{"pr_number": 10239, "pr_title": "JEP371 ClassData Support and JEP383 Support (Part 3)", "pr_createdAt": "2020-07-23T22:56:31Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10239", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxOTc3MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10239#discussion_r462519771", "bodyText": "This duplicates the body of defineClass.  Can the Class<?> defineClass(boolean initOption) version forward to this one with a null classData?", "author": "DanHeidinga", "createdAt": "2020-07-29T19:00:03Z", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2282,45 +2282,83 @@ int toFlag() {\n \t\t\tprivate final String className;\n \t\t\tprivate final Lookup lookup;\n \t\t\tprivate final int ClassOptFlags;\n+\n \t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj, int flags) {\n \t\t\t\tclassName = name;\n \t\t\t\tclassBytes = template;\n \t\t\t\tlookup = lookupObj;\n \t\t\t\tClassOptFlags = flags;\n \t\t\t}\n+\n \t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj) {\n \t\t\t\tclassName = name;\n \t\t\t\tclassBytes = template;\n \t\t\t\tlookup = lookupObj;\n \t\t\t\tClassOptFlags = 0;\n \t\t\t}\n+\n \t\t\tClass<?> defineClass(boolean initOption) {\n \t\t\t\tClass<?> ret = AccessController.doPrivileged(new PrivilegedAction<Class<?>>() {\n \t\t\t\t\t@Override\n \t\t\t\t\tpublic Class<?> run() {\n \t\t\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n \t\t\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n-\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes, jlAccess.protectionDomain(lookupClass), initOption, ClassOptFlags, null);\n+\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes,\n+\t\t\t\t\t\t\t\tjlAccess.protectionDomain(lookupClass), initOption, ClassOptFlags, null);\n+\t\t\t\t\t}\n+\t\t\t\t});\n+\t\t\t\treturn ret;\n+\t\t\t}\n+\n+\t\t\tClass<?> defineClass(boolean initOption, Object classData) {\n+\t\t\t\tClass<?> ret = AccessController.doPrivileged(new PrivilegedAction<Class<?>>() {\n+\t\t\t\t\t@Override\n+\t\t\t\t\tpublic Class<?> run() {\n+\t\t\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n+\t\t\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n+\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes,\n+\t\t\t\t\t\t\t\tjlAccess.protectionDomain(lookupClass), initOption, ClassOptFlags, classData);", "originalCommit": "90a8a9312899ed56f7fc04b6a43b9d48364f4182", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxNjMyNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10239#discussion_r462716327", "bodyText": "Yes. Addressed in the HEAD commit.", "author": "babsingh", "createdAt": "2020-07-30T03:42:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxOTc3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyMTIzMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10239#discussion_r462521232", "bodyText": "class data bytes may be confusing given the addition of the classData object", "author": "DanHeidinga", "createdAt": "2020-07-29T19:02:28Z", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2282,45 +2282,83 @@ int toFlag() {\n \t\t\tprivate final String className;\n \t\t\tprivate final Lookup lookup;\n \t\t\tprivate final int ClassOptFlags;\n+\n \t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj, int flags) {\n \t\t\t\tclassName = name;\n \t\t\t\tclassBytes = template;\n \t\t\t\tlookup = lookupObj;\n \t\t\t\tClassOptFlags = flags;\n \t\t\t}\n+\n \t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj) {\n \t\t\t\tclassName = name;\n \t\t\t\tclassBytes = template;\n \t\t\t\tlookup = lookupObj;\n \t\t\t\tClassOptFlags = 0;\n \t\t\t}\n+\n \t\t\tClass<?> defineClass(boolean initOption) {\n \t\t\t\tClass<?> ret = AccessController.doPrivileged(new PrivilegedAction<Class<?>>() {\n \t\t\t\t\t@Override\n \t\t\t\t\tpublic Class<?> run() {\n \t\t\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n \t\t\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n-\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes, jlAccess.protectionDomain(lookupClass), initOption, ClassOptFlags, null);\n+\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes,\n+\t\t\t\t\t\t\t\tjlAccess.protectionDomain(lookupClass), initOption, ClassOptFlags, null);\n+\t\t\t\t\t}\n+\t\t\t\t});\n+\t\t\t\treturn ret;\n+\t\t\t}\n+\n+\t\t\tClass<?> defineClass(boolean initOption, Object classData) {\n+\t\t\t\tClass<?> ret = AccessController.doPrivileged(new PrivilegedAction<Class<?>>() {\n+\t\t\t\t\t@Override\n+\t\t\t\t\tpublic Class<?> run() {\n+\t\t\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n+\t\t\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n+\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes,\n+\t\t\t\t\t\t\t\tjlAccess.protectionDomain(lookupClass), initOption, ClassOptFlags, classData);\n \t\t\t\t\t}\n \t\t\t\t});\n \t\t\t\treturn ret;\n \t\t\t}\n \t\t}\n+\n \t\t/**\n \t\t * Constructs a new hidden class from an array of class data bytes.\n \t\t * \n-\t\t * @param bytes the class data bytes of the hidden class to be defined.  \n+\t\t * @param bytes the class data bytes of the hidden class to be defined.", "originalCommit": "90a8a9312899ed56f7fc04b6a43b9d48364f4182", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxNjQ5MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10239#discussion_r462716490", "bodyText": "Reworded class data bytes to class file bytes in the HEAD commit.", "author": "babsingh", "createdAt": "2020-07-30T03:43:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyMTIzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyMjE3NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10239#discussion_r462522174", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t * Constructs a new hidden class from an array of class data bytes.\n          \n          \n            \n            \t\t * Constructs a new hidden class from an array of class file bytes.", "author": "DanHeidinga", "createdAt": "2020-07-29T19:04:08Z", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2282,45 +2282,83 @@ int toFlag() {\n \t\t\tprivate final String className;\n \t\t\tprivate final Lookup lookup;\n \t\t\tprivate final int ClassOptFlags;\n+\n \t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj, int flags) {\n \t\t\t\tclassName = name;\n \t\t\t\tclassBytes = template;\n \t\t\t\tlookup = lookupObj;\n \t\t\t\tClassOptFlags = flags;\n \t\t\t}\n+\n \t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj) {\n \t\t\t\tclassName = name;\n \t\t\t\tclassBytes = template;\n \t\t\t\tlookup = lookupObj;\n \t\t\t\tClassOptFlags = 0;\n \t\t\t}\n+\n \t\t\tClass<?> defineClass(boolean initOption) {\n \t\t\t\tClass<?> ret = AccessController.doPrivileged(new PrivilegedAction<Class<?>>() {\n \t\t\t\t\t@Override\n \t\t\t\t\tpublic Class<?> run() {\n \t\t\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n \t\t\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n-\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes, jlAccess.protectionDomain(lookupClass), initOption, ClassOptFlags, null);\n+\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes,\n+\t\t\t\t\t\t\t\tjlAccess.protectionDomain(lookupClass), initOption, ClassOptFlags, null);\n+\t\t\t\t\t}\n+\t\t\t\t});\n+\t\t\t\treturn ret;\n+\t\t\t}\n+\n+\t\t\tClass<?> defineClass(boolean initOption, Object classData) {\n+\t\t\t\tClass<?> ret = AccessController.doPrivileged(new PrivilegedAction<Class<?>>() {\n+\t\t\t\t\t@Override\n+\t\t\t\t\tpublic Class<?> run() {\n+\t\t\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n+\t\t\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n+\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes,\n+\t\t\t\t\t\t\t\tjlAccess.protectionDomain(lookupClass), initOption, ClassOptFlags, classData);\n \t\t\t\t\t}\n \t\t\t\t});\n \t\t\t\treturn ret;\n \t\t\t}\n \t\t}\n+\n \t\t/**\n \t\t * Constructs a new hidden class from an array of class data bytes.\n \t\t * \n-\t\t * @param bytes the class data bytes of the hidden class to be defined.  \n+\t\t * @param bytes the class data bytes of the hidden class to be defined.\n \t\t * @param initOption whether to initialize the hidden class.\n \t\t * @param classOptions the {@link ClassOption} to define the hidden class.\n+\t\t * \n \t\t * @return A Lookup object of the newly created hidden class.\n \t\t * @throws IllegalAccessException if this Lookup does not have full privilege access.\n \t\t */\n-\n \t\tpublic Lookup defineHiddenClass(byte[] bytes, boolean initOption, ClassOption... classOptions) throws IllegalAccessException {\n+\t\t\tClassDefiner definer = classDefiner(bytes, classOptions);\n+\t\t\treturn new Lookup(definer.defineClass(initOption));\n+\t\t}\n+\t\t\n+\t\t/**\n+\t\t * Constructs a new hidden class from an array of class data bytes.", "originalCommit": "90a8a9312899ed56f7fc04b6a43b9d48364f4182", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxNjU5Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10239#discussion_r462716593", "bodyText": "Incorporated in the HEAD commit.", "author": "babsingh", "createdAt": "2020-07-30T03:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyMjE3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyMjMwOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10239#discussion_r462522309", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t * @param bytes the class data bytes of the hidden class to be defined.\n          \n          \n            \n            \t\t * @param bytes the class file bytes of the hidden class to be defined.", "author": "DanHeidinga", "createdAt": "2020-07-29T19:04:22Z", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2282,45 +2282,83 @@ int toFlag() {\n \t\t\tprivate final String className;\n \t\t\tprivate final Lookup lookup;\n \t\t\tprivate final int ClassOptFlags;\n+\n \t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj, int flags) {\n \t\t\t\tclassName = name;\n \t\t\t\tclassBytes = template;\n \t\t\t\tlookup = lookupObj;\n \t\t\t\tClassOptFlags = flags;\n \t\t\t}\n+\n \t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj) {\n \t\t\t\tclassName = name;\n \t\t\t\tclassBytes = template;\n \t\t\t\tlookup = lookupObj;\n \t\t\t\tClassOptFlags = 0;\n \t\t\t}\n+\n \t\t\tClass<?> defineClass(boolean initOption) {\n \t\t\t\tClass<?> ret = AccessController.doPrivileged(new PrivilegedAction<Class<?>>() {\n \t\t\t\t\t@Override\n \t\t\t\t\tpublic Class<?> run() {\n \t\t\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n \t\t\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n-\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes, jlAccess.protectionDomain(lookupClass), initOption, ClassOptFlags, null);\n+\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes,\n+\t\t\t\t\t\t\t\tjlAccess.protectionDomain(lookupClass), initOption, ClassOptFlags, null);\n+\t\t\t\t\t}\n+\t\t\t\t});\n+\t\t\t\treturn ret;\n+\t\t\t}\n+\n+\t\t\tClass<?> defineClass(boolean initOption, Object classData) {\n+\t\t\t\tClass<?> ret = AccessController.doPrivileged(new PrivilegedAction<Class<?>>() {\n+\t\t\t\t\t@Override\n+\t\t\t\t\tpublic Class<?> run() {\n+\t\t\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n+\t\t\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n+\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes,\n+\t\t\t\t\t\t\t\tjlAccess.protectionDomain(lookupClass), initOption, ClassOptFlags, classData);\n \t\t\t\t\t}\n \t\t\t\t});\n \t\t\t\treturn ret;\n \t\t\t}\n \t\t}\n+\n \t\t/**\n \t\t * Constructs a new hidden class from an array of class data bytes.\n \t\t * \n-\t\t * @param bytes the class data bytes of the hidden class to be defined.  \n+\t\t * @param bytes the class data bytes of the hidden class to be defined.\n \t\t * @param initOption whether to initialize the hidden class.\n \t\t * @param classOptions the {@link ClassOption} to define the hidden class.\n+\t\t * \n \t\t * @return A Lookup object of the newly created hidden class.\n \t\t * @throws IllegalAccessException if this Lookup does not have full privilege access.\n \t\t */\n-\n \t\tpublic Lookup defineHiddenClass(byte[] bytes, boolean initOption, ClassOption... classOptions) throws IllegalAccessException {\n+\t\t\tClassDefiner definer = classDefiner(bytes, classOptions);\n+\t\t\treturn new Lookup(definer.defineClass(initOption));\n+\t\t}\n+\t\t\n+\t\t/**\n+\t\t * Constructs a new hidden class from an array of class data bytes.\n+\t\t * \n+\t\t * @param bytes the class data bytes of the hidden class to be defined.", "originalCommit": "90a8a9312899ed56f7fc04b6a43b9d48364f4182", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxNjYxNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10239#discussion_r462716616", "bodyText": "Incorporated in the HEAD commit.", "author": "babsingh", "createdAt": "2020-07-30T03:43:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyMjMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyNzEyOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10239#discussion_r462527129", "bodyText": "Why an unused parameter?", "author": "DanHeidinga", "createdAt": "2020-07-29T19:12:31Z", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -5466,12 +5500,96 @@ public Object helper(Object[] arguments) throws Throwable {\n \t}\n \n \t/*[IF Java15]*/\n-\tstatic boolean permuteArgumentChecks(int[] arr, MethodType mt1, MethodType mt2) {\n-\t\tthrow OpenJDKCompileStub.OpenJDKCompileStubThrowError();\n+\t/**\n+\t * Validates that the permute[] specifies a valid permutation from permuteType to handleType.\n+\t * This method throws IllegalArgumentException on failure and returns true on success. This\n+\t * disjointness allows it to be used in asserts.\n+\t * \n+\t * @param permute array specifies the conversion from permuteType to handleType.\n+\t * @param permuteType source method type.\n+\t * @param handleType target method type.\n+\t * \n+\t * @return true on success.\n+\t * @throws IllegalArgumentException on failure.\n+\t */\n+\tstatic boolean permuteArgumentChecks(int[] permute, MethodType permuteType, MethodType handleType) {\n+\t\treturn validatePermutationArray(permuteType, handleType, permute);\n \t}\n \t\n-\tstatic MethodHandle collectReturnValue(MethodHandle mh1, MethodHandle mh2) {\n-\t\tthrow OpenJDKCompileStub.OpenJDKCompileStubThrowError();\n+\t/**\n+\t * Return the classData stored in the accessClass of the Lookup object.\n+\t * \n+\t * @param caller Lookup object used to verify privileged access and retrieve classData.\n+\t * @param unused.", "originalCommit": "90a8a9312899ed56f7fc04b6a43b9d48364f4182", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxNzQxMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10239#discussion_r462717412", "bodyText": "RI introduced MethodHandles.classData with an unused String. We had to match the RI in order to support calls from the JEP383 API.", "author": "babsingh", "createdAt": "2020-07-30T03:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyNzEyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyODU2Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10239#discussion_r462528563", "bodyText": "Is this field visible to Reflection in the RI?", "author": "DanHeidinga", "createdAt": "2020-07-29T19:15:07Z", "path": "jcl/src/java.base/share/classes/java/lang/Class.java", "diffHunk": "@@ -266,6 +266,10 @@ static Unsafe getUnsafe() {\n \tprivate Class<?> nestHost;\n /*[ENDIF] Java11*/\n \t\n+/*[IF Java15]*/\n+\tprivate transient Object classData;", "originalCommit": "90a8a9312899ed56f7fc04b6a43b9d48364f4182", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxOTA0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10239#discussion_r462719046", "bodyText": "The Class.classData field is listed in Reflection.fieldFilterMap. It gets filtered out from public-view. I don't think it is visible to Reflection in the RI. Assuming, I have correctly read the code.", "author": "babsingh", "createdAt": "2020-07-30T03:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyODU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUzMDQzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10239#discussion_r462530430", "bodyText": "How did we determine that true aka initialize is the right value here?", "author": "DanHeidinga", "createdAt": "2020-07-29T19:18:31Z", "path": "jcl/src/java.base/share/classes/java/lang/invoke/MethodHandles.java", "diffHunk": "@@ -2282,45 +2282,83 @@ int toFlag() {\n \t\t\tprivate final String className;\n \t\t\tprivate final Lookup lookup;\n \t\t\tprivate final int ClassOptFlags;\n+\n \t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj, int flags) {\n \t\t\t\tclassName = name;\n \t\t\t\tclassBytes = template;\n \t\t\t\tlookup = lookupObj;\n \t\t\t\tClassOptFlags = flags;\n \t\t\t}\n+\n \t\t\tClassDefiner(String name, byte[] template, Lookup lookupObj) {\n \t\t\t\tclassName = name;\n \t\t\t\tclassBytes = template;\n \t\t\t\tlookup = lookupObj;\n \t\t\t\tClassOptFlags = 0;\n \t\t\t}\n+\n \t\t\tClass<?> defineClass(boolean initOption) {\n \t\t\t\tClass<?> ret = AccessController.doPrivileged(new PrivilegedAction<Class<?>>() {\n \t\t\t\t\t@Override\n \t\t\t\t\tpublic Class<?> run() {\n \t\t\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n \t\t\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n-\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes, jlAccess.protectionDomain(lookupClass), initOption, ClassOptFlags, null);\n+\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes,\n+\t\t\t\t\t\t\t\tjlAccess.protectionDomain(lookupClass), initOption, ClassOptFlags, null);\n+\t\t\t\t\t}\n+\t\t\t\t});\n+\t\t\t\treturn ret;\n+\t\t\t}\n+\n+\t\t\tClass<?> defineClass(boolean initOption, Object classData) {\n+\t\t\t\tClass<?> ret = AccessController.doPrivileged(new PrivilegedAction<Class<?>>() {\n+\t\t\t\t\t@Override\n+\t\t\t\t\tpublic Class<?> run() {\n+\t\t\t\t\t\tJavaLangAccess jlAccess = SharedSecrets.getJavaLangAccess();\n+\t\t\t\t\t\tClass<?> lookupClass = lookup.lookupClass();\n+\t\t\t\t\t\treturn jlAccess.defineClass(lookupClass.getClassLoader(), lookupClass, className, classBytes,\n+\t\t\t\t\t\t\t\tjlAccess.protectionDomain(lookupClass), initOption, ClassOptFlags, classData);\n \t\t\t\t\t}\n \t\t\t\t});\n \t\t\t\treturn ret;\n \t\t\t}\n \t\t}\n+\n \t\t/**\n \t\t * Constructs a new hidden class from an array of class data bytes.\n \t\t * \n-\t\t * @param bytes the class data bytes of the hidden class to be defined.  \n+\t\t * @param bytes the class data bytes of the hidden class to be defined.\n \t\t * @param initOption whether to initialize the hidden class.\n \t\t * @param classOptions the {@link ClassOption} to define the hidden class.\n+\t\t * \n \t\t * @return A Lookup object of the newly created hidden class.\n \t\t * @throws IllegalAccessException if this Lookup does not have full privilege access.\n \t\t */\n-\n \t\tpublic Lookup defineHiddenClass(byte[] bytes, boolean initOption, ClassOption... classOptions) throws IllegalAccessException {\n+\t\t\tClassDefiner definer = classDefiner(bytes, classOptions);\n+\t\t\treturn new Lookup(definer.defineClass(initOption));\n+\t\t}\n+\t\t\n+\t\t/**\n+\t\t * Constructs a new hidden class from an array of class data bytes.\n+\t\t * \n+\t\t * @param bytes the class data bytes of the hidden class to be defined.\n+\t\t * @param classData the classData to be stored in the hidden class.\n+\t\t * @param classOptions the {@link ClassOption} to define the hidden class.\n+\t\t * \n+\t\t * @return A Lookup object of the newly created hidden class.\n+\t\t * @throws IllegalAccessException if this Lookup does not have full privilege access.\n+\t\t */\n+\t\tLookup defineHiddenClassWithClassData(byte[] bytes, Object classData, ClassOption... classOptions) throws IllegalAccessException {\n+\t\t\tClassDefiner definer = classDefiner(bytes, classOptions);\n+\t\t\treturn new Lookup(definer.defineClass(true, classData));", "originalCommit": "90a8a9312899ed56f7fc04b6a43b9d48364f4182", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1MzY3Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10239#discussion_r462553673", "bodyText": "From the documentation. defineHiddenClassWithClassData is a package private method so its documentation does not get published in the official docs.", "author": "babsingh", "createdAt": "2020-07-29T20:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUzMDQzMA=="}], "type": "inlineReview"}, {"oid": "fbdaa6b644d9d3610b38b54838b2dea81135d916", "url": "https://github.com/eclipse-openj9/openj9/commit/fbdaa6b644d9d3610b38b54838b2dea81135d916", "message": "Update comments and modified ClassDefiner.defineClass as per code-review\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-07-30T03:38:44Z", "type": "forcePushed"}, {"oid": "ed349867f81fbb55faf5a4b8e8bbf3a46bb68329", "url": "https://github.com/eclipse-openj9/openj9/commit/ed349867f81fbb55faf5a4b8e8bbf3a46bb68329", "message": "Update comments and modify ClassDefiner.defineClass as per code-review\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-07-30T03:58:04Z", "type": "forcePushed"}, {"oid": "a1fb618898a0e48a022f9ab2ad0857ef2b26ab3c", "url": "https://github.com/eclipse-openj9/openj9/commit/a1fb618898a0e48a022f9ab2ad0857ef2b26ab3c", "message": "JEP371 ClassData Support and JEP383 Support (Part 3)\n\nJEP371 ClassData Support:\n\n1. Implement Class.setClassData(...) and Class.getClassData()\n2. Store classData in Access.defineClass(...)\n3. Implement Access.classData(...)\n4. Implement MethodHandleNatives.classData(...)\n5. Implement ClassDefiner.defineClass(initOption, classData)\n6. Implement Lookup.defineHiddenClassWithClassData(...)\n7. Implement MethodHandles.classData(...)\n\nJEP383 Support (Part 3):\n\n1. Implement MethodHandles.permuteArgumentChecks(...)\n2. Implement MethodHandles.collectReturnValue(...)\n3. Implement VarHandle.target()\n4. Implement VarHandle.asDirect()\n5. Implement VarHandle.isDirect()\n6. Implement VarHandle.getMethodHandle(...)\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-07-30T04:00:23Z", "type": "commit"}, {"oid": "f36909de48dfb0ea9470b1522f6a244b96655b80", "url": "https://github.com/eclipse-openj9/openj9/commit/f36909de48dfb0ea9470b1522f6a244b96655b80", "message": "Set Class.classData before init in ClassLoader_defineClassImpl1\n\nBefore the new JEP371 changes, the classData could be set in\nAccess.defineClass in Java code before the class was initialized.\n\nWith the new JEP371 changes, all code to define and init the class was\nmoved into native code, ClassLoader_defineClassImpl1.\n\nThis requires Class.classData to be initialized within\nClassLoader_defineClassImpl1 before the class is initialized.\n\nClass.setClassData is removed since it is no longer used.\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-07-30T04:00:23Z", "type": "commit"}, {"oid": "93db73943ebdb2d12bbca9195b30327934732d11", "url": "https://github.com/eclipse-openj9/openj9/commit/93db73943ebdb2d12bbca9195b30327934732d11", "message": "Update comments and modify ClassDefiner.defineClass as per code-review\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-07-30T04:00:23Z", "type": "commit"}, {"oid": "93db73943ebdb2d12bbca9195b30327934732d11", "url": "https://github.com/eclipse-openj9/openj9/commit/93db73943ebdb2d12bbca9195b30327934732d11", "message": "Update comments and modify ClassDefiner.defineClass as per code-review\n\nSigned-off-by: Babneet Singh <sbabneet@ca.ibm.com>", "committedDate": "2020-07-30T04:00:23Z", "type": "forcePushed"}]}