{"pr_number": 10207, "pr_title": "JEP371 implementation part 2", "pr_createdAt": "2020-07-21T15:35:00Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10207", "timeline": [{"oid": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "url": "https://github.com/eclipse-openj9/openj9/commit/67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "message": "JEP371 implementation part 2.\n\n1. Add a new API defineClassImpl1() in classLoader.java.\n2. Replace Unsafe.defineAnonymousClass() with the new API to \ndefine hidden classes.\n3. Add J9AccClassHiddenClass, J9AccHiddenClassOptionNestmate and\nJ9AccHiddenClassOptionStrong.\n4. Disable class sharing (and SCC tests) for hidden class for now. \n\nHidden classes are treated the same as unsafe anonymous \nclasses, except: \na) Its defining classloader is the loader of its hostclass.\nb) It has J9AccClassHiddenClass set.\nc) If defined with NESTMATE/STRONG,\nJ9AccHiddenClassOptionNestmate/J9AccHiddenClassOptionStrong \nwill be set.\n\nissue #9328\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-07-21T15:37:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0MjA1NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458242055", "bodyText": "I would prefer these new flags follow the convention - start with J9AccClass", "author": "gacholio", "createdAt": "2020-07-21T16:47:07Z", "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -1059,17 +1059,17 @@ ROMClassBuilder::finishPrepareAndLaydown(\n  *                                  + UNUSED\n  *                                 + UNUSED\n  *                                + UNUSED\n- *                               + UNUSED\n+ *                              + J9AccHiddenClassOptionNestmate", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMzNzg5Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458337893", "bodyText": "Fixed.", "author": "hangshao0", "createdAt": "2020-07-21T19:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0MjA1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0MjYxOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458242618", "bodyText": "Brackets please.", "author": "gacholio", "createdAt": "2020-07-21T16:48:02Z", "path": "runtime/bcutil/ROMClassSegmentAllocationStrategy.cpp", "diffHunk": "@@ -34,9 +34,10 @@ ROMClassSegmentAllocationStrategy::allocate(UDATA bytesRequired)\n \t/* Scan existing segments for one large enough to hold the new ROM class */\n \n \tJ9MemorySegment* segment = NULL;\n-\tbool isLoadedByAnonClassLoader = _classLoader == _javaVM->anonClassLoader;\n \t/* always make a new segment if its an anonClass */\n-\tif (!isLoadedByAnonClassLoader) {\n+\tbool allocNewSegment = (_allocNewSeg || _classLoader == _javaVM->anonClassLoader);", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMzODE2NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458338164", "bodyText": "Fixed.", "author": "hangshao0", "createdAt": "2020-07-21T19:31:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0MjYxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0Mzg5OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458243899", "bodyText": "Extra blank", "author": "gacholio", "createdAt": "2020-07-21T16:50:04Z", "path": "runtime/jcl/common/clsldr.cpp", "diffHunk": "@@ -85,6 +93,66 @@ Java_java_lang_ClassLoader_defineClassImpl(JNIEnv *env, jobject receiver, jstrin\n \treturn result;\n }\n \n+#if JAVA_SPEC_VERSION >= 15\n+jclass JNICALL\n+Java_java_lang_ClassLoader_defineClassImpl1(JNIEnv *env, jobject receiver, jclass hostClass, jstring className, jbyteArray classRep, jobject protectionDomain, jboolean init, jint flags, jobject obj)\n+{\n+\tJ9VMThread *currentThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = currentThread->javaVM;\n+\tJ9InternalVMFunctions *vmFuncs = vm->internalVMFunctions;\n+\tUDATA options = 0;\n+\t\n+\tvmFuncs->internalEnterVMFromJNI(currentThread);\n+\tif (NULL == classRep) {\n+\t\tvmFuncs->setCurrentException(currentThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t\tvmFuncs->internalExitVMToJNI(currentThread);\n+\t\treturn NULL;\n+\t}\n+\tif (NULL == hostClass) {\n+\t\tvmFuncs->setCurrentException(currentThread, J9VMCONSTANTPOOL_JAVALANGILLEGALARGUMENTEXCEPTION, NULL);\n+\t\tvmFuncs->internalExitVMToJNI(currentThread);\n+\t\treturn NULL;\n+\t}\n+\n+\tj9object_t hostClassObject = J9_JNI_UNWRAP_REFERENCE(hostClass);\n+\tJ9Class *hostClazz =  J9VM_J9CLASS_FROM_HEAPCLASS(currentThread, hostClassObject);\n+\n+\tvmFuncs->internalExitVMToJNI(currentThread);\n+\n+\toptions |= (J9_FINDCLASS_FLAG_HIDDEN | J9_FINDCLASS_FLAG_UNSAFE | J9_FINDCLASS_FLAG_ANON);\n+\tif (J9_ARE_ALL_BITS_SET(flags, CLASSOPTION_FLAG_NESTMATE)) {\n+\t\toptions |= J9_FINDCLASS_FLAG_CLASS_OPTION_NESTMATE;\n+\t}\n+\tif (J9_ARE_ALL_BITS_SET(flags, CLASSOPTION_FLAG_STRONG )) {", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMzODM4MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458338381", "bodyText": "Fixed.", "author": "hangshao0", "createdAt": "2020-07-21T19:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0Mzg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NDEwNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458244107", "bodyText": "Extra line", "author": "gacholio", "createdAt": "2020-07-21T16:50:23Z", "path": "runtime/jcl/common/clsldr.cpp", "diffHunk": "@@ -85,6 +93,66 @@ Java_java_lang_ClassLoader_defineClassImpl(JNIEnv *env, jobject receiver, jstrin\n \treturn result;\n }\n \n+#if JAVA_SPEC_VERSION >= 15\n+jclass JNICALL\n+Java_java_lang_ClassLoader_defineClassImpl1(JNIEnv *env, jobject receiver, jclass hostClass, jstring className, jbyteArray classRep, jobject protectionDomain, jboolean init, jint flags, jobject obj)\n+{\n+\tJ9VMThread *currentThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = currentThread->javaVM;\n+\tJ9InternalVMFunctions *vmFuncs = vm->internalVMFunctions;\n+\tUDATA options = 0;\n+\t\n+\tvmFuncs->internalEnterVMFromJNI(currentThread);\n+\tif (NULL == classRep) {\n+\t\tvmFuncs->setCurrentException(currentThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t\tvmFuncs->internalExitVMToJNI(currentThread);\n+\t\treturn NULL;\n+\t}\n+\tif (NULL == hostClass) {\n+\t\tvmFuncs->setCurrentException(currentThread, J9VMCONSTANTPOOL_JAVALANGILLEGALARGUMENTEXCEPTION, NULL);\n+\t\tvmFuncs->internalExitVMToJNI(currentThread);\n+\t\treturn NULL;\n+\t}\n+\n+\tj9object_t hostClassObject = J9_JNI_UNWRAP_REFERENCE(hostClass);\n+\tJ9Class *hostClazz =  J9VM_J9CLASS_FROM_HEAPCLASS(currentThread, hostClassObject);\n+\n+\tvmFuncs->internalExitVMToJNI(currentThread);\n+\n+\toptions |= (J9_FINDCLASS_FLAG_HIDDEN | J9_FINDCLASS_FLAG_UNSAFE | J9_FINDCLASS_FLAG_ANON);\n+\tif (J9_ARE_ALL_BITS_SET(flags, CLASSOPTION_FLAG_NESTMATE)) {\n+\t\toptions |= J9_FINDCLASS_FLAG_CLASS_OPTION_NESTMATE;\n+\t}\n+\tif (J9_ARE_ALL_BITS_SET(flags, CLASSOPTION_FLAG_STRONG )) {\n+\t\toptions |= J9_FINDCLASS_FLAG_CLASS_OPTION_STRONG;\n+\t}\n+\t\n+\tjsize length = env->GetArrayLength(classRep);\n+\n+\tjclass result = defineClassCommon(env, receiver, className, classRep, 0, length, protectionDomain, options, hostClazz, NULL);\n+\tif (env->ExceptionCheck()) {\n+\t\treturn NULL;\n+\t} else if (NULL == result) {\n+\t\tthrowNewInternalError(env, NULL);\n+\t\treturn NULL;\n+\t}\n+\n+\tif (init) {\n+\t\tvmFuncs->internalEnterVMFromJNI(currentThread);\n+\t\tj9object_t classObject = J9_JNI_UNWRAP_REFERENCE(result);\n+\t\tJ9Class *j9clazz =  J9VM_J9CLASS_FROM_HEAPCLASS(currentThread, classObject);\n+\t\tif (VM_VMHelpers::classRequiresInitialization(currentThread, j9clazz)) {\n+\t\t\tvmFuncs->initializeClass(currentThread, j9clazz);\n+\t\t}\n+\t\tvmFuncs->internalExitVMToJNI(currentThread);\n+\t}\n+", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMzODU5Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458338592", "bodyText": "Removed.", "author": "hangshao0", "createdAt": "2020-07-21T19:32:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NDEwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NDU2Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458244566", "bodyText": "Why is this code being removed?", "author": "gacholio", "createdAt": "2020-07-21T16:51:04Z", "path": "runtime/jcl/common/java_lang_Class.cpp", "diffHunk": "@@ -1812,17 +1812,6 @@ Java_java_lang_Class_getNestHostImpl(JNIEnv *env, jobject recv)\n \n \tif (NULL == nestHost) {\n \t\tJ9Class *clazzToUse = clazz;\n-#if JAVA_SPEC_VERSION >= 15", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM0NTk1Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458345952", "bodyText": "Our previous implementation used Unsafe.defineAnonymousClass() to define hidden classes. It did not take ClassOption.NESTMATE that is passed in, so we returned the nest host of hostClass for anonymous classes here as a temporary workaround to make java -version working. Change in this PR is taking care of the ClassOption.NESTMATE and setting J9AccHiddenClassOptionNestmate. The change in loadAndVerifyNestHost() in this PR is now checking J9AccHiddenClassOptionNestmate and returning the correct nest host for hidden classes, so this piece of code can be removed.", "author": "hangshao0", "createdAt": "2020-07-21T19:46:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NDU2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NDkzOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458244938", "bodyText": "Please us the macro from j9modifiers_api.h", "author": "gacholio", "createdAt": "2020-07-21T16:51:37Z", "path": "runtime/jcl/common/java_lang_Class.cpp", "diffHunk": "@@ -1937,4 +1926,22 @@ Java_java_lang_Class_getNestMembersImpl(JNIEnv *env, jobject recv)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n }\n \n+jboolean JNICALL \n+Java_java_lang_Class_isHiddenImpl(JNIEnv *env, jobject recv)\n+{\n+#if JAVA_SPEC_VERSION >= 15\n+\tjboolean result = JNI_FALSE;\n+\tJ9VMThread *currentThread = (J9VMThread*)env;\n+\tJ9InternalVMFunctions *vmFuncs = currentThread->javaVM->internalVMFunctions;\n+\tvmFuncs->internalEnterVMFromJNI(currentThread);\n+\tJ9Class *clazz = J9VM_J9CLASS_FROM_HEAPCLASS(currentThread, J9_JNI_UNWRAP_REFERENCE(recv));\n+\tresult = J9_ARE_ALL_BITS_SET(clazz->romClass->extraModifiers, J9AccClassHiddenClass);", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM0NjQzOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458346438", "bodyText": "Fixed.", "author": "hangshao0", "createdAt": "2020-07-21T19:47:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NDkzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NTI4Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458245286", "bodyText": "Please move this comment above the if.", "author": "gacholio", "createdAt": "2020-07-21T16:52:11Z", "path": "runtime/jcl/common/jcldefine.c", "diffHunk": "@@ -131,14 +131,17 @@ defineClassCommon(JNIEnv *env, jobject classLoaderObject,\n retry:\n \n \tomrthread_monitor_enter(vm->classTableMutex);\n-\n-\tif (vmFuncs->hashClassTableAt(classLoader, utf8Name, utf8Length) != NULL) {\n-\t\t/* Bad, we have already defined this class - fail */\n-\t\tomrthread_monitor_exit(vm->classTableMutex);\n-\t\tif (J9_ARE_NO_BITS_SET(options, J9_FINDCLASS_FLAG_NAME_IS_INVALID)) {\n-\t\t\tvmFuncs->setCurrentException(currentThread, J9VMCONSTANTPOOL_JAVALANGLINKAGEERROR, (UDATA *)*(j9object_t*)className);\n+\t\n+\tif (J9_ARE_NO_BITS_SET(options, J9_FINDCLASS_FLAG_HIDDEN)) {\n+\t\t/* Hidden class is never added into the hash table */", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM0NjUxMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458346512", "bodyText": "Fixed.", "author": "hangshao0", "createdAt": "2020-07-21T19:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NTI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NTQ0Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458245447", "bodyText": "NULL !=", "author": "gacholio", "createdAt": "2020-07-21T16:52:25Z", "path": "runtime/jcl/common/jcldefine.c", "diffHunk": "@@ -131,14 +131,17 @@ defineClassCommon(JNIEnv *env, jobject classLoaderObject,\n retry:\n \n \tomrthread_monitor_enter(vm->classTableMutex);\n-\n-\tif (vmFuncs->hashClassTableAt(classLoader, utf8Name, utf8Length) != NULL) {\n-\t\t/* Bad, we have already defined this class - fail */\n-\t\tomrthread_monitor_exit(vm->classTableMutex);\n-\t\tif (J9_ARE_NO_BITS_SET(options, J9_FINDCLASS_FLAG_NAME_IS_INVALID)) {\n-\t\t\tvmFuncs->setCurrentException(currentThread, J9VMCONSTANTPOOL_JAVALANGLINKAGEERROR, (UDATA *)*(j9object_t*)className);\n+\t\n+\tif (J9_ARE_NO_BITS_SET(options, J9_FINDCLASS_FLAG_HIDDEN)) {\n+\t\t/* Hidden class is never added into the hash table */\n+\t\tif (vmFuncs->hashClassTableAt(classLoader, utf8Name, utf8Length) != NULL) {", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM1Nzc0MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458357740", "bodyText": "Fixed.", "author": "hangshao0", "createdAt": "2020-07-21T20:09:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NTQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NjQyMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458246423", "bodyText": "Has this case been tested? It took a while to get this right the first time.", "author": "gacholio", "createdAt": "2020-07-21T16:54:01Z", "path": "runtime/oti/j9.h", "diffHunk": "@@ -124,7 +124,7 @@ typedef struct J9ClassLoaderWalkState {\n #define J9CLASS_IS_MIXED(ramClass) (((J9CLASS_FLAGS(ramClass) >> J9AccClassRAMShapeShift) & OBJECT_HEADER_SHAPE_MASK) == OBJECT_HEADER_SHAPE_MIXED)\n \n #define J9CLASS_IS_EXEMPT_FROM_VALIDATION(clazz) \\\n-\t(J9ROMCLASS_IS_UNSAFE((clazz)->romClass) || J9_ARE_ANY_BITS_SET((clazz)->classFlags, J9ClassIsExemptFromValidation))\n+\t((J9ROMCLASS_IS_UNSAFE((clazz)->romClass) && !J9ROMCLASS_IS_HIDDEN((clazz)->romClass)) || (J9_ARE_ANY_BITS_SET((clazz)->classFlags, J9ClassIsExemptFromValidation)))", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM0ODA3NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458348075", "bodyText": "Yes, it is tested. This does not change behavior for all unsafe non-hidden classes.", "author": "hangshao0", "createdAt": "2020-07-21T19:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NjQyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NzY2Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458247663", "bodyText": "Are you sure these bits are available? I see overlap with varags (likely doesn't apply to classes) and ValueType.", "author": "gacholio", "createdAt": "2020-07-21T16:55:52Z", "path": "runtime/oti/j9javaaccessflags.h", "diffHunk": "@@ -118,6 +119,8 @@\n #define J9AccVolatile 0x40\n #define J9AccRecord 0x400\n #define J9AccSealed 0x200\n+#define J9AccHiddenClassOptionNestmate 0x80", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM1MzI0Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458353247", "bodyText": "I see the value of varags and ValueType. But they are set to romClass->modifiers. The new J9AccClassXXXX this PR added are set to romClass->extraModifiers.\nHowever, I noticed both J9AccVarArgs and J9AccTransient are 0x80, and they are both set to romClass->modifiers. Incorrect ?", "author": "hangshao0", "createdAt": "2020-07-21T20:00:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NzY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3Mzk0Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458373942", "bodyText": "However, I noticed both J9AccVarArgs and J9AccTransient are 0x80, and they are both set to romClass->modifiers.\n\nThis comment can be ignored. After a closer look, they are setting to romMethod->modifiers and romField->modifiers.", "author": "hangshao0", "createdAt": "2020-07-21T20:39:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NzY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0ODg2NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458248865", "bodyText": "macro please", "author": "gacholio", "createdAt": "2020-07-21T16:57:46Z", "path": "runtime/util/hshelp.c", "diffHunk": "@@ -2469,8 +2469,15 @@ recreateRAMClasses(J9VMThread * currentThread, J9HashTable * classHashTable, J9H\n \t\tif (fastHCR) {\n \t\t\toptions |= J9_FINDCLASS_FLAG_FAST_HCR;\n \t\t}\n-\n-\t\tif (J9_ARE_ALL_BITS_SET(originalRAMClass->classFlags, J9ClassIsAnonymous)) {\n+\t\tif (J9_ARE_ANY_BITS_SET(originalRAMClass->romClass->extraModifiers, J9AccClassHiddenClass)) {", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM1MzMwNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458353304", "bodyText": "Fixed.", "author": "hangshao0", "createdAt": "2020-07-21T20:00:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0ODg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0OTA4OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458249089", "bodyText": "macro please", "author": "gacholio", "createdAt": "2020-07-21T16:58:08Z", "path": "runtime/util/hshelp.c", "diffHunk": "@@ -3440,7 +3447,16 @@ reloadROMClasses(J9VMThread * currentThread, jint class_count, const jvmtiClassD\n \t\t\toptions = options | J9_FINDCLASS_FLAG_UNSAFE;\n \t\t}\n \t\tloadData.classLoader = originalRAMClass->classLoader;\n-\t\tif (J9_ARE_ALL_BITS_SET(originalRAMClass->classFlags, J9ClassIsAnonymous)) {\n+\t\tif (J9_ARE_ANY_BITS_SET(originalRAMClass->romClass->extraModifiers, J9AccClassHiddenClass)) {", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM1MzU1Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458353553", "bodyText": "Fixed.", "author": "hangshao0", "createdAt": "2020-07-21T20:00:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0OTA4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0OTM5MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458249391", "bodyText": "These tests could also be macros in j9modifiers_api.h", "author": "gacholio", "createdAt": "2020-07-21T16:58:36Z", "path": "runtime/util/hshelp.c", "diffHunk": "@@ -2469,8 +2469,15 @@ recreateRAMClasses(J9VMThread * currentThread, J9HashTable * classHashTable, J9H\n \t\tif (fastHCR) {\n \t\t\toptions |= J9_FINDCLASS_FLAG_FAST_HCR;\n \t\t}\n-\n-\t\tif (J9_ARE_ALL_BITS_SET(originalRAMClass->classFlags, J9ClassIsAnonymous)) {\n+\t\tif (J9_ARE_ANY_BITS_SET(originalRAMClass->romClass->extraModifiers, J9AccClassHiddenClass)) {\n+\t\t\toptions |= (J9_FINDCLASS_FLAG_HIDDEN | J9_FINDCLASS_FLAG_UNSAFE | J9_FINDCLASS_FLAG_ANON);\n+\t\t\tif (J9_ARE_ANY_BITS_SET(originalRAMClass->romClass->extraModifiers, J9AccHiddenClassOptionNestmate)) {", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM1MzQ5MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458353491", "bodyText": "Added macros.", "author": "hangshao0", "createdAt": "2020-07-21T20:00:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0OTM5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI1MDkwNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458250907", "bodyText": "Why does the EXEMPT macro allow hidden classes only to have them excluded here? Seems confusing.", "author": "gacholio", "createdAt": "2020-07-21T17:01:04Z", "path": "runtime/vm/ClassInitialization.cpp", "diffHunk": "@@ -157,11 +157,14 @@ performVerification(J9VMThread *currentThread, J9Class *clazz)\n \t\t/* See if this class should be verified:\n \t\t *\n \t\t * - Do not verify any class created by sun.misc.Unsafe\n+\t\t * - Do not verify hidden classes\n \t\t * - Do not verify any class which is marked for exclusion in the optional flags\n \t\t * - Verify every class whose bytecodes have been modified\n \t\t * - Do not verify bootstrap classes if the appropriate runtime flag is set\n \t\t */\n-\t\tif (!J9CLASS_IS_EXEMPT_FROM_VALIDATION(clazz) && J9_ARE_NO_BITS_SET(romClass->optionalFlags, J9_ROMCLASS_OPTINFO_VERIFY_EXCLUDE)) {\n+\t\tif (((!J9CLASS_IS_EXEMPT_FROM_VALIDATION(clazz)) && J9_ARE_NO_BITS_SET(romClass->extraModifiers, J9AccClassHiddenClass))", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM1NzU0OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458357549", "bodyText": "If I allow J9AccClassHiddenClass go through this, we will eventually go into https://github.com/eclipse/openj9/blob/master/runtime/bcverify/vrfyhelp.c#L957. As hidden class is not in the hashtable, we won't be find the ramclass, causing crash later inside the verifier.", "author": "hangshao0", "createdAt": "2020-07-21T20:08:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI1MDkwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI1MTE0OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458251148", "bodyText": "macros please", "author": "gacholio", "createdAt": "2020-07-21T17:01:27Z", "path": "runtime/vm/classsupport.c", "diffHunk": "@@ -223,7 +223,15 @@ internalCreateArrayClass(J9VMThread* vmThread, J9ROMArrayClass* romClass, J9Clas\n #endif /* defined(J9VM_OPT_VALHALLA_VALUE_TYPES) */\n \n \tif (elementInitSuccess) {\n-\t\tif (J9_ARE_ANY_BITS_SET(elementClass->classFlags, J9ClassIsAnonymous)) {\n+\t\tif (J9_ARE_ANY_BITS_SET(elementClass->romClass->extraModifiers, J9AccClassHiddenClass)) {", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM1MzcyNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458353726", "bodyText": "Fixed.", "author": "hangshao0", "createdAt": "2020-07-21T20:00:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI1MTE0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI1MTc0MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458251741", "bodyText": "brackets please", "author": "gacholio", "createdAt": "2020-07-21T17:02:26Z", "path": "runtime/vm/visible.c", "diffHunk": "@@ -283,9 +283,20 @@ loadAndVerifyNestHost(J9VMThread *vmThread, J9Class *clazz, UDATA options)\n \t\tJ9UTF8 *nestHostName = J9ROMCLASS_NESTHOSTNAME(romClass);\n \t\tBOOLEAN canRunJavaCode = J9_ARE_NO_BITS_SET(options, J9_LOOK_NO_JAVA);\n \t\tBOOLEAN throwException = canRunJavaCode && J9_ARE_NO_BITS_SET(options, J9_LOOK_NO_THROW);\n+\t\tBOOLEAN hiddenNestMate = J9_ARE_ALL_BITS_SET(romClass->extraModifiers, J9AccHiddenClassOptionNestmate);\n+\n+\t\tJ9Class* curClazz = clazz;\n+\t\tBOOLEAN isCurClassHiddenNestMate = hiddenNestMate;\n+\t\twhile (isCurClassHiddenNestMate && curClazz != curClazz->hostClass) {", "originalCommit": "67b5c5ccaa30e00b57873e4ef88845d18d564fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM1Mzc5NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458353794", "bodyText": "Fixed.", "author": "hangshao0", "createdAt": "2020-07-21T20:01:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI1MTc0MQ=="}], "type": "inlineReview"}, {"oid": "b3e8431939d03e1a10cb4d210a0264353355b68b", "url": "https://github.com/eclipse-openj9/openj9/commit/b3e8431939d03e1a10cb4d210a0264353355b68b", "message": "JEP371 implementation part 2.\n\n1. Add a new API defineClassImpl1() in classLoader.java.\n2. Replace Unsafe.defineAnonymousClass() with the new API to \ndefine hidden classes.\n3. Add J9AccClassHiddenClass, J9AccHiddenClassOptionNestmate and\nJ9AccHiddenClassOptionStrong.\n4. Disable class sharing (and SCC tests) for hidden class for now. \n\nHidden classes are treated the same as unsafe anonymous \nclasses, except: \na) Its defining classloader is the loader of its hostclass.\nb) It has J9AccClassHiddenClass set.\nc) If defined with NESTMATE/STRONG,\nJ9AccHiddenClassOptionNestmate/J9AccHiddenClassOptionStrong \nwill be set.\n\nissue #9328\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-07-21T19:29:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg2NjMzMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458866332", "bodyText": "The trailing Class here seems superfluous.", "author": "gacholio", "createdAt": "2020-07-22T15:10:02Z", "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -1059,17 +1059,17 @@ ROMClassBuilder::finishPrepareAndLaydown(\n  *                                  + UNUSED\n  *                                 + UNUSED\n  *                                + UNUSED\n- *                               + UNUSED\n+ *                              + J9AccClassHiddenOptionNestmate\n  *\n- *                             + UNUSED\n+ *                             + J9AccClassHiddenOptionStrong\n  *                            + AccSealed\n  *                           + AccRecord\n  *                          + AccClassAnonClass\n  *\n  *                        + AccSynthetic (matches Oracle modifier position)\n  *                       + AccClassUseBisectionSearch\n  *                      + AccClassInnerClass\n- *                     + UNUSED\n+ *                     + J9AccClassHiddenClass", "originalCommit": "b3e8431939d03e1a10cb4d210a0264353355b68b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNjA4Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458916086", "bodyText": "I'd still like this changed.", "author": "gacholio", "createdAt": "2020-07-22T16:20:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg2NjMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNzc1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r458917759", "bodyText": "I'd still like this changed.\n\nYes, I will change this. But after lunch.", "author": "hangshao0", "createdAt": "2020-07-22T16:22:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg2NjMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNTczNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10207#discussion_r459005734", "bodyText": "Fixed.", "author": "hangshao0", "createdAt": "2020-07-22T18:42:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg2NjMzMg=="}], "type": "inlineReview"}, {"oid": "deefdae6712d8bd417c25c638cd58b29dc674891", "url": "https://github.com/eclipse-openj9/openj9/commit/deefdae6712d8bd417c25c638cd58b29dc674891", "message": "JEP371 implementation part 2.\n\n1. Add a new API defineClassImpl1() in classLoader.java.\n2. Replace Unsafe.defineAnonymousClass() with the new API to \ndefine hidden classes.\n3. Add J9AccClassHiddenClass, J9AccHiddenClassOptionNestmate and\nJ9AccHiddenClassOptionStrong.\n4. Disable class sharing (and SCC tests) for hidden class for now. \n\nHidden classes are treated the same as unsafe anonymous \nclasses, except: \na) Its defining classloader is the loader of its hostclass.\nb) It has J9AccClassHiddenClass set.\nc) If defined with NESTMATE/STRONG,\nJ9AccHiddenClassOptionNestmate/J9AccHiddenClassOptionStrong \nwill be set.\n\nissue #9328\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-07-22T18:41:51Z", "type": "forcePushed"}, {"oid": "c5d177d499d1a5da295be3d213d77f37169646ff", "url": "https://github.com/eclipse-openj9/openj9/commit/c5d177d499d1a5da295be3d213d77f37169646ff", "message": "JEP371 implementation part 2.\n\n1. Add a new API defineClassImpl1() in classLoader.java.\n2. Replace Unsafe.defineAnonymousClass() with the new API to \ndefine hidden classes.\n3. Add J9AccClassHiddenClass, J9AccHiddenClassOptionNestmate and\nJ9AccHiddenClassOptionStrong.\n4. Disable class sharing (and SCC tests) for hidden class for now. \n\nHidden classes are treated the same as unsafe anonymous \nclasses, except: \na) Its defining classloader is the loader of its hostclass.\nb) It has J9AccClassHiddenClass set.\nc) If defined with NESTMATE/STRONG,\nJ9AccHiddenClassOptionNestmate/J9AccHiddenClassOptionStrong \nwill be set.\n\nissue #9328\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-07-22T19:06:34Z", "type": "commit"}, {"oid": "c5d177d499d1a5da295be3d213d77f37169646ff", "url": "https://github.com/eclipse-openj9/openj9/commit/c5d177d499d1a5da295be3d213d77f37169646ff", "message": "JEP371 implementation part 2.\n\n1. Add a new API defineClassImpl1() in classLoader.java.\n2. Replace Unsafe.defineAnonymousClass() with the new API to \ndefine hidden classes.\n3. Add J9AccClassHiddenClass, J9AccHiddenClassOptionNestmate and\nJ9AccHiddenClassOptionStrong.\n4. Disable class sharing (and SCC tests) for hidden class for now. \n\nHidden classes are treated the same as unsafe anonymous \nclasses, except: \na) Its defining classloader is the loader of its hostclass.\nb) It has J9AccClassHiddenClass set.\nc) If defined with NESTMATE/STRONG,\nJ9AccHiddenClassOptionNestmate/J9AccHiddenClassOptionStrong \nwill be set.\n\nissue #9328\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-07-22T19:06:34Z", "type": "forcePushed"}]}