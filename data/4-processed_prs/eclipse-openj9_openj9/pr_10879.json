{"pr_number": 10879, "pr_title": "Print `initialized` stanza to each file", "pr_createdAt": "2020-10-14T02:44:26Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10879", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1NTc1Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10879#discussion_r504755756", "bodyText": "Is this function still needed?", "author": "RSalman", "createdAt": "2020-10-14T15:07:53Z", "path": "runtime/gc_verbose_java/VerboseHandlerJava.cpp", "diffHunk": "@@ -62,6 +63,26 @@ MM_VerboseHandlerJava::getThreadName(char *buf, UDATA bufLen, OMR_VMThread *omrT\n \treturn consumedEntireString;\n }\n \n+void\n+MM_VerboseHandlerJava::writeVmArgs(MM_EnvironmentBase* env, MM_VerboseBuffer * buffer, J9JavaVM *vm)\n+{\n+\tPORT_ACCESS_FROM_JAVAVM(vm);\n+\tJavaVMInitArgs* vmArgs = vm->vmArgsArray->actualVMArgs;\n+\tbuffer->formatAndOutput(env,  1, \"<vmargs>\");\n+\tfor (jint i = 0; i < vmArgs->nOptions; ++i) {\n+\t\tchar escapedXMLString[128];\n+\t\tUDATA optLen = strlen(vmArgs->options[i].optionString);\n+\t\tUDATA escapeConsumed = escapeXMLString(OMRPORT_FROM_J9PORT(PORTLIB), escapedXMLString, sizeof(escapedXMLString), vmArgs->options[i].optionString, optLen);\n+\t\tconst char* dots = (escapeConsumed < optLen) ? \"...\" : \"\";\n+\t\tif (NULL == vmArgs->options[i].extraInfo) {\n+\t\t\tbuffer->formatAndOutput(env,  2, \"<vmarg name=\\\"%s%s\\\" />\", escapedXMLString, dots);\n+\t\t} else {\n+\t\t\tbuffer->formatAndOutput(env,  2, \"<vmarg name=\\\"%s%s\\\" value=\\\"%p\\\" />\", escapedXMLString, dots, vmArgs->options[i].extraInfo);\n+\t\t}\n+\t}\n+\tbuffer->formatAndOutput(env,  1, \"</vmargs>\");\n+}\n+\n void\n MM_VerboseHandlerJava::writeVmArgs(MM_VerboseManager *manager, MM_EnvironmentBase* env, J9JavaVM *vm)", "originalCommit": "5e66561ab8de5c84f27298d54692c98f1f5eca99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1NzQ2OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10879#discussion_r504757469", "bodyText": "New line isn't needed here", "author": "RSalman", "createdAt": "2020-10-14T15:10:05Z", "path": "runtime/gc_verbose_handler_realtime/VerboseHandlerOutputRealtime.cpp", "diffHunk": "@@ -35,6 +37,7 @@\n #include \"mmhook.h\"\n #include \"mmprivatehook.h\"\n \n+", "originalCommit": "5e66561ab8de5c84f27298d54692c98f1f5eca99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9f585b47aa31935cf5a02dc9f7b93eeaabddf4ce", "url": "https://github.com/eclipse-openj9/openj9/commit/9f585b47aa31935cf5a02dc9f7b93eeaabddf4ce", "message": "off\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-10-15T00:18:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NTI4MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10879#discussion_r505885281", "bodyText": "Please look into if this needs to be changed to use buffer. I think it does like outputInitializedInnerStanza is", "author": "RSalman", "createdAt": "2020-10-15T21:51:21Z", "path": "runtime/gc_verbose_handler_realtime/VerboseHandlerOutputRealtime.cpp", "diffHunk": "@@ -173,22 +175,24 @@ MM_VerboseHandlerOutputRealtime::getCycleType(UDATA type)\n \treturn cycleType;\n }\n \n+void\n+MM_VerboseHandlerOutputRealtime::outputInitializedInnerStanza(MM_EnvironmentBase *env, MM_VerboseBuffer *buffer){\n+\tMM_GCExtensionsBase *extension = env->getExtensions();\n+\tbuffer->formatAndOutput(env, 1, \"<metronome>\");\t\n+\tbuffer->formatAndOutput(env, 2, \"<attribute name=\\\"beatsPerMeasure\\\" value=\\\"%zu\\\" />\", extension->beatMicro);\n+\tbuffer->formatAndOutput(env, 2, \"<attribute name=\\\"timeInterval\\\" value=\\\"%zu\\\" />\", extension->timeWindowMicro);\n+\tbuffer->formatAndOutput(env, 2, \"<attribute name=\\\"targetUtilization\\\" value=\\\"%zu\\\" />\", extension->targetUtilizationPercentage);\n+\tbuffer->formatAndOutput(env, 2, \"<attribute name=\\\"trigger\\\" value=\\\"0x%zx\\\" />\", extension->gcTrigger);\n+\tbuffer->formatAndOutput(env, 2, \"<attribute name=\\\"headRoom\\\" value=\\\"0x%zx\\\" />\", extension->headRoom);\n+\tbuffer->formatAndOutput(env, 1, \"</metronome>\");\n+}\n void\n MM_VerboseHandlerOutputRealtime::handleInitializedInnerStanzas(J9HookInterface** hook, UDATA eventNum, void* eventData)\n {\n \tMM_InitializedEvent* event = (MM_InitializedEvent*)eventData;\n-\tMM_VerboseWriterChain* writer = _manager->getWriterChain();\n \tMM_EnvironmentBase* env = MM_EnvironmentBase::getEnvironment(event->currentThread);\n-\n \thandleInitializedRegion(hook, eventNum, eventData);", "originalCommit": "f9752bbe51f8f69aba37cae78e8e86309e1d2ab6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4f28fe38ea2281b318fdd02a13a67738c31e307b", "url": "https://github.com/eclipse-openj9/openj9/commit/4f28fe38ea2281b318fdd02a13a67738c31e307b", "message": "metrotome\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-10-19T17:25:53Z", "type": "forcePushed"}, {"oid": "1b43246c7d028ab453ff8dbdecdc14611fbc2666", "url": "https://github.com/eclipse-openj9/openj9/commit/1b43246c7d028ab453ff8dbdecdc14611fbc2666", "message": "metrotome\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-10-19T17:26:29Z", "type": "forcePushed"}, {"oid": "835c0a29c73d24e87ef72b2ffe7775e73344f352", "url": "https://github.com/eclipse-openj9/openj9/commit/835c0a29c73d24e87ef72b2ffe7775e73344f352", "message": "metrotome\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-10-19T17:31:32Z", "type": "forcePushed"}, {"oid": "ecff8cbf32838a8933dbf3a12e5e40bd5ef979ef", "url": "https://github.com/eclipse-openj9/openj9/commit/ecff8cbf32838a8933dbf3a12e5e40bd5ef979ef", "message": "metrotome\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-10-19T17:34:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEzMTk3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10879#discussion_r508131972", "bodyText": "Minor formatting: space before J9JavaVM..", "author": "RSalman", "createdAt": "2020-10-20T00:07:41Z", "path": "runtime/gc_verbose_java/VerboseHandlerJava.hpp", "diffHunk": "@@ -51,7 +52,7 @@ class MM_VerboseHandlerJava : public MM_Base\n \t/**\n \t * Output Java VM arguments.\n \t */\n-\tstatic void writeVmArgs(MM_VerboseManager *manager, MM_EnvironmentBase* env, J9JavaVM *vm);\n+\tstatic void writeVmArgs(MM_EnvironmentBase* env, MM_VerboseBuffer* buffer,J9JavaVM* vm);", "originalCommit": "d82093a432ab21de10528a7db609749614d24a08", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1OTg1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10879#discussion_r513759859", "bodyText": "Minor nit pick: extension to extensions", "author": "RSalman", "createdAt": "2020-10-28T21:05:27Z", "path": "runtime/gc_verbose_handler_realtime/VerboseHandlerOutputRealtime.cpp", "diffHunk": "@@ -174,21 +176,16 @@ MM_VerboseHandlerOutputRealtime::getCycleType(UDATA type)\n }\n \n void\n-MM_VerboseHandlerOutputRealtime::handleInitializedInnerStanzas(J9HookInterface** hook, UDATA eventNum, void* eventData)\n-{\n-\tMM_InitializedEvent* event = (MM_InitializedEvent*)eventData;\n-\tMM_VerboseWriterChain* writer = _manager->getWriterChain();\n-\tMM_EnvironmentBase* env = MM_EnvironmentBase::getEnvironment(event->currentThread);\n-\n-\thandleInitializedRegion(hook, eventNum, eventData);\n-\n-\twriter->formatAndOutput(env, 1, \"<metronome>\");\n-\twriter->formatAndOutput(env, 2, \"<attribute name=\\\"beatsPerMeasure\\\" value=\\\"%zu\\\" />\", event->beat);\n-\twriter->formatAndOutput(env, 2, \"<attribute name=\\\"timeInterval\\\" value=\\\"%zu\\\" />\", event->timeWindow);\n-\twriter->formatAndOutput(env, 2, \"<attribute name=\\\"targetUtilization\\\" value=\\\"%zu\\\" />\", event->targetUtilization);\n-\twriter->formatAndOutput(env, 2, \"<attribute name=\\\"trigger\\\" value=\\\"0x%zx\\\" />\", event->gcTrigger);\n-\twriter->formatAndOutput(env, 2, \"<attribute name=\\\"headRoom\\\" value=\\\"0x%zx\\\" />\", event->headRoom);\n-\twriter->formatAndOutput(env, 1, \"</metronome>\");\n+MM_VerboseHandlerOutputRealtime::outputInitializedInnerStanza(MM_EnvironmentBase *env, MM_VerboseBuffer *buffer){\n+\tMM_GCExtensionsBase *extension = env->getExtensions();", "originalCommit": "f5b1679b0299147065666de5f2bdd9d9ea292b58", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "06e961dfc8d99d0d2e9f84af6d644c5817cfbbdf", "url": "https://github.com/eclipse-openj9/openj9/commit/06e961dfc8d99d0d2e9f84af6d644c5817cfbbdf", "message": "Revert \"use MM_InitializedEvent_FULL\"\n\nThis reverts commit 207d19ca27c43a6db24ea9ee234ab77d7fcb9f89.", "committedDate": "2020-11-10T22:54:49Z", "type": "forcePushed"}, {"oid": "95208c223a0d506793a1be121e64fddb3c00edf4", "url": "https://github.com/eclipse-openj9/openj9/commit/95208c223a0d506793a1be121e64fddb3c00edf4", "message": "Revert \"use MM_InitializedEvent_FULL\"\n\nThis reverts commit 207d19ca27c43a6db24ea9ee234ab77d7fcb9f89.", "committedDate": "2020-11-27T20:31:27Z", "type": "forcePushed"}, {"oid": "fb5ac060cfff3fe00f009e7823f80831e568d115", "url": "https://github.com/eclipse-openj9/openj9/commit/fb5ac060cfff3fe00f009e7823f80831e568d115", "message": "off\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-12-01T16:27:32Z", "type": "forcePushed"}, {"oid": "22109df78e63f256b2ea627e898c163260bda3c0", "url": "https://github.com/eclipse-openj9/openj9/commit/22109df78e63f256b2ea627e898c163260bda3c0", "message": "Print `initialized` stanza to each file\nhttps://github.com/eclipse/omr/pull/5607\n\nWhen using `-Xverbosegclog` flag, prints 'Initialized' stanza at the beginning of each file.\nIn order to achieve this, following changes have been made:\n\nIn `MM_VerboseHandlerOutputRealtime`:\n- Replace `handleInitializedInnerStanzas()` with `outputInitializedInnerStanza()` to print\n `metronome` stanza to one `VerboseBuffer`.\n\nIn `MM_VerboseHandlerOutputStandardJava`, 'MM_VerboseHandlerOutputRealtime',\n'MM_VerboseHandlerJava', modify `writeVmArgs()` to take a `VerboseBuffer`.\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-12-01T16:50:02Z", "type": "forcePushed"}, {"oid": "d32e87bc97ed3499dd18955c317b31ad43fa4d83", "url": "https://github.com/eclipse-openj9/openj9/commit/d32e87bc97ed3499dd18955c317b31ad43fa4d83", "message": "Print `initialized` stanza to each file\nhttps://github.com/eclipse/omr/pull/5607\n\nWhen using `-Xverbosegclog` flag, prints 'Initialized' stanza at the beginning of each file.\nIn order to achieve this, following changes have been made:\n\nIn `MM_VerboseHandlerOutputRealtime`:\n- Replace `handleInitializedInnerStanzas()` with `outputInitializedInnerStanza()` to print\n `metronome` stanza to one `VerboseBuffer`.\n\nIn `MM_VerboseHandlerOutputStandardJava`, 'MM_VerboseHandlerOutputRealtime',\n'MM_VerboseHandlerJava', modify `writeVmArgs()` to take a `VerboseBuffer`.\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-12-01T16:57:05Z", "type": "forcePushed"}, {"oid": "28fc8847241ef319ed4b8b3ddaabe449c1c87ca0", "url": "https://github.com/eclipse-openj9/openj9/commit/28fc8847241ef319ed4b8b3ddaabe449c1c87ca0", "message": "Print `initialized` stanza to each file\nhttps://github.com/eclipse/omr/pull/5607\n\nWhen using `-Xverbosegclog` flag, prints 'Initialized' stanza at the beginning of each file.\nIn order to achieve this, following changes have been made:\n\nIn `MM_VerboseHandlerOutputRealtime`:\n- Replace `handleInitializedInnerStanzas()` with `outputInitializedInnerStanza()` to print\n `metronome` stanza to one `VerboseBuffer`.\n\nIn `MM_VerboseHandlerOutputStandardJava`, 'MM_VerboseHandlerOutputRealtime',\n'MM_VerboseHandlerJava', modify `writeVmArgs()` to take a `VerboseBuffer`.\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-12-01T16:59:32Z", "type": "commit"}, {"oid": "28fc8847241ef319ed4b8b3ddaabe449c1c87ca0", "url": "https://github.com/eclipse-openj9/openj9/commit/28fc8847241ef319ed4b8b3ddaabe449c1c87ca0", "message": "Print `initialized` stanza to each file\nhttps://github.com/eclipse/omr/pull/5607\n\nWhen using `-Xverbosegclog` flag, prints 'Initialized' stanza at the beginning of each file.\nIn order to achieve this, following changes have been made:\n\nIn `MM_VerboseHandlerOutputRealtime`:\n- Replace `handleInitializedInnerStanzas()` with `outputInitializedInnerStanza()` to print\n `metronome` stanza to one `VerboseBuffer`.\n\nIn `MM_VerboseHandlerOutputStandardJava`, 'MM_VerboseHandlerOutputRealtime',\n'MM_VerboseHandlerJava', modify `writeVmArgs()` to take a `VerboseBuffer`.\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-12-01T16:59:32Z", "type": "forcePushed"}]}