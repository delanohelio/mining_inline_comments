{"pr_number": 8632, "pr_title": "Resolve the race condition setting/reading _theca->cacheFullFlags", "pr_createdAt": "2020-02-21T19:22:44Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8632", "timeline": [{"oid": "f4a407996d1365f83f01a34645a87e781f68cf06", "url": "https://github.com/eclipse-openj9/openj9/commit/f4a407996d1365f83f01a34645a87e781f68cf06", "message": "Minimize the race condition time window setting/reading cacheFullFlags\n\nRead _theca->cacheFullFlags into local variable cacheFullFlags right\nbefore it is used. \n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-02-21T19:23:31Z", "type": "forcePushed"}, {"oid": "c95e1a463684c0c70c6b1994422326dcb38a908f", "url": "https://github.com/eclipse-openj9/openj9/commit/c95e1a463684c0c70c6b1994422326dcb38a908f", "message": "Minimize the race condition time window setting/reading cacheFullFlags\n\nRead _theca->cacheFullFlags into local variable cacheFullFlags right\nbefore it is used. \n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-02-21T19:38:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc4MTYyOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8632#discussion_r382781629", "bodyText": "This isn't a fix, you can use compare and swap to fix it.", "author": "pshipton", "createdAt": "2020-02-21T20:06:31Z", "path": "runtime/shared_common/CompositeCache.cpp", "diffHunk": "@@ -6813,7 +6813,7 @@ SH_CompositeCacheImpl::updateRuntimeFullFlags(J9VMThread *currentThread)\n \tif (_readOnlyOSCache || J9_ARE_ALL_BITS_SET(*_runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_READONLY)) {\n \t\tgoto done;\n \t}\n-\n+\tcacheFullFlags = _theca->cacheFullFlags;", "originalCommit": "c95e1a463684c0c70c6b1994422326dcb38a908f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgwMDE4OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8632#discussion_r382800188", "bodyText": "You mean compare and swap on local variable cacheFullFlags ?", "author": "hangshao0", "createdAt": "2020-02-21T20:52:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc4MTYyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgwNTMwNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8632#discussion_r382805304", "bodyText": "The time window I find in the old code is between line 6802 and line 6817. Line 6802 got a value of 0 from  _theca->cacheFullFlags.  When doing comparison at line 6817, both _theca->cacheFullFlags and _cacheFullFlags are changed by another thread. The current thread is still using a cached cacheFullFlags which is 0 .", "author": "hangshao0", "createdAt": "2020-02-21T21:05:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc4MTYyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0NDAzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8632#discussion_r382844030", "bodyText": "Compare and swap can be used to combine the test _cacheFullFlags == cacheFullFlags and the assignment _cacheFullFlags = cacheFullFlags into one atomic operation. Sounds like the fetch of _theca->cacheFullFlags, the test and the assignment need to be protected by a monitor. Is the code that changed _theca->cacheFullFlags in another thread using any monitor?", "author": "pshipton", "createdAt": "2020-02-21T22:53:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc4MTYyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM4NTQ0OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8632#discussion_r383385448", "bodyText": "The other thread is changing _theca->cacheFullFlags, _cacheFullFlags  and the runtime flags here:\nhttps://github.com/eclipse/openj9/blob/master/runtime/shared_common/CompositeCache.cpp#L6142to#L6150\nIt is not using a monitor. But it is inside the write mutex.\nWe shouldn't cache the obsolete _theca->cacheFullFlags value to the local variable cacheFullFlags and use the obsolete value to update the runtime flags.  I think we should fetch the latest _theca->cacheFullFlags to update the runtime flags.", "author": "hangshao0", "createdAt": "2020-02-24T16:50:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc4MTYyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5MTI3Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8632#discussion_r383491276", "bodyText": "Since a thread switch can occur at any time, and the cpu is free to move code around somewhat, changing the source to move the fetch of _theca->cacheFullFlags closer to the test isn't a proper fix. Some kind of synchronization needs to be used to guarantee consistent results.", "author": "pshipton", "createdAt": "2020-02-24T20:16:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc4MTYyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUzMTM0OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8632#discussion_r383531348", "bodyText": "Moved the setting of _cacheFullFlags and its comparison against\n_theca->cacheFullFlags inside _runtimeFlagsProtectMutex.", "author": "hangshao0", "createdAt": "2020-02-24T21:41:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc4MTYyOQ=="}], "type": "inlineReview"}, {"oid": "ac58876496792333251e977fc1401b419807728a", "url": "https://github.com/eclipse-openj9/openj9/commit/ac58876496792333251e977fc1401b419807728a", "message": "Resolve the race condition setting/reading _theca->cacheFullFlags\n\nCompare _cacheFullFlags against _theca->cacheFullFlags to see if\n_theca->cacheFullFlags has been updated. If yes, use the latest\n_theca->cacheFullFlags value to set runtime flags.\n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-02-24T17:07:23Z", "type": "forcePushed"}, {"oid": "5a0ea7a171e8ec94b4bb7394ac9940cd0c9f6398", "url": "https://github.com/eclipse-openj9/openj9/commit/5a0ea7a171e8ec94b4bb7394ac9940cd0c9f6398", "message": "Resolve the race condition setting/reading _theca->cacheFullFlags\n\nCompare _cacheFullFlags against _theca->cacheFullFlags to see if\n_theca->cacheFullFlags has been updated. If yes, use the latest\n_theca->cacheFullFlags value to set runtime flags.\n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-02-24T21:29:29Z", "type": "forcePushed"}, {"oid": "5b4d136b98813a83276c6f2a5e6a612003d55a71", "url": "https://github.com/eclipse-openj9/openj9/commit/5b4d136b98813a83276c6f2a5e6a612003d55a71", "message": "Resolve the race condition setting/reading _theca->cacheFullFlags\n\nCompare _cacheFullFlags against _theca->cacheFullFlags to see if\n_theca->cacheFullFlags has been updated. If yes, use the latest\n_theca->cacheFullFlags value to set runtime flags.\n\nMove the setting of _cacheFullFlags and its comparison against\n_theca->cacheFullFlags inside _runtimeFlagsProtectMutex.\n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-02-24T21:39:49Z", "type": "commit"}, {"oid": "5b4d136b98813a83276c6f2a5e6a612003d55a71", "url": "https://github.com/eclipse-openj9/openj9/commit/5b4d136b98813a83276c6f2a5e6a612003d55a71", "message": "Resolve the race condition setting/reading _theca->cacheFullFlags\n\nCompare _cacheFullFlags against _theca->cacheFullFlags to see if\n_theca->cacheFullFlags has been updated. If yes, use the latest\n_theca->cacheFullFlags value to set runtime flags.\n\nMove the setting of _cacheFullFlags and its comparison against\n_theca->cacheFullFlags inside _runtimeFlagsProtectMutex.\n\nFixes #8628\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-02-24T21:39:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0ODQ5Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8632#discussion_r383548493", "bodyText": "I don't see the corresponding omrthread_monitor_exit()", "author": "pshipton", "createdAt": "2020-02-24T22:18:56Z", "path": "runtime/shared_common/CompositeCache.cpp", "diffHunk": "@@ -6813,16 +6813,19 @@ SH_CompositeCacheImpl::updateRuntimeFullFlags(J9VMThread *currentThread)\n \tif (_readOnlyOSCache || J9_ARE_ALL_BITS_SET(*_runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_READONLY)) {\n \t\tgoto done;\n \t}\n-\n-\tif (_cacheFullFlags == cacheFullFlags) {\n+\t\n+\t/* It is possible we take _headerProtectMutex inside _runtimeFlagsProtectMutex.\n+\t * So assert we do not hold _headerProtectMutex before taking _runtimeFlagsProtectMutex.\n+\t */\n+\tTrc_SHR_Assert_True(1 != omrthread_monitor_owned_by_self(_headerProtectMutex));\n+\tomrthread_monitor_enter(_runtimeFlagsProtectMutex);", "originalCommit": "5b4d136b98813a83276c6f2a5e6a612003d55a71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0ODc1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8632#discussion_r383548759", "bodyText": "nm, it's already there.", "author": "pshipton", "createdAt": "2020-02-24T22:19:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0ODQ5Mw=="}], "type": "inlineReview"}]}