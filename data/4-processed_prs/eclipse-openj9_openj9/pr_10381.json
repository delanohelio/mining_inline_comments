{"pr_number": 10381, "pr_title": "JEP 360/JEP 384 Sealed classes and records DDR support", "pr_createdAt": "2020-08-12T21:07:15Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10381", "timeline": [{"oid": "e019a4cf23453d8244dd92f604b9c83fccdd6f0b", "url": "https://github.com/eclipse-openj9/openj9/commit/e019a4cf23453d8244dd92f604b9c83fccdd6f0b", "message": "JEP 360/JEP 384 Sealed classes and records ddr support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-08-12T21:12:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkzNjU0Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r469936547", "bodyText": "Please keep imports sorted.", "author": "keithc-ca", "createdAt": "2020-08-13T13:06:47Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/j9/OptInfo.java", "diffHunk": "@@ -30,6 +30,7 @@\n import static com.ibm.j9ddr.vm29.structure.J9NonbuilderConstants.J9_ROMCLASS_OPTINFO_SOURCE_DEBUG_EXTENSION;\n import static com.ibm.j9ddr.vm29.structure.J9NonbuilderConstants.J9_ROMCLASS_OPTINFO_SOURCE_FILE_NAME;\n import static com.ibm.j9ddr.vm29.structure.J9NonbuilderConstants.J9_ROMCLASS_OPTINFO_TYPE_ANNOTATION_INFO;\n+import static com.ibm.j9ddr.vm29.structure.J9NonbuilderConstants.J9_ROMCLASS_OPTINFO_PERMITTEDSUBCLASSES_ATTRIBUTE;", "originalCommit": "e019a4cf23453d8244dd92f604b9c83fccdd6f0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkzNzI0Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r469937243", "bodyText": "Please remove trailing whitespace (at least in new code).", "author": "keithc-ca", "createdAt": "2020-08-13T13:07:56Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/j9/OptInfo.java", "diffHunk": "@@ -236,4 +237,33 @@ public static J9SourceDebugExtensionPointer getSourceDebugExtensionForROMClass(J\n \t\treturn J9SourceDebugExtensionPointer.NULL;\n \t}\n \n+\tprivate static U32Pointer getPermittedSubclassPointer(J9ROMClassPointer romClass) throws CorruptDataException {\n+\t\tSelfRelativePointer srpPtr = getSRPPtr(J9ROMClassHelper.optionalInfo(romClass), romClass.optionalFlags(), \n+\t\t\tJ9_ROMCLASS_OPTINFO_PERMITTEDSUBCLASSES_ATTRIBUTE);\n+\t\tif (!srpPtr.isNull()) {\n+\t\t\treturn U32Pointer.cast(srpPtr.get());\n+\t\t}\t", "originalCommit": "e019a4cf23453d8244dd92f604b9c83fccdd6f0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1MTUwNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r469951505", "bodyText": "Please leave a blank line between methods.", "author": "keithc-ca", "createdAt": "2020-08-13T13:29:48Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/RomClassWalker.java", "diffHunk": "@@ -846,6 +860,54 @@ int allSlotsInVerificationTypeInfoDo(U8Pointer cursor) throws CorruptDataExcepti\n \t\t}\n \t\treturn 3;\n \t}\n+\tvoid recordAttributeDo(U32Pointer attribute) throws CorruptDataException", "originalCommit": "e019a4cf23453d8244dd92f604b9c83fccdd6f0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1NjIwNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r469956204", "bodyText": "Have you verified that no tests are affected by this change?", "author": "keithc-ca", "createdAt": "2020-08-13T13:36:21Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/commands/J9BCUtil.java", "diffHunk": "@@ -557,10 +557,10 @@ public static void j9bcutil_dumpRomClass(PrintStream out, J9ROMClassPointer romC\n \t\t/* dump the enclosing method */\n \t\tdumpEnclosingMethod(out, romClass, flags);\n \n-\t\tout.append(String.format(\"Sun Access Flags (0x%s): \", Long.toHexString(romClass.modifiers().longValue())));\n+\t\tout.append(String.format(\"Oracle Access Flags (0x%s): \", Long.toHexString(romClass.modifiers().longValue())));", "originalCommit": "e019a4cf23453d8244dd92f604b9c83fccdd6f0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk3MjEwMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r469972103", "bodyText": "No. I will try it out.", "author": "theresa-m", "createdAt": "2020-08-13T13:58:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1NjIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAxNTU1OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r470015558", "bodyText": "The OpenJ9 DDR tests are passing for me locally.", "author": "theresa-m", "createdAt": "2020-08-13T14:57:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1NjIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA2MDg3Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r470060873", "bodyText": "As I think about this again, I think (given we're changing things) that it should not refer to 'Sun' or 'Oracle': How about 'Basic Access Flags'?", "author": "keithc-ca", "createdAt": "2020-08-13T16:03:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1NjIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA2NzY5OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r470067699", "bodyText": "Agreed. I originally added Oracle to match the statement in rcdump.c but I think both should be updated.", "author": "theresa-m", "createdAt": "2020-08-13T16:14:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1NjIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1Nzk0OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r469957948", "bodyText": "Please instead use out.format(\"Permitted subclasses (%d):%n\", permittedSubclassCount)\n\n%n expresses the desired newline\nthere's no need to build the string locally", "author": "keithc-ca", "createdAt": "2020-08-13T13:38:57Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/commands/J9BCUtil.java", "diffHunk": "@@ -610,6 +610,18 @@ public static void j9bcutil_dumpRomClass(PrintStream out, J9ROMClassPointer romC\n \t\t\t}\n \t\t}\n \n+\t\t/* Permitted subclasses for a sealed class */\n+\t\tif (J9ROMClassHelper.isSealed(romClass)) {\n+\t\t\tint permittedSubclassCount = OptInfo.getPermittedSubclassCount(romClass);\n+\t\t\tout.append(String.format(\"Permitted subclasses (%d):\" + nl, permittedSubclassCount));", "originalCommit": "e019a4cf23453d8244dd92f604b9c83fccdd6f0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1ODcwMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r469958702", "bodyText": "out.format(\"   %s%n\", J9UTF8Helper.stringValue(permittedSubclassName));", "author": "keithc-ca", "createdAt": "2020-08-13T13:40:03Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/commands/J9BCUtil.java", "diffHunk": "@@ -610,6 +610,18 @@ public static void j9bcutil_dumpRomClass(PrintStream out, J9ROMClassPointer romC\n \t\t\t}\n \t\t}\n \n+\t\t/* Permitted subclasses for a sealed class */\n+\t\tif (J9ROMClassHelper.isSealed(romClass)) {\n+\t\t\tint permittedSubclassCount = OptInfo.getPermittedSubclassCount(romClass);\n+\t\t\tout.append(String.format(\"Permitted subclasses (%d):\" + nl, permittedSubclassCount));\n+\n+\t\t\tfor (int i = 0; i < permittedSubclassCount; i++) {\n+\t\t\t\tJ9UTF8Pointer permittedSubclassName = OptInfo.getPermittedSubclassNameAtIndex(romClass, i);\n+\t\t\t\tout.append(\"   \" + J9UTF8Helper.stringValue(permittedSubclassName));\n+\t\t\t\tout.append(nl);", "originalCommit": "e019a4cf23453d8244dd92f604b9c83fccdd6f0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1OTE0Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r469959142", "bodyText": "Spaces after closing ) are missing.", "author": "keithc-ca", "createdAt": "2020-08-13T13:40:41Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/commands/J9BCUtil.java", "diffHunk": "@@ -715,6 +727,10 @@ private static void dumpClassJ9ExtraModifiers(PrintStream out, long accessFlags)\n \t\t\tout.append(\"(anonClass) \");\n \t\tif ((accessFlags & J9AccClassIsUnmodifiableBit) != 0)\n \t\t\tout.append(\"(unmodifiable) \");\n+\t\tif ((accessFlags & J9JavaAccessFlags.J9AccRecord) != 0)\n+\t\t\tout.append(\"(record)\");\n+\t\tif ((accessFlags & J9JavaAccessFlags.J9AccSealed) != 0)\n+\t\t\tout.append(\"(sealed)\");", "originalCommit": "e019a4cf23453d8244dd92f604b9c83fccdd6f0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk1OTUzOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r469959539", "bodyText": "formatting: please move brace to end of preceding line.", "author": "keithc-ca", "createdAt": "2020-08-13T13:41:20Z", "path": "runtime/util/rcdump.c", "diffHunk": "@@ -180,6 +181,11 @@ IDATA j9bcutil_dumpRomClass( J9ROMClass *romClass, J9PortLibrary *portLib, J9Tra\n \t\t}\n \t}\n \n+\tif (J9ROMCLASS_IS_SEALED(romClass))\n+\t{", "originalCommit": "e019a4cf23453d8244dd92f604b9c83fccdd6f0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2MDcyMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r469960723", "bodyText": "Please be consistent: * next to name instead of type:\nJ9UTF8 *permittedSubclassNameUtf8 = ...", "author": "keithc-ca", "createdAt": "2020-08-13T13:43:01Z", "path": "runtime/util/rcdump.c", "diffHunk": "@@ -823,6 +829,22 @@ dumpEnclosingMethod(J9PortLibrary *portLib, J9ROMClass *romClass, U_32 flags)\n \treturn BCT_ERR_NO_ERROR;\n }\n \n+static I_32\n+dumpPermittedSubclasses(J9PortLibrary *portLib, J9ROMClass *romClass)\n+{\n+\tPORT_ACCESS_FROM_PORT(portLib);\n+\n+\tU_32 *permittedSubclassesCountPtr = getNumberOfPermittedSubclassesPtr(romClass);\n+\tU_16 i = 0;\n+\n+\tj9tty_printf(PORTLIB, \"Permitted subclasses (%i):\\n\", *permittedSubclassesCountPtr);\n+\tfor (; i < *permittedSubclassesCountPtr; i++) {\n+\t\tJ9UTF8* permittedSubclassNameUtf8 = permittedSubclassesNameAtIndex(permittedSubclassesCountPtr, i);", "originalCommit": "e019a4cf23453d8244dd92f604b9c83fccdd6f0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2MzU5Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r469963592", "bodyText": "getNumberOfPermittedSubclassesPtr seems a strange API to me: why return a pointer (nobody appears to write to it)?\nIf we decide to change it, that change should be deferred to a separate pull request.", "author": "keithc-ca", "createdAt": "2020-08-13T13:47:03Z", "path": "runtime/util/rcdump.c", "diffHunk": "@@ -823,6 +829,22 @@ dumpEnclosingMethod(J9PortLibrary *portLib, J9ROMClass *romClass, U_32 flags)\n \treturn BCT_ERR_NO_ERROR;\n }\n \n+static I_32\n+dumpPermittedSubclasses(J9PortLibrary *portLib, J9ROMClass *romClass)\n+{\n+\tPORT_ACCESS_FROM_PORT(portLib);\n+\n+\tU_32 *permittedSubclassesCountPtr = getNumberOfPermittedSubclassesPtr(romClass);", "originalCommit": "e019a4cf23453d8244dd92f604b9c83fccdd6f0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4MTY1OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r469981658", "bodyText": "Yes its a bit odd to the other optinfo api methods. Other variable-length sections of ROM class optionalInfo have iterator like setups but that seemed like overkill to me here since its only a list of class names that is stored.\nThe list of permitted subclass names is located directly after permittedSubclassesCountPtr so permittedSubclassesNameAtIndex takes in this pointer later as a starting address to find the class name.", "author": "theresa-m", "createdAt": "2020-08-13T14:12:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2MzU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2NDI3Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r469964273", "bodyText": "formatting (here and line 1358)", "author": "keithc-ca", "createdAt": "2020-08-13T13:47:59Z", "path": "runtime/util/rcdump.c", "diffHunk": "@@ -1325,6 +1347,20 @@ j9_printClassExtraModifiers(J9PortLibrary *portLib, U_32 modifiers)\n \t\tmodifiers &= ~J9AccClassIsUnmodifiable;\n \t\tif(modifiers) j9tty_printf(PORTLIB, \" \");\n \t}\n+\n+\tif(modifiers & J9AccRecord)\n+\t{", "originalCommit": "e019a4cf23453d8244dd92f604b9c83fccdd6f0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2NjQ0MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r469966440", "bodyText": "Moving the constants below to a new namespace creates a discontinuity in core files.\nThe change seems reasonable, but I please confirm you did so consciously.", "author": "keithc-ca", "createdAt": "2020-08-13T13:51:10Z", "path": "runtime/oti/j9nonbuilder.h", "diffHunk": "@@ -108,6 +108,8 @@\n #define J9FieldTypeMask 0x380000\n #define J9FieldTypeShort 0x280000\n \n+/* @ddr_namespace: map_to_type=J9RecordComponentFlags */", "originalCommit": "e019a4cf23453d8244dd92f604b9c83fccdd6f0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk5NTcwMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r469995700", "bodyText": "I am not familiar with the consequences of this change. What do you recommend to confirm its okay?", "author": "theresa-m", "createdAt": "2020-08-13T14:30:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2NjQ0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAzOTU3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r470039579", "bodyText": "A core file generated from a VM built before this change would have these constants in J9FieldFlags.\nI think J9RecordComponentFlags is a better place for them, but it will mean NoSuchFieldError will be thrown by DDR code that makes use of J9RecordComponentFlags.J9RecordComponentFlagHasAnnotations (for example) when accessing such an old core file. Because records are still a preview feature, I can live with that: My point is that it needs to be a conscious decision.", "author": "keithc-ca", "createdAt": "2020-08-13T15:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2NjQ0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA0MjgxMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r470042811", "bodyText": "Okay. Thanks for the clarification.", "author": "theresa-m", "createdAt": "2020-08-13T15:36:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2NjQ0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA0MjA2NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r470042065", "bodyText": "Please remove all trailing whitespace in code you're adding (e.g. this line).", "author": "keithc-ca", "createdAt": "2020-08-13T15:35:03Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/j9/OptInfo.java", "diffHunk": "@@ -236,4 +237,33 @@ public static J9SourceDebugExtensionPointer getSourceDebugExtensionForROMClass(J\n \t\treturn J9SourceDebugExtensionPointer.NULL;\n \t}\n \n+\tprivate static U32Pointer getPermittedSubclassPointer(J9ROMClassPointer romClass) throws CorruptDataException {\n+\t\tSelfRelativePointer srpPtr = getSRPPtr(J9ROMClassHelper.optionalInfo(romClass), romClass.optionalFlags(), ", "originalCommit": "223dbba42d1e33cbeb09b13d0677ef35eb8651ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "78c54398aa37fb5e7d6d9d0ee32a4c29c37c9f3e", "url": "https://github.com/eclipse-openj9/openj9/commit/78c54398aa37fb5e7d6d9d0ee32a4c29c37c9f3e", "message": "Review changes\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-08-13T16:22:00Z", "type": "forcePushed"}, {"oid": "d54909c39981d54ca7e9ec25a77fbf5b3a9f7aeb", "url": "https://github.com/eclipse-openj9/openj9/commit/d54909c39981d54ca7e9ec25a77fbf5b3a9f7aeb", "message": "Review changes\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-08-14T20:31:17Z", "type": "forcePushed"}, {"oid": "c0ac6674474cdfcfb927946f79318611334d5fd7", "url": "https://github.com/eclipse-openj9/openj9/commit/c0ac6674474cdfcfb927946f79318611334d5fd7", "message": "Review changes\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-08-14T21:14:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc0MjY1Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r471742657", "bodyText": "I think this would be clearer if inverted:\n    int padding = recordComponentLength % U32.SIZEOF;\n    if (0 != padding) {\n        padding = U32.SIZEOF - padding;\n    }", "author": "keithc-ca", "createdAt": "2020-08-17T19:59:35Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/RomClassWalker.java", "diffHunk": "@@ -846,6 +860,76 @@ int allSlotsInVerificationTypeInfoDo(U8Pointer cursor) throws CorruptDataExcepti\n \t\t}\n \t\treturn 3;\n \t}\n+\n+\tvoid recordAttributeDo(U32Pointer attribute) throws CorruptDataException\n+\t{\n+\t\tif (attribute.isNull()) {\n+\t\t\treturn;\n+\t\t}\n+\t\tU32Pointer attributeStart = attribute;\n+\t\tint numRecordComponents = attribute.at(0).intValue();\n+\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_U32, attribute, \"numberRecordComponents\");\n+\t\tattribute = attribute.add(1);\n+\n+\t\tfor (int i = 0; i < numRecordComponents; i++) {\n+\t\t\tJ9ROMRecordComponentShapePointer recordComponent = J9ROMRecordComponentShapePointer.cast(attribute);\n+\t\t\tattribute = U32Pointer.cast(recordComponent.add(1));\n+\n+\t\t\t/* name and descriptor */\n+\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_SRPNAS, recordComponent.nameAndSignature(), \"nameAndSignature\");\n+\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_U32, recordComponent.attributeFlagsEA(), \"attributeFlags\");\n+\t\t\tclassWalkerCallback.addSection(clazz, recordComponent, attribute.getAddress() - recordComponent.getAddress(), \"recordComponentShape\", true);\n+\n+\t\t\t/* process variable attributes */\n+\t\t\tUDATA attributeFlags = recordComponent.attributeFlags();\n+\n+\t\t\tif (attributeFlags.anyBitsIn(J9RecordComponentFlagHasGenericSignature)) {\n+\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, attribute, \"recordComponentGenSigUTF8\");\n+\t\t\t\tattribute = attribute.add(1);\n+\t\t\t}\n+\n+\t\t\tif (attributeFlags.anyBitsIn(J9RecordComponentFlagHasAnnotations)) {\n+\t\t\t\tint increment = allSlotsInAnnotationDo(attribute, \"recordComponentAnnotation\");\n+\t\t\t\tattribute = attribute.add(increment);\n+\t\t\t}\n+\n+\t\t\tif (attributeFlags.anyBitsIn(J9RecordComponentFlagHasTypeAnnotations)) {\n+\t\t\t\tint increment = allSlotsInAnnotationDo(attribute, \"recordComponentTypeAnnotation\");\n+\t\t\t\tattribute = attribute.add(increment);\n+\t\t\t}\n+\t\t}\n+\t\t\n+\t\t/* calculate RecordComponent padding */\n+\t\tint recordComponentLength = (int)(attribute.getAddress() - attributeStart.getAddress());\n+\t\tint padding = U32.SIZEOF - (recordComponentLength % U32.SIZEOF);\n+\t\tif (U32.SIZEOF == padding) {\n+\t\t\tpadding = 0;\n+\t\t}", "originalCommit": "c0ac6674474cdfcfb927946f79318611334d5fd7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc0Mzg0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r471743846", "bodyText": "This comment is stale, and I'm not sure it added much value.", "author": "keithc-ca", "createdAt": "2020-08-17T20:01:51Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/RomClassWalker.java", "diffHunk": "@@ -846,6 +860,76 @@ int allSlotsInVerificationTypeInfoDo(U8Pointer cursor) throws CorruptDataExcepti\n \t\t}\n \t\treturn 3;\n \t}\n+\n+\tvoid recordAttributeDo(U32Pointer attribute) throws CorruptDataException\n+\t{\n+\t\tif (attribute.isNull()) {\n+\t\t\treturn;\n+\t\t}\n+\t\tU32Pointer attributeStart = attribute;\n+\t\tint numRecordComponents = attribute.at(0).intValue();\n+\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_U32, attribute, \"numberRecordComponents\");\n+\t\tattribute = attribute.add(1);\n+\n+\t\tfor (int i = 0; i < numRecordComponents; i++) {\n+\t\t\tJ9ROMRecordComponentShapePointer recordComponent = J9ROMRecordComponentShapePointer.cast(attribute);\n+\t\t\tattribute = U32Pointer.cast(recordComponent.add(1));\n+\n+\t\t\t/* name and descriptor */", "originalCommit": "c0ac6674474cdfcfb927946f79318611334d5fd7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc0Njc5Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r471746797", "bodyText": "Please remove the trailing whitespace.", "author": "keithc-ca", "createdAt": "2020-08-17T20:07:53Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/RomClassWalker.java", "diffHunk": "@@ -846,6 +860,76 @@ int allSlotsInVerificationTypeInfoDo(U8Pointer cursor) throws CorruptDataExcepti\n \t\t}\n \t\treturn 3;\n \t}\n+\n+\tvoid recordAttributeDo(U32Pointer attribute) throws CorruptDataException\n+\t{\n+\t\tif (attribute.isNull()) {\n+\t\t\treturn;\n+\t\t}\n+\t\tU32Pointer attributeStart = attribute;\n+\t\tint numRecordComponents = attribute.at(0).intValue();\n+\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_U32, attribute, \"numberRecordComponents\");\n+\t\tattribute = attribute.add(1);\n+\n+\t\tfor (int i = 0; i < numRecordComponents; i++) {\n+\t\t\tJ9ROMRecordComponentShapePointer recordComponent = J9ROMRecordComponentShapePointer.cast(attribute);\n+\t\t\tattribute = U32Pointer.cast(recordComponent.add(1));\n+\n+\t\t\t/* name and descriptor */\n+\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_SRPNAS, recordComponent.nameAndSignature(), \"nameAndSignature\");\n+\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_U32, recordComponent.attributeFlagsEA(), \"attributeFlags\");\n+\t\t\tclassWalkerCallback.addSection(clazz, recordComponent, attribute.getAddress() - recordComponent.getAddress(), \"recordComponentShape\", true);\n+\n+\t\t\t/* process variable attributes */\n+\t\t\tUDATA attributeFlags = recordComponent.attributeFlags();\n+\n+\t\t\tif (attributeFlags.anyBitsIn(J9RecordComponentFlagHasGenericSignature)) {\n+\t\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, attribute, \"recordComponentGenSigUTF8\");\n+\t\t\t\tattribute = attribute.add(1);\n+\t\t\t}\n+\n+\t\t\tif (attributeFlags.anyBitsIn(J9RecordComponentFlagHasAnnotations)) {\n+\t\t\t\tint increment = allSlotsInAnnotationDo(attribute, \"recordComponentAnnotation\");\n+\t\t\t\tattribute = attribute.add(increment);\n+\t\t\t}\n+\n+\t\t\tif (attributeFlags.anyBitsIn(J9RecordComponentFlagHasTypeAnnotations)) {\n+\t\t\t\tint increment = allSlotsInAnnotationDo(attribute, \"recordComponentTypeAnnotation\");\n+\t\t\t\tattribute = attribute.add(increment);\n+\t\t\t}\n+\t\t}\n+\t\t", "originalCommit": "c0ac6674474cdfcfb927946f79318611334d5fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQwMjcyMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r472402722", "bodyText": "It's still here.", "author": "keithc-ca", "createdAt": "2020-08-18T18:37:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc0Njc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQwNzgyMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r472407821", "bodyText": "Thanks. It is removed now.", "author": "theresa-m", "createdAt": "2020-08-18T18:47:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc0Njc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ0MTMzNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r472441334", "bodyText": "I see you've completely removed the lines containing only whitespace: it's not what I was asking for, but that's ok.", "author": "keithc-ca", "createdAt": "2020-08-18T19:50:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc0Njc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc0Nzk4Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r471747983", "bodyText": "Suggest you say srpPtr.notNull(), or invert.", "author": "keithc-ca", "createdAt": "2020-08-17T20:10:07Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/j9/OptInfo.java", "diffHunk": "@@ -236,4 +237,33 @@ public static J9SourceDebugExtensionPointer getSourceDebugExtensionForROMClass(J\n \t\treturn J9SourceDebugExtensionPointer.NULL;\n \t}\n \n+\tprivate static U32Pointer getPermittedSubclassPointer(J9ROMClassPointer romClass) throws CorruptDataException {\n+\t\tSelfRelativePointer srpPtr = getSRPPtr(J9ROMClassHelper.optionalInfo(romClass), romClass.optionalFlags(),\n+\t\t\tJ9_ROMCLASS_OPTINFO_PERMITTEDSUBCLASSES_ATTRIBUTE);\n+\t\tif (!srpPtr.isNull()) {", "originalCommit": "c0ac6674474cdfcfb927946f79318611334d5fd7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc0ODIxNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r471748215", "bodyText": "Suggest permittedSubclassPointer.notNull() or invert.", "author": "keithc-ca", "createdAt": "2020-08-17T20:10:34Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/j9/OptInfo.java", "diffHunk": "@@ -236,4 +237,33 @@ public static J9SourceDebugExtensionPointer getSourceDebugExtensionForROMClass(J\n \t\treturn J9SourceDebugExtensionPointer.NULL;\n \t}\n \n+\tprivate static U32Pointer getPermittedSubclassPointer(J9ROMClassPointer romClass) throws CorruptDataException {\n+\t\tSelfRelativePointer srpPtr = getSRPPtr(J9ROMClassHelper.optionalInfo(romClass), romClass.optionalFlags(),\n+\t\t\tJ9_ROMCLASS_OPTINFO_PERMITTEDSUBCLASSES_ATTRIBUTE);\n+\t\tif (!srpPtr.isNull()) {\n+\t\t\treturn U32Pointer.cast(srpPtr.get());\n+\t\t}\n+\t\treturn U32Pointer.NULL;\n+\t}\n+\n+\tpublic static int getPermittedSubclassCount(J9ROMClassPointer romClass) throws CorruptDataException {\n+\t\tU32Pointer permittedSubclassPointer = getPermittedSubclassPointer(romClass);\n+\t\tif (!permittedSubclassPointer.isNull()) {", "originalCommit": "c0ac6674474cdfcfb927946f79318611334d5fd7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc0ODQ3OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r471748478", "bodyText": "Suggest permittedSubclassPointer.notNull() or invert.", "author": "keithc-ca", "createdAt": "2020-08-17T20:11:04Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/j9/OptInfo.java", "diffHunk": "@@ -236,4 +237,33 @@ public static J9SourceDebugExtensionPointer getSourceDebugExtensionForROMClass(J\n \t\treturn J9SourceDebugExtensionPointer.NULL;\n \t}\n \n+\tprivate static U32Pointer getPermittedSubclassPointer(J9ROMClassPointer romClass) throws CorruptDataException {\n+\t\tSelfRelativePointer srpPtr = getSRPPtr(J9ROMClassHelper.optionalInfo(romClass), romClass.optionalFlags(),\n+\t\t\tJ9_ROMCLASS_OPTINFO_PERMITTEDSUBCLASSES_ATTRIBUTE);\n+\t\tif (!srpPtr.isNull()) {\n+\t\t\treturn U32Pointer.cast(srpPtr.get());\n+\t\t}\n+\t\treturn U32Pointer.NULL;\n+\t}\n+\n+\tpublic static int getPermittedSubclassCount(J9ROMClassPointer romClass) throws CorruptDataException {\n+\t\tU32Pointer permittedSubclassPointer = getPermittedSubclassPointer(romClass);\n+\t\tif (!permittedSubclassPointer.isNull()) {\n+\t\t\treturn permittedSubclassPointer.at(0).intValue();\n+\t\t}\n+\t\treturn 0;\n+\t}\n+\n+\tpublic static J9UTF8Pointer getPermittedSubclassNameAtIndex(J9ROMClassPointer romClass, int index) throws CorruptDataException {\n+\t\tU32Pointer permittedSubclassPointer = getPermittedSubclassPointer(romClass);\n+\t\tif (!permittedSubclassPointer.isNull()) {", "originalCommit": "c0ac6674474cdfcfb927946f79318611334d5fd7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc1MTMxOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r471751318", "bodyText": "Most calls to addSlot() supply a slot name beginning with a lower-case letter: why the departure here and on line 700 below?", "author": "keithc-ca", "createdAt": "2020-08-17T20:16:49Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/RomClassWalker.java", "diffHunk": "@@ -687,6 +691,16 @@ void allSlotsInOptionalInfoDo() throws CorruptDataException\n \t\t\tallSlotsInAnnotationDo(U32Pointer.cast(cursor.get()), \"classAnnotations\");\n \t\t\tcursor = cursor.add(1);\n \t\t}\n+\t\tif (romClass.optionalFlags().allBitsIn(J9NonbuilderConstants.J9_ROMCLASS_OPTINFO_RECORD_ATTRIBUTE)) {\n+\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_SRP, cursor, \"RecordAttributeSRP\");", "originalCommit": "c0ac6674474cdfcfb927946f79318611334d5fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMwMTA3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r472301072", "bodyText": "I will change it to lower case.", "author": "theresa-m", "createdAt": "2020-08-18T15:51:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc1MTMxOA=="}], "type": "inlineReview"}, {"oid": "b8d86047eb176f2f6755ef0410cb76f18375bb4b", "url": "https://github.com/eclipse-openj9/openj9/commit/b8d86047eb176f2f6755ef0410cb76f18375bb4b", "message": "Review changes\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-08-18T17:51:06Z", "type": "forcePushed"}, {"oid": "d3b3d6646c86b3fac23c1dd61634fa553d402697", "url": "https://github.com/eclipse-openj9/openj9/commit/d3b3d6646c86b3fac23c1dd61634fa553d402697", "message": "Review changes\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-08-18T17:57:05Z", "type": "forcePushed"}, {"oid": "4054670bcc50fab6c3eac3b25466265600ee3d9d", "url": "https://github.com/eclipse-openj9/openj9/commit/4054670bcc50fab6c3eac3b25466265600ee3d9d", "message": "Review changes\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-08-18T18:47:11Z", "type": "forcePushed"}, {"oid": "0d583df4bcbf944e565b53d662309a31fc21be6c", "url": "https://github.com/eclipse-openj9/openj9/commit/0d583df4bcbf944e565b53d662309a31fc21be6c", "message": "Review updates\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-08-18T19:22:51Z", "type": "forcePushed"}, {"oid": "525ad24e07f863fcf337f8457ab76967453e15f9", "url": "https://github.com/eclipse-openj9/openj9/commit/525ad24e07f863fcf337f8457ab76967453e15f9", "message": "Fix record NAS recording\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-08-24T12:30:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc2Mjk0MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r475762940", "bodyText": "The length could be expressed more clearly as J9ROMRecordComponentShape.SIZEOF.", "author": "keithc-ca", "createdAt": "2020-08-24T17:03:34Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/RomClassWalker.java", "diffHunk": "@@ -846,6 +860,72 @@ int allSlotsInVerificationTypeInfoDo(U8Pointer cursor) throws CorruptDataExcepti\n \t\t}\n \t\treturn 3;\n \t}\n+\n+\tvoid recordAttributeDo(U32Pointer attribute) throws CorruptDataException\n+\t{\n+\t\tif (attribute.isNull()) {\n+\t\t\treturn;\n+\t\t}\n+\t\tU32Pointer attributeStart = attribute;\n+\t\tint numRecordComponents = attribute.at(0).intValue();\n+\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_U32, attribute, \"numberRecordComponents\");\n+\t\tattribute = attribute.add(1);\n+\t\tfor (int i = 0; i < numRecordComponents; i++) {\n+\t\t\tJ9ROMRecordComponentShapePointer recordComponent = J9ROMRecordComponentShapePointer.cast(attribute);\n+\t\t\tattribute = U32Pointer.cast(recordComponent.add(1));\n+\n+\t\t\tJ9ROMNameAndSignaturePointer recordComponentNAS = recordComponent.nameAndSignature();\n+\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, recordComponentNAS.nameEA(), \"name\");\n+\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_ROM_UTF8, recordComponentNAS.signatureEA(), \"signature\");\n+\t\t\tclassWalkerCallback.addSlot(clazz, SlotType.J9_U32, recordComponent.attributeFlagsEA(), \"attributeFlags\");\n+\t\t\tclassWalkerCallback.addSection(clazz, recordComponent, attribute.getAddress() - recordComponent.getAddress(), \"recordComponentShape\", true);", "originalCommit": "525ad24e07f863fcf337f8457ab76967453e15f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgwMTY5Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10381#discussion_r475801692", "bodyText": "updated with this change.", "author": "theresa-m", "createdAt": "2020-08-24T18:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc2Mjk0MA=="}], "type": "inlineReview"}, {"oid": "dc24ad80bacf33b1b2427e62358d2c5bb9986df8", "url": "https://github.com/eclipse-openj9/openj9/commit/dc24ad80bacf33b1b2427e62358d2c5bb9986df8", "message": "Fix record NAS recording\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-08-24T18:09:24Z", "type": "forcePushed"}, {"oid": "2f5a1a35c24f47147b2fc78606f62fcc0107e4f8", "url": "https://github.com/eclipse-openj9/openj9/commit/2f5a1a35c24f47147b2fc78606f62fcc0107e4f8", "message": "JEP 360/JEP 384 Sealed classes and records ddr support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-08-24T19:09:09Z", "type": "commit"}, {"oid": "2f5a1a35c24f47147b2fc78606f62fcc0107e4f8", "url": "https://github.com/eclipse-openj9/openj9/commit/2f5a1a35c24f47147b2fc78606f62fcc0107e4f8", "message": "JEP 360/JEP 384 Sealed classes and records ddr support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-08-24T19:09:09Z", "type": "forcePushed"}]}