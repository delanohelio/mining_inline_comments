{"pr_number": 10457, "pr_title": "Allow SDK_FILENAME to be configured via variable file", "pr_createdAt": "2020-08-26T07:04:07Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10457", "timeline": [{"oid": "6af155621164eefcd41fe1c0a9a88527b4d4d020", "url": "https://github.com/eclipse-openj9/openj9/commit/6af155621164eefcd41fe1c0a9a88527b4d4d020", "message": "Allow SDK_FILENAME to be configured via variable file\n\nGive the option to allow SDK_FILENAME to be configurable\nvia the defaults.yml or any vendor variable file.\nDefault to the existing definition. Move the sdk\nvariables setup into the Archive SDK function. We don't\nneed it set earlier and this allows FULL_SDK_VERSION\nto be set from the OpenJDK source tag. Also allow variables\nto be used in the SDK_FILENAME template. The Groovy template\nengine is used to resolve the variables defined in the yml.\n\n[skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-08-26T08:01:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU2MzI2OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10457#discussion_r477563268", "bodyText": "Command could be simplified by using sed:\nsed -n -e 's/+/_/g; s/^OPENJDK_TAG := //p' < closed/openjdk-tag.gmk", "author": "vsebe", "createdAt": "2020-08-26T20:16:08Z", "path": "buildenv/jenkins/common/variables-functions.groovy", "diffHunk": "@@ -618,7 +618,25 @@ def set_build_variables() {\n def set_sdk_variables() {\n     DATESTAMP = get_date()\n     SDK_FILE_EXT = SPEC.contains('zos') ? '.pax' : '.tar.gz'\n-    SDK_FILENAME =  \"OpenJ9-JDK${SDK_VERSION}-${SPEC}-${DATESTAMP}${SDK_FILE_EXT}\"\n+    // Get full version from tag (eg. 11.0.8+10) and replace + with _\n+    FULL_SDK_VERSION = sh (\n+        script: \"\"\"grep OPENJDK_TAG closed/openjdk-tag.gmk | awk 'BEGIN {FS = \"[ :=]+\"} {gsub(/\\\\+/, \"_\")} {print \\$2}'\"\"\",", "originalCommit": "6af155621164eefcd41fe1c0a9a88527b4d4d020", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Nzk3NDUwNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10457#discussion_r477974504", "bodyText": "I don't think either option is simple \ud83d\ude06\nI stole borrowed it from Adopt\nhttps://github.com/AdoptOpenJDK/openjdk-build/blob/9148896926f269c42d36d40a9edd9248b0d601cb/sbin/build.sh#L728\nDoes it work on z/OS? I will reconfirm if the awk works on z/OS.", "author": "AdamBrousseau", "createdAt": "2020-08-27T02:43:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU2MzI2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODA3NzU5Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10457#discussion_r478077592", "bodyText": "Both ways (sed or awk) work on z/OS. Is the tag file guaranteed to only ever have a single line?", "author": "AdamBrousseau", "createdAt": "2020-08-27T04:06:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU2MzI2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODA5OTI5OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10457#discussion_r478099299", "bodyText": "Updated to sed. Also changed the filename def to be set based on BUILD_IDENTIFIER.", "author": "AdamBrousseau", "createdAt": "2020-08-27T04:29:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU2MzI2OA=="}], "type": "inlineReview"}, {"oid": "d13c92cbeac1fba2f26b95c6940974cea06515f9", "url": "https://github.com/eclipse-openj9/openj9/commit/d13c92cbeac1fba2f26b95c6940974cea06515f9", "message": "Allow SDK_FILENAME to be configured via variable file\n\nGive the option to allow SDK_FILENAME to be configurable\nvia the defaults.yml or any vendor variable file. Set it\nbased on BUILD_IDENTIFIER and fallback to 'default'.\nDefault to the existing definition for OpenJ9. Move the sdk\nvariables setup into the Archive SDK function. We don't\nneed it set earlier and this allows FULL_SDK_VERSION\nto be set from the OpenJDK source tag. Also allow variables\nto be used in the SDK_FILENAME template. The Groovy template\nengine is used to resolve the variables defined in the yml.\n\n[skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-08-27T04:28:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY2MTE3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10457#discussion_r478661179", "bodyText": "Is this call required here?\nThe variables should be already set since set_sdk_variables() is called in build_all()  at L572 https://github.com/eclipse/openj9/blob/d13c92cbeac1fba2f26b95c6940974cea06515f9/buildenv/jenkins/common/build.groovy#L572\nand archive_sdk is called after at L574\nhttps://github.com/eclipse/openj9/blob/d13c92cbeac1fba2f26b95c6940974cea06515f9/buildenv/jenkins/common/build.groovy#L574", "author": "vsebe", "createdAt": "2020-08-27T19:57:15Z", "path": "buildenv/jenkins/common/build.groovy", "diffHunk": "@@ -283,6 +283,7 @@ def build() {\n \n def archive_sdk() {\n     stage('Archive') {\n+        variableFile.set_sdk_variables()", "originalCommit": "d13c92cbeac1fba2f26b95c6940974cea06515f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM2NDAxMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10457#discussion_r479364010", "bodyText": "Yes we want it here. I had put it in build_all for testing purposes and missed removing it. Will update.", "author": "AdamBrousseau", "createdAt": "2020-08-28T15:03:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY2MTE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY2MzgxNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10457#discussion_r478663814", "bodyText": "Shouldn't SDK_FILENAME_TEMPLATE be  SDK_FILENAME ?", "author": "vsebe", "createdAt": "2020-08-27T20:02:30Z", "path": "buildenv/jenkins/common/variables-functions.groovy", "diffHunk": "@@ -618,7 +618,26 @@ def set_build_variables() {\n def set_sdk_variables() {\n     DATESTAMP = get_date()\n     SDK_FILE_EXT = SPEC.contains('zos') ? '.pax' : '.tar.gz'\n-    SDK_FILENAME =  \"OpenJ9-JDK${SDK_VERSION}-${SPEC}-${DATESTAMP}${SDK_FILE_EXT}\"\n+    // Get full version from tag (eg. 11.0.8+10) and replace + with _\n+    FULL_SDK_VERSION = sh (\n+        script: \"sed -n -e 's/+/_/g; s/^OPENJDK_TAG := //p' < closed/openjdk-tag.gmk\",\n+        returnStdout: true\n+    ).trim()\n+    echo \"FULL_SDK_VERSION:'${FULL_SDK_VERSION}'\"\n+\n+    // Use template from variable file if provided otherwise default\n+    SDK_FILENAME = get_value(VARIABLES.misc.sdk_filename_template, BUILD_IDENTIFIER) ?: get_value(VARIABLES.misc.sdk_filename_template, 'default')\n+    echo \"SDK_FILENAME_TEMPLATE:'${SDK_FILENAME}'\"", "originalCommit": "d13c92cbeac1fba2f26b95c6940974cea06515f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM2MjgyNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10457#discussion_r479362827", "bodyText": "Since I am echoing twice, I called the pre-processed version 'template', I originally had 2 variables but then combined them since I don't need to keep the template version.", "author": "AdamBrousseau", "createdAt": "2020-08-28T15:01:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY2MzgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE2MDQ4Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10457#discussion_r481160486", "bodyText": "This is confusing since SDK_FILENAME_TEMPLATE is not a variable and this is for development purpose. Please remove this echo since SDK_FILENAME is again printed at line 639.", "author": "vsebe", "createdAt": "2020-09-01T14:01:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY2MzgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIxOTkyNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10457#discussion_r481219924", "bodyText": "I would rather keep both echos so we can see the variable/template being processed. I will rename the first variable to include template so it's more clear.\nEdit: That will add more code. I will just add more to the echo to make it clear.", "author": "AdamBrousseau", "createdAt": "2020-09-01T15:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY2MzgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY2NjM3NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10457#discussion_r478666374", "bodyText": "Is SDK_IMPL_SHORT used anywhere else?", "author": "vsebe", "createdAt": "2020-08-27T20:07:48Z", "path": "buildenv/jenkins/common/variables-functions.groovy", "diffHunk": "@@ -665,6 +684,10 @@ def set_test_targets() {\n     }\n     echo \"TESTS:'${TESTS}'\"\n \n+    set_sdk_impl()\n+}\n+\n+def set_sdk_impl() {\n     // Set SDK Implementation, default to OpenJ9\n     SDK_IMPL = buildspec.getScalarField(\"sdk_impl\", 'all') ?: 'openj9'\n     SDK_IMPL_SHORT = buildspec.getScalarField(\"sdk_impl_short\", 'all') ?: 'j9'", "originalCommit": "d13c92cbeac1fba2f26b95c6940974cea06515f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM2Mjk3NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10457#discussion_r479362975", "bodyText": "Test job generation", "author": "AdamBrousseau", "createdAt": "2020-08-28T15:02:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY2NjM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE3NzI5MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10457#discussion_r481177290", "bodyText": "Is it a different PR?", "author": "vsebe", "createdAt": "2020-09-01T14:24:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY2NjM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIxODQ4MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10457#discussion_r481218481", "bodyText": "This is existing functionality\nhttps://github.com/eclipse/openj9/blob/master/buildenv/jenkins/common/pipeline-functions.groovy#L467\nhttps://github.com/eclipse/openj9/blob/master/buildenv/jenkins/common/pipeline-functions.groovy#L598", "author": "AdamBrousseau", "createdAt": "2020-09-01T15:11:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY2NjM3NA=="}], "type": "inlineReview"}, {"oid": "bd6925c17bc7f4471ecc3c5f7cca87a5851bf8e6", "url": "https://github.com/eclipse-openj9/openj9/commit/bd6925c17bc7f4471ecc3c5f7cca87a5851bf8e6", "message": "Allow SDK_FILENAME to be configured via variable file\n\nGive the option to allow SDK_FILENAME to be configurable\nvia the defaults.yml or any vendor variable file. Set it\nbased on BUILD_IDENTIFIER and fallback to 'default'.\nDefault to the existing definition for OpenJ9. Move the sdk\nvariables setup into the Archive SDK function. We don't\nneed it set earlier and this allows FULL_SDK_VERSION\nto be set from the OpenJDK source tag. Also allow variables\nto be used in the SDK_FILENAME template. The Groovy template\nengine is used to resolve the variables defined in the yml.\n\n[skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-08-28T15:04:56Z", "type": "forcePushed"}, {"oid": "42f37cd59ba0707b4ee192a842214eebc80cef73", "url": "https://github.com/eclipse-openj9/openj9/commit/42f37cd59ba0707b4ee192a842214eebc80cef73", "message": "Allow SDK_FILENAME to be configured via variable file\n\nGive the option to allow SDK_FILENAME to be configurable\nvia the defaults.yml or any vendor variable file. Set it\nbased on BUILD_IDENTIFIER and fallback to 'default'.\nDefault to the existing definition for OpenJ9. Move the sdk\nvariables setup into the Archive SDK function. We don't\nneed it set earlier and this allows FULL_SDK_VERSION\nto be set from the OpenJDK source tag. Also allow variables\nto be used in the SDK_FILENAME template. The Groovy template\nengine is used to resolve the variables defined in the yml.\n\n[skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-09-01T15:15:54Z", "type": "forcePushed"}, {"oid": "c53ba7ae60c5d6284684f1677d2903731a0d9c8a", "url": "https://github.com/eclipse-openj9/openj9/commit/c53ba7ae60c5d6284684f1677d2903731a0d9c8a", "message": "Allow SDK_FILENAME to be configured via variable file\n\nGive the option to allow SDK_FILENAME to be configurable\nvia the defaults.yml or any vendor variable file. Set it\nbased on BUILD_IDENTIFIER and fallback to 'default'.\nDefault to the existing definition for OpenJ9. Move the sdk\nvariables setup into the Archive SDK function. We don't\nneed it set earlier and this allows FULL_SDK_VERSION\nto be set from the OpenJDK source tag. Also allow variables\nto be used in the SDK_FILENAME template. The Groovy template\nengine is used to resolve the variables defined in the yml.\n\n[skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-09-23T06:05:31Z", "type": "forcePushed"}, {"oid": "7e24fefdbcd001386b436c9f169c53ef45da6bcd", "url": "https://github.com/eclipse-openj9/openj9/commit/7e24fefdbcd001386b436c9f169c53ef45da6bcd", "message": "[skip ci] debug\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-09-23T15:17:00Z", "type": "forcePushed"}, {"oid": "75d953fb688a42bc00d5e4601b33657c5ca0b7b3", "url": "https://github.com/eclipse-openj9/openj9/commit/75d953fb688a42bc00d5e4601b33657c5ca0b7b3", "message": "Rewrtie the version parsing [skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-09-25T06:53:28Z", "type": "forcePushed"}, {"oid": "70d5c02040c73ccf7dadeefece4348d06de5ac6a", "url": "https://github.com/eclipse-openj9/openj9/commit/70d5c02040c73ccf7dadeefece4348d06de5ac6a", "message": "Rewrtie the version parsing [skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-09-25T14:08:49Z", "type": "forcePushed"}, {"oid": "3e80708f99a502d1f845565dc0a7d3c2b66793d5", "url": "https://github.com/eclipse-openj9/openj9/commit/3e80708f99a502d1f845565dc0a7d3c2b66793d5", "message": "Rewrtie the version parsing [skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-09-25T14:16:01Z", "type": "forcePushed"}, {"oid": "9b764115219d5cac6c5a889554b04829e6187d07", "url": "https://github.com/eclipse-openj9/openj9/commit/9b764115219d5cac6c5a889554b04829e6187d07", "message": "Allow SDK_FILENAME to be configured via variable file\n\nGive the option to allow SDK_FILENAME to be configurable\nvia the defaults.yml or any vendor variable file. Set it\nbased on BUILD_IDENTIFIER and fallback to 'default'.\nDefault to the existing definition for OpenJ9. Move the sdk\nvariables setup into the Archive SDK function. We don't\nneed it set earlier and this allows FULL_SDK_VERSION\nto be set from the OpenJDK source tag. Also allow variables\nto be used in the SDK_FILENAME template. The Groovy template\nengine is used to resolve the variables defined in the yml.\n\n[skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-09-25T14:23:33Z", "type": "commit"}, {"oid": "9b764115219d5cac6c5a889554b04829e6187d07", "url": "https://github.com/eclipse-openj9/openj9/commit/9b764115219d5cac6c5a889554b04829e6187d07", "message": "Allow SDK_FILENAME to be configured via variable file\n\nGive the option to allow SDK_FILENAME to be configurable\nvia the defaults.yml or any vendor variable file. Set it\nbased on BUILD_IDENTIFIER and fallback to 'default'.\nDefault to the existing definition for OpenJ9. Move the sdk\nvariables setup into the Archive SDK function. We don't\nneed it set earlier and this allows FULL_SDK_VERSION\nto be set from the OpenJDK source tag. Also allow variables\nto be used in the SDK_FILENAME template. The Groovy template\nengine is used to resolve the variables defined in the yml.\n\n[skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-09-25T14:23:33Z", "type": "forcePushed"}]}