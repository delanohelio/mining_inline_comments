{"pr_number": 11170, "pr_title": "Ensure we don't crash when image not present", "pr_createdAt": "2020-11-12T20:16:52Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/11170", "timeline": [{"oid": "9d9ffac8da88178c6e7033ce07be26fbae521a98", "url": "https://github.com/eclipse-openj9/openj9/commit/9d9ffac8da88178c6e7033ce07be26fbae521a98", "message": "Ensure we don't crash when image not present\n\nRefactor the VMSnapshotImpl destructor to skip most of\nthe implementation if the `_vm` is null. This likely\nindicates that we're shutting down from a partially\ninitialized state - likely due to a missing image\nfile.\n\nSome additional refactoring to make the code slightly\nclearer about which state we're in (restore / snapshot)\nand what the expected behaviour is.\n\nSigned-off-by: Dan Heidinga <heidinga@redhat.com>", "committedDate": "2020-11-12T20:14:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA0MTgzNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11170#discussion_r523041837", "bodyText": "What is the purpose of changing this cast type?", "author": "theresa-m", "createdAt": "2020-11-13T15:56:53Z", "path": "runtime/vm/VMSnapshotImpl.cpp", "diffHunk": "@@ -1398,14 +1414,27 @@ initializeVMSnapshotImpl(J9PortLibrary *portLibrary, BOOLEAN isSnapShotRun, cons\n extern \"C\" void\n setupVMSnapshotImpl(void *vmSnapshotImpl, J9JavaVM* vm)\n {\n-\t((VMSnapshotImpl *)vmSnapshotImpl)->setJ9JavaVM(vm);\n-\tvm->vmSnapshotImplPortLibrary = ((VMSnapshotImpl *)vmSnapshotImpl)->getVMSnapshotImplPortLibrary();\n+\tVMSnapshotImpl *impl = static_cast<VMSnapshotImpl *>(vmSnapshotImpl);\n+\tJ9JavaVM* implVM = impl->getJ9JavaVM();\n+\tif (implVM != NULL) {\n+\t\tif (implVM != vm) {\n+\t\t\t/* Something seriously wrong here! */\n+\t\t\tprintf(\"**** In a Restore run and was passed a different vm pointer.\\n\");\n+\t\t\tprintf(\"**** Expected VMSnapshotImpl->_vm(%p) was (%p)\\n\", implVM, vm);\n+\t\t\tabort();\n+\t\t}\n+\t\t/* No action required */\n+\t} else {\n+\t\t/* Snapshot run - initial set of VM into VMSnapshotImpl*/\n+\t\timpl->setJ9JavaVM(vm);\n+\t}\n+\tvm->vmSnapshotImplPortLibrary = impl->getVMSnapshotImplPortLibrary();\n }\n \n extern \"C\" J9JavaVM *\n getJ9JavaVMFromVMSnapshotImpl(void *vmSnapshotImpl)\n {\n-\treturn ((VMSnapshotImpl *)vmSnapshotImpl)->getJ9JavaVM();\n+\treturn static_cast<VMSnapshotImpl *>(vmSnapshotImpl)->getJ9JavaVM();", "originalCommit": "9d9ffac8da88178c6e7033ce07be26fbae521a98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA1NzI0MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11170#discussion_r523057240", "bodyText": "This is a cpp file so it should use the c++ casting format.  Also, <static_cast> gives some compile time checking that c-style casts don't, thought that's not really relevant in this case", "author": "DanHeidinga", "createdAt": "2020-11-13T16:21:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA0MTgzNw=="}], "type": "inlineReview"}]}