{"pr_number": 9155, "pr_title": "AArch64: Return 64 as L1 data cache line size when info unavailable", "pr_createdAt": "2020-04-07T13:29:53Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9155", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxOTYwNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9155#discussion_r404819607", "bodyText": "Nitpick - we typically avoid // comments in VM code as not all supported compilers accept them and its easier to blanket ban them then ensure they are only present where in platform-specific code\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t// Cache line size in unavailable on some systems\n          \n          \n            \n            \t\t\t/* Cache line size in unavailable on some systems */", "author": "DanHeidinga", "createdAt": "2020-04-07T13:44:03Z", "path": "runtime/port/unix/j9sysinfo.c", "diffHunk": "@@ -1675,8 +1675,11 @@ j9sysinfo_get_cache_info(struct J9PortLibrary *portLibrary, const J9CacheInfoQue\n \t) {\n \t\t/* L1 data cache line size */\n \t\tint32_t rc = (int32_t)sysconf(_SC_LEVEL1_DCACHE_LINESIZE);\n-\t\tif (rc >= 0) {\n+\t\tif (rc > 0) {\n \t\t\tresult = rc;\n+\t\t} else if (rc == 0) {\n+\t\t\t// Cache line size in unavailable on some systems", "originalCommit": "88ef36f44ef0937bbfc888d4a72f7b9f00eaccab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgzOTA2Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/9155#discussion_r404839066", "bodyText": "Updated the code as suggested.", "author": "knn-k", "createdAt": "2020-04-07T14:10:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxOTYwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMDQ0NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9155#discussion_r404820445", "bodyText": "I had suggested 64 in the issue where this was discussed but have no experience on aarch64 to tell if that's actually reasonable.  Does 64 make sense given the chips that are available?  Would another value be a safer default?", "author": "DanHeidinga", "createdAt": "2020-04-07T13:45:10Z", "path": "runtime/port/unix/j9sysinfo.c", "diffHunk": "@@ -1675,8 +1675,11 @@ j9sysinfo_get_cache_info(struct J9PortLibrary *portLibrary, const J9CacheInfoQue\n \t) {\n \t\t/* L1 data cache line size */\n \t\tint32_t rc = (int32_t)sysconf(_SC_LEVEL1_DCACHE_LINESIZE);\n-\t\tif (rc >= 0) {\n+\t\tif (rc > 0) {\n \t\t\tresult = rc;\n+\t\t} else if (rc == 0) {\n+\t\t\t// Cache line size in unavailable on some systems\n+\t\t\tresult = 64;", "originalCommit": "88ef36f44ef0937bbfc888d4a72f7b9f00eaccab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgzMTcxOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9155#discussion_r404831718", "bodyText": "As I understand it, it's better if the number is too big than too small. If it's too big then a little memory will be wasted, but if it's too small then it will defeat the purpose of the optimization and affect performance.", "author": "pshipton", "createdAt": "2020-04-07T14:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMDQ0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgzNzQ2NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9155#discussion_r404837464", "bodyText": "The line size of L1 data cache of Cortex-A53 (low-end AArch64 core) is 64 bytes, as stated in http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.ddi0500j/BABCFDAH.html.\nOther Cortex-A3x, A5x and A7x chips also seem to have 64 byte cache line in L1 data cache.", "author": "knn-k", "createdAt": "2020-04-07T14:07:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMDQ0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5OTA5MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9155#discussion_r405199091", "bodyText": "I don't think there is a good reason to choose other line size.  Cortex AArch64 cores seem to have the 64 byte cache lines.\n64 should be better than 0.", "author": "knn-k", "createdAt": "2020-04-08T00:59:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMDQ0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwMzc1Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/9155#discussion_r405203756", "bodyText": "Pls add the information https://github.com/eclipse/openj9/pull/9155/files#r404837464 as a comment in the code for future reference.", "author": "pshipton", "createdAt": "2020-04-08T01:18:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMDQ0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwOTY0Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9155#discussion_r405209642", "bodyText": "Updated the comment.", "author": "knn-k", "createdAt": "2020-04-08T01:40:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMDQ0NQ=="}], "type": "inlineReview"}, {"oid": "86175da91f7fc0eff778a588fd70bc281c7d7436", "url": "https://github.com/eclipse-openj9/openj9/commit/86175da91f7fc0eff778a588fd70bc281c7d7436", "message": "AArch64: Return 64 as L1 data cache line size when info unavailable\n\nsysconf(_SC_LEVEL1_DCACHE_LINESIZE) returns 0 on some systems.\nThis commit changes j9sysinfo_get_cache_info() to return 64 as the\nL1 data cache line size for AArch64 on such systems.\n\nSigned-off-by: KONNO Kazuhiro <konno@jp.ibm.com>", "committedDate": "2020-04-07T14:08:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwMzQ3Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/9155#discussion_r405203476", "bodyText": "Typo in should be is", "author": "pshipton", "createdAt": "2020-04-08T01:17:11Z", "path": "runtime/port/unix/j9sysinfo.c", "diffHunk": "@@ -1675,8 +1675,11 @@ j9sysinfo_get_cache_info(struct J9PortLibrary *portLibrary, const J9CacheInfoQue\n \t) {\n \t\t/* L1 data cache line size */\n \t\tint32_t rc = (int32_t)sysconf(_SC_LEVEL1_DCACHE_LINESIZE);\n-\t\tif (rc >= 0) {\n+\t\tif (rc > 0) {\n \t\t\tresult = rc;\n+\t\t} else if (rc == 0) {\n+\t\t\t/* Cache line size in unavailable on some systems */", "originalCommit": "86175da91f7fc0eff778a588fd70bc281c7d7436", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "da9324c7ef17d4b8b900e89b50a7aa2981d7f978", "url": "https://github.com/eclipse-openj9/openj9/commit/da9324c7ef17d4b8b900e89b50a7aa2981d7f978", "message": "AArch64: Return 64 as L1 data cache line size when info unavailable\n\nsysconf(_SC_LEVEL1_DCACHE_LINESIZE) returns 0 on some systems.\nThis commit changes j9sysinfo_get_cache_info() to return 64 as the\nL1 data cache line size for AArch64 on such systems.\n\nSigned-off-by: KONNO Kazuhiro <konno@jp.ibm.com>", "committedDate": "2020-04-08T01:37:32Z", "type": "commit"}, {"oid": "da9324c7ef17d4b8b900e89b50a7aa2981d7f978", "url": "https://github.com/eclipse-openj9/openj9/commit/da9324c7ef17d4b8b900e89b50a7aa2981d7f978", "message": "AArch64: Return 64 as L1 data cache line size when info unavailable\n\nsysconf(_SC_LEVEL1_DCACHE_LINESIZE) returns 0 on some systems.\nThis commit changes j9sysinfo_get_cache_info() to return 64 as the\nL1 data cache line size for AArch64 on such systems.\n\nSigned-off-by: KONNO Kazuhiro <konno@jp.ibm.com>", "committedDate": "2020-04-08T01:37:32Z", "type": "forcePushed"}]}