{"pr_number": 10743, "pr_title": "Handle native OOM in catUTFToString4", "pr_createdAt": "2020-09-29T18:50:59Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10743", "timeline": [{"oid": "657d24fae2ba8adc2425c06afaf4c38da1e26449", "url": "https://github.com/eclipse-openj9/openj9/commit/657d24fae2ba8adc2425c06afaf4c38da1e26449", "message": "Handle native OOM in catUTFToString4\n\ncatUTFToString4 will now set native OOM if it fails to allocate memory,\nso that an exception will always be pending if NULL is returned. Update\ncallers to respect the OOM.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-09-29T18:48:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3MjE1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10743#discussion_r496972159", "bodyText": "Is it better to throw an empty IAE here than the NativeOOM?", "author": "DanHeidinga", "createdAt": "2020-09-29T19:06:14Z", "path": "runtime/codert_vm/cnathelp.cpp", "diffHunk": "@@ -3013,7 +3013,9 @@ old_slow_jitNewInstanceImplAccessCheck(J9VMThread *currentThread)\n \t\t\t\tJ9UTF8_LENGTH(nameUTF),\n \t\t\t\tJ9UTF8_DATA(sigUTF),\n \t\t\t\tJ9UTF8_LENGTH(sigUTF));\n-\t\tsetCurrentExceptionFromJIT(currentThread, J9VMCONSTANTPOOL_JAVALANGILLEGALACCESSEXCEPTION, detailMessage);\n+\t\tif (NULL != detailMessage) {", "originalCommit": "657d24fae2ba8adc2425c06afaf4c38da1e26449", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5MDU1Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10743#discussion_r496990553", "bodyText": "I don't like the idea of setting two exceptions in a row, but I could be talked out of it. It won't actually cause any problems to do so.", "author": "gacholio", "createdAt": "2020-09-29T19:28:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3MjE1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5OTQyMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10743#discussion_r496999423", "bodyText": "I'm OK with throwing the nativeOOM as that's the immediate failure.  Either way, the user will need to resolve both the cause of the OOM and the IAE - given this is a native OOM, trying to create a second exception (and its stacktrace) to set one as the cause of the other is asking for trouble.\nLet's keep it as you've written it", "author": "DanHeidinga", "createdAt": "2020-09-29T19:42:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3MjE1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3NDE1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10743#discussion_r496974159", "bodyText": "We're in the VM here.  Can we directly call setNativeOOM??\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tvmThread->javaVM->internalVMFunctions->setNativeOutOfMemoryError(vmThread, 0, 0);\n          \n          \n            \n            \t\tsetNativeOutOfMemoryError(vmThread, 0, 0);", "author": "DanHeidinga", "createdAt": "2020-09-29T19:10:00Z", "path": "runtime/vm/stringhelpers.cpp", "diffHunk": "@@ -498,7 +498,9 @@ catUtfToString4(J9VMThread * vmThread, const U_8 *data1, UDATA length1, const U_\n \tj9object_t result = NULL;\n \tUDATA totalLength = length1 + length2 + length3 + length4;\n \tU_8 *buffer = (U_8*)j9mem_allocate_memory(totalLength, OMRMEM_CATEGORY_VM);\n-\tif (NULL != buffer) {\n+\tif (NULL == buffer) {\n+\t\tvmThread->javaVM->internalVMFunctions->setNativeOutOfMemoryError(vmThread, 0, 0);", "originalCommit": "657d24fae2ba8adc2425c06afaf4c38da1e26449", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk4ODUxOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10743#discussion_r496988518", "bodyText": "The file is recompiled for one of the tests, so the direct call causes a link error.", "author": "gacholio", "createdAt": "2020-09-29T19:26:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3NDE1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5MDU3MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10743#discussion_r496990570", "bodyText": "I'd suggest the J9_VM_FUNCTION(currentThread, function) approach but it isn't worth the effort for an OOM case", "author": "DanHeidinga", "createdAt": "2020-09-29T19:28:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3NDE1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5MjkyMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10743#discussion_r496992922", "bodyText": "That macro only works if the magic ifdef is defined, which it is not for the test directory.", "author": "gacholio", "createdAt": "2020-09-29T19:31:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3NDE1OQ=="}], "type": "inlineReview"}]}