{"pr_number": 10774, "pr_title": "Allow -Xdump options for jcmd Dump.* commands", "pr_createdAt": "2020-10-02T19:54:52Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10774", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNjQwMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499026400", "bodyText": "I might set default options for heap dumps as well.\njavacore defaults to exclusive+preempt\nheap defaults to exclusive+compact+prepwalk\nsystem and snap defaults to serial\nSee settings via -Xdump:<type>:defaults", "author": "pshipton", "createdAt": "2020-10-02T20:05:35Z", "path": "jcl/src/java.base/share/classes/openj9/internal/tools/attach/target/DiagnosticUtils.java", "diffHunk": "@@ -273,12 +273,37 @@ private static DiagnosticProperties doDump(String diagnosticCommand) {\n \t\t\t}\n \t\t\tif (!dumpType.isEmpty()) {\n \t\t\t\tString request = dumpType;\n-\t\t\t\tif (parts.length == 2) {\n-\t\t\t\t\tString fileDirective = (\"system\".equals(dumpType) && IPC.isZOS) ? \":dsn=\" : \":file=\"; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n-\t\t\t\t\trequest += fileDirective + parts[1];\n+\t\t\t\tboolean foundSystemRequest = false;\n+\t\t\t\tboolean heapDump = \"heap\".equals(dumpType);\n+\t\t\t\tboolean systemDump = \"system\".equals(dumpType);\n+\t\t\t\tString options = \"\"; //$NON-NLS-1$\n+\t\t\t\tString separator = \":\"; //$NON-NLS-1$\n+\t\t\t\tfor (int i = 1; i < parts.length; i++) {\n+\t\t\t\t\tString option = parts[i];\n+\t\t\t\t\tboolean isRequest = option.startsWith(\"request=\");\n+\t\t\t\t\tboolean isOpts = option.startsWith(\"opts=\");\n+\t\t\t\t\tif (isRequest || isOpts) { //$NON-NLS-1$ //$NON-NLS-2$\n+\t\t\t\t\t\tif (heapDump && isOpts) {\n+\t\t\t\t\t\t\t// opts= are only valid for heap dumps\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\toptions += separator + option;\n+\t\t\t\t\t\tif (systemDump && isRequest) {\n+\t\t\t\t\t\t\tfoundSystemRequest = true;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tString fileDirective = (systemDump && IPC.isZOS) ? \"dsn=\" : \"file=\"; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n+\t\t\t\t\t\toptions += separator + fileDirective + option;\n+\t\t\t\t\t}\n+\t\t\t\t\tseparator = \",\"; //$NON-NLS-1$\n+\t\t\t\t}\n+\t\t\t\tif (systemDump && !foundSystemRequest) {\n+\t\t\t\t\t// default options for a system dump if the user didn't specify\n+\t\t\t\t\toptions += \"request=exclusive+prepwalk\";  //$NON-NLS-1$", "originalCommit": "9806852095bf3c334960351e974452052cf3fc71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAzMDU5Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499030592", "bodyText": "As per [1],  by default -Xdump:java has request=exclusive+preempt, and -Xdump:heap has request=exclusive+compact+prepwalk,.\n[1] https://www.eclipse.org/openj9/docs/xdump/", "author": "JasonFengJ9", "createdAt": "2020-10-02T20:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNjQwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAzNDA0NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499034045", "bodyText": "This needs a separator before \"request\".\nPerhaps options should be a StringBuilder?", "author": "keithc-ca", "createdAt": "2020-10-02T20:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNjQwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNjQzMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499026433", "bodyText": "System.err.println superfluous?", "author": "kgibm", "createdAt": "2020-10-02T20:05:40Z", "path": "jcl/src/java.base/share/classes/openj9/internal/tools/attach/target/DiagnosticUtils.java", "diffHunk": "@@ -273,12 +273,37 @@ private static DiagnosticProperties doDump(String diagnosticCommand) {\n \t\t\t}\n \t\t\tif (!dumpType.isEmpty()) {\n \t\t\t\tString request = dumpType;\n-\t\t\t\tif (parts.length == 2) {\n-\t\t\t\t\tString fileDirective = (\"system\".equals(dumpType) && IPC.isZOS) ? \":dsn=\" : \":file=\"; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n-\t\t\t\t\trequest += fileDirective + parts[1];\n+\t\t\t\tboolean foundSystemRequest = false;\n+\t\t\t\tboolean heapDump = \"heap\".equals(dumpType);\n+\t\t\t\tboolean systemDump = \"system\".equals(dumpType);\n+\t\t\t\tString options = \"\"; //$NON-NLS-1$\n+\t\t\t\tString separator = \":\"; //$NON-NLS-1$\n+\t\t\t\tfor (int i = 1; i < parts.length; i++) {\n+\t\t\t\t\tString option = parts[i];\n+\t\t\t\t\tboolean isRequest = option.startsWith(\"request=\");\n+\t\t\t\t\tboolean isOpts = option.startsWith(\"opts=\");\n+\t\t\t\t\tif (isRequest || isOpts) { //$NON-NLS-1$ //$NON-NLS-2$\n+\t\t\t\t\t\tif (heapDump && isOpts) {\n+\t\t\t\t\t\t\t// opts= are only valid for heap dumps\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\toptions += separator + option;\n+\t\t\t\t\t\tif (systemDump && isRequest) {\n+\t\t\t\t\t\t\tfoundSystemRequest = true;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tString fileDirective = (systemDump && IPC.isZOS) ? \"dsn=\" : \"file=\"; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n+\t\t\t\t\t\toptions += separator + fileDirective + option;\n+\t\t\t\t\t}\n+\t\t\t\t\tseparator = \",\"; //$NON-NLS-1$\n+\t\t\t\t}\n+\t\t\t\tif (systemDump && !foundSystemRequest) {\n+\t\t\t\t\t// default options for a system dump if the user didn't specify\n+\t\t\t\t\toptions += \"request=exclusive+prepwalk\";  //$NON-NLS-1$\n \t\t\t\t}\n+\t\t\t\tSystem.err.println(\"request + options\");", "originalCommit": "9806852095bf3c334960351e974452052cf3fc71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA0MDYwNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499040605", "bodyText": "For my debugging/testing", "author": "pshipton", "createdAt": "2020-10-02T20:41:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNjQzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNjYyOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499026628", "bodyText": "Shouldn't this be systemDump && isOpts instead?", "author": "kgibm", "createdAt": "2020-10-02T20:06:11Z", "path": "jcl/src/java.base/share/classes/openj9/internal/tools/attach/target/DiagnosticUtils.java", "diffHunk": "@@ -273,12 +273,37 @@ private static DiagnosticProperties doDump(String diagnosticCommand) {\n \t\t\t}\n \t\t\tif (!dumpType.isEmpty()) {\n \t\t\t\tString request = dumpType;\n-\t\t\t\tif (parts.length == 2) {\n-\t\t\t\t\tString fileDirective = (\"system\".equals(dumpType) && IPC.isZOS) ? \":dsn=\" : \":file=\"; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n-\t\t\t\t\trequest += fileDirective + parts[1];\n+\t\t\t\tboolean foundSystemRequest = false;\n+\t\t\t\tboolean heapDump = \"heap\".equals(dumpType);\n+\t\t\t\tboolean systemDump = \"system\".equals(dumpType);\n+\t\t\t\tString options = \"\"; //$NON-NLS-1$\n+\t\t\t\tString separator = \":\"; //$NON-NLS-1$\n+\t\t\t\tfor (int i = 1; i < parts.length; i++) {\n+\t\t\t\t\tString option = parts[i];\n+\t\t\t\t\tboolean isRequest = option.startsWith(\"request=\");\n+\t\t\t\t\tboolean isOpts = option.startsWith(\"opts=\");\n+\t\t\t\t\tif (isRequest || isOpts) { //$NON-NLS-1$ //$NON-NLS-2$\n+\t\t\t\t\t\tif (heapDump && isOpts) {", "originalCommit": "9806852095bf3c334960351e974452052cf3fc71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA0MDg0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499040846", "bodyText": "Fixed it as !dumpDump && isOpts", "author": "pshipton", "createdAt": "2020-10-02T20:41:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyNjYyOA=="}], "type": "inlineReview"}, {"oid": "e8c563bf92adc84f8f0fcc2415db0320f52cf8d4", "url": "https://github.com/eclipse-openj9/openj9/commit/e8c563bf92adc84f8f0fcc2415db0320f52cf8d4", "message": "Allow -Xdump options for jcmd Dump.* commands\n\nDefault system dumps to `request=exclusive+prepwalk`\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-10-02T21:24:23Z", "type": "forcePushed"}, {"oid": "50e845921fb10676c3d27b7dda7aa08beec8b2f3", "url": "https://github.com/eclipse-openj9/openj9/commit/50e845921fb10676c3d27b7dda7aa08beec8b2f3", "message": "Allow -Xdump options for jcmd Dump.* commands\n\nDefault system dumps to `request=exclusive+prepwalk`\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-10-02T21:37:51Z", "type": "forcePushed"}, {"oid": "48494220a2b67b0dcba9fe270ec489040f337140", "url": "https://github.com/eclipse-openj9/openj9/commit/48494220a2b67b0dcba9fe270ec489040f337140", "message": "Allow -Xdump options for jcmd Dump.* commands\n\nDefault system dumps to `request=exclusive+prepwalk`\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-10-02T22:14:17Z", "type": "forcePushed"}, {"oid": "455e70b39ada872874dd4484108ac6babeae6f67", "url": "https://github.com/eclipse-openj9/openj9/commit/455e70b39ada872874dd4484108ac6babeae6f67", "message": "Allow -Xdump options for jcmd Dump.* commands\n\nDefault system and heap dumps to `request=exclusive+prepwalk`\n\nFix a bug reporting an exception when requesting a dump.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-10-02T22:16:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5NTIyNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499095224", "bodyText": "does the order of these three entries matter? can we turn the <file path> to the similar key=value style, i.e., file=<file path> (dsn=<file path> for zOS)?", "author": "JasonFengJ9", "createdAt": "2020-10-03T00:15:06Z", "path": "jcl/src/java.base/share/classes/openj9/internal/tools/attach/target/DiagnosticUtils.java", "diffHunk": "@@ -46,7 +46,9 @@\n \tprivate static final String FORMAT_PREFIX = \" Format: \"; //$NON-NLS-1$\n \n \t@SuppressWarnings(\"nls\")\n-\tprivate static final String FILE_PATH_HELP = \" <file path>%n\"\n+\tprivate static final String DUMP_OPTION_HELP = \" [request=<options>] [opts=<options] [<file path>]%n\"", "originalCommit": "455e70b39ada872874dd4484108ac6babeae6f67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwMDI5NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499100294", "bodyText": "Seems like that would be a breaking change. Some users may already be using jcmd $pid Dump.system $file, for example.", "author": "kgibm", "createdAt": "2020-10-03T00:53:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5NTIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE4ODg3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499188872", "bodyText": "@kgibm Agreed that it will require a script change for the usage like your example. On the other hand, my feeling is that the proposed option format are not consistent, and might cause confusion down the road, IMO, maybe now it is the time to provide unified option format matching -Xdump.\nCan the example usage be modified to accommodate a new format hopefully with low cost?", "author": "JasonFengJ9", "createdAt": "2020-10-03T23:04:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5NTIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE5MTY3MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499191671", "bodyText": "@JasonFengJ9 That's a fair point. I defer to others to decide. I guess one middle ground could be to support both: add support for file=/dns= and then assume that if an argument is not preceded with word=, then it is the file for backwards compatibility.", "author": "kgibm", "createdAt": "2020-10-03T23:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5NTIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMzMjgwOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499332809", "bodyText": "The order doesn't matter. We could allow file= and dsn, but I don't want to break compatibility by changing the existing syntax.", "author": "pshipton", "createdAt": "2020-10-05T03:40:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5NTIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU2OTQ4OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499569489", "bodyText": "Sure, no objection if the back compatibility takes precedence.\nAlso got another question, in current option format, just wondering how do we address The command can be extended to take other parameters as well so the user can set any options [1] (assuming such options available in -Xdump), or in a separated PR instead?\n[1] #10747 (comment)", "author": "JasonFengJ9", "createdAt": "2020-10-05T12:44:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5NTIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU3NDQzNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499574434", "bodyText": "This was already done by accepting request= and opts=. Besides file= or dsn=, these are the only valid options when requesting an immediate dump.", "author": "pshipton", "createdAt": "2020-10-05T12:52:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5NTIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYwOTcyMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499609722", "bodyText": "Okay, my thought was to specify same style of Xdump options via jcmd, i.e., dump accordingly as per the events, filter, and others. I am fine with the interpretation of an immediate dump for this PR.", "author": "JasonFengJ9", "createdAt": "2020-10-05T13:45:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5NTIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY2NTMzMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499665331", "bodyText": "Changing the existing dump options is a different operation, which could also be added, but separately from this change.", "author": "pshipton", "createdAt": "2020-10-05T15:00:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5NTIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY4MjcyNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499682724", "bodyText": "I don't think supporting dsn= or file= makes sense. The API of com.sun.tools.attach.spi.AttachProvider doesn't promise that the virtual machines answered are on the same host (as each other or as where jcmd is used). As such, it's unclear whether dsn= or file= would be appropriate paired with a particular vmid. I think the decision about how to choose the appropriate option string is best left to the target vm.", "author": "keithc-ca", "createdAt": "2020-10-05T15:25:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5NTIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcwMTc3Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499701777", "bodyText": "Technically a target vm could state its OS type (zOS or not) via VMID in its advertisement file.\nOn the other hand, zOS is a tightly controlled system which even disables the AttachAPI by default, it will be rare situation that there is an interaction between zOS images and other OS.\nThe motivation to add dsn= or file= is to reduce the parsing code complexity and the whole string can be consumed by native code in a whole.", "author": "JasonFengJ9", "createdAt": "2020-10-05T15:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA5NTIyNA=="}], "type": "inlineReview"}, {"oid": "e34fee7af09a9d8f08288df526ad8f3f1293eb2b", "url": "https://github.com/eclipse-openj9/openj9/commit/e34fee7af09a9d8f08288df526ad8f3f1293eb2b", "message": "Allow -Xdump options for jcmd Dump.* commands\n\nDefault system and heap dumps to `request=exclusive+prepwalk`\n\nFix a bug reporting an exception when requesting a dump.\n\nUpdate the tests.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-10-05T20:12:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg1NzEwOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499857108", "bodyText": "I think this should end with %n (and was probably intended given the line split here).", "author": "keithc-ca", "createdAt": "2020-10-05T20:35:50Z", "path": "jcl/src/java.base/share/classes/openj9/internal/tools/attach/target/DiagnosticUtils.java", "diffHunk": "@@ -46,7 +46,9 @@\n \tprivate static final String FORMAT_PREFIX = \" Format: \"; //$NON-NLS-1$\n \n \t@SuppressWarnings(\"nls\")\n-\tprivate static final String FILE_PATH_HELP = \" <file path>%n\"\n+\tprivate static final String DUMP_OPTION_HELP = \" [request=<options>] [opts=<options] [<file path>]%n\"\n+\t\t\t\t+ \" Set optional request= and opts= -Xdump options. The order of the parameters does not matter.%n\"\n+\t\t\t\t+ \" system and heap dumps default to request=exclusive+prepwalk rather than the -Xdump:<type>:defaults setting.%n\"\n \t\t\t\t+ \" <file path> is optional, otherwise a default path/name is used.\"", "originalCommit": "e34fee7af09a9d8f08288df526ad8f3f1293eb2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg2MjEzOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499862138", "bodyText": "The //$NON-NLS-n$ comments don't belong here: they belong on lines 280, 281, 285 & 286 above.", "author": "keithc-ca", "createdAt": "2020-10-05T20:45:48Z", "path": "jcl/src/java.base/share/classes/openj9/internal/tools/attach/target/DiagnosticUtils.java", "diffHunk": "@@ -272,17 +274,41 @@ private static DiagnosticProperties doDump(String diagnosticCommand) {\n \t\t\t\t}\n \t\t\t}\n \t\t\tif (!dumpType.isEmpty()) {\n-\t\t\t\tString request = dumpType;\n-\t\t\t\tif (parts.length == 2) {\n-\t\t\t\t\tString fileDirective = (\"system\".equals(dumpType) && IPC.isZOS) ? \":dsn=\" : \":file=\"; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n-\t\t\t\t\trequest += fileDirective + parts[1];\n+\t\t\t\tStringBuilder request = new StringBuilder();\n+\t\t\t\trequest.append(dumpType);\n+\t\t\t\tboolean foundRequest = false;\n+\t\t\t\tboolean heapDump = \"heap\".equals(dumpType);\n+\t\t\t\tboolean systemDump = \"system\".equals(dumpType);\n+\t\t\t\tString separator = \":\"; //$NON-NLS-1$\n+\t\t\t\tfor (int i = 1; i < parts.length; i++) {\n+\t\t\t\t\tString option = parts[i];\n+\t\t\t\t\tboolean isRequest = option.startsWith(\"request=\");\n+\t\t\t\t\tboolean isOpts = option.startsWith(\"opts=\");\n+\t\t\t\t\tif (isRequest || isOpts) { //$NON-NLS-1$ //$NON-NLS-2$", "originalCommit": "e34fee7af09a9d8f08288df526ad8f3f1293eb2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg2MjY3MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499862670", "bodyText": "//$NON-NLS-3$ should be removed: there are only two string literals here.", "author": "keithc-ca", "createdAt": "2020-10-05T20:46:49Z", "path": "jcl/src/java.base/share/classes/openj9/internal/tools/attach/target/DiagnosticUtils.java", "diffHunk": "@@ -272,17 +274,41 @@ private static DiagnosticProperties doDump(String diagnosticCommand) {\n \t\t\t\t}\n \t\t\t}\n \t\t\tif (!dumpType.isEmpty()) {\n-\t\t\t\tString request = dumpType;\n-\t\t\t\tif (parts.length == 2) {\n-\t\t\t\t\tString fileDirective = (\"system\".equals(dumpType) && IPC.isZOS) ? \":dsn=\" : \":file=\"; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n-\t\t\t\t\trequest += fileDirective + parts[1];\n+\t\t\t\tStringBuilder request = new StringBuilder();\n+\t\t\t\trequest.append(dumpType);\n+\t\t\t\tboolean foundRequest = false;\n+\t\t\t\tboolean heapDump = \"heap\".equals(dumpType);\n+\t\t\t\tboolean systemDump = \"system\".equals(dumpType);\n+\t\t\t\tString separator = \":\"; //$NON-NLS-1$\n+\t\t\t\tfor (int i = 1; i < parts.length; i++) {\n+\t\t\t\t\tString option = parts[i];\n+\t\t\t\t\tboolean isRequest = option.startsWith(\"request=\");\n+\t\t\t\t\tboolean isOpts = option.startsWith(\"opts=\");\n+\t\t\t\t\tif (isRequest || isOpts) { //$NON-NLS-1$ //$NON-NLS-2$\n+\t\t\t\t\t\tif (!heapDump && isOpts) {\n+\t\t\t\t\t\t\t// opts= are only valid for heap dumps\n+\t\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\trequest.append(separator).append(option);\n+\t\t\t\t\t\tif (isRequest) {\n+\t\t\t\t\t\t\tfoundRequest = true;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tString fileDirective = (systemDump && IPC.isZOS) ? \"dsn=\" : \"file=\"; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$", "originalCommit": "e34fee7af09a9d8f08288df526ad8f3f1293eb2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg2NzI1Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499867253", "bodyText": "This line is much too long: please split.", "author": "keithc-ca", "createdAt": "2020-10-05T20:55:54Z", "path": "test/functional/Java8andUp/src/org/openj9/test/attachAPI/TestJcmd.java", "diffHunk": "@@ -238,6 +240,48 @@ public void testDumps() throws IOException {\n \t\t}\n \t}\n \n+\t@Test\n+\tpublic void testDumpsWithOptions() throws IOException {\n+\t\tString[][] commandsAndDumpTypes = {{DUMP_HEAP, \"Heap\", \"request=exclusive+compact+prepwalk,opts=CLASSIC\"}, {GC_HEAP_DUMP, \"Heap\", \"opts=PHD\"}, {DUMP_JAVA, \"Java\", \"request=serial\"}, {DUMP_SNAP, \"Snap\", \"request=exclusive\"}, {DUMP_SYSTEM, \"System\", \"request=exclusive+compact+prepwalk\"}};", "originalCommit": "e34fee7af09a9d8f08288df526ad8f3f1293eb2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg2OTA1NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r499869054", "bodyText": "The help should mention 'opts=..' only for heap dumps.", "author": "keithc-ca", "createdAt": "2020-10-05T20:59:03Z", "path": "jcl/src/java.base/share/classes/openj9/internal/tools/attach/target/DiagnosticUtils.java", "diffHunk": "@@ -356,17 +382,17 @@ private static DiagnosticProperties doHelp(String diagnosticCommand) {\n \t\t\t+ \" Options: -l : print information about ownable synchronizers%n\";\n \n \tprivate static final String DIAGNOSTICS_DUMP_HEAP_HELP = \"Create a heap dump.%n\" //$NON-NLS-1$\n-\t\t\t+ FORMAT_PREFIX + DIAGNOSTICS_DUMP_HEAP + FILE_PATH_HELP\n+\t\t\t+ FORMAT_PREFIX + DIAGNOSTICS_DUMP_HEAP + DUMP_OPTION_HELP", "originalCommit": "e34fee7af09a9d8f08288df526ad8f3f1293eb2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "be2c1a6ecd0748dbd3f94d5bbb078c3f9297e163", "url": "https://github.com/eclipse-openj9/openj9/commit/be2c1a6ecd0748dbd3f94d5bbb078c3f9297e163", "message": "Allow -Xdump options for jcmd Dump.* commands\n\nDefault system and heap dumps to `request=exclusive+prepwalk`\n\nFix a bug reporting an exception when requesting a dump.\n\nUpdate the tests.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-10-05T23:51:43Z", "type": "forcePushed"}, {"oid": "ebe534b4cbc755c27392a9392cde198cddda52cb", "url": "https://github.com/eclipse-openj9/openj9/commit/ebe534b4cbc755c27392a9392cde198cddda52cb", "message": "Allow -Xdump options for jcmd Dump.* commands\n\nDefault system and heap dumps to `request=exclusive+prepwalk`\n\nFix a bug reporting an exception when requesting a dump.\n\nUpdate the tests.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-10-06T00:01:07Z", "type": "forcePushed"}, {"oid": "d8bfc33bd470d8bc8e64e785b8d941529132a175", "url": "https://github.com/eclipse-openj9/openj9/commit/d8bfc33bd470d8bc8e64e785b8d941529132a175", "message": "Allow -Xdump options for jcmd Dump.* commands\n\nDefault system and heap dumps to `request=exclusive+prepwalk`\n\nFix a bug reporting an exception when requesting a dump.\n\nUpdate the tests.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-10-06T00:06:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM2NzY2MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r500367660", "bodyText": "Help for all other commands ends with a final %n; this should too.", "author": "keithc-ca", "createdAt": "2020-10-06T15:04:17Z", "path": "jcl/src/java.base/share/classes/openj9/internal/tools/attach/target/DiagnosticUtils.java", "diffHunk": "@@ -356,22 +392,22 @@ private static DiagnosticProperties doHelp(String diagnosticCommand) {\n \t\t\t+ \" Options: -l : print information about ownable synchronizers%n\";\n \n \tprivate static final String DIAGNOSTICS_DUMP_HEAP_HELP = \"Create a heap dump.%n\" //$NON-NLS-1$\n-\t\t\t+ FORMAT_PREFIX + DIAGNOSTICS_DUMP_HEAP + FILE_PATH_HELP\n+\t\t\t+ FORMAT_PREFIX + DIAGNOSTICS_DUMP_HEAP + HEAP_DUMP_OPTION_HELP + HEAPSYSTEM_DUMP_OPTION_HELP + GENERIC_DUMP_OPTION_HELP\n \t\t\t+ DIAGNOSTICS_GC_HEAP_DUMP + \" is an alias for \" + DIAGNOSTICS_DUMP_HEAP; //$NON-NLS-1$", "originalCommit": "d8bfc33bd470d8bc8e64e785b8d941529132a175", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQwMzM5MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r500403391", "bodyText": "Updated", "author": "pshipton", "createdAt": "2020-10-06T15:42:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM2NzY2MA=="}], "type": "inlineReview"}, {"oid": "be029128470aab0b99816eef68654ec0d8d1dd70", "url": "https://github.com/eclipse-openj9/openj9/commit/be029128470aab0b99816eef68654ec0d8d1dd70", "message": "Allow -Xdump options for jcmd Dump.* commands\n\nDefault system and heap dumps to `request=exclusive+prepwalk`\n\nFix a bug reporting an exception when requesting a dump.\n\nUpdate the tests.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-10-06T15:36:10Z", "type": "forcePushed"}, {"oid": "2fcba2e0a39ae37f448fd5928488ad3ff0c9ae2c", "url": "https://github.com/eclipse-openj9/openj9/commit/2fcba2e0a39ae37f448fd5928488ad3ff0c9ae2c", "message": "Allow -Xdump options for jcmd Dump.* commands\n\nDefault system and heap dumps to `request=exclusive+prepwalk`\n\nFix a bug reporting an exception when requesting a dump.\n\nUpdate the tests.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-10-06T15:42:12Z", "type": "forcePushed"}, {"oid": "f15577bb3aee2860e638cda623f98209a86edd3b", "url": "https://github.com/eclipse-openj9/openj9/commit/f15577bb3aee2860e638cda623f98209a86edd3b", "message": "Allow -Xdump options for jcmd Dump.* commands\n\nDefault system and heap dumps to `request=exclusive+prepwalk`\n\nFix a bug reporting an exception when requesting a dump.\n\nUpdate the tests.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-10-06T16:25:09Z", "type": "commit"}, {"oid": "f15577bb3aee2860e638cda623f98209a86edd3b", "url": "https://github.com/eclipse-openj9/openj9/commit/f15577bb3aee2860e638cda623f98209a86edd3b", "message": "Allow -Xdump options for jcmd Dump.* commands\n\nDefault system and heap dumps to `request=exclusive+prepwalk`\n\nFix a bug reporting an exception when requesting a dump.\n\nUpdate the tests.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-10-06T16:25:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ5NDk1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10774#discussion_r500494959", "bodyText": ": is only appropriate before the first option; subsequent options are separated by ,.\nSorry, I see line 317 now.", "author": "keithc-ca", "createdAt": "2020-10-06T18:04:51Z", "path": "jcl/src/java.base/share/classes/openj9/internal/tools/attach/target/DiagnosticUtils.java", "diffHunk": "@@ -272,17 +284,50 @@ private static DiagnosticProperties doDump(String diagnosticCommand) {\n \t\t\t\t}\n \t\t\t}\n \t\t\tif (!dumpType.isEmpty()) {\n-\t\t\t\tString request = dumpType;\n-\t\t\t\tif (parts.length == 2) {\n-\t\t\t\t\tString fileDirective = (\"system\".equals(dumpType) && IPC.isZOS) ? \":dsn=\" : \":file=\"; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$\n-\t\t\t\t\trequest += fileDirective + parts[1];\n+\t\t\t\tStringBuilder request = new StringBuilder();\n+\t\t\t\trequest.append(dumpType);\n+\t\t\t\tString filePath = null;\n+\t\t\t\tboolean foundRequest = false;\n+\t\t\t\tboolean heapDump = \"heap\".equals(dumpType); //$NON-NLS-1$\n+\t\t\t\tboolean systemDump = \"system\".equals(dumpType); //$NON-NLS-1$\n+\t\t\t\tString separator = \":\"; //$NON-NLS-1$", "originalCommit": "f15577bb3aee2860e638cda623f98209a86edd3b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}