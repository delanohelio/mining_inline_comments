{"pr_number": 11156, "pr_title": "Convert the property value from the platform encoding to MUTF8 string", "pr_createdAt": "2020-11-11T21:14:11Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/11156", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1MzEwNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521653104", "bodyText": "This is incorrect - should be pool_removeElement.", "author": "gacholio", "createdAt": "2020-11-11T21:37:05Z", "path": "runtime/vm/vmprops.c", "diffHunk": "@@ -1040,13 +1040,22 @@ getJ9VMVersionString(J9JavaVM *vm) {\n UDATA\n addSystemProperty(J9JavaVM * vm, const char* propName,  const char* propValue, UDATA flags)\n {\n+\tchar *convertedPropValue = NULL;\n \tJ9VMSystemProperty* newProp = pool_newElement(vm->systemProperties);\n \tif (NULL == newProp) {\n \t\treturn J9SYSPROP_ERROR_OUT_OF_MEMORY;\n \t}\n \n+\t/* Convert the value string from the platform encoding to the modified UTF8 */\n+\tconvertedPropValue = (char *)getMUtf8String(vm, propValue, strlen(propValue));\n+\tif (NULL == convertedPropValue) {\n+\t\tPORT_ACCESS_FROM_JAVAVM(vm);\n+\t\tj9mem_free_memory(newProp);", "originalCommit": "8fc5773e427a2df3f8afb9392694e3a0545ce4d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY2MjI4MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521662281", "bodyText": "The fix here will to be moved out as suggested by Pete.", "author": "ChengJin01", "createdAt": "2020-11-11T21:56:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1MzEwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1MzM2Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521653367", "bodyText": "This is going to be a little trickier. Sometimes the arguments to addSystemProperty() are already converted to utf8.\nSee https://github.com/eclipse/openj9/blob/master/runtime/vm/vmprops.c#L856-L861\nand https://github.com/eclipse/openj9/blob/master/runtime/vm/vmprops.c#L907\nEither the callers of addSystemProperty() need to pass in a new argument to indicate the value should be converted, or the conversion needs to be done elsewhere before addSystemProperty() is called.", "author": "pshipton", "createdAt": "2020-11-11T21:37:28Z", "path": "runtime/vm/vmprops.c", "diffHunk": "@@ -1040,13 +1040,22 @@ getJ9VMVersionString(J9JavaVM *vm) {\n UDATA\n addSystemProperty(J9JavaVM * vm, const char* propName,  const char* propValue, UDATA flags)\n {\n+\tchar *convertedPropValue = NULL;\n \tJ9VMSystemProperty* newProp = pool_newElement(vm->systemProperties);\n \tif (NULL == newProp) {\n \t\treturn J9SYSPROP_ERROR_OUT_OF_MEMORY;\n \t}\n \n+\t/* Convert the value string from the platform encoding to the modified UTF8 */\n+\tconvertedPropValue = (char *)getMUtf8String(vm, propValue, strlen(propValue));", "originalCommit": "8fc5773e427a2df3f8afb9392694e3a0545ce4d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY2NjI0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521666246", "bodyText": "As discussed with @pshipton offline, the fix above will be moved to getOptionArg to ensure all functions in addModularitySystemProperties including addPropertiesForOptionWithAssignArg are fixed in the same way to address all these cases for the platform setting.", "author": "ChengJin01", "createdAt": "2020-11-11T22:04:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1MzM2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY3MzI4NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521673285", "bodyText": "The code has been updated at 3032987. Will compile a build locally with the fix to see whether it still works good as expected.", "author": "ChengJin01", "createdAt": "2020-11-11T22:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1MzM2Nw=="}], "type": "inlineReview"}, {"oid": "30329871ee1a60edf626ffa8e542638851913045", "url": "https://github.com/eclipse-openj9/openj9/commit/30329871ee1a60edf626ffa8e542638851913045", "message": "Convert the property value from the platform encoding to MUTF8 string\n\nThe change is to convert the property value string from the platform\nencoding to the modified UTF8 to adapt to the OS locale setting.\n\nFixes: #11139\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-11-11T22:15:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4NjU0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521686546", "bodyText": "The places that use this need to pass the J9SYSPROP_FLAG_VALUE_ALLOCATED flag to addSystemProperty() so the memory is freed.", "author": "pshipton", "createdAt": "2020-11-11T22:53:35Z", "path": "runtime/vm/vmprops.c", "diffHunk": "@@ -152,6 +152,11 @@ getOptionArg(J9JavaVM *vm, IDATA argIndex, UDATA optionNameLen)\n \t}\n \n _end:\n+\tif (NULL != optionArg) {\n+\t\t/* Convert the value string from the platform encoding to the modified UTF8 */\n+\t\toptionArg = (char *)getMUtf8String(vm, optionArg, strlen(optionArg));", "originalCommit": "30329871ee1a60edf626ffa8e542638851913045", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4NzQxNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521687417", "bodyText": "and addPropertyForOptionWithModuleListArg() should free the memory.", "author": "pshipton", "createdAt": "2020-11-11T22:55:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4NjU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4NzY2Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521687666", "bodyText": "Also, pls add a function comment for this function which mentions the return value is allocated and needs to be freed.", "author": "pshipton", "createdAt": "2020-11-11T22:56:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4NjU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5MjUwMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521692500", "bodyText": "Updated the code against the suggestions above.", "author": "ChengJin01", "createdAt": "2020-11-11T23:10:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4NjU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5OTE5OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521699198", "bodyText": "addPropertyForOptionWithModuleListArg() needs to free the memory, and addPropertiesForOptionWithAssignArg needs to pass J9SYSPROP_FLAG_VALUE_ALLOCATED as well.", "author": "pshipton", "createdAt": "2020-11-11T23:24:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4NjU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcwNjk4MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521706981", "bodyText": "Added code j9mem_free_memory(optionArg) in the loop in addPropertyForOptionWithModuleListArg().", "author": "ChengJin01", "createdAt": "2020-11-11T23:40:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4NjU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcwOTg0OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521709848", "bodyText": "Added J9SYSPROP_FLAG_VALUE_ALLOCATED to addPropertiesForOptionWithAssignArg given only J9SYSPROP_FLAG_NAME_ALLOCATED is passed to addSystemProperty in there.", "author": "ChengJin01", "createdAt": "2020-11-11T23:49:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4NjU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcxMDgyNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521710825", "bodyText": "Ok, and pls add a function comment for this function which mentions the return value is allocated and needs to be freed.", "author": "pshipton", "createdAt": "2020-11-11T23:52:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4NjU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcxNzAzNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521717037", "bodyText": "Added comment for optionArg in addPropertiesForOptionWithAssignArg.", "author": "ChengJin01", "createdAt": "2020-11-12T00:03:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4NjU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc0MTQ4Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521741483", "bodyText": "I'm asking for a function comment to be added to getOptionArg().", "author": "pshipton", "createdAt": "2020-11-12T00:45:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4NjU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc1MzE0Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521753143", "bodyText": "Added the function comment to getOptionArg() as suggested above.", "author": "ChengJin01", "createdAt": "2020-11-12T01:05:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4NjU0Ng=="}], "type": "inlineReview"}, {"oid": "96784bbac3e5bc47e3d5ce369403492bc1cc9573", "url": "https://github.com/eclipse-openj9/openj9/commit/96784bbac3e5bc47e3d5ce369403492bc1cc9573", "message": "Convert the property value from the platform encoding to MUTF8 string\n\nThe change is to convert the property value string from the platform\nencoding to the modified UTF8 to adapt to the OS locale setting.\n\nFixes: #11139\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-11-11T23:09:34Z", "type": "forcePushed"}, {"oid": "be15e82436188b0c87dbb989d38e8377a9dedb58", "url": "https://github.com/eclipse-openj9/openj9/commit/be15e82436188b0c87dbb989d38e8377a9dedb58", "message": "Convert the property value from the platform encoding to MUTF8 string\n\nThe change is to convert the property value string from the platform\nencoding to the modified UTF8 to adapt to the OS locale setting.\n\nFixes: #11139\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-11-11T23:38:29Z", "type": "forcePushed"}, {"oid": "7b2e824030689adfa86045ba633c9b28b27fea9b", "url": "https://github.com/eclipse-openj9/openj9/commit/7b2e824030689adfa86045ba633c9b28b27fea9b", "message": "Convert the property value from the platform encoding to MUTF8 string\n\nThe change is to convert the property value string from the platform\nencoding to the modified UTF8 to adapt to the OS locale setting.\n\nFixes: #11139\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-11-11T23:48:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcxMDU2Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521710562", "bodyText": "Above there is a case that does goto _end which needs to free optionArg", "author": "pshipton", "createdAt": "2020-11-11T23:52:00Z", "path": "runtime/vm/vmprops.c", "diffHunk": "@@ -309,6 +316,8 @@ addPropertyForOptionWithModuleListArg(J9JavaVM *vm, const char *optionName, IDAT\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tCONSUME_ARG(j9vm_args, argIndex);\n+\n+\t\t\t\tj9mem_free_memory(optionArg);", "originalCommit": "7b2e824030689adfa86045ba633c9b28b27fea9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcxMDY5Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521710693", "bodyText": "two cases actually", "author": "pshipton", "createdAt": "2020-11-11T23:52:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcxMDU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcxNzI0Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521717242", "bodyText": "Fixed the cases as mentioned above.", "author": "ChengJin01", "createdAt": "2020-11-12T00:03:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTcxMDU2Mg=="}], "type": "inlineReview"}, {"oid": "ae8da52d92f15640045fe29ba9290fea1854d4e7", "url": "https://github.com/eclipse-openj9/openj9/commit/ae8da52d92f15640045fe29ba9290fea1854d4e7", "message": "Convert the property value from the platform encoding to MUTF8 string\n\nThe change is to convert the property value string from the platform\nencoding to the modified UTF8 to adapt to the OS locale setting.\n\nFixes: #11139\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-11-12T00:01:18Z", "type": "forcePushed"}, {"oid": "0c59946fdbc16ad2ac90c0a476c45b253b2edad1", "url": "https://github.com/eclipse-openj9/openj9/commit/0c59946fdbc16ad2ac90c0a476c45b253b2edad1", "message": "Convert the property value from the platform encoding to MUTF8 string\n\nThe change is to convert the property value string from the platform\nencoding to the modified UTF8 to adapt to the OS locale setting.\n\nFixes: #11139\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-11-12T00:03:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc0MTc0Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521741742", "bodyText": "There are 4 places calling this, why only comment one of them?", "author": "pshipton", "createdAt": "2020-11-12T00:45:56Z", "path": "runtime/vm/vmprops.c", "diffHunk": "@@ -370,6 +381,7 @@ addPropertiesForOptionWithAssignArg(J9JavaVM *vm, const char *optionName, UDATA\n \t\tUDATA indexLen = 1;\n \n \t\tdo {\n+\t\t\t/* The allocated return value for optionArg needs to be freed after use */", "originalCommit": "0c59946fdbc16ad2ac90c0a476c45b253b2edad1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc1MzQ3Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/11156#discussion_r521753476", "bodyText": "Added the function comment for getOptionArg.", "author": "ChengJin01", "createdAt": "2020-11-12T01:06:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc0MTc0Mg=="}], "type": "inlineReview"}, {"oid": "00742e1656ee8b67a97eb4720cb30bfc65efff58", "url": "https://github.com/eclipse-openj9/openj9/commit/00742e1656ee8b67a97eb4720cb30bfc65efff58", "message": "Convert the property value from the platform encoding to MUTF8 string\n\nThe change is to convert the property value string from the platform\nencoding to the modified UTF8 to adapt to the OS locale setting.\n\nFixes: #11139\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-11-12T01:01:41Z", "type": "forcePushed"}, {"oid": "a1828265d4db88473cf2283e84a2a3661bfe7c5f", "url": "https://github.com/eclipse-openj9/openj9/commit/a1828265d4db88473cf2283e84a2a3661bfe7c5f", "message": "Convert the property value from the platform encoding to MUTF8 string\n\nThe change is to convert the property value string from the platform\nencoding to the modified UTF8 to adapt to the OS locale setting.\n\nFixes: #11139\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-11-12T01:04:45Z", "type": "commit"}, {"oid": "a1828265d4db88473cf2283e84a2a3661bfe7c5f", "url": "https://github.com/eclipse-openj9/openj9/commit/a1828265d4db88473cf2283e84a2a3661bfe7c5f", "message": "Convert the property value from the platform encoding to MUTF8 string\n\nThe change is to convert the property value string from the platform\nencoding to the modified UTF8 to adapt to the OS locale setting.\n\nFixes: #11139\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-11-12T01:04:45Z", "type": "forcePushed"}]}