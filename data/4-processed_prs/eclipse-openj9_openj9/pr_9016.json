{"pr_number": 9016, "pr_title": "Make JITINLINE functions in MethodMetaData.c static VMINLINE", "pr_createdAt": "2020-03-28T20:21:21Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9016", "timeline": [{"oid": "1ce5d3a4be825d8f61b0434c29f97b7c963bd096", "url": "https://github.com/eclipse-openj9/openj9/commit/1ce5d3a4be825d8f61b0434c29f97b7c963bd096", "message": "Make JITINLINE functions in MethodMetaData.c static inline\n\n1. Move the declaration of private functions from MethodMetaData.h to\n   MethodMetaData.c\n2. Add the static qualifier to JITINLINE.\n3. Recognize the clang compiler, JITINLINE should be the same as on GCC\n\nThis fixes a link-time error, caused by an incorrect usage of the inline\nqualifier in C code.\n\nSigned-off-by: Robert Young <rwy0717@gmail.com>", "committedDate": "2020-03-28T20:23:03Z", "type": "forcePushed"}, {"oid": "d12fc05bc7a9ce6467ac5b3f9f5c2a2c3facbb24", "url": "https://github.com/eclipse-openj9/openj9/commit/d12fc05bc7a9ce6467ac5b3f9f5c2a2c3facbb24", "message": "Make JITINLINE functions in MethodMetaData.c static inline\n\n1. Move the declaration of private functions from MethodMetaData.h to\n   MethodMetaData.c\n2. Add the static qualifier to JITINLINE.\n3. Recognize the clang compiler, JITINLINE should be the same as on GCC\n4. For functions already marked static JITINLINE, remove static\n   qualifier.\n\nThis fixes a link-time error, caused by an incorrect usage of the inline\nqualifier in C code.\n\nSigned-off-by: Robert Young <rwy0717@gmail.com>", "committedDate": "2020-03-28T20:31:57Z", "type": "forcePushed"}, {"oid": "eba1d78b6fe12db0f7afb42642e1e5248c522b4f", "url": "https://github.com/eclipse-openj9/openj9/commit/eba1d78b6fe12db0f7afb42642e1e5248c522b4f", "message": "Make JITINLINE functions in MethodMetaData.c static inline\n\n1. Move the declaration of private functions from MethodMetaData.h to\n   MethodMetaData.c\n2. Add the static qualifier to JITINLINE.\n3. Recognize the clang compiler, JITINLINE should be the same as on GCC\n4. For functions already marked static and JITINLINE, remove static\n   qualifier.\n5. Remove duplicate non-inline declarations of:\n   - getJit32BitInterpreterPC\n   - getJit16BitInterpreterPC\n   - getJitConstantPool\n   - getJitRamMethod\n6. remove JITINLINE annotation from public function getByteCodeIndex\n\nThis fixes a link-time error, caused by an incorrect usage of the inline\nqualifier in C code.\n\nSigned-off-by: Robert Young <rwy0717@gmail.com>", "committedDate": "2020-03-28T21:31:08Z", "type": "forcePushed"}, {"oid": "d846a8f1a5b781aac3d9ff01af9cfeb49e70a3f5", "url": "https://github.com/eclipse-openj9/openj9/commit/d846a8f1a5b781aac3d9ff01af9cfeb49e70a3f5", "message": "Make JITINLINE functions in MethodMetaData.c also static\n\n1. Move the declaration of private functions from MethodMetaData.h to\n   MethodMetaData.c, as well as the definition of JITINLINE.\n2. Add the static qualifier to every function that is marked JITINLINE.\n3. Recognize the clang compiler, JITINLINE should be the same as on GCC.\n4. Replace preprocessor test against WINDOWS with test against _MSC_VER.\n5. Remove duplicate non-inline declarations of:\n   - getJit32BitInterpreterPC\n   - getJit16BitInterpreterPC\n   - getJitConstantPool\n   - getJitRamMethod\n6. remove JITINLINE annotation from public function getByteCodeIndex.\n\nThis fixes a link-time error, caused by an incorrect usage of the inline\nqualifier in C code.\n\nSigned-off-by: Robert Young <rwy0717@gmail.com>", "committedDate": "2020-03-29T17:24:01Z", "type": "forcePushed"}, {"oid": "0b53ef5ddc63b9766f2b4c604df6308a73a09383", "url": "https://github.com/eclipse-openj9/openj9/commit/0b53ef5ddc63b9766f2b4c604df6308a73a09383", "message": "Make JITINLINE functions in MethodMetaData.c also static\n\n1. Move the declaration of private functions from MethodMetaData.h to\n   MethodMetaData.c, as well as the definition of JITINLINE.\n2. Add the static qualifier to every function that is marked JITINLINE.\n3. Recognize the clang compiler, JITINLINE should be the same as on GCC.\n4. Replace preprocessor test against WINDOWS with test against _MSC_VER.\n5. Remove duplicate non-inline declarations of:\n   - getJit32BitInterpreterPC\n   - getJit16BitInterpreterPC\n   - getJitConstantPool\n   - getJitRamMethod\n6. remove JITINLINE annotation from public function getByteCodeIndex.\n\nThis fixes a link-time error, caused by an incorrect usage of the inline\nqualifier in C code.\n\nSigned-off-by: Robert Young <rwy0717@gmail.com>", "committedDate": "2020-03-29T17:27:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUxNTcxMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9016#discussion_r407515711", "bodyText": "Does JITINLINE == VMINLINE? If so I don't see the value of having this duplicate value. We should just use VMINLINE to be consistent.", "author": "fjeremic", "createdAt": "2020-04-13T14:45:54Z", "path": "runtime/compiler/runtime/MethodMetaData.c", "diffHunk": "@@ -30,10 +30,62 @@\n #include \"rommeth.h\"\n #include \"env/jittypes.h\"\n \n+#if defined(DEBUG)\n+#define JITINLINE\n+#else\n+#if defined(_MSC_VER)\n+#define JITINLINE __forceinline\n+#elif (((__GNUC__ > 3) || (__GNUC__ == 3 && __GNUC_MINOR__ >= 1)) || defined(__clang__)) && !defined(J9VM_GC_REALTIME)\n+#define JITINLINE inline __attribute((always_inline))\n+#else\n+#define JITINLINE __inline\n+#endif\n+#endif", "originalCommit": "0b53ef5ddc63b9766f2b4c604df6308a73a09383", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUzMTczOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9016#discussion_r407531739", "bodyText": "Does JITINLINE == VMINLINE?\n\nThey are close but not identical.\n\nWe should just use VMINLINE to be consistent.\n\nYep, I was going for a more minimal PR, but am more than happy to tidy up. Before we switch to VMINLINE, there is one strange detail here that I would like to understand. In this condition:\n#elif (((__GNUC__ > 3) || (__GNUC__ == 3 && __GNUC_MINOR__ >= 1)) || defined(__clang__)) && !defined(J9VM_GC_REALTIME)\nWhy would it say && !defined(J9VM_GC_REALTIME)? It seems important, but I don't see why it's here. J9VM_GC_REALTIME is always defined--so effectively, JITINLINE will always be __inline. Meanwhile, VMINLINE does something which makes more sense.\nI'm going to try switching to VMINLINE and see if it everything works (I expect it will).", "author": "rwy0717", "createdAt": "2020-04-13T15:15:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUxNTcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUzMzI3MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9016#discussion_r407533270", "bodyText": "Probably some historical artifact. Yeah I'd say if VMINLINE works after your tests we just switch to that and keep things simple. Thanks!", "author": "fjeremic", "createdAt": "2020-04-13T15:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUxNTcxMQ=="}], "type": "inlineReview"}, {"oid": "c15894e46262ed578788ecfa204e62aee67d52a2", "url": "https://github.com/eclipse-openj9/openj9/commit/c15894e46262ed578788ecfa204e62aee67d52a2", "message": "Make JITINLINE functions in MethodMetaData.c also static\n\n1. Move the declaration of private functions from MethodMetaData.h to\n   MethodMetaData.c, as well as the definition of JITINLINE.\n2. Add the static qualifier to every function that is marked JITINLINE.\n3. Recognize the clang compiler, JITINLINE should be the same as on GCC.\n4. Replace preprocessor test against WINDOWS with test against _MSC_VER.\n5. Remove duplicate non-inline declarations of:\n   - getJit32BitInterpreterPC\n   - getJit16BitInterpreterPC\n   - getJitConstantPool\n   - getJitRamMethod\n6. remove JITINLINE annotation from public function getByteCodeIndex.\n\nThis fixes a link-time error, caused by an incorrect usage of the inline\nqualifier in C code.\n\nSigned-off-by: Robert Young <rwy0717@gmail.com>", "committedDate": "2020-04-14T13:10:33Z", "type": "forcePushed"}, {"oid": "27054625eeac5e0bbf260f366890c8e5fbcae4cf", "url": "https://github.com/eclipse-openj9/openj9/commit/27054625eeac5e0bbf260f366890c8e5fbcae4cf", "message": "Make JITINLINE functions in MethodMetaData.c static VMINLINE\n\n1. Delete JITINLINE, replacing all uses with VMINLINE.\n2. Move the declaration of private functions from MethodMetaData.h to\n   MethodMetaData.c.\n3. Add the static qualifier to every function that was marked JITINLINE.\n4. Remove duplicate non-inline declarations of:\n   - getJit32BitInterpreterPC\n   - getJit16BitInterpreterPC\n   - getJitConstantPool\n   - getJitRamMethod\n5. remove inline annotation from the public function getByteCodeIndex.\n\nThis fixes a dynamic linker error in debug builds, caused by inline\nfunction definitions that were were not marked static or extern.\n\nSigned-off-by: Robert Young <rwy0717@gmail.com>", "committedDate": "2020-04-14T13:57:35Z", "type": "commit"}, {"oid": "27054625eeac5e0bbf260f366890c8e5fbcae4cf", "url": "https://github.com/eclipse-openj9/openj9/commit/27054625eeac5e0bbf260f366890c8e5fbcae4cf", "message": "Make JITINLINE functions in MethodMetaData.c static VMINLINE\n\n1. Delete JITINLINE, replacing all uses with VMINLINE.\n2. Move the declaration of private functions from MethodMetaData.h to\n   MethodMetaData.c.\n3. Add the static qualifier to every function that was marked JITINLINE.\n4. Remove duplicate non-inline declarations of:\n   - getJit32BitInterpreterPC\n   - getJit16BitInterpreterPC\n   - getJitConstantPool\n   - getJitRamMethod\n5. remove inline annotation from the public function getByteCodeIndex.\n\nThis fixes a dynamic linker error in debug builds, caused by inline\nfunction definitions that were were not marked static or extern.\n\nSigned-off-by: Robert Young <rwy0717@gmail.com>", "committedDate": "2020-04-14T13:57:35Z", "type": "forcePushed"}]}