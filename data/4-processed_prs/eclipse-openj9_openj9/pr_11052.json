{"pr_number": 11052, "pr_title": "Improve jps to be able to handle composed arguments", "pr_createdAt": "2020-10-30T00:00:24Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/11052", "timeline": [{"oid": "f058b3aa172e1f8c692eaa3dd8b5aa1af23fc897", "url": "https://github.com/eclipse-openj9/openj9/commit/f058b3aa172e1f8c692eaa3dd8b5aa1af23fc897", "message": "This patch improves jps to be able to handle composed arguments\n\nFixes #11036\n\nSigned-off-by: Alexey Anufriev <contact@alexey-anufriev.com>", "committedDate": "2020-10-30T00:04:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY5MzkzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r514693935", "bodyText": "-J needs to be a separate argument. It's actually -J<vm option> such as -J-Xmx512m.", "author": "pshipton", "createdAt": "2020-10-30T01:58:26Z", "path": "jcl/src/jdk.jcmd/share/classes/openj9/tools/attach/diagnostics/tools/Jps.java", "diffHunk": "@@ -33,12 +33,27 @@\n  * A tool for listing Java processes and their information.\n  *\n  */\n+@SuppressWarnings(\"nls\")\n public class Jps {\n \n+\tprivate static final String DESCRIPTION =\n+\t\t\t\"jps: Print a list of Java processes and information about them%n%n\";\n+\n+\tprivate static final String HELP_TEXT =\n+\t\t\t\"usage: jps [-h] [-J] [-l] [-q] [-m] [-v]%n\" +\n+\t\t\t\"usage: jps [-h] [-Jlqmv]%n%n\" +", "originalCommit": "f058b3aa172e1f8c692eaa3dd8b5aa1af23fc897", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTExOTc0OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r515119749", "bodyText": "There are duplicated usage: here, in addition, the usage format should be consistent with other tools such as Jmap, Jstack, and Jstat in same package.", "author": "JasonFengJ9", "createdAt": "2020-10-30T14:02:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY5MzkzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEyNDUxMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r515124511", "bodyText": "@JasonFengJ9, sure, will remove the duplicate. And by the \"consistent format\" do you mean to have support of composed arguments for every tool?", "author": "alexey-anufriev", "createdAt": "2020-10-30T14:08:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY5MzkzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzMzcwNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r515133706", "bodyText": "@alexey-anufriev I meant the usage format like Jmap as following:\n\tprivate static String HELPTEXT = \"jmap: obtain heap information about a Java process%n\"\n\t\t\t+ \" Usage:%n\"\n\t\t\t+ \"    jmap <option>* <vmid>%n\"\n\nin which Usage:%n is in a separated line.\n\nAll the other tools in the same package can be updated similarly.\n\nI think this is about the support of composed arguments for other tools though not necessary in this PR.", "author": "JasonFengJ9", "createdAt": "2020-10-30T14:22:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY5MzkzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzNjE4OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r515136188", "bodyText": "@JasonFengJ9, ah, so you mean the help output. For sure I can adapt that.", "author": "alexey-anufriev", "createdAt": "2020-10-30T14:25:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY5MzkzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjMxMjkyMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r516312920", "bodyText": "Improved", "author": "alexey-anufriev", "createdAt": "2020-11-02T23:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY5MzkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzODM5MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r515138390", "bodyText": "Since this PR intends to match RI behaviours, this error message can be modified to illegal argument: as well such that the script doesn't have to handle different errors.\n@pshipton any thoughts?", "author": "JasonFengJ9", "createdAt": "2020-10-30T14:28:49Z", "path": "jcl/src/jdk.jcmd/share/classes/openj9/tools/attach/diagnostics/tools/Jps.java", "diffHunk": "@@ -68,38 +83,52 @@ public static void main(String[] args) {\n \t\tSystem.exit(rc);\n \t}\n \t\n-\t@SuppressWarnings(\"nls\")\n \tprivate static void parseArguments(String[] args) {\n \t\tprintApplicationArguments = false;\n \t\tprintJvmArguments = false;\n \t\tnoPackageName = true;\n \t\tvmidOnly = false;\n-\t\tfinal String HELPTEXT = \"jps: Print a list of Java processes and information about them%n\"\n-\t\t\t\t+ \"    -J: supply arguments to the Java VM running jps%n\"\n-\t\t\t\t+ \"    -l: print the application package name%n\"\n-\t\t\t\t+ \"    -q: print only the virtual machine identifiers%n\"\n-\t\t\t\t+ \"    -m: print the application arguments%n\"\n-\t\t\t\t+ \"    -v: print the Java VM arguments, including those produced automatically%n\";\n-\t\tfor (String a : args) {\n-\t\t\tswitch (a) {\n-\t\t\tcase \"-l\":\n+\n+\t\tfor (String arg : args) {\n+\t\t\tif (!arg.startsWith(\"-\") || arg.length() == 1) {\n+\t\t\t\tSystem.out.printf(\"malformed argument '%s'%n%n\", arg);", "originalCommit": "f058b3aa172e1f8c692eaa3dd8b5aa1af23fc897", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE0MTM0Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r515141342", "bodyText": "Makes sense", "author": "pshipton", "createdAt": "2020-10-30T14:33:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzODM5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjMxMzI4Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r516313287", "bodyText": "Improved", "author": "alexey-anufriev", "createdAt": "2020-11-02T23:03:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzODM5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzODczMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r515138732", "bodyText": "Do we need different error message here?", "author": "JasonFengJ9", "createdAt": "2020-10-30T14:29:20Z", "path": "jcl/src/jdk.jcmd/share/classes/openj9/tools/attach/diagnostics/tools/Jps.java", "diffHunk": "@@ -68,38 +83,52 @@ public static void main(String[] args) {\n \t\tSystem.exit(rc);\n \t}\n \t\n-\t@SuppressWarnings(\"nls\")\n \tprivate static void parseArguments(String[] args) {\n \t\tprintApplicationArguments = false;\n \t\tprintJvmArguments = false;\n \t\tnoPackageName = true;\n \t\tvmidOnly = false;\n-\t\tfinal String HELPTEXT = \"jps: Print a list of Java processes and information about them%n\"\n-\t\t\t\t+ \"    -J: supply arguments to the Java VM running jps%n\"\n-\t\t\t\t+ \"    -l: print the application package name%n\"\n-\t\t\t\t+ \"    -q: print only the virtual machine identifiers%n\"\n-\t\t\t\t+ \"    -m: print the application arguments%n\"\n-\t\t\t\t+ \"    -v: print the Java VM arguments, including those produced automatically%n\";\n-\t\tfor (String a : args) {\n-\t\t\tswitch (a) {\n-\t\t\tcase \"-l\":\n+\n+\t\tfor (String arg : args) {\n+\t\t\tif (!arg.startsWith(\"-\") || arg.length() == 1) {\n+\t\t\t\tSystem.out.printf(\"malformed argument '%s'%n%n\", arg);\n+\t\t\t\tinterruptWithHelpMessage();\n+\t\t\t}\n+\t\t\targ = arg.substring(1);\n+\t\t\tfor (char singleArg : arg.toCharArray()) {\n+\t\t\t\tprocessArgument(singleArg);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tprivate static void processArgument(char arg) {\n+\t\tswitch (arg) {\n+\t\t\tcase 'l':\n \t\t\t\tnoPackageName = false;\n \t\t\t\tbreak;\n-\t\t\tcase \"-m\":\n+\t\t\tcase 'm':\n \t\t\t\tprintApplicationArguments = true;\n \t\t\t\tbreak;\n-\t\t\tcase \"-q\":\n+\t\t\tcase 'q':\n \t\t\t\tvmidOnly = true;\n \t\t\t\tbreak;\n-\t\t\tcase \"-v\":\n+\t\t\tcase 'v':\n \t\t\t\tprintJvmArguments = true;\n \t\t\t\tbreak;\n-\t\t\t\t/* implicitly handle -h and -help via the default case */\n-\t\t\tdefault: \n-\t\t\t\tSystem.out.printf(HELPTEXT);\n-\t\t\t\tSystem.exit(1);\n+\t\t\tcase 'h':\n+\t\t\t\tSystem.out.printf(DESCRIPTION);\n+\t\t\t\tinterruptWithHelpMessage();\n+\t\t\t\tbreak;\n+\t\t\tdefault:\n+\t\t\t\tSystem.out.printf(\"unsupported argument '-%c'%n%n\", arg);", "originalCommit": "f058b3aa172e1f8c692eaa3dd8b5aa1af23fc897", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE0MjAxMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r515142011", "bodyText": "Pls expand why the message needs to be different. Are you referring to comparison with the RI?", "author": "pshipton", "createdAt": "2020-10-30T14:34:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzODczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE0MjI5OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r515142299", "bodyText": "I will reuse illegal argument", "author": "alexey-anufriev", "createdAt": "2020-10-30T14:34:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzODczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE0MzA5NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r515143094", "bodyText": "I think this should be illegal argument as well to match RI.", "author": "JasonFengJ9", "createdAt": "2020-10-30T14:36:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzODczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjMxMzMzOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r516313338", "bodyText": "Improved", "author": "alexey-anufriev", "createdAt": "2020-11-02T23:03:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzODczMg=="}], "type": "inlineReview"}, {"oid": "e0babb1ac07e61106a36239defaad37adc08e20b", "url": "https://github.com/eclipse-openj9/openj9/commit/e0babb1ac07e61106a36239defaad37adc08e20b", "message": "This patch improves jps to be able to handle composed arguments\n\nFixes #11036\n\nSigned-off-by: Alexey Anufriev <contact@alexey-anufriev.com>", "committedDate": "2020-11-02T23:01:39Z", "type": "forcePushed"}, {"oid": "7d039d09791c5420bfc397ec5772809609d5fb97", "url": "https://github.com/eclipse-openj9/openj9/commit/7d039d09791c5420bfc397ec5772809609d5fb97", "message": "This patch improves jps to be able to handle composed arguments\n\nFixes #11036\n\nSigned-off-by: Alexey Anufriev <contact@alexey-anufriev.com>", "committedDate": "2020-11-03T22:18:24Z", "type": "commit"}, {"oid": "7d039d09791c5420bfc397ec5772809609d5fb97", "url": "https://github.com/eclipse-openj9/openj9/commit/7d039d09791c5420bfc397ec5772809609d5fb97", "message": "This patch improves jps to be able to handle composed arguments\n\nFixes #11036\n\nSigned-off-by: Alexey Anufriev <contact@alexey-anufriev.com>", "committedDate": "2020-11-03T22:18:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMyNDc4NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r517324784", "bodyText": "@alexey-anufriev this can stay as [-lqmv] but need a note that -q takes precedence over the other options.", "author": "JasonFengJ9", "createdAt": "2020-11-04T12:59:09Z", "path": "jcl/src/jdk.jcmd/share/classes/openj9/tools/attach/diagnostics/tools/Jps.java", "diffHunk": "@@ -33,12 +33,28 @@\n  * A tool for listing Java processes and their information.\n  *\n  */\n+@SuppressWarnings(\"nls\")\n public class Jps {\n \n+\tprivate static final String DESCRIPTION =\n+\t\t\t\"jps: Print a list of Java processes and information about them%n%n\";\n+\n+\tprivate static final String HELP_TEXT =\n+\t\t\t\"Usage:%n\" +\n+\t\t\t\"    jps [-h] [-J<vm option>] [-l] [-q] [-m] [-v]%n\" +\n+\t\t\t\"    jps [-h] [-J<vm option>] [-q] [-lmv]%n%n\" +", "originalCommit": "7d039d09791c5420bfc397ec5772809609d5fb97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMyNjY4MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r517326681", "bodyText": "But q flag composed with any other flag will lead to illegal argument. And block [-lqmv] would mean that they can be used together, which is not true anymore.", "author": "alexey-anufriev", "createdAt": "2020-11-04T13:02:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMyNDc4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM3NzEwMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r517377101", "bodyText": "But q flag composed with any other flag will lead to illegal argument\n\nProbably there was confusion here, #11052 (comment) (I agreed) suggested that q composed with other flags should not be restricted.", "author": "JasonFengJ9", "createdAt": "2020-11-04T14:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMyNDc4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM3Nzg5NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r517377895", "bodyText": "Yes, it's good the way it is.", "author": "pshipton", "createdAt": "2020-11-04T14:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMyNDc4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4MjUyNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r517382526", "bodyText": "Yes, it's good the way it is.\n\n@pshipton are you leaning toward current way \"restrict q flag with others\"?", "author": "JasonFengJ9", "createdAt": "2020-11-04T14:27:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMyNDc4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4NjE3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r517386172", "bodyText": "The help output is as we requested. The restriction on combining -q with other flags isn't what we discussed before, but the code is already written. I don't think it's a big deal either way. I plan to merge it the way it is once the testing completes.", "author": "pshipton", "createdAt": "2020-11-04T14:32:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzMyNDc4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM3OTgzNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r517379836", "bodyText": "Sorry, we don't want to restrict q with other flags though RI does so.\nPlease revert to previous version.", "author": "JasonFengJ9", "createdAt": "2020-11-04T14:23:51Z", "path": "jcl/src/jdk.jcmd/share/classes/openj9/tools/attach/diagnostics/tools/Jps.java", "diffHunk": "@@ -68,38 +84,56 @@ public static void main(String[] args) {\n \t\tSystem.exit(rc);\n \t}\n \t\n-\t@SuppressWarnings(\"nls\")\n \tprivate static void parseArguments(String[] args) {\n \t\tprintApplicationArguments = false;\n \t\tprintJvmArguments = false;\n \t\tnoPackageName = true;\n \t\tvmidOnly = false;\n-\t\tfinal String HELPTEXT = \"jps: Print a list of Java processes and information about them%n\"\n-\t\t\t\t+ \"    -J: supply arguments to the Java VM running jps%n\"\n-\t\t\t\t+ \"    -l: print the application package name%n\"\n-\t\t\t\t+ \"    -q: print only the virtual machine identifiers%n\"\n-\t\t\t\t+ \"    -m: print the application arguments%n\"\n-\t\t\t\t+ \"    -v: print the Java VM arguments, including those produced automatically%n\";\n-\t\tfor (String a : args) {\n-\t\t\tswitch (a) {\n-\t\t\tcase \"-l\":\n+\n+\t\tfor (String arg : args) {\n+\t\t\tif (isInvalidArgument(arg)) {\n+\t\t\t\tSystem.out.printf(\"illegal argument: %s%n%n\", arg);\n+\t\t\t\tinterruptWithHelpMessage();\n+\t\t\t}\n+\t\t\targ = arg.substring(1);\n+\t\t\tfor (char singleArg : arg.toCharArray()) {\n+\t\t\t\tprocessArgument(singleArg);\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tprivate static boolean isInvalidArgument(String arg) {", "originalCommit": "7d039d09791c5420bfc397ec5772809609d5fb97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4NTEzOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r517385138", "bodyText": "Let's stop the churn. It isn't what we discussed before, but the code is already written. I don't think it's a big deal either way. I plan to merge it the way it is once the testing completes.", "author": "pshipton", "createdAt": "2020-11-04T14:31:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM3OTgzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MTQ5Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/11052#discussion_r517391496", "bodyText": "sure, it is fine to me.", "author": "JasonFengJ9", "createdAt": "2020-11-04T14:39:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM3OTgzNg=="}], "type": "inlineReview"}]}