{"pr_number": 8525, "pr_title": "Set estimate when encoding per-CC helper snippets", "pr_createdAt": "2020-02-07T01:11:38Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8525", "timeline": [{"oid": "3e8e33b9cddd9acd57ce063b203bd0031dedc7c5", "url": "https://github.com/eclipse-openj9/openj9/commit/3e8e33b9cddd9acd57ce063b203bd0031dedc7c5", "message": "Set estimate when encoding per-CC helper snippets\n\nPreviously, when performing binary encoding for the per-CC helper\nsnippets on Power, binary length estimates were not being set on the\ninstructions being encoded. While this was fine in the past, since these\nestimates were not being used in this case, an impending refactor to the\nPower binary encoder will be adding asserts to ensure that these values\nwere set correctly initially. As a result of this, it is now necessary\nto ensure that estimateBinaryLength is called on an instruction prior to\ncalling generateBinaryEncoding on it.\n\nSigned-off-by: Ben Thomas <ben@benthomas.ca>", "committedDate": "2020-02-06T16:09:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzEzNDcxNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8525#discussion_r377134714", "bodyText": "There is only one BinaryBufferStart value (at least for a logical encoding unit such as a specific compilation). The way i->estimateBinaryLength is done looks wrong to me.  The next instruction will see longer estimated length. Reversing the two lines above and fixing using cg->getBinaryBufferStart would make more senses.", "author": "zl-wang", "createdAt": "2020-02-10T15:31:33Z", "path": "runtime/compiler/p/codegen/J9PPCSnippet.cpp", "diffHunk": "@@ -1879,6 +1879,17 @@ uint32_t TR::getCCPreLoadedCodeSize()\n #define CCEYECATCHER(a, b, c, d) (((a) << 24) | ((b) << 16) | ((c) << 8) | ((d) << 0))\n #endif\n \n+static void performCCPreLoadedBinaryEncoding(uint8_t *buffer, TR::CodeGenerator *cg)\n+   {\n+   cg->setBinaryBufferStart(buffer);\n+   cg->setBinaryBufferCursor(buffer);\n+   for (TR::Instruction *i = cg->getFirstInstruction(); i != NULL; i = i->getNext())\n+      {\n+      i->estimateBinaryLength(cg->getBinaryBufferCursor() - cg->getBinaryBufferStart());\n+      cg->setBinaryBufferCursor(i->generateBinaryEncoding());", "originalCommit": "3e8e33b9cddd9acd57ce063b203bd0031dedc7c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMzNTAzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8525#discussion_r378335030", "bodyText": "I think you're confused about what this code is actually doing... In this case, estimateBinaryLength is the method of TR::Instruction in charge of generating the binary length estimate and it takes in the current estimated offset into the binary buffer.\nIn this case, using the actual offset instead of keeping track of an estimate is fine since we don't ever actually use the estimated positions we generate here outside of verifying that the estimates are not violated. It's assumed that all conditional branches within a per-CC helper snippet are within range and the new binary encoder will fail with an assertion if that assumption doesn't hold and an out-of-range branch is encountered.", "author": "aviansie-ben", "createdAt": "2020-02-12T15:44:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzEzNDcxNA=="}], "type": "inlineReview"}]}