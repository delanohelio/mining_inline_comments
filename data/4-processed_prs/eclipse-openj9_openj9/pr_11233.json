{"pr_number": 11233, "pr_title": "Enable Value Type support for JITServer", "pr_createdAt": "2020-11-19T21:21:13Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/11233", "timeline": [{"oid": "9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206", "url": "https://github.com/eclipse-openj9/openj9/commit/9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206", "message": "Enable Value Type support for JITServer\n\nThis commit adapts queries required for value type support\ninside JIT for JITServer.\nMethods added:\n- `TR_ResolvedJ9JITServerMethod::isFieldQType`\n- `TR_ResolvedJ9JITServerMethod::isFieldFlattened`\nModified for JITServer:\n- `J9::ClassEnv::enumerateFields`\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-11-19T21:34:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg4ODUxOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11233#discussion_r529888518", "bodyText": "Maybe create a fieldOrStaticSignature that returns an UTF8here so that we avoid the conversion to char * and then back to UTF8", "author": "mpirvu", "createdAt": "2020-11-24T21:26:49Z", "path": "runtime/compiler/env/j9methodServer.cpp", "diffHunk": "@@ -2054,6 +2054,33 @@ TR_ResolvedJ9JITServerMethod::archetypeArgPlaceholderSlot()\n    return paramSlots;\n    }\n \n+bool\n+TR_ResolvedJ9JITServerMethod::isFieldQType(int32_t cpIndex)\n+   {\n+   if (!TR::Compiler->om.areValueTypesEnabled() ||\n+      (-1 == cpIndex))\n+      return false;\n+\n+   auto comp = _fe->_compInfoPT->getCompilation();\n+   int32_t sigLen;\n+   char *sig = fieldOrStaticSignatureChars(cpIndex, sigLen);", "originalCommit": "9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU1MjU3MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11233#discussion_r530552571", "bodyText": "Doing that would require also adding versions of getROMString and getRemoteROMString that return UTF8, since fieldOrStaticSignature uses them to get the signature.\nIf that's something worth doing maybe it's better to do it in a separate PR?", "author": "dmitry-ten", "createdAt": "2020-11-25T17:52:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg4ODUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3NTYzNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11233#discussion_r530575634", "bodyText": "I think it's worth doing, so let's open another PR for that", "author": "mpirvu", "createdAt": "2020-11-25T18:37:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg4ODUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0OTY1Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11233#discussion_r530049652", "bodyText": "In J9::ClassEnv::enumerateFields when we retrieve the data from the client there is an assumption that the strings are null terminated. I was under the impression that the string constructor does not copy the null terminating character. Maybe some implementations do that so that they can optimize the c_str() function, but I don't think it's guaranteed.", "author": "mpirvu", "createdAt": "2020-11-25T01:28:51Z", "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -2162,6 +2172,28 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          client->write(response, TR::Compiler->cls.isClassRefValueType(comp, clazz, cpIndex));\n          }\n          break;\n+      case MessageType::ClassEnv_enumerateFields:\n+         {\n+         auto recv = client->getRecvData<TR_OpaqueClassBlock *>();\n+         const TR::TypeLayout* layout = comp->typeLayout(std::get<0>(recv));\n+\n+         std::vector<TR::TypeLayoutEntry> entries;\n+         std::vector<std::string> fieldNames;\n+         std::vector<std::string> typeSignatures;\n+         entries.reserve(layout->count());\n+         fieldNames.reserve(layout->count());\n+         typeSignatures.reserve(layout->count());\n+         for (int32_t idx = 0; idx < layout->count(); ++idx)\n+            {\n+            const TR::TypeLayoutEntry &entry = layout->entry(idx);\n+            entries.push_back(entry);\n+            // both strings are null-terminated so we don't need to know length\n+            fieldNames.push_back(std::string(entry._fieldname));", "originalCommit": "9a8ac0a48c1f5a2a4bef8534885837d0ad6b3206", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA1NDg0MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11233#discussion_r530054841", "bodyText": "Apparently, starting with C++11 it is guaranteed to have a null terminator:\nThe returned array is null-terminated, that is, data() and c_str() perform the same function.", "author": "mpirvu", "createdAt": "2020-11-25T01:46:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0OTY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDUyMjQzMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11233#discussion_r530522433", "bodyText": "Yeah, I used c_str() under the assumption that the result would have a null-terminator", "author": "dmitry-ten", "createdAt": "2020-11-25T17:01:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA0OTY1Mg=="}], "type": "inlineReview"}, {"oid": "15aeddf156ab0adaeb26464830bfee51b1cc9fdf", "url": "https://github.com/eclipse-openj9/openj9/commit/15aeddf156ab0adaeb26464830bfee51b1cc9fdf", "message": "Enable Value Type support for JITServer\n\nThis commit adapts queries required for value type support\ninside JIT for JITServer.\nMethods added:\n- `TR_ResolvedJ9JITServerMethod::isFieldQType`\n- `TR_ResolvedJ9JITServerMethod::isFieldFlattened`\nModified for JITServer:\n- `J9::ClassEnv::enumerateFields`\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-11-25T16:41:15Z", "type": "forcePushed"}, {"oid": "3446382f354b89ebd2de3d1fedf0aab372b498e7", "url": "https://github.com/eclipse-openj9/openj9/commit/3446382f354b89ebd2de3d1fedf0aab372b498e7", "message": "Enable Value Type support for JITServer\n\nThis commit adapts queries required for value type support\ninside JIT for JITServer.\nMethods added:\n- `TR_ResolvedJ9JITServerMethod::isFieldQType`\n- `TR_ResolvedJ9JITServerMethod::isFieldFlattened`\nModified for JITServer:\n- `J9::ClassEnv::enumerateFields`\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-11-25T17:06:20Z", "type": "forcePushed"}, {"oid": "c7b362f8e8b5a5bad8f3296a0d06e15167cfd517", "url": "https://github.com/eclipse-openj9/openj9/commit/c7b362f8e8b5a5bad8f3296a0d06e15167cfd517", "message": "Enable Value Type support for JITServer\n\nThis commit adapts queries required for value type support\ninside JIT for JITServer.\nMethods added:\n- `TR_ResolvedJ9JITServerMethod::isFieldQType`\n- `TR_ResolvedJ9JITServerMethod::isFieldFlattened`\nModified for JITServer:\n- `J9::ClassEnv::enumerateFields`\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-11-25T17:39:40Z", "type": "commit"}, {"oid": "c7b362f8e8b5a5bad8f3296a0d06e15167cfd517", "url": "https://github.com/eclipse-openj9/openj9/commit/c7b362f8e8b5a5bad8f3296a0d06e15167cfd517", "message": "Enable Value Type support for JITServer\n\nThis commit adapts queries required for value type support\ninside JIT for JITServer.\nMethods added:\n- `TR_ResolvedJ9JITServerMethod::isFieldQType`\n- `TR_ResolvedJ9JITServerMethod::isFieldFlattened`\nModified for JITServer:\n- `J9::ClassEnv::enumerateFields`\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-11-25T17:39:40Z", "type": "forcePushed"}]}