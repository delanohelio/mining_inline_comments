{"pr_number": 9734, "pr_title": "Create query to determine the SCC mode", "pr_createdAt": "2020-05-28T18:29:50Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9734", "timeline": [{"oid": "9e0dd713c2923584e3252926cd66a9115c99a8b3", "url": "https://github.com/eclipse-openj9/openj9/commit/9e0dd713c2923584e3252926cd66a9115c99a8b3", "message": "Added query to determine is SCC is the default SCC, returns TRUE is SCC is the default and FALSE otherwise.\n\nSigned-off-by: Samantha Rempel <Samantha.Rempel@ibm.com>", "committedDate": "2020-05-28T18:57:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2NTI4OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r435465289", "bodyText": "Can you change \"isSCCDefault\" to \"isSharedClassEnabledByDefault\" ?", "author": "hangshao0", "createdAt": "2020-06-04T18:30:17Z", "path": "runtime/oti/j9nonbuilder.h", "diffHunk": "@@ -1227,6 +1227,7 @@ typedef struct J9SharedClassConfig {\n \tconst char* ctrlDirName;\n \tUDATA  ( *getCacheSizeBytes)(struct J9JavaVM* vm) ;\n \tUDATA  ( *getTotalUsableCacheBytes)(struct J9JavaVM* vm);\n+\tBOOLEAN  ( *isSCCDefault)(struct J9JavaVM* vm);", "originalCommit": "855734cc4ef892782e80bc5d668782fb79ead2b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2NTY2OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r435465669", "bodyText": "Also rename here to j9shr_isSharedClassEnabledByDefault.", "author": "hangshao0", "createdAt": "2020-06-04T18:30:56Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3516,6 +3516,7 @@ j9shr_init(J9JavaVM *vm, UDATA loadFlags, UDATA* nonfatal)\n \t\t}\n \n \t\tconfig->getCacheSizeBytes = j9shr_getCacheSizeBytes;\n+\t\tconfig->isSCCDefault = j9shr_isSCCDefault;", "originalCommit": "855734cc4ef892782e80bc5d668782fb79ead2b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2ODY2MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r435468661", "bodyText": "Better to say \"Check if the shared cache is enabled by default or using \"-Xshareclasses\" in the command line. \"", "author": "hangshao0", "createdAt": "2020-06-04T18:35:18Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3952,6 +3953,25 @@ j9shr_getCacheSizeBytes(J9JavaVM *vm)\n \treturn ret;\n }\n \n+/**\n+ * check if SCC is the default SSC (was enabled b/c of -Xshareclasses)", "originalCommit": "855734cc4ef892782e80bc5d668782fb79ead2b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2ODg5Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r435468892", "bodyText": "This comment is incorrect.", "author": "hangshao0", "createdAt": "2020-06-04T18:35:38Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3952,6 +3953,25 @@ j9shr_getCacheSizeBytes(J9JavaVM *vm)\n \treturn ret;\n }\n \n+/**\n+ * check if SCC is the default SSC (was enabled b/c of -Xshareclasses)\n+ *\n+ * @param [in] vm Pointer to the VM structure for the JVM\n+ *\n+ * @return The softmx bytes or the total usable cache size.", "originalCommit": "855734cc4ef892782e80bc5d668782fb79ead2b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2OTE0NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r435469145", "bodyText": "Please remove this comment.", "author": "hangshao0", "createdAt": "2020-06-04T18:35:56Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3952,6 +3953,25 @@ j9shr_getCacheSizeBytes(J9JavaVM *vm)\n \treturn ret;\n }\n \n+/**\n+ * check if SCC is the default SSC (was enabled b/c of -Xshareclasses)\n+ *\n+ * @param [in] vm Pointer to the VM structure for the JVM\n+ *\n+ * @return The softmx bytes or the total usable cache size.\n+ * \n+ * J9_ARE_ALL_BITS_SET(javaVM->sharedClassConfig->runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_CACHE_NON_BOOT_CLASSES)", "originalCommit": "855734cc4ef892782e80bc5d668782fb79ead2b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2OTcwMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r435469703", "bodyText": "Please and a comment saying \"Only bootstrap classes are shared by default.\"", "author": "hangshao0", "createdAt": "2020-06-04T18:36:42Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3952,6 +3953,25 @@ j9shr_getCacheSizeBytes(J9JavaVM *vm)\n \treturn ret;\n }\n \n+/**\n+ * check if SCC is the default SSC (was enabled b/c of -Xshareclasses)\n+ *\n+ * @param [in] vm Pointer to the VM structure for the JVM\n+ *\n+ * @return The softmx bytes or the total usable cache size.\n+ * \n+ * J9_ARE_ALL_BITS_SET(javaVM->sharedClassConfig->runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_CACHE_NON_BOOT_CLASSES)\n+ */\n+BOOLEAN\n+j9shr_isSCCDefault(J9JavaVM *vm)\n+{\n+\tBOOLEAN ret = FALSE;\n+\tif (J9_ARE_ALL_BITS_SET(vm->sharedClassConfig->runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_CACHE_NON_BOOT_CLASSES)){", "originalCommit": "855734cc4ef892782e80bc5d668782fb79ead2b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3ODkxNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r435478916", "bodyText": "We should return TRUE if J9SHR_RUNTIMEFLAG_ENABLE_CACHEBOOTCLASSES is set but J9SHR_RUNTIMEFLAG_ENABLE_CACHE_NON_BOOT_CLASSES is not set.", "author": "hangshao0", "createdAt": "2020-06-04T18:49:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2OTcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4Mjc3NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r435482774", "bodyText": "formatting: space before {", "author": "keithc-ca", "createdAt": "2020-06-04T18:56:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2OTcwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5ODMwNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r435498306", "bodyText": "Given the description and the implementation below, this name seems wrong: j9shr_isSharedClassEnabled would be more appropriate. The VM field name should be updated to match.", "author": "keithc-ca", "createdAt": "2020-06-04T19:26:29Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3952,6 +3953,26 @@ j9shr_getCacheSizeBytes(J9JavaVM *vm)\n \treturn ret;\n }\n \n+/**\n+ * Check if the shared cache is enabled by default or by using \"-Xshareclasses\" in the command line. \n+ * \n+ * @param [in] vm Pointer to the VM structure for the JVM\n+ *\n+ * @return TRUE if shared cache is enabled by default, FALSE otherwise\n+ * \n+ */\n+BOOLEAN\n+j9shr_isSharedClassEnabledByDefault(J9JavaVM *vm)", "originalCommit": "aa8410084b7d18731f7216ea2022caf9de6d04af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUwNDI1Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r435504253", "bodyText": "j9shr_isSharedClassEnabled looks confusing to me. When shared class is enabled, there are 2 cases:\n\nBy default: only bootstrap classes are shared.\nUsing -Xshareclasses in the command line: Both bootstrap classes and non-bootstrap classes are shared.\n\nI am fine with the current name or something like j9shr_isOnlyBootClassesSharingEnabled().", "author": "hangshao0", "createdAt": "2020-06-04T19:38:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5ODMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUyMjk0NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r435522944", "bodyText": "I like j9shr_isOnlyBootClassesSharingEnabled, but perhaps an explanation of how this is expected to be used will help us agree on the right name.", "author": "keithc-ca", "createdAt": "2020-06-04T20:14:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5ODMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4OTEyOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r435989129", "bodyText": "The query was created in response to this issue: \"It would be useful to have a query to determine whether the SCC being used is an SCC created via the -Xshareclasses option, or the default SCC. One use case would be making heuristic decisions based on this information (eg #6734).\" So I opted to have it return true if the SCC being used was the default and false in the -Xshareclasses case.", "author": "Samantha-Rempel", "createdAt": "2020-06-05T15:15:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5ODMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA2MzQwNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r436063404", "bodyText": "It's possible in the future that boot classes won't be the only sharing enabled by default. Ideally platform class loader classes would also be shared by default.", "author": "pshipton", "createdAt": "2020-06-05T17:32:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5ODMwNg=="}], "type": "inlineReview"}, {"oid": "58ebe8c721643a890c34a9af1342aa0b549eae06", "url": "https://github.com/eclipse-openj9/openj9/commit/58ebe8c721643a890c34a9af1342aa0b549eae06", "message": "Merge pull request #9765 from knn-k/aarch64recomp2\n\nAArch64: Implement Recomp.cpp", "committedDate": "2020-06-05T13:05:37Z", "type": "forcePushed"}, {"oid": "49505d71b34b973f3b2791d7a3ecc2dca188dd7e", "url": "https://github.com/eclipse-openj9/openj9/commit/49505d71b34b973f3b2791d7a3ecc2dca188dd7e", "message": "Add query to determine is Shared Classis the default SCC, returns TRUE is SCC is the default and FALSE otherwise.\n\nModified shrinit.h, shrinit,cpp and j9nonbuilder.h to add query that returns TRUE if Shared Class was enabled by default and FALSE if it was enabled via the command line.\n\nSigned-off-by: Samantha Rempel <Samantha.Rempel@ibm.com>", "committedDate": "2020-06-11T13:54:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNzA1NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r438827055", "bodyText": "don't use anonymous types\nthere's no need to explicitly assign values to the literals\nall these names live in the global namespace and need to be more specific\nthis should include a value indicating the SCC is disabled (by default)\n\nWe want something more like this:\ntypedef enum J9SharedClassCacheMode {\n    J9SharedClassCacheDisabled,\n    J9SharedClassCacheBootstrapOnly,\n    J9SharedClassCacheBoostrapAndExtension,\n    J9SharedClassCacheUserDefined\n} J9SharedClassCacheMode;", "author": "keithc-ca", "createdAt": "2020-06-11T14:26:42Z", "path": "runtime/oti/j9nonbuilder.h", "diffHunk": "@@ -262,6 +262,12 @@ typedef enum {\n \tJ9FlushCompQueueDataBreakpoint\n } J9JITFlushCompilationQueueReason;\n \n+typedef enum {\n+   BootstrapOnly               = 0,\n+   BoostrapAndExtension        = 1,\n+   UserDefined                 = 2\n+} SharedClassCacheMode;", "originalCommit": "49505d71b34b973f3b2791d7a3ecc2dca188dd7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NTA3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r438885079", "bodyText": "When reaching the new API j9shr_getSharedClassCacheMode, shared cache cannot be inactive. We don't need to add J9SharedClassCacheDisabled.  The \"UserDefined\" could be something like FullSharing or FullyEnabled.", "author": "hangshao0", "createdAt": "2020-06-11T15:43:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNzA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5NTU0OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r438895549", "bodyText": "Thanks for that information. My suggestion was based on the suggestion from @dsouzai which included the literal INACTIVE.", "author": "keithc-ca", "createdAt": "2020-06-11T15:55:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNzA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkzOTg1Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r438939856", "bodyText": "Okay I'll keep Disabled option out, what do we prefer for the UserDefiined option?", "author": "Samantha-Rempel", "createdAt": "2020-06-11T17:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNzA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk1ODM1NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r438958354", "bodyText": "It should be as I showed above, without J9SharedClassCacheDisabled.", "author": "keithc-ca", "createdAt": "2020-06-11T17:41:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNzA1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyODQxNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r438828415", "bodyText": "The field is getSharedClassCacheMode and the function is j9shr_getSharedClassCacheMode .", "author": "keithc-ca", "createdAt": "2020-06-11T14:28:35Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3516,6 +3516,7 @@ j9shr_init(J9JavaVM *vm, UDATA loadFlags, UDATA* nonfatal)\n \t\t}\n \n \t\tconfig->getCacheSizeBytes = j9shr_getCacheSizeBytes;\n+\t\tconfig->isSharedClassEnabledByDefault = j9shr_isSharedClassEnabledByDefault;", "originalCommit": "49505d71b34b973f3b2791d7a3ecc2dca188dd7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyODk4MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r438828980", "bodyText": "I expect you meant:\n  SharedClassCacheMode ret = UserDefined;", "author": "keithc-ca", "createdAt": "2020-06-11T14:29:21Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3952,6 +3953,30 @@ j9shr_getCacheSizeBytes(J9JavaVM *vm)\n \treturn ret;\n }\n \n+/**\n+ * Check if the shared cache is enabled by default or by using \"-Xshareclasses\" in the command line. \n+ * \n+ * @param [in] vm Pointer to the VM structure for the JVM\n+ *\n+ * @return TRUE if shared cache is enabled by default, FALSE otherwise\n+ * \n+ */\n+SharedClassCacheMode\n+j9shr_getSharedClassCacheMode(J9JavaVM *vm)\n+{\n+\tSharedClassCacheMode UserDefined;", "originalCommit": "49505d71b34b973f3b2791d7a3ecc2dca188dd7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "80965e5743219f4c18104dd88e47a4052cccedbd", "url": "https://github.com/eclipse-openj9/openj9/commit/80965e5743219f4c18104dd88e47a4052cccedbd", "message": "Add query to determine is Shared Classis the default SCC, returns TRUE is SCC is the default and FALSE otherwise.\n\nModified shrinit.h, shrinit,cpp and j9nonbuilder.h to add query that returns TRUE if Shared Class was enabled by default and FALSE if it was enabled via the command line.\n\nSigned-off-by: Samantha Rempel <Samantha.Rempel@ibm.com>", "committedDate": "2020-06-11T15:19:12Z", "type": "forcePushed"}, {"oid": "a92b8d107c19879de86da57536306061c3d85ca6", "url": "https://github.com/eclipse-openj9/openj9/commit/a92b8d107c19879de86da57536306061c3d85ca6", "message": "Add query to determine is Shared Classis the default SCC, returns TRUE is SCC is the default and FALSE otherwise.\n\nModified shrinit.h, shrinit,cpp and j9nonbuilder.h to add query that returns TRUE if Shared Class was enabled by default and FALSE if it was enabled via the command line.\n\nSigned-off-by: Samantha Rempel <Samantha.Rempel@ibm.com>", "committedDate": "2020-06-11T17:51:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NjEwNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r438976104", "bodyText": "Please indent with tabs like the rest of this file.", "author": "keithc-ca", "createdAt": "2020-06-11T18:05:01Z", "path": "runtime/oti/j9nonbuilder.h", "diffHunk": "@@ -262,6 +262,12 @@ typedef enum {\n \tJ9FlushCompQueueDataBreakpoint\n } J9JITFlushCompilationQueueReason;\n \n+typedef enum J9SharedClassCacheMode {\n+    J9SharedClassCacheBootstrapOnly,\n+    J9SharedClassCacheBoostrapAndExtension,\n+    J9SharedClassCacheUserDefined", "originalCommit": "a92b8d107c19879de86da57536306061c3d85ca6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3OTIyMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r438979221", "bodyText": "This needs only check J9SHR_RUNTIMEFLAG_ENABLE_CACHEBOOTCLASSES once:\n    if (J9_ARE_ALL_BITS_SET(vm->sharedClassConfig->runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_CACHEBOOTCLASSES)) {\n        if (J9_ARE_ALL_BITS_SET(vm->sharedClassConfig->runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_CACHE_NON_BOOT_CLASSES)) {\n            ret = J9SharedClassCacheUserDefined;\n        } else {\n            ret = J9SharedClassCacheBootstrapOnly;\n        }\n    }\n\nAlso notice } and else belong on the same line.", "author": "keithc-ca", "createdAt": "2020-06-11T18:10:48Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3952,6 +3953,30 @@ j9shr_getCacheSizeBytes(J9JavaVM *vm)\n \treturn ret;\n }\n \n+/**\n+ * Check if the shared cache is enabled by default or by using \"-Xshareclasses\" in the command line. \n+ * \n+ * @param [in] vm Pointer to the VM structure for the JVM\n+ *\n+ * @return TRUE if shared cache is enabled by default, FALSE otherwise\n+ * \n+ */\n+J9SharedClassCacheMode\n+j9shr_getSharedClassCacheMode(J9JavaVM *vm)\n+{\n+\tJ9SharedClassCacheMode ret = JJ9SharedClassCacheUserDefined;\n+\t/* Only bootstrap classes are shared by default */\n+\tif (J9_ARE_ALL_BITS_SET(vm->sharedClassConfig->runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_CACHEBOOTCLASSES) && \n+\t\tJ9_ARE_NO_BITS_SET(vm->sharedClassConfig->runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_CACHE_NON_BOOT_CLASSES)) {\n+\t\tret = J9SharedClassCacheBootstrapOnly;\n+\t}\n+\telse if (J9_ARE_ALL_BITS_SET(vm->sharedClassConfig->runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_CACHEBOOTCLASSES) && \n+\t\tJ9_ARE_ALL_BITS_SET(vm->sharedClassConfig->runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_CACHE_NON_BOOT_CLASSES)) {\n+\t\tret = J9SharedClassCacheUserDefined;\n+\t}", "originalCommit": "a92b8d107c19879de86da57536306061c3d85ca6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9dd3e2faefa104d4dc5171ea4c681a1c80a1b9a1", "url": "https://github.com/eclipse-openj9/openj9/commit/9dd3e2faefa104d4dc5171ea4c681a1c80a1b9a1", "message": "Add query to determine is Shared Classis the default SCC, returns TRUE is SCC is the default and FALSE otherwise.\n\nModified shrinit.h, shrinit,cpp and j9nonbuilder.h to add query that returns TRUE if Shared Class was enabled by default and FALSE if it was enabled via the command line.\n\nSigned-off-by: Samantha Rempel <Samantha.Rempel@ibm.com>", "committedDate": "2020-06-11T18:15:27Z", "type": "forcePushed"}, {"oid": "44e31c921fca5d042e02cd402be7dc2c3172a931", "url": "https://github.com/eclipse-openj9/openj9/commit/44e31c921fca5d042e02cd402be7dc2c3172a931", "message": "Add query to determine is Shared Classis the default SCC, returns TRUE is SCC is the default and FALSE otherwise.\n\nModified shrinit.h, shrinit,cpp and j9nonbuilder.h to add query that returns TRUE if Shared Class was enabled by default and FALSE if it was enabled via the command line.\n\nSigned-off-by: Samantha Rempel <Samantha.Rempel@ibm.com>", "committedDate": "2020-06-11T18:23:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAwNTA1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r439005059", "bodyText": "This comment needs to be updated.", "author": "hangshao0", "createdAt": "2020-06-11T18:59:51Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3952,6 +3953,29 @@ j9shr_getCacheSizeBytes(J9JavaVM *vm)\n \treturn ret;\n }\n \n+/**\n+ * Check if the shared cache is enabled by default or by using \"-Xshareclasses\" in the command line. ", "originalCommit": "44e31c921fca5d042e02cd402be7dc2c3172a931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAwNTEzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r439005135", "bodyText": "This comment also needs to be updated.", "author": "hangshao0", "createdAt": "2020-06-11T19:00:00Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3952,6 +3953,29 @@ j9shr_getCacheSizeBytes(J9JavaVM *vm)\n \treturn ret;\n }\n \n+/**\n+ * Check if the shared cache is enabled by default or by using \"-Xshareclasses\" in the command line. \n+ * \n+ * @param [in] vm Pointer to the VM structure for the JVM\n+ *\n+ * @return TRUE if shared cache is enabled by default, FALSE otherwise", "originalCommit": "44e31c921fca5d042e02cd402be7dc2c3172a931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAwNjkyNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r439006927", "bodyText": "We have\n#if defined(J9VM_OPT_SHARED_CLASSES)\nin this file.\nCan you move J9SharedClassCacheMode inside the #if defined(J9VM_OPT_SHARED_CLASSES)", "author": "hangshao0", "createdAt": "2020-06-11T19:03:27Z", "path": "runtime/oti/j9nonbuilder.h", "diffHunk": "@@ -262,6 +262,12 @@ typedef enum {\n \tJ9FlushCompQueueDataBreakpoint\n } J9JITFlushCompilationQueueReason;\n \n+typedef enum J9SharedClassCacheMode {", "originalCommit": "44e31c921fca5d042e02cd402be7dc2c3172a931", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e8bf2dcc2af869e4816233cab2a9d74274d7877c", "url": "https://github.com/eclipse-openj9/openj9/commit/e8bf2dcc2af869e4816233cab2a9d74274d7877c", "message": "Add query to determine is Shared Classis the default SCC, returns TRUE is SCC is the default and FALSE otherwise.\n\nModified shrinit.h, shrinit,cpp and j9nonbuilder.h to add query that returns TRUE if Shared Class was enabled by default and FALSE if it was enabled via the command line.\n\nSigned-off-by: Samantha Rempel <Samantha.Rempel@ibm.com>", "committedDate": "2020-06-12T12:44:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ1NTg3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r439455879", "bodyText": "I think spaces are being used here instead of tabs.", "author": "dsouzai", "createdAt": "2020-06-12T14:32:50Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3952,6 +3953,30 @@ j9shr_getCacheSizeBytes(J9JavaVM *vm)\n \treturn ret;\n }\n \n+/**\n+ * Determine the type of shared class cache that is enabled. Either the current default, \n+ * Bootstrap Classes Only, or user defined shared cache, enabled via \"-Xshareclasses\" on the command line. \n+ * \n+ * @param [in] vm Pointer to the VM structure for the JVM\n+ *\n+ * @return J9SharedClassCacheMode enum that idicates the Shared Cache Class that is in effect\n+ * \n+ */\n+J9SharedClassCacheMode\n+j9shr_getSharedClassCacheMode(J9JavaVM *vm)\n+{\n+\tJ9SharedClassCacheMode ret = J9SharedClassCacheUserDefined;\n+\t/* Only bootstrap classes are shared by default */\n+\tif (J9_ARE_ALL_BITS_SET(vm->sharedClassConfig->runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_CACHEBOOTCLASSES)) {\n+        if (J9_ARE_ALL_BITS_SET(vm->sharedClassConfig->runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_CACHE_NON_BOOT_CLASSES)) {\n+            ret = J9SharedClassCacheUserDefined;\n+        } else {\n+            ret = J9SharedClassCacheBootstrapOnly;\n+        }\n+    }", "originalCommit": "e8bf2dcc2af869e4816233cab2a9d74274d7877c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "05d9b0a5a988cc7f2b8dae05d5a06555f1e521a9", "url": "https://github.com/eclipse-openj9/openj9/commit/05d9b0a5a988cc7f2b8dae05d5a06555f1e521a9", "message": "Add query to determine is Shared Classis the default SCC, returns TRUE is SCC is the default and FALSE otherwise.\n\nModified shrinit.h, shrinit,cpp and j9nonbuilder.h to add query that returns TRUE if Shared Class was enabled by default and FALSE if it was enabled via the command line.\n\nSigned-off-by: Samantha Rempel <Samantha.Rempel@ibm.com>", "committedDate": "2020-06-12T15:04:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4MTM5OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r439481398", "bodyText": "\"Shared Cache Class\" should be \"Shared Class Cache\".", "author": "hangshao0", "createdAt": "2020-06-12T15:15:30Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3952,6 +3953,30 @@ j9shr_getCacheSizeBytes(J9JavaVM *vm)\n \treturn ret;\n }\n \n+/**\n+ * Determine the type of shared class cache that is enabled. Either the current default, \n+ * Bootstrap Classes Only, or user defined shared cache, enabled via \"-Xshareclasses\" on the command line. \n+ * \n+ * @param [in] vm Pointer to the VM structure for the JVM\n+ *\n+ * @return J9SharedClassCacheMode enum that idicates the Shared Cache Class that is in effect", "originalCommit": "05d9b0a5a988cc7f2b8dae05d5a06555f1e521a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4MzY4Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r439483683", "bodyText": "Don't forget to update your commit message. It still says\nAdd query to determine is Shared Class is the default SCC, returns TRUE is SCC is the default and FALSE otherwise", "author": "hangshao0", "createdAt": "2020-06-12T15:19:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4MTM5OA=="}], "type": "inlineReview"}, {"oid": "fd3c685c0858a296f1207e791af6e1d12742cecb", "url": "https://github.com/eclipse-openj9/openj9/commit/fd3c685c0858a296f1207e791af6e1d12742cecb", "message": "Add query to determine is Shared Classis the default SCC, returns TRUE is SCC is the default and FALSE otherwise.\n\nModified shrinit.h, shrinit,cpp and j9nonbuilder.h to add query that returns TRUE if Shared Class was enabled by default and FALSE if it was enabled via the command line.\n\nSigned-off-by: Samantha Rempel <Samantha.Rempel@ibm.com>", "committedDate": "2020-06-12T15:23:03Z", "type": "forcePushed"}, {"oid": "adeb297c0ac00ebcd37c380c42e0de198f9adc3b", "url": "https://github.com/eclipse-openj9/openj9/commit/adeb297c0ac00ebcd37c380c42e0de198f9adc3b", "message": "Add query that returns an enum indicating the Shared Class Cache that is in effect.\n\nModified shrinit.h, shrinit,cpp and j9nonbuilder.h to add query that returns enum J9SharedClassCacheBootstrapOnly for the default SCC and J9SharedClassCacheUserDefined if it was enabled via the command line.\n\nSigned-off-by: Samantha Rempel <Samantha.Rempel@ibm.com>", "committedDate": "2020-06-12T15:28:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxMDI2Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r440410263", "bodyText": "I believe, as your comment says, only bootstrap classes are shared by default, so shouldn't ret be initialized to J9SharedClassCacheBootstrapOnly? There are three possible values, yet this can't return J9SharedClassCacheBoostrapAndExtension; that doesn't seem right.\n@hangshao0 Please comment.", "author": "keithc-ca", "createdAt": "2020-06-15T19:52:57Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3952,6 +3953,30 @@ j9shr_getCacheSizeBytes(J9JavaVM *vm)\n \treturn ret;\n }\n \n+/**\n+ * Determine the type of shared class cache that is enabled. Either the current default, \n+ * Bootstrap Classes Only, or user defined shared cache, enabled via \"-Xshareclasses\" on the command line. \n+ * \n+ * @param [in] vm Pointer to the VM structure for the JVM\n+ *\n+ * @return J9SharedClassCacheMode enum that idicates the Shared Class Cache that is in effect\n+ * \n+ */\n+J9SharedClassCacheMode\n+j9shr_getSharedClassCacheMode(J9JavaVM *vm)\n+{\n+\tJ9SharedClassCacheMode ret = J9SharedClassCacheUserDefined;\n+\t/* Only bootstrap classes are shared by default */\n+\tif (J9_ARE_ALL_BITS_SET(vm->sharedClassConfig->runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_CACHEBOOTCLASSES)) {\n+\t\tif (J9_ARE_ALL_BITS_SET(vm->sharedClassConfig->runtimeFlags, J9SHR_RUNTIMEFLAG_ENABLE_CACHE_NON_BOOT_CLASSES)) {\n+\t\t\tret = J9SharedClassCacheUserDefined;\n+\t\t} else {\n+\t\t\tret = J9SharedClassCacheBootstrapOnly;\n+\t\t}\n+\t}", "originalCommit": "adeb297c0ac00ebcd37c380c42e0de198f9adc3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxODY1MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r440418651", "bodyText": "yet this can't return J9SharedClassCacheBoostrapAndExtension.\n\nJ9SharedClassCacheBoostrapAndExtension is a possible case in the future after we change the default class sharing from \"boostrap classes\" to \"bootstrap + extension classes\". It is an impossible case now. User cannot configure the JVM to share \"bootstrap + extension classes\" now.", "author": "hangshao0", "createdAt": "2020-06-15T20:09:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxMDI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyMDQ1Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r440420452", "bodyText": "I agree that it is better to initialize ret to J9SharedClassCacheBootstrapOnly.", "author": "hangshao0", "createdAt": "2020-06-15T20:13:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxMDI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1NTU4Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r441055587", "bodyText": "I have made that change, is this okay to resolve?", "author": "Samantha-Rempel", "createdAt": "2020-06-16T18:23:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxMDI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxMDYzMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r440410633", "bodyText": "typo: idicates -> indicates", "author": "keithc-ca", "createdAt": "2020-06-15T19:53:43Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3952,6 +3953,30 @@ j9shr_getCacheSizeBytes(J9JavaVM *vm)\n \treturn ret;\n }\n \n+/**\n+ * Determine the type of shared class cache that is enabled. Either the current default, \n+ * Bootstrap Classes Only, or user defined shared cache, enabled via \"-Xshareclasses\" on the command line. \n+ * \n+ * @param [in] vm Pointer to the VM structure for the JVM\n+ *\n+ * @return J9SharedClassCacheMode enum that idicates the Shared Class Cache that is in effect", "originalCommit": "adeb297c0ac00ebcd37c380c42e0de198f9adc3b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxOTc0NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r440419744", "bodyText": "\"Either the current default, Bootstrap Classes Only, or user defined shared cache\" should be something like:\n\"Either the current default (Bootstrap Classes Only), or user defined shared cache\"", "author": "hangshao0", "createdAt": "2020-06-15T20:12:01Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3952,6 +3953,30 @@ j9shr_getCacheSizeBytes(J9JavaVM *vm)\n \treturn ret;\n }\n \n+/**\n+ * Determine the type of shared class cache that is enabled. Either the current default, ", "originalCommit": "adeb297c0ac00ebcd37c380c42e0de198f9adc3b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "671a9d9a07451a010238e9bd10271ef78204cd80", "url": "https://github.com/eclipse-openj9/openj9/commit/671a9d9a07451a010238e9bd10271ef78204cd80", "message": "Add query that returns an enum indicating the Shared Class Cache that is in effect.\n\nModified shrinit.h, shrinit,cpp and j9nonbuilder.h to add query that returns enum J9SharedClassCacheBootstrapOnly for the default SCC and J9SharedClassCacheUserDefined if it was enabled via the command line.\n\nSigned-off-by: Samantha Rempel <Samantha.Rempel@ibm.com>", "committedDate": "2020-06-16T13:24:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0MjA2Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/9734#discussion_r441042066", "bodyText": "It's easier to see that all fields are initialized if they are set in the same order as they are declared. Please swap these two lines.", "author": "keithc-ca", "createdAt": "2020-06-16T18:03:37Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3516,6 +3516,7 @@ j9shr_init(J9JavaVM *vm, UDATA loadFlags, UDATA* nonfatal)\n \t\t}\n \n \t\tconfig->getCacheSizeBytes = j9shr_getCacheSizeBytes;\n+\t\tconfig->getSharedClassCacheMode = j9shr_getSharedClassCacheMode;\n \t\tconfig->getTotalUsableCacheBytes = j9shr_getTotalUsableCacheBytes;", "originalCommit": "671a9d9a07451a010238e9bd10271ef78204cd80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "363a8870fc0481e72d0efc1e6e3a82095c89d7fe", "url": "https://github.com/eclipse-openj9/openj9/commit/363a8870fc0481e72d0efc1e6e3a82095c89d7fe", "message": "Add query that returns an enum indicating the Shared Class Cache that is in effect.\n\nModified shrinit.h, shrinit,cpp and j9nonbuilder.h to add query that returns enum J9SharedClassCacheBootstrapOnly for the default SCC and J9SharedClassCacheUserDefined if it was enabled via the command line.\n\nSigned-off-by: Samantha Rempel <Samantha.Rempel@ibm.com>", "committedDate": "2020-06-16T18:19:40Z", "type": "commit"}, {"oid": "363a8870fc0481e72d0efc1e6e3a82095c89d7fe", "url": "https://github.com/eclipse-openj9/openj9/commit/363a8870fc0481e72d0efc1e6e3a82095c89d7fe", "message": "Add query that returns an enum indicating the Shared Class Cache that is in effect.\n\nModified shrinit.h, shrinit,cpp and j9nonbuilder.h to add query that returns enum J9SharedClassCacheBootstrapOnly for the default SCC and J9SharedClassCacheUserDefined if it was enabled via the command line.\n\nSigned-off-by: Samantha Rempel <Samantha.Rempel@ibm.com>", "committedDate": "2020-06-16T18:19:40Z", "type": "forcePushed"}]}