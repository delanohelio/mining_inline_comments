{"pr_number": 10714, "pr_title": "Add double map API to OSX", "pr_createdAt": "2020-09-26T19:36:04Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10714", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk3NjQxOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10714#discussion_r510976419", "bodyText": "spelling: preferred", "author": "amicic", "createdAt": "2020-10-23T15:46:01Z", "path": "runtime/gc_base/IndexableObjectAllocationModel.cpp", "diffHunk": "@@ -305,12 +305,12 @@ MM_IndexableObjectAllocationModel::layoutDiscontiguousArraylet(MM_EnvironmentBas\n }\n \n #if defined(J9VM_GC_ENABLE_DOUBLE_MAP)\n-#if !(defined(LINUX) && defined(J9VM_ENV_DATA64))\n+#if !((defined(LINUX) || defined(OSX)) && defined(J9VM_ENV_DATA64))\n /* Double map is only supported on LINUX 64 bit Systems for now */\n #error \"Platform not supported by Double Map API\"\n-#endif /* !(defined(LINUX) && defined(J9VM_ENV_DATA64)) */\n+#endif /* !((defined(LINUX) || defined(OSX)) && defined(J9VM_ENV_DATA64)) */\n void * \n-MM_IndexableObjectAllocationModel::doubleMapArraylets(MM_EnvironmentBase *env, J9Object *objectPtr) \n+MM_IndexableObjectAllocationModel::doubleMapArraylets(MM_EnvironmentBase *env, J9Object *objectPtr, void *preferedAddress)", "originalCommit": "b95e6075546b06f53d3dcf1b57b0c7b308cff383", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2a1e7508ad0c13c306717743d6a5bd0875fceef0", "url": "https://github.com/eclipse-openj9/openj9/commit/2a1e7508ad0c13c306717743d6a5bd0875fceef0", "message": "Fix spelling\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-10-28T23:32:57Z", "type": "forcePushed"}, {"oid": "1caf1aaf622cc771f79cd4da656c78acd14b6262", "url": "https://github.com/eclipse-openj9/openj9/commit/1caf1aaf622cc771f79cd4da656c78acd14b6262", "message": "Add double map API to OSX\n\nUpdate call to double map API\n\nDepends on: https://github.com/eclipse/omr/pull/5580\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-10-29T18:15:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE0NTIwNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10714#discussion_r515145205", "bodyText": "Minor rant.... This mapping is probably unnecessary, since at the call site we could create OMR PortLib instance and call OMR API directly .\nWe already have many instances in OpenJ9 code that we do such things (use directly OMR API of different sorts), but we also have already pre-existing OpenJ9-to-OMR mapping in this file.\nI don't know what's a preferred way with newly introduced APIs. I prefer simplicity (and avoid this mapping). @pshipton @DanHeidinga, opinion?", "author": "amicic", "createdAt": "2020-10-30T14:39:10Z", "path": "runtime/oti/j9port_generated.h", "diffHunk": "@@ -582,6 +582,7 @@ extern J9_CFUNC int32_t j9port_isCompatible(struct J9PortLibraryVersion *expecte\n #define j9vmem_commit_memory(param1,param2,param3) OMRPORT_FROM_J9PORT(privatePortLibrary)->vmem_commit_memory(OMRPORT_FROM_J9PORT(privatePortLibrary),param1,param2,param3)\n #define j9vmem_decommit_memory(param1,param2,param3) OMRPORT_FROM_J9PORT(privatePortLibrary)->vmem_decommit_memory(OMRPORT_FROM_J9PORT(privatePortLibrary),param1,param2,param3)\n #define j9vmem_free_memory(param1,param2,param3) OMRPORT_FROM_J9PORT(privatePortLibrary)->vmem_free_memory(OMRPORT_FROM_J9PORT(privatePortLibrary),param1,param2,param3)\n+#define j9vmem_release_double_mapped_region(param1,param2,param3) OMRPORT_FROM_J9PORT(privatePortLibrary)->vmem_release_double_mapped_region(OMRPORT_FROM_J9PORT(privatePortLibrary),param1,param2,param3)", "originalCommit": "1caf1aaf622cc771f79cd4da656c78acd14b6262", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE2NDY4Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10714#discussion_r515164683", "bodyText": "I prefer for new code to use omr directly rather than using a mapping. I believe the mappings were introduced just to avoid changing a lot of code. In the future we may want to remove them.", "author": "pshipton", "createdAt": "2020-10-30T15:03:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE0NTIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE4OTA5OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10714#discussion_r515189099", "bodyText": "I agree with Peter.  Let's avoid introducing new mappings and use OMR directly when it makes sense", "author": "DanHeidinga", "createdAt": "2020-10-30T15:36:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE0NTIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzODU1NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10714#discussion_r515238555", "bodyText": "Updated vmem_release_double_mapped_region calls to use OMR API.", "author": "bragaigor", "createdAt": "2020-10-30T16:53:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE0NTIwNQ=="}], "type": "inlineReview"}, {"oid": "c3254aea5f06804a186ad3f96b16d4b23529b242", "url": "https://github.com/eclipse-openj9/openj9/commit/c3254aea5f06804a186ad3f96b16d4b23529b242", "message": "Add double map API to OSX\n\nUpdate call to double map API\n\nDepends on: https://github.com/eclipse/omr/pull/5580\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-10-30T16:52:12Z", "type": "commit"}, {"oid": "c3254aea5f06804a186ad3f96b16d4b23529b242", "url": "https://github.com/eclipse-openj9/openj9/commit/c3254aea5f06804a186ad3f96b16d4b23529b242", "message": "Add double map API to OSX\n\nUpdate call to double map API\n\nDepends on: https://github.com/eclipse/omr/pull/5580\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-10-30T16:52:12Z", "type": "forcePushed"}]}