{"pr_number": 10474, "pr_title": "Get target JITServer's CPU before CG object is created", "pr_createdAt": "2020-08-27T16:34:42Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10474", "timeline": [{"oid": "dec5738e333a95a270d60eff324927707c6bcf10", "url": "https://github.com/eclipse-openj9/openj9/commit/dec5738e333a95a270d60eff324927707c6bcf10", "message": "Get target JITServer's CPU before CG object is created\n\nThis is needed so that the codegen is able to set the correct\nflags when initializing.\n\nSigned-off-by: Dhruv Chopra <Dhruv.C.Chopra@ibm.com>", "committedDate": "2020-08-27T16:36:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU1NTA5OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10474#discussion_r478555098", "bodyText": "if (((TR_J9VMBase *)fe)->isAOT_DEPRECATED_DO_NOT_USE() && TR::Compiler->target.cpu.isX86())\n      _target = TR::Compiler->relocatableTarget;\nI think this needs to be moved out as well (It looks like you already added code outside the constructor but didn't remove it from here)", "author": "harryyu1994", "createdAt": "2020-08-27T16:43:29Z", "path": "runtime/compiler/compile/J9Compilation.cpp", "diffHunk": "@@ -183,21 +185,9 @@ J9::Compilation::Compilation(int32_t id,\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    _osrProhibitedOverRangeOfTrees(false)\n    {\n-#if defined(J9VM_OPT_JITSERVER)\n-   // In JITServer, we would like to use JITClient's processor info for the compilation\n-   // The following code effectively replaces the cpu with client's cpu through the getProcessorDescription() that has JITServer support\n-   if (self()->getPersistentInfo()->getRemoteCompilationMode() == JITServer::SERVER)\n+   if (((TR_J9VMBase *)fe)->isAOT_DEPRECATED_DO_NOT_USE() && TR::Compiler->target.cpu.isX86())", "originalCommit": "dec5738e333a95a270d60eff324927707c6bcf10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU1OTk2MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10474#discussion_r478559960", "bodyText": "Sorry forgot about this! Fixed in e7c02f3.", "author": "dchopra001", "createdAt": "2020-08-27T16:51:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU1NTA5OA=="}], "type": "inlineReview"}, {"oid": "e7c02f3c6e8fc77822ef63d4a1f97866c019ec93", "url": "https://github.com/eclipse-openj9/openj9/commit/e7c02f3c6e8fc77822ef63d4a1f97866c019ec93", "message": "Get target JITServer's CPU before CG object is created\n\nThis is needed so that the codegen is able to set the correct\nflags when initializing.\n\nSigned-off-by: Dhruv Chopra <Dhruv.C.Chopra@ibm.com>", "committedDate": "2020-08-27T16:50:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU1Njg2OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10474#discussion_r478556868", "bodyText": "Here we are ignoring the parameter target and set our own. It may be nicer for the caller to set the parameter to TR::Compiler->relocatableTarget when we have AOT compilations under x86.", "author": "mpirvu", "createdAt": "2020-08-27T16:46:22Z", "path": "runtime/compiler/compile/J9Compilation.cpp", "diffHunk": "@@ -183,21 +185,9 @@ J9::Compilation::Compilation(int32_t id,\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    _osrProhibitedOverRangeOfTrees(false)\n    {\n-#if defined(J9VM_OPT_JITSERVER)\n-   // In JITServer, we would like to use JITClient's processor info for the compilation\n-   // The following code effectively replaces the cpu with client's cpu through the getProcessorDescription() that has JITServer support\n-   if (self()->getPersistentInfo()->getRemoteCompilationMode() == JITServer::SERVER)\n+   if (((TR_J9VMBase *)fe)->isAOT_DEPRECATED_DO_NOT_USE() && TR::Compiler->target.cpu.isX86())\n       {\n-      OMRProcessorDesc JITClientProcessorDesc = TR::Compiler->target.cpu.getProcessorDescription();\n-      _target.cpu = TR::CPU(JITClientProcessorDesc);\n-      }\n-   else\n-#endif /* defined(J9VM_OPT_JITSERVER) */\n-      {\n-      if (((TR_J9VMBase *)fe)->isAOT_DEPRECATED_DO_NOT_USE() && TR::Compiler->target.cpu.isX86())\n-         {\n-         _target = TR::Compiler->relocatableTarget;\n-         }\n+      _target = TR::Compiler->relocatableTarget;", "originalCommit": "dec5738e333a95a270d60eff324927707c6bcf10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU2MzE4OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10474#discussion_r478563188", "bodyText": "Why is the cast needed? Isn't target a TR::Environment variable?", "author": "mpirvu", "createdAt": "2020-08-27T16:57:11Z", "path": "runtime/compiler/control/CompilationThread.cpp", "diffHunk": "@@ -8513,7 +8531,8 @@ TR::CompilationInfoPerThreadBase::wrappedCompile(J9PortLibrary *portLib, void *\n                p->_dispatchRegion,\n                p->trMemory(),\n                p->_optimizationPlan,\n-               reloRuntime);\n+               reloRuntime,\n+               static_cast<TR::Environment *>(&target));", "originalCommit": "e7c02f3c6e8fc77822ef63d4a1f97866c019ec93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU2OTUxNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10474#discussion_r478569516", "bodyText": "This was needed to cast it to a pointer to a TR::Environment.", "author": "dchopra001", "createdAt": "2020-08-27T17:08:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU2MzE4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYyMzYzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10474#discussion_r478623635", "bodyText": "Isn't &target of type TR::Environment * though?", "author": "dsouzai", "createdAt": "2020-08-27T18:45:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU2MzE4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYzOTAzOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10474#discussion_r478639038", "bodyText": "Yeah, I can't recall why I added this initially now. But I've removed the case here: 2b4a2d7", "author": "dchopra001", "createdAt": "2020-08-27T19:14:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU2MzE4OA=="}], "type": "inlineReview"}, {"oid": "2b4a2d734a9c6c7ca2662af754b30ba44f21d257", "url": "https://github.com/eclipse-openj9/openj9/commit/2b4a2d734a9c6c7ca2662af754b30ba44f21d257", "message": "Get target JITServer's CPU before CG object is created\n\nThis is needed so that the codegen is able to set the correct\nflags when initializing.\n\nSigned-off-by: Dhruv Chopra <Dhruv.C.Chopra@ibm.com>", "committedDate": "2020-08-27T19:13:59Z", "type": "commit"}, {"oid": "2b4a2d734a9c6c7ca2662af754b30ba44f21d257", "url": "https://github.com/eclipse-openj9/openj9/commit/2b4a2d734a9c6c7ca2662af754b30ba44f21d257", "message": "Get target JITServer's CPU before CG object is created\n\nThis is needed so that the codegen is able to set the correct\nflags when initializing.\n\nSigned-off-by: Dhruv Chopra <Dhruv.C.Chopra@ibm.com>", "committedDate": "2020-08-27T19:13:59Z", "type": "forcePushed"}]}