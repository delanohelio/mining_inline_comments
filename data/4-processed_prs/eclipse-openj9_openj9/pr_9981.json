{"pr_number": 9981, "pr_title": "Update DDR code to comply with arrays not having NULL pointers", "pr_createdAt": "2020-06-23T13:35:13Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9981", "timeline": [{"oid": "2fa667fbbeb99416a7deb886cdbce597994cf769", "url": "https://github.com/eclipse-openj9/openj9/commit/2fa667fbbeb99416a7deb886cdbce597994cf769", "message": "Update DDR code to comply with arrays not having NULL pointers\n\nDiscontiguous arraylet do not have NULL arrayoids anymore;\ntheregore DDR was updated to reflect this change.\n\nRelated to: #9373\nFixes: #9971\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-06-23T13:40:40Z", "type": "forcePushed"}, {"oid": "6aa7a1c486beacf5930d557a824e5a823788edd3", "url": "https://github.com/eclipse-openj9/openj9/commit/6aa7a1c486beacf5930d557a824e5a823788edd3", "message": "Update DDR code to comply with arrays not having NULL pointers\n\nDiscontiguous arraylet do not have NULL arrayoids anymore;\ntheregore DDR was updated to reflect this change.\n\nRelated to: #9373\nFixes: #9971\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-06-23T13:43:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI1MTg4OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9981#discussion_r444251888", "bodyText": "Please remove the redundant parentheses:\n  numberOfArraylets = dataSizeInBytes.rightShift(arrayletLeafLogSize).add(dataSizeInBytes.bitAnd(arrayletLeafSizeMask).add(arrayletLeafSizeMask).rightShift(arrayletLeafLogSize));", "author": "keithc-ca", "createdAt": "2020-06-23T14:07:16Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/j9/gc/GCArrayletObjectModelBase_V2.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*******************************************************************************\n+ * Copyright (c) 2001, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+package com.ibm.j9ddr.vm29.j9.gc;\n+\n+import com.ibm.j9ddr.CorruptDataException;\n+import com.ibm.j9ddr.vm29.types.UDATA;\n+\n+public abstract class GCArrayletObjectModelBase_V2 extends GCArrayletObjectModelBase_V1\n+{\n+\tpublic GCArrayletObjectModelBase_V2() throws CorruptDataException \n+\t{\n+\t\tsuper();\n+\t}\n+\n+\t/**\n+\t * Return the total number of arraylets for an indexable object with a size of dataInSizeByte, including a (possibly empty) leaf in the spine.\n+\t * @param dataSizeInBytes size of an array in bytes (not elements)\n+\t * @return the number of arraylets used for an array of dataSizeInBytes bytes\n+\t */\n+\t@Override\n+\tprotected UDATA numArraylets(UDATA dataSizeInBytes) throws CorruptDataException\n+\t{\n+\t\tUDATA numberOfArraylets = new UDATA(1);\n+\t\tif (!UDATA.MAX.eq(arrayletLeafSize)) {\n+\t\t\t/* CMVC 135307 : following logic for calculating the leaf count would not overflow dataSizeInBytes.\n+\t\t\t * the assumption is leaf size is order of 2. It's identical to:\n+\t\t\t * if (dataSizeInBytes % leafSize) is 0\n+\t\t\t * \tleaf count = dataSizeInBytes >> leafLogSize\n+\t\t\t * else\n+\t\t\t * \tleaf count = (dataSizeInBytes >> leafLogSize) + 1\n+\t\t\t */\n+\t\t\tnumberOfArraylets = (dataSizeInBytes.rightShift(arrayletLeafLogSize)).add(((dataSizeInBytes.bitAnd(arrayletLeafSizeMask)).add(arrayletLeafSizeMask)).rightShift(arrayletLeafLogSize));", "originalCommit": "6aa7a1c486beacf5930d557a824e5a823788edd3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI1MzQzNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9981#discussion_r444253437", "bodyText": "Please remove this and similar methods below that only delegate to super.", "author": "keithc-ca", "createdAt": "2020-06-23T14:09:24Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/j9/gc/GCArrayletObjectModel_V2.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*******************************************************************************\n+ * Copyright (c) 1991, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+package com.ibm.j9ddr.vm29.j9.gc;\n+\n+import com.ibm.j9ddr.CorruptDataException;\n+import com.ibm.j9ddr.vm29.pointer.ObjectReferencePointer;\n+import com.ibm.j9ddr.vm29.pointer.VoidPointer;\n+import com.ibm.j9ddr.vm29.pointer.generated.J9ArrayClassPointer;\n+import com.ibm.j9ddr.vm29.pointer.generated.J9IndexableObjectPointer;\n+import com.ibm.j9ddr.vm29.types.UDATA;\n+\n+class GCArrayletObjectModel_V2 extends GCArrayletObjectModelBase_V2\n+{\n+\t\n+\tpublic GCArrayletObjectModel_V2() throws CorruptDataException \n+\t{\t\t\n+\t}\n+\t\n+\t@Override\n+\tprotected long getArrayLayout(J9IndexableObjectPointer array) throws CorruptDataException\n+\t{\n+\t\treturn super.getArrayLayout(array);\n+\t}", "originalCommit": "6aa7a1c486beacf5930d557a824e5a823788edd3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "002933b210f84d5eb50614685c5a716de964b21b", "url": "https://github.com/eclipse-openj9/openj9/commit/002933b210f84d5eb50614685c5a716de964b21b", "message": "Rename GCArrayletObjectModelBase_V1\n\nModify ALG_GC_ARRAYLET_OBJECT_MODEL_VERSION to 2\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-06-23T21:14:02Z", "type": "forcePushed"}, {"oid": "d6b54e0134766db00e69c997b61f59ee7ac32364", "url": "https://github.com/eclipse-openj9/openj9/commit/d6b54e0134766db00e69c997b61f59ee7ac32364", "message": "Update DDR code to comply with arrays not having NULL pointers\n\nDiscontiguous arraylet do not have NULL arrayoids anymore;\ntheregore DDR was updated to reflect this change.\n\nRelated to: #9373\nFixes: #9971\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-06-23T21:42:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUyNjYxOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9981#discussion_r444526619", "bodyText": "I thought the plan was that this would extend GCArrayletObjectModelBase?", "author": "keithc-ca", "createdAt": "2020-06-23T21:44:59Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/j9/gc/GCArrayletObjectModel_V2.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*******************************************************************************\n+ * Copyright (c) 1991, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+package com.ibm.j9ddr.vm29.j9.gc;\n+\n+import com.ibm.j9ddr.CorruptDataException;\n+import com.ibm.j9ddr.vm29.types.UDATA;\n+\n+class GCArrayletObjectModel_V2 extends GCArrayletObjectModel_V1", "originalCommit": "d6b54e0134766db00e69c997b61f59ee7ac32364", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUyOTg3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9981#discussion_r444529879", "bodyText": "If you prefer I can update it to extend from GCArrayletObjectModelBase. I thought we could reuse GCArrayletObjectModel_V1, then we wouldn't need to reimplement the method getTotalFootprintInBytesWithHeader. It's just one method so it probably wouldn't hurt to copy it?", "author": "bragaigor", "createdAt": "2020-06-23T21:52:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUyNjYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDkzNDc3Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9981#discussion_r444934777", "bodyText": "I think it's safer to keep the classes separate. The base class should only have implementation that's common to all versions; the two versioned classes should not be tied to each other (and GCArrayletObjectModel_V1 may never change again).", "author": "keithc-ca", "createdAt": "2020-06-24T14:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUyNjYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4NzgwOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9981#discussion_r444987809", "bodyText": "Updated", "author": "bragaigor", "createdAt": "2020-06-24T15:38:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUyNjYxOQ=="}], "type": "inlineReview"}, {"oid": "6548260f771d6caaaec4a6efd020f6c3f1f9ba5e", "url": "https://github.com/eclipse-openj9/openj9/commit/6548260f771d6caaaec4a6efd020f6c3f1f9ba5e", "message": "Update DDR code to comply with arrays not having NULL pointers\n\nDiscontiguous arraylet do not have NULL arrayoids anymore;\ntheregore DDR was updated to reflect this change.\n\nRelated to: #9373\nFixes: #9971\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-06-24T15:37:19Z", "type": "commit"}, {"oid": "6548260f771d6caaaec4a6efd020f6c3f1f9ba5e", "url": "https://github.com/eclipse-openj9/openj9/commit/6548260f771d6caaaec4a6efd020f6c3f1f9ba5e", "message": "Update DDR code to comply with arrays not having NULL pointers\n\nDiscontiguous arraylet do not have NULL arrayoids anymore;\ntheregore DDR was updated to reflect this change.\n\nRelated to: #9373\nFixes: #9971\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-06-24T15:37:19Z", "type": "forcePushed"}]}