{"pr_number": 11392, "pr_title": "Store client's VM phase in JITServer client session", "pr_createdAt": "2020-12-07T22:03:56Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/11392", "timeline": [{"oid": "65633e99e6b7ec67d8cd3f415b15ae55d6f639cc", "url": "https://github.com/eclipse-openj9/openj9/commit/65633e99e6b7ec67d8cd3f415b15ae55d6f639cc", "message": "Store client's VM phase in JITServer client session\n\nServer needs to know when client is in startup phase,\nso that it can insert JIT hints for compilations that\nare memory and cpu expensive. This commit stores\nwhether the client is in startup in the client session.\n\nSigned-off-by: dmitry-ten <candalistic@gmail.com>", "committedDate": "2020-12-07T22:29:44Z", "type": "forcePushed"}, {"oid": "8fd16a04785c697484096493327cd270b948c0e9", "url": "https://github.com/eclipse-openj9/openj9/commit/8fd16a04785c697484096493327cd270b948c0e9", "message": "Store client's VM phase in JITServer client session\n\nServer needs to know when client is in startup phase,\nso that it can insert JIT hints for compilations that\nare expensive, i.e. hot/scorching compilations or\nmemory/cpu intensive ones.\nThis commit stores whether this information in the client session.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-12-07T22:31:50Z", "type": "forcePushed"}, {"oid": "2cb1351945d7b5ea75eb45361fa5a737606d932f", "url": "https://github.com/eclipse-openj9/openj9/commit/2cb1351945d7b5ea75eb45361fa5a737606d932f", "message": "Store client's VM phase in JITServer client session\n\nServer needs to know when client is in startup phase,\nso that it can insert JIT hints for compilations that\nare expensive, i.e. hot/scorching compilations or\nmemory/cpu intensive ones.\nThis commit stores whether this information in the client session.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-12-07T22:33:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk4ODg1Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11392#discussion_r537988852", "bodyText": "Please remove !", "author": "mpirvu", "createdAt": "2020-12-08T02:39:32Z", "path": "runtime/compiler/env/J9VMEnv.cpp", "diffHunk": "@@ -508,3 +508,15 @@ J9::VMEnv::getInterpreterVTableOffset()\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    return sizeof(J9Class);\n    }\n+\n+bool\n+J9::VMEnv::isVMInStartupPhase(J9JITConfig *jitConfig)\n+   {\n+#if defined(J9VM_OPT_JITSERVER)\n+   if (auto stream = TR::CompilationInfo::getStream())\n+      {\n+      return TR::compInfoPT->getClientData()->isInStartupPhase();\n+      }\n+#endif /* defined(J9VM_OPT_JITSERVER) */\n+   return !jitConfig->javaVM->phase != J9VM_PHASE_NOT_STARTUP;", "originalCommit": "2cb1351945d7b5ea75eb45361fa5a737606d932f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk5MDA3NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11392#discussion_r537990075", "bodyText": "I don't think we need a monitor just to get/set a boolean. Such operations are atomic anyway.", "author": "mpirvu", "createdAt": "2020-12-08T02:42:50Z", "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -73,6 +74,7 @@ ClientSessionData::ClientSessionData(uint64_t clientUID, uint32_t seqNo) :\n    TR::SymbolValidationManager::populateSystemClassesNotWorthRemembering(this);\n \n    _wellKnownClassesMonitor = TR::Monitor::create(\"JIT-JITServerWellKnownClassesMonitor\");\n+   _startupPhaseMonitor = TR::Monitor::create(\"JIT-JITServerStartupPhaseMonitor\");", "originalCommit": "2cb1351945d7b5ea75eb45361fa5a737606d932f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODUwNzQ5Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/11392#discussion_r538507496", "bodyText": "Are they actually atomic?\nThis post says they are not atomic in C++.", "author": "dmitry-ten", "createdAt": "2020-12-08T15:36:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk5MDA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU4MjA0MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11392#discussion_r538582041", "bodyText": "I am not convinced about the arguments in that post:\n\nsizeof(bool) is implementation-defined and may conceivably be > 1, so it's possible that it could be non-atomic in some cases.\n\nIn theory it's possible to have a bool larger than a char, but in practice nobody does that\n\nYou need atomic to avoid race-conditions. A race-condition occurs if two threads access the same memory location, and at least one of them is a write operation. If your program contains race-conditions, the behavior is undefined\n\nThe threads will see either true or false, there is nothing in between. If you wanted to be entirely correct, then you'd have to check the flag and do everything it depends on it in a single critical section, which is impractical. In fact, if another thread updates the flag, I would like to see that update.\n\nWithout atomic there is no guarantee that you'll ever see the update in the other thread at all, or that you'll see updates to variables in the same order that you make them in a different thread.\n\nThis could happen if the value is cached in a register. The use is very far away from where the flag is written, so it's very unlikely that will happen. Even if it happens, start-up phase is just a heuristic, it should not have correctness implications.", "author": "mpirvu", "createdAt": "2020-12-08T16:41:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk5MDA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc1ODAyMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11392#discussion_r538758021", "bodyText": "I see, makes sense. Removed the monitor.", "author": "dmitry-ten", "createdAt": "2020-12-08T19:47:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk5MDA3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk5MDU0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/11392#discussion_r537990546", "bodyText": "This could be marked const", "author": "mpirvu", "createdAt": "2020-12-08T02:44:12Z", "path": "runtime/compiler/runtime/JITClientSession.hpp", "diffHunk": "@@ -454,6 +454,10 @@ class ClientSessionData\n    void cacheWellKnownClassChainOffsets(unsigned int includedClasses, size_t numClasses,\n                                         const uintptr_t *classChainOffsets, const void *wellKnownClassChainOffsets);\n \n+   TR::Monitor *getStartupPhaseMonitor() { return _startupPhaseMonitor; }\n+   bool isInStartupPhase();", "originalCommit": "2cb1351945d7b5ea75eb45361fa5a737606d932f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3492c0aba06cd5a1650d538f06a5b483bd50e8bf", "url": "https://github.com/eclipse-openj9/openj9/commit/3492c0aba06cd5a1650d538f06a5b483bd50e8bf", "message": "Store client's VM phase in JITServer client session\n\nServer needs to know when client is in startup phase,\nso that it can insert JIT hints for compilations that\nare expensive, i.e. hot/scorching compilations or\nmemory/cpu intensive ones.\nThis commit stores whether this information in the client session.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-12-08T16:11:11Z", "type": "forcePushed"}, {"oid": "189f550f400334b6487c627c208e1569ff9d944e", "url": "https://github.com/eclipse-openj9/openj9/commit/189f550f400334b6487c627c208e1569ff9d944e", "message": "Store client's VM phase in JITServer client session\n\nServer needs to know when client is in startup phase,\nso that it can insert JIT hints for compilations that\nare expensive, i.e. hot/scorching compilations or\nmemory/cpu intensive ones.\nThis commit stores whether this information in the client session.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-12-08T19:44:35Z", "type": "forcePushed"}, {"oid": "71a01792f3c757924a1dba0f5ae5b7a7e1e7e4b4", "url": "https://github.com/eclipse-openj9/openj9/commit/71a01792f3c757924a1dba0f5ae5b7a7e1e7e4b4", "message": "Store client's VM phase in JITServer client session\n\nServer needs to know when client is in startup phase,\nso that it can insert JIT hints for compilations that\nare expensive, i.e. hot/scorching compilations or\nmemory/cpu intensive ones.\nThis commit stores whether this information in the client session.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-12-08T19:47:47Z", "type": "commit"}, {"oid": "71a01792f3c757924a1dba0f5ae5b7a7e1e7e4b4", "url": "https://github.com/eclipse-openj9/openj9/commit/71a01792f3c757924a1dba0f5ae5b7a7e1e7e4b4", "message": "Store client's VM phase in JITServer client session\n\nServer needs to know when client is in startup phase,\nso that it can insert JIT hints for compilations that\nare expensive, i.e. hot/scorching compilations or\nmemory/cpu intensive ones.\nThis commit stores whether this information in the client session.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-12-08T19:47:47Z", "type": "forcePushed"}]}