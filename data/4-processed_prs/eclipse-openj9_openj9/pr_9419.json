{"pr_number": 9419, "pr_title": "Add the check of BCV_SPECIAL in generating stackmaps", "pr_createdAt": "2020-04-30T17:06:20Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9419", "timeline": [{"oid": "8158f8b7dc113385d9c651b153ad50605f588756", "url": "https://github.com/eclipse-openj9/openj9/commit/8158f8b7dc113385d9c651b153ad50605f588756", "message": "Add the check of BCV_SPECIAL in generating stackmaps\n\nThe change is to add the check of BCV_SPECIAL when merging & matching\nstacks to ensure the uninitializedThis flag is correctly set up during\nthe generation of stackmaps so as to match the RI's behavior at runtime\nverification.\n\nFixes: #9385\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-05-05T20:23:51Z", "type": "forcePushed"}, {"oid": "fcafa7c52500ef6b814cf3efb983abb904bfdaac", "url": "https://github.com/eclipse-openj9/openj9/commit/fcafa7c52500ef6b814cf3efb983abb904bfdaac", "message": "Add the check of BCV_SPECIAL in generating stackmaps\n\nThe change is to add the check of BCV_SPECIAL when merging & matching\nstacks to ensure the uninitializedThis flag is correctly set up during\nthe generation of stackmaps so as to match the RI's behavior at runtime\nverification.\n\nFixes: #9385\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-05-05T20:25:54Z", "type": "forcePushed"}, {"oid": "153fc4307434dcedcf5be68aaea6e8300f3215bd", "url": "https://github.com/eclipse-openj9/openj9/commit/153fc4307434dcedcf5be68aaea6e8300f3215bd", "message": "Add the check of BCV_SPECIAL in generating stackmaps\n\nThe change is to add the check of BCV_SPECIAL when merging & matching\nstacks to ensure the uninitializedThis flag is correctly set up during\nthe generation of stackmaps so as to match the RI's behavior at runtime\nverification.\n\nFixes: #9385\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-05-06T06:37:03Z", "type": "forcePushed"}, {"oid": "cbfc48bd57c6d66cf8716dcfed169e2ea11010a5", "url": "https://github.com/eclipse-openj9/openj9/commit/cbfc48bd57c6d66cf8716dcfed169e2ea11010a5", "message": "Add the check of BCV_SPECIAL in generating stackmaps\n\nThe change is to add the check of BCV_SPECIAL when merging & matching\nstacks to ensure the uninitializedThis flag is correctly set up during\nthe generation of stackmaps so as to match the RI's behavior at runtime\nverification.\n\nFixes: #9385\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-05-07T23:05:28Z", "type": "forcePushed"}, {"oid": "d65321bd6d8cb47fd2beee82a1397adf3cc0804f", "url": "https://github.com/eclipse-openj9/openj9/commit/d65321bd6d8cb47fd2beee82a1397adf3cc0804f", "message": "Add the check of BCV_SPECIAL in generating stackmaps\n\nThe change is to add the check of BCV_SPECIAL when merging & matching\nstacks to ensure the uninitializedThis flag is correctly set up during\nthe generation of stackmaps so as to match the RI's behavior at runtime\nverification.\n\nFixes: #9385\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-05-07T23:17:31Z", "type": "forcePushed"}, {"oid": "657b969f7841e5c0ff4ac6bdfb6bfbd6f87406d0", "url": "https://github.com/eclipse-openj9/openj9/commit/657b969f7841e5c0ff4ac6bdfb6bfbd6f87406d0", "message": "Add the check of BCV_SPECIAL in generating stackmaps\n\nThe change is to add the check of BCV_SPECIAL when merging & matching\nstacks to ensure the uninitializedThis flag is correctly set up during\nthe generation of stackmaps so as to match the RI's behavior at runtime\nverification.[ci skip]\n\nFixes: #9385\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-05-07T23:24:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNTMwNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9419#discussion_r442435307", "bodyText": "Isn't the local targetItem already initialized to be *targetStackPtr?  Can the local be used here?\nAlso, please use explicit boolean conditions\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t\tif ((*targetStackPtr != (UDATA) (BCV_BASE_TYPE_TOP))\n          \n          \n            \n            \t\t\t\t\t\t&& !(*targetStackPtr & BCV_SPECIAL)\n          \n          \n            \n            \t\t\t\t\t\tif ((targetItem != (UDATA) (BCV_BASE_TYPE_TOP))\n          \n          \n            \n            \t\t\t\t\t\t&& ((targetItem & BCV_SPECIAL) == 0)", "author": "DanHeidinga", "createdAt": "2020-06-18T18:54:04Z", "path": "runtime/bcverify/bcverify.c", "diffHunk": "@@ -954,8 +954,14 @@ mergeStacks (J9BytecodeVerificationData * verifyData, UDATA target)\n \t\t\t\t\t/* Merge when either the source or target not an object */\n \t\t\t\t\tif ((sourceItem | targetItem) & (BCV_BASE_OR_SPECIAL)) {\n \n-\t\t\t\t\t\t/* Mismatch results in undefined local - rewalk if modified stack */\n-\t\t\t\t\t\tif (*targetStackPtr != (UDATA) (BCV_BASE_TYPE_TOP)) {\n+\t\t\t\t\t\t/* Mismatch results in undefined local - rewalk if modified stack\n+\t\t\t\t\t\t * Note: BCV_SPECIAL (specifically BCV_SPECIAL_INIT) must be reserved to flag the uninitialized_this object\n+\t\t\t\t\t\t * existing in the stackmap frame when invoking setInitializedThisStatus()\n+\t\t\t\t\t\t * after the stackmaps is successfully built.\n+\t\t\t\t\t\t */\n+\t\t\t\t\t\tif ((*targetStackPtr != (UDATA) (BCV_BASE_TYPE_TOP))\n+\t\t\t\t\t\t&& !(*targetStackPtr & BCV_SPECIAL)", "originalCommit": "657b969f7841e5c0ff4ac6bdfb6bfbd6f87406d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNjA5MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9419#discussion_r442436090", "bodyText": "Is this really checking for (targetItem & BCV_SPECIAL_INIT) != 0 to avoid changing to BCV_BASE_TYPE_TOP in that case?", "author": "DanHeidinga", "createdAt": "2020-06-18T18:55:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNTMwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUwMzYxMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9419#discussion_r442503612", "bodyText": "Isn't the local targetItem already initialized to be *targetStackPtr? Can the local be used here? Also, please use explicit boolean conditions\n\nYes, we should use targetItem instead of *targetStackPtr in this case. Updated as suggested.", "author": "ChengJin01", "createdAt": "2020-06-18T21:08:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNTMwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUxMzgzNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9419#discussion_r442513837", "bodyText": "Is this really checking for (targetItem & BCV_SPECIAL_INIT) != 0 to avoid changing to BCV_BASE_TYPE_TOP in that case?\n\nYes, it was based on the thorough debugging with the class files in question.  It is obvious that the intention of the original implementation was to reserve the BCV_SPECIAL bits so as to set up uninitializedThis  in setInitializedThisStatus but somehow the bits were wipe out here accidentally to deal with other situations. The  BCV_SPECIAL bits can't be restored back or reset up later in simulateStack once they are removed here. That's why we need to handle the case on both mergeStack()  and  matchStack() to ensure the BCV_SPECIAL bits from the generated stackmaps are correctly addressed.", "author": "ChengJin01", "createdAt": "2020-06-18T21:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNTMwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNjY0MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9419#discussion_r442436641", "bodyText": "Tracepoints aren't changed.  If necessary, the current one is obsoleted and a new one is introduced at the end of the file so the index & format never change", "author": "DanHeidinga", "createdAt": "2020-06-18T18:56:20Z", "path": "runtime/bcverify/j9bcverify.tdf", "diffHunk": "@@ -114,7 +114,7 @@ TraceExit=Trc_RTV_findAndMatchStack_Exit Overhead=1 Level=3 Template=\"findAndMat\n TraceEntry=Trc_RTV_matchStack_Entry Overhead=1 Level=3 Template=\"matchStack - inlineMatch is %i\"\n TraceException=Trc_RTV_matchStack_DepthMismatchException Overhead=1 Level=1 Template=\"matchStack - %.*s %.*s%.*s mismatched stack depths, live = %i, target = %i\"\n TraceException=Trc_RTV_matchStack_IncompatibleClassException Overhead=1 Level=1 Template=\"matchStack - %.*s %.*s%.*s incompatible objects at offset %i, live = 0x%X, target = 0x%X\"\n-TraceException=Trc_RTV_matchStack_PrimitiveMismatchException Overhead=1 Level=1 Template=\"matchStack - %.*s %.*s%.*s incompatible primitives at offset %i, live = 0x%X, target = 0x%X\"\n+TraceException=Trc_RTV_matchStack_PrimitiveOrSpecialMismatchException Overhead=1 Level=1 Template=\"matchStack - %.*s %.*s%.*s incompatible primitives or special at offset %i, live = 0x%X, target = 0x%X\"", "originalCommit": "657b969f7841e5c0ff4ac6bdfb6bfbd6f87406d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUwMjQxMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9419#discussion_r442502410", "bodyText": "Agree and moved the new tracepoint to the end of the file.", "author": "ChengJin01", "createdAt": "2020-06-18T21:06:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNjY0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ3NTQ1NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9419#discussion_r442475455", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t/* Only skip the check on the target slot with BCV_SPECIAL for the generated stackmaps\n          \n          \n            \n            \t\t\t * as this slot is set up based on the bytecode itself rather than decompressed stackmaps.\n          \n          \n            \n            \t\t\t */\n          \n          \n            \n            \t\t\t} else if ((*targetPtr != BCV_BASE_TYPE_TOP) && !((*targetPtr & BCV_SPECIAL) && verifyData->createdStackMap)) {\n          \n          \n            \n            \t\t\t\tTrc_RTV_matchStack_PrimitiveOrSpecialMismatchException(verifyData->vmStruct,\n          \n          \n            \n            \t\t\t} else if (*targetPtr != BCV_BASE_TYPE_TOP) {\n          \n          \n            \n            \t\t\t\tif (((*targetPtr & BCV_SPECIAL) != 0) && verifyData->createdStackMap) {\n          \n          \n            \n            \t\t\t\t\t/* Generated stackmaps can skip the check on the target slot with BCV_SPECIAL\n          \n          \n            \n            \t\t\t \t\t* as this slot is set up based on the bytecode itself rather than decompressed stackmaps.\n          \n          \n            \n            \t\t\t\t\t*/\n          \n          \n            \n            \t\t\t\t} else {\n          \n          \n            \n            \t\t\t\t\tTrc_RTV_matchStack_PrimitiveOrSpecialMismatchException(verifyData->vmStruct,\n          \n          \n            \n            \t\t\t\t\t.....\n          \n          \n            \n            \t\t\t\t\trc = BCV_FAIL; /* fail - primitive or special mismatch */\n          \n          \n            \n            \t\t\t\t\tgoto _incompatibleType;\n          \n          \n            \n            \t\t\t\t}\n          \n          \n            \n            \t\t\t}\n          \n      \n    \n    \n  \n\nReorganizing this may be clearer about when the check is being skipped vs not.", "author": "DanHeidinga", "createdAt": "2020-06-18T20:09:52Z", "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -353,8 +345,11 @@ matchStack(J9BytecodeVerificationData * verifyData, J9BranchTargetStack *liveSta\n \t\t\t\t\t\tgoto _incompatibleType;\n \t\t\t\t\t}\n \t\t\t\t}\n-\t\t\t} else if (*targetPtr != BCV_BASE_TYPE_TOP) {\n-\t\t\t\tTrc_RTV_matchStack_PrimitiveMismatchException(verifyData->vmStruct,\n+\t\t\t/* Only skip the check on the target slot with BCV_SPECIAL for the generated stackmaps\n+\t\t\t * as this slot is set up based on the bytecode itself rather than decompressed stackmaps.\n+\t\t\t */\n+\t\t\t} else if ((*targetPtr != BCV_BASE_TYPE_TOP) && !((*targetPtr & BCV_SPECIAL) && verifyData->createdStackMap)) {\n+\t\t\t\tTrc_RTV_matchStack_PrimitiveOrSpecialMismatchException(verifyData->vmStruct,", "originalCommit": "657b969f7841e5c0ff4ac6bdfb6bfbd6f87406d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUwMTg4Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9419#discussion_r442501882", "bodyText": "Agree and updated against the suggestion above.", "author": "ChengJin01", "createdAt": "2020-06-18T21:04:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ3NTQ1NQ=="}], "type": "inlineReview"}, {"oid": "f2335ae497132851dade07176169b9b6aa3c863a", "url": "https://github.com/eclipse-openj9/openj9/commit/f2335ae497132851dade07176169b9b6aa3c863a", "message": "Add the check of BCV_SPECIAL in generating stackmaps\n\nThe change is to add the check of BCV_SPECIAL when merging & matching\nstacks to ensure the uninitializedThis flag is correctly set up during\nthe generation of stackmaps so as to match the RI's behavior at runtime\nverification.[ci skip]\n\nFixes: #9385\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-18T21:02:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU5MTE1Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9419#discussion_r442591153", "bodyText": "The old tracepoint has to stay here", "author": "DanHeidinga", "createdAt": "2020-06-19T01:59:11Z", "path": "runtime/bcverify/j9bcverify.tdf", "diffHunk": "@@ -114,7 +114,6 @@ TraceExit=Trc_RTV_findAndMatchStack_Exit Overhead=1 Level=3 Template=\"findAndMat\n TraceEntry=Trc_RTV_matchStack_Entry Overhead=1 Level=3 Template=\"matchStack - inlineMatch is %i\"\n TraceException=Trc_RTV_matchStack_DepthMismatchException Overhead=1 Level=1 Template=\"matchStack - %.*s %.*s%.*s mismatched stack depths, live = %i, target = %i\"\n TraceException=Trc_RTV_matchStack_IncompatibleClassException Overhead=1 Level=1 Template=\"matchStack - %.*s %.*s%.*s incompatible objects at offset %i, live = 0x%X, target = 0x%X\"\n-TraceException=Trc_RTV_matchStack_PrimitiveMismatchException Overhead=1 Level=1 Template=\"matchStack - %.*s %.*s%.*s incompatible primitives at offset %i, live = 0x%X, target = 0x%X\"", "originalCommit": "f2335ae497132851dade07176169b9b6aa3c863a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYwNDQwOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9419#discussion_r442604408", "bodyText": "Fixed.", "author": "ChengJin01", "createdAt": "2020-06-19T02:55:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU5MTE1Mw=="}], "type": "inlineReview"}, {"oid": "a811a1ad41f3cd469711f5807ebaa54197bd7ae2", "url": "https://github.com/eclipse-openj9/openj9/commit/a811a1ad41f3cd469711f5807ebaa54197bd7ae2", "message": "Add the check of BCV_SPECIAL in generating stackmaps\n\nThe change is to add the check of BCV_SPECIAL when merging & matching\nstacks to ensure the uninitializedThis flag is correctly set up during\nthe generation of stackmaps so as to match the RI's behavior at runtime\nverification.[ci skip]\n\nFixes: #9385\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-19T02:54:18Z", "type": "commit"}, {"oid": "a811a1ad41f3cd469711f5807ebaa54197bd7ae2", "url": "https://github.com/eclipse-openj9/openj9/commit/a811a1ad41f3cd469711f5807ebaa54197bd7ae2", "message": "Add the check of BCV_SPECIAL in generating stackmaps\n\nThe change is to add the check of BCV_SPECIAL when merging & matching\nstacks to ensure the uninitializedThis flag is correctly set up during\nthe generation of stackmaps so as to match the RI's behavior at runtime\nverification.[ci skip]\n\nFixes: #9385\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-19T02:54:18Z", "type": "forcePushed"}]}