{"pr_number": 8755, "pr_title": "Find module with romClass name rather than loadData->className", "pr_createdAt": "2020-03-05T03:47:18Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8755", "timeline": [{"oid": "f44aae7d42f8a605530c21bc529474e05ddb0b5f", "url": "https://github.com/eclipse-openj9/openj9/commit/f44aae7d42f8a605530c21bc529474e05ddb0b5f", "message": "Check buildRomClass() result before trying to find module\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-03-05T03:48:29Z", "type": "forcePushed"}, {"oid": "528a64877b04de797577ce17d13d940706a446ad", "url": "https://github.com/eclipse-openj9/openj9/commit/528a64877b04de797577ce17d13d940706a446ad", "message": "Check buildRomClass() result before trying to find module\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-03-05T04:34:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA5OTI3OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8755#discussion_r388099278", "bodyText": "Can you modify this to check result once around the outside of this if and the next?\nSomething like:\nif (BCT_ERR_NO_ERROR == result) {\n    if ((J2SE_VERSION(vm) >= J2SE_V11)...... {\n    .....\n    if (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags, J9_EXTENDED_RUNTIME_RECREATE_CLASSFILE_ONLOAD)) {\n    }   \n}\nas the J9_EXTENDED_RUNTIME_RECREATE_CLASSFILE_ONLOAD immediately checks for BCT_ERR_NO_ERROR as well", "author": "DanHeidinga", "createdAt": "2020-03-05T06:28:00Z", "path": "runtime/bcutil/defineclass.c", "diffHunk": "@@ -764,6 +764,7 @@ callDynamicLoader(J9VMThread *vmThread, J9LoadROMClassData *loadData, U_8 * inte\n \t/* The module of a class transformed by a JVMTI agent needs access to unnamed modules */", "originalCommit": "528a64877b04de797577ce17d13d940706a446ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQxNDY0OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8755#discussion_r388414648", "bodyText": "@DanHeidinga Updated. I expect the (NULL != loadData->romClass) is redundant and can be removed as well, what do you think?\nI was trying to get a JVM created for the user to try. There may be more than one problem, we'll see what happens on a re-run with this change. The machines were busy with nightly testing and I missed the user's timezone window last night.", "author": "pshipton", "createdAt": "2020-03-05T16:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA5OTI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyNjczNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8755#discussion_r388426737", "bodyText": "I think you're right.  I wonder if we added the null check to satisfy one of the static analysis tools we've run", "author": "DanHeidinga", "createdAt": "2020-03-05T16:54:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA5OTI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUyOTMxMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8755#discussion_r388529310", "bodyText": "I figured we needed the null check in the absence of checking the result code.", "author": "pshipton", "createdAt": "2020-03-05T19:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA5OTI3OA=="}], "type": "inlineReview"}, {"oid": "af25d54e8ac10f32c628f017ad1f0a44ff7c2569", "url": "https://github.com/eclipse-openj9/openj9/commit/af25d54e8ac10f32c628f017ad1f0a44ff7c2569", "message": "Check buildRomClass() result before trying to find module\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-03-05T16:32:34Z", "type": "forcePushed"}, {"oid": "d3039239d826916d58e2c471f89c3ebdb8db400e", "url": "https://github.com/eclipse-openj9/openj9/commit/d3039239d826916d58e2c471f89c3ebdb8db400e", "message": "Check buildRomClass() result before trying to find module\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-03-05T19:56:30Z", "type": "forcePushed"}, {"oid": "7643ad750f4b7fb2ff9b4eaa06d70bb9e78c4737", "url": "https://github.com/eclipse-openj9/openj9/commit/7643ad750f4b7fb2ff9b4eaa06d70bb9e78c4737", "message": "Check buildRomClass() result before trying to find module\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-03-06T03:01:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY5Mjg2NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8755#discussion_r388692864", "bodyText": "Minor nitpick - this line of the if statement is indented to far.  It should be a single tab (or preferably in my view none!).\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t&& (classFileBytesReplacedByRIA || classFileBytesReplacedByRCA)\n          \n          \n            \n            \t\t&& (classFileBytesReplacedByRIA || classFileBytesReplacedByRCA)", "author": "DanHeidinga", "createdAt": "2020-03-06T03:10:32Z", "path": "runtime/bcutil/defineclass.c", "diffHunk": "@@ -761,20 +761,19 @@ callDynamicLoader(J9VMThread *vmThread, J9LoadROMClassData *loadData, U_8 * inte\n \t\t\tFALSE, /* isIntermediateROMClass */\n \t\t\tlocalBuffer);\n \n-\t/* The module of a class transformed by a JVMTI agent needs access to unnamed modules */\n-\tif ((J2SE_VERSION(vm) >= J2SE_V11)\n-\t\t&& (classFileBytesReplacedByRIA || classFileBytesReplacedByRCA)\n-\t\t&& (NULL != loadData->romClass)\n-\t) {\n-\t\tJ9Module *module = J9_VM_FUNCTION(vmThread, findModuleForPackage)(vmThread, loadData->classLoader,\n-\t\t\t\tloadData->className, (U_32) packageNameLength(loadData->romClass));\n-\t\tif (NULL != module) {\n-\t\t\tmodule->isLoose = TRUE;\n+\tif (BCT_ERR_NO_ERROR == result) {\n+\t\t/* The module of a class transformed by a JVMTI agent needs access to unnamed modules */\n+\t\tif ((J2SE_VERSION(vm) >= J2SE_V11)\n+\t\t\t\t&& (classFileBytesReplacedByRIA || classFileBytesReplacedByRCA)", "originalCommit": "7643ad750f4b7fb2ff9b4eaa06d70bb9e78c4737", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExNjg1Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8755#discussion_r389116857", "bodyText": "Seems Eclipses likes to indent by 2 tabs. I've removed one.", "author": "pshipton", "createdAt": "2020-03-06T20:02:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY5Mjg2NA=="}], "type": "inlineReview"}, {"oid": "2d2351aa13b66ea012eb28b195e6910b4371f860", "url": "https://github.com/eclipse-openj9/openj9/commit/2d2351aa13b66ea012eb28b195e6910b4371f860", "message": "Find module with romClass name rather than loadData->className\n\nThe loadData->className may be null. Also check the \nbuildRomClass() result before trying to find the module.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-03-06T20:01:32Z", "type": "forcePushed"}, {"oid": "e81c2c009a4299d220edf2e95e55ff68fc3c0c8b", "url": "https://github.com/eclipse-openj9/openj9/commit/e81c2c009a4299d220edf2e95e55ff68fc3c0c8b", "message": "Find module with romClass name rather than loadData->className\n\nThe loadData->className may be null. Also check the \nbuildRomClass() result before trying to find the module.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-03-06T20:24:53Z", "type": "commit"}, {"oid": "e81c2c009a4299d220edf2e95e55ff68fc3c0c8b", "url": "https://github.com/eclipse-openj9/openj9/commit/e81c2c009a4299d220edf2e95e55ff68fc3c0c8b", "message": "Find module with romClass name rather than loadData->className\n\nThe loadData->className may be null. Also check the \nbuildRomClass() result before trying to find the module.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-03-06T20:24:53Z", "type": "forcePushed"}]}