{"pr_number": 9189, "pr_title": "Disable runtime assumption table on JITServer", "pr_createdAt": "2020-04-08T21:08:37Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9189", "timeline": [{"oid": "fe2f9b282a1de2d3bd230d18e41d9fcd0900137a", "url": "https://github.com/eclipse-openj9/openj9/commit/fe2f9b282a1de2d3bd230d18e41d9fcd0900137a", "message": "Disable runtime assumption table on JITServer\n\nJITServer should not create any runtime assumptions, instead it\nshould buffer them and send them to the client. In order to catch\nall mistakes, it's better to disable RuntimeAssumptionTable on JITServer\nso any misuses will be caught by crashes.\n\nIssue: #8029\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-04-08T21:29:27Z", "type": "forcePushed"}, {"oid": "9d0508a3b1439496c5a73e2a3fd7b7993b970edd", "url": "https://github.com/eclipse-openj9/openj9/commit/9d0508a3b1439496c5a73e2a3fd7b7993b970edd", "message": "Disable runtime assumption table on JITServer\n\nJITServer should not create any runtime assumptions, instead it\nshould buffer them and send them to the client. In order to catch\nall mistakes, it's better to disable RuntimeAssumptionTable on JITServer\nso any misuses will be caught by crashes.\n\nIssue: #8029\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-04-08T21:33:23Z", "type": "forcePushed"}, {"oid": "e89e865520e4d4b2bcab40f762b166aca5c8a5a9", "url": "https://github.com/eclipse-openj9/openj9/commit/e89e865520e4d4b2bcab40f762b166aca5c8a5a9", "message": "Disable runtime assumption table on JITServer\n\nJITServer should not create any runtime assumptions, instead it\nshould buffer them and send them to the client. In order to catch\nall mistakes, it's better to disable RuntimeAssumptionTable on JITServer\nso any misuses will be caught by crashes.\n\nIssue: #8029\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-04-08T21:59:55Z", "type": "forcePushed"}, {"oid": "7d96f99431c5035cfac107b7ff9aecf3350adf17", "url": "https://github.com/eclipse-openj9/openj9/commit/7d96f99431c5035cfac107b7ff9aecf3350adf17", "message": "Disable runtime assumption table on JITServer\n\nJITServer should not create any runtime assumptions, instead it\nshould buffer them and send them to the client. In order to catch\nall mistakes, it's better to disable RuntimeAssumptionTable on JITServer\nso any misuses will be caught by crashes.\n\nIssue: #8029\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-04-08T22:17:13Z", "type": "forcePushed"}, {"oid": "67e71ba0f55d24e6efae710fae7ecbdd376f1428", "url": "https://github.com/eclipse-openj9/openj9/commit/67e71ba0f55d24e6efae710fae7ecbdd376f1428", "message": "Disable runtime assumption table on JITServer\n\nJITServer should not create any runtime assumptions, instead it\nshould buffer them and send them to the client. In order to catch\nall mistakes, it's better to disable RuntimeAssumptionTable on JITServer\nso any misuses will be caught by crashes.\n\nIssue: #8029\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-04-08T22:23:53Z", "type": "forcePushed"}, {"oid": "6ba79f78b4f270b41810882976c9807c306ca999", "url": "https://github.com/eclipse-openj9/openj9/commit/6ba79f78b4f270b41810882976c9807c306ca999", "message": "Disable runtime assumption table on JITServer\n\nJITServer should not create any runtime assumptions, instead it\nshould buffer them and send them to the client. In order to catch\nall mistakes, it's better to disable RuntimeAssumptionTable on JITServer\nso any misuses will be caught by crashes.\n\nIssue: #8029\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-04-08T22:48:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE3Njc3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9189#discussion_r406176772", "bodyText": "If we take this path at the server something is wrong.\nThus, i would rather place an ASSERT_FATAL here.", "author": "mpirvu", "createdAt": "2020-04-09T12:43:58Z", "path": "runtime/compiler/control/HookedByTheJit.cpp", "diffHunk": "@@ -3146,8 +3146,13 @@ void jitIllegalFinalFieldModification(J9VMThread *currentThread, J9Class *fieldC\n    reportHook(currentThread, \"jitIllegalFinalFieldModification\", \"class %p %.*s\", fieldClass, length, className);\n \n    TR::CompilationInfo * compInfo = TR::CompilationInfo::get(jitConfig);\n+\n    TR_RuntimeAssumptionTable * rat = compInfo->getPersistentInfo()->getRuntimeAssumptionTable();\n-   if (rat)\n+   if (rat\n+#if defined(J9VM_OPT_JITSERVER)", "originalCommit": "6ba79f78b4f270b41810882976c9807c306ca999", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyODg4NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9189#discussion_r407528884", "bodyText": "We do take this path at the server. Investigating what's wrong here.", "author": "harryyu1994", "createdAt": "2020-04-13T15:10:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE3Njc3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE3NzY3MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9189#discussion_r406177670", "bodyText": "Why is this code removed. The idea is that, we don't want to update the CHTable at the server because it is not used for compilation anyway.", "author": "mpirvu", "createdAt": "2020-04-09T12:45:38Z", "path": "runtime/compiler/control/HookedByTheJit.cpp", "diffHunk": "@@ -3550,9 +3555,6 @@ static bool updateCHTable(J9VMThread * vmThread, J9Class  * cl)\n    TR_PersistentCHTable * table = 0;\n    if (TR::Options::getCmdLineOptions()->allowRecompilation()\n       && !TR::Options::getCmdLineOptions()->getOption(TR_DisableCHOpts)\n-#if defined(J9VM_OPT_JITSERVER)\n-      && compInfo->getPersistentInfo()->getRemoteCompilationMode() != JITServer::SERVER", "originalCommit": "6ba79f78b4f270b41810882976c9807c306ca999", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUzMjEzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9189#discussion_r407532130", "bodyText": "I think persistentMemory->getPersistentInfo()->getRuntimeAssumptionTable()->init() is the only place where we call updateCHTable() at the server. Since that's disabled, updateCHTable() is no longer called at the server thus doesn't need a guard.", "author": "harryyu1994", "createdAt": "2020-04-13T15:16:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE3NzY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY4ODk0OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9189#discussion_r407688949", "bodyText": "To be sure let's add an ASSERT_FATAL", "author": "mpirvu", "createdAt": "2020-04-13T20:05:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE3NzY3MA=="}], "type": "inlineReview"}, {"oid": "6276941c3ff42a22b68f64e8216d810819ef227c", "url": "https://github.com/eclipse-openj9/openj9/commit/6276941c3ff42a22b68f64e8216d810819ef227c", "message": "Disable runtime assumption table on JITServer\n\nJITServer should not create any runtime assumptions, instead it\nshould buffer them and send them to the client. In order to catch\nall mistakes, it's better to disable RuntimeAssumptionTable on JITServer\nso any misuses will be caught by crashes.\n\nIssue: #8029\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-04-13T18:43:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY4ODExMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9189#discussion_r407688110", "bodyText": "compInfo is not defined at this point", "author": "mpirvu", "createdAt": "2020-04-13T20:03:23Z", "path": "runtime/compiler/control/HookedByTheJit.cpp", "diffHunk": "@@ -3136,6 +3136,15 @@ void jitMethodBreakpointed(J9VMThread * vmThread, J9Method *j9method)\n  */\n void jitIllegalFinalFieldModification(J9VMThread *currentThread, J9Class *fieldClass)\n    {\n+#if defined(J9VM_OPT_JITSERVER)", "originalCommit": "6276941c3ff42a22b68f64e8216d810819ef227c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgwNTUzNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9189#discussion_r407805537", "bodyText": "We should have got the jitConfig like below:\nJ9JITConfig * jitConfig = currentThread->javaVM->jitConfig;\nMaybe it compiles because there is a global somewhere.", "author": "mpirvu", "createdAt": "2020-04-14T01:04:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY4ODExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg3NzMxOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9189#discussion_r407877318", "bodyText": "Good eye! I can't believe that compiled.", "author": "harryyu1994", "createdAt": "2020-04-14T05:34:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY4ODExMA=="}], "type": "inlineReview"}, {"oid": "ed07d6dacf76c41fd343c2a6619bb9c742bff70c", "url": "https://github.com/eclipse-openj9/openj9/commit/ed07d6dacf76c41fd343c2a6619bb9c742bff70c", "message": "Disable runtime assumption table on JITServer\n\nJITServer should not create any runtime assumptions, instead it\nshould buffer them and send them to the client. In order to catch\nall mistakes, it's better to disable RuntimeAssumptionTable on JITServer\nso any misuses will be caught by crashes.\n\nIssue: #8029\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-04-13T20:15:15Z", "type": "forcePushed"}, {"oid": "74a30fb8d6e6ff8d47ba21cb2d2b65f1ec36ec81", "url": "https://github.com/eclipse-openj9/openj9/commit/74a30fb8d6e6ff8d47ba21cb2d2b65f1ec36ec81", "message": "Disable runtime assumption table on JITServer\n\nJITServer should not create any runtime assumptions, instead it\nshould buffer them and send them to the client. In order to catch\nall mistakes, it's better to disable RuntimeAssumptionTable on JITServer\nso any misuses will be caught by crashes.\n\nIssue: #8029\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-04-13T21:32:53Z", "type": "forcePushed"}, {"oid": "1f08ddfa7d3daa9b0786ddc569bdf0333b0edc0f", "url": "https://github.com/eclipse-openj9/openj9/commit/1f08ddfa7d3daa9b0786ddc569bdf0333b0edc0f", "message": "Disable runtime assumption table on JITServer\n\nJITServer should not create any runtime assumptions, instead it\nshould buffer them and send them to the client. In order to catch\nall mistakes, it's better to disable RuntimeAssumptionTable on JITServer\nso any misuses will be caught by crashes.\n\nIssue: #8029\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-04-14T05:34:37Z", "type": "commit"}, {"oid": "1f08ddfa7d3daa9b0786ddc569bdf0333b0edc0f", "url": "https://github.com/eclipse-openj9/openj9/commit/1f08ddfa7d3daa9b0786ddc569bdf0333b0edc0f", "message": "Disable runtime assumption table on JITServer\n\nJITServer should not create any runtime assumptions, instead it\nshould buffer them and send them to the client. In order to catch\nall mistakes, it's better to disable RuntimeAssumptionTable on JITServer\nso any misuses will be caught by crashes.\n\nIssue: #8029\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-04-14T05:34:37Z", "type": "forcePushed"}]}