{"pr_number": 9564, "pr_title": "Convert long to float on Windows-32 bit", "pr_createdAt": "2020-05-14T17:44:54Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9564", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0MDI1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425340259", "bodyText": "One declaration at a time, each with an initializer.", "author": "keithc-ca", "createdAt": "2020-05-14T18:17:21Z", "path": "runtime/util/fltconv.c", "diffHunk": "@@ -386,8 +387,75 @@ helperCConvertLongToFloat(I_64 src)\n {\n \tjfloat tmpDst;\n \n+/* Every platform but 32-bit Windows can use the cast.\n+ * Using VS2017 15.9 the cast doesn't give the expected result.\n+ */\n+#if !defined(WIN32) || defined(WIN64)\n \ttmpDst = (jfloat)src;\n-\n+#else /* !defined(WIN32) || defined(WIN64) */\n+\t{\n+\t\tint idl1, sign;\n+\t\tU_64 spfInt, overflow;", "originalCommit": "8a65d2d0e577107ea4ec28f256d511cd824ccffd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQzMDQ1OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425430458", "bodyText": "Fixed them all and a few other things as well.", "author": "pshipton", "createdAt": "2020-05-14T21:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0MDI1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0NDY5NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425344694", "bodyText": "This test must be >= else it yields the wrong answer for u64val = (1 << 32).", "author": "keithc-ca", "createdAt": "2020-05-14T18:25:25Z", "path": "runtime/util/fltconv.c", "diffHunk": "@@ -440,4 +508,21 @@ fltconv_indexLeadingOne32(U_32 u32val)\n }\n \n \n+static int \n+fltconv_indexLeadingOne64(U_64 u64val)\n+{\n+\tint leading;\n+\t\n+\tif (0 == u64val) {\n+\t\treturn -1;\n+\t}\n+\n+\tleading = fltconv_indexLeadingOne32((U_32)(u64val >> 32));\n+\tif (leading > 0) {", "originalCommit": "8a65d2d0e577107ea4ec28f256d511cd824ccffd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQzMDI1NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425430254", "bodyText": "Thanks for catching this one.", "author": "pshipton", "createdAt": "2020-05-14T21:05:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0NDY5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1NzQ5Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425357496", "bodyText": "I suggest (((U_64)1) << 63) is a better way to say 0x8000000000000000 and the first two conditions can be tested in a single operation with <:\n    if ((((U_64)1) << 63) < overflow) {\n        spfInt + = 1;\n    } else if ((((U_64)1) << 63) == overflow) {\n        if (0 != (spfInt & 1)) {\n            spfInt + = 1;\n        }\n    }", "author": "keithc-ca", "createdAt": "2020-05-14T18:47:58Z", "path": "runtime/util/fltconv.c", "diffHunk": "@@ -386,8 +387,75 @@ helperCConvertLongToFloat(I_64 src)\n {\n \tjfloat tmpDst;\n \n+/* Every platform but 32-bit Windows can use the cast.\n+ * Using VS2017 15.9 the cast doesn't give the expected result.\n+ */\n+#if !defined(WIN32) || defined(WIN64)\n \ttmpDst = (jfloat)src;\n-\n+#else /* !defined(WIN32) || defined(WIN64) */\n+\t{\n+\t\tint idl1, sign;\n+\t\tU_64 spfInt, overflow;\n+\t\n+\t\tif (0 == src) {\n+\t\t\treturn 0.0f;\n+\t\t}\n+\t\n+\t\tif (src < 0) {\n+\t\t\tspfInt = (U_64)0 - (U_64)src;\n+\t\t\tsign = 1;\n+\t\t} else {\n+\t\t\tspfInt = (U_64)src;\n+\t\t\tsign = 0;\n+\t\t}\n+\t\t\n+\t\t/* Find out where the most significant bit is in the integer value.\n+\t\t * We are only interested in keeping 24 of those bits. \n+\t\t */\n+\t\tidl1 = fltconv_indexLeadingOne64(spfInt);\n+\t\tif (idl1 >= 24) {\n+\t\t\t\n+\t\t\t/* If it's more than 24 bits, we shift right and keep track of\n+\t\t\t * the overflow for some possible rounding. \n+\t\t\t */\n+\t\t\toverflow = spfInt << (64 - (idl1 - 23));\n+\t\t\tspfInt >>= (idl1 - 23);\n+\t\t\tspfInt &= 0x007FFFFF;\n+\t\t\tspfInt |= ((idl1+SPEXPONENT_BIAS) << 23);\n+\t\t\tif (0 != (overflow & 0x8000000000000000)) {\n+\t\t\t\tif (0 != (overflow & 0x7FFFFFFFFFF00000)) {\n+\t\t\t\t\tspfInt++;\n+\t\t\t\t} else {\n+\t\t\t\t\tif (0 != (spfInt & 1)) {\n+\t\t\t\t\t\tspfInt++;\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}", "originalCommit": "8a65d2d0e577107ea4ec28f256d511cd824ccffd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQyOTc5MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425429791", "bodyText": "The suggested code isn't equivalent. I've updated to use the shift but otherwise left is as-is.", "author": "pshipton", "createdAt": "2020-05-14T21:05:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1NzQ5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQzNDQ2Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425434467", "bodyText": "I believe it is equivalent (considering the range of values that overflow might take).", "author": "keithc-ca", "createdAt": "2020-05-14T21:14:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1NzQ5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ0MjQ4Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425442487", "bodyText": "ok I see. Updated.", "author": "pshipton", "createdAt": "2020-05-14T21:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1NzQ5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM4MjkwMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425382900", "bodyText": "I'm not sure WIN64 is reliable: this should use defined(J9VM_ENV_DATA64) instead.", "author": "keithc-ca", "createdAt": "2020-05-14T19:35:37Z", "path": "runtime/util/fltconv.c", "diffHunk": "@@ -386,8 +387,75 @@ helperCConvertLongToFloat(I_64 src)\n {\n \tjfloat tmpDst;\n \n+/* Every platform but 32-bit Windows can use the cast.\n+ * Using VS2017 15.9 the cast doesn't give the expected result.\n+ */\n+#if !defined(WIN32) || defined(WIN64)", "originalCommit": "8a65d2d0e577107ea4ec28f256d511cd824ccffd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQzMDU1Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425430557", "bodyText": "Updated.", "author": "pshipton", "createdAt": "2020-05-14T21:06:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM4MjkwMA=="}], "type": "inlineReview"}, {"oid": "49d6037e21def901c72f3b53d99da949c9204249", "url": "https://github.com/eclipse-openj9/openj9/commit/49d6037e21def901c72f3b53d99da949c9204249", "message": "Convert long to float on Windows-32 bit\n\nWork around a problem with float cast in VS2017 15.9\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-05-14T21:00:09Z", "type": "forcePushed"}, {"oid": "2c92b5fec6f3cd69ca306e62c72a5673e133223b", "url": "https://github.com/eclipse-openj9/openj9/commit/2c92b5fec6f3cd69ca306e62c72a5673e133223b", "message": "Convert long to float on Windows-32 bit\n\nWork around a problem with float cast in VS2017 15.9\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-05-14T21:05:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQzMzEwNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425433107", "bodyText": "This is dead code: the function is only called if u64val != 0 (and the code below handles that case anyway).", "author": "keithc-ca", "createdAt": "2020-05-14T21:11:22Z", "path": "runtime/util/fltconv.c", "diffHunk": "@@ -440,4 +509,21 @@ fltconv_indexLeadingOne32(U_32 u32val)\n }\n \n \n+static int \n+fltconv_indexLeadingOne64(U_64 u64val)\n+{\n+\tint leading = 0;\n+\t\n+\tif (0 == u64val) {\n+\t\treturn -1;\n+\t}", "originalCommit": "2c92b5fec6f3cd69ca306e62c72a5673e133223b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ0MzU0OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425443548", "bodyText": "Removed.", "author": "pshipton", "createdAt": "2020-05-14T21:32:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQzMzEwNw=="}], "type": "inlineReview"}, {"oid": "9bf217a123964ca18b356d483dac99b164fd4258", "url": "https://github.com/eclipse-openj9/openj9/commit/9bf217a123964ca18b356d483dac99b164fd4258", "message": "Convert long to float on Windows-32 bit\n\nWork around a problem with float cast in VS2017 15.9\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-05-14T21:30:01Z", "type": "forcePushed"}, {"oid": "ecd78b343a4d06e92d0cab0503aa8fb12eaa3824", "url": "https://github.com/eclipse-openj9/openj9/commit/ecd78b343a4d06e92d0cab0503aa8fb12eaa3824", "message": "Convert long to float on Windows-32 bit\n\nWork around a problem with float cast in VS2017 15.9\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-05-14T21:32:29Z", "type": "forcePushed"}, {"oid": "ce7ca27ab3817e82d6d9553dd1b68f622edc5699", "url": "https://github.com/eclipse-openj9/openj9/commit/ce7ca27ab3817e82d6d9553dd1b68f622edc5699", "message": "Convert long to float on Windows-32 bit\n\nWork around a problem with float cast in VS2017 15.9\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-05-14T21:34:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ0NzMyMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425447323", "bodyText": "The comment here and on the #endif no longer match the #if.", "author": "keithc-ca", "createdAt": "2020-05-14T21:41:31Z", "path": "runtime/util/fltconv.c", "diffHunk": "@@ -386,8 +387,72 @@ helperCConvertLongToFloat(I_64 src)\n {\n \tjfloat tmpDst;\n \n+/* Every platform but 32-bit Windows can use the cast.\n+ * Using VS2017 15.9 the cast doesn't give the expected result.\n+ */\n+#if !defined(WIN32) || defined(J9VM_ENV_DATA64)\n \ttmpDst = (jfloat)src;\n-\n+#else /* !defined(WIN32) || defined(WIN64) */", "originalCommit": "ce7ca27ab3817e82d6d9553dd1b68f622edc5699", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ0ODQ1OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425448458", "bodyText": "Updated.", "author": "pshipton", "createdAt": "2020-05-14T21:44:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ0NzMyMw=="}], "type": "inlineReview"}, {"oid": "5928d9fde9a1c090b24acb3caa88fa7844e4045b", "url": "https://github.com/eclipse-openj9/openj9/commit/5928d9fde9a1c090b24acb3caa88fa7844e4045b", "message": "Convert long to float on Windows-32 bit\n\nWork around a problem with float cast in VS2017 15.9\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-05-14T21:43:38Z", "type": "commit"}, {"oid": "5928d9fde9a1c090b24acb3caa88fa7844e4045b", "url": "https://github.com/eclipse-openj9/openj9/commit/5928d9fde9a1c090b24acb3caa88fa7844e4045b", "message": "Convert long to float on Windows-32 bit\n\nWork around a problem with float cast in VS2017 15.9\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-05-14T21:43:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ1MDUyNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425450526", "bodyText": "Shouldn't this say 19.16 (I don't know where 15.9 came from)?", "author": "keithc-ca", "createdAt": "2020-05-14T21:48:48Z", "path": "runtime/util/fltconv.c", "diffHunk": "@@ -386,8 +387,72 @@ helperCConvertLongToFloat(I_64 src)\n {\n \tjfloat tmpDst;\n \n+/* Every platform but 32-bit Windows can use the cast.\n+ * Using VS2017 15.9 the cast doesn't give the expected result.", "originalCommit": "5928d9fde9a1c090b24acb3caa88fa7844e4045b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ1MzI1Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425453256", "bodyText": "15.9 is the version of VS2017 we install to get the C compiler 19.16\nhttps://docs.microsoft.com/en-us/visualstudio/releasenotes/vs2017-relnotes", "author": "pshipton", "createdAt": "2020-05-14T21:55:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ1MDUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ2MjE3Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9564#discussion_r425462177", "bodyText": "Ok, got it. Thanks.", "author": "keithc-ca", "createdAt": "2020-05-14T22:17:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ1MDUyNg=="}], "type": "inlineReview"}]}