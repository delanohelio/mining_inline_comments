{"pr_number": 10682, "pr_title": "Store classes not worth remembering per client for JITServer", "pr_createdAt": "2020-09-23T20:09:43Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10682", "timeline": [{"oid": "5ba40b360853c65c6138ce065f1c14108fed5284", "url": "https://github.com/eclipse-openj9/openj9/commit/5ba40b360853c65c6138ce065f1c14108fed5284", "message": "Store classes not worth remembering per client for JITServer\n\nPR #10644 added a static array of classes not worth remembering\nto Symbol Validation Manager. JITServer, however, requires this array\nto be stored on a per client bases, since pointers to J9 classes\nare different between clients.\nAlso, ensure that `getSystemClassFromClassName` always calls\nthe base version on the client, even in AOT compilation,\nas all validation is done on the server.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-23T20:20:56Z", "type": "forcePushed"}, {"oid": "c9aacec131afd3958e9565e07e6466b743b6aa81", "url": "https://github.com/eclipse-openj9/openj9/commit/c9aacec131afd3958e9565e07e6466b743b6aa81", "message": "Store classes not worth remembering per client for JITServer\n\nPR #10644 added a static array of classes not worth remembering\nto Symbol Validation Manager. JITServer, however, requires this array\nto be stored on a per client bases, since pointers to J9 classes\nare different between clients.\nAlso, ensure that `getSystemClassFromClassName` always calls\nthe base version on the client, even in AOT compilation,\nas all validation is done on the server.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-23T20:23:26Z", "type": "forcePushed"}, {"oid": "be45c7ccba70bc4756728ed2ecd39f1d86a507d8", "url": "https://github.com/eclipse-openj9/openj9/commit/be45c7ccba70bc4756728ed2ecd39f1d86a507d8", "message": "Store classes not worth remembering per client for JITServer\n\nPR #10644 added a static array of classes not worth remembering\nto Symbol Validation Manager. JITServer, however, requires this array\nto be stored on a per client bases, since pointers to J9 classes\nare different between clients.\nAlso, ensure that `getSystemClassFromClassName` always calls\nthe base version on the client, even in AOT compilation,\nas all validation is done on the server.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-23T21:03:39Z", "type": "forcePushed"}, {"oid": "1977a74a44c54f7110fa5af2fbdb01adc606ac29", "url": "https://github.com/eclipse-openj9/openj9/commit/1977a74a44c54f7110fa5af2fbdb01adc606ac29", "message": "Store classes not worth remembering per client for JITServer\n\nPR #10644 added a static array of classes not worth remembering\nto Symbol Validation Manager. JITServer, however, requires this array\nto be stored on a per client bases, since pointers to J9 classes\nare different between clients.\nAlso, ensure that `getSystemClassFromClassName` always calls\nthe base version on the client, even in AOT compilation,\nas all validation is done on the server.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-23T21:11:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0MDgxMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10682#discussion_r493940813", "bodyText": "We have a frontend as a parameter of handleServerMessage. Do we need a specific one, i.e. a non-AOT one? If so, please add a comment explaining why.", "author": "mpirvu", "createdAt": "2020-09-23T22:59:24Z", "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -256,9 +256,10 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n       case MessageType::VM_getSystemClassFromClassName:\n          {\n          auto recv = client->getRecvData<std::string, bool>();\n+         TR_J9VMBase *fej9 = TR_J9VMBase::get(vmThread->javaVM->jitConfig, vmThread);", "originalCommit": "1977a74a44c54f7110fa5af2fbdb01adc606ac29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ0MTg2MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10682#discussion_r494441861", "bodyText": "Yeah, we need non-AOT front-end here, since validation is done on the server. I mention it in the commit message, will add comment here as well.", "author": "dmitry-ten", "createdAt": "2020-09-24T16:11:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0MDgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUzOTkyOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10682#discussion_r494539928", "bodyText": "Ironically, I just reviewed an item from @dchopra001 where I suggested using a TR_J9 frontend in this very place. In a sense I answered my own question in that PR.", "author": "mpirvu", "createdAt": "2020-09-24T18:50:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0MDgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU5MzE0Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10682#discussion_r494593142", "bodyText": "Can we remove this line of code from here and merge it as part of #10688 instead? The change here is needed to functional correctness on Z. Since we are trying to get this change into the 0.23 branch, it'll be easier to push it through as part of #10688. Unless we are sure that the change in this PR should also be double delivered?", "author": "dchopra001", "createdAt": "2020-09-24T20:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0MDgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYwMTEwNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10682#discussion_r494601106", "bodyText": "I will remove it.", "author": "dmitry-ten", "createdAt": "2020-09-24T20:47:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0MDgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYwMTQ1MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10682#discussion_r494601450", "bodyText": "Thanks!", "author": "dchopra001", "createdAt": "2020-09-24T20:48:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0MDgxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk0Njc5Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10682#discussion_r493946796", "bodyText": "This should be derived from the definition of the array", "author": "mpirvu", "createdAt": "2020-09-23T23:11:00Z", "path": "runtime/compiler/runtime/SymbolValidationManager.hpp", "diffHunk": "@@ -628,6 +628,7 @@ struct ImproperInterfaceMethodFromCPRecord : public MethodValidationRecord\n    int32_t _cpIndex;\n    };\n \n+#define SYSTEM_CLASSES_NOT_WORTH_REMEMBERING_COUNT 2", "originalCommit": "1977a74a44c54f7110fa5af2fbdb01adc606ac29", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1MDcwNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10682#discussion_r493950705", "bodyText": "We have the comp object so we can ask comp->isOutOfProcessCompilation()", "author": "mpirvu", "createdAt": "2020-09-23T23:23:02Z", "path": "runtime/compiler/runtime/SymbolValidationManager.cpp", "diffHunk": "@@ -111,6 +115,26 @@ TR::SymbolValidationManager::SymbolValidationManager(TR::Region &region, TR_Reso\n       _alreadyGeneratedRecords.insert(\n          new (_region) ArrayClassFromComponentClassRecord(arrayClass, component));\n       }\n+\n+#if defined(J9VM_OPT_JITSERVER)\n+   if (TR::CompilationInfo::get()->getPersistentInfo()->getRemoteCompilationMode() == JITServer::SERVER)", "originalCommit": "1977a74a44c54f7110fa5af2fbdb01adc606ac29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQwOTUwMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10682#discussion_r494409501", "bodyText": "We can't use that method here, since SVM is created from J9::Compilation constructor, and _isOutOfProcessCompilation is not set yet. But if we move if outside of the constructor then it can be changed.", "author": "dmitry-ten", "createdAt": "2020-09-24T15:25:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk1MDcwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2NTUzMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10682#discussion_r493965531", "bodyText": "I think we should execute this block of code in the constructor of a session where our new vector of classes not worth remembering is defined. This way we can avoid locking getClassesNotWorthRememberingMonitor() every time we create an SVM object. I am proposing to take this block of code (more or less) and create a static function in SymbolValidationManager. Then call this function in the constructor of a client session. We may not even need a vector, just an array of structs should be enough, though I don't know if we can use the computed number of elements in another file.", "author": "mpirvu", "createdAt": "2020-09-24T00:07:01Z", "path": "runtime/compiler/runtime/SymbolValidationManager.cpp", "diffHunk": "@@ -111,6 +115,26 @@ TR::SymbolValidationManager::SymbolValidationManager(TR::Region &region, TR_Reso\n       _alreadyGeneratedRecords.insert(\n          new (_region) ArrayClassFromComponentClassRecord(arrayClass, component));\n       }\n+\n+#if defined(J9VM_OPT_JITSERVER)\n+   if (TR::CompilationInfo::get()->getPersistentInfo()->getRemoteCompilationMode() == JITServer::SERVER)\n+      {\n+      // If needed, populate the client session with classes not worth remembering\n+      auto clientData = _fej9->_compInfoPT->getClientData();\n+      auto &classesNotWorthRemembering = clientData->getSystemClassesNotWorthRemembering();\n+         {\n+         OMR::CriticalSection classesNotWorthRememberingMonitor(clientData->getClassesNotWorthRememberingMonitor());\n+         if (classesNotWorthRemembering.size() != SYSTEM_CLASSES_NOT_WORTH_REMEMBERING_COUNT)\n+            {\n+            for (int i = 0; i < SYSTEM_CLASSES_NOT_WORTH_REMEMBERING_COUNT; ++i)\n+               {\n+               auto classNotWorthRemembering = &_systemClassesNotWorthRemembering[i];\n+               classesNotWorthRemembering.push_back({ classNotWorthRemembering->_className, NULL, classNotWorthRemembering->_checkIsSuperClass });\n+               }\n+            }\n+         }\n+      }", "originalCommit": "1977a74a44c54f7110fa5af2fbdb01adc606ac29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ1OTY1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10682#discussion_r494459659", "bodyText": "Yeah, I will implement that. I think we don't even need a monitor if array initialization is done in client session constructor.", "author": "dmitry-ten", "createdAt": "2020-09-24T16:38:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2NTUzMQ=="}], "type": "inlineReview"}, {"oid": "b89dac5d4eb1b17fb63ceb4eb8079b25c72b7019", "url": "https://github.com/eclipse-openj9/openj9/commit/b89dac5d4eb1b17fb63ceb4eb8079b25c72b7019", "message": "Store classes not worth remembering per client for JITServer\n\nPR #10644 added a static array of classes not worth remembering\nto Symbol Validation Manager. JITServer, however, requires this array\nto be stored on a per client bases, since pointers to J9 classes\nare different between clients.\nAlso, ensure that `getSystemClassFromClassName` always calls\nthe base version on the client, even in AOT compilation,\nas all validation is done on the server.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-24T16:41:57Z", "type": "forcePushed"}, {"oid": "d36c0ff581e1b43e1579cf92dfa284970e5a600f", "url": "https://github.com/eclipse-openj9/openj9/commit/d36c0ff581e1b43e1579cf92dfa284970e5a600f", "message": "Store classes not worth remembering per client for JITServer\n\nPR #10644 added a static array of classes not worth remembering\nto Symbol Validation Manager. JITServer, however, requires this array\nto be stored on a per client bases, since pointers to J9 classes\nare different between clients.\nAlso, ensure that `getSystemClassFromClassName` always calls\nthe base version on the client, even in AOT compilation,\nas all validation is done on the server.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-24T17:55:57Z", "type": "forcePushed"}, {"oid": "a1a9de4ea2901e77029f3c6b48d1d6bc681d9528", "url": "https://github.com/eclipse-openj9/openj9/commit/a1a9de4ea2901e77029f3c6b48d1d6bc681d9528", "message": "Store classes not worth remembering per client for JITServer\n\nPR #10644 added a static array of classes not worth remembering\nto Symbol Validation Manager. JITServer, however, requires this array\nto be stored on a per client bases, since pointers to J9 classes\nare different between clients.\nAlso, ensure that `getSystemClassFromClassName` always calls\nthe base version on the client, even in AOT compilation,\nas all validation is done on the server.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-24T17:59:07Z", "type": "forcePushed"}, {"oid": "a14b7a9bd001e1fa5d2510b4d200ca0e2de68767", "url": "https://github.com/eclipse-openj9/openj9/commit/a14b7a9bd001e1fa5d2510b4d200ca0e2de68767", "message": "Store classes not worth remembering per client for JITServer\n\nPR #10644 added a static array of classes not worth remembering\nto Symbol Validation Manager. JITServer, however, requires this array\nto be stored on a per client bases, since pointers to J9 classes\nare different between clients.\nAlso, ensure that `getSystemClassFromClassName` always calls\nthe base version on the client, even in AOT compilation,\nas all validation is done on the server.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-24T22:01:17Z", "type": "forcePushed"}, {"oid": "b56aec7f369c98a8de17280b0d065709b1dbe86c", "url": "https://github.com/eclipse-openj9/openj9/commit/b56aec7f369c98a8de17280b0d065709b1dbe86c", "message": "Store classes not worth remembering per client for JITServer\n\nPR #10644 added a static array of classes not worth remembering\nto Symbol Validation Manager. JITServer, however, requires this array\nto be stored on a per client bases, since pointers to J9 classes\nare different between clients.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-24T22:01:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY1ODkxNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10682#discussion_r494658917", "bodyText": "Can't we leave the first const here. The second one refers to the _className being immutable, but the first one refers to the string of characters being immutable.", "author": "mpirvu", "createdAt": "2020-09-24T23:10:01Z", "path": "runtime/compiler/runtime/SymbolValidationManager.hpp", "diffHunk": "@@ -637,9 +641,9 @@ class SymbolValidationManager\n \n    struct SystemClassNotWorthRemembering\n       {\n-      const char * const _className;\n+      char *_className;", "originalCommit": "b56aec7f369c98a8de17280b0d065709b1dbe86c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcwNjAxMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10682#discussion_r494706013", "bodyText": "True. I can push the change once the tests pass.", "author": "dmitry-ten", "createdAt": "2020-09-25T02:07:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY1ODkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk3MTc2MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10682#discussion_r494971760", "bodyText": "The tests on Power take very long for some reason, but on x86 they passed. You could do this change now.", "author": "mpirvu", "createdAt": "2020-09-25T13:02:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY1ODkxNw=="}], "type": "inlineReview"}, {"oid": "355e038cfde6eedd5a2baaf0a87ecc97562397c9", "url": "https://github.com/eclipse-openj9/openj9/commit/355e038cfde6eedd5a2baaf0a87ecc97562397c9", "message": "Store classes not worth remembering per client for JITServer\n\nPR #10644 added a static array of classes not worth remembering\nto Symbol Validation Manager. JITServer, however, requires this array\nto be stored on a per client bases, since pointers to J9 classes\nare different between clients.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-25T13:49:50Z", "type": "commit"}, {"oid": "355e038cfde6eedd5a2baaf0a87ecc97562397c9", "url": "https://github.com/eclipse-openj9/openj9/commit/355e038cfde6eedd5a2baaf0a87ecc97562397c9", "message": "Store classes not worth remembering per client for JITServer\n\nPR #10644 added a static array of classes not worth remembering\nto Symbol Validation Manager. JITServer, however, requires this array\nto be stored on a per client bases, since pointers to J9 classes\nare different between clients.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-25T13:49:50Z", "type": "forcePushed"}]}