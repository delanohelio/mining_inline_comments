{"pr_number": 8810, "pr_title": "Fix valueType array flags", "pr_createdAt": "2020-03-09T21:28:20Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8810", "timeline": [{"oid": "31febb0efaef6a8814d1ecb6bc4f1c18a618a931", "url": "https://github.com/eclipse-openj9/openj9/commit/31febb0efaef6a8814d1ecb6bc4f1c18a618a931", "message": "Fix valueType array flags\n\nFor arrays of valueType elements (where componentType is a valuetype),\nthe arrays themselves are not valuetypes but they should inherit the\nlayout characteristics (ie. flattenable, etc.) of the valuetype\nelements. A 2D (or more) array of valuetype elements (where\nleafComponentType is a Valuetype but componentType is not) is not direct\narray array of valuetype elements, therefore it should not inherit any\nlayout properties from the leafComponentType. A 2D array is an array of\nreferences so it can never be flattened, however, its elements may be\nflattened arrays.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-03-09T21:29:27Z", "type": "forcePushed"}, {"oid": "d0b41490b46492d31f910db22dab031637500175", "url": "https://github.com/eclipse-openj9/openj9/commit/d0b41490b46492d31f910db22dab031637500175", "message": "Fix valueType array flags\n\nFor arrays of valueType elements (where componentType is a valuetype),\nthe arrays themselves are not valuetypes but they should inherit the\nlayout characteristics (ie. flattenable, etc.) of the valuetype\nelements. A 2D (or more) array of valuetype elements (where\nleafComponentType is a Valuetype but componentType is not) is not direct\narray array of valuetype elements, therefore it should not inherit any\nlayout properties from the leafComponentType. A 2D array is an array of\nreferences so it can never be flattened, however, its elements may be\nflattened arrays.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-03-09T21:47:06Z", "type": "forcePushed"}, {"oid": "cbfbe2979a0e29c78c5369adf5f1e189b9ded037", "url": "https://github.com/eclipse-openj9/openj9/commit/cbfbe2979a0e29c78c5369adf5f1e189b9ded037", "message": "Fix valueType array flags\n\nFor arrays of valueType elements (where componentType is a valuetype),\nthe arrays themselves are not valuetypes but they should inherit the\nlayout characteristics (ie. flattenable, etc.) of the valuetype\nelements. A 2D (or more) array of valuetype elements (where\nleafComponentType is a Valuetype but componentType is not) is not direct\narray array of valuetype elements, therefore it should not inherit any\nlayout properties from the leafComponentType. A 2D array is an array of\nreferences so it can never be flattened, however, its elements may be\nflattened arrays.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-03-09T21:48:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQxNzUxMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8810#discussion_r390417513", "bodyText": "Please invert the & operands - this is why I was confused thinking you were adding flags.", "author": "gacholio", "createdAt": "2020-03-10T15:49:51Z", "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2894,12 +2894,19 @@ internalCreateRAMClassFromROMClassImpl(J9VMThread *vmThread, J9ClassLoader *clas\n \t\t\t\t} else {\n \t\t\t\t\tarity = 1;\n \t\t\t\t\tleafComponentType = elementClass;\n+\t\t\t\t\t/* For arrays of valueType elements (where componentType is a valuetype), the arrays themselves are not\n+\t\t\t\t\t * valuetypes but they should inherit the layout characteristics (ie. flattenable, etc.)\n+\t\t\t\t\t * of the valuetype elements. A 2D (or more) array of valuetype elements (where leafComponentType is a Valuetype but\n+\t\t\t\t\t * componentType is not) is not direct array array of valuetype elements, therefore it should not inherit any layout\n+\t\t\t\t\t * properties from the leafComponentType. A 2D array is an array of references so it can never be flattened, however, its\n+\t\t\t\t\t * elements may be flattened arrays.\n+\t\t\t\t\t */\n+\t\t\t\t\tramArrayClass->classFlags |= (J9ClassIsFlattened | J9ClassLargestAlignmentConstraintReference | J9ClassLargestAlignmentConstraintDouble) & elementClass->classFlags;", "originalCommit": "cbfbe2979a0e29c78c5369adf5f1e189b9ded037", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "22bde10d61a6b250f2a4b8969eb0206f624d9bfb", "url": "https://github.com/eclipse-openj9/openj9/commit/22bde10d61a6b250f2a4b8969eb0206f624d9bfb", "message": "Fix valueType array flags\n\nFor arrays of valueType elements (where componentType is a valuetype),\nthe arrays themselves are not valuetypes but they should inherit the\nlayout characteristics (ie. flattenable, etc.) of the valuetype\nelements. A 2D (or more) array of valuetype elements (where\nleafComponentType is a Valuetype but componentType is not) is not direct\narray array of valuetype elements, therefore it should not inherit any\nlayout properties from the leafComponentType. A 2D array is an array of\nreferences so it can never be flattened, however, its elements may be\nflattened arrays.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-03-10T16:34:50Z", "type": "commit"}, {"oid": "22bde10d61a6b250f2a4b8969eb0206f624d9bfb", "url": "https://github.com/eclipse-openj9/openj9/commit/22bde10d61a6b250f2a4b8969eb0206f624d9bfb", "message": "Fix valueType array flags\n\nFor arrays of valueType elements (where componentType is a valuetype),\nthe arrays themselves are not valuetypes but they should inherit the\nlayout characteristics (ie. flattenable, etc.) of the valuetype\nelements. A 2D (or more) array of valuetype elements (where\nleafComponentType is a Valuetype but componentType is not) is not direct\narray array of valuetype elements, therefore it should not inherit any\nlayout properties from the leafComponentType. A 2D array is an array of\nreferences so it can never be flattened, however, its elements may be\nflattened arrays.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-03-10T16:34:50Z", "type": "forcePushed"}]}