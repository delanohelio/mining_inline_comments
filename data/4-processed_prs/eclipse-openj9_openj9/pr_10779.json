{"pr_number": 10779, "pr_title": "Auto download bootjdk", "pr_createdAt": "2020-10-03T14:47:33Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10779", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4MDA0MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r499580040", "bodyText": "Not sure we'd want the env output here.  What value is having this information at this point?  There are also 2 within 5 lines.  mkdir isn't really needed.  Windows path has a mv and gzip will create the directory structure if it doesn't exist.", "author": "jdekonin", "createdAt": "2020-10-05T13:00:43Z", "path": "buildenv/jenkins/common/variables-functions.groovy", "diffHunk": "@@ -1514,33 +1514,66 @@ def create_job(JOB_NAME, SDK_VERSION, SPEC, downstreamJobType, id) {\n }\n \n def set_build_variables_per_node() {\n-    BOOT_JDK = check_path(buildspec.getScalarField('boot_jdk', SDK_VERSION), true)\n+    BOOT_JDK = buildspec.getScalarField('boot_jdk.location', SDK_VERSION)\n     println(\"BOOT_JDK: ${BOOT_JDK}\")\n-    if (!BOOT_JDK) {\n-        error(\"BOOT_JDK: ${BOOT_JDK} does not exist!\")\n+    if (!check_path(\"${BOOT_JDK}/bin/java\")) {\n+        echo \"BOOT_JDK: ${BOOT_JDK} does not exist! Attempt to download it...\"\n+        download_boot_jdk(BOOT_JDK)\n     }\n \n-    def freemarkerPath = buildspec.getScalarField('freemarker', SDK_VERSION)\n-    FREEMARKER = check_path(buildspec.getScalarField('freemarker', SDK_VERSION), false)\n+    FREEMARKER = buildspec.getScalarField('freemarker', SDK_VERSION)\n     println(\"FREEMARKER: ${FREEMARKER}\")\n-    if (!FREEMARKER) {\n+    if (!check_path(FREEMARKER)) {\n         error(\"FREEMARKER: ${FREEMARKER} does not exist!\")\n     }\n \n-    OPENJDK_REFERENCE_REPO = check_path(buildspec.getScalarField(\"openjdk_reference_repo\", SDK_VERSION), true)\n+    OPENJDK_REFERENCE_REPO = buildspec.getScalarField(\"openjdk_reference_repo\", SDK_VERSION)\n     println(\"OPENJDK_REFERENCE_REPO: ${OPENJDK_REFERENCE_REPO}\")\n-    if (!OPENJDK_REFERENCE_REPO) {\n+    if (!check_path(OPENJDK_REFERENCE_REPO)) {\n         println(\"The git cache OPENJDK_REFERENCE_REPO: ${buildspec.getScalarField('openjdk_reference_repo', SDK_VERSION)} does not exist on ${NODE_NAME}!\")\n     }\n }\n \n-def check_path(inPath, isDir) {\n+def check_path(inPath) {\n     if (!inPath) {\n-        return inPath\n+        return false\n     }\n-\n-    def testOption = (isDir) ? \"-d\" : \"-e\"\n-    return sh (script: \"test ${testOption} ${inPath} && echo ${inPath} || echo ''\", returnStdout: true).trim()\n+    return sh (script: \"test -e ${inPath} && echo true || echo false\", returnStdout: true).trim().toBoolean()\n }\n \n+def download_boot_jdk(jdkPath) {\n+    def bootJDKVersion = SDK_VERSION.toInteger() - 1\n+    if ((SDK_VERSION == '8') || (SDK_VERSION == '11')) {\n+        bootJDKVersion = SDK_VERSION\n+    }\n+    def os = buildspec.getScalarField('boot_jdk', 'os')\n+    def arch = buildspec.getScalarField('boot_jdk', 'arch')\n+    def dirStrip = buildspec.getScalarField('boot_jdk', 'dir_strip')\n+    def sdkUrl = \"https://api.adoptopenjdk.net/v3/binary/latest/${bootJDKVersion}/ga/${os}/${arch}/jdk/openj9/normal/adoptopenjdk?project=jdk\"\n+\n+    /*\n+     * Download bootjdk\n+     * Windows are zips from Adopt. Unzip doesn't have strip dir so we have to manually move.\n+     * Remaining platforms are tarballs.\n+     * Mac has some extra dirs to strip off hence $dirStrip.\n+     */\n+    dir('bootjdk') {\n+        sh \"\"\"\n+            env\n+            curl -LJkO ${sdkUrl}\n+            mkdir -p ${jdkPath}\n+            sdkFile=`ls | grep OpenJDK`\n+            env", "originalCommit": "f6c6fd7d905f07c0f8ea048f561f25c137fa9c17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYwMDg5NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r499600894", "bodyText": "ah, debug I forgot to remove. Will update.", "author": "AdamBrousseau", "createdAt": "2020-10-05T13:32:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4MDA0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4MTAxOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r499581019", "bodyText": "Not sure what bootjdk.tar.gz is connected too.  I'm thinking you mean \"\\$sdkFile\"?", "author": "jdekonin", "createdAt": "2020-10-05T13:02:14Z", "path": "buildenv/jenkins/common/variables-functions.groovy", "diffHunk": "@@ -1514,33 +1514,66 @@ def create_job(JOB_NAME, SDK_VERSION, SPEC, downstreamJobType, id) {\n }\n \n def set_build_variables_per_node() {\n-    BOOT_JDK = check_path(buildspec.getScalarField('boot_jdk', SDK_VERSION), true)\n+    BOOT_JDK = buildspec.getScalarField('boot_jdk.location', SDK_VERSION)\n     println(\"BOOT_JDK: ${BOOT_JDK}\")\n-    if (!BOOT_JDK) {\n-        error(\"BOOT_JDK: ${BOOT_JDK} does not exist!\")\n+    if (!check_path(\"${BOOT_JDK}/bin/java\")) {\n+        echo \"BOOT_JDK: ${BOOT_JDK} does not exist! Attempt to download it...\"\n+        download_boot_jdk(BOOT_JDK)\n     }\n \n-    def freemarkerPath = buildspec.getScalarField('freemarker', SDK_VERSION)\n-    FREEMARKER = check_path(buildspec.getScalarField('freemarker', SDK_VERSION), false)\n+    FREEMARKER = buildspec.getScalarField('freemarker', SDK_VERSION)\n     println(\"FREEMARKER: ${FREEMARKER}\")\n-    if (!FREEMARKER) {\n+    if (!check_path(FREEMARKER)) {\n         error(\"FREEMARKER: ${FREEMARKER} does not exist!\")\n     }\n \n-    OPENJDK_REFERENCE_REPO = check_path(buildspec.getScalarField(\"openjdk_reference_repo\", SDK_VERSION), true)\n+    OPENJDK_REFERENCE_REPO = buildspec.getScalarField(\"openjdk_reference_repo\", SDK_VERSION)\n     println(\"OPENJDK_REFERENCE_REPO: ${OPENJDK_REFERENCE_REPO}\")\n-    if (!OPENJDK_REFERENCE_REPO) {\n+    if (!check_path(OPENJDK_REFERENCE_REPO)) {\n         println(\"The git cache OPENJDK_REFERENCE_REPO: ${buildspec.getScalarField('openjdk_reference_repo', SDK_VERSION)} does not exist on ${NODE_NAME}!\")\n     }\n }\n \n-def check_path(inPath, isDir) {\n+def check_path(inPath) {\n     if (!inPath) {\n-        return inPath\n+        return false\n     }\n-\n-    def testOption = (isDir) ? \"-d\" : \"-e\"\n-    return sh (script: \"test ${testOption} ${inPath} && echo ${inPath} || echo ''\", returnStdout: true).trim()\n+    return sh (script: \"test -e ${inPath} && echo true || echo false\", returnStdout: true).trim().toBoolean()\n }\n \n+def download_boot_jdk(jdkPath) {\n+    def bootJDKVersion = SDK_VERSION.toInteger() - 1\n+    if ((SDK_VERSION == '8') || (SDK_VERSION == '11')) {\n+        bootJDKVersion = SDK_VERSION\n+    }\n+    def os = buildspec.getScalarField('boot_jdk', 'os')\n+    def arch = buildspec.getScalarField('boot_jdk', 'arch')\n+    def dirStrip = buildspec.getScalarField('boot_jdk', 'dir_strip')\n+    def sdkUrl = \"https://api.adoptopenjdk.net/v3/binary/latest/${bootJDKVersion}/ga/${os}/${arch}/jdk/openj9/normal/adoptopenjdk?project=jdk\"\n+\n+    /*\n+     * Download bootjdk\n+     * Windows are zips from Adopt. Unzip doesn't have strip dir so we have to manually move.\n+     * Remaining platforms are tarballs.\n+     * Mac has some extra dirs to strip off hence $dirStrip.\n+     */\n+    dir('bootjdk') {\n+        sh \"\"\"\n+            env\n+            curl -LJkO ${sdkUrl}\n+            mkdir -p ${jdkPath}\n+            sdkFile=`ls | grep OpenJDK`\n+            env\n+            if [[ \"\\$sdkFile\" == *zip ]]; then\n+                unzip \"\\$sdkFile\" -d .\n+                sdkFolder=`ls -d */`\n+                mv \"\\$sdkFolder\"* ${jdkPath}/\n+            else\n+                gzip -cd \"\\$sdkFile\" | tar xof - -C ${jdkPath} --strip=${dirStrip}\n+            fi\n+            ${jdkPath}/bin/java -version\n+            rm -f bootjdk.tar.gz", "originalCommit": "f6c6fd7d905f07c0f8ea048f561f25c137fa9c17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYwMTIyOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r499601229", "bodyText": "Good catch, forgot to update that.", "author": "AdamBrousseau", "createdAt": "2020-10-05T13:32:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4MTAxOQ=="}], "type": "inlineReview"}, {"oid": "3783c91f1ca44b637fb355c18367cb7feaac92b3", "url": "https://github.com/eclipse-openj9/openj9/commit/3783c91f1ca44b637fb355c18367cb7feaac92b3", "message": "Auto download bootjdk\n\nIf bootjdk is not present on the system in the\nlocation provided, attempt to pull one from Adopt\nand unpack it to that same location.\n\nAssumes build user has write permissions in the\nlocation provided. Downloads 8 & 11 for JDK8/11.\nDownloads n-1 for other (non-LTS) versions.\n\nAlso reworks function check_path to return a bool\nrather than either a string or empty string.\n\n[skip ci]\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-10-05T13:33:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYwNDMyMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r499604321", "bodyText": "Missed an a here in arch.", "author": "jdekonin", "createdAt": "2020-10-05T13:37:17Z", "path": "buildenv/jenkins/variables/defaults.yml", "diffHunk": "@@ -246,11 +250,15 @@ ppc64le_linux_jit:\n s390x_linux:\n   extends: ['debuginfo', 'freemarker', 'openjdk_reference_repo', 'openssl']\n   boot_jdk:\n-    8: '/usr/lib/jvm/adoptojdk-java-s390x-80'\n-    11: '/usr/lib/jvm/adoptojdk-java-11'\n-    14: '/usr/lib/jvm/adoptojdk-java-14'\n-    15: '/usr/lib/jvm/adoptojdk-java-14'\n-    next: '/usr/lib/jvm/adoptojdk-java-15'\n+    location:\n+      8: '/usr/lib/jvm/adoptojdk-java-s390x-80'\n+      11: '/usr/lib/jvm/adoptojdk-java-11'\n+      14: '/usr/lib/jvm/adoptojdk-java-14'\n+      15: '/usr/lib/jvm/adoptojdk-java-14'\n+      next: '/usr/lib/jvm/adoptojdk-java-15'\n+    rch: 's390x'", "originalCommit": "3783c91f1ca44b637fb355c18367cb7feaac92b3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "79c94c5fd9bc04a0d6ea5cb42586614a2bdb708a", "url": "https://github.com/eclipse-openj9/openj9/commit/79c94c5fd9bc04a0d6ea5cb42586614a2bdb708a", "message": "Auto download bootjdk\n\nIf bootjdk is not present on the system in the\nlocation provided, attempt to pull one from Adopt\nand unpack it to that same location.\n\nAssumes build user has write permissions in the\nlocation provided. Downloads 8 & 11 for JDK8/11.\nDownloads n-1 for other (non-LTS) versions.\n\nAlso reworks function check_path to return a bool\nrather than either a string or empty string.\n\n[skip ci]\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-10-05T14:40:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMjIxNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r499732214", "bodyText": "typo", "author": "pshipton", "createdAt": "2020-10-05T16:41:19Z", "path": "buildenv/jenkins/variables/defaults.yml", "diffHunk": "@@ -531,7 +555,11 @@ x86-64_windows_xl_uma:\n x86-32_windows:\n   extends: ['debuginfo', 'openjdk_reference_repo', 'openssl_bundle']\n   boot_jdk:\n-    8: '/cygdrive/c/openjdk/jdk7'\n+    locaiton:", "originalCommit": "79c94c5fd9bc04a0d6ea5cb42586614a2bdb708a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0NDQ1NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r499744455", "bodyText": "fixed", "author": "AdamBrousseau", "createdAt": "2020-10-05T17:02:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMjIxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMzc0NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r499733745", "bodyText": "Did you want to handle .pax and .pax.Z as well?", "author": "pshipton", "createdAt": "2020-10-05T16:43:53Z", "path": "buildenv/jenkins/common/variables-functions.groovy", "diffHunk": "@@ -1514,33 +1514,64 @@ def create_job(JOB_NAME, SDK_VERSION, SPEC, downstreamJobType, id) {\n }\n \n def set_build_variables_per_node() {\n-    BOOT_JDK = check_path(buildspec.getScalarField('boot_jdk', SDK_VERSION), true)\n+    BOOT_JDK = buildspec.getScalarField('boot_jdk.location', SDK_VERSION)\n     println(\"BOOT_JDK: ${BOOT_JDK}\")\n-    if (!BOOT_JDK) {\n-        error(\"BOOT_JDK: ${BOOT_JDK} does not exist!\")\n+    if (!check_path(\"${BOOT_JDK}/bin/java\")) {\n+        echo \"BOOT_JDK: ${BOOT_JDK} does not exist! Attempt to download it...\"\n+        download_boot_jdk(BOOT_JDK)\n     }\n \n-    def freemarkerPath = buildspec.getScalarField('freemarker', SDK_VERSION)\n-    FREEMARKER = check_path(buildspec.getScalarField('freemarker', SDK_VERSION), false)\n+    FREEMARKER = buildspec.getScalarField('freemarker', SDK_VERSION)\n     println(\"FREEMARKER: ${FREEMARKER}\")\n-    if (!FREEMARKER) {\n+    if (!check_path(FREEMARKER)) {\n         error(\"FREEMARKER: ${FREEMARKER} does not exist!\")\n     }\n \n-    OPENJDK_REFERENCE_REPO = check_path(buildspec.getScalarField(\"openjdk_reference_repo\", SDK_VERSION), true)\n+    OPENJDK_REFERENCE_REPO = buildspec.getScalarField(\"openjdk_reference_repo\", SDK_VERSION)\n     println(\"OPENJDK_REFERENCE_REPO: ${OPENJDK_REFERENCE_REPO}\")\n-    if (!OPENJDK_REFERENCE_REPO) {\n+    if (!check_path(OPENJDK_REFERENCE_REPO)) {\n         println(\"The git cache OPENJDK_REFERENCE_REPO: ${buildspec.getScalarField('openjdk_reference_repo', SDK_VERSION)} does not exist on ${NODE_NAME}!\")\n     }\n }\n \n-def check_path(inPath, isDir) {\n+def check_path(inPath) {\n     if (!inPath) {\n-        return inPath\n+        return false\n     }\n-\n-    def testOption = (isDir) ? \"-d\" : \"-e\"\n-    return sh (script: \"test ${testOption} ${inPath} && echo ${inPath} || echo ''\", returnStdout: true).trim()\n+    return sh (script: \"test -e ${inPath} && echo true || echo false\", returnStdout: true).trim().toBoolean()\n }\n \n+def download_boot_jdk(jdkPath) {\n+    def bootJDKVersion = SDK_VERSION.toInteger() - 1\n+    if ((SDK_VERSION == '8') || (SDK_VERSION == '11')) {\n+        bootJDKVersion = SDK_VERSION\n+    }\n+    def os = buildspec.getScalarField('boot_jdk', 'os')\n+    def arch = buildspec.getScalarField('boot_jdk', 'arch')\n+    def dirStrip = buildspec.getScalarField('boot_jdk', 'dir_strip')\n+    def sdkUrl = \"https://api.adoptopenjdk.net/v3/binary/latest/${bootJDKVersion}/ga/${os}/${arch}/jdk/openj9/normal/adoptopenjdk?project=jdk\"\n+\n+    /*\n+     * Download bootjdk\n+     * Windows are zips from Adopt. Unzip doesn't have strip dir so we have to manually move.\n+     * Remaining platforms are tarballs.\n+     * Mac has some extra dirs to strip off hence $dirStrip.\n+     */\n+    dir('bootjdk') {\n+        sh \"\"\"\n+            curl -LJkO ${sdkUrl}\n+            mkdir -p ${jdkPath}\n+            sdkFile=`ls | grep OpenJDK`\n+            if [[ \"\\$sdkFile\" == *zip ]]; then\n+                unzip \"\\$sdkFile\" -d .\n+                sdkFolder=`ls -d */`\n+                mv \"\\$sdkFolder\"* ${jdkPath}/\n+            else\n+                gzip -cd \"\\$sdkFile\" | tar xof - -C ${jdkPath} --strip=${dirStrip}", "originalCommit": "79c94c5fd9bc04a0d6ea5cb42586614a2bdb708a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczNTc2Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r499735763", "bodyText": "I guess they aren't available from Adopt, so any support on this can wait.", "author": "pshipton", "createdAt": "2020-10-05T16:47:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMzc0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0NTE0MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r499745141", "bodyText": "No because Adopt won't have z/OS binaries anyways. If we want to make the curl configurable in the future we can revisit.", "author": "AdamBrousseau", "createdAt": "2020-10-05T17:03:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMzc0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczNTA5OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r499735099", "bodyText": "I don't think this will put it into jdkPath.", "author": "pshipton", "createdAt": "2020-10-05T16:46:13Z", "path": "buildenv/jenkins/common/variables-functions.groovy", "diffHunk": "@@ -1514,33 +1514,64 @@ def create_job(JOB_NAME, SDK_VERSION, SPEC, downstreamJobType, id) {\n }\n \n def set_build_variables_per_node() {\n-    BOOT_JDK = check_path(buildspec.getScalarField('boot_jdk', SDK_VERSION), true)\n+    BOOT_JDK = buildspec.getScalarField('boot_jdk.location', SDK_VERSION)\n     println(\"BOOT_JDK: ${BOOT_JDK}\")\n-    if (!BOOT_JDK) {\n-        error(\"BOOT_JDK: ${BOOT_JDK} does not exist!\")\n+    if (!check_path(\"${BOOT_JDK}/bin/java\")) {\n+        echo \"BOOT_JDK: ${BOOT_JDK} does not exist! Attempt to download it...\"\n+        download_boot_jdk(BOOT_JDK)\n     }\n \n-    def freemarkerPath = buildspec.getScalarField('freemarker', SDK_VERSION)\n-    FREEMARKER = check_path(buildspec.getScalarField('freemarker', SDK_VERSION), false)\n+    FREEMARKER = buildspec.getScalarField('freemarker', SDK_VERSION)\n     println(\"FREEMARKER: ${FREEMARKER}\")\n-    if (!FREEMARKER) {\n+    if (!check_path(FREEMARKER)) {\n         error(\"FREEMARKER: ${FREEMARKER} does not exist!\")\n     }\n \n-    OPENJDK_REFERENCE_REPO = check_path(buildspec.getScalarField(\"openjdk_reference_repo\", SDK_VERSION), true)\n+    OPENJDK_REFERENCE_REPO = buildspec.getScalarField(\"openjdk_reference_repo\", SDK_VERSION)\n     println(\"OPENJDK_REFERENCE_REPO: ${OPENJDK_REFERENCE_REPO}\")\n-    if (!OPENJDK_REFERENCE_REPO) {\n+    if (!check_path(OPENJDK_REFERENCE_REPO)) {\n         println(\"The git cache OPENJDK_REFERENCE_REPO: ${buildspec.getScalarField('openjdk_reference_repo', SDK_VERSION)} does not exist on ${NODE_NAME}!\")\n     }\n }\n \n-def check_path(inPath, isDir) {\n+def check_path(inPath) {\n     if (!inPath) {\n-        return inPath\n+        return false\n     }\n-\n-    def testOption = (isDir) ? \"-d\" : \"-e\"\n-    return sh (script: \"test ${testOption} ${inPath} && echo ${inPath} || echo ''\", returnStdout: true).trim()\n+    return sh (script: \"test -e ${inPath} && echo true || echo false\", returnStdout: true).trim().toBoolean()\n }\n \n+def download_boot_jdk(jdkPath) {\n+    def bootJDKVersion = SDK_VERSION.toInteger() - 1\n+    if ((SDK_VERSION == '8') || (SDK_VERSION == '11')) {\n+        bootJDKVersion = SDK_VERSION\n+    }\n+    def os = buildspec.getScalarField('boot_jdk', 'os')\n+    def arch = buildspec.getScalarField('boot_jdk', 'arch')\n+    def dirStrip = buildspec.getScalarField('boot_jdk', 'dir_strip')\n+    def sdkUrl = \"https://api.adoptopenjdk.net/v3/binary/latest/${bootJDKVersion}/ga/${os}/${arch}/jdk/openj9/normal/adoptopenjdk?project=jdk\"\n+\n+    /*\n+     * Download bootjdk\n+     * Windows are zips from Adopt. Unzip doesn't have strip dir so we have to manually move.\n+     * Remaining platforms are tarballs.\n+     * Mac has some extra dirs to strip off hence $dirStrip.\n+     */\n+    dir('bootjdk') {\n+        sh \"\"\"\n+            curl -LJkO ${sdkUrl}\n+            mkdir -p ${jdkPath}\n+            sdkFile=`ls | grep OpenJDK`\n+            if [[ \"\\$sdkFile\" == *zip ]]; then\n+                unzip \"\\$sdkFile\" -d .", "originalCommit": "79c94c5fd9bc04a0d6ea5cb42586614a2bdb708a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0MDIyMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r499740222", "bodyText": "nm, I see.", "author": "pshipton", "createdAt": "2020-10-05T16:54:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczNTA5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0Mjc5MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r499742790", "bodyText": "This should clean up the $sdkFolder", "author": "pshipton", "createdAt": "2020-10-05T16:59:26Z", "path": "buildenv/jenkins/common/variables-functions.groovy", "diffHunk": "@@ -1514,33 +1514,64 @@ def create_job(JOB_NAME, SDK_VERSION, SPEC, downstreamJobType, id) {\n }\n \n def set_build_variables_per_node() {\n-    BOOT_JDK = check_path(buildspec.getScalarField('boot_jdk', SDK_VERSION), true)\n+    BOOT_JDK = buildspec.getScalarField('boot_jdk.location', SDK_VERSION)\n     println(\"BOOT_JDK: ${BOOT_JDK}\")\n-    if (!BOOT_JDK) {\n-        error(\"BOOT_JDK: ${BOOT_JDK} does not exist!\")\n+    if (!check_path(\"${BOOT_JDK}/bin/java\")) {\n+        echo \"BOOT_JDK: ${BOOT_JDK} does not exist! Attempt to download it...\"\n+        download_boot_jdk(BOOT_JDK)\n     }\n \n-    def freemarkerPath = buildspec.getScalarField('freemarker', SDK_VERSION)\n-    FREEMARKER = check_path(buildspec.getScalarField('freemarker', SDK_VERSION), false)\n+    FREEMARKER = buildspec.getScalarField('freemarker', SDK_VERSION)\n     println(\"FREEMARKER: ${FREEMARKER}\")\n-    if (!FREEMARKER) {\n+    if (!check_path(FREEMARKER)) {\n         error(\"FREEMARKER: ${FREEMARKER} does not exist!\")\n     }\n \n-    OPENJDK_REFERENCE_REPO = check_path(buildspec.getScalarField(\"openjdk_reference_repo\", SDK_VERSION), true)\n+    OPENJDK_REFERENCE_REPO = buildspec.getScalarField(\"openjdk_reference_repo\", SDK_VERSION)\n     println(\"OPENJDK_REFERENCE_REPO: ${OPENJDK_REFERENCE_REPO}\")\n-    if (!OPENJDK_REFERENCE_REPO) {\n+    if (!check_path(OPENJDK_REFERENCE_REPO)) {\n         println(\"The git cache OPENJDK_REFERENCE_REPO: ${buildspec.getScalarField('openjdk_reference_repo', SDK_VERSION)} does not exist on ${NODE_NAME}!\")\n     }\n }\n \n-def check_path(inPath, isDir) {\n+def check_path(inPath) {\n     if (!inPath) {\n-        return inPath\n+        return false\n     }\n-\n-    def testOption = (isDir) ? \"-d\" : \"-e\"\n-    return sh (script: \"test ${testOption} ${inPath} && echo ${inPath} || echo ''\", returnStdout: true).trim()\n+    return sh (script: \"test -e ${inPath} && echo true || echo false\", returnStdout: true).trim().toBoolean()\n }\n \n+def download_boot_jdk(jdkPath) {\n+    def bootJDKVersion = SDK_VERSION.toInteger() - 1\n+    if ((SDK_VERSION == '8') || (SDK_VERSION == '11')) {\n+        bootJDKVersion = SDK_VERSION\n+    }\n+    def os = buildspec.getScalarField('boot_jdk', 'os')\n+    def arch = buildspec.getScalarField('boot_jdk', 'arch')\n+    def dirStrip = buildspec.getScalarField('boot_jdk', 'dir_strip')\n+    def sdkUrl = \"https://api.adoptopenjdk.net/v3/binary/latest/${bootJDKVersion}/ga/${os}/${arch}/jdk/openj9/normal/adoptopenjdk?project=jdk\"\n+\n+    /*\n+     * Download bootjdk\n+     * Windows are zips from Adopt. Unzip doesn't have strip dir so we have to manually move.\n+     * Remaining platforms are tarballs.\n+     * Mac has some extra dirs to strip off hence $dirStrip.\n+     */\n+    dir('bootjdk') {\n+        sh \"\"\"\n+            curl -LJkO ${sdkUrl}\n+            mkdir -p ${jdkPath}\n+            sdkFile=`ls | grep OpenJDK`\n+            if [[ \"\\$sdkFile\" == *zip ]]; then\n+                unzip \"\\$sdkFile\" -d .\n+                sdkFolder=`ls -d */`\n+                mv \"\\$sdkFolder\"* ${jdkPath}/", "originalCommit": "79c94c5fd9bc04a0d6ea5cb42586614a2bdb708a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0NjEyOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r499746128", "bodyText": "Since it will be in the WORKSPACE the job will clean it up at the end. I rm'd the binary to free up some space.", "author": "AdamBrousseau", "createdAt": "2020-10-05T17:05:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0Mjc5MA=="}], "type": "inlineReview"}, {"oid": "9cdf270da252a00072e782079fdb2eb288f73fd1", "url": "https://github.com/eclipse-openj9/openj9/commit/9cdf270da252a00072e782079fdb2eb288f73fd1", "message": "Auto download bootjdk\n\nIf bootjdk is not present on the system in the\nlocation provided, attempt to pull one from Adopt\nand unpack it to that same location.\n\nAssumes build user has write permissions in the\nlocation provided. Downloads 8 & 11 for JDK8/11.\nDownloads n-1 for other (non-LTS) versions.\n\nAlso reworks function check_path to return a bool\nrather than either a string or empty string.\n\n[skip ci]\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-10-05T17:01:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0Nzc0Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r499747742", "bodyText": "This won't work for next. Let me fix.", "author": "AdamBrousseau", "createdAt": "2020-10-05T17:08:34Z", "path": "buildenv/jenkins/common/variables-functions.groovy", "diffHunk": "@@ -1514,33 +1514,64 @@ def create_job(JOB_NAME, SDK_VERSION, SPEC, downstreamJobType, id) {\n }\n \n def set_build_variables_per_node() {\n-    BOOT_JDK = check_path(buildspec.getScalarField('boot_jdk', SDK_VERSION), true)\n+    BOOT_JDK = buildspec.getScalarField('boot_jdk.location', SDK_VERSION)\n     println(\"BOOT_JDK: ${BOOT_JDK}\")\n-    if (!BOOT_JDK) {\n-        error(\"BOOT_JDK: ${BOOT_JDK} does not exist!\")\n+    if (!check_path(\"${BOOT_JDK}/bin/java\")) {\n+        echo \"BOOT_JDK: ${BOOT_JDK} does not exist! Attempt to download it...\"\n+        download_boot_jdk(BOOT_JDK)\n     }\n \n-    def freemarkerPath = buildspec.getScalarField('freemarker', SDK_VERSION)\n-    FREEMARKER = check_path(buildspec.getScalarField('freemarker', SDK_VERSION), false)\n+    FREEMARKER = buildspec.getScalarField('freemarker', SDK_VERSION)\n     println(\"FREEMARKER: ${FREEMARKER}\")\n-    if (!FREEMARKER) {\n+    if (!check_path(FREEMARKER)) {\n         error(\"FREEMARKER: ${FREEMARKER} does not exist!\")\n     }\n \n-    OPENJDK_REFERENCE_REPO = check_path(buildspec.getScalarField(\"openjdk_reference_repo\", SDK_VERSION), true)\n+    OPENJDK_REFERENCE_REPO = buildspec.getScalarField(\"openjdk_reference_repo\", SDK_VERSION)\n     println(\"OPENJDK_REFERENCE_REPO: ${OPENJDK_REFERENCE_REPO}\")\n-    if (!OPENJDK_REFERENCE_REPO) {\n+    if (!check_path(OPENJDK_REFERENCE_REPO)) {\n         println(\"The git cache OPENJDK_REFERENCE_REPO: ${buildspec.getScalarField('openjdk_reference_repo', SDK_VERSION)} does not exist on ${NODE_NAME}!\")\n     }\n }\n \n-def check_path(inPath, isDir) {\n+def check_path(inPath) {\n     if (!inPath) {\n-        return inPath\n+        return false\n     }\n-\n-    def testOption = (isDir) ? \"-d\" : \"-e\"\n-    return sh (script: \"test ${testOption} ${inPath} && echo ${inPath} || echo ''\", returnStdout: true).trim()\n+    return sh (script: \"test -e ${inPath} && echo true || echo false\", returnStdout: true).trim().toBoolean()\n }\n \n+def download_boot_jdk(jdkPath) {\n+    def bootJDKVersion = SDK_VERSION.toInteger() - 1", "originalCommit": "9cdf270da252a00072e782079fdb2eb288f73fd1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4ceea11cf4f70150e731aacb73d8518e31d4e9e2", "url": "https://github.com/eclipse-openj9/openj9/commit/4ceea11cf4f70150e731aacb73d8518e31d4e9e2", "message": "debug [skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-10-05T18:12:25Z", "type": "forcePushed"}, {"oid": "149a6f520ac901d3bb98fbb79c991540b523bb56", "url": "https://github.com/eclipse-openj9/openj9/commit/149a6f520ac901d3bb98fbb79c991540b523bb56", "message": "debug [skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-10-05T18:13:53Z", "type": "forcePushed"}, {"oid": "f6837b96b29d985d1abb2d1dc52b3762acf0da07", "url": "https://github.com/eclipse-openj9/openj9/commit/f6837b96b29d985d1abb2d1dc52b3762acf0da07", "message": "debug [skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-10-05T18:39:14Z", "type": "forcePushed"}, {"oid": "daab1a83dec38fee09089c6f13b6a2a8b7921f73", "url": "https://github.com/eclipse-openj9/openj9/commit/daab1a83dec38fee09089c6f13b6a2a8b7921f73", "message": "debug [skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-10-05T18:42:21Z", "type": "forcePushed"}, {"oid": "2a36f8eb89419340806cf101a4b949227dfa1a9f", "url": "https://github.com/eclipse-openj9/openj9/commit/2a36f8eb89419340806cf101a4b949227dfa1a9f", "message": "debug [skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-10-06T03:03:18Z", "type": "forcePushed"}, {"oid": "db57a548422d03fe93763b5691f65caa1eeae2a7", "url": "https://github.com/eclipse-openj9/openj9/commit/db57a548422d03fe93763b5691f65caa1eeae2a7", "message": "debug [skip ci]\n\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-10-06T03:45:08Z", "type": "forcePushed"}, {"oid": "3c9d947cbe478acf38da3492280a909237e06326", "url": "https://github.com/eclipse-openj9/openj9/commit/3c9d947cbe478acf38da3492280a909237e06326", "message": "Auto download bootjdk\n\nIf bootjdk is not present on the system in the\nlocation provided, attempt to pull one from Adopt\nand unpack it to that same location.\n\nAssumes build user has write permissions in the\nlocation provided. Downloads version specified\nin the variable file.\n\nAlso reworks function check_path to return a bool\nrather than either a string or empty string.\n\n[skip ci]\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-10-06T04:53:26Z", "type": "forcePushed"}, {"oid": "e847575b61eb9002f0e3e2b5fd686bb6a842fbca", "url": "https://github.com/eclipse-openj9/openj9/commit/e847575b61eb9002f0e3e2b5fd686bb6a842fbca", "message": "Auto download bootjdk\n\nIf bootjdk is not present on the system in the\nlocation provided, attempt to pull one from Adopt\nand unpack it to that same location.\n\nAssumes build user has write permissions in the\nlocation provided. Downloads version specified\nin the variable file.\n\nAlso reworks function check_path to return a bool\nrather than either a string or empty string.\n\n[skip ci]\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-10-06T12:25:44Z", "type": "forcePushed"}, {"oid": "dfca97c4dabae49462edf50a2ae6634d4507e4d7", "url": "https://github.com/eclipse-openj9/openj9/commit/dfca97c4dabae49462edf50a2ae6634d4507e4d7", "message": "Auto download bootjdk\n\nIf bootjdk is not present on the system in the\nlocation provided, attempt to pull one from Adopt\nand unpack it to that same location.\n\nAssumes build user has write permissions in the\nlocation provided. Downloads version specified\nin the variable file.\n\nAlso reworks function check_path to return a bool\nrather than either a string or empty string.\n\n[skip ci]\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-10-06T12:39:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1OTA3NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r500459075", "bodyText": "We can use 15 to build 15, since it's already GAed.", "author": "pshipton", "createdAt": "2020-10-06T17:06:11Z", "path": "buildenv/jenkins/variables/defaults.yml", "diffHunk": "@@ -166,6 +166,20 @@ freemarker:\n openjdk_reference_repo:\n   openjdk_reference_repo: '/home/jenkins/openjdk_cache'\n #========================================#\n+# BootJDK Default values\n+#========================================#\n+boot_jdk_default:\n+  boot_jdk:\n+    location:\n+      all: '${HOME}/bootjdks'\n+    version:\n+      8: '8'\n+      11: '11'\n+      15: '14'", "originalCommit": "dfca97c4dabae49462edf50a2ae6634d4507e4d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUwMjMyNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r500502325", "bodyText": "Updated", "author": "AdamBrousseau", "createdAt": "2020-10-06T18:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1OTA3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2MTU4NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r500461585", "bodyText": "How does this work? There isn't any Openj9 Aarch64 build at Adopt for Java 15.", "author": "pshipton", "createdAt": "2020-10-06T17:10:15Z", "path": "buildenv/jenkins/variables/defaults.yml", "diffHunk": "@@ -432,12 +435,15 @@ x86-64_linux_valhalla:\n # Linux Aarch 64bits Compressed Pointers\n #========================================#\n aarch64_linux:\n-  extends: ['debuginfo', 'freemarker', 'openjdk_reference_repo', 'openssl']\n+  extends: ['boot_jdk_default', 'debuginfo', 'freemarker', 'openjdk_reference_repo', 'openssl']\n   boot_jdk:\n-    8: '/usr/lib/jvm/java-1.8.0'\n-    11: '/usr/lib/jvm/adoptojdk-java-11'\n-    15: '/usr/lib/jvm/jdk-15+36'\n-    next: '/usr/lib/jvm/jdk-15+36'\n+    version:\n+      8: '8'\n+      11: '11'\n+      15: '15'", "originalCommit": "dfca97c4dabae49462edf50a2ae6634d4507e4d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2Nzc3MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r500467770", "bodyText": "It will only try if the directory doesn't already exist on the machine.  So for the odd case where the platform is still in progress that will need to be pushed out manually otherwise it will fail.", "author": "jdekonin", "createdAt": "2020-10-06T17:20:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2MTU4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUxMjYzOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r500512638", "bodyText": "This PR changes the default bootjdk directories, so none of them exist unless the machines have been updated.\n${HOME}/bootjdks for most, and /opt/bootjdks for AIX.", "author": "pshipton", "createdAt": "2020-10-06T18:32:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2MTU4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUxOTc4MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10779#discussion_r500519780", "bodyText": "Correct, for the single aarch machine I have already copied the bootjdk to the new location.\n[jenkins@cent7-arm8-1 ~]$ ll bootjdks/\ntotal 12\ndrwxrwxr-x 9 jenkins jenkins 4096 Oct  6 05:06 jdk11\ndrwxrwxr-x 9 jenkins jenkins 4096 Oct  6 12:22 jdk15\ndrwxrwxr-x 7 jenkins jenkins 4096 Oct  6 12:25 jdk8", "author": "AdamBrousseau", "createdAt": "2020-10-06T18:44:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2MTU4NQ=="}], "type": "inlineReview"}, {"oid": "b1f35d61ae243e41078dd6fd9ebc29bb6e485282", "url": "https://github.com/eclipse-openj9/openj9/commit/b1f35d61ae243e41078dd6fd9ebc29bb6e485282", "message": "Auto download bootjdk\n\nIf bootjdk is not present on the system in the\nlocation provided, attempt to pull one from Adopt\nand unpack it to that same location.\n\nAssumes build user has write permissions in the\nlocation provided. Downloads version specified\nin the variable file.\n\nAlso reworks function check_path to return a bool\nrather than either a string or empty string.\n\n[skip ci]\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-10-06T18:15:40Z", "type": "commit"}, {"oid": "b1f35d61ae243e41078dd6fd9ebc29bb6e485282", "url": "https://github.com/eclipse-openj9/openj9/commit/b1f35d61ae243e41078dd6fd9ebc29bb6e485282", "message": "Auto download bootjdk\n\nIf bootjdk is not present on the system in the\nlocation provided, attempt to pull one from Adopt\nand unpack it to that same location.\n\nAssumes build user has write permissions in the\nlocation provided. Downloads version specified\nin the variable file.\n\nAlso reworks function check_path to return a bool\nrather than either a string or empty string.\n\n[skip ci]\nSigned-off-by: Adam Brousseau <adam.brousseau88@gmail.com>", "committedDate": "2020-10-06T18:15:40Z", "type": "forcePushed"}]}