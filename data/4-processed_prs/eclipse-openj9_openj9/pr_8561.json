{"pr_number": 8561, "pr_title": "Fix '-XXjitdirectory' option on Linux on Z", "pr_createdAt": "2020-02-12T16:14:31Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8561", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM2ODI5Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r378368293", "bodyText": "We can delay declaring this void* to the point we use it.", "author": "r30shah", "createdAt": "2020-02-12T16:33:40Z", "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -984,7 +984,7 @@ removeSuffix(char *string, const char *suffix)\n static BOOLEAN\n preloadLibraries(void)\n {\n-\tvoid *vmDLL, *threadDLL, *portDLL;\n+\tvoid *vmDLL, *threadDLL, *portDLL, *zlibDLL;", "originalCommit": "f49f5589860ec427e57197894499ece4c1087393", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "85bd6d109d17b12760185cd638d20d1afc4021fd", "url": "https://github.com/eclipse-openj9/openj9/commit/85bd6d109d17b12760185cd638d20d1afc4021fd", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library available in OpenJ9. In regular world, both library sits in the same directory and when it need to load `libj9zlib` which is required by `libj9jit` it finds it from the previously set path. When we specify the `-XXjitdirectory` option it overwrites the path to load dynamically linked libraries from and JVM fails to start as it can not find `libj9zlib` needed by JIT library. In order to fix this issue, we need to preload `libj9zlib` library before it loads `libj9jit` similarly as we preload other libraries such as `libjvm` .\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-12T16:34:54Z", "type": "forcePushed"}, {"oid": "e1e6a18ee288c9de2428acfc694e22f0ffd2761c", "url": "https://github.com/eclipse-openj9/openj9/commit/e1e6a18ee288c9de2428acfc694e22f0ffd2761c", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm` .\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-12T16:53:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQwOTY2MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r378409661", "bodyText": "This should be void *", "author": "r30shah", "createdAt": "2020-02-12T17:43:00Z", "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -1189,6 +1189,11 @@ preloadLibraries(void)\n \t * location if not preloaded. */\n \tpreloadLibrary(J9_HARMONY_PORT_LIBRARY_SHIM_DLL_NAME, TRUE);\n #endif /* J9VM_OPT_HARMONY */\n+\tvoid zlibDLL = preloadLibrary(J9_ZIP_DLL_NAME, TRUE);", "originalCommit": "e1e6a18ee288c9de2428acfc694e22f0ffd2761c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8cb98240907a757a84c78e370eb99933e5cc75da", "url": "https://github.com/eclipse-openj9/openj9/commit/8cb98240907a757a84c78e370eb99933e5cc75da", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-12T18:33:02Z", "type": "forcePushed"}, {"oid": "8f626392f40240db9ffe4e48a86f896989cfcd24", "url": "https://github.com/eclipse-openj9/openj9/commit/8f626392f40240db9ffe4e48a86f896989cfcd24", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-12T18:34:29Z", "type": "forcePushed"}, {"oid": "c1229e123c2cfcb4442175c3ea3ca6c656d0db3a", "url": "https://github.com/eclipse-openj9/openj9/commit/c1229e123c2cfcb4442175c3ea3ca6c656d0db3a", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-14T14:51:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ5NDk1Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r379494953", "bodyText": "libj9zlib29.so shouldn't be hard coded, use j9zlib or is J9_ZIP_DLL_NAME sufficient?", "author": "pshipton", "createdAt": "2020-02-14T15:33:30Z", "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -1189,6 +1189,14 @@ preloadLibraries(void)\n \t * location if not preloaded. */\n \tpreloadLibrary(J9_HARMONY_PORT_LIBRARY_SHIM_DLL_NAME, TRUE);\n #endif /* J9VM_OPT_HARMONY */\n+\n+#if (defined(S390) && defined(LINUX))\n+\tvoid *zlibDLL = preloadLibrary(J9_ZIP_DLL_NAME, TRUE);\n+\tif (NULL == zlibDLL) {\n+\t\tfprintf(stderr,\"libj9zlib29.so failed to load: %s\\n\", J9_ZIP_DLL_NAME);", "originalCommit": "c1229e123c2cfcb4442175c3ea3ca6c656d0db3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUxMDAzOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r379510039", "bodyText": "libj9zlib29.so shouldn't be hard coded, use j9zlib or is J9_ZIP_DLL_NAME sufficient?\n\nDiscussed offline with @r30shah , the decision is to go with J9_ZIP_DLL_NAME.", "author": "simonameng", "createdAt": "2020-02-14T16:00:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ5NDk1Mw=="}], "type": "inlineReview"}, {"oid": "d0103a6e4b665f5e614e1b20b65c92d2e336d514", "url": "https://github.com/eclipse-openj9/openj9/commit/d0103a6e4b665f5e614e1b20b65c92d2e336d514", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-14T16:06:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU0ODg2NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r379548864", "bodyText": "It would be useful to document why this is only done on Linux on Z and why we are preloading this DLL in the first place as the reason is non-obvious.", "author": "fjeremic", "createdAt": "2020-02-14T17:16:18Z", "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -1189,6 +1189,14 @@ preloadLibraries(void)\n \t * location if not preloaded. */\n \tpreloadLibrary(J9_HARMONY_PORT_LIBRARY_SHIM_DLL_NAME, TRUE);\n #endif /* J9VM_OPT_HARMONY */\n+\n+#if (defined(S390) && defined(LINUX))\n+\tvoid *zlibDLL = preloadLibrary(J9_ZIP_DLL_NAME, TRUE);\n+\tif (NULL == zlibDLL) {\n+\t\tfprintf(stderr,\"Failed to load: %s\\n\", J9_ZIP_DLL_NAME);\n+\t\texit( -1 );\t/* failed */\n+\t}\n+#endif /* defined(S390) && defined(LINUX) */", "originalCommit": "d0103a6e4b665f5e614e1b20b65c92d2e336d514", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "909027c6d2d2b55fb7bf4a1c31505d8523b9dd9a", "url": "https://github.com/eclipse-openj9/openj9/commit/909027c6d2d2b55fb7bf4a1c31505d8523b9dd9a", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to preload `libj9zlib` library before it loads `libj9jit`\nsimilarly as we preload other libraries such as `libjvm`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-14T21:38:07Z", "type": "forcePushed"}, {"oid": "530d10b8fa2143e0ad268d5b5e5274121f65318c", "url": "https://github.com/eclipse-openj9/openj9/commit/530d10b8fa2143e0ad268d5b5e5274121f65318c", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-25T22:16:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2MTUzMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384561533", "bodyText": "Multi-line comments should be consistent with the rest of the codebase. I've also amended the comment slightly to improve the grammar:\n\t\t\t/*\n\t\t\t * On Linux on Z libj9jit dynamically loads libj9zlib as it is used for AOT method data compression\n\t\t\t * which is currently only enabled on Z platform. We want to ensure that when the JVM loads libj9jit,\n\t\t\t * libj9zlib is already loaded. See eclipse/openj9#8561 for more details.\n\t\t\t */", "author": "fjeremic", "createdAt": "2020-02-26T15:20:35Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2844,6 +2844,23 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\tOn Linux on Z it needs to open the libj9zlib to load libj9jit as it is used for AOT method\n+\t\t\tdata compression which is currently only enabled on Z platform. To make sure when JVM loads \n+\t\t\tlibj9jit, libj9zlib is already loaded, we are openning it.\n+\t\t\tFor more details see OpenJ9 PR#8561\n+\t\t\t*/", "originalCommit": "530d10b8fa2143e0ad268d5b5e5274121f65318c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2MTkzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384561930", "bodyText": "Ifdefs should begin at column 0 (no indentation) to be consistent with other ifdefs.", "author": "fjeremic", "createdAt": "2020-02-26T15:21:08Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2844,6 +2844,23 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\tOn Linux on Z it needs to open the libj9zlib to load libj9jit as it is used for AOT method\n+\t\t\tdata compression which is currently only enabled on Z platform. To make sure when JVM loads \n+\t\t\tlibj9jit, libj9zlib is already loaded, we are openning it.\n+\t\t\tFor more details see OpenJ9 PR#8561\n+\t\t\t*/\n+\t\t\t#if (defined(S390) && defined(LINUX))", "originalCommit": "530d10b8fa2143e0ad268d5b5e5274121f65318c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2MjU4NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384562585", "bodyText": "Are we able to use j9str_printf here? See an example 6 lines below. Let's try to be safe by passing the length of the temporary buffer so we don't have buffer overflows here.", "author": "fjeremic", "createdAt": "2020-02-26T15:22:04Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2844,6 +2844,23 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\tOn Linux on Z it needs to open the libj9zlib to load libj9jit as it is used for AOT method\n+\t\t\tdata compression which is currently only enabled on Z platform. To make sure when JVM loads \n+\t\t\tlibj9jit, libj9zlib is already loaded, we are openning it.\n+\t\t\tFor more details see OpenJ9 PR#8561\n+\t\t\t*/\n+\t\t\t#if (defined(S390) && defined(LINUX))\n+\t\t\t\tchar zlibDll[EsMaxPath];\n+\t\t\t\tchar *zlibDllDir = zlibDll;\n+\t\t\t\tstrcpy(zlibDllDir, vm->j9libvmDirectory);\n+\t\t\t\tstrncat(zlibDllDir, DIR_SEPARATOR_STR, sizeof(DIR_SEPARATOR_STR)-1);\n+\t\t\t\tstrncat(zlibDllDir, J9_ZIP_DLL_NAME, sizeof(J9_ZIP_DLL_NAME)-1);", "originalCommit": "530d10b8fa2143e0ad268d5b5e5274121f65318c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2ODc4MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384568781", "bodyText": "please introduce a scope as c89 requires that variables are defined at the top of a scope", "author": "DanHeidinga", "createdAt": "2020-02-26T15:30:19Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2844,6 +2844,23 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\tOn Linux on Z it needs to open the libj9zlib to load libj9jit as it is used for AOT method\n+\t\t\tdata compression which is currently only enabled on Z platform. To make sure when JVM loads \n+\t\t\tlibj9jit, libj9zlib is already loaded, we are openning it.\n+\t\t\tFor more details see OpenJ9 PR#8561\n+\t\t\t*/\n+\t\t\t#if (defined(S390) && defined(LINUX))\n+\t\t\t\tchar zlibDll[EsMaxPath];", "originalCommit": "530d10b8fa2143e0ad268d5b5e5274121f65318c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2OTcwNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384569706", "bodyText": "Please always use opening and closing { & } curly braces for control flow.  It's too easy to indent code that looks like it should be part of the if and isn't if the braces aren't there.", "author": "DanHeidinga", "createdAt": "2020-02-26T15:31:36Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2844,6 +2844,23 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\tOn Linux on Z it needs to open the libj9zlib to load libj9jit as it is used for AOT method\n+\t\t\tdata compression which is currently only enabled on Z platform. To make sure when JVM loads \n+\t\t\tlibj9jit, libj9zlib is already loaded, we are openning it.\n+\t\t\tFor more details see OpenJ9 PR#8561\n+\t\t\t*/\n+\t\t\t#if (defined(S390) && defined(LINUX))\n+\t\t\t\tchar zlibDll[EsMaxPath];\n+\t\t\t\tchar *zlibDllDir = zlibDll;\n+\t\t\t\tstrcpy(zlibDllDir, vm->j9libvmDirectory);\n+\t\t\t\tstrncat(zlibDllDir, DIR_SEPARATOR_STR, sizeof(DIR_SEPARATOR_STR)-1);\n+\t\t\t\tstrncat(zlibDllDir, J9_ZIP_DLL_NAME, sizeof(J9_ZIP_DLL_NAME)-1);\n+\t\t\t\tif (0 != j9sl_open_shared_library(zlibDllDir, &(entry->descriptor), openFlags))", "originalCommit": "530d10b8fa2143e0ad268d5b5e5274121f65318c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3MDExOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384570119", "bodyText": "If the preload fails, shouldn't this return an error and prevent the VM from starting?", "author": "DanHeidinga", "createdAt": "2020-02-26T15:32:15Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2844,6 +2844,23 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\tOn Linux on Z it needs to open the libj9zlib to load libj9jit as it is used for AOT method\n+\t\t\tdata compression which is currently only enabled on Z platform. To make sure when JVM loads \n+\t\t\tlibj9jit, libj9zlib is already loaded, we are openning it.\n+\t\t\tFor more details see OpenJ9 PR#8561\n+\t\t\t*/\n+\t\t\t#if (defined(S390) && defined(LINUX))\n+\t\t\t\tchar zlibDll[EsMaxPath];\n+\t\t\t\tchar *zlibDllDir = zlibDll;\n+\t\t\t\tstrcpy(zlibDllDir, vm->j9libvmDirectory);\n+\t\t\t\tstrncat(zlibDllDir, DIR_SEPARATOR_STR, sizeof(DIR_SEPARATOR_STR)-1);\n+\t\t\t\tstrncat(zlibDllDir, J9_ZIP_DLL_NAME, sizeof(J9_ZIP_DLL_NAME)-1);\n+\t\t\t\tif (0 != j9sl_open_shared_library(zlibDllDir, &(entry->descriptor), openFlags))\n+ \t\t\t\t\tj9tty_printf(PORTLIB, \"Error: Failed to open zlib DLL %s (%s)\\n\", zlibDllDir, j9error_last_error_message());", "originalCommit": "530d10b8fa2143e0ad268d5b5e5274121f65318c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "407d2b7bfff8c149fc48a0b04a5297828c87a1b5", "url": "https://github.com/eclipse-openj9/openj9/commit/407d2b7bfff8c149fc48a0b04a5297828c87a1b5", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-26T15:43:46Z", "type": "forcePushed"}, {"oid": "986aa314b060cef51709e4fd8949dad95861a2ef", "url": "https://github.com/eclipse-openj9/openj9/commit/986aa314b060cef51709e4fd8949dad95861a2ef", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-26T21:12:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzNTQzNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384935434", "bodyText": "where does this memory get freed?  Likely needs to be added at the end of the scope", "author": "DanHeidinga", "createdAt": "2020-02-27T06:32:49Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2843,8 +2843,41 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\t* On Linux on Z libj9jit dynamically loads libj9zlib as it is used for AOT method data compression\n+\t\t\t* which is currently only enabled on Z platform. We want to ensure that when the JVM loads libj9jit,\n+\t\t\t* libj9zlib is already loaded. See eclipse/openj9#8561 for more details.\n+\t\t\t*/\n+#if (defined(S390) && defined(LINUX))\n+\t\t\t{\n+\t\t\tchar zlibDll[EsMaxPath];\n+\t\t\tchar *zlibDllDir = zlibDll;\n+\t\t\tUDATA expectedZlibPathLength = 0;\n+\t\t\tUDATA zlibDllLength = 0;\n+\t\t\tUDATA zlibFileHandle = 0;\n+\t\t\t\n+\t\t\tzlibDllLength = strlen(vm->j9libvmDirectory);\n+\t\t\texpectedZlibPathLength = zlibDllLength + (sizeof(DIR_SEPARATOR_STR) - 1) + strlen(J9_ZIP_DLL_NAME) + 1;\n+\t\t\tif (expectedZlibPathLength > EsMaxPath) {\n+\t\t\t\tzlibDllDir = j9mem_allocate_memory(expectedZlibPathLength, OMRMEM_CATEGORY_VM);", "originalCommit": "986aa314b060cef51709e4fd8949dad95861a2ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzNTk0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384935946", "bodyText": "Vaguely this code to do the free\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t}\n          \n          \n            \n            \t\t\t}\n          \n          \n            \n            \t\t\tif (zlibDllDir != zlibDll) {\n          \n          \n            \n            \t\t\t\tj9_mem_free_memory(zlibDllDir);\n          \n          \n            \n            \t\t\t\tzlibDllDir = NULL;\n          \n          \n            \n            \t\t\t}", "author": "DanHeidinga", "createdAt": "2020-02-27T06:34:22Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2843,8 +2843,41 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\t/*\n+\t\t\t* On Linux on Z libj9jit dynamically loads libj9zlib as it is used for AOT method data compression\n+\t\t\t* which is currently only enabled on Z platform. We want to ensure that when the JVM loads libj9jit,\n+\t\t\t* libj9zlib is already loaded. See eclipse/openj9#8561 for more details.\n+\t\t\t*/\n+#if (defined(S390) && defined(LINUX))\n+\t\t\t{\n+\t\t\tchar zlibDll[EsMaxPath];\n+\t\t\tchar *zlibDllDir = zlibDll;\n+\t\t\tUDATA expectedZlibPathLength = 0;\n+\t\t\tUDATA zlibDllLength = 0;\n+\t\t\tUDATA zlibFileHandle = 0;\n+\t\t\t\n+\t\t\tzlibDllLength = strlen(vm->j9libvmDirectory);\n+\t\t\texpectedZlibPathLength = zlibDllLength + (sizeof(DIR_SEPARATOR_STR) - 1) + strlen(J9_ZIP_DLL_NAME) + 1;\n+\t\t\tif (expectedZlibPathLength > EsMaxPath) {\n+\t\t\t\tzlibDllDir = j9mem_allocate_memory(expectedZlibPathLength, OMRMEM_CATEGORY_VM);\n+\t\t\t\tif (NULL == zlibDllDir) {\n+\t\t\t\t\treturn JNI_ERR;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tj9str_printf(PORTLIB, zlibDllDir, expectedZlibPathLength, \"%s%s%s\",\n+\t\t\t\t\tvm->j9libvmDirectory, DIR_SEPARATOR_STR, J9_ZIP_DLL_NAME);\n+\t\t\tzlibFileHandle = j9sl_open_shared_library(zlibDllDir, &(entry->descriptor), openFlags);\n+\t\t\tif (0 != zlibFileHandle) {\n+\t\t\t\tj9tty_printf(PORTLIB, \"Error: Failed to open zlib DLL %s (%s)\\n\", zlibDllDir, j9error_last_error_message());\n+\t\t\t\treturn JNI_ERR;\n+\t\t\t}", "originalCommit": "986aa314b060cef51709e4fd8949dad95861a2ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzNzEwOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r384937108", "bodyText": "This block of code splits the existing code to calculate the dllCheckPathPtr in half.  It would be better to put the new code immediately after the openFlags = 0 line so the rest of the existing code is kept in a logical block", "author": "DanHeidinga", "createdAt": "2020-02-27T06:38:27Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2843,8 +2843,41 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+", "originalCommit": "986aa314b060cef51709e4fd8949dad95861a2ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f64513e69ec8f8883698e30e01730323d525d247", "url": "https://github.com/eclipse-openj9/openj9/commit/f64513e69ec8f8883698e30e01730323d525d247", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-27T21:17:35Z", "type": "forcePushed"}, {"oid": "a89449f2f40886f87f752cd1906190c63fb59c9c", "url": "https://github.com/eclipse-openj9/openj9/commit/a89449f2f40886f87f752cd1906190c63fb59c9c", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-27T21:19:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUwNDE1Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r385504157", "bodyText": "Shouldn't this be checking and freeing zlibDllDir?", "author": "DanHeidinga", "createdAt": "2020-02-28T04:37:20Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2827,6 +2827,45 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\tUDATA openFlags = (entry->loadFlags & XRUN_LIBRARY) ? J9PORT_SLOPEN_DECORATE | J9PORT_SLOPEN_LAZY : J9PORT_SLOPEN_DECORATE;\n \t\t\tUDATA jitFileHandle = 0;\n \t\t\tUDATA rc = 0;\n+\n+\t\t\t/*\n+\t\t\t* On Linux on Z libj9jit dynamically loads libj9zlib as it is used for AOT method data compression\n+\t\t\t* which is currently only enabled on Z platform. We want to ensure that when the JVM loads libj9jit,\n+\t\t\t* libj9zlib is already loaded. See eclipse/openj9#8561 for more details.\n+\t\t\t*/\n+#if (defined(S390) && defined(LINUX))\n+\t\t\t{\n+\t\t\tchar zlibDll[EsMaxPath];\n+\t\t\tchar *zlibDllDir = zlibDll;\n+\t\t\tUDATA expectedZlibPathLength = 0;\n+\t\t\tUDATA zlibDllLength = 0;\n+\t\t\tUDATA zlibFileHandle = 0;\n+\t\t\tUDATA zlibRC = 0;\n+\t\t\t\n+\t\t\tzlibDllLength = strlen(vm->j9libvmDirectory);\n+\t\t\texpectedZlibPathLength = zlibDllLength + (sizeof(DIR_SEPARATOR_STR) - 1) + strlen(J9_ZIP_DLL_NAME) + 1;\n+\t\t\tif (expectedZlibPathLength > EsMaxPath) {\n+\t\t\t\tzlibDllDir = j9mem_allocate_memory(expectedZlibPathLength, OMRMEM_CATEGORY_VM);\n+\t\t\t\tif (NULL == zlibDllDir) {\n+\t\t\t\t\treturn JNI_ERR;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tj9str_printf(PORTLIB, zlibDllDir, expectedZlibPathLength, \"%s%s%s\",\n+\t\t\t\t\tvm->j9libvmDirectory, DIR_SEPARATOR_STR, J9_ZIP_DLL_NAME);\n+\t\t\tzlibFileHandle = j9sl_open_shared_library(zlibDllDir, &(entry->descriptor), openFlags);\n+\t\t\tif (0 != zlibFileHandle) {\n+\t\t\t\tj9tty_printf(PORTLIB, \"Error: Failed to open zlib DLL %s (%s)\\n\", zlibDllDir, j9error_last_error_message());\n+\t\t\t\tzlibRC = JNI_ERR;\n+\t\t\t}\n+\t\t\tif (dllCheckPath != dllCheckPathPtr) {\n+\t\t\t\tj9mem_free_memory(dllCheckPathPtr);", "originalCommit": "a89449f2f40886f87f752cd1906190c63fb59c9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUwNDI1MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8561#discussion_r385504250", "bodyText": "please remove this and the newline below as they aren't necessary", "author": "DanHeidinga", "createdAt": "2020-02-28T04:37:55Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -2843,8 +2882,10 @@ modifyDllLoadTable(J9JavaVM * vm, J9Pool* loadTable, J9VMInitArgs* j9vm_args)\n \t\t\t\t\treturn JNI_ERR;\n \t\t\t\t}\n \t\t\t}\n+", "originalCommit": "a89449f2f40886f87f752cd1906190c63fb59c9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e48c33912d47113584108850881db71f46a57220", "url": "https://github.com/eclipse-openj9/openj9/commit/e48c33912d47113584108850881db71f46a57220", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-28T15:32:31Z", "type": "commit"}, {"oid": "e48c33912d47113584108850881db71f46a57220", "url": "https://github.com/eclipse-openj9/openj9/commit/e48c33912d47113584108850881db71f46a57220", "message": "Fix '-XXjitdirectory' option on Linux on Z\n\nOn Linux on Z, `libj9jit` library dynamically links the `libj9zlib` library\navailable in OpenJ9. In regular world, both library sits in the same directory\nand when it need to load `libj9zlib` which is required by `libj9jit` it finds\nit from the previously set path. When we specify the `-XXjitdirectory` option\nit overwrites the path to load dynamically linked libraries from and JVM fails\nto start as it can not find `libj9zlib` needed by JIT library. In order to fix\nthis issue, we need to load `libj9zlib` library before it loads `libj9jit`.\n\nSigned-off-by: simonameng <simonameng97@gmail.com>", "committedDate": "2020-02-28T15:32:31Z", "type": "forcePushed"}]}