{"pr_number": 10095, "pr_title": "verbose:module/nomodule option implementation", "pr_createdAt": "2020-07-06T19:55:31Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10095", "timeline": [{"oid": "de71cca307acc92567b3035fa5c10e10a1c75c3a", "url": "https://github.com/eclipse-openj9/openj9/commit/de71cca307acc92567b3035fa5c10e10a1c75c3a", "message": "verbose:module/nomodule option implementation\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-07-06T19:58:43Z", "type": "forcePushed"}, {"oid": "b08ef1cb7509a616a634b0b02b78a498e1da272c", "url": "https://github.com/eclipse-openj9/openj9/commit/b08ef1cb7509a616a634b0b02b78a498e1da272c", "message": "verbose:module/nomodule option implementation\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-08-10T15:36:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODIxMjM2OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10095#discussion_r548212368", "bodyText": "This memory needs to be freed when it doesn't fit into the buffer.", "author": "pshipton", "createdAt": "2020-12-23T20:32:11Z", "path": "runtime/verbose/verbose.c", "diffHunk": "@@ -1333,6 +1360,46 @@ verboseStackMapFrameVerification(J9HookInterface** hook, UDATA eventNum, void* e\n \treleaseVerboseVerificationBuffer(PORTLIB, &buf, byteArray);\n }\n \n+#if (JAVA_SPEC_VERSION >= 11)\n+static void\n+printModule(J9VMThread* vmThread, char* message, J9Module* module)\n+{\n+\tchar moduleNameBuf[J9VM_PACKAGE_NAME_BUFFER_LENGTH];\n+\tchar *moduleNameUTF = NULL;\n+\tJ9UTF8 *jrtURL = NULL;\n+\tchar* template = \"%s: %s from: %.*s\\n\";\n+\n+\tPORT_ACCESS_FROM_VMC(vmThread);\n+\n+\t/* module name */\n+\tmoduleNameUTF = vmThread->javaVM->internalVMFunctions->copyStringToUTF8WithMemAlloc(", "originalCommit": "b08ef1cb7509a616a634b0b02b78a498e1da272c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODIxNDk2OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10095#discussion_r548214969", "bodyText": "I don't understand why this case is needed. It seems the hooks are only registered when VERBOSE_SETTINGS_SET, and registering occurs after parsing all the options, so there is no case when the hooks need to be unregistered. parseVerboseArgumentList() is only called once, and registering the hooks isn't inside a loop.", "author": "pshipton", "createdAt": "2020-12-23T20:35:35Z", "path": "runtime/verbose/verbose.c", "diffHunk": "@@ -1122,6 +1136,19 @@ setVerboseState( J9JavaVM *vm, J9VerboseSettings *verboseOptions, char **errorSt\n \t\tvm->verboseStruct->getCfrExceptionDetails = generateJ9CfrExceptionDetails;\n \t\tvm->verboseStruct->getRtvExceptionDetails = generateJ9RtvExceptionDetails;\n \t}\n+\n+#if (JAVA_SPEC_VERSION >= 11)\n+\tif (VERBOSE_SETTINGS_CLEAR == verboseOptions->module) {", "originalCommit": "b08ef1cb7509a616a634b0b02b78a498e1da272c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODIyMzI3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10095#discussion_r548223272", "bodyText": "We don't need to test all these modes. The code doesn't depend on JIT modes, GC policy, compressed or non-compressed. Testing NoOptions should be sufficient.", "author": "pshipton", "createdAt": "2020-12-23T20:46:30Z", "path": "test/functional/cmdLineTests/verbosetest/playlist.xml", "diffHunk": "@@ -49,4 +49,34 @@\n \t\t\t<impl>ibm</impl>\n \t\t</impls>\n \t</test>\n+\n+\t<test>\n+\t\t<testCaseName>cmdLineTester_verbosetest_11</testCaseName>\n+\t\t<variations>\n+\t\t\t<variation>NoOptions</variation>\n+\t\t\t<variation>Mode501</variation>", "originalCommit": "b08ef1cb7509a616a634b0b02b78a498e1da272c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2d94c21397bdb4648973c53d88a6d5e8ceff5499", "url": "https://github.com/eclipse-openj9/openj9/commit/2d94c21397bdb4648973c53d88a6d5e8ceff5499", "message": "verbose:module/nomodule option implementation\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2021-01-06T17:08:06Z", "type": "forcePushed"}, {"oid": "44b3e7790e4d01035b2f6b021a6158841f632e27", "url": "https://github.com/eclipse-openj9/openj9/commit/44b3e7790e4d01035b2f6b021a6158841f632e27", "message": "verbose:module/nomodule option implementation\n\nSigned-off-by: Theresa Mammarella <tmammare@redhat.com>", "committedDate": "2021-01-06T17:33:18Z", "type": "forcePushed"}, {"oid": "837addf109e4d904019aab5c217f70327eb6191e", "url": "https://github.com/eclipse-openj9/openj9/commit/837addf109e4d904019aab5c217f70327eb6191e", "message": "verbose:module/nomodule option implementation\n\nSigned-off-by: Theresa Mammarella <tmammare@redhat.com>", "committedDate": "2021-01-06T17:37:49Z", "type": "forcePushed"}, {"oid": "ea4cc4ecbe444e557e236b00c774eb79f55003f0", "url": "https://github.com/eclipse-openj9/openj9/commit/ea4cc4ecbe444e557e236b00c774eb79f55003f0", "message": "verbose:module/nomodule option implementation\n\nSigned-off-by: Theresa Mammarella <tmammare@redhat.com>", "committedDate": "2021-01-06T17:39:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg4NTE3MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10095#discussion_r552885170", "bodyText": "Is setting VERBOSE_SETTINGS_IGNORE or VERBOSE_SETTINGS_CLEAR still needed, I don't see these used.", "author": "pshipton", "createdAt": "2021-01-06T18:21:41Z", "path": "runtime/verbose/verbose.c", "diffHunk": "@@ -633,6 +641,12 @@ parseVerboseArgument(char* options, J9VerboseSettings* verboseOptions, char** er\n \t\t\tverboseOptions->relocations = VERBOSE_SETTINGS_SET;\n \t\t} else if(strcmp(options, OPT_ROMCLASS)==0) {\n \t\t\tverboseOptions->romclass = VERBOSE_SETTINGS_SET;\n+#if (JAVA_SPEC_VERSION >= 11)\n+\t\t} else if(strcmp(options, OPT_NOMODULE)==0) {\n+\t\t\tverboseOptions->module = (VERBOSE_SETTINGS_SET == verboseOptions->module) ? VERBOSE_SETTINGS_IGNORE: VERBOSE_SETTINGS_CLEAR;", "originalCommit": "ea4cc4ecbe444e557e236b00c774eb79f55003f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjkxMjIyNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10095#discussion_r552912227", "bodyText": "The reason it's needed for nogc and noclass is to support enabling/disabling verbose output at runtime.\nhttps://docs.oracle.com/javase/8/docs/api/java/lang/management/ClassLoadingMXBean.html#setVerbose-boolean-\nhttps://docs.oracle.com/en/java/javase/11/docs/specs/jvmti.html#SetVerboseFlag", "author": "pshipton", "createdAt": "2021-01-06T19:14:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg4NTE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk4NDAxMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10095#discussion_r552984013", "bodyText": "Thanks I removed that line. The OPT_MODULE input is there so that verbose:nomodule is recognized to match with hotspot.", "author": "theresa-m", "createdAt": "2021-01-06T22:05:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg4NTE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk5MTgxOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10095#discussion_r552991819", "bodyText": "I just meant the line should be simplified, like follows. I don't think your change is correct, the test behavior shouldn't change.\nverboseOptions->module = VERBOSE_SETTINGS_IGNORE;", "author": "pshipton", "createdAt": "2021-01-06T22:16:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg4NTE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk5NDA1OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10095#discussion_r552994058", "bodyText": "hotspot doesn't seem to do anything to disable the module output when both verbose:module and verbose:nomodule are set. Thats likely a mistake though.", "author": "theresa-m", "createdAt": "2021-01-06T22:22:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg4NTE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk5NDQ3MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10095#discussion_r552994471", "bodyText": "I'll add that line back in the simplified state.", "author": "theresa-m", "createdAt": "2021-01-06T22:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg4NTE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk5ODc4Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10095#discussion_r552998786", "bodyText": "-verbose:module,nomodule does do the expected on Hotspot (no module output). I agree -verbose:module -verbose:nomodule showing module output seems like a Hotspot bug.", "author": "pshipton", "createdAt": "2021-01-06T22:35:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg4NTE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwNjgwOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10095#discussion_r553006808", "bodyText": "Updated.", "author": "theresa-m", "createdAt": "2021-01-06T22:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg4NTE3MA=="}], "type": "inlineReview"}, {"oid": "5112b84cea85ffe5226719b145883d2763b482c3", "url": "https://github.com/eclipse-openj9/openj9/commit/5112b84cea85ffe5226719b145883d2763b482c3", "message": "verbose:module/nomodule option implementation\n\nSigned-off-by: Theresa Mammarella <tmammare@redhat.com>", "committedDate": "2021-01-06T22:03:24Z", "type": "forcePushed"}, {"oid": "a56a38a3d4a0dd6c67e224ced5a34a0de69b3ad7", "url": "https://github.com/eclipse-openj9/openj9/commit/a56a38a3d4a0dd6c67e224ced5a34a0de69b3ad7", "message": "verbose:module/nomodule option implementation\n\nSigned-off-by: Theresa Mammarella <tmammare@redhat.com>", "committedDate": "2021-01-06T22:58:33Z", "type": "commit"}, {"oid": "a56a38a3d4a0dd6c67e224ced5a34a0de69b3ad7", "url": "https://github.com/eclipse-openj9/openj9/commit/a56a38a3d4a0dd6c67e224ced5a34a0de69b3ad7", "message": "verbose:module/nomodule option implementation\n\nSigned-off-by: Theresa Mammarella <tmammare@redhat.com>", "committedDate": "2021-01-06T22:58:33Z", "type": "forcePushed"}]}