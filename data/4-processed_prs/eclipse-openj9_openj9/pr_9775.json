{"pr_number": 9775, "pr_title": "Enable using Level 1 data cache on RISC-V specific hardware", "pr_createdAt": "2020-06-02T21:02:53Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9775", "timeline": [{"oid": "390648f90b43c35d82ff36b4763c487358972945", "url": "https://github.com/eclipse-openj9/openj9/commit/390648f90b43c35d82ff36b4763c487358972945", "message": "Enable using L1 data cache on RISC-V specific hardware\n\nThe change is to enable the L1 data cache (no support\non the emulator) on the hardware to ensure it works\nappropriately after setup.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-06T00:45:06Z", "type": "forcePushed"}, {"oid": "4b2c869e0662aa576fa6840859752f56b8165b31", "url": "https://github.com/eclipse-openj9/openj9/commit/4b2c869e0662aa576fa6840859752f56b8165b31", "message": "Enable using L1 data cache on RISC-V specific hardware\n\nThe change is to enable the L1 data cache (no support\non the emulator) on the hardware to ensure it works\nappropriately after setup.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-08T17:24:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg3NDQzMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9775#discussion_r436874431", "bodyText": "Please add comments here and on #endif: /* defined(RISCV64) */.", "author": "keithc-ca", "createdAt": "2020-06-08T17:28:46Z", "path": "runtime/tests/port/si.c", "diffHunk": "@@ -2183,9 +2183,17 @@ j9sysinfo_test_get_l1dcache_line_size(struct J9PortLibrary *portLibrary)\n \tcQuery.level = 1;\n \tcQuery.cacheType = J9PORT_CACHEINFO_DCACHE;\n \trc = j9sysinfo_get_cache_info(&cQuery);\n-#if !(defined(J9ARM) || defined(RISCV64))\n+#if !(defined(J9ARM))\n \tif (rc < 0) {\n+#if defined(RISCV64)\n+\t\toutputComment(PORTLIB, \"j9sysinfo_get_cache_info is not supported on this platform\\n\");\n+\t\tif (J9PORT_ERROR_SYSINFO_NOT_SUPPORTED != rc) {\n+\t\t\toutputErrorMessage(PORTTEST_ERROR_ARGS, \"j9sysinfo_get_cache_info should have returned %d but returned %d\\n\", \n+\t\t\t\tJ9PORT_ERROR_SYSINFO_NOT_SUPPORTED, rc);\n+\t\t}\n+#else", "originalCommit": "4b2c869e0662aa576fa6840859752f56b8165b31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg3OTQzNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9775#discussion_r436879437", "bodyText": "Added as suggested above.", "author": "ChengJin01", "createdAt": "2020-06-08T17:36:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg3NDQzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg3NDY0OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9775#discussion_r436874649", "bodyText": "Please remove the unnecessary pareentheses.", "author": "keithc-ca", "createdAt": "2020-06-08T17:29:07Z", "path": "runtime/tests/port/si.c", "diffHunk": "@@ -2183,9 +2183,17 @@ j9sysinfo_test_get_l1dcache_line_size(struct J9PortLibrary *portLibrary)\n \tcQuery.level = 1;\n \tcQuery.cacheType = J9PORT_CACHEINFO_DCACHE;\n \trc = j9sysinfo_get_cache_info(&cQuery);\n-#if !(defined(J9ARM) || defined(RISCV64))\n+#if !(defined(J9ARM))", "originalCommit": "4b2c869e0662aa576fa6840859752f56b8165b31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg3OTUyNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9775#discussion_r436879525", "bodyText": "Fixed.", "author": "ChengJin01", "createdAt": "2020-06-08T17:37:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg3NDY0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg3NTQwOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9775#discussion_r436875408", "bodyText": "Please update the comment to match the #if condition and restore the spaces (here and on the #endif).\n#else /* !defined(J9ARM) */", "author": "keithc-ca", "createdAt": "2020-06-08T17:30:22Z", "path": "runtime/tests/port/si.c", "diffHunk": "@@ -2199,13 +2207,13 @@ j9sysinfo_test_get_l1dcache_line_size(struct J9PortLibrary *portLibrary)\n \t\t\t\t\tl1DcacheSize, rc);\n \t\t}\n \t}\n-#else /* !(defined(J9ARM) || defined(RISCV64)) */\n+#else /*!(defined(J9ARM))*/", "originalCommit": "4b2c869e0662aa576fa6840859752f56b8165b31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg3OTU2Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9775#discussion_r436879567", "bodyText": "Fixed.", "author": "ChengJin01", "createdAt": "2020-06-08T17:37:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg3NTQwOA=="}], "type": "inlineReview"}, {"oid": "673481b287e61194c96f0daa89d0e813450870fd", "url": "https://github.com/eclipse-openj9/openj9/commit/673481b287e61194c96f0daa89d0e813450870fd", "message": "Enable using L1 data cache on RISC-V specific hardware\n\nThe change is to enable the L1 data cache (no support\non the emulator) on the hardware to ensure it works\nappropriately after setup.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-08T17:36:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4MjE0Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9775#discussion_r436882142", "bodyText": "This deserves a comment too (/* defined(RISCV64) */) - I should have mentioned it in the previous review.", "author": "keithc-ca", "createdAt": "2020-06-08T17:41:45Z", "path": "runtime/port/unix/j9sysinfo.c", "diffHunk": "@@ -1719,6 +1719,17 @@ j9sysinfo_get_cache_info(struct J9PortLibrary *portLibrary, const J9CacheInfoQue\n \tcase J9PORT_CACHEINFO_QUERY_LINESIZE:\n \tcase J9PORT_CACHEINFO_QUERY_CACHESIZE:\n \t\tresult =  getCacheSize(portLibrary, query->cpu, query->level, query->cacheType, query->cmd);\n+\n+#if defined(RISCV64)\n+\t/* The L1 data cache at \"cache/index1\" is set up from \"/sys/devices/system/cpu/cpu1\" on some Linux distro\n+\t * (e.g. Debian_riscv) rather than \"/sys/devices/system/cpu/cpu0\" in which \"cache/index1\" doesn't exist.\n+\t * Note: this is a temporary solution specific to Debian_riscv which won't be used or simply\n+\t * removed once we confirm \"cpu0/cache/index1\" does exist on the latest version of Debian_riscv.\n+\t */\n+\tif (result < 0) {\n+\t\tresult =  getCacheSize(portLibrary, query->cpu + 1, query->level, query->cacheType, query->cmd);\n+\t}\n+#endif", "originalCommit": "673481b287e61194c96f0daa89d0e813450870fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4NDUzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9775#discussion_r436884535", "bodyText": "Fixed.", "author": "ChengJin01", "createdAt": "2020-06-08T17:46:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4MjE0Mg=="}], "type": "inlineReview"}, {"oid": "24242e7b434dd4cfa67aa74ae046852a69a6c296", "url": "https://github.com/eclipse-openj9/openj9/commit/24242e7b434dd4cfa67aa74ae046852a69a6c296", "message": "Enable using L1 data cache on RISC-V specific hardware\n\nThe change is to enable the L1 data cache (no support\non the emulator) on the hardware to ensure it works\nappropriately after setup.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-08T17:45:27Z", "type": "commit"}, {"oid": "24242e7b434dd4cfa67aa74ae046852a69a6c296", "url": "https://github.com/eclipse-openj9/openj9/commit/24242e7b434dd4cfa67aa74ae046852a69a6c296", "message": "Enable using L1 data cache on RISC-V specific hardware\n\nThe change is to enable the L1 data cache (no support\non the emulator) on the hardware to ensure it works\nappropriately after setup.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-08T17:45:27Z", "type": "forcePushed"}]}