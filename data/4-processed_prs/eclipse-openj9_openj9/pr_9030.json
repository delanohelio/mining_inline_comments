{"pr_number": 9030, "pr_title": "IL Generation for defaultvalue bytecode instruction", "pr_createdAt": "2020-03-31T01:49:36Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9030", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY1MzMxNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9030#discussion_r401653315", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tcase 'Q':\n          \n          \n            \n            \t\t\tcase 'L': next = J9_NATIVE_TYPE_OBJECT; break;\n          \n          \n            \n            \t\t\tcase 'Q': /* FALLTHROUGH */\n          \n          \n            \n            \t\t\tcase 'L': next = J9_NATIVE_TYPE_OBJECT; break;", "author": "DanHeidinga", "createdAt": "2020-04-01T14:21:14Z", "path": "runtime/jit_vm/ctsupport.cpp", "diffHunk": "@@ -202,6 +202,7 @@ jitParseSignature (const J9UTF8 *signature, U_8 *paramBuffer, UDATA *paramElemen\n \t\t\tstate = returnValue;\n \t\t} else {\n \t\t\tswitch (*sigChar) {\n+\t\t\tcase 'Q':\n \t\t\tcase 'L': next = J9_NATIVE_TYPE_OBJECT; break;", "originalCommit": "b9a23471bc975f5e2a458fa276b0e8a6d73d9665", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY1Mzg3MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9030#discussion_r401653870", "bodyText": "It's a minor thing but we try to label all fall throughs explicitly so that future refactoring doesn't mess up the logic", "author": "DanHeidinga", "createdAt": "2020-04-01T14:21:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY1MzMxNQ=="}], "type": "inlineReview"}, {"oid": "79d5737f576f71b23feb7b26c750e43ec478a4dc", "url": "https://github.com/eclipse-openj9/openj9/commit/79d5737f576f71b23feb7b26c750e43ec478a4dc", "message": "Prototype ILGen for defaultvalue bytecode\n\nFor a defaultvalue bytecode, if the class is resolved, generate a\nnewvalue instruction with default values for the fields as operands.\nRecursively generate a newvalue for any fields that are themselves\nvalue types.\n\nThe JIT compiler is not yet able to handle the case of an unresolved\nclass used in a defaultvalue bytecode instruction.  Simply fail the\ncompilation during ILGen if an unresolved class is encountered in that\nsituation.  The failure is reported as an\nUnsupportedValueTypeOperation exception.  The intention is that these\ncan be replaced with OSR points in the future.\n\nIn order to track the frequency with which we are failing compilations\ndue to encountering unresolved classes during IL generation for the\ndefaultvalue bytecode, use static debug counters that begin with\nthe string \"ilgen.abort/unresolved/defaultvalue\".\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>", "committedDate": "2020-04-01T18:46:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MjU5OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9030#discussion_r401842599", "bodyText": "Minor nitpick:  We usually avoid // comments in vm code even though they'll compile on all platforms in c++\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            // VALHALLA_TODO:  Need to return a J9_NATIVE_TYPE_VALUE for 'Q' in future\n          \n          \n            \n            \t\t\tcase 'Q': /* FALLTHROUGH */\n          \n          \n            \n            \t\t\tcase 'Q': \n          \n          \n            \n            \t\t\t\t/* VALHALLA_TODO:  Need to return a J9_NATIVE_TYPE_VALUE for 'Q' in future */\n          \n          \n            \n            \t\t\t\t/* FALLTHROUGH */", "author": "DanHeidinga", "createdAt": "2020-04-01T19:02:55Z", "path": "runtime/jit_vm/ctsupport.cpp", "diffHunk": "@@ -202,6 +202,8 @@ jitParseSignature (const J9UTF8 *signature, U_8 *paramBuffer, UDATA *paramElemen\n \t\t\tstate = returnValue;\n \t\t} else {\n \t\t\tswitch (*sigChar) {\n+// VALHALLA_TODO:  Need to return a J9_NATIVE_TYPE_VALUE for 'Q' in future\n+\t\t\tcase 'Q': /* FALLTHROUGH */", "originalCommit": "3035978a9c3537369135101af6f1a232a4316e05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1NDUzMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9030#discussion_r401854533", "bodyText": "Minor nitpick: We usually avoid // comments in vm code even though they'll compile on all platforms in c++\n\nSorry!  I should have read the coding standards before submitting these changes.", "author": "hzongaro", "createdAt": "2020-04-01T19:24:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MjU5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MzAzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9030#discussion_r401843035", "bodyText": "Should this Q have a similar comment added?", "author": "DanHeidinga", "createdAt": "2020-04-01T19:03:45Z", "path": "runtime/compiler/env/J9ClassEnv.cpp", "diffHunk": "@@ -449,7 +449,8 @@ J9::ClassEnv::enumerateFields(TR::Region& region, TR_OpaqueClassBlock * opaqueCl\n             dataType = TR::Double;\n             break;\n             }\n-         case 'L': \n+         case 'L':\n+         case 'Q':", "originalCommit": "3035978a9c3537369135101af6f1a232a4316e05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2MDg3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9030#discussion_r401860872", "bodyText": "Sorry about the churn!  I inadvertently pushed my changes that time before I was ready.", "author": "hzongaro", "createdAt": "2020-04-01T19:36:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MzAzNQ=="}], "type": "inlineReview"}, {"oid": "2af5c522e64c8f873dc1dff34a0d59390fbb8444", "url": "https://github.com/eclipse-openj9/openj9/commit/2af5c522e64c8f873dc1dff34a0d59390fbb8444", "message": "Prototype ILGen for defaultvalue bytecode\n\nFor a defaultvalue bytecode, if the class is resolved, generate a\nnewvalue instruction with default values for the fields as operands.\nRecursively generate a newvalue for any fields that are themselves\nvalue types.\n\nThe JIT compiler is not yet able to handle the case of an unresolved\nclass used in a defaultvalue bytecode instruction.  Simply fail the\ncompilation during ILGen if an unresolved class is encountered in that\nsituation.  The failure is reported as an\nUnsupportedValueTypeOperation exception.  The intention is that these\ncan be replaced with OSR points in the future.\n\nIn order to track the frequency with which we are failing compilations\ndue to encountering unresolved classes during IL generation for the\ndefaultvalue bytecode, use static debug counters that begin with\nthe string \"ilgen.abort/unresolved/defaultvalue\".\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>", "committedDate": "2020-04-01T19:05:55Z", "type": "forcePushed"}, {"oid": "4ee52776a8d558c3cc5035146d868a5bb9fbcce3", "url": "https://github.com/eclipse-openj9/openj9/commit/4ee52776a8d558c3cc5035146d868a5bb9fbcce3", "message": "Check for Q as prefix for value type classes\n\nThe experimental value types support uses the letter Q before the class\nname for a value type class.  This change handles the following cases:\n\n1) In building a TR:TypeLayout in J9ClassEnv.cpp, treat a field that\n   has Q before a class name as being of type TR::Address.\n\n2) The code in TR_J9VM::getClassFromSignature strips off any leading 'L'\n   and trailing semicolon from the signature string for a class that it\n   is looking up.  For value types, it also needs to strip off any\n   leading 'Q'.\n\n3) In jitParseSignature in ctsupport.cpp, allow for the letter Q before\n   a class name in parsing signatures.\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>", "committedDate": "2020-04-01T19:28:47Z", "type": "commit"}, {"oid": "c34da9ec317791a4733b51daf927311507d49f01", "url": "https://github.com/eclipse-openj9/openj9/commit/c34da9ec317791a4733b51daf927311507d49f01", "message": "Prototype ILGen for defaultvalue bytecode\n\nFor a defaultvalue bytecode, if the class is resolved, generate a\nnewvalue instruction with default values for the fields as operands.\nRecursively generate a newvalue for any fields that are themselves\nvalue types.\n\nThe JIT compiler is not yet able to handle the case of an unresolved\nclass used in a defaultvalue bytecode instruction.  Simply fail the\ncompilation during ILGen if an unresolved class is encountered in that\nsituation.  The failure is reported as an\nUnsupportedValueTypeOperation exception.  The intention is that these\ncan be replaced with OSR points in the future.\n\nIn order to track the frequency with which we are failing compilations\ndue to encountering unresolved classes during IL generation for the\ndefaultvalue bytecode, use static debug counters that begin with\nthe string \"ilgen.abort/unresolved/defaultvalue\".\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>", "committedDate": "2020-04-01T19:28:54Z", "type": "commit"}, {"oid": "c34da9ec317791a4733b51daf927311507d49f01", "url": "https://github.com/eclipse-openj9/openj9/commit/c34da9ec317791a4733b51daf927311507d49f01", "message": "Prototype ILGen for defaultvalue bytecode\n\nFor a defaultvalue bytecode, if the class is resolved, generate a\nnewvalue instruction with default values for the fields as operands.\nRecursively generate a newvalue for any fields that are themselves\nvalue types.\n\nThe JIT compiler is not yet able to handle the case of an unresolved\nclass used in a defaultvalue bytecode instruction.  Simply fail the\ncompilation during ILGen if an unresolved class is encountered in that\nsituation.  The failure is reported as an\nUnsupportedValueTypeOperation exception.  The intention is that these\ncan be replaced with OSR points in the future.\n\nIn order to track the frequency with which we are failing compilations\ndue to encountering unresolved classes during IL generation for the\ndefaultvalue bytecode, use static debug counters that begin with\nthe string \"ilgen.abort/unresolved/defaultvalue\".\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>", "committedDate": "2020-04-01T19:28:54Z", "type": "forcePushed"}]}