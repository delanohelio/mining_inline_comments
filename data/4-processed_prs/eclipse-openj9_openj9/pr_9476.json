{"pr_number": 9476, "pr_title": "Add cmdline opts to toggle array flattening", "pr_createdAt": "2020-05-06T16:27:32Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9476", "timeline": [{"oid": "5445466a75e5817a15a7c7962d1722ca4e4cdf4d", "url": "https://github.com/eclipse-openj9/openj9/commit/5445466a75e5817a15a7c7962d1722ca4e4cdf4d", "message": "Add cmdline opts to toggle array flattening\n\nDefault is is array flattening disable.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-05-06T16:27:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NjU3MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9476#discussion_r420996571", "bodyText": "What's the consequence of this change? Is this a bug fix rolled into this PR?", "author": "gacholio", "createdAt": "2020-05-06T18:17:44Z", "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -2901,14 +2907,15 @@ internalCreateRAMClassFromROMClassImpl(J9VMThread *vmThread, J9ClassLoader *clas\n \t\t\t\t\t * properties from the leafComponentType. A 2D array is an array of references so it can never be flattened, however, its\n \t\t\t\t\t * elements may be flattened arrays.\n \t\t\t\t\t */\n-\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & (J9ClassIsFlattened | J9ClassLargestAlignmentConstraintReference | J9ClassLargestAlignmentConstraintDouble));\n+\t\t\t\t\tramArrayClass->classFlags |= (elementClass->classFlags & arrayFlags);\n+\n \t\t\t\t}\n \t\t\t\tramArrayClass->leafComponentType = leafComponentType;\n \t\t\t\tramArrayClass->arity = arity;\n \t\t\t\tramArrayClass->componentType = elementClass;\n \t\t\t\tramArrayClass->module = leafComponentType->module;\n \n-\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(elementClass)) {\n+\t\t\t\tif (J9_IS_J9CLASS_FLATTENED(ramArrayClass)) {", "originalCommit": "5445466a75e5817a15a7c7962d1722ca4e4cdf4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAwMjIwNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9476#discussion_r421002205", "bodyText": "I think I see - previously the element determined if the array was flattened.", "author": "gacholio", "createdAt": "2020-05-06T18:27:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NjU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAwNDEyNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9476#discussion_r421004126", "bodyText": "Does there need to be a check for the element type being a VT?", "author": "gacholio", "createdAt": "2020-05-06T18:30:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NjU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAxNjUxMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9476#discussion_r421016513", "bodyText": "previously the element determined if the array was flattened.\n\nYes this code was technically wrong before but there was no impact since prior to this change the element determined if the array is flattened or not.\nSince flattening or array/element will now be done independently, one must only look at the array flags.\n\nDoes there need to be a check for the element type being a VT?\n\nFor a singleton type, being a VT is a prerequisite of flattening. So J9_IS_J9CLASS_FLATTENED(elementClass) == TRUE implies VT. Arrays cannot be VTs, only singleton types, so J9_IS_J9CLASS_FLATTENED(ramArrayClass) == TRUE implies that elementType is flattened and also a VT.", "author": "tajila", "createdAt": "2020-05-06T18:50:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NjU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyODE2NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9476#discussion_r421028164", "bodyText": "Short answer is I dont think there needs to be a VT check here, since its implied with the flattening check", "author": "tajila", "createdAt": "2020-05-06T19:10:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NjU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzMDk2OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9476#discussion_r421030968", "bodyText": "I wasn't clear - it looks like all arrays will get the flattened flag if the new option is set, which seems incorrect.", "author": "gacholio", "createdAt": "2020-05-06T19:15:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NjU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzMzI3MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9476#discussion_r421033270", "bodyText": "Ah, arrayFlags is a mask - I read it as being assigned to the flags.", "author": "gacholio", "createdAt": "2020-05-06T19:19:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NjU3MQ=="}], "type": "inlineReview"}, {"oid": "0dd1369c70f505e54737e89175623fd3b5ef2d12", "url": "https://github.com/eclipse-openj9/openj9/commit/0dd1369c70f505e54737e89175623fd3b5ef2d12", "message": "Add cmdline opts to toggle array flattening\n\nDefault is is array flattening disable.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-05-06T20:44:06Z", "type": "commit"}, {"oid": "0dd1369c70f505e54737e89175623fd3b5ef2d12", "url": "https://github.com/eclipse-openj9/openj9/commit/0dd1369c70f505e54737e89175623fd3b5ef2d12", "message": "Add cmdline opts to toggle array flattening\n\nDefault is is array flattening disable.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-05-06T20:44:06Z", "type": "forcePushed"}]}