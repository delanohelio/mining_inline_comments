{"pr_number": 8460, "pr_title": "Support for CP String patching", "pr_createdAt": "2020-01-30T17:51:20Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8460", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEzNzQ4OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8460#discussion_r373137488", "bodyText": "compilation error:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            }\n          \n          \n            \n            } J9ClassPatchMap;", "author": "babsingh", "createdAt": "2020-01-30T19:07:06Z", "path": "runtime/oti/j9nonbuilder.h", "diffHunk": "@@ -1957,6 +1958,11 @@ typedef struct J9ClassPathEntry {\n #endif\n } J9ClassPathEntry;\n \n+typedef struct J9ClassPatchMap {\n+\tU_16 size;\n+\tU_16* indexMap;\n+}", "originalCommit": "dad92bb98e2554102d78fc4d8e7b430635a1553a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1e4f06080dbc668570b8a4380fb557dadbb51f30", "url": "https://github.com/eclipse-openj9/openj9/commit/1e4f06080dbc668570b8a4380fb557dadbb51f30", "message": "Initial commit for CP String patching\n\nSigned-off-by: Jack Lu <Jack.S.Lu@ibm.com>", "committedDate": "2020-01-30T20:17:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4ODMyNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8460#discussion_r373188327", "bodyText": "copyright update not required; file hasn't been edited.", "author": "babsingh", "createdAt": "2020-01-30T20:54:57Z", "path": "runtime/bcutil/defineclass.c", "diffHunk": "@@ -1,5 +1,5 @@\n /*******************************************************************************\n- * Copyright (c) 1991, 2019 IBM Corp. and others\n+ * Copyright (c) 1991, 2020 IBM Corp. and others", "originalCommit": "1e4f06080dbc668570b8a4380fb557dadbb51f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4ODY5Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8460#discussion_r373188697", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tif (patchMap != NULL && patchMap->size != 0) {\n          \n          \n            \n            \tif ((patchMap != NULL) && (patchMap->size != 0)) {", "author": "babsingh", "createdAt": "2020-01-30T20:55:47Z", "path": "runtime/jcl/common/jcldefine.c", "diffHunk": "@@ -70,6 +70,10 @@ defineClassCommon(JNIEnv *env, jobject classLoaderObject,\n \t\tgoto done;\n \t}\n \n+\tif (patchMap != NULL && patchMap->size != 0) {", "originalCommit": "1e4f06080dbc668570b8a4380fb557dadbb51f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4ODk0Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8460#discussion_r373188947", "bodyText": "may be use a macro for constant 128.", "author": "babsingh", "createdAt": "2020-01-30T20:56:20Z", "path": "runtime/jcl/common/sun_misc_Unsafe.cpp", "diffHunk": "@@ -96,19 +93,57 @@ Java_sun_misc_Unsafe_defineAnonymousClass(JNIEnv *env, jobject receiver, jclass\n \t\thostClassLoader = vm->systemClassLoader->classLoaderObject;\n \t}\n \tjobject hostClassLoaderLocalRef = vmFuncs->j9jni_createLocalRef(env, hostClassLoader);\n+\n+\tJ9ClassPatchMap cpPatchMap = {0, NULL};\n+\tj9array_t patchArray = NULL;\n+\tPORT_ACCESS_FROM_ENV(env);\n+\n+\tU_16 indexMap[128];", "originalCommit": "1e4f06080dbc668570b8a4380fb557dadbb51f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4OTIzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8460#discussion_r373189230", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tcpPatchMap.indexMap = (U_16*)j9mem_allocate_memory(cpPatchMap.size * sizeof(U_16), J9MEM_CATEGORY_VM);\n          \n          \n            \n            \t\t\tcpPatchMap.indexMap = (U_16 *)j9mem_allocate_memory(cpPatchMap.size * sizeof(U_16), J9MEM_CATEGORY_VM);", "author": "babsingh", "createdAt": "2020-01-30T20:56:47Z", "path": "runtime/jcl/common/sun_misc_Unsafe.cpp", "diffHunk": "@@ -96,19 +93,57 @@ Java_sun_misc_Unsafe_defineAnonymousClass(JNIEnv *env, jobject receiver, jclass\n \t\thostClassLoader = vm->systemClassLoader->classLoaderObject;\n \t}\n \tjobject hostClassLoaderLocalRef = vmFuncs->j9jni_createLocalRef(env, hostClassLoader);\n+\n+\tJ9ClassPatchMap cpPatchMap = {0, NULL};\n+\tj9array_t patchArray = NULL;\n+\tPORT_ACCESS_FROM_ENV(env);\n+\n+\tU_16 indexMap[128];\n+\tif (constPatches != NULL) {\n+\t\tpatchArray = (j9array_t)J9_JNI_UNWRAP_REFERENCE(constPatches);\n+\t\tcpPatchMap.size = (U_16)J9INDEXABLEOBJECT_SIZE(currentThread, patchArray);\n+\t\tif (cpPatchMap.size <= 128) {\n+\t\t\tcpPatchMap.indexMap = indexMap;\n+\t\t} else {\n+\t\t\tcpPatchMap.indexMap = (U_16*)j9mem_allocate_memory(cpPatchMap.size * sizeof(U_16), J9MEM_CATEGORY_VM);", "originalCommit": "1e4f06080dbc668570b8a4380fb557dadbb51f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4OTM4NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8460#discussion_r373189385", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tJ9Class * clazz = J9VM_J9CLASS_FROM_HEAPCLASS(currentThread, J9_JNI_UNWRAP_REFERENCE(anonClass));\n          \n          \n            \n            \t\tJ9Class *clazz = J9VM_J9CLASS_FROM_HEAPCLASS(currentThread, J9_JNI_UNWRAP_REFERENCE(anonClass));", "author": "babsingh", "createdAt": "2020-01-30T20:57:02Z", "path": "runtime/jcl/common/sun_misc_Unsafe.cpp", "diffHunk": "@@ -96,19 +93,57 @@ Java_sun_misc_Unsafe_defineAnonymousClass(JNIEnv *env, jobject receiver, jclass\n \t\thostClassLoader = vm->systemClassLoader->classLoaderObject;\n \t}\n \tjobject hostClassLoaderLocalRef = vmFuncs->j9jni_createLocalRef(env, hostClassLoader);\n+\n+\tJ9ClassPatchMap cpPatchMap = {0, NULL};\n+\tj9array_t patchArray = NULL;\n+\tPORT_ACCESS_FROM_ENV(env);\n+\n+\tU_16 indexMap[128];\n+\tif (constPatches != NULL) {\n+\t\tpatchArray = (j9array_t)J9_JNI_UNWRAP_REFERENCE(constPatches);\n+\t\tcpPatchMap.size = (U_16)J9INDEXABLEOBJECT_SIZE(currentThread, patchArray);\n+\t\tif (cpPatchMap.size <= 128) {\n+\t\t\tcpPatchMap.indexMap = indexMap;\n+\t\t} else {\n+\t\t\tcpPatchMap.indexMap = (U_16*)j9mem_allocate_memory(cpPatchMap.size * sizeof(U_16), J9MEM_CATEGORY_VM);\n+\t\t}\n+\t}\n+\n \tvmFuncs->internalExitVMToJNI(currentThread);\n \n \tjsize length = env->GetArrayLength(bytecodes);\n \n \t/* acquires access internally */\n-\tjclass anonClass = defineClassCommon(env, hostClassLoaderLocalRef, NULL,bytecodes, 0, length, protectionDomainLocalRef, J9_FINDCLASS_FLAG_UNSAFE | J9_FINDCLASS_FLAG_ANON, hostClazz);\n+\tjclass anonClass = defineClassCommon(env, hostClassLoaderLocalRef, NULL,bytecodes, 0, length, protectionDomainLocalRef, J9_FINDCLASS_FLAG_UNSAFE | J9_FINDCLASS_FLAG_ANON, hostClazz, &cpPatchMap);\n \tif (env->ExceptionCheck()) {\n \t\treturn NULL;\n \t} else if (NULL == anonClass) {\n \t\tthrowNewInternalError(env, NULL);\n \t\treturn NULL;\n \t}\n \n+\tif (constPatches != NULL) {\n+\t\tvmFuncs->internalEnterVMFromJNI(currentThread);\n+\t\tJ9Class * clazz = J9VM_J9CLASS_FROM_HEAPCLASS(currentThread, J9_JNI_UNWRAP_REFERENCE(anonClass));", "originalCommit": "1e4f06080dbc668570b8a4380fb557dadbb51f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4OTQ1NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8460#discussion_r373189454", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tU_32 * cpShapeDescription = J9ROMCLASS_CPSHAPEDESCRIPTION(clazz->romClass);\n          \n          \n            \n            \t\tU_32 *cpShapeDescription = J9ROMCLASS_CPSHAPEDESCRIPTION(clazz->romClass);", "author": "babsingh", "createdAt": "2020-01-30T20:57:12Z", "path": "runtime/jcl/common/sun_misc_Unsafe.cpp", "diffHunk": "@@ -96,19 +93,57 @@ Java_sun_misc_Unsafe_defineAnonymousClass(JNIEnv *env, jobject receiver, jclass\n \t\thostClassLoader = vm->systemClassLoader->classLoaderObject;\n \t}\n \tjobject hostClassLoaderLocalRef = vmFuncs->j9jni_createLocalRef(env, hostClassLoader);\n+\n+\tJ9ClassPatchMap cpPatchMap = {0, NULL};\n+\tj9array_t patchArray = NULL;\n+\tPORT_ACCESS_FROM_ENV(env);\n+\n+\tU_16 indexMap[128];\n+\tif (constPatches != NULL) {\n+\t\tpatchArray = (j9array_t)J9_JNI_UNWRAP_REFERENCE(constPatches);\n+\t\tcpPatchMap.size = (U_16)J9INDEXABLEOBJECT_SIZE(currentThread, patchArray);\n+\t\tif (cpPatchMap.size <= 128) {\n+\t\t\tcpPatchMap.indexMap = indexMap;\n+\t\t} else {\n+\t\t\tcpPatchMap.indexMap = (U_16*)j9mem_allocate_memory(cpPatchMap.size * sizeof(U_16), J9MEM_CATEGORY_VM);\n+\t\t}\n+\t}\n+\n \tvmFuncs->internalExitVMToJNI(currentThread);\n \n \tjsize length = env->GetArrayLength(bytecodes);\n \n \t/* acquires access internally */\n-\tjclass anonClass = defineClassCommon(env, hostClassLoaderLocalRef, NULL,bytecodes, 0, length, protectionDomainLocalRef, J9_FINDCLASS_FLAG_UNSAFE | J9_FINDCLASS_FLAG_ANON, hostClazz);\n+\tjclass anonClass = defineClassCommon(env, hostClassLoaderLocalRef, NULL,bytecodes, 0, length, protectionDomainLocalRef, J9_FINDCLASS_FLAG_UNSAFE | J9_FINDCLASS_FLAG_ANON, hostClazz, &cpPatchMap);\n \tif (env->ExceptionCheck()) {\n \t\treturn NULL;\n \t} else if (NULL == anonClass) {\n \t\tthrowNewInternalError(env, NULL);\n \t\treturn NULL;\n \t}\n \n+\tif (constPatches != NULL) {\n+\t\tvmFuncs->internalEnterVMFromJNI(currentThread);\n+\t\tJ9Class * clazz = J9VM_J9CLASS_FROM_HEAPCLASS(currentThread, J9_JNI_UNWRAP_REFERENCE(anonClass));\n+\n+\t\tj9object_t item = NULL;\n+\t\tU_32 * cpShapeDescription = J9ROMCLASS_CPSHAPEDESCRIPTION(clazz->romClass);", "originalCommit": "1e4f06080dbc668570b8a4380fb557dadbb51f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4OTU0NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8460#discussion_r373189545", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tJ9ConstantPool * ramCP = J9_CP_FROM_CLASS(clazz);\n          \n          \n            \n            \t\tJ9ConstantPool *ramCP = J9_CP_FROM_CLASS(clazz);", "author": "babsingh", "createdAt": "2020-01-30T20:57:22Z", "path": "runtime/jcl/common/sun_misc_Unsafe.cpp", "diffHunk": "@@ -96,19 +93,57 @@ Java_sun_misc_Unsafe_defineAnonymousClass(JNIEnv *env, jobject receiver, jclass\n \t\thostClassLoader = vm->systemClassLoader->classLoaderObject;\n \t}\n \tjobject hostClassLoaderLocalRef = vmFuncs->j9jni_createLocalRef(env, hostClassLoader);\n+\n+\tJ9ClassPatchMap cpPatchMap = {0, NULL};\n+\tj9array_t patchArray = NULL;\n+\tPORT_ACCESS_FROM_ENV(env);\n+\n+\tU_16 indexMap[128];\n+\tif (constPatches != NULL) {\n+\t\tpatchArray = (j9array_t)J9_JNI_UNWRAP_REFERENCE(constPatches);\n+\t\tcpPatchMap.size = (U_16)J9INDEXABLEOBJECT_SIZE(currentThread, patchArray);\n+\t\tif (cpPatchMap.size <= 128) {\n+\t\t\tcpPatchMap.indexMap = indexMap;\n+\t\t} else {\n+\t\t\tcpPatchMap.indexMap = (U_16*)j9mem_allocate_memory(cpPatchMap.size * sizeof(U_16), J9MEM_CATEGORY_VM);\n+\t\t}\n+\t}\n+\n \tvmFuncs->internalExitVMToJNI(currentThread);\n \n \tjsize length = env->GetArrayLength(bytecodes);\n \n \t/* acquires access internally */\n-\tjclass anonClass = defineClassCommon(env, hostClassLoaderLocalRef, NULL,bytecodes, 0, length, protectionDomainLocalRef, J9_FINDCLASS_FLAG_UNSAFE | J9_FINDCLASS_FLAG_ANON, hostClazz);\n+\tjclass anonClass = defineClassCommon(env, hostClassLoaderLocalRef, NULL,bytecodes, 0, length, protectionDomainLocalRef, J9_FINDCLASS_FLAG_UNSAFE | J9_FINDCLASS_FLAG_ANON, hostClazz, &cpPatchMap);\n \tif (env->ExceptionCheck()) {\n \t\treturn NULL;\n \t} else if (NULL == anonClass) {\n \t\tthrowNewInternalError(env, NULL);\n \t\treturn NULL;\n \t}\n \n+\tif (constPatches != NULL) {\n+\t\tvmFuncs->internalEnterVMFromJNI(currentThread);\n+\t\tJ9Class * clazz = J9VM_J9CLASS_FROM_HEAPCLASS(currentThread, J9_JNI_UNWRAP_REFERENCE(anonClass));\n+\n+\t\tj9object_t item = NULL;\n+\t\tU_32 * cpShapeDescription = J9ROMCLASS_CPSHAPEDESCRIPTION(clazz->romClass);\n+\t\tJ9ConstantPool * ramCP = J9_CP_FROM_CLASS(clazz);", "originalCommit": "1e4f06080dbc668570b8a4380fb557dadbb51f30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bb94c806d202160c2fa0de3e6026cb5f5a3ddae8", "url": "https://github.com/eclipse-openj9/openj9/commit/bb94c806d202160c2fa0de3e6026cb5f5a3ddae8", "message": "Initial commit for CP String patching\n\nSigned-off-by: Jack Lu <Jack.S.Lu@ibm.com>", "committedDate": "2020-01-30T21:30:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM0MTAwNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8460#discussion_r374341006", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t&& (J9UTF8_EQUALS(romString, J9ROMSTRINGREF_UTF8DATA((J9ROMStringRef *)&romCP[j])))) {\n          \n          \n            \n            \t\t\t\t\tif ((J9_CP_TYPE(cpShapeDescription, j) == J9CPTYPE_STRING)\n          \n          \n            \n            \t\t\t\t\t\t&& J9UTF8_EQUALS(romString, J9ROMSTRINGREF_UTF8DATA((J9ROMStringRef *)&romCP[j]))\n          \n          \n            \n            \t\t\t\t\t) {", "author": "babsingh", "createdAt": "2020-02-03T21:06:45Z", "path": "runtime/jcl/common/sun_misc_Unsafe.cpp", "diffHunk": "@@ -96,19 +95,65 @@ Java_sun_misc_Unsafe_defineAnonymousClass(JNIEnv *env, jobject receiver, jclass\n \t\thostClassLoader = vm->systemClassLoader->classLoaderObject;\n \t}\n \tjobject hostClassLoaderLocalRef = vmFuncs->j9jni_createLocalRef(env, hostClassLoader);\n+\n+\tJ9ClassPatchMap cpPatchMap = {0, NULL};\n+\tj9array_t patchArray = NULL;\n+\tPORT_ACCESS_FROM_ENV(env);\n+\n+\tU_16 indexMap[BUFFER_SIZE];\n+\tif (constPatches != NULL) {\n+\t\tpatchArray = (j9array_t)J9_JNI_UNWRAP_REFERENCE(constPatches);\n+\t\tcpPatchMap.size = (U_16)J9INDEXABLEOBJECT_SIZE(currentThread, patchArray);\n+\t\tif (cpPatchMap.size <= BUFFER_SIZE) {\n+\t\t\tcpPatchMap.indexMap = indexMap;\n+\t\t} else {\n+\t\t\tcpPatchMap.indexMap = (U_16 *)j9mem_allocate_memory(cpPatchMap.size * sizeof(U_16), J9MEM_CATEGORY_VM);\n+\t\t}\n+\t}\n+\n \tvmFuncs->internalExitVMToJNI(currentThread);\n \n \tjsize length = env->GetArrayLength(bytecodes);\n \n \t/* acquires access internally */\n-\tjclass anonClass = defineClassCommon(env, hostClassLoaderLocalRef, NULL,bytecodes, 0, length, protectionDomainLocalRef, J9_FINDCLASS_FLAG_UNSAFE | J9_FINDCLASS_FLAG_ANON, hostClazz);\n+\tjclass anonClass = defineClassCommon(env, hostClassLoaderLocalRef, NULL,bytecodes, 0, length, protectionDomainLocalRef, J9_FINDCLASS_FLAG_UNSAFE | J9_FINDCLASS_FLAG_ANON, hostClazz, &cpPatchMap);\n \tif (env->ExceptionCheck()) {\n \t\treturn NULL;\n \t} else if (NULL == anonClass) {\n \t\tthrowNewInternalError(env, NULL);\n \t\treturn NULL;\n \t}\n \n+\tif (constPatches != NULL) {\n+\t\tvmFuncs->internalEnterVMFromJNI(currentThread);\n+\t\tJ9Class *clazz = J9VM_J9CLASS_FROM_HEAPCLASS(currentThread, J9_JNI_UNWRAP_REFERENCE(anonClass));\n+\n+\t\tj9object_t item = NULL;\n+\t\tU_32 *cpShapeDescription = J9ROMCLASS_CPSHAPEDESCRIPTION(clazz->romClass);\n+\t\tJ9ConstantPool *ramCP = J9_CP_FROM_CLASS(clazz);\n+\t\tJ9ROMConstantPoolItem *romCP = ramCP->romConstantPool;\n+\n+\t\tfor (U_16 i = 0; i < cpPatchMap.size; i++) {\n+\t\t\titem = J9JAVAARRAYOFOBJECT_LOAD(currentThread, patchArray, i);\n+\t\t\tif ((item != NULL) && (J9_CP_TYPE(cpShapeDescription, cpPatchMap.indexMap[i]) == J9CPTYPE_STRING)) {\n+\t\t\t\tJ9UTF8 *romString = J9ROMSTRINGREF_UTF8DATA((J9ROMStringRef *)&romCP[cpPatchMap.indexMap[i]]);\n+\n+\t\t\t\tfor (U_16 j = 1; j < clazz->romClass->ramConstantPoolCount; j++) {\n+\t\t\t\t\tif ((J9_CP_TYPE(cpShapeDescription, j) == J9CPTYPE_STRING)\n+\t\t\t\t\t&& (J9UTF8_EQUALS(romString, J9ROMSTRINGREF_UTF8DATA((J9ROMStringRef *)&romCP[j])))) {", "originalCommit": "a97a1e1ceb3a1eb95f734ea40332f7bd5609f08f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwNjYwOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8460#discussion_r374406608", "bodyText": "fixed as per suggested", "author": "fengxue-IS", "createdAt": "2020-02-03T23:50:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM0MTAwNg=="}], "type": "inlineReview"}, {"oid": "7f3089712584b9d3e92bf5702e79bc2686f6a5ec", "url": "https://github.com/eclipse-openj9/openj9/commit/7f3089712584b9d3e92bf5702e79bc2686f6a5ec", "message": "prototype for cp string comparsion during patching\n\nSigned-off-by: Jack Lu <Jack.S.Lu@ibm.com>", "committedDate": "2020-02-03T23:49:57Z", "type": "forcePushed"}, {"oid": "23f72fb73c321a814b91527326568e2f89dc6f73", "url": "https://github.com/eclipse-openj9/openj9/commit/23f72fb73c321a814b91527326568e2f89dc6f73", "message": "Search RAM CP for identical String entries to patch\n\nFor each patch object, apply to all matching String entries in the constantpool\n\nSigned-off-by: Jack Lu <Jack.S.Lu@ibm.com>", "committedDate": "2020-02-05T17:53:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0NTY3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8460#discussion_r375645672", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * If valid patchMap structure passed, class require ConstantPool patching,\n          \n          \n            \n            \t * If a valid patchMap structure is passed, this class requirse ConstantPool patching.", "author": "DanHeidinga", "createdAt": "2020-02-06T05:23:46Z", "path": "runtime/bcutil/ConstantPoolMap.cpp", "diffHunk": "@@ -302,6 +302,20 @@ ConstantPoolMap::computeConstantPoolMapAndSizes()\n \t\t\t}\n \t\t}\n \t}\n+\n+\tJ9ClassPatchMap *map = _context->patchMap();\n+\n+\t/**\n+\t * If valid patchMap structure passed, class require ConstantPool patching,", "originalCommit": "23f72fb73c321a814b91527326568e2f89dc6f73", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0NTgxMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8460#discussion_r375645810", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * record Classfile to J9Class constantpool index mapping to patch RAM Class\n          \n          \n            \n            \t * Record the index mapping from Classfile to J9Class constantpool to allow patching the RAM CP", "author": "DanHeidinga", "createdAt": "2020-02-06T05:24:28Z", "path": "runtime/bcutil/ConstantPoolMap.cpp", "diffHunk": "@@ -302,6 +302,20 @@ ConstantPoolMap::computeConstantPoolMapAndSizes()\n \t\t\t}\n \t\t}\n \t}\n+\n+\tJ9ClassPatchMap *map = _context->patchMap();\n+\n+\t/**\n+\t * If valid patchMap structure passed, class require ConstantPool patching,\n+\t * record Classfile to J9Class constantpool index mapping to patch RAM Class", "originalCommit": "23f72fb73c321a814b91527326568e2f89dc6f73", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0NjY4Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8460#discussion_r375646686", "bodyText": "This function gets VMAccess so it can't be called with it.  Need to swap these two lines", "author": "DanHeidinga", "createdAt": "2020-02-06T05:28:57Z", "path": "runtime/jcl/common/sun_misc_Unsafe.cpp", "diffHunk": "@@ -96,19 +95,72 @@ Java_sun_misc_Unsafe_defineAnonymousClass(JNIEnv *env, jobject receiver, jclass\n \t\thostClassLoader = vm->systemClassLoader->classLoaderObject;\n \t}\n \tjobject hostClassLoaderLocalRef = vmFuncs->j9jni_createLocalRef(env, hostClassLoader);\n+\n+\tJ9ClassPatchMap cpPatchMap = {0, NULL};\n+\tj9array_t patchArray = NULL;\n+\tPORT_ACCESS_FROM_ENV(env);\n+\n+\tU_16 indexMap[BUFFER_SIZE];\n+\tif (constPatches != NULL) {\n+\t\tpatchArray = (j9array_t)J9_JNI_UNWRAP_REFERENCE(constPatches);\n+\t\tcpPatchMap.size = (U_16)J9INDEXABLEOBJECT_SIZE(currentThread, patchArray);\n+\t\tif (cpPatchMap.size <= BUFFER_SIZE) {\n+\t\t\tcpPatchMap.indexMap = indexMap;\n+\t\t} else {\n+\t\t\tcpPatchMap.indexMap = (U_16 *)j9mem_allocate_memory(cpPatchMap.size * sizeof(U_16), J9MEM_CATEGORY_VM);\n+\n+\t\t\tif (cpPatchMap.indexMap == NULL) {\n+\t\t\t\tvmFuncs->throwNativeOOMError(env, 0, 0);", "originalCommit": "23f72fb73c321a814b91527326568e2f89dc6f73", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0NzE0OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8460#discussion_r375647148", "bodyText": "It's a good practice to null out fields that have been released even when the end of the function is so close.  Future changes to the file may accidentally reuse the freed mem if we don't null it now.", "author": "DanHeidinga", "createdAt": "2020-02-06T05:31:08Z", "path": "runtime/jcl/common/sun_misc_Unsafe.cpp", "diffHunk": "@@ -96,19 +95,72 @@ Java_sun_misc_Unsafe_defineAnonymousClass(JNIEnv *env, jobject receiver, jclass\n \t\thostClassLoader = vm->systemClassLoader->classLoaderObject;\n \t}\n \tjobject hostClassLoaderLocalRef = vmFuncs->j9jni_createLocalRef(env, hostClassLoader);\n+\n+\tJ9ClassPatchMap cpPatchMap = {0, NULL};\n+\tj9array_t patchArray = NULL;\n+\tPORT_ACCESS_FROM_ENV(env);\n+\n+\tU_16 indexMap[BUFFER_SIZE];\n+\tif (constPatches != NULL) {\n+\t\tpatchArray = (j9array_t)J9_JNI_UNWRAP_REFERENCE(constPatches);\n+\t\tcpPatchMap.size = (U_16)J9INDEXABLEOBJECT_SIZE(currentThread, patchArray);\n+\t\tif (cpPatchMap.size <= BUFFER_SIZE) {\n+\t\t\tcpPatchMap.indexMap = indexMap;\n+\t\t} else {\n+\t\t\tcpPatchMap.indexMap = (U_16 *)j9mem_allocate_memory(cpPatchMap.size * sizeof(U_16), J9MEM_CATEGORY_VM);\n+\n+\t\t\tif (cpPatchMap.indexMap == NULL) {\n+\t\t\t\tvmFuncs->throwNativeOOMError(env, 0, 0);\n+\t\t\t\tvmFuncs->internalExitVMToJNI(currentThread);\n+\t\t\t\treturn NULL;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n \tvmFuncs->internalExitVMToJNI(currentThread);\n \n \tjsize length = env->GetArrayLength(bytecodes);\n \n \t/* acquires access internally */\n-\tjclass anonClass = defineClassCommon(env, hostClassLoaderLocalRef, NULL,bytecodes, 0, length, protectionDomainLocalRef, J9_FINDCLASS_FLAG_UNSAFE | J9_FINDCLASS_FLAG_ANON, hostClazz);\n+\tjclass anonClass = defineClassCommon(env, hostClassLoaderLocalRef, NULL,bytecodes, 0, length, protectionDomainLocalRef, J9_FINDCLASS_FLAG_UNSAFE | J9_FINDCLASS_FLAG_ANON, hostClazz, &cpPatchMap);\n \tif (env->ExceptionCheck()) {\n \t\treturn NULL;\n \t} else if (NULL == anonClass) {\n \t\tthrowNewInternalError(env, NULL);\n \t\treturn NULL;\n \t}\n \n+\tif (constPatches != NULL) {\n+\t\tvmFuncs->internalEnterVMFromJNI(currentThread);\n+\t\tJ9Class *clazz = J9VM_J9CLASS_FROM_HEAPCLASS(currentThread, J9_JNI_UNWRAP_REFERENCE(anonClass));\n+\t\tU_32 *cpShapeDescription = J9ROMCLASS_CPSHAPEDESCRIPTION(clazz->romClass);\n+\t\tJ9ConstantPool *ramCP = J9_CP_FROM_CLASS(clazz);\n+\t\tJ9ROMConstantPoolItem *romCP = ramCP->romConstantPool;\n+\n+\t\t/* Get J9 constantpool mapped item for patch item, only support patching STRING entries has been added */\n+\t\tfor (U_16 i = 0; i < cpPatchMap.size; i++) {\n+\t\t\tj9object_t item = J9JAVAARRAYOFOBJECT_LOAD(currentThread, patchArray, i);\n+\t\t\tif ((item != NULL) && (J9_CP_TYPE(cpShapeDescription, cpPatchMap.indexMap[i]) == J9CPTYPE_STRING)) {\n+\t\t\t\tJ9UTF8 *romString = J9ROMSTRINGREF_UTF8DATA((J9ROMStringRef *)&romCP[cpPatchMap.indexMap[i]]);\n+\n+\t\t\t\t/* For each patch object, search the RAM constantpool for identical string entries */\n+\t\t\t\tfor (U_16 j = 1; j < clazz->romClass->ramConstantPoolCount; j++) {\n+\t\t\t\t\tif ((J9_CP_TYPE(cpShapeDescription, j) == J9CPTYPE_STRING)\n+\t\t\t\t\t\t&& J9UTF8_EQUALS(romString, J9ROMSTRINGREF_UTF8DATA((J9ROMStringRef *)&romCP[j]))\n+\t\t\t\t\t) {\n+\t\t\t\t\t\tJ9RAMStringRef *ramStringRef = ((J9RAMStringRef *)ramCP) + j;\n+\t\t\t\t\t\tJ9STATIC_OBJECT_STORE(currentThread, clazz, &ramStringRef->stringObject, item);\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\n+\t\tif (cpPatchMap.size > BUFFER_SIZE) {\n+\t\t\tj9mem_free_memory(cpPatchMap.indexMap);", "originalCommit": "23f72fb73c321a814b91527326568e2f89dc6f73", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "573628ba41b9e0e2aece9f3da050a93a3d4f9d87", "url": "https://github.com/eclipse-openj9/openj9/commit/573628ba41b9e0e2aece9f3da050a93a3d4f9d87", "message": "Support CP String patching\n\n- New J9ClassPatchMap structure to store patching info\n- Update defineClassCommon code to accept J9ClassPatchMap\n- Patch RAM constantpool before returing class object\n\nSigned-off-by: Jack Lu <Jack.S.Lu@ibm.com>", "committedDate": "2020-02-06T17:55:04Z", "type": "commit"}, {"oid": "cd8147267f71d0a11e72b44662e71da94b57035b", "url": "https://github.com/eclipse-openj9/openj9/commit/cd8147267f71d0a11e72b44662e71da94b57035b", "message": "Search RAM CP for identical String entries to patch\n\nFor each patch object, apply to all matching String entries in the constantpool\n\nSigned-off-by: Jack Lu <Jack.S.Lu@ibm.com>", "committedDate": "2020-02-06T17:55:14Z", "type": "commit"}, {"oid": "cd8147267f71d0a11e72b44662e71da94b57035b", "url": "https://github.com/eclipse-openj9/openj9/commit/cd8147267f71d0a11e72b44662e71da94b57035b", "message": "Search RAM CP for identical String entries to patch\n\nFor each patch object, apply to all matching String entries in the constantpool\n\nSigned-off-by: Jack Lu <Jack.S.Lu@ibm.com>", "committedDate": "2020-02-06T17:55:14Z", "type": "forcePushed"}, {"oid": "99754a9f2d53f3252820c5385d0a94a21ab85ab1", "url": "https://github.com/eclipse-openj9/openj9/commit/99754a9f2d53f3252820c5385d0a94a21ab85ab1", "message": "Add assert on CP patch type check\n\n- Only allow String CP entries to be patched\n- Remove redundant VMAccess call when setting OOM exception\n\nSigned-off-by: Jack Lu <Jack.S.Lu@ibm.com>", "committedDate": "2020-02-07T20:50:29Z", "type": "commit"}, {"oid": "99754a9f2d53f3252820c5385d0a94a21ab85ab1", "url": "https://github.com/eclipse-openj9/openj9/commit/99754a9f2d53f3252820c5385d0a94a21ab85ab1", "message": "Add assert on CP patch type check\n\n- Only allow String CP entries to be patched\n- Remove redundant VMAccess call when setting OOM exception\n\nSigned-off-by: Jack Lu <Jack.S.Lu@ibm.com>", "committedDate": "2020-02-07T20:50:29Z", "type": "forcePushed"}]}