{"pr_number": 10219, "pr_title": "AArch64: Enable OOL for VMnewEvaluator", "pr_createdAt": "2020-07-22T07:19:22Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10219", "timeline": [{"oid": "6e812f8e0f86a4dca963a1632e83468cf4cfdb0f", "url": "https://github.com/eclipse-openj9/openj9/commit/6e812f8e0f86a4dca963a1632e83468cf4cfdb0f", "message": "AArch64: Enable OOL for VMnewEvaluator\n\nThis commit enables OutOfLineCodeSection for VMnewEvaluator.\n\nSigned-off-by: Akira Saitoh <saiaki@jp.ibm.com>", "committedDate": "2020-07-22T06:52:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAxMjY5Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10219#discussion_r462012693", "bodyText": "Is ARM64HeapAllocSnippet used anywhere else?\nIf not, please remove its code from J9ARM64Snippet.hpp/cpp.  You can do it in a separate PR.", "author": "knn-k", "createdAt": "2020-07-29T03:14:30Z", "path": "runtime/compiler/aarch64/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -1368,9 +1369,10 @@ J9::ARM64::TreeEvaluator::VMnewEvaluator(TR::Node *node, TR::CodeGenerator *cg)\n    // 5. Allocate object/array on heap\n    genHeapAlloc(node, cg, isVariableLength, allocateSize, elementSize, resultReg, lengthReg, tempReg1, tempReg2, tempReg3, conditions, callLabel);\n \n-   // 6. Setup HeapAllocSnippet for slowpath\n-   TR::Snippet *snippet = new (cg->trHeapMemory()) TR::ARM64HeapAllocSnippet(cg, node, callLabel, node->getSymbolReference(), doneLabel);", "originalCommit": "6e812f8e0f86a4dca963a1632e83468cf4cfdb0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAxNDM0Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10219#discussion_r462014343", "bodyText": "The heap alloc snippet is not used anywhere. I will remove it in a separate PR.", "author": "Akira1Saitoh", "createdAt": "2020-07-29T03:20:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAxMjY5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAxNDIxNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10219#discussion_r462014216", "bodyText": "You use objReg as the target register of the OOL section here.\nWhat is the reason of calling generateMovInstruction(cg, node, objReg, resultReg, true); later?", "author": "knn-k", "createdAt": "2020-07-29T03:20:25Z", "path": "runtime/compiler/aarch64/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -1368,9 +1369,10 @@ J9::ARM64::TreeEvaluator::VMnewEvaluator(TR::Node *node, TR::CodeGenerator *cg)\n    // 5. Allocate object/array on heap\n    genHeapAlloc(node, cg, isVariableLength, allocateSize, elementSize, resultReg, lengthReg, tempReg1, tempReg2, tempReg3, conditions, callLabel);\n \n-   // 6. Setup HeapAllocSnippet for slowpath\n-   TR::Snippet *snippet = new (cg->trHeapMemory()) TR::ARM64HeapAllocSnippet(cg, node, callLabel, node->getSymbolReference(), doneLabel);\n-   cg->addSnippet(snippet);\n+   // 6. Setup OOL Section for slowpath\n+   TR::Register *objReg = cg->allocateCollectedReferenceRegister();\n+   TR_ARM64OutOfLineCodeSection *outlinedHelperCall = new (cg->trHeapMemory()) TR_ARM64OutOfLineCodeSection(node, TR::acall, objReg, callLabel, callReturnLabel, cg);", "originalCommit": "6e812f8e0f86a4dca963a1632e83468cf4cfdb0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAyOTQ4Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10219#discussion_r462029487", "bodyText": "The allocated object is stored in objReg, so objReg is a collected reference register. resultReg is a temporary register that holds the address of the object, but it must not be a collected reference register. In our instruction stream, resultReg is already used before branching into the OOL section. If it is a collected reference register, it will be added to the GC map at the branch instruction to the helper in the OOL section. At this point, the value in resultReg is not a valid object, so resultReg must not be added to the GC map.\nresultReg is copied to objReg after all checks whether the slow path is taken are done.", "author": "Akira1Saitoh", "createdAt": "2020-07-29T04:23:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAxNDIxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA2MDQyOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10219#discussion_r462060428", "bodyText": "Thank you for explaining.  I understand.", "author": "knn-k", "createdAt": "2020-07-29T06:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAxNDIxNg=="}], "type": "inlineReview"}]}