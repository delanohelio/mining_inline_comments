{"pr_number": 8391, "pr_title": "JEP 359 cfdumper support", "pr_createdAt": "2020-01-23T22:14:58Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8391", "timeline": [{"oid": "234637713f11baaf591d89247e4ed5ce3105b4cd", "url": "https://github.com/eclipse-openj9/openj9/commit/234637713f11baaf591d89247e4ed5ce3105b4cd", "message": "JEP 359 cfdumper support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-01-23T22:17:40Z", "type": "forcePushed"}, {"oid": "668dd4e5d94459742b22ea4437cd816a94d58f3b", "url": "https://github.com/eclipse-openj9/openj9/commit/668dd4e5d94459742b22ea4437cd816a94d58f3b", "message": "JEP 359 cfdumper support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-01-29T21:27:30Z", "type": "forcePushed"}, {"oid": "88d94b7a04654ce27c8728da0092f9e339b4107b", "url": "https://github.com/eclipse-openj9/openj9/commit/88d94b7a04654ce27c8728da0092f9e339b4107b", "message": "JEP 359 cfdumper support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-02-09T07:06:15Z", "type": "forcePushed"}, {"oid": "d14d8d1c9ba094259e2cfa3581b92a945bac5bf4", "url": "https://github.com/eclipse-openj9/openj9/commit/d14d8d1c9ba094259e2cfa3581b92a945bac5bf4", "message": "JEP 359 cfdumper support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-02-10T14:05:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkxODY2NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8391#discussion_r378918665", "bodyText": "Do the typeAnnotations need to be analyzed here as well?  Same for the component annotations?   Otherwise I'm not sure how their UTF8s get added", "author": "DanHeidinga", "createdAt": "2020-02-13T15:07:13Z", "path": "runtime/bcutil/ClassFileWriter.cpp", "diffHunk": "@@ -493,6 +498,37 @@ ClassFileWriter::analyzeMethods()\n \t}\n }\n \n+void\n+ClassFileWriter::analyzeRecordAttribute()\n+{\n+\taddEntry((void *) &RECORD, 0, CFR_CONSTANT_Utf8);\n+\n+\t/* first 4 bytes contains number of record components */\n+\tU_32 numberOfRecords = getNumberOfRecordComponents(_romClass);\n+\tJ9ROMRecordComponentShape* recordComponent = recordComponentStartDo(_romClass);\n+\tfor (U_32 i = 0; i < numberOfRecords; i++) {\n+\n+\t\t/* record component name and signature */\n+\t\taddEntry(J9ROMRECORDCOMPONENTSHAPE_NAME(recordComponent), 0, CFR_CONSTANT_Utf8);\n+\t\taddEntry(J9ROMRECORDCOMPONENTSHAPE_SIGNATURE(recordComponent), 0, CFR_CONSTANT_Utf8);\n+\n+\t\t/* analyze attributes */\n+\t\tif (recordComponentHasSignature(recordComponent)) {\n+\t\t\tJ9UTF8* genericSignature = getRecordComponentGenericSignature(recordComponent);\n+\t\t\taddEntry((void *) &SIGNATURE, 0, CFR_CONSTANT_Utf8);\n+\t\t\taddEntry(genericSignature, 0, CFR_CONSTANT_Utf8);\n+\t\t}\n+\t\tif (recordComponentHasAnnotations(recordComponent)) {\n+\t\t\taddEntry((void *) &RUNTIME_VISIBLE_ANNOTATIONS, 0, CFR_CONSTANT_Utf8);\n+\t\t}\n+\t\tif (recordComponentHasTypeAnnotations(recordComponent)) {\n+\t\t\taddEntry((void *) &RUNTIME_VISIBLE_TYPE_ANNOTATIONS, 0, CFR_CONSTANT_Utf8);", "originalCommit": "d14d8d1c9ba094259e2cfa3581b92a945bac5bf4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkyMzIwNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8391#discussion_r378923207", "bodyText": "Looking deeper into the code, you've matched the existing pattern and I think I understand how this works now.", "author": "DanHeidinga", "createdAt": "2020-02-13T15:14:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkxODY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkyMTMxNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8391#discussion_r378921315", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * Write zero as a placeholder for length. */\n          \n          \n            \n            \t * Write zero as a placeholder for length. \n          \n          \n            \n            \t */", "author": "DanHeidinga", "createdAt": "2020-02-13T15:11:33Z", "path": "runtime/bcutil/ClassFileWriter.cpp", "diffHunk": "@@ -1041,6 +1080,67 @@ ClassFileWriter::writeAttributes()\n \t\t\t}\n \t\t}\n \t}\n+\n+\t/* record attribute */\n+\tif (J9_ARE_ANY_BITS_SET(_romClass->extraModifiers, J9AccRecord)) {\n+\t\twriteRecordAttribute();\n+\t}\n+}\n+\n+void ClassFileWriter::writeRecordAttribute()\n+{\n+\t/* Write header - size calculation will be written specially at the end.\n+\t * Write zero as a placeholder for length. */", "originalCommit": "d14d8d1c9ba094259e2cfa3581b92a945bac5bf4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkyMjI3Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8391#discussion_r378922273", "bodyText": "please assign initial values", "author": "DanHeidinga", "createdAt": "2020-02-13T15:13:00Z", "path": "runtime/util/romclasswalk.c", "diffHunk": "@@ -701,6 +701,68 @@ static void allSlotsInConstantPoolDo(J9ROMClass* romClass, J9ROMClassWalkCallbac\n \t}\n }\n \n+static UDATA\n+allSlotsInRecordComponentDo(J9ROMClass* romClass, J9ROMRecordComponentShape* recordComponent, J9ROMClassWalkCallbacks* callbacks, void* userData) {\n+\tBOOLEAN rangeValid;\n+\tU_32 attributeFlags;\n+\tJ9ROMNameAndSignature *recordComponentNAS;", "originalCommit": "d14d8d1c9ba094259e2cfa3581b92a945bac5bf4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b41b7148492ce6f8c73fb35b3719b5632e125616", "url": "https://github.com/eclipse-openj9/openj9/commit/b41b7148492ce6f8c73fb35b3719b5632e125616", "message": "JEP 359 cfdumper support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-02-13T17:23:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzODg3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8391#discussion_r379038879", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * Stored as U32 in the ROM class, U16 in class file. */\n          \n          \n            \n            \t * Stored as U32 in the ROM class, U16 in class file.\n          \n          \n            \n            \t */", "author": "DanHeidinga", "createdAt": "2020-02-13T18:25:44Z", "path": "runtime/bcutil/ClassFileWriter.cpp", "diffHunk": "@@ -1041,6 +1080,68 @@ ClassFileWriter::writeAttributes()\n \t\t\t}\n \t\t}\n \t}\n+\n+\t/* record attribute */\n+\tif (J9_ARE_ANY_BITS_SET(_romClass->extraModifiers, J9AccRecord)) {\n+\t\twriteRecordAttribute();\n+\t}\n+}\n+\n+void ClassFileWriter::writeRecordAttribute()\n+{\n+\t/* Write header - size calculation will be written specially at the end.\n+\t * Write zero as a placeholder for length.\n+\t */\n+\twriteU16(indexForUTF8((J9UTF8 *) &RECORD));\n+\tU_8* recordAttributeLengthAddr = _classFileCursor;\n+\twriteU32(0);\n+\tU_8* startLengthCalculationAddr = _classFileCursor;\n+\t\n+\t/* write number of record components (components_count).\n+\t * Stored as U32 in the ROM class, U16 in class file. */", "originalCommit": "b41b7148492ce6f8c73fb35b3719b5632e125616", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzOTUxOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8391#discussion_r379039519", "bodyText": "Sorry, I missed one other minor nitpick previously", "author": "DanHeidinga", "createdAt": "2020-02-13T18:26:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzODg3OQ=="}], "type": "inlineReview"}, {"oid": "dfbd5fcf01c00920193a8a964fca042762189c50", "url": "https://github.com/eclipse-openj9/openj9/commit/dfbd5fcf01c00920193a8a964fca042762189c50", "message": "JEP 359 cfdumper support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-02-13T18:50:28Z", "type": "forcePushed"}, {"oid": "c7f78a392701a06476ed4d56ebd6614b21bf8573", "url": "https://github.com/eclipse-openj9/openj9/commit/c7f78a392701a06476ed4d56ebd6614b21bf8573", "message": "JEP 359 cfdumper support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-02-14T07:14:44Z", "type": "forcePushed"}, {"oid": "bb29ca5c052fb8039c69c9efbb39c7ca453b7061", "url": "https://github.com/eclipse-openj9/openj9/commit/bb29ca5c052fb8039c69c9efbb39c7ca453b7061", "message": "JEP 359 cfdumper support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-02-14T18:15:16Z", "type": "forcePushed"}, {"oid": "bb29ca5c052fb8039c69c9efbb39c7ca453b7061", "url": "https://github.com/eclipse-openj9/openj9/commit/bb29ca5c052fb8039c69c9efbb39c7ca453b7061", "message": "JEP 359 cfdumper support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-02-14T18:15:16Z", "type": "commit"}]}