{"pr_number": 10214, "pr_title": "Implement monitor enter/exit VM helper call for value types on Power", "pr_createdAt": "2020-07-21T20:40:32Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10214", "timeline": [{"oid": "2d11053543cbd34879eb7427f611c39f3bc43551", "url": "https://github.com/eclipse-openj9/openj9/commit/2d11053543cbd34879eb7427f611c39f3bc43551", "message": "Implement monitor enter/exit VM helper call for value types on Power\n\nAdd support for monitor enter/exit for value types on Power. Handles the\nfollowing three cases:\n1.) Object is known to be a value type at compile time: VM helper is\n    called directly and IllegalMonitorStateException is thrown\n2.) Object is known NOT to be a valuetype at compile time: proceed as\n    before\n3.) Unknown at compile time if object is a value type: Check at runtime\n    if object is a value type, call VM helper if so\n\nSigned-off-by: Jackie Midroni <jackie.midroni@mail.utoronto.ca>", "committedDate": "2020-07-21T20:42:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgwOTI4Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10214#discussion_r458809283", "bodyText": "This function is called inside internal control flow so you shouldn't allocate new registers inside it since the register dependency won't know about them. You can pass in tempReg and condReg that were already allocated into the function.\nThere are also some minor issues with missing spaces or braces that aren't in the right spot in this function.", "author": "IBMJimmyk", "createdAt": "2020-07-22T13:53:52Z", "path": "runtime/compiler/p/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -7768,15 +7769,40 @@ static bool simpleReadMonitor(TR::Node *node, TR::CodeGenerator *cg, TR::Node *o\n    return true;\n    }\n \n+void J9::Power::TreeEvaluator::generateCheckForValueTypeMonitorEnterOrExit(TR::Node *node, TR::LabelSymbol *helperCallLabel, TR::Register *objReg, TR::Register *objectClassReg, TR::CodeGenerator *cg)\n+{\n+   //get class of object\n+   generateLoadJ9Class(node, objectClassReg, objReg, cg); \n+\n+   //get memory reference to class flags\n+   TR_J9VMBase *fej9 = (TR_J9VMBase *)(cg->fe());\n+   TR::MemoryReference *classFlagsMemRef = new (cg->trHeapMemory()) TR::MemoryReference(objectClassReg, static_cast<uintptr_t>(fej9->getOffsetOfClassFlags()), 4, cg);\n+\n+   //check J9ClassIsValueType flag\n+   TR::Register *tempReg = cg->allocateRegister();\n+   TR::Register *condReg = cg->allocateRegister(TR_CCR);", "originalCommit": "2d11053543cbd34879eb7427f611c39f3bc43551", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e22429b06a4d455c6bbf4856339496ce1b3dbe3e", "url": "https://github.com/eclipse-openj9/openj9/commit/e22429b06a4d455c6bbf4856339496ce1b3dbe3e", "message": "Implement monitor enter/exit VM helper call for value types on Power\n\nAdd support for monitor enter/exit for value types on Power. Handles the\nfollowing three cases:\n1.) Object is known to be a value type at compile time: VM helper is\n    called directly and IllegalMonitorStateException is thrown\n2.) Object is known NOT to be a valuetype at compile time: proceed as\n    before\n3.) Unknown at compile time if object is a value type: Check at runtime\n    if object is a value type, call VM helper if so\n\nSigned-off-by: Jackie Midroni <jackie.midroni@mail.utoronto.ca>", "committedDate": "2020-07-22T14:20:26Z", "type": "forcePushed"}, {"oid": "8f8929272c03ea08b00477bb5124d1fd899560b8", "url": "https://github.com/eclipse-openj9/openj9/commit/8f8929272c03ea08b00477bb5124d1fd899560b8", "message": "Implement monitor enter/exit VM helper call for value types on Power\n\nAdd support for monitor enter/exit for value types on Power. Handles the\nfollowing three cases:\n1.) Object is known to be a value type at compile time: VM helper is\n    called directly and IllegalMonitorStateException is thrown\n2.) Object is known NOT to be a valuetype at compile time: proceed as\n    before\n3.) Unknown at compile time if object is a value type: Check at runtime\n    if object is a value type, call VM helper if so\n\nSigned-off-by: Jackie Midroni <jackie.midroni@mail.utoronto.ca>", "committedDate": "2020-07-22T14:22:22Z", "type": "commit"}, {"oid": "8f8929272c03ea08b00477bb5124d1fd899560b8", "url": "https://github.com/eclipse-openj9/openj9/commit/8f8929272c03ea08b00477bb5124d1fd899560b8", "message": "Implement monitor enter/exit VM helper call for value types on Power\n\nAdd support for monitor enter/exit for value types on Power. Handles the\nfollowing three cases:\n1.) Object is known to be a value type at compile time: VM helper is\n    called directly and IllegalMonitorStateException is thrown\n2.) Object is known NOT to be a valuetype at compile time: proceed as\n    before\n3.) Unknown at compile time if object is a value type: Check at runtime\n    if object is a value type, call VM helper if so\n\nSigned-off-by: Jackie Midroni <jackie.midroni@mail.utoronto.ca>", "committedDate": "2020-07-22T14:22:22Z", "type": "forcePushed"}]}