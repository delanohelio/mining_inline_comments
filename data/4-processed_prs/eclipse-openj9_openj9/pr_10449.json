{"pr_number": 10449, "pr_title": "Recover gr16 as a general register in POWER10", "pr_createdAt": "2020-08-25T12:51:24Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10449", "timeline": [{"oid": "9be4b681f1e6543aa201729f09c7fcf71d22a4b2", "url": "https://github.com/eclipse-openj9/openj9/commit/9be4b681f1e6543aa201729f09c7fcf71d22a4b2", "message": "Recover gr16 as a general register in POWER10\n\nAfter disableTOC is turned on in POWER10, we can recoup\ngr16 as a preserved general purpose register, instead of\na reserved register. This is the first time we set up the\ncompiler-visible machine resources according to the CPU type.\n\nThe side-effect needs to be taken care of in JNI dispatch.\nPlus, TOCBaseRegister should be prohibited from being referenced\nin codegen. Otherwise, register assigner will crash.\n\nSigned-off-by: Julian Wang <zlwang@ca.ibm.com>", "committedDate": "2020-08-25T15:16:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxNDA0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10449#discussion_r480414046", "bodyText": "Here and in a few other places, we don't check the disableTOC option. Is that by design?", "author": "gita-omr", "createdAt": "2020-08-31T21:38:28Z", "path": "runtime/compiler/p/codegen/PPCJNILinkage.cpp", "diffHunk": "@@ -219,7 +219,12 @@ TR::Register *J9::Power::JNILinkage::buildDirectDispatch(TR::Node *callNode)\n       {\n       // We need to kill all the non-volatiles so that they'll be in a stack frame in case\n       // gc needs to find them.\n-      if (comp()->target().is32Bit())\n+      if (comp()->target().is64Bit())", "originalCommit": "9be4b681f1e6543aa201729f09c7fcf71d22a4b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEwMTI1Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10449#discussion_r481101253", "bodyText": "yes, that is by design, since disableTOC carries more meanings than POWER10.  For example, on POWER8/9, AOT also disabled pTOC (but gr16 is not free in those cases).  gr16 is only free on P10 and later (when pTOC is disabled as well).", "author": "zl-wang", "createdAt": "2020-09-01T12:31:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxNDA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM1MTA1NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10449#discussion_r481351055", "bodyText": "Sorry, I don't completely follow: will we be able to run with pTOC on P10?", "author": "gita-omr", "createdAt": "2020-09-01T18:36:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxNDA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM1NzI0NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10449#discussion_r481357244", "bodyText": "after this PR is merged ... no, pTOC is completely gone on P10 and gr16 is recovered (you cannot reference to pTOC anymore on P10).  before this PR is merged, gr16 is still reserved and pTOC can be referenced and used in theory (but disabled in reality already -- on P10/later only, this is).", "author": "zl-wang", "createdAt": "2020-09-01T18:48:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxNDA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA5Mzc4NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10449#discussion_r482093784", "bodyText": "Thanks. Just to clarify after an off-line discussion: it was a design decision to disable pTOC completely and always use gr16 on P10 (no command line or env option to use old behaviour for either of those)", "author": "gita-omr", "createdAt": "2020-09-02T14:02:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQxNDA0Ng=="}], "type": "inlineReview"}]}