{"pr_number": 298, "pr_title": "Add a cluster level collector for node config settings", "pr_createdAt": "2020-07-22T18:02:16Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298", "timeline": [{"oid": "1816e4792f1f5cef9da29eff06f721dee945902d", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/1816e4792f1f5cef9da29eff06f721dee945902d", "message": "Add a cluster level collector for node config settings. Create a node config cache in AppContext", "committedDate": "2020-07-22T17:54:27Z", "type": "commit"}, {"oid": "9de4cd26f6671cf255ea4d6554a49879f10bda2c", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/9de4cd26f6671cf255ea4d6554a49879f10bda2c", "message": "Add more comments", "committedDate": "2020-07-22T18:12:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE5MDY5Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r459190697", "bodyText": "Since this is not going to sql db, I don't think we need NaN value and check. Let's instead throw a checked exception here for consumer code safety? (anyway the check has to be handled by the caller; exception will help protect against cases where callers forget the NaN check).", "author": "vigyasharma", "createdAt": "2020-07-23T03:00:05Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/collector/NodeConfigCache.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.collector;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.commons.lang3.builder.HashCodeBuilder;\n+\n+/**\n+ * we create a thread-safe unbounded cache instance in {@link com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext}\n+ * to store the node config settings from each node. Any RCA vertex in RCA graph can read the node config directly from\n+ * this cache instance. The key of this cache is NodeKey + Resource and value is the actual value of the config setting\n+ * (i.e. size of write queue capacity)\n+ */\n+public class NodeConfigCache {\n+\n+  private static final int LOADING_CACHE_EVICTION_TIMEOUT = 10;\n+  private final Cache<NodeConfigKey, Double> nodeConfigCache;\n+\n+  //unbounded cache with eviction timeout set to 10 mins\n+  public NodeConfigCache() {\n+    nodeConfigCache =\n+        CacheBuilder.newBuilder()\n+            .expireAfterWrite(LOADING_CACHE_EVICTION_TIMEOUT, TimeUnit.MINUTES)\n+            .build();\n+  }\n+\n+  public void put(NodeKey nodeKey, Resource config, double value) {\n+    nodeConfigCache.put(new NodeConfigKey(nodeKey, config), value);\n+  }\n+\n+  public double get(NodeKey nodeKey, Resource config) {\n+    Double ret = nodeConfigCache.getIfPresent(new NodeConfigKey(nodeKey, config));\n+    if (ret == null) {\n+      return Double.NaN;\n+    }", "originalCommit": "9de4cd26f6671cf255ea4d6554a49879f10bda2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1MTA3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r459751071", "bodyText": "done, throw an exception if config does not exist in cache", "author": "rguo-aws", "createdAt": "2020-07-23T21:57:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE5MDY5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYyNzAzOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r459627038", "bodyText": "nit: Can we replace the TIMEOUT in LOADING_CACHE_EVICTION_TIMEOUT with TTL?", "author": "khushbr", "createdAt": "2020-07-23T17:54:49Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/collector/NodeConfigCache.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.collector;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.commons.lang3.builder.HashCodeBuilder;\n+\n+/**\n+ * we create a thread-safe unbounded cache instance in {@link com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext}\n+ * to store the node config settings from each node. Any RCA vertex in RCA graph can read the node config directly from\n+ * this cache instance. The key of this cache is NodeKey + Resource and value is the actual value of the config setting\n+ * (i.e. size of write queue capacity)\n+ */\n+public class NodeConfigCache {\n+\n+  private static final int LOADING_CACHE_EVICTION_TIMEOUT = 10;", "originalCommit": "9de4cd26f6671cf255ea4d6554a49879f10bda2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1MjQ5Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r459752496", "bodyText": "done, replaced it with TTL", "author": "rguo-aws", "createdAt": "2020-07-23T22:00:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYyNzAzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYyODczNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r459628735", "bodyText": "Do we want to check here for Non-Null, Non-Negative values before putting them in HashMap?", "author": "khushbr", "createdAt": "2020-07-23T17:57:38Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/collector/NodeConfigCache.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.collector;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.commons.lang3.builder.HashCodeBuilder;\n+\n+/**\n+ * we create a thread-safe unbounded cache instance in {@link com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext}\n+ * to store the node config settings from each node. Any RCA vertex in RCA graph can read the node config directly from\n+ * this cache instance. The key of this cache is NodeKey + Resource and value is the actual value of the config setting\n+ * (i.e. size of write queue capacity)\n+ */\n+public class NodeConfigCache {\n+\n+  private static final int LOADING_CACHE_EVICTION_TIMEOUT = 10;\n+  private final Cache<NodeConfigKey, Double> nodeConfigCache;\n+\n+  //unbounded cache with eviction timeout set to 10 mins\n+  public NodeConfigCache() {\n+    nodeConfigCache =\n+        CacheBuilder.newBuilder()\n+            .expireAfterWrite(LOADING_CACHE_EVICTION_TIMEOUT, TimeUnit.MINUTES)\n+            .build();\n+  }\n+\n+  public void put(NodeKey nodeKey, Resource config, double value) {\n+    nodeConfigCache.put(new NodeConfigKey(nodeKey, config), value);", "originalCommit": "9de4cd26f6671cf255ea4d6554a49879f10bda2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc1MTk1MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r459751951", "bodyText": "we perform this check in the node level NodeConfigCollector when collection configs from DB.", "author": "rguo-aws", "createdAt": "2020-07-23T21:59:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYyODczNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzMDA2NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r459630064", "bodyText": "How do we handle stale entries in  Node Config cache? Do we need a check in get() for stale data ?", "author": "khushbr", "createdAt": "2020-07-23T17:59:53Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/collector/NodeConfigCache.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.collector;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.commons.lang3.builder.HashCodeBuilder;\n+\n+/**\n+ * we create a thread-safe unbounded cache instance in {@link com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext}\n+ * to store the node config settings from each node. Any RCA vertex in RCA graph can read the node config directly from\n+ * this cache instance. The key of this cache is NodeKey + Resource and value is the actual value of the config setting\n+ * (i.e. size of write queue capacity)\n+ */\n+public class NodeConfigCache {\n+\n+  private static final int LOADING_CACHE_EVICTION_TIMEOUT = 10;\n+  private final Cache<NodeConfigKey, Double> nodeConfigCache;\n+\n+  //unbounded cache with eviction timeout set to 10 mins\n+  public NodeConfigCache() {\n+    nodeConfigCache =\n+        CacheBuilder.newBuilder()\n+            .expireAfterWrite(LOADING_CACHE_EVICTION_TIMEOUT, TimeUnit.MINUTES)\n+            .build();\n+  }\n+\n+  public void put(NodeKey nodeKey, Resource config, double value) {\n+    nodeConfigCache.put(new NodeConfigKey(nodeKey, config), value);\n+  }\n+\n+  public double get(NodeKey nodeKey, Resource config) {\n+    Double ret = nodeConfigCache.getIfPresent(new NodeConfigKey(nodeKey, config));", "originalCommit": "9de4cd26f6671cf255ea4d6554a49879f10bda2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NTA1MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r459765051", "bodyText": "we don't handle stale data in the cache itself. data will be return if presented in cache and will be evicted if TTL is reached.", "author": "rguo-aws", "createdAt": "2020-07-23T22:33:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzMDA2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzMjI5Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r459632292", "bodyText": "The constants here make the code unreadable, if we can add a variable with name suggesting what the constant represents, it is helpful.\nAdditionally, later we should refactor to introduce a defaultIntervalPeriod and use is across all collector and similarly for RCAs as well.", "author": "khushbr", "createdAt": "2020-07-23T18:03:58Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/collector/NodeConfigClusterCollector.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.collector;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.PerformanceAnalyzerApp;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.EmptyFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.NodeConfigFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.NonLeafNode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.metrics.ExceptionsAndErrors;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.metrics.RcaGraphMetrics;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import java.util.List;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * Cluster level node config collector that collect node config settings from each node and\n+ * store them into the {@link NodeConfigCache}\n+ */\n+public class NodeConfigClusterCollector extends NonLeafNode<EmptyFlowUnit> {\n+\n+  private static final Logger LOG = LogManager.getLogger(NodeConfigClusterCollector.class);\n+  private final NodeConfigCollector nodeConfigCollector;\n+\n+  public NodeConfigClusterCollector(final NodeConfigCollector nodeConfigCollector) {\n+    super(0, 5);", "originalCommit": "9de4cd26f6671cf255ea4d6554a49879f10bda2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NTYxNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r459765617", "bodyText": "yes, we can create a static const here.  But since we will do another refactoring to remove the 5 second intervals form the super() constructor completely, it would be better to leave it as is at this moment ?", "author": "rguo-aws", "createdAt": "2020-07-23T22:35:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzMjI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI0NDI5NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r460244294", "bodyText": "Makes sense, please add an issue for this.", "author": "khushbr", "createdAt": "2020-07-24T19:22:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzMjI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzMzIyOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r459633229", "bodyText": "nit:  Javadoc explaining what addNodeLevelConfigs() is doing.", "author": "khushbr", "createdAt": "2020-07-23T18:05:36Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/collector/NodeConfigClusterCollector.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.collector;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.PerformanceAnalyzerApp;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.EmptyFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.NodeConfigFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.NonLeafNode;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.metrics.ExceptionsAndErrors;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.metrics.RcaGraphMetrics;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import java.util.List;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * Cluster level node config collector that collect node config settings from each node and\n+ * store them into the {@link NodeConfigCache}\n+ */\n+public class NodeConfigClusterCollector extends NonLeafNode<EmptyFlowUnit> {\n+\n+  private static final Logger LOG = LogManager.getLogger(NodeConfigClusterCollector.class);\n+  private final NodeConfigCollector nodeConfigCollector;\n+\n+  public NodeConfigClusterCollector(final NodeConfigCollector nodeConfigCollector) {\n+    super(0, 5);\n+    this.nodeConfigCollector = nodeConfigCollector;\n+  }\n+\n+  private void addNodeLevelConfigs() {", "originalCommit": "9de4cd26f6671cf255ea4d6554a49879f10bda2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3MDA2Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r459770066", "bodyText": "done. javadoc added", "author": "rguo-aws", "createdAt": "2020-07-23T22:48:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzMzIyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzNDYzMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r459634630", "bodyText": "Just Curious: Any particular reason we picked the unbounded cache? We may not be having fixed number of entries we want to put in the cache. So wouldn't leaving it unbounded might cause out of memory errors? It should be fine, If we are sure the number of entries are less.", "author": "aditjind", "createdAt": "2020-07-23T18:08:13Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/collector/NodeConfigCache.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.collector;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.Resource;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.commons.lang3.builder.HashCodeBuilder;\n+\n+/**\n+ * we create a thread-safe unbounded cache instance in {@link com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext}\n+ * to store the node config settings from each node. Any RCA vertex in RCA graph can read the node config directly from\n+ * this cache instance. The key of this cache is NodeKey + Resource and value is the actual value of the config setting\n+ * (i.e. size of write queue capacity)\n+ */\n+public class NodeConfigCache {\n+\n+  private static final int LOADING_CACHE_EVICTION_TIMEOUT = 10;\n+  private final Cache<NodeConfigKey, Double> nodeConfigCache;\n+\n+  //unbounded cache with eviction timeout set to 10 mins\n+  public NodeConfigCache() {\n+    nodeConfigCache =\n+        CacheBuilder.newBuilder()", "originalCommit": "9de4cd26f6671cf255ea4d6554a49879f10bda2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NDQ1Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r459764452", "bodyText": "the maxmium number of entries will be (number of node) * (node config on each node) which is not that big considering that stale entries will be evicted if reaches TTL.", "author": "rguo-aws", "createdAt": "2020-07-23T22:32:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzNDYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzNTM5NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/298#discussion_r459635395", "bodyText": "Maybe 1 UT for updating the value of the key and asserting if the updated value is returned.", "author": "aditjind", "createdAt": "2020-07-23T18:09:33Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/store/collector/NodeConfigCacheTest.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.store.collector;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.GradleTaskForRca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.ResourceUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.collector.NodeConfigCache;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+\n+@Category(GradleTaskForRca.class)\n+public class NodeConfigCacheTest {\n+\n+  private NodeConfigCache nodeConfigCache;\n+  private NodeKey nodeKey1;\n+  private NodeKey nodeKey2;\n+\n+  @Before\n+  public void init() {\n+    this.nodeConfigCache = new NodeConfigCache();\n+    this.nodeKey1 = new NodeKey(\"node1\", \"127.0.0.1\");\n+    this.nodeKey2 = new NodeKey(\"node2\", \"127.0.0.2\");\n+  }\n+\n+  @Test\n+  public void testNonExistentKey() {\n+    double val = nodeConfigCache.get(nodeKey1, ResourceUtil.WRITE_QUEUE_CAPACITY);\n+    Assert.assertTrue(Double.isNaN(val));\n+\n+    nodeConfigCache.put(nodeKey1, ResourceUtil.WRITE_QUEUE_CAPACITY, 2.0);\n+    val = nodeConfigCache.get(nodeKey1, ResourceUtil.WRITE_QUEUE_REJECTION);\n+    Assert.assertTrue(Double.isNaN(val));\n+\n+    val = nodeConfigCache.get(nodeKey2, ResourceUtil.WRITE_QUEUE_CAPACITY);\n+    Assert.assertTrue(Double.isNaN(val));\n+  }\n+\n+  @Test\n+  public void testSetAndGetValue() {", "originalCommit": "9de4cd26f6671cf255ea4d6554a49879f10bda2c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "193f2bb3358fe7b5c9ac9d134f2af938a3ff7927", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/193f2bb3358fe7b5c9ac9d134f2af938a3ff7927", "message": "Address PR comments", "committedDate": "2020-07-23T22:43:35Z", "type": "commit"}, {"oid": "faa0667f55880b6739444c88dff281be2d3c8f4e", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/faa0667f55880b6739444c88dff281be2d3c8f4e", "message": "add javadoc", "committedDate": "2020-07-23T22:47:12Z", "type": "commit"}, {"oid": "3363e16c216674429b7aa088d63ad1fc2ec315a7", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/3363e16c216674429b7aa088d63ad1fc2ec315a7", "message": "Fix UTs", "committedDate": "2020-07-23T23:02:25Z", "type": "commit"}]}