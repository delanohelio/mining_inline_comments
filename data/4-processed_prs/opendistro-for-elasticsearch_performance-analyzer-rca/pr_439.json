{"pr_number": 439, "pr_title": "Add 128GB heap JVM decider", "pr_createdAt": "2020-09-30T18:04:18Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439", "timeline": [{"oid": "23288c57d5f6b6ad3ef10ababe406d7a22aae67a", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/23288c57d5f6b6ad3ef10ababe406d7a22aae67a", "message": "Add 128GB heap JVM decider", "committedDate": "2020-09-30T18:03:27Z", "type": "commit"}, {"oid": "f0c0f139be913609984e1f349606186bed523325", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f0c0f139be913609984e1f349606186bed523325", "message": "Merge branch 'master' into 128g", "committedDate": "2020-10-01T21:17:21Z", "type": "commit"}, {"oid": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "message": "Add JvmScaleUpPolicy", "committedDate": "2020-10-02T06:53:45Z", "type": "commit"}, {"oid": "f24747488d8b4476a08375aefa7e386b18171797", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f24747488d8b4476a08375aefa7e386b18171797", "message": "Merge branch 'master' into 128g", "committedDate": "2020-10-04T18:33:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAzOTEyMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499039123", "bodyText": "nit: Can you rename this to 128GBHeapAction, G1GCAction, or something more accurate", "author": "sidheart", "createdAt": "2020-10-02T20:37:23Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/SizeUpJvmAction.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Dimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+public class SizeUpJvmAction extends SuppressibleAction {", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk1MjYzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499952631", "bodyText": "Would've loved to name it 128GBHeapAction, but you can't start class names with a number, and our goal is not really to get the JVM to use a different GC as well. We want a bigger sized heap. Maybe HeapSizeIncreaseAction?", "author": "ktkrg", "createdAt": "2020-10-06T01:10:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAzOTEyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA0MDIzNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499040237", "bodyText": "Nit rename along with SizeUpAction", "author": "sidheart", "createdAt": "2020-10-02T20:40:07Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/jvm/sizing/JvmScaleUpPolicy.java", "diffHunk": "@@ -0,0 +1,145 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.jvm.sizing;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.SizeUpJvmAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.DecisionPolicy;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.configs.JvmScaleUpPolicyConfig;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.RcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing.LargeHeapClusterRca;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+public class JvmScaleUpPolicy implements DecisionPolicy {", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAzMDg5MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500030890", "bodyText": "HeapSizeIncreasePolicy?", "author": "ktkrg", "createdAt": "2020-10-06T06:22:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA0MDIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcwODgwNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499708804", "bodyText": "Need to check with Vigya about ActionSets. If we aren't emitting this cycle, should we emit the last set of actions?", "author": "sidheart", "createdAt": "2020-10-05T16:02:52Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/jvm/sizing/JvmScaleUpPolicy.java", "diffHunk": "@@ -0,0 +1,145 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.jvm.sizing;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.SizeUpJvmAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.DecisionPolicy;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.configs.JvmScaleUpPolicyConfig;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.RcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing.LargeHeapClusterRca;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+public class JvmScaleUpPolicy implements DecisionPolicy {\n+\n+  private final LargeHeapClusterRca largeHeapClusterRca;\n+  private AppContext appContext;\n+  private RcaConf rcaConf;\n+  private PerNodeSlidingWindow perNodeSlidingWindow;\n+  private long evalFrequency;\n+  private long counter;\n+  private int unhealthyNodePercentage;\n+  private int minimumMinutesUnhealthy;\n+\n+  public JvmScaleUpPolicy(final LargeHeapClusterRca largeHeapClusterRca,\n+      final long policyEvaluationFrequency) {\n+    this.largeHeapClusterRca = largeHeapClusterRca;\n+    this.evalFrequency = policyEvaluationFrequency;\n+    this.counter = 0;\n+    this.perNodeSlidingWindow = new PerNodeSlidingWindow(4, TimeUnit.DAYS);\n+  }\n+\n+  @Override\n+  public List<Action> evaluate() {\n+    counter++;\n+    addToSlidingWindow();\n+    if (counter == evalFrequency) {\n+      counter = 0;\n+      return evaluateAndEmit();\n+    }", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcxNzg2MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499717861", "bodyText": "Should we be controlling the frequency here?", "author": "sidheart", "createdAt": "2020-10-05T16:17:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcwODgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA0MTYwNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500041607", "bodyText": "+1, we need to remember the last set of actions and emit them. For long running items i raised PR #452 which makes use of alarm monitors (the bucketized sliding window will extend from #447 to create persistable sliding windows).", "author": "vigyasharma", "createdAt": "2020-10-06T06:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcwODgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkyNjU3OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500926579", "bodyText": "aah, ok.. done. I'll merge again from master once #452 is merged.", "author": "ktkrg", "createdAt": "2020-10-07T11:08:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcwODgwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcxMDEwMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499710103", "bodyText": "Can you do a null check on hotNodeSummary? It's a little extra careful, but I've found that helpful with these functional bits", "author": "sidheart", "createdAt": "2020-10-05T16:05:01Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/jvm/sizing/JvmScaleUpPolicy.java", "diffHunk": "@@ -0,0 +1,145 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.jvm.sizing;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.SizeUpJvmAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.DecisionPolicy;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.configs.JvmScaleUpPolicyConfig;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.RcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing.LargeHeapClusterRca;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+public class JvmScaleUpPolicy implements DecisionPolicy {\n+\n+  private final LargeHeapClusterRca largeHeapClusterRca;\n+  private AppContext appContext;\n+  private RcaConf rcaConf;\n+  private PerNodeSlidingWindow perNodeSlidingWindow;\n+  private long evalFrequency;\n+  private long counter;\n+  private int unhealthyNodePercentage;\n+  private int minimumMinutesUnhealthy;\n+\n+  public JvmScaleUpPolicy(final LargeHeapClusterRca largeHeapClusterRca,\n+      final long policyEvaluationFrequency) {\n+    this.largeHeapClusterRca = largeHeapClusterRca;\n+    this.evalFrequency = policyEvaluationFrequency;\n+    this.counter = 0;\n+    this.perNodeSlidingWindow = new PerNodeSlidingWindow(4, TimeUnit.DAYS);\n+  }\n+\n+  @Override\n+  public List<Action> evaluate() {\n+    counter++;\n+    addToSlidingWindow();\n+    if (counter == evalFrequency) {\n+      counter = 0;\n+      return evaluateAndEmit();\n+    }\n+\n+    return Collections.emptyList();\n+  }\n+\n+  private void addToSlidingWindow() {\n+    long currTime = System.currentTimeMillis();\n+    if (largeHeapClusterRca.getFlowUnits().isEmpty()) {\n+      return;\n+    }\n+    ResourceFlowUnit<HotClusterSummary> flowUnit = largeHeapClusterRca.getFlowUnits().get(0);\n+\n+    if (flowUnit.getSummary() == null) {\n+      return;\n+    }\n+    List<HotNodeSummary> hotNodeSummaries = flowUnit.getSummary().getHotNodeSummaryList();\n+    hotNodeSummaries.forEach(hotNodeSummary -> {\n+      NodeKey nodeKey = new NodeKey(hotNodeSummary.getNodeID(), hotNodeSummary.getHostAddress());", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkyODQ0NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500928444", "bodyText": "I get what you're saying, but we defensively create a new ArrayList for node summaries. I've added a @nonnull annotation on the getter to enforce static checking of (non)nullness so that others can also safely use the list without adding null checks.", "author": "ktkrg", "createdAt": "2020-10-07T11:11:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcxMDEwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcxNTUxNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499715515", "bodyText": "Can you make this and line 43 use a shared static final variable that = 5?", "author": "sidheart", "createdAt": "2020-10-05T16:13:36Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/jvm/HeapHealthDecider.java", "diffHunk": "@@ -31,12 +34,15 @@\n \n   public static final String NAME = \"HeapHealthDecider\";\n   private final OldGenDecisionPolicy oldGenDecisionPolicy;\n+  private final JvmScaleUpPolicy jvmScaleUpPolicy;\n   private int counter = 0;\n \n-  public HeapHealthDecider(int decisionFrequency, final HighHeapUsageClusterRca highHeapUsageClusterRca) {\n+  public HeapHealthDecider(int decisionFrequency,\n+      final HighHeapUsageClusterRca highHeapUsageClusterRca, LargeHeapClusterRca largeHeapClusterRca) {\n     //TODO : refactor parent class to remove evalIntervalSeconds completely\n     super(5, decisionFrequency);\n     oldGenDecisionPolicy = new OldGenDecisionPolicy(highHeapUsageClusterRca);\n+    jvmScaleUpPolicy = new JvmScaleUpPolicy(largeHeapClusterRca, TimeUnit.DAYS.toSeconds(2) / 5);", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkyODQ5MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500928490", "bodyText": "done. <Resolving other comments instead of replying 'done' multiple times>", "author": "ktkrg", "createdAt": "2020-10-07T11:11:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcxNTUxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcxNTkxNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499715917", "bodyText": "nit: newline at end of file", "author": "sidheart", "createdAt": "2020-10-05T16:14:13Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/configs/HighOldGenOccupancyRcaConfig.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.configs;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.RcaConf;\n+\n+public class HighOldGenOccupancyRcaConfig {\n+\n+  private static final String RCA_NAME = \"HighOldGenOccupancyRca\";\n+  public static final long DEFAULT_UTILIZATION = 75;\n+  public static final long DEFAULT_EVALUATION_INTERVAL_IN_S = 60;\n+  private final Long heapUtilizationThreshold;\n+\n+  private final long evaluationIntervalInS;\n+\n+  public HighOldGenOccupancyRcaConfig(final RcaConf conf) {\n+    this.evaluationIntervalInS = conf.readRcaConfig(RCA_NAME,\n+        HighOldGenOccupancyRcaConfigKeys.EVALUATION_INTERVAL_IN_S.toString(),\n+        DEFAULT_EVALUATION_INTERVAL_IN_S, Long.class);\n+\n+    this.heapUtilizationThreshold = conf\n+        .readRcaConfig(RCA_NAME, HighOldGenOccupancyRcaConfigKeys.HEAP_UTILIZATION_THRESHOLD\n+            .toString(), DEFAULT_UTILIZATION, Long.class);\n+  }\n+\n+  enum HighOldGenOccupancyRcaConfigKeys {\n+    HEAP_UTILIZATION_THRESHOLD(\"heap-utilization-threshold\"),\n+    EVALUATION_INTERVAL_IN_S(\"eval-interval-in-s\");\n+\n+    private final String value;\n+\n+    HighOldGenOccupancyRcaConfigKeys(final String value) {\n+      this.value = value;\n+    }\n+\n+\n+    @Override\n+    public String toString() {\n+      return this.value;\n+    }\n+\n+  }\n+\n+  public Long getHeapUtilizationThreshold() {\n+    return heapUtilizationThreshold;\n+  }\n+\n+  public long getEvaluationIntervalInS() {\n+    return evaluationIntervalInS;\n+  }\n+}", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcxNjA1Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499716053", "bodyText": "Add preamble", "author": "sidheart", "createdAt": "2020-10-05T16:14:26Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/jvm/sizing/JvmScaleUpPolicy.java", "diffHunk": "@@ -0,0 +1,145 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.jvm.sizing;", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcxNjI1NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499716254", "bodyText": "Add preamble", "author": "sidheart", "createdAt": "2020-10-05T16:14:43Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/SizeUpJvmAction.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions;", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcxNzE1OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499717159", "bodyText": "Add preamble", "author": "sidheart", "createdAt": "2020-10-05T16:16:05Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/configs/JvmScaleUpPolicyConfig.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.configs;", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcyMTU4NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499721585", "bodyText": "Remove?", "author": "sidheart", "createdAt": "2020-10-05T16:23:05Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/ElasticSearchAnalysisGraph.java", "diffHunk": "@@ -298,6 +322,7 @@ private void constructShardResourceUsageGraph() {\n     Metric cpuUtilization = new CPU_Utilization(EVALUATION_INTERVAL_SECONDS);\n     Metric ioTotThroughput = new IO_TotThroughput(EVALUATION_INTERVAL_SECONDS);\n     Metric ioTotSyscallRate = new IO_TotalSyscallRate(EVALUATION_INTERVAL_SECONDS);\n+    new File(\"/\").getTotalSpace();", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcyMjA4MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499722080", "bodyText": "nit: can we have a static variable called EVERY_MINUTE or something for this 12?", "author": "sidheart", "createdAt": "2020-10-05T16:23:59Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/ElasticSearchAnalysisGraph.java", "diffHunk": "@@ -172,8 +177,27 @@ public void construct() {\n     hotNodeClusterRca.addTag(TAG_LOCUS, LOCUS_MASTER_NODE);\n     hotNodeClusterRca.addAllUpstreams(Collections.singletonList(hotJVMNodeRca));\n \n+    final HighOldGenOccupancyRca oldGenOccupancyRca = new HighOldGenOccupancyRca(heapMax, heapUsed);\n+    oldGenOccupancyRca.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    oldGenOccupancyRca.addAllUpstreams(Arrays.asList(heapMax, heapUsed));\n+\n+    final OldGenReclamationRca oldGenReclamationRca = new OldGenReclamationRca(heapUsed,\n+        heapMax, gcEvent);\n+    oldGenReclamationRca.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    oldGenReclamationRca.addAllUpstreams(Arrays.asList(heapUsed, heapMax, gcEvent));\n+\n+    final OldGenContendedRca oldGenContendedRca = new OldGenContendedRca(oldGenOccupancyRca,\n+        oldGenReclamationRca);\n+    oldGenContendedRca.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+    oldGenContendedRca.addAllUpstreams(Arrays.asList(oldGenOccupancyRca, oldGenReclamationRca));\n+\n+    final LargeHeapClusterRca largeHeapClusterRca = new LargeHeapClusterRca(oldGenContendedRca);\n+    largeHeapClusterRca.addTag(TAG_LOCUS, LOCUS_MASTER_NODE);\n+    largeHeapClusterRca.addAllUpstreams(Collections.singletonList(oldGenContendedRca));\n+    largeHeapClusterRca.addTag(TAG_AGGREGATE_UPSTREAM, LOCUS_DATA_NODE);\n+\n     // Heap Health Decider\n-    HeapHealthDecider heapHealthDecider = new HeapHealthDecider(12, highHeapUsageClusterRca);\n+    HeapHealthDecider heapHealthDecider = new HeapHealthDecider(12, highHeapUsageClusterRca, largeHeapClusterRca);", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczMDMwMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499730303", "bodyText": "Add preamble", "author": "sidheart", "createdAt": "2020-10-05T16:38:02Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/jvmsizing/LargeHeapClusterRca.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing;", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczNDQzNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499734436", "bodyText": "You check UNHEALTHY here but you set CONTENDED in the RCA", "author": "sidheart", "createdAt": "2020-10-05T16:45:04Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/jvmsizing/LargeHeapClusterRca.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class LargeHeapClusterRca extends Rca<ResourceFlowUnit<HotClusterSummary>> {\n+\n+  private static final Logger LOG = LogManager.getLogger(LargeHeapClusterRca.class);\n+  private static final long EVAL_INTERVAL_IN_S = 5;\n+\n+  private Rca<ResourceFlowUnit<HotNodeSummary>> oldGenContendedRca;\n+\n+  public LargeHeapClusterRca(final Rca<ResourceFlowUnit<HotNodeSummary>> oldGenContendedRca) {\n+    super(EVAL_INTERVAL_IN_S);\n+    this.oldGenContendedRca = oldGenContendedRca;\n+  }\n+\n+  @Override\n+  public void generateFlowUnitListFromWire(FlowUnitOperationArgWrapper args) {\n+    throw new UnsupportedOperationException(\"generateFlowUnitListFromWire is not supported on the\"\n+        + \" node-local RCA: \" + args.getNode().name());\n+  }\n+\n+  @Override\n+  public ResourceFlowUnit<HotClusterSummary> operate() {\n+    List<ResourceFlowUnit<HotNodeSummary>> oldGenContendedFlowUnits = oldGenContendedRca\n+        .getFlowUnits();\n+    List<HotNodeSummary> unhealthyNodeSummaries = new ArrayList<>();\n+    long currTime = System.currentTimeMillis();\n+    for (ResourceFlowUnit<HotNodeSummary> flowUnit : oldGenContendedFlowUnits) {\n+      if (flowUnit.isEmpty()) {\n+        continue;\n+      }\n+\n+      if (flowUnit.getResourceContext().isUnhealthy()) {", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA0NTcyNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500045726", "bodyText": "isUnhealthy checks for both contended and unhealthy", "author": "ktkrg", "createdAt": "2020-10-06T06:57:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczNDQzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczNTk1NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499735955", "bodyText": "nit: I think we need a ConversionUtil class at this point", "author": "sidheart", "createdAt": "2020-10-05T16:47:43Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/jvmsizing/OldGenReclamationRca.java", "diffHunk": "@@ -0,0 +1,147 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing;\n+\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.OLD_GEN;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.TOT_FULL_GC;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.HeapDimension.MEM_TYPE;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.persist.SQLParsingUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.ResourceUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.hotheap.HighHeapUsageOldGenRca.MinOldGenSlidingWindow;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+public class OldGenReclamationRca extends Rca<ResourceFlowUnit<HotResourceSummary>> {\n+\n+  private static final long EVAL_INTERVAL_IN_S = 5;\n+  private static final double DEFAULT_TARGET_UTILIZATION_AFTER_GC = 75.0d;\n+  private static final long DEFAULT_RCA_EVALUATION_INTERVAL_IN_S = 60;\n+  private static final long B_TO_MB = 1024 * 1024;", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkyOTgyMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500929821", "bodyText": "I've tried to eliminate redundant definitions of the same constant, so you should see less of these in this PR, but as a general codebase hygiene I agree, we should create a Util class for this as a separate PR.", "author": "ktkrg", "createdAt": "2020-10-07T11:14:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczNTk1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTczOTAxMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499739011", "bodyText": "nit: use parentheses for order of operations", "author": "sidheart", "createdAt": "2020-10-05T16:52:54Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/jvmsizing/OldGenReclamationRca.java", "diffHunk": "@@ -0,0 +1,147 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing;\n+\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.OLD_GEN;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.TOT_FULL_GC;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.HeapDimension.MEM_TYPE;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.persist.SQLParsingUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.ResourceUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.hotheap.HighHeapUsageOldGenRca.MinOldGenSlidingWindow;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+public class OldGenReclamationRca extends Rca<ResourceFlowUnit<HotResourceSummary>> {\n+\n+  private static final long EVAL_INTERVAL_IN_S = 5;\n+  private static final double DEFAULT_TARGET_UTILIZATION_AFTER_GC = 75.0d;\n+  private static final long DEFAULT_RCA_EVALUATION_INTERVAL_IN_S = 60;\n+  private static final long B_TO_MB = 1024 * 1024;\n+\n+  private final MinOldGenSlidingWindow minOldGenSlidingWindow;\n+  private final SlidingWindow<SlidingWindowData> gcEventsSlidingWindow;\n+\n+  private Metric heapUsed;\n+  private Metric gcEvent;\n+  private Metric heapMax;\n+  private HotResourceSummary prevSummary;\n+  private ResourceContext prevContext;\n+  private double targetHeapUtilizationAfterGc;\n+  private long rcaEvaluationIntervalInS;\n+  private long rcaPeriod;\n+  private int samples;\n+\n+  public OldGenReclamationRca(final Metric heapUsed, final Metric heapMax, final Metric gcEvent) {\n+    this(heapUsed, heapMax, gcEvent, DEFAULT_TARGET_UTILIZATION_AFTER_GC,\n+        DEFAULT_RCA_EVALUATION_INTERVAL_IN_S);\n+  }\n+\n+  public OldGenReclamationRca(final Metric heapUsed, final Metric heapMax, final Metric gcEvent,\n+      final double targetHeapUtilizationAfterGc, final long rcaEvaluationIntervalInS) {\n+    super(EVAL_INTERVAL_IN_S);\n+    this.heapUsed = heapUsed;\n+    this.gcEvent = gcEvent;\n+    this.heapMax = heapMax;\n+    this.targetHeapUtilizationAfterGc = targetHeapUtilizationAfterGc;\n+    this.rcaEvaluationIntervalInS = rcaEvaluationIntervalInS;\n+    this.rcaPeriod = rcaEvaluationIntervalInS / EVAL_INTERVAL_IN_S;\n+    this.samples = 0;\n+    this.minOldGenSlidingWindow = new MinOldGenSlidingWindow(1, TimeUnit.MINUTES);\n+    this.gcEventsSlidingWindow = new SlidingWindow<>(1, TimeUnit.MINUTES);\n+    this.prevContext = new ResourceContext(State.UNKNOWN);\n+    this.prevSummary = null;\n+  }\n+\n+  @Override\n+  public void generateFlowUnitListFromWire(FlowUnitOperationArgWrapper args) {\n+    throw new UnsupportedOperationException(\"generateFlowUnitListFromWire should not be called \"\n+        + \"for node-local rca: \" + args.getNode().name());\n+  }\n+\n+  @Override\n+  public ResourceFlowUnit<HotResourceSummary> operate() {\n+    samples++;\n+    double oldGenMax = getOldGenValueForMetric(heapMax);\n+    double oldGenUsed = getOldGenValueForMetric(heapUsed);\n+    double gcEvents = getGcEvents();\n+    long currTime = System.currentTimeMillis();\n+    minOldGenSlidingWindow.next(new SlidingWindowData(currTime, oldGenUsed));\n+    gcEventsSlidingWindow.next(new SlidingWindowData(currTime, gcEvents));\n+\n+    if (samples == rcaPeriod) {\n+      samples = 0;\n+      double events = gcEventsSlidingWindow.readSum();\n+      if (events >= 1) {\n+        double threshold = targetHeapUtilizationAfterGc / 100d * oldGenMax;", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0MTEwOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499741109", "bodyText": "readMin() is O(1) but calling it twice isn't threadsafe. Save the result in a variable and use it in lines 88 and 90 and 96", "author": "sidheart", "createdAt": "2020-10-05T16:56:32Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/jvmsizing/OldGenReclamationRca.java", "diffHunk": "@@ -0,0 +1,147 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing;\n+\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.OLD_GEN;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.TOT_FULL_GC;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.HeapDimension.MEM_TYPE;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.persist.SQLParsingUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.ResourceUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.hotheap.HighHeapUsageOldGenRca.MinOldGenSlidingWindow;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+public class OldGenReclamationRca extends Rca<ResourceFlowUnit<HotResourceSummary>> {\n+\n+  private static final long EVAL_INTERVAL_IN_S = 5;\n+  private static final double DEFAULT_TARGET_UTILIZATION_AFTER_GC = 75.0d;\n+  private static final long DEFAULT_RCA_EVALUATION_INTERVAL_IN_S = 60;\n+  private static final long B_TO_MB = 1024 * 1024;\n+\n+  private final MinOldGenSlidingWindow minOldGenSlidingWindow;\n+  private final SlidingWindow<SlidingWindowData> gcEventsSlidingWindow;\n+\n+  private Metric heapUsed;\n+  private Metric gcEvent;\n+  private Metric heapMax;\n+  private HotResourceSummary prevSummary;\n+  private ResourceContext prevContext;\n+  private double targetHeapUtilizationAfterGc;\n+  private long rcaEvaluationIntervalInS;\n+  private long rcaPeriod;\n+  private int samples;\n+\n+  public OldGenReclamationRca(final Metric heapUsed, final Metric heapMax, final Metric gcEvent) {\n+    this(heapUsed, heapMax, gcEvent, DEFAULT_TARGET_UTILIZATION_AFTER_GC,\n+        DEFAULT_RCA_EVALUATION_INTERVAL_IN_S);\n+  }\n+\n+  public OldGenReclamationRca(final Metric heapUsed, final Metric heapMax, final Metric gcEvent,\n+      final double targetHeapUtilizationAfterGc, final long rcaEvaluationIntervalInS) {\n+    super(EVAL_INTERVAL_IN_S);\n+    this.heapUsed = heapUsed;\n+    this.gcEvent = gcEvent;\n+    this.heapMax = heapMax;\n+    this.targetHeapUtilizationAfterGc = targetHeapUtilizationAfterGc;\n+    this.rcaEvaluationIntervalInS = rcaEvaluationIntervalInS;\n+    this.rcaPeriod = rcaEvaluationIntervalInS / EVAL_INTERVAL_IN_S;\n+    this.samples = 0;\n+    this.minOldGenSlidingWindow = new MinOldGenSlidingWindow(1, TimeUnit.MINUTES);\n+    this.gcEventsSlidingWindow = new SlidingWindow<>(1, TimeUnit.MINUTES);\n+    this.prevContext = new ResourceContext(State.UNKNOWN);\n+    this.prevSummary = null;\n+  }\n+\n+  @Override\n+  public void generateFlowUnitListFromWire(FlowUnitOperationArgWrapper args) {\n+    throw new UnsupportedOperationException(\"generateFlowUnitListFromWire should not be called \"\n+        + \"for node-local rca: \" + args.getNode().name());\n+  }\n+\n+  @Override\n+  public ResourceFlowUnit<HotResourceSummary> operate() {\n+    samples++;\n+    double oldGenMax = getOldGenValueForMetric(heapMax);\n+    double oldGenUsed = getOldGenValueForMetric(heapUsed);\n+    double gcEvents = getGcEvents();\n+    long currTime = System.currentTimeMillis();\n+    minOldGenSlidingWindow.next(new SlidingWindowData(currTime, oldGenUsed));\n+    gcEventsSlidingWindow.next(new SlidingWindowData(currTime, gcEvents));\n+\n+    if (samples == rcaPeriod) {\n+      samples = 0;\n+      double events = gcEventsSlidingWindow.readSum();\n+      if (events >= 1) {\n+        double threshold = targetHeapUtilizationAfterGc / 100d * oldGenMax;\n+        HotResourceSummary summary = null;\n+        ResourceContext context = null;\n+        if (minOldGenSlidingWindow.readMin() > threshold) {", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzNTcxNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500935714", "bodyText": "The operate method will only be called from one thread, so next(E e) and readMin() always happen in the right order. Multiple threads don't concurrently call this method. Not sure where the thread safety issue is arising from. I don't think we are sharing any static state too in the min sliding window class. Where are you seeing such inconsistencies?", "author": "ktkrg", "createdAt": "2020-10-07T11:25:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0MTEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3MTY5OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r501371699", "bodyText": "If anyone else modifies minOldGenSlidingWindow, or it's backed by an implementation that removes entries on a schedule instead of a write, this may be inconsistent.\nIt isn't inconsistent right now, so I won't block on this, but it's a pretty simple fix.", "author": "sidheart", "createdAt": "2020-10-07T23:45:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0MTEwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0MjY2NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499742665", "bodyText": "I don't know what this 60 means, can you create a variable for it?", "author": "sidheart", "createdAt": "2020-10-05T16:59:14Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/jvmsizing/OldGenReclamationRca.java", "diffHunk": "@@ -0,0 +1,147 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing;\n+\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.OLD_GEN;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.TOT_FULL_GC;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.HeapDimension.MEM_TYPE;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.persist.SQLParsingUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.ResourceUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.hotheap.HighHeapUsageOldGenRca.MinOldGenSlidingWindow;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+public class OldGenReclamationRca extends Rca<ResourceFlowUnit<HotResourceSummary>> {\n+\n+  private static final long EVAL_INTERVAL_IN_S = 5;\n+  private static final double DEFAULT_TARGET_UTILIZATION_AFTER_GC = 75.0d;\n+  private static final long DEFAULT_RCA_EVALUATION_INTERVAL_IN_S = 60;\n+  private static final long B_TO_MB = 1024 * 1024;\n+\n+  private final MinOldGenSlidingWindow minOldGenSlidingWindow;\n+  private final SlidingWindow<SlidingWindowData> gcEventsSlidingWindow;\n+\n+  private Metric heapUsed;\n+  private Metric gcEvent;\n+  private Metric heapMax;\n+  private HotResourceSummary prevSummary;\n+  private ResourceContext prevContext;\n+  private double targetHeapUtilizationAfterGc;\n+  private long rcaEvaluationIntervalInS;\n+  private long rcaPeriod;\n+  private int samples;\n+\n+  public OldGenReclamationRca(final Metric heapUsed, final Metric heapMax, final Metric gcEvent) {\n+    this(heapUsed, heapMax, gcEvent, DEFAULT_TARGET_UTILIZATION_AFTER_GC,\n+        DEFAULT_RCA_EVALUATION_INTERVAL_IN_S);\n+  }\n+\n+  public OldGenReclamationRca(final Metric heapUsed, final Metric heapMax, final Metric gcEvent,\n+      final double targetHeapUtilizationAfterGc, final long rcaEvaluationIntervalInS) {\n+    super(EVAL_INTERVAL_IN_S);\n+    this.heapUsed = heapUsed;\n+    this.gcEvent = gcEvent;\n+    this.heapMax = heapMax;\n+    this.targetHeapUtilizationAfterGc = targetHeapUtilizationAfterGc;\n+    this.rcaEvaluationIntervalInS = rcaEvaluationIntervalInS;\n+    this.rcaPeriod = rcaEvaluationIntervalInS / EVAL_INTERVAL_IN_S;\n+    this.samples = 0;\n+    this.minOldGenSlidingWindow = new MinOldGenSlidingWindow(1, TimeUnit.MINUTES);\n+    this.gcEventsSlidingWindow = new SlidingWindow<>(1, TimeUnit.MINUTES);\n+    this.prevContext = new ResourceContext(State.UNKNOWN);\n+    this.prevSummary = null;\n+  }\n+\n+  @Override\n+  public void generateFlowUnitListFromWire(FlowUnitOperationArgWrapper args) {\n+    throw new UnsupportedOperationException(\"generateFlowUnitListFromWire should not be called \"\n+        + \"for node-local rca: \" + args.getNode().name());\n+  }\n+\n+  @Override\n+  public ResourceFlowUnit<HotResourceSummary> operate() {\n+    samples++;\n+    double oldGenMax = getOldGenValueForMetric(heapMax);\n+    double oldGenUsed = getOldGenValueForMetric(heapUsed);\n+    double gcEvents = getGcEvents();\n+    long currTime = System.currentTimeMillis();\n+    minOldGenSlidingWindow.next(new SlidingWindowData(currTime, oldGenUsed));\n+    gcEventsSlidingWindow.next(new SlidingWindowData(currTime, gcEvents));\n+\n+    if (samples == rcaPeriod) {\n+      samples = 0;\n+      double events = gcEventsSlidingWindow.readSum();\n+      if (events >= 1) {\n+        double threshold = targetHeapUtilizationAfterGc / 100d * oldGenMax;\n+        HotResourceSummary summary = null;\n+        ResourceContext context = null;\n+        if (minOldGenSlidingWindow.readMin() > threshold) {\n+          summary = new HotResourceSummary(ResourceUtil.FULL_GC_EFFECTIVENESS,\n+              targetHeapUtilizationAfterGc, minOldGenSlidingWindow.readMin(), 60);", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0Mzc5Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499743796", "bodyText": "These two functions are really useful. Can you move them into a MetricUtil class so that they can be reused?", "author": "sidheart", "createdAt": "2020-10-05T17:01:13Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/jvmsizing/OldGenReclamationRca.java", "diffHunk": "@@ -0,0 +1,147 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing;\n+\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.OLD_GEN;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.TOT_FULL_GC;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.HeapDimension.MEM_TYPE;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.persist.SQLParsingUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.ResourceUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.hotheap.HighHeapUsageOldGenRca.MinOldGenSlidingWindow;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+public class OldGenReclamationRca extends Rca<ResourceFlowUnit<HotResourceSummary>> {\n+\n+  private static final long EVAL_INTERVAL_IN_S = 5;\n+  private static final double DEFAULT_TARGET_UTILIZATION_AFTER_GC = 75.0d;\n+  private static final long DEFAULT_RCA_EVALUATION_INTERVAL_IN_S = 60;\n+  private static final long B_TO_MB = 1024 * 1024;\n+\n+  private final MinOldGenSlidingWindow minOldGenSlidingWindow;\n+  private final SlidingWindow<SlidingWindowData> gcEventsSlidingWindow;\n+\n+  private Metric heapUsed;\n+  private Metric gcEvent;\n+  private Metric heapMax;\n+  private HotResourceSummary prevSummary;\n+  private ResourceContext prevContext;\n+  private double targetHeapUtilizationAfterGc;\n+  private long rcaEvaluationIntervalInS;\n+  private long rcaPeriod;\n+  private int samples;\n+\n+  public OldGenReclamationRca(final Metric heapUsed, final Metric heapMax, final Metric gcEvent) {\n+    this(heapUsed, heapMax, gcEvent, DEFAULT_TARGET_UTILIZATION_AFTER_GC,\n+        DEFAULT_RCA_EVALUATION_INTERVAL_IN_S);\n+  }\n+\n+  public OldGenReclamationRca(final Metric heapUsed, final Metric heapMax, final Metric gcEvent,\n+      final double targetHeapUtilizationAfterGc, final long rcaEvaluationIntervalInS) {\n+    super(EVAL_INTERVAL_IN_S);\n+    this.heapUsed = heapUsed;\n+    this.gcEvent = gcEvent;\n+    this.heapMax = heapMax;\n+    this.targetHeapUtilizationAfterGc = targetHeapUtilizationAfterGc;\n+    this.rcaEvaluationIntervalInS = rcaEvaluationIntervalInS;\n+    this.rcaPeriod = rcaEvaluationIntervalInS / EVAL_INTERVAL_IN_S;\n+    this.samples = 0;\n+    this.minOldGenSlidingWindow = new MinOldGenSlidingWindow(1, TimeUnit.MINUTES);\n+    this.gcEventsSlidingWindow = new SlidingWindow<>(1, TimeUnit.MINUTES);\n+    this.prevContext = new ResourceContext(State.UNKNOWN);\n+    this.prevSummary = null;\n+  }\n+\n+  @Override\n+  public void generateFlowUnitListFromWire(FlowUnitOperationArgWrapper args) {\n+    throw new UnsupportedOperationException(\"generateFlowUnitListFromWire should not be called \"\n+        + \"for node-local rca: \" + args.getNode().name());\n+  }\n+\n+  @Override\n+  public ResourceFlowUnit<HotResourceSummary> operate() {\n+    samples++;\n+    double oldGenMax = getOldGenValueForMetric(heapMax);\n+    double oldGenUsed = getOldGenValueForMetric(heapUsed);\n+    double gcEvents = getGcEvents();\n+    long currTime = System.currentTimeMillis();\n+    minOldGenSlidingWindow.next(new SlidingWindowData(currTime, oldGenUsed));\n+    gcEventsSlidingWindow.next(new SlidingWindowData(currTime, gcEvents));\n+\n+    if (samples == rcaPeriod) {\n+      samples = 0;\n+      double events = gcEventsSlidingWindow.readSum();\n+      if (events >= 1) {\n+        double threshold = targetHeapUtilizationAfterGc / 100d * oldGenMax;\n+        HotResourceSummary summary = null;\n+        ResourceContext context = null;\n+        if (minOldGenSlidingWindow.readMin() > threshold) {\n+          summary = new HotResourceSummary(ResourceUtil.FULL_GC_EFFECTIVENESS,\n+              targetHeapUtilizationAfterGc, minOldGenSlidingWindow.readMin(), 60);\n+          context = new ResourceContext(State.UNHEALTHY);\n+\n+          return new ResourceFlowUnit<>(currTime, context, summary);\n+        } else {\n+          summary = new HotResourceSummary(ResourceUtil.FULL_GC_EFFECTIVENESS,\n+              targetHeapUtilizationAfterGc, minOldGenSlidingWindow.readMin(), 60);\n+          context = new ResourceContext(State.HEALTHY);\n+        }\n+\n+        prevSummary = summary;\n+        prevContext = context;\n+\n+        return new ResourceFlowUnit<>(currTime, context, summary);\n+      }\n+    }\n+\n+    return new ResourceFlowUnit<>(currTime, prevContext, prevSummary);\n+  }\n+\n+  private double getGcEvents() {\n+    List<MetricFlowUnit> gcEventMetricFlowUnits = gcEvent.getFlowUnits();\n+    double metricValue = 0d;\n+    for (final MetricFlowUnit gcEventMetricFlowUnit : gcEventMetricFlowUnits) {\n+      if (gcEventMetricFlowUnit.isEmpty()) {\n+        continue;\n+      }\n+\n+      double ret = SQLParsingUtil.readDataFromSqlResult(gcEventMetricFlowUnit.getData(),\n+          MEM_TYPE.getField(),\n+          TOT_FULL_GC.toString(), MetricsDB.MAX);\n+      if (!Double.isNaN(ret)) {\n+        metricValue = ret;\n+      }\n+    }\n+\n+    return metricValue;\n+  }\n+\n+  private double getOldGenValueForMetric(Metric heapMetric) {\n+    List<MetricFlowUnit> heapMetricFlowUnits = heapMetric.getFlowUnits();\n+    double metricValue = 0d;\n+    for (final MetricFlowUnit heapMetricFlowUnit : heapMetricFlowUnits) {\n+      if (heapMetricFlowUnit.isEmpty()) {\n+        continue;\n+      }", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzNzUwNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500937504", "bodyText": "Instead of putting them in a static class, I've reduced duplication by abstracting these old gen related methods into an abstract class OldGenRca from which other old gen profiling RCAs extend.", "author": "ktkrg", "createdAt": "2020-10-07T11:29:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0Mzc5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0NDQ4MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499744481", "bodyText": "I get that this is a guess, but isn't the default for CMS to run at 75%? Should we set the default slightly lower to 70?", "author": "sidheart", "createdAt": "2020-10-05T17:02:35Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/jvmsizing/OldGenReclamationRca.java", "diffHunk": "@@ -0,0 +1,147 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing;\n+\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.OLD_GEN;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.TOT_FULL_GC;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.HeapDimension.MEM_TYPE;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.persist.SQLParsingUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.ResourceUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.hotheap.HighHeapUsageOldGenRca.MinOldGenSlidingWindow;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+public class OldGenReclamationRca extends Rca<ResourceFlowUnit<HotResourceSummary>> {\n+\n+  private static final long EVAL_INTERVAL_IN_S = 5;\n+  private static final double DEFAULT_TARGET_UTILIZATION_AFTER_GC = 75.0d;", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzODg4Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500938887", "bodyText": "I intentionally set it to the same value as the CMS threshold. My idea was to see how many times we end up with an ineffective collection where even after the collection ends, we still are above the threshold(so that CMS schedules another collection in the future)", "author": "ktkrg", "createdAt": "2020-10-07T11:31:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0NDQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0NTYzNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499745637", "bodyText": "A MetricUtil class for queries of this form would be great", "author": "sidheart", "createdAt": "2020-10-05T17:04:37Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/jvmsizing/HighOldGenOccupancyRca.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing;\n+\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.OLD_GEN;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.HeapDimension.MEM_TYPE;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.configs.HighOldGenOccupancyRcaConfig;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.persist.SQLParsingUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.ResourceUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.RcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class HighOldGenOccupancyRca extends Rca<ResourceFlowUnit<HotResourceSummary>> {\n+\n+  private static final Logger LOG = LogManager.getLogger(HighOldGenOccupancyRca.class);\n+  private static final long EVAL_INTERVAL_IN_S = 5;\n+  private static final int B_TO_MB = 1024 * 1024;\n+\n+  private final Metric heapUsed;\n+  private final Metric heapMax;\n+  private final SlidingWindow<SlidingWindowData> oldGenUtilizationSlidingWindow;\n+\n+  private long heapUtilizationThreshold;\n+  private long rcaEvaluationIntervalInS;\n+  private long rcaSamplesBeforeEval;\n+  private long samples;\n+\n+  /**\n+   * Create HighOldGenOccupancyRca with default values.\n+   * @param heapMax The heapMax metric.\n+   * @param heapUsed The heapUsed metric.\n+   */\n+  public HighOldGenOccupancyRca(final Metric heapMax, final Metric heapUsed) {\n+    this(heapMax, heapUsed, HighOldGenOccupancyRcaConfig.DEFAULT_UTILIZATION,\n+        HighOldGenOccupancyRcaConfig.DEFAULT_EVALUATION_INTERVAL_IN_S);\n+  }\n+\n+  public HighOldGenOccupancyRca(final Metric heapMax, final Metric heapUsed,\n+      final long heapUtilizationThreshold, final long rcaEvaluationIntervalInS) {\n+    super(EVAL_INTERVAL_IN_S);\n+    this.oldGenUtilizationSlidingWindow = new SlidingWindow<>(1, TimeUnit.MINUTES);\n+    this.heapUsed = heapUsed;\n+    this.heapMax = heapMax;\n+    this.heapUtilizationThreshold = heapUtilizationThreshold;\n+    this.rcaEvaluationIntervalInS = rcaEvaluationIntervalInS;\n+    this.rcaSamplesBeforeEval = rcaEvaluationIntervalInS / EVAL_INTERVAL_IN_S;\n+    this.samples = 0;\n+  }\n+\n+  @Override\n+  public void generateFlowUnitListFromWire(FlowUnitOperationArgWrapper args) {\n+    throw new UnsupportedOperationException(\"generateFlowUnitListFromWire should not be called \"\n+        + \"for node-local rca: \" + args.getNode().name());\n+  }\n+\n+  @Override\n+  public ResourceFlowUnit<HotResourceSummary> operate() {\n+    samples++;\n+    addToSlidingWindow();\n+    if (samples == rcaSamplesBeforeEval) {\n+      samples = 0;\n+      return evaluateAndEmit();\n+    }\n+\n+    return new ResourceFlowUnit<>(System.currentTimeMillis());\n+  }\n+\n+  private ResourceFlowUnit<HotResourceSummary> evaluateAndEmit() {\n+    long currTime = System.currentTimeMillis();\n+    double averageUtilizationPercentage = oldGenUtilizationSlidingWindow.readAvg();\n+    ResourceContext context = new ResourceContext(State.HEALTHY);\n+    HotResourceSummary summary = new HotResourceSummary(ResourceUtil.OLD_GEN_HEAP_USAGE,\n+        (double)heapUtilizationThreshold,\n+        averageUtilizationPercentage, (int)rcaEvaluationIntervalInS);\n+    if (averageUtilizationPercentage >= heapUtilizationThreshold) {\n+      context = new ResourceContext(State.UNHEALTHY);\n+    }\n+    return new ResourceFlowUnit<>(currTime, context, summary);\n+  }\n+\n+  private void addToSlidingWindow() {\n+    double oldGenUsed = getOldGenValueForMetric(heapUsed);\n+    double maxOldGen = getOldGenValueForMetric(heapMax);\n+\n+    if (maxOldGen == 0d) {\n+      LOG.info(\"Max Old Gen capacity cannot be 0. Skipping.\");\n+    }\n+\n+    this.oldGenUtilizationSlidingWindow.next(new SlidingWindowData(System.currentTimeMillis(),\n+        oldGenUsed / maxOldGen * 100d));\n+  }\n+\n+  private double getOldGenValueForMetric(Metric heapMetric) {\n+    List<MetricFlowUnit> heapMetricFlowUnits = heapMetric.getFlowUnits();\n+    double metricValue = 0d;\n+    for (final MetricFlowUnit heapMetricFlowUnit : heapMetricFlowUnits) {\n+      if (heapMetricFlowUnit.isEmpty()) {\n+        continue;\n+      }\n+\n+      double ret = SQLParsingUtil.readDataFromSqlResult(heapMetricFlowUnit.getData(),\n+          MEM_TYPE.getField(),\n+          OLD_GEN.toString(), MetricsDB.MAX);\n+      if (!Double.isNaN(ret)) {\n+        metricValue = ret / B_TO_MB;\n+      }\n+    }\n+\n+    return metricValue;\n+  }", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0NjUwOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r499746508", "bodyText": "nit: parentheses for order of operations instead of relying on L to R evaluation", "author": "sidheart", "createdAt": "2020-10-05T17:06:14Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/jvmsizing/HighOldGenOccupancyRca.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing;\n+\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.OLD_GEN;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.HeapDimension.MEM_TYPE;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.configs.HighOldGenOccupancyRcaConfig;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.persist.SQLParsingUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.ResourceUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.RcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class HighOldGenOccupancyRca extends Rca<ResourceFlowUnit<HotResourceSummary>> {\n+\n+  private static final Logger LOG = LogManager.getLogger(HighOldGenOccupancyRca.class);\n+  private static final long EVAL_INTERVAL_IN_S = 5;\n+  private static final int B_TO_MB = 1024 * 1024;\n+\n+  private final Metric heapUsed;\n+  private final Metric heapMax;\n+  private final SlidingWindow<SlidingWindowData> oldGenUtilizationSlidingWindow;\n+\n+  private long heapUtilizationThreshold;\n+  private long rcaEvaluationIntervalInS;\n+  private long rcaSamplesBeforeEval;\n+  private long samples;\n+\n+  /**\n+   * Create HighOldGenOccupancyRca with default values.\n+   * @param heapMax The heapMax metric.\n+   * @param heapUsed The heapUsed metric.\n+   */\n+  public HighOldGenOccupancyRca(final Metric heapMax, final Metric heapUsed) {\n+    this(heapMax, heapUsed, HighOldGenOccupancyRcaConfig.DEFAULT_UTILIZATION,\n+        HighOldGenOccupancyRcaConfig.DEFAULT_EVALUATION_INTERVAL_IN_S);\n+  }\n+\n+  public HighOldGenOccupancyRca(final Metric heapMax, final Metric heapUsed,\n+      final long heapUtilizationThreshold, final long rcaEvaluationIntervalInS) {\n+    super(EVAL_INTERVAL_IN_S);\n+    this.oldGenUtilizationSlidingWindow = new SlidingWindow<>(1, TimeUnit.MINUTES);\n+    this.heapUsed = heapUsed;\n+    this.heapMax = heapMax;\n+    this.heapUtilizationThreshold = heapUtilizationThreshold;\n+    this.rcaEvaluationIntervalInS = rcaEvaluationIntervalInS;\n+    this.rcaSamplesBeforeEval = rcaEvaluationIntervalInS / EVAL_INTERVAL_IN_S;\n+    this.samples = 0;\n+  }\n+\n+  @Override\n+  public void generateFlowUnitListFromWire(FlowUnitOperationArgWrapper args) {\n+    throw new UnsupportedOperationException(\"generateFlowUnitListFromWire should not be called \"\n+        + \"for node-local rca: \" + args.getNode().name());\n+  }\n+\n+  @Override\n+  public ResourceFlowUnit<HotResourceSummary> operate() {\n+    samples++;\n+    addToSlidingWindow();\n+    if (samples == rcaSamplesBeforeEval) {\n+      samples = 0;\n+      return evaluateAndEmit();\n+    }\n+\n+    return new ResourceFlowUnit<>(System.currentTimeMillis());\n+  }\n+\n+  private ResourceFlowUnit<HotResourceSummary> evaluateAndEmit() {\n+    long currTime = System.currentTimeMillis();\n+    double averageUtilizationPercentage = oldGenUtilizationSlidingWindow.readAvg();\n+    ResourceContext context = new ResourceContext(State.HEALTHY);\n+    HotResourceSummary summary = new HotResourceSummary(ResourceUtil.OLD_GEN_HEAP_USAGE,\n+        (double)heapUtilizationThreshold,\n+        averageUtilizationPercentage, (int)rcaEvaluationIntervalInS);\n+    if (averageUtilizationPercentage >= heapUtilizationThreshold) {\n+      context = new ResourceContext(State.UNHEALTHY);\n+    }\n+    return new ResourceFlowUnit<>(currTime, context, summary);\n+  }\n+\n+  private void addToSlidingWindow() {\n+    double oldGenUsed = getOldGenValueForMetric(heapUsed);\n+    double maxOldGen = getOldGenValueForMetric(heapMax);\n+\n+    if (maxOldGen == 0d) {\n+      LOG.info(\"Max Old Gen capacity cannot be 0. Skipping.\");\n+    }\n+\n+    this.oldGenUtilizationSlidingWindow.next(new SlidingWindowData(System.currentTimeMillis(),\n+        oldGenUsed / maxOldGen * 100d));", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA0ODI2Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500048267", "bodyText": "+1. do we really need the *100 here or should we just work with decimals ( [0,1] values)?", "author": "vigyasharma", "createdAt": "2020-10-06T07:03:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0NjUwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzOTg4NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500939884", "bodyText": "done, but kept the 100 just so that percentage looks normal. This was just a personal preference.", "author": "ktkrg", "createdAt": "2020-10-07T11:33:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0NjUwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgwNjI5Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r497806296", "bodyText": "Isn't this going to be all data nodes?", "author": "vigyasharma", "createdAt": "2020-09-30T21:18:22Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/SizeUpJvmAction.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Dimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+public class SizeUpJvmAction extends SuppressibleAction {\n+\n+  public static final String NAME = \"SizeUpJvmAction\";\n+  private static final String SUMMARY = \"Update heap size to 128GB\";\n+  private final boolean canUpdate;\n+  private final NodeKey esNode;\n+  private static final long DEFAULT_COOL_OFF_PERIOD_IN_MILLIS = TimeUnit.DAYS.toMillis(3);\n+  private static final long GB_TO_B = 1024 * 1024 * 1024;\n+\n+  public SizeUpJvmAction(final AppContext appContext) {\n+    super(appContext);\n+    this.esNode = new NodeKey(appContext.getMyInstanceDetails());\n+    this.canUpdate = Runtime.getRuntime().totalMemory() > 200 * GB_TO_B;\n+  }\n+\n+  @Override\n+  public boolean canUpdate() {\n+    return canUpdate;\n+  }\n+\n+  @Override\n+  public long coolOffPeriodInMillis() {\n+    return DEFAULT_COOL_OFF_PERIOD_IN_MILLIS;\n+  }\n+\n+  @Override\n+  public List<NodeKey> impactedNodes() {\n+    return Collections.singletonList(esNode);\n+  }", "originalCommit": "23288c57d5f6b6ad3ef10ababe406d7a22aae67a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzOTkzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500939931", "bodyText": "good catch! changed.", "author": "ktkrg", "createdAt": "2020-10-07T11:33:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgwNjI5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgwOTY4NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r497809684", "bodyText": "Do we need this increasePressure impact? This will create conflicts with other actions.", "author": "vigyasharma", "createdAt": "2020-09-30T21:25:20Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/SizeUpJvmAction.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Dimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+public class SizeUpJvmAction extends SuppressibleAction {\n+\n+  public static final String NAME = \"SizeUpJvmAction\";\n+  private static final String SUMMARY = \"Update heap size to 128GB\";\n+  private final boolean canUpdate;\n+  private final NodeKey esNode;\n+  private static final long DEFAULT_COOL_OFF_PERIOD_IN_MILLIS = TimeUnit.DAYS.toMillis(3);\n+  private static final long GB_TO_B = 1024 * 1024 * 1024;\n+\n+  public SizeUpJvmAction(final AppContext appContext) {\n+    super(appContext);\n+    this.esNode = new NodeKey(appContext.getMyInstanceDetails());\n+    this.canUpdate = Runtime.getRuntime().totalMemory() > 200 * GB_TO_B;\n+  }\n+\n+  @Override\n+  public boolean canUpdate() {\n+    return canUpdate;\n+  }\n+\n+  @Override\n+  public long coolOffPeriodInMillis() {\n+    return DEFAULT_COOL_OFF_PERIOD_IN_MILLIS;\n+  }\n+\n+  @Override\n+  public List<NodeKey> impactedNodes() {\n+    return Collections.singletonList(esNode);\n+  }\n+\n+  @Override\n+  public Map<NodeKey, ImpactVector> impact() {\n+    final ImpactVector impactVector = new ImpactVector();\n+    impactVector.increasesPressure(Dimension.RAM, Dimension.DISK, Dimension.CPU);", "originalCommit": "23288c57d5f6b6ad3ef10ababe406d7a22aae67a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk0MDA1Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500940053", "bodyText": "agreed. removed the increasePressure set.", "author": "ktkrg", "createdAt": "2020-10-07T11:34:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgwOTY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA0NjYwOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500046608", "bodyText": "cast to double?", "author": "vigyasharma", "createdAt": "2020-10-06T06:59:36Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/jvm/sizing/JvmScaleUpPolicy.java", "diffHunk": "@@ -0,0 +1,145 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.jvm.sizing;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.SizeUpJvmAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.DecisionPolicy;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.configs.JvmScaleUpPolicyConfig;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.RcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing.LargeHeapClusterRca;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+public class JvmScaleUpPolicy implements DecisionPolicy {\n+\n+  private final LargeHeapClusterRca largeHeapClusterRca;\n+  private AppContext appContext;\n+  private RcaConf rcaConf;\n+  private PerNodeSlidingWindow perNodeSlidingWindow;\n+  private long evalFrequency;\n+  private long counter;\n+  private int unhealthyNodePercentage;\n+  private int minimumMinutesUnhealthy;\n+\n+  public JvmScaleUpPolicy(final LargeHeapClusterRca largeHeapClusterRca,\n+      final long policyEvaluationFrequency) {\n+    this.largeHeapClusterRca = largeHeapClusterRca;\n+    this.evalFrequency = policyEvaluationFrequency;\n+    this.counter = 0;\n+    this.perNodeSlidingWindow = new PerNodeSlidingWindow(4, TimeUnit.DAYS);\n+  }\n+\n+  @Override\n+  public List<Action> evaluate() {\n+    counter++;\n+    addToSlidingWindow();\n+    if (counter == evalFrequency) {\n+      counter = 0;\n+      return evaluateAndEmit();\n+    }\n+\n+    return Collections.emptyList();\n+  }\n+\n+  private void addToSlidingWindow() {\n+    long currTime = System.currentTimeMillis();\n+    if (largeHeapClusterRca.getFlowUnits().isEmpty()) {\n+      return;\n+    }\n+    ResourceFlowUnit<HotClusterSummary> flowUnit = largeHeapClusterRca.getFlowUnits().get(0);\n+\n+    if (flowUnit.getSummary() == null) {\n+      return;\n+    }\n+    List<HotNodeSummary> hotNodeSummaries = flowUnit.getSummary().getHotNodeSummaryList();\n+    hotNodeSummaries.forEach(hotNodeSummary -> {\n+      NodeKey nodeKey = new NodeKey(hotNodeSummary.getNodeID(), hotNodeSummary.getHostAddress());\n+      perNodeSlidingWindow.next(nodeKey, new SlidingWindowData(currTime, 1d));\n+    });\n+  }\n+\n+  private List<Action> evaluateAndEmit() {\n+    List<Action> actions = new ArrayList<>();\n+    int numNodesInCluster = appContext.getAllClusterInstances().size();\n+    int numNodesInClusterUndersizedOldGen = getUnderSizedOldGenCount();\n+\n+    if (numNodesInClusterUndersizedOldGen * 100 / numNodesInCluster >= unhealthyNodePercentage) {", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk0MDM3OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500940379", "bodyText": "done", "author": "ktkrg", "createdAt": "2020-10-07T11:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA0NjYwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1MDgwOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500050808", "bodyText": "Isn't the HighHeapUsageOldGenRca doing something similar with minOldGenSlidingWindow ? can we reuse flow units from there?", "author": "vigyasharma", "createdAt": "2020-10-06T07:08:43Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/jvmsizing/OldGenReclamationRca.java", "diffHunk": "@@ -0,0 +1,147 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing;\n+\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.OLD_GEN;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.TOT_FULL_GC;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.HeapDimension.MEM_TYPE;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.persist.SQLParsingUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.ResourceUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.scheduler.FlowUnitOperationArgWrapper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.hotheap.HighHeapUsageOldGenRca.MinOldGenSlidingWindow;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+public class OldGenReclamationRca extends Rca<ResourceFlowUnit<HotResourceSummary>> {\n+\n+  private static final long EVAL_INTERVAL_IN_S = 5;\n+  private static final double DEFAULT_TARGET_UTILIZATION_AFTER_GC = 75.0d;\n+  private static final long DEFAULT_RCA_EVALUATION_INTERVAL_IN_S = 60;\n+  private static final long B_TO_MB = 1024 * 1024;\n+\n+  private final MinOldGenSlidingWindow minOldGenSlidingWindow;\n+  private final SlidingWindow<SlidingWindowData> gcEventsSlidingWindow;\n+\n+  private Metric heapUsed;\n+  private Metric gcEvent;\n+  private Metric heapMax;\n+  private HotResourceSummary prevSummary;\n+  private ResourceContext prevContext;\n+  private double targetHeapUtilizationAfterGc;\n+  private long rcaEvaluationIntervalInS;\n+  private long rcaPeriod;\n+  private int samples;\n+\n+  public OldGenReclamationRca(final Metric heapUsed, final Metric heapMax, final Metric gcEvent) {\n+    this(heapUsed, heapMax, gcEvent, DEFAULT_TARGET_UTILIZATION_AFTER_GC,\n+        DEFAULT_RCA_EVALUATION_INTERVAL_IN_S);\n+  }\n+\n+  public OldGenReclamationRca(final Metric heapUsed, final Metric heapMax, final Metric gcEvent,", "originalCommit": "3a293ff61af29d43ceca1fc7b7898ec8ce5cb3dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk0MDI0NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r500940244", "bodyText": "They're similar, but I decided to keep them separate in case one needs to change independently of the other. I've reduced duplication though. Added a base oldgen class that contains common methods used by old gen rcas, like using minOldGenSlidingWindow to get heap usage after gc, and getting max(and used) size for old gen.", "author": "ktkrg", "createdAt": "2020-10-07T11:34:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1MDgwOA=="}], "type": "inlineReview"}, {"oid": "86e423bddbc81b1176154c2b5b0fffeb7fda8ddc", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/86e423bddbc81b1176154c2b5b0fffeb7fda8ddc", "message": "Reduce duplication, address comments", "committedDate": "2020-10-07T11:08:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM3MDY3MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r501370670", "bodyText": "Nice! Once both our PRs are merged, we should consolidate them so that we reuse computations like this.", "author": "sidheart", "createdAt": "2020-10-07T23:41:31Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/OldGenRca.java", "diffHunk": "@@ -0,0 +1,155 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca;\n+\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.OLD_GEN;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType.TOT_FULL_GC;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.HeapDimension.MEM_TYPE;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Rca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.persist.SQLParsingUtil;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public abstract class OldGenRca<T extends ResourceFlowUnit<?>> extends Rca<T> {", "originalCommit": "86e423bddbc81b1176154c2b5b0fffeb7fda8ddc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3d982e1dadf031eb59ed8e756119de5d44c85ece", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/3d982e1dadf031eb59ed8e756119de5d44c85ece", "message": "Merge from master", "committedDate": "2020-10-08T00:39:50Z", "type": "commit"}, {"oid": "e7368b36aa079bfda3a3a375fadbfe1b1b5a5b72", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e7368b36aa079bfda3a3a375fadbfe1b1b5a5b72", "message": "Use AlarmMonitor instead of sliding window", "committedDate": "2020-10-09T01:09:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwNTQzMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r501305430", "bodyText": "nit: can just do prevActionList = evaluateAndEmit(); (and just call it actionList)", "author": "vigyasharma", "createdAt": "2020-10-07T20:57:26Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/jvm/sizing/HeapSizeIncreasePolicy.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.jvm.sizing;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.HeapSizeIncreaseAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.DecisionPolicy;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.configs.JvmScaleUpPolicyConfig;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.RcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing.LargeHeapClusterRca;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+public class HeapSizeIncreasePolicy implements DecisionPolicy {\n+\n+  private final LargeHeapClusterRca largeHeapClusterRca;\n+  private AppContext appContext;\n+  private RcaConf rcaConf;\n+  private PerNodeSlidingWindow perNodeSlidingWindow;\n+  private long evalFrequency;\n+  private long counter;\n+  private int unhealthyNodePercentage;\n+  private int minimumMinutesUnhealthy;\n+\n+  private List<Action> prevActionList;\n+\n+  public HeapSizeIncreasePolicy(final LargeHeapClusterRca largeHeapClusterRca,\n+      final long policyEvaluationFrequency) {\n+    this.largeHeapClusterRca = largeHeapClusterRca;\n+    this.evalFrequency = policyEvaluationFrequency;\n+    this.counter = 0;\n+    this.perNodeSlidingWindow = new PerNodeSlidingWindow(4, TimeUnit.DAYS);\n+    this.prevActionList = new ArrayList<>();\n+  }\n+\n+  @Override\n+  public List<Action> evaluate() {\n+    counter++;\n+    addToSlidingWindow();\n+    if (counter == evalFrequency) {\n+      counter = 0;\n+      List<Action> actions = evaluateAndEmit();\n+      prevActionList.clear();\n+      prevActionList.addAll(actions);", "originalCommit": "86e423bddbc81b1176154c2b5b0fffeb7fda8ddc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU1NzE0Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502557146", "bodyText": "Using the alarm monitor now, so I'm not following this pattern anymore, and returning whatever was the evaluation.", "author": "ktkrg", "createdAt": "2020-10-09T16:53:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwNTQzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwODEwOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r501308109", "bodyText": "Are you planning to replace the PerNodeSlidingWindows with JvmActionsAlarmMonitor ? If/when we use that, then we can check for healthy/unhealthy in every cycle instead of once every 2 days. That will let us move to healthy/unhealthy alarm states faster.", "author": "vigyasharma", "createdAt": "2020-10-07T21:02:30Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/jvm/HeapHealthDecider.java", "diffHunk": "@@ -20,23 +20,31 @@\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.Decider;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.Decision;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.jvm.old_gen.OldGenDecisionPolicy;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.jvm.sizing.HeapSizeIncreasePolicy;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.RcaConf;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.HighHeapUsageClusterRca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing.LargeHeapClusterRca;\n import java.util.List;\n+import java.util.concurrent.TimeUnit;\n \n /**\n  * decider to bring down heap usage in young gen / old gen\n  */\n public class HeapHealthDecider extends Decider {\n \n+  private static final int EVAL_INTERVAL_IN_S = 5;\n   public static final String NAME = \"HeapHealthDecider\";\n   private final OldGenDecisionPolicy oldGenDecisionPolicy;\n+  private final HeapSizeIncreasePolicy heapSizeIncreasePolicy;\n   private int counter = 0;\n \n-  public HeapHealthDecider(int decisionFrequency, final HighHeapUsageClusterRca highHeapUsageClusterRca) {\n+  public HeapHealthDecider(int decisionFrequency,\n+      final HighHeapUsageClusterRca highHeapUsageClusterRca, LargeHeapClusterRca largeHeapClusterRca) {\n     //TODO : refactor parent class to remove evalIntervalSeconds completely\n-    super(5, decisionFrequency);\n+    super(EVAL_INTERVAL_IN_S, decisionFrequency);\n     oldGenDecisionPolicy = new OldGenDecisionPolicy(highHeapUsageClusterRca);\n+    heapSizeIncreasePolicy = new HeapSizeIncreasePolicy(largeHeapClusterRca,\n+        TimeUnit.DAYS.toSeconds(2) / EVAL_INTERVAL_IN_S);", "originalCommit": "86e423bddbc81b1176154c2b5b0fffeb7fda8ddc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU1NzIxNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502557214", "bodyText": "Yes, using it now.", "author": "ktkrg", "createdAt": "2020-10-09T16:54:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwODEwOQ=="}], "type": "inlineReview"}, {"oid": "55499a17c3e8dbe28d64fcc8afbc847cb57715fb", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/55499a17c3e8dbe28d64fcc8afbc847cb57715fb", "message": "Add unit tests for the policy and the action", "committedDate": "2020-10-09T08:56:17Z", "type": "commit"}, {"oid": "11d98127634eb848716636b04af1189b4658a504", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/11d98127634eb848716636b04af1189b4658a504", "message": "Add unit tests for the RCAs", "committedDate": "2020-10-09T09:49:32Z", "type": "commit"}, {"oid": "2ba0fa1a995e50822df233cbb659c790955d104c", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/2ba0fa1a995e50822df233cbb659c790955d104c", "message": "Merge branch 'master' into 128g", "committedDate": "2020-10-09T16:28:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU3NTQyMg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502575422", "bodyText": "javax.annotation provides @nonnull, is there a reason you're using this specific import?", "author": "sidheart", "createdAt": "2020-10-09T17:29:28Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/HeapSizeIncreaseAction.java", "diffHunk": "@@ -18,12 +18,12 @@\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Dimension;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n-import java.util.ArrayList;\n-import java.util.Collections;\n+import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.concurrent.TimeUnit;\n import java.util.stream.Collectors;\n+import org.checkerframework.checker.nullness.qual.NonNull;", "originalCommit": "2ba0fa1a995e50822df233cbb659c790955d104c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU4OTY3Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502589677", "bodyText": "right, wanted to use Findbug's nonnull itself. We don't run checker framework checks yet.", "author": "ktkrg", "createdAt": "2020-10-09T17:58:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU3NTQyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU3NjAzMg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502576032", "bodyText": "See other comment, is this correct?", "author": "sidheart", "createdAt": "2020-10-09T17:30:36Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/jvm/sizing/HeapSizeIncreasePolicy.java", "diffHunk": "@@ -18,60 +18,63 @@\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.HeapSizeIncreaseAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.AlarmMonitor;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.DecisionPolicy;\n-import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.configs.JvmScaleUpPolicyConfig;\n-import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindow;\n-import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators.SlidingWindowData;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.jvm.JvmActionsAlarmMonitor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.configs.HeapSizeIncreasePolicyConfig;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.RcaConf;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing.LargeHeapClusterRca;\n+import com.google.common.annotations.VisibleForTesting;\n import java.util.ArrayList;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n-import java.util.concurrent.TimeUnit;\n+import org.checkerframework.checker.nullness.qual.NonNull;", "originalCommit": "2ba0fa1a995e50822df233cbb659c790955d104c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU3NzA2Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502577067", "bodyText": "Good enough for L0, can you add a TODO comment here, I think we can reduce the amount of memory this consumes by making a custom SlidingWindow for L1", "author": "sidheart", "createdAt": "2020-10-09T17:32:45Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/jvm/sizing/HeapSizeIncreasePolicy.java", "diffHunk": "@@ -84,71 +87,41 @@ private void addToSlidingWindow() {\n     List<HotNodeSummary> hotNodeSummaries = flowUnit.getSummary().getHotNodeSummaryList();\n     hotNodeSummaries.forEach(hotNodeSummary -> {\n       NodeKey nodeKey = new NodeKey(hotNodeSummary.getNodeID(), hotNodeSummary.getHostAddress());\n-      perNodeSlidingWindow.next(nodeKey, new SlidingWindowData(currTime, 1d));\n+      heapSizeIncreaseClusterMonitor.recordIssue(nodeKey, currTime);\n     });\n   }\n \n-  private List<Action> evaluateAndEmit() {\n-    List<Action> actions = new ArrayList<>();\n-    int numNodesInCluster = appContext.getAllClusterInstances().size();\n-    int numNodesInClusterUndersizedOldGen = getUnderSizedOldGenCount();\n+  private class HeapSizeIncreaseClusterMonitor {\n \n-    if ((numNodesInClusterUndersizedOldGen / (double) numNodesInCluster) * 100d >= unhealthyNodePercentage) {\n-      Action jvmSizeUpAction = new HeapSizeIncreaseAction(appContext);\n-      if (jvmSizeUpAction.isActionable()) {\n-        actions.add(jvmSizeUpAction);\n-      }\n-    }\n+    private static final int DEFAULT_DAY_BREACH_THRESHOLD = 8;\n+    private static final int DEFAULT_WEEK_BREACH_THRESHOLD = 3;\n+    private final Map<NodeKey, AlarmMonitor> perNodeMonitor;", "originalCommit": "2ba0fa1a995e50822df233cbb659c790955d104c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU4MzI4NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502583284", "bodyText": "I thought so too. It's already a 1000 line PR, didn't want to add to it, and also cover it in testing for this time.", "author": "ktkrg", "createdAt": "2020-10-09T17:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU3NzA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU3OTE3OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502579179", "bodyText": "Is this key still relevant?", "author": "sidheart", "createdAt": "2020-10-09T17:37:14Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/configs/HeapSizeIncreasePolicyConfig.java", "diffHunk": "@@ -26,24 +26,25 @@\n \n   private final int minUnhealthyMinutes;\n \n-  public JvmScaleUpPolicyConfig(final RcaConf rcaConf) {\n+  public HeapSizeIncreasePolicyConfig(final RcaConf rcaConf) {\n     this.unhealthyNodePercentage = rcaConf.readRcaConfig(POLICY_NAME,\n-        ScaleUpPolicyKeys.UNHEALTHY_NODE_PERCENTAGE_KEY.toString(), DEFAULT_UNHEALTHY_NODE_PERCENTAGE\n-        , Integer.class);\n+        HeapSizeIncreasePolicyKeys.UNHEALTHY_NODE_PERCENTAGE_KEY.toString(),\n+        DEFAULT_UNHEALTHY_NODE_PERCENTAGE, Integer.class);\n     this.minUnhealthyMinutes = rcaConf.readRcaConfig(POLICY_NAME,\n-        ScaleUpPolicyKeys.MIN_UNHEALTHY_MINUTES_KEY.toString(), DEFAULT_MIN_UNHEALTHY_MINUTES,\n+        HeapSizeIncreasePolicyKeys.MIN_UNHEALTHY_MINUTES_KEY.toString(), DEFAULT_MIN_UNHEALTHY_MINUTES,\n         Integer.class);\n   }\n \n-  enum ScaleUpPolicyKeys {\n+  enum HeapSizeIncreasePolicyKeys {\n     UNHEALTHY_NODE_PERCENTAGE_KEY(\"unhealthy-node-percentage\"),\n     MIN_UNHEALTHY_MINUTES_KEY(\"min-unhealthy-minutes\");", "originalCommit": "2ba0fa1a995e50822df233cbb659c790955d104c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU4OTc2Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502589763", "bodyText": "Right, that key is not needed.", "author": "ktkrg", "createdAt": "2020-10-09T17:58:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU3OTE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU4MDQ2Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502580467", "bodyText": "Did this cause a bug somewhere? Is this a necessary change?", "author": "sidheart", "createdAt": "2020-10-09T17:39:44Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/summaries/HotClusterSummary.java", "diffHunk": "@@ -57,6 +57,7 @@ public HotClusterSummary(int numOfNodes, int numOfUnhealthyNodes) {\n     super();\n     this.numOfNodes = numOfNodes;\n     this.numOfUnhealthyNodes = numOfUnhealthyNodes;\n+    this.hotNodeSummaryList = new ArrayList<>();", "originalCommit": "2ba0fa1a995e50822df233cbb659c790955d104c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU4NTY2OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502585668", "bodyText": "yes, caused an NPE without it.", "author": "ktkrg", "createdAt": "2020-10-09T17:50:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU4MDQ2Nw=="}], "type": "inlineReview"}, {"oid": "4be44b80d765ac1fb0997d4865584f3443e099e5", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/4be44b80d765ac1fb0997d4865584f3443e099e5", "message": "Address PR comments", "committedDate": "2020-10-09T17:59:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcwMjkyNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502702926", "bodyText": "Check cache and queue actions. We've been using summary() and fromSummary() methods to serialize/deserialize the full action for decision table/api/validations etc. let's keep this in the same format.", "author": "vigyasharma", "createdAt": "2020-10-09T22:50:00Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/HeapSizeIncreaseAction.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.ImpactVector.Dimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import javax.annotation.Nonnull;\n+\n+public class HeapSizeIncreaseAction extends SuppressibleAction {\n+\n+  public static final String NAME = \"HeapSizeIncreaseAction\";\n+  private static final String SUMMARY = \"Update heap size to 128GB\";\n+  private final boolean canUpdate;\n+  private final NodeKey esNode;\n+  private static final long DEFAULT_COOL_OFF_PERIOD_IN_MILLIS = TimeUnit.DAYS.toMillis(3);\n+  private static final long GB_TO_B = 1024 * 1024 * 1024;\n+\n+  public HeapSizeIncreaseAction(@Nonnull final AppContext appContext) {\n+    super(appContext);\n+    this.esNode = new NodeKey(appContext.getMyInstanceDetails());\n+    this.canUpdate = Runtime.getRuntime().totalMemory() > 200 * GB_TO_B;\n+  }\n+\n+  @Override\n+  public boolean canUpdate() {\n+    return canUpdate;\n+  }\n+\n+  @Override\n+  public long coolOffPeriodInMillis() {\n+    return DEFAULT_COOL_OFF_PERIOD_IN_MILLIS;\n+  }\n+\n+  @Override\n+  public List<NodeKey> impactedNodes() {\n+\n+    return appContext.getDataNodeInstances()\n+                     .stream()\n+                     .map(NodeKey::new).collect(Collectors.toList());\n+  }\n+\n+  @Override\n+  public Map<NodeKey, ImpactVector> impact() {\n+    final Map<NodeKey, ImpactVector> impactMap = new HashMap<>();\n+    for (NodeKey nodeKey : impactedNodes()) {\n+      final ImpactVector impactVector = new ImpactVector();\n+      impactVector.decreasesPressure(Dimension.HEAP);\n+      impactMap.put(nodeKey, impactVector);\n+    }\n+\n+    return impactMap;\n+  }\n+\n+  @Override\n+  public String name() {\n+    return NAME;\n+  }\n+\n+  @Override\n+  public String summary() {", "originalCommit": "4be44b80d765ac1fb0997d4865584f3443e099e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ0NjEwMg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503446102", "bodyText": "Done.", "author": "ktkrg", "createdAt": "2020-10-12T17:49:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcwMjkyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcwNDkxNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502704917", "bodyText": "Can we just pass new HeapSizeIncreaseClusterMonitor() from the other constructor?", "author": "vigyasharma", "createdAt": "2020-10-09T22:58:11Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/jvm/sizing/HeapSizeIncreasePolicy.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.jvm.sizing;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.HeapSizeIncreaseAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.AlarmMonitor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.DecisionPolicy;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.jvm.JvmActionsAlarmMonitor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.configs.HeapSizeIncreasePolicyConfig;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.RcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing.LargeHeapClusterRca;\n+import com.google.common.annotations.VisibleForTesting;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nonnull;\n+\n+public class HeapSizeIncreasePolicy implements DecisionPolicy {\n+\n+  private final LargeHeapClusterRca largeHeapClusterRca;\n+  private AppContext appContext;\n+  private RcaConf rcaConf;\n+  private final HeapSizeIncreaseClusterMonitor heapSizeIncreaseClusterMonitor;\n+\n+  private int unhealthyNodePercentage;\n+\n+  public HeapSizeIncreasePolicy(final LargeHeapClusterRca largeHeapClusterRca) {\n+    this(largeHeapClusterRca, null);\n+  }\n+\n+  public HeapSizeIncreasePolicy(final LargeHeapClusterRca largeHeapClusterRca,\n+      final HeapSizeIncreaseClusterMonitor clusterMonitor) {\n+    this.largeHeapClusterRca = largeHeapClusterRca;\n+    if (clusterMonitor != null) {\n+      this.heapSizeIncreaseClusterMonitor = clusterMonitor;\n+    } else {\n+      this.heapSizeIncreaseClusterMonitor = new HeapSizeIncreaseClusterMonitor();", "originalCommit": "4be44b80d765ac1fb0997d4865584f3443e099e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ0NjM0NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503446344", "bodyText": "Removed the other constructor. Thought I would need it for unit testing, but I didn't need it.", "author": "ktkrg", "createdAt": "2020-10-12T17:50:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcwNDkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcwNTEzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502705131", "bodyText": "is this line needed?", "author": "vigyasharma", "createdAt": "2020-10-09T22:59:15Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/jvm/sizing/HeapSizeIncreasePolicy.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.jvm.sizing;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.HeapSizeIncreaseAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.AlarmMonitor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.DecisionPolicy;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.jvm.JvmActionsAlarmMonitor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.configs.HeapSizeIncreasePolicyConfig;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.RcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing.LargeHeapClusterRca;\n+import com.google.common.annotations.VisibleForTesting;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nonnull;\n+\n+public class HeapSizeIncreasePolicy implements DecisionPolicy {\n+\n+  private final LargeHeapClusterRca largeHeapClusterRca;\n+  private AppContext appContext;\n+  private RcaConf rcaConf;\n+  private final HeapSizeIncreaseClusterMonitor heapSizeIncreaseClusterMonitor;\n+\n+  private int unhealthyNodePercentage;\n+\n+  public HeapSizeIncreasePolicy(final LargeHeapClusterRca largeHeapClusterRca) {\n+    this(largeHeapClusterRca, null);\n+  }\n+\n+  public HeapSizeIncreasePolicy(final LargeHeapClusterRca largeHeapClusterRca,\n+      final HeapSizeIncreaseClusterMonitor clusterMonitor) {\n+    this.largeHeapClusterRca = largeHeapClusterRca;\n+    if (clusterMonitor != null) {\n+      this.heapSizeIncreaseClusterMonitor = clusterMonitor;\n+    } else {\n+      this.heapSizeIncreaseClusterMonitor = new HeapSizeIncreaseClusterMonitor();\n+    }\n+  }\n+\n+  @Override\n+  public List<Action> evaluate() {\n+    addToClusterMonitor();\n+\n+    List<Action> actions = new ArrayList<>();\n+    if (!heapSizeIncreaseClusterMonitor.isHealthy()) {\n+      Action heapSizeIncreaseAction = new HeapSizeIncreaseAction(appContext);\n+      if (heapSizeIncreaseAction.isActionable()) {\n+        actions.add(heapSizeIncreaseAction);\n+        return actions;", "originalCommit": "4be44b80d765ac1fb0997d4865584f3443e099e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ0NjM5Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503446396", "bodyText": "removed.", "author": "ktkrg", "createdAt": "2020-10-12T17:50:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcwNTEzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcwNjA5MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502706090", "bodyText": "nit: since we are not using the key here, can we simplify it with a for each loop on just the values?", "author": "vigyasharma", "createdAt": "2020-10-09T23:03:39Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/jvm/sizing/HeapSizeIncreasePolicy.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.jvm.sizing;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.HeapSizeIncreaseAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.AlarmMonitor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.DecisionPolicy;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.deciders.jvm.JvmActionsAlarmMonitor;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.configs.HeapSizeIncreasePolicyConfig;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotClusterSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.core.RcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.NodeKey;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing.LargeHeapClusterRca;\n+import com.google.common.annotations.VisibleForTesting;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nonnull;\n+\n+public class HeapSizeIncreasePolicy implements DecisionPolicy {\n+\n+  private final LargeHeapClusterRca largeHeapClusterRca;\n+  private AppContext appContext;\n+  private RcaConf rcaConf;\n+  private final HeapSizeIncreaseClusterMonitor heapSizeIncreaseClusterMonitor;\n+\n+  private int unhealthyNodePercentage;\n+\n+  public HeapSizeIncreasePolicy(final LargeHeapClusterRca largeHeapClusterRca) {\n+    this(largeHeapClusterRca, null);\n+  }\n+\n+  public HeapSizeIncreasePolicy(final LargeHeapClusterRca largeHeapClusterRca,\n+      final HeapSizeIncreaseClusterMonitor clusterMonitor) {\n+    this.largeHeapClusterRca = largeHeapClusterRca;\n+    if (clusterMonitor != null) {\n+      this.heapSizeIncreaseClusterMonitor = clusterMonitor;\n+    } else {\n+      this.heapSizeIncreaseClusterMonitor = new HeapSizeIncreaseClusterMonitor();\n+    }\n+  }\n+\n+  @Override\n+  public List<Action> evaluate() {\n+    addToClusterMonitor();\n+\n+    List<Action> actions = new ArrayList<>();\n+    if (!heapSizeIncreaseClusterMonitor.isHealthy()) {\n+      Action heapSizeIncreaseAction = new HeapSizeIncreaseAction(appContext);\n+      if (heapSizeIncreaseAction.isActionable()) {\n+        actions.add(heapSizeIncreaseAction);\n+        return actions;\n+      }\n+    }\n+\n+    return actions;\n+  }\n+\n+  private void addToClusterMonitor() {\n+    long currTime = System.currentTimeMillis();\n+    if (largeHeapClusterRca.getFlowUnits().isEmpty()) {\n+      return;\n+    }\n+    ResourceFlowUnit<HotClusterSummary> flowUnit = largeHeapClusterRca.getFlowUnits().get(0);\n+\n+    if (flowUnit.getSummary() == null) {\n+      return;\n+    }\n+    List<HotNodeSummary> hotNodeSummaries = flowUnit.getSummary().getHotNodeSummaryList();\n+    hotNodeSummaries.forEach(hotNodeSummary -> {\n+      NodeKey nodeKey = new NodeKey(hotNodeSummary.getNodeID(), hotNodeSummary.getHostAddress());\n+      heapSizeIncreaseClusterMonitor.recordIssue(nodeKey, currTime);\n+    });\n+  }\n+\n+  private class HeapSizeIncreaseClusterMonitor {\n+\n+    private static final int DEFAULT_DAY_BREACH_THRESHOLD = 8;\n+    private static final int DEFAULT_WEEK_BREACH_THRESHOLD = 3;\n+    private final Map<NodeKey, AlarmMonitor> perNodeMonitor;\n+\n+    HeapSizeIncreaseClusterMonitor() {\n+      this.perNodeMonitor = new HashMap<>();\n+    }\n+\n+    public void recordIssue(final NodeKey nodeKey, long currTimeStamp) {\n+      perNodeMonitor.computeIfAbsent(nodeKey,\n+          key -> new JvmActionsAlarmMonitor(DEFAULT_DAY_BREACH_THRESHOLD,\n+              DEFAULT_WEEK_BREACH_THRESHOLD))\n+                    .recordIssue(currTimeStamp, 1d);\n+    }\n+\n+    public boolean isHealthy() {\n+      int numDataNodesInCluster = appContext.getDataNodeInstances().size();\n+      double unhealthyCount = 0;\n+      for (Map.Entry<NodeKey, AlarmMonitor> entry : perNodeMonitor.entrySet()) {\n+        if (!entry.getValue().isHealthy()) {\n+          unhealthyCount++;\n+        }\n+      }", "originalCommit": "4be44b80d765ac1fb0997d4865584f3443e099e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ0NjQ4NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503446485", "bodyText": "done.", "author": "ktkrg", "createdAt": "2020-10-12T17:50:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcwNjA5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcwNzYyOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r502707628", "bodyText": "nit: newline", "author": "vigyasharma", "createdAt": "2020-10-09T23:10:42Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/jvmsizing/OldGenContendedRcaTest.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.jvmsizing;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.when;\n+import static org.mockito.MockitoAnnotations.initMocks;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Resources.State;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.contexts.ResourceContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.ResourceFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotResourceSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.ResourceUtil;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.util.InstanceDetails;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.util.InstanceDetails.Id;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.util.InstanceDetails.Ip;\n+import java.util.Collections;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mock;\n+\n+public class OldGenContendedRcaTest {\n+  @Mock\n+  private HighOldGenOccupancyRca mockOldGenOccupancyRca;\n+\n+  @Mock\n+  private OldGenReclamationRca mockOldGenReclamationRca;\n+\n+  @Mock\n+  private AppContext mockAppContext;\n+\n+  private final InstanceDetails currentInstance = new InstanceDetails(new Id(\"nodeId\"),\n+      new Ip(\"1.2.3.4\"), 0);\n+  private OldGenContendedRca testRca;\n+\n+  @Before\n+  public void setup() throws Exception {\n+    initMocks(this);\n+    when(mockAppContext.getMyInstanceDetails()).thenReturn(currentInstance);\n+    this.testRca = new OldGenContendedRca(mockOldGenOccupancyRca, mockOldGenReclamationRca);\n+    this.testRca.setAppContext(mockAppContext);\n+  }\n+\n+  @Test\n+  public void testEmptyDependentFlowUnits() {\n+    when(mockOldGenOccupancyRca.getFlowUnits()).thenReturn(Collections.emptyList());\n+    when(mockOldGenReclamationRca.getFlowUnits()).thenReturn(Collections.emptyList());\n+\n+    ResourceFlowUnit<HotNodeSummary> flowUnit = testRca.operate();\n+    assertTrue(flowUnit.isEmpty());\n+  }\n+\n+  @Test\n+  public void oneDependentRcaUnhealthy() {\n+    when(mockOldGenOccupancyRca.getFlowUnits()).thenReturn(Collections\n+        .singletonList(new ResourceFlowUnit<>(System.currentTimeMillis(), new ResourceContext(\n+            State.UNHEALTHY), new HotResourceSummary(ResourceUtil.OLD_GEN_HEAP_USAGE, 0d, 0d, 0))));\n+    when(mockOldGenReclamationRca.getFlowUnits()).thenReturn(Collections\n+        .singletonList(new ResourceFlowUnit<>(System.currentTimeMillis(), new ResourceContext(\n+            State.HEALTHY), new HotResourceSummary(ResourceUtil.FULL_GC_EFFECTIVENESS, 0d, 0d, 0))));\n+\n+    ResourceFlowUnit<HotNodeSummary> flowUnit = testRca.operate();\n+    assertTrue(flowUnit.isEmpty());\n+\n+\n+    when(mockOldGenOccupancyRca.getFlowUnits()).thenReturn(Collections\n+        .singletonList(new ResourceFlowUnit<>(System.currentTimeMillis(), new ResourceContext(\n+            State.HEALTHY), new HotResourceSummary(ResourceUtil.OLD_GEN_HEAP_USAGE, 0d, 0d, 0))));\n+    when(mockOldGenReclamationRca.getFlowUnits()).thenReturn(Collections\n+        .singletonList(new ResourceFlowUnit<>(System.currentTimeMillis(), new ResourceContext(\n+            State.UNHEALTHY), new HotResourceSummary(ResourceUtil.FULL_GC_EFFECTIVENESS, 0d, 0d,\n+            0))));\n+\n+    assertTrue(testRca.operate().isEmpty());\n+  }\n+\n+  @Test\n+  public void testContendedOldGen() {\n+\n+    when(mockOldGenOccupancyRca.getFlowUnits()).thenReturn(Collections\n+        .singletonList(new ResourceFlowUnit<>(System.currentTimeMillis(), new ResourceContext(\n+            State.UNHEALTHY), new HotResourceSummary(ResourceUtil.OLD_GEN_HEAP_USAGE, 0d, 0d, 0))));\n+    when(mockOldGenReclamationRca.getFlowUnits()).thenReturn(Collections\n+        .singletonList(new ResourceFlowUnit<>(System.currentTimeMillis(), new ResourceContext(\n+            State.UNHEALTHY), new HotResourceSummary(ResourceUtil.FULL_GC_EFFECTIVENESS, 0d, 0d,\n+            0))));\n+\n+    ResourceFlowUnit<HotNodeSummary> flowUnit = testRca.operate();\n+    assertFalse(flowUnit.isEmpty());\n+    assertEquals(currentInstance.getInstanceId(), flowUnit.getSummary().getNodeID());\n+    assertEquals(currentInstance.getInstanceIp(), flowUnit.getSummary().getHostAddress());\n+  }\n+\n+}", "originalCommit": "4be44b80d765ac1fb0997d4865584f3443e099e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ0NjUzNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503446536", "bodyText": "done.", "author": "ktkrg", "createdAt": "2020-10-12T17:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjcwNzYyOA=="}], "type": "inlineReview"}, {"oid": "551c25dd85f97fb5ed39dad427dd65d7901bc952", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/551c25dd85f97fb5ed39dad427dd65d7901bc952", "message": "Address PR comments, add integ test for contention", "committedDate": "2020-10-12T17:49:05Z", "type": "commit"}, {"oid": "61e0355f2ed8218d3122dc879d38ac5ed9ca8756", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/61e0355f2ed8218d3122dc879d38ac5ed9ca8756", "message": "Merge branch 'master' into 128g", "committedDate": "2020-10-12T20:45:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU2MDc5Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503560793", "bodyText": "Needs * GB_TO_B on the RHS", "author": "sidheart", "createdAt": "2020-10-12T22:14:35Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/HeapSizeIncreaseAction.java", "diffHunk": "@@ -37,7 +44,17 @@\n   public HeapSizeIncreaseAction(@Nonnull final AppContext appContext) {\n     super(appContext);\n     this.esNode = new NodeKey(appContext.getMyInstanceDetails());\n-    this.canUpdate = Runtime.getRuntime().totalMemory() > 200 * GB_TO_B;\n+    this.canUpdate = Runtime.getRuntime().totalMemory() > 200;", "originalCommit": "551c25dd85f97fb5ed39dad427dd65d7901bc952", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5MzQ3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503593471", "bodyText": "Yikes! I updated this. Looks like one of my commits was missing. Added it now.", "author": "ktkrg", "createdAt": "2020-10-12T23:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU2MDc5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU2MTY4NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503561684", "bodyText": "Undo this change and rebase, you'll get the try with resource version", "author": "sidheart", "createdAt": "2020-10-12T22:17:03Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java", "diffHunk": "@@ -92,6 +92,7 @@ protected synchronized void write() throws IOException {\n     }\n     // write to temporary file\n     writer.flush();\n+    writer.close();", "originalCommit": "551c25dd85f97fb5ed39dad427dd65d7901bc952", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5MzY0NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503593645", "bodyText": "yup, done now.", "author": "ktkrg", "createdAt": "2020-10-12T23:54:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU2MTY4NA=="}], "type": "inlineReview"}, {"oid": "752472e60e09d605d8e23d9ffaf9075faa9e7159", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/752472e60e09d605d8e23d9ffaf9075faa9e7159", "message": "Use persistable alarms, update integ test configs", "committedDate": "2020-10-12T23:51:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5NDU2NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503594565", "bodyText": "Is this correct? Won't this action be constructed on a master node?", "author": "sidheart", "createdAt": "2020-10-12T23:57:36Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/HeapSizeIncreaseAction.java", "diffHunk": "@@ -32,29 +33,36 @@\n public class HeapSizeIncreaseAction extends SuppressibleAction {\n \n   public static final String NAME = \"HeapSizeIncreaseAction\";\n-  private static final String SUMMARY = \"Update heap size to 128GB\";\n+  private static final long GB_TO_B = 1024 * 1024 * 1024;\n   private static final String ID_KEY = \"Id\";\n   private static final String IP_KEY = \"Ip\";\n+  private static final String MEMORY_THRESHOLD_KEY = \"memory-threshold\";\n   private static final String CAN_UPDATE_KEY = \"canUpdate\";\n   private final boolean canUpdate;\n   private final NodeKey esNode;\n   private static final long DEFAULT_COOL_OFF_PERIOD_IN_MILLIS = TimeUnit.DAYS.toMillis(3);\n-  private static final long GB_TO_B = 1024 * 1024 * 1024;\n+  private final long memoryThreshold;\n \n   public HeapSizeIncreaseAction(@Nonnull final AppContext appContext) {\n+    this(appContext, HeapSizeIncreasePolicyConfig.DEFAULT_MIN_TOTAL_MEM_IN_GB * GB_TO_B);\n+  }\n+\n+  public HeapSizeIncreaseAction(@Nonnull final AppContext appContext, final long memoryThreshold) {\n     super(appContext);\n     this.esNode = new NodeKey(appContext.getMyInstanceDetails());", "originalCommit": "752472e60e09d605d8e23d9ffaf9075faa9e7159", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYyNzE3NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503627174", "bodyText": "Fixed it! I was running this on a colocated master cluster which is why this slipped through the cracks. I am checking this on the data node now at the node level rca itself.", "author": "ktkrg", "createdAt": "2020-10-13T02:13:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5NDU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5NDgyOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503594828", "bodyText": "Why is there a call to super() here? Won't it just set and reset the same variables?", "author": "sidheart", "createdAt": "2020-10-12T23:58:39Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/HeapSizeIncreaseAction.java", "diffHunk": "@@ -32,29 +33,36 @@\n public class HeapSizeIncreaseAction extends SuppressibleAction {\n \n   public static final String NAME = \"HeapSizeIncreaseAction\";\n-  private static final String SUMMARY = \"Update heap size to 128GB\";\n+  private static final long GB_TO_B = 1024 * 1024 * 1024;\n   private static final String ID_KEY = \"Id\";\n   private static final String IP_KEY = \"Ip\";\n+  private static final String MEMORY_THRESHOLD_KEY = \"memory-threshold\";\n   private static final String CAN_UPDATE_KEY = \"canUpdate\";\n   private final boolean canUpdate;\n   private final NodeKey esNode;\n   private static final long DEFAULT_COOL_OFF_PERIOD_IN_MILLIS = TimeUnit.DAYS.toMillis(3);\n-  private static final long GB_TO_B = 1024 * 1024 * 1024;\n+  private final long memoryThreshold;\n \n   public HeapSizeIncreaseAction(@Nonnull final AppContext appContext) {\n+    this(appContext, HeapSizeIncreasePolicyConfig.DEFAULT_MIN_TOTAL_MEM_IN_GB * GB_TO_B);\n+  }\n+\n+  public HeapSizeIncreaseAction(@Nonnull final AppContext appContext, final long memoryThreshold) {\n     super(appContext);\n     this.esNode = new NodeKey(appContext.getMyInstanceDetails());\n-    this.canUpdate = Runtime.getRuntime().totalMemory() > 200;\n+    this.memoryThreshold = memoryThreshold;\n+    this.canUpdate = Runtime.getRuntime().totalMemory() > memoryThreshold;\n   }\n \n   /**\n    * Constructor used when building the action from a summary.\n    */\n   public HeapSizeIncreaseAction(final NodeKey nodeKey, final boolean canUpdate,\n-      final AppContext appContext) {\n+      final AppContext appContext, final long memoryThreshold) {\n     super(appContext);", "originalCommit": "752472e60e09d605d8e23d9ffaf9075faa9e7159", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYwNTI4Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503605287", "bodyText": "Call to super will only set the appContext as required by SuppressibleAction.", "author": "ktkrg", "createdAt": "2020-10-13T00:39:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5NDgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5NTY5Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503595697", "bodyText": "Neat! This is a compact way of doing it", "author": "sidheart", "createdAt": "2020-10-13T00:02:06Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/configs/HeapSizeIncreasePolicyConfig.java", "diffHunk": "@@ -19,20 +19,37 @@\n \n public class HeapSizeIncreasePolicyConfig {\n \n-  private static final String POLICY_NAME = \"HeapSizeIncreasePolicy\";\n+  private static final String POLICY_NAME = \"heap-size-increase-policy\";\n   public static final int DEFAULT_UNHEALTHY_NODE_PERCENTAGE = 50;\n+  public static final int DEFAULT_MIN_TOTAL_MEM_IN_GB = 200;\n   public static final int DEFAULT_MIN_UNHEALTHY_MINUTES = 2 * 24 * 60;\n+  private static final int DEFAULT_DAY_BREACH_THRESHOLD = 8;\n+  private static final int DEFAULT_WEEK_BREACH_THRESHOLD = 3;\n   private final int unhealthyNodePercentage;\n+  private final int dayBreachThreshold;\n+  private final int weekBreachThreshold;\n+  private final int minimumTotalMemoryInGB;\n \n \n   public HeapSizeIncreasePolicyConfig(final RcaConf rcaConf) {\n     this.unhealthyNodePercentage = rcaConf.readRcaConfig(POLICY_NAME,\n         HeapSizeIncreasePolicyKeys.UNHEALTHY_NODE_PERCENTAGE_KEY.toString(),\n         DEFAULT_UNHEALTHY_NODE_PERCENTAGE, Integer.class);\n+    this.dayBreachThreshold = rcaConf.readRcaConfig(POLICY_NAME,\n+        HeapSizeIncreasePolicyKeys.DAY_BREACH_THRESHOLD_KEY.toString(), DEFAULT_DAY_BREACH_THRESHOLD,\n+        Integer.class);\n+    this.weekBreachThreshold = rcaConf\n+        .readRcaConfig(POLICY_NAME, HeapSizeIncreasePolicyKeys.WEEK_BREACH_THRESHOLD_KEY\n+            .toString(), DEFAULT_WEEK_BREACH_THRESHOLD, Integer.class);\n+    this.minimumTotalMemoryInGB = rcaConf.readRcaConfig(POLICY_NAME,\n+        HeapSizeIncreasePolicyKeys.MIN_TOTAL_MEM_IN_GB.toString(), DEFAULT_MIN_TOTAL_MEM_IN_GB, Integer.class);\n   }\n \n   enum HeapSizeIncreasePolicyKeys {\n-    UNHEALTHY_NODE_PERCENTAGE_KEY(\"unhealthy-node-percentage\");\n+    UNHEALTHY_NODE_PERCENTAGE_KEY(\"unhealthy-node-percentage\"),\n+    DAY_BREACH_THRESHOLD_KEY(\"day-breach-threshold\"),\n+    WEEK_BREACH_THRESHOLD_KEY(\"week-breach-threshold\"),\n+    MIN_TOTAL_MEM_IN_GB(\"minimum-total-memory-in-gigabytes\");", "originalCommit": "752472e60e09d605d8e23d9ffaf9075faa9e7159", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5NjQ3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503596471", "bodyText": "This doesn't matter at all for the IT right? @ARcaGraph will be taken over this?", "author": "sidheart", "createdAt": "2020-10-13T00:05:09Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/jvmsizing/resources/rca_master.conf", "diffHunk": "@@ -0,0 +1,94 @@\n+{\n+  \"analysis-graph-implementor\":\n+    \"com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.AnalysisGraphTest\",", "originalCommit": "752472e60e09d605d8e23d9ffaf9075faa9e7159", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYwNDY5Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503604692", "bodyText": "yeah.. that's right.", "author": "ktkrg", "createdAt": "2020-10-13T00:37:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU5NjQ3MQ=="}], "type": "inlineReview"}, {"oid": "da2fd9025703306ae6a9c71c29b66b86efaf3b7d", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/da2fd9025703306ae6a9c71c29b66b86efaf3b7d", "message": "Check for memory requirement on data node instead of master node", "committedDate": "2020-10-13T02:08:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY2ODEwNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503668104", "bodyText": "Do we need this full config file? Is it possible to just pass the test config as a string here?", "author": "vigyasharma", "createdAt": "2020-10-13T05:01:59Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/jvmsizing/resources/rca.conf", "diffHunk": "@@ -0,0 +1,91 @@\n+{", "originalCommit": "da2fd9025703306ae6a9c71c29b66b86efaf3b7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI3NTEzOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r504275138", "bodyText": "I just wanted to have full confidence in the framework being able to read the relevant sections of the config file and apply them correctly.", "author": "ktkrg", "createdAt": "2020-10-13T21:41:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY2ODEwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY2ODcxOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503668718", "bodyText": "Can we check more action attributes, like impacted node IPs & IDs, cool off period, action name etc. (similar to here) ?", "author": "vigyasharma", "createdAt": "2020-10-13T05:04:28Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/jvmsizing/validator/HeapSizeIncreaseValidator.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.jvmsizing.validator;\n+\n+import static org.junit.Assert.assertTrue;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.AppContext;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.HeapSizeIncreaseAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.api.IValidator;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions.PersistedAction;\n+\n+public class HeapSizeIncreaseValidator implements IValidator {\n+\n+  AppContext appContext;\n+  long startTime;\n+\n+  public HeapSizeIncreaseValidator() {\n+    appContext = new AppContext();\n+    startTime = System.currentTimeMillis();\n+  }\n+\n+  @Override\n+  public boolean checkDbObj(Object object) {\n+    if (object == null) {\n+      return false;\n+    }\n+\n+    PersistedAction persistedAction = (PersistedAction) object;\n+    return checkPersistedAction(persistedAction);\n+  }\n+\n+  private boolean checkPersistedAction(final PersistedAction persistedAction) {", "originalCommit": "da2fd9025703306ae6a9c71c29b66b86efaf3b7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI3NTIwMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r504275203", "bodyText": "Done.", "author": "ktkrg", "createdAt": "2020-10-13T21:41:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY2ODcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY2OTMzNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r503669337", "bodyText": "We should also add an IT for Dedicated master setup. In that test, we should simulate that the dedicated master is only aggregating metrics from the data node.", "author": "vigyasharma", "createdAt": "2020-10-13T05:06:36Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/jvmsizing/HeapSizeIncreaseIT.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.jvmsizing;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.HeapDimension.Constants;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.GC_Collection_Event;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.Heap_Max;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.Heap_Used;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.RcaItMarker;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AErrorPatternIgnored;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AExpect;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AExpect.Type;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AMetric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ARcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ARcaGraph;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATable;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATuple;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.ClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.HostTag;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.runners.RcaItNotEncryptedRunner;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.jvmsizing.validator.HeapSizeIncreaseValidator;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions.PersistedAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.ElasticSearchAnalysisGraph;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+\n+@Category(RcaItMarker.class)\n+@RunWith(RcaItNotEncryptedRunner.class)\n+@AClusterType(ClusterType.MULTI_NODE_CO_LOCATED_MASTER)", "originalCommit": "da2fd9025703306ae6a9c71c29b66b86efaf3b7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI3NTI0NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r504275244", "bodyText": "Done.", "author": "ktkrg", "createdAt": "2020-10-13T21:41:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY2OTMzNw=="}], "type": "inlineReview"}, {"oid": "eca26530ae566904ede0a3cc3983025d7d81be47", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/eca26530ae566904ede0a3cc3983025d7d81be47", "message": "Add dedicated master integ test", "committedDate": "2020-10-13T21:39:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI3OTMzOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r504279339", "bodyText": "nit: remove", "author": "vigyasharma", "createdAt": "2020-10-13T21:51:07Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/jvmsizing/HighOldGenOccupancyRca.java", "diffHunk": "@@ -96,6 +101,9 @@ public void generateFlowUnitListFromWire(FlowUnitOperationArgWrapper args) {\n     if (averageUtilizationPercentage >= heapUtilizationThreshold) {\n       context = new ResourceContext(State.UNHEALTHY);\n     }\n+    this.previousSummary = summary;\n+    this.previousContext = context;\n+    LOG.warn(\"kak: returning OCCUPANCY: {}\", context.getState().toString());", "originalCommit": "eca26530ae566904ede0a3cc3983025d7d81be47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMwMDg3Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r504300876", "bodyText": "Removed.", "author": "ktkrg", "createdAt": "2020-10-13T22:45:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI3OTMzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MTQ2MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r504281461", "bodyText": "Decider should not be getting metrics from master node", "author": "vigyasharma", "createdAt": "2020-10-13T21:56:04Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/jvmsizing/HeapSizeIncreaseDedicatedMasterIT.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.jvmsizing;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.HeapDimension.Constants;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.GC_Collection_Event;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.Heap_Max;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.Heap_Used;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.RcaItMarker;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AErrorPatternIgnored;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AExpect;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AExpect.Type;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AMetric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ARcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ARcaGraph;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATable;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATuple;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.ClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.HostTag;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.runners.RcaItNotEncryptedRunner;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.jvmsizing.validator.HeapSizeIncreaseValidatorDedicatedMaster;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions.PersistedAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.ElasticSearchAnalysisGraph;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+\n+@Category(RcaItMarker.class)\n+@RunWith(RcaItNotEncryptedRunner.class)\n+@AClusterType(ClusterType.MULTI_NODE_DEDICATED_MASTER)\n+@ARcaGraph(ElasticSearchAnalysisGraph.class)\n+@ARcaConf(dataNode = JvmSizingITConstants.RCA_CONF_PATH + \"rca.conf\", electedMaster =\n+    JvmSizingITConstants.RCA_CONF_PATH + \"rca_master.conf\")\n+@AMetric(\n+    name = Heap_Max.class,\n+    dimensionNames = {Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(\n+            hostTag = HostTag.DATA_0,\n+            tuple = {\n+                @ATuple(\n+                    dimensionValues = {GCType.Constants.OLD_GEN_VALUE},\n+                    sum = 1000000000.0, avg = 1000000000.0, min = 1000000000.0, max = 1000000000.0\n+                )\n+            }\n+        ),\n+        @ATable(\n+            hostTag = HostTag.DATA_1,\n+            tuple = {\n+                @ATuple(\n+                    dimensionValues = {GCType.Constants.OLD_GEN_VALUE},\n+                    sum = 1000000000.0, avg = 1000000000.0, min = 1000000000.0, max = 1000000000.0\n+                )\n+            }\n+        ),\n+        @ATable(\n+            hostTag = HostTag.ELECTED_MASTER,", "originalCommit": "eca26530ae566904ede0a3cc3983025d7d81be47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMwMDgzNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r504300834", "bodyText": "Removed elected master metrics for the dedicated master IT.", "author": "ktkrg", "createdAt": "2020-10-13T22:45:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MTQ2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MjE0OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r504282148", "bodyText": "We should also do ITs where nodes emit different values for Heap Used and other such metrics. Plus the case where only one or two nodes are bad (<threshold) and so we don't see the action.\nThis PR is already huge, we can add these additional ITs in a separate PR.", "author": "vigyasharma", "createdAt": "2020-10-13T21:57:39Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/jvmsizing/HeapSizeIncreaseDedicatedMasterIT.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.jvmsizing;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.GCType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.HeapDimension.Constants;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.GC_Collection_Event;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.Heap_Max;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.Heap_Used;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.RcaItMarker;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AErrorPatternIgnored;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AExpect;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AExpect.Type;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AMetric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ARcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ARcaGraph;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATable;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATuple;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.ClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.HostTag;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.runners.RcaItNotEncryptedRunner;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.jvmsizing.validator.HeapSizeIncreaseValidatorDedicatedMaster;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions.PersistedAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.ElasticSearchAnalysisGraph;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+\n+@Category(RcaItMarker.class)\n+@RunWith(RcaItNotEncryptedRunner.class)\n+@AClusterType(ClusterType.MULTI_NODE_DEDICATED_MASTER)\n+@ARcaGraph(ElasticSearchAnalysisGraph.class)\n+@ARcaConf(dataNode = JvmSizingITConstants.RCA_CONF_PATH + \"rca.conf\", electedMaster =\n+    JvmSizingITConstants.RCA_CONF_PATH + \"rca_master.conf\")\n+@AMetric(\n+    name = Heap_Max.class,\n+    dimensionNames = {Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(\n+            hostTag = HostTag.DATA_0,\n+            tuple = {\n+                @ATuple(\n+                    dimensionValues = {GCType.Constants.OLD_GEN_VALUE},\n+                    sum = 1000000000.0, avg = 1000000000.0, min = 1000000000.0, max = 1000000000.0\n+                )\n+            }\n+        ),\n+        @ATable(\n+            hostTag = HostTag.DATA_1,\n+            tuple = {\n+                @ATuple(\n+                    dimensionValues = {GCType.Constants.OLD_GEN_VALUE},\n+                    sum = 1000000000.0, avg = 1000000000.0, min = 1000000000.0, max = 1000000000.0\n+                )\n+            }\n+        ),\n+        @ATable(\n+            hostTag = HostTag.ELECTED_MASTER,\n+            tuple = {\n+                @ATuple(\n+                    dimensionValues = {GCType.Constants.OLD_GEN_VALUE},\n+                    sum = 1000000000.0, avg = 1000000000.0, max = 1000000000.0, min = 1000000000.0\n+                )\n+            }\n+        )\n+    }\n+)\n+@AMetric(\n+    name = Heap_Used.class,\n+    dimensionNames = {Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(\n+            hostTag = HostTag.DATA_0,\n+            tuple = {\n+                @ATuple(\n+                    dimensionValues = {GCType.Constants.OLD_GEN_VALUE},\n+                    sum = 950000000.0, avg = 950000000.0, min = 950000000.0, max = 950000000.0\n+                )\n+            }\n+        ),\n+        @ATable(\n+            hostTag = HostTag.DATA_1,", "originalCommit": "eca26530ae566904ede0a3cc3983025d7d81be47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MjQzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r504282431", "bodyText": "Did we remove this license header?", "author": "vigyasharma", "createdAt": "2020-10-13T21:58:21Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/jvmsizing/validator/HeapSizeIncreaseValidator.java", "diffHunk": "@@ -1,28 +1,10 @@\n-/*", "originalCommit": "eca26530ae566904ede0a3cc3983025d7d81be47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMwMDkxNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r504300915", "bodyText": "Added.", "author": "ktkrg", "createdAt": "2020-10-13T22:45:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MjQzMQ=="}], "type": "inlineReview"}, {"oid": "e4ed4cd51af9b450d71659d3d54ea0696476c7a9", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e4ed4cd51af9b450d71659d3d54ea0696476c7a9", "message": "Address comments", "committedDate": "2020-10-13T22:44:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA2NTgwOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/439#discussion_r505065809", "bodyText": "good ! readability matters. Thanks a lot", "author": "yojs", "createdAt": "2020-10-14T23:29:24Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/ElasticSearchAnalysisGraph.java", "diffHunk": "@@ -110,8 +114,10 @@\n public class ElasticSearchAnalysisGraph extends AnalysisGraph {\n \n   private static final Logger LOG = LogManager.getLogger(ElasticSearchAnalysisGraph.class);\n-  private static final int RCA_PERIOD = 12;  // 1 minute. RCA_PERIOD is measured as number of EVALUATION_INTERVAL_SECONDS\n   private static final int EVALUATION_INTERVAL_SECONDS = 5;\n+  private static final int SECONDS_IN_MIN = 60;\n+  // 1 minute. RCA_PERIOD is measured as number of EVALUATION_INTERVAL_SECONDS\n+  private static final int RCA_PERIOD = SECONDS_IN_MIN / EVALUATION_INTERVAL_SECONDS;", "originalCommit": "e4ed4cd51af9b450d71659d3d54ea0696476c7a9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0d9ea04aea569bacadacaa189e1f7c21833a3b11", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/0d9ea04aea569bacadacaa189e1f7c21833a3b11", "message": "Merge branch 'master' into 128gb-heap", "committedDate": "2020-10-15T00:25:44Z", "type": "commit"}]}