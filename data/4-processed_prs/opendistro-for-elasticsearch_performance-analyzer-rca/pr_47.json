{"pr_number": 47, "pr_title": "Make _cat/master call only when rca is enabled", "pr_createdAt": "2020-01-10T20:42:12Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/47", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUwMzg4NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/47#discussion_r365503884", "bodyText": "I tend to think, it we should move it inside the startPollers(), so now just two instead of three", "author": "yojs", "createdAt": "2020-01-11T06:32:50Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -249,22 +228,26 @@ private void readRcaEnabledFromConf() {\n    * has changed in the meantime (such as a new elected master). It also starts the RCA runtime if\n    * it wasn't already running but the current state of the flag expects it to.\n    */\n-  private void startRcaNanny() {\n+  public void startNanny() {\n+    startNodeRolePoller();", "originalCommit": "dfda656a99cfa9c6409960eac3a9c72a517fea7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUwMzk2MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/47#discussion_r365503960", "bodyText": "can we use boolean ?", "author": "yojs", "createdAt": "2020-01-11T06:35:03Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/reader/ClusterDetailsEventProcessor.java", "diffHunk": "@@ -122,17 +122,19 @@ public static NodeDetails getCurrentNodeDetails() {\n   }\n \n   public static class NodeDetails {\n-\n     private String id;\n     private String hostAddress;\n     private String role;\n+    private Boolean isMasterNode;", "originalCommit": "dfda656a99cfa9c6409960eac3a9c72a517fea7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk2NzIwNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/47#discussion_r365967206", "bodyText": "This value can even be null so we will need Boolean", "author": "spardeepsingh", "createdAt": "2020-01-13T18:49:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUwMzk2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUwNDEzOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/47#discussion_r365504139", "bodyText": "Is it still required after merging with the last changes ? It never failed for me. If we think it is required, then we should add a comment explaining why this is so", "author": "yojs", "createdAt": "2020-01-11T06:39:41Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaControllerTest.java", "diffHunk": "@@ -30,6 +30,8 @@\n \n @Category(GradleTaskForRca.class)\n public class RcaControllerTest {\n+  private static final int IEVAL_ITERATIONS = 20;\n+  private static final int NODE_ROLE_EVAL_ITERATIONS = 70;", "originalCommit": "dfda656a99cfa9c6409960eac3a9c72a517fea7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk2NzYxNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/47#discussion_r365967615", "bodyText": "It is required as we are changing the periodicity of getting master node value to 60 sec. Will add a comment for that", "author": "spardeepsingh", "createdAt": "2020-01-13T18:50:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUwNDEzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMjg2NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/47#discussion_r365532864", "bodyText": "It might be cleaner to keep this method and only remove the startRcaConfPoller(); if we are incorporating that functionality in the rcaNanny()", "author": "yojs", "createdAt": "2020-01-11T17:32:48Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -133,19 +133,6 @@ public RcaController(\n     this.timeUnit = timeUnit;\n   }\n \n-  /**\n-   * Starts the pollers. Each poller is a thread that checks for the state of the system that the\n-   * RCA is concerned with. - RcaConfPoller: Periodically reads a config file to determine if RCA is\n-   * supposed to be running or not and accordingly sets a flag. - NodeRolePoller: This checks for\n-   * the change of role for an elastic search Master node. - RcaNanny: RcaConfPoller sets the flag\n-   * but this thread works to start Rca or shut it down based on the flag.\n-   */\n-  public void startPollers() {\n-    startRcaConfPoller();", "originalCommit": "67c812a56625206f6b3f1146e63a09046b116655", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMzA0Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/47#discussion_r365533047", "bodyText": "Let's not have calls to schedule inside scheduleAtFixedRate. We should have just the method references like it used to be. The expensive part was not that the another executor existed (they all use the same thread pool), but the call to getElectedMasterHostAddress.  So, let's just make the nodeRolePoller a no-op, is RCA is disabled.", "author": "yojs", "createdAt": "2020-01-11T17:36:36Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -249,22 +225,26 @@ private void readRcaEnabledFromConf() {\n    * has changed in the meantime (such as a new elected master). It also starts the RCA runtime if\n    * it wasn't already running but the current state of the flag expects it to.\n    */\n-  private void startRcaNanny() {\n+  public void startNanny() {\n     netOpsExecutorService.scheduleAtFixedRate(\n         () -> {\n-          if (rcaScheduler != null && rcaScheduler.isRunning()) {\n-            if (!rcaEnabled) {\n-              // Need to shutdown the rca scheduler\n-              stop();\n-            } else {\n+          netOpsExecutorService.schedule(this::readRcaEnabledFromConf, 1, TimeUnit.SECONDS);", "originalCommit": "67c812a56625206f6b3f1146e63a09046b116655", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b15cf701774d6b0e93586f5983391e6616735adb", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b15cf701774d6b0e93586f5983391e6616735adb", "message": "Make _cat/master call only when rca is enabled", "committedDate": "2020-01-13T20:54:35Z", "type": "commit"}, {"oid": "3f4140bf1d22ea715d342bbbac6c7c80e85ff743", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/3f4140bf1d22ea715d342bbbac6c7c80e85ff743", "message": "Change to make call to _cat/master every 60 seconds instead of 5 seconds", "committedDate": "2020-01-13T21:10:18Z", "type": "commit"}, {"oid": "483dbbbdbe8e039038712499501fb55033134ece", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/483dbbbdbe8e039038712499501fb55033134ece", "message": "Use ClusterDetailsEventProcessor to get master node value instead of making cat/master calls", "committedDate": "2020-01-13T21:23:52Z", "type": "commit"}, {"oid": "483dbbbdbe8e039038712499501fb55033134ece", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/483dbbbdbe8e039038712499501fb55033134ece", "message": "Use ClusterDetailsEventProcessor to get master node value instead of making cat/master calls", "committedDate": "2020-01-13T21:23:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA2MTUyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/47#discussion_r366061525", "bodyText": "Because this is going to make ES API call, perhaps we should have a log for now and then we can add a metric for this.", "author": "yojs", "createdAt": "2020-01-13T22:24:39Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -277,13 +276,14 @@ private String getElectedMasterHostAddress() {\n     return \"\";\n   }\n \n-  private void handleNodeRoleChange(\n-      final NodeDetails currentNode, final String electedMasterHostAddress) {\n+  private void handleNodeRoleChange(final NodeDetails currentNode) {\n     final NodeRole currentNodeRole = NodeRole.valueOf(currentNode.getRole());\n-    if (currentNode.getHostAddress().equalsIgnoreCase(electedMasterHostAddress)) {\n-      currentRole = NodeRole.ELECTED_MASTER;\n+    Boolean isMasterNode = currentNode.getIsMasterNode();\n+    if (isMasterNode != null) {\n+      currentRole = isMasterNode ? NodeRole.ELECTED_MASTER : currentNodeRole;\n     } else {\n-      currentRole = currentNodeRole;\n+      final String electedMasterHostAddress = getElectedMasterHostAddress();\n+      currentRole = currentNode.getHostAddress().equalsIgnoreCase(electedMasterHostAddress) ? NodeRole.ELECTED_MASTER : currentNodeRole;", "originalCommit": "483dbbbdbe8e039038712499501fb55033134ece", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4c3c37c0d192cbf7cfc1f201b09c9b79f7162f3e", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/4c3c37c0d192cbf7cfc1f201b09c9b79f7162f3e", "message": "Adding log statement for _cat/master call", "committedDate": "2020-01-13T22:41:37Z", "type": "commit"}]}