{"pr_number": 447, "pr_title": "Add the PersistableSlidingWindow class", "pr_createdAt": "2020-10-02T10:49:05Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447", "timeline": [{"oid": "cce6115e62a01ea5d493b871c96699c065c11b4a", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/cce6115e62a01ea5d493b871c96699c065c11b4a", "message": "Add the PersistableSlidingWindow class\n\n- A PersistableSlidingWindow is a sliding window that aggregates data\ninto buckets and can be written to and read from the disk. This makes it\nsuitable for retaining data over large spans of time requiring too much\nmemory or being susceptible to node loss.", "committedDate": "2020-10-02T10:51:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg4MjUwOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r498882508", "bodyText": "Is this functionally correct? IIUC, this expects timestampDiff to be in SECONDS, converts it to timeUnit and compares it against bucketSizeMs which is in milliseconds.\nIs timeUnit guaranteed to be in ms? Is timestampDiff guaranteed to be in seconds?", "author": "vigyasharma", "createdAt": "2020-10-02T15:10:28Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.FileRotate;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.BufferedWriter;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.io.Writer;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.commons.lang3.RandomStringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * PersistableSlidingWindow is a SlidingWindow which can have its data written to and read from disk\n+ *\n+ * <p>The sliding window retains data for slidingWindowSizeInSeconds and aggregates values into time\n+ * buckets of width bucketSizeInSeconds. For example if slidingWindowSizeInSeconds is 86400 (1 day)\n+ * and bucketSizeInSeconds is 3600 (1 hr) then there will be at most 25 data points in the sliding window\n+ * at any given time. It's 25 and not 24 because the oldest datapoints are removed lazily based on\n+ * arrival time. This shouldn't impact most consumers of this data structure.\n+ *\n+ * <p>The data contained in this sliding window is effectively a time series. Consumers may extend this\n+ * class and define more complex aggregations or analytics functions.\n+ */\n+public class PersistableSlidingWindow extends SlidingWindow<SlidingWindowData> {\n+  private static final Logger LOG = LogManager.getLogger(PersistableSlidingWindow.class);\n+  private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+  protected static final String SEPARATOR = \"\\n\";\n+\n+  private Path pathToFile;\n+\n+  protected SlidingWindowData aggregatedData;\n+  protected final double bucketSizeMs;\n+\n+  public PersistableSlidingWindow(int slidingWindowSize,\n+                                  int bucketSize,\n+                                  TimeUnit timeUnit,\n+                                  Path filePath) {\n+    super(slidingWindowSize, timeUnit);\n+    this.bucketSizeMs = timeUnit.toMillis(bucketSize);\n+    this.pathToFile = filePath;\n+    try {\n+      if (Files.exists(pathToFile)) {\n+        loadFromFile(pathToFile);\n+      } else {\n+        Files.createFile(pathToFile);\n+      }\n+    } catch (IOException e) {\n+      LOG.error(\"Couldn't create file {} to perform young generation tuning\", pathToFile, e);\n+      throw new IllegalArgumentException(\"Couldn't create or read a file at \" + filePath);\n+    }\n+  }\n+\n+  @Override\n+  public void next(SlidingWindowData slidingWindowData) {\n+    if (aggregatedData == null) {\n+      aggregatedData = new SlidingWindowData(slidingWindowData.getTimeStamp(), slidingWindowData.getValue());\n+      return;\n+    }\n+    long timestampDiff = slidingWindowData.getTimeStamp() - aggregatedData.getTimeStamp();\n+    if (timeUnit.convert(timestampDiff, TimeUnit.SECONDS) > bucketSizeMs) {", "originalCommit": "cce6115e62a01ea5d493b871c96699c065c11b4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwNTcyNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r498905726", "bodyText": "Good catch, fixed and added a UT to catch this.\nSlidingWindowData timestamps must be in ms (SlidingWindow assumes this). The bucket length and overall window size can be specified using any timeunit.", "author": "sidheart", "createdAt": "2020-10-02T15:50:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg4MjUwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg5MTc2NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r498891765", "bodyText": "This class is doing two things, it is providing a persistable sliding window, and it is aggregating (deduping) data points within a bucketization window.\nHow about we split these responsibilities and have this class focus only on persisting?\nRe: the bucketization piece, I have a few more comments - I suppose the motivation for this is to act like an alarm breach monitor which gets set when some thresholds are hit, and unset on a different criteria. This can be used in deciders then, to figure out when an action is relevant (alarm unhealthy) and irrelevant (alarm healthy).\nAs such, it may be read more often than an issue gets added (next being called) and the sliding window should get updated on each read.\nAgain, we can move this to a separate PR/class and focus this one primarily on persistence as I see most of the code here pertains to persisting data.", "author": "vigyasharma", "createdAt": "2020-10-02T15:26:13Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.FileRotate;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.BufferedWriter;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.io.Writer;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.commons.lang3.RandomStringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * PersistableSlidingWindow is a SlidingWindow which can have its data written to and read from disk\n+ *\n+ * <p>The sliding window retains data for slidingWindowSizeInSeconds and aggregates values into time\n+ * buckets of width bucketSizeInSeconds. For example if slidingWindowSizeInSeconds is 86400 (1 day)\n+ * and bucketSizeInSeconds is 3600 (1 hr) then there will be at most 25 data points in the sliding window\n+ * at any given time. It's 25 and not 24 because the oldest datapoints are removed lazily based on\n+ * arrival time. This shouldn't impact most consumers of this data structure.\n+ *\n+ * <p>The data contained in this sliding window is effectively a time series. Consumers may extend this\n+ * class and define more complex aggregations or analytics functions.\n+ */\n+public class PersistableSlidingWindow extends SlidingWindow<SlidingWindowData> {", "originalCommit": "cce6115e62a01ea5d493b871c96699c065c11b4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyNjg0NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r498926845", "bodyText": "I removed the aggregation logic from this PR.", "author": "sidheart", "createdAt": "2020-10-02T16:31:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg5MTc2NQ=="}], "type": "inlineReview"}, {"oid": "67b248349be0b0069733d805f82bd8ef2c3c2b35", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/67b248349be0b0069733d805f82bd8ef2c3c2b35", "message": "Add the PersistableSlidingWindow class\n\n- A PersistableSlidingWindow is a sliding window that aggregates data\ninto buckets and can be written to and read from the disk. This makes it\nsuitable for retaining data over large spans of time requiring too much\nmemory or being susceptible to node loss.", "committedDate": "2020-10-02T15:47:18Z", "type": "forcePushed"}, {"oid": "9ad509e36e6b6bad00f49d2c8b613df89cfe695a", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/9ad509e36e6b6bad00f49d2c8b613df89cfe695a", "message": "Add the PersistableSlidingWindow class\n\n- A PersistableSlidingWindow is a sliding window that aggregates data\ninto buckets and can be written to and read from the disk. This makes it\nsuitable for retaining data over large spans of time requiring too much\nmemory or being susceptible to node loss.", "committedDate": "2020-10-02T16:28:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyMjc5MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r499022791", "bodyText": "Is this still relevant? if not, please remove", "author": "vigyasharma", "createdAt": "2020-10-02T19:56:45Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.FileRotate;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.BufferedWriter;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Iterator;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.commons.lang3.RandomStringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * PersistableSlidingWindow is a SlidingWindow which can have its data written to and read from disk\n+ *\n+ * <p>The sliding window retains data for slidingWindowSizeInSeconds and aggregates values into time\n+ * buckets of width bucketSizeInSeconds. For example if slidingWindowSizeInSeconds is 86400 (1 day)\n+ * and bucketSizeInSeconds is 3600 (1 hr) then there will be at most 25 data points in the sliding window\n+ * at any given time. It's 25 and not 24 because the oldest datapoints are removed lazily based on\n+ * arrival time. This shouldn't impact most consumers of this data structure.", "originalCommit": "9ad509e36e6b6bad00f49d2c8b613df89cfe695a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAzNTQxMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r499035410", "bodyText": "Updated comments in PersistableSlidingWindow", "author": "sidheart", "createdAt": "2020-10-02T20:27:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyMjc5MQ=="}], "type": "inlineReview"}, {"oid": "3dd429c3f97e4aedd2e24790f30727ab3229e9bc", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/3dd429c3f97e4aedd2e24790f30727ab3229e9bc", "message": "Add the PersistableSlidingWindow class\n\n- A PersistableSlidingWindow is a sliding window that aggregates data\ninto buckets and can be written to and read from the disk. This makes it\nsuitable for retaining data over large spans of time requiring too much\nmemory or being susceptible to node loss.", "committedDate": "2020-10-02T20:27:02Z", "type": "forcePushed"}, {"oid": "2700c244aa0746324bc142c42ce634e4e34ed218", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/2700c244aa0746324bc142c42ce634e4e34ed218", "message": "Add the PersistableSlidingWindow class\n\n- A PersistableSlidingWindow is a sliding window that aggregates data\ninto buckets and can be written to and read from the disk. This makes it\nsuitable for retaining data over large spans of time requiring too much\nmemory or being susceptible to node loss.", "committedDate": "2020-10-02T20:30:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA4NDIyMg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r499084222", "bodyText": "do we want to make rotateFile() synchronized ?\nAnd can we refactor FileRotate class to make it more generic instead of using static to expose its method directly ?", "author": "rguo-aws", "createdAt": "2020-10-02T23:08:51Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.FileRotate;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.BufferedWriter;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Iterator;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.commons.lang3.RandomStringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * PersistableSlidingWindow is a SlidingWindow which can have its data written to and read from disk\n+ */\n+public class PersistableSlidingWindow extends SlidingWindow<SlidingWindowData> {\n+  private static final Logger LOG = LogManager.getLogger(PersistableSlidingWindow.class);\n+  private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+  protected static final String SEPARATOR = \"\\n\";\n+\n+  private Path pathToFile;\n+\n+  public PersistableSlidingWindow(int slidingWindowSize,\n+                                  TimeUnit timeUnit,\n+                                  Path filePath) {\n+    super(slidingWindowSize, timeUnit);\n+    this.pathToFile = filePath;\n+    try {\n+      if (Files.exists(pathToFile)) {\n+        load(pathToFile);\n+      } else {\n+        Files.createFile(pathToFile);\n+      }\n+    } catch (IOException e) {\n+      LOG.error(\"Couldn't create file {} to perform young generation tuning\", pathToFile, e);\n+      throw new IllegalArgumentException(\"Couldn't create or read a file at \" + filePath);\n+    }\n+  }\n+\n+  /**\n+   * Loads the SlidingWindowData contained in the given path into this PersistableSlidingWindow\n+   * @param path The path to the file containing the SlidingWindow data\n+   * @throws IOException If there is an error reading the file\n+   */\n+  protected void load(Path path) throws IOException {\n+    LineIterator it = FileUtils.lineIterator(path.toFile(), \"UTF-8\");\n+    try {\n+      while (it.hasNext()) {\n+        String line = it.nextLine();\n+        SlidingWindowData data = objectMapper.readValue(line, SlidingWindowData.class);\n+        next(data);\n+      }\n+    } finally {\n+      LineIterator.closeQuietly(it);\n+    }\n+  }\n+\n+  /**\n+   * Writes the contents of this SlidingWindow into the path provided during construction\n+   *\n+   * <p>This write occurs in 2 stages, it writes to a temporary file, then replaces the actual data\n+   * file with the contents of the temporary file\n+   *\n+   * @throws IOException If there is a CRUD error with the files involved\n+   */\n+  protected void write() throws IOException {\n+    String tmpFile = pathToFile.toString() + RandomStringUtils.randomAlphanumeric(32);\n+    Path tmpPath = Paths.get(tmpFile);\n+    Files.createFile(Paths.get(tmpFile));\n+    BufferedWriter writer = new BufferedWriter(new FileWriter(tmpFile, false));\n+    Iterator<SlidingWindowData> it = windowDeque.descendingIterator();\n+    while (it.hasNext()) {\n+      writer.write(objectMapper.writeValueAsString(it.next()));\n+      writer.write(SEPARATOR);\n+    }\n+    // write to temporary file\n+    writer.flush();\n+    // atomic rotate\n+    FileRotate.rotateFile(tmpPath, pathToFile);", "originalCommit": "2700c244aa0746324bc142c42ce634e4e34ed218", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg4NDQwNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r499884404", "bodyText": "I made the write and load synchronized, we don't want to make rotateFile synchronized\nFileRotate contains a lot of specific logic for logfile rotation with a date prefix. Refactoring it is out of scope. I've made minimal changes to address the thread safety issue you brought up.", "author": "sidheart", "createdAt": "2020-10-05T21:32:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA4NDIyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA4NjUxOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r499086518", "bodyText": "should we do this check within the constructor itself ? I think it would make more sense to perform this check during writing operation.", "author": "rguo-aws", "createdAt": "2020-10-02T23:21:33Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.FileRotate;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.BufferedWriter;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Iterator;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.commons.lang3.RandomStringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * PersistableSlidingWindow is a SlidingWindow which can have its data written to and read from disk\n+ */\n+public class PersistableSlidingWindow extends SlidingWindow<SlidingWindowData> {\n+  private static final Logger LOG = LogManager.getLogger(PersistableSlidingWindow.class);\n+  private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+  protected static final String SEPARATOR = \"\\n\";\n+\n+  private Path pathToFile;\n+\n+  public PersistableSlidingWindow(int slidingWindowSize,\n+                                  TimeUnit timeUnit,\n+                                  Path filePath) {\n+    super(slidingWindowSize, timeUnit);\n+    this.pathToFile = filePath;\n+    try {", "originalCommit": "2700c244aa0746324bc142c42ce634e4e34ed218", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg4NDc4MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r499884781", "bodyText": "I don't expose the load function to consumers. This class loads previous data exactly once upon construction. It doesn't need to load during write/next operations.", "author": "sidheart", "createdAt": "2020-10-05T21:33:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA4NjUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg4NTQyOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r499885429", "bodyText": "The reason I create the file here is because I need to do the check before I load. The reason this logic shouldn't live inside write() is because it would waste every single instruction to check beyond the first", "author": "sidheart", "createdAt": "2020-10-05T21:34:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA4NjUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQyOTU2NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r500429565", "bodyText": "I thought about it, and I see what you were getting at. I preserved the load in the constructor, but I removed the create file as it's unnecessary.", "author": "sidheart", "createdAt": "2020-10-06T16:20:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA4NjUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2NTEwMg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r499065102", "bodyText": "nit: We should use File.separator for compatibility.", "author": "ktkrg", "createdAt": "2020-10-02T21:50:53Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.FileRotate;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.BufferedWriter;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Iterator;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.commons.lang3.RandomStringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * PersistableSlidingWindow is a SlidingWindow which can have its data written to and read from disk\n+ */\n+public class PersistableSlidingWindow extends SlidingWindow<SlidingWindowData> {\n+  private static final Logger LOG = LogManager.getLogger(PersistableSlidingWindow.class);\n+  private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+  protected static final String SEPARATOR = \"\\n\";", "originalCommit": "2700c244aa0746324bc142c42ce634e4e34ed218", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg4NTkzNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r499885934", "bodyText": "File.separator is generally a path separator like '/'\nIn this case, I'm using a known character to separate data entries in my own file format. I renamed this to DATA_SEPARATOR to hopefully make it more clear.", "author": "sidheart", "createdAt": "2020-10-05T21:35:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2NTEwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkyOTQ1Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r499929456", "bodyText": "Thanks, not sure why I said File.separator, I was meaning to say System.lineSeparator(). As long as you use the same separator for reading and writing I'm ok.", "author": "ktkrg", "createdAt": "2020-10-05T23:42:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2NTEwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkzMjc3MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r499932770", "bodyText": "Changed to use System.lineSeparator()", "author": "sidheart", "createdAt": "2020-10-05T23:53:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2NTEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA4OTQzNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r499089435", "bodyText": "any reason why we're writing in the reverse sequential order? Won't this bring back the sliding window in the reverse order after a load?", "author": "ktkrg", "createdAt": "2020-10-02T23:37:10Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.FileRotate;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.BufferedWriter;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Iterator;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.commons.lang3.RandomStringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * PersistableSlidingWindow is a SlidingWindow which can have its data written to and read from disk\n+ */\n+public class PersistableSlidingWindow extends SlidingWindow<SlidingWindowData> {\n+  private static final Logger LOG = LogManager.getLogger(PersistableSlidingWindow.class);\n+  private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+  protected static final String SEPARATOR = \"\\n\";\n+\n+  private Path pathToFile;\n+\n+  public PersistableSlidingWindow(int slidingWindowSize,\n+                                  TimeUnit timeUnit,\n+                                  Path filePath) {\n+    super(slidingWindowSize, timeUnit);\n+    this.pathToFile = filePath;\n+    try {\n+      if (Files.exists(pathToFile)) {\n+        load(pathToFile);\n+      } else {\n+        Files.createFile(pathToFile);\n+      }\n+    } catch (IOException e) {\n+      LOG.error(\"Couldn't create file {} to perform young generation tuning\", pathToFile, e);\n+      throw new IllegalArgumentException(\"Couldn't create or read a file at \" + filePath);\n+    }\n+  }\n+\n+  /**\n+   * Loads the SlidingWindowData contained in the given path into this PersistableSlidingWindow\n+   * @param path The path to the file containing the SlidingWindow data\n+   * @throws IOException If there is an error reading the file\n+   */\n+  protected void load(Path path) throws IOException {\n+    LineIterator it = FileUtils.lineIterator(path.toFile(), \"UTF-8\");\n+    try {\n+      while (it.hasNext()) {\n+        String line = it.nextLine();\n+        SlidingWindowData data = objectMapper.readValue(line, SlidingWindowData.class);\n+        next(data);\n+      }\n+    } finally {\n+      LineIterator.closeQuietly(it);\n+    }\n+  }\n+\n+  /**\n+   * Writes the contents of this SlidingWindow into the path provided during construction\n+   *\n+   * <p>This write occurs in 2 stages, it writes to a temporary file, then replaces the actual data\n+   * file with the contents of the temporary file\n+   *\n+   * @throws IOException If there is a CRUD error with the files involved\n+   */\n+  protected void write() throws IOException {\n+    String tmpFile = pathToFile.toString() + RandomStringUtils.randomAlphanumeric(32);\n+    Path tmpPath = Paths.get(tmpFile);\n+    Files.createFile(Paths.get(tmpFile));\n+    BufferedWriter writer = new BufferedWriter(new FileWriter(tmpFile, false));\n+    Iterator<SlidingWindowData> it = windowDeque.descendingIterator();", "originalCommit": "2700c244aa0746324bc142c42ce634e4e34ed218", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg4NjQzNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r499886437", "bodyText": "This is so that things are in the correct order. Look at how SlidingWindow stores data in a LinkedList on calls to next(). Also see PersistableSlidingWindowTest#testNext(). I added an extra case to this function for extra sanity as well.", "author": "sidheart", "createdAt": "2020-10-05T21:37:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA4OTQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkyODUzMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r499928530", "bodyText": "ha! We offerFirst() and pollLast(), it makes sense now.", "author": "ktkrg", "createdAt": "2020-10-05T23:39:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA4OTQzNQ=="}], "type": "inlineReview"}, {"oid": "491cc48308aaef7ca6d785d16c893c6a78a072f4", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/491cc48308aaef7ca6d785d16c893c6a78a072f4", "message": "Add the PersistableSlidingWindow class\n\n- A PersistableSlidingWindow is a sliding window that aggregates data\ninto buckets and can be written to and read from the disk. This makes it\nsuitable for retaining data over large spans of time requiring too much\nmemory or being susceptible to node loss.", "committedDate": "2020-10-05T21:30:04Z", "type": "forcePushed"}, {"oid": "bfb9184c3e55484a115a3461756246513ed4155e", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/bfb9184c3e55484a115a3461756246513ed4155e", "message": "Add the PersistableSlidingWindow class\n\n- A PersistableSlidingWindow is a sliding window that aggregates data\ninto buckets and can be written to and read from the disk. This makes it\nsuitable for retaining data over large spans of time requiring too much\nmemory or being susceptible to node loss.", "committedDate": "2020-10-05T23:52:30Z", "type": "forcePushed"}, {"oid": "10e47b907ec8a19c7025c9e66238bb4bb9bb87e4", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/10e47b907ec8a19c7025c9e66238bb4bb9bb87e4", "message": "Add the PersistableSlidingWindow class\n\n- A PersistableSlidingWindow is a sliding window that aggregates data\ninto buckets and can be written to and read from the disk. This makes it\nsuitable for retaining data over large spans of time requiring too much\nmemory or being susceptible to node loss.", "committedDate": "2020-10-06T16:19:02Z", "type": "commit"}, {"oid": "10e47b907ec8a19c7025c9e66238bb4bb9bb87e4", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/10e47b907ec8a19c7025c9e66238bb4bb9bb87e4", "message": "Add the PersistableSlidingWindow class\n\n- A PersistableSlidingWindow is a sliding window that aggregates data\ninto buckets and can be written to and read from the disk. This makes it\nsuitable for retaining data over large spans of time requiring too much\nmemory or being susceptible to node loss.", "committedDate": "2020-10-06T16:19:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1ODU2Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r500458562", "bodyText": "Do we really need to wrap this into an IllegalArgumentException? We could leave this as the checked IOException. It will ensure that callers handle it gracefully.", "author": "vigyasharma", "createdAt": "2020-10-06T17:05:16Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.aggregators;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.FileRotate;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.BufferedWriter;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Iterator;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.commons.io.LineIterator;\n+import org.apache.commons.lang3.RandomStringUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * PersistableSlidingWindow is a SlidingWindow which can have its data written to and read from disk\n+ */\n+public class PersistableSlidingWindow extends SlidingWindow<SlidingWindowData> {\n+  private static final Logger LOG = LogManager.getLogger(PersistableSlidingWindow.class);\n+  private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+  private Path pathToFile;\n+\n+  public PersistableSlidingWindow(int slidingWindowSize,\n+                                  TimeUnit timeUnit,\n+                                  Path filePath) {\n+    super(slidingWindowSize, timeUnit);\n+    this.pathToFile = filePath;\n+    try {\n+      if (Files.exists(pathToFile)) {\n+        load(pathToFile);\n+      }\n+    } catch (IOException e) {\n+      LOG.error(\"Couldn't create file {} to perform young generation tuning\", pathToFile, e);\n+      throw new IllegalArgumentException(\"Couldn't create or read a file at \" + filePath);", "originalCommit": "10e47b907ec8a19c7025c9e66238bb4bb9bb87e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ5MTg2Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r500491866", "bodyText": "file could be accidentally deleted by operator or even some other process(i.e. log pusher). should we create a new file in case IOException occurs ?", "author": "rguo-aws", "createdAt": "2020-10-06T17:59:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1ODU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUwOTc3Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/447#discussion_r500509772", "bodyText": "I've changed this not to throw. If we can't load data on construction we'll just log an error.\nA caller who is expecting data to be loaded can check if the window is empty.\nA deleted/moved file issue will be resolved on the next call to write() as it includes an atomic move operation.", "author": "sidheart", "createdAt": "2020-10-06T18:28:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1ODU2Mg=="}], "type": "inlineReview"}, {"oid": "7e67248918802b2c44927c32f04d58eae84856e1", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/7e67248918802b2c44927c32f04d58eae84856e1", "message": "Change PersistableSlidingWindow to not throw on construction", "committedDate": "2020-10-06T18:23:27Z", "type": "commit"}]}