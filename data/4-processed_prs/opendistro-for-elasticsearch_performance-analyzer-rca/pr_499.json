{"pr_number": 499, "pr_title": "Add ITs for JVM old gen policy", "pr_createdAt": "2020-10-28T22:58:47Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/499", "timeline": [{"oid": "b519f8a7621a34dd8e36b9147d30f01a2430dbf0", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b519f8a7621a34dd8e36b9147d30f01a2430dbf0", "message": "Add ITs for JVM old gen policy. Retrieve persisted actions list from Rest endpoint", "committedDate": "2020-10-28T22:51:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyMTc4MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/499#discussion_r513821781", "bodyText": "Should we just remove it ?", "author": "yojs", "createdAt": "2020-10-28T23:30:09Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -278,7 +278,7 @@ synchronized int insertRow(String tableName, List<Object> row) throws SQLExcepti\n       recordsWithMaxFieldValue = create.select().from(tableName).where(DSL.field(field)\n               .eq(create.select(max(field)).from(tableName))).fetch();\n     } catch (DataAccessException dex) {\n-      LOG.error(\"Error querying table {}\", tableName, dex);\n+      //LOG.warn(\"Error querying table {}\", tableName, dex);", "originalCommit": "b519f8a7621a34dd8e36b9147d30f01a2430dbf0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyNjA3OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/499#discussion_r513826079", "bodyText": "Can we make this as an util class or rename as CacheClearActionSummary?", "author": "sruti1312", "createdAt": "2020-10-28T23:43:17Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/actions/CacheClearAction.java", "diffHunk": "@@ -120,4 +118,39 @@ public CacheClearAction build() {\n       return new CacheClearAction(appContext, coolOffPeriodInMillis, canUpdate);\n     }\n   }\n+\n+  public static class Summary {", "originalCommit": "b519f8a7621a34dd8e36b9147d30f01a2430dbf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgzMjM1OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/499#discussion_r513832359", "bodyText": "Since this Summary is only used as a Json container within each action class(similar to the Builder class within the action class), I would like to leave it as it is. We can make them as separate classes if needed in the future", "author": "rguo-aws", "createdAt": "2020-10-29T00:03:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyNjA3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyNzgzMg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/499#discussion_r513827832", "bodyText": "This is fixed with Sid's PR. We dont need to add them here", "author": "sruti1312", "createdAt": "2020-10-28T23:48:43Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/jvm/old_gen_policy/dedicated_master/LevelThreeDedicatedMasterITest.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.jvm.old_gen_policy.dedicated_master;\n+\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.jvm.old_gen_policy.dedicated_master.LevelThreeDedicatedMasterITest.FIELDDATA_CACHE_SIZE_IN_PERCENT;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.jvm.old_gen_policy.dedicated_master.LevelThreeDedicatedMasterITest.HEAP_MAX_SIZE_IN_BYTE;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.jvm.old_gen_policy.dedicated_master.LevelThreeDedicatedMasterITest.SHARD_REQUEST_CACHE_SIZE_IN_PERCENT;\n+import static com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cache.CacheUtil.GB_TO_BYTES;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.configs.QueueActionConfig;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolDimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.Cache_Max_Size;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.GC_Collection_Event;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.Heap_Max;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.Heap_Used;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.ThreadPool_QueueCapacity;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.RcaItMarker;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AErrorPatternIgnored;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AExpect;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AMetric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ARcaGraph;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATable;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATuple;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.ClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.HostTag;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.runners.RcaItNotEncryptedRunner;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.jvm.old_gen_policy.validator.LevelThreeValidator;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions.PersistedAction;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.ElasticSearchAnalysisGraph;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+\n+@RunWith(RcaItNotEncryptedRunner.class)\n+\n+@Category(RcaItMarker.class)\n+@AClusterType(ClusterType.MULTI_NODE_DEDICATED_MASTER)\n+@ARcaGraph(ElasticSearchAnalysisGraph.class)\n+@AMetric(name = Heap_Used.class,\n+    dimensionNames = {AllMetrics.HeapDimension.Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(hostTag = {HostTag.DATA_0},\n+            tuple = {\n+                @ATuple(dimensionValues = AllMetrics.GCType.Constants.OLD_GEN_VALUE,\n+                    sum = HEAP_MAX_SIZE_IN_BYTE * 0.96,\n+                    avg = HEAP_MAX_SIZE_IN_BYTE * 0.96,\n+                    min = HEAP_MAX_SIZE_IN_BYTE * 0.96,\n+                    max = HEAP_MAX_SIZE_IN_BYTE * 0.96),\n+            }\n+        )\n+    }\n+)\n+@AMetric(name = Heap_Max.class,\n+    dimensionNames = {AllMetrics.HeapDimension.Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(hostTag = {HostTag.DATA_0},\n+            tuple = {\n+                @ATuple(dimensionValues = AllMetrics.GCType.Constants.HEAP_VALUE,\n+                    sum = HEAP_MAX_SIZE_IN_BYTE,\n+                    avg = HEAP_MAX_SIZE_IN_BYTE,\n+                    min = HEAP_MAX_SIZE_IN_BYTE,\n+                    max = HEAP_MAX_SIZE_IN_BYTE),\n+            }\n+        )\n+    }\n+)\n+@AMetric(name = GC_Collection_Event.class,\n+    dimensionNames = {AllMetrics.HeapDimension.Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(hostTag = {HostTag.DATA_0},\n+            tuple = {\n+                @ATuple(dimensionValues = AllMetrics.GCType.Constants.TOT_FULL_GC_VALUE,\n+                    sum = 1, avg = 1, min = 1, max = 1),\n+            }\n+        )\n+    }\n+)\n+@AMetric(\n+    name = Cache_Max_Size.class,\n+    dimensionNames = {AllMetrics.CacheConfigDimension.Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(\n+            hostTag = HostTag.DATA_0,\n+            tuple = {\n+                @ATuple(\n+                    dimensionValues = {AllMetrics.CacheType.Constants.FIELD_DATA_CACHE_NAME},\n+                    sum = HEAP_MAX_SIZE_IN_BYTE * FIELDDATA_CACHE_SIZE_IN_PERCENT,\n+                    avg = HEAP_MAX_SIZE_IN_BYTE * FIELDDATA_CACHE_SIZE_IN_PERCENT,\n+                    min = HEAP_MAX_SIZE_IN_BYTE * FIELDDATA_CACHE_SIZE_IN_PERCENT,\n+                    max = HEAP_MAX_SIZE_IN_BYTE * FIELDDATA_CACHE_SIZE_IN_PERCENT),\n+                @ATuple(\n+                    dimensionValues = {AllMetrics.CacheType.Constants.SHARD_REQUEST_CACHE_NAME},\n+                    sum = HEAP_MAX_SIZE_IN_BYTE * SHARD_REQUEST_CACHE_SIZE_IN_PERCENT,\n+                    avg = HEAP_MAX_SIZE_IN_BYTE * SHARD_REQUEST_CACHE_SIZE_IN_PERCENT,\n+                    min = HEAP_MAX_SIZE_IN_BYTE * SHARD_REQUEST_CACHE_SIZE_IN_PERCENT,\n+                    max = HEAP_MAX_SIZE_IN_BYTE * SHARD_REQUEST_CACHE_SIZE_IN_PERCENT)\n+            }),\n+    })\n+@AMetric(name = ThreadPool_QueueCapacity.class,\n+    dimensionNames = {ThreadPoolDimension.Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(hostTag = HostTag.DATA_0,\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = QueueActionConfig.DEFAULT_WRITE_QUEUE_UPPER_BOUND - 200,\n+                    avg = QueueActionConfig.DEFAULT_WRITE_QUEUE_UPPER_BOUND - 200,\n+                    min = QueueActionConfig.DEFAULT_WRITE_QUEUE_UPPER_BOUND - 200,\n+                    max = QueueActionConfig.DEFAULT_WRITE_QUEUE_UPPER_BOUND - 200),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = QueueActionConfig.DEFAULT_SEARCH_QUEUE_UPPER_BOUND - 200,\n+                    avg = QueueActionConfig.DEFAULT_SEARCH_QUEUE_UPPER_BOUND - 200,\n+                    min = QueueActionConfig.DEFAULT_SEARCH_QUEUE_UPPER_BOUND - 200,\n+                    max = QueueActionConfig.DEFAULT_SEARCH_QUEUE_UPPER_BOUND - 200)\n+            }\n+        )\n+    }\n+)\n+public class LevelThreeDedicatedMasterITest {\n+  public static final long HEAP_MAX_SIZE_IN_BYTE = 10 * GB_TO_BYTES;\n+  public static final double FIELDDATA_CACHE_SIZE_IN_PERCENT = 0.3;\n+  public static final double SHARD_REQUEST_CACHE_SIZE_IN_PERCENT = 0.04;\n+\n+  @Test\n+  @AExpect(\n+      what = AExpect.Type.REST_API,\n+      on = HostTag.ELECTED_MASTER,\n+      validator = LevelThreeValidator.class,\n+      forRca = PersistedAction.class,\n+      timeoutSeconds = 1000)\n+  @AErrorPatternIgnored(\n+      pattern = \"CacheUtil:getCacheMaxSize()\",\n+      reason = \"Cache related configs are expected to be missing in this integ test\")\n+  @AErrorPatternIgnored(\n+      pattern = \"AggregateMetric:gather()\",\n+      reason = \"Cache metrics are expected to be missing in this integ test\")\n+  @AErrorPatternIgnored(\n+      pattern = \"SubscribeResponseHandler:onError()\",\n+      reason = \"A unit test expressly calls SubscribeResponseHandler#onError, which writes an error log\")\n+  @AErrorPatternIgnored(\n+      pattern = \"SQLParsingUtil:readDataFromSqlResult()\",\n+      reason = \"Old gen metrics is expected to be missing in this integ test.\")\n+  @AErrorPatternIgnored(\n+      pattern = \"HighHeapUsageOldGenRca:operate()\",\n+      reason = \"Old gen rca is expected to be missing in this integ test.\")\n+  @AErrorPatternIgnored(\n+      pattern = \"ModifyCacheMaxSizeAction:build()\",\n+      reason = \"Node config cache is expected to be missing during shutdown\")\n+  @AErrorPatternIgnored(\n+      pattern = \"NodeConfigCollector:collectAndPublishMetric()\",\n+      reason = \"Shard request cache metrics is expected to be missing\")\n+  @AErrorPatternIgnored(\n+      pattern = \"CacheUtil:getCacheMaxSize()\",\n+      reason = \"Shard request cache metrics is expected to be missing.\")\n+  @AErrorPatternIgnored(\n+      pattern = \"HighHeapUsageYoungGenRca:operate()\",\n+      reason = \"YoungGen metrics is expected to be missing.\")\n+  @AErrorPatternIgnored(\n+      pattern = \"PersistableSlidingWindow:<init>()\",\n+      reason = \"Persistence base path can be null for integration test.\")", "originalCommit": "b519f8a7621a34dd8e36b9147d30f01a2430dbf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgzMjgyMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/499#discussion_r513832821", "bodyText": "thanks for catching this. Yes. let me remove those in my next PRs(I am creating a few more ITs to cover corner cases in JVM decider)", "author": "rguo-aws", "createdAt": "2020-10-29T00:04:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyNzgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzkyNjQ4MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/499#discussion_r513926480", "bodyText": "done, removed this pattern", "author": "rguo-aws", "createdAt": "2020-10-29T03:42:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyNzgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgzNjQwNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/499#discussion_r513836406", "bodyText": "I see that you have updated OLD_GEN to HEAP. The method says getMaxOldGenSizeOrDefault. Is there a reason why this change was made? Do we want to rename the method?", "author": "sruti1312", "createdAt": "2020-10-29T00:17:07Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/OldGenRca.java", "diffHunk": "@@ -72,7 +73,7 @@ protected double getMaxOldGenSizeOrDefault(final double defaultValue) {\n       }\n       double ret =\n           SQLParsingUtil\n-              .readDataFromSqlResult(heapMaxMetric.getData(), MEM_TYPE.getField(), OLD_GEN.toString(), MetricsDB.MAX);\n+              .readDataFromSqlResult(heapMaxMetric.getData(), MEM_TYPE.getField(), HEAP.toString(), MetricsDB.MAX);", "originalCommit": "b519f8a7621a34dd8e36b9147d30f01a2430dbf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgzNzcwMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/499#discussion_r513837701", "bodyText": "yes, this was a bug I found in old gen RCA. Heap usage is supposed to be calculated by (old gen usage)/(max total heap size). but for some reason, we calculated it by (old gen usage)/(max old gen size)", "author": "rguo-aws", "createdAt": "2020-10-29T00:21:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgzNjQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzkyNjg4NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/499#discussion_r513926884", "bodyText": "done. added a new function to retrieve HEAP and leave the OLD_GEN unchanged", "author": "rguo-aws", "createdAt": "2020-10-29T03:42:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgzNjQwNg=="}], "type": "inlineReview"}, {"oid": "4a3ffb78fa7ac32cacc03bcd4aa7c92f5ef0100a", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/4a3ffb78fa7ac32cacc03bcd4aa7c92f5ef0100a", "message": "Merge remote-tracking branch 'origin' into rguo-jvm-decider-IT2", "committedDate": "2020-10-29T00:32:51Z", "type": "commit"}, {"oid": "2ff3041eb088b9302421e154e191ca1c83c6802a", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/2ff3041eb088b9302421e154e191ca1c83c6802a", "message": "address PR comments", "committedDate": "2020-10-29T01:39:06Z", "type": "commit"}, {"oid": "6242ad517b033a85f4c19924371deb3f40924aa6", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/6242ad517b033a85f4c19924371deb3f40924aa6", "message": "more update", "committedDate": "2020-10-29T02:26:12Z", "type": "commit"}, {"oid": "e7860be96d00cfb5fc78be9b4df849c9bbdbc0f4", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/e7860be96d00cfb5fc78be9b4df849c9bbdbc0f4", "message": "Address more IT failures", "committedDate": "2020-10-29T17:16:14Z", "type": "commit"}]}