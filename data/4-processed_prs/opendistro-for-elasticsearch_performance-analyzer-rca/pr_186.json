{"pr_number": 186, "pr_title": "Ut fix", "pr_createdAt": "2020-05-06T17:52:09Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186", "timeline": [{"oid": "88c3748bc8387ba8bc6e072a83cb50f7c9d3a07e", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/88c3748bc8387ba8bc6e072a83cb50f7c9d3a07e", "message": "Adding Fix for flaky behavior of readAndUpdateMutedRcas() UT and handling a race condition in scheduler and mutedRCA", "committedDate": "2020-05-06T06:53:18Z", "type": "commit"}, {"oid": "aee2c29be66808e6afc68eaac4ae3f9b7323179a", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/aee2c29be66808e6afc68eaac4ae3f9b7323179a", "message": "Adding WaitFor to accomodate for any delays in test running", "committedDate": "2020-05-06T17:48:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NTE4Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r420995186", "bodyText": "I don't see that we are validating that there are Java classes with these names ?", "author": "yojs", "createdAt": "2020-05-06T18:15:29Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -275,6 +275,17 @@ private void readRcaEnabledFromConf() {\n         });\n   }\n \n+  private void readAndUpdateMutesRcasDuringStart() {\n+    try {\n+      Set<String> rcasForMute = new HashSet<>(rcaConf.getMutedRcaList());\n+      rcasForMute.forEach(mutedRca -> Stats.getInstance().addToMutedGraphNodes(mutedRca));", "originalCommit": "aee2c29be66808e6afc68eaac4ae3f9b7323179a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAwMjI0Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r421002242", "bodyText": "Let's add a test that exercises this path. I mean when during the start of RcaController", "author": "yojs", "createdAt": "2020-05-06T18:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NTE4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0MzYwOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r422443609", "bodyText": "I don't see that we are validating that there are Java classes with these names ?\n\nDone. Added check based on class name.", "author": "khushbr", "createdAt": "2020-05-09T02:34:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NTE4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0Mzc2OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r422443769", "bodyText": "Let's add a test that exercises this path. I mean when during the start of RcaController\n\nIt is difficult to simulate this within a UT, since it relies on lastModifiedTimeInMillisInMemory, initialized at boot-up and start() being invoked. Will add an integration test to cover this.", "author": "khushbr", "createdAt": "2020-05-09T02:36:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5NTE4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyMTk1MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r421021950", "bodyText": "There is an edge case where both readAndUpdateMutesRcas and readAndUpdateMutesRcasDuringStart can try to update the muted Rca list back to back. So we would try to read in rca.conf twice.\nThis will happen when rca was turned on and then off. Then between the two muted rcas update checks interval, some does both the things - adds a new muted rca and then turns on the rca.\nreadAndUpdateMutesRcasDuringStart should ever be read at the start of the process itself. That's the time when RCA graph is not constructed and we cannot validate the new new muted RCAs. For any other updated to the muted list, the periodic rca.conf update checker will take care of it.", "author": "yojs", "createdAt": "2020-05-06T18:59:35Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -150,7 +150,7 @@ private void start() {\n       List<ConnectedComponent> connectedComponents = RcaUtil.getAnalysisGraphComponents(rcaConf);\n \n       // Mute the rca nodes after the graph creation and before the scheduler start\n-      readAndUpdateMutesRcas();\n+      readAndUpdateMutesRcasDuringStart();", "originalCommit": "aee2c29be66808e6afc68eaac4ae3f9b7323179a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0MzU3NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r422443574", "bodyText": "Agreed, Have also added a comment explaining this.", "author": "khushbr", "createdAt": "2020-05-09T02:34:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyMTk1MA=="}], "type": "inlineReview"}, {"oid": "9b47ff6bb94963f04a035e9d25fb5b2737fc5c37", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/9b47ff6bb94963f04a035e9d25fb5b2737fc5c37", "message": "Adding Validation check within readAndUpdateMutesRcasDuringStart()", "committedDate": "2020-05-09T02:30:28Z", "type": "commit"}, {"oid": "da1635b1a077528c885d9f063e355bb09ffebf30", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/da1635b1a077528c885d9f063e355bb09ffebf30", "message": "Removing the Validation check within readAndUpdateMutesRcasDuringStart(), falling back on checks within readAndUpdateMutesRcas() to handle the start-up incorrect rca name scenario", "committedDate": "2020-05-11T21:56:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4MDc4OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r423380788", "bodyText": "Will it make sense to rewrite updateMutedGraphNodes as do two things:\n\nclear()\naddAll(nodeNames)\n\nAnd just call that here instead of iterating through rcasForMute ?", "author": "yojs", "createdAt": "2020-05-11T23:41:59Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -268,13 +268,35 @@ private void readRcaEnabledFromConf() {\n             String nextLine = sc.nextLine();\n             rcaEnabled = Boolean.parseBoolean(nextLine);\n           } catch (IOException e) {\n-            LOG.error(\"Error reading file '{}': {}\", filePath.toString(), e.getMessage());\n+            LOG.error(\"Error reading file '{}': {}\", filePath.toString(), e);\n             e.printStackTrace();\n             rcaEnabled = rcaEnabledDefaultValue;\n           }\n         });\n   }\n \n+  private void readAndUpdateMutesRcasDuringStart() {\n+    try {\n+      /* We have an edge case where both `readAndUpdateMutesRcas()` and `readAndUpdateMutesRcasDuringStart()`\n+       * can try to update the muted Rca list back to back, reading rca.conf twice. This will happen when rca\n+       * was turned off and then on.\n+       *\n+       * <p> `readAndUpdateMutesRcasDuringStart()` should only be read at the start of the process, when\n+       * RCA graph is not constructed and we cannot validate the new new muted RCAs. For any other update\n+       * to the muted list, the periodic rca.conf update checker will take care of it.\n+       *\n+       */\n+      if (lastModifiedTimeInMillisInMemory == 0) {\n+        Set<String> rcasForMute = new HashSet<>(rcaConf.getMutedRcaList());\n+        rcasForMute.forEach(mutedRca -> Stats.getInstance().addToMutedGraphNodes(mutedRca));", "originalCommit": "da1635b1a077528c885d9f063e355bb09ffebf30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4MzU0OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r423383549", "bodyText": "Yes, we can use the updateMutedGraphNodes() as is. Updating the code for the same.", "author": "khushbr", "createdAt": "2020-05-11T23:50:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4MDc4OA=="}], "type": "inlineReview"}, {"oid": "879fabd66b2705d78ee95d3ee86796ade59ef4f0", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/879fabd66b2705d78ee95d3ee86796ade59ef4f0", "message": "Replacing updateMutedGraphNodes() with addToMutedGraphNodes() inside readAndUpdateMutesRcasDuringStart()", "committedDate": "2020-05-12T00:04:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMTE1OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r424101159", "bodyText": "updateMutedGraphNodes retains the intersection of the elements in the original and what's provided if provided element is nonEmpty or else it adds them all.\nBecause the muted rcas in the rca.conf is the final list, we should just clear the old elements and the new ones right ?", "author": "yojs", "createdAt": "2020-05-13T00:04:13Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -288,7 +288,7 @@ private void readAndUpdateMutesRcasDuringStart() {\n        */\n       if (lastModifiedTimeInMillisInMemory == 0) {\n         Set<String> rcasForMute = new HashSet<>(rcaConf.getMutedRcaList());\n-        rcasForMute.forEach(mutedRca -> Stats.getInstance().addToMutedGraphNodes(mutedRca));\n+        Stats.getInstance().updateMutedGraphNodes(rcasForMute);", "originalCommit": "879fabd66b2705d78ee95d3ee86796ade59ef4f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYxNzA5MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r424617091", "bodyText": "The mutedGraphNodes is initialized as an empty set as part of the RCA Controller start().\nSince readAndUpdateMutesRcasDuringStart()  is only invoked during the start, the mutedGraphNodes will be an empty set and the  updateMutedGraphNodes() on finding mutedGraphNodes as empty will add all the elements in rca.conf", "author": "khushbr", "createdAt": "2020-05-13T17:41:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMTE1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDczNDYxNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r424734616", "bodyText": "Stats class is static. So, if RCA was disabled, muted rcas changed in the rca.conf and later enabled again, then based on this code, updateMutedGraphNodes will call retainAll that will be lead to an intersection of the nodes to be muted, right ?", "author": "yojs", "createdAt": "2020-05-13T21:13:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMTE1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5NzE0NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r424797145", "bodyText": "Agreed, this condition was missed. Since rca.conf is our source of truth, now updateMutedGraphNodes() is clearing the older values in mutedGraphNodes and adding all from rca.conf.", "author": "khushbr", "createdAt": "2020-05-13T23:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwMTE1OQ=="}], "type": "inlineReview"}, {"oid": "afed113f18822fbe55256ee399b7d98e2bdca7bd", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/afed113f18822fbe55256ee399b7d98e2bdca7bd", "message": "Adding UT and updating readAndUpdateMutesRcasDuringStart()", "committedDate": "2020-05-13T23:56:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMxNDA0Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r425314043", "bodyText": "Why do we need to handle exception here ? This make it quite confusing as we are not throwing any exceptions in between I assume ?", "author": "rguo-aws", "createdAt": "2020-05-14T17:34:55Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -268,13 +268,35 @@ private void readRcaEnabledFromConf() {\n             String nextLine = sc.nextLine();\n             rcaEnabled = Boolean.parseBoolean(nextLine);\n           } catch (IOException e) {\n-            LOG.error(\"Error reading file '{}': {}\", filePath.toString(), e.getMessage());\n+            LOG.error(\"Error reading file '{}': {}\", filePath.toString(), e);\n             e.printStackTrace();\n             rcaEnabled = rcaEnabledDefaultValue;\n           }\n         });\n   }\n \n+  private void readAndUpdateMutesRcasDuringStart() {\n+    try {\n+      /* We have an edge case where both `readAndUpdateMutesRcas()` and `readAndUpdateMutesRcasDuringStart()`\n+       * can try to update the muted Rca list back to back, reading rca.conf twice. This will happen when rca\n+       * was turned off and then on.\n+       *\n+       * <p> `readAndUpdateMutesRcasDuringStart()` should only be read at the start of the process, when\n+       * RCA graph is not constructed and we cannot validate the new new muted RCAs. For any other update\n+       * to the muted list, the periodic rca.conf update checker will take care of it.\n+       *\n+       */\n+      if (lastModifiedTimeInMillisInMemory == 0) {\n+        Set<String> rcasForMute = new HashSet<>(rcaConf.getMutedRcaList());\n+        Stats.getInstance().updateMutedGraphNodes(rcasForMute);\n+        LOG.info(\"Updated the muted RCA Graph to : {}\", rcaConf.getMutedRcaList());\n+      }\n+    } catch (Exception e) {", "originalCommit": "afed113f18822fbe55256ee399b7d98e2bdca7bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMxNjIyMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/186#discussion_r425316220", "bodyText": "We are only logging the exception with metric here and not throwing.", "author": "khushbr", "createdAt": "2020-05-14T17:38:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMxNDA0Mw=="}], "type": "inlineReview"}]}