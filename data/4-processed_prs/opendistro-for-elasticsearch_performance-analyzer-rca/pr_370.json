{"pr_number": 370, "pr_title": "Add integ test for queue rejection cluster RCA", "pr_createdAt": "2020-08-13T18:42:09Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/370", "timeline": [{"oid": "2546d72a3e323f30e703249091f07f8ce1ce48ea", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/2546d72a3e323f30e703249091f07f8ce1ce48ea", "message": "Add integ test for queue rejection cluster RCA", "committedDate": "2020-08-13T18:37:54Z", "type": "commit"}, {"oid": "0ea109ad3b3531d0515175f4ad08ceb79a0d642e", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/0ea109ad3b3531d0515175f4ad08ceb79a0d642e", "message": "Merge remote-tracking branch 'origin' into rguo-it", "committedDate": "2020-08-13T19:06:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwOTIyOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/370#discussion_r470209229", "bodyText": "Maybe we can use the TEST_RESOURCES_DIR in Consts.java and add on top of that ?", "author": "yojs", "createdAt": "2020-08-13T19:52:56Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/queue_tuning/RcaItQueueTuning.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.queue_tuning;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolDimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.ThreadPool_QueueCapacity;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.ThreadPool_RejectedReqs;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AExpect;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AMetric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ARcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ARcaGraph;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATable;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATuple;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.api.TestApi;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.ClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.HostTag;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.runners.RcaItNotEncryptedRunner;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.queue_tuning.validator.QueueRejectionValidator;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.ElasticSearchAnalysisGraph;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.QueueRejectionClusterRca;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+@RunWith(RcaItNotEncryptedRunner.class)\n+\n+@AClusterType(ClusterType.MULTI_NODE_CO_LOCATED_MASTER)\n+@ARcaGraph(ElasticSearchAnalysisGraph.class)\n+//specify a custom rca.conf to set the rejection-time-period-in-seconds to 5s to reduce runtime\n+@ARcaConf(dataNode = RcaItQueueTuning.QUEUE_TUNING_RESOURCES_DIR + \"rca.conf\")\n+@AMetric(name = ThreadPool_RejectedReqs.class,\n+    dimensionNames = {ThreadPoolDimension.Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(hostTag = HostTag.DATA_0,\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 1.0, avg = 1.0, min = 1.0, max = 1.0),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0)\n+            }\n+        ),\n+        @ATable(hostTag = {HostTag.ELECTED_MASTER},\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0)\n+            }\n+        )\n+    }\n+)\n+\n+@AMetric(name = ThreadPool_QueueCapacity.class,\n+    dimensionNames = {ThreadPoolDimension.Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(hostTag = HostTag.DATA_0,\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 500, avg = 500, min = 500, max = 500),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 1500, avg = 1500, min = 1500, max = 1500)\n+            }\n+        ),\n+        @ATable(hostTag = {HostTag.ELECTED_MASTER},\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 1500, avg = 1500, min = 1500, max = 1500)\n+            }\n+        )\n+    }\n+)\n+public class RcaItQueueTuning {\n+  public static final String QUEUE_TUNING_RESOURCES_DIR =\n+      \"./src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/queue_tuning/resource/\";", "originalCommit": "2546d72a3e323f30e703249091f07f8ce1ce48ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg1Mjk3MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/370#discussion_r470852970", "bodyText": "done, break the full path into smaller pieces and move the common part into Conts.java", "author": "rguo-aws", "createdAt": "2020-08-14T20:34:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwOTIyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIxMDY3MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/370#discussion_r470210670", "bodyText": "setTestApi() is an optional method. You can define this, if you want access to the TestApi object. As in this case we are not using that, maybe we can skip this and the class member  private TestApi api; ?", "author": "yojs", "createdAt": "2020-08-13T19:55:36Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/queue_tuning/RcaItQueueTuning.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.queue_tuning;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolDimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.ThreadPool_QueueCapacity;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.ThreadPool_RejectedReqs;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AExpect;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AMetric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ARcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ARcaGraph;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATable;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATuple;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.api.TestApi;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.ClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.HostTag;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.runners.RcaItNotEncryptedRunner;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.queue_tuning.validator.QueueRejectionValidator;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.ElasticSearchAnalysisGraph;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.QueueRejectionClusterRca;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+@RunWith(RcaItNotEncryptedRunner.class)\n+\n+@AClusterType(ClusterType.MULTI_NODE_CO_LOCATED_MASTER)\n+@ARcaGraph(ElasticSearchAnalysisGraph.class)\n+//specify a custom rca.conf to set the rejection-time-period-in-seconds to 5s to reduce runtime\n+@ARcaConf(dataNode = RcaItQueueTuning.QUEUE_TUNING_RESOURCES_DIR + \"rca.conf\")\n+@AMetric(name = ThreadPool_RejectedReqs.class,\n+    dimensionNames = {ThreadPoolDimension.Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(hostTag = HostTag.DATA_0,\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 1.0, avg = 1.0, min = 1.0, max = 1.0),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0)\n+            }\n+        ),\n+        @ATable(hostTag = {HostTag.ELECTED_MASTER},\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0)\n+            }\n+        )\n+    }\n+)\n+\n+@AMetric(name = ThreadPool_QueueCapacity.class,\n+    dimensionNames = {ThreadPoolDimension.Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(hostTag = HostTag.DATA_0,\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 500, avg = 500, min = 500, max = 500),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 1500, avg = 1500, min = 1500, max = 1500)\n+            }\n+        ),\n+        @ATable(hostTag = {HostTag.ELECTED_MASTER},\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 1500, avg = 1500, min = 1500, max = 1500)\n+            }\n+        )\n+    }\n+)\n+public class RcaItQueueTuning {\n+  public static final String QUEUE_TUNING_RESOURCES_DIR =\n+      \"./src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/queue_tuning/resource/\";\n+  private TestApi api;\n+\n+  @Test\n+  @AExpect(\n+      what = AExpect.Type.REST_API,\n+      on = HostTag.ELECTED_MASTER,\n+      validator = QueueRejectionValidator.class,\n+      forRca = QueueRejectionClusterRca.class,\n+      timeoutSeconds = 500)\n+  public void simple() {\n+  }\n+\n+  public void setTestApi(final TestApi api) {\n+    this.api = api;", "originalCommit": "2546d72a3e323f30e703249091f07f8ce1ce48ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg1MDAwNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/370#discussion_r470850006", "bodyText": "done. removed the testapi.", "author": "rguo-aws", "createdAt": "2020-08-14T20:26:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIxMDY3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIxMDk3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/370#discussion_r470210971", "bodyText": "Maybe we can change the name to something more indicative of what this is testing ?", "author": "yojs", "createdAt": "2020-08-13T19:56:11Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/queue_tuning/RcaItQueueTuning.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.queue_tuning;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolDimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.ThreadPool_QueueCapacity;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.ThreadPool_RejectedReqs;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AExpect;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AMetric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ARcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ARcaGraph;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATable;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATuple;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.api.TestApi;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.ClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.HostTag;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.runners.RcaItNotEncryptedRunner;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.queue_tuning.validator.QueueRejectionValidator;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.ElasticSearchAnalysisGraph;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.QueueRejectionClusterRca;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+@RunWith(RcaItNotEncryptedRunner.class)\n+\n+@AClusterType(ClusterType.MULTI_NODE_CO_LOCATED_MASTER)\n+@ARcaGraph(ElasticSearchAnalysisGraph.class)\n+//specify a custom rca.conf to set the rejection-time-period-in-seconds to 5s to reduce runtime\n+@ARcaConf(dataNode = RcaItQueueTuning.QUEUE_TUNING_RESOURCES_DIR + \"rca.conf\")\n+@AMetric(name = ThreadPool_RejectedReqs.class,\n+    dimensionNames = {ThreadPoolDimension.Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(hostTag = HostTag.DATA_0,\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 1.0, avg = 1.0, min = 1.0, max = 1.0),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0)\n+            }\n+        ),\n+        @ATable(hostTag = {HostTag.ELECTED_MASTER},\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0)\n+            }\n+        )\n+    }\n+)\n+\n+@AMetric(name = ThreadPool_QueueCapacity.class,\n+    dimensionNames = {ThreadPoolDimension.Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(hostTag = HostTag.DATA_0,\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 500, avg = 500, min = 500, max = 500),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 1500, avg = 1500, min = 1500, max = 1500)\n+            }\n+        ),\n+        @ATable(hostTag = {HostTag.ELECTED_MASTER},\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 1500, avg = 1500, min = 1500, max = 1500)\n+            }\n+        )\n+    }\n+)\n+public class RcaItQueueTuning {\n+  public static final String QUEUE_TUNING_RESOURCES_DIR =\n+      \"./src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/queue_tuning/resource/\";\n+  private TestApi api;\n+\n+  @Test\n+  @AExpect(\n+      what = AExpect.Type.REST_API,\n+      on = HostTag.ELECTED_MASTER,\n+      validator = QueueRejectionValidator.class,\n+      forRca = QueueRejectionClusterRca.class,\n+      timeoutSeconds = 500)\n+  public void simple() {", "originalCommit": "2546d72a3e323f30e703249091f07f8ce1ce48ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg1MDE2OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/370#discussion_r470850168", "bodyText": "done. renamed to testQueueRejectionRca()", "author": "rguo-aws", "createdAt": "2020-08-14T20:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIxMDk3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIxMTc4Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/370#discussion_r470211787", "bodyText": "Integration tests can become complicated and sometimes it might be good to add doc comments stating what scenarios we are testing and what are the expectations ?", "author": "yojs", "createdAt": "2020-08-13T19:57:40Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/queue_tuning/RcaItQueueTuning.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.queue_tuning;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolDimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.ThreadPoolType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.ThreadPool_QueueCapacity;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.ThreadPool_RejectedReqs;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AExpect;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.AMetric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ARcaConf;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ARcaGraph;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATable;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.annotations.ATuple;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.api.TestApi;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.ClusterType;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.configs.HostTag;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.framework.runners.RcaItNotEncryptedRunner;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.integTests.tests.queue_tuning.validator.QueueRejectionValidator;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.ElasticSearchAnalysisGraph;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.cluster.QueueRejectionClusterRca;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+@RunWith(RcaItNotEncryptedRunner.class)\n+\n+@AClusterType(ClusterType.MULTI_NODE_CO_LOCATED_MASTER)\n+@ARcaGraph(ElasticSearchAnalysisGraph.class)\n+//specify a custom rca.conf to set the rejection-time-period-in-seconds to 5s to reduce runtime\n+@ARcaConf(dataNode = RcaItQueueTuning.QUEUE_TUNING_RESOURCES_DIR + \"rca.conf\")\n+@AMetric(name = ThreadPool_RejectedReqs.class,\n+    dimensionNames = {ThreadPoolDimension.Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(hostTag = HostTag.DATA_0,\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 1.0, avg = 1.0, min = 1.0, max = 1.0),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0)\n+            }\n+        ),\n+        @ATable(hostTag = {HostTag.ELECTED_MASTER},\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0)\n+            }\n+        )\n+    }\n+)\n+\n+@AMetric(name = ThreadPool_QueueCapacity.class,\n+    dimensionNames = {ThreadPoolDimension.Constants.TYPE_VALUE},\n+    tables = {\n+        @ATable(hostTag = HostTag.DATA_0,\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 500, avg = 500, min = 500, max = 500),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 1500, avg = 1500, min = 1500, max = 1500)\n+            }\n+        ),\n+        @ATable(hostTag = {HostTag.ELECTED_MASTER},\n+            tuple = {\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.WRITE_NAME},\n+                    sum = 0.0, avg = 0.0, min = 0.0, max = 0.0),\n+                @ATuple(dimensionValues = {ThreadPoolType.Constants.SEARCH_NAME},\n+                    sum = 1500, avg = 1500, min = 1500, max = 1500)\n+            }\n+        )\n+    }\n+)\n+public class RcaItQueueTuning {\n+  public static final String QUEUE_TUNING_RESOURCES_DIR =\n+      \"./src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/integTests/tests/queue_tuning/resource/\";\n+  private TestApi api;\n+\n+  @Test", "originalCommit": "2546d72a3e323f30e703249091f07f8ce1ce48ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg1MDI5Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/370#discussion_r470850296", "bodyText": "added comments on top to explain what this integ test does", "author": "rguo-aws", "createdAt": "2020-08-14T20:27:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIxMTc4Nw=="}], "type": "inlineReview"}, {"oid": "31d52b693065440bd6404055c26329b659ab343c", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/31d52b693065440bd6404055c26329b659ab343c", "message": "resolve merge conflict", "committedDate": "2020-08-13T21:18:13Z", "type": "commit"}, {"oid": "d64f81feb48f01da90f19273f1c506062a083cb0", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/d64f81feb48f01da90f19273f1c506062a083cb0", "message": "Merge remote-tracking branch 'origin/master' into rguo-it", "committedDate": "2020-08-14T20:20:01Z", "type": "commit"}, {"oid": "1606aebc0e46a26a41b7544752963d61bc954094", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/1606aebc0e46a26a41b7544752963d61bc954094", "message": "Address PR comments", "committedDate": "2020-08-14T20:44:07Z", "type": "commit"}, {"oid": "ff24fbf45b2e0a129d64bf90e9ce1068a5101ec8", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/ff24fbf45b2e0a129d64bf90e9ce1068a5101ec8", "message": "address checkstyle issue", "committedDate": "2020-08-14T20:47:42Z", "type": "commit"}]}