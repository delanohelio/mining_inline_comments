{"pr_number": 168, "pr_title": "Muting API", "pr_createdAt": "2020-04-28T22:13:20Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168", "timeline": [{"oid": "392f8944c6ae595f7ff0ea73ab545d6219a36102", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/392f8944c6ae595f7ff0ea73ab545d6219a36102", "message": "Addressing CR comments, part -2. Separating the rca.conf files for testing Muted RCAs and making chaged to RcaController", "committedDate": "2020-04-28T20:02:42Z", "type": "commit"}, {"oid": "c2ff4559489b6c42aee4904247248d173d135ef7", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/c2ff4559489b6c42aee4904247248d173d135ef7", "message": "Addressing PR Comments, Part-3", "committedDate": "2020-04-28T22:03:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk2MDM4Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168#discussion_r416960383", "bodyText": "getAllNodes() is an expensive call. It should only be called if nodeNames is uninitialized.", "author": "yojs", "createdAt": "2020-04-28T22:24:19Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/core/ConnectedComponent.java", "diffHunk": "@@ -114,4 +117,10 @@ public void addLeafNode(Node node) {\n     }\n     return dependencyOrderedNodes;\n   }\n+\n+  public Set<String> getNodeNames() {\n+    getAllNodes();", "originalCommit": "c2ff4559489b6c42aee4904247248d173d135ef7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAyMDA2NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168#discussion_r417020065", "bodyText": "With current implementation, we are returning nodeNames without making the null check. If the nodeNames is not populated, then it should fail.", "author": "khushbr", "createdAt": "2020-04-29T01:30:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk2MDM4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk2MTQyNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168#discussion_r416961427", "bodyText": "I don't get it, why can't we just call getNodeNames() instead of calling the expensive method getAnalysisGraphComponents ?", "author": "yojs", "createdAt": "2020-04-28T22:26:58Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -253,6 +261,51 @@ private void readRcaEnabledFromConf() {\n             rcaEnabled = rcaEnabledDefaultValue;\n           }\n         });\n+\n+    // If RCA is enabled, update Analysis graph with Muted RCAs value\n+    if (rcaEnabled) {\n+      LOG.debug(\"Updating Analysis Graph with Muted RCAs\");\n+      readAndUpdateMutesRcas();\n+    }\n+  }\n+\n+  /**\n+   * Reads the mutedRCAList value from the rca.conf file, performs validation on the param value\n+   * provided and on successful validation, updates the AnalysisGraph with muted RCA value.\n+   *\n+   * <p>In case all the RCAs in param value are incorrect, return without any update.\n+   */\n+  private void readAndUpdateMutesRcas() {\n+    // If the rca config file has been updated since the lastModifiedTimeInMillisInMemory in memory,\n+    // refresh the `muted-rcas` value from rca config file.\n+    long lastModifiedTimeInMillisOnDisk = rcaConf.getLastModifiedTime();\n+    if (lastModifiedTimeInMillisOnDisk > lastModifiedTimeInMillisInMemory) {\n+      try {\n+        Set<String> rcasForMute = new HashSet<>(rcaConf.getMutedRcaList());\n+        LOG.info(\"RCAs provided for muting : {}\", rcasForMute);\n+\n+        Set<String> graphNodeNames = new HashSet<>();\n+        RcaUtil.getAnalysisGraphComponents(rcaConf).forEach(\n+                connectedComponent -> graphNodeNames.addAll(connectedComponent.getNodeNames()));", "originalCommit": "c2ff4559489b6c42aee4904247248d173d135ef7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAyMDMyOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168#discussion_r417020328", "bodyText": "Agreed, so now we are maintaining a set which gets populated at the time of graph creation and is accessible via getNodeNames()", "author": "khushbr", "createdAt": "2020-04-29T01:31:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk2MTQyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk2MTkxNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168#discussion_r416961917", "bodyText": "Ideally this one should be:\nrcasForMute.retainAll(getNodeNames());, right ?", "author": "yojs", "createdAt": "2020-04-28T22:28:16Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -253,6 +261,51 @@ private void readRcaEnabledFromConf() {\n             rcaEnabled = rcaEnabledDefaultValue;\n           }\n         });\n+\n+    // If RCA is enabled, update Analysis graph with Muted RCAs value\n+    if (rcaEnabled) {\n+      LOG.debug(\"Updating Analysis Graph with Muted RCAs\");\n+      readAndUpdateMutesRcas();\n+    }\n+  }\n+\n+  /**\n+   * Reads the mutedRCAList value from the rca.conf file, performs validation on the param value\n+   * provided and on successful validation, updates the AnalysisGraph with muted RCA value.\n+   *\n+   * <p>In case all the RCAs in param value are incorrect, return without any update.\n+   */\n+  private void readAndUpdateMutesRcas() {\n+    // If the rca config file has been updated since the lastModifiedTimeInMillisInMemory in memory,\n+    // refresh the `muted-rcas` value from rca config file.\n+    long lastModifiedTimeInMillisOnDisk = rcaConf.getLastModifiedTime();\n+    if (lastModifiedTimeInMillisOnDisk > lastModifiedTimeInMillisInMemory) {\n+      try {\n+        Set<String> rcasForMute = new HashSet<>(rcaConf.getMutedRcaList());\n+        LOG.info(\"RCAs provided for muting : {}\", rcasForMute);\n+\n+        Set<String> graphNodeNames = new HashSet<>();\n+        RcaUtil.getAnalysisGraphComponents(rcaConf).forEach(\n+                connectedComponent -> graphNodeNames.addAll(connectedComponent.getNodeNames()));\n+\n+        // Update rcasForMute to retain only valid RCAs\n+        rcasForMute.retainAll(graphNodeNames);", "originalCommit": "c2ff4559489b6c42aee4904247248d173d135ef7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAyMDM1Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168#discussion_r417020352", "bodyText": "Done.", "author": "khushbr", "createdAt": "2020-04-29T01:31:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk2MTkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk5ODIzNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/168#discussion_r416998235", "bodyText": "nit: suggest renaming this(and other instances) to node muting instead of rca muting. We're not restricting this to just rca nodes anywhere.", "author": "ktkrg", "createdAt": "2020-04-29T00:10:39Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -253,6 +261,51 @@ private void readRcaEnabledFromConf() {\n             rcaEnabled = rcaEnabledDefaultValue;\n           }\n         });\n+\n+    // If RCA is enabled, update Analysis graph with Muted RCAs value\n+    if (rcaEnabled) {\n+      LOG.debug(\"Updating Analysis Graph with Muted RCAs\");\n+      readAndUpdateMutesRcas();\n+    }\n+  }\n+\n+  /**\n+   * Reads the mutedRCAList value from the rca.conf file, performs validation on the param value\n+   * provided and on successful validation, updates the AnalysisGraph with muted RCA value.\n+   *\n+   * <p>In case all the RCAs in param value are incorrect, return without any update.\n+   */\n+  private void readAndUpdateMutesRcas() {\n+    // If the rca config file has been updated since the lastModifiedTimeInMillisInMemory in memory,\n+    // refresh the `muted-rcas` value from rca config file.\n+    long lastModifiedTimeInMillisOnDisk = rcaConf.getLastModifiedTime();\n+    if (lastModifiedTimeInMillisOnDisk > lastModifiedTimeInMillisInMemory) {\n+      try {\n+        Set<String> rcasForMute = new HashSet<>(rcaConf.getMutedRcaList());\n+        LOG.info(\"RCAs provided for muting : {}\", rcasForMute);\n+\n+        Set<String> graphNodeNames = new HashSet<>();\n+        RcaUtil.getAnalysisGraphComponents(rcaConf).forEach(\n+                connectedComponent -> graphNodeNames.addAll(connectedComponent.getNodeNames()));\n+\n+        // Update rcasForMute to retain only valid RCAs\n+        rcasForMute.retainAll(graphNodeNames);\n+\n+        // If rcasForMute post validation is empty but rcaConf.getMutedRcaList() is not empty\n+        // all the input RCAs are incorrect, return.\n+        if (rcasForMute.isEmpty() && !rcaConf.getMutedRcaList().isEmpty()) {\n+          LOG.error(\"Incorrect RCA(s): {}, cannot be muted. Valid RCAs: {}\",", "originalCommit": "c2ff4559489b6c42aee4904247248d173d135ef7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "288e883d1ef5a3f67d6e0f23d8725f5a41e9af06", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/288e883d1ef5a3f67d6e0f23d8725f5a41e9af06", "message": "Addressing PR Comments, Part-4", "committedDate": "2020-04-29T01:27:23Z", "type": "commit"}]}