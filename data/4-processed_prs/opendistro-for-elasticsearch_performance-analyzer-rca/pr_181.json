{"pr_number": 181, "pr_title": "Allow retrieving temperature profile RCAs from all nodes.", "pr_createdAt": "2020-05-04T22:19:47Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181", "timeline": [{"oid": "80ccbf6d568ff1e6d86368b20f04a0519d4d49dd", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/80ccbf6d568ff1e6d86368b20f04a0519d4d49dd", "message": "Turn off Temperature profile components in RCA", "committedDate": "2020-05-04T20:53:53Z", "type": "commit"}, {"oid": "cc7696ac00dff0168a833cb7f84a5aa8cfc036c0", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/cc7696ac00dff0168a833cb7f84a5aa8cfc036c0", "message": "Allow data nodes to be queried for temperature profile RCAs", "committedDate": "2020-05-04T21:40:44Z", "type": "commit"}, {"oid": "c15d33e9b21050d5d499a4e83f0b4d1884db4565", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/c15d33e9b21050d5d499a4e83f0b4d1884db4565", "message": "Mute temperature profile RCAs", "committedDate": "2020-05-04T22:15:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyMTg4Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r419821886", "bodyText": "Should we also add to the log, what they were ? Basically add records object to the log ?", "author": "yojs", "createdAt": "2020-05-05T01:37:31Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/summaries/temperature/CompactNodeSummary.java", "diffHunk": "@@ -68,6 +74,69 @@ public CompactNodeSummary(final String nodeId, final String hostAddress) {\n         this.numOfShards = new int[TemperatureVector.Dimension.values().length];\n     }\n \n+    public static CompactNodeSummary buildSummaryFromDatabase(Result<Record> records,\n+        DSLContext context) {\n+        if (records.size() != 1) {\n+            throw new IllegalArgumentException(\n+                \"Only 1 CompactNodeSummary expected. Found: \" + records.size());", "originalCommit": "c15d33e9b21050d5d499a4e83f0b4d1884db4565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc1NTIyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r421755225", "bodyText": "Done.", "author": "ktkrg", "createdAt": "2020-05-07T19:53:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyMTg4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTEzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r419825131", "bodyText": "Let's do `LOG.error(\"\", dex ); ?", "author": "yojs", "createdAt": "2020-05-05T01:52:08Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -216,6 +206,46 @@ public synchronized RcaResponse readRca(String rca) {\n     return response;\n   }\n \n+  private RcaResponse readTemperatureProfileRca(String rca) {\n+    RcaResponse response = null;\n+    Field<Integer> primaryKeyField = DSL.field(\n+        SQLiteQueryUtils.getPrimaryKeyColumnName(ResourceFlowUnit.RCA_TABLE_NAME), Integer.class);\n+    SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils.buildRcaQuery(create, rca);\n+    try {\n+      List<Record> recordList = rcaQuery.fetch();\n+      if (recordList == null || recordList.isEmpty()) {\n+        return null;\n+      }\n+      Record mostRecentRecord = recordList.get(0);\n+      response = RcaResponse.buildResponse(mostRecentRecord);\n+\n+      if (rca.equals(ClusterTemperatureRca.TABLE_NAME)) {\n+        Field<Integer> foreignKeyField = DSL.field(\n+            SQLiteQueryUtils.getPrimaryKeyColumnName(ResourceFlowUnit.RCA_TABLE_NAME),\n+            Integer.class);\n+        SelectJoinStep<Record> query = SQLiteQueryUtils\n+            .buildSummaryQuery(create, ClusterTemperatureSummary.TABLE_NAME,\n+                mostRecentRecord.get(primaryKeyField),\n+                foreignKeyField);\n+        Result<Record> temperatureSummary = query.fetch();\n+        GenericSummary summary =\n+            ClusterTemperatureSummary.buildSummaryFromDatabase(temperatureSummary, create);\n+        response.addNestedSummaryList(summary);\n+      } else if (rca.equalsIgnoreCase(NodeTemperatureRca.TABLE_NAME)) {\n+        SelectJoinStep<Record> query = SQLiteQueryUtils.buildSummaryQuery(create,\n+            \"CompactNodeSummary\", mostRecentRecord.get(primaryKeyField), primaryKeyField);\n+        Result<Record> nodeTemperatureCompactSummary = query.fetch();\n+        GenericSummary summary =\n+            CompactNodeSummary.buildSummaryFromDatabase(nodeTemperatureCompactSummary, create);\n+        response.addNestedSummaryList(summary);\n+      }\n+    } catch (DataAccessException dex) {\n+      dex.printStackTrace();", "originalCommit": "c15d33e9b21050d5d499a4e83f0b4d1884db4565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc1NTIwMg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r421755202", "bodyText": "Done.", "author": "ktkrg", "createdAt": "2020-05-07T19:53:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTEzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTM4OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r419825389", "bodyText": "Can we make it FullNodeTemperatureSummary.buildSummaryFromDatabase() ?", "author": "yojs", "createdAt": "2020-05-05T01:53:30Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -216,6 +206,46 @@ public synchronized RcaResponse readRca(String rca) {\n     return response;\n   }\n \n+  private RcaResponse readTemperatureProfileRca(String rca) {\n+    RcaResponse response = null;\n+    Field<Integer> primaryKeyField = DSL.field(\n+        SQLiteQueryUtils.getPrimaryKeyColumnName(ResourceFlowUnit.RCA_TABLE_NAME), Integer.class);\n+    SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils.buildRcaQuery(create, rca);\n+    try {\n+      List<Record> recordList = rcaQuery.fetch();\n+      if (recordList == null || recordList.isEmpty()) {\n+        return null;\n+      }\n+      Record mostRecentRecord = recordList.get(0);\n+      response = RcaResponse.buildResponse(mostRecentRecord);\n+\n+      if (rca.equals(ClusterTemperatureRca.TABLE_NAME)) {\n+        Field<Integer> foreignKeyField = DSL.field(\n+            SQLiteQueryUtils.getPrimaryKeyColumnName(ResourceFlowUnit.RCA_TABLE_NAME),\n+            Integer.class);\n+        SelectJoinStep<Record> query = SQLiteQueryUtils\n+            .buildSummaryQuery(create, ClusterTemperatureSummary.TABLE_NAME,\n+                mostRecentRecord.get(primaryKeyField),\n+                foreignKeyField);\n+        Result<Record> temperatureSummary = query.fetch();\n+        GenericSummary summary =\n+            ClusterTemperatureSummary.buildSummaryFromDatabase(temperatureSummary, create);\n+        response.addNestedSummaryList(summary);\n+      } else if (rca.equalsIgnoreCase(NodeTemperatureRca.TABLE_NAME)) {\n+        SelectJoinStep<Record> query = SQLiteQueryUtils.buildSummaryQuery(create,\n+            \"CompactNodeSummary\", mostRecentRecord.get(primaryKeyField), primaryKeyField);\n+        Result<Record> nodeTemperatureCompactSummary = query.fetch();\n+        GenericSummary summary =\n+            CompactNodeSummary.buildSummaryFromDatabase(nodeTemperatureCompactSummary, create);", "originalCommit": "c15d33e9b21050d5d499a4e83f0b4d1884db4565", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTY4MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r419825680", "bodyText": "Should we also check for the node Role and ensure it is a data node we are making a query to ?", "author": "yojs", "createdAt": "2020-05-05T01:54:42Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -216,6 +206,46 @@ public synchronized RcaResponse readRca(String rca) {\n     return response;\n   }\n \n+  private RcaResponse readTemperatureProfileRca(String rca) {\n+    RcaResponse response = null;\n+    Field<Integer> primaryKeyField = DSL.field(\n+        SQLiteQueryUtils.getPrimaryKeyColumnName(ResourceFlowUnit.RCA_TABLE_NAME), Integer.class);\n+    SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils.buildRcaQuery(create, rca);\n+    try {\n+      List<Record> recordList = rcaQuery.fetch();\n+      if (recordList == null || recordList.isEmpty()) {\n+        return null;\n+      }\n+      Record mostRecentRecord = recordList.get(0);\n+      response = RcaResponse.buildResponse(mostRecentRecord);\n+\n+      if (rca.equals(ClusterTemperatureRca.TABLE_NAME)) {\n+        Field<Integer> foreignKeyField = DSL.field(\n+            SQLiteQueryUtils.getPrimaryKeyColumnName(ResourceFlowUnit.RCA_TABLE_NAME),\n+            Integer.class);\n+        SelectJoinStep<Record> query = SQLiteQueryUtils\n+            .buildSummaryQuery(create, ClusterTemperatureSummary.TABLE_NAME,\n+                mostRecentRecord.get(primaryKeyField),\n+                foreignKeyField);\n+        Result<Record> temperatureSummary = query.fetch();\n+        GenericSummary summary =\n+            ClusterTemperatureSummary.buildSummaryFromDatabase(temperatureSummary, create);\n+        response.addNestedSummaryList(summary);\n+      } else if (rca.equalsIgnoreCase(NodeTemperatureRca.TABLE_NAME)) {", "originalCommit": "c15d33e9b21050d5d499a4e83f0b4d1884db4565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc1NTE0OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r421755149", "bodyText": "It's fine for now, but in the long run I think we may need to. This implementation assumes that when you unicast query a node for its local rcas, you know what node you're querying and what rca you need.\nWe have one case we need to handle in the way we are writing node roles now. We either write the role as a master or a data, and it becomes tricky if it's a data-master node.\nI'll create an issue for this.", "author": "ktkrg", "createdAt": "2020-05-07T19:52:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTY4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0NTM3OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r421845379", "bodyText": "awesome ! thanks", "author": "yojs", "createdAt": "2020-05-07T23:11:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTY4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTc1NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r419825755", "bodyText": "Can we make sure that this is the elected master we are making the query to ?", "author": "yojs", "createdAt": "2020-05-05T01:55:06Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/SQLitePersistor.java", "diffHunk": "@@ -216,6 +206,46 @@ public synchronized RcaResponse readRca(String rca) {\n     return response;\n   }\n \n+  private RcaResponse readTemperatureProfileRca(String rca) {\n+    RcaResponse response = null;\n+    Field<Integer> primaryKeyField = DSL.field(\n+        SQLiteQueryUtils.getPrimaryKeyColumnName(ResourceFlowUnit.RCA_TABLE_NAME), Integer.class);\n+    SelectJoinStep<Record> rcaQuery = SQLiteQueryUtils.buildRcaQuery(create, rca);\n+    try {\n+      List<Record> recordList = rcaQuery.fetch();\n+      if (recordList == null || recordList.isEmpty()) {\n+        return null;\n+      }\n+      Record mostRecentRecord = recordList.get(0);\n+      response = RcaResponse.buildResponse(mostRecentRecord);\n+\n+      if (rca.equals(ClusterTemperatureRca.TABLE_NAME)) {", "originalCommit": "c15d33e9b21050d5d499a4e83f0b4d1884db4565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc1NTEwNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r421755104", "bodyText": "This is taken care of by the RcaRequestHandler and the fact that cluster temperature rca is not a part of the rcas that can be queried with local=true param and is a part of cluster level rcas. Because it's not part of the local rca set, it by default falls back to ensuring that this is a cluster level rca and that flow checks if the current host is a master node already.", "author": "ktkrg", "createdAt": "2020-05-07T19:52:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTc1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0NTA4MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r421845080", "bodyText": "Sounds good. Can we add that as a code comment ? So that people know why they cannot get this RCA when queried from non-elected masters ?", "author": "yojs", "createdAt": "2020-05-07T23:10:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTc1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0NjMyMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r422446323", "bodyText": "done.", "author": "ktkrg", "createdAt": "2020-05-09T03:09:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTc1NQ=="}], "type": "inlineReview"}, {"oid": "5c4928c9f35ed814f6df446da0d31af6055cd0e6", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/5c4928c9f35ed814f6df446da0d31af6055cd0e6", "message": "Added more information to the error logs", "committedDate": "2020-05-07T19:18:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxODE0Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r422418146", "bodyText": "do we need to handle the DataTypeException here ?", "author": "rguo-aws", "createdAt": "2020-05-08T23:27:45Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/summaries/temperature/CompactNodeSummary.java", "diffHunk": "@@ -68,6 +78,71 @@ public CompactNodeSummary(final String nodeId, final String hostAddress) {\n         this.numOfShards = new int[TemperatureVector.Dimension.values().length];\n     }\n \n+    public static CompactNodeSummary buildSummaryFromDatabase(Result<Record> records,\n+        DSLContext context) {\n+        if (records.size() != 1) {\n+            LOG.error(\"Expected 1 compact node summary, got {}. Summaries: {}\", records.size(),\n+                records);\n+            throw new IllegalArgumentException(\n+                \"Only 1 CompactNodeSummary expected. Found: \" + records.size());\n+        }\n+\n+        Record record = records.get(0);\n+        final String nodeId =\n+            record.get(DSL.field(DSL.name(HotNodeSummary.SQL_SCHEMA_CONSTANTS.NODE_ID_COL_NAME),", "originalCommit": "5c4928c9f35ed814f6df446da0d31af6055cd0e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0NjA2OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r422446068", "bodyText": "done.", "author": "ktkrg", "createdAt": "2020-05-09T03:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxODE0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxODIyMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r422418221", "bodyText": "same as above", "author": "rguo-aws", "createdAt": "2020-05-08T23:28:05Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/summaries/temperature/CompactNodeSummary.java", "diffHunk": "@@ -68,6 +78,71 @@ public CompactNodeSummary(final String nodeId, final String hostAddress) {\n         this.numOfShards = new int[TemperatureVector.Dimension.values().length];\n     }\n \n+    public static CompactNodeSummary buildSummaryFromDatabase(Result<Record> records,\n+        DSLContext context) {\n+        if (records.size() != 1) {\n+            LOG.error(\"Expected 1 compact node summary, got {}. Summaries: {}\", records.size(),\n+                records);\n+            throw new IllegalArgumentException(\n+                \"Only 1 CompactNodeSummary expected. Found: \" + records.size());\n+        }\n+\n+        Record record = records.get(0);\n+        final String nodeId =\n+            record.get(DSL.field(DSL.name(HotNodeSummary.SQL_SCHEMA_CONSTANTS.NODE_ID_COL_NAME),\n+                String.class));\n+        final String hostAddress =\n+            record.get(DSL.field(DSL.name(SQL_SCHEMA_CONSTANTS.HOST_IP_ADDRESS_COL_NAME)), String.class);\n+\n+        CompactNodeSummary summary = new CompactNodeSummary(nodeId, hostAddress);\n+\n+        readAndSetTotalConsumedPerDimension(record, summary);\n+        readAndSetNumShardsPerDimension(record, summary);\n+        readAndSetTemperatureVector(record, summary);\n+\n+        return summary;\n+    }\n+\n+    private static void readAndSetTemperatureVector(Record record, CompactNodeSummary summary) {\n+        for (TemperatureVector.Dimension dimension : TemperatureVector.Dimension.values()) {\n+            String normalizedMeanUsageForDimension = record\n+                .get((DSL.field(DSL.name(dimension.NAME + MEAN_SUFFIX_KEY),", "originalCommit": "5c4928c9f35ed814f6df446da0d31af6055cd0e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0NjA2Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r422446067", "bodyText": "done.", "author": "ktkrg", "createdAt": "2020-05-09T03:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxODIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxODU1Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r422418556", "bodyText": "can we simple cast the return type as Double.class here ?\nrecord.get((DSL.field(DSL.name(dimension.NAME + TOTAL_SUFFIX_KEY), Double.class)));", "author": "rguo-aws", "createdAt": "2020-05-08T23:29:37Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/summaries/temperature/CompactNodeSummary.java", "diffHunk": "@@ -68,6 +78,71 @@ public CompactNodeSummary(final String nodeId, final String hostAddress) {\n         this.numOfShards = new int[TemperatureVector.Dimension.values().length];\n     }\n \n+    public static CompactNodeSummary buildSummaryFromDatabase(Result<Record> records,\n+        DSLContext context) {\n+        if (records.size() != 1) {\n+            LOG.error(\"Expected 1 compact node summary, got {}. Summaries: {}\", records.size(),\n+                records);\n+            throw new IllegalArgumentException(\n+                \"Only 1 CompactNodeSummary expected. Found: \" + records.size());\n+        }\n+\n+        Record record = records.get(0);\n+        final String nodeId =\n+            record.get(DSL.field(DSL.name(HotNodeSummary.SQL_SCHEMA_CONSTANTS.NODE_ID_COL_NAME),\n+                String.class));\n+        final String hostAddress =\n+            record.get(DSL.field(DSL.name(SQL_SCHEMA_CONSTANTS.HOST_IP_ADDRESS_COL_NAME)), String.class);\n+\n+        CompactNodeSummary summary = new CompactNodeSummary(nodeId, hostAddress);\n+\n+        readAndSetTotalConsumedPerDimension(record, summary);\n+        readAndSetNumShardsPerDimension(record, summary);\n+        readAndSetTemperatureVector(record, summary);\n+\n+        return summary;\n+    }\n+\n+    private static void readAndSetTemperatureVector(Record record, CompactNodeSummary summary) {\n+        for (TemperatureVector.Dimension dimension : TemperatureVector.Dimension.values()) {\n+            String normalizedMeanUsageForDimension = record\n+                .get((DSL.field(DSL.name(dimension.NAME + MEAN_SUFFIX_KEY),\n+                    String.class)));\n+            short value = 0;\n+            if (normalizedMeanUsageForDimension != null && !normalizedMeanUsageForDimension.isEmpty()) {\n+                value = Short.parseShort(normalizedMeanUsageForDimension);\n+            }\n+            summary.setTemperatureForDimension(dimension,\n+                new NormalizedValue(value));\n+        }\n+    }\n+\n+    private static void readAndSetNumShardsPerDimension(Record record, CompactNodeSummary summary) {\n+        for (TemperatureVector.Dimension dimension : TemperatureVector.Dimension.values()) {\n+            String numShardsForDimension = record\n+                .get((DSL.field(DSL.name(dimension.NAME + NUM_SHARDS_SUFFIX_KEY),\n+                    String.class)));\n+            int value = 0;\n+            if (numShardsForDimension != null && !numShardsForDimension.isEmpty()) {\n+                value = Integer.parseInt(numShardsForDimension);\n+            }\n+            summary.setNumOfShards(dimension, value);\n+        }\n+    }\n+\n+    private static void readAndSetTotalConsumedPerDimension(Record record,\n+        CompactNodeSummary summary) {\n+        for (TemperatureVector.Dimension dimension : TemperatureVector.Dimension.values()) {\n+            String totalConsumedForDimension =\n+                record.get((DSL.field(DSL.name(dimension.NAME + TOTAL_SUFFIX_KEY), String.class)));", "originalCommit": "5c4928c9f35ed814f6df446da0d31af6055cd0e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQyMDU0Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r422420547", "bodyText": "That was my first implementation. It failed with a class cast exception, so I ended up doing it this way.", "author": "ktkrg", "createdAt": "2020-05-08T23:39:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxODU1Ng=="}], "type": "inlineReview"}, {"oid": "69d2ac5ebe997322fa1c62a09bff63e56c0f6d94", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/69d2ac5ebe997322fa1c62a09bff63e56c0f6d94", "message": "Merging from master", "committedDate": "2020-05-09T00:48:32Z", "type": "commit"}, {"oid": "40c077bbf26468e8349fb576c6dc9b7e64de90e8", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/40c077bbf26468e8349fb576c6dc9b7e64de90e8", "message": "Add a try-catch block for handling DataTypeException from Jooq", "committedDate": "2020-05-09T00:52:00Z", "type": "commit"}, {"oid": "191520336d6d63fe905d55495d4e0ba44617fdd5", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/191520336d6d63fe905d55495d4e0ba44617fdd5", "message": "Added clarifying comment around ClusterTemperatureRca retrieval", "committedDate": "2020-05-09T03:09:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5Nzc5NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r423297794", "bodyText": "Can this be converted into a static import ?", "author": "khushbr", "createdAt": "2020-05-11T20:25:09Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/summaries/temperature/CompactNodeSummary.java", "diffHunk": "@@ -19,15 +19,24 @@\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.NodeTemperatureSummaryMessage;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.grpc.ResourceTemperatureMessage;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.summaries.HotNodeSummary.SQL_SCHEMA_CONSTANTS;", "originalCommit": "191520336d6d63fe905d55495d4e0ba44617fdd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5ODYyOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r423298628", "bodyText": "Is this a candidate for a metric?", "author": "khushbr", "createdAt": "2020-05-11T20:26:41Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/summaries/temperature/CompactNodeSummary.java", "diffHunk": "@@ -68,6 +79,88 @@ public CompactNodeSummary(final String nodeId, final String hostAddress) {\n         this.numOfShards = new int[TemperatureVector.Dimension.values().length];\n     }\n \n+    public static CompactNodeSummary buildSummaryFromDatabase(Result<Record> records,\n+        DSLContext context) {\n+        if (records.size() != 1) {\n+            LOG.error(\"Expected 1 compact node summary, got {}. Summaries: {}\", records.size(),\n+                records);\n+            throw new IllegalArgumentException(\n+                \"Only 1 CompactNodeSummary expected. Found: \" + records.size());", "originalCommit": "191520336d6d63fe905d55495d4e0ba44617fdd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwMDQxOA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r423300418", "bodyText": "For my understanding, is there a relevance to the ordering of these calls ? Just from function name, it looks that readAndSetNumShardsPerDimension() should be invoked before readAndSetTotalConsumedPerDimension()", "author": "khushbr", "createdAt": "2020-05-11T20:29:53Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/summaries/temperature/CompactNodeSummary.java", "diffHunk": "@@ -68,6 +79,88 @@ public CompactNodeSummary(final String nodeId, final String hostAddress) {\n         this.numOfShards = new int[TemperatureVector.Dimension.values().length];\n     }\n \n+    public static CompactNodeSummary buildSummaryFromDatabase(Result<Record> records,\n+        DSLContext context) {\n+        if (records.size() != 1) {\n+            LOG.error(\"Expected 1 compact node summary, got {}. Summaries: {}\", records.size(),\n+                records);\n+            throw new IllegalArgumentException(\n+                \"Only 1 CompactNodeSummary expected. Found: \" + records.size());\n+        }\n+\n+        Record record = records.get(0);\n+        final String nodeId =\n+            record.get(DSL.field(DSL.name(HotNodeSummary.SQL_SCHEMA_CONSTANTS.NODE_ID_COL_NAME),\n+                String.class));\n+        final String hostAddress =\n+            record.get(DSL.field(DSL.name(SQL_SCHEMA_CONSTANTS.HOST_IP_ADDRESS_COL_NAME)), String.class);\n+\n+        CompactNodeSummary summary = new CompactNodeSummary(nodeId, hostAddress);\n+\n+        readAndSetTotalConsumedPerDimension(record, summary);\n+        readAndSetNumShardsPerDimension(record, summary);\n+        readAndSetTemperatureVector(record, summary);", "originalCommit": "191520336d6d63fe905d55495d4e0ba44617fdd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwNTc3OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r423305778", "bodyText": "nit: Can use\nLOG.error(\"Couldn't convert to the right data type while reading temperature vector from the DB.\", dte);", "author": "khushbr", "createdAt": "2020-05-11T20:40:02Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/summaries/temperature/CompactNodeSummary.java", "diffHunk": "@@ -68,6 +79,88 @@ public CompactNodeSummary(final String nodeId, final String hostAddress) {\n         this.numOfShards = new int[TemperatureVector.Dimension.values().length];\n     }\n \n+    public static CompactNodeSummary buildSummaryFromDatabase(Result<Record> records,\n+        DSLContext context) {\n+        if (records.size() != 1) {\n+            LOG.error(\"Expected 1 compact node summary, got {}. Summaries: {}\", records.size(),\n+                records);\n+            throw new IllegalArgumentException(\n+                \"Only 1 CompactNodeSummary expected. Found: \" + records.size());\n+        }\n+\n+        Record record = records.get(0);\n+        final String nodeId =\n+            record.get(DSL.field(DSL.name(HotNodeSummary.SQL_SCHEMA_CONSTANTS.NODE_ID_COL_NAME),\n+                String.class));\n+        final String hostAddress =\n+            record.get(DSL.field(DSL.name(SQL_SCHEMA_CONSTANTS.HOST_IP_ADDRESS_COL_NAME)), String.class);\n+\n+        CompactNodeSummary summary = new CompactNodeSummary(nodeId, hostAddress);\n+\n+        readAndSetTotalConsumedPerDimension(record, summary);\n+        readAndSetNumShardsPerDimension(record, summary);\n+        readAndSetTemperatureVector(record, summary);\n+\n+        return summary;\n+    }\n+\n+    private static void readAndSetTemperatureVector(Record record, CompactNodeSummary summary) {\n+        try {\n+            for (TemperatureVector.Dimension dimension : TemperatureVector.Dimension.values()) {\n+                String normalizedMeanUsageForDimension = record\n+                    .get((DSL.field(DSL.name(dimension.NAME + MEAN_SUFFIX_KEY),\n+                        String.class)));\n+                short value = 0;\n+                if (normalizedMeanUsageForDimension != null && !normalizedMeanUsageForDimension\n+                    .isEmpty()) {\n+                    value = Short.parseShort(normalizedMeanUsageForDimension);\n+                }\n+                summary.setTemperatureForDimension(dimension,\n+                    new NormalizedValue(value));\n+            }\n+        } catch (final DataTypeException dte) {\n+            LOG.error(\"Couldn't convert to the right data type while reading temperature vector \"\n+                + \"from the DB. {}\", dte.getMessage(), dte);", "originalCommit": "191520336d6d63fe905d55495d4e0ba44617fdd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwODQzNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r423308434", "bodyText": "Can you add a java doc here explaining what the key, value represent and map usage.", "author": "khushbr", "createdAt": "2020-05-11T20:45:05Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/util/SQLiteQueryUtils.java", "diffHunk": "@@ -45,13 +49,14 @@\n  */\n public class SQLiteQueryUtils {\n   private static final Map<String, String> nestedTableMap;\n+  private static final Map<String, String> temperatureProfileNestedSummaryMap;", "originalCommit": "191520336d6d63fe905d55495d4e0ba44617fdd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMxMDA2NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/181#discussion_r423310064", "bodyText": "Why use an unmodifiableMap instead of an immutableMap ?", "author": "khushbr", "createdAt": "2020-05-11T20:48:10Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/util/SQLiteQueryUtils.java", "diffHunk": "@@ -61,6 +66,18 @@\n     nestedTableMap = Collections.unmodifiableMap(tableMap);\n   }\n \n+  static {\n+    Map<String, String> temperatureSummaryMap = new HashMap<>();\n+    temperatureSummaryMap.put(ResourceFlowUnit.RCA_TABLE_NAME,\n+        NodeLevelDimensionalSummary.SUMMARY_TABLE_NAME);\n+    temperatureSummaryMap.put(NodeLevelDimensionalSummary.SUMMARY_TABLE_NAME,\n+        NodeLevelDimensionalSummary.ZONE_SUMMARY_TABLE_NAME);\n+    temperatureSummaryMap.put(NodeLevelDimensionalSummary.ZONE_SUMMARY_TABLE_NAME,\n+        ShardProfileSummary.SUMMARY_TABLE_NAME);\n+\n+    temperatureProfileNestedSummaryMap = Collections.unmodifiableMap(temperatureSummaryMap);", "originalCommit": "191520336d6d63fe905d55495d4e0ba44617fdd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}