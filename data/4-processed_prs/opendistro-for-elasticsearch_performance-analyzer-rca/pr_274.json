{"pr_number": 274, "pr_title": "Make RCA framework NOT use ClusterDetailsEventProcessor", "pr_createdAt": "2020-07-14T19:20:26Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/274", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIzMTk1OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/274#discussion_r455231958", "bodyText": "do wen need to check whether appContext is null here to avoid null pointer exception ?", "author": "rguo-aws", "createdAt": "2020-07-15T17:48:57Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/core/Node.java", "diffHunk": "@@ -187,4 +194,20 @@ public void setLocalFlowUnit(T localFlowUnit) {\n   public void readRcaConf(RcaConf conf) {\n     return;\n   }\n+\n+  public void setAppContext(final AppContext appContext) {\n+    this.appContext = appContext;\n+  }\n+\n+  public InstanceDetails getInstanceDetails() {\n+    return this.appContext.getMyInstanceDetails();", "originalCommit": "74f34c413f5bee247c653169890d64dce8cb534d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIzMjk3MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/274#discussion_r455232970", "bodyText": "Thanks a lot @rguo-aws Will add it", "author": "yojs", "createdAt": "2020-07-15T17:50:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIzMTk1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIzMjU0Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/274#discussion_r455232542", "bodyText": "add javadoc for this function ?", "author": "rguo-aws", "createdAt": "2020-07-15T17:49:48Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/core/Node.java", "diffHunk": "@@ -187,4 +194,20 @@ public void setLocalFlowUnit(T localFlowUnit) {\n   public void readRcaConf(RcaConf conf) {\n     return;\n   }\n+\n+  public void setAppContext(final AppContext appContext) {", "originalCommit": "74f34c413f5bee247c653169890d64dce8cb534d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ0MjE5NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/274#discussion_r455442195", "bodyText": "Do we really want a javadoc for a setter ?", "author": "yojs", "createdAt": "2020-07-16T00:34:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTIzMjU0Mg=="}], "type": "inlineReview"}, {"oid": "f19bf43b58d07103b5caecb4de01cf86859b39ef", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f19bf43b58d07103b5caecb4de01cf86859b39ef", "message": "Make RCA framework NOT use ClusterDetailsEventProcessor\n\nUsing the static classes have problems as one instance of JVM can have only one instance of the class running. ClusterDetailsEventProcessor is an important class as it contains the instance details. If we want to simutate multiple RCAControllers running as part of a single JVM for the purpose of IntegrationTest framework, we should make ClusterDetailsEventProcessor a non-static class, such that each RcaController can work with its own. This is not the complete removal of the static methods in the ClusterDetailsEventProcessor, but just making the RCA framework not use them. There will be follow up PRs that will eventually make ClusterDetailsEventProcessor non-static", "committedDate": "2020-07-15T17:56:30Z", "type": "commit"}, {"oid": "df68c3889812ed62f22d3c6c3995e7a4950712c6", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/df68c3889812ed62f22d3c6c3995e7a4950712c6", "message": "Removing all occurences of \"ClusterDetailsEventProcessor.getCurrentNodeDetails\" except for periodic samplers", "committedDate": "2020-07-15T17:56:30Z", "type": "commit"}, {"oid": "7ba6a94937d500c4bce72d2e35a1b34f906ded57", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/7ba6a94937d500c4bce72d2e35a1b34f906ded57", "message": "Gave RCA scheduler access to AppContext instead of just the current node instance", "committedDate": "2020-07-15T17:56:30Z", "type": "commit"}, {"oid": "90b21d92d94f3dd69b2d897d70a7436116973375", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/90b21d92d94f3dd69b2d897d70a7436116973375", "message": "This should remove all the usage of static ClusterDetailsEventProcessor from the RCA code. Except for the Periodic Samplers.", "committedDate": "2020-07-15T17:56:31Z", "type": "commit"}, {"oid": "70bdcd878c1cd2a265bbba9a6a9242e197d6a4e0", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/70bdcd878c1cd2a265bbba9a6a9242e197d6a4e0", "message": "removed the usage of static getDataNodesDetails() call from QueryMetricsRequestHandler", "committedDate": "2020-07-15T17:56:31Z", "type": "commit"}, {"oid": "fc0f4ef45ec81b34e4071e7fa6c9cedf9458cf6b", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/fc0f4ef45ec81b34e4071e7fa6c9cedf9458cf6b", "message": "resolving the merge conflicts", "committedDate": "2020-07-15T18:28:37Z", "type": "commit"}, {"oid": "fc0f4ef45ec81b34e4071e7fa6c9cedf9458cf6b", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/fc0f4ef45ec81b34e4071e7fa6c9cedf9458cf6b", "message": "resolving the merge conflicts", "committedDate": "2020-07-15T18:28:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI0MDI0Ng==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/274#discussion_r455240246", "bodyText": "Just a minor nit, should we return an immutable list here as well to be consistent?", "author": "ktkrg", "createdAt": "2020-07-15T18:02:15Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/AppContext.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *  A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  or in the \"license\" file accompanying this file. This file is distributed\n+ *  on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *  express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.util.InstanceDetails;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.reader.ClusterDetailsEventProcessor;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.ImmutableList;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * The PA agent process is composed of multiple components. The PA Reader and RCA are two such components that are\n+ * independent in a way they process information but also share some information such as the node and the cluster\n+ * details. Today, some of these information is accessed by calling static methods and members. This is a bad idea.\n+ * This class encapsulates such information and is created right at the start in the {@code PerformanceAnalyzerApp}.\n+ */\n+public class AppContext {\n+  private volatile ClusterDetailsEventProcessor clusterDetailsEventProcessor;\n+\n+  @VisibleForTesting\n+  private volatile List<InstanceDetails> instances;\n+\n+  public AppContext() {\n+    this.clusterDetailsEventProcessor = null;\n+  }\n+\n+  public void setClusterDetailsEventProcessor(final ClusterDetailsEventProcessor clusterDetailsEventProcessor) {\n+    this.clusterDetailsEventProcessor = clusterDetailsEventProcessor;\n+  }\n+\n+  public InstanceDetails getMyInstanceDetails() {\n+    ClusterDetailsEventProcessor.NodeDetails nodeDetails = clusterDetailsEventProcessor.getCurrentNodeDetails();\n+\n+    InstanceDetails ret;\n+    if (nodeDetails == null) {\n+      ret = new InstanceDetails(AllMetrics.NodeRole.UNKNOWN);\n+    } else {\n+      ret = new InstanceDetails(\n+          AllMetrics.NodeRole.valueOf(nodeDetails.getRole()),\n+          nodeDetails.getId(),\n+          nodeDetails.getHostAddress(),\n+          nodeDetails.getIsMasterNode());\n+    }\n+    return ret;\n+  }\n+\n+  /**\n+   * Can be used to get all the nodes in the cluster.\n+   *\n+   * @return Returns an empty list of the details are not available or else it provides the immutable list of nodes in\n+   * the cluster.\n+   */\n+  public List<InstanceDetails> getAllClusterInstances() {\n+    return getInstanceDetailsFromNodeDetails(clusterDetailsEventProcessor.getNodesDetails());\n+  }\n+\n+  public List<InstanceDetails> getDataNodeInstances() {\n+    return getInstanceDetailsFromNodeDetails(clusterDetailsEventProcessor.getDataNodesDetails());\n+  }\n+\n+  private static List<InstanceDetails> getInstanceDetailsFromNodeDetails(\n+      final List<ClusterDetailsEventProcessor.NodeDetails> nodeDetails) {\n+    List<InstanceDetails> instances = new ArrayList<>();\n+\n+    for (ClusterDetailsEventProcessor.NodeDetails node : nodeDetails) {\n+      InstanceDetails instanceDetails = new InstanceDetails(\n+          AllMetrics.NodeRole.valueOf(node.getRole()), node.getId(), node.getHostAddress(), node.getIsMasterNode());\n+      instances.add(instanceDetails);\n+    }\n+    return ImmutableList.copyOf(instances);\n+  }\n+\n+  public List<String> getPeerInstanceIps() {\n+    return getAllClusterInstances().stream()\n+        .skip(1)  // Skipping the first instance as it is self.\n+        .map(InstanceDetails::getInstanceIp)\n+        .collect(Collectors.toList());", "originalCommit": "74f34c413f5bee247c653169890d64dce8cb534d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQzOTQxMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/274#discussion_r455439410", "bodyText": "Sure ! will add", "author": "yojs", "createdAt": "2020-07-16T00:24:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI0MDI0Ng=="}], "type": "inlineReview"}, {"oid": "377fa2d80234d7281b30fa2ce93830490f857c7c", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/377fa2d80234d7281b30fa2ce93830490f857c7c", "message": "Handling null appContext in Node.java", "committedDate": "2020-07-15T21:03:35Z", "type": "commit"}, {"oid": "ee515f976fce589cc87aa6767b520a31600a6015", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/ee515f976fce589cc87aa6767b520a31600a6015", "message": "Fixing some more UTs", "committedDate": "2020-07-15T21:55:29Z", "type": "commit"}, {"oid": "5c82255bd261c9acb560394054ef4347965da5bb", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/5c82255bd261c9acb560394054ef4347965da5bb", "message": "make getPeerInstanceIps return an immutable list", "committedDate": "2020-07-16T00:26:00Z", "type": "commit"}, {"oid": "b8387e143a046e6c7f1baee84469dd750509e76d", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b8387e143a046e6c7f1baee84469dd750509e76d", "message": "removing all unused imports of ClusterDetailsEventProcessor", "committedDate": "2020-07-16T00:33:05Z", "type": "commit"}]}