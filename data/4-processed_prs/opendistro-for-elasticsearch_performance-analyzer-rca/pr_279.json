{"pr_number": 279, "pr_title": "Rest mutual auth fix", "pr_createdAt": "2020-07-16T18:04:33Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/279", "timeline": [{"oid": "b881fc828476c7deb8ed81768db75a790821fe2e", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b881fc828476c7deb8ed81768db75a790821fe2e", "message": "Fix merge issue with WireHopperTest", "committedDate": "2020-07-17T17:52:23Z", "type": "forcePushed"}, {"oid": "af001b6099a392b4af7daf1c44fd85b927d26fec", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/af001b6099a392b4af7daf1c44fd85b927d26fec", "message": "Add required mutual auth to gRPC Server/Client\n\nPreviously we had 1 sided TLS on the server side. Data between the\nclient and server was send over an encrypted channel, but any client\ncould make requests to the server.\n\nThis commit changes the behavior so that only clients with the matching\ncertificates can make requests to the server when TLS is enabled. This\ncommit does NOT add support for installing a trust manager. That must be\nadded in the future.", "committedDate": "2020-07-21T18:12:04Z", "type": "commit"}, {"oid": "d0b6804081c6bc40602f86400e8a0ab9edce6537", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/d0b6804081c6bc40602f86400e8a0ab9edce6537", "message": "Add full mutual auth to gRPC client/server and augment tests", "committedDate": "2020-07-21T18:12:04Z", "type": "commit"}, {"oid": "f545e2cc13526a22524cdc95293fb87ca38d9ed2", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f545e2cc13526a22524cdc95293fb87ca38d9ed2", "message": "Implement mutual auth for the REST endpoints\n\nThis commit makes the PerformanceAnalyzerWebServer authenticate clients\nif the user specifies a certificate authority. It also properly sets up\nthe server's identity, so that any clients can authenticate the server.", "committedDate": "2020-07-21T18:19:16Z", "type": "commit"}, {"oid": "de2cb4db6329563d33ac2beff2708e4e59304dfc", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/de2cb4db6329563d33ac2beff2708e4e59304dfc", "message": "Fix merge issue with WireHopperTest", "committedDate": "2020-07-21T18:19:21Z", "type": "commit"}, {"oid": "28033f241ced960acb4a06af77f2c87335388ea6", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/28033f241ced960acb4a06af77f2c87335388ea6", "message": "Fixing up PerformanceAnalyzerWebServerTest", "committedDate": "2020-07-21T18:19:21Z", "type": "commit"}, {"oid": "8894129c2a17e1fa2cc1c6acdf395f82c1aebf21", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/8894129c2a17e1fa2cc1c6acdf395f82c1aebf21", "message": "Modify gradle.yml for testing", "committedDate": "2020-07-21T18:19:21Z", "type": "commit"}, {"oid": "8894129c2a17e1fa2cc1c6acdf395f82c1aebf21", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/8894129c2a17e1fa2cc1c6acdf395f82c1aebf21", "message": "Modify gradle.yml for testing", "committedDate": "2020-07-21T18:19:21Z", "type": "forcePushed"}, {"oid": "dea63c469011a2236be81bbe071b0bde83ca6dd7", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/dea63c469011a2236be81bbe071b0bde83ca6dd7", "message": "Remove info log flooding from testing gradle.yml", "committedDate": "2020-07-21T18:31:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIyNDU5MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/279#discussion_r460224590", "bodyText": "nit: additional space. static  class -> static class", "author": "ktkrg", "createdAt": "2020-07-24T18:38:33Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/PerformanceAnalyzerWebServer.java", "diffHunk": "@@ -66,8 +71,34 @@ public static HttpServer createInternalServer(String portFromSetting, String hos\n     return null;\n   }\n \n+  /**\n+   * ClientAuthConfigurator makes the server perform client authentication if the user has set up a\n+   * certificate authority\n+   */\n+  private static  class ClientAuthConfigurator extends HttpsConfigurator {", "originalCommit": "dea63c469011a2236be81bbe071b0bde83ca6dd7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAzNzQ4Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/279#discussion_r461037482", "bodyText": "Do you plan to wrap up the TODO in this PR or in a follow up ?", "author": "yojs", "createdAt": "2020-07-27T17:03:45Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/PerformanceAnalyzerWebServer.java", "diffHunk": "@@ -81,38 +112,30 @@ private static HttpServer createHttpsServer(int readerPort, String bindHost) thr\n       server = HttpsServer.create(new InetSocketAddress(InetAddress.getLoopbackAddress(), readerPort), INCOMING_QUEUE_LENGTH);\n     }\n \n-    TrustManager[] trustAllCerts =\n-        new TrustManager[] {\n-            new X509TrustManager() {\n-\n-              public X509Certificate[] getAcceptedIssuers() {\n-                return null;\n-              }\n-\n-              public void checkClientTrusted(X509Certificate[] certs, String authType) {}\n-\n-              public void checkServerTrusted(X509Certificate[] certs, String authType) {}\n-            }\n-        };\n-\n-    HostnameVerifier allHostsValid =\n-        new HostnameVerifier() {\n-          public boolean verify(String hostname, SSLSession session) {\n-            return true;\n-          }\n-        };\n-\n     // Install the all-trusting trust manager\n     SSLContext sslContext = SSLContext.getInstance(\"TLSv1.2\");\n \n     KeyStore ks = CertificateUtils.createKeyStore();\n     KeyManagerFactory kmf = KeyManagerFactory.getInstance(\"NewSunX509\");\n     kmf.init(ks, CertificateUtils.IN_MEMORY_PWD.toCharArray());\n-    sslContext.init(kmf.getKeyManagers(), trustAllCerts, null);\n+    sslContext.init(kmf.getKeyManagers(), CertificateUtils.getTrustManagers(true), null);\n+    server.setHttpsConfigurator(new ClientAuthConfigurator(sslContext));\n+\n+\n+    // TODO ask ktkrg why this is necessary", "originalCommit": "dea63c469011a2236be81bbe071b0bde83ca6dd7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}