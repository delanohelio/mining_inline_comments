{"pr_number": 1626, "pr_title": "JBTM-3320 LRA forget calls for nested completed participants are not \u2026", "pr_createdAt": "2020-05-21T08:56:27Z", "pr_url": "https://github.com/jbosstm/narayana/pull/1626", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxNzEzMg==", "url": "https://github.com/jbosstm/narayana/pull/1626#discussion_r428817132", "bodyText": "just two ideas\n\ncould be pending null or it could not be?\nI would, personally and if I don't miss some detail, consider more readable the lamda style like pending.removeIf(record -> record.forget())", "author": "ochaloup", "createdAt": "2020-05-21T17:56:01Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/Transaction.java", "diffHunk": "@@ -690,10 +697,21 @@ public boolean forgetParticipant(String participantUrl) {\n         return findLRAParticipant(participantUrl, true) != null;\n     }\n \n-    public void forgetAllParticipants() {\n-        if (pending != null) {\n-            pending.forEach(LRARecord::forget);\n+    public boolean forgetAllParticipants() {\n+        boolean notifiedAll = true;\n+\n+        Iterator<LRARecord> iterator = pending.iterator();", "originalCommit": "fdd62431d14c2f1eefd3e2cce92acaf58010509d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0351d68661591df1fd53bd81d741fc7ded362bfb", "url": "https://github.com/jbosstm/narayana/commit/0351d68661591df1fd53bd81d741fc7ded362bfb", "message": "JBTM-3320 LRA forget calls for nested completed participants are not repeated and do not close the LRA", "committedDate": "2020-05-22T07:55:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3ODY5Mg==", "url": "https://github.com/jbosstm/narayana/pull/1626#discussion_r430278692", "bodyText": "Do we need to call runPostLRAActions();. Have you tested your changes with an AfterLRAListener registered with the nested LRA?", "author": "mmusgrov", "createdAt": "2020-05-26T09:28:32Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/Transaction.java", "diffHunk": "@@ -480,7 +480,13 @@ private int doEnd(boolean cancel) {\n                     status = toLRAStatus(status());\n                 } else {\n                     // forget calls for nested participants\n-                    forgetAllParticipants();\n+                    if (forgetAllParticipants()) {\n+                        updateState(LRAStatus.Closed);\n+                        return ActionStatus.COMMITTED;", "originalCommit": "0351d68661591df1fd53bd81d741fc7ded362bfb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM0ODgxOQ==", "url": "https://github.com/jbosstm/narayana/pull/1626#discussion_r430348819", "bodyText": "AfterLRA notifications should depend on the outcome of forget calls, as nested LRA is not finished before forget calls are delivered. Or did I misunderstood the scenario? I can add such test if needed.", "author": "xstefank", "createdAt": "2020-05-26T11:41:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3ODY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3MTA4Mw==", "url": "https://github.com/jbosstm/narayana/pull/1626#discussion_r430971083", "bodyText": "After your code changes the transaction end logic finishes early and you are skipping a section of code that we currently execute. In particular the code on line\n\n  \n    \n      narayana/rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/Transaction.java\n    \n    \n         Line 520\n      in\n      0351d68\n    \n    \n    \n    \n\n        \n          \n           runPostLRAActions(); \n        \n    \n  \n\n that was designed to perform the AfterLRA notifications is skipped.", "author": "mmusgrov", "createdAt": "2020-05-27T09:10:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3ODY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIyMzA3Mg==", "url": "https://github.com/jbosstm/narayana/pull/1626#discussion_r433223072", "bodyText": "sorry @mmusgrov I've just got back to this. So if I remove this return statement then it should be ok right?", "author": "xstefank", "createdAt": "2020-06-01T13:08:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3ODY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxMDg5Nw==", "url": "https://github.com/jbosstm/narayana/pull/1626#discussion_r433410897", "bodyText": "@mmusgrov actually, it doesn't seem to matter to return here. I've added the test as you've requested.", "author": "xstefank", "createdAt": "2020-06-01T18:27:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3ODY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc0NTg0OQ==", "url": "https://github.com/jbosstm/narayana/pull/1626#discussion_r433745849", "bodyText": "I am still uncomfortable why this route through the end() routine is returning early. No other code path returns early so it makes maintaining this method more difficult. We either need to avoid the early return or fully comment why it is safe to do so.\nThanks for the extra test - I didn't really understand what is was doing so some commentary would have been helpful to the both the reviewer and to future maintainers.", "author": "mmusgrov", "createdAt": "2020-06-02T09:32:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3ODY5Mg=="}], "type": "inlineReview"}, {"oid": "a22c125914a45c4c6ce23070c303b4a3dc100eec", "url": "https://github.com/jbosstm/narayana/commit/a22c125914a45c4c6ce23070c303b4a3dc100eec", "message": "JBTM-3320 LRA forget calls for nested completed participants are not repeated and do not close the LRA", "committedDate": "2020-06-01T18:24:01Z", "type": "forcePushed"}, {"oid": "2f4c818a22781edea7d96c4207fb29a1162bee8d", "url": "https://github.com/jbosstm/narayana/commit/2f4c818a22781edea7d96c4207fb29a1162bee8d", "message": "JBTM-3320 LRA forget calls for nested completed participants are not repeated and do not close the LRA", "committedDate": "2020-06-01T18:25:53Z", "type": "forcePushed"}, {"oid": "854af77b4ef7e69045c7de1aca68152e78b4ee39", "url": "https://github.com/jbosstm/narayana/commit/854af77b4ef7e69045c7de1aca68152e78b4ee39", "message": "JBTM-3320 LRA forget calls for nested completed participants are not repeated and do not close the LRA", "committedDate": "2020-06-02T07:19:41Z", "type": "forcePushed"}, {"oid": "ab3c6872bad6a1194386e25bbde19ef9756e99ac", "url": "https://github.com/jbosstm/narayana/commit/ab3c6872bad6a1194386e25bbde19ef9756e99ac", "message": "JBTM-3320 LRA forget calls for nested completed participants are not repeated and do not close the LRA", "committedDate": "2020-06-02T14:10:41Z", "type": "forcePushed"}, {"oid": "839e9992c72968ae8e2df618e002bd187a6f1f45", "url": "https://github.com/jbosstm/narayana/commit/839e9992c72968ae8e2df618e002bd187a6f1f45", "message": "JBTM-3320 LRA forget calls for nested completed participants are not repeated and do not close the LRA", "committedDate": "2020-06-02T15:43:20Z", "type": "commit"}, {"oid": "839e9992c72968ae8e2df618e002bd187a6f1f45", "url": "https://github.com/jbosstm/narayana/commit/839e9992c72968ae8e2df618e002bd187a6f1f45", "message": "JBTM-3320 LRA forget calls for nested completed participants are not repeated and do not close the LRA", "committedDate": "2020-06-02T15:43:20Z", "type": "forcePushed"}]}