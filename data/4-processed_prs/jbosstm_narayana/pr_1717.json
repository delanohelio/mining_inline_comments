{"pr_number": 1717, "pr_title": "JBTM-3342 Propagate the parent context header (Long-Running-Action-Pa\u2026", "pr_createdAt": "2020-11-08T17:33:59Z", "pr_url": "https://github.com/jbosstm/narayana/pull/1717", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MjYwMg==", "url": "https://github.com/jbosstm/narayana/pull/1717#discussion_r519642602", "bodyText": "this will override user-provided header. Is it intended behavior?", "author": "xstefank", "createdAt": "2020-11-09T08:53:27Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -271,6 +271,28 @@ public void filter(ContainerRequestContext containerRequestContext) {\n                 lraId = incommingLRA;\n         }\n \n+        String query = incommingLRA == null ? null : incommingLRA.getQuery();\n+\n+        if (query != null) {\n+            for (String param : query.split(\"&\")) { // or apply a regex matching parent=...\n+                if (param.startsWith(\"parent=\")) {\n+                    String parent = param.split(\"=\", 2)[1];\n+\n+                    try {\n+                        // verify that parent corresponds to a valid URI\n+                        new URI(parent);\n+                        // the parent param was generated using URI.toASCIIString\n+                        headers.putSingle(LRA_HTTP_PARENT_CONTEXT_HEADER, parent);", "originalCommit": "36aa27618636cc291e41af5cd172720fc8b0ac63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4MzAwNw==", "url": "https://github.com/jbosstm/narayana/pull/1717#discussion_r519683007", "bodyText": "Come on, read the spec, aren't we allowed to implement it. Does user behaviour override the spec now (ie does the users' opinion of what constitutes the transaction hierarchy trump actuality).", "author": "mmusgrov", "createdAt": "2020-11-09T09:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MjYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTcwMjY3Mg==", "url": "https://github.com/jbosstm/narayana/pull/1717#discussion_r519702672", "bodyText": "https://github.com/eclipse/microprofile-lra/blob/master/api/src/main/java/org/eclipse/microprofile/lra/annotation/ws/rs/LRA.java#L82\n-- I think we should fail if the user propagates the wrong parent header, or at least log warning. This seems like it can hide potential issues with user code.", "author": "xstefank", "createdAt": "2020-11-09T10:27:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MjYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc3NDY4NA==", "url": "https://github.com/jbosstm/narayana/pull/1717#discussion_r519774684", "bodyText": "That part of the spec is referring to LRA_HTTP_CONTEXT_HEADER.\nYou can't randomly change the parent context since it forms a strict hierarchy.", "author": "mmusgrov", "createdAt": "2020-11-09T12:36:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MjYwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MzcwOA==", "url": "https://github.com/jbosstm/narayana/pull/1717#discussion_r519643708", "bodyText": "Remove this please and add a comment explaining that the header is populated by the filter automatically?", "author": "xstefank", "createdAt": "2020-11-09T08:55:17Z", "path": "rts/lra/test/basic/src/test/java/io/narayana/lra/arquillian/NestedParticipantIT.java", "diffHunk": "@@ -99,34 +106,71 @@ public void nestedParticipantAfterLRACallTest() {\n                 .header(LRA.LRA_HTTP_CONTEXT_HEADER, parentLRA)\n                 .get();\n \n-            Assert.assertEquals(200, response.getStatus());\n+            assertEquals(200, response.getStatus());\n             Assert.assertTrue(response.hasEntity());\n \n             nestedLRA = URI.create(response.readEntity(String.class));\n-            Assert.assertNotEquals(parentLRA, nestedLRA);\n-            Assert.assertEquals(1, lraMetricService.getMetric(LRAMetricType.Nested, parentLRA, NestedParticipant.class));\n+            assertNotEquals(parentLRA, nestedLRA);\n+            assertEquals(1, lraMetricService.getMetric(LRAMetricType.Nested, parentLRA, NestedParticipant.class));\n         } finally {\n             if (response != null) {\n                 response.close();\n             }\n         }\n \n         // close nested LRA\n-        narayanaLRAClient.closeLRA(nestedLRA);\n+        lraClient.closeLRA(nestedLRA);\n         // the nested LRA should be in Closed state, however, we keep it in Closing state\n         // so we can't wait for the recovery of the nested LRA\n         // https://issues.redhat.com/browse/JBTM-3330\n         narayanaLRARecovery.waitForEndPhaseReplay(nestedLRA);\n \n-        Assert.assertEquals(1, lraMetricService.getMetric(LRAMetricType.Completed, nestedLRA, NestedParticipant.class));\n-        Assert.assertEquals(2, lraMetricService.getMetric(LRAMetricType.Nested, parentLRA, NestedParticipant.class));\n-        Assert.assertEquals(0, lraMetricService.getMetric(LRAMetricType.AfterLRA, nestedLRA, NestedParticipant.class));\n+        assertEquals(1, lraMetricService.getMetric(LRAMetricType.Completed, nestedLRA, NestedParticipant.class));\n+        assertEquals(2, lraMetricService.getMetric(LRAMetricType.Nested, parentLRA, NestedParticipant.class));\n+        assertEquals(0, lraMetricService.getMetric(LRAMetricType.AfterLRA, nestedLRA, NestedParticipant.class));\n \n-        narayanaLRAClient.closeLRA(parentLRA);\n+        lraClient.closeLRA(parentLRA);\n         narayanaLRARecovery.waitForEndPhaseReplay(nestedLRA);\n \n-        Assert.assertEquals(\"After LRA method for nested LRA enlist should have been called\",\n+        assertEquals(\"After LRA method for nested LRA enlist should have been called\",\n             1, lraMetricService.getMetric(LRAMetricType.AfterLRA, nestedLRA, NestedParticipant.class));\n \n     }\n+\n+    @Test\n+    public void testParentContext() {\n+        // start a top level LRA\n+        URI parent = lraClient.startLRA(\"parent\");\n+        // and nest another one under it\n+        URI child = lraClient.startLRA(\"child\");\n+\n+        Response response = null;\n+\n+        try {\n+            response = client.target(UriBuilder.fromUri(baseURL.toExternalForm())\n+                    .path(NestedParticipant.ROOT_PATH)\n+                    .path(NestedParticipant.PATH))\n+                    .request()\n+//                .header(LRA.LRA_HTTP_CONTEXT_HEADER, parentLRA)", "originalCommit": "36aa27618636cc291e41af5cd172720fc8b0ac63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4MzU3Ng==", "url": "https://github.com/jbosstm/narayana/pull/1717#discussion_r519683576", "bodyText": "Sure. I see that the fix has broken one of the tests so I will remove it at the same time I resolve that failure. I'll also add a test for deeper transaction hierarchies.", "author": "mmusgrov", "createdAt": "2020-11-09T09:57:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MzcwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0NDc5MA==", "url": "https://github.com/jbosstm/narayana/pull/1717#discussion_r519644790", "bodyText": "we should add a message that says which one was null. The error message in test says it is only parentId.", "author": "xstefank", "createdAt": "2020-11-09T08:57:10Z", "path": "rts/lra/test/basic/src/test/java/io/narayana/lra/arquillian/resource/NestedParticipant.java", "diffHunk": "@@ -48,16 +47,33 @@\n \n     public static final String ROOT_PATH = \"/nested\";\n     public static final String ENLIST_PATH = \"/enlist\";\n+    public static final String PATH = \"path\";\n \n     @Inject\n     LRAMetricService lraMetricService;\n \n+    @LRA(end = false)\n+    @GET\n+    @Path(PATH)\n+    @Produces({MediaType.TEXT_PLAIN})\n+    public Response runWithNestedContext(@HeaderParam(LRA.LRA_HTTP_CONTEXT_HEADER) URI lraId,\n+                           @HeaderParam(LRA.LRA_HTTP_PARENT_CONTEXT_HEADER) URI parentId) {\n+        if (parentId == null || lraId == null) {\n+            return Response.serverError().build();", "originalCommit": "36aa27618636cc291e41af5cd172720fc8b0ac63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY4NDU5NA==", "url": "https://github.com/jbosstm/narayana/pull/1717#discussion_r519684594", "bodyText": "I don't think so, this is a test suite in which we already have tests that check the presence of LRA_HTTP_CONTEXT_HEADER.", "author": "mmusgrov", "createdAt": "2020-11-09T09:59:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0NDc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTcwMzA5Nw==", "url": "https://github.com/jbosstm/narayana/pull/1717#discussion_r519703097", "bodyText": "true, this was more about this particular test only. It is unlikely it wouldn't be caught elsewhere.", "author": "xstefank", "createdAt": "2020-11-09T10:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0NDc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc3MTk1OA==", "url": "https://github.com/jbosstm/narayana/pull/1717#discussion_r519771958", "bodyText": "This is a test for nested contexts so LRA_HTTP_CONTEXT_HEADER is not relevant (ie it just adds noise to an already large test suite).", "author": "mmusgrov", "createdAt": "2020-11-09T12:31:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0NDc5MA=="}], "type": "inlineReview"}, {"oid": "96a00cf3e3e98f848e15d5ee9de376d91e079cd5", "url": "https://github.com/jbosstm/narayana/commit/96a00cf3e3e98f848e15d5ee9de376d91e079cd5", "message": "JBTM-3342 Propagate the parent context header (Long-Running-Action-Parent)", "committedDate": "2020-11-16T15:35:18Z", "type": "forcePushed"}, {"oid": "d05952f6b598b5f8ac40bdd33071c2e712f67fed", "url": "https://github.com/jbosstm/narayana/commit/d05952f6b598b5f8ac40bdd33071c2e712f67fed", "message": "JBTM-3342 Propagate the parent context", "committedDate": "2020-11-16T18:49:27Z", "type": "forcePushed"}, {"oid": "254e4dcec8177c2668e900aff94fe16aafd390ac", "url": "https://github.com/jbosstm/narayana/commit/254e4dcec8177c2668e900aff94fe16aafd390ac", "message": "JBTM-3342 Propagate the parent context", "committedDate": "2020-11-16T19:10:44Z", "type": "forcePushed"}, {"oid": "05a21cf80a3c1c5487b0c43bc9780e496f066418", "url": "https://github.com/jbosstm/narayana/commit/05a21cf80a3c1c5487b0c43bc9780e496f066418", "message": "JBTM-3342 Propagate the LRA parent context", "committedDate": "2020-11-16T19:30:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM0NzM1Mw==", "url": "https://github.com/jbosstm/narayana/pull/1717#discussion_r525347353", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String QUERY_PAIR_SEPARATOR = \"&\"; //\n          \n          \n            \n                public static final String QUERY_PAIR_SEPARATOR = \"&\";", "author": "xstefank", "createdAt": "2020-11-17T17:26:31Z", "path": "rts/lra/service-base/src/main/java/io/narayana/lra/LRAConstants.java", "diffHunk": "@@ -40,6 +40,8 @@\n     public static final String CLIENT_ID_PARAM_NAME = \"ClientID\";\n     public static final String TIMELIMIT_PARAM_NAME = \"TimeLimit\";\n     public static final String PARENT_LRA_PARAM_NAME = \"ParentLRA\";\n+    public static final String QUERY_PAIR_SEPARATOR = \"&\"; //", "originalCommit": "05a21cf80a3c1c5487b0c43bc9780e496f066418", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM1MjA5OQ==", "url": "https://github.com/jbosstm/narayana/pull/1717#discussion_r525352099", "bodyText": "is it correct to return null if decode is false? In that case, this can be refactored to not contain the parameter.", "author": "xstefank", "createdAt": "2020-11-17T17:33:36Z", "path": "rts/lra/service-base/src/main/java/io/narayana/lra/Current.java", "diffHunk": "@@ -64,6 +72,67 @@ public static Object getState(String key) {\n         return null;\n     }\n \n+    private static String getParents(URI uri) {\n+        String query = uri.getQuery();\n+\n+        if (query != null) {\n+            for (String nvpair : query.split(QUERY_PAIR_SEPARATOR)) {\n+                if (nvpair.startsWith(PARENT_LRA_PARAM_NAME + QUERY_FIELD_SEPARATOR)) {\n+                    return nvpair.split(QUERY_FIELD_SEPARATOR)[1];\n+                }\n+            }\n+        }\n+\n+        return null;\n+    }\n+\n+    // construct the LRA URI including the parent hierarchy as a query parameter\n+    public static URI buildFullLRAUrl(String baseURI, URI parentId) throws URISyntaxException {\n+        // is the parent part of a hierarchy\n+        String parents = Current.getParents(parentId); // gets the hierarchy form the query param\n+        // we have the hierarchy so remove the query parameter\n+        String gParent = new URI(parentId.getScheme(),\n+                parentId.getAuthority(),\n+                parentId.getPath(),\n+                null, // skip the query string\n+                parentId.getFragment())\n+                .toASCIIString();\n+\n+        if (parents != null) {\n+            gParent += parents + \",\"; // , separated list of the hierarchy\n+        }\n+\n+        return UriBuilder.fromUri(baseURI).queryParam(PARENT_LRA_PARAM_NAME, gParent).build();\n+    }\n+\n+    // given a URL extract the immediate parent of\n+    public static String getFirstParent(URI parent, boolean decode) throws UnsupportedEncodingException {\n+        String query = parent == null ? null : parent.getQuery();\n+\n+        if (query != null) {\n+            for (String param : query.split(QUERY_PAIR_SEPARATOR)) {\n+                if (param.startsWith(PARENT_LRA_PARAM_NAME + QUERY_FIELD_SEPARATOR)) {\n+                    String parents = param.split(QUERY_FIELD_SEPARATOR, 2)[1];\n+\n+                    // parents is a comma separated list of parents (the first one is the direct parent)\n+                    if (parents != null) {\n+                        String[] pa = parents.split(\",\");\n+\n+                        if (pa.length > 0) {\n+                            if (decode) {\n+                                return URLDecoder.decode(pa[0], \"UTF-8\");\n+                            }", "originalCommit": "05a21cf80a3c1c5487b0c43bc9780e496f066418", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d8b59e9ddf57d49e62f3ddab412f081254bd3e80", "url": "https://github.com/jbosstm/narayana/commit/d8b59e9ddf57d49e62f3ddab412f081254bd3e80", "message": "JBTM-3342 Propagate the LRA parent context", "committedDate": "2020-11-17T18:10:29Z", "type": "commit"}, {"oid": "d8b59e9ddf57d49e62f3ddab412f081254bd3e80", "url": "https://github.com/jbosstm/narayana/commit/d8b59e9ddf57d49e62f3ddab412f081254bd3e80", "message": "JBTM-3342 Propagate the LRA parent context", "committedDate": "2020-11-17T18:10:29Z", "type": "forcePushed"}]}