{"pr_number": 1702, "pr_title": "[JBTM-3376] clean CMRIntegrationTest to be more transparent and get more info when it fails", "pr_createdAt": "2020-10-22T08:13:30Z", "pr_url": "https://github.com/jbosstm/narayana/pull/1702", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAzNzA4NA==", "url": "https://github.com/jbosstm/narayana/pull/1702#discussion_r510037084", "bodyText": "Why aren't we printing the stack trace for suppressed exceptions?", "author": "mmusgrov", "createdAt": "2020-10-22T10:01:41Z", "path": "ArjunaJTA/jta/tests/classes/com/hp/mwtests/ts/jta/commitmarkable/integration/CMRIntegrationTest.java", "diffHunk": "@@ -169,60 +167,40 @@ public void run() {\n \t\t\t\t\t\t\t\t\t.createStatement();\n \t\t\t\t\t\t\tcreateStatement\n \t\t\t\t\t\t\t\t\t.execute(\"INSERT INTO foo (bar) VALUES (1)\");\n-\t\t\t\t\t\t\t// System.out.printf(\"XXX txn close%n\");\n-\n-\t\t\t\t\t\t\tif (faultType == 1)\n-\t\t\t\t\t\t\t\tRuntime.getRuntime().halt(0);\n \n                             userTransaction.commit();\n \t\t\t\t\t\t\tconnection.close(); // This wouldn't work for a\n \t\t\t\t\t\t\t\t\t\t\t\t// none-JCA code as commit has\n \t\t\t\t\t\t\t\t\t\t\t\t// closed the connection - it\n \t\t\t\t\t\t\t\t\t\t\t\t// helps us though as JCA seems\n \t\t\t\t\t\t\t\t\t\t\t\t// to rely on finalize\n-\n-\t\t\t\t\t\t\t// System.out\n-\t\t\t\t\t\t\t// .printf(\"committed txn iteration %d%n\", i);\n \t\t\t\t\t\t\tsuccess++;\n \t\t\t\t\t\t} catch (SQLException e) {\n-\t\t\t\t\t\t\tSystem.err.println(\"boom\");\n-\t\t\t\t\t\t\te.printStackTrace();\n-\t\t\t\t\t\t\tif (e.getCause() != null) {\n-\t\t\t\t\t\t\t\te.getCause().printStackTrace();\n-\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tlog.errorf(e, \"Error while invoking insertion to a database table with CMR resource\");\n \t\t\t\t\t\t\tSQLException nextException = e.getNextException();\n \t\t\t\t\t\t\twhile (nextException != null) {\n-\t\t\t\t\t\t\t\tnextException.printStackTrace();\n-\t\t\t\t\t\t\t\tnextException = nextException\n-\t\t\t\t\t\t\t\t\t\t.getNextException();\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\tThrowable[] suppressed = e.getSuppressed();\n-\t\t\t\t\t\t\tfor (int j = 0; j < suppressed.length; j++) {\n-\t\t\t\t\t\t\t\tsuppressed[j].printStackTrace();", "originalCommit": "4a2c7efba988708c4082dca6d67cf523c8b49c89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAzOTIyOQ==", "url": "https://github.com/jbosstm/narayana/pull/1702#discussion_r510039229", "bodyText": "That's done by logger automatically. It prints nicely cause exceptions and the suppressed exceptions without this manual handling. The logger is placed clearly with the level of severity and indentation under the standalone.log (easier to read, easier to understand the cause chain with the suppressed exception printed in the hierarchy).\nThat's all the reasons for these changes.", "author": "ochaloup", "createdAt": "2020-10-22T10:05:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAzNzA4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA0NTM1OQ==", "url": "https://github.com/jbosstm/narayana/pull/1702#discussion_r510045359", "bodyText": "I would prefer that we explicitly fail here (also there are other places where we throw instead of fail). If a test throws an exception I interpret that as meaning that the test needs fixing unless the test is marked as such, eg @test (expected = IllegalStateException.class).", "author": "mmusgrov", "createdAt": "2020-10-22T10:15:47Z", "path": "ArjunaJTA/jta/tests/classes/com/hp/mwtests/ts/jta/commitmarkable/integration/CMRIntegrationTest.java", "diffHunk": "@@ -169,60 +167,40 @@ public void run() {\n \t\t\t\t\t\t\t\t\t.createStatement();\n \t\t\t\t\t\t\tcreateStatement\n \t\t\t\t\t\t\t\t\t.execute(\"INSERT INTO foo (bar) VALUES (1)\");\n-\t\t\t\t\t\t\t// System.out.printf(\"XXX txn close%n\");\n-\n-\t\t\t\t\t\t\tif (faultType == 1)\n-\t\t\t\t\t\t\t\tRuntime.getRuntime().halt(0);\n \n                             userTransaction.commit();\n \t\t\t\t\t\t\tconnection.close(); // This wouldn't work for a\n \t\t\t\t\t\t\t\t\t\t\t\t// none-JCA code as commit has\n \t\t\t\t\t\t\t\t\t\t\t\t// closed the connection - it\n \t\t\t\t\t\t\t\t\t\t\t\t// helps us though as JCA seems\n \t\t\t\t\t\t\t\t\t\t\t\t// to rely on finalize\n-\n-\t\t\t\t\t\t\t// System.out\n-\t\t\t\t\t\t\t// .printf(\"committed txn iteration %d%n\", i);\n \t\t\t\t\t\t\tsuccess++;\n \t\t\t\t\t\t} catch (SQLException e) {\n-\t\t\t\t\t\t\tSystem.err.println(\"boom\");\n-\t\t\t\t\t\t\te.printStackTrace();\n-\t\t\t\t\t\t\tif (e.getCause() != null) {\n-\t\t\t\t\t\t\t\te.getCause().printStackTrace();\n-\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tlog.errorf(e, \"Error while invoking insertion to a database table with CMR resource\");\n \t\t\t\t\t\t\tSQLException nextException = e.getNextException();\n \t\t\t\t\t\t\twhile (nextException != null) {\n-\t\t\t\t\t\t\t\tnextException.printStackTrace();\n-\t\t\t\t\t\t\t\tnextException = nextException\n-\t\t\t\t\t\t\t\t\t\t.getNextException();\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\tThrowable[] suppressed = e.getSuppressed();\n-\t\t\t\t\t\t\tfor (int j = 0; j < suppressed.length; j++) {\n-\t\t\t\t\t\t\t\tsuppressed[j].printStackTrace();\n+\t\t\t\t\t\t\t\tlog.errorf(\"Next SQLException chained\", nextException);\n+\t\t\t\t\t\t\t\tnextException = nextException.getNextException();\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t\ttry {\n \t\t\t\t\t\t\t\tuserTransaction.rollback();\n \t\t\t\t\t\t\t} catch (IllegalStateException | SecurityException\n \t\t\t\t\t\t\t\t\t| SystemException e1) {\n-\t\t\t\t\t\t\t\te1.printStackTrace();\n-\t\t\t\t\t\t\t\tfail(\"Problem with transaction\");\n+\t\t\t\t\t\t\t\tlog.error(\"Problem with transaction\", e1);\n+\t\t\t\t\t\t\t\tthrow new IllegalStateException(\"Problem with transaction\", e1);", "originalCommit": "4a2c7efba988708c4082dca6d67cf523c8b49c89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDExNzI5MA==", "url": "https://github.com/jbosstm/narayana/pull/1702#discussion_r510117290", "bodyText": "Sure. Fixed.", "author": "ochaloup", "createdAt": "2020-10-22T12:24:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA0NTM1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA0NTk3Mg==", "url": "https://github.com/jbosstm/narayana/pull/1702#discussion_r510045972", "bodyText": "This is much more friendly than boom :-)", "author": "mmusgrov", "createdAt": "2020-10-22T10:16:50Z", "path": "ArjunaJTA/jta/tests/classes/com/hp/mwtests/ts/jta/commitmarkable/integration/CMRIntegrationTest.java", "diffHunk": "@@ -169,60 +167,40 @@ public void run() {\n \t\t\t\t\t\t\t\t\t.createStatement();\n \t\t\t\t\t\t\tcreateStatement\n \t\t\t\t\t\t\t\t\t.execute(\"INSERT INTO foo (bar) VALUES (1)\");\n-\t\t\t\t\t\t\t// System.out.printf(\"XXX txn close%n\");\n-\n-\t\t\t\t\t\t\tif (faultType == 1)\n-\t\t\t\t\t\t\t\tRuntime.getRuntime().halt(0);\n \n                             userTransaction.commit();\n \t\t\t\t\t\t\tconnection.close(); // This wouldn't work for a\n \t\t\t\t\t\t\t\t\t\t\t\t// none-JCA code as commit has\n \t\t\t\t\t\t\t\t\t\t\t\t// closed the connection - it\n \t\t\t\t\t\t\t\t\t\t\t\t// helps us though as JCA seems\n \t\t\t\t\t\t\t\t\t\t\t\t// to rely on finalize\n-\n-\t\t\t\t\t\t\t// System.out\n-\t\t\t\t\t\t\t// .printf(\"committed txn iteration %d%n\", i);\n \t\t\t\t\t\t\tsuccess++;\n \t\t\t\t\t\t} catch (SQLException e) {\n-\t\t\t\t\t\t\tSystem.err.println(\"boom\");\n-\t\t\t\t\t\t\te.printStackTrace();\n-\t\t\t\t\t\t\tif (e.getCause() != null) {\n-\t\t\t\t\t\t\t\te.getCause().printStackTrace();\n-\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tlog.errorf(e, \"Error while invoking insertion to a database table with CMR resource\");", "originalCommit": "4a2c7efba988708c4082dca6d67cf523c8b49c89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a5fed4eb3ee7e40e351e0b55a8135add6fae7e94", "url": "https://github.com/jbosstm/narayana/commit/a5fed4eb3ee7e40e351e0b55a8135add6fae7e94", "message": "[JBTM-3376] clean CMRIntegrationTest to be more transparent and get more when fails", "committedDate": "2020-10-22T12:23:30Z", "type": "commit"}, {"oid": "a5fed4eb3ee7e40e351e0b55a8135add6fae7e94", "url": "https://github.com/jbosstm/narayana/commit/a5fed4eb3ee7e40e351e0b55a8135add6fae7e94", "message": "[JBTM-3376] clean CMRIntegrationTest to be more transparent and get more when fails", "committedDate": "2020-10-22T12:23:30Z", "type": "forcePushed"}]}