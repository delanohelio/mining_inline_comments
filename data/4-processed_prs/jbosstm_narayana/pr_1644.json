{"pr_number": 1644, "pr_title": "JBTM-3341 Failed LRA is not kept in FailedTo* state in the object store", "pr_createdAt": "2020-07-02T14:00:45Z", "pr_url": "https://github.com/jbosstm/narayana/pull/1644", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxNjk0NQ==", "url": "https://github.com/jbosstm/narayana/pull/1644#discussion_r449916945", "bodyText": "This code calls into LRAService to convert an id into a transaction and then calls back into lraService with the returned transaction. Why not add a method to LRAService that takes the id (and internally converts it):\npublic boolean remove(URI lra)", "author": "mmusgrov", "createdAt": "2020-07-05T20:45:22Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/api/Coordinator.java", "diffHunk": "@@ -377,7 +377,7 @@ public Response compensateNestedLRA(@PathParam(\"NestedLraId\") String nestedLraId\n     @PUT\n     @Path(\"nested/{NestedLraId}/forget\")\n     public Response forgetNestedLRA(@PathParam(\"NestedLraId\") String nestedLraId) {\n-        lraService.remove(toURI(nestedLraId));\n+        lraService.remove(lraService.getTransaction(toURI(nestedLraId)));", "originalCommit": "53887ad28ab62e763a86033f03caff0c24a32359", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg1MjgyMQ==", "url": "https://github.com/jbosstm/narayana/pull/1644#discussion_r450852821", "bodyText": "I think the LRAService#remove should work directly with lraId and not with Transaction.The remove method should probably use the LRA Transaction instance obtained from the list and not the one that comes in argument\n\nthen this line is currently wrong: https://github.com/jbosstm/narayana/blob/5.10.5.Final/rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/service/LRAService.java#L207", "author": "ochaloup", "createdAt": "2020-07-07T13:12:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxNjk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg2MjQwNg==", "url": "https://github.com/jbosstm/narayana/pull/1644#discussion_r450862406", "bodyText": "the issue is in the other call of the remove method where the recovered transaction object on which we actually call the second phase again and has its state updated accordingly (failedToClose) is not included in the lra list. The LRA taken from the list is in the wrong state.\nProbably the better fix would be to include the Recovery LRA object in the lra list directly but that would need to be replaced on every recovery pass as a new recovery LRA is created and so far we didn't run into this issue so I've decided that this is an easier fix. I would also then change the implementation of the lra list from the list to map as this replace operation would be unnecessary complex otherwise.\nLet me know how would you like to proceed, please.", "author": "xstefank", "createdAt": "2020-07-07T13:26:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxNjk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ2NTQ5Nw==", "url": "https://github.com/jbosstm/narayana/pull/1644#discussion_r451465497", "bodyText": "@xstefank for me to understand better, the code that we discuss is\nif (lra.isFailed()) { // persist failed LRA state\n  lra.deactivate();\n}\n\nwhere the lra is deactivated and this call has to be run on a lra instance, right?\nYou suggest that the passed lra is not part of the Coordinator lras when remove is called from LRAService#finished, correct?\nIf the lra is not included in the lra list (which I assume is meant to be lras) then the code I pasted above won't never be called. Then it won't be a problem.\nProbably. So I understand it in a wrong way. Can you explain me a bit more, please?", "author": "ochaloup", "createdAt": "2020-07-08T11:16:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxNjk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3ODk1MA==", "url": "https://github.com/jbosstm/narayana/pull/1644#discussion_r451478950", "bodyText": "Just keep the existing  lraService.remove method and maybe add a new one that takes a transaction instance. I would advice against refactoring the code at this stage.", "author": "mmusgrov", "createdAt": "2020-07-08T11:43:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxNjk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU0OTU0MQ==", "url": "https://github.com/jbosstm/narayana/pull/1644#discussion_r451549541", "bodyText": "I understand the issue now and I got the point about the lra instance passed to the remove method.\nI was trying to understand the processing and I'm not able to come with a better/nicer way. I assume it's fine to be this way.\nI don't like code duplication thus I do not prefer the ducplication code into lraService.remove method but if it's fine for the rest then ok.", "author": "ochaloup", "createdAt": "2020-07-08T13:36:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxNjk0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg1NjY3OQ==", "url": "https://github.com/jbosstm/narayana/pull/1644#discussion_r450856679", "bodyText": "Thsis is not a request for a change but just a note \"thinking loudly\"\nDo you know why the LRA Transaction instance permits the status to be null?\nI think it could be better to assert that's not null? I can see the code may assign the status to null during recovery. Maybe some future change could adjust it.", "author": "ochaloup", "createdAt": "2020-07-07T13:18:28Z", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/Transaction.java", "diffHunk": "@@ -374,6 +374,10 @@ public boolean isRecovering() {\n                 (status.equals(LRAStatus.Cancelling) || status.equals(LRAStatus.Closing));\n     }\n \n+    public boolean isFailed() {\n+        return status != null &&", "originalCommit": "53887ad28ab62e763a86033f03caff0c24a32359", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3NzU0Mg==", "url": "https://github.com/jbosstm/narayana/pull/1644#discussion_r451477542", "bodyText": "The status cannot be null. We used to use null to indicate that the transaction was active but we have since introduced an explicit state for this (LRAStatus.Active). I didn't mention it in my review since it is unrelated to the PR, I was going to clean up the code in one go in a dedicated PR.", "author": "mmusgrov", "createdAt": "2020-07-08T11:40:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg1NjY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3ODYyNg==", "url": "https://github.com/jbosstm/narayana/pull/1644#discussion_r451478626", "bodyText": "thanks Mike, that will be better.", "author": "xstefank", "createdAt": "2020-07-08T11:42:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg1NjY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ4MTU1OQ==", "url": "https://github.com/jbosstm/narayana/pull/1644#discussion_r451481559", "bodyText": "Where does \"the code assign null to the status\"? It should not do that.\nChecking for status == null is a throwback to when we did not have an LRAStatus.Active state so the null checks are superfluous but I would advice against refactoring in the PR - do it in a separate one that does a general clean up of the code.", "author": "mmusgrov", "createdAt": "2020-07-08T11:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg1NjY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTUyMTU1NA==", "url": "https://github.com/jbosstm/narayana/pull/1644#discussion_r451521554", "bodyText": "@mmusgrov https://github.com/jbosstm/narayana/blob/master/rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/Transaction.java#L272", "author": "ochaloup", "createdAt": "2020-07-08T12:54:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg1NjY3OQ=="}], "type": "inlineReview"}, {"oid": "86ccff27ddf601ba339ec3e27763f5e38a096d6f", "url": "https://github.com/jbosstm/narayana/commit/86ccff27ddf601ba339ec3e27763f5e38a096d6f", "message": "JBTM-3341 Failed LRA is not kept in FailedTo* state in the object store", "committedDate": "2020-07-09T09:00:44Z", "type": "commit"}, {"oid": "86ccff27ddf601ba339ec3e27763f5e38a096d6f", "url": "https://github.com/jbosstm/narayana/commit/86ccff27ddf601ba339ec3e27763f5e38a096d6f", "message": "JBTM-3341 Failed LRA is not kept in FailedTo* state in the object store", "committedDate": "2020-07-09T09:00:44Z", "type": "forcePushed"}]}