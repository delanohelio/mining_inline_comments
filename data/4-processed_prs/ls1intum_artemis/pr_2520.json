{"pr_number": 2520, "pr_title": "[Bugfix] Grading Configuration sum of test case weights 0", "pr_createdAt": "2020-12-08T18:03:22Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/2520", "timeline": [{"oid": "993c378695e9d6b108a89157e1225f2113d37353", "url": "https://github.com/ls1intum/Artemis/commit/993c378695e9d6b108a89157e1225f2113d37353", "message": "throw error when the sum of all test case weights are <= 0", "committedDate": "2020-12-08T12:42:20Z", "type": "commit"}, {"oid": "07a9813c390e90db18e9d55761455faa3eb749c0", "url": "https://github.com/ls1intum/Artemis/commit/07a9813c390e90db18e9d55761455faa3eb749c0", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into bugfix/programming-exercises/grading-configuration", "committedDate": "2020-12-08T17:43:16Z", "type": "commit"}, {"oid": "0a693495218e6246cf0a7321b90869a50de36c7b", "url": "https://github.com/ls1intum/Artemis/commit/0a693495218e6246cf0a7321b90869a50de36c7b", "message": "fix check as it was on the wrong place", "committedDate": "2020-12-08T19:13:44Z", "type": "commit"}, {"oid": "aac10cc8bf69e3142075ad0acd18bf627d129b97", "url": "https://github.com/ls1intum/Artemis/commit/aac10cc8bf69e3142075ad0acd18bf627d129b97", "message": "add check also on client to", "committedDate": "2020-12-08T20:09:44Z", "type": "commit"}, {"oid": "43eb3120d16db784dfae7d627b6cc3f17b74fc08", "url": "https://github.com/ls1intum/Artemis/commit/43eb3120d16db784dfae7d627b6cc3f17b74fc08", "message": "add server test", "committedDate": "2020-12-08T20:26:01Z", "type": "commit"}, {"oid": "a0865e6f99dc264f7369c287184506697ace33c1", "url": "https://github.com/ls1intum/Artemis/commit/a0865e6f99dc264f7369c287184506697ace33c1", "message": "add client test", "committedDate": "2020-12-09T01:33:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkzOTQyNw==", "url": "https://github.com/ls1intum/Artemis/pull/2520#discussion_r538939427", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import { MockAlertService } from '../../helpers/mocks/service/mock-alert.service';", "author": "fde312", "createdAt": "2020-12-09T01:40:21Z", "path": "src/test/javascript/spec/component/programming-exercise/programming-exercise-configure-grading.component.spec.ts", "diffHunk": "@@ -39,6 +39,7 @@ import { MockCookieService } from '../../helpers/mocks/service/mock-cookie.servi\n import { MockProgrammingExerciseService } from '../../helpers/mocks/service/mock-programming-exercise.service';\n import { MockRouter } from '../../helpers/mocks/mock-router';\n import { StaticCodeAnalysisCategory, StaticCodeAnalysisCategoryState } from 'app/entities/static-code-analysis-category.model';\n+import { MockAlertService } from '../../helpers/mocks/service/mock-alert.service';", "originalCommit": "a0865e6f99dc264f7369c287184506697ace33c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "36b5159773f3461bf62dc65a41d79e5b596e119d", "url": "https://github.com/ls1intum/Artemis/commit/36b5159773f3461bf62dc65a41d79e5b596e119d", "message": "Update src/test/javascript/spec/component/programming-exercise/programming-exercise-configure-grading.component.spec.ts", "committedDate": "2020-12-09T01:40:32Z", "type": "commit"}, {"oid": "2161943d20a84122092680b4d6dbfdb930b6bc10", "url": "https://github.com/ls1intum/Artemis/commit/2161943d20a84122092680b4d6dbfdb930b6bc10", "message": "Merge branch 'develop' into bugfix/programming-exercises/grading-configuration", "committedDate": "2020-12-09T12:30:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ0OTg2Ng==", "url": "https://github.com/ls1intum/Artemis/pull/2520#discussion_r539449866", "bodyText": "This can/should simplify to return sumOfWeightNewTestCases > 0;.", "author": "FrankeLukas", "createdAt": "2020-12-09T16:23:04Z", "path": "src/main/webapp/app/exercises/programming/manage/grading/programming-exercise-configure-grading.component.ts", "diffHunk": "@@ -522,4 +534,22 @@ export class ProgrammingExerciseConfigureGradingComponent implements OnInit, OnD\n             )\n             .subscribe();\n     }\n+\n+    public isSumOfWeightsGreaterThanZero(testCaseUpdates: ProgrammingExerciseTestCaseUpdate[]): boolean {\n+        // Copy the existing test cases and update the test cases that were changed\n+        const copyTestCases = cloneDeep(this.testCases);\n+        testCaseUpdates.forEach((testCaseUpdate) => {\n+            const index = copyTestCases.findIndex((testCase) => testCase.id === testCaseUpdate.id);\n+            if (index !== -1) {\n+                copyTestCases[index] = testCaseUpdate;\n+            }\n+        });\n+        // Make sure that the at least one test weight is greater than 0, so that students can still reach a score of 100%\n+        const sumOfWeightNewTestCases = copyTestCases.reduce((sum, testCase) => sum + (testCase.weight ?? 0), 0);\n+        if (sumOfWeightNewTestCases <= 0) {\n+            return false;\n+        } else {\n+            return true;\n+        }", "originalCommit": "2161943d20a84122092680b4d6dbfdb930b6bc10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTczMDI5OQ==", "url": "https://github.com/ls1intum/Artemis/pull/2520#discussion_r539730299", "bodyText": "Done in 16df0615c", "author": "fde312", "createdAt": "2020-12-09T23:39:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ0OTg2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ1NTQ5NQ==", "url": "https://github.com/ls1intum/Artemis/pull/2520#discussion_r539455495", "bodyText": "Not sure how much memory/perf this is taking, but I would guess that doing everything in one loop would save us a bit here (?):\nlet weight = 0;\nthis.testCases.foreach((testCase) => {\n    const index = testCaseUpdates.findIndex((update) => testCase.id === update.id);\n    if (index !== -1) {\n        weight += testCaseUpdates[index].weight ?? 0;\n    } else {\n        weight += testCase.weight ?? 0;\n    }\n});\nreturn weight > 0;\n\n(untested)", "author": "FrankeLukas", "createdAt": "2020-12-09T16:29:44Z", "path": "src/main/webapp/app/exercises/programming/manage/grading/programming-exercise-configure-grading.component.ts", "diffHunk": "@@ -522,4 +534,22 @@ export class ProgrammingExerciseConfigureGradingComponent implements OnInit, OnD\n             )\n             .subscribe();\n     }\n+\n+    public isSumOfWeightsGreaterThanZero(testCaseUpdates: ProgrammingExerciseTestCaseUpdate[]): boolean {\n+        // Copy the existing test cases and update the test cases that were changed\n+        const copyTestCases = cloneDeep(this.testCases);", "originalCommit": "2161943d20a84122092680b4d6dbfdb930b6bc10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTczMDYyNQ==", "url": "https://github.com/ls1intum/Artemis/pull/2520#discussion_r539730625", "bodyText": "Yep, you are right. Your way is cleaner, thanks! :)\nDone in 16df0615c", "author": "fde312", "createdAt": "2020-12-09T23:40:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ1NTQ5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY2NzA2Mg==", "url": "https://github.com/ls1intum/Artemis/pull/2520#discussion_r539667062", "bodyText": "I do not think you need fakeAsync here. I removed both this and the ticks and it still works", "author": "stefanwaldhauser", "createdAt": "2020-12-09T21:38:09Z", "path": "src/test/javascript/spec/component/programming-exercise/programming-exercise-configure-grading.component.spec.ts", "diffHunk": "@@ -362,6 +362,54 @@ describe('ProgrammingExerciseConfigureGradingComponent', () => {\n         flush();\n     }));\n \n+    it('should show error alert when test case weights are less or equal zero', fakeAsync(() => {", "originalCommit": "2161943d20a84122092680b4d6dbfdb930b6bc10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyNDA5Mg==", "url": "https://github.com/ls1intum/Artemis/pull/2520#discussion_r539724092", "bodyText": "Done in 8177c86", "author": "fde312", "createdAt": "2020-12-09T23:25:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY2NzA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY3MTc3MA==", "url": "https://github.com/ls1intum/Artemis/pull/2520#discussion_r539671770", "bodyText": "This and the ticks seems not needed. I removed them and it still works. The component is recreated in the beforeEach already", "author": "stefanwaldhauser", "createdAt": "2020-12-09T21:46:08Z", "path": "src/test/javascript/spec/component/programming-exercise/programming-exercise-configure-grading.component.spec.ts", "diffHunk": "@@ -362,6 +362,54 @@ describe('ProgrammingExerciseConfigureGradingComponent', () => {\n         flush();\n     }));\n \n+    it('should show error alert when test case weights are less or equal zero', fakeAsync(() => {\n+        initGradingComponent({ showInactive: true });\n+\n+        fixture.detectChanges();\n+\n+        const orderedTests = _sortBy(testCases1, 'testName');\n+\n+        const table = debugElement.query(By.css(testCaseTableId));\n+\n+        // get all input fields\n+        const editingInputs = table.queryAll(By.css(tableEditingInput));\n+        expect(editingInputs).to.have.lengthOf(testCases1.length * 3);\n+        // Set only the weight input fields to 0 of all test cases\n+        for (let i = 0; i < editingInputs.length; i += 3) {\n+            const weightInput = editingInputs[i].nativeElement;\n+            expect(weightInput).to.exist;\n+            weightInput.focus();\n+\n+            // Set new weight.\n+            weightInput.value = '0';\n+            weightInput.dispatchEvent(new Event('blur'));\n+        }\n+\n+        fixture.detectChanges();\n+        expect(comp.changedTestCaseIds).to.deep.equal(orderedTests.map((test) => test.id));\n+\n+        // Mock which should be return from update service call\n+        const updateTestCases = orderedTests.map((test) => {\n+            return { ...test, weight: 0, bonusMultiplier: 2, bonusPoints: 1 };\n+        });\n+        // Save weight.\n+        updateTestCasesStub.returns(of(updateTestCases));\n+\n+        // Initialize spy for error alert\n+        const alertService = TestBed.inject(JhiAlertService);\n+        const alertServiceSpy = spy(alertService, 'error');\n+\n+        const saveButton = getSaveButton();\n+        expectElementToBeEnabled(saveButton);\n+        saveButton.click();\n+\n+        expect(alertServiceSpy).to.be.calledOnce;\n+\n+        tick();\n+        fixture.destroy();", "originalCommit": "2161943d20a84122092680b4d6dbfdb930b6bc10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyNDE1Nw==", "url": "https://github.com/ls1intum/Artemis/pull/2520#discussion_r539724157", "bodyText": "Done in 8177c86", "author": "fde312", "createdAt": "2020-12-09T23:25:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY3MTc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY3NzIxNg==", "url": "https://github.com/ls1intum/Artemis/pull/2520#discussion_r539677216", "bodyText": "Will getWeight ever return null? I think this method will fail in this case. I am asking because I think in the client you are testinf if weight is undefined", "author": "stefanwaldhauser", "createdAt": "2020-12-09T21:55:03Z", "path": "src/main/java/de/tum/in/www1/artemis/service/ProgrammingExerciseTestCaseService.java", "diffHunk": "@@ -77,6 +78,13 @@ public ProgrammingExerciseTestCaseService(ProgrammingExerciseTestCaseRepository\n             matchingTestCase.setBonusPoints(programmingExerciseTestCaseDTO.getBonusPoints());\n             updatedTests.add(matchingTestCase);\n         }\n+\n+        // Make sure that at least one test has a weight so that students can still achieve 100% score\n+        var testWeightsSum = existingTestCases.stream().mapToDouble(ProgrammingExerciseTestCase::getWeight).sum();", "originalCommit": "2161943d20a84122092680b4d6dbfdb930b6bc10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyOTc5Ng==", "url": "https://github.com/ls1intum/Artemis/pull/2520#discussion_r539729796", "bodyText": "Done in 2b46a47", "author": "fde312", "createdAt": "2020-12-09T23:38:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY3NzIxNg=="}], "type": "inlineReview"}, {"oid": "3f4cbadbc010fe6bab625bc358bf493311a90140", "url": "https://github.com/ls1intum/Artemis/commit/3f4cbadbc010fe6bab625bc358bf493311a90140", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into bugfix/programming-exercises/grading-configuration", "committedDate": "2020-12-09T22:53:57Z", "type": "commit"}, {"oid": "8177c86a2ee986a85ed7292b3d561cf31612195f", "url": "https://github.com/ls1intum/Artemis/commit/8177c86a2ee986a85ed7292b3d561cf31612195f", "message": "include feedback for client test", "committedDate": "2020-12-09T23:25:21Z", "type": "commit"}, {"oid": "2b46a4701db95d63217508be78c3c679ff6949a9", "url": "https://github.com/ls1intum/Artemis/commit/2b46a4701db95d63217508be78c3c679ff6949a9", "message": "add null check for getWeight", "committedDate": "2020-12-09T23:37:57Z", "type": "commit"}, {"oid": "16df0615c74e14d70ef51deefa16516b63483bd7", "url": "https://github.com/ls1intum/Artemis/commit/16df0615c74e14d70ef51deefa16516b63483bd7", "message": "integrate feedback for weight calculation on client", "committedDate": "2020-12-09T23:39:20Z", "type": "commit"}]}