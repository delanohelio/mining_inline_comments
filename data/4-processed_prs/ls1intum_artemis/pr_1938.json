{"pr_number": 1938, "pr_title": "Do not allow tutors to override their own assessments if there is a complaint", "pr_createdAt": "2020-07-20T06:45:23Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/1938", "timeline": [{"oid": "6d0fc8d8aff21f599451f6e9dff44633231e6211", "url": "https://github.com/ls1intum/Artemis/commit/6d0fc8d8aff21f599451f6e9dff44633231e6211", "message": "do not fetch submissions with results which have complains", "committedDate": "2020-07-20T06:37:42Z", "type": "commit"}, {"oid": "6267e07cc97a5690f21969a3fd59434920467b67", "url": "https://github.com/ls1intum/Artemis/commit/6267e07cc97a5690f21969a3fd59434920467b67", "message": "Remove transactional & refactor getSubmissionsByTutorForExercise\nFor all exercise types to filter out results with complaints\nAlso delete old method from ResultRepository and move to SubmissionRepository", "committedDate": "2020-07-20T09:41:04Z", "type": "commit"}, {"oid": "f42f3a9b5563191442ba729bc08dbc1c96f36563", "url": "https://github.com/ls1intum/Artemis/commit/f42f3a9b5563191442ba729bc08dbc1c96f36563", "message": "Update TextSubmissionService.java\n\nRemove transactional", "committedDate": "2020-07-20T12:11:48Z", "type": "commit"}, {"oid": "cade9313dc0d274c7ddbaf80061e3bb028e8ba81", "url": "https://github.com/ls1intum/Artemis/commit/cade9313dc0d274c7ddbaf80061e3bb028e8ba81", "message": "Merge branch 'develop' into bugfix/hide-your-assessments-with-complains", "committedDate": "2020-07-21T09:42:47Z", "type": "commit"}, {"oid": "4627f979ab655ca9cc39818c62696df9ef1f1f7e", "url": "https://github.com/ls1intum/Artemis/commit/4627f979ab655ca9cc39818c62696df9ef1f1f7e", "message": "Merge branch 'develop' into bugfix/hide-your-assessments-with-complains", "committedDate": "2020-07-21T15:43:43Z", "type": "commit"}, {"oid": "6d04fb73c0c58c363f02cf32a8ec42ca6815f083", "url": "https://github.com/ls1intum/Artemis/commit/6d04fb73c0c58c363f02cf32a8ec42ca6815f083", "message": "allow results with complaints to be listed in the tutor dashboard", "committedDate": "2020-07-21T20:03:35Z", "type": "commit"}, {"oid": "7b5ebe16d5662422d5e97d126895b28466d2b670", "url": "https://github.com/ls1intum/Artemis/commit/7b5ebe16d5662422d5e97d126895b28466d2b670", "message": "Do not allow tutors to override results if there is a complaint for their assessment", "committedDate": "2020-07-21T20:04:06Z", "type": "commit"}, {"oid": "e8185b42d0dce8439fd6fb94915b6552879bb71e", "url": "https://github.com/ls1intum/Artemis/commit/e8185b42d0dce8439fd6fb94915b6552879bb71e", "message": "Merge branch 'develop' into bugfix/hide-your-assessments-with-complains", "committedDate": "2020-07-21T20:08:52Z", "type": "commit"}, {"oid": "1c3f9f23331617fd89d9ef6ae7fcff9b07021271", "url": "https://github.com/ls1intum/Artemis/commit/1c3f9f23331617fd89d9ef6ae7fcff9b07021271", "message": "Lock the input fields in case the user cannot override", "committedDate": "2020-07-21T21:16:04Z", "type": "commit"}, {"oid": "fe06effdc660129afd5f5d4c11e3b48b687b6993", "url": "https://github.com/ls1intum/Artemis/commit/fe06effdc660129afd5f5d4c11e3b48b687b6993", "message": "lock general input elements if readOnly mode", "committedDate": "2020-07-21T21:52:09Z", "type": "commit"}, {"oid": "38995deda9bfb82425774ae6c722916c47217b88", "url": "https://github.com/ls1intum/Artemis/commit/38995deda9bfb82425774ae6c722916c47217b88", "message": "lock input elements for text submissions", "committedDate": "2020-07-21T21:52:41Z", "type": "commit"}, {"oid": "2cfc19753202000dcd4ac549ea644a1e3188b44e", "url": "https://github.com/ls1intum/Artemis/commit/2cfc19753202000dcd4ac549ea644a1e3188b44e", "message": "hide text submissions inputs if read only", "committedDate": "2020-07-21T22:14:12Z", "type": "commit"}, {"oid": "b64d2fc52cd2f8a9688458cd9b84d9f28ffb8bae", "url": "https://github.com/ls1intum/Artemis/commit/b64d2fc52cd2f8a9688458cd9b84d9f28ffb8bae", "message": "do not allow tutor to override modeling submissions if  there is a complaint", "committedDate": "2020-07-21T22:18:05Z", "type": "commit"}, {"oid": "2677d3bd0293640f56860ea0a0d9e0f17d1f1ed7", "url": "https://github.com/ls1intum/Artemis/commit/2677d3bd0293640f56860ea0a0d9e0f17d1f1ed7", "message": "do not allow overriding if assessment has complaint", "committedDate": "2020-07-21T22:23:12Z", "type": "commit"}, {"oid": "40df1b9b6f4e627f7c09694857823ada2b51dbe6", "url": "https://github.com/ls1intum/Artemis/commit/40df1b9b6f4e627f7c09694857823ada2b51dbe6", "message": "Merge branch 'bugfix/hide-your-assessments-with-complains' of github.com:ls1intum/Artemis into bugfix/hide-your-assessments-with-complains", "committedDate": "2020-07-21T22:24:54Z", "type": "commit"}, {"oid": "155e4d9d8cc280f13352259ea55ef2cbdda69664", "url": "https://github.com/ls1intum/Artemis/commit/155e4d9d8cc280f13352259ea55ef2cbdda69664", "message": "decouple canOverride from readonly attributes, as complain evaluationg tutors should not override the result but rather evaluate the complaint. However\nreadonly should only apply for the original tutor, when there is a complaint for his assessment\ncanOverride follows the old rules (instructor | assessment on time | is Assesor) AND it must not have a complaint", "committedDate": "2020-07-22T09:53:27Z", "type": "commit"}, {"oid": "778fb1596b9aac05e62353f8593fa577442f057b", "url": "https://github.com/ls1intum/Artemis/commit/778fb1596b9aac05e62353f8593fa577442f057b", "message": "update edge case header text display", "committedDate": "2020-07-22T09:54:00Z", "type": "commit"}, {"oid": "f654b71e0a8b95ff5a16572268214dbd8c09f50b", "url": "https://github.com/ls1intum/Artemis/commit/f654b71e0a8b95ff5a16572268214dbd8c09f50b", "message": "Let the tutor know if the complaint has already been handled.", "committedDate": "2020-07-22T10:55:09Z", "type": "commit"}, {"oid": "d27751318746750e4523d63b7eb8849e8d5faa6b", "url": "https://github.com/ls1intum/Artemis/commit/d27751318746750e4523d63b7eb8849e8d5faa6b", "message": "It should never be read only for instructors", "committedDate": "2020-07-22T11:10:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MzYxMg==", "url": "https://github.com/ls1intum/Artemis/pull/1938#discussion_r458983612", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // Retrieve all submissions assessed by the tutor and filter out ones which contain complaints", "author": "kloessst", "createdAt": "2020-07-22T18:04:29Z", "path": "src/main/java/de/tum/in/www1/artemis/service/TextSubmissionService.java", "diffHunk": "@@ -238,28 +234,16 @@ public TextSubmission save(TextSubmission textSubmission) {\n      * Given an exercise id and a tutor id, it returns all the text submissions where the tutor has a result associated\n      *\n      * @param exerciseId - the id of the exercise we are looking for\n-     * @param tutorId    - the id of the tutor we are interested in\n+     * @param tutor - the tutor we are interested in\n      * @return a list of text Submissions\n      */\n-    @Transactional(readOnly = true)\n-    public List<TextSubmission> getAllTextSubmissionsByTutorForExercise(Long exerciseId, Long tutorId) {\n-        // We take all the results in this exercise associated to the tutor, and from there we retrieve the submissions\n-        List<Result> results = this.resultRepository.findAllByParticipationExerciseIdAndAssessorId(exerciseId, tutorId);\n-\n-        // TODO: properly load the submissions with all required data from the database without using @Transactional\n-        return results.stream().map(result -> {\n-            Submission submission = result.getSubmission();\n-            TextSubmission textSubmission = new TextSubmission();\n-\n-            result.setSubmission(null);\n-            textSubmission.setLanguage(submission.getLanguage());\n-            textSubmission.setResult(result);\n-            textSubmission.setParticipation(submission.getParticipation());\n-            textSubmission.setId(submission.getId());\n-            textSubmission.setSubmissionDate(submission.getSubmissionDate());\n-\n-            return textSubmission;\n-        }).collect(toList());\n+    public List<TextSubmission> getAllTextSubmissionsAssessedByTutorWithForExercise(Long exerciseId, User tutor) {\n+        // Retrieve all submissions assessed by the tutor and filter out ones which contain complaints", "originalCommit": "d27751318746750e4523d63b7eb8849e8d5faa6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk5NjM0Nw==", "url": "https://github.com/ls1intum/Artemis/pull/1938#discussion_r458996347", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        *ngIf=\"(isAssessor && !hasComplaint) || (isAssessor && isAtLeastInstructor)\"\n          \n          \n            \n                        *ngIf=\"isAssessor && (!hasComplaint || isAtLeastInstructor)\"", "author": "kloessst", "createdAt": "2020-07-22T18:26:50Z", "path": "src/main/webapp/app/assessment/assessment-header/assessment-header.component.html", "diffHunk": "@@ -17,15 +17,39 @@ <h3 class=\"top-container\">\n             Assessment locked by: otherUser\n         </span>\n         <span\n-            *ngIf=\"!isAssessor && isComplaint\"\n+            id=\"assessmentReadOnlyUnhandledComplaint\"\n+            *ngIf=\"isAssessor && !isAtLeastInstructor && hasComplaint && !complaintHandled\"\n+            class=\"ml-3\"\n+            style=\"font-size: 65%;\"\n+            jhiTranslate=\"artemisApp.assessment.assessmentReadOnlyUnhandledComplaint\"\n+        >\n+            There is a complaint for this assessment. Another tutor must respond.\n+        </span>\n+        <span\n+            id=\"assessmentReadOnlyhandled\"\n+            *ngIf=\"isAssessor && !isAtLeastInstructor && hasComplaint && complaintHandled\"\n+            class=\"ml-3\"\n+            style=\"font-size: 65%;\"\n+            jhiTranslate=\"artemisApp.assessment.assessmentReadOnlyHandledComplaint\"\n+        >\n+            The complaint about your assessment has been resolved.\n+        </span>\n+        <span\n+            *ngIf=\"!isAssessor && hasComplaint\"\n             class=\"ml-3\"\n             style=\"font-size: 65%;\"\n             jhiTranslate=\"artemisApp.assessment.assessmentLockedComplaintView\"\n             [translateValues]=\"{ otherUser: result?.assessor?.name + ' (' + result?.assessor?.login + ')' }\"\n         >\n             Original Assessor: otherUser\n         </span>\n-        <span id=\"assessmentLockedCurrentUser\" *ngIf=\"isAssessor\" class=\"text-danger ml-3\" style=\"font-size: 65%;\" jhiTranslate=\"artemisApp.assessment.assessmentLockedCurrentUser\">\n+        <span\n+            id=\"assessmentLockedCurrentUser\"\n+            *ngIf=\"(isAssessor && !hasComplaint) || (isAssessor && isAtLeastInstructor)\"", "originalCommit": "d27751318746750e4523d63b7eb8849e8d5faa6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNjc5Mg==", "url": "https://github.com/ls1intum/Artemis/pull/1938#discussion_r459006792", "bodyText": "Why do we need the else case here? I don't think we should award everyone with 'ROLE_INSTRUCTOR' these rights in this case.", "author": "kloessst", "createdAt": "2020-07-22T18:44:31Z", "path": "src/main/webapp/app/exercises/file-upload/assess/file-upload-assessment.component.ts", "diffHunk": "@@ -428,14 +427,39 @@ export class FileUploadAssessmentComponent implements OnInit, AfterViewInit, OnD\n \n     private checkPermissions() {\n         this.isAssessor = this.result && this.result.assessor && this.result.assessor.id === this.userId;\n+        if (this.exercise) {\n+            this.isAtLeastInstructor = this.accountService.isAtLeastInstructorInCourse(this.exercise.course || this.exercise.exerciseGroup!.exam!.course);\n+        } else {\n+            this.isAtLeastInstructor = this.accountService.hasAnyAuthorityDirect(['ROLE_INSTRUCTOR', 'ROLE_ADMIN']);", "originalCommit": "d27751318746750e4523d63b7eb8849e8d5faa6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwOTMyMQ==", "url": "https://github.com/ls1intum/Artemis/pull/1938#discussion_r459009321", "bodyText": "I also saw this code duplicated somewhere else. Maybe we could create a super class for all exercise type assessment components and define this in there.", "author": "kloessst", "createdAt": "2020-07-22T18:48:44Z", "path": "src/main/webapp/app/exercises/file-upload/assess/file-upload-assessment.component.ts", "diffHunk": "@@ -428,14 +427,39 @@ export class FileUploadAssessmentComponent implements OnInit, AfterViewInit, OnD\n \n     private checkPermissions() {\n         this.isAssessor = this.result && this.result.assessor && this.result.assessor.id === this.userId;\n+        if (this.exercise) {\n+            this.isAtLeastInstructor = this.accountService.isAtLeastInstructorInCourse(this.exercise.course || this.exercise.exerciseGroup!.exam!.course);\n+        } else {\n+            this.isAtLeastInstructor = this.accountService.hasAnyAuthorityDirect(['ROLE_INSTRUCTOR', 'ROLE_ADMIN']);\n+        }\n+    }\n \n-        let isBeforeAssessmentDueDate = true;\n-        // Add check as the assessmentDueDate must not be set for exercises\n-        if (this.exercise.assessmentDueDate) {\n-            isBeforeAssessmentDueDate = this.exercise && this.exercise.assessmentDueDate && moment().isBefore(this.exercise.assessmentDueDate);\n+    /**\n+     * Boolean which determines whether the user can override a result.\n+     * If no exercise is loaded, for example during loading between exercises, we return false.\n+     * Instructors can always override a result.\n+     * Tutors can override their own results within the assessment due date, if there is no complaint about their assessment.\n+     * They cannot override a result anymore, if there is a complaint. Another tutor must handle the complaint.\n+     */\n+    get canOverride(): boolean {", "originalCommit": "d27751318746750e4523d63b7eb8849e8d5faa6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwOTk5OA==", "url": "https://github.com/ls1intum/Artemis/pull/1938#discussion_r459009998", "bodyText": "This appears multiple times. Would be better if this is defined in one place.", "author": "kloessst", "createdAt": "2020-07-22T18:49:49Z", "path": "src/main/webapp/app/exercises/file-upload/assess/file-upload-assessment.component.ts", "diffHunk": "@@ -495,6 +519,10 @@ export class FileUploadAssessmentComponent implements OnInit, AfterViewInit, OnD\n         this.referencedFeedback = feedbacks;\n     }\n \n+    get readOnly(): boolean {\n+        return !this.isAtLeastInstructor && !!this.complaint && this.isAssessor;", "originalCommit": "d27751318746750e4523d63b7eb8849e8d5faa6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxNzkzMA==", "url": "https://github.com/ls1intum/Artemis/pull/1938#discussion_r459017930", "bodyText": "There are three assessment components which have very similar code. However, refactoring them to create an assessment superclass would require a deep intrusion into the code which I feel should be done in a separate PR. This change should also include adapting the manual assessment review of programming exercises to follow the same procedure as the other exercises types. However, this is all out of scope of this PR, and we should probably do this after the exams are over.", "author": "anditurdiu", "createdAt": "2020-07-22T19:03:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwOTk5OA=="}], "type": "inlineReview"}, {"oid": "9d20a23ac3ecede18952073de959cdbeab60d6e5", "url": "https://github.com/ls1intum/Artemis/commit/9d20a23ac3ecede18952073de959cdbeab60d6e5", "message": "implement code review suggestions", "committedDate": "2020-07-22T19:39:09Z", "type": "commit"}]}