{"pr_number": 2531, "pr_title": "Improve Jenkins setup docu", "pr_createdAt": "2020-12-11T08:34:08Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/2531", "timeline": [{"oid": "52028177b3323d8b56b3693201f5d274d3ba0bf2", "url": "https://github.com/ls1intum/Artemis/commit/52028177b3323d8b56b3693201f5d274d3ba0bf2", "message": "Start with adjustment of documentation.", "committedDate": "2020-11-20T09:57:19Z", "type": "commit"}, {"oid": "a8a1f9131a06bb2a35216153fe27c58d45979904", "url": "https://github.com/ls1intum/Artemis/commit/a8a1f9131a06bb2a35216153fe27c58d45979904", "message": "Merge branch 'develop' into docu/jenkins-pipeline", "committedDate": "2020-12-08T17:08:48Z", "type": "commit"}, {"oid": "77bd9d73845a24499d74eea803012314701ecd4c", "url": "https://github.com/ls1intum/Artemis/commit/77bd9d73845a24499d74eea803012314701ecd4c", "message": "Add documentation regarding caching and local agents.", "committedDate": "2020-12-08T19:01:06Z", "type": "commit"}, {"oid": "d43c65bf81d292644c700948541a5515a6de0ff8", "url": "https://github.com/ls1intum/Artemis/commit/d43c65bf81d292644c700948541a5515a6de0ff8", "message": "Make dind optional.", "committedDate": "2020-12-11T08:32:09Z", "type": "commit"}, {"oid": "91a2795f634f854487214781fc81628f551ab1a7", "url": "https://github.com/ls1intum/Artemis/commit/91a2795f634f854487214781fc81628f551ab1a7", "message": "Add 'e.g.'", "committedDate": "2020-12-11T08:38:25Z", "type": "commit"}, {"oid": "2427e4a699f18aa6a521322611fcdec6f6b78a19", "url": "https://github.com/ls1intum/Artemis/commit/2427e4a699f18aa6a521322611fcdec6f6b78a19", "message": "Merge branch 'develop' into docu/jenkins-pipeline", "committedDate": "2020-12-11T08:44:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkzODIwMw==", "url": "https://github.com/ls1intum/Artemis/pull/2531#discussion_r540938203", "bodyText": "Can you please add a reason why this is necessary. I guess the main reason is to speed up build times...", "author": "krusche", "createdAt": "2020-12-11T13:14:38Z", "path": "docs/dev/setup/programming-exercises.rst", "diffHunk": "@@ -60,3 +60,30 @@ Note that the ``Jenkinsfile`` **must** start either\n The variables `#dockerImage`, `#testRepository`, `#assignmentRepository`, `#jenkinsNotificationToken` and `#notificationsUrl` will automatically be replaced (for the normal Jenkinsfile, within the Jenkinsfile-staticCodeAnalysis, #staticCodeAnalysisScript is also replaced).\n \n You should not need to touch any of these variables, except the `#dockerImage` variable, if you want to use a different agent setup (e.g. a Kubernetes setup).\n+\n+\n+Caching example for Maven\n+^^^^^^^^^^^^^^^^^^^^^^^^^\n+Adjust the agent-args and add the environment block.", "originalCommit": "2427e4a699f18aa6a521322611fcdec6f6b78a19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTY2NzU2Mw==", "url": "https://github.com/ls1intum/Artemis/pull/2531#discussion_r541667563", "bodyText": "Yes. It significantly speeds up build. Sady the dependencies cached in the docker image are frequently out of date. So we do the caching like that", "author": "1-alex98", "createdAt": "2020-12-12T16:59:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkzODIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTY3NDM4NQ==", "url": "https://github.com/ls1intum/Artemis/pull/2531#discussion_r541674385", "bodyText": "I've added an explanation.", "author": "sleiss", "createdAt": "2020-12-12T17:13:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkzODIwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkzODQxMw==", "url": "https://github.com/ls1intum/Artemis/pull/2531#discussion_r540938413", "bodyText": "you can reference artemis-java-testing-sandbox here, which can circumvent those issues", "author": "krusche", "createdAt": "2020-12-11T13:14:59Z", "path": "docs/dev/setup/programming-exercises.rst", "diffHunk": "@@ -60,3 +60,30 @@ Note that the ``Jenkinsfile`` **must** start either\n The variables `#dockerImage`, `#testRepository`, `#assignmentRepository`, `#jenkinsNotificationToken` and `#notificationsUrl` will automatically be replaced (for the normal Jenkinsfile, within the Jenkinsfile-staticCodeAnalysis, #staticCodeAnalysisScript is also replaced).\n \n You should not need to touch any of these variables, except the `#dockerImage` variable, if you want to use a different agent setup (e.g. a Kubernetes setup).\n+\n+\n+Caching example for Maven\n+^^^^^^^^^^^^^^^^^^^^^^^^^\n+Adjust the agent-args and add the environment block.\n+\n+\n+.. code:: bash\n+\n+        agent {\n+            docker {\n+                image '#dockerImage'\n+                label 'docker'\n+                args '-v $HOME/maven-cache-docker:/var/maven'\n+            }\n+        }\n+        environment {\n+          JAVA_TOOL_OPTIONS = '-Duser.home=/var/maven'\n+        }\n+        stages {\n+            stage('Checkout') {\n+\n+\n+\n+You have to add permissions to the folder (which will be located at the $HOME folder of the user that jenkins uses), e.g. with ``sudo chmod 777 maven-cache-docker -R``.\n+\n+Note that this might allow students to access shared resources (e.g. jars used by Maven), and they might be able to overwrite them.", "originalCommit": "2427e4a699f18aa6a521322611fcdec6f6b78a19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTY3NDU1OQ==", "url": "https://github.com/ls1intum/Artemis/pull/2531#discussion_r541674559", "bodyText": "I've added it.", "author": "sleiss", "createdAt": "2020-12-12T17:13:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkzODQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkzODg1MA==", "url": "https://github.com/ls1intum/Artemis/pull/2531#discussion_r540938850", "bodyText": "add a new line to fix the GitHub action warning", "author": "krusche", "createdAt": "2020-12-11T13:15:47Z", "path": "docs/dev/setup/jenkins-gitlab.rst", "diffHunk": "@@ -418,42 +405,12 @@ Start Jenkins\n            continuous-integration:\n                user: your.chosen.username\n                password: your.chosen.password\n-\n-12. Setup JDK 15 in Jenkins Settings\n-\n-    Navigate in your browser into Jenkins \u2192 Manage Jenkins \u2192 Global Tool\n-    Configuration \u2192 JDK. Change the existing JDK installation or click\n-    on Add JDK.\n-\n-    Use ``OpenJDK 15`` as Name and\n-    ``/usr/lib/jvm/java-15-openjdk-amd64`` as JAVA_HOME\n-\n-   .. figure:: jenkins-gitlab/jenkins_jdk_config.png\n-      :align: center\n-\n Required Jenkins Plugins", "originalCommit": "2427e4a699f18aa6a521322611fcdec6f6b78a19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTY3NDQ2OQ==", "url": "https://github.com/ls1intum/Artemis/pull/2531#discussion_r541674469", "bodyText": "Fixed", "author": "sleiss", "createdAt": "2020-12-12T17:13:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkzODg1MA=="}], "type": "inlineReview"}, {"oid": "1204b782a7cc9b3e953f74ce5affe667172f5152", "url": "https://github.com/ls1intum/Artemis/commit/1204b782a7cc9b3e953f74ce5affe667172f5152", "message": "Merge branch 'develop' into docu/jenkins-pipeline", "committedDate": "2020-12-11T13:48:09Z", "type": "commit"}, {"oid": "af8739d6e7e7b703e69b7c3b49c4df2fac96574f", "url": "https://github.com/ls1intum/Artemis/commit/af8739d6e7e7b703e69b7c3b49c4df2fac96574f", "message": "small improvements\n\nwork in progress due to a TODO in the section with use-crumb", "committedDate": "2020-12-11T13:50:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTExMTIwNA==", "url": "https://github.com/ls1intum/Artemis/pull/2531#discussion_r541111204", "bodyText": "It seems that disabling CSRF in Jenkins is no longer necessary. In Artemis support for it is enabled by default https://github.com/ls1intum/Artemis/blob/develop/src/main/resources/config/application-jenkins.yml and we are running a setup with it enabled without problems.", "author": "b-fein", "createdAt": "2020-12-11T17:32:37Z", "path": "docs/dev/setup/jenkins-gitlab.rst", "diffHunk": "@@ -658,10 +631,29 @@ the following steps:\n     Cross Site Request Forgery exploits\u201d. Also disable the option\n     ``use-crumb`` in ``application-jenkins.yml``.\n \n+    TODO: this seems to be outdated: Only ``Enable proxy compatibility`` is available\n+\n     Depending on the version this setting might not be available anymore.\n     Have a look `here <https://unix.stackexchange.com/questions/444177/how-to-disable-the-csrf-protection-in-jenkins-by-default>`__ on how you can disable CSRF protection.", "originalCommit": "af8739d6e7e7b703e69b7c3b49c4df2fac96574f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTY3NTA4NA==", "url": "https://github.com/ls1intum/Artemis/pull/2531#discussion_r541675084", "bodyText": "@krusche Were you able to set it up locally without disabling this setting as you tried it yesterday?\nIf so, I would suggest removing this section.", "author": "sleiss", "createdAt": "2020-12-12T17:14:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTExMTIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEyNTU4MQ==", "url": "https://github.com/ls1intum/Artemis/pull/2531#discussion_r544125581", "bodyText": "I did not fully finish the setup locally, so I can't say it. Would be great if someone can try it out again. I think the issue with crumb being active occurs, when the URLs and the http scheme are not always the same, so this could still be an issue", "author": "krusche", "createdAt": "2020-12-16T09:02:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTExMTIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEyNjA4MQ==", "url": "https://github.com/ls1intum/Artemis/pull/2531#discussion_r544126081", "bodyText": "This is no issue when you have certificates and \"official\" domains, but it rather can be an issue in the local setup with localhost or docker specific urls", "author": "krusche", "createdAt": "2020-12-16T09:03:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTExMTIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDE5NTI4OA==", "url": "https://github.com/ls1intum/Artemis/pull/2531#discussion_r544195288", "bodyText": "I seem to have missed the line above earlier where it states this is only for local setups. It\u2019s just above where Github cuts off the diff.\nI agree it might cause problems in some local docker setups. (I think it works in some cases, though, as I don\u2019t think I\u2019ve disabled CSRF in mine.) With this disclaimer that disabling CSRF should only be done for local setups and not in production this section should definitely stay.", "author": "b-fein", "createdAt": "2020-12-16T10:45:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTExMTIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY5ODE1NQ==", "url": "https://github.com/ls1intum/Artemis/pull/2531#discussion_r545698155", "bodyText": "I have the Jenkins/Gitlab set up on two machines and never got CSRF to work. I updated the docs (where the TODO is) so that they include steps on how to disable that locally.", "author": "ivanchimeno", "createdAt": "2020-12-18T09:19:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTExMTIwNA=="}], "type": "inlineReview"}, {"oid": "203992e1ae3241c06f67fc6cbb309cfd4ffc17ae", "url": "https://github.com/ls1intum/Artemis/commit/203992e1ae3241c06f67fc6cbb309cfd4ffc17ae", "message": "Add details about caching, fix minor issues.", "committedDate": "2020-12-12T17:12:16Z", "type": "commit"}, {"oid": "206b8208dd300c861ac9ca2bea6f3a518fed31e0", "url": "https://github.com/ls1intum/Artemis/commit/206b8208dd300c861ac9ca2bea6f3a518fed31e0", "message": "Merge branch 'docu/jenkins-pipeline' of github.com:ls1intum/ArTEMiS into docu/jenkins-pipeline", "committedDate": "2020-12-12T17:12:50Z", "type": "commit"}, {"oid": "a57896541c51c759f0d1f330fce2b4cbdb370142", "url": "https://github.com/ls1intum/Artemis/commit/a57896541c51c759f0d1f330fce2b4cbdb370142", "message": "Merge branch 'develop' into docu/jenkins-pipeline", "committedDate": "2020-12-17T11:19:02Z", "type": "commit"}, {"oid": "23be766354e885c90826ccab7e590c0f979bf884", "url": "https://github.com/ls1intum/Artemis/commit/23be766354e885c90826ccab7e590c0f979bf884", "message": "update jenkins docs to include how to disable csrf on a local environment", "committedDate": "2020-12-18T09:16:48Z", "type": "commit"}, {"oid": "be5358ada95d506f073220b96e17aaab8e96187b", "url": "https://github.com/ls1intum/Artemis/commit/be5358ada95d506f073220b96e17aaab8e96187b", "message": "use unique ports for Artemis 8080, Gitlab 8081 and Jenkins 8082", "committedDate": "2020-12-19T07:32:07Z", "type": "commit"}, {"oid": "6a51e823f0827849b571dc21c95d6aaf496a9879", "url": "https://github.com/ls1intum/Artemis/commit/6a51e823f0827849b571dc21c95d6aaf496a9879", "message": "Merge branch 'develop' into docu/jenkins-pipeline", "committedDate": "2020-12-19T07:32:38Z", "type": "commit"}]}