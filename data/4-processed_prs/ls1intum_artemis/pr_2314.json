{"pr_number": 2314, "pr_title": "[Feature] Stash unsubmitted changes after due date has passed", "pr_createdAt": "2020-11-02T22:11:59Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/2314", "timeline": [{"oid": "1905c79ed85569552911db3efc68d14a58864575", "url": "https://github.com/ls1intum/Artemis/commit/1905c79ed85569552911db3efc68d14a58864575", "message": "stash also unsubmitted changes when the repo is locked", "committedDate": "2020-11-02T21:13:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk4Mjg0MA==", "url": "https://github.com/ls1intum/Artemis/pull/2314#discussion_r516982840", "bodyText": "Reformulate / adjust reporting logic to notify only about operations that failed (not always both).", "author": "MaisiKoleni", "createdAt": "2020-11-03T22:05:33Z", "path": "src/main/java/de/tum/in/www1/artemis/service/scheduled/ProgrammingExerciseScheduleService.java", "diffHunk": "@@ -227,20 +227,25 @@ private Runnable lockStudentRepositories(ProgrammingExercise exercise, Predicate\n             SecurityUtils.setAuthorizationObject();\n             try {\n                 List<ProgrammingExerciseStudentParticipation> failedLockOperations = removeWritePermissionsFromAllStudentRepositories(programmingExerciseId, condition);\n+                // Stash also the not submitted/committed changes, to ensure that only submitted/commited changes are displayed\n+                List<ProgrammingExerciseStudentParticipation> failedStashOperations = stashChangesInAllStudentRepositories(programmingExerciseId, condition);\n \n-                // We sent a notification to the instructor about the success of the repository locking operation.\n+                // We sent a notification to the instructor about the success of the repository locking and stashing operations.\n                 long numberOfFailedLockOperations = failedLockOperations.size();\n+                long numberOfFailedStashOperations = failedStashOperations.size();\n                 Optional<ProgrammingExercise> programmingExercise = programmingExerciseRepository.findWithTemplateParticipationAndSolutionParticipationById(programmingExerciseId);\n                 if (programmingExercise.isEmpty()) {\n                     throw new EntityNotFoundException(\"programming exercise not found with id \" + programmingExerciseId);\n                 }\n-                if (numberOfFailedLockOperations > 0) {\n+                if (numberOfFailedLockOperations > 0 || numberOfFailedStashOperations > 0) {\n                     groupNotificationService.notifyInstructorGroupAboutExerciseUpdate(programmingExercise.get(),\n-                            Constants.PROGRAMMING_EXERCISE_FAILED_LOCK_OPERATIONS_NOTIFICATION + failedLockOperations.size());\n+                            Constants.PROGRAMMING_EXERCISE_FAILED_LOCK_OPERATIONS_NOTIFICATION + numberOfFailedLockOperations\n+                                    + \". Furthermore, When stashing the not submitted changes, not all stash operations were successfull. Number of failed stash operations: \"\n+                                    + numberOfFailedStashOperations);", "originalCommit": "1905c79ed85569552911db3efc68d14a58864575", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "db6a3e75483e0ee2466d7ead3f8d92b50ab86bb3", "url": "https://github.com/ls1intum/Artemis/commit/db6a3e75483e0ee2466d7ead3f8d92b50ab86bb3", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into bugfix/programming-exercises/stash-unsubmitted-changes", "committedDate": "2020-11-04T01:16:04Z", "type": "commit"}, {"oid": "fbdeea95647e5d16893abe86dea8969ba07db64d", "url": "https://github.com/ls1intum/Artemis/commit/fbdeea95647e5d16893abe86dea8969ba07db64d", "message": "add test for stashing changes", "committedDate": "2020-11-04T15:55:18Z", "type": "commit"}, {"oid": "da5cdca0f0e8b3b5dbf19ed77a1460e61b488894", "url": "https://github.com/ls1intum/Artemis/commit/da5cdca0f0e8b3b5dbf19ed77a1460e61b488894", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into bugfix/programming-exercises/stash-unsubmitted-changes", "committedDate": "2020-11-04T17:44:37Z", "type": "commit"}, {"oid": "bdae02bb4ffa071b1e61392308860afca1402285", "url": "https://github.com/ls1intum/Artemis/commit/bdae02bb4ffa071b1e61392308860afca1402285", "message": "add more tests", "committedDate": "2020-11-04T17:45:07Z", "type": "commit"}, {"oid": "2527d3c4e6a86e2f43ae7ecf82aa89c36fd06122", "url": "https://github.com/ls1intum/Artemis/commit/2527d3c4e6a86e2f43ae7ecf82aa89c36fd06122", "message": "structure test and improve coverage for new method", "committedDate": "2020-11-04T22:35:56Z", "type": "commit"}, {"oid": "eae8e1243d0426111c486abe2ac357fd1400a048", "url": "https://github.com/ls1intum/Artemis/commit/eae8e1243d0426111c486abe2ac357fd1400a048", "message": "improve test coverage", "committedDate": "2020-11-05T01:31:29Z", "type": "commit"}, {"oid": "5b7b048ec6b560742da0f4e52bf53d8cda789474", "url": "https://github.com/ls1intum/Artemis/commit/5b7b048ec6b560742da0f4e52bf53d8cda789474", "message": "incorporate feedback and make codacy happy", "committedDate": "2020-11-05T02:18:41Z", "type": "commit"}, {"oid": "eea5d1b0047b4c81d950dfc22cfcc20cc7441abc", "url": "https://github.com/ls1intum/Artemis/commit/eea5d1b0047b4c81d950dfc22cfcc20cc7441abc", "message": "Update RepositoryProgrammingExerciseParticipationResourceIntegrationTest.java", "committedDate": "2020-11-05T02:49:11Z", "type": "commit"}, {"oid": "b662912e6ffedea172859422e16597e3b94a23e9", "url": "https://github.com/ls1intum/Artemis/commit/b662912e6ffedea172859422e16597e3b94a23e9", "message": "increase coverage", "committedDate": "2020-11-05T05:59:22Z", "type": "commit"}, {"oid": "91f2f794a31e283f67d9a52526e327e6e0a01bc8", "url": "https://github.com/ls1intum/Artemis/commit/91f2f794a31e283f67d9a52526e327e6e0a01bc8", "message": "Merge branch 'bugfix/programming-exercises/stash-unsubmitted-changes' of https://github.com/ls1intum/Artemis into bugfix/programming-exercises/stash-unsubmitted-changes", "committedDate": "2020-11-05T05:59:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI0NDMyMw==", "url": "https://github.com/ls1intum/Artemis/pull/2314#discussion_r518244323", "bodyText": "git.close();  won't close the repo with the new Git(repo). I think for linux this is fine but for Windows this could introduce some problems. If you don't need to repo anymore, make sure to close it correctly. You could use the constructor new Git(repo, true) to force a close of the repo if you close the git instance.", "author": "kloessst", "createdAt": "2020-11-05T17:48:33Z", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/GitService.java", "diffHunk": "@@ -705,4 +705,16 @@ public boolean repositoryAlreadyExists(URL repoUrl) {\n         Path localPath = new java.io.File(REPO_CLONE_PATH + folderNameForRepositoryUrl(repoUrl)).toPath();\n         return Files.exists(localPath);\n     }\n+\n+    /**\n+     * Stashes not submitted/committed changes of the repo.\n+     *\n+     * @param repo student repo of a participation in a programming exercise\n+     * @throws GitAPIException\n+     */\n+    public void stashChanges(Repository repo) throws GitAPIException {\n+        Git git = new Git(repo);\n+        git.stashCreate().call();\n+        git.close();", "originalCommit": "91f2f794a31e283f67d9a52526e327e6e0a01bc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2NTk0Ng==", "url": "https://github.com/ls1intum/Artemis/pull/2314#discussion_r518265946", "bodyText": "Nevermind the Git(repo, closeRepo) constructor is package private and can't be used. We would need to use Git.open(File dir, FS fs) the get a Git instance which closes the repo. As we do caching of repos closing might not be necessary.", "author": "kloessst", "createdAt": "2020-11-05T18:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI0NDMyMw=="}], "type": "inlineReview"}]}