{"pr_number": 2480, "pr_title": "[Bugfix] Import a prog. exercise by cloning instead of forking", "pr_createdAt": "2020-11-30T11:59:06Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/2480", "timeline": [{"oid": "fcee8b27406eb026e76fd3028b9ae064198b0418", "url": "https://github.com/ls1intum/Artemis/commit/fcee8b27406eb026e76fd3028b9ae064198b0418", "message": "rename copy to fork repository", "committedDate": "2020-11-27T14:01:49Z", "type": "commit"}, {"oid": "ce74848ca38e048bf4c60f358c8b577399482617", "url": "https://github.com/ls1intum/Artemis/commit/ce74848ca38e048bf4c60f358c8b577399482617", "message": "fix source url", "committedDate": "2020-11-27T16:00:24Z", "type": "commit"}, {"oid": "a6899ec22d81902b749f3e3cce134b0266d33e35", "url": "https://github.com/ls1intum/Artemis/commit/a6899ec22d81902b749f3e3cce134b0266d33e35", "message": "forgot to call() git", "committedDate": "2020-11-27T16:20:45Z", "type": "commit"}, {"oid": "fd77faa0c843fe95c4ccc38657c828746aec0897", "url": "https://github.com/ls1intum/Artemis/commit/fd77faa0c843fe95c4ccc38657c828746aec0897", "message": "refactoring", "committedDate": "2020-11-30T08:24:35Z", "type": "commit"}, {"oid": "55a7073a4f5a3db86caf0574476edf909a2f5864", "url": "https://github.com/ls1intum/Artemis/commit/55a7073a4f5a3db86caf0574476edf909a2f5864", "message": "Merge branch 'develop' into bugfix/change-forking-to-cloning", "committedDate": "2020-11-30T08:27:38Z", "type": "commit"}, {"oid": "d0ced3c984e367f9c236e175c2fb4afe5788245d", "url": "https://github.com/ls1intum/Artemis/commit/d0ced3c984e367f9c236e175c2fb4afe5788245d", "message": "fix testcase for import", "committedDate": "2020-11-30T11:19:57Z", "type": "commit"}, {"oid": "2e68a99bd849d7766d3f24333505282f694b73ad", "url": "https://github.com/ls1intum/Artemis/commit/2e68a99bd849d7766d3f24333505282f694b73ad", "message": "rename mockCopy... to mockFork...", "committedDate": "2020-11-30T11:26:41Z", "type": "commit"}, {"oid": "5e5487a156bb3d5c1b1529fb4e845017e07299f3", "url": "https://github.com/ls1intum/Artemis/commit/5e5487a156bb3d5c1b1529fb4e845017e07299f3", "message": "setup repo mocks", "committedDate": "2020-11-30T11:45:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk0NTk1NQ==", "url": "https://github.com/ls1intum/Artemis/pull/2480#discussion_r532945955", "bodyText": "what happens in the following scenario (which happens rather often)?\n\nAn instructor works in the online code editor in the source template repository, commits&pushes changes.\nThe instructor also works offline in his IDE and commits&pushes changes\nThere is a merge conflict in the template repository on the Artemis server\nSometimes later, the instructor imports the exercise.\n\nI would assume that getOrCheckoutRepository(...) will reuse the existing repository (which is in a conflict state), and will try to pull the latest changes, which will fail. Then the whole import would fail.\nI think we should avoid this issue. I see the following easy fix: Instead of reusing the existing repository with getOrCheckoutRepository(url, boolean), we should rather clone the repository from Bitbucket again into a new folder (this is e.g. also done when we export git repos) using the method getOrCheckoutRepository(URL repoUrl, boolean pullOnGet, String targetPath). The targetPath could e.g. be REPO_CLONE_PATH", "author": "krusche", "createdAt": "2020-11-30T22:30:44Z", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/bitbucket/BitbucketService.java", "diffHunk": "@@ -265,6 +270,29 @@ public VcsRepositoryUrl copyRepository(String sourceProjectKey, String sourceRep\n         throw new BitbucketException(\"Max retries for forking reached. Could not fork repository \" + sourceRepositoryName + \" to \" + targetRepositoryName);\n     }\n \n+    @Override\n+    public VcsRepositoryUrl copyRepository(String sourceProjectKey, String sourceRepositoryName, String targetProjectKey, String targetRepositoryName) {\n+        final var targetRepoSlug = targetProjectKey.toLowerCase() + \"-\" + targetRepositoryName.toLowerCase();\n+        try {\n+            var sourceRepoUrl = getCloneRepositoryUrl(sourceProjectKey, sourceRepositoryName.toLowerCase());\n+            URL sourceRepositoryUrlAsUrl = new URL(sourceRepoUrl.toString());\n+            // checkout the source repo\n+            Repository sourceRepo = gitService.getOrCheckoutRepository(sourceRepositoryUrlAsUrl, true);", "originalCommit": "5e5487a156bb3d5c1b1529fb4e845017e07299f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk0NjUzMA==", "url": "https://github.com/ls1intum/Artemis/pull/2480#discussion_r532946530", "bodyText": "In this case, we should also delete the newly cloned repository after it has been copied successfully.", "author": "krusche", "createdAt": "2020-11-30T22:32:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk0NTk1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEzNzkxNg==", "url": "https://github.com/ls1intum/Artemis/pull/2480#discussion_r533137916", "bodyText": "But won't the repository directly from Bitbucket be also in a conflict state unless the merge conflict was fixed?\nAnd in case the merge conflict was solved, is the repo on Artemis still broken? This would mean that (independent from importing) the source template repo on Artemis would not work, right?", "author": "derLalla", "createdAt": "2020-12-01T08:02:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk0NTk1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY0MzM0Mw==", "url": "https://github.com/ls1intum/Artemis/pull/2480#discussion_r533643343", "bodyText": "resolved in the latest commit", "author": "derLalla", "createdAt": "2020-12-01T18:49:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk0NTk1NQ=="}], "type": "inlineReview"}, {"oid": "e97d40dc4ae3f17af0d7aa447b24239cef353047", "url": "https://github.com/ls1intum/Artemis/commit/e97d40dc4ae3f17af0d7aa447b24239cef353047", "message": "Merge branch 'develop' into bugfix/change-forking-to-cloning", "committedDate": "2020-12-01T12:47:03Z", "type": "commit"}, {"oid": "3ae74c2a08a26859d4de8a66add06da574172749", "url": "https://github.com/ls1intum/Artemis/commit/3ae74c2a08a26859d4de8a66add06da574172749", "message": "clone source repo to different location", "committedDate": "2020-12-01T13:22:34Z", "type": "commit"}, {"oid": "6f9e3bda776a08ccbdf6e1fdc90d79255780df58", "url": "https://github.com/ls1intum/Artemis/commit/6f9e3bda776a08ccbdf6e1fdc90d79255780df58", "message": "revert to test old behaviour", "committedDate": "2020-12-01T14:46:08Z", "type": "commit"}, {"oid": "c75faa35ec70668764fc23f5a4d448fe06af7ae1", "url": "https://github.com/ls1intum/Artemis/commit/c75faa35ec70668764fc23f5a4d448fe06af7ae1", "message": "revert back to fix", "committedDate": "2020-12-01T15:11:03Z", "type": "commit"}]}