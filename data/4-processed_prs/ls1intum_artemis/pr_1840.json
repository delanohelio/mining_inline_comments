{"pr_number": 1840, "pr_title": "Bugfix for LTI oauth and tasks/plantUmls in multiple programming exercises in exams", "pr_createdAt": "2020-07-08T23:09:48Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/1840", "timeline": [{"oid": "5c699b5fdc79d0dd308471d45dd912a49ec20d20", "url": "https://github.com/ls1intum/Artemis/commit/5c699b5fdc79d0dd308471d45dd912a49ec20d20", "message": "remove duplicated account call in system-notification.component.ts\n\nthis hopefully also solves the issue with the lti oauth authentication", "committedDate": "2020-07-08T21:21:54Z", "type": "commit"}, {"oid": "ff84baa89232b21e5613a9c2b833f80d500f00ab", "url": "https://github.com/ls1intum/Artemis/commit/ff84baa89232b21e5613a9c2b833f80d500f00ab", "message": "update markdown when activating online code editor in exams", "committedDate": "2020-07-08T22:09:46Z", "type": "commit"}, {"oid": "30aa69c6263f519010a29bf7a872dea93a86d9a3", "url": "https://github.com/ls1intum/Artemis/commit/30aa69c6263f519010a29bf7a872dea93a86d9a3", "message": "fix bug that tasks and plantUmls are not correctly reloaded in exams when switching between multiple programming exercises in the online code editor", "committedDate": "2020-07-08T22:47:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2MzgzNA==", "url": "https://github.com/ls1intum/Artemis/pull/1840#discussion_r451963834", "bodyText": "Good fix!", "author": "thilo-behnke", "createdAt": "2020-07-09T04:57:18Z", "path": "src/main/webapp/app/exercises/programming/shared/instructions-render/extensions/programming-exercise-plant-uml.extension.ts", "diffHunk": "@@ -14,6 +14,8 @@ export class ProgrammingExercisePlantUmlExtensionWrapper implements ArtemisShowd\n     private latestResult: Result | null = null;\n     private injectableElementsFoundSubject = new Subject<() => void>();\n \n+    // unique index, even if multiple plant uml diagrams are shown from different problem statements on the same page (in different tabs)\n+    private plantUmlIndex = 0;", "originalCommit": "30aa69c6263f519010a29bf7a872dea93a86d9a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2NzYxNw==", "url": "https://github.com/ls1intum/Artemis/pull/1840#discussion_r451967617", "bodyText": "I think this is the correct approach to fixing the issue, however I'm not sure the implementation is bulletproof:\nthis.loadAndInjectPlantUml(plantUml, this.plantUmlIndex - plantUmlsValidated.length + index + 1\nAs far as I see it, this.plantUmlIndex - plantUmlsValidated.length will lead to the wrong id range start for e.g. the first exercise in the exam:\nE.g. exercise 1 has 5 umls, exercise 2 has 3.\nFor exercise 1:\nthis.plantUmlIndex - plantUmlsValidated.length = 7 - 5 = 2\n=> Should be 0\nFor exercise 2:\nthis.plantUmlIndex - plantUmlsValidated.length = 7 - 3 = 4\n=> Should be 4\nI would suggest to directly determine the plantUml ids at the beginning, something like (untested):\n                        const plantUmls = text.match(plantUmlRegex) || [];\n                        // Assign unique ids to uml data structure at the beginning. \n                        const plantUmlsIndexed = plantUmls.map(uml -> {\n                            plantUmlIndex++;\n                            const nextIndex = plantUmlIndex;\n                            return {id: nextIndex, uml}; \n                        })\n                        const replacedText = plantUmlsIndexed.reduce((acc: string, {uml, id}): string => {\n                            return acc.replace(new RegExp(escapeStringForUseInRegex(uml), 'g'), plantUmlContainer.replace(idPlaceholder, id.toString()));              \n                        }, text);\n                        ... more stuff about validation, leaving out for brevity sake.\n                        // Now here the advantage is that the id is part of the data structure:\n                        plantUmlsValidated.forEach(({id, uml}) => {\n                            this.loadAndInjectPlantUml(uml, id);\n                        }", "author": "thilo-behnke", "createdAt": "2020-07-09T05:12:46Z", "path": "src/main/webapp/app/exercises/programming/shared/instructions-render/extensions/programming-exercise-plant-uml.extension.ts", "diffHunk": "@@ -66,19 +67,22 @@ export class ProgrammingExercisePlantUmlExtensionWrapper implements ArtemisShowd\n                 const plantUmlContainer = `<div class=\"mb-4\" id=\"plantUml-${idPlaceholder}\"></div>`;\n                 // Replace test status markers.\n                 const plantUmls = text.match(plantUmlRegex) || [];\n-                const replacedText = plantUmls.reduce(\n-                    (acc: string, plantUml: string, index: number): string =>\n-                        acc.replace(new RegExp(escapeStringForUseInRegex(plantUml), 'g'), plantUmlContainer.replace(idPlaceholder, index.toString())),\n-                    text,\n-                );\n+                const replacedText = plantUmls.reduce((acc: string, plantUml: string): string => {\n+                    this.plantUmlIndex++;\n+                    return acc.replace(new RegExp(escapeStringForUseInRegex(plantUml), 'g'), plantUmlContainer.replace(idPlaceholder, this.plantUmlIndex.toString()));\n+                }, text);\n                 const plantUmlsValidated = plantUmls.map((plantUml) =>\n                     plantUml.replace(/testsColor\\(([^)]+)\\)/g, (match: any, capture: string) => {\n                         const tests = capture.split(',');\n                         const { testCaseState } = this.programmingExerciseInstructionService.testStatusForTask(tests, this.latestResult);\n                         return testCaseState === TestCaseState.SUCCESS ? 'green' : testCaseState === TestCaseState.FAIL ? 'red' : 'grey';\n                     }),\n                 );\n-                this.injectableElementsFoundSubject.next(() => this.loadAndInjectPlantUmls(plantUmlsValidated));\n+                this.injectableElementsFoundSubject.next(() => {\n+                    plantUmlsValidated.forEach((plantUml: string, index: number) => {\n+                        this.loadAndInjectPlantUml(plantUml, this.plantUmlIndex - plantUmlsValidated.length + index + 1);", "originalCommit": "30aa69c6263f519010a29bf7a872dea93a86d9a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2ODM4Mg==", "url": "https://github.com/ls1intum/Artemis/pull/1840#discussion_r451968382", "bodyText": "Another possible fix would be to save the plantUmlIndex in a closure outside of the thunk.\nThis has the advantage that the plantUml index range start will be the same, even if the service variable changes (this.plantUmlIndex).\nAgain not tested:\n// Store variable in closure.\nconst plantUmlIndexRangeStart = this.plantUmlIndex - plantUmlsValidated.length;\nplantUmlsValidated.forEach((plantUml: string, index: number) => {]\n                        // Access the closure variable instead of the class property.\n                        this.loadAndInjectPlantUml(plantUml, plantUmlIndexRangeStart + index + 1);\n}", "author": "thilo-behnke", "createdAt": "2020-07-09T05:15:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2NzYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE0MDA2Mw==", "url": "https://github.com/ls1intum/Artemis/pull/1840#discussion_r452140063", "bodyText": "I assumed that the calculation of the indices is not done at the same time for different exercises (only when you switch between 2). So in your example, it would be instead\nFor exercise 1:\nthis.plantUmlIndex - plantUmlsValidated.length = 5 - 5 = 2\nHowever, I agree that my approach is too simple and we should implement this in a more bulletproof fashion. The problem is, I am not so experienced with the mechanisms and did not have enough time to implement this properly", "author": "krusche", "createdAt": "2020-07-09T11:08:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2NzYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY0MzQzMQ==", "url": "https://github.com/ls1intum/Artemis/pull/1840#discussion_r452643431", "bodyText": "fixed by @kloessst", "author": "krusche", "createdAt": "2020-07-10T06:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk2NzYxNw=="}], "type": "inlineReview"}, {"oid": "31156f5be042d3a7331f1ecdfd3f36fc3178573c", "url": "https://github.com/ls1intum/Artemis/commit/31156f5be042d3a7331f1ecdfd3f36fc3178573c", "message": "make sure to close repos after download so that the delete operation works", "committedDate": "2020-07-09T14:24:40Z", "type": "commit"}, {"oid": "a01077e3dc3c3b220cc500d76b84dfe425b7dd26", "url": "https://github.com/ls1intum/Artemis/commit/a01077e3dc3c3b220cc500d76b84dfe425b7dd26", "message": "Store index with uml", "committedDate": "2020-07-09T18:40:55Z", "type": "commit"}, {"oid": "0931d965f6a630ec7c13add92ea9df09efab2dd7", "url": "https://github.com/ls1intum/Artemis/commit/0931d965f6a630ec7c13add92ea9df09efab2dd7", "message": "Add id to tasks", "committedDate": "2020-07-09T18:48:24Z", "type": "commit"}, {"oid": "b02f03bc2497d8108f418af82b2c8325a638dea7", "url": "https://github.com/ls1intum/Artemis/commit/b02f03bc2497d8108f418af82b2c8325a638dea7", "message": "Merge branch 'bugfix/lti-oauth2' of https://github.com/ls1intum/Artemis into bugfix/lti-oauth2", "committedDate": "2020-07-09T18:48:51Z", "type": "commit"}, {"oid": "0e433a66e9b1792b4e62f60f9f4a6f99b1fab59c", "url": "https://github.com/ls1intum/Artemis/commit/0e433a66e9b1792b4e62f60f9f4a6f99b1fab59c", "message": "Fix task tests", "committedDate": "2020-07-09T19:27:35Z", "type": "commit"}, {"oid": "5e4a00788115dc466a98bcd0e56bd9ce83b24db2", "url": "https://github.com/ls1intum/Artemis/commit/5e4a00788115dc466a98bcd0e56bd9ce83b24db2", "message": "Remove unnecessary test", "committedDate": "2020-07-09T19:37:29Z", "type": "commit"}, {"oid": "190767c0e175bce50a26713228dcfb4cbc69835a", "url": "https://github.com/ls1intum/Artemis/commit/190767c0e175bce50a26713228dcfb4cbc69835a", "message": "Linting", "committedDate": "2020-07-09T20:04:53Z", "type": "commit"}, {"oid": "a2cf145a56157ca0f69a8607d45e2ecaee3fecf2", "url": "https://github.com/ls1intum/Artemis/commit/a2cf145a56157ca0f69a8607d45e2ecaee3fecf2", "message": "Merge branch 'develop' into bugfix/lti-oauth2", "committedDate": "2020-07-09T21:51:38Z", "type": "commit"}]}