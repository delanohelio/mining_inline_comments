{"pr_number": 2471, "pr_title": "Feature/user statistics", "pr_createdAt": "2020-11-27T16:19:26Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/2471", "timeline": [{"oid": "07bf800031b7a28c2894cba9f257cf179e1d9690", "url": "https://github.com/ls1intum/Artemis/commit/07bf800031b7a28c2894cba9f257cf179e1d9690", "message": "first statistics changes", "committedDate": "2020-11-18T13:39:35Z", "type": "commit"}, {"oid": "237fa4c1b5d62544d8acf45eff322951d46e24ca", "url": "https://github.com/ls1intum/Artemis/commit/237fa4c1b5d62544d8acf45eff322951d46e24ca", "message": "refactoring, not finished", "committedDate": "2020-11-18T17:13:33Z", "type": "commit"}, {"oid": "8fd9708b21f3b4e5624f82983c67c35c7cf84339", "url": "https://github.com/ls1intum/Artemis/commit/8fd9708b21f3b4e5624f82983c67c35c7cf84339", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into feature/user-statistics", "committedDate": "2020-11-18T17:14:31Z", "type": "commit"}, {"oid": "add67a6275d793203cef64f2b73f098b618a8281", "url": "https://github.com/ls1intum/Artemis/commit/add67a6275d793203cef64f2b73f098b618a8281", "message": "users, active users and submission + some refactoring", "committedDate": "2020-11-20T16:58:03Z", "type": "commit"}, {"oid": "a6b68b747ba8a9e4751ee00943a94b188ab09363", "url": "https://github.com/ls1intum/Artemis/commit/a6b68b747ba8a9e4751ee00943a94b188ab09363", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into feature/user-statistics", "committedDate": "2020-11-20T16:59:59Z", "type": "commit"}, {"oid": "1d806e960ba684c38def630c5ea117d054d9e789", "url": "https://github.com/ls1intum/Artemis/commit/1d806e960ba684c38def630c5ea117d054d9e789", "message": "added 2 new pieces of information and extracted logic into repository", "committedDate": "2020-11-20T21:34:26Z", "type": "commit"}, {"oid": "692040676db1b5d0eeca006847931eebe28d8e5e", "url": "https://github.com/ls1intum/Artemis/commit/692040676db1b5d0eeca006847931eebe28d8e5e", "message": "5 more aspects", "committedDate": "2020-11-21T15:13:05Z", "type": "commit"}, {"oid": "7dfec269a1b23d123783c5e74dc810f533f6f345", "url": "https://github.com/ls1intum/Artemis/commit/7dfec269a1b23d123783c5e74dc810f533f6f345", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into feature/user-statistics", "committedDate": "2020-11-21T15:13:36Z", "type": "commit"}, {"oid": "a2ac2cb368051d536a64273a489cb79a9bdb3d8d", "url": "https://github.com/ls1intum/Artemis/commit/a2ac2cb368051d536a64273a489cb79a9bdb3d8d", "message": "test commit", "committedDate": "2020-11-21T15:40:26Z", "type": "commit"}, {"oid": "cc8fa323abc79b4610b93913d206f9020bbb2b97", "url": "https://github.com/ls1intum/Artemis/commit/cc8fa323abc79b4610b93913d206f9020bbb2b97", "message": "feedback implemented", "committedDate": "2020-11-21T16:10:21Z", "type": "commit"}, {"oid": "2677ff3bc025a91c337345786b578578cf238d2f", "url": "https://github.com/ls1intum/Artemis/commit/2677ff3bc025a91c337345786b578578cf238d2f", "message": "smaller fixes", "committedDate": "2020-11-21T16:48:53Z", "type": "commit"}, {"oid": "e060a61a4235cd277b8f201ce165dc9c1ca4b54c", "url": "https://github.com/ls1intum/Artemis/commit/e060a61a4235cd277b8f201ce165dc9c1ca4b54c", "message": "start chart method", "committedDate": "2020-11-23T10:00:01Z", "type": "commit"}, {"oid": "e6a3f4db5198403c38d67e8b68596a874037fd2d", "url": "https://github.com/ls1intum/Artemis/commit/e6a3f4db5198403c38d67e8b68596a874037fd2d", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into feature/user-statistics", "committedDate": "2020-11-23T10:00:50Z", "type": "commit"}, {"oid": "6a877159af0d79ce866803ef5c55c54809a50485", "url": "https://github.com/ls1intum/Artemis/commit/6a877159af0d79ce866803ef5c55c54809a50485", "message": "two bar charts", "committedDate": "2020-11-24T20:37:41Z", "type": "commit"}, {"oid": "a3ee71192436db7adc679b27996695b2e3a88a92", "url": "https://github.com/ls1intum/Artemis/commit/a3ee71192436db7adc679b27996695b2e3a88a92", "message": "push server changes", "committedDate": "2020-11-26T08:57:07Z", "type": "commit"}, {"oid": "a1363a012a75eefd126cbed5fed1342d8c6a7f89", "url": "https://github.com/ls1intum/Artemis/commit/a1363a012a75eefd126cbed5fed1342d8c6a7f89", "message": "added first graph with real values", "committedDate": "2020-11-27T11:32:23Z", "type": "commit"}, {"oid": "ee8f7c6e07ac1e3cddb5441fa33978b6b23ccd87", "url": "https://github.com/ls1intum/Artemis/commit/ee8f7c6e07ac1e3cddb5441fa33978b6b23ccd87", "message": "removed StatisticsObject", "committedDate": "2020-11-27T11:33:11Z", "type": "commit"}, {"oid": "b224b0adeaa80cf1fd6a0cdac7bb0773154e1497", "url": "https://github.com/ls1intum/Artemis/commit/b224b0adeaa80cf1fd6a0cdac7bb0773154e1497", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into feature/user-statistics", "committedDate": "2020-11-27T11:33:28Z", "type": "commit"}, {"oid": "46c81aa6081caa603d5713a1e10b4d0b69151dd0", "url": "https://github.com/ls1intum/Artemis/commit/46c81aa6081caa603d5713a1e10b4d0b69151dd0", "message": "worked on year tab, week working", "committedDate": "2020-11-27T15:00:47Z", "type": "commit"}, {"oid": "228da8ae7b96b1d35e110dc8a01aebe969812c5a", "url": "https://github.com/ls1intum/Artemis/commit/228da8ae7b96b1d35e110dc8a01aebe969812c5a", "message": "Refactored unused stuff", "committedDate": "2020-11-27T19:07:41Z", "type": "commit"}, {"oid": "cb02d3091ecb1d6f67cdf3d53e237668cdeb54e5", "url": "https://github.com/ls1intum/Artemis/commit/cb02d3091ecb1d6f67cdf3d53e237668cdeb54e5", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into feature/user-statistics", "committedDate": "2020-11-27T19:08:23Z", "type": "commit"}, {"oid": "ac7257d174ed321c706cf7f8a28037403a3871ae", "url": "https://github.com/ls1intum/Artemis/commit/ac7257d174ed321c706cf7f8a28037403a3871ae", "message": "Codacy", "committedDate": "2020-11-27T19:44:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTk5ODQxMA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r531998410", "bodyText": "why is where s.submissionDate > '1970-01-01 00:00:01' in there?", "author": "TobiasPr", "createdAt": "2020-11-28T07:46:25Z", "path": "src/main/java/de/tum/in/www1/artemis/repository/StatisticsRepository.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package de.tum.in.www1.artemis.repository;\n+\n+import java.time.Instant;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.data.jpa.repository.JpaRepository;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+import org.springframework.stereotype.Repository;\n+\n+import de.tum.in.www1.artemis.domain.User;\n+\n+/**\n+ * Spring Data JPA repository for the user statistics\n+ */\n+@Repository\n+public interface StatisticsRepository extends JpaRepository<User, Long> {\n+\n+    @Query(\"select count(distinct u.login) from User u, PersistentAuditEvent p where u.login like p.principal and p.auditEventType = 'AUTHENTICATION_SUCCESS' and u.login not like '%test%' and p.auditEventDate >= :#{#span}\")\n+    Integer getLoggedInUsers(@Param(\"span\") Instant span);\n+\n+    @Query(\"select count(distinct u.login) from User u, Submission s, StudentParticipation p where s.participation.id = p.id and p.student.id = u.id and s.submissionDate >= :#{#span} and u.login not like '%test%'\")\n+    Integer getActiveUsers(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select count(distinct sub.id) from Submission sub where sub.submissionDate >= :#{#span}\")\n+    Integer getTotalSubmissions(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select count(distinct e.id) from Exercise e where e.releaseDate >= :#{#span} and e.releaseDate <= :#{#now}\")\n+    Integer getReleasedExercises(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"select count(distinct e.id) from Exercise e where e.dueDate >= :#{#span} and e.dueDate <= :#{#now}\")\n+    Integer getExerciseDeadlines(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"select count(distinct e.id) from Exam e where e.endDate >= :#{#span} and e.endDate <= :#{#now}\")\n+    Integer getConductedExams(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"select count(distinct se.id) from StudentExam se, Exam e where se.submitted = true and se.exam = e and e.endDate >= :#{#span}\")\n+    Integer getExamParticipations(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select sum(e.registeredUsers.size) from Exam e where e.endDate >= :#{#span} and e.endDate <= :#{#now}\")\n+    Integer getExamRegistrations(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"select count(distinct r.assessor.id) from Result r where (r.assessmentType = 'MANUAL' or r.assessmentType = 'SEMI-AUTOMATIC') and r.completionDate >= :#{#span}\")\n+    Integer getActiveTutors(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select count(distinct r.id) from Result r where r.completionDate >= :#{#span}\")\n+    Integer getCreatedResults(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select sum(r.feedbacks.size) from Result r where r.completionDate >= :#{#span}\")\n+    Integer getResultFeedbacks(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select 'DATE(s.submissionDate)' as day, count(s.id) as amount from Submission s where s.submissionDate > '1970-01-01 00:00:01' group by 'DATE(s.submissionDate)' order by 'DATE(s.submissionDate)' asc\")", "originalCommit": "ac7257d174ed321c706cf7f8a28037403a3871ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjcwMw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532056703", "bodyText": "Done", "author": "FuchsDominik", "createdAt": "2020-11-28T16:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTk5ODQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwMDQzMg==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532000432", "bodyText": "is it correct that getTotalSumbmissionsDay has no ZonedDateTime parameter name?", "author": "TobiasPr", "createdAt": "2020-11-28T07:49:04Z", "path": "src/main/java/de/tum/in/www1/artemis/repository/StatisticsRepository.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package de.tum.in.www1.artemis.repository;\n+\n+import java.time.Instant;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.data.jpa.repository.JpaRepository;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+import org.springframework.stereotype.Repository;\n+\n+import de.tum.in.www1.artemis.domain.User;\n+\n+/**\n+ * Spring Data JPA repository for the user statistics\n+ */\n+@Repository\n+public interface StatisticsRepository extends JpaRepository<User, Long> {\n+\n+    @Query(\"select count(distinct u.login) from User u, PersistentAuditEvent p where u.login like p.principal and p.auditEventType = 'AUTHENTICATION_SUCCESS' and u.login not like '%test%' and p.auditEventDate >= :#{#span}\")\n+    Integer getLoggedInUsers(@Param(\"span\") Instant span);\n+\n+    @Query(\"select count(distinct u.login) from User u, Submission s, StudentParticipation p where s.participation.id = p.id and p.student.id = u.id and s.submissionDate >= :#{#span} and u.login not like '%test%'\")\n+    Integer getActiveUsers(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select count(distinct sub.id) from Submission sub where sub.submissionDate >= :#{#span}\")\n+    Integer getTotalSubmissions(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select count(distinct e.id) from Exercise e where e.releaseDate >= :#{#span} and e.releaseDate <= :#{#now}\")\n+    Integer getReleasedExercises(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"select count(distinct e.id) from Exercise e where e.dueDate >= :#{#span} and e.dueDate <= :#{#now}\")\n+    Integer getExerciseDeadlines(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"select count(distinct e.id) from Exam e where e.endDate >= :#{#span} and e.endDate <= :#{#now}\")\n+    Integer getConductedExams(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"select count(distinct se.id) from StudentExam se, Exam e where se.submitted = true and se.exam = e and e.endDate >= :#{#span}\")\n+    Integer getExamParticipations(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select sum(e.registeredUsers.size) from Exam e where e.endDate >= :#{#span} and e.endDate <= :#{#now}\")\n+    Integer getExamRegistrations(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"select count(distinct r.assessor.id) from Result r where (r.assessmentType = 'MANUAL' or r.assessmentType = 'SEMI-AUTOMATIC') and r.completionDate >= :#{#span}\")\n+    Integer getActiveTutors(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select count(distinct r.id) from Result r where r.completionDate >= :#{#span}\")\n+    Integer getCreatedResults(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select sum(r.feedbacks.size) from Result r where r.completionDate >= :#{#span}\")\n+    Integer getResultFeedbacks(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select 'DATE(s.submissionDate)' as day, count(s.id) as amount from Submission s where s.submissionDate > '1970-01-01 00:00:01' group by 'DATE(s.submissionDate)' order by 'DATE(s.submissionDate)' asc\")\n+    List<Map<String, Object>> getTotalSubmissionsDay();", "originalCommit": "ac7257d174ed321c706cf7f8a28037403a3871ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwMjYyNg==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532002626", "bodyText": "I think we should use a Map<ZonedDateTime, Integer> here.\nIt gives us the benefit that it will be compatible with the other cases of the switch statement and also improves readability when debugging.", "author": "TobiasPr", "createdAt": "2020-11-28T07:57:42Z", "path": "src/main/java/de/tum/in/www1/artemis/service/StatisticsService.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.time.ZonedDateTime;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.repository.StatisticsRepository;\n+\n+@Service\n+public class StatisticsService {\n+\n+    private final StatisticsRepository statisticsRepository;\n+\n+    public StatisticsService(StatisticsRepository statisticsRepository) {\n+        this.statisticsRepository = statisticsRepository;\n+    }\n+\n+    public Integer getLoggedInUsers(Long span) {\n+        return this.statisticsRepository.getLoggedInUsers(ZonedDateTime.now().minusDays(span).toInstant());\n+    }\n+\n+    public Integer getActiveUsers(Long span) {\n+        return this.statisticsRepository.getActiveUsers(ZonedDateTime.now().minusDays(span));\n+    }\n+\n+    /**\n+     * Forwards the request to the repository, which returns a List<Map<String, Object>>, with String being the column name, \"day\" and \"amount\" and Object being the value,\n+     * either the date or the amount of submissions. It then collects the amounts in an array, depending on the span value, and returns it\n+     *\n+     * @param span DAY,WEEK,MONTH or YEAR depending on the active tab in the view\n+     * @return a array, containing the values for each bar in the graph\n+     */\n+    public Integer[] getTotalSubmissions(String span) {\n+        switch (span) {\n+            case \"DAY\": // result = this.statisticsRepository.getTotalSubmissionsDay(ZonedDateTime.now().minusDays(7));\n+                return null;\n+            case \"WEEK\":\n+                Integer[] result = new Integer[7];", "originalCommit": "ac7257d174ed321c706cf7f8a28037403a3871ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwMzA3NA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532003074", "bodyText": "what is the distinct doing? we only query from one table -> id should be distinct anyway", "author": "TobiasPr", "createdAt": "2020-11-28T08:03:21Z", "path": "src/main/java/de/tum/in/www1/artemis/repository/StatisticsRepository.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package de.tum.in.www1.artemis.repository;\n+\n+import java.time.Instant;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.data.jpa.repository.JpaRepository;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+import org.springframework.stereotype.Repository;\n+\n+import de.tum.in.www1.artemis.domain.User;\n+\n+/**\n+ * Spring Data JPA repository for the user statistics\n+ */\n+@Repository\n+public interface StatisticsRepository extends JpaRepository<User, Long> {\n+\n+    @Query(\"select count(distinct u.login) from User u, PersistentAuditEvent p where u.login like p.principal and p.auditEventType = 'AUTHENTICATION_SUCCESS' and u.login not like '%test%' and p.auditEventDate >= :#{#span}\")\n+    Integer getLoggedInUsers(@Param(\"span\") Instant span);\n+\n+    @Query(\"select count(distinct u.login) from User u, Submission s, StudentParticipation p where s.participation.id = p.id and p.student.id = u.id and s.submissionDate >= :#{#span} and u.login not like '%test%'\")\n+    Integer getActiveUsers(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select count(distinct sub.id) from Submission sub where sub.submissionDate >= :#{#span}\")\n+    Integer getTotalSubmissions(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select count(distinct e.id) from Exercise e where e.releaseDate >= :#{#span} and e.releaseDate <= :#{#now}\")", "originalCommit": "ac7257d174ed321c706cf7f8a28037403a3871ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjUwNQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532056505", "bodyText": "Done", "author": "FuchsDominik", "createdAt": "2020-11-28T16:15:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwMzA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwMzA5Ng==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532003096", "bodyText": "Same here", "author": "TobiasPr", "createdAt": "2020-11-28T08:03:36Z", "path": "src/main/java/de/tum/in/www1/artemis/repository/StatisticsRepository.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package de.tum.in.www1.artemis.repository;\n+\n+import java.time.Instant;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.data.jpa.repository.JpaRepository;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+import org.springframework.stereotype.Repository;\n+\n+import de.tum.in.www1.artemis.domain.User;\n+\n+/**\n+ * Spring Data JPA repository for the user statistics\n+ */\n+@Repository\n+public interface StatisticsRepository extends JpaRepository<User, Long> {\n+\n+    @Query(\"select count(distinct u.login) from User u, PersistentAuditEvent p where u.login like p.principal and p.auditEventType = 'AUTHENTICATION_SUCCESS' and u.login not like '%test%' and p.auditEventDate >= :#{#span}\")\n+    Integer getLoggedInUsers(@Param(\"span\") Instant span);\n+\n+    @Query(\"select count(distinct u.login) from User u, Submission s, StudentParticipation p where s.participation.id = p.id and p.student.id = u.id and s.submissionDate >= :#{#span} and u.login not like '%test%'\")\n+    Integer getActiveUsers(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select count(distinct sub.id) from Submission sub where sub.submissionDate >= :#{#span}\")\n+    Integer getTotalSubmissions(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select count(distinct e.id) from Exercise e where e.releaseDate >= :#{#span} and e.releaseDate <= :#{#now}\")\n+    Integer getReleasedExercises(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"select count(distinct e.id) from Exercise e where e.dueDate >= :#{#span} and e.dueDate <= :#{#now}\")", "originalCommit": "ac7257d174ed321c706cf7f8a28037403a3871ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjQ4MA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532056480", "bodyText": "Done", "author": "FuchsDominik", "createdAt": "2020-11-28T16:14:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwMzA5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwMzEyNg==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532003126", "bodyText": "Same here", "author": "TobiasPr", "createdAt": "2020-11-28T08:03:57Z", "path": "src/main/java/de/tum/in/www1/artemis/repository/StatisticsRepository.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package de.tum.in.www1.artemis.repository;\n+\n+import java.time.Instant;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.data.jpa.repository.JpaRepository;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+import org.springframework.stereotype.Repository;\n+\n+import de.tum.in.www1.artemis.domain.User;\n+\n+/**\n+ * Spring Data JPA repository for the user statistics\n+ */\n+@Repository\n+public interface StatisticsRepository extends JpaRepository<User, Long> {\n+\n+    @Query(\"select count(distinct u.login) from User u, PersistentAuditEvent p where u.login like p.principal and p.auditEventType = 'AUTHENTICATION_SUCCESS' and u.login not like '%test%' and p.auditEventDate >= :#{#span}\")\n+    Integer getLoggedInUsers(@Param(\"span\") Instant span);\n+\n+    @Query(\"select count(distinct u.login) from User u, Submission s, StudentParticipation p where s.participation.id = p.id and p.student.id = u.id and s.submissionDate >= :#{#span} and u.login not like '%test%'\")\n+    Integer getActiveUsers(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select count(distinct sub.id) from Submission sub where sub.submissionDate >= :#{#span}\")\n+    Integer getTotalSubmissions(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select count(distinct e.id) from Exercise e where e.releaseDate >= :#{#span} and e.releaseDate <= :#{#now}\")\n+    Integer getReleasedExercises(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"select count(distinct e.id) from Exercise e where e.dueDate >= :#{#span} and e.dueDate <= :#{#now}\")\n+    Integer getExerciseDeadlines(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"select count(distinct e.id) from Exam e where e.endDate >= :#{#span} and e.endDate <= :#{#now}\")", "originalCommit": "ac7257d174ed321c706cf7f8a28037403a3871ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjQ3Mg==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532056472", "bodyText": "Done", "author": "FuchsDominik", "createdAt": "2020-11-28T16:14:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwMzEyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwNDIwMg==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532004202", "bodyText": "Should we move this to a .model.ts?", "author": "TobiasPr", "createdAt": "2020-11-28T08:16:05Z", "path": "src/main/webapp/app/admin/statistics/statistics.component.ts", "diffHunk": "@@ -0,0 +1,178 @@\n+import { Component, OnInit, OnChanges, ViewChild } from '@angular/core';\n+import { StatisticsService } from 'app/admin/statistics/statistics.service';\n+import { SPAN_PATTERN } from 'app/app.constants';\n+import { ChartDataSets, ChartOptions, ChartType } from 'chart.js';\n+import { BaseChartDirective, Label } from 'ng2-charts';\n+import { DataSet } from 'app/exercises/quiz/manage/statistics/quiz-statistic/quiz-statistic.component';\n+import { TranslateService } from '@ngx-translate/core';\n+import * as moment from 'moment';\n+\n+export enum SpanType {", "originalCommit": "ac7257d174ed321c706cf7f8a28037403a3871ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjQ2Mw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532056463", "bodyText": "Done", "author": "FuchsDominik", "createdAt": "2020-11-28T16:14:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwNDIwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwNDQ4NQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532004485", "bodyText": "use moment().daysInMonth()", "author": "TobiasPr", "createdAt": "2020-11-28T08:19:33Z", "path": "src/main/webapp/app/admin/statistics/statistics.component.ts", "diffHunk": "@@ -0,0 +1,178 @@\n+import { Component, OnInit, OnChanges, ViewChild } from '@angular/core';\n+import { StatisticsService } from 'app/admin/statistics/statistics.service';\n+import { SPAN_PATTERN } from 'app/app.constants';\n+import { ChartDataSets, ChartOptions, ChartType } from 'chart.js';\n+import { BaseChartDirective, Label } from 'ng2-charts';\n+import { DataSet } from 'app/exercises/quiz/manage/statistics/quiz-statistic/quiz-statistic.component';\n+import { TranslateService } from '@ngx-translate/core';\n+import * as moment from 'moment';\n+\n+export enum SpanType {\n+    DAY = 'DAY',\n+    WEEK = 'WEEK',\n+    MONTH = 'MONTH',\n+    YEAR = 'YEAR',\n+}\n+\n+@Component({\n+    selector: 'jhi-statistics',\n+    templateUrl: './statistics.component.html',\n+})\n+export class JhiStatisticsComponent implements OnInit, OnChanges {\n+    spanPattern = SPAN_PATTERN;\n+    span: SpanType = SpanType.WEEK;\n+\n+    // Histogram related properties\n+    public histogramData: number[] = [];\n+    public barChartOptions: ChartOptions = {};\n+    public barChartLabels: Label[] = [];\n+    public barChartType: ChartType = 'bar';\n+    public barChartLegend = true;\n+    public UserLoginChartData: ChartDataSets[] = [];\n+    public SubmissionsChartData: ChartDataSets[] = [];\n+\n+    @ViewChild(BaseChartDirective) chart: BaseChartDirective;\n+\n+    constructor(private service: StatisticsService, private translateService: TranslateService) {}\n+\n+    async ngOnInit() {\n+        await this.setBinWidth();\n+        await this.createChart();\n+    }\n+\n+    async ngOnChanges() {}\n+\n+    private async setBinWidth(): Promise<void> {\n+        switch (this.span) {\n+            case SpanType.DAY:\n+                this.histogramData = Array(24).fill(0);\n+                break;\n+            case SpanType.WEEK:\n+                this.histogramData = Array(7).fill(0);\n+                break;\n+            case SpanType.MONTH:\n+                const days = this.daysInMonth();\n+                this.histogramData = Array(days).fill(0);\n+                break;\n+            case SpanType.YEAR:\n+                this.histogramData = Array(12).fill(0);\n+                break;\n+        }\n+    }\n+\n+    private daysInMonth(): number {\n+        return new Date(new Date().getFullYear(), new Date().getMonth(), 0).getDate();", "originalCommit": "ac7257d174ed321c706cf7f8a28037403a3871ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjQ0Mw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532056443", "bodyText": "Done", "author": "FuchsDominik", "createdAt": "2020-11-28T16:14:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwNDQ4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwNTY0Nw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532005647", "bodyText": "we shouldn't introduce the labels for weekdays, moment can give them to you momentObject.format('dddd')", "author": "TobiasPr", "createdAt": "2020-11-28T08:33:22Z", "path": "src/main/webapp/app/admin/statistics/statistics.component.ts", "diffHunk": "@@ -0,0 +1,178 @@\n+import { Component, OnInit, OnChanges, ViewChild } from '@angular/core';\n+import { StatisticsService } from 'app/admin/statistics/statistics.service';\n+import { SPAN_PATTERN } from 'app/app.constants';\n+import { ChartDataSets, ChartOptions, ChartType } from 'chart.js';\n+import { BaseChartDirective, Label } from 'ng2-charts';\n+import { DataSet } from 'app/exercises/quiz/manage/statistics/quiz-statistic/quiz-statistic.component';\n+import { TranslateService } from '@ngx-translate/core';\n+import * as moment from 'moment';\n+\n+export enum SpanType {\n+    DAY = 'DAY',\n+    WEEK = 'WEEK',\n+    MONTH = 'MONTH',\n+    YEAR = 'YEAR',\n+}\n+\n+@Component({\n+    selector: 'jhi-statistics',\n+    templateUrl: './statistics.component.html',\n+})\n+export class JhiStatisticsComponent implements OnInit, OnChanges {\n+    spanPattern = SPAN_PATTERN;\n+    span: SpanType = SpanType.WEEK;\n+\n+    // Histogram related properties\n+    public histogramData: number[] = [];\n+    public barChartOptions: ChartOptions = {};\n+    public barChartLabels: Label[] = [];\n+    public barChartType: ChartType = 'bar';\n+    public barChartLegend = true;\n+    public UserLoginChartData: ChartDataSets[] = [];\n+    public SubmissionsChartData: ChartDataSets[] = [];\n+\n+    @ViewChild(BaseChartDirective) chart: BaseChartDirective;\n+\n+    constructor(private service: StatisticsService, private translateService: TranslateService) {}\n+\n+    async ngOnInit() {\n+        await this.setBinWidth();\n+        await this.createChart();\n+    }\n+\n+    async ngOnChanges() {}\n+\n+    private async setBinWidth(): Promise<void> {\n+        switch (this.span) {\n+            case SpanType.DAY:\n+                this.histogramData = Array(24).fill(0);\n+                break;\n+            case SpanType.WEEK:\n+                this.histogramData = Array(7).fill(0);\n+                break;\n+            case SpanType.MONTH:\n+                const days = this.daysInMonth();\n+                this.histogramData = Array(days).fill(0);\n+                break;\n+            case SpanType.YEAR:\n+                this.histogramData = Array(12).fill(0);\n+                break;\n+        }\n+    }\n+\n+    private daysInMonth(): number {\n+        return new Date(new Date().getFullYear(), new Date().getMonth(), 0).getDate();\n+    }\n+\n+    async getSubmissions(): Promise<number[]> {\n+        return new Promise<number[]>((resolve, reject) => {\n+            this.service.getTotalSubmissions(this.span).subscribe((res: number[]) => {\n+                if (res !== null) {\n+                    resolve(res);\n+                } else {\n+                    reject('Submissions could not get fetched');\n+                }\n+            });\n+        });\n+    }\n+\n+    onTabChanged(span: string): void {\n+        switch (span) {\n+            case 'Day':\n+                this.span = SpanType.DAY;\n+                break;\n+            case 'Week':\n+                this.span = SpanType.WEEK;\n+                break;\n+            case 'Month':\n+                this.span = SpanType.MONTH;\n+                break;\n+            case 'Year':\n+                this.span = SpanType.YEAR;\n+                break;\n+        }\n+    }\n+    private getWeekdays(day: number): string[] {\n+        const days = [\n+            this.translateService.instant('weekdays.monday'),", "originalCommit": "ac7257d174ed321c706cf7f8a28037403a3871ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjQyNQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532056425", "bodyText": "Done", "author": "FuchsDominik", "createdAt": "2020-11-28T16:14:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwNTY0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA2MDU2OA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r533060568", "bodyText": "@FuchsDominik did this not work, because the weekday translations are still there", "author": "fde312", "createdAt": "2020-12-01T04:09:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwNTY0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM3MjM3Nw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r533372377", "bodyText": "I implemented it as requested but withdrawed it again, as moment().format('dddd') does not translate the weekdays into german. I would handle it like this, unless you have another approach which would also translate the labels @fde312", "author": "FuchsDominik", "createdAt": "2020-12-01T12:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwNTY0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwNTk4NQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532005985", "bodyText": "get rid of this", "author": "TobiasPr", "createdAt": "2020-11-28T08:37:04Z", "path": "src/main/webapp/i18n/en/statistics.json", "diffHunk": "@@ -0,0 +1,37 @@\n+{\n+    \"statistics\": {\n+        \"amountOfStudents\": \"# of students\",\n+        \"span\": {\n+            \"day\": \"Day\",\n+            \"week\": \"Week\",\n+            \"month\": \"Month\",\n+            \"year\": \"Year\"\n+        },\n+        \"title\": \"User statistics\",\n+        \"days\": \" days\",\n+        \"loggedInUsers\": \"Amount of logins of distinct users in the last \",\n+        \"activeUsers\": \"Amount of logins of active users in the last \",\n+        \"totalSubmissions\": \"Total amount of submissions in the last \",\n+        \"exercises\": {\n+            \"released\": \"Total amount of released exercises in the last \",\n+            \"due\": \"Total amount of exercise deadlines in the last \"\n+        },\n+        \"conductedExams\": \"Total amount of conducted exams in the last \",\n+        \"examParticipation\": \" -> amount of student who participated: \",\n+        \"examRegistrations\": \" -> with the amount of students being registered in these exam: \",\n+        \"activeTutors\": \"Total amount of tutors which have created an assessment in the last \",\n+        \"results\": \"Total amount of results created in the last \",\n+        \"resultFeedbacks\": \"-> feedback count: \",\n+        \"userLogins\": \"User Logins\",\n+        \"submissions\": \"Submissions\"\n+    },\n+    \"weekdays\": {", "originalCommit": "ac7257d174ed321c706cf7f8a28037403a3871ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjM4Ng==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532056386", "bodyText": "Done", "author": "FuchsDominik", "createdAt": "2020-11-28T16:14:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwNTk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwNjAwMw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532006003", "bodyText": "get rid of this", "author": "TobiasPr", "createdAt": "2020-11-28T08:37:18Z", "path": "src/main/webapp/i18n/de/statistics.json", "diffHunk": "@@ -0,0 +1,37 @@\n+{\n+    \"statistics\": {\n+        \"amountOfStudents\": \"# an Studenten\",\n+        \"span\": {\n+            \"day\": \"Tag\",\n+            \"week\": \"Woche\",\n+            \"month\": \"Monat\",\n+            \"year\": \"Jahr\"\n+        },\n+        \"title\": \"Benutzer Statistiken\",\n+        \"days\": \" Tagen\",\n+        \"loggedInUsers\": \"Anzahl an Anmeldungen unterschiedlicher Benutzer in den letzten \",\n+        \"activeUsers\": \"Anzahl an Anmeldungen aktiver Benutzer in den letzten \",\n+        \"totalSubmissions\": \"Anzahl an Abgaben in den letzten \",\n+        \"exercises\": {\n+            \"released\": \"Anzahl an ver\u00f6ffentlichten Aufgaben in den letzten \",\n+            \"due\": \"Anzahl an Aufgaben mit einer Deadline in den letzten \"\n+        },\n+        \"conductedExams\": \"Anzahl an abgehaltenen Klausuen in den letzten \",\n+        \"examParticipation\": \" -> und Anzahl Studenten, die daran teilgenommen haben: \",\n+        \"examRegistrations\": \" -> Die Anzahl an Studenten mit einer Registrierung f\u00fcr die Klausur: \",\n+        \"activeTutors\": \"Anzahl der Tutoren, die eine Bewertung erstellt haben in den letzten \",\n+        \"results\": \"Anzahl erstellter Resultate in den letzten \",\n+        \"resultFeedbacks\": \"-> mit der absoluten Feedbackanzahl: \",\n+        \"userLogins\": \"Benutzer Anmeldungen\",\n+        \"submissions\": \"Abgaben\"\n+    },\n+    \"weekdays\": {", "originalCommit": "ac7257d174ed321c706cf7f8a28037403a3871ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjM4Mg==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532056382", "bodyText": "Done", "author": "FuchsDominik", "createdAt": "2020-11-28T16:13:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAwNjAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAzNTQzMQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532035431", "bodyText": "Why are you using a Promise here? Can't we work with Observables here as well?", "author": "fde312", "createdAt": "2020-11-28T12:36:17Z", "path": "src/main/webapp/app/admin/statistics/statistics.component.ts", "diffHunk": "@@ -0,0 +1,178 @@\n+import { Component, OnInit, OnChanges, ViewChild } from '@angular/core';\n+import { StatisticsService } from 'app/admin/statistics/statistics.service';\n+import { SPAN_PATTERN } from 'app/app.constants';\n+import { ChartDataSets, ChartOptions, ChartType } from 'chart.js';\n+import { BaseChartDirective, Label } from 'ng2-charts';\n+import { DataSet } from 'app/exercises/quiz/manage/statistics/quiz-statistic/quiz-statistic.component';\n+import { TranslateService } from '@ngx-translate/core';\n+import * as moment from 'moment';\n+\n+export enum SpanType {\n+    DAY = 'DAY',\n+    WEEK = 'WEEK',\n+    MONTH = 'MONTH',\n+    YEAR = 'YEAR',\n+}\n+\n+@Component({\n+    selector: 'jhi-statistics',\n+    templateUrl: './statistics.component.html',\n+})\n+export class JhiStatisticsComponent implements OnInit, OnChanges {\n+    spanPattern = SPAN_PATTERN;\n+    span: SpanType = SpanType.WEEK;\n+\n+    // Histogram related properties\n+    public histogramData: number[] = [];\n+    public barChartOptions: ChartOptions = {};\n+    public barChartLabels: Label[] = [];\n+    public barChartType: ChartType = 'bar';\n+    public barChartLegend = true;\n+    public UserLoginChartData: ChartDataSets[] = [];\n+    public SubmissionsChartData: ChartDataSets[] = [];\n+\n+    @ViewChild(BaseChartDirective) chart: BaseChartDirective;\n+\n+    constructor(private service: StatisticsService, private translateService: TranslateService) {}\n+\n+    async ngOnInit() {\n+        await this.setBinWidth();\n+        await this.createChart();\n+    }\n+\n+    async ngOnChanges() {}\n+\n+    private async setBinWidth(): Promise<void> {\n+        switch (this.span) {\n+            case SpanType.DAY:\n+                this.histogramData = Array(24).fill(0);\n+                break;\n+            case SpanType.WEEK:\n+                this.histogramData = Array(7).fill(0);\n+                break;\n+            case SpanType.MONTH:\n+                const days = this.daysInMonth();\n+                this.histogramData = Array(days).fill(0);\n+                break;\n+            case SpanType.YEAR:\n+                this.histogramData = Array(12).fill(0);\n+                break;\n+        }\n+    }\n+\n+    private daysInMonth(): number {\n+        return new Date(new Date().getFullYear(), new Date().getMonth(), 0).getDate();\n+    }\n+\n+    async getSubmissions(): Promise<number[]> {\n+        return new Promise<number[]>((resolve, reject) => {", "originalCommit": "ac7257d174ed321c706cf7f8a28037403a3871ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA0NzM0OA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532047348", "bodyText": "The graph was initialized before the Submissions got fetched, so I used asynchronous method calls to wait for the result", "author": "FuchsDominik", "createdAt": "2020-11-28T14:41:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAzNTQzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0MjkzMQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532642931", "bodyText": "But why not do it using observables? @FuchsDominik . It is highly unusual in angular to work with promises as everything is based on observables", "author": "stefanwaldhauser", "createdAt": "2020-11-30T14:37:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAzNTQzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc0Nzc3NQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532747775", "bodyText": "Well i still work with observables. All i can say is that using an explicit Promise did the trick as through asynchronous method calls the graph is not instantiated before the result comes back.", "author": "FuchsDominik", "createdAt": "2020-11-30T16:55:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAzNTQzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA2MDg2OA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r533060868", "bodyText": "@FuchsDominik Lets have a look together. Maybe some RxJs magic can help :)", "author": "fde312", "createdAt": "2020-12-01T04:10:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAzNTQzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY0MDM2NA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r533640364", "bodyText": "Resolved in this commit", "author": "FuchsDominik", "createdAt": "2020-12-01T18:44:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAzNTQzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAzNTYyMw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532035623", "bodyText": "You do not need parentheses here", "author": "fde312", "createdAt": "2020-11-28T12:38:32Z", "path": "src/main/java/de/tum/in/www1/artemis/service/StatisticsService.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.time.ZonedDateTime;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.repository.StatisticsRepository;\n+\n+@Service\n+public class StatisticsService {\n+\n+    private final StatisticsRepository statisticsRepository;\n+\n+    public StatisticsService(StatisticsRepository statisticsRepository) {\n+        this.statisticsRepository = statisticsRepository;\n+    }\n+\n+    public Integer getLoggedInUsers(Long span) {\n+        return this.statisticsRepository.getLoggedInUsers(ZonedDateTime.now().minusDays(span).toInstant());\n+    }\n+\n+    public Integer getActiveUsers(Long span) {\n+        return this.statisticsRepository.getActiveUsers(ZonedDateTime.now().minusDays(span));\n+    }\n+\n+    /**\n+     * Forwards the request to the repository, which returns a List<Map<String, Object>>, with String being the column name, \"day\" and \"amount\" and Object being the value,\n+     * either the date or the amount of submissions. It then collects the amounts in an array, depending on the span value, and returns it\n+     *\n+     * @param span DAY,WEEK,MONTH or YEAR depending on the active tab in the view\n+     * @return a array, containing the values for each bar in the graph\n+     */\n+    public Integer[] getTotalSubmissions(String span) {\n+        switch (span) {\n+            case \"DAY\": // result = this.statisticsRepository.getTotalSubmissionsDay(ZonedDateTime.now().minusDays(7));\n+                return null;\n+            case \"WEEK\":\n+                Integer[] result = new Integer[7];\n+                Arrays.fill(result, 0);\n+                ZonedDateTime border = ZonedDateTime.now().minusDays(6).withHour(0).withMinute(0).withSecond(0);\n+                List<Map<String, Object>> outcome = this.statisticsRepository.getTotalSubmissionsWeek(border);\n+                for (Map<String, Object> map : outcome) {\n+                    ZonedDateTime date = (ZonedDateTime) map.get(\"day\");\n+                    Integer amount = map.get(\"amount\") != null ? ((Long) map.get(\"amount\")).intValue() : null;\n+                    for (int i = 0; i < 7; i++) {\n+                        if (date.getDayOfMonth() == ZonedDateTime.now().minusDays(i).getDayOfMonth()) {\n+                            result[6 - i] += amount;\n+                        }\n+                    }\n+                }\n+                return result;\n+            case \"MONTH\":\n+                return null;\n+            case \"YEAR\":\n+                return null;\n+            default:\n+                return null;\n+        }\n+    }\n+\n+    public Integer getReleasedExercises(Long span) {\n+        return this.statisticsRepository.getReleasedExercises(ZonedDateTime.now().minusDays(span), ZonedDateTime.now());\n+    }\n+\n+    public Integer getExerciseDeadlines(Long span) {\n+        return this.statisticsRepository.getExerciseDeadlines(ZonedDateTime.now().minusDays(span), ZonedDateTime.now());\n+    }\n+\n+    public Integer getConductedExams(Long span) {\n+        return this.statisticsRepository.getConductedExams(ZonedDateTime.now().minusDays(span), ZonedDateTime.now());\n+    }\n+\n+    public Integer getExamParticipations(Long span) {\n+        return this.statisticsRepository.getExamParticipations(ZonedDateTime.now().minusDays(span));\n+    }\n+\n+    public Integer getExamRegistrations(Long span) {\n+        return this.statisticsRepository.getExamRegistrations(ZonedDateTime.now().minusDays(span), ZonedDateTime.now());\n+    }\n+\n+    public Integer getActiveTutors(Long span) {\n+        return this.statisticsRepository.getActiveTutors(ZonedDateTime.now().minusDays(span));\n+    }\n+\n+    public Integer getCreatedResults(Long span) {\n+        return this.statisticsRepository.getCreatedResults(ZonedDateTime.now().minusDays(span));\n+    }\n+\n+    public Integer getResultFeedbacks(Long span) {\n+        Integer result = this.statisticsRepository.getResultFeedbacks(ZonedDateTime.now().minusDays(span));\n+        return (result != null ? result : 0);", "originalCommit": "ac7257d174ed321c706cf7f8a28037403a3871ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjM1OQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532056359", "bodyText": "Done", "author": "FuchsDominik", "createdAt": "2020-11-28T16:13:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAzNTYyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAzNTcxMw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532035713", "bodyText": "Just name it StatisticsComponent", "author": "fde312", "createdAt": "2020-11-28T12:39:34Z", "path": "src/main/webapp/app/admin/statistics/statistics.component.ts", "diffHunk": "@@ -0,0 +1,178 @@\n+import { Component, OnInit, OnChanges, ViewChild } from '@angular/core';\n+import { StatisticsService } from 'app/admin/statistics/statistics.service';\n+import { SPAN_PATTERN } from 'app/app.constants';\n+import { ChartDataSets, ChartOptions, ChartType } from 'chart.js';\n+import { BaseChartDirective, Label } from 'ng2-charts';\n+import { DataSet } from 'app/exercises/quiz/manage/statistics/quiz-statistic/quiz-statistic.component';\n+import { TranslateService } from '@ngx-translate/core';\n+import * as moment from 'moment';\n+\n+export enum SpanType {\n+    DAY = 'DAY',\n+    WEEK = 'WEEK',\n+    MONTH = 'MONTH',\n+    YEAR = 'YEAR',\n+}\n+\n+@Component({\n+    selector: 'jhi-statistics',\n+    templateUrl: './statistics.component.html',\n+})\n+export class JhiStatisticsComponent implements OnInit, OnChanges {", "originalCommit": "ac7257d174ed321c706cf7f8a28037403a3871ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjM0MA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532056340", "bodyText": "Done", "author": "FuchsDominik", "createdAt": "2020-11-28T16:13:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjAzNTcxMw=="}], "type": "inlineReview"}, {"oid": "499bb9fd70d8f4710fe3744189d0493f61a8db7d", "url": "https://github.com/ls1intum/Artemis/commit/499bb9fd70d8f4710fe3744189d0493f61a8db7d", "message": "Integrate Code Reviews", "committedDate": "2020-11-28T16:09:13Z", "type": "commit"}, {"oid": "0c261e7ea86df36f0fc1d13f0ac96f1864a3046a", "url": "https://github.com/ls1intum/Artemis/commit/0c261e7ea86df36f0fc1d13f0ac96f1864a3046a", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into feature/user-statistics", "committedDate": "2020-11-28T16:10:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjUwOTc1NA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532509754", "bodyText": "You could probably change this to 'api/management/statistics/' and adjust the other urls.", "author": "sjagla27", "createdAt": "2020-11-30T10:56:38Z", "path": "src/main/webapp/app/admin/statistics/statistics.service.ts", "diffHunk": "@@ -0,0 +1,100 @@\n+import { Injectable } from '@angular/core';\n+import { HttpClient, HttpParams } from '@angular/common/http';\n+import { Observable } from 'rxjs/Observable';\n+import { SERVER_API_URL } from 'app/app.constants';\n+import { SpanType } from 'app/entities/statistics.model';\n+\n+@Injectable({ providedIn: 'root' })\n+export class StatisticsService {\n+    private resourceUrl = SERVER_API_URL + 'api/';", "originalCommit": "0c261e7ea86df36f0fc1d13f0ac96f1864a3046a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjUzMzc4Mg==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532533782", "bodyText": "Done", "author": "FuchsDominik", "createdAt": "2020-11-30T11:39:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjUwOTc1NA=="}], "type": "inlineReview"}, {"oid": "26c304b14d682a3ce150db83b5a908274b647375", "url": "https://github.com/ls1intum/Artemis/commit/26c304b14d682a3ce150db83b5a908274b647375", "message": "refactor REST call url", "committedDate": "2020-11-30T11:37:49Z", "type": "commit"}, {"oid": "93880c069ec7d455857ded7e074f90b4f68e2720", "url": "https://github.com/ls1intum/Artemis/commit/93880c069ec7d455857ded7e074f90b4f68e2720", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into feature/user-statistics", "committedDate": "2020-11-30T11:38:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyNTI1Ng==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532625256", "bodyText": "Could you please reformat the querys using Java 13 Textblocks? See: https://thorben-janssen.com/java-text-blocks-hibernate-jpa/\nIt makes them much nicer to read imo :)\nConcerns all querys", "author": "stefanwaldhauser", "createdAt": "2020-11-30T14:12:44Z", "path": "src/main/java/de/tum/in/www1/artemis/repository/StatisticsRepository.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package de.tum.in.www1.artemis.repository;\n+\n+import java.time.Instant;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.data.jpa.repository.JpaRepository;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+import org.springframework.stereotype.Repository;\n+\n+import de.tum.in.www1.artemis.domain.User;\n+\n+/**\n+ * Spring Data JPA repository for the user statistics\n+ */\n+@Repository\n+public interface StatisticsRepository extends JpaRepository<User, Long> {\n+\n+    @Query(\"select count(distinct u.login) from User u, PersistentAuditEvent p where u.login like p.principal and p.auditEventType = 'AUTHENTICATION_SUCCESS' and u.login not like '%test%' and p.auditEventDate >= :#{#span}\")", "originalCommit": "93880c069ec7d455857ded7e074f90b4f68e2720", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc4NjAxNA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532786014", "bodyText": "Thanks for the hint, done", "author": "FuchsDominik", "createdAt": "2020-11-30T17:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyNTI1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyNzg5MA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532627890", "bodyText": "The parameters are named a little bit confusing. Maybe something like startInclusive and endInclusive? Concerns all querys", "author": "stefanwaldhauser", "createdAt": "2020-11-30T14:16:24Z", "path": "src/main/java/de/tum/in/www1/artemis/repository/StatisticsRepository.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package de.tum.in.www1.artemis.repository;\n+\n+import java.time.Instant;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.data.jpa.repository.JpaRepository;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+import org.springframework.stereotype.Repository;\n+\n+import de.tum.in.www1.artemis.domain.User;\n+\n+/**\n+ * Spring Data JPA repository for the user statistics\n+ */\n+@Repository\n+public interface StatisticsRepository extends JpaRepository<User, Long> {\n+\n+    @Query(\"select count(distinct u.login) from User u, PersistentAuditEvent p where u.login like p.principal and p.auditEventType = 'AUTHENTICATION_SUCCESS' and u.login not like '%test%' and p.auditEventDate >= :#{#span}\")\n+    Integer getLoggedInUsers(@Param(\"span\") Instant span);\n+\n+    @Query(\"select count(distinct u.login) from User u, Submission s, StudentParticipation p where s.participation.id = p.id and p.student.id = u.id and s.submissionDate >= :#{#span} and u.login not like '%test%'\")\n+    Integer getActiveUsers(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select count(sub.id) from Submission sub where sub.submissionDate >= :#{#span}\")\n+    Integer getTotalSubmissions(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"select count(e.id) from Exercise e where e.releaseDate >= :#{#span} and e.releaseDate <= :#{#now}\")\n+    Integer getReleasedExercises(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);", "originalCommit": "93880c069ec7d455857ded7e074f90b4f68e2720", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc4NjM5MA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532786390", "bodyText": "Thanks for the hint, adjusted the relevant query", "author": "FuchsDominik", "createdAt": "2020-11-30T17:51:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyNzg5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYzMzYzMQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532633631", "bodyText": "As far as I can see all the querys here query for something in certain range (from dateA to dateB), but sometimes you use only one parameter, and sometimes you use two parameters. Could you maybe rewrite the querys to always use two parameters? IMO it makes them easier to understand because I can clearly see: \"this gets the logged in users from data A to data B\" and the querys become more useful as i can input any timeframe i want", "author": "stefanwaldhauser", "createdAt": "2020-11-30T14:24:25Z", "path": "src/main/java/de/tum/in/www1/artemis/repository/StatisticsRepository.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package de.tum.in.www1.artemis.repository;\n+\n+import java.time.Instant;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.data.jpa.repository.JpaRepository;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+import org.springframework.stereotype.Repository;\n+\n+import de.tum.in.www1.artemis.domain.User;\n+\n+/**\n+ * Spring Data JPA repository for the user statistics\n+ */\n+@Repository\n+public interface StatisticsRepository extends JpaRepository<User, Long> {\n+\n+    @Query(\"select count(distinct u.login) from User u, PersistentAuditEvent p where u.login like p.principal and p.auditEventType = 'AUTHENTICATION_SUCCESS' and u.login not like '%test%' and p.auditEventDate >= :#{#span}\")\n+    Integer getLoggedInUsers(@Param(\"span\") Instant span);", "originalCommit": "93880c069ec7d455857ded7e074f90b4f68e2720", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYzNDAxMQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532634011", "bodyText": "Also maybe rename the methods to something more clearer like countNumberOfLoggedInUsers, so it is more clear from the method name what the quer does", "author": "stefanwaldhauser", "createdAt": "2020-11-30T14:24:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYzMzYzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxMDczMQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532710731", "bodyText": "Yes, sorry, like mentioned in the PR description, this is deprecated code which will be refactored after this PR and is just here for semantic purposes.", "author": "FuchsDominik", "createdAt": "2020-11-30T16:06:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYzMzYzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDgxMzkyNA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r534813924", "bodyText": "I was also very confused until I read @stefanwaldhauser's comment. If the code is going to be refactored and deprecated it might be a good idea to add a comment above the method and mention that. Just to not confuse others.\nIt's just a suggestion, otherwise just resolve this conversation again :)", "author": "ivanchimeno", "createdAt": "2020-12-03T07:32:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYzMzYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYzNjE3MA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532636170", "bodyText": "Why are you not using the Enum here?", "author": "stefanwaldhauser", "createdAt": "2020-11-30T14:28:01Z", "path": "src/main/java/de/tum/in/www1/artemis/service/StatisticsService.java", "diffHunk": "@@ -0,0 +1,95 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.time.ZonedDateTime;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.repository.StatisticsRepository;\n+\n+@Service\n+public class StatisticsService {\n+\n+    private final StatisticsRepository statisticsRepository;\n+\n+    public StatisticsService(StatisticsRepository statisticsRepository) {\n+        this.statisticsRepository = statisticsRepository;\n+    }\n+\n+    public Integer getLoggedInUsers(Long span) {\n+        return this.statisticsRepository.getLoggedInUsers(ZonedDateTime.now().minusDays(span).toInstant());\n+    }\n+\n+    public Integer getActiveUsers(Long span) {\n+        return this.statisticsRepository.getActiveUsers(ZonedDateTime.now().minusDays(span));\n+    }\n+\n+    /**\n+     * Forwards the request to the repository, which returns a List<Map<String, Object>>, with String being the column name, \"day\" and \"amount\" and Object being the value,\n+     * either the date or the amount of submissions. It then collects the amounts in an array, depending on the span value, and returns it\n+     *\n+     * @param span DAY,WEEK,MONTH or YEAR depending on the active tab in the view\n+     * @return a array, containing the values for each bar in the graph\n+     */\n+    public Integer[] getTotalSubmissions(String span) {", "originalCommit": "93880c069ec7d455857ded7e074f90b4f68e2720", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc4Njg3MA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532786870", "bodyText": "Good catch, done", "author": "FuchsDominik", "createdAt": "2020-11-30T17:51:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYzNjE3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYzNjUyNw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532636527", "bodyText": "The parameter name span confuses me here. It is not the span you defined in the enum? It looks to be just a number of days", "author": "stefanwaldhauser", "createdAt": "2020-11-30T14:28:32Z", "path": "src/main/java/de/tum/in/www1/artemis/service/StatisticsService.java", "diffHunk": "@@ -0,0 +1,95 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.time.ZonedDateTime;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.repository.StatisticsRepository;\n+\n+@Service\n+public class StatisticsService {\n+\n+    private final StatisticsRepository statisticsRepository;\n+\n+    public StatisticsService(StatisticsRepository statisticsRepository) {\n+        this.statisticsRepository = statisticsRepository;\n+    }\n+\n+    public Integer getLoggedInUsers(Long span) {", "originalCommit": "93880c069ec7d455857ded7e074f90b4f68e2720", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcwOTM5MA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532709390", "bodyText": "Yes, sorry, like mentioned in the PR description, this is deprecated code which will be refactored after this PR and is just here for semantic purposes.", "author": "FuchsDominik", "createdAt": "2020-11-30T16:04:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYzNjUyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYzNzgxNw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532637817", "bodyText": "This does not what I would expect. If I click on the week tab i would expect it to show me the values for THIS week and not just go back 7 days, same for month and so on. I mean if it currently wednesday I expect it to show me the values for monday, tuesday and wednesday. Does anybody else have an opinion here? Or you have to rename the client to something like Last 7 Days Last 30 Days", "author": "stefanwaldhauser", "createdAt": "2020-11-30T14:30:20Z", "path": "src/main/java/de/tum/in/www1/artemis/service/StatisticsService.java", "diffHunk": "@@ -0,0 +1,95 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.time.ZonedDateTime;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.repository.StatisticsRepository;\n+\n+@Service\n+public class StatisticsService {\n+\n+    private final StatisticsRepository statisticsRepository;\n+\n+    public StatisticsService(StatisticsRepository statisticsRepository) {\n+        this.statisticsRepository = statisticsRepository;\n+    }\n+\n+    public Integer getLoggedInUsers(Long span) {\n+        return this.statisticsRepository.getLoggedInUsers(ZonedDateTime.now().minusDays(span).toInstant());\n+    }\n+\n+    public Integer getActiveUsers(Long span) {\n+        return this.statisticsRepository.getActiveUsers(ZonedDateTime.now().minusDays(span));\n+    }\n+\n+    /**\n+     * Forwards the request to the repository, which returns a List<Map<String, Object>>, with String being the column name, \"day\" and \"amount\" and Object being the value,\n+     * either the date or the amount of submissions. It then collects the amounts in an array, depending on the span value, and returns it\n+     *\n+     * @param span DAY,WEEK,MONTH or YEAR depending on the active tab in the view\n+     * @return a array, containing the values for each bar in the graph\n+     */\n+    public Integer[] getTotalSubmissions(String span) {\n+        switch (span) {\n+            case \"DAY\": // result = this.statisticsRepository.getTotalSubmissionsDay(ZonedDateTime.now().minusDays(7));\n+                return null;\n+            case \"WEEK\":\n+                Integer[] result = new Integer[7];\n+                Arrays.fill(result, 0);\n+                ZonedDateTime border = ZonedDateTime.now().minusDays(6).withHour(0).withMinute(0).withSecond(0);", "originalCommit": "93880c069ec7d455857ded7e074f90b4f68e2720", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxNjg1NQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532716855", "bodyText": "Yes this is a debatable issue. However, I orientate myself roughly on the Apple Health App, which also displays the last 7/30 etc. days. Plus it displays more information, especially if its Monday and there is no data yet, this seems a bit weird IMO", "author": "FuchsDominik", "createdAt": "2020-11-30T16:13:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYzNzgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0MTU3Nw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532641577", "bodyText": "why are you not using the enum here?", "author": "stefanwaldhauser", "createdAt": "2020-11-30T14:35:36Z", "path": "src/main/webapp/app/admin/statistics/statistics.component.ts", "diffHunk": "@@ -0,0 +1,165 @@\n+import { Component, OnInit, OnChanges, ViewChild } from '@angular/core';\n+import { StatisticsService } from 'app/admin/statistics/statistics.service';\n+import { SPAN_PATTERN } from 'app/app.constants';\n+import { ChartDataSets, ChartOptions, ChartType } from 'chart.js';\n+import { BaseChartDirective, Label } from 'ng2-charts';\n+import { DataSet } from 'app/exercises/quiz/manage/statistics/quiz-statistic/quiz-statistic.component';\n+import { TranslateService } from '@ngx-translate/core';\n+import * as moment from 'moment';\n+import { SpanType } from 'app/entities/statistics.model';\n+\n+@Component({\n+    selector: 'jhi-statistics',\n+    templateUrl: './statistics.component.html',\n+})\n+export class StatisticsComponent implements OnInit, OnChanges {\n+    spanPattern = SPAN_PATTERN;\n+    span: SpanType = SpanType.WEEK;\n+\n+    // Histogram related properties\n+    public histogramData: number[] = [];\n+    public barChartOptions: ChartOptions = {};\n+    public barChartLabels: Label[] = [];\n+    public barChartType: ChartType = 'bar';\n+    public barChartLegend = true;\n+    public UserLoginChartData: ChartDataSets[] = [];\n+    public SubmissionsChartData: ChartDataSets[] = [];\n+\n+    @ViewChild(BaseChartDirective) chart: BaseChartDirective;\n+\n+    constructor(private service: StatisticsService, private translateService: TranslateService) {}\n+\n+    async ngOnInit() {\n+        await this.setBinWidth();\n+        await this.createChart();\n+    }\n+\n+    async ngOnChanges() {}\n+\n+    private async setBinWidth(): Promise<void> {\n+        switch (this.span) {\n+            case SpanType.DAY:\n+                this.histogramData = Array(24).fill(0);\n+                break;\n+            case SpanType.WEEK:\n+                this.histogramData = Array(7).fill(0);\n+                break;\n+            case SpanType.MONTH:\n+                this.histogramData = Array(moment().daysInMonth()).fill(0);\n+                break;\n+            case SpanType.YEAR:\n+                this.histogramData = Array(12).fill(0);\n+                break;\n+        }\n+    }\n+\n+    async getSubmissions(): Promise<number[]> {\n+        return new Promise<number[]>((resolve, reject) => {\n+            this.service.getTotalSubmissions(this.span).subscribe((res: number[]) => {\n+                if (res !== null) {\n+                    resolve(res);\n+                } else {\n+                    reject('Submissions could not get fetched');\n+                }\n+            });\n+        });\n+    }\n+\n+    onTabChanged(span: string): void {", "originalCommit": "93880c069ec7d455857ded7e074f90b4f68e2720", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2MDIxOA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532760218", "bodyText": "As we dont use Enums in the .html file, the method gets a String passed", "author": "FuchsDominik", "createdAt": "2020-11-30T17:12:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0MTU3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0MjA4OA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532642088", "bodyText": "You should support both english and german", "author": "stefanwaldhauser", "createdAt": "2020-11-30T14:36:15Z", "path": "src/main/webapp/app/admin/statistics/statistics.component.ts", "diffHunk": "@@ -0,0 +1,165 @@\n+import { Component, OnInit, OnChanges, ViewChild } from '@angular/core';\n+import { StatisticsService } from 'app/admin/statistics/statistics.service';\n+import { SPAN_PATTERN } from 'app/app.constants';\n+import { ChartDataSets, ChartOptions, ChartType } from 'chart.js';\n+import { BaseChartDirective, Label } from 'ng2-charts';\n+import { DataSet } from 'app/exercises/quiz/manage/statistics/quiz-statistic/quiz-statistic.component';\n+import { TranslateService } from '@ngx-translate/core';\n+import * as moment from 'moment';\n+import { SpanType } from 'app/entities/statistics.model';\n+\n+@Component({\n+    selector: 'jhi-statistics',\n+    templateUrl: './statistics.component.html',\n+})\n+export class StatisticsComponent implements OnInit, OnChanges {\n+    spanPattern = SPAN_PATTERN;\n+    span: SpanType = SpanType.WEEK;\n+\n+    // Histogram related properties\n+    public histogramData: number[] = [];\n+    public barChartOptions: ChartOptions = {};\n+    public barChartLabels: Label[] = [];\n+    public barChartType: ChartType = 'bar';\n+    public barChartLegend = true;\n+    public UserLoginChartData: ChartDataSets[] = [];\n+    public SubmissionsChartData: ChartDataSets[] = [];\n+\n+    @ViewChild(BaseChartDirective) chart: BaseChartDirective;\n+\n+    constructor(private service: StatisticsService, private translateService: TranslateService) {}\n+\n+    async ngOnInit() {\n+        await this.setBinWidth();\n+        await this.createChart();\n+    }\n+\n+    async ngOnChanges() {}\n+\n+    private async setBinWidth(): Promise<void> {\n+        switch (this.span) {\n+            case SpanType.DAY:\n+                this.histogramData = Array(24).fill(0);\n+                break;\n+            case SpanType.WEEK:\n+                this.histogramData = Array(7).fill(0);\n+                break;\n+            case SpanType.MONTH:\n+                this.histogramData = Array(moment().daysInMonth()).fill(0);\n+                break;\n+            case SpanType.YEAR:\n+                this.histogramData = Array(12).fill(0);\n+                break;\n+        }\n+    }\n+\n+    async getSubmissions(): Promise<number[]> {\n+        return new Promise<number[]>((resolve, reject) => {\n+            this.service.getTotalSubmissions(this.span).subscribe((res: number[]) => {\n+                if (res !== null) {\n+                    resolve(res);\n+                } else {\n+                    reject('Submissions could not get fetched');\n+                }\n+            });\n+        });\n+    }\n+\n+    onTabChanged(span: string): void {\n+        switch (span) {\n+            case 'Day':\n+                this.span = SpanType.DAY;\n+                break;\n+            case 'Week':\n+                this.span = SpanType.WEEK;\n+                break;\n+            case 'Month':\n+                this.span = SpanType.MONTH;\n+                break;\n+            case 'Year':\n+                this.span = SpanType.YEAR;\n+                break;\n+        }\n+    }\n+\n+    private getWeekdays(): string[] {\n+        const days: string[] = [];\n+\n+        for (let i = 0; i < 7; i++) {\n+            days.push(\n+                moment()\n+                    .subtract(6 - i, 'd')\n+                    .format('dddd'),\n+            );\n+        }\n+        return days;\n+    }\n+\n+    private createLabels(): string[] {\n+        let labels: string[] = [];\n+        switch (this.span) {\n+            case SpanType.DAY:\n+                for (let i = 0; i < this.histogramData.length; i++) {\n+                    labels[i] = `${i}:00,${i + 1}:00`;\n+                }\n+                break;\n+            case SpanType.WEEK:\n+                labels = this.getWeekdays();\n+                break;\n+            case SpanType.MONTH:\n+                for (let i = 0; i < this.histogramData.length; i++) {\n+                    labels[i] = i + 1 + '';\n+                }\n+                break;\n+            case SpanType.YEAR:\n+                labels = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];", "originalCommit": "93880c069ec7d455857ded7e074f90b4f68e2720", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc4NzgzMQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532787831", "bodyText": "Now does :)", "author": "FuchsDominik", "createdAt": "2020-11-30T17:53:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0MjA4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0MzgwOA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532643808", "bodyText": "getNumberOfReleasedExercises and so on :)", "author": "stefanwaldhauser", "createdAt": "2020-11-30T14:38:40Z", "path": "src/main/webapp/app/admin/statistics/statistics.service.ts", "diffHunk": "@@ -0,0 +1,100 @@\n+import { Injectable } from '@angular/core';\n+import { HttpClient, HttpParams } from '@angular/common/http';\n+import { Observable } from 'rxjs/Observable';\n+import { SERVER_API_URL } from 'app/app.constants';\n+import { SpanType } from 'app/entities/statistics.model';\n+\n+@Injectable({ providedIn: 'root' })\n+export class StatisticsService {\n+    private resourceUrl = SERVER_API_URL + 'api/management/statistics/';\n+\n+    constructor(private http: HttpClient) {}\n+\n+    /**\n+     * Sends a GET request to retrieve the amount of logged in users in the last *span* days\n+     */\n+    getloggedUsers(span: number): Observable<number> {\n+        const params = new HttpParams().set('span', '' + span);\n+        return this.http.get<number>(`${this.resourceUrl}users`, { params });\n+    }\n+\n+    /**\n+     * Sends a GET request to retrieve the amount of users with an submission in the last *span* days\n+     */\n+    getActiveUsers(span: number): Observable<number> {\n+        const params = new HttpParams().set('span', '' + span);\n+        return this.http.get<number>(`${this.resourceUrl}activeUsers`, { params });\n+    }\n+\n+    /**\n+     * Sends a GET request to retrieve the amount of submissions made in the last *span* days\n+     */\n+    getTotalSubmissions(span: SpanType): Observable<number[]> {\n+        const params = new HttpParams().set('span', '' + span);\n+        return this.http.get<number[]>(`${this.resourceUrl}submissions`, { params });\n+    }\n+\n+    /**\n+     * Sends a GET request to retrieve the amount of released exercises in the last *span* days\n+     */\n+    getReleasedExercises(span: number): Observable<number> {", "originalCommit": "93880c069ec7d455857ded7e074f90b4f68e2720", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxNzU1Mw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532717553", "bodyText": "Yes, sorry, this is also deprecated code which will be refactored after this PR and ist just here for semantic purposes.", "author": "FuchsDominik", "createdAt": "2020-11-30T16:14:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY0MzgwOA=="}], "type": "inlineReview"}, {"oid": "ea28fa7ce583b5250cde3499d6659b38eb254195", "url": "https://github.com/ls1intum/Artemis/commit/ea28fa7ce583b5250cde3499d6659b38eb254195", "message": "Address Stefan's comments", "committedDate": "2020-11-30T17:48:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwNjIwMg==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532806202", "bodyText": "This doesn't use the text-block style yet.", "author": "FrankeLukas", "createdAt": "2020-11-30T18:23:05Z", "path": "src/main/java/de/tum/in/www1/artemis/repository/StatisticsRepository.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package de.tum.in.www1.artemis.repository;\n+\n+import java.time.Instant;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.data.jpa.repository.JpaRepository;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+import org.springframework.stereotype.Repository;\n+\n+import de.tum.in.www1.artemis.domain.User;\n+\n+/**\n+ * Spring Data JPA repository for the user statistics\n+ */\n+@Repository\n+public interface StatisticsRepository extends JpaRepository<User, Long> {\n+\n+    @Query(\"select count(distinct u.login) from User u, PersistentAuditEvent p where u.login like p.principal and p.auditEventType = 'AUTHENTICATION_SUCCESS' and u.login not like '%test%' and p.auditEventDate >= :#{#span}\")", "originalCommit": "ea28fa7ce583b5250cde3499d6659b38eb254195", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwOTIxMg==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532809212", "bodyText": "Thanks, done", "author": "FuchsDominik", "createdAt": "2020-11-30T18:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwNjIwMg=="}], "type": "inlineReview"}, {"oid": "366a0ca658674e94cb50c2a87b3660bdc387288e", "url": "https://github.com/ls1intum/Artemis/commit/366a0ca658674e94cb50c2a87b3660bdc387288e", "message": "fix missing Text-block style", "committedDate": "2020-11-30T18:26:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgzMjI4OA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532832288", "bodyText": "This one is not formatted like the rest is.", "author": "sjagla27", "createdAt": "2020-11-30T19:07:05Z", "path": "src/main/java/de/tum/in/www1/artemis/repository/StatisticsRepository.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package de.tum.in.www1.artemis.repository;\n+\n+import java.time.Instant;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.data.jpa.repository.JpaRepository;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+import org.springframework.stereotype.Repository;\n+\n+import de.tum.in.www1.artemis.domain.User;\n+\n+/**\n+ * Spring Data JPA repository for the user statistics\n+ */\n+@Repository\n+public interface StatisticsRepository extends JpaRepository<User, Long> {\n+\n+    @Query(\"\"\"\n+            select count(distinct u.login)\n+            from User u, PersistentAuditEvent p\n+            where u.login like p.principal and p.auditEventType = 'AUTHENTICATION_SUCCESS' and u.login not like '%test%' and p.auditEventDate >= :#{#span}\n+            \"\"\")\n+    Integer getLoggedInUsers(@Param(\"span\") Instant span);\n+\n+    @Query(\"\"\"\n+            select count(distinct u.login)\n+            from User u, Submission s, StudentParticipation p\n+            where s.participation.id = p.id and p.student.id = u.id and s.submissionDate >= :#{#span} and u.login not like '%test%'\n+            \"\"\")\n+    Integer getActiveUsers(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"\"\"\n+            select count(e.id)\n+            from Exercise e\n+            where e.releaseDate >= :#{#span} and e.releaseDate <= :#{#now}\n+            \"\"\")\n+    Integer getReleasedExercises(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"\"\"\n+            select count(e.id)\n+            from Exercise e\n+            where e.dueDate >= :#{#span} and e.dueDate <= :#{#now}\n+            \"\"\")\n+    Integer getExerciseDeadlines(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"\"\"\n+            select count(e.id) from Exam e where e.endDate >= :#{#span} and e.endDate <= :#{#now}", "originalCommit": "366a0ca658674e94cb50c2a87b3660bdc387288e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgzNzIyNw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r532837227", "bodyText": "Done", "author": "FuchsDominik", "createdAt": "2020-11-30T19:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgzMjI4OA=="}], "type": "inlineReview"}, {"oid": "098393562c8ad4db3f03a38571867afd437fe9e8", "url": "https://github.com/ls1intum/Artemis/commit/098393562c8ad4db3f03a38571867afd437fe9e8", "message": "fix missing Text-block style", "committedDate": "2020-11-30T19:14:42Z", "type": "commit"}, {"oid": "f6e30d7546138808db3176d23669807099621dc0", "url": "https://github.com/ls1intum/Artemis/commit/f6e30d7546138808db3176d23669807099621dc0", "message": "Implemented YEAR, MONTH and DAY and refactoring of client side", "committedDate": "2020-12-01T17:19:11Z", "type": "commit"}, {"oid": "1d6534697b753b439a60ab864f3f78ebf93d9d58", "url": "https://github.com/ls1intum/Artemis/commit/1d6534697b753b439a60ab864f3f78ebf93d9d58", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into feature/user-statistics", "committedDate": "2020-12-01T17:19:46Z", "type": "commit"}, {"oid": "c556e9eb255b463d67da7525fb68dae1a7eb6723", "url": "https://github.com/ls1intum/Artemis/commit/c556e9eb255b463d67da7525fb68dae1a7eb6723", "message": "active tab adjustments", "committedDate": "2020-12-01T18:16:10Z", "type": "commit"}, {"oid": "06bde3aba39bf8a3d41d40b5feb72f06842389cc", "url": "https://github.com/ls1intum/Artemis/commit/06bde3aba39bf8a3d41d40b5feb72f06842389cc", "message": "removed unused Pattern and refactor URL", "committedDate": "2020-12-02T09:59:22Z", "type": "commit"}, {"oid": "892b65635224eff5ea01fe1f44eea001bed827e2", "url": "https://github.com/ls1intum/Artemis/commit/892b65635224eff5ea01fe1f44eea001bed827e2", "message": "Merge branch 'develop' of https://github.com/ls1intum/Artemis into feature/user-statistics", "committedDate": "2020-12-02T09:59:36Z", "type": "commit"}, {"oid": "e437e19987e1db86f8be8026923a1d1be3b8099d", "url": "https://github.com/ls1intum/Artemis/commit/e437e19987e1db86f8be8026923a1d1be3b8099d", "message": "remove unused pattern", "committedDate": "2020-12-02T10:18:05Z", "type": "commit"}, {"oid": "c28777a4b7e9277e90cd36e2c8393421b7fad135", "url": "https://github.com/ls1intum/Artemis/commit/c28777a4b7e9277e90cd36e2c8393421b7fad135", "message": "set graph min, refactor server side", "committedDate": "2020-12-02T13:00:27Z", "type": "commit"}, {"oid": "d94ad86f5471576bf5fd0bdc7ed3479cd84a49fb", "url": "https://github.com/ls1intum/Artemis/commit/d94ad86f5471576bf5fd0bdc7ed3479cd84a49fb", "message": "refactoring", "committedDate": "2020-12-02T14:12:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDgxODY1MQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r534818651", "bodyText": "Might be better to rename this to something like getActiveUserCount?", "author": "ivanchimeno", "createdAt": "2020-12-03T07:35:29Z", "path": "src/main/java/de/tum/in/www1/artemis/repository/StatisticsRepository.java", "diffHunk": "@@ -0,0 +1,109 @@\n+package de.tum.in.www1.artemis.repository;\n+\n+import java.time.Instant;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.data.jpa.repository.JpaRepository;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+import org.springframework.stereotype.Repository;\n+\n+import de.tum.in.www1.artemis.domain.User;\n+\n+/**\n+ * Spring Data JPA repository for the user statistics\n+ */\n+@Repository\n+public interface StatisticsRepository extends JpaRepository<User, Long> {\n+\n+    @Query(\"\"\"\n+            select count(distinct u.login)\n+            from User u, PersistentAuditEvent p\n+            where u.login like p.principal and p.auditEventType = 'AUTHENTICATION_SUCCESS' and u.login not like '%test%' and p.auditEventDate >= :#{#span}\n+            \"\"\")\n+    Integer getLoggedInUsers(@Param(\"span\") Instant span);\n+\n+    @Query(\"\"\"\n+            select count(distinct u.login)\n+            from User u, Submission s, StudentParticipation p\n+            where s.participation.id = p.id and p.student.id = u.id and s.submissionDate >= :#{#span} and u.login not like '%test%'\n+            \"\"\")\n+    Integer getActiveUsers(@Param(\"span\") ZonedDateTime span);", "originalCommit": "d94ad86f5471576bf5fd0bdc7ed3479cd84a49fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDgyMzgzNg==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r534823836", "bodyText": "Or maybe \"active\" is the wrong word here since the query returns users that have submitted something from a given date.", "author": "ivanchimeno", "createdAt": "2020-12-03T07:38:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDgxODY1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3MzI0Ng==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r535473246", "bodyText": "This deprecated code, i really should have marked it somehow, sorry. I will refactor most of the server side code.", "author": "FuchsDominik", "createdAt": "2020-12-03T18:19:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDgxODY1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDgyNzQ5NQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r534827495", "bodyText": "Why does the method name contain \"yesterday\" when there are date range parameters?", "author": "ivanchimeno", "createdAt": "2020-12-03T07:41:04Z", "path": "src/main/java/de/tum/in/www1/artemis/repository/StatisticsRepository.java", "diffHunk": "@@ -0,0 +1,109 @@\n+package de.tum.in.www1.artemis.repository;\n+\n+import java.time.Instant;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.data.jpa.repository.JpaRepository;\n+import org.springframework.data.jpa.repository.Query;\n+import org.springframework.data.repository.query.Param;\n+import org.springframework.stereotype.Repository;\n+\n+import de.tum.in.www1.artemis.domain.User;\n+\n+/**\n+ * Spring Data JPA repository for the user statistics\n+ */\n+@Repository\n+public interface StatisticsRepository extends JpaRepository<User, Long> {\n+\n+    @Query(\"\"\"\n+            select count(distinct u.login)\n+            from User u, PersistentAuditEvent p\n+            where u.login like p.principal and p.auditEventType = 'AUTHENTICATION_SUCCESS' and u.login not like '%test%' and p.auditEventDate >= :#{#span}\n+            \"\"\")\n+    Integer getLoggedInUsers(@Param(\"span\") Instant span);\n+\n+    @Query(\"\"\"\n+            select count(distinct u.login)\n+            from User u, Submission s, StudentParticipation p\n+            where s.participation.id = p.id and p.student.id = u.id and s.submissionDate >= :#{#span} and u.login not like '%test%'\n+            \"\"\")\n+    Integer getActiveUsers(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"\"\"\n+            select count(e.id)\n+            from Exercise e\n+            where e.releaseDate >= :#{#span} and e.releaseDate <= :#{#now}\n+            \"\"\")\n+    Integer getReleasedExercises(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"\"\"\n+            select count(e.id)\n+            from Exercise e\n+            where e.dueDate >= :#{#span} and e.dueDate <= :#{#now}\n+            \"\"\")\n+    Integer getExerciseDeadlines(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"\"\"\n+            select count(e.id)\n+            from Exam e\n+            where e.endDate >= :#{#span} and e.endDate <= :#{#now}\n+            \"\"\")\n+    Integer getConductedExams(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"\"\"\n+            select count(se.id)\n+            from StudentExam se, Exam e\n+            where se.submitted = true and se.exam = e and e.endDate >= :#{#span}\n+            \"\"\")\n+    Integer getExamParticipations(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"\"\"\n+            select sum(e.registeredUsers.size)\n+            from Exam e\n+            where e.endDate >= :#{#span} and e.endDate <= :#{#now}\n+            \"\"\")\n+    Integer getExamRegistrations(@Param(\"span\") ZonedDateTime span, @Param(\"now\") ZonedDateTime now);\n+\n+    @Query(\"\"\"\n+            select count(distinct r.assessor.id)\n+            from Result r\n+            where (r.assessmentType = 'MANUAL' or r.assessmentType = 'SEMI-AUTOMATIC') and r.completionDate >= :#{#span}\n+            \"\"\")\n+    Integer getActiveTutors(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"\"\"\n+            select count(r.id)\n+            from Result r\n+            where r.completionDate >= :#{#span}\n+            \"\"\")\n+    Integer getCreatedResults(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"\"\"\n+            select sum(r.feedbacks.size)\n+            from Result r\n+            where r.completionDate >= :#{#span}\n+            \"\"\")\n+    Integer getResultFeedbacks(@Param(\"span\") ZonedDateTime span);\n+\n+    @Query(\"\"\"\n+            select s.submissionDate as day, count(s.id) as amount\n+            from Submission s\n+            where s.submissionDate > :#{#startDate}\n+            group by s.submissionDate\n+            order by s.submissionDate asc\n+            \"\"\")\n+    List<Map<String, Object>> getTotalSubmissions(ZonedDateTime startDate);\n+\n+    @Query(\"\"\"\n+            select s.submissionDate as day, count(s.id) as amount\n+            from Submission s\n+            where s.submissionDate > :#{#startDate} and s.submissionDate < :#{#endDate}\n+            group by s.submissionDate\n+            order by s.submissionDate asc\n+            \"\"\")\n+    List<Map<String, Object>> getTotalSubmissionsYesterday(ZonedDateTime startDate, ZonedDateTime endDate);", "originalCommit": "d94ad86f5471576bf5fd0bdc7ed3479cd84a49fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3NDQ5Nw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r535474497", "bodyText": "Also deprecated, this was used to extract the submission from yesterday, not needed atm. Will be refactored", "author": "FuchsDominik", "createdAt": "2020-12-03T18:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDgyNzQ5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDgzNDk2MA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r534834960", "bodyText": "Holy that's a really big and complex method. Is there a way to break this down into smaller functions and/or define queries that will do the heavy work for you?", "author": "ivanchimeno", "createdAt": "2020-12-03T07:46:01Z", "path": "src/main/java/de/tum/in/www1/artemis/service/StatisticsService.java", "diffHunk": "@@ -0,0 +1,140 @@\n+package de.tum.in.www1.artemis.service;\n+\n+import java.time.YearMonth;\n+import java.time.ZonedDateTime;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.springframework.stereotype.Service;\n+\n+import de.tum.in.www1.artemis.domain.enumeration.SpanType;\n+import de.tum.in.www1.artemis.repository.StatisticsRepository;\n+\n+@Service\n+public class StatisticsService {\n+\n+    private final StatisticsRepository statisticsRepository;\n+\n+    public StatisticsService(StatisticsRepository statisticsRepository) {\n+        this.statisticsRepository = statisticsRepository;\n+    }\n+\n+    public Integer getLoggedInUsers(Long span) {\n+        return this.statisticsRepository.getLoggedInUsers(ZonedDateTime.now().minusDays(span).toInstant());\n+    }\n+\n+    public Integer getActiveUsers(Long span) {\n+        return this.statisticsRepository.getActiveUsers(ZonedDateTime.now().minusDays(span));\n+    }\n+\n+    /**\n+     * Forwards the request to the repository, which returns a List<Map<String, Object>>, with String being the column name, \"day\" and \"amount\" and Object being the value,\n+     * either the date or the amount of submissions. It then collects the amounts in an array, depending on the span value, and returns it\n+     *\n+     * @param span DAY,WEEK,MONTH or YEAR depending on the active tab in the view\n+     * @return a array, containing the values for each bar in the graph\n+     */\n+    public Integer[] getTotalSubmissions(SpanType span) {", "originalCommit": "d94ad86f5471576bf5fd0bdc7ed3479cd84a49fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDgzNzIzOA==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r534837238", "bodyText": "It's really hard to understand what's happening here. If it's impossible to break this down then I'd suggest writing comments so that developers can understand this quicker.", "author": "ivanchimeno", "createdAt": "2020-12-03T07:47:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDgzNDk2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUyNTAxOQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r535525019", "bodyText": "Yes you are right. It is a pretty complex method due to the fact that every SpanType needs to get handled seperately. I tried to split it up in smaller methods now and commented it in a pretty detailed way. Hope this is better. Done in this commit", "author": "FuchsDominik", "createdAt": "2020-12-03T19:32:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDgzNDk2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg0MjQwMg==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r534842402", "bodyText": "Not really sure here but does Artemis use came case for urls? Wouldn't active-users be a bit better (same goes for the routes defined below)?", "author": "ivanchimeno", "createdAt": "2020-12-03T07:50:02Z", "path": "src/main/java/de/tum/in/www1/artemis/web/rest/StatisticsResource.java", "diffHunk": "@@ -0,0 +1,172 @@\n+package de.tum.in.www1.artemis.web.rest;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.web.bind.annotation.*;\n+\n+import de.tum.in.www1.artemis.domain.enumeration.SpanType;\n+import de.tum.in.www1.artemis.repository.*;\n+import de.tum.in.www1.artemis.service.*;\n+\n+/**\n+ * REST controller for managing user statistics.\n+ */\n+@RestController\n+@RequestMapping(\"/api\")\n+@PreAuthorize(\"hasRole('ADMIN')\")\n+public class StatisticsResource {\n+\n+    private final Logger log = LoggerFactory.getLogger(StatisticsResource.class);\n+\n+    private final StatisticsService service;\n+\n+    public StatisticsResource(StatisticsService service) {\n+        this.service = service;\n+    }\n+\n+    /**\n+     * GET management/statistics/users : get the amount of logged in user in the last \"span\" days.\n+     *\n+     * @param span the period of which the amount should be calculated\n+     * @return the ResponseEntity with status 200 (OK) and the amount of users in body, or status 404 (Not Found)\n+     */\n+    @GetMapping(\"management/statistics/users\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Integer> getloggedUsers(@RequestParam long span) {\n+        log.debug(\"REST request to get user login count in the last {} days\", span);\n+        return ResponseEntity.ok(this.service.getLoggedInUsers(span));\n+    }\n+\n+    /**\n+     * GET management/statistics/activeUsers : get the amount of active users which made a submission in the last \"span\" days.\n+     *\n+     * @param span the period of which the amount should be calculated\n+     * @return the ResponseEntity with status 200 (OK) and the amount of submissions in body, or status 404 (Not Found)\n+     */\n+    @GetMapping(\"management/statistics/activeUsers\")", "originalCommit": "d94ad86f5471576bf5fd0bdc7ed3479cd84a49fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ4NTYwNw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r535485607", "bodyText": "Thats actually true, yes. If its ok, i would change this when i refactor this method. (Which will be soon) Thanks for the tip! The only route actively used right now is \"management/statistics/submission\" which should be fine", "author": "FuchsDominik", "createdAt": "2020-12-03T18:37:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg0MjQwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg0Nzk4Mg==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r534847982", "bodyText": "There is a trick in Angular on how to use enums in HTML templates. You can write something like:\nSpanType = SpanType;\n\nIt creates a private variable that holds your enum so that in the template you can do stuff like SpanType.DAY", "author": "ivanchimeno", "createdAt": "2020-12-03T07:53:13Z", "path": "src/main/webapp/app/admin/statistics/statistics.component.ts", "diffHunk": "@@ -0,0 +1,165 @@\n+import { Component, OnInit, ViewChild } from '@angular/core';\n+import { StatisticsService } from 'app/admin/statistics/statistics.service';\n+import { ChartDataSets, ChartOptions, ChartType } from 'chart.js';\n+import { BaseChartDirective, Label } from 'ng2-charts';\n+import { DataSet } from 'app/exercises/quiz/manage/statistics/quiz-statistic/quiz-statistic.component';\n+import { TranslateService } from '@ngx-translate/core';\n+import * as moment from 'moment';\n+import { SpanType } from 'app/entities/statistics.model';\n+\n+@Component({\n+    selector: 'jhi-statistics',\n+    templateUrl: './statistics.component.html',\n+})\n+export class StatisticsComponent implements OnInit {\n+    DAY = SpanType.DAY;", "originalCommit": "d94ad86f5471576bf5fd0bdc7ed3479cd84a49fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUyMjIzNQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r535522235", "bodyText": "Thanks for the tip! I refactored the code as you suggested in this commit.", "author": "FuchsDominik", "createdAt": "2020-12-03T19:29:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg0Nzk4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg1MzQzMw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r534853433", "bodyText": "Is this the currently active span? If so it's better to rename this.", "author": "ivanchimeno", "createdAt": "2020-12-03T07:56:21Z", "path": "src/main/webapp/app/admin/statistics/statistics.component.ts", "diffHunk": "@@ -0,0 +1,165 @@\n+import { Component, OnInit, ViewChild } from '@angular/core';\n+import { StatisticsService } from 'app/admin/statistics/statistics.service';\n+import { ChartDataSets, ChartOptions, ChartType } from 'chart.js';\n+import { BaseChartDirective, Label } from 'ng2-charts';\n+import { DataSet } from 'app/exercises/quiz/manage/statistics/quiz-statistic/quiz-statistic.component';\n+import { TranslateService } from '@ngx-translate/core';\n+import * as moment from 'moment';\n+import { SpanType } from 'app/entities/statistics.model';\n+\n+@Component({\n+    selector: 'jhi-statistics',\n+    templateUrl: './statistics.component.html',\n+})\n+export class StatisticsComponent implements OnInit {\n+    DAY = SpanType.DAY;\n+    WEEK = SpanType.WEEK;\n+    MONTH = SpanType.MONTH;\n+    YEAR = SpanType.YEAR;\n+    span: SpanType = SpanType.WEEK;", "originalCommit": "d94ad86f5471576bf5fd0bdc7ed3479cd84a49fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUyMTcyNQ==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r535521725", "bodyText": "Thanks, adjusted it in this commit", "author": "FuchsDominik", "createdAt": "2020-12-03T19:29:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg1MzQzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg2MzI3Mw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r534863273", "bodyText": "Just fyi but you can also define enums like:\nenum SpanType {\n   Day,\n   Week, \n   Month, \n   Year\n}\n\nYou don't need to always write the string representation.", "author": "ivanchimeno", "createdAt": "2020-12-03T08:02:06Z", "path": "src/main/webapp/app/entities/statistics.model.ts", "diffHunk": "@@ -0,0 +1,6 @@\n+export enum SpanType {\n+    DAY = 'DAY',", "originalCommit": "d94ad86f5471576bf5fd0bdc7ed3479cd84a49fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ5MTU1Mw==", "url": "https://github.com/ls1intum/Artemis/pull/2471#discussion_r535491553", "bodyText": "Good to know, however i would like to keep it that way in order to keep it consistent, as we use this declaration all the time.", "author": "FuchsDominik", "createdAt": "2020-12-03T18:46:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg2MzI3Mw=="}], "type": "inlineReview"}, {"oid": "5905879e8731f464bb3777cae0b6e686a48611d8", "url": "https://github.com/ls1intum/Artemis/commit/5905879e8731f464bb3777cae0b6e686a48611d8", "message": "Integrate Ivan's PR review", "committedDate": "2020-12-03T19:27:29Z", "type": "commit"}, {"oid": "c856872b49a3574bfbf9e48b636f65af37edd23e", "url": "https://github.com/ls1intum/Artemis/commit/c856872b49a3574bfbf9e48b636f65af37edd23e", "message": "Merge branch 'develop' into feature/user-statistics", "committedDate": "2020-12-03T20:04:50Z", "type": "commit"}]}