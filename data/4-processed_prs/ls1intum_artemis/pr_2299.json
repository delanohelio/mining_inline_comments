{"pr_number": 2299, "pr_title": "Use Set instead of List for TextSubmission.textBlocks", "pr_createdAt": "2020-10-29T21:08:26Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/2299", "timeline": [{"oid": "d6663724673a03ef56f55c223efe5e6db1bfea0c", "url": "https://github.com/ls1intum/Artemis/commit/d6663724673a03ef56f55c223efe5e6db1bfea0c", "message": "List -> Set for TextSubmission.textBlocks", "committedDate": "2020-10-29T20:17:08Z", "type": "commit"}, {"oid": "845799d5c14232a591b76d1be8636ac419a54c02", "url": "https://github.com/ls1intum/Artemis/commit/845799d5c14232a591b76d1be8636ac419a54c02", "message": "fix tests", "committedDate": "2020-10-29T21:04:51Z", "type": "commit"}, {"oid": "b225128d540f2e876d0ba30dfb9528f61a2cb35d", "url": "https://github.com/ls1intum/Artemis/commit/b225128d540f2e876d0ba30dfb9528f61a2cb35d", "message": "Merge branch 'develop' into chore/text-block-set", "committedDate": "2020-11-06T00:03:20Z", "type": "commit"}, {"oid": "8f222259dc78b3d9cc4fcbabd0b45e3190b9b2a6", "url": "https://github.com/ls1intum/Artemis/commit/8f222259dc78b3d9cc4fcbabd0b45e3190b9b2a6", "message": "TextBlockService\n\nReturn Set in splitSubmissionIntoBlocks()\n\nSigned-off-by: Jan Philip Bernius <janphilip.bernius@tum.de>", "committedDate": "2020-11-06T08:03:21Z", "type": "commit"}, {"oid": "161326ce22f3dedf6eb1f0f9466a539e9d75f61c", "url": "https://github.com/ls1intum/Artemis/commit/161326ce22f3dedf6eb1f0f9466a539e9d75f61c", "message": "AutomaticTextAssessmentConflictService\n\ngroupingBy with toSet()\n\nSigned-off-by: Jan Philip Bernius <janphilip.bernius@tum.de>", "committedDate": "2020-11-06T08:03:55Z", "type": "commit"}, {"oid": "6d55c2ea62ecf0b9b23e69ee19a53261116a638b", "url": "https://github.com/ls1intum/Artemis/commit/6d55c2ea62ecf0b9b23e69ee19a53261116a638b", "message": "TextAssessmentResource\n\ndo not overwrite parameters of saveTextBlocks()\n\nSigned-off-by: Jan Philip Bernius <janphilip.bernius@tum.de>", "committedDate": "2020-11-06T08:05:37Z", "type": "commit"}, {"oid": "89af7f5ea49a7f8855dc50bb0269e442a3714b14", "url": "https://github.com/ls1intum/Artemis/commit/89af7f5ea49a7f8855dc50bb0269e442a3714b14", "message": "TextExerciseUtilService\n\nJavaDoc\n\nSigned-off-by: Jan Philip Bernius <janphilip.bernius@tum.de>", "committedDate": "2020-11-06T08:11:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU3MTM2NQ==", "url": "https://github.com/ls1intum/Artemis/pull/2299#discussion_r518571365", "bodyText": "Should be possible to allocate the HashSet in the groupingBy\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final Map<Long, List<TextBlock>> textBlocks = allTextBlocks.stream().collect(groupingBy(block -> block.getSubmission().getId()));\n          \n          \n            \n                    textSubmissionSet.forEach(textSubmission -> textSubmission.setBlocks(new HashSet<>(textBlocks.get(textSubmission.getId()))));\n          \n          \n            \n                    final Map<Long, List<TextBlock>> textBlocks = allTextBlocks.stream().collect(groupingBy(block -> block.getSubmission().getId(), toSet()));\n          \n          \n            \n                    textSubmissionSet.forEach(textSubmission -> textSubmission.setBlocks(textBlocks.get(textSubmission.getId())));", "author": "jpbernius", "createdAt": "2020-11-06T07:40:36Z", "path": "src/main/java/de/tum/in/www1/artemis/service/AutomaticTextAssessmentConflictService.java", "diffHunk": "@@ -149,9 +145,9 @@ public void asyncCheckFeedbackConsistency(List<TextBlock> textBlocks, List<Feedb\n                 return (TextSubmission) conflict.getFirstFeedback().getResult().getSubmission();\n             }\n         }).collect(toSet());\n-        final Map<Long, List<TextBlock>> textBlocks = textBlockRepository.findAllBySubmissionIdIn(textSubmissionSet.stream().map(TextSubmission::getId).collect(toList())).stream()\n-                .collect(groupingBy(b -> b.getSubmission().getId()));\n-        textSubmissionSet.forEach(textSubmission -> textSubmission.setBlocks(textBlocks.get(textSubmission.getId())));\n+        var allTextBlocks = textBlockRepository.findAllBySubmissionIdIn(textSubmissionSet.stream().map(TextSubmission::getId).collect(toSet()));\n+        final Map<Long, List<TextBlock>> textBlocks = allTextBlocks.stream().collect(groupingBy(block -> block.getSubmission().getId()));\n+        textSubmissionSet.forEach(textSubmission -> textSubmission.setBlocks(new HashSet<>(textBlocks.get(textSubmission.getId()))));", "originalCommit": "b225128d540f2e876d0ba30dfb9528f61a2cb35d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU3OTM5Ng==", "url": "https://github.com/ls1intum/Artemis/pull/2299#discussion_r518579396", "bodyText": "This can be changed to public Set<TextBlock> splitSubmissionIntoBlocks(TextSubmission submission). Will submit a commit.", "author": "jpbernius", "createdAt": "2020-11-06T07:59:28Z", "path": "src/main/java/de/tum/in/www1/artemis/service/TextBlockService.java", "diffHunk": "@@ -49,11 +46,11 @@\n      * @param submission TextSubmission to split\n      * @return List of TextBlocks\n      */\n-    @Transactional(readOnly = true)\n     public List<TextBlock> splitSubmissionIntoBlocks(TextSubmission submission) {", "originalCommit": "b225128d540f2e876d0ba30dfb9528f61a2cb35d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjkwMDY2Nw==", "url": "https://github.com/ls1intum/Artemis/pull/2299#discussion_r522900667", "bodyText": "Would it make sense to use Collections.emptySet() here, which avoids allocating a new HashSet if we don't need it?", "author": "FrankeLukas", "createdAt": "2020-11-13T11:46:34Z", "path": "src/main/java/de/tum/in/www1/artemis/service/TextBlockService.java", "diffHunk": "@@ -49,23 +46,24 @@\n      * @param submission TextSubmission to split\n      * @return List of TextBlocks\n      */\n-    @Transactional(readOnly = true)\n-    public List<TextBlock> splitSubmissionIntoBlocks(TextSubmission submission) {\n+    public Set<TextBlock> splitSubmissionIntoBlocks(TextSubmission submission) {\n+        final Set<TextBlock> blocks = new HashSet<>();\n+\n+        // Return empty set for missing submission text.\n         final String submissionText = submission.getText();\n-        if (submissionText == null)\n-            return new ArrayList<>();\n-        // Return empty list for missing submission text.\n+        if (submissionText == null) {\n+            return blocks;", "originalCommit": "89af7f5ea49a7f8855dc50bb0269e442a3714b14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcyNzAyOQ==", "url": "https://github.com/ls1intum/Artemis/pull/2299#discussion_r523727029", "bodyText": "changed it, but I don't think it will make a noticeable difference (maybe 1ns faster ;-)", "author": "krusche", "createdAt": "2020-11-15T08:37:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjkwMDY2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjkwMTYyOA==", "url": "https://github.com/ls1intum/Artemis/pull/2299#discussion_r522901628", "bodyText": "Typo: expectedText", "author": "FrankeLukas", "createdAt": "2020-11-13T11:48:55Z", "path": "src/test/java/de/tum/in/www1/artemis/service/TextBlockServiceTest.java", "diffHunk": "@@ -47,42 +45,57 @@ public void splitSubmissionIntoBlocksForEmptyText() {\n     @Test\n     public void splitSubmissionIntoBlocksForSingleSentence() {\n         final TextSubmission submission = new TextSubmission(0L).text(\"Hello World.\");\n-        final List<TextBlock> textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n+        final var textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n \n         assertThat(textBlocks, hasSize(1));\n-        assertThat(textBlocks.get(0).getText(), is(equalTo(\"Hello World.\")));\n+        assertThat(textBlocks.iterator().next().getText(), is(equalTo(\"Hello World.\")));\n     }\n \n     @Test\n     public void splitSubmissionIntoBlocksForTwoSentencesWithoutNewLine() {\n         final TextSubmission submission = new TextSubmission(0L).text(\"Hello World. This is a Test.\");\n-        final List<TextBlock> textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n+        final var textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n \n         assertThat(textBlocks, hasSize(2));\n-        assertThat(textBlocks.get(0).getText(), is(equalTo(\"Hello World.\")));\n-        assertThat(textBlocks.get(1).getText(), is(equalTo(\"This is a Test.\")));\n+        assertThat(textBlocks, hasItem(textBlockWithEqualText(\"Hello World.\")));\n+        assertThat(textBlocks, hasItem(textBlockWithEqualText(\"This is a Test.\")));\n     }\n \n     @Test\n     public void splitSubmissionsIntoBlocksForManySentencesWithNewlinesWithoutFullstop() {\n         final TextSubmission submission = new TextSubmission(0L).text(\"Hello World. This is a Test\\n\\n\\nAnother Test\");\n-        final List<TextBlock> textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n+        final var textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n \n         assertThat(textBlocks, hasSize(3));\n-        assertThat(textBlocks.get(0).getText(), is(equalTo(\"Hello World.\")));\n-        assertThat(textBlocks.get(1).getText(), is(equalTo(\"This is a Test\")));\n-        assertThat(textBlocks.get(2).getText(), is(equalTo(\"Another Test\")));\n+        assertThat(textBlocks, hasItem(textBlockWithEqualText(\"Hello World.\")));\n+        assertThat(textBlocks, hasItem(textBlockWithEqualText(\"This is a Test\")));\n+        assertThat(textBlocks, hasItem(textBlockWithEqualText(\"Another Test\")));\n     }\n \n     @Test\n     public void splitSubmissionIntoBlocksForManySentencesWithoutPunctuation() {\n         final TextSubmission submission = new TextSubmission(0L).text(\"Example:\\nThis is the first example\\n\\nSection 2:\\n- Here is a list\\n- Of many bullet  points\\n\\n\");\n-        final List<TextBlock> textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n+        final var textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n \n         String[] sections = new String[] { \"Example:\", \"This is the first example\", \"Section 2:\", \"- Here is a list\", \"- Of many bullet  points\" };\n         assertThat(textBlocks, hasSize(sections.length));\n-        for (int i = 0; i < sections.length; i++) {\n-            assertThat(textBlocks.get(i).getText(), is(equalTo(sections[i])));\n+        for (String section : sections) {\n+            assertThat(textBlocks, hasItem(textBlockWithEqualText(section)));\n         }\n     }\n+\n+    private Matcher<TextBlock> textBlockWithEqualText(String expextedText) {", "originalCommit": "89af7f5ea49a7f8855dc50bb0269e442a3714b14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcyNjk4OA==", "url": "https://github.com/ls1intum/Artemis/pull/2299#discussion_r523726988", "bodyText": "fixed", "author": "krusche", "createdAt": "2020-11-15T08:36:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjkwMTYyOA=="}], "type": "inlineReview"}, {"oid": "70c97c50dcb38a9c6a88ab324e337726e7706299", "url": "https://github.com/ls1intum/Artemis/commit/70c97c50dcb38a9c6a88ab324e337726e7706299", "message": "fixed issues found in comments", "committedDate": "2020-11-15T08:37:35Z", "type": "commit"}, {"oid": "08ff0671c4916522654e75ba2ab846d4beffcfb6", "url": "https://github.com/ls1intum/Artemis/commit/08ff0671c4916522654e75ba2ab846d4beffcfb6", "message": "Merge branch 'develop' into chore/text-block-set", "committedDate": "2020-11-15T08:38:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcyOTczNA==", "url": "https://github.com/ls1intum/Artemis/pull/2299#discussion_r523729734", "bodyText": "Does it make sense to use a immutable set here? The other returned set are mutable. Maybe refactor to only return immutable sets? Set<String> immutable = ImmutableSet.copyOf(set);", "author": "stefanwaldhauser", "createdAt": "2020-11-15T09:02:41Z", "path": "src/main/java/de/tum/in/www1/artemis/service/TextBlockService.java", "diffHunk": "@@ -49,23 +46,23 @@\n      * @param submission TextSubmission to split\n      * @return List of TextBlocks\n      */\n-    @Transactional(readOnly = true)\n-    public List<TextBlock> splitSubmissionIntoBlocks(TextSubmission submission) {\n+    public Set<TextBlock> splitSubmissionIntoBlocks(TextSubmission submission) {\n+\n+        // Return empty set for missing submission text.\n         final String submissionText = submission.getText();\n-        if (submissionText == null)\n-            return new ArrayList<>();\n-        // Return empty list for missing submission text.\n+        if (submissionText == null) {\n+            return Collections.emptySet();", "originalCommit": "08ff0671c4916522654e75ba2ab846d4beffcfb6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}