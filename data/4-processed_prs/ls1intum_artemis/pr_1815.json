{"pr_number": 1815, "pr_title": "Prevent changing the working time of student exams after the exam is visible", "pr_createdAt": "2020-07-04T13:16:55Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/1815", "timeline": [{"oid": "29ca34168179598f753f5678ba5de33fdfeeaf5b", "url": "https://github.com/ls1intum/Artemis/commit/29ca34168179598f753f5678ba5de33fdfeeaf5b", "message": "prevent changing the working time after the exam is visible", "committedDate": "2020-07-04T08:06:43Z", "type": "commit"}, {"oid": "6b70b0743f0da085ae4bc545ca0d0b79819dd627", "url": "https://github.com/ls1intum/Artemis/commit/6b70b0743f0da085ae4bc545ca0d0b79819dd627", "message": "Merge branch 'develop' into bugfix/no-change-in-student-working-time-after-exam-visible", "committedDate": "2020-07-04T20:22:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwODE3NA==", "url": "https://github.com/ls1intum/Artemis/pull/1815#discussion_r449808174", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // if the exam is not visible, we rather disable the form\n          \n          \n            \n                    // if the exam is not visible to students yet, we disable the form to edit the working time", "author": "sleiss", "createdAt": "2020-07-04T21:51:08Z", "path": "src/main/webapp/app/exam/manage/student-exams/student-exam-detail.component.ts", "diffHunk": "@@ -107,8 +108,29 @@ export class StudentExamDetailComponent implements OnInit {\n         const workingTime = this.artemisDurationFromSecondsPipe.transform(this.studentExam.workingTime);\n         const workingTimeParts = workingTime.split(':');\n         this.workingTimeForm = new FormGroup({\n-            minutes: new FormControl(parseInt(workingTimeParts[0] ? workingTimeParts[0] : '0', 10), [Validators.min(0), Validators.required]),\n-            seconds: new FormControl(parseInt(workingTimeParts[1] ? workingTimeParts[1] : '0', 10), [Validators.min(0), Validators.max(59), Validators.required]),\n+            minutes: new FormControl({ value: parseInt(workingTimeParts[0] ? workingTimeParts[0] : '0', 10), disabled: this.examIsVisible() }, [\n+                Validators.min(0),\n+                Validators.required,\n+            ]),\n+            seconds: new FormControl({ value: parseInt(workingTimeParts[1] ? workingTimeParts[1] : '0', 10), disabled: this.examIsVisible() }, [\n+                Validators.min(0),\n+                Validators.max(59),\n+                Validators.required,\n+            ]),\n         });\n     }\n+\n+    examIsVisible(): boolean {\n+        if (this.studentExam.exam) {\n+            return moment(this.studentExam.exam.visibleDate).isBefore(moment());\n+        }\n+        // if the exam is not visible, we rather disable the form", "originalCommit": "6b70b0743f0da085ae4bc545ca0d0b79819dd627", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "402c6f26ec18e099b76169eb45412bf8f0cab129", "url": "https://github.com/ls1intum/Artemis/commit/402c6f26ec18e099b76169eb45412bf8f0cab129", "message": "Update src/main/webapp/app/exam/manage/student-exams/student-exam-detail.component.ts\n\nCo-authored-by: Simon Lei\u00df <5084100+sleiss@users.noreply.github.com>", "committedDate": "2020-07-04T22:52:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkwNDU4OA==", "url": "https://github.com/ls1intum/Artemis/pull/1815#discussion_r449904588", "bodyText": "You may want to add a comment here to make this more clear:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return moment(this.studentExam.exam.visibleDate).isBefore(moment());\n          \n          \n            \n                        // Disable the form to edit the working time if the exam is already visible\n          \n          \n            \n                        return moment(this.studentExam.exam.visibleDate).isBefore(moment());", "author": "sascha11110", "createdAt": "2020-07-05T18:17:07Z", "path": "src/main/webapp/app/exam/manage/student-exams/student-exam-detail.component.ts", "diffHunk": "@@ -107,8 +108,29 @@ export class StudentExamDetailComponent implements OnInit {\n         const workingTime = this.artemisDurationFromSecondsPipe.transform(this.studentExam.workingTime);\n         const workingTimeParts = workingTime.split(':');\n         this.workingTimeForm = new FormGroup({\n-            minutes: new FormControl(parseInt(workingTimeParts[0] ? workingTimeParts[0] : '0', 10), [Validators.min(0), Validators.required]),\n-            seconds: new FormControl(parseInt(workingTimeParts[1] ? workingTimeParts[1] : '0', 10), [Validators.min(0), Validators.max(59), Validators.required]),\n+            minutes: new FormControl({ value: parseInt(workingTimeParts[0] ? workingTimeParts[0] : '0', 10), disabled: this.examIsVisible() }, [\n+                Validators.min(0),\n+                Validators.required,\n+            ]),\n+            seconds: new FormControl({ value: parseInt(workingTimeParts[1] ? workingTimeParts[1] : '0', 10), disabled: this.examIsVisible() }, [\n+                Validators.min(0),\n+                Validators.max(59),\n+                Validators.required,\n+            ]),\n         });\n     }\n+\n+    examIsVisible(): boolean {\n+        if (this.studentExam.exam) {\n+            return moment(this.studentExam.exam.visibleDate).isBefore(moment());", "originalCommit": "402c6f26ec18e099b76169eb45412bf8f0cab129", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkwNDgxMg==", "url": "https://github.com/ls1intum/Artemis/pull/1815#discussion_r449904812", "bodyText": "I don't get this comment. For two reasons:\n\nThe purpose of the PR is to ensure that the working time cannot be changed after the exam is visible to the students. If there is no visibleDate the working time can be changed --> so the method should return false (--> form is editable)\nThe first part (if the exam is not visible to students yet) is a little confusing. If the visibleDate is not set would make more sense here", "author": "sascha11110", "createdAt": "2020-07-05T18:20:22Z", "path": "src/main/webapp/app/exam/manage/student-exams/student-exam-detail.component.ts", "diffHunk": "@@ -107,8 +108,29 @@ export class StudentExamDetailComponent implements OnInit {\n         const workingTime = this.artemisDurationFromSecondsPipe.transform(this.studentExam.workingTime);\n         const workingTimeParts = workingTime.split(':');\n         this.workingTimeForm = new FormGroup({\n-            minutes: new FormControl(parseInt(workingTimeParts[0] ? workingTimeParts[0] : '0', 10), [Validators.min(0), Validators.required]),\n-            seconds: new FormControl(parseInt(workingTimeParts[1] ? workingTimeParts[1] : '0', 10), [Validators.min(0), Validators.max(59), Validators.required]),\n+            minutes: new FormControl({ value: parseInt(workingTimeParts[0] ? workingTimeParts[0] : '0', 10), disabled: this.examIsVisible() }, [\n+                Validators.min(0),\n+                Validators.required,\n+            ]),\n+            seconds: new FormControl({ value: parseInt(workingTimeParts[1] ? workingTimeParts[1] : '0', 10), disabled: this.examIsVisible() }, [\n+                Validators.min(0),\n+                Validators.max(59),\n+                Validators.required,\n+            ]),\n         });\n     }\n+\n+    examIsVisible(): boolean {\n+        if (this.studentExam.exam) {\n+            return moment(this.studentExam.exam.visibleDate).isBefore(moment());\n+        }\n+        // if the exam is not visible to students yet, we disable the form to edit the working time", "originalCommit": "402c6f26ec18e099b76169eb45412bf8f0cab129", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkwNjQ3OA==", "url": "https://github.com/ls1intum/Artemis/pull/1815#discussion_r449906478", "bodyText": "the comment is wrong, I'll update it. This should just prevent an edge case and type script error when for some reason the studentExam.exam is not loaded or undefined", "author": "krusche", "createdAt": "2020-07-05T18:40:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkwNDgxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkwNDkwNQ==", "url": "https://github.com/ls1intum/Artemis/pull/1815#discussion_r449904905", "bodyText": "We should find a better solution for this soon :-D", "author": "sascha11110", "createdAt": "2020-07-05T18:21:37Z", "path": "src/test/java/de/tum/in/www1/artemis/StudentExamIntegrationTest.java", "diffHunk": "@@ -70,7 +70,13 @@ public void initTestCase() {\n     }\n \n     @AfterEach\n-    public void resetDatabase() {\n+    public void resetDatabase() throws Exception {\n+\n+        // change back to instructor user\n+        database.changeUser(\"instructor1\");\n+        // Clean up to prevent exceptions during reset database\n+        request.delete(\"/api/courses/\" + course1.getId() + \"/exams/\" + exam1.getId(), HttpStatus.OK);", "originalCommit": "402c6f26ec18e099b76169eb45412bf8f0cab129", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkwNTc0OA==", "url": "https://github.com/ls1intum/Artemis/pull/1815#discussion_r449905748", "bodyText": "In my project I always use a try{}finally{} and within the finally I delete all of the entities created by accessing the repository directly\nif(repo.existsById(...)){\nrepo.deleteById(...);\n}\nSomething like that. Is that something that might help you?", "author": "julian-christl", "createdAt": "2020-07-05T18:31:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkwNDkwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkwNTk3Ng==", "url": "https://github.com/ls1intum/Artemis/pull/1815#discussion_r449905976", "bodyText": "we have a better solution already, I added a cleanup database service on develop so this line might not even be necessary, but still a good test that the DELETE Rest call does work as intended", "author": "krusche", "createdAt": "2020-07-05T18:34:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkwNDkwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkwNjUxNA==", "url": "https://github.com/ls1intum/Artemis/pull/1815#discussion_r449906514", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // if the exam is not visible to students yet, we disable the form to edit the working time\n          \n          \n            \n                    // if exam is undefined, the form to edit the working time is disabled", "author": "krusche", "createdAt": "2020-07-05T18:41:11Z", "path": "src/main/webapp/app/exam/manage/student-exams/student-exam-detail.component.ts", "diffHunk": "@@ -107,8 +108,29 @@ export class StudentExamDetailComponent implements OnInit {\n         const workingTime = this.artemisDurationFromSecondsPipe.transform(this.studentExam.workingTime);\n         const workingTimeParts = workingTime.split(':');\n         this.workingTimeForm = new FormGroup({\n-            minutes: new FormControl(parseInt(workingTimeParts[0] ? workingTimeParts[0] : '0', 10), [Validators.min(0), Validators.required]),\n-            seconds: new FormControl(parseInt(workingTimeParts[1] ? workingTimeParts[1] : '0', 10), [Validators.min(0), Validators.max(59), Validators.required]),\n+            minutes: new FormControl({ value: parseInt(workingTimeParts[0] ? workingTimeParts[0] : '0', 10), disabled: this.examIsVisible() }, [\n+                Validators.min(0),\n+                Validators.required,\n+            ]),\n+            seconds: new FormControl({ value: parseInt(workingTimeParts[1] ? workingTimeParts[1] : '0', 10), disabled: this.examIsVisible() }, [\n+                Validators.min(0),\n+                Validators.max(59),\n+                Validators.required,\n+            ]),\n         });\n     }\n+\n+    examIsVisible(): boolean {\n+        if (this.studentExam.exam) {\n+            return moment(this.studentExam.exam.visibleDate).isBefore(moment());\n+        }\n+        // if the exam is not visible to students yet, we disable the form to edit the working time", "originalCommit": "402c6f26ec18e099b76169eb45412bf8f0cab129", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5ada80d6ce14369b55c997686acad5fb2939e4c4", "url": "https://github.com/ls1intum/Artemis/commit/5ada80d6ce14369b55c997686acad5fb2939e4c4", "message": "Apply suggestions from code review\n\nCo-authored-by: Sascha Beele <sascha@beele.io>", "committedDate": "2020-07-05T18:41:31Z", "type": "commit"}]}