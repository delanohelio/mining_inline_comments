{"pr_number": 3819, "pr_title": "Clean up inactive iscsi sessions when VMs get moved due to crashes", "pr_createdAt": "2020-01-17T15:31:59Z", "pr_url": "https://github.com/apache/cloudstack/pull/3819", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDExNDQyMw==", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r370114423", "bodyText": "you need a license here to pass (rat failure)", "author": "DaanHoogland", "createdAt": "2020-01-23T13:26:41Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,127 @@\n+package com.cloud.hypervisor.kvm.storage;", "originalCommit": "c7e8f6982f5435b15996b55c0f1368539fa015e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMzNDE3Nw==", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r371334177", "bodyText": "added the apache license", "author": "skattoju4", "createdAt": "2020-01-27T16:11:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDExNDQyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI0OTExNA==", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r370249114", "bodyText": "I am OK with the way it is, but I would like to raise the following question: Is it interesting to externalize CLEANUP_INTERVAL_SEC this on a global settings variable (config keys)?", "author": "GabrielBrascher", "createdAt": "2020-01-23T17:16:36Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,127 @@\n+package com.cloud.hypervisor.kvm.storage;\n+\n+import com.cloud.hypervisor.kvm.resource.LibvirtConnection;\n+import com.cloud.hypervisor.kvm.resource.LibvirtDomainXMLParser;\n+import com.cloud.hypervisor.kvm.resource.LibvirtVMDef;\n+import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n+import org.apache.log4j.Logger;\n+import org.libvirt.Connect;\n+import org.libvirt.Domain;\n+import org.libvirt.LibvirtException;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class IscsiStorageCleanupMonitor implements Runnable{\n+    private static final Logger s_logger = Logger.getLogger(IscsiStorageCleanupMonitor.class);\n+    private static final int CLEANUP_INTERVAL_SEC = 60; // check every X seconds", "originalCommit": "c7e8f6982f5435b15996b55c0f1368539fa015e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI2MDQzNw==", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r370260437", "bodyText": "I would recommend creating a few methods  (e.g. checkIfIscsSessionBelongAnyVm(Connect), etc) which would allow documenting (Javadoc) and creating unit tests (JUnit).", "author": "GabrielBrascher", "createdAt": "2020-01-23T17:39:59Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,127 @@\n+package com.cloud.hypervisor.kvm.storage;\n+\n+import com.cloud.hypervisor.kvm.resource.LibvirtConnection;\n+import com.cloud.hypervisor.kvm.resource.LibvirtDomainXMLParser;\n+import com.cloud.hypervisor.kvm.resource.LibvirtVMDef;\n+import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n+import org.apache.log4j.Logger;\n+import org.libvirt.Connect;\n+import org.libvirt.Domain;\n+import org.libvirt.LibvirtException;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class IscsiStorageCleanupMonitor implements Runnable{\n+    private static final Logger s_logger = Logger.getLogger(IscsiStorageCleanupMonitor.class);\n+    private static final int CLEANUP_INTERVAL_SEC = 60; // check every X seconds\n+    private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n+    private static final String KEYWORD_ISCSI = \"iscsi\";\n+    private static final String KEYWORD_IQN = \"iqn\";\n+\n+    private IscsiAdmStorageAdaptor iscsiStorageAdaptor;\n+\n+    private Map<String, Boolean> diskStatusMap;\n+\n+    public IscsiStorageCleanupMonitor() {\n+        diskStatusMap = new HashMap<>();\n+        s_logger.debug(\"Initialize cleanup thread\");\n+        iscsiStorageAdaptor = new IscsiAdmStorageAdaptor();\n+    }\n+\n+\n+    private class Monitor extends ManagedContextRunnable {\n+\n+        @Override\n+        protected void runInContext() {\n+            Connect conn = null;\n+            try {\n+                conn = LibvirtConnection.getConnection();\n+\n+                //populate all the iscsi disks currently attached to this host\n+                diskStatusMap.clear();\n+                File[] iscsiVolumes = new File(ISCSI_PATH_PREFIX).listFiles();\n+\n+                if (iscsiVolumes == null || iscsiVolumes.length == 0) {\n+                    s_logger.debug(\"No iscsi sessions found for cleanup\");\n+                    return;\n+                }\n+\n+                for( File v : iscsiVolumes) {\n+                    if (isIscsiDisk(v.getAbsolutePath())) {\n+                        s_logger.debug(\"found iscsi disk by cleanup thread, marking inactive:\" + v.getAbsolutePath());\n+                        diskStatusMap.put(v.getAbsolutePath(), false);\n+                    }\n+                }\n+\n+                // check if they belong to any VM\n+                int[] domains = conn.listDomains();\n+                s_logger.debug(String.format(\"found %d domains\", domains.length));\n+                for (int domId : domains) {\n+                    Domain dm = conn.domainLookupByID(domId);\n+                    final String domXml = dm.getXMLDesc(0);\n+                    final LibvirtDomainXMLParser parser = new LibvirtDomainXMLParser();\n+                    parser.parseDomainXML(domXml);\n+                    List<LibvirtVMDef.DiskDef> disks = parser.getDisks();\n+\n+                    //check the volume map. If an entry exists change the status to True\n+                    for (final LibvirtVMDef.DiskDef disk : disks) {\n+                        if (diskStatusMap.containsKey(disk.getDiskPath())) {\n+                            diskStatusMap.put(disk.getDiskPath(), true);\n+                            s_logger.debug(\"active disk found by cleanup thread\" + disk.getDiskPath());\n+                        }\n+                    }", "originalCommit": "c7e8f6982f5435b15996b55c0f1368539fa015e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cc3402fbf6bfe28cd6be37cfdcf161f34e3e63c5", "url": "https://github.com/apache/cloudstack/commit/cc3402fbf6bfe28cd6be37cfdcf161f34e3e63c5", "message": "Merge pull request #7 from skattoju4/patch-1\n\nadd apache license to IscsiStorageCleanupMonitor.java", "committedDate": "2020-01-27T16:10:19Z", "type": "forcePushed"}, {"oid": "a750ce07dd1d3af117c3a1c6eef7540a35f49b83", "url": "https://github.com/apache/cloudstack/commit/a750ce07dd1d3af117c3a1c6eef7540a35f49b83", "message": "Update IscsiStorageCleanupMonitor.java\n\nadd apache license", "committedDate": "2020-01-27T20:17:12Z", "type": "forcePushed"}, {"oid": "932a98b7e6c17df418869b3da3ec332dc4e8543d", "url": "https://github.com/apache/cloudstack/commit/932a98b7e6c17df418869b3da3ec332dc4e8543d", "message": "Update IscsiStorageCleanupMonitor.java\n\nadd apache license", "committedDate": "2020-01-27T20:59:48Z", "type": "forcePushed"}, {"oid": "0ad47e5ac41a66277d82fd4ec01f786086389548", "url": "https://github.com/apache/cloudstack/commit/0ad47e5ac41a66277d82fd4ec01f786086389548", "message": "ISCI Session cleanup for KVM managed storage", "committedDate": "2020-01-27T21:33:34Z", "type": "commit"}, {"oid": "6d06cf28b60b3ffc191e68731071e3e407ad863d", "url": "https://github.com/apache/cloudstack/commit/6d06cf28b60b3ffc191e68731071e3e407ad863d", "message": "Remove the key delete logic", "committedDate": "2020-01-27T21:33:41Z", "type": "commit"}, {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db", "url": "https://github.com/apache/cloudstack/commit/0bf605ba335241d81280092823a7a0e4bb1570db", "message": "Update IscsiStorageCleanupMonitor.java\n\nadd apache license", "committedDate": "2020-01-27T21:33:51Z", "type": "commit"}, {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db", "url": "https://github.com/apache/cloudstack/commit/0bf605ba335241d81280092823a7a0e4bb1570db", "message": "Update IscsiStorageCleanupMonitor.java\n\nadd apache license", "committedDate": "2020-01-27T21:33:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTkyOTc3OA==", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r371929778", "bodyText": "long method with a lot of comment. can you please factor out the pieces that need commenting in their own method with clear names? that would make this thread code more maintainable for future generations.", "author": "DaanHoogland", "createdAt": "2020-01-28T16:55:32Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,143 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package com.cloud.hypervisor.kvm.storage;\n+\n+import com.cloud.hypervisor.kvm.resource.LibvirtConnection;\n+import com.cloud.hypervisor.kvm.resource.LibvirtDomainXMLParser;\n+import com.cloud.hypervisor.kvm.resource.LibvirtVMDef;\n+import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n+import org.apache.log4j.Logger;\n+import org.libvirt.Connect;\n+import org.libvirt.Domain;\n+import org.libvirt.LibvirtException;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class IscsiStorageCleanupMonitor implements Runnable{\n+    private static final Logger s_logger = Logger.getLogger(IscsiStorageCleanupMonitor.class);\n+    private static final int CLEANUP_INTERVAL_SEC = 60; // check every X seconds\n+    private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n+    private static final String KEYWORD_ISCSI = \"iscsi\";\n+    private static final String KEYWORD_IQN = \"iqn\";\n+\n+    private IscsiAdmStorageAdaptor iscsiStorageAdaptor;\n+\n+    private Map<String, Boolean> diskStatusMap;\n+\n+    public IscsiStorageCleanupMonitor() {\n+        diskStatusMap = new HashMap<>();\n+        s_logger.debug(\"Initialize cleanup thread\");\n+        iscsiStorageAdaptor = new IscsiAdmStorageAdaptor();\n+    }\n+\n+\n+    private class Monitor extends ManagedContextRunnable {\n+\n+        @Override\n+        protected void runInContext() {", "originalCommit": "0bf605ba335241d81280092823a7a0e4bb1570db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTkzMTg0Mw==", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r371931843", "bodyText": "populateDiskStatusMap();", "author": "DaanHoogland", "createdAt": "2020-01-28T16:58:54Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,143 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package com.cloud.hypervisor.kvm.storage;\n+\n+import com.cloud.hypervisor.kvm.resource.LibvirtConnection;\n+import com.cloud.hypervisor.kvm.resource.LibvirtDomainXMLParser;\n+import com.cloud.hypervisor.kvm.resource.LibvirtVMDef;\n+import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n+import org.apache.log4j.Logger;\n+import org.libvirt.Connect;\n+import org.libvirt.Domain;\n+import org.libvirt.LibvirtException;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class IscsiStorageCleanupMonitor implements Runnable{\n+    private static final Logger s_logger = Logger.getLogger(IscsiStorageCleanupMonitor.class);\n+    private static final int CLEANUP_INTERVAL_SEC = 60; // check every X seconds\n+    private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n+    private static final String KEYWORD_ISCSI = \"iscsi\";\n+    private static final String KEYWORD_IQN = \"iqn\";\n+\n+    private IscsiAdmStorageAdaptor iscsiStorageAdaptor;\n+\n+    private Map<String, Boolean> diskStatusMap;\n+\n+    public IscsiStorageCleanupMonitor() {\n+        diskStatusMap = new HashMap<>();\n+        s_logger.debug(\"Initialize cleanup thread\");\n+        iscsiStorageAdaptor = new IscsiAdmStorageAdaptor();\n+    }\n+\n+\n+    private class Monitor extends ManagedContextRunnable {\n+\n+        @Override\n+        protected void runInContext() {\n+            Connect conn = null;\n+            try {\n+                conn = LibvirtConnection.getConnection();\n+\n+                //populate all the iscsi disks currently attached to this host\n+                diskStatusMap.clear();\n+                File[] iscsiVolumes = new File(ISCSI_PATH_PREFIX).listFiles();\n+\n+                if (iscsiVolumes == null || iscsiVolumes.length == 0) {\n+                    s_logger.debug(\"No iscsi sessions found for cleanup\");\n+                    return;\n+                }\n+\n+                for( File v : iscsiVolumes) {\n+                    if (isIscsiDisk(v.getAbsolutePath())) {\n+                        s_logger.debug(\"found iscsi disk by cleanup thread, marking inactive:\" + v.getAbsolutePath());\n+                        diskStatusMap.put(v.getAbsolutePath(), false);\n+                    }\n+                }", "originalCommit": "0bf605ba335241d81280092823a7a0e4bb1570db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTkzMjA5MA==", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r371932090", "bodyText": "checkDiskStatusMap();", "author": "DaanHoogland", "createdAt": "2020-01-28T16:59:22Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,143 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package com.cloud.hypervisor.kvm.storage;\n+\n+import com.cloud.hypervisor.kvm.resource.LibvirtConnection;\n+import com.cloud.hypervisor.kvm.resource.LibvirtDomainXMLParser;\n+import com.cloud.hypervisor.kvm.resource.LibvirtVMDef;\n+import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n+import org.apache.log4j.Logger;\n+import org.libvirt.Connect;\n+import org.libvirt.Domain;\n+import org.libvirt.LibvirtException;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class IscsiStorageCleanupMonitor implements Runnable{\n+    private static final Logger s_logger = Logger.getLogger(IscsiStorageCleanupMonitor.class);\n+    private static final int CLEANUP_INTERVAL_SEC = 60; // check every X seconds\n+    private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n+    private static final String KEYWORD_ISCSI = \"iscsi\";\n+    private static final String KEYWORD_IQN = \"iqn\";\n+\n+    private IscsiAdmStorageAdaptor iscsiStorageAdaptor;\n+\n+    private Map<String, Boolean> diskStatusMap;\n+\n+    public IscsiStorageCleanupMonitor() {\n+        diskStatusMap = new HashMap<>();\n+        s_logger.debug(\"Initialize cleanup thread\");\n+        iscsiStorageAdaptor = new IscsiAdmStorageAdaptor();\n+    }\n+\n+\n+    private class Monitor extends ManagedContextRunnable {\n+\n+        @Override\n+        protected void runInContext() {\n+            Connect conn = null;\n+            try {\n+                conn = LibvirtConnection.getConnection();\n+\n+                //populate all the iscsi disks currently attached to this host\n+                diskStatusMap.clear();\n+                File[] iscsiVolumes = new File(ISCSI_PATH_PREFIX).listFiles();\n+\n+                if (iscsiVolumes == null || iscsiVolumes.length == 0) {\n+                    s_logger.debug(\"No iscsi sessions found for cleanup\");\n+                    return;\n+                }\n+\n+                for( File v : iscsiVolumes) {\n+                    if (isIscsiDisk(v.getAbsolutePath())) {\n+                        s_logger.debug(\"found iscsi disk by cleanup thread, marking inactive:\" + v.getAbsolutePath());\n+                        diskStatusMap.put(v.getAbsolutePath(), false);\n+                    }\n+                }\n+\n+                // check if they belong to any VM\n+                int[] domains = conn.listDomains();\n+                s_logger.debug(String.format(\"found %d domains\", domains.length));\n+                for (int domId : domains) {\n+                    Domain dm = conn.domainLookupByID(domId);\n+                    final String domXml = dm.getXMLDesc(0);\n+                    final LibvirtDomainXMLParser parser = new LibvirtDomainXMLParser();\n+                    parser.parseDomainXML(domXml);\n+                    List<LibvirtVMDef.DiskDef> disks = parser.getDisks();\n+\n+                    //check the volume map. If an entry exists change the status to True\n+                    for (final LibvirtVMDef.DiskDef disk : disks) {\n+                        if (diskStatusMap.containsKey(disk.getDiskPath())) {\n+                            diskStatusMap.put(disk.getDiskPath(), true);\n+                            s_logger.debug(\"active disk found by cleanup thread\" + disk.getDiskPath());\n+                        }\n+                    }\n+                }", "originalCommit": "0bf605ba335241d81280092823a7a0e4bb1570db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTkzMjM2Nw==", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r371932367", "bodyText": "space needed in log message before the path.", "author": "DaanHoogland", "createdAt": "2020-01-28T16:59:49Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,143 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package com.cloud.hypervisor.kvm.storage;\n+\n+import com.cloud.hypervisor.kvm.resource.LibvirtConnection;\n+import com.cloud.hypervisor.kvm.resource.LibvirtDomainXMLParser;\n+import com.cloud.hypervisor.kvm.resource.LibvirtVMDef;\n+import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n+import org.apache.log4j.Logger;\n+import org.libvirt.Connect;\n+import org.libvirt.Domain;\n+import org.libvirt.LibvirtException;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class IscsiStorageCleanupMonitor implements Runnable{\n+    private static final Logger s_logger = Logger.getLogger(IscsiStorageCleanupMonitor.class);\n+    private static final int CLEANUP_INTERVAL_SEC = 60; // check every X seconds\n+    private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n+    private static final String KEYWORD_ISCSI = \"iscsi\";\n+    private static final String KEYWORD_IQN = \"iqn\";\n+\n+    private IscsiAdmStorageAdaptor iscsiStorageAdaptor;\n+\n+    private Map<String, Boolean> diskStatusMap;\n+\n+    public IscsiStorageCleanupMonitor() {\n+        diskStatusMap = new HashMap<>();\n+        s_logger.debug(\"Initialize cleanup thread\");\n+        iscsiStorageAdaptor = new IscsiAdmStorageAdaptor();\n+    }\n+\n+\n+    private class Monitor extends ManagedContextRunnable {\n+\n+        @Override\n+        protected void runInContext() {\n+            Connect conn = null;\n+            try {\n+                conn = LibvirtConnection.getConnection();\n+\n+                //populate all the iscsi disks currently attached to this host\n+                diskStatusMap.clear();\n+                File[] iscsiVolumes = new File(ISCSI_PATH_PREFIX).listFiles();\n+\n+                if (iscsiVolumes == null || iscsiVolumes.length == 0) {\n+                    s_logger.debug(\"No iscsi sessions found for cleanup\");\n+                    return;\n+                }\n+\n+                for( File v : iscsiVolumes) {\n+                    if (isIscsiDisk(v.getAbsolutePath())) {\n+                        s_logger.debug(\"found iscsi disk by cleanup thread, marking inactive:\" + v.getAbsolutePath());\n+                        diskStatusMap.put(v.getAbsolutePath(), false);\n+                    }\n+                }\n+\n+                // check if they belong to any VM\n+                int[] domains = conn.listDomains();\n+                s_logger.debug(String.format(\"found %d domains\", domains.length));\n+                for (int domId : domains) {\n+                    Domain dm = conn.domainLookupByID(domId);\n+                    final String domXml = dm.getXMLDesc(0);\n+                    final LibvirtDomainXMLParser parser = new LibvirtDomainXMLParser();\n+                    parser.parseDomainXML(domXml);\n+                    List<LibvirtVMDef.DiskDef> disks = parser.getDisks();\n+\n+                    //check the volume map. If an entry exists change the status to True\n+                    for (final LibvirtVMDef.DiskDef disk : disks) {\n+                        if (diskStatusMap.containsKey(disk.getDiskPath())) {\n+                            diskStatusMap.put(disk.getDiskPath(), true);\n+                            s_logger.debug(\"active disk found by cleanup thread\" + disk.getDiskPath());", "originalCommit": "0bf605ba335241d81280092823a7a0e4bb1570db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTkzNDc1Mg==", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r371934752", "bodyText": "disconnectPhysicalDisks();", "author": "DaanHoogland", "createdAt": "2020-01-28T17:03:58Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,143 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package com.cloud.hypervisor.kvm.storage;\n+\n+import com.cloud.hypervisor.kvm.resource.LibvirtConnection;\n+import com.cloud.hypervisor.kvm.resource.LibvirtDomainXMLParser;\n+import com.cloud.hypervisor.kvm.resource.LibvirtVMDef;\n+import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n+import org.apache.log4j.Logger;\n+import org.libvirt.Connect;\n+import org.libvirt.Domain;\n+import org.libvirt.LibvirtException;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class IscsiStorageCleanupMonitor implements Runnable{\n+    private static final Logger s_logger = Logger.getLogger(IscsiStorageCleanupMonitor.class);\n+    private static final int CLEANUP_INTERVAL_SEC = 60; // check every X seconds\n+    private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n+    private static final String KEYWORD_ISCSI = \"iscsi\";\n+    private static final String KEYWORD_IQN = \"iqn\";\n+\n+    private IscsiAdmStorageAdaptor iscsiStorageAdaptor;\n+\n+    private Map<String, Boolean> diskStatusMap;\n+\n+    public IscsiStorageCleanupMonitor() {\n+        diskStatusMap = new HashMap<>();\n+        s_logger.debug(\"Initialize cleanup thread\");\n+        iscsiStorageAdaptor = new IscsiAdmStorageAdaptor();\n+    }\n+\n+\n+    private class Monitor extends ManagedContextRunnable {\n+\n+        @Override\n+        protected void runInContext() {\n+            Connect conn = null;\n+            try {\n+                conn = LibvirtConnection.getConnection();\n+\n+                //populate all the iscsi disks currently attached to this host\n+                diskStatusMap.clear();\n+                File[] iscsiVolumes = new File(ISCSI_PATH_PREFIX).listFiles();\n+\n+                if (iscsiVolumes == null || iscsiVolumes.length == 0) {\n+                    s_logger.debug(\"No iscsi sessions found for cleanup\");\n+                    return;\n+                }\n+\n+                for( File v : iscsiVolumes) {\n+                    if (isIscsiDisk(v.getAbsolutePath())) {\n+                        s_logger.debug(\"found iscsi disk by cleanup thread, marking inactive:\" + v.getAbsolutePath());\n+                        diskStatusMap.put(v.getAbsolutePath(), false);\n+                    }\n+                }\n+\n+                // check if they belong to any VM\n+                int[] domains = conn.listDomains();\n+                s_logger.debug(String.format(\"found %d domains\", domains.length));\n+                for (int domId : domains) {\n+                    Domain dm = conn.domainLookupByID(domId);\n+                    final String domXml = dm.getXMLDesc(0);\n+                    final LibvirtDomainXMLParser parser = new LibvirtDomainXMLParser();\n+                    parser.parseDomainXML(domXml);\n+                    List<LibvirtVMDef.DiskDef> disks = parser.getDisks();\n+\n+                    //check the volume map. If an entry exists change the status to True\n+                    for (final LibvirtVMDef.DiskDef disk : disks) {\n+                        if (diskStatusMap.containsKey(disk.getDiskPath())) {\n+                            diskStatusMap.put(disk.getDiskPath(), true);\n+                            s_logger.debug(\"active disk found by cleanup thread\" + disk.getDiskPath());\n+                        }\n+                    }\n+                }\n+\n+                // the ones where the state is false, they are stale. They may be\n+                // removed we go through each volume which is false, check iscsiadm,\n+                // if the volume still exisits, logout of that volume and remove it from the map\n+\n+                // XXX: It is possible that someone had manually added an iSCSI volume.\n+                // we would not be able to detect that\n+                for (String diskPath : diskStatusMap.keySet()) {\n+                    if (!diskStatusMap.get(diskPath)) {\n+                        if (Files.exists(Paths.get(diskPath))) {\n+                            try {\n+                                s_logger.info(\"Cleaning up disk \" + diskPath);\n+                                iscsiStorageAdaptor.disconnectPhysicalDiskByPath(diskPath);\n+                            } catch (Exception e) {\n+                                s_logger.warn(\"[ignored] Error cleaning up \" + diskPath, e);\n+                            }\n+                        }\n+                    }\n+                }", "originalCommit": "0bf605ba335241d81280092823a7a0e4bb1570db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f34eca68d2e21161e9fa9b88a3a5bd756f1ed733", "url": "https://github.com/apache/cloudstack/commit/f34eca68d2e21161e9fa9b88a3a5bd756f1ed733", "message": "factor code into methods", "committedDate": "2020-01-28T18:51:40Z", "type": "commit"}]}