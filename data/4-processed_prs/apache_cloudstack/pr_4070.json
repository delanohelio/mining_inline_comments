{"pr_number": 4070, "pr_title": "Update cloud-set-guest-password.in", "pr_createdAt": "2020-05-11T10:33:45Z", "pr_url": "https://github.com/apache/cloudstack/pull/4070", "timeline": [{"oid": "5b7339ccd25dacd433aa122ee40360da09f2e5cf", "url": "https://github.com/apache/cloudstack/commit/5b7339ccd25dacd433aa122ee40360da09f2e5cf", "message": "Update cloud-set-guest-password.in", "committedDate": "2020-05-11T09:28:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA4NjE2NA==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r423086164", "bodyText": "This is line is extremely long, can you make them 3 lines instead?", "author": "nvazquez", "createdAt": "2020-05-11T14:36:02Z", "path": "setup/bindir/cloud-set-guest-password.in", "diffHunk": "@@ -26,25 +26,56 @@\n # Modify this line to specify the user (default is root)\n user=root\n \n-# Add your DHCP lease folders here\n-DHCP_FOLDERS=\"/var/lib/dhclient/* /var/lib/dhcp3/* /var/lib/dhcp/*\"\n-PASSWORD_SERVER_PORT=8080\n-password_received=0\n-file_count=0\n-error_count=0\n-\n-for DHCP_FILE in $DHCP_FOLDERS; do\n-\tif [ -f $DHCP_FILE ]; then\n-\t\tfile_count=$((file_count+1))\n-\t\tPASSWORD_SERVER_IP=$(grep dhcp-server-identifier $DHCP_FILE | tail -1 | awk '{print $NF}' | tr -d '\\;')\n-\n-\t\tif [ -n \"$PASSWORD_SERVER_IP\" ]; then\n-\t\t\tlogger -t \"cloud\" \"Found password server IP $PASSWORD_SERVER_IP in $DHCP_FILE\"\n-                        break\n-\t\tfi\n-\tfi\n-done\n+# Add network provider variables here (default means that interface for network manager is eth0)\n+NETPLAN=/etc/netplan\n+IFUPDOWN=/etc/network/interfaces\n+NETMAN=/etc/sysconfig/network-scripts/ifcfg-eth0\n+\n+# Add dhcp variables\n+PASSWORD_SERVER_PORT=8080                                                                                                                                                                                                                    password_received=0                                                                                                                                                                                                                          error_count=0", "originalCommit": "5b7339ccd25dacd433aa122ee40360da09f2e5cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA5MjQ5Mw==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r423092493", "bodyText": "Yes no pb, it is most probably a copy/paste bug, I'll change it right away.", "author": "dimsijul", "createdAt": "2020-05-11T14:44:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA4NjE2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA4ODM0OA==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r423088348", "bodyText": "Maybe moving this up outside of the if block?", "author": "nvazquez", "createdAt": "2020-05-11T14:38:57Z", "path": "setup/bindir/cloud-set-guest-password.in", "diffHunk": "@@ -26,25 +26,56 @@\n # Modify this line to specify the user (default is root)\n user=root\n \n-# Add your DHCP lease folders here\n-DHCP_FOLDERS=\"/var/lib/dhclient/* /var/lib/dhcp3/* /var/lib/dhcp/*\"\n-PASSWORD_SERVER_PORT=8080\n-password_received=0\n-file_count=0\n-error_count=0\n-\n-for DHCP_FILE in $DHCP_FOLDERS; do\n-\tif [ -f $DHCP_FILE ]; then\n-\t\tfile_count=$((file_count+1))\n-\t\tPASSWORD_SERVER_IP=$(grep dhcp-server-identifier $DHCP_FILE | tail -1 | awk '{print $NF}' | tr -d '\\;')\n-\n-\t\tif [ -n \"$PASSWORD_SERVER_IP\" ]; then\n-\t\t\tlogger -t \"cloud\" \"Found password server IP $PASSWORD_SERVER_IP in $DHCP_FILE\"\n-                        break\n-\t\tfi\n-\tfi\n-done\n+# Add network provider variables here (default means that interface for network manager is eth0)\n+NETPLAN=/etc/netplan\n+IFUPDOWN=/etc/network/interfaces\n+NETMAN=/etc/sysconfig/network-scripts/ifcfg-eth0\n+\n+# Add dhcp variables\n+PASSWORD_SERVER_PORT=8080                                                                                                                                                                                                                    password_received=0                                                                                                                                                                                                                          error_count=0\n+\n+# OS is using netplan\n+if [ -d \"$NETPLAN\" ]; then\n+        logger -t \"cloud\" \"Operating System is using netplan\"\n+\n+        PASSWORD_SERVER_IP=$(netplan ip leases eth0 | grep SERVER_ADDRESS | awk '{split($0,a,\"=\"); print a[2]}')\n+\n+        if [ -n \"$PASSWORD_SERVER_IP\" ]; then\n+                 logger -t \"cloud\" \"Found password server IP $PASSWORD_SERVER_IP in netplan config\"\n+        fi\n+fi\n+\n+# OS is using ifupdown\n+if [ -f \"$IFUPDOWN\" ]; then\n+        logger -t \"cloud\" \"Operating System is using ifupdown\"\n+\n+        DHCP_FOLDERS=\"/var/lib/dhclient/* /var/lib/dhcp3/* /var/lib/dhcp/*\"\n+        file_count=0", "originalCommit": "5b7339ccd25dacd433aa122ee40360da09f2e5cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA5NjE1MQ==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r423096151", "bodyText": "I have moved it outside of the if block. I had left it there initially because only in this loop will there be a loop and and a counter but no pb.", "author": "dimsijul", "createdAt": "2020-05-11T14:49:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA4ODM0OA=="}], "type": "inlineReview"}, {"oid": "26295a23afabd34fda17c39df884edd410127abe", "url": "https://github.com/apache/cloudstack/commit/26295a23afabd34fda17c39df884edd410127abe", "message": "update file_count & syntax error\n\nfile_count outside of the if block\n3 lines instead of one too long (line 35)", "committedDate": "2020-05-11T14:48:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxNTYwNQ==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r423915605", "bodyText": "@dimsijul Hi. maybe its a good idea to change NETMAN to the directory too like NETPLAN or IFUPDOWN because eth0 can change if we dont use the naming scheme.\n\"If both systemd predictable interface naming (net.ifnames) and biosdevname naming schemes are disabled, network interfaces continue to use the unpredictable and potentially inconsistent ethX name originally given by the kernel.\"\nNETMAN=/etc/sysconfig/network-scripts", "author": "svenvogel", "createdAt": "2020-05-12T17:39:33Z", "path": "setup/bindir/cloud-set-guest-password.in", "diffHunk": "@@ -26,25 +26,58 @@\n # Modify this line to specify the user (default is root)\n user=root\n \n-# Add your DHCP lease folders here\n-DHCP_FOLDERS=\"/var/lib/dhclient/* /var/lib/dhcp3/* /var/lib/dhcp/*\"\n+# Add network provider variables here (default means that interface for network manager is eth0)\n+NETPLAN=/etc/netplan\n+IFUPDOWN=/etc/network/interfaces\n+NETMAN=/etc/sysconfig/network-scripts/ifcfg-eth0", "originalCommit": "26295a23afabd34fda17c39df884edd410127abe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI2MDE5OA==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r424260198", "bodyText": "Hi Sven,\nI see what you mean. Yes, I'll do the change to base the detection on the folder. I think the same kind of issue would apply to the netplan command though, if the interface is not declared as eth0 in the netplan config...", "author": "dimsijul", "createdAt": "2020-05-13T08:24:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxNTYwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI2NDk4Nw==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r424264987", "bodyText": "Also, I think that maybe we should do the same as the account to target  in :\nModify this line to specify the user (default is root)\nuser=root\nwith maybe :\nModify this line to specify the network interface (default is eth0)\nnetinterface=eth0\nand use that variable in netplan and nmcli commands.\nWhat do you think ?", "author": "dimsijul", "createdAt": "2020-05-13T08:32:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxNTYwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgyMDc0Nw==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r425820747", "bodyText": "@dimsijul\n\nHi Sven,\nI see what you mean. Yes, I'll do the change to base the detection on the folder. I think the same kind of issue would apply to the netplan command though, if the interface is not declared as eth0 in the netplan config...\n\nsounds good.\n\nAlso, I think that maybe we should do the same as the account to target in :\nModify this line to specify the user (default is root)\nuser=root\nwith maybe :\nModify this line to specify the network interface (default is eth0)\nnetinterface=eth0\nand use that variable in netplan and nmcli commands.\nWhat do you think ?\n\nmaybe i thread lost... what do you mean with modify user=root and netinterface=eth0... maybe you can ... you mean to specify the first interface?\ni see what you mean. yes we should use a variable for the interface but maybe its better to grep the interface. we dont send the interface to the machine so we need to find it out.", "author": "svenvogel", "createdAt": "2020-05-15T13:58:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxNTYwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgyMzc2NA==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r425823764", "bodyText": "Yes that is what I mean", "author": "dimsijul", "createdAt": "2020-05-15T14:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxNTYwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgzMTM5Mg==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r425831392", "bodyText": "maybe grep from \"ip command\" or \"nmcli\" command the interface for your script. i think we should not change the user. so we want to change the root password.", "author": "svenvogel", "createdAt": "2020-05-15T14:15:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxNTYwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgzNDU4NQ==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r425834585", "bodyText": "I did not mean to change the user, but maybe to use the same logic by specifying the interface instead of assuming it is eth0. Maybe it can be retrieved as you mention. I'll do the tests.", "author": "dimsijul", "createdAt": "2020-05-15T14:19:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxNTYwNQ=="}], "type": "inlineReview"}, {"oid": "d683a8933ca1e47fd0f112553e5993857a005d4b", "url": "https://github.com/apache/cloudstack/commit/d683a8933ca1e47fd0f112553e5993857a005d4b", "message": "Detection of netman to base it on folder", "committedDate": "2020-05-13T08:28:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgzNzM3NA==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r425837374", "bodyText": "maybe a stupid solution like, if we have more than one interface and use only show and grep/regex for an ip\nnmcli -f IP4.GATEWAY device show | ...regex...", "author": "svenvogel", "createdAt": "2020-05-15T14:23:52Z", "path": "setup/bindir/cloud-set-guest-password.in", "diffHunk": "@@ -26,25 +26,58 @@\n # Modify this line to specify the user (default is root)\n user=root\n \n-# Add your DHCP lease folders here\n-DHCP_FOLDERS=\"/var/lib/dhclient/* /var/lib/dhcp3/* /var/lib/dhcp/*\"\n+# Add network provider variables here (default means that interface for network manager is eth0)\n+NETPLAN=/etc/netplan\n+IFUPDOWN=/etc/network/interfaces\n+NETMAN=/etc/sysconfig/network-scripts\n+\n+# Add dhcp variables\n PASSWORD_SERVER_PORT=8080\n password_received=0\n-file_count=0\n error_count=0\n+file_count=0\n \n-for DHCP_FILE in $DHCP_FOLDERS; do\n-\tif [ -f $DHCP_FILE ]; then\n-\t\tfile_count=$((file_count+1))\n-\t\tPASSWORD_SERVER_IP=$(grep dhcp-server-identifier $DHCP_FILE | tail -1 | awk '{print $NF}' | tr -d '\\;')\n+# OS is using netplan\n+if [ -d \"$NETPLAN\" ]; then\n+        logger -t \"cloud\" \"Operating System is using netplan\"\n \n-\t\tif [ -n \"$PASSWORD_SERVER_IP\" ]; then\n-\t\t\tlogger -t \"cloud\" \"Found password server IP $PASSWORD_SERVER_IP in $DHCP_FILE\"\n-                        break\n-\t\tfi\n-\tfi\n-done\n+        PASSWORD_SERVER_IP=$(netplan ip leases eth0 | grep SERVER_ADDRESS | awk '{split($0,a,\"=\"); print a[2]}')\n+\n+        if [ -n \"$PASSWORD_SERVER_IP\" ]; then\n+                 logger -t \"cloud\" \"Found password server IP $PASSWORD_SERVER_IP in netplan config\"\n+        fi\n+fi\n+\n+# OS is using ifupdown\n+if [ -f \"$IFUPDOWN\" ]; then\n+        logger -t \"cloud\" \"Operating System is using ifupdown\"\n+\n+        DHCP_FOLDERS=\"/var/lib/dhclient/* /var/lib/dhcp3/* /var/lib/dhcp/*\"\n+\n+        for DHCP_FILE in $DHCP_FOLDERS; do\n+                if [ -f $DHCP_FILE ]; then\n+                        file_count=$((file_count+1))\n+                        PASSWORD_SERVER_IP=$(grep dhcp-server-identifier $DHCP_FILE | tail -1 | awk '{print $NF}' | tr -d '\\;')\n+\n+                        if [ -n \"$PASSWORD_SERVER_IP\" ]; then\n+                                logger -t \"cloud\" \"Found password server IP $PASSWORD_SERVER_IP in $DHCP_FILE\"\n+                                break\n+                        fi\n+                fi\n+        done\n+fi\n+\n+# OS is using network interfaces\n+if [ -d \"$NETMAN\" ]; then\n+        logger -t \"cloud\" \"Operating System is using network manager\"\n+\n+        PASSWORD_SERVER_IP=$(nmcli -f IP4.GATEWAY device show eth0 | sed 's/ //g' | awk '{split($0,a,\":\"); print a[2]}')", "originalCommit": "d683a8933ca1e47fd0f112553e5993857a005d4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY0MzM0OQ==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r426643349", "bodyText": "I have used this command to retrieve the interface name :\nNETINT=$(ip -o -4 route show to default | awk '{print $5}')", "author": "dimsijul", "createdAt": "2020-05-18T13:54:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgzNzM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE2NTgyNw==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r427165827", "bodyText": "let me test but i think this sound not bad ... we pick the default is an good idea :)", "author": "svenvogel", "createdAt": "2020-05-19T09:35:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgzNzM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI3NTYzOA==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r427275638", "bodyText": "Hi Sven,\nthanks for testing. On our side, we have tested it on :\n\nCentOS 8\nDebian 10\nDebian 9\nUbuntu 20.04\nUbuntu 18.04\nUbuntu 16.04\n\nLet me know if your tests go well.\nCheers,\nJulien", "author": "dimsijul", "createdAt": "2020-05-19T12:50:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgzNzM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM0MjY2OQ==", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r427342669", "bodyText": "yes sounds good. did you test it? command is working fine. we are only use this for netplan and networkmanager otherwise we go the old way, so we dont break any existing functionality.", "author": "svenvogel", "createdAt": "2020-05-19T14:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgzNzM3NA=="}], "type": "inlineReview"}, {"oid": "e577ce0f84da3e14a5d0ae5aa1b597a97b4aa85d", "url": "https://github.com/apache/cloudstack/commit/e577ce0f84da3e14a5d0ae5aa1b597a97b4aa85d", "message": "Update cloud-set-guest-password.in", "committedDate": "2020-05-18T13:53:28Z", "type": "commit"}]}