{"pr_number": 4176, "pr_title": "server: Purge all cookies on logout, set /client path on login", "pr_createdAt": "2020-06-24T17:02:34Z", "pr_url": "https://github.com/apache/cloudstack/pull/4176", "timeline": [{"oid": "57e3fcf4170b4cb7b147d7b35a02945a19a0f4ae", "url": "https://github.com/apache/cloudstack/commit/57e3fcf4170b4cb7b147d7b35a02945a19a0f4ae", "message": "server: Purge all cookies on logout, set /client path on login\n\nThis will purge all the cookies on logout including multiple sessionkey\ncookies if passed. On login, this will restrict sessionkey cookie\n(httponly) to the /client path like the JSESSIONID cookie.\n\nFixes #4136\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>", "committedDate": "2020-06-24T16:58:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA0MjUxNw==", "url": "https://github.com/apache/cloudstack/pull/4176#discussion_r445042517", "bodyText": "We need to check if this is necessary or not", "author": "rhtyd", "createdAt": "2020-06-24T17:04:28Z", "path": "server/src/main/java/com/cloud/api/ApiServlet.java", "diffHunk": "@@ -213,7 +213,7 @@ void processRequestInContext(final HttpServletRequest req, final HttpServletResp\n                     try {\n                         responseString = apiAuthenticator.authenticate(command, params, session, remoteAddress, responseType, auditTrailSb, req, resp);\n                         if (session != null && session.getAttribute(ApiConstants.SESSIONKEY) != null) {\n-                            resp.addHeader(\"SET-COOKIE\", String.format(\"%s=%s;HttpOnly\", ApiConstants.SESSIONKEY, session.getAttribute(ApiConstants.SESSIONKEY)));\n+                            resp.addHeader(\"SET-COOKIE\", String.format(\"%s=%s;HttpOnly;Path=/client\", ApiConstants.SESSIONKEY, session.getAttribute(ApiConstants.SESSIONKEY)));", "originalCommit": "57e3fcf4170b4cb7b147d7b35a02945a19a0f4ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM0MDAxMQ==", "url": "https://github.com/apache/cloudstack/pull/4176#discussion_r445340011", "bodyText": "@davidjumani please explore if this would work, without adding the /client path to the cookie; as I worry if this change can potentially break non-standard env (those which don't use the default context path of /client as defined in /etc/cloudstack/management/server.properties)", "author": "rhtyd", "createdAt": "2020-06-25T06:44:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA0MjUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM1MjQxNQ==", "url": "https://github.com/apache/cloudstack/pull/4176#discussion_r445352415", "bodyText": "Looks like it is necessary, if not present, two sessionkeys are present\nIf non-standard implementations are the case, wouldn't JSESSIONID cause issues too?\nAlso exploring saml logins", "author": "davidjumani", "createdAt": "2020-06-25T07:14:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA0MjUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTUwMzI0NA==", "url": "https://github.com/apache/cloudstack/pull/4176#discussion_r445503244", "bodyText": "@davidjumani in a deploy trillian env with this PR (or you may use the primate-qa server as well which has this PR) and both old UI and Primate, can you check side-effects when you change the context in /etc/cloudstack/management/server.properties from /client/ to say (a) /somenew-path and (b) / and restart management server and try log-in in both legacy UI and Primate (check network an Application/cookies)", "author": "rhtyd", "createdAt": "2020-06-25T11:56:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA0MjUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYzMjU1NA==", "url": "https://github.com/apache/cloudstack/pull/4176#discussion_r445632554", "bodyText": "Nevermind I tested, this will break if path is restricted to /client only; ideally shoud match the webapp context path", "author": "rhtyd", "createdAt": "2020-06-25T15:10:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA0MjUxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MDA5NQ==", "url": "https://github.com/apache/cloudstack/pull/4176#discussion_r445080095", "bodyText": "@rhtyd missing brace", "author": "shwstppr", "createdAt": "2020-06-24T18:11:31Z", "path": "server/src/main/java/com/cloud/api/ApiServlet.java", "diffHunk": "@@ -238,9 +238,14 @@ void processRequestInContext(final HttpServletRequest req, final HttpServletResp\n                             } catch (final IllegalStateException ignored) {\n                             }\n                         }\n-                        Cookie sessionKeyCookie = new Cookie(ApiConstants.SESSIONKEY, \"\");\n-                        sessionKeyCookie.setMaxAge(0);\n-                        resp.addCookie(sessionKeyCookie);\n+                        final Cookie[] cookies = req.getCookies();\n+                        if (cookies != null)", "originalCommit": "57e3fcf4170b4cb7b147d7b35a02945a19a0f4ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "15be473e6c256b3fc8d1088638be2242e67d3fa0", "url": "https://github.com/apache/cloudstack/commit/15be473e6c256b3fc8d1088638be2242e67d3fa0", "message": "Add brace", "committedDate": "2020-06-24T18:29:23Z", "type": "commit"}, {"oid": "d629eb15bbd76f6b485aa11674947a8575be44b1", "url": "https://github.com/apache/cloudstack/commit/d629eb15bbd76f6b485aa11674947a8575be44b1", "message": "set cookie path to webapp context path", "committedDate": "2020-06-25T15:14:17Z", "type": "commit"}, {"oid": "b7e88bcb9f336c595c0a8cb80603b10c9997317c", "url": "https://github.com/apache/cloudstack/commit/b7e88bcb9f336c595c0a8cb80603b10c9997317c", "message": "Update ApiServlet.java", "committedDate": "2020-07-04T05:12:14Z", "type": "commit"}, {"oid": "6605d015265cdf83717f3fbe9b4c96b4d040081a", "url": "https://github.com/apache/cloudstack/commit/6605d015265cdf83717f3fbe9b4c96b4d040081a", "message": "Change sessionkey cookie path", "committedDate": "2020-07-07T14:27:30Z", "type": "commit"}]}