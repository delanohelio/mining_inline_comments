{"pr_number": 4193, "pr_title": "Fix usage record count", "pr_createdAt": "2020-07-01T12:21:19Z", "pr_url": "https://github.com/apache/cloudstack/pull/4193", "timeline": [{"oid": "5b5a2e54dd2016481385d3b8558f23280d5047d1", "url": "https://github.com/apache/cloudstack/commit/5b5a2e54dd2016481385d3b8558f23280d5047d1", "message": "Fix usage record count fix", "committedDate": "2020-07-01T12:20:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ3ODc4OQ==", "url": "https://github.com/apache/cloudstack/pull/4193#discussion_r449478789", "bodyText": "As this code is in a test if (usageId != null), it will remove IP address usage only if the API command listUsageRecords was called with a specific usageId parameter.\nFor API calls like command=listUsageRecords&startdate=xxx&enddate=xxx, it will include all usage records, including for IP addresses on networks with \"Hide usage\".", "author": "olivierlemasle", "createdAt": "2020-07-03T09:23:17Z", "path": "server/src/main/java/com/cloud/usage/UsageServiceImpl.java", "diffHunk": "@@ -328,9 +333,20 @@ public boolean generateUsageRecords(GenerateUsageRecordsCmd cmd) {\n                     break;\n                 case UsageTypes.IP_ADDRESS:\n                     IPAddressVO ip = _ipDao.findByUuidIncludingRemoved(usageId);\n-                    if (ip != null) {\n-                        usageDbId = ip.getId();\n+                    if (ip == null) {\n+                        break;\n+                    }\n+                    Long networkId = ip.getAssociatedWithNetworkId();\n+                    if (networkId == null) {\n+                        networkId = ip.getSourceNetworkId();\n+                    }\n+                    NetworkDetailVO networkDetail = _networkDetailsDao.findDetail(networkId, Network.hideIpAddressUsage);\n+                    if (networkDetail != null && networkDetail.getValue() != null && networkDetail.getValue().equals(\"true\")) {", "originalCommit": "69eeac38a7c9263988da73ccb444dac988f67032", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f5dd55c334e5319b33d5c1803c3df4ccf104185b", "url": "https://github.com/apache/cloudstack/commit/f5dd55c334e5319b33d5c1803c3df4ccf104185b", "message": "fix usage record", "committedDate": "2020-09-17T04:15:59Z", "type": "commit"}, {"oid": "2be830e18e9c39fea706b34187901df74f926d1a", "url": "https://github.com/apache/cloudstack/commit/2be830e18e9c39fea706b34187901df74f926d1a", "message": "Merge branch '4.13' of https://github.com/apache/cloudstack into usage_record_cnt_fix", "committedDate": "2020-09-17T04:16:12Z", "type": "commit"}, {"oid": "2be830e18e9c39fea706b34187901df74f926d1a", "url": "https://github.com/apache/cloudstack/commit/2be830e18e9c39fea706b34187901df74f926d1a", "message": "Merge branch '4.13' of https://github.com/apache/cloudstack into usage_record_cnt_fix", "committedDate": "2020-09-17T04:16:12Z", "type": "forcePushed"}]}