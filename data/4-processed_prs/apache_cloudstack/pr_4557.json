{"pr_number": 4557, "pr_title": "Fixed instance creation failure on dvswitch when using vlan id 4095", "pr_createdAt": "2020-12-22T10:13:00Z", "pr_url": "https://github.com/apache/cloudstack/pull/4557", "timeline": [{"oid": "0e2f9ae147eb345e71379007c4096902d785e6d3", "url": "https://github.com/apache/cloudstack/commit/0e2f9ae147eb345e71379007c4096902d785e6d3", "message": "Fixed instance creation failure on dvswitch when using vlan id 4095", "committedDate": "2020-12-22T10:10:48Z", "type": "commit"}, {"oid": "1b48ee2d470ae4a95e9adca68bbb9de59024b2f6", "url": "https://github.com/apache/cloudstack/commit/1b48ee2d470ae4a95e9adca68bbb9de59024b2f6", "message": "Null pointer", "committedDate": "2020-12-22T11:13:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMwNzc4OQ==", "url": "https://github.com/apache/cloudstack/pull/4557#discussion_r547307789", "bodyText": "so if (vlanId == 4095) we set the range and  vlanId but if (vlanId == null) we don't care about the set range. is this intentional?", "author": "DaanHoogland", "createdAt": "2020-12-22T14:28:03Z", "path": "vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/HypervisorHostHelper.java", "diffHunk": "@@ -1073,6 +1073,10 @@ public static VMwareDVSPvlanConfigSpec createDVPortPvlanConfigSpec(int vlanId, i\n     }\n \n     public static VmwareDistributedVirtualSwitchVlanSpec createDVPortVlanSpec(Integer vlanId, String vlanRange) {\n+        if (vlanId != null && vlanId == 4095){\n+            vlanId = null;\n+            vlanRange = \"0-4094\";\n+        }", "originalCommit": "1b48ee2d470ae4a95e9adca68bbb9de59024b2f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMxMjg2Ng==", "url": "https://github.com/apache/cloudstack/pull/4557#discussion_r547312866", "bodyText": "@DaanHoogland Yes the 4095 vlan ID is used a magic no. to create a trunked port group; this already exists for other hypervisors like kvm - https://cwiki.apache.org/confluence/display/CLOUDSTACK/Enable+vlan+4095+%27tag+passthrough%27+for+KVM", "author": "rhtyd", "createdAt": "2020-12-22T14:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMwNzc4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMxNjA2NA==", "url": "https://github.com/apache/cloudstack/pull/4557#discussion_r547316064", "bodyText": "yes, i understand the function of vlandId == 4095 but my point is that it will be possible to pass vlanId == null and range == '2-9,15-99,4000-4094' or even range == '4000-4095', and should we correct that combination of parameters?", "author": "DaanHoogland", "createdAt": "2020-12-22T14:43:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMwNzc4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMxNjQ1MQ==", "url": "https://github.com/apache/cloudstack/pull/4557#discussion_r547316451", "bodyText": "maybe not relevant enough to this fix, never mind", "author": "DaanHoogland", "createdAt": "2020-12-22T14:44:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMwNzc4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE2NjAxMQ==", "url": "https://github.com/apache/cloudstack/pull/4557#discussion_r553166011", "bodyText": "@Spaceman1984 Have you tested this?\nthis method createDVPortVlanSpec() is called only when vlanId is null, so if check here is always 'false' and the underlying code never executes. Please check and try to fix this in the appropriate top level method in the call stack.", "author": "sureshanaparti", "createdAt": "2021-01-07T08:05:22Z", "path": "vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/HypervisorHostHelper.java", "diffHunk": "@@ -1073,6 +1073,10 @@ public static VMwareDVSPvlanConfigSpec createDVPortPvlanConfigSpec(int vlanId, i\n     }\n \n     public static VmwareDistributedVirtualSwitchVlanSpec createDVPortVlanSpec(Integer vlanId, String vlanRange) {\n+        if (vlanId != null && vlanId == 4095){", "originalCommit": "1b48ee2d470ae4a95e9adca68bbb9de59024b2f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc2NTQyMA==", "url": "https://github.com/apache/cloudstack/pull/4557#discussion_r553765420", "bodyText": "This method is not onlly called when vlanid is null.\nIf vid is not null, spvlanid would be evaluated and if spvlanid is null, the method will be called.\nif (vid == null || spvlanid == null) {\n    vlanspec = createDVPortVlanSpec(vid, vlanRange);\n    ...\n}\n\nI tested this as I stated in the description.", "author": "Spaceman1984", "createdAt": "2021-01-08T06:29:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE2NjAxMQ=="}], "type": "inlineReview"}]}