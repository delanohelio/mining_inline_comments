{"pr_number": 3795, "pr_title": "Agent lb on svm", "pr_createdAt": "2020-01-06T12:13:09Z", "pr_url": "https://github.com/apache/cloudstack/pull/3795", "timeline": [{"oid": "d392e6ad23622590364b9feb36e7b52d251c5205", "url": "https://github.com/apache/cloudstack/commit/d392e6ad23622590364b9feb36e7b52d251c5205", "message": "add host if needed", "committedDate": "2020-01-06T11:51:56Z", "type": "commit"}, {"oid": "5808ad89bf0b41209801848890ad1714540e5532", "url": "https://github.com/apache/cloudstack/commit/5808ad89bf0b41209801848890ad1714540e5532", "message": "allow for test with null-host", "committedDate": "2020-01-06T13:33:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYxMTc5MQ==", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363611791", "bodyText": "We can do null checks and if host is removed or is some unsupported state like error etc.?", "author": "rhtyd", "createdAt": "2020-01-07T06:51:54Z", "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +144,48 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {", "originalCommit": "5808ad89bf0b41209801848890ad1714540e5532", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYxMTkzNA==", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363611934", "bodyText": "oh I see it's already here, we could probably do something like item in array where array is list of unsupported states?", "author": "rhtyd", "createdAt": "2020-01-07T06:52:40Z", "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +144,48 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(\"trying to add no host to a list\");\n             }\n-            if (host.getType() == Host.Type.Routing || host.getType() == Host.Type.ConsoleProxy || host.getType() == Host.Type.SecondaryStorage || host.getType() == Host.Type.SecondaryStorageVM) {\n-                if (host.getHypervisorType() != null && host.getHypervisorType() != Hypervisor.HypervisorType.KVM && host.getHypervisorType() != Hypervisor.HypervisorType.LXC) {\n-                    continue;\n-                }\n-                agentBasedHosts.add(host);\n+            return;\n+        }\n+        if (host.getResourceState() == ResourceState.Creating) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(String.format(\"host is in creating state, not adding to the host list, (id = %s)\", host.getUuid()));\n             }\n+            return;\n         }\n-        return agentBasedHosts;\n+        if (host.getResourceState() == ResourceState.Error) {", "originalCommit": "5808ad89bf0b41209801848890ad1714540e5532", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY2NDUxMQ==", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363664511", "bodyText": "refactorred have a look, @rhtyd . I think it is cosmetic but it does make a point.", "author": "DaanHoogland", "createdAt": "2020-01-07T09:41:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYxMTkzNA=="}], "type": "inlineReview"}, {"oid": "5735e6eaecca28258f31db93c482f927647f5024", "url": "https://github.com/apache/cloudstack/commit/5735e6eaecca28258f31db93c482f927647f5024", "message": "full coverage of states", "committedDate": "2020-01-07T09:38:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4MjU2NQ==", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363682565", "bodyText": "Why not use Arrays.asList()?", "author": "rhtyd", "createdAt": "2020-01-07T10:25:15Z", "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +146,54 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(\"trying to add no host to a list\");\n             }\n-            if (host.getType() == Host.Type.Routing || host.getType() == Host.Type.ConsoleProxy || host.getType() == Host.Type.SecondaryStorage || host.getType() == Host.Type.SecondaryStorageVM) {\n-                if (host.getHypervisorType() != null && host.getHypervisorType() != Hypervisor.HypervisorType.KVM && host.getHypervisorType() != Hypervisor.HypervisorType.LXC) {\n-                    continue;\n-                }\n-                agentBasedHosts.add(host);\n+            return;\n+        }\n+\n+        ResourceState[] allowedStates = new ResourceState[]{", "originalCommit": "5735e6eaecca28258f31db93c482f927647f5024", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4MjY4Nw==", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363682687", "bodyText": "Why not use list.contains()?", "author": "rhtyd", "createdAt": "2020-01-07T10:25:31Z", "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +146,54 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(\"trying to add no host to a list\");\n             }\n-            if (host.getType() == Host.Type.Routing || host.getType() == Host.Type.ConsoleProxy || host.getType() == Host.Type.SecondaryStorage || host.getType() == Host.Type.SecondaryStorageVM) {\n-                if (host.getHypervisorType() != null && host.getHypervisorType() != Hypervisor.HypervisorType.KVM && host.getHypervisorType() != Hypervisor.HypervisorType.LXC) {\n-                    continue;\n-                }\n-                agentBasedHosts.add(host);\n+            return;\n+        }\n+\n+        ResourceState[] allowedStates = new ResourceState[]{\n+                ResourceState.Enabled,\n+                ResourceState.Maintenance,\n+                ResourceState.Disabled,\n+                ResourceState.ErrorInMaintenance,\n+                ResourceState.PrepareForMaintenance\n+        };\n+        // so the remaining ResourceState[] disallowedStates = new ResourceState[]{ResourceState.Creating, ResourceState.Error};\n+        if (binarySearch(allowedStates, host.getResourceState()) < 0) {", "originalCommit": "5735e6eaecca28258f31db93c482f927647f5024", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcwMDI2MQ==", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363700261", "bodyText": "seems like less cpu power/more code?", "author": "DaanHoogland", "createdAt": "2020-01-07T11:11:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4MjY4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc0NzUxMQ==", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363747511", "bodyText": "@rhtyd ?", "author": "DaanHoogland", "createdAt": "2020-01-07T13:30:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4MjY4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc1MzM1MA==", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363753350", "bodyText": "@DaanHoogland premature optimisation is... nope there won't be a lot of performance gain. If you have to you can use Collections.binarySearch()", "author": "rhtyd", "createdAt": "2020-01-07T13:45:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4MjY4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc2MTk0OQ==", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363761949", "bodyText": "ok, it felt quite natural to me, but will use an EnumSet.contains().", "author": "DaanHoogland", "createdAt": "2020-01-07T14:04:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4MjY4Nw=="}], "type": "inlineReview"}, {"oid": "78db672ffe18ab93289152137b406ed04c1556f4", "url": "https://github.com/apache/cloudstack/commit/78db672ffe18ab93289152137b406ed04c1556f4", "message": "EnumSet.contains instead of Arrays.binarySearch", "committedDate": "2020-01-07T14:12:14Z", "type": "commit"}]}