{"pr_number": 3862, "pr_title": "Userdata to display static NAT as public ip instead of VR ip", "pr_createdAt": "2020-02-04T10:09:08Z", "pr_url": "https://github.com/apache/cloudstack/pull/3862", "timeline": [{"oid": "b131cf1961414170c793fb09f050477d8d83340f", "url": "https://github.com/apache/cloudstack/commit/b131cf1961414170c793fb09f050477d8d83340f", "message": "Userdata to display static NAT as public ip instead of VR ip\n\nIf static nat is enabled on VM then metadata service should return\nthe static nat instead of gateway IP.\nIf static not is not enabled then it should return the gateway IP\nas the public IP\n\nTest results:\n\nStep to reproduce:\n\n1. Create a vm\n2. Ssh to vm.\n3. Run the below command inside the vm\nwget http://<VR public ip>/latest/meta-data/public-ipv4\n\nNote down the output of the above command\n4. Now acquire a new public and enable static NAT on that IP to this vm\n5. Now run the same command mentioned above in the VM\nThis should display the static NAT ip instead of VR public IP\n\nOutput:\n\nBefore enabling static nat\n\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.10.10.29\n\nAfter enabling static nat\n\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.11.10.30", "committedDate": "2020-02-12T10:20:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUxOTk0OA==", "url": "https://github.com/apache/cloudstack/pull/3862#discussion_r381519948", "bodyText": "@ravening you missed one check here\n-            } else {\n+            } else if (router.getPublicIpAddress() != null) {", "author": "weizhouapache", "createdAt": "2020-02-19T20:16:38Z", "path": "server/src/main/java/com/cloud/network/router/CommandSetupHelper.java", "diffHunk": "@@ -1024,18 +1026,21 @@ private VmDataCommand generateVmDataCommand(final VirtualRouter router, final St\n         cmd.addVmData(\"userdata\", \"user-data\", userData);\n         cmd.addVmData(\"metadata\", \"service-offering\", StringUtils.unicodeEscape(serviceOffering));\n         cmd.addVmData(\"metadata\", \"availability-zone\", StringUtils.unicodeEscape(zoneName));\n-        cmd.addVmData(\"metadata\", \"local-ipv4\", guestIpAddress);\n+        cmd.addVmData(\"metadata\", \"local-ipv4\", vmPrivateIpAddress);\n         cmd.addVmData(\"metadata\", \"local-hostname\", StringUtils.unicodeEscape(vmName));\n-        if (dcVo.getNetworkType() == NetworkType.Basic) {\n-            cmd.addVmData(\"metadata\", \"public-ipv4\", guestIpAddress);\n+\n+        Network network = _networkDao.findById(guestNetworkId);\n+        if (dcVo.getNetworkType() == NetworkType.Basic || network.getGuestType() == Network.GuestType.Shared) {\n+            cmd.addVmData(\"metadata\", \"public-ipv4\", vmPrivateIpAddress);\n             cmd.addVmData(\"metadata\", \"public-hostname\", StringUtils.unicodeEscape(vmName));\n         } else {\n-            if (router.getPublicIpAddress() == null) {\n-                cmd.addVmData(\"metadata\", \"public-ipv4\", guestIpAddress);\n+            if (publicIpAddress != null) {\n+                cmd.addVmData(\"metadata\", \"public-ipv4\", publicIpAddress);\n+                cmd.addVmData(\"metadata\", \"public-hostname\", publicIpAddress);\n             } else {", "originalCommit": "b131cf1961414170c793fb09f050477d8d83340f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg4MzE2Ng==", "url": "https://github.com/apache/cloudstack/pull/3862#discussion_r381883166", "bodyText": "Made necessary changes", "author": "ravening", "createdAt": "2020-02-20T09:37:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUxOTk0OA=="}], "type": "inlineReview"}, {"oid": "bef2f533ec8b5cc8e6a83ba47b40086ecc8a9444", "url": "https://github.com/apache/cloudstack/commit/bef2f533ec8b5cc8e6a83ba47b40086ecc8a9444", "message": "Userdata to display static NAT as public ip instead of VR ip\n\nIf static nat is enabled on VM then metadata service should return\nthe static nat instead of gateway IP.\nIf static not is not enabled then it should return the gateway IP\nas the public IP\n\nTest results:\n\nStep to reproduce:\n\n1. Create a vm\n2. Ssh to vm.\n3. Run the below command inside the vm\nwget http://<VR public ip>/latest/meta-data/public-ipv4\n\nNote down the output of the above command\n4. Now acquire a new public and enable static NAT on that IP to this vm\n5. Now run the same command mentioned above in the VM\nThis should display the static NAT ip instead of VR public IP\n\nOutput:\n\nBefore enabling static nat\n\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.10.10.29\n\nAfter enabling static nat\n\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.11.10.30", "committedDate": "2020-02-20T09:36:08Z", "type": "commit"}, {"oid": "bef2f533ec8b5cc8e6a83ba47b40086ecc8a9444", "url": "https://github.com/apache/cloudstack/commit/bef2f533ec8b5cc8e6a83ba47b40086ecc8a9444", "message": "Userdata to display static NAT as public ip instead of VR ip\n\nIf static nat is enabled on VM then metadata service should return\nthe static nat instead of gateway IP.\nIf static not is not enabled then it should return the gateway IP\nas the public IP\n\nTest results:\n\nStep to reproduce:\n\n1. Create a vm\n2. Ssh to vm.\n3. Run the below command inside the vm\nwget http://<VR public ip>/latest/meta-data/public-ipv4\n\nNote down the output of the above command\n4. Now acquire a new public and enable static NAT on that IP to this vm\n5. Now run the same command mentioned above in the VM\nThis should display the static NAT ip instead of VR public IP\n\nOutput:\n\nBefore enabling static nat\n\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.10.10.29\n\nAfter enabling static nat\n\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.11.10.30", "committedDate": "2020-02-20T09:36:08Z", "type": "forcePushed"}, {"oid": "e77d23e8f943d4fbb6912573598ff584d377e60c", "url": "https://github.com/apache/cloudstack/commit/e77d23e8f943d4fbb6912573598ff584d377e60c", "message": "server: apply vm user data when release a public ip", "committedDate": "2020-02-25T09:54:32Z", "type": "commit"}]}