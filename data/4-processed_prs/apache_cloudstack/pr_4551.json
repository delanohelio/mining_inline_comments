{"pr_number": 4551, "pr_title": "Cleanup volume information from db when deleted", "pr_createdAt": "2020-12-18T06:04:47Z", "pr_url": "https://github.com/apache/cloudstack/pull/4551", "timeline": [{"oid": "4ded3a248f2609e774eedb510b541aeee790b393", "url": "https://github.com/apache/cloudstack/commit/4ded3a248f2609e774eedb510b541aeee790b393", "message": "Cleanup volume information from db when deleted", "committedDate": "2020-12-17T10:59:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMTU5Ng==", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r545731596", "bodyText": "it looks same as storeVolumeSearch", "author": "weizhouapache", "createdAt": "2020-12-18T10:10:40Z", "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/image/db/VolumeDataStoreDaoImpl.java", "diffHunk": "@@ -120,6 +120,11 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n         uploadVolumeStateSearch.and(\"destroyed\", uploadVolumeStateSearch.entity().getDestroyed(), SearchCriteria.Op.EQ);\n         uploadVolumeStateSearch.done();\n \n+        allVolumesSearch = this.createSearchBuilder();", "originalCommit": "4ded3a248f2609e774eedb510b541aeee790b393", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e", "url": "https://github.com/apache/cloudstack/commit/717a849e277da2ba749db1bc94cc04b6eb79395e", "message": "reuse search builder", "committedDate": "2020-12-18T12:56:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzk1NDQwMQ==", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r603954401", "bodyText": "is not null enough? what if it is an object but doesn't exist? or it does but not on imageStore?", "author": "DaanHoogland", "createdAt": "2021-03-30T09:57:03Z", "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -392,15 +405,16 @@ protected Answer copyVolumeBetweenPools(DataObject srcData, DataObject destData)\n                     return answer;\n                 }\n             } catch (Exception e) {\n-                if (imageStore.exists(objOnImageStore)) {\n+                if (objOnImageStore != null) {", "originalCommit": "717a849e277da2ba749db1bc94cc04b6eb79395e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDYxNTgzMA==", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r604615830", "bodyText": "imagestore.exists() eventually calls volumeDataStoreDao.findByStoreVolume(...) for volumes, which in case of multiple entries could possibly return the wrong record", "author": "Pearl1594", "createdAt": "2021-03-31T06:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzk1NDQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjIwMTA0Nw==", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r606201047", "bodyText": "ok, but still, the objOnImageStore may be a valid object that represents nothing on our imageStore, can it? shouldn't we protect against that as well?", "author": "DaanHoogland", "createdAt": "2021-04-02T11:45:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzk1NDQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjk5NjE4OQ==", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r606996189", "bodyText": "@DaanHoogland I didn't quite understand your previous comment. Could you please explain what you mean by it. Thanks", "author": "Pearl1594", "createdAt": "2021-04-05T09:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzk1NDQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzAzNDQxNg==", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r607034416", "bodyText": "@Pearl1594 what you are saying might be true but during catch() we have to check if DB entry really exists or not and process the image storage object by marking it OperationFailed. objOnImageStore will always be != null (\"DataObject objOnImageStore = imageStore.create(srcData);\") since no where in try{} block we are setting to null or changing the object.\n@DaanHoogland in that method we are dealing only with database entries. If you are asking if it represents nothing on imagestore \"physically\" then the answer is we don't need to be concerned about that.", "author": "harikrishna-patnala", "createdAt": "2021-04-05T11:00:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzk1NDQwMQ=="}], "type": "inlineReview"}, {"oid": "6ba974e3e6e11b2e8d9c2118d1ebd1a0540cbbfa", "url": "https://github.com/apache/cloudstack/commit/6ba974e3e6e11b2e8d9c2118d1ebd1a0540cbbfa", "message": "Merge branch '4.15' of https://github.com/apache/cloudstack into db-cleanup-volumes", "committedDate": "2021-04-01T05:13:30Z", "type": "commit"}, {"oid": "cf4d1bb01c1860584b6ce3ee6713a70e71e29ea8", "url": "https://github.com/apache/cloudstack/commit/cf4d1bb01c1860584b6ce3ee6713a70e71e29ea8", "message": "Merge branch '4.15' of https://github.com/apache/cloudstack into db-cleanup-volumes", "committedDate": "2021-04-06T06:29:26Z", "type": "commit"}, {"oid": "cc8bd638f1cdb8584a35daef1cc9d6df0d05b8ca", "url": "https://github.com/apache/cloudstack/commit/cc8bd638f1cdb8584a35daef1cc9d6df0d05b8ca", "message": "revert change", "committedDate": "2021-04-06T06:33:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzU2NTI5NA==", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r607565294", "bodyText": "if any volumes on store at this point, have to remove  them. check if you have to call deleteVolumeOnSecondaryStore() in this case as well", "author": "sureshanaparti", "createdAt": "2021-04-06T06:44:52Z", "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -392,15 +405,16 @@ protected Answer copyVolumeBetweenPools(DataObject srcData, DataObject destData)\n                     return answer;\n                 }\n             } catch (Exception e) {\n-                if (imageStore.exists(objOnImageStore)) {\n+                if (objOnImageStore != null) {\n                     objOnImageStore.processEvent(Event.OperationFailed);\n                     imageStore.delete(objOnImageStore);", "originalCommit": "717a849e277da2ba749db1bc94cc04b6eb79395e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzgxODEzNg==", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r613818136", "bodyText": "@Pearl1594 can you reply ^^", "author": "rhtyd", "createdAt": "2021-04-15T07:22:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzU2NTI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzgxOTA1Mg==", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r613819052", "bodyText": "It makes sense to delete the volume on secondary store on failure. Will add that - needs testing.", "author": "Pearl1594", "createdAt": "2021-04-15T07:23:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzU2NTI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDU2ODYwMg==", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r660568602", "bodyText": "@Pearl1594 any update on the changes / testing ?", "author": "sureshanaparti", "createdAt": "2021-06-29T12:30:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzU2NTI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDU5ODYxNg==", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r660598616", "bodyText": "Haven't had the chance to get to testing this yet @sureshanaparti  - Will do it by end of this week.", "author": "Pearl1594", "createdAt": "2021-06-29T13:07:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzU2NTI5NA=="}], "type": "inlineReview"}]}