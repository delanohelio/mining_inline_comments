{"pr_number": 4359, "pr_title": "Failed to update host password if username/password is not saved in db", "pr_createdAt": "2020-09-30T23:01:43Z", "pr_url": "https://github.com/apache/cloudstack/pull/4359", "timeline": [{"oid": "549dd14de57e19edeb6862e1286e673ed05033e1", "url": "https://github.com/apache/cloudstack/commit/549dd14de57e19edeb6862e1286e673ed05033e1", "message": "Failed to update host password if username/password is not saved in Cloudstack DB\n\nIf the entries for a host in host_details table are missing then we cant update the\npassword of the host using the cloudmonkey command\nThis can happen because host was removed earlier resulting in deletion\nof entries in the database\n\nThis commit fixes the issue\n\n(local) mgt01 > update hostpassword\nhostid=50436ac8-b73a-4eaf-bbab-7adbd9a50870 username=root\npassword=cloudstack\n{\n  \"success\": true\n}\n\nNow the entries should be added in host_details table as well", "committedDate": "2020-10-12T08:31:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r503423069", "bodyText": "username from the command object can be null or empty ?", "author": "sureshanaparti", "createdAt": "2020-10-12T17:00:11Z", "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -3938,7 +3938,12 @@ public void doInTransactionWithoutResult(final TransactionStatus status) {\n                     }\n                     // update password for this host\n                     final DetailVO nv = _detailsDao.findDetail(h.getId(), ApiConstants.USERNAME);\n-                    if (nv.getValue().equals(command.getUsername())) {\n+                    if (nv == null) {\n+                        final DetailVO nvu = new DetailVO(h.getId(), ApiConstants.USERNAME, command.getUsername());", "originalCommit": "549dd14de57e19edeb6862e1286e673ed05033e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc1MDExNQ==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r503750115", "bodyText": "@sureshanaparti username and password are mandatory parameters.. They cant be null\n(local) \ud83d\udc31 > update hostpassword hostid=50c8-b73a-4eaf-bbab-7a70\n\ud83d\udca9 Missing required parameters:  password, username", "author": "ravening", "createdAt": "2020-10-13T08:08:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkxODYwMQ==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r503918601", "bodyText": "@ravening empty \"\" (or) \"   \" username string ?", "author": "sureshanaparti", "createdAt": "2020-10-13T12:42:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkyMDQ5NA==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r503920494", "bodyText": "@ravening empty \"\" (or) \"   \" username string ?\n\n@sureshanaparti those are non null values", "author": "ravening", "createdAt": "2020-10-13T12:45:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjEyODE4Ng==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r506128186", "bodyText": "@sureshanaparti  Even if I dont pass username, I dont get NPE\n update hostpassword hostid=50436ac8-b73a-4eaf-bbab-7adbd9a50870 password=cloudstack username=\n\ud83d\ude48 Error: (HTTP 431, error code 4350) The username is not same for the hosts..", "author": "ravening", "createdAt": "2020-10-16T07:37:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE3NTQ5NQ==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r506175495", "bodyText": "@ravening username is not null, but empty string, so can you add check for that ? Ex: \"StringUtils.isBlank(command.getUsername())\"", "author": "sureshanaparti", "createdAt": "2020-10-16T08:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjE3NzU2Nw==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r506177567", "bodyText": "@ravening username is not null, but empty string, so can you add check for that ? Ex: \"StringUtils.isBlank(command.getUsername())\"\n\n@sureshanaparti but why? For some hosts, username and password can be empty string", "author": "ravening", "createdAt": "2020-10-16T08:40:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyNTQ2NQ==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r506225465", "bodyText": "@ravening if you pass username, then it shouldn't be empty, password can be empty. can you confirm if username  is persisted with empty value in the host_details table?", "author": "sureshanaparti", "createdAt": "2020-10-16T09:38:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIzMTY3OA==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r506231678", "bodyText": "@sureshanaparti\n(local) \ud83d\udc31 > update hostpassword hostid=50436ac8-b73a-4eaf-bbab-7adbd9a50870 password=cloudstack username=\"  \"\n\ud83d\ude48 Error: (HTTP 431, error code 4350) The username is not same for the hosts..\n(local) \ud83d\udc31 >\n(local) \ud83d\udc31 > update hostpassword hostid=50436ac8-b73a-4eaf-bbab-7adbd9a50870 password=cloudstack username=\"\"\n\ud83d\ude48 Error: (HTTP 431, error code 4350) The username is not same for the hosts..\n(local) \ud83d\udc31 >", "author": "ravening", "createdAt": "2020-10-16T09:46:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI1MzEwNg==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r506253106", "bodyText": "@ravening can you test your changes when \"nv == null\" with above username and share the persisted records in the host_details table?", "author": "sureshanaparti", "createdAt": "2020-10-16T10:07:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI2ODQ0OA==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r506268448", "bodyText": "@sureshanaparti\n(local) \ud83d\udc31 > update hostpassword hostid=f16d5515-8c53-4873-b395-dc439f5c67d6 password=cloudstack username=\" \"\n{\n  \"success\": true\n}\n\nthis is when nv is null", "author": "ravening", "createdAt": "2020-10-16T10:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI3MzMzNA==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r506273334", "bodyText": "can you share the entries in host_details table of that test?", "author": "sureshanaparti", "createdAt": "2020-10-16T10:33:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYxNjA4NQ==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r506616085", "bodyText": "can you share the entries in host_details table of that test?\n\nI think it's not going anywhere further. Can you let me know what exactly you are looking for?", "author": "ravening", "createdAt": "2020-10-16T17:21:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYyODEyMQ==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r506628121", "bodyText": "can you share the entries in host_details table of that test?\n\n@sureshanaparti  the last result I pasted was tested when host_details entry were removed for that host", "author": "ravening", "createdAt": "2020-10-16T17:41:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5OTY5MA==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r508199690", "bodyText": "@ravening No point in saving password with username empty. Hope you got it. Wanted to confirm the same based on the entries persisted in host_details table for your test. Can you share these? Thanks.", "author": "sureshanaparti", "createdAt": "2020-10-20T04:18:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIzNTA3NA==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r508235074", "bodyText": "@sureshanaparti @ravening we had the issue in the past that Removed kvm host is added back to cloudstack when cloudstack-agent is started. in that case, there is no username/password saved in host_details for the host (because the entries are removed from db when host is removed, but not added back).", "author": "weizhouapache", "createdAt": "2020-10-20T06:18:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzU3MA==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r503423570", "bodyText": "cmd.getUsername() can be null or empty here, please check.", "author": "sureshanaparti", "createdAt": "2020-10-12T17:01:15Z", "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -3994,7 +3999,12 @@ public void doInTransactionWithoutResult(final TransactionStatus status) {\n                 }\n                 // update password for this host\n                 final DetailVO nv = _detailsDao.findDetail(host.getId(), ApiConstants.USERNAME);\n-                if (nv.getValue().equals(cmd.getUsername())) {\n+                if (nv == null) {\n+                    final DetailVO nvu = new DetailVO(host.getId(), ApiConstants.USERNAME, cmd.getUsername());", "originalCommit": "549dd14de57e19edeb6862e1286e673ed05033e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM0MTAyOA==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r513341028", "bodyText": "@ravening Username null or empty fix is not addressed here. Please check.", "author": "sureshanaparti", "createdAt": "2020-10-28T10:39:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDExMTc4MA==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r510111780", "bodyText": "@ravening should we use 'userNameWithoutSpaces' instead of cmd.getUserName() ?", "author": "weizhouapache", "createdAt": "2020-10-22T12:15:39Z", "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -3938,7 +3943,12 @@ public void doInTransactionWithoutResult(final TransactionStatus status) {\n                     }\n                     // update password for this host\n                     final DetailVO nv = _detailsDao.findDetail(h.getId(), ApiConstants.USERNAME);\n-                    if (nv.getValue().equals(command.getUsername())) {\n+                    if (nv == null) {\n+                        final DetailVO nvu = new DetailVO(h.getId(), ApiConstants.USERNAME, command.getUsername());", "originalCommit": "e26bc423ef85fa3656b69cbb7ce3da823c6048d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE0MzQ1NQ==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r510143455", "bodyText": "yes correct. probably i missed it. will change that", "author": "ravening", "createdAt": "2020-10-22T13:03:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDExMTc4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM0Mzg4Mw==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r513343883", "bodyText": "@ravening  Username null or empty fix is missing here.", "author": "sureshanaparti", "createdAt": "2020-10-28T10:44:04Z", "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -3994,7 +4004,12 @@ public void doInTransactionWithoutResult(final TransactionStatus status) {\n                 }\n                 // update password for this host\n                 final DetailVO nv = _detailsDao.findDetail(host.getId(), ApiConstants.USERNAME);\n-                if (nv.getValue().equals(cmd.getUsername())) {\n+                if (nv == null) {\n+                    final DetailVO nvu = new DetailVO(host.getId(), ApiConstants.USERNAME, cmd.getUsername());", "originalCommit": "e26bc423ef85fa3656b69cbb7ce3da823c6048d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM3NTU1Nw==", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r513375557", "bodyText": "@sureshanaparti fixed it", "author": "ravening", "createdAt": "2020-10-28T11:39:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM0Mzg4Mw=="}], "type": "inlineReview"}, {"oid": "c30fd82baf29dff09929dc5a101346b41550a199", "url": "https://github.com/apache/cloudstack/commit/c30fd82baf29dff09929dc5a101346b41550a199", "message": "code refactor", "committedDate": "2020-10-28T11:34:23Z", "type": "forcePushed"}, {"oid": "33cf8103c52d87efc784d5d465974bcb64a73796", "url": "https://github.com/apache/cloudstack/commit/33cf8103c52d87efc784d5d465974bcb64a73796", "message": "Failed to update host password if username/password is not saved in Cloudstack DB\n\nIf the entries for a host in host_details table are missing then we cant update the\npassword of the host using the cloudmonkey command\nThis can happen because host was removed earlier resulting in deletion\nof entries in the database\n\nThis commit fixes the issue\n\n(local) mgt01 > update hostpassword\nhostid=50436ac8-b73a-4eaf-bbab-7adbd9a50870 username=root\npassword=cloudstack\n{\n\"success\": true\n}\n\nNow the entries should be added in host_details table as well", "committedDate": "2020-10-28T11:49:37Z", "type": "commit"}, {"oid": "33cf8103c52d87efc784d5d465974bcb64a73796", "url": "https://github.com/apache/cloudstack/commit/33cf8103c52d87efc784d5d465974bcb64a73796", "message": "Failed to update host password if username/password is not saved in Cloudstack DB\n\nIf the entries for a host in host_details table are missing then we cant update the\npassword of the host using the cloudmonkey command\nThis can happen because host was removed earlier resulting in deletion\nof entries in the database\n\nThis commit fixes the issue\n\n(local) mgt01 > update hostpassword\nhostid=50436ac8-b73a-4eaf-bbab-7adbd9a50870 username=root\npassword=cloudstack\n{\n\"success\": true\n}\n\nNow the entries should be added in host_details table as well", "committedDate": "2020-10-28T11:49:37Z", "type": "forcePushed"}]}