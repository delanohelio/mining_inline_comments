{"pr_number": 4116, "pr_title": "cks: fix template, deployment issues", "pr_createdAt": "2020-05-28T16:31:51Z", "pr_url": "https://github.com/apache/cloudstack/pull/4116", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyNjY4OQ==", "url": "https://github.com/apache/cloudstack/pull/4116#discussion_r436426689", "bodyText": "Remove unused/commented method", "author": "rhtyd", "createdAt": "2020-06-08T01:55:43Z", "path": "engine/schema/src/main/java/com/cloud/storage/dao/VMTemplateDao.java", "diffHunk": "@@ -36,6 +36,8 @@\n \n     public VMTemplateVO findByTemplateName(String templateName);\n \n+    public VMTemplateVO findValidByTemplateName(String templateName);\n+\n     // public void update(VMTemplateVO template);", "originalCommit": "8c6861bdc0f6b9fbf58a1c099f36ba08348dd204", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ2MzA2OA==", "url": "https://github.com/apache/cloudstack/pull/4116#discussion_r436463068", "bodyText": "done", "author": "shwstppr", "createdAt": "2020-06-08T05:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyNjY4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyNjc4Nw==", "url": "https://github.com/apache/cloudstack/pull/4116#discussion_r436426787", "bodyText": "Is logAndThrow a new utility?", "author": "rhtyd", "createdAt": "2020-06-08T01:56:13Z", "path": "plugins/integrations/kubernetes-service/src/main/java/com/cloud/kubernetes/cluster/KubernetesClusterManagerImpl.java", "diffHunk": "@@ -908,6 +910,10 @@ private void validateKubernetesClusterUpgradeParameters(UpgradeKubernetesCluster\n         if (!KubernetesCluster.State.Running.equals(kubernetesCluster.getState())) {\n             throw new InvalidParameterValueException(String.format(\"Kubernetes cluster ID: %s is not in running state\", kubernetesCluster.getUuid()));\n         }\n+        final DataCenter zone = dataCenterDao.findById(kubernetesCluster.getZoneId());\n+        if (zone == null) {\n+            logAndThrow(Level.WARN, String.format(\"Unable to find zone for Kubernetes cluster ID: %s\", kubernetesCluster.getUuid()));", "originalCommit": "8c6861bdc0f6b9fbf58a1c099f36ba08348dd204", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ2Mjk1MQ==", "url": "https://github.com/apache/cloudstack/pull/4116#discussion_r436462951", "bodyText": "Just some helper methods to log and throw exceptions for similar error \n  \n    \n      cloudstack/plugins/integrations/kubernetes-service/src/main/java/com/cloud/kubernetes/cluster/KubernetesClusterManagerImpl.java\n    \n    \n        Lines 216 to 249\n      in\n      8c6861b\n    \n    \n    \n    \n\n        \n          \n           private void logMessage(final Level logLevel, final String message, final Exception e) { \n        \n\n        \n          \n               if (logLevel == Level.WARN) { \n        \n\n        \n          \n                   if (e != null) { \n        \n\n        \n          \n                       LOGGER.warn(message, e); \n        \n\n        \n          \n                   } else { \n        \n\n        \n          \n                       LOGGER.warn(message); \n        \n\n        \n          \n                   } \n        \n\n        \n          \n               } else { \n        \n\n        \n          \n                   if (e != null) { \n        \n\n        \n          \n                       LOGGER.error(message, e); \n        \n\n        \n          \n                   } else { \n        \n\n        \n          \n                       LOGGER.error(message); \n        \n\n        \n          \n                   } \n        \n\n        \n          \n               } \n        \n\n        \n          \n           } \n        \n\n        \n          \n            \n        \n\n        \n          \n           private void logTransitStateAndThrow(final Level logLevel, final String message, final Long kubernetesClusterId, final KubernetesCluster.Event event, final Exception e) throws CloudRuntimeException { \n        \n\n        \n          \n               logMessage(logLevel, message, e); \n        \n\n        \n          \n               if (kubernetesClusterId != null && event != null) { \n        \n\n        \n          \n                   stateTransitTo(kubernetesClusterId, event); \n        \n\n        \n          \n               } \n        \n\n        \n          \n               if (e == null) { \n        \n\n        \n          \n                   throw new CloudRuntimeException(message); \n        \n\n        \n          \n               } \n        \n\n        \n          \n               throw new CloudRuntimeException(message, e); \n        \n\n        \n          \n           } \n        \n\n        \n          \n            \n        \n\n        \n          \n           private void logAndThrow(final Level logLevel, final String message) throws CloudRuntimeException { \n        \n\n        \n          \n               logTransitStateAndThrow(logLevel, message, null, null, null); \n        \n\n        \n          \n           } \n        \n\n        \n          \n            \n        \n\n        \n          \n           private void logAndThrow(final Level logLevel, final String message, final Exception ex) throws CloudRuntimeException { \n        \n\n        \n          \n               logTransitStateAndThrow(logLevel, message, null, null, ex); \n        \n\n        \n          \n           }", "author": "shwstppr", "createdAt": "2020-06-08T05:25:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyNjc4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzMDQxMA==", "url": "https://github.com/apache/cloudstack/pull/4116#discussion_r443030410", "bodyText": "The call public List<TemplateJoinVO> newTemplateView(VirtualMachineTemplate template, long zoneId, boolean readyOnly) as implemented in TemplateJoinDaoImpl, does a search including removed leading to a hit for a template that is not available. Is this intended?", "author": "DaanHoogland", "createdAt": "2020-06-19T20:27:02Z", "path": "plugins/integrations/kubernetes-service/src/main/java/com/cloud/kubernetes/cluster/KubernetesClusterManagerImpl.java", "diffHunk": "@@ -300,8 +294,7 @@ private boolean isKubernetesServiceTemplateConfigured(DataCenter zone) {\n                 LOGGER.warn(String.format(\"Unable to find the template %s to be used for provisioning Kubernetes cluster nodes\", templateName));\n                 return false;\n             }\n-            List<VMTemplateZoneVO> listZoneTemplate = templateZoneDao.listByZoneTemplate(zone.getId(), template.getId());\n-            if (listZoneTemplate == null || listZoneTemplate.isEmpty()) {\n+            if (CollectionUtils.isEmpty(templateJoinDao.newTemplateView(template, zone.getId(), true))) {", "originalCommit": "d4b763f79146fafee693af54132f2290b9597b28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTExNTg4Mw==", "url": "https://github.com/apache/cloudstack/pull/4116#discussion_r445115883", "bodyText": "@DaanHoogland thanks for pointing it. I'll check that again", "author": "shwstppr", "createdAt": "2020-06-24T19:17:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzMDQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ5NDU2NA==", "url": "https://github.com/apache/cloudstack/pull/4116#discussion_r462494564", "bodyText": "any resolution on this @shwstppr ?", "author": "DaanHoogland", "createdAt": "2020-07-29T18:15:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzMDQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjc5NzQwOQ==", "url": "https://github.com/apache/cloudstack/pull/4116#discussion_r462797409", "bodyText": "@DaanHoogland I've checked this. newTemplateView is called here with readyOnly=true and deleted templates have state=NULL.", "author": "shwstppr", "createdAt": "2020-07-30T07:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzMDQxMA=="}], "type": "inlineReview"}, {"oid": "3c66d2a8acc2bee290e0c198509e1a5e855037ea", "url": "https://github.com/apache/cloudstack/commit/3c66d2a8acc2bee290e0c198509e1a5e855037ea", "message": "cleanup\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>", "committedDate": "2020-06-24T19:00:51Z", "type": "forcePushed"}, {"oid": "10d604a2710a3a77e08be1df46978862192a2f0c", "url": "https://github.com/apache/cloudstack/commit/10d604a2710a3a77e08be1df46978862192a2f0c", "message": "Merge branch 'master' into fix-cks-template-name-bug-4107", "committedDate": "2020-07-08T22:25:44Z", "type": "forcePushed"}, {"oid": "6a02e2e2167a5f49ab9f98325fae40e4ac2fe1e1", "url": "https://github.com/apache/cloudstack/commit/6a02e2e2167a5f49ab9f98325fae40e4ac2fe1e1", "message": "wrong condition\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>", "committedDate": "2020-07-08T22:31:30Z", "type": "forcePushed"}, {"oid": "05b4eff6ed755ffcb85a1d426b91c2a2181ec7a4", "url": "https://github.com/apache/cloudstack/commit/05b4eff6ed755ffcb85a1d426b91c2a2181ec7a4", "message": "cks: fixes\n\nFixes deployment, template and network deletion.\nAlso allows filetering in listKubernetesSupportedVersions with keyword\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>", "committedDate": "2020-07-08T22:33:59Z", "type": "forcePushed"}, {"oid": "94c31d3f7c526f84b70475f4293bd529a19bafb0", "url": "https://github.com/apache/cloudstack/commit/94c31d3f7c526f84b70475f4293bd529a19bafb0", "message": "cks: fixes\n\nFixes deployment, template and network deletion.\nAlso allows filetering in listKubernetesSupportedVersions with keyword\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>", "committedDate": "2020-07-08T22:39:01Z", "type": "forcePushed"}, {"oid": "23369e52774d1de838360a531ff492446aa8c405", "url": "https://github.com/apache/cloudstack/commit/23369e52774d1de838360a531ff492446aa8c405", "message": "cks: fixes\n\nFixes deployment, template and network deletion.\nAlso allows filetering in listKubernetesSupportedVersions with keyword\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>", "committedDate": "2020-07-08T22:42:52Z", "type": "commit"}, {"oid": "23369e52774d1de838360a531ff492446aa8c405", "url": "https://github.com/apache/cloudstack/commit/23369e52774d1de838360a531ff492446aa8c405", "message": "cks: fixes\n\nFixes deployment, template and network deletion.\nAlso allows filetering in listKubernetesSupportedVersions with keyword\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>", "committedDate": "2020-07-08T22:42:52Z", "type": "forcePushed"}]}