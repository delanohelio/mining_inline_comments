{"pr_number": 4516, "pr_title": "Fix hypervisor type cast to string", "pr_createdAt": "2020-12-03T14:29:15Z", "pr_url": "https://github.com/apache/cloudstack/pull/4516", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUzNjA4Ng==", "url": "https://github.com/apache/cloudstack/pull/4516#discussion_r536536086", "bodyText": "it would be better to define hypervisorType as\nHypervisorType hypervisorType = (String)dsInfos.get(\"hypervisorType\");\n\nthe other lines in this file needs to be changed accordingly.", "author": "weizhouapache", "createdAt": "2020-12-05T07:33:44Z", "path": "plugins/storage/volume/default/src/main/java/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java", "diffHunk": "@@ -132,7 +132,11 @@ public DataStore initialize(Map<String, Object> dsInfos) {\n         Long zoneId = (Long)dsInfos.get(\"zoneId\");\n         String url = (String)dsInfos.get(\"url\");\n         String providerName = (String)dsInfos.get(\"providerName\");\n-        String hypervisorType = (String)dsInfos.get(\"hypervisorType\");\n+        Object hypervisorTypeObj = dsInfos.get(\"hypervisorType\");", "originalCommit": "117b001ad3606f7eb8a4398dee513f39c5a5fc88", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA4Njc1NQ==", "url": "https://github.com/apache/cloudstack/pull/4516#discussion_r537086755", "bodyText": "I will update the PR.", "author": "alexandru-bagu", "createdAt": "2020-12-06T17:35:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUzNjA4Ng=="}], "type": "inlineReview"}, {"oid": "f1a539480c3da9c1ccc0dee66d832fa92f445a20", "url": "https://github.com/apache/cloudstack/commit/f1a539480c3da9c1ccc0dee66d832fa92f445a20", "message": "changed type to HypervisorType instead of String", "committedDate": "2020-12-07T10:05:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQzNDM0NQ==", "url": "https://github.com/apache/cloudstack/pull/4516#discussion_r537434345", "bodyText": "@alexandru-bagu in your latest commit, hypervisor type is casted to string again", "author": "weizhouapache", "createdAt": "2020-12-07T11:31:09Z", "path": "plugins/storage/volume/default/src/main/java/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java", "diffHunk": "@@ -133,7 +133,7 @@ public DataStore initialize(Map<String, Object> dsInfos) {\n         String providerName = (String)dsInfos.get(\"providerName\");\n         HypervisorType hypervisorType = HypervisorType.None;\n         if(dsInfos.containsKey(\"hypervisorType\")) {\n-            hypervisorType = (HypervisorType)dsInfos.get(\"hypervisorType\");\n+            hypervisorType = HypervisorType.getType((String)dsInfos.get(\"hypervisorType\"));", "originalCommit": "87f52d89990c77124838447272706efd765b4c98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1OTM5NA==", "url": "https://github.com/apache/cloudstack/pull/4516#discussion_r537459394", "bodyText": "@weizhouapache The issue I created this PR for is that dsInfos.get(\"hypervisorType\") is sometimes String or sometimes missing. As I highlighted in my previous post, both String and HypervisorType is used so I am not sure about how to proceed. We could check types but I don't believe that is correct.", "author": "alexandru-bagu", "createdAt": "2020-12-07T12:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQzNDM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk2NzY0OQ==", "url": "https://github.com/apache/cloudstack/pull/4516#discussion_r539967649", "bodyText": "casting to String and calling toString() on an object would only be different if toString() is not implemented @alexandru-bagu . What are you aiming for here?", "author": "DaanHoogland", "createdAt": "2020-12-10T08:26:29Z", "path": "plugins/storage/volume/default/src/main/java/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java", "diffHunk": "@@ -133,7 +133,7 @@ public DataStore initialize(Map<String, Object> dsInfos) {\n         String providerName = (String)dsInfos.get(\"providerName\");\n         HypervisorType hypervisorType = HypervisorType.None;\n         if(dsInfos.containsKey(\"hypervisorType\")) {\n-            hypervisorType = HypervisorType.getType((String)dsInfos.get(\"hypervisorType\"));\n+            hypervisorType = HypervisorType.getType(dsInfos.get(\"hypervisorType\").toString());", "originalCommit": "93564c4142c661246169c5aa356db33b76c648fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDAyMDg5NA==", "url": "https://github.com/apache/cloudstack/pull/4516#discussion_r540020894", "bodyText": "Unless I am wrong, .toString is implemented by the compiler for enums. My aim was to provide a quick fix for this issue and I did a small test to show that the code above works. https://github.com/alexandru-bagu/java-enum-test\nThe point of .toString there is that if the object given is either String or HypervisorType then both will provide the same output for .toString unless as you have said one overrides the .toString for the enum. In this case it is not overriden as such the code will work.\nThough I agree, this not the correct way to fix it. I will make it a cast to HypervisorType and change the function call that provides the wrong type.", "author": "alexandru-bagu", "createdAt": "2020-12-10T09:44:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk2NzY0OQ=="}], "type": "inlineReview"}, {"oid": "5e42af7f2530203e9da8e10b5d7cb2c1f251c8a4", "url": "https://github.com/apache/cloudstack/commit/5e42af7f2530203e9da8e10b5d7cb2c1f251c8a4", "message": "proper changes to use only enum of HypervisorType", "committedDate": "2020-12-10T12:35:14Z", "type": "commit"}, {"oid": "5e42af7f2530203e9da8e10b5d7cb2c1f251c8a4", "url": "https://github.com/apache/cloudstack/commit/5e42af7f2530203e9da8e10b5d7cb2c1f251c8a4", "message": "proper changes to use only enum of HypervisorType", "committedDate": "2020-12-10T12:35:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTYxMzQ3Nw==", "url": "https://github.com/apache/cloudstack/pull/4516#discussion_r541613477", "bodyText": "I do not know if hypervisorType is 100% not null.\nmaybe it is better to use if (HypervisorType.VMware.equals(hypervisorType)) { ?", "author": "weizhouapache", "createdAt": "2020-12-12T15:18:55Z", "path": "plugins/storage/volume/default/src/main/java/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java", "diffHunk": "@@ -250,15 +249,15 @@ public DataStore initialize(Map<String, Object> dsInfos) {\n             parameters.setPath(hostPath.replaceFirst(\"/\", \"\"));\n             parameters.setUserInfo(userInfo);\n         } else if (scheme.equalsIgnoreCase(\"PreSetup\")) {\n-            if (StringUtils.isNotBlank(hypervisorType) && HypervisorType.getType(hypervisorType).equals(HypervisorType.VMware)) {\n+            if (hypervisorType.equals(HypervisorType.VMware)) {", "originalCommit": "5e42af7f2530203e9da8e10b5d7cb2c1f251c8a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTY5OTY3NA==", "url": "https://github.com/apache/cloudstack/pull/4516#discussion_r541699674", "bodyText": "Wouldn't that hide improper calls to this function?", "author": "alexandru-bagu", "createdAt": "2020-12-12T18:06:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTYxMzQ3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTg2NTI2MQ==", "url": "https://github.com/apache/cloudstack/pull/4516#discussion_r541865261", "bodyText": "no, @alexandru-bagu , it is common practice using equals to call it on the object guaranteed not to be null, in this case the enum member\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (hypervisorType.equals(HypervisorType.VMware)) {\n          \n          \n            \n                        if (HypervisorType.VMware.equals(hypervisorType)) {", "author": "DaanHoogland", "createdAt": "2020-12-13T07:20:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTYxMzQ3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTg4NTY4Ng==", "url": "https://github.com/apache/cloudstack/pull/4516#discussion_r541885686", "bodyText": "You misunderstand. If someone calls this function without providing this parameter then they wouldn't know because there would be no error reported. Alas I will commit your suggestions.", "author": "alexandru-bagu", "createdAt": "2020-12-13T09:27:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTYxMzQ3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTg2NTM1Mw==", "url": "https://github.com/apache/cloudstack/pull/4516#discussion_r541865353", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (hypervisorType.equals(HypervisorType.VMware)) {\n          \n          \n            \n                        if (HypervisorType.VMware.equals(hypervisorType)) {", "author": "DaanHoogland", "createdAt": "2020-12-13T07:20:49Z", "path": "plugins/storage/volume/default/src/main/java/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java", "diffHunk": "@@ -250,15 +249,15 @@ public DataStore initialize(Map<String, Object> dsInfos) {\n             parameters.setPath(hostPath.replaceFirst(\"/\", \"\"));\n             parameters.setUserInfo(userInfo);\n         } else if (scheme.equalsIgnoreCase(\"PreSetup\")) {\n-            if (StringUtils.isNotBlank(hypervisorType) && HypervisorType.getType(hypervisorType).equals(HypervisorType.VMware)) {\n+            if (hypervisorType.equals(HypervisorType.VMware)) {\n                 validateVcenterDetails(zoneId, podId, clusterId,storageHost);\n             }\n             parameters.setType(StoragePoolType.PreSetup);\n             parameters.setHost(storageHost);\n             parameters.setPort(0);\n             parameters.setPath(hostPath);\n         } else if (scheme.equalsIgnoreCase(\"DatastoreCluster\")) {\n-            if (StringUtils.isNotBlank(hypervisorType) && HypervisorType.getType(hypervisorType).equals(HypervisorType.VMware)) {\n+            if (hypervisorType.equals(HypervisorType.VMware)) {", "originalCommit": "5e42af7f2530203e9da8e10b5d7cb2c1f251c8a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTg2NTQ2NQ==", "url": "https://github.com/apache/cloudstack/pull/4516#discussion_r541865465", "bodyText": "and in this case the string literal:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } else if (scheme.equalsIgnoreCase(\"PreSetup\") && !hypervisorType.equals(HypervisorType.VMware)) {\n          \n          \n            \n                    } else if (\"PreSetup\".equalsIgnoreCase(scheme) && !HypervisorType.VMware.equals(hypervisorType)) {", "author": "DaanHoogland", "createdAt": "2020-12-13T07:21:43Z", "path": "plugins/storage/volume/default/src/main/java/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java", "diffHunk": "@@ -338,7 +337,7 @@ public DataStore initialize(Map<String, Object> dsInfos) {\n             uuid = (String)existingUuid;\n         } else if (scheme.equalsIgnoreCase(\"sharedmountpoint\") || scheme.equalsIgnoreCase(\"clvm\")) {\n             uuid = UUID.randomUUID().toString();\n-        } else if (scheme.equalsIgnoreCase(\"PreSetup\") && !(StringUtils.isNotBlank(hypervisorType) && HypervisorType.getType(hypervisorType).equals(HypervisorType.VMware))) {\n+        } else if (scheme.equalsIgnoreCase(\"PreSetup\") && !hypervisorType.equals(HypervisorType.VMware)) {", "originalCommit": "5e42af7f2530203e9da8e10b5d7cb2c1f251c8a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9cce1d3df84c6f8a963ac9cc17566c02dd1b7435", "url": "https://github.com/apache/cloudstack/commit/9cce1d3df84c6f8a963ac9cc17566c02dd1b7435", "message": "Update plugins/storage/volume/default/src/main/java/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java\r\n\r\nDefensive check\n\nCo-authored-by: dahn <daan.hoogland@gmail.com>", "committedDate": "2020-12-13T09:28:38Z", "type": "commit"}, {"oid": "8ea07c5a2139fff75913e3e817c85a415b17acac", "url": "https://github.com/apache/cloudstack/commit/8ea07c5a2139fff75913e3e817c85a415b17acac", "message": "Update plugins/storage/volume/default/src/main/java/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java\r\n\r\nDefensive check\n\nCo-authored-by: dahn <daan.hoogland@gmail.com>", "committedDate": "2020-12-13T09:28:56Z", "type": "commit"}, {"oid": "a6914e0e9ddf71acf4a9b9a246c47b281e080fb3", "url": "https://github.com/apache/cloudstack/commit/a6914e0e9ddf71acf4a9b9a246c47b281e080fb3", "message": "Update plugins/storage/volume/default/src/main/java/org/apache/cloudstack/storage/datastore/lifecycle/CloudStackPrimaryDataStoreLifeCycleImpl.java\r\n\r\nDefensive check\n\nCo-authored-by: dahn <daan.hoogland@gmail.com>", "committedDate": "2020-12-13T09:32:33Z", "type": "commit"}]}