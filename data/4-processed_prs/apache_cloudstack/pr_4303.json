{"pr_number": 4303, "pr_title": "Ubuntu 20.04: Fix systemvm cannot start up", "pr_createdAt": "2020-09-03T13:53:05Z", "pr_url": "https://github.com/apache/cloudstack/pull/4303", "timeline": [{"oid": "1afb8bbbc8d97667eab9adacd237730f32ec2316", "url": "https://github.com/apache/cloudstack/commit/1afb8bbbc8d97667eab9adacd237730f32ec2316", "message": "security_group.py: fix SyntaxWarning: \"is\" with a literal.\n\n2020-04-27 09:43:54,172 DEBUG [kvm.resource.LibvirtComputingResource] (Agent-Handler-2:null) (logid:c33ba330) /usr/share/cloudstack-common/scripts/vm/network/security_group.py:513: SyntaxWarning: \"is\" with a literal. Did you mean \"==\"?\n  if rules is None or rules is \"\":\n/usr/share/cloudstack-common/scripts/vm/network/security_group.py:522: SyntaxWarning: \"is\" with a literal. Did you mean \"==\"?\n  if rules is None or rules is \"\":\n/usr/share/cloudstack-common/scripts/vm/network/security_group.py:823: SyntaxWarning: \"is\" with a literal. Did you mean \"==\"?\n  if brName is None or brName is \"\":", "committedDate": "2020-09-03T13:43:59Z", "type": "commit"}, {"oid": "76f0e3fa1a295f27d15d87751bd3fd148ea0f1c3", "url": "https://github.com/apache/cloudstack/commit/76f0e3fa1a295f27d15d87751bd3fd148ea0f1c3", "message": "Ubuntu 20.04: Fix systemvm cannot start up\n\nin Ubuntu 16.04:\n\nroot@node13:~# bridge -o link show\n2: eth0 state UP : <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloudbr0 state forwarding priority 32 cost 100\n5: vnet0 state UNKNOWN : <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloud0 state forwarding priority 32 cost 100\n6: vnet1 state UNKNOWN : <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloudbr0 state forwarding priority 32 cost 100\n7: vnet2 state UNKNOWN : <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloudbr0 state forwarding priority 32 cost 100\n\nroot@node13:~# bridge -o link show | awk '/master cloudbr0 / && !/^[0-9]+: vnet/ {print $2}' | head -1\neth0\n\nroot@node13:~# bridge -o link show | awk '/master cloudbr0 / && !/^[0-9]+: vnet/ {print $2}' | head -1 |cut -d \":\" -f1\neth0\n\nin Ubuntu 20.04:\n\nroot@node62:~# bridge -o link show\n2: ens3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloudbr0 state forwarding priority 32 cost 100\n10: vnet3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloud0 state forwarding priority 32 cost 100\n11: vnet4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloudbr0 state forwarding priority 32 cost 100\n12: vnet5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloudbr0 state forwarding priority 32 cost 100\n\nroot@node62:~# bridge -o link show | awk '/master cloudbr0 / && !/^[0-9]+: vnet/ {print $2}' | head -1\nens3:\n\nroot@node62:~# bridge -o link show | awk '/master cloudbr0 / && !/^[0-9]+: vnet/ {print $2}' | head -1 |cut -d ':' -f1\nens3", "committedDate": "2020-09-03T13:44:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ2MDcyMw==", "url": "https://github.com/apache/cloudstack/pull/4303#discussion_r483460723", "bodyText": "Maybe better to change this to:\nif not rules:\nThat captures the None and empty string case right away.", "author": "wido", "createdAt": "2020-09-04T08:12:54Z", "path": "scripts/vm/network/security_group.py", "diffHunk": "@@ -510,7 +510,7 @@ def check_default_network_rules(vm_name, vm_id, vm_ip, vm_ip6, vm_mac, vif, brna\n         rules = execute(\"iptables-save |grep -w %s |grep -w %s |grep -w %s\" % (brfw, vif, vmchain_default))\n     except:\n         rules = None\n-    if rules is None or rules is \"\":\n+    if rules is None or rules == \"\":", "originalCommit": "76f0e3fa1a295f27d15d87751bd3fd148ea0f1c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3NTk5OA==", "url": "https://github.com/apache/cloudstack/pull/4303#discussion_r483475998", "bodyText": "good, thanks @wido", "author": "weizhouapache", "createdAt": "2020-09-04T08:41:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ2MDcyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ2MTI5Mg==", "url": "https://github.com/apache/cloudstack/pull/4303#discussion_r483461292", "bodyText": "Do we know what changed in Ubuntu 20.04? As the '-o' flag should make it stable to use on the CLI", "author": "wido", "createdAt": "2020-09-04T08:13:55Z", "path": "scripts/vm/network/security_group.py", "diffHunk": "@@ -185,7 +185,7 @@ def destroy_network_rules_for_nic(vm_name, vm_ip, vm_mac, vif, sec_ips):\n         logging.debug(\"Ignoring failure to delete ebtable rules for vm: \" + vm_name)\n \n def get_bridge_physdev(brname):\n-    physdev = execute(\"bridge -o link show | awk '/master %s / && !/^[0-9]+: vnet/ {print $2}' | head -1\" % brname)\n+    physdev = execute(\"bridge -o link show | awk '/master %s / && !/^[0-9]+: vnet/ {print $2}' | head -1 | cut -d ':' -f1\" % brname)", "originalCommit": "76f0e3fa1a295f27d15d87751bd3fd148ea0f1c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3NjgzNw==", "url": "https://github.com/apache/cloudstack/pull/4303#discussion_r483476837", "bodyText": "@wido here is an example\nin ubuntu 16.04\nroot@node42:~# bridge -o link show\n2: eth0 state UP : <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloudbr0 state forwarding priority 32 cost 100\n\nin ubuntu 20.04\nroot@node62:~# bridge -o link show\n2: ens3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloudbr0 state forwarding priority 32 cost 100", "author": "weizhouapache", "createdAt": "2020-09-04T08:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ2MTI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU0NjMwMA==", "url": "https://github.com/apache/cloudstack/pull/4303#discussion_r483546300", "bodyText": "Should we use ip (iproute2) instead of old tools?", "author": "rhtyd", "createdAt": "2020-09-04T11:01:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ2MTI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2MDQ1NQ==", "url": "https://github.com/apache/cloudstack/pull/4303#discussion_r483560455", "bodyText": "bridge is a part of iproute2. The old tool is called 'brctl'", "author": "wido", "createdAt": "2020-09-04T11:34:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ2MTI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTg2NDQ0NQ==", "url": "https://github.com/apache/cloudstack/pull/4303#discussion_r559864445", "bodyText": "there is the trick to use ls /sys/class/net to get the exact interface names", "author": "abdelouahabb", "createdAt": "2021-01-19T01:43:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ2MTI5Mg=="}], "type": "inlineReview"}, {"oid": "3d21db449d80ca5452dd53b638cf458228cf5232", "url": "https://github.com/apache/cloudstack/commit/3d21db449d80ca5452dd53b638cf458228cf5232", "message": "security_group.py: use 'if not' instead", "committedDate": "2020-09-04T08:56:28Z", "type": "commit"}]}