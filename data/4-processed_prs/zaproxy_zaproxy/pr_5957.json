{"pr_number": 5957, "pr_title": "Fix Issue 5897 - Docker python scripts use Context if available", "pr_createdAt": "2020-04-27T19:18:34Z", "pr_url": "https://github.com/zaproxy/zaproxy/pull/5957", "timeline": [{"oid": "693ca443c58ca7f6a03a26a65e8083efde2dc792", "url": "https://github.com/zaproxy/zaproxy/commit/693ca443c58ca7f6a03a26a65e8083efde2dc792", "message": "Scan with context in Docker scripts\n\nSigned-off-by: beldcode <philip.berthold@tutanota.com>", "committedDate": "2020-04-27T20:34:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU3MDQ1NA==", "url": "https://github.com/zaproxy/zaproxy/pull/5957#discussion_r423570454", "bodyText": "This looks a bit weird. Cant we just use contextid=context_id and drop the test?", "author": "psiinon", "createdAt": "2020-05-12T08:51:37Z", "path": "docker/zap_common.py", "diffHunk": "@@ -382,23 +387,32 @@ def zap_spider(zap, target):\n \n \n @hook(wrap=True)\n-def zap_ajax_spider(zap, target, max_time):\n+def zap_ajax_spider(zap, target, max_time, context=None):\n     logging.debug('AjaxSpider ' + target)\n     if max_time:\n         zap.ajaxSpider.set_option_max_duration(str(max_time))\n-    zap.ajaxSpider.scan(target)\n+    if context is not None:\n+        spider_scan_id = zap.spider.scan(target, contextname=context)\n+    else:\n+        spider_scan_id = zap.spider.scan(target)\n     time.sleep(5)\n \n     while (zap.ajaxSpider.status == 'running'):\n         logging.debug('Ajax Spider running, found urls: ' + zap.ajaxSpider.number_of_results)\n         time.sleep(5)\n     logging.debug('Ajax Spider complete')\n \n-\n+'''\n+In zap_active_scan, we use the global context_id, which is used in zap.ascan.scan to indicate that there is\n+a context\n+'''\n @hook(wrap=True)\n def zap_active_scan(zap, target, policy):\n     logging.debug('Active Scan ' + target + ' with policy ' + policy)\n-    ascan_scan_id = zap.ascan.scan(target, recurse=True, scanpolicyname=policy)\n+    if context_id is None:\n+        ascan_scan_id = zap.ascan.scan(target, recurse=True, scanpolicyname=policy)#, contextid=None)", "originalCommit": "693ca443c58ca7f6a03a26a65e8083efde2dc792", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI2MDYzMw==", "url": "https://github.com/zaproxy/zaproxy/pull/5957#discussion_r430260633", "bodyText": "the context_id variable is initialized in the zap_import_context function.. this function is only called if a context_file is given. So context_id is not always available..", "author": "beldcode", "createdAt": "2020-05-26T08:58:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU3MDQ1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI2OTk4Mw==", "url": "https://github.com/zaproxy/zaproxy/pull/5957#discussion_r437269983", "bodyText": "It's fine if it's None, the API client will just ignore that parameter.", "author": "thc202", "createdAt": "2020-06-09T09:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU3MDQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU3MDcxMQ==", "url": "https://github.com/zaproxy/zaproxy/pull/5957#discussion_r423570711", "bodyText": "Is this test needed or can we pass across context=None?", "author": "psiinon", "createdAt": "2020-05-12T08:52:02Z", "path": "docker/zap_common.py", "diffHunk": "@@ -382,23 +387,32 @@ def zap_spider(zap, target):\n \n \n @hook(wrap=True)\n-def zap_ajax_spider(zap, target, max_time):\n+def zap_ajax_spider(zap, target, max_time, context=None):\n     logging.debug('AjaxSpider ' + target)\n     if max_time:\n         zap.ajaxSpider.set_option_max_duration(str(max_time))\n-    zap.ajaxSpider.scan(target)\n+    if context is not None:", "originalCommit": "693ca443c58ca7f6a03a26a65e8083efde2dc792", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxMjg5Ng==", "url": "https://github.com/zaproxy/zaproxy/pull/5957#discussion_r423612896", "bodyText": "This should be reverted.", "author": "thc202", "createdAt": "2020-05-12T09:59:12Z", "path": "docker/docker-compose.yml", "diffHunk": "@@ -13,5 +13,5 @@ services:\n   test:\n     build: \n       context: .\n-      dockerfile: Dockerfile-zapcli\n+      dockerfile: Dockerfile-stable-zapcli", "originalCommit": "693ca443c58ca7f6a03a26a65e8083efde2dc792", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxMzQwOQ==", "url": "https://github.com/zaproxy/zaproxy/pull/5957#discussion_r423613409", "bodyText": "I'd suggest removing this comment, it's repeating what the code is doing (same for the others).", "author": "thc202", "createdAt": "2020-05-12T10:00:03Z", "path": "docker/zap-baseline.py", "diffHunk": "@@ -321,10 +321,23 @@ def main(argv):\n         time.sleep(2)\n \n         # Spider target\n-        zap_spider(zap, target)\n+        '''\n+        Here the zap spider is supposed to only use a context if a context file is given", "originalCommit": "693ca443c58ca7f6a03a26a65e8083efde2dc792", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxNTI5OQ==", "url": "https://github.com/zaproxy/zaproxy/pull/5957#discussion_r423615299", "bodyText": "The ID is being returned so the caller can pass the ID when calling the other function.", "author": "thc202", "createdAt": "2020-05-12T10:03:20Z", "path": "docker/zap_common.py", "diffHunk": "@@ -510,8 +524,14 @@ def write_report(file_path, report):\n \n         f.write(report)\n \n+'''\n+zap_import_context imports the context and stores a context_id which will be used by zap_active_scan. Therefore the\n+context_id must be global so that zap_active_scan has access to the variable.\n+'''\n+\n @hook(wrap=True)\n def zap_import_context(zap, context_file):\n+    global context_id", "originalCommit": "693ca443c58ca7f6a03a26a65e8083efde2dc792", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxNTUyMQ==", "url": "https://github.com/zaproxy/zaproxy/pull/5957#discussion_r423615521", "bodyText": "The name of the context might not be the same as the name of the file, better get the name from ZAP (e.g. last one in the context list), it also avoids processing the name multiple times.", "author": "thc202", "createdAt": "2020-05-12T10:03:45Z", "path": "docker/zap-baseline.py", "diffHunk": "@@ -321,10 +321,23 @@ def main(argv):\n         time.sleep(2)\n \n         # Spider target\n-        zap_spider(zap, target)\n+        '''\n+        Here the zap spider is supposed to only use a context if a context file is given\n+        otherwise the inital spider funcionality without a context is used\n+        '''\n+        if context_file:\n+            zap_spider(zap, target, os.path.splitext(os.path.basename(context_file))[0])", "originalCommit": "693ca443c58ca7f6a03a26a65e8083efde2dc792", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYzOTUzMQ==", "url": "https://github.com/zaproxy/zaproxy/pull/5957#discussion_r423639531", "bodyText": "Good catch.", "author": "kingthorin", "createdAt": "2020-05-12T10:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxNTUyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDUwMDk5NA==", "url": "https://github.com/zaproxy/zaproxy/pull/5957#discussion_r430500994", "bodyText": "I'll use ZAP for that! Thx for the hint.", "author": "beldcode", "createdAt": "2020-05-26T15:27:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxNTUyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU5NDY1NQ==", "url": "https://github.com/zaproxy/zaproxy/pull/5957#discussion_r430594655", "bodyText": "@thc202 is there a special reason why to use the last context name from the context list?", "author": "beldcode", "createdAt": "2020-05-26T17:46:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxNTUyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI2ODc5NQ==", "url": "https://github.com/zaproxy/zaproxy/pull/5957#discussion_r437268795", "bodyText": "The last one is the context that was imported/added by the script.", "author": "thc202", "createdAt": "2020-06-09T09:24:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxNTUyMQ=="}], "type": "inlineReview"}, {"oid": "c0ec7c35b5050071e44db42fab8d30660f7f9f9f", "url": "https://github.com/zaproxy/zaproxy/commit/c0ec7c35b5050071e44db42fab8d30660f7f9f9f", "message": "Scan with context in Docker scripts\n\nSigned-off-by: beldcode <philip.berthold@tutanota.com>", "committedDate": "2020-08-27T15:37:14Z", "type": "forcePushed"}, {"oid": "75f81ab625da4e546e150bf85bf3789389996818", "url": "https://github.com/zaproxy/zaproxy/commit/75f81ab625da4e546e150bf85bf3789389996818", "message": "Scan with context in Docker scripts\n\nUse global variables for the context name and ID to use in the spiders\nand active scan, avoiding the need to change the function calls and\nbreaking existing hooks.\nChange import context function to obtain the name of the imported\ncontext.\nUpdate tests to match the new behaviour.\n\nSigned-off-by: beldcode <philip.berthold@tutanota.com>", "committedDate": "2020-08-27T19:57:35Z", "type": "commit"}, {"oid": "75f81ab625da4e546e150bf85bf3789389996818", "url": "https://github.com/zaproxy/zaproxy/commit/75f81ab625da4e546e150bf85bf3789389996818", "message": "Scan with context in Docker scripts\n\nUse global variables for the context name and ID to use in the spiders\nand active scan, avoiding the need to change the function calls and\nbreaking existing hooks.\nChange import context function to obtain the name of the imported\ncontext.\nUpdate tests to match the new behaviour.\n\nSigned-off-by: beldcode <philip.berthold@tutanota.com>", "committedDate": "2020-08-27T19:57:35Z", "type": "forcePushed"}]}