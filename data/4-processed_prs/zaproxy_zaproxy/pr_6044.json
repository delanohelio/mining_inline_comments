{"pr_number": 6044, "pr_title": "Call default filter after custom filters", "pr_createdAt": "2020-06-18T16:21:37Z", "pr_url": "https://github.com/zaproxy/zaproxy/pull/6044", "timeline": [{"oid": "7cff917e6515ad2f527b2e76f80e9239ad237c36", "url": "https://github.com/zaproxy/zaproxy/commit/7cff917e6515ad2f527b2e76f80e9239ad237c36", "message": "Call default filter after custom filters\n\n- Call the default filter after the custom filters\n- Introduce a new filter result \"WANTED\" to signal\nthat a parser wants to parse it.\n\nResolves #6038\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-06-18T19:03:45Z", "type": "forcePushed"}, {"oid": "89e05e052f4e07728963fe8cb80ebf7a526e6b6c", "url": "https://github.com/zaproxy/zaproxy/commit/89e05e052f4e07728963fe8cb80ebf7a526e6b6c", "message": "Call default filter after custom filters\n\n- Call the default filter after the custom filters\n- Introduce a new filter result \"WANTED\" to signal\nthat a parser wants to parse it.\n\nResolves #6038\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-06-18T19:41:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwODg1Mw==", "url": "https://github.com/zaproxy/zaproxy/pull/6044#discussion_r442708853", "bodyText": "This could call the controller directly, we don't need to expose in the public API for now.\nCould be done in the previous line as it no longer needs to be done last.", "author": "thc202", "createdAt": "2020-06-19T08:32:07Z", "path": "zap/src/main/java/org/zaproxy/zap/spider/Spider.java", "diffHunk": "@@ -209,9 +209,9 @@ private void init() {\n             this.addFetchFilter(filter);\n         }\n \n-        // Add a default parse filter and any custom ones\n-        this.addParseFilter(new DefaultParseFilter(spiderParam, extension.getMessages()));\n+        // Add custom parse filters and set a default one\n         for (ParseFilter filter : extension.getCustomParseFilters()) this.addParseFilter(filter);\n+        this.setDefaultParseFilter(new DefaultParseFilter(spiderParam, extension.getMessages()));", "originalCommit": "89e05e052f4e07728963fe8cb80ebf7a526e6b6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwODg4MA==", "url": "https://github.com/zaproxy/zaproxy/pull/6044#discussion_r442708880", "bodyText": "Lets keep these methods internal for now (package accessible).", "author": "thc202", "createdAt": "2020-06-19T08:32:11Z", "path": "zap/src/main/java/org/zaproxy/zap/spider/SpiderController.java", "diffHunk": "@@ -228,6 +230,15 @@ public void addParseFilter(ParseFilter filter) {\n         parseFilters.add(filter);\n     }\n \n+    public void setDefaultParseFilter(ParseFilter filter) {", "originalCommit": "89e05e052f4e07728963fe8cb80ebf7a526e6b6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwODkwOA==", "url": "https://github.com/zaproxy/zaproxy/pull/6044#discussion_r442708908", "bodyText": "This would have to be tweaked to \"Setting default filter: \".", "author": "thc202", "createdAt": "2020-06-19T08:32:14Z", "path": "zap/src/main/java/org/zaproxy/zap/spider/SpiderController.java", "diffHunk": "@@ -228,6 +230,15 @@ public void addParseFilter(ParseFilter filter) {\n         parseFilters.add(filter);\n     }\n \n+    public void setDefaultParseFilter(ParseFilter filter) {\n+        log.debug(\"Loading parse filter: \" + filter.getClass().getSimpleName());", "originalCommit": "89e05e052f4e07728963fe8cb80ebf7a526e6b6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwOTQxNQ==", "url": "https://github.com/zaproxy/zaproxy/pull/6044#discussion_r442709415", "bodyText": "This could skip some filters when WANTED, the suggestion was to call all of them to allow custom restrictions (regardless of the order they were added).", "author": "thc202", "createdAt": "2020-06-19T08:33:14Z", "path": "zap/src/main/java/org/zaproxy/zap/spider/SpiderTask.java", "diffHunk": "@@ -234,22 +234,29 @@ private void runImpl() {\n         parent.checkPauseAndWait();\n \n         // Check the parse filters to see if the resource should be skipped from parsing\n+        FilterResult filterResult = FilterResult.NOT_FILTERED;\n         for (ParseFilter filter : parent.getController().getParseFilters()) {\n-            FilterResult filterResult = filter.filtered(msg);\n-            if (filterResult.isFiltered()) {\n-                if (log.isDebugEnabled()) {\n-                    log.debug(\n-                            \"Resource [\"\n-                                    + msg.getRequestHeader().getURI()\n-                                    + \"] fetched, but will not be parsed due to a ParseFilter rule: \"\n-                                    + filterResult.getReason());\n-                }\n-\n-                parent.notifyListenersSpiderTaskResult(\n-                        new SpiderTaskResult(msg, filterResult.getReason()));\n-                return;\n+            filterResult = filter.filtered(msg);\n+            if (filterResult.isFiltered() || filterResult == FilterResult.WANTED) {", "originalCommit": "89e05e052f4e07728963fe8cb80ebf7a526e6b6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwOTYyMg==", "url": "https://github.com/zaproxy/zaproxy/pull/6044#discussion_r442709622", "bodyText": "Worth explaining that this skips the default filter, if no other filter filters it out.", "author": "thc202", "createdAt": "2020-06-19T08:33:43Z", "path": "zap/src/main/java/org/zaproxy/zap/spider/filters/ParseFilter.java", "diffHunk": "@@ -71,6 +71,9 @@ public FilterResult filtered(HttpMessage responseMessage) {\n         /** Indicates that the resource was not filtered. */\n         public static final FilterResult NOT_FILTERED = new FilterResult();\n \n+        /** Indicates that the resource is wanted by a custom parser. */", "originalCommit": "89e05e052f4e07728963fe8cb80ebf7a526e6b6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "891ba333c194b6be127aa83998c63a7900cbe868", "url": "https://github.com/zaproxy/zaproxy/commit/891ba333c194b6be127aa83998c63a7900cbe868", "message": "Call default filter after custom filters\n\n- Call the default filter after the custom filters\n- Introduce a new filter result \"WANTED\" to signal\nthat a parser wants to parse it. It allows the\nresource to skip the default filter, if no other\nfilter filters it out.\n\nResolves #6038\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-06-19T10:05:08Z", "type": "forcePushed"}, {"oid": "7961e021bbff74aaeb28949a8a0eddd92a9533b8", "url": "https://github.com/zaproxy/zaproxy/commit/7961e021bbff74aaeb28949a8a0eddd92a9533b8", "message": "Call default filter after custom filters\n\n- Call the default filter after the custom filters\n- Introduce a new filter result \"WANTED\" to signal\nthat a parser wants to parse it. It allows the\nresource to skip the default filter, if no other\nfilter filters it out.\n\nResolves #6038\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-06-19T10:07:10Z", "type": "forcePushed"}, {"oid": "50a5d1b00c5fd3ede161a962e7704b0aa190eeee", "url": "https://github.com/zaproxy/zaproxy/commit/50a5d1b00c5fd3ede161a962e7704b0aa190eeee", "message": "Call default filter after custom filters\n\n- Call the default filter after the custom filters\n- Introduce a new filter result \"WANTED\" to signal\nthat a parser wants to parse it. It allows the\nresource to skip the default filter, if no other\nfilter filters it out.\n\nResolves #6038\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-06-19T13:50:24Z", "type": "commit"}, {"oid": "50a5d1b00c5fd3ede161a962e7704b0aa190eeee", "url": "https://github.com/zaproxy/zaproxy/commit/50a5d1b00c5fd3ede161a962e7704b0aa190eeee", "message": "Call default filter after custom filters\n\n- Call the default filter after the custom filters\n- Introduce a new filter result \"WANTED\" to signal\nthat a parser wants to parse it. It allows the\nresource to skip the default filter, if no other\nfilter filters it out.\n\nResolves #6038\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-06-19T13:50:24Z", "type": "forcePushed"}]}