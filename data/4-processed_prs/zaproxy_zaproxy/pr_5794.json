{"pr_number": 5794, "pr_title": "Correct MailTo pattern for RegexAutoTagScanner", "pr_createdAt": "2020-01-11T01:48:06Z", "pr_url": "https://github.com/zaproxy/zaproxy/pull/5794", "timeline": [{"oid": "4af577ccb357517c8091a1b59fcee7db266fd5ee", "url": "https://github.com/zaproxy/zaproxy/commit/4af577ccb357517c8091a1b59fcee7db266fd5ee", "message": "Correct MailTo pattern for RegexAutoTagScanner\n\nconfig.xml > Correct default.\nConstant.java > Add method to look for the incorrect pattern and fix it.\n(Added a ZAP comment.)\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-01-11T01:50:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ5MDE0OQ==", "url": "https://github.com/zaproxy/zaproxy/pull/5794#discussion_r365490149", "bodyText": "I've probably overlooked something, but this seemed necessary to make it stick.", "author": "kingthorin", "createdAt": "2020-01-11T01:58:47Z", "path": "zap/src/main/java/org/parosproxy/paros/Constant.java", "diffHunk": "@@ -1092,6 +1095,29 @@ private static void upgradeFrom2_8_0(XMLConfiguration config) {\n         // Update to a newer default user agent\n         config.setProperty(\n                 ConnectionParam.DEFAULT_USER_AGENT, ConnectionParam.DEFAULT_DEFAULT_USER_AGENT);\n+        updatePscanTagMailtoPattern(config);\n+    }\n+\n+    private static void updatePscanTagMailtoPattern(XMLConfiguration config) {\n+        String autoTagScannersKey = \"pscans.autoTagScanners.scanner\";\n+        List<HierarchicalConfiguration> tagScanners = config.configurationsAt(autoTagScannersKey);\n+        String badPattern = \"<.*href\\\\s*['\\\"]?mailto:\";\n+        String goodPattern = \"<.*href\\\\s*=['\\\"]?mailto:\";\n+\n+        for (int i = 0, size = tagScanners.size(); i < size; ++i) {\n+            String elementBaseKey = autoTagScannersKey + \"(\" + i + \").\";\n+            String currentKeyResBodyRegex = elementBaseKey + \"resBodyRegex\";\n+            if (config.getProperty(currentKeyResBodyRegex).equals(badPattern)) {\n+                config.setProperty(currentKeyResBodyRegex, goodPattern);\n+                break;\n+            }\n+        }\n+\n+        try {\n+            config.save();", "originalCommit": "4af577ccb357517c8091a1b59fcee7db266fd5ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU5MDk0MA==", "url": "https://github.com/zaproxy/zaproxy/pull/5794#discussion_r365590940", "bodyText": "It shouldn't, the config is already being saved after calling all upgradeFrom_ methods (when setting the latest version). I also tested without this statement and the tag was updated in the file.", "author": "thc202", "createdAt": "2020-01-12T15:31:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ5MDE0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU5MTc3NA==", "url": "https://github.com/zaproxy/zaproxy/pull/5794#discussion_r365591774", "bodyText": "But did you see it in the UI as updated?", "author": "kingthorin", "createdAt": "2020-01-12T15:45:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ5MDE0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU5MTkzNQ==", "url": "https://github.com/zaproxy/zaproxy/pull/5794#discussion_r365591935", "bodyText": "Yes, it was the new value.", "author": "thc202", "createdAt": "2020-01-12T15:46:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ5MDE0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU5MjYyOA==", "url": "https://github.com/zaproxy/zaproxy/pull/5794#discussion_r365592628", "bodyText": "Probably because of how I was testing? Inserting the method call at 610'ish so it'd be used in devmode... I'll remove this try block.", "author": "kingthorin", "createdAt": "2020-01-12T15:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ5MDE0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU5MjgxNg==", "url": "https://github.com/zaproxy/zaproxy/pull/5794#discussion_r365592816", "bodyText": "Right, in that case it would not be saved.", "author": "thc202", "createdAt": "2020-01-12T16:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ5MDE0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU5MDk5Ng==", "url": "https://github.com/zaproxy/zaproxy/pull/5794#discussion_r365590996", "bodyText": "Worth adding \\\\s* after the equals.", "author": "thc202", "createdAt": "2020-01-12T15:32:08Z", "path": "zap/src/main/java/org/parosproxy/paros/Constant.java", "diffHunk": "@@ -1092,6 +1095,29 @@ private static void upgradeFrom2_8_0(XMLConfiguration config) {\n         // Update to a newer default user agent\n         config.setProperty(\n                 ConnectionParam.DEFAULT_USER_AGENT, ConnectionParam.DEFAULT_DEFAULT_USER_AGENT);\n+        updatePscanTagMailtoPattern(config);\n+    }\n+\n+    private static void updatePscanTagMailtoPattern(XMLConfiguration config) {\n+        String autoTagScannersKey = \"pscans.autoTagScanners.scanner\";\n+        List<HierarchicalConfiguration> tagScanners = config.configurationsAt(autoTagScannersKey);\n+        String badPattern = \"<.*href\\\\s*['\\\"]?mailto:\";\n+        String goodPattern = \"<.*href\\\\s*=['\\\"]?mailto:\";", "originalCommit": "4af577ccb357517c8091a1b59fcee7db266fd5ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU5MTg4OA==", "url": "https://github.com/zaproxy/zaproxy/pull/5794#discussion_r365591888", "bodyText": "Okay", "author": "kingthorin", "createdAt": "2020-01-12T15:45:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU5MDk5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTU5MTM5NA==", "url": "https://github.com/zaproxy/zaproxy/pull/5794#discussion_r365591394", "bodyText": "String currentKeyResBodyRegex = autoTagScannersKey + \"(\" + i + \").resBodyRegex\";", "author": "thc202", "createdAt": "2020-01-12T15:38:49Z", "path": "zap/src/main/java/org/parosproxy/paros/Constant.java", "diffHunk": "@@ -1092,6 +1095,29 @@ private static void upgradeFrom2_8_0(XMLConfiguration config) {\n         // Update to a newer default user agent\n         config.setProperty(\n                 ConnectionParam.DEFAULT_USER_AGENT, ConnectionParam.DEFAULT_DEFAULT_USER_AGENT);\n+        updatePscanTagMailtoPattern(config);\n+    }\n+\n+    private static void updatePscanTagMailtoPattern(XMLConfiguration config) {\n+        String autoTagScannersKey = \"pscans.autoTagScanners.scanner\";\n+        List<HierarchicalConfiguration> tagScanners = config.configurationsAt(autoTagScannersKey);\n+        String badPattern = \"<.*href\\\\s*['\\\"]?mailto:\";\n+        String goodPattern = \"<.*href\\\\s*=['\\\"]?mailto:\";\n+\n+        for (int i = 0, size = tagScanners.size(); i < size; ++i) {\n+            String elementBaseKey = autoTagScannersKey + \"(\" + i + \").\";\n+            String currentKeyResBodyRegex = elementBaseKey + \"resBodyRegex\";", "originalCommit": "4af577ccb357517c8091a1b59fcee7db266fd5ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "843dc87cb65ed6ad6502d56b885af16a8e0cef27", "url": "https://github.com/zaproxy/zaproxy/commit/843dc87cb65ed6ad6502d56b885af16a8e0cef27", "message": "Correct MailTo pattern for RegexAutoTagScanner\n\nconfig.xml > Correct default.\nConstant.java > Add method to look for the incorrect pattern and fix it.\n(Added a ZAP comment.)\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-01-12T15:56:04Z", "type": "forcePushed"}, {"oid": "bac74a33aadddcfe7a8bdf808269e7576634ffbc", "url": "https://github.com/zaproxy/zaproxy/commit/bac74a33aadddcfe7a8bdf808269e7576634ffbc", "message": "Correct MailTo pattern for RegexAutoTagScanner\n\nconfig.xml > Correct default.\nConstant.java > Add method to look for the incorrect pattern and fix it.\n(Added a ZAP comment.)\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-01-12T15:58:32Z", "type": "forcePushed"}, {"oid": "5cdfb192212b1f5b975d9b406affdb5354434eb8", "url": "https://github.com/zaproxy/zaproxy/commit/5cdfb192212b1f5b975d9b406affdb5354434eb8", "message": "Correct MailTo pattern for RegexAutoTagScanner\n\nconfig.xml > Correct default.\nConstant.java > Add method to look for the incorrect pattern and fix it.\n(Added a ZAP comment.)\n\nSigned-off-by: kingthorin kingthorin@users.noreply.github.com", "committedDate": "2020-01-12T16:02:41Z", "type": "forcePushed"}, {"oid": "a6667f31a88b83d3d2dd3a6b619f7c24cd83a6e9", "url": "https://github.com/zaproxy/zaproxy/commit/a6667f31a88b83d3d2dd3a6b619f7c24cd83a6e9", "message": "Correct MailTo pattern for RegexAutoTagScanner\n\nconfig.xml > Correct default.\nConstant.java > Add method to look for the incorrect pattern and fix it.\n(Added a ZAP comment.)\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-01-12T16:03:43Z", "type": "forcePushed"}, {"oid": "4bb2884af2a37c5d967eb0be48240713c029a724", "url": "https://github.com/zaproxy/zaproxy/commit/4bb2884af2a37c5d967eb0be48240713c029a724", "message": "Correct MailTo pattern for RegexAutoTagScanner\n\nconfig.xml > Correct default.\nConstant.java > Add method to look for the incorrect pattern and fix it.\n(Added a ZAP comment.)\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-01-12T16:13:05Z", "type": "forcePushed"}, {"oid": "f78dbeb10d8afd99ff608f13b6727d3dda9a7e8f", "url": "https://github.com/zaproxy/zaproxy/commit/f78dbeb10d8afd99ff608f13b6727d3dda9a7e8f", "message": "Correct MailTo pattern for RegexAutoTagScanner\n\nconfig.xml > Correct default.\nConstant.java > Add method to look for the incorrect pattern and fix it.\n(Added a ZAP comment.)\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-01-12T18:09:34Z", "type": "commit"}, {"oid": "f78dbeb10d8afd99ff608f13b6727d3dda9a7e8f", "url": "https://github.com/zaproxy/zaproxy/commit/f78dbeb10d8afd99ff608f13b6727d3dda9a7e8f", "message": "Correct MailTo pattern for RegexAutoTagScanner\n\nconfig.xml > Correct default.\nConstant.java > Add method to look for the incorrect pattern and fix it.\n(Added a ZAP comment.)\n\nSigned-off-by: kingthorin <kingthorin@users.noreply.github.com>", "committedDate": "2020-01-12T18:09:34Z", "type": "forcePushed"}]}