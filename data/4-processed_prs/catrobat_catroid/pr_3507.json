{"pr_number": 3507, "pr_title": "CATROID-500 Fix variable interpretation in WebRequestBrick", "pr_createdAt": "2020-03-02T18:27:37Z", "pr_url": "https://github.com/Catrobat/Catroid/pull/3507", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5NDA4NQ==", "url": "https://github.com/Catrobat/Catroid/pull/3507#discussion_r397894085", "bodyText": "Could you split up the test in a way that its sepparated from setup and the code lines which really do test something. Also please think about implementing the teardown function because you are using static members like the StageActivity.stageListener. .... This mocks will remain for further tests and may bring them to fail if not reset", "author": "DinosaurierRex", "createdAt": "2020-03-25T14:24:13Z", "path": "catroid/src/test/java/org/catrobat/catroid/test/content/actions/WebRequestActionTest.java", "diffHunk": "@@ -185,4 +190,50 @@ public void testCancelledCallAndResendRequest() {\n \t\tverify(StageActivity.stageListener.webConnectionHolder, times(2)).addConnection(any());\n \t\tverify(webConnection, times(2)).sendWebRequest();\n \t}\n+\n+\t@Test\n+\tpublic void testSuccessfulResponseWithInputVariable() {\n+\t\tUserVariable inputVariable = new UserVariable(TEST_INPUTVARIABLE, TEST_URL);\n+\t\tFormulaElement formulaElement = new FormulaElement(\n+\t\t\t\tFormulaElement.ElementType.USER_VARIABLE, inputVariable.getName(), null);\n+\t\tfinal String responseString = \"Response\";\n+\n+\t\tFormula formula = Mockito.spy(new Formula(formulaElement));\n+\n+\t\ttestSprite.addUserVariable(userVariable);\n+\t\ttestSprite.addUserVariable(inputVariable);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQwNTE5OQ==", "url": "https://github.com/Catrobat/Catroid/pull/3507#discussion_r412405199", "bodyText": "Setup is now in a seperate function.\nCan you please specify, how the existing teardown-function is not sufficient?\nI have only seen other tests setting the Stagelister.stageListener to null.", "author": "stefanreichenauer", "createdAt": "2020-04-21T18:47:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5NDA4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5NjI0MA==", "url": "https://github.com/Catrobat/Catroid/pull/3507#discussion_r397896240", "bodyText": "An Exception will automatically cause the test to fail. So please dont catch Excpetions just to make the test \"fail\". Also think about another test where this failing could be triggered in a way that you want the test to pass if the Exception is thrown. Hint: Annotations @Test(expected = NullPointerException.class) like this will make the test pass if the mentioned exception is thrown.", "author": "DinosaurierRex", "createdAt": "2020-03-25T14:26:51Z", "path": "catroid/src/test/java/org/catrobat/catroid/test/content/actions/WebRequestActionTest.java", "diffHunk": "@@ -185,4 +190,50 @@ public void testCancelledCallAndResendRequest() {\n \t\tverify(StageActivity.stageListener.webConnectionHolder, times(2)).addConnection(any());\n \t\tverify(webConnection, times(2)).sendWebRequest();\n \t}\n+\n+\t@Test\n+\tpublic void testSuccessfulResponseWithInputVariable() {\n+\t\tUserVariable inputVariable = new UserVariable(TEST_INPUTVARIABLE, TEST_URL);\n+\t\tFormulaElement formulaElement = new FormulaElement(\n+\t\t\t\tFormulaElement.ElementType.USER_VARIABLE, inputVariable.getName(), null);\n+\t\tfinal String responseString = \"Response\";\n+\n+\t\tFormula formula = Mockito.spy(new Formula(formulaElement));\n+\n+\t\ttestSprite.addUserVariable(userVariable);\n+\t\ttestSprite.addUserVariable(inputVariable);\n+\n+\t\tWebRequestAction action = (WebRequestAction) testSprite.getActionFactory().createWebRequestAction(\n+\t\t\t\ttestSprite,\n+\t\t\t\tformula,\n+\t\t\t\tuserVariable\n+\t\t);\n+\t\taction.setWebConnectionFactory(webConnectionFactory);\n+\n+\t\twhen(StageActivity.stageListener.webConnectionHolder.addConnection(any())).thenReturn(true);\n+\n+\t\ttry {\n+\t\t\tdoAnswer(invocation -> {\n+\t\t\t\tSprite sprite = invocation.getArgument(0);\n+\t\t\t\treturn String.valueOf(sprite.getUserVariable(TEST_INPUTVARIABLE).getValue());\n+\t\t\t}).when(formula).interpretString(any(Sprite.class));\n+\t\t} catch (InterpretationException e) {\n+\t\t\tfail(\"Formula could not be interpreted\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQwNTQ4Nw==", "url": "https://github.com/Catrobat/Catroid/pull/3507#discussion_r412405487", "bodyText": "I removed the try-catch-block, and added the exception to the method signature.\nI choose to not add a test for testing the failing exception, because the exception is triggered by the function Formula.interpretString, which is not to test in this test-class, and the function is mocked anyway.\nPlease let me know, if I should add a test for it.", "author": "stefanreichenauer", "createdAt": "2020-04-21T18:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5NjI0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5NzIxNg==", "url": "https://github.com/Catrobat/Catroid/pull/3507#discussion_r397897216", "bodyText": "Split these asserts up in several TCs as far as possible. If a setup function is implemented, for each Testcase your setup will be loaded and then its easier to split up", "author": "DinosaurierRex", "createdAt": "2020-03-25T14:27:59Z", "path": "catroid/src/test/java/org/catrobat/catroid/test/content/actions/WebRequestActionTest.java", "diffHunk": "@@ -185,4 +190,50 @@ public void testCancelledCallAndResendRequest() {\n \t\tverify(StageActivity.stageListener.webConnectionHolder, times(2)).addConnection(any());\n \t\tverify(webConnection, times(2)).sendWebRequest();\n \t}\n+\n+\t@Test\n+\tpublic void testSuccessfulResponseWithInputVariable() {\n+\t\tUserVariable inputVariable = new UserVariable(TEST_INPUTVARIABLE, TEST_URL);\n+\t\tFormulaElement formulaElement = new FormulaElement(\n+\t\t\t\tFormulaElement.ElementType.USER_VARIABLE, inputVariable.getName(), null);\n+\t\tfinal String responseString = \"Response\";\n+\n+\t\tFormula formula = Mockito.spy(new Formula(formulaElement));\n+\n+\t\ttestSprite.addUserVariable(userVariable);\n+\t\ttestSprite.addUserVariable(inputVariable);\n+\n+\t\tWebRequestAction action = (WebRequestAction) testSprite.getActionFactory().createWebRequestAction(\n+\t\t\t\ttestSprite,\n+\t\t\t\tformula,\n+\t\t\t\tuserVariable\n+\t\t);\n+\t\taction.setWebConnectionFactory(webConnectionFactory);\n+\n+\t\twhen(StageActivity.stageListener.webConnectionHolder.addConnection(any())).thenReturn(true);\n+\n+\t\ttry {\n+\t\t\tdoAnswer(invocation -> {\n+\t\t\t\tSprite sprite = invocation.getArgument(0);\n+\t\t\t\treturn String.valueOf(sprite.getUserVariable(TEST_INPUTVARIABLE).getValue());\n+\t\t\t}).when(formula).interpretString(any(Sprite.class));\n+\t\t} catch (InterpretationException e) {\n+\t\t\tfail(\"Formula could not be interpreted\");\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tdoAnswer(invocation -> {\n+\t\t\tString url = invocation.getArgument(0);\n+\t\t\tassertEquals(url, TEST_URL);\n+\t\t\treturn webConnection;\n+\t\t}).when(webConnectionFactory).createWebConnection(anyString(), any());\n+\n+\t\tdoAnswer(invocation -> {\n+\t\t\taction.onRequestFinished(responseString);\n+\t\t\treturn null;\n+\t\t}).when(webConnection).sendWebRequest();\n+\n+\t\tassertTrue(action.act(0f));\n+\t\tassertEquals(responseString, userVariable.getValue());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQwNjU1Ng==", "url": "https://github.com/Catrobat/Catroid/pull/3507#discussion_r412406556", "bodyText": "Done.", "author": "stefanreichenauer", "createdAt": "2020-04-21T18:49:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg5NzIxNg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "10417aafb2fd6d82abc405a8bfeab24012a70865", "url": "https://github.com/Catrobat/Catroid/commit/10417aafb2fd6d82abc405a8bfeab24012a70865", "message": "CATROID-500 Fix variable interpretation in WebRequestBrick\n\nMove the interpretation of the input formula of the WebRequestBrick\nfrom the ActionFactory to the action, so that the formula is\ninterpreted at run-time.", "committedDate": "2020-04-21T19:08:31Z", "type": "commit"}, {"oid": "10417aafb2fd6d82abc405a8bfeab24012a70865", "url": "https://github.com/Catrobat/Catroid/commit/10417aafb2fd6d82abc405a8bfeab24012a70865", "message": "CATROID-500 Fix variable interpretation in WebRequestBrick\n\nMove the interpretation of the input formula of the WebRequestBrick\nfrom the ActionFactory to the action, so that the formula is\ninterpreted at run-time.", "committedDate": "2020-04-21T19:08:31Z", "type": "forcePushed"}]}