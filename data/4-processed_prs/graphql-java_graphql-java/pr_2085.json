{"pr_number": 2085, "pr_title": "#1914 Use default values for fields of input types when default argument value is provided", "pr_createdAt": "2020-10-28T02:36:50Z", "pr_url": "https://github.com/graphql-java/graphql-java/pull/2085", "timeline": [{"oid": "b0c8753de5c0dd0b09ea53d7644dbf419ef84c15", "url": "https://github.com/graphql-java/graphql-java/commit/b0c8753de5c0dd0b09ea53d7644dbf419ef84c15", "message": "Use default values for fields of input types when default arguments are provided", "committedDate": "2020-10-28T02:07:57Z", "type": "commit"}, {"oid": "f71a196f7c0fb8fc5c37c2f1fd868136e683cda0", "url": "https://github.com/graphql-java/graphql-java/commit/f71a196f7c0fb8fc5c37c2f1fd868136e683cda0", "message": "#1914 Shortened test name", "committedDate": "2020-10-28T02:44:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0NzIwNQ==", "url": "https://github.com/graphql-java/graphql-java/pull/2085#discussion_r513147205", "bodyText": "Performance of this statement can be improved by keeping a map of Object field's name and the field itself in ObjectValue class.", "author": "priyaaggarwal24", "createdAt": "2020-10-28T02:47:06Z", "path": "src/main/java/graphql/schema/idl/SchemaGeneratorHelper.java", "diffHunk": "@@ -292,8 +293,13 @@ Object buildArrayValue(GraphQLType requiredType, ArrayValue arrayValue) {\n \n     Object buildObjectValue(ObjectValue defaultValue, GraphQLInputObjectType objectType) {\n         Map<String, Object> map = new LinkedHashMap<>();\n-        defaultValue.getObjectFields().forEach(of -> map.put(of.getName(),\n-                buildValue(of.getValue(), objectType.getField(of.getName()).getType())));\n+        objectType.getFieldDefinitions().forEach(\n+                f -> {\n+                    final Value<?> fieldValueFromDefaultObjectValue = defaultValue.getObjectFields().stream()", "originalCommit": "f71a196f7c0fb8fc5c37c2f1fd868136e683cda0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYzOTg2MA==", "url": "https://github.com/graphql-java/graphql-java/pull/2085#discussion_r514639860", "bodyText": "fields of objects are typically < 10 say - iterating them is not  a real problem.  Also schema building is KN OWN to be a heavy thing they can be slower (where slower is not really slow) - So there are no perf savings to be had in schema generation as a rule\nThat is not to say it should be terrible - but that when people come to us about performance its NOT in the schema gen side of things", "author": "bbakerman", "createdAt": "2020-10-30T00:21:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0NzIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY3NTE2Mg==", "url": "https://github.com/graphql-java/graphql-java/pull/2085#discussion_r514675162", "bodyText": "ok, thanks", "author": "priyaaggarwal24", "createdAt": "2020-10-30T01:38:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0NzIwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0Nzg0Mw==", "url": "https://github.com/graphql-java/graphql-java/pull/2085#discussion_r513147843", "bodyText": "Introspection of schema now considers the default values defined in Input types.", "author": "priyaaggarwal24", "createdAt": "2020-10-28T02:49:36Z", "path": "src/test/groovy/graphql/introspection/IntrospectionResultToSchemaTest.groovy", "diffHunk": "@@ -590,7 +590,7 @@ input CharacterInput {\n }\n \n type Query {\n-  outputField(inputArg: InputType = {age : 666, name : \"nameViaArg\"}, inputBoolean: Boolean = true, inputInt: Int = 1, inputString: String = \"viaArgString\"): OutputType\n+  outputField(inputArg: InputType = {age : 666, complex : {boolean : true, int : 666, string : \"string\"}, name : \"nameViaArg\", rocks : true}, inputBoolean: Boolean = true, inputInt: Int = 1, inputString: String = \"viaArgString\"): OutputType", "originalCommit": "f71a196f7c0fb8fc5c37c2f1fd868136e683cda0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e7ad9278e7530a4e05892e03b36a18eabdfb18fb", "url": "https://github.com/graphql-java/graphql-java/commit/e7ad9278e7530a4e05892e03b36a18eabdfb18fb", "message": "#1914 Added a test to verify if null value provided in input overrides default", "committedDate": "2020-10-30T01:30:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY0NjQ1NA==", "url": "https://github.com/graphql-java/graphql-java/pull/2085#discussion_r514646454", "bodyText": "final Value<?> fieldValueFromDefaultObjectValue = defaultValue.getObjectFields().stream().filter(dvf -> dvf.getName().equals(f.getName())).map(ObjectField::getValue).findFirst().orElse(null);\nends up really hard to read.  I like to put in simple methods to represent this\nfinal Value<?> fieldValueFromDefaultObjectValue = buildFieldDefaultValue(defaultValue,...)", "author": "bbakerman", "createdAt": "2020-10-30T00:47:42Z", "path": "src/main/java/graphql/schema/idl/SchemaGeneratorHelper.java", "diffHunk": "@@ -292,8 +293,13 @@ Object buildArrayValue(GraphQLType requiredType, ArrayValue arrayValue) {\n \n     Object buildObjectValue(ObjectValue defaultValue, GraphQLInputObjectType objectType) {\n         Map<String, Object> map = new LinkedHashMap<>();\n-        defaultValue.getObjectFields().forEach(of -> map.put(of.getName(),\n-                buildValue(of.getValue(), objectType.getField(of.getName()).getType())));\n+        objectType.getFieldDefinitions().forEach(\n+                f -> {\n+                    final Value<?> fieldValueFromDefaultObjectValue = defaultValue.getObjectFields().stream()\n+                            .filter(dvf -> dvf.getName().equals(f.getName())).map(ObjectField::getValue).findFirst().orElse(null);\n+                    map.put(f.getName(), fieldValueFromDefaultObjectValue != null ? buildValue(fieldValueFromDefaultObjectValue, f.getType()): f.getDefaultValue());\n+                }\n+        );\n         return map;", "originalCommit": "f71a196f7c0fb8fc5c37c2f1fd868136e683cda0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY5NTA2MA==", "url": "https://github.com/graphql-java/graphql-java/pull/2085#discussion_r514695060", "bodyText": "@bbakerman Done. Refactored the long statement into a method.", "author": "priyaaggarwal24", "createdAt": "2020-10-30T01:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY0NjQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY3MjI5MQ==", "url": "https://github.com/graphql-java/graphql-java/pull/2085#discussion_r514672291", "bodyText": "Can we get another test in place for when the inner field is named BUT the value is null", "author": "bbakerman", "createdAt": "2020-10-30T01:35:14Z", "path": "src/test/groovy/graphql/Issue1914.groovy", "diffHunk": "@@ -0,0 +1,81 @@\n+package graphql\n+\n+import graphql.schema.DataFetcher\n+import spock.lang.Specification\n+\n+class Issue1914 extends Specification {\n+\n+    def \"default values in input objects are respected when variable is not provided\"() {\n+        given:\n+        def spec = \"\"\"type Query {\n+            sayHello(arg: Arg! = {}): String\n+        }\n+        input Arg {\n+            foo: String = \"bar\"\n+        }\n+        \"\"\"\n+        DataFetcher df = { dfe ->\n+            Map arg = dfe.getArgument(\"arg\")\n+            return arg.get(\"foo\")\n+        } as DataFetcher\n+        def graphQL = TestUtil.graphQL(spec, [\"Query\": [\"sayHello\": df]]).build()\n+\n+        when:\n+        def result = graphQL.execute('{sayHello}')\n+\n+        then:\n+        result.errors.isEmpty()\n+        result.data == [sayHello: \"bar\"]\n+\n+    }\n+\n+    def \"default values in input objects are overridden when variable is provided\"() {\n+        given:\n+        def spec = \"\"\"type Query {\n+            sayHello(arg: Arg! = {foo: \"brewery\"}): String\n+        }\n+        input Arg {\n+            foo: String = \"bar\"\n+        }\n+        \"\"\"\n+        DataFetcher df = { dfe ->\n+            Map arg = dfe.getArgument(\"arg\")\n+            return arg.get(\"foo\")\n+        } as DataFetcher\n+        def graphQL = TestUtil.graphQL(spec, [\"Query\": [\"sayHello\": df]]).build()\n+\n+        when:\n+        def result = graphQL.execute('{sayHello}')\n+\n+        then:\n+        result.errors.isEmpty()\n+        result.data == [sayHello: \"brewery\"]\n+\n+    }\n+\n+    def \"default values in input objects are overridden when variable is provided and otherwise are respected\"() {\n+        given:\n+        def spec = \"\"\"type Query {\n+            sayHello(arg: Arg! = {field1: \"F1ValOverride\"}): String\n+        }\n+        input Arg {\n+            field1: String = \"F1V\"\n+            field2: String = \"F2V\"\n+        }\n+        \"\"\"\n+        DataFetcher df = { dfe ->\n+            Map arg = dfe.getArgument(\"arg\")\n+            return arg.get(\"field1\") + \" & \" + arg.get(\"field2\")\n+        } as DataFetcher\n+        def graphQL = TestUtil.graphQL(spec, [\"Query\": [\"sayHello\": df]]).build()\n+\n+        when:\n+        def result = graphQL.execute('{sayHello}')\n+\n+        then:\n+        result.errors.isEmpty()\n+        result.data == [sayHello: \"F1ValOverride & F2V\"]", "originalCommit": "f71a196f7c0fb8fc5c37c2f1fd868136e683cda0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY3Njk0OA==", "url": "https://github.com/graphql-java/graphql-java/pull/2085#discussion_r514676948", "bodyText": "do you something like\n\"default values in input objects are overridden when null value is provided in input\"?\nor do you mean the default value provided for a field in input type is null?", "author": "priyaaggarwal24", "createdAt": "2020-10-30T01:40:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY3MjI5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY5Mzk5OA==", "url": "https://github.com/graphql-java/graphql-java/pull/2085#discussion_r514693998", "bodyText": "@bbakerman Added a test where one of the fields in input type have null value (below this test)", "author": "priyaaggarwal24", "createdAt": "2020-10-30T01:58:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY3MjI5MQ=="}], "type": "inlineReview"}, {"oid": "f8dbacc8ede09935a5a5dbf50d11813899c5314f", "url": "https://github.com/graphql-java/graphql-java/commit/f8dbacc8ede09935a5a5dbf50d11813899c5314f", "message": "#1914 Added a test with field having null value and refactored a long statement into a method", "committedDate": "2020-10-30T01:51:13Z", "type": "commit"}, {"oid": "edf49a29fc6c5f4177cf34d3cc11a4c653ca99f6", "url": "https://github.com/graphql-java/graphql-java/commit/edf49a29fc6c5f4177cf34d3cc11a4c653ca99f6", "message": "#1914 Updated test to have a field with default value null", "committedDate": "2020-10-30T01:57:50Z", "type": "commit"}]}