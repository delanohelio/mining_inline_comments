{"pr_number": 3525, "pr_title": "In functional tests where possible remove the VIRTUAL tag", "pr_createdAt": "2020-06-04T12:47:15Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3525", "timeline": [{"oid": "94f50774138ec30b9815266f3bbafdfd1212fbb7", "url": "https://github.com/telstra/open-kilda/commit/94f50774138ec30b9815266f3bbafdfd1212fbb7", "message": "In functional tests where possible remove the VIRTUAL tag", "committedDate": "2020-06-05T09:08:35Z", "type": "forcePushed"}, {"oid": "0603f4ffb2ace41dcaba332646272dc33b5978db", "url": "https://github.com/telstra/open-kilda/commit/0603f4ffb2ace41dcaba332646272dc33b5978db", "message": "In functional tests where possible remove the VIRTUAL tag", "committedDate": "2020-06-10T07:38:23Z", "type": "forcePushed"}, {"oid": "a9bd96efa290a0155a4ea43828e193082094d203", "url": "https://github.com/telstra/open-kilda/commit/a9bd96efa290a0155a4ea43828e193082094d203", "message": "In functional tests where possible remove the VIRTUAL tag", "committedDate": "2020-06-10T12:17:43Z", "type": "forcePushed"}, {"oid": "f6fd9906bd0ec1678c69ecc4b4d8ebdfa862db17", "url": "https://github.com/telstra/open-kilda/commit/f6fd9906bd0ec1678c69ecc4b4d8ebdfa862db17", "message": "In functional tests where possible remove the VIRTUAL tag", "committedDate": "2020-06-11T09:26:42Z", "type": "forcePushed"}, {"oid": "4a5f7d2abf0bc25c4002880db610700c4fa2fced", "url": "https://github.com/telstra/open-kilda/commit/4a5f7d2abf0bc25c4002880db610700c4fa2fced", "message": "In functional tests where possible remove the VIRTUAL tag", "committedDate": "2020-06-12T14:24:49Z", "type": "forcePushed"}, {"oid": "5fc97eef07a89e5e5a980e66663d4e02af515867", "url": "https://github.com/telstra/open-kilda/commit/5fc97eef07a89e5e5a980e66663d4e02af515867", "message": "In functional tests where possible remove the VIRTUAL tag", "committedDate": "2020-06-15T10:13:22Z", "type": "forcePushed"}, {"oid": "6938335e9b84662a52fac92de61633b467187deb", "url": "https://github.com/telstra/open-kilda/commit/6938335e9b84662a52fac92de61633b467187deb", "message": "In functional tests where possible remove the VIRTUAL tag", "committedDate": "2020-06-17T08:27:49Z", "type": "forcePushed"}, {"oid": "65fa5a5c54d72b1c02e41f0c385ddb417cc5a341", "url": "https://github.com/telstra/open-kilda/commit/65fa5a5c54d72b1c02e41f0c385ddb417cc5a341", "message": "In functional tests where possible remove the VIRTUAL tag", "committedDate": "2020-06-23T08:32:21Z", "type": "forcePushed"}, {"oid": "9a47837719c784b1b01ca3f5d22814da95596e66", "url": "https://github.com/telstra/open-kilda/commit/9a47837719c784b1b01ca3f5d22814da95596e66", "message": "In functional tests where possible remove the VIRTUAL tag", "committedDate": "2020-06-23T10:45:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY5MTkxMA==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444691910", "bodyText": "why?", "author": "andriidovhan", "createdAt": "2020-06-24T07:16:01Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteV2Spec.groovy", "diffHunk": "@@ -114,49 +117,13 @@ class AutoRerouteV2Spec extends HealthCheckSpecification {\n         cleanup: \"Restore topology to the original state, remove the flow\"\n         flowHelperV2.deleteFlow(flow.flowId)\n         portDown && !portUp && antiflap.portUp(isl.dstSwitch.dpId, isl.dstPort)\n-        broughtDownPorts.every { antiflap.portUp(it.switchId, it.portNo) }\n-        Wrappers.wait(discoveryInterval + WAIT_OFFSET) {\n+        broughtDownIsls.each { antiflap.portUp(it.srcSwitch.dpId, it.srcPort) }\n+        wait(discoveryInterval + WAIT_OFFSET) {\n             assert northbound.getActiveLinks().size() == topology.islsForActiveSwitches.size() * 2\n         }\n         database.resetCosts()\n     }\n \n-    @Tags([VIRTUAL, LOW_PRIORITY])", "originalCommit": "9a47837719c784b1b01ca3f5d22814da95596e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDczODc5OA==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444738798", "bodyText": "It is failed isl that cause the flow to reroute, so the test makes no sense. Moreover, it is misleading, since switch disconnect itself does not cause a flow reroute (for example flow will be absolutely fine if round-trip remain active)", "author": "rtretyak", "createdAt": "2020-06-24T08:43:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY5MTkxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY5NzA5Mg==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444697092", "bodyText": "I am afraid it can be unstable\nfor example:\n\nwe will have original reroute + 3 retries and move on to the next step\nin the next step(\"Flows are 'Down'\") we will get 'isl timeout'\nsystem will try to reroute the flow, flowStatus will be changed to IN_PROGRESS, but we expect that flowStatus is DOWN", "author": "andriidovhan", "createdAt": "2020-06-24T07:26:51Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteV2Spec.groovy", "diffHunk": "@@ -455,17 +421,9 @@ class AutoRerouteV2Spec extends HealthCheckSpecification {\n             assert !firstFlowHistory.find { it.taskId =~ /.+ : retry #1/ }\n             def secondFlowHistory = northbound.getFlowHistory(secondFlow.flowId).findAll { it.action == REROUTE_ACTION }\n             assert secondFlowHistory.findAll { it.taskId =~ /.+ : retry #2/ }.size() >= 1\n-            // reroute caused by failed ISL on backup path\n-            assert secondFlowHistory.findAll {\n-                it.details =~ /Reason: ISL (.*) become INACTIVE because of FAIL TIMEOUT (.*)/\n-            }.size() == 1\n-            /* NOTE: retry is available for a flow when switchUp event appears on a transit switch\n-            We can't check that 3 attempts of reroute are available in flow history, system can't guarantee it.\n-            Reason: during retrying ISL on backup path can fail -> new reroute event(e.g. REROUTE_FAIL_ISL)\n-            will be triggered and put in the queue of reroute -> for instance: in the queue we have 3rd attempt\n-            and REROUTE_FAIL_ISL -> these two reroutes will be merged based on some algorithm ->\n-            system execute one reroute only.\n-            (System doesn't merge reason of reroute, it just pick any reason from queue) */\n+            /*there should be original reroute + 3 retries. We are not checking the #3 retry directly, since it may\n+            have its reason changed to 'isl timeout' because ISL is about to fail due to a disconnected switch*/\n+            assert secondFlowHistory.size() == 4", "originalCommit": "9a47837719c784b1b01ca3f5d22814da95596e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDczMDU2OA==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444730568", "bodyText": "we wait until all non-rtl isls get failed before checking that flows are down. So isl timeout reroute will appear before that", "author": "rtretyak", "createdAt": "2020-06-24T08:28:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY5NzA5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMDUxNg==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444700516", "bodyText": "rtIsls -> nonRtIsls ?", "author": "andriidovhan", "createdAt": "2020-06-24T07:33:51Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteV2Spec.groovy", "diffHunk": "@@ -474,11 +432,20 @@ class AutoRerouteV2Spec extends HealthCheckSpecification {\n         }\n \n         and: \"Flows are 'Down'\"\n+        def rtIsls = topology.getRelatedIsls(switchPair1.src).findAll {", "originalCommit": "9a47837719c784b1b01ca3f5d22814da95596e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDczMDY5MQ==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444730691", "bodyText": "right", "author": "rtretyak", "createdAt": "2020-06-24T08:29:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMDUxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQxNTM1MQ==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r445415351", "bodyText": "it is not fixed", "author": "andriidovhan", "createdAt": "2020-06-25T09:06:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMDUxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQxOTMzNw==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r445419337", "bodyText": "yeah I know, haven't done the push yet. will reask the review when done", "author": "rtretyak", "createdAt": "2020-06-25T09:13:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMDUxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMDcwNg==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444700706", "bodyText": "why do we need to verify non rtIsls in this test? It is already tested in RoundTripIslSpec", "author": "andriidovhan", "createdAt": "2020-06-24T07:34:17Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteV2Spec.groovy", "diffHunk": "@@ -474,11 +432,20 @@ class AutoRerouteV2Spec extends HealthCheckSpecification {\n         }\n \n         and: \"Flows are 'Down'\"\n+        def rtIsls = topology.getRelatedIsls(switchPair1.src).findAll {\n+            !it.srcSwitch.features.contains(SwitchFeature.NOVIFLOW_COPY_FIELD) ||\n+                !it.dstSwitch.features.contains(SwitchFeature.NOVIFLOW_COPY_FIELD)\n+        }\n+        Wrappers.wait(discoveryTimeout) {\n+            def allLinks = northbound.getAllLinks()\n+            rtIsls.forEach { assert islUtils.getIslInfo(allLinks, it).get().state == FAILED }", "originalCommit": "9a47837719c784b1b01ca3f5d22814da95596e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDczMTM1MA==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444731350", "bodyText": "explained above. Required to wait for all non-rtl isls to get failed so that 'isl timeout' reason does not get in the way when verifying history", "author": "rtretyak", "createdAt": "2020-06-24T08:30:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMDcwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwNDIxMw==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444704213", "bodyText": "is it obsolete?", "author": "andriidovhan", "createdAt": "2020-06-24T07:41:22Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/switches/FlowRulesSpec.groovy", "diffHunk": "@@ -67,34 +66,6 @@ class FlowRulesSpec extends HealthCheckSpecification {\n         dstSwDefaultRules = northbound.getSwitchRules(dstSwitch.dpId).flowEntries\n     }\n \n-    @Tags([VIRTUAL, SMOKE])", "originalCommit": "9a47837719c784b1b01ca3f5d22814da95596e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDczNzI4OQ==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444737289", "bodyText": "already tested in other specs", "author": "rtretyak", "createdAt": "2020-06-24T08:40:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwNDIxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwOTMyMw==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444709323", "bodyText": "are you sure that you want to delete isl with force option ?", "author": "andriidovhan", "createdAt": "2020-06-24T07:51:10Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/switches/SwitchDeleteSpec.groovy", "diffHunk": "@@ -127,24 +125,18 @@ class SwitchDeleteSpec extends HealthCheckSpecification {\n         \"casual\"        | getFlowHelperV2().randomFlow(*getTopology().getActiveSwitches()[0..1])\n     }\n \n-    @Tags(VIRTUAL)\n+    @Tidy\n     def \"Able to delete an inactive switch without any ISLs\"() {\n         given: \"An inactive switch without any ISLs\"\n         def sw = topology.getActiveSwitches()[0]\n         def swIsls = topology.getRelatedIsls(sw)\n-\n-        // deactivate all active ISLs on switch\n+        // port down on all active ISLs on switch\n         swIsls.each { antiflap.portDown(sw.dpId, it.srcPort) }\n         TimeUnit.SECONDS.sleep(2) //receive any in-progress disco packets\n-        Wrappers.wait(WAIT_OFFSET) {\n-            swIsls.each { assert islUtils.getIslInfo(it).get().state == IslChangeType.FAILED }\n-        }\n-\n         // delete all ISLs on switch\n         swIsls.each {\n-            northbound.deleteLink(islUtils.toLinkParameters(it))\n+            northbound.deleteLink(islUtils.toLinkParameters(it), true)", "originalCommit": "9a47837719c784b1b01ca3f5d22814da95596e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDczOTg0NQ==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444739845", "bodyText": "no, will revisit this place", "author": "rtretyak", "createdAt": "2020-06-24T08:44:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwOTMyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ2NjE4Ng==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r445466186", "bodyText": "reverted the changes here as it was before", "author": "rtretyak", "createdAt": "2020-06-25T10:38:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwOTMyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcxMTY0Mw==", "url": "https://github.com/telstra/open-kilda/pull/3525#discussion_r444711643", "bodyText": "do we really need this verification?\non the one hand we know that switch was deleted on the other hand switch was deleted with the force option and switch is still connected to FL\nlet it be, I don't have strict opinion here", "author": "andriidovhan", "createdAt": "2020-06-24T07:55:20Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/switches/SwitchDeleteSpec.groovy", "diffHunk": "@@ -189,12 +178,13 @@ class SwitchDeleteSpec extends HealthCheckSpecification {\n             }\n         }\n \n-        and: \"Cleanup: restore the switch, ISLs and reset costs\"\n+        cleanup: \"Restore the switch, ISLs and reset costs\"\n         // restore switch\n         def blockData = lockKeeper.knockoutSwitch(sw, mgmtFlManager)\n-        lockKeeper.reviveSwitch(sw, blockData)\n-        Wrappers.wait(WAIT_OFFSET) { assert northbound.activeSwitches.any { it.switchId == sw.dpId } }\n-\n+        Wrappers.wait(WAIT_OFFSET) {\n+            mgmtFlManager.getFloodlightService(sw.getRegion()).getSwitches().every { it.switchId != sw.dpId }", "originalCommit": "9a47837719c784b1b01ca3f5d22814da95596e66", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cc1893883895dbdc7aa60a6fbf53ff6764633662", "url": "https://github.com/telstra/open-kilda/commit/cc1893883895dbdc7aa60a6fbf53ff6764633662", "message": "In functional tests where possible remove the VIRTUAL tag", "committedDate": "2020-06-25T10:38:09Z", "type": "forcePushed"}, {"oid": "1dff8094a90a7e0a6e3c8eaad5605967ead6d4d6", "url": "https://github.com/telstra/open-kilda/commit/1dff8094a90a7e0a6e3c8eaad5605967ead6d4d6", "message": "In functional tests where possible remove the VIRTUAL tag", "committedDate": "2020-07-01T09:53:53Z", "type": "forcePushed"}, {"oid": "7025be38908269b991c39395581de375bb165d09", "url": "https://github.com/telstra/open-kilda/commit/7025be38908269b991c39395581de375bb165d09", "message": "In functional tests where possible remove the VIRTUAL tag", "committedDate": "2020-07-01T10:24:30Z", "type": "commit"}, {"oid": "7025be38908269b991c39395581de375bb165d09", "url": "https://github.com/telstra/open-kilda/commit/7025be38908269b991c39395581de375bb165d09", "message": "In functional tests where possible remove the VIRTUAL tag", "committedDate": "2020-07-01T10:24:30Z", "type": "forcePushed"}]}