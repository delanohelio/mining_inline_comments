{"pr_number": 3895, "pr_title": "Zero Downtime Deployment Design", "pr_createdAt": "2020-12-01T20:29:56Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3895", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5ODkxMQ==", "url": "https://github.com/telstra/open-kilda/pull/3895#discussion_r533998911", "bodyText": "described", "author": "rtretyak", "createdAt": "2020-12-02T09:02:04Z", "path": "docs/design/zero-downtime/README.md", "diffHunk": "@@ -0,0 +1,62 @@\n+# Zero Downtime Upgrades for Open Kilda\n+\n+## Rationale\n+Current deployment process requires time slot with no reactions from contol plane for any network events as long\n+as no flow/switch ops are available as well. To improve this new deployment procedure is proposed.\n+It's details are descrivbed in this document.", "originalCommit": "553bbc5b1e4b072a8522a6046b66351fc9e53a25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAwMDI3Mg==", "url": "https://github.com/telstra/open-kilda/pull/3895#discussion_r534000272", "bodyText": "provides", "author": "rtretyak", "createdAt": "2020-12-02T09:04:08Z", "path": "docs/design/zero-downtime/README.md", "diffHunk": "@@ -0,0 +1,62 @@\n+# Zero Downtime Upgrades for Open Kilda\n+\n+## Rationale\n+Current deployment process requires time slot with no reactions from contol plane for any network events as long\n+as no flow/switch ops are available as well. To improve this new deployment procedure is proposed.\n+It's details are descrivbed in this document.\n+\n+## Solution\n+\n+Provide ability to deploy kilda in so called blue/green mode. Which will allow to quickly switch\n+system between different release versions. However, due to event-driven nature of kilda and a bunch of\n+limitations from Apache Storm there are changes made in original Blue/Green approach.\n+\n+### Shared Transport\n+\n+Kilda uses Kafka as a Message broker and messages in it to communicate between components of the system.\n+To provide backward compatibility between green and new versions of kilda within the same kafka topic\n+we need to split messages by some value between new and old ones. For this purpose will be used kafka message\n+header with run-id encoded in it. Run id should be unique within a single deployment.\n+Each component will emit messages with run-id header that is valid by the deployment. All receiver parts\n+should validate message header first and verify that run id matches with its configuration in that case component\n+will handle the message. Kafka provide API to write custom interceptors for both consumer and producer. This", "originalCommit": "553bbc5b1e4b072a8522a6046b66351fc9e53a25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAwMjU2MA==", "url": "https://github.com/telstra/open-kilda/pull/3895#discussion_r534002560", "bodyText": "hab->hub", "author": "rtretyak", "createdAt": "2020-12-02T09:07:39Z", "path": "docs/design/zero-downtime/README.md", "diffHunk": "@@ -0,0 +1,62 @@\n+# Zero Downtime Upgrades for Open Kilda\n+\n+## Rationale\n+Current deployment process requires time slot with no reactions from contol plane for any network events as long\n+as no flow/switch ops are available as well. To improve this new deployment procedure is proposed.\n+It's details are descrivbed in this document.\n+\n+## Solution\n+\n+Provide ability to deploy kilda in so called blue/green mode. Which will allow to quickly switch\n+system between different release versions. However, due to event-driven nature of kilda and a bunch of\n+limitations from Apache Storm there are changes made in original Blue/Green approach.\n+\n+### Shared Transport\n+\n+Kilda uses Kafka as a Message broker and messages in it to communicate between components of the system.\n+To provide backward compatibility between green and new versions of kilda within the same kafka topic\n+we need to split messages by some value between new and old ones. For this purpose will be used kafka message\n+header with run-id encoded in it. Run id should be unique within a single deployment.\n+Each component will emit messages with run-id header that is valid by the deployment. All receiver parts\n+should validate message header first and verify that run id matches with its configuration in that case component\n+will handle the message. Kafka provide API to write custom interceptors for both consumer and producer. This\n+interceptor will be responsible for verifying deployment id.\n+\n+### Zookeeper to store the state\n+\n+Since storm has limitations on lifecycle of its topologies, new mechanism is required to deal with topologies states. \n+Also it should be responsible to handle graceful shutdown procedure for topologies. For this role Apache Zookeeper\n+looks like a good fit.\n+\n+#### Node structure for Zookeeper\n+\n+`/kilda/{component_type}/{env_id}` - root for every component process, where:\n+`component_type` - topology or service name, e.g. `floodlight`, `network`, `nb_worker`\n+`env_id` - flag of blue or green env\n+\n+#### Signal, States and Build-Version\n+\n+Each component root node will have 3 children zNodes:\n+- signal - input field, can be `START` or `SHUTDOWN`, the way to make component start emittin processing new events\n+- state - int, number of active subcomponents of a component, when `SHUTDOWN` is emitted, should be `0`, positive otherwise.\n+- build-version - string field with run id, could be changed on fly, see #Shared transport for details\n+For the long running task such as hub in hab and spoke topologies, there should be a way to stop receiving new", "originalCommit": "553bbc5b1e4b072a8522a6046b66351fc9e53a25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAwMjg5MA==", "url": "https://github.com/telstra/open-kilda/pull/3895#discussion_r534002890", "bodyText": "floodlifghts >floodlights\neven are odd > even are green", "author": "rtretyak", "createdAt": "2020-12-02T09:08:08Z", "path": "docs/design/zero-downtime/README.md", "diffHunk": "@@ -0,0 +1,62 @@\n+# Zero Downtime Upgrades for Open Kilda\n+\n+## Rationale\n+Current deployment process requires time slot with no reactions from contol plane for any network events as long\n+as no flow/switch ops are available as well. To improve this new deployment procedure is proposed.\n+It's details are descrivbed in this document.\n+\n+## Solution\n+\n+Provide ability to deploy kilda in so called blue/green mode. Which will allow to quickly switch\n+system between different release versions. However, due to event-driven nature of kilda and a bunch of\n+limitations from Apache Storm there are changes made in original Blue/Green approach.\n+\n+### Shared Transport\n+\n+Kilda uses Kafka as a Message broker and messages in it to communicate between components of the system.\n+To provide backward compatibility between green and new versions of kilda within the same kafka topic\n+we need to split messages by some value between new and old ones. For this purpose will be used kafka message\n+header with run-id encoded in it. Run id should be unique within a single deployment.\n+Each component will emit messages with run-id header that is valid by the deployment. All receiver parts\n+should validate message header first and verify that run id matches with its configuration in that case component\n+will handle the message. Kafka provide API to write custom interceptors for both consumer and producer. This\n+interceptor will be responsible for verifying deployment id.\n+\n+### Zookeeper to store the state\n+\n+Since storm has limitations on lifecycle of its topologies, new mechanism is required to deal with topologies states. \n+Also it should be responsible to handle graceful shutdown procedure for topologies. For this role Apache Zookeeper\n+looks like a good fit.\n+\n+#### Node structure for Zookeeper\n+\n+`/kilda/{component_type}/{env_id}` - root for every component process, where:\n+`component_type` - topology or service name, e.g. `floodlight`, `network`, `nb_worker`\n+`env_id` - flag of blue or green env\n+\n+#### Signal, States and Build-Version\n+\n+Each component root node will have 3 children zNodes:\n+- signal - input field, can be `START` or `SHUTDOWN`, the way to make component start emittin processing new events\n+- state - int, number of active subcomponents of a component, when `SHUTDOWN` is emitted, should be `0`, positive otherwise.\n+- build-version - string field with run id, could be changed on fly, see #Shared transport for details\n+For the long running task such as hub in hab and spoke topologies, there should be a way to stop receiving new\n+requests, finishing up existing, and after that decrementing counter by 1 in a state field.\n+\n+#### Basic Deployment Scenario:\n+\n+Since floodlifghts could be destinguished by region let's assume, that all odd regions are blue and even are odd", "originalCommit": "553bbc5b1e4b072a8522a6046b66351fc9e53a25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAwMzUwNw==", "url": "https://github.com/telstra/open-kilda/pull/3895#discussion_r534003507", "bodyText": "should look like or should be like", "author": "rtretyak", "createdAt": "2020-12-02T09:09:08Z", "path": "docs/design/zero-downtime/README.md", "diffHunk": "@@ -0,0 +1,62 @@\n+# Zero Downtime Upgrades for Open Kilda\n+\n+## Rationale\n+Current deployment process requires time slot with no reactions from contol plane for any network events as long\n+as no flow/switch ops are available as well. To improve this new deployment procedure is proposed.\n+It's details are descrivbed in this document.\n+\n+## Solution\n+\n+Provide ability to deploy kilda in so called blue/green mode. Which will allow to quickly switch\n+system between different release versions. However, due to event-driven nature of kilda and a bunch of\n+limitations from Apache Storm there are changes made in original Blue/Green approach.\n+\n+### Shared Transport\n+\n+Kilda uses Kafka as a Message broker and messages in it to communicate between components of the system.\n+To provide backward compatibility between green and new versions of kilda within the same kafka topic\n+we need to split messages by some value between new and old ones. For this purpose will be used kafka message\n+header with run-id encoded in it. Run id should be unique within a single deployment.\n+Each component will emit messages with run-id header that is valid by the deployment. All receiver parts\n+should validate message header first and verify that run id matches with its configuration in that case component\n+will handle the message. Kafka provide API to write custom interceptors for both consumer and producer. This\n+interceptor will be responsible for verifying deployment id.\n+\n+### Zookeeper to store the state\n+\n+Since storm has limitations on lifecycle of its topologies, new mechanism is required to deal with topologies states. \n+Also it should be responsible to handle graceful shutdown procedure for topologies. For this role Apache Zookeeper\n+looks like a good fit.\n+\n+#### Node structure for Zookeeper\n+\n+`/kilda/{component_type}/{env_id}` - root for every component process, where:\n+`component_type` - topology or service name, e.g. `floodlight`, `network`, `nb_worker`\n+`env_id` - flag of blue or green env\n+\n+#### Signal, States and Build-Version\n+\n+Each component root node will have 3 children zNodes:\n+- signal - input field, can be `START` or `SHUTDOWN`, the way to make component start emittin processing new events\n+- state - int, number of active subcomponents of a component, when `SHUTDOWN` is emitted, should be `0`, positive otherwise.\n+- build-version - string field with run id, could be changed on fly, see #Shared transport for details\n+For the long running task such as hub in hab and spoke topologies, there should be a way to stop receiving new\n+requests, finishing up existing, and after that decrementing counter by 1 in a state field.\n+\n+#### Basic Deployment Scenario:\n+\n+Since floodlifghts could be destinguished by region let's assume, that all odd regions are blue and even are odd\n+Based on that deployment process should be look like:", "originalCommit": "553bbc5b1e4b072a8522a6046b66351fc9e53a25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxMDI2OQ==", "url": "https://github.com/telstra/open-kilda/pull/3895#discussion_r534010269", "bodyText": "worth mentioning that we should change their build-versions to match green floodlight before sending START signal", "author": "rtretyak", "createdAt": "2020-12-02T09:18:57Z", "path": "docs/design/zero-downtime/README.md", "diffHunk": "@@ -0,0 +1,62 @@\n+# Zero Downtime Upgrades for Open Kilda\n+\n+## Rationale\n+Current deployment process requires time slot with no reactions from contol plane for any network events as long\n+as no flow/switch ops are available as well. To improve this new deployment procedure is proposed.\n+It's details are descrivbed in this document.\n+\n+## Solution\n+\n+Provide ability to deploy kilda in so called blue/green mode. Which will allow to quickly switch\n+system between different release versions. However, due to event-driven nature of kilda and a bunch of\n+limitations from Apache Storm there are changes made in original Blue/Green approach.\n+\n+### Shared Transport\n+\n+Kilda uses Kafka as a Message broker and messages in it to communicate between components of the system.\n+To provide backward compatibility between green and new versions of kilda within the same kafka topic\n+we need to split messages by some value between new and old ones. For this purpose will be used kafka message\n+header with run-id encoded in it. Run id should be unique within a single deployment.\n+Each component will emit messages with run-id header that is valid by the deployment. All receiver parts\n+should validate message header first and verify that run id matches with its configuration in that case component\n+will handle the message. Kafka provide API to write custom interceptors for both consumer and producer. This\n+interceptor will be responsible for verifying deployment id.\n+\n+### Zookeeper to store the state\n+\n+Since storm has limitations on lifecycle of its topologies, new mechanism is required to deal with topologies states. \n+Also it should be responsible to handle graceful shutdown procedure for topologies. For this role Apache Zookeeper\n+looks like a good fit.\n+\n+#### Node structure for Zookeeper\n+\n+`/kilda/{component_type}/{env_id}` - root for every component process, where:\n+`component_type` - topology or service name, e.g. `floodlight`, `network`, `nb_worker`\n+`env_id` - flag of blue or green env\n+\n+#### Signal, States and Build-Version\n+\n+Each component root node will have 3 children zNodes:\n+- signal - input field, can be `START` or `SHUTDOWN`, the way to make component start emittin processing new events\n+- state - int, number of active subcomponents of a component, when `SHUTDOWN` is emitted, should be `0`, positive otherwise.\n+- build-version - string field with run id, could be changed on fly, see #Shared transport for details\n+For the long running task such as hub in hab and spoke topologies, there should be a way to stop receiving new\n+requests, finishing up existing, and after that decrementing counter by 1 in a state field.\n+\n+#### Basic Deployment Scenario:\n+\n+Since floodlifghts could be destinguished by region let's assume, that all odd regions are blue and even are odd\n+Based on that deployment process should be look like:\n+- Set `SHUTDOWN` signal for odd floodlights and change it's build-version for the new one\n+- Redeploy floodlight containers of green color\n+- Ensure that all green components has a signal `SHUTDOWN` and state of each has 0 active workers.\n+- Deploy all new topologies for green\n+- Emit `START` for green floodlight\n+- Emit `START` for `router`, `flow_hs`, `reroute`, `switch_manager`, `nb_worker` of green", "originalCommit": "553bbc5b1e4b072a8522a6046b66351fc9e53a25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxMzU2NQ==", "url": "https://github.com/telstra/open-kilda/pull/3895#discussion_r534013565", "bodyText": "it's -> their", "author": "rtretyak", "createdAt": "2020-12-02T09:23:47Z", "path": "docs/design/zero-downtime/README.md", "diffHunk": "@@ -0,0 +1,62 @@\n+# Zero Downtime Upgrades for Open Kilda\n+\n+## Rationale\n+Current deployment process requires time slot with no reactions from contol plane for any network events as long\n+as no flow/switch ops are available as well. To improve this new deployment procedure is proposed.\n+It's details are descrivbed in this document.\n+\n+## Solution\n+\n+Provide ability to deploy kilda in so called blue/green mode. Which will allow to quickly switch\n+system between different release versions. However, due to event-driven nature of kilda and a bunch of\n+limitations from Apache Storm there are changes made in original Blue/Green approach.\n+\n+### Shared Transport\n+\n+Kilda uses Kafka as a Message broker and messages in it to communicate between components of the system.\n+To provide backward compatibility between green and new versions of kilda within the same kafka topic\n+we need to split messages by some value between new and old ones. For this purpose will be used kafka message\n+header with run-id encoded in it. Run id should be unique within a single deployment.\n+Each component will emit messages with run-id header that is valid by the deployment. All receiver parts\n+should validate message header first and verify that run id matches with its configuration in that case component\n+will handle the message. Kafka provide API to write custom interceptors for both consumer and producer. This\n+interceptor will be responsible for verifying deployment id.\n+\n+### Zookeeper to store the state\n+\n+Since storm has limitations on lifecycle of its topologies, new mechanism is required to deal with topologies states. \n+Also it should be responsible to handle graceful shutdown procedure for topologies. For this role Apache Zookeeper\n+looks like a good fit.\n+\n+#### Node structure for Zookeeper\n+\n+`/kilda/{component_type}/{env_id}` - root for every component process, where:\n+`component_type` - topology or service name, e.g. `floodlight`, `network`, `nb_worker`\n+`env_id` - flag of blue or green env\n+\n+#### Signal, States and Build-Version\n+\n+Each component root node will have 3 children zNodes:\n+- signal - input field, can be `START` or `SHUTDOWN`, the way to make component start emittin processing new events\n+- state - int, number of active subcomponents of a component, when `SHUTDOWN` is emitted, should be `0`, positive otherwise.\n+- build-version - string field with run id, could be changed on fly, see #Shared transport for details\n+For the long running task such as hub in hab and spoke topologies, there should be a way to stop receiving new\n+requests, finishing up existing, and after that decrementing counter by 1 in a state field.\n+\n+#### Basic Deployment Scenario:\n+\n+Since floodlifghts could be destinguished by region let's assume, that all odd regions are blue and even are odd\n+Based on that deployment process should be look like:\n+- Set `SHUTDOWN` signal for odd floodlights and change it's build-version for the new one", "originalCommit": "553bbc5b1e4b072a8522a6046b66351fc9e53a25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNTA4Mw==", "url": "https://github.com/telstra/open-kilda/pull/3895#discussion_r534015083", "bodyText": "components have", "author": "rtretyak", "createdAt": "2020-12-02T09:25:47Z", "path": "docs/design/zero-downtime/README.md", "diffHunk": "@@ -0,0 +1,62 @@\n+# Zero Downtime Upgrades for Open Kilda\n+\n+## Rationale\n+Current deployment process requires time slot with no reactions from contol plane for any network events as long\n+as no flow/switch ops are available as well. To improve this new deployment procedure is proposed.\n+It's details are descrivbed in this document.\n+\n+## Solution\n+\n+Provide ability to deploy kilda in so called blue/green mode. Which will allow to quickly switch\n+system between different release versions. However, due to event-driven nature of kilda and a bunch of\n+limitations from Apache Storm there are changes made in original Blue/Green approach.\n+\n+### Shared Transport\n+\n+Kilda uses Kafka as a Message broker and messages in it to communicate between components of the system.\n+To provide backward compatibility between green and new versions of kilda within the same kafka topic\n+we need to split messages by some value between new and old ones. For this purpose will be used kafka message\n+header with run-id encoded in it. Run id should be unique within a single deployment.\n+Each component will emit messages with run-id header that is valid by the deployment. All receiver parts\n+should validate message header first and verify that run id matches with its configuration in that case component\n+will handle the message. Kafka provide API to write custom interceptors for both consumer and producer. This\n+interceptor will be responsible for verifying deployment id.\n+\n+### Zookeeper to store the state\n+\n+Since storm has limitations on lifecycle of its topologies, new mechanism is required to deal with topologies states. \n+Also it should be responsible to handle graceful shutdown procedure for topologies. For this role Apache Zookeeper\n+looks like a good fit.\n+\n+#### Node structure for Zookeeper\n+\n+`/kilda/{component_type}/{env_id}` - root for every component process, where:\n+`component_type` - topology or service name, e.g. `floodlight`, `network`, `nb_worker`\n+`env_id` - flag of blue or green env\n+\n+#### Signal, States and Build-Version\n+\n+Each component root node will have 3 children zNodes:\n+- signal - input field, can be `START` or `SHUTDOWN`, the way to make component start emittin processing new events\n+- state - int, number of active subcomponents of a component, when `SHUTDOWN` is emitted, should be `0`, positive otherwise.\n+- build-version - string field with run id, could be changed on fly, see #Shared transport for details\n+For the long running task such as hub in hab and spoke topologies, there should be a way to stop receiving new\n+requests, finishing up existing, and after that decrementing counter by 1 in a state field.\n+\n+#### Basic Deployment Scenario:\n+\n+Since floodlifghts could be destinguished by region let's assume, that all odd regions are blue and even are odd\n+Based on that deployment process should be look like:\n+- Set `SHUTDOWN` signal for odd floodlights and change it's build-version for the new one\n+- Redeploy floodlight containers of green color\n+- Ensure that all green components has a signal `SHUTDOWN` and state of each has 0 active workers.", "originalCommit": "553bbc5b1e4b072a8522a6046b66351fc9e53a25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxOTk0Nw==", "url": "https://github.com/telstra/open-kilda/pull/3895#discussion_r534019947", "bodyText": "is it only 'network' topology that can conflict between blue/green versions? Is there any event that we can receive pass the network topology?", "author": "rtretyak", "createdAt": "2020-12-02T09:32:45Z", "path": "docs/design/zero-downtime/README.md", "diffHunk": "@@ -0,0 +1,62 @@\n+# Zero Downtime Upgrades for Open Kilda\n+\n+## Rationale\n+Current deployment process requires time slot with no reactions from contol plane for any network events as long\n+as no flow/switch ops are available as well. To improve this new deployment procedure is proposed.\n+It's details are descrivbed in this document.\n+\n+## Solution\n+\n+Provide ability to deploy kilda in so called blue/green mode. Which will allow to quickly switch\n+system between different release versions. However, due to event-driven nature of kilda and a bunch of\n+limitations from Apache Storm there are changes made in original Blue/Green approach.\n+\n+### Shared Transport\n+\n+Kilda uses Kafka as a Message broker and messages in it to communicate between components of the system.\n+To provide backward compatibility between green and new versions of kilda within the same kafka topic\n+we need to split messages by some value between new and old ones. For this purpose will be used kafka message\n+header with run-id encoded in it. Run id should be unique within a single deployment.\n+Each component will emit messages with run-id header that is valid by the deployment. All receiver parts\n+should validate message header first and verify that run id matches with its configuration in that case component\n+will handle the message. Kafka provide API to write custom interceptors for both consumer and producer. This\n+interceptor will be responsible for verifying deployment id.\n+\n+### Zookeeper to store the state\n+\n+Since storm has limitations on lifecycle of its topologies, new mechanism is required to deal with topologies states. \n+Also it should be responsible to handle graceful shutdown procedure for topologies. For this role Apache Zookeeper\n+looks like a good fit.\n+\n+#### Node structure for Zookeeper\n+\n+`/kilda/{component_type}/{env_id}` - root for every component process, where:\n+`component_type` - topology or service name, e.g. `floodlight`, `network`, `nb_worker`\n+`env_id` - flag of blue or green env\n+\n+#### Signal, States and Build-Version\n+\n+Each component root node will have 3 children zNodes:\n+- signal - input field, can be `START` or `SHUTDOWN`, the way to make component start emittin processing new events\n+- state - int, number of active subcomponents of a component, when `SHUTDOWN` is emitted, should be `0`, positive otherwise.\n+- build-version - string field with run id, could be changed on fly, see #Shared transport for details\n+For the long running task such as hub in hab and spoke topologies, there should be a way to stop receiving new\n+requests, finishing up existing, and after that decrementing counter by 1 in a state field.\n+\n+#### Basic Deployment Scenario:\n+\n+Since floodlifghts could be destinguished by region let's assume, that all odd regions are blue and even are odd\n+Based on that deployment process should be look like:\n+- Set `SHUTDOWN` signal for odd floodlights and change it's build-version for the new one\n+- Redeploy floodlight containers of green color\n+- Ensure that all green components has a signal `SHUTDOWN` and state of each has 0 active workers.\n+- Deploy all new topologies for green\n+- Emit `START` for green floodlight\n+- Emit `START` for `router`, `flow_hs`, `reroute`, `switch_manager`, `nb_worker` of green\n+- Verify state is changed, and each has positive number value\n+- Emit `SHUTDOWN` for the network blue\n+- Emit `START` for the network green\n+- Emit `SHUTDOWN` for `router`, `flow_hs`, `reroute`, `switch_manager`, `nb_worker` of blue", "originalCommit": "553bbc5b1e4b072a8522a6046b66351fc9e53a25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk4MjkyMQ==", "url": "https://github.com/telstra/open-kilda/pull/3895#discussion_r534982921", "bodyText": "network uses db data both, so there could be race conditions", "author": "timofei-durakov", "createdAt": "2020-12-03T09:11:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxOTk0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA4MzUwOQ==", "url": "https://github.com/telstra/open-kilda/pull/3895#discussion_r534083509", "bodyText": "Since both 'routers' and both floodlights are UP theoretically a switch can be marked as 'active' in both green and blue floodlights (in both regions). Is that correct? In this case we may process certain event twice", "author": "rtretyak", "createdAt": "2020-12-02T11:08:11Z", "path": "docs/design/zero-downtime/README.md", "diffHunk": "@@ -0,0 +1,62 @@\n+# Zero Downtime Upgrades for Open Kilda\n+\n+## Rationale\n+Current deployment process requires time slot with no reactions from contol plane for any network events as long\n+as no flow/switch ops are available as well. To improve this new deployment procedure is proposed.\n+It's details are descrivbed in this document.\n+\n+## Solution\n+\n+Provide ability to deploy kilda in so called blue/green mode. Which will allow to quickly switch\n+system between different release versions. However, due to event-driven nature of kilda and a bunch of\n+limitations from Apache Storm there are changes made in original Blue/Green approach.\n+\n+### Shared Transport\n+\n+Kilda uses Kafka as a Message broker and messages in it to communicate between components of the system.\n+To provide backward compatibility between green and new versions of kilda within the same kafka topic\n+we need to split messages by some value between new and old ones. For this purpose will be used kafka message\n+header with run-id encoded in it. Run id should be unique within a single deployment.\n+Each component will emit messages with run-id header that is valid by the deployment. All receiver parts\n+should validate message header first and verify that run id matches with its configuration in that case component\n+will handle the message. Kafka provide API to write custom interceptors for both consumer and producer. This\n+interceptor will be responsible for verifying deployment id.\n+\n+### Zookeeper to store the state\n+\n+Since storm has limitations on lifecycle of its topologies, new mechanism is required to deal with topologies states. \n+Also it should be responsible to handle graceful shutdown procedure for topologies. For this role Apache Zookeeper\n+looks like a good fit.\n+\n+#### Node structure for Zookeeper\n+\n+`/kilda/{component_type}/{env_id}` - root for every component process, where:\n+`component_type` - topology or service name, e.g. `floodlight`, `network`, `nb_worker`\n+`env_id` - flag of blue or green env\n+\n+#### Signal, States and Build-Version\n+\n+Each component root node will have 3 children zNodes:\n+- signal - input field, can be `START` or `SHUTDOWN`, the way to make component start emittin processing new events\n+- state - int, number of active subcomponents of a component, when `SHUTDOWN` is emitted, should be `0`, positive otherwise.\n+- build-version - string field with run id, could be changed on fly, see #Shared transport for details\n+For the long running task such as hub in hab and spoke topologies, there should be a way to stop receiving new\n+requests, finishing up existing, and after that decrementing counter by 1 in a state field.\n+\n+#### Basic Deployment Scenario:\n+\n+Since floodlifghts could be destinguished by region let's assume, that all odd regions are blue and even are odd\n+Based on that deployment process should be look like:\n+- Set `SHUTDOWN` signal for odd floodlights and change it's build-version for the new one\n+- Redeploy floodlight containers of green color\n+- Ensure that all green components has a signal `SHUTDOWN` and state of each has 0 active workers.\n+- Deploy all new topologies for green\n+- Emit `START` for green floodlight\n+- Emit `START` for `router`, `flow_hs`, `reroute`, `switch_manager`, `nb_worker` of green\n+- Verify state is changed, and each has positive number value\n+- Emit `SHUTDOWN` for the network blue\n+- Emit `START` for the network green\n+- Emit `SHUTDOWN` for `router`, `flow_hs`, `reroute`, `switch_manager`, `nb_worker` of blue", "originalCommit": "553bbc5b1e4b072a8522a6046b66351fc9e53a25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk4NDIxOA==", "url": "https://github.com/telstra/open-kilda/pull/3895#discussion_r534984218", "bodyText": "the only way we handle event twice is a network both blue/grean are enabled", "author": "timofei-durakov", "createdAt": "2020-12-03T09:13:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA4MzUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA4NTM0MA==", "url": "https://github.com/telstra/open-kilda/pull/3895#discussion_r534085340", "bodyText": "Please add a note that it is required for switch to be connected to at least 2 regions/equal controllers for this scenario", "author": "rtretyak", "createdAt": "2020-12-02T11:11:07Z", "path": "docs/design/zero-downtime/README.md", "diffHunk": "@@ -0,0 +1,62 @@\n+# Zero Downtime Upgrades for Open Kilda\n+\n+## Rationale\n+Current deployment process requires time slot with no reactions from contol plane for any network events as long\n+as no flow/switch ops are available as well. To improve this new deployment procedure is proposed.\n+It's details are descrivbed in this document.\n+\n+## Solution\n+\n+Provide ability to deploy kilda in so called blue/green mode. Which will allow to quickly switch\n+system between different release versions. However, due to event-driven nature of kilda and a bunch of\n+limitations from Apache Storm there are changes made in original Blue/Green approach.\n+\n+### Shared Transport\n+\n+Kilda uses Kafka as a Message broker and messages in it to communicate between components of the system.\n+To provide backward compatibility between green and new versions of kilda within the same kafka topic\n+we need to split messages by some value between new and old ones. For this purpose will be used kafka message\n+header with run-id encoded in it. Run id should be unique within a single deployment.\n+Each component will emit messages with run-id header that is valid by the deployment. All receiver parts\n+should validate message header first and verify that run id matches with its configuration in that case component\n+will handle the message. Kafka provide API to write custom interceptors for both consumer and producer. This\n+interceptor will be responsible for verifying deployment id.\n+\n+### Zookeeper to store the state\n+\n+Since storm has limitations on lifecycle of its topologies, new mechanism is required to deal with topologies states. \n+Also it should be responsible to handle graceful shutdown procedure for topologies. For this role Apache Zookeeper\n+looks like a good fit.\n+\n+#### Node structure for Zookeeper\n+\n+`/kilda/{component_type}/{env_id}` - root for every component process, where:\n+`component_type` - topology or service name, e.g. `floodlight`, `network`, `nb_worker`\n+`env_id` - flag of blue or green env\n+\n+#### Signal, States and Build-Version\n+\n+Each component root node will have 3 children zNodes:\n+- signal - input field, can be `START` or `SHUTDOWN`, the way to make component start emittin processing new events\n+- state - int, number of active subcomponents of a component, when `SHUTDOWN` is emitted, should be `0`, positive otherwise.\n+- build-version - string field with run id, could be changed on fly, see #Shared transport for details\n+For the long running task such as hub in hab and spoke topologies, there should be a way to stop receiving new\n+requests, finishing up existing, and after that decrementing counter by 1 in a state field.\n+\n+#### Basic Deployment Scenario:", "originalCommit": "553bbc5b1e4b072a8522a6046b66351fc9e53a25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9bcc510b03bb23ca1ad6466db222bf83eca7c99b", "url": "https://github.com/telstra/open-kilda/commit/9bcc510b03bb23ca1ad6466db222bf83eca7c99b", "message": "Zero Downtime Deployment Design", "committedDate": "2020-12-03T09:18:24Z", "type": "forcePushed"}, {"oid": "ace96b3057255a2cb7af3ae11620593bdee69394", "url": "https://github.com/telstra/open-kilda/commit/ace96b3057255a2cb7af3ae11620593bdee69394", "message": "Zero Downtime Deployment Design", "committedDate": "2020-12-29T08:50:54Z", "type": "forcePushed"}, {"oid": "dbfa24f5f305d3fa7124b7ede971e5de8deba87b", "url": "https://github.com/telstra/open-kilda/commit/dbfa24f5f305d3fa7124b7ede971e5de8deba87b", "message": "Zero Downtime Deployment Design", "committedDate": "2020-12-29T08:51:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYyNTQzMg==", "url": "https://github.com/telstra/open-kilda/pull/3895#discussion_r549625432", "bodyText": "each except northbound and GRPC. Maybe we should mention it", "author": "niksv", "createdAt": "2020-12-29T09:03:38Z", "path": "docs/design/zero-downtime/README.md", "diffHunk": "@@ -0,0 +1,92 @@\n+# Zero Downtime Upgrades for Open Kilda\n+\n+## Rationale\n+Current deployment process requires time slot with no reactions from contol plane for any network events as long\n+as no flow/switch ops are available as well. To improve this new deployment procedure is proposed.\n+It's details are described in this document.\n+\n+## Solution\n+\n+Provide ability to deploy kilda in so called blue/green mode. Which will allow to quickly switch\n+system between different release versions. However, due to event-driven nature of kilda and a bunch of\n+limitations from Apache Storm there are changes made in original Blue/Green approach.\n+\n+### Shared Transport\n+\n+Kilda uses Kafka as a Message broker and messages in it to communicate between components of the system.\n+To provide backward compatibility between green and new versions of kilda within the same kafka topic\n+we need to split messages by some value between new and old ones. For this purpose will be used kafka message\n+header with run-id encoded in it. Run id should be unique within a single deployment.\n+Each component will emit messages with run-id header that is valid by the deployment. All receiver parts\n+should validate message header first and verify that run id matches with its configuration in that case component\n+will handle the message. Kafka provides API to write custom interceptors for both consumer and producer. This\n+interceptor will be responsible for verifying deployment id.\n+\n+### Zookeeper to store the state\n+\n+Since storm has limitations on lifecycle of its topologies, new mechanism is required to deal with topologies states. \n+Also it should be responsible to handle graceful shutdown procedure for topologies. For this role Apache Zookeeper\n+looks like a good fit.\n+\n+#### Node structure for Zookeeper\n+\n+`/kilda/{component_type}/{env_id}` - root for every component process, where:\n+`component_type` - topology or service name, e.g. `floodlight`, `network`, `nb_worker`\n+`env_id` - flag of blue or green env\n+\n+#### Signal, States and Build-Version\n+\n+Each component root node will have 3 children zNodes:", "originalCommit": "dbfa24f5f305d3fa7124b7ede971e5de8deba87b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYyNjY5Ng==", "url": "https://github.com/telstra/open-kilda/pull/3895#discussion_r549626696", "bodyText": "why here? why not with northbound? We have stats requests from stats topology to GRPC service. at this point stats topology is blue and GRPC is green so they can't communicate", "author": "niksv", "createdAt": "2020-12-29T09:07:18Z", "path": "docs/design/zero-downtime/README.md", "diffHunk": "@@ -0,0 +1,92 @@\n+# Zero Downtime Upgrades for Open Kilda\n+\n+## Rationale\n+Current deployment process requires time slot with no reactions from contol plane for any network events as long\n+as no flow/switch ops are available as well. To improve this new deployment procedure is proposed.\n+It's details are described in this document.\n+\n+## Solution\n+\n+Provide ability to deploy kilda in so called blue/green mode. Which will allow to quickly switch\n+system between different release versions. However, due to event-driven nature of kilda and a bunch of\n+limitations from Apache Storm there are changes made in original Blue/Green approach.\n+\n+### Shared Transport\n+\n+Kilda uses Kafka as a Message broker and messages in it to communicate between components of the system.\n+To provide backward compatibility between green and new versions of kilda within the same kafka topic\n+we need to split messages by some value between new and old ones. For this purpose will be used kafka message\n+header with run-id encoded in it. Run id should be unique within a single deployment.\n+Each component will emit messages with run-id header that is valid by the deployment. All receiver parts\n+should validate message header first and verify that run id matches with its configuration in that case component\n+will handle the message. Kafka provides API to write custom interceptors for both consumer and producer. This\n+interceptor will be responsible for verifying deployment id.\n+\n+### Zookeeper to store the state\n+\n+Since storm has limitations on lifecycle of its topologies, new mechanism is required to deal with topologies states. \n+Also it should be responsible to handle graceful shutdown procedure for topologies. For this role Apache Zookeeper\n+looks like a good fit.\n+\n+#### Node structure for Zookeeper\n+\n+`/kilda/{component_type}/{env_id}` - root for every component process, where:\n+`component_type` - topology or service name, e.g. `floodlight`, `network`, `nb_worker`\n+`env_id` - flag of blue or green env\n+\n+#### Signal, States and Build-Version\n+\n+Each component root node will have 3 children zNodes:\n+- signal - input field, can be `START` or `SHUTDOWN`, the way to make component start emittin processing new events\n+- state - int, number of active subcomponents of a component, when `SHUTDOWN` is emitted, should be `0`, positive otherwise.\n+- build-version - string field with run id, could be changed on fly, see #Shared transport for details\n+For the long running task such as hub in hub and spoke topologies, there should be a way to stop receiving new\n+requests, finishing up existing, and after that decrementing counter by 1 in a state field.\n+\n+#### Basic Deployment Scenario:\n+\n+*Note*\n+For this upgrade procedure each switch should be connected to 2 floodlights simultaneously.\n+ \n+Since floodlights could be distinguished by region let's assume, that all odd regions are green and even are blue\n+For the scenario, below suppose that `blue` is a current env and `green` is the one to be deployed.\n+Based on that the process should look like:\n+\n+- Ensure that `signal` for the `green` components is set to `SHUTDOWN` and the `build-version` is updated  \n+- Deploy green topologies  \n+- Set `SHUTDOWN` signal for `green` floodlights \n+- Redeploy floodlight containers of `green` color\n+- Redeploy grpc containers of `green` color", "originalCommit": "dbfa24f5f305d3fa7124b7ede971e5de8deba87b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8148d7411d7b600ea79b1fe192a059ea8dc22688", "url": "https://github.com/telstra/open-kilda/commit/8148d7411d7b600ea79b1fe192a059ea8dc22688", "message": "Zero Downtime Deployment Design", "committedDate": "2020-12-31T09:12:12Z", "type": "commit"}, {"oid": "8148d7411d7b600ea79b1fe192a059ea8dc22688", "url": "https://github.com/telstra/open-kilda/commit/8148d7411d7b600ea79b1fe192a059ea8dc22688", "message": "Zero Downtime Deployment Design", "committedDate": "2020-12-31T09:12:12Z", "type": "forcePushed"}]}