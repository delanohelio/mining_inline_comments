{"pr_number": 3851, "pr_title": "[Server42] Software timestamps", "pr_createdAt": "2020-11-13T14:14:09Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3851", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk3ODc2Mg==", "url": "https://github.com/telstra/open-kilda/pull/3851#discussion_r522978762", "bodyText": "Bit OR i.e. | should be cheaper than int64 sum.", "author": "surabujin", "createdAt": "2020-11-13T14:20:03Z", "path": "src-cpp/server42/src/Workers.cpp", "diffHunk": "@@ -33,6 +34,16 @@ using namespace std::literals::chrono_literals;\n \n namespace org::openkilda {\n \n+    uint64_t get_current_timestamp() {\n+        auto now = std::chrono::time_point_cast<std::chrono::nanoseconds>(\n+                std::chrono::high_resolution_clock::now());\n+        auto duration = now.time_since_epoch();\n+        uint64_t seconds = std::chrono::duration_cast<std::chrono::seconds>(duration).count();\n+        uint64_t nanoseconds = std::chrono::duration_cast<std::chrono::nanoseconds>(duration - std::chrono::seconds(seconds)).count();\n+        uint64_t timestamp = (seconds << 32ul) + (nanoseconds & 0xFFFFFFFF);", "originalCommit": "f10d7c9d7b22afd0bc4407aa45923277299bf06c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk4NTQ0MQ==", "url": "https://github.com/telstra/open-kilda/pull/3851#discussion_r522985441", "bodyText": "do not try to be smarter than GCC. =)", "author": "nikitamarchenko", "createdAt": "2020-11-13T14:30:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk3ODc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk4MDM3Nw==", "url": "https://github.com/telstra/open-kilda/pull/3851#discussion_r522980377", "bodyText": "htobe64 can/shoult be done outside this(all) loop.", "author": "surabujin", "createdAt": "2020-11-13T14:22:28Z", "path": "src-cpp/server42/src/Workers.cpp", "diffHunk": "@@ -64,8 +77,13 @@ namespace org::openkilda {\n                             mbuf_send_buffer[i].initFromRawPacket(*(pos+i), device);\n                             mbuf_send_buffer_p[i] = &mbuf_send_buffer[i];\n                             mbuf_send_buffer_p[i]->setFreeMbuf(true);\n-                        }\n \n+                            //TODO: can be switched to raw memory arithmetics\n+                            pcpp::Packet parsed_packet(mbuf_send_buffer_p[i], false, pcpp::UDP);\n+                            auto *udp_layer = parsed_packet.getLayerOfType<pcpp::UdpLayer>();\n+                            auto *payload = reinterpret_cast<org::openkilda::Payload *>(udp_layer->getLayerPayload());\n+                            payload->t0 = htobe64(timestamp);", "originalCommit": "f10d7c9d7b22afd0bc4407aa45923277299bf06c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk4NDY3OQ==", "url": "https://github.com/telstra/open-kilda/pull/3851#discussion_r522984679", "bodyText": "done", "author": "nikitamarchenko", "createdAt": "2020-11-13T14:29:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk4MDM3Nw=="}], "type": "inlineReview"}, {"oid": "666b481416c0d9d02671df56d00cff7a81738f4c", "url": "https://github.com/telstra/open-kilda/commit/666b481416c0d9d02671df56d00cff7a81738f4c", "message": "[Server42] Software timestamps", "committedDate": "2020-11-13T14:31:03Z", "type": "commit"}, {"oid": "666b481416c0d9d02671df56d00cff7a81738f4c", "url": "https://github.com/telstra/open-kilda/commit/666b481416c0d9d02671df56d00cff7a81738f4c", "message": "[Server42] Software timestamps", "committedDate": "2020-11-13T14:31:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk4NDY0OA==", "url": "https://github.com/telstra/open-kilda/pull/3851#discussion_r522984648", "bodyText": "Maybe it would be better to give some name to magic number 3 here?", "author": "rozdy", "createdAt": "2020-11-13T14:29:20Z", "path": "src-cpp/server42/src/Workers.cpp", "diffHunk": "@@ -298,29 +333,44 @@ namespace org::openkilda {\n \n                 auto *payload = reinterpret_cast<org::openkilda::Payload *>(udp_layer->getLayerPayload());\n \n-                auto now = std::chrono::time_point_cast<std::chrono::nanoseconds>(\n-                        std::chrono::high_resolution_clock::now());\n-\n-                auto duration = now.time_since_epoch();\n-                uint64_t seconds = std::chrono::duration_cast<std::chrono::seconds>(duration).count();\n-                uint64_t nanoseconds = std::chrono::duration_cast<std::chrono::nanoseconds>(duration).count();\n-\n                 std::string flow_id(payload->flow_id);\n \n                 if (!fake_duration.count(flow_id)) {\n-                    fake_duration[flow_id] = base_latency(rd);\n+                    fake_duration[flow_id] = base_latency(rd) * cycles_in_1_ms;\n                 }\n \n-                uint64_t timestamp = (seconds << 32ul) + (nanoseconds & 0xFFFFFFFF);\n+                std::shared_ptr<pcpp::MBufRawPacket> mbuf_raw_ptr(new pcpp::MBufRawPacket());\n+\n+                mbuf_raw_ptr->initFromRawPacket(rx_mbuf[i], device);\n+\n+                uint64_t latency_time = fake_duration[flow_id];\n+                const uint64_t delta_based_direction = 3 * cycles_in_1_ms;", "originalCommit": "f10d7c9d7b22afd0bc4407aa45923277299bf06c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk5MjE4Mw==", "url": "https://github.com/telstra/open-kilda/pull/3851#discussion_r522992183", "bodyText": "Latency delta is based on the direction set to 3ms. Three because it gives a good view in opentsdb.", "author": "nikitamarchenko", "createdAt": "2020-11-13T14:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk4NDY0OA=="}], "type": "inlineReview"}]}