{"pr_number": 3844, "pr_title": "Added ability to run Kilda in blue and green modes locally", "pr_createdAt": "2020-11-10T16:54:01Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3844", "timeline": [{"oid": "f3604dc58efe2cf60fcc41d5a6f7a88dbec1f654", "url": "https://github.com/telstra/open-kilda/commit/f3604dc58efe2cf60fcc41d5a6f7a88dbec1f654", "message": "Added blue green modes for wfm", "committedDate": "2020-11-11T07:10:56Z", "type": "forcePushed"}, {"oid": "da6c7df6a725c7228c6a4afed9eec64401b3e60d", "url": "https://github.com/telstra/open-kilda/commit/da6c7df6a725c7228c6a4afed9eec64401b3e60d", "message": "Added kafka consumer group id prefix. This fix allows two northbounds read the same topic simultaneously.", "committedDate": "2020-11-27T12:22:36Z", "type": "forcePushed"}, {"oid": "15f0dc26bebaf3864d4bf9c68f8dadffe6e1cf0c", "url": "https://github.com/telstra/open-kilda/commit/15f0dc26bebaf3864d4bf9c68f8dadffe6e1cf0c", "message": "Added kafka consumer group id prefix. This fix allows two northbounds read the same topic simultaneously.", "committedDate": "2020-11-27T13:39:01Z", "type": "forcePushed"}, {"oid": "5102e41404663bd1312e73f5b4a8cc4e16d71696", "url": "https://github.com/telstra/open-kilda/commit/5102e41404663bd1312e73f5b4a8cc4e16d71696", "message": "Added kafka consumer group id prefix. This fix allows two northbounds read the same topic simultaneously.", "committedDate": "2020-12-07T09:53:06Z", "type": "forcePushed"}, {"oid": "336b7a42b4182031937676ee09481c6bc47b318f", "url": "https://github.com/telstra/open-kilda/commit/336b7a42b4182031937676ee09481c6bc47b318f", "message": "Added kafka consumer group id prefix. This fix allows two northbounds read the same topic simultaneously.", "committedDate": "2020-12-07T09:56:38Z", "type": "forcePushed"}, {"oid": "c2d27e096c1efcb95bc439cfb05dd97f6d06773e", "url": "https://github.com/telstra/open-kilda/commit/c2d27e096c1efcb95bc439cfb05dd97f6d06773e", "message": "Use 1 config insteam of 3", "committedDate": "2020-12-10T15:17:24Z", "type": "forcePushed"}, {"oid": "9bd2e8e7cc4010bea043dc87be4424553a764eb9", "url": "https://github.com/telstra/open-kilda/commit/9bd2e8e7cc4010bea043dc87be4424553a764eb9", "message": "Use 1 config insteam of 3", "committedDate": "2020-12-11T06:14:21Z", "type": "forcePushed"}, {"oid": "a67ae4a853e1b151c746a5a974d292cf62c019f6", "url": "https://github.com/telstra/open-kilda/commit/a67ae4a853e1b151c746a5a974d292cf62c019f6", "message": "Use 1 config insteam of 3", "committedDate": "2020-12-11T06:14:54Z", "type": "forcePushed"}, {"oid": "204bc295b118be5c6f01c69aa83b8315df944718", "url": "https://github.com/telstra/open-kilda/commit/204bc295b118be5c6f01c69aa83b8315df944718", "message": "Added kafka consumer group id prefix. This fix allows two northbounds read the same topic simultaneously.", "committedDate": "2020-12-11T12:05:17Z", "type": "forcePushed"}, {"oid": "ed3d083f85d789bf6c9bd202cc138072f7111737", "url": "https://github.com/telstra/open-kilda/commit/ed3d083f85d789bf6c9bd202cc138072f7111737", "message": "Use 1 config insteam of 3", "committedDate": "2020-12-11T12:36:27Z", "type": "forcePushed"}, {"oid": "e76c7d36a1f9d5b0ec52c754a1777abf8c9a8d3a", "url": "https://github.com/telstra/open-kilda/commit/e76c7d36a1f9d5b0ec52c754a1777abf8c9a8d3a", "message": "0-Downtime: Local blue-green deployment", "committedDate": "2020-12-11T12:38:40Z", "type": "forcePushed"}, {"oid": "e26f8a9e9fec5fb78e3d039dc117d386a19269f2", "url": "https://github.com/telstra/open-kilda/commit/e26f8a9e9fec5fb78e3d039dc117d386a19269f2", "message": "0-Downtime: Local blue-green deployment", "committedDate": "2020-12-11T13:56:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk3NTMzNg==", "url": "https://github.com/telstra/open-kilda/pull/3844#discussion_r540975336", "bodyText": "--scale northbound-blue-green=0 {{if not (exists \"/no_grpc_speaker\")}}--scale grpc-speaker-blue-green=0{{end}}\n\nThis is not needed here.", "author": "dpoltavets", "createdAt": "2020-12-11T14:13:48Z", "path": "confd/templates/makefile/makefile.tmpl", "diffHunk": "@@ -44,7 +48,25 @@ up-test-mode:\n \t@echo ~~\n \t@echo\n \tcp -n .env.example .env\n-\tdocker-compose up -d\n+\tdocker-compose up -d --scale northbound-blue-green=0 {{if not (exists \"/no_grpc_speaker\")}}--scale grpc-speaker-blue-green=0{{end}}\n+\tdocker-compose logs -f wfm\n+\t$(MAKE) -C tools/elk-dashboards\n+\n+up-test-mode-stable:\n+\tcp -n .env.example .env\n+\tTAG=$(STABLE_TAG) WFM_TOPOLOGIES_MODE=blue docker-compose up -d --scale northbound-blue-green=0 {{if not (exists \"/no_grpc_speaker\")}}--scale grpc-speaker-blue-green=0{{end}}\n+\tdocker-compose logs -f wfm\n+\t$(MAKE) -C tools/elk-dashboards\n+\n+up-test-mode-green:\n+\tcp -n .env.example .env\n+\tWFM_TOPOLOGIES_MODE=green docker-compose up -d floodlight_2 northbound-blue-green wfm {{if not (exists \"/no_grpc_speaker\")}}grpc-speaker-blue-green{{end}}\n+\tdocker-compose logs -f wfm\n+\t$(MAKE) -C tools/elk-dashboards\n+\n+up-test-mode-blue:\n+\tcp -n .env.example .env\n+\tTAG=$(STABLE_TAG) WFM_TOPOLOGIES_MODE=blue  docker-compose up -d floodlight_1 wfm --scale northbound-blue-green=0 {{if not (exists \"/no_grpc_speaker\")}}--scale grpc-speaker-blue-green=0{{end}}", "originalCommit": "e26f8a9e9fec5fb78e3d039dc117d386a19269f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f8e38a7d339aa6bb59488757648bbc40370ffba2", "url": "https://github.com/telstra/open-kilda/commit/f8e38a7d339aa6bb59488757648bbc40370ffba2", "message": "0-Downtime: Local blue-green deployment", "committedDate": "2020-12-15T13:02:09Z", "type": "forcePushed"}, {"oid": "46f15e0d117fa6f57b26284e3fca92479b439c4f", "url": "https://github.com/telstra/open-kilda/commit/46f15e0d117fa6f57b26284e3fca92479b439c4f", "message": "0-Downtime: Local blue-green deployment", "committedDate": "2020-12-15T13:04:16Z", "type": "forcePushed"}, {"oid": "c2c5cb9c07b6496abecb59bdaf8fe07e636a26ef", "url": "https://github.com/telstra/open-kilda/commit/c2c5cb9c07b6496abecb59bdaf8fe07e636a26ef", "message": "0-Downtime: Local blue-green deployment", "committedDate": "2020-12-15T13:05:13Z", "type": "forcePushed"}, {"oid": "1919dfa4a63599bdb0987e123ef6351a0659eca4", "url": "https://github.com/telstra/open-kilda/commit/1919dfa4a63599bdb0987e123ef6351a0659eca4", "message": "Added ability to run Kilda in blue and green modes locally", "committedDate": "2020-12-17T10:55:45Z", "type": "forcePushed"}, {"oid": "a5aacd4ff6808ba0c5ba0c88fb981d2fd183a60d", "url": "https://github.com/telstra/open-kilda/commit/a5aacd4ff6808ba0c5ba0c88fb981d2fd183a60d", "message": "Added ability to run Kilda in blue and green modes locally", "committedDate": "2020-12-21T19:58:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkyMDM4Mw==", "url": "https://github.com/telstra/open-kilda/pull/3844#discussion_r547920383", "bodyText": "Is it always blue(or green) or can be any one of them? Do we steel need just \"northbound\" service?", "author": "surabujin", "createdAt": "2020-12-23T11:49:43Z", "path": "confd/templates/docker-compose/docker-compose.tmpl", "diffHunk": "@@ -441,9 +446,34 @@ services:\n          - northbound.pendev\n     mem_limit: ${NB_MEM_LIMIT:-1073741824}\n \n+  northbound-blue-green:", "originalCommit": "a5aacd4ff6808ba0c5ba0c88fb981d2fd183a60d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg2NzM5Mg==", "url": "https://github.com/telstra/open-kilda/pull/3844#discussion_r548867392", "bodyText": "northbound-blue-green is always green. Maybe I should rename it.\nyes we still need northbound to run Kilda as usual. Maybe it can be renamed to northbound-blue", "author": "niksv", "createdAt": "2020-12-25T12:38:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkyMDM4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkyNTg5Mg==", "url": "https://github.com/telstra/open-kilda/pull/3844#discussion_r547925892", "bodyText": "do not use exec in this way. In the original code, it was some kind of optimization - we can \"close/replace\" the existing bash process with make (at the end of the script). Now you have some logic around this make call... and should not close the existing bash process too early.\nPS it can be done in a simpler way (if WFM_TOPOLOGIES_MODE can contain only \"blue\" or \"green\" or are not defined):\nmake kill-all${WFM_TOPOLOGIES_MODE:+-$WFM_TOPOLOGIES_MODE}\nexec make deploy-alll${WFM_TOPOLOGIES_MODE:+-$WFM_TOPOLOGIES_MODE}", "author": "surabujin", "createdAt": "2020-12-23T12:04:16Z", "path": "docker/wfm/app/entry-point.sh", "diffHunk": "@@ -19,5 +19,21 @@ set -eu ${DEBUG:+-x}\n PATH=${PATH}:/opt/storm/bin\n \n cd /app\n-make kill-all\n-exec make deploy-all\n+\n+case ${WFM_TOPOLOGIES_MODE:-} in\n+\n+  blue)\n+    make kill-all-blue\n+    exec make deploy-all-blue", "originalCommit": "a5aacd4ff6808ba0c5ba0c88fb981d2fd183a60d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkyNzk3MA==", "url": "https://github.com/telstra/open-kilda/pull/3844#discussion_r547927970", "bodyText": "Unexpected behavior, at least for me. You completely ignore the value of WFM_TOPOLOGIES_MODE. Such behavior can mask incorrect values into WFM_TOPOLOGIES_MODE.", "author": "surabujin", "createdAt": "2020-12-23T12:09:38Z", "path": "docker/wfm/app/entry-point.sh", "diffHunk": "@@ -19,5 +19,21 @@ set -eu ${DEBUG:+-x}\n PATH=${PATH}:/opt/storm/bin\n \n cd /app\n-make kill-all\n-exec make deploy-all\n+\n+case ${WFM_TOPOLOGIES_MODE:-} in\n+\n+  blue)\n+    make kill-all-blue\n+    exec make deploy-all-blue\n+    ;;\n+\n+  green)\n+    make kill-all-green\n+    exec make deploy-all-green\n+    ;;\n+\n+  *)\n+    make kill-all", "originalCommit": "a5aacd4ff6808ba0c5ba0c88fb981d2fd183a60d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg2NzEzMQ==", "url": "https://github.com/telstra/open-kilda/pull/3844#discussion_r548867131", "bodyText": "I left it for backward compatibility. If we do not pass WFM_TOPOLOGIES_MODE typologies will run on blue mode", "author": "niksv", "createdAt": "2020-12-25T12:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkyNzk3MA=="}], "type": "inlineReview"}, {"oid": "4e29d90ee411f1361e4b6609083625fb9b5fa145", "url": "https://github.com/telstra/open-kilda/commit/4e29d90ee411f1361e4b6609083625fb9b5fa145", "message": "Added ability to run Kilda in blue and green modes locally", "committedDate": "2020-12-23T12:45:54Z", "type": "forcePushed"}, {"oid": "81e00f463693003af0bb56320ca8bfcaff5e301e", "url": "https://github.com/telstra/open-kilda/commit/81e00f463693003af0bb56320ca8bfcaff5e301e", "message": "Added ability to run Kilda in blue and green modes locally", "committedDate": "2020-12-25T09:55:43Z", "type": "commit"}, {"oid": "81e00f463693003af0bb56320ca8bfcaff5e301e", "url": "https://github.com/telstra/open-kilda/commit/81e00f463693003af0bb56320ca8bfcaff5e301e", "message": "Added ability to run Kilda in blue and green modes locally", "committedDate": "2020-12-25T09:55:43Z", "type": "forcePushed"}]}