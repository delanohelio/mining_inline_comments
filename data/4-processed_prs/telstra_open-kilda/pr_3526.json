{"pr_number": 3526, "pr_title": "Remove CopyField action from the VxLAN ingress rule.", "pr_createdAt": "2020-06-04T12:51:11Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3526", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI1ODU2MA==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r435258560", "bodyText": "incorrect comment, but correct code.\nint is 4 bytes. not 8", "author": "niksv", "createdAt": "2020-06-04T13:36:40Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/shared/packet/Vxlan.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/* Copyright 2017 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.floodlight.shared.packet;\n+\n+import lombok.EqualsAndHashCode;\n+import lombok.NoArgsConstructor;\n+import net.floodlightcontroller.packet.BasePacket;\n+import net.floodlightcontroller.packet.IPacket;\n+\n+import java.nio.ByteBuffer;\n+\n+@lombok.Data\n+@EqualsAndHashCode(callSuper = true)\n+@NoArgsConstructor\n+public class Vxlan extends BasePacket {\n+    private static final byte FLAGS = 0x8;\n+    private static final int VXLAN_HEADER_SIZE_IN_BYTES = 8;\n+    private static final int FIRST_RESERVED_AREA_IN_BYTES = 3;\n+    private static final int SECOND_RESERVED_AREA_IN_BITS = 8;\n+\n+    private int vni;\n+\n+    @Override\n+    public byte[] serialize() {\n+        byte[] payloadData = null;\n+        if (this.payload != null) {\n+            this.payload.setParent(this);\n+            payloadData = this.payload.serialize();\n+        }\n+\n+        int length = (short) (VXLAN_HEADER_SIZE_IN_BYTES + (payloadData == null ? 0 : payloadData.length));\n+        byte[] data = new byte[length];\n+        ByteBuffer bb = ByteBuffer.wrap(data);\n+        bb.put(FLAGS);\n+        bb.put(new byte[FIRST_RESERVED_AREA_IN_BYTES]);\n+        // 8 bit shift to add reserved area\n+        bb.putInt(vni << SECOND_RESERVED_AREA_IN_BITS);\n+\n+        if (payloadData != null) {\n+            bb.put(payloadData);\n+        }\n+\n+        return data;\n+    }\n+\n+    @Override\n+    public IPacket deserialize(byte[] data, int offset, int length) {\n+        ByteBuffer bb = ByteBuffer.wrap(data, offset, length);\n+        // skip 8 bytes\n+        bb.getInt();", "originalCommit": "2d1efea498c31adf876b6e1bd251e2a472df1aaf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY5MjQxNw==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r435692417", "bodyText": "Yes. You are right. Comment has been fixed.", "author": "dpoltavets", "createdAt": "2020-06-05T05:07:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI1ODU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg4MDkyMw==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r435880923", "bodyText": "Why 4?", "author": "surabujin", "createdAt": "2020-06-05T12:14:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI1ODU2MA=="}], "type": "inlineReview"}, {"oid": "84305dce81f9add79c8b2fbf220b6f1e336608f0", "url": "https://github.com/telstra/open-kilda/commit/84305dce81f9add79c8b2fbf220b6f1e336608f0", "message": "CopyField action has been removed from the VxLAN ingress rule.", "committedDate": "2020-06-05T05:04:24Z", "type": "forcePushed"}, {"oid": "e8a3b6b1cba1932b299e9944d330a744013d4ce1", "url": "https://github.com/telstra/open-kilda/commit/e8a3b6b1cba1932b299e9944d330a744013d4ce1", "message": "CopyField action has been removed from the VxLAN ingress rule.", "committedDate": "2020-06-05T05:06:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg2NzgzOQ==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r435867839", "bodyText": "Do you understand price of this change? \"ping\" will not be able to see issues with ingress flow rules (it is already can't see issues in egress rules). So only transit rules are verified.", "author": "surabujin", "createdAt": "2020-06-05T11:47:17Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/command/ping/PingRequestCommand.java", "diffHunk": "@@ -104,7 +104,7 @@ private OFMessage makePacketOut(IOFSwitch sw, byte[] data) {\n         pktOut.setData(data);\n \n         List<OFAction> actions = Collections.singletonList(ofFactory.actions().buildOutput()\n-                .setPort(OFPort.TABLE)", "originalCommit": "e8a3b6b1cba1932b299e9944d330a744013d4ce1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg3MDY4Mg==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r435870682", "bodyText": "If you make a decision on transit encapsulation type - you must process all existing and not existing(trigger apropriate error) types.", "author": "surabujin", "createdAt": "2020-06-05T11:53:41Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/service/ping/PingService.java", "diffHunk": "@@ -94,21 +97,40 @@ public IPacket wrapData(Ping ping, byte[] payload) {\n         l3.setDestinationAddress(NET_L3_ADDRESS);\n         l3.setTtl(NET_L3_TTL);\n \n-        EthType l2Type = EthType.IPv4;\n-        IPacket l2Payload = l3;\n-        List<Integer> vlanStack = FlowEndpoint.makeVlanStack(ping.getIngressInnerVlanId(), ping.getIngressVlanId());\n-        for (int vlanID : vlanStack) {\n-            l2Payload = EthernetPacketToolbox.injectVlan(l2Payload, vlanID, l2Type);\n-            l2Type = EthType.VLAN_FRAME;\n-        }\n-\n         Ethernet l2 = new Ethernet();\n-        l2.setEtherType(l2Type);\n+        l2.setPayload(l3);\n+        l2.setEtherType(EthType.IPv4);\n         l2.setSourceMACAddress(magicSourceMacAddress);\n         DatapathId egressSwitch = DatapathId.of(ping.getDest().getDatapath().toLong());\n         l2.setDestinationMACAddress(MacAddress.of(egressSwitch));\n-        l2.setPayload(l2Payload);\n \n+        if (FlowEncapsulationType.VXLAN.equals(ping.getTransitEncapsulation().getType())) {\n+            Vxlan vxlan = new Vxlan();\n+            vxlan.setPayload(l2);\n+            vxlan.setVni(ping.getTransitEncapsulation().getId());\n+\n+            UDP udp = new UDP();\n+            udp.setPayload(vxlan);\n+            udp.setSourcePort(TransportPort.of(SwitchManager.STUB_VXLAN_UDP_SRC));\n+            udp.setDestinationPort(TransportPort.of(SwitchManager.VXLAN_UDP_DST));\n+\n+            IPv4 ipv4 = new IPv4();\n+            ipv4.setPayload(udp);\n+            ipv4.setProtocol(IpProtocol.UDP);\n+            ipv4.setSourceAddress(SwitchManager.STUB_VXLAN_IPV4_SRC);\n+            ipv4.setDestinationAddress(SwitchManager.STUB_VXLAN_IPV4_DST);\n+            ipv4.setTtl(NET_L3_TTL);\n+\n+            Ethernet ethernet = new Ethernet();\n+            ethernet.setPayload(ipv4);\n+            ethernet.setEtherType(EthType.IPv4);\n+            ethernet.setSourceMACAddress(magicSourceMacAddress);\n+            ethernet.setDestinationMACAddress(MacAddress.of(egressSwitch));\n+\n+            return ethernet;\n+        }\n+\n+        l2.setVlanID(ping.getTransitEncapsulation().getId().shortValue());", "originalCommit": "e8a3b6b1cba1932b299e9944d330a744013d4ce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyNjI5OA==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r437226298", "bodyText": "Fixed.", "author": "dpoltavets", "createdAt": "2020-06-09T08:25:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg3MDY4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg3MzA5MQ==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r435873091", "bodyText": "em... and what it is?", "author": "surabujin", "createdAt": "2020-06-05T11:58:23Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/shared/packet/Vxlan.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/* Copyright 2017 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.floodlight.shared.packet;\n+\n+import lombok.EqualsAndHashCode;\n+import lombok.NoArgsConstructor;\n+import net.floodlightcontroller.packet.BasePacket;\n+import net.floodlightcontroller.packet.IPacket;\n+\n+import java.nio.ByteBuffer;\n+\n+@lombok.Data\n+@EqualsAndHashCode(callSuper = true)\n+@NoArgsConstructor\n+public class Vxlan extends BasePacket {\n+    private static final byte FLAGS = 0x8;", "originalCommit": "e8a3b6b1cba1932b299e9944d330a744013d4ce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyNjY0NQ==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r437226645", "bodyText": "Added description.", "author": "dpoltavets", "createdAt": "2020-06-09T08:25:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg3MzA5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg3NTYwOA==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r435875608", "bodyText": "Totally unreadable. You fill only one field and name all other as \"reserved\"... ugly. Without VxLan packet schema somewhere in front of eyes this code is not modifiable.", "author": "surabujin", "createdAt": "2020-06-05T12:03:19Z", "path": "src-java/floodlight-service/floodlight-modules/src/main/java/org/openkilda/floodlight/shared/packet/Vxlan.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/* Copyright 2017 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.floodlight.shared.packet;\n+\n+import lombok.EqualsAndHashCode;\n+import lombok.NoArgsConstructor;\n+import net.floodlightcontroller.packet.BasePacket;\n+import net.floodlightcontroller.packet.IPacket;\n+\n+import java.nio.ByteBuffer;\n+\n+@lombok.Data\n+@EqualsAndHashCode(callSuper = true)\n+@NoArgsConstructor\n+public class Vxlan extends BasePacket {\n+    private static final byte FLAGS = 0x8;\n+    private static final int VXLAN_HEADER_SIZE_IN_BYTES = 8;\n+    private static final int FIRST_RESERVED_AREA_IN_BYTES = 3;\n+    private static final int SECOND_RESERVED_AREA_IN_BITS = 8;\n+\n+    private int vni;\n+\n+    @Override\n+    public byte[] serialize() {", "originalCommit": "e8a3b6b1cba1932b299e9944d330a744013d4ce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyNjY4Ng==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r437226686", "bodyText": "Added description.", "author": "dpoltavets", "createdAt": "2020-06-09T08:26:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg3NTYwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg4NDg4Nw==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r435884887", "bodyText": "new ... toBuilder ... build?.. why for?", "author": "surabujin", "createdAt": "2020-06-05T12:22:36Z", "path": "src-java/ping-topology/ping-storm-topology/src/main/java/org/openkilda/wfm/topology/ping/bolt/FlowFetcher.java", "diffHunk": "@@ -110,8 +128,10 @@ private void handlePeriodicRequest(Tuple input) throws PipelineException {\n             refreshHeap(input, true);\n         }\n         final CommandContext commandContext = pullContext(input);\n-        for (Flow flow : flowsSet) {\n-            PingContext pingContext = new PingContext(Kinds.PERIODIC, flow);\n+        for (FlowWithTransitEncapsulation flow : flowsSet) {\n+            PingContext pingContext = new PingContext(Kinds.PERIODIC, flow.getFlow()).toBuilder()", "originalCommit": "e8a3b6b1cba1932b299e9944d330a744013d4ce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyNjg5MQ==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r437226891", "bodyText": "Fixed.", "author": "dpoltavets", "createdAt": "2020-06-09T08:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg4NDg4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk0ODM1NQ==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r435948355", "bodyText": "Why this check is required?", "author": "surabujin", "createdAt": "2020-06-05T14:10:23Z", "path": "src-java/ping-topology/ping-storm-topology/src/main/java/org/openkilda/wfm/topology/ping/bolt/PingProducer.java", "diffHunk": "@@ -66,20 +72,39 @@ private Ping buildPing(PingContext pingContext, FlowDirection direction) {\n         Flow flow = pingContext.getFlow();\n         FlowEndpoint ingress;\n         FlowEndpoint egress;\n+        int islPort;\n         if (FlowDirection.FORWARD == direction) {\n             ingress = new FlowSourceAdapter(flow).getEndpoint();\n             egress = new FlowDestAdapter(flow).getEndpoint();\n+            islPort = getIslPort(flow, flow.getForwardPath());\n         } else if (FlowDirection.REVERSE == direction) {\n             ingress = new FlowDestAdapter(flow).getEndpoint();\n             egress = new FlowSourceAdapter(flow).getEndpoint();\n+            islPort = getIslPort(flow, flow.getReversePath());\n         } else {\n             throw new IllegalArgumentException(String.format(\n                     \"Unexpected %s value: %s\", FlowDirection.class.getCanonicalName(), direction));\n         }\n \n-        return new Ping(ingress.getOuterVlanId(), ingress.getInnerVlanId(),\n-                        new NetworkEndpoint(ingress.getSwitchId(), ingress.getPortNumber()),\n-                        new NetworkEndpoint(egress.getSwitchId(), egress.getPortNumber()));\n+        return new Ping(new NetworkEndpoint(ingress.getSwitchId(), ingress.getPortNumber()),\n+                        new NetworkEndpoint(egress.getSwitchId(), egress.getPortNumber()),\n+                        pingContext.getTransitEncapsulation(), islPort);\n+    }\n+\n+    private int getIslPort(Flow flow, FlowPath flowPath) {\n+        List<PathSegment> segments = flowPath.getSegments();\n+        if (segments.isEmpty()) {\n+            throw new IllegalArgumentException(\n+                    format(\"Path segments not provided, flow_id: %s\", flow.getFlowId()));\n+        }\n+\n+        PathSegment ingressSegment = segments.get(0);\n+        if (!ingressSegment.getSrcSwitch().getSwitchId().equals(flowPath.getSrcSwitch().getSwitchId())) {", "originalCommit": "e8a3b6b1cba1932b299e9944d330a744013d4ce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyODY2MQ==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r437228661", "bodyText": "We verify this when creating requests for installing switch rules. Therefore, I think that there may be cases when this check is needed.", "author": "dpoltavets", "createdAt": "2020-06-09T08:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk0ODM1NQ=="}], "type": "inlineReview"}, {"oid": "0fb904c9f81bd83d0db28e4a615a41bcb88f340a", "url": "https://github.com/telstra/open-kilda/commit/0fb904c9f81bd83d0db28e4a615a41bcb88f340a", "message": "CopyField action has been removed from the VxLAN ingress rule.", "committedDate": "2020-06-09T08:24:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM0Nzc4Mw==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r437347783", "bodyText": "new ... toBuilder() ... build()... still", "author": "surabujin", "createdAt": "2020-06-09T11:50:32Z", "path": "src-java/ping-topology/ping-storm-topology/src/main/java/org/openkilda/wfm/topology/ping/bolt/FlowFetcher.java", "diffHunk": "@@ -126,17 +148,44 @@ private void handleOnDemandRequest(Tuple input) throws PipelineException {\n         if (optionalFlow.isPresent()) {\n             Flow flow = optionalFlow.get();\n \n-            PingContext pingContext = new PingContext(Kinds.ON_DEMAND, flow).toBuilder()\n-                    .timeout(request.getTimeout())\n-                    .build();\n-            emit(input, pingContext, pullContext(input));\n-\n+            if (!flow.isOneSwitchFlow()) {\n+                Optional<FlowTransitEncapsulation> transitEncapsulation = getTransitEncapsulation(flow);\n+                if (transitEncapsulation.isPresent()) {\n+                    PingContext pingContext = new PingContext(Kinds.ON_DEMAND, flow).toBuilder()", "originalCommit": "0fb904c9f81bd83d0db28e4a615a41bcb88f340a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk1NTczMA==", "url": "https://github.com/telstra/open-kilda/pull/3526#discussion_r437955730", "bodyText": "Fixed.", "author": "dpoltavets", "createdAt": "2020-06-10T08:35:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM0Nzc4Mw=="}], "type": "inlineReview"}, {"oid": "b612ab099ced91f56812ec89e7f2eeace7644f17", "url": "https://github.com/telstra/open-kilda/commit/b612ab099ced91f56812ec89e7f2eeace7644f17", "message": "CopyField action has been removed from the VxLAN ingress rule.", "committedDate": "2020-06-10T07:30:49Z", "type": "forcePushed"}, {"oid": "7328b9914f33141b80b8c031e80dcf5d7f3078ec", "url": "https://github.com/telstra/open-kilda/commit/7328b9914f33141b80b8c031e80dcf5d7f3078ec", "message": "CopyField action has been removed from the VxLAN ingress rule.", "committedDate": "2020-06-10T08:34:17Z", "type": "forcePushed"}, {"oid": "2eb4f45072a063421299ecc8c6c099b8c8ff70f0", "url": "https://github.com/telstra/open-kilda/commit/2eb4f45072a063421299ecc8c6c099b8c8ff70f0", "message": "CopyField action has been removed from the VxLAN ingress rule.", "committedDate": "2020-06-10T11:16:09Z", "type": "commit"}, {"oid": "2eb4f45072a063421299ecc8c6c099b8c8ff70f0", "url": "https://github.com/telstra/open-kilda/commit/2eb4f45072a063421299ecc8c6c099b8c8ff70f0", "message": "CopyField action has been removed from the VxLAN ingress rule.", "committedDate": "2020-06-10T11:16:09Z", "type": "forcePushed"}]}