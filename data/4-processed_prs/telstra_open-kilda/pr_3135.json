{"pr_number": 3135, "pr_title": "Added MAX_LATENCY PCE strategy.", "pr_createdAt": "2020-01-22T07:08:43Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3135", "timeline": [{"oid": "7fc66966fefe86fe74b7bfdd48a2e1f8ee36f213", "url": "https://github.com/telstra/open-kilda/commit/7fc66966fefe86fe74b7bfdd48a2e1f8ee36f213", "message": "Added MAX_LATENCY PCE strategy.", "committedDate": "2020-01-22T07:40:20Z", "type": "forcePushed"}, {"oid": "97335b57d136a498112eb81c01d92cd13e5f2943", "url": "https://github.com/telstra/open-kilda/commit/97335b57d136a498112eb81c01d92cd13e5f2943", "message": "Added MAX_LATENCY PCE strategy.", "committedDate": "2020-01-22T08:14:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYyMTQwMA==", "url": "https://github.com/telstra/open-kilda/pull/3135#discussion_r369621400", "bodyText": "Pair of ordered lists that represents forward path from start to end and reverse one\nCorrect javadoc for previous method also, please.", "author": "rozdy", "createdAt": "2020-01-22T15:17:41Z", "path": "services/src/kilda-pce/src/main/java/org/openkilda/pce/finder/PathFinder.java", "diffHunk": "@@ -39,6 +39,16 @@\n                                                    WeightFunction weightFunction)\n             throws UnroutableFlowException;\n \n+    /**\n+     * Finds a path whose weight is less than maxWeight and as close to maxWeight as possible.\n+     *\n+     * @return an ordered list that represents the path from start to end, or an empty list if no path found.", "originalCommit": "97335b57d136a498112eb81c01d92cd13e5f2943", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA2NzYyNA==", "url": "https://github.com/telstra/open-kilda/pull/3135#discussion_r370067624", "bodyText": "Fixed.", "author": "dpoltavets", "createdAt": "2020-01-23T11:34:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYyMTQwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYzMTk0Mg==", "url": "https://github.com/telstra/open-kilda/pull/3135#discussion_r369631942", "bodyText": "Algorithm with max weight is very similar to previous one. Maybe we can generalize it using different weight shift and path weight comparison functions to avoid code duplication?", "author": "rozdy", "createdAt": "2020-01-22T15:34:24Z", "path": "services/src/kilda-pce/src/main/java/org/openkilda/pce/finder/BestWeightAndShortestPathFinder.java", "diffHunk": "@@ -286,6 +305,69 @@ private void restoreEdge(Edge edge) {\n         return (bestPath != null) ? bestPath.parentPath : new LinkedList<>();\n     }\n \n+    /**\n+     * Finds a path whose weight is less than maxWeight and as close to maxWeight as possible.\n+     *\n+     * @return An ordered list that represents the path from start to end, or an empty list\n+     */\n+    private List<Edge> getPath(Node start, Node end, WeightFunction weightFunction, long maxWeight) {\n+        long bestWeight = Long.MAX_VALUE;\n+        SearchNode bestPath = null;\n+\n+        Deque<SearchNode> toVisit = new LinkedList<>();\n+        Map<Node, SearchNode> visited = new HashMap<>();\n+\n+        toVisit.add(new SearchNode(weightFunction, start, allowedDepth, 0, emptyList()));\n+\n+        while (!toVisit.isEmpty()) {\n+            SearchNode current = toVisit.pop();\n+\n+            // Leave if the path contains this node\n+            if (current.containsSwitch(current.dstSw.getSwitchId())) {\n+                continue;\n+            }\n+\n+            // Shift the current weight relative to maxWeight\n+            long shiftedCurrentWeight = Math.abs(maxWeight - current.parentWeight);\n+\n+            // Determine if this node is the destination node.\n+            if (current.dstSw.equals(end)) {\n+                // We found the destination\n+                if (shiftedCurrentWeight < bestWeight && current.parentWeight < maxWeight) {\n+                    // We found a best path. If we don't get here, then the entire graph will be\n+                    // searched until we run out of nodes or the depth is reached.\n+                    bestWeight = shiftedCurrentWeight;\n+                    bestPath = current;\n+                }\n+                // We found dest, no need to keep processing\n+                continue;\n+            }\n+\n+            // Stop processing entirely if we've gone too far, or over maxWeight\n+            if (current.allowedDepth <= 0 || current.parentWeight > maxWeight) {\n+                continue;\n+            }\n+\n+            // Otherwise, if we've been here before, see if this path is better\n+            SearchNode prior = visited.get(current.dstSw);\n+            if (prior != null && shiftedCurrentWeight >= Math.abs(maxWeight - prior.parentWeight)) {\n+                continue;\n+            }\n+\n+            // Either this is the first time, or this one has less weight .. either way, this node should\n+            // be the one in the visited list\n+            visited.put(current.dstSw, current);\n+\n+            // At this stage .. haven't found END, haven't gone too deep, and we are not over weight.\n+            // So, add the outbound isls.\n+            current.dstSw.getOutgoingLinks().stream()\n+                    .sorted(Comparator.comparing(edge -> edge.getDestSwitch().getSwitchId()))\n+                    .forEach(edge -> toVisit.add(current.addNode(edge)));\n+        }\n+\n+        return (bestPath != null) ? bestPath.parentPath : new LinkedList<>();\n+    }", "originalCommit": "97335b57d136a498112eb81c01d92cd13e5f2943", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA2ODkxNg==", "url": "https://github.com/telstra/open-kilda/pull/3135#discussion_r370068916", "bodyText": "Algorithm with max weight looks similar, but we are searching path in another way.", "author": "dpoltavets", "createdAt": "2020-01-23T11:37:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYzMTk0Mg=="}], "type": "inlineReview"}, {"oid": "fb52f0ef5af1de5dac793b24ef37dccbf2760af1", "url": "https://github.com/telstra/open-kilda/commit/fb52f0ef5af1de5dac793b24ef37dccbf2760af1", "message": "Added MAX_LATENCY PCE strategy.", "committedDate": "2020-01-23T11:33:00Z", "type": "forcePushed"}, {"oid": "704b7ffc18ac14165fdea675e7b4499d9618fdb4", "url": "https://github.com/telstra/open-kilda/commit/704b7ffc18ac14165fdea675e7b4499d9618fdb4", "message": "Added MAX_LATENCY PCE strategy.", "committedDate": "2020-01-24T08:28:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUyNzQ1Mg==", "url": "https://github.com/telstra/open-kilda/pull/3135#discussion_r370527452", "bodyText": "here must be current.parentWeight >= maxWeight", "author": "niksv", "createdAt": "2020-01-24T08:57:46Z", "path": "services/src/kilda-pce/src/main/java/org/openkilda/pce/finder/BestWeightAndShortestPathFinder.java", "diffHunk": "@@ -286,6 +305,82 @@ private void restoreEdge(Edge edge) {\n         return (bestPath != null) ? bestPath.parentPath : new LinkedList<>();\n     }\n \n+    private List<Edge> getPath(Node start, Node end, WeightFunction weightFunction, long maxWeight) {\n+        SearchNode desiredPath = getDesiredPath(start, end, weightFunction, maxWeight);\n+        SearchNode desiredReversePath = getDesiredPath(end, start, weightFunction, maxWeight);\n+\n+        if (desiredReversePath != null) {\n+            if (desiredPath == null || desiredReversePath.parentWeight > desiredPath.parentWeight) {\n+                desiredPath = desiredReversePath;\n+            }\n+        }\n+\n+        return (desiredPath != null) ? desiredPath.parentPath : new LinkedList<>();\n+    }\n+\n+    /**\n+     * Finds a path whose weight is less than maxWeight and as close to maxWeight as possible.\n+     *\n+     * @return A pair of ordered lists that represents the path from start to end, or an empty list\n+     */\n+    private SearchNode getDesiredPath(Node start, Node end, WeightFunction weightFunction, long maxWeight) {\n+        long desiredWeight = Long.MAX_VALUE;\n+        SearchNode desiredPath = null;\n+\n+        Deque<SearchNode> toVisit = new LinkedList<>();\n+        Map<Node, SearchNode> visited = new HashMap<>();\n+\n+        toVisit.add(new SearchNode(weightFunction, start, allowedDepth, 0, emptyList()));\n+\n+        while (!toVisit.isEmpty()) {\n+            SearchNode current = toVisit.pop();\n+\n+            // Leave if the path contains this node\n+            if (current.containsSwitch(current.dstSw.getSwitchId())) {\n+                continue;\n+            }\n+\n+            // Shift the current weight relative to maxWeight\n+            long shiftedCurrentWeight = Math.abs(maxWeight - current.parentWeight);\n+\n+            // Determine if this node is the destination node.\n+            if (current.dstSw.equals(end)) {\n+                // We found the destination\n+                if (shiftedCurrentWeight < desiredWeight && current.parentWeight < maxWeight) {\n+                    // We found a best path. If we don't get here, then the entire graph will be\n+                    // searched until we run out of nodes or the depth is reached.\n+                    desiredWeight = shiftedCurrentWeight;\n+                    desiredPath = current;\n+                }\n+                // We found dest, no need to keep processing\n+                continue;\n+            }\n+\n+            // Stop processing entirely if we've gone too far, or over maxWeight\n+            if (current.allowedDepth <= 0 || current.parentWeight > maxWeight) {", "originalCommit": "704b7ffc18ac14165fdea675e7b4499d9618fdb4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU0NjM2OA==", "url": "https://github.com/telstra/open-kilda/pull/3135#discussion_r370546368", "bodyText": "Fixed.", "author": "dpoltavets", "createdAt": "2020-01-24T09:45:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUyNzQ1Mg=="}], "type": "inlineReview"}, {"oid": "ef35092b26935953e80ab6a3cc7ce9634d08ee04", "url": "https://github.com/telstra/open-kilda/commit/ef35092b26935953e80ab6a3cc7ce9634d08ee04", "message": "Added MAX_LATENCY PCE strategy.", "committedDate": "2020-01-24T09:44:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU3MTk5Mw==", "url": "https://github.com/telstra/open-kilda/pull/3135#discussion_r370571993", "bodyText": "Javadoc return section is outdated.", "author": "rozdy", "createdAt": "2020-01-24T10:43:12Z", "path": "services/src/kilda-pce/src/main/java/org/openkilda/pce/finder/BestWeightAndShortestPathFinder.java", "diffHunk": "@@ -286,6 +305,82 @@ private void restoreEdge(Edge edge) {\n         return (bestPath != null) ? bestPath.parentPath : new LinkedList<>();\n     }\n \n+    private List<Edge> getPath(Node start, Node end, WeightFunction weightFunction, long maxWeight) {\n+        SearchNode desiredPath = getDesiredPath(start, end, weightFunction, maxWeight);\n+        SearchNode desiredReversePath = getDesiredPath(end, start, weightFunction, maxWeight);\n+\n+        if (desiredReversePath != null) {\n+            if (desiredPath == null || desiredReversePath.parentWeight > desiredPath.parentWeight) {\n+                desiredPath = desiredReversePath;\n+            }\n+        }\n+\n+        return (desiredPath != null) ? desiredPath.parentPath : new LinkedList<>();\n+    }\n+\n+    /**\n+     * Finds a path whose weight is less than maxWeight and as close to maxWeight as possible.\n+     *\n+     * @return A pair of ordered lists that represents the path from start to end, or an empty list\n+     */", "originalCommit": "ef35092b26935953e80ab6a3cc7ce9634d08ee04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU3Njg3MQ==", "url": "https://github.com/telstra/open-kilda/pull/3135#discussion_r370576871", "bodyText": "Fixed.", "author": "dpoltavets", "createdAt": "2020-01-24T10:54:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU3MTk5Mw=="}], "type": "inlineReview"}, {"oid": "35bc5ddc2377813fc903d5f41cfe3d22e751550f", "url": "https://github.com/telstra/open-kilda/commit/35bc5ddc2377813fc903d5f41cfe3d22e751550f", "message": "Added MAX_LATENCY PCE strategy.", "committedDate": "2020-01-24T10:53:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU3OTM4OA==", "url": "https://github.com/telstra/open-kilda/pull/3135#discussion_r370579388", "bodyText": "I genuinely do not understand the narrative of these tests. How do you compare cheapness to deepness in test names?", "author": "rtretyak", "createdAt": "2020-01-24T11:01:28Z", "path": "services/src/kilda-pce/src/test/java/org/openkilda/pce/finder/BestWeightAndShortestPathFinderTest.java", "diffHunk": "@@ -135,6 +135,71 @@ public void shouldChooseCheaperWithSameDepth() throws  UnroutableFlowException {\n         assertEquals(SWITCH_ID_3, rpath.get(0).getDestSwitch().getSwitchId());\n     }\n \n+    @Test\n+    public void shouldChooseCheaperOverTooDeepMaxWeightStrategy() throws  UnroutableFlowException {", "originalCommit": "35bc5ddc2377813fc903d5f41cfe3d22e751550f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bc9372531d8b0a3e72baa346d153511d301ce572", "url": "https://github.com/telstra/open-kilda/commit/bc9372531d8b0a3e72baa346d153511d301ce572", "message": "Added MAX_LATENCY PCE strategy.", "committedDate": "2020-01-27T06:33:14Z", "type": "forcePushed"}, {"oid": "f8509e569c20608a5e249b6819e0ba94d984fad7", "url": "https://github.com/telstra/open-kilda/commit/f8509e569c20608a5e249b6819e0ba94d984fad7", "message": "Added MAX_LATENCY PCE strategy.", "committedDate": "2020-01-27T09:56:55Z", "type": "forcePushed"}, {"oid": "c80f8237d5b0afdc4ea4baea456e5ddfdfc088f3", "url": "https://github.com/telstra/open-kilda/commit/c80f8237d5b0afdc4ea4baea456e5ddfdfc088f3", "message": "Add tests for MAX_LATENCY PCE strategy", "committedDate": "2020-02-10T08:23:32Z", "type": "forcePushed"}, {"oid": "f8b1d6c9191eaa5aa1c6fbcf4917b0ae070d4b96", "url": "https://github.com/telstra/open-kilda/commit/f8b1d6c9191eaa5aa1c6fbcf4917b0ae070d4b96", "message": "Added MAX_LATENCY PCE strategy.", "committedDate": "2020-03-02T06:07:11Z", "type": "commit"}, {"oid": "236cb9f5a6745b29aa4186bfeb631ae11f2b3243", "url": "https://github.com/telstra/open-kilda/commit/236cb9f5a6745b29aa4186bfeb631ae11f2b3243", "message": "Add tests for MAX_LATENCY PCE strategy", "committedDate": "2020-03-02T06:07:13Z", "type": "commit"}, {"oid": "236cb9f5a6745b29aa4186bfeb631ae11f2b3243", "url": "https://github.com/telstra/open-kilda/commit/236cb9f5a6745b29aa4186bfeb631ae11f2b3243", "message": "Add tests for MAX_LATENCY PCE strategy", "committedDate": "2020-03-02T06:07:13Z", "type": "forcePushed"}]}