{"pr_number": 3728, "pr_title": "update port/vlan should not cause reroute", "pr_createdAt": "2020-09-21T09:26:18Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3728", "timeline": [{"oid": "9c33eaae53bf16c92eb7ae5a0e8c9d01f049803d", "url": "https://github.com/telstra/open-kilda/commit/9c33eaae53bf16c92eb7ae5a0e8c9d01f049803d", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-23T17:41:06Z", "type": "forcePushed"}, {"oid": "143363279802b3288787476b082285ac22d481ab", "url": "https://github.com/telstra/open-kilda/commit/143363279802b3288787476b082285ac22d481ab", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-23T19:34:41Z", "type": "forcePushed"}, {"oid": "332f335944e73c553cc506f6ba22fa843721d0a1", "url": "https://github.com/telstra/open-kilda/commit/332f335944e73c553cc506f6ba22fa843721d0a1", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-23T20:12:43Z", "type": "forcePushed"}, {"oid": "b3c63f1dd21e465be4d5dc62fb90f37064356e52", "url": "https://github.com/telstra/open-kilda/commit/b3c63f1dd21e465be4d5dc62fb90f37064356e52", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-24T08:33:54Z", "type": "forcePushed"}, {"oid": "830cb64f0e5d069e2fe2dab710ef5cbb9fe9a3ce", "url": "https://github.com/telstra/open-kilda/commit/830cb64f0e5d069e2fe2dab710ef5cbb9fe9a3ce", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-24T08:49:41Z", "type": "forcePushed"}, {"oid": "d4f906cce5aa8061e5520a472183ef0116516289", "url": "https://github.com/telstra/open-kilda/commit/d4f906cce5aa8061e5520a472183ef0116516289", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-24T09:23:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM1OTM2Mw==", "url": "https://github.com/telstra/open-kilda/pull/3728#discussion_r494359363", "bodyText": "nit: add new line", "author": "niksv", "createdAt": "2020-09-24T14:20:29Z", "path": "docs/design/hub-and-spoke/crud/update/flow-update-fsm.puml", "diffHunk": "@@ -0,0 +1,143 @@\n+flow-update-fsm.png was created with draw.io to make the diagram easier to read.\n+\n+The current file was created so that in the case of a FSM design change we have the textual difference of what was\n+changed. This file exactly describes all the transitions in the implemented FSM.\n+\n+@startuml\n+title Flow Update FSM\n+hide empty description\n+\n+[*] --> FLOW_VALIDATED : next\n+[*] --> FINISHED_WITH_ERROR : error\n+\n+FLOW_VALIDATED --> FLOW_UPDATED : next\n+FLOW_VALIDATED --> REVERTING_FLOW_STATUS : timeout\n+FLOW_VALIDATED --> REVERTING_FLOW_STATUS : error\n+\n+FLOW_UPDATED --> PRIMARY_RESOURCES_ALLOCATED : next\n+FLOW_UPDATED --> RESOURCE_ALLOCATION_COMPLETED : update-endpoint-rules-only\n+FLOW_UPDATED --> REVERTING_FLOW: timeout\n+FLOW_UPDATED --> REVERTING_FLOW: error\n+\n+PRIMARY_RESOURCES_ALLOCATED --> PROTECTED_RESOURCES_ALLOCATED : next\n+PRIMARY_RESOURCES_ALLOCATED --> NEW_RULES_REVERTED : timeout\n+PRIMARY_RESOURCES_ALLOCATED --> NEW_RULES_REVERTED : error\n+PRIMARY_RESOURCES_ALLOCATED --> REVERTING_ALLOCATED_RESOURCES : no-path-found\n+\n+PROTECTED_RESOURCES_ALLOCATED --> RESOURCE_ALLOCATION_COMPLETED : next\n+PROTECTED_RESOURCES_ALLOCATED --> NEW_RULES_REVERTED : timeout\n+PROTECTED_RESOURCES_ALLOCATED --> NEW_RULES_REVERTED : error\n+PROTECTED_RESOURCES_ALLOCATED --> REVERTING_ALLOCATED_RESOURCES : no-path-found\n+\n+RESOURCE_ALLOCATION_COMPLETED --> INSTALLING_NON_INGRESS_RULES : next\n+RESOURCE_ALLOCATION_COMPLETED --> NEW_RULES_REVERTED : timeout\n+RESOURCE_ALLOCATION_COMPLETED --> NEW_RULES_REVERTED : error\n+\n+INSTALLING_NON_INGRESS_RULES : response-received / remove pending command\n+INSTALLING_NON_INGRESS_RULES : error-received / put failed command\n+INSTALLING_NON_INGRESS_RULES --> NON_INGRESS_RULES_INSTALLED : rules-installed\n+INSTALLING_NON_INGRESS_RULES --> PATHS_SWAP_REVERTED : timeout\n+INSTALLING_NON_INGRESS_RULES --> PATHS_SWAP_REVERTED : error\n+\n+NON_INGRESS_RULES_INSTALLED --> VALIDATING_NON_INGRESS_RULES : next\n+NON_INGRESS_RULES_INSTALLED --> PATHS_SWAP_REVERTED : timeout\n+NON_INGRESS_RULES_INSTALLED --> PATHS_SWAP_REVERTED : error\n+\n+VALIDATING_NON_INGRESS_RULES : response-received / remove pending command\n+VALIDATING_NON_INGRESS_RULES : error-received / put failed command\n+VALIDATING_NON_INGRESS_RULES --> NON_INGRESS_RULES_VALIDATED : rules-validated\n+VALIDATING_NON_INGRESS_RULES --> PATHS_SWAP_REVERTED : timeout\n+VALIDATING_NON_INGRESS_RULES --> PATHS_SWAP_REVERTED : error\n+VALIDATING_NON_INGRESS_RULES --> PATHS_SWAP_REVERTED : missing-rule-found\n+\n+NON_INGRESS_RULES_VALIDATED --> PATHS_SWAPPED : next\n+NON_INGRESS_RULES_VALIDATED --> REVERTING_PATHS_SWAP : timeout\n+NON_INGRESS_RULES_VALIDATED --> REVERTING_PATHS_SWAP : error\n+\n+PATHS_SWAPPED --> INSTALLING_INGRESS_RULES : next\n+PATHS_SWAPPED --> REVERTING_PATHS_SWAP : timeout\n+PATHS_SWAPPED --> REVERTING_PATHS_SWAP : error\n+\n+INSTALLING_INGRESS_RULES : response-received / remove pending command\n+INSTALLING_INGRESS_RULES : error-received / put failed command\n+INSTALLING_INGRESS_RULES --> INGRESS_RULES_INSTALLED : rules-installed\n+INSTALLING_INGRESS_RULES --> INGRESS_RULES_INSTALLED : ingress-is-skipped\n+INSTALLING_INGRESS_RULES --> REVERTING_PATHS_SWAP : timeout\n+INSTALLING_INGRESS_RULES --> REVERTING_PATHS_SWAP : error\n+\n+INGRESS_RULES_INSTALLED --> VALIDATING_INGRESS_RULES : next\n+INGRESS_RULES_INSTALLED --> REVERTING_PATHS_SWAP : timeout\n+INGRESS_RULES_INSTALLED --> REVERTING_PATHS_SWAP : error\n+\n+VALIDATING_INGRESS_RULES : response-received / remove pending command\n+VALIDATING_INGRESS_RULES : error-received / put failed command\n+VALIDATING_INGRESS_RULES --> INGRESS_RULES_VALIDATED : rules-validated\n+VALIDATING_INGRESS_RULES --> REVERTING_PATHS_SWAP : timeout\n+VALIDATING_INGRESS_RULES --> REVERTING_PATHS_SWAP : error\n+VALIDATING_INGRESS_RULES --> REVERTING_PATHS_SWAP : missing-rule-found\n+\n+INGRESS_RULES_VALIDATED --> NEW_PATHS_INSTALLATION_COMPLETED : next\n+INGRESS_RULES_VALIDATED --> REVERTING_PATHS_SWAP : timeout\n+INGRESS_RULES_VALIDATED --> REVERTING_PATHS_SWAP : error\n+\n+NEW_PATHS_INSTALLATION_COMPLETED --> REMOVING_OLD_RULES : next\n+NEW_PATHS_INSTALLATION_COMPLETED --> REVERTING_PATHS_SWAP : timeout\n+NEW_PATHS_INSTALLATION_COMPLETED --> REVERTING_PATHS_SWAP : error\n+\n+REMOVING_OLD_RULES : response-received / remove pending command\n+REMOVING_OLD_RULES : error-received / put failed command\n+REMOVING_OLD_RULES --> OLD_RULES_REMOVED : rules-removed\n+REMOVING_OLD_RULES --> OLD_RULES_REMOVED : error\n+\n+OLD_RULES_REMOVED --> OLD_PATHS_REMOVAL_COMPLETED : next\n+OLD_RULES_REMOVED --> UPDATING_FLOW_STATUS : update-endpoint-rules-only\n+\n+OLD_PATHS_REMOVAL_COMPLETED --> DEALLOCATING_OLD_RESOURCES : next\n+OLD_PATHS_REMOVAL_COMPLETED --> DEALLOCATING_OLD_RESOURCES : error\n+\n+DEALLOCATING_OLD_RESOURCES --> OLD_RESOURCES_DEALLOCATED : next\n+\n+OLD_RESOURCES_DEALLOCATED --> UPDATING_FLOW_STATUS : next\n+OLD_RESOURCES_DEALLOCATED --> UPDATING_FLOW_STATUS : error\n+\n+UPDATING_FLOW_STATUS --> FLOW_STATUS_UPDATED : next\n+\n+FLOW_STATUS_UPDATED --> FINISHED : next\n+FLOW_STATUS_UPDATED --> FINISHED_WITH_ERROR : error\n+\n+FINISHED --> [*]\n+\n+FINISHED_WITH_ERROR : enter / report error\n+FINISHED_WITH_ERROR --> [*]\n+\n+REVERTING_PATHS_SWAP : enter / report error\n+REVERTING_PATHS_SWAP --> PATHS_SWAP_REVERTED : next\n+\n+PATHS_SWAP_REVERTED : enter / report error\n+PATHS_SWAP_REVERTED --> REVERTING_NEW_RULES : next\n+PATHS_SWAP_REVERTED --> REVERTING_NEW_RULES : error\n+\n+REVERTING_NEW_RULES : response-received / remove pending command\n+REVERTING_NEW_RULES : error-received / put failed command\n+REVERTING_NEW_RULES --> NEW_RULES_REVERTED : rules-removed\n+REVERTING_NEW_RULES --> NEW_RULES_REVERTED : error\n+\n+NEW_RULES_REVERTED --> REVERTING_ALLOCATED_RESOURCES : next\n+NEW_RULES_REVERTED --> REVERTING_ALLOCATED_RESOURCES : error\n+NEW_RULES_REVERTED --> REVERTING_FLOW : update-endpoint-rules-only\n+\n+REVERTING_ALLOCATED_RESOURCES : enter / report error\n+REVERTING_ALLOCATED_RESOURCES --> RESOURCES_ALLOCATION_REVERTED : next\n+REVERTING_ALLOCATED_RESOURCES --> RESOURCES_ALLOCATION_REVERTED : error\n+\n+RESOURCES_ALLOCATION_REVERTED --> REVERTING_FLOW : next\n+RESOURCES_ALLOCATION_REVERTED --> REVERTING_FLOW : error\n+\n+REVERTING_FLOW : enter / report error\n+REVERTING_FLOW --> REVERTING_FLOW_STATUS : next\n+REVERTING_FLOW --> REVERTING_FLOW_STATUS : error\n+\n+REVERTING_FLOW_STATUS --> FINISHED_WITH_ERROR : next\n+REVERTING_FLOW_STATUS --> FINISHED_WITH_ERROR : error\n+\n+@enduml", "originalCommit": "a2355e48a1316b46dcec2cfbb3d3e1bff282ea7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ5NjcyMA==", "url": "https://github.com/telstra/open-kilda/pull/3728#discussion_r494496720", "bodyText": "It should be fine but I'll ask just  in case. Did you checked that enabling/disabling of connected devices on flow endpoint works correct if we change connected devices flag and src_port (for example)? I'm worried about situation when we install Ingress/egress rules and adds some new rules (like connected devices) in one command.", "author": "niksv", "createdAt": "2020-09-24T17:40:11Z", "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/update/actions/UpdateFlowAction.java", "diffHunk": "@@ -159,6 +185,44 @@ private String getOrCreateFlowGroupId(String flowId) throws FlowProcessingExcept\n                         format(\"Flow %s not found\", flowId)));\n     }\n \n+    private FlowUpdateFsm.EndpointUpdate updateEndpointRulesOnly(RequestedFlow originalFlow, RequestedFlow targetFlow,\n+                                                                 String originalGroupId, String targetGroupId) {\n+        boolean updateEndpointOnly = originalFlow.getSrcSwitch().equals(targetFlow.getSrcSwitch());\n+        updateEndpointOnly &= originalFlow.getDestSwitch().equals(targetFlow.getDestSwitch());\n+\n+        updateEndpointOnly &= originalFlow.isAllocateProtectedPath() == targetFlow.isAllocateProtectedPath();\n+        updateEndpointOnly &= originalFlow.getBandwidth() == targetFlow.getBandwidth();\n+        updateEndpointOnly &= originalFlow.isIgnoreBandwidth() == targetFlow.isIgnoreBandwidth();\n+\n+        updateEndpointOnly &= Objects.equal(originalFlow.getMaxLatency(), targetFlow.getMaxLatency());\n+        updateEndpointOnly &= Objects.equal(originalFlow.getFlowEncapsulationType(),\n+                targetFlow.getFlowEncapsulationType());\n+        updateEndpointOnly &= Objects.equal(originalFlow.getPathComputationStrategy(),\n+                targetFlow.getPathComputationStrategy());", "originalCommit": "a2355e48a1316b46dcec2cfbb3d3e1bff282ea7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDc2Nzg3OA==", "url": "https://github.com/telstra/open-kilda/pull/3728#discussion_r494767878", "bodyText": "good catch, updated", "author": "timofei-durakov", "createdAt": "2020-09-25T06:11:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ5NjcyMA=="}], "type": "inlineReview"}, {"oid": "440011d73162a65b8028ecc88b0effd2fbec7b0f", "url": "https://github.com/telstra/open-kilda/commit/440011d73162a65b8028ecc88b0effd2fbec7b0f", "message": "Get rid of Direction enum in command builder", "committedDate": "2020-09-25T06:11:20Z", "type": "forcePushed"}, {"oid": "f893bec4ff7f72f69a48051db4fe749416dc345d", "url": "https://github.com/telstra/open-kilda/commit/f893bec4ff7f72f69a48051db4fe749416dc345d", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-25T06:13:38Z", "type": "forcePushed"}, {"oid": "955e19ce3ed4ae706ff84bbc6caa8c0deeb773ab", "url": "https://github.com/telstra/open-kilda/commit/955e19ce3ed4ae706ff84bbc6caa8c0deeb773ab", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-25T11:22:04Z", "type": "commit"}, {"oid": "955e19ce3ed4ae706ff84bbc6caa8c0deeb773ab", "url": "https://github.com/telstra/open-kilda/commit/955e19ce3ed4ae706ff84bbc6caa8c0deeb773ab", "message": "update port/vlan should not cause reroute", "committedDate": "2020-09-25T11:22:04Z", "type": "forcePushed"}]}