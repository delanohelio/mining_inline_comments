{"pr_number": 3635, "pr_title": "refactor tests for smart discovery", "pr_createdAt": "2020-07-15T08:29:38Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3635", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwMjI3OA==", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r454902278", "bodyText": "Wait inside wait? I don't really get it. Either change how waitForIslStatus works or remove it and do a common wait for isls without islUtils.waitForIslStatus", "author": "rtretyak", "createdAt": "2020-07-15T09:01:56Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/FlowCrudSpec.groovy", "diffHunk": "@@ -730,7 +730,9 @@ class FlowCrudSpec extends HealthCheckSpecification {\n         def newIsl = islUtils.replug(isl, false, notConnectedIsl, true, true)\n \n         islUtils.waitForIslStatus([isl, isl.reversed], MOVED)\n-        islUtils.waitForIslStatus([newIsl, newIsl.reversed], DISCOVERED)\n+        Wrappers.wait(discoveryFailedInterval + WAIT_OFFSET) {\n+            islUtils.waitForIslStatus([newIsl, newIsl.reversed], DISCOVERED)", "originalCommit": "e2a589d88f10f57f20bfc2e0ac4c7240e5a2cd22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA1MTIzMQ==", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r455051231", "bodyText": "agree, my bad(", "author": "andriidovhan", "createdAt": "2020-07-15T13:28:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwMjI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwMzU3Mg==", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r454903572", "bodyText": "Default traffgen port may change, it is configurable. Instead of doing such an assumption you should get switch ports and find a port without isl", "author": "rtretyak", "createdAt": "2020-07-15T09:04:13Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/logging/CheckLoggingSpec.groovy", "diffHunk": "@@ -86,4 +88,26 @@ class CheckLoggingSpec extends HealthCheckSpecification {\n                     \"Storm should generate a warning message about not being able to find the flow\"\n         }\n     }\n+\n+    def \"Check push discovery package logging\"() {\n+        given: \"Two port(with/without ISL)\"\n+        def sw = topology.activeTraffGens*.switchConnected.first()\n+        def portWithIsl = topology.getRelatedIsls(sw).first().srcPort\n+        def portWithoutIsl = 10 //default port for traffgen", "originalCommit": "e2a589d88f10f57f20bfc2e0ac4c7240e5a2cd22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA3MzkzNw==", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r455073937", "bodyText": "agree, fixed", "author": "andriidovhan", "createdAt": "2020-07-15T13:59:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwMzU3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwNTI5Ng==", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r454905296", "bodyText": "the '60' number should be bind to the actual config", "author": "rtretyak", "createdAt": "2020-07-15T09:07:16Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/logging/CheckLoggingSpec.groovy", "diffHunk": "@@ -86,4 +88,26 @@ class CheckLoggingSpec extends HealthCheckSpecification {\n                     \"Storm should generate a warning message about not being able to find the flow\"\n         }\n     }\n+\n+    def \"Check push discovery package logging\"() {\n+        given: \"Two port(with/without ISL)\"\n+        def sw = topology.activeTraffGens*.switchConnected.first()\n+        def portWithIsl = topology.getRelatedIsls(sw).first().srcPort\n+        def portWithoutIsl = 10 //default port for traffgen\n+\n+        when: \"Retrieve logs for port with ISL for last 1 minute\"\n+        def result\n+\n+        then: \"There should be 1 message of push discovery for port without ISL and more than 1 for port with ISL\"\n+        Wrappers.wait(discoveryFailedInterval + WAIT_OFFSET) {\n+            result = elastic.getLogs(new ElasticQueryBuilder().setTags(KildaTags.FLOODLIGHT)\n+                    .setLevel(\"INFO\").setTimeRange(60).build())", "originalCommit": "e2a589d88f10f57f20bfc2e0ac4c7240e5a2cd22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA3MTU3MA==", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r455071570", "bodyText": "this number is described in the when block description (1 minute)", "author": "andriidovhan", "createdAt": "2020-07-15T13:56:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwNTI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyMDkzMw==", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r455620933", "bodyText": "if discovery.slow.poll.interval is changed to 59 instead of 60, then you can potentially see 2 push discovery messages for down port in the last 60 seconds", "author": "rtretyak", "createdAt": "2020-07-16T08:38:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwNTI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM0OTQ3Mg==", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r456349472", "bodyText": "This test can  be unstable, it was deleted.", "author": "andriidovhan", "createdAt": "2020-07-17T10:07:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwNTI5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwNjQ5OQ==", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r454906499", "bodyText": "can this number be calculated based of discovery interval and requested timerange?", "author": "rtretyak", "createdAt": "2020-07-15T09:09:17Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/logging/CheckLoggingSpec.groovy", "diffHunk": "@@ -86,4 +88,26 @@ class CheckLoggingSpec extends HealthCheckSpecification {\n                     \"Storm should generate a warning message about not being able to find the flow\"\n         }\n     }\n+\n+    def \"Check push discovery package logging\"() {\n+        given: \"Two port(with/without ISL)\"\n+        def sw = topology.activeTraffGens*.switchConnected.first()\n+        def portWithIsl = topology.getRelatedIsls(sw).first().srcPort\n+        def portWithoutIsl = 10 //default port for traffgen\n+\n+        when: \"Retrieve logs for port with ISL for last 1 minute\"\n+        def result\n+\n+        then: \"There should be 1 message of push discovery for port without ISL and more than 1 for port with ISL\"\n+        Wrappers.wait(discoveryFailedInterval + WAIT_OFFSET) {\n+            result = elastic.getLogs(new ElasticQueryBuilder().setTags(KildaTags.FLOODLIGHT)\n+                    .setLevel(\"INFO\").setTimeRange(60).build())\n+            assert result.hits.hits.findAll { hit ->\n+                hit.source.message.toLowerCase().contains(pushDiscoveryMsg(\"$sw.dpId-$portWithoutIsl\"))\n+            }.size() == 1\n+            assert result.hits.hits.findAll { hit ->\n+                hit.source.message.toLowerCase().contains(pushDiscoveryMsg(\"$sw.dpId-$portWithIsl\"))\n+            }.size() > 1", "originalCommit": "e2a589d88f10f57f20bfc2e0ac4c7240e5a2cd22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5MTU3NA==", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r455091574", "bodyText": "I tried to do it, but I had no luck\nI mean I see needed amount of logs in kibana, but can't get them by elastic.getLogs(new ElasticQueryBuilder().setTags(KildaTags.FLOODLIGHT).setLevel(\"INFO\").setTimeRange(60).build())", "author": "andriidovhan", "createdAt": "2020-07-15T14:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwNjQ5OQ=="}], "type": "inlineReview"}, {"oid": "a0f0f2d1ffaba5e1596fd1c9f90ca279e27409dc", "url": "https://github.com/telstra/open-kilda/commit/a0f0f2d1ffaba5e1596fd1c9f90ca279e27409dc", "message": "add/refactor tests for smart discovery", "committedDate": "2020-07-15T14:25:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxNzk3OQ==", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r455617979", "bodyText": "it is cleaner to use northbound.getLink here to ask for 1 certain isl. islUtils.getIslInfo(it) will dump all isls twice", "author": "rtretyak", "createdAt": "2020-07-16T08:33:24Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/links/IslMinPortSpeedSpec.groovy", "diffHunk": "@@ -38,7 +38,9 @@ class IslMinPortSpeedSpec extends HealthCheckSpecification {\n         when: \"Replug one end of the connected link to the destination switch(isl.srcSwitchId -> newDst.srcSwitchId)\"\n         def newIsl = islUtils.replug(isl, false, newDst, true, true)\n \n-        islUtils.waitForIslStatus([newIsl, newIsl.reversed], DISCOVERED)\n+        Wrappers.wait(discoverySlowPollInterval + WAIT_OFFSET) {\n+            [newIsl, newIsl.reversed].each { assert islUtils.getIslInfo(it).get().state == DISCOVERED }", "originalCommit": "a0f0f2d1ffaba5e1596fd1c9f90ca279e27409dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMzOTg2Mg==", "url": "https://github.com/telstra/open-kilda/pull/3635#discussion_r456339862", "bodyText": "fixed", "author": "andriidovhan", "createdAt": "2020-07-17T09:48:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxNzk3OQ=="}], "type": "inlineReview"}, {"oid": "39bb2a0817831f25e2d630b7651a170e9eb38558", "url": "https://github.com/telstra/open-kilda/commit/39bb2a0817831f25e2d630b7651a170e9eb38558", "message": "add/refactor tests for smart discovery", "committedDate": "2020-07-17T10:07:54Z", "type": "forcePushed"}, {"oid": "50f1156edbef9c4c62825f750e74b216fa1bbe4b", "url": "https://github.com/telstra/open-kilda/commit/50f1156edbef9c4c62825f750e74b216fa1bbe4b", "message": "add/refactor tests for smart discovery", "committedDate": "2020-07-17T10:14:36Z", "type": "forcePushed"}, {"oid": "0924e69d725a5ccce9c9e33d6d5029550e985a9e", "url": "https://github.com/telstra/open-kilda/commit/0924e69d725a5ccce9c9e33d6d5029550e985a9e", "message": "add/refactor tests for smart discovery", "committedDate": "2020-07-23T07:40:12Z", "type": "forcePushed"}, {"oid": "79e74233ddc0da8971ebe954e3378ea9c142e503", "url": "https://github.com/telstra/open-kilda/commit/79e74233ddc0da8971ebe954e3378ea9c142e503", "message": "add/refactor tests for smart discovery", "committedDate": "2020-07-23T07:46:04Z", "type": "forcePushed"}, {"oid": "76e42f6b7c0eb1b2eba935e26273baf5284e77e2", "url": "https://github.com/telstra/open-kilda/commit/76e42f6b7c0eb1b2eba935e26273baf5284e77e2", "message": "add/refactor tests for smart discovery", "committedDate": "2020-07-23T09:42:37Z", "type": "forcePushed"}, {"oid": "7a47cdebd82e18513878dd334c64f9505020b7f4", "url": "https://github.com/telstra/open-kilda/commit/7a47cdebd82e18513878dd334c64f9505020b7f4", "message": "add/refactor tests for smart discovery", "committedDate": "2020-07-24T13:38:44Z", "type": "commit"}, {"oid": "7a47cdebd82e18513878dd334c64f9505020b7f4", "url": "https://github.com/telstra/open-kilda/commit/7a47cdebd82e18513878dd334c64f9505020b7f4", "message": "add/refactor tests for smart discovery", "committedDate": "2020-07-24T13:38:44Z", "type": "forcePushed"}]}