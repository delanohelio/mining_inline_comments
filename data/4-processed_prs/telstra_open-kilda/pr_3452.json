{"pr_number": 3452, "pr_title": "Add test for errors during flow delete", "pr_createdAt": "2020-05-07T14:34:13Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3452", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NzU4Mg==", "url": "https://github.com/telstra/open-kilda/pull/3452#discussion_r421947582", "bodyText": "!northboundV2.getFlowStatus(flowId)\nit allows us to not fail if some flow already exist", "author": "andriidovhan", "createdAt": "2020-05-08T05:33:30Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/resilience/RollbacksSpec.groovy", "diffHunk": "@@ -255,4 +257,32 @@ and at least 1 path must remain safe\"\n                 ]\n         ]\n     }\n+\n+    @Tidy\n+    def \"Flow is successfully deleted from the system even if some rule delete commands fail (no rollback for delete)\"() {\n+        given: \"A flow\"\n+        def swPair = topologyHelper.switchPairs.first()\n+        def flow = flowHelperV2.randomFlow(swPair)\n+        flowHelperV2.addFlow(flow)\n+\n+        when: \"Send delete request for the flow\"\n+        lockKeeper.shapeSwitchesTraffic([swPair.src], new TrafficControlData(1000))\n+        northboundV2.deleteFlow(flow.flowId)\n+\n+        and: \"One of the related switches does not respond\"\n+        def blockData = switchHelper.knockoutSwitch(swPair.src, mgmtFlManager)\n+\n+        then: \"Flow history shows failed delete rule retry attempts but flow deletion is successful at the end\"\n+        wait(WAIT_OFFSET) {\n+            def history = northbound.getFlowHistory(flow.flowId).last().histories\n+            //egress and ingress rule on a broken switch, 3 retries each = total 6\n+            assert history.count { it.details ==~ /Failed to remove the rule.*Retrying \\(attempt \\d+\\)/ } == 6\n+            assert history.last().action == DELETE_SUCCESS\n+        }\n+        northboundV2.getAllFlows().empty", "originalCommit": "9232d685c0ad60de1e89f21d694c9c7c780c3c09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA1Mzc0NQ==", "url": "https://github.com/telstra/open-kilda/pull/3452#discussion_r422053745", "bodyText": "done", "author": "rtretyak", "createdAt": "2020-05-08T09:52:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NzU4Mg=="}], "type": "inlineReview"}, {"oid": "989b055def85eba60de07c0156fa9672d4e05b06", "url": "https://github.com/telstra/open-kilda/commit/989b055def85eba60de07c0156fa9672d4e05b06", "message": "Add test for errors during flow delete", "committedDate": "2020-05-08T09:51:57Z", "type": "forcePushed"}, {"oid": "05a6da8638e341a0ccacd9e8082cf7457a15439c", "url": "https://github.com/telstra/open-kilda/commit/05a6da8638e341a0ccacd9e8082cf7457a15439c", "message": "Add test for errors during flow delete", "committedDate": "2020-05-12T08:58:50Z", "type": "commit"}, {"oid": "05a6da8638e341a0ccacd9e8082cf7457a15439c", "url": "https://github.com/telstra/open-kilda/commit/05a6da8638e341a0ccacd9e8082cf7457a15439c", "message": "Add test for errors during flow delete", "committedDate": "2020-05-12T08:58:50Z", "type": "forcePushed"}]}