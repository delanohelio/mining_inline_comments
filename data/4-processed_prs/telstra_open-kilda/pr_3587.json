{"pr_number": 3587, "pr_title": "Added max_count parameter into flow history API", "pr_createdAt": "2020-07-02T10:21:12Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3587", "timeline": [{"oid": "4aaf9aefca4aae6c0092f44de51d88306b5d3708", "url": "https://github.com/telstra/open-kilda/commit/4aaf9aefca4aae6c0092f44de51d88306b5d3708", "message": "Added max_count paramater into flow history API", "committedDate": "2020-07-06T14:29:00Z", "type": "forcePushed"}, {"oid": "982ec6e7ac70d5db3317ca5aa050e6d3431168b9", "url": "https://github.com/telstra/open-kilda/commit/982ec6e7ac70d5db3317ca5aa050e6d3431168b9", "message": "Added max_count paramater into flow history API", "committedDate": "2020-07-06T14:54:14Z", "type": "forcePushed"}, {"oid": "ddcf023f5e0f147c1cb0cb9851896ca9bc5513f5", "url": "https://github.com/telstra/open-kilda/commit/ddcf023f5e0f147c1cb0cb9851896ca9bc5513f5", "message": "Added max_count paramater into flow history API", "committedDate": "2020-07-07T09:52:20Z", "type": "forcePushed"}, {"oid": "042664d6bfb5b23cea65dc636ec3dd52cfe6e1d9", "url": "https://github.com/telstra/open-kilda/commit/042664d6bfb5b23cea65dc636ec3dd52cfe6e1d9", "message": "Added max_count paramater into flow history API", "committedDate": "2020-07-07T10:18:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyMzMzMw==", "url": "https://github.com/telstra/open-kilda/pull/3587#discussion_r451023333", "bodyText": "excess single quote at the end of the sentence -.-", "author": "rtretyak", "createdAt": "2020-07-07T17:19:58Z", "path": "src-java/northbound-service/northbound/src/main/java/org/openkilda/northbound/service/impl/FlowServiceImpl.java", "diffHunk": "@@ -647,12 +647,18 @@ private FlowPathPayload buildFlowPathPayload(List<FlowPathDto> paths, String flo\n     @Override\n     public CompletableFuture<List<FlowEventPayload>> listFlowEvents(String flowId,\n                                                                     long timestampFrom,\n-                                                                    long timestampTo) {\n+                                                                    long timestampTo, int maxCount) {\n+        if (maxCount < 1) {\n+            throw new MessageException(RequestCorrelationId.getId(), System.currentTimeMillis(),\n+                    ErrorType.PARAMETERS_INVALID, format(\"Invalid `max_count` argument '%s'.\", maxCount),\n+                    \"`max_count` argument must be positive.'\");", "originalCommit": "042664d6bfb5b23cea65dc636ec3dd52cfe6e1d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMxOTI0MA==", "url": "https://github.com/telstra/open-kilda/pull/3587#discussion_r451319240", "bodyText": "will fix", "author": "niksv", "createdAt": "2020-07-08T06:48:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyMzMzMw=="}], "type": "inlineReview"}, {"oid": "9f20ff3dc4c43eb7f67279f391edf45dda157194", "url": "https://github.com/telstra/open-kilda/commit/9f20ff3dc4c43eb7f67279f391edf45dda157194", "message": "Added max_count paramater into flow history API", "committedDate": "2020-07-08T06:54:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1NjM1Mw==", "url": "https://github.com/telstra/open-kilda/pull/3587#discussion_r452156353", "bodyText": "Per RFC, HttpStatus.PARTIAL_CONTENT is returned only if Range header is passed. In out case we should return 200 OK.", "author": "sergii-iakovenko", "createdAt": "2020-07-09T11:42:45Z", "path": "src-java/northbound-service/northbound/src/main/java/org/openkilda/northbound/controller/v1/FlowController.java", "diffHunk": "@@ -328,18 +332,42 @@ public void invalidateFlowCache() {\n      */\n     @ApiOperation(value = \"Gets history for flow\", response = FlowEventPayload.class, responseContainer = \"List\")\n     @GetMapping(path = \"/{flow_id}/history\")\n-    @ResponseStatus(HttpStatus.OK)\n-    public CompletableFuture<List<FlowEventPayload>> getHistory(\n+    public ResponseEntity<List<FlowEventPayload>> getHistory(\n             @PathVariable(\"flow_id\") String flowId,\n-            @ApiParam(value = \"default: the day before timeTo.\", required = false)\n+            @ApiParam(value = \"default: 0 (1 January 1970 00:00:00).\", required = false)\n             @RequestParam(value = \"timeFrom\", required = false) Optional<Long> optionalTimeFrom,\n             @ApiParam(value = \"default: now.\", required = false)\n-            @RequestParam(value = \"timeTo\", required = false) Optional<Long> optionalTimeTo) {\n+            @RequestParam(value = \"timeTo\", required = false) Optional<Long> optionalTimeTo,\n+            @ApiParam(value = \"Return at most N latest records. \"\n+                    + \"Default: if `timeFrom` or/and `timeTo` parameters are presented default value of \"\n+                    + \"`maxCount` is infinite (all records in time interval will be returned). \"\n+                    + \"Otherwise default value of `maxCount` will be equal to 100. In This case response will contain \"\n+                    + \"header 'Content-Range' and have status 206 (Partial Content).\")\n+            @RequestParam(value = \"max_count\", required = false) Optional<Integer> optionalMaxCount) {\n+        int maxCount = optionalMaxCount.orElseGet(() -> {\n+            if (optionalTimeFrom.isPresent() || optionalTimeTo.isPresent()) {\n+                return Integer.MAX_VALUE;\n+            } else {\n+                return DEFAULT_MAX_HISTORY_RECORD_COUNT;\n+            }\n+        });\n+\n         Long timeTo = optionalTimeTo.orElseGet(() -> Instant.now().getEpochSecond());\n-        Long timeFrom = optionalTimeFrom.orElseGet(\n-                () -> Instant.ofEpochSecond(timeTo).minus(1, ChronoUnit.DAYS).getEpochSecond()\n-        );\n-        return flowService.listFlowEvents(flowId, timeFrom, timeTo);\n+        Long timeFrom = optionalTimeFrom.orElse(0L);\n+        List<FlowEventPayload> events = flowService.listFlowEvents(flowId, timeFrom, timeTo, maxCount).join();\n+\n+        HttpStatus responseStatus = HttpStatus.OK;\n+        HttpHeaders headers = new HttpHeaders();\n+\n+        if (!optionalMaxCount.isPresent() && !optionalTimeFrom.isPresent() && !optionalTimeTo.isPresent()) {\n+            // if request has no parameters we assume that default value of `maxCount` is 100. To indicate that response\n+            // may contain not all of history records \"Content-Range\" header will be added to response.\n+            // Also Response status will be set to 206 (Partial Content)\n+            int count = Math.min(DEFAULT_MAX_HISTORY_RECORD_COUNT, events.size()) - 1;\n+            headers.add(HttpHeaders.CONTENT_RANGE, format(\"event 0-%d/*\", count));\n+            responseStatus = HttpStatus.PARTIAL_CONTENT;", "originalCommit": "9f20ff3dc4c43eb7f67279f391edf45dda157194", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI1NzgyNg==", "url": "https://github.com/telstra/open-kilda/pull/3587#discussion_r452257826", "bodyText": "fixed", "author": "niksv", "createdAt": "2020-07-09T14:25:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1NjM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2NTAyNQ==", "url": "https://github.com/telstra/open-kilda/pull/3587#discussion_r452265025", "bodyText": "Let's use more generic units - \"items\" (instead of \"event\")", "author": "sergii-iakovenko", "createdAt": "2020-07-09T14:35:54Z", "path": "src-java/northbound-service/northbound/src/main/java/org/openkilda/northbound/controller/v1/FlowController.java", "diffHunk": "@@ -328,18 +332,39 @@ public void invalidateFlowCache() {\n      */\n     @ApiOperation(value = \"Gets history for flow\", response = FlowEventPayload.class, responseContainer = \"List\")\n     @GetMapping(path = \"/{flow_id}/history\")\n-    @ResponseStatus(HttpStatus.OK)\n-    public CompletableFuture<List<FlowEventPayload>> getHistory(\n+    public ResponseEntity<List<FlowEventPayload>> getHistory(\n             @PathVariable(\"flow_id\") String flowId,\n-            @ApiParam(value = \"default: the day before timeTo.\", required = false)\n+            @ApiParam(value = \"default: 0 (1 January 1970 00:00:00).\", required = false)\n             @RequestParam(value = \"timeFrom\", required = false) Optional<Long> optionalTimeFrom,\n             @ApiParam(value = \"default: now.\", required = false)\n-            @RequestParam(value = \"timeTo\", required = false) Optional<Long> optionalTimeTo) {\n+            @RequestParam(value = \"timeTo\", required = false) Optional<Long> optionalTimeTo,\n+            @ApiParam(value = \"Return at most N latest records. \"\n+                    + \"Default: if `timeFrom` or/and `timeTo` parameters are presented default value of \"\n+                    + \"`maxCount` is infinite (all records in time interval will be returned). \"\n+                    + \"Otherwise default value of `maxCount` will be equal to 100. In This case response will contain \"\n+                    + \"header 'Content-Range'.\")\n+            @RequestParam(value = \"max_count\", required = false) Optional<Integer> optionalMaxCount) {\n+        int maxCount = optionalMaxCount.orElseGet(() -> {\n+            if (optionalTimeFrom.isPresent() || optionalTimeTo.isPresent()) {\n+                return Integer.MAX_VALUE;\n+            } else {\n+                return DEFAULT_MAX_HISTORY_RECORD_COUNT;\n+            }\n+        });\n+\n         Long timeTo = optionalTimeTo.orElseGet(() -> Instant.now().getEpochSecond());\n-        Long timeFrom = optionalTimeFrom.orElseGet(\n-                () -> Instant.ofEpochSecond(timeTo).minus(1, ChronoUnit.DAYS).getEpochSecond()\n-        );\n-        return flowService.listFlowEvents(flowId, timeFrom, timeTo);\n+        Long timeFrom = optionalTimeFrom.orElse(0L);\n+        List<FlowEventPayload> events = flowService.listFlowEvents(flowId, timeFrom, timeTo, maxCount).join();\n+\n+        HttpHeaders headers = new HttpHeaders();\n+\n+        if (!optionalMaxCount.isPresent() && !optionalTimeFrom.isPresent() && !optionalTimeTo.isPresent()) {\n+            // if request has no parameters we assume that default value of `maxCount` is 100. To indicate that response\n+            // may contain not all of history records \"Content-Range\" header will be added to response.\n+            int count = Math.min(DEFAULT_MAX_HISTORY_RECORD_COUNT, events.size()) - 1;\n+            headers.add(HttpHeaders.CONTENT_RANGE, format(\"event 0-%d/*\", count));", "originalCommit": "3580dcb1e5b782984bfa536724e05692c3a38b94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2OTcxNw==", "url": "https://github.com/telstra/open-kilda/pull/3587#discussion_r452269717", "bodyText": "fixex", "author": "niksv", "createdAt": "2020-07-09T14:42:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2NTAyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI3OTY1Ng==", "url": "https://github.com/telstra/open-kilda/pull/3587#discussion_r452279656", "bodyText": "I'd return this header ONLY in cases when we have in database more records than DEFAULT_MAX_HISTORY_RECORD_COUNT.", "author": "sergii-iakovenko", "createdAt": "2020-07-09T14:55:09Z", "path": "src-java/northbound-service/northbound/src/main/java/org/openkilda/northbound/controller/v1/FlowController.java", "diffHunk": "@@ -328,18 +332,39 @@ public void invalidateFlowCache() {\n      */\n     @ApiOperation(value = \"Gets history for flow\", response = FlowEventPayload.class, responseContainer = \"List\")\n     @GetMapping(path = \"/{flow_id}/history\")\n-    @ResponseStatus(HttpStatus.OK)\n-    public CompletableFuture<List<FlowEventPayload>> getHistory(\n+    public ResponseEntity<List<FlowEventPayload>> getHistory(\n             @PathVariable(\"flow_id\") String flowId,\n-            @ApiParam(value = \"default: the day before timeTo.\", required = false)\n+            @ApiParam(value = \"default: 0 (1 January 1970 00:00:00).\", required = false)\n             @RequestParam(value = \"timeFrom\", required = false) Optional<Long> optionalTimeFrom,\n             @ApiParam(value = \"default: now.\", required = false)\n-            @RequestParam(value = \"timeTo\", required = false) Optional<Long> optionalTimeTo) {\n+            @RequestParam(value = \"timeTo\", required = false) Optional<Long> optionalTimeTo,\n+            @ApiParam(value = \"Return at most N latest records. \"\n+                    + \"Default: if `timeFrom` or/and `timeTo` parameters are presented default value of \"\n+                    + \"`maxCount` is infinite (all records in time interval will be returned). \"\n+                    + \"Otherwise default value of `maxCount` will be equal to 100. In This case response will contain \"\n+                    + \"header 'Content-Range'.\")\n+            @RequestParam(value = \"max_count\", required = false) Optional<Integer> optionalMaxCount) {\n+        int maxCount = optionalMaxCount.orElseGet(() -> {\n+            if (optionalTimeFrom.isPresent() || optionalTimeTo.isPresent()) {\n+                return Integer.MAX_VALUE;\n+            } else {\n+                return DEFAULT_MAX_HISTORY_RECORD_COUNT;\n+            }\n+        });\n+\n         Long timeTo = optionalTimeTo.orElseGet(() -> Instant.now().getEpochSecond());\n-        Long timeFrom = optionalTimeFrom.orElseGet(\n-                () -> Instant.ofEpochSecond(timeTo).minus(1, ChronoUnit.DAYS).getEpochSecond()\n-        );\n-        return flowService.listFlowEvents(flowId, timeFrom, timeTo);\n+        Long timeFrom = optionalTimeFrom.orElse(0L);\n+        List<FlowEventPayload> events = flowService.listFlowEvents(flowId, timeFrom, timeTo, maxCount).join();\n+\n+        HttpHeaders headers = new HttpHeaders();\n+\n+        if (!optionalMaxCount.isPresent() && !optionalTimeFrom.isPresent() && !optionalTimeTo.isPresent()) {\n+            // if request has no parameters we assume that default value of `maxCount` is 100. To indicate that response\n+            // may contain not all of history records \"Content-Range\" header will be added to response.\n+            int count = Math.min(DEFAULT_MAX_HISTORY_RECORD_COUNT, events.size()) - 1;\n+            headers.add(HttpHeaders.CONTENT_RANGE, format(\"items 0-%d/*\", count));", "originalCommit": "24fbc11a834de040f92bbae1ed3d6b53d6d2185c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5c47b9ed30321a253ac12edd9ee2958e20b9178c", "url": "https://github.com/telstra/open-kilda/commit/5c47b9ed30321a253ac12edd9ee2958e20b9178c", "message": "Added max_count paramater into flow history API", "committedDate": "2020-07-10T19:09:45Z", "type": "commit"}, {"oid": "5c47b9ed30321a253ac12edd9ee2958e20b9178c", "url": "https://github.com/telstra/open-kilda/commit/5c47b9ed30321a253ac12edd9ee2958e20b9178c", "message": "Added max_count paramater into flow history API", "committedDate": "2020-07-10T19:09:45Z", "type": "forcePushed"}]}