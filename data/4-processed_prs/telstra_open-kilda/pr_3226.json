{"pr_number": 3226, "pr_title": "Add func tests for ARP connected devices", "pr_createdAt": "2020-02-20T14:37:59Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3226", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQyNTA1Mw==", "url": "https://github.com/telstra/open-kilda/pull/3226#discussion_r382425053", "bodyText": "According to code here must be NOVIFLOW_PUSH_POP_VXLAN feature", "author": "niksv", "createdAt": "2020-02-21T07:04:27Z", "path": "src-java/testing/functional-tests/src/main/groovy/org/openkilda/functionaltests/helpers/SwitchHelper.groovy", "diffHunk": "@@ -84,49 +105,53 @@ class SwitchHelper {\n         if (swProps.multiTable) {\n             multiTableRules = [MULTITABLE_PRE_INGRESS_PASS_THROUGH_COOKIE, MULTITABLE_INGRESS_DROP_COOKIE,\n                     MULTITABLE_POST_INGRESS_DROP_COOKIE, MULTITABLE_EGRESS_PASS_THROUGH_COOKIE,\n-                    MULTITABLE_TRANSIT_DROP_COOKIE, LLDP_POST_INGRESS_COOKIE, LLDP_POST_INGRESS_ONE_SWITCH_COOKIE]\n+                    MULTITABLE_TRANSIT_DROP_COOKIE, LLDP_POST_INGRESS_COOKIE, LLDP_POST_INGRESS_ONE_SWITCH_COOKIE,\n+                    ARP_POST_INGRESS_COOKIE, ARP_POST_INGRESS_ONE_SWITCH_COOKIE]\n             if (sw.features.contains(SwitchFeature.NOVIFLOW_COPY_FIELD)) {", "originalCommit": "1f1066ec4f8e6313f8d3969f9827de59526219f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ2ODIzNQ==", "url": "https://github.com/telstra/open-kilda/pull/3226#discussion_r382468235", "bodyText": "Yeah, I know. Fixed it in https://github.com/telstra/open-kilda/pull/3092/files but not here. Will fix it here too", "author": "rtretyak", "createdAt": "2020-02-21T09:07:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQyNTA1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQzNjE1OA==", "url": "https://github.com/telstra/open-kilda/pull/3226#discussion_r382436158", "bodyText": "what will happen if some rules are missed on the switch?\nFor example\nactualHexCookie = [1,2]\nexpectedHexCookie = [1,2,3]\nwill condition (actualHexCookie - expectedHexCookie).empty be false positive in this case", "author": "niksv", "createdAt": "2020-02-21T07:42:24Z", "path": "src-java/testing/functional-tests/src/main/groovy/org/openkilda/functionaltests/helpers/SwitchHelper.groovy", "diffHunk": "@@ -164,13 +189,13 @@ class SwitchHelper {\n         Wrappers.wait(Constants.RULES_INSTALLATION_TIME) {\n             def actualHexCookie = []\n             for (long cookie : northbound.getSwitchRules(sw.dpId).flowEntries*.cookie) {\n-                actualHexCookie.add(Cookie.decode(cookie).toString())\n+                actualHexCookie.add(decode(cookie).toString())\n             }\n             def expectedHexCookie = []\n             for (long cookie : sw.defaultCookies) {\n-                expectedHexCookie.add(Cookie.decode(cookie).toString())\n+                expectedHexCookie.add(decode(cookie).toString())\n             }\n-            assert actualHexCookie.sort() == expectedHexCookie.sort()\n+            assert (actualHexCookie - expectedHexCookie).empty", "originalCommit": "1f1066ec4f8e6313f8d3969f9827de59526219f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ2ODU5MQ==", "url": "https://github.com/telstra/open-kilda/pull/3226#discussion_r382468591", "bodyText": "very true, thx. Will fix this", "author": "rtretyak", "createdAt": "2020-02-21T09:07:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQzNjE1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUzMjkwOQ==", "url": "https://github.com/telstra/open-kilda/pull/3226#discussion_r382532909", "bodyText": "fixed", "author": "rtretyak", "createdAt": "2020-02-21T11:28:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQzNjE1OA=="}], "type": "inlineReview"}, {"oid": "6be18e84afa2aefe5163693b93dc45e5b352db7e", "url": "https://github.com/telstra/open-kilda/commit/6be18e84afa2aefe5163693b93dc45e5b352db7e", "message": "Add func tests for ARP connected devices", "committedDate": "2020-02-21T11:28:01Z", "type": "forcePushed"}, {"oid": "0b97059c39d080b6caa44a3060f1566eab452d65", "url": "https://github.com/telstra/open-kilda/commit/0b97059c39d080b6caa44a3060f1566eab452d65", "message": "Add func tests for ARP connected devices", "committedDate": "2020-02-21T11:29:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUzNjAxMg==", "url": "https://github.com/telstra/open-kilda/pull/3226#discussion_r382536012", "bodyText": "nit: not quite accurate name switchLldpRules because we add ARP rules to this list", "author": "niksv", "createdAt": "2020-02-21T11:36:41Z", "path": "src-java/testing/functional-tests/src/main/groovy/org/openkilda/functionaltests/helpers/SwitchHelper.groovy", "diffHunk": "@@ -84,49 +106,53 @@ class SwitchHelper {\n         if (swProps.multiTable) {\n             multiTableRules = [MULTITABLE_PRE_INGRESS_PASS_THROUGH_COOKIE, MULTITABLE_INGRESS_DROP_COOKIE,\n                     MULTITABLE_POST_INGRESS_DROP_COOKIE, MULTITABLE_EGRESS_PASS_THROUGH_COOKIE,\n-                    MULTITABLE_TRANSIT_DROP_COOKIE, LLDP_POST_INGRESS_COOKIE, LLDP_POST_INGRESS_ONE_SWITCH_COOKIE]\n-            if (sw.features.contains(SwitchFeature.NOVIFLOW_COPY_FIELD)) {\n-                multiTableRules.add(LLDP_POST_INGRESS_VXLAN_COOKIE)\n+                    MULTITABLE_TRANSIT_DROP_COOKIE, LLDP_POST_INGRESS_COOKIE, LLDP_POST_INGRESS_ONE_SWITCH_COOKIE,\n+                    ARP_POST_INGRESS_COOKIE, ARP_POST_INGRESS_ONE_SWITCH_COOKIE]\n+            if (sw.features.contains(SwitchFeature.NOVIFLOW_PUSH_POP_VXLAN)) {\n+                multiTableRules.addAll([LLDP_POST_INGRESS_VXLAN_COOKIE, ARP_POST_INGRESS_VXLAN_COOKIE])\n             }\n             northbound.getLinks(sw.dpId, null, null, null).each {\n                 if (sw.features.contains(SwitchFeature.NOVIFLOW_COPY_FIELD)) {\n-                    multiTableRules.add(Cookie.encodeIslVxlanEgress(it.source.portNo))\n-                    multiTableRules.add(Cookie.encodeIslVxlanTransit(it.source.portNo))\n+                    multiTableRules.add(encodeIslVxlanEgress(it.source.portNo))\n+                    multiTableRules.add(encodeIslVxlanTransit(it.source.portNo))\n                 }\n-                multiTableRules.add(Cookie.encodeIslVlanEgress(it.source.portNo))\n+                multiTableRules.add(encodeIslVlanEgress(it.source.portNo))\n             }\n             northbound.getSwitchFlows(sw.dpId).each {\n                 if (it.source.datapath.equals(sw.dpId)) {\n-                    multiTableRules.add(Cookie.encodeIngressRulePassThrough(it.source.portId))\n+                    multiTableRules.add(encodeIngressRulePassThrough(it.source.portId))\n                     if (swProps.switchLldp || it.source.detectConnectedDevices.lldp) {\n-                        switchLldpRules.add(Cookie.encodeLldpInputCustomer(it.source.portId))\n+                        switchLldpRules.add(encodeLldpInputCustomer(it.source.portId))\n                     }\n                 }\n                 if (it.destination.datapath.equals(sw.dpId)) {\n-                    multiTableRules.add(Cookie.encodeIngressRulePassThrough(it.destination.portId))\n+                    multiTableRules.add(encodeIngressRulePassThrough(it.destination.portId))\n                     if (swProps.switchLldp || it.destination.detectConnectedDevices.lldp) {\n-                        switchLldpRules.add(Cookie.encodeLldpInputCustomer(it.destination.portId))\n+                        switchLldpRules.add(encodeLldpInputCustomer(it.destination.portId))\n                     }\n                 }\n             }\n         }\n         if (swProps.switchLldp) {\n             switchLldpRules.addAll([LLDP_INPUT_PRE_DROP_COOKIE, LLDP_TRANSIT_COOKIE, LLDP_INGRESS_COOKIE])\n         }\n+        if (swProps.switchArp) {\n+            switchLldpRules.addAll([ARP_INPUT_PRE_DROP_COOKIE, ARP_TRANSIT_COOKIE, ARP_INGRESS_COOKIE])", "originalCommit": "0b97059c39d080b6caa44a3060f1566eab452d65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU1MTc4Mg==", "url": "https://github.com/telstra/open-kilda/pull/3226#discussion_r382551782", "bodyText": "fixed", "author": "rtretyak", "createdAt": "2020-02-21T12:18:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUzNjAxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUzODAxMw==", "url": "https://github.com/telstra/open-kilda/pull/3226#discussion_r382538013", "bodyText": "Will be false positive in next case:\n\nswitch is in multiTable mode\nchange switch mode to single table\nFor some reasons all rules were NOT reinstalled.\n\nExpected result:\nAssertion failed\nActual result\nAssert is OK because:\nSingle table rules are a subset of multi table rules (see line 143)\nso in our case actualHexCookie = [singleTableRules + excess multi table rules]\nexpectedHexCookies = [singleTableRules]\nthat is why actualHexCookie. containsInAnyOrder(expectedHexCookie.toArray()) is OK", "author": "niksv", "createdAt": "2020-02-21T11:42:28Z", "path": "src-java/testing/functional-tests/src/main/groovy/org/openkilda/functionaltests/helpers/SwitchHelper.groovy", "diffHunk": "@@ -164,13 +190,13 @@ class SwitchHelper {\n         Wrappers.wait(Constants.RULES_INSTALLATION_TIME) {\n             def actualHexCookie = []\n             for (long cookie : northbound.getSwitchRules(sw.dpId).flowEntries*.cookie) {\n-                actualHexCookie.add(Cookie.decode(cookie).toString())\n+                actualHexCookie.add(decode(cookie).toString())\n             }\n             def expectedHexCookie = []\n             for (long cookie : sw.defaultCookies) {\n-                expectedHexCookie.add(Cookie.decode(cookie).toString())\n+                expectedHexCookie.add(decode(cookie).toString())\n             }\n-            assert actualHexCookie.sort() == expectedHexCookie.sort()\n+            assertThat actualHexCookie, containsInAnyOrder(expectedHexCookie.toArray())", "originalCommit": "0b97059c39d080b6caa44a3060f1566eab452d65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU0MDU5MQ==", "url": "https://github.com/telstra/open-kilda/pull/3226#discussion_r382540591", "bodyText": "Even though the matcher is called 'contains..', it does a full match and will complain in both cases if actual is bigger than expected or expected is bigger than actual.", "author": "rtretyak", "createdAt": "2020-02-21T11:49:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUzODAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU0NTk5OA==", "url": "https://github.com/telstra/open-kilda/pull/3226#discussion_r382545998", "bodyText": "okay", "author": "niksv", "createdAt": "2020-02-21T12:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUzODAxMw=="}], "type": "inlineReview"}, {"oid": "18ff4559d727d523ee0f5da3873d0f80eba662cb", "url": "https://github.com/telstra/open-kilda/commit/18ff4559d727d523ee0f5da3873d0f80eba662cb", "message": "Add func tests for ARP connected devices", "committedDate": "2020-02-21T11:55:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUzNjM0Mw==", "url": "https://github.com/telstra/open-kilda/pull/3226#discussion_r382536343", "bodyText": "2020", "author": "andriidovhan", "createdAt": "2020-02-21T11:37:43Z", "path": "src-java/testing/test-library/src/main/java/org/openkilda/testing/service/traffexam/model/ArpData.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/* Copyright 2019 Telstra Open Source", "originalCommit": "0b97059c39d080b6caa44a3060f1566eab452d65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUzNzQ4MA==", "url": "https://github.com/telstra/open-kilda/pull/3226#discussion_r382537480", "bodyText": "How about sending just swProps instead of three parameters?", "author": "andriidovhan", "createdAt": "2020-02-21T11:41:00Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/switches/DefaultRulesValidationSpec.groovy", "diffHunk": "@@ -41,7 +55,50 @@ class DefaultRulesValidationSpec extends HealthCheckSpecification {\n             rules.proper.sort() == sw.defaultCookies.sort()\n         }\n \n-        where: \"Run for all unique switches\"\n-        sw << getTopology().getActiveSwitches().unique { activeSw -> activeSw.description }\n+        cleanup: \"Restore original switch props\"\n+        switchHelper.updateSwitchProperties(sw, originalProps)\n+\n+        where: \"Run for all combinations of unique switches and switch modes\"\n+        [swProps, sw] <<\n+                [[\n+                    [\n+                        multiTable: false,\n+                        switchLldp: false,\n+                        switchArp: false\n+                    ],\n+\n+                    [\n+                        multiTable: true,\n+                        switchLldp: false,\n+                        switchArp: false\n+                    ],\n+                    [\n+                        multiTable: true,\n+                        switchLldp: true,\n+                        switchArp: true\n+                    ]\n+                ], getTopology().getActiveSwitches().unique { activeSw -> activeSw.description }\n+                ].combinations().findAll { Map swProp, Switch _sw ->\n+                    //filter out combinations where we pick non-multitable switch and do multitable switch props\n+                    !(swProp.multiTable && !_sw.features.contains(SwitchFeature.MULTI_TABLE))\n+                }\n+        propsDescr = getDescr(swProps.multiTable, swProps.switchLldp, swProps.switchArp)\n+    }\n+\n+    String getDescr(boolean multitable, boolean lldp, boolean arp) {", "originalCommit": "0b97059c39d080b6caa44a3060f1566eab452d65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU1MDU2Nw==", "url": "https://github.com/telstra/open-kilda/pull/3226#discussion_r382550567", "bodyText": "Any arguments?", "author": "rtretyak", "createdAt": "2020-02-21T12:14:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUzNzQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU2NDc4NA==", "url": "https://github.com/telstra/open-kilda/pull/3226#discussion_r382564784", "bodyText": "All passed parameters can be taken from the same object.\nSo, I strongly believe it is easier to pass an object only.\nIn addition you don't need to remember the correct order of passed arguments.", "author": "andriidovhan", "createdAt": "2020-02-21T12:51:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUzNzQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU4NzU0OQ==", "url": "https://github.com/telstra/open-kilda/pull/3226#discussion_r382587549", "bodyText": "My thought process is: Your option is 'not safe'. You have to 'remember' the key names and do not get any suggestions from the IDE. It is not type-safe as well. I prefer not to spread dynamic code across the place and get rid of it as soon as possible, since any typo will only be caught during runtime.\nI understand that we pass the same map to the test itself, but I would happily use custom classes(like ConnectedDeviceTestData in ConnectedDevicesSpec) if it didn't require additional coding. And I would be happy to pass a strongly-typed object here as a param. I would also may have considered using map if we had too many params to pass(but its only 3 here).\nSo you gave only 1 argument: ' you don't need remember the order of passed arguments'. Nobody have to 'remember' it, it is the method signature, order will always be suggested by the IDE..unlike remembering keys of your map.\nDon't get me wrong, I see your suggestion as an option and don't think its bad, but unless you give more arguments I don't see real reasons to change current code. It's just different", "author": "rtretyak", "createdAt": "2020-02-21T13:44:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUzNzQ4MA=="}], "type": "inlineReview"}, {"oid": "61801943926768ea09125ac1390b590efa288155", "url": "https://github.com/telstra/open-kilda/commit/61801943926768ea09125ac1390b590efa288155", "message": "Add func tests for ARP connected devices", "committedDate": "2020-02-21T15:04:39Z", "type": "forcePushed"}, {"oid": "c9e850c2ee2aa265781e9f4de2e0a127ee4c9960", "url": "https://github.com/telstra/open-kilda/commit/c9e850c2ee2aa265781e9f4de2e0a127ee4c9960", "message": "Add func tests for ARP connected devices", "committedDate": "2020-02-24T09:22:55Z", "type": "forcePushed"}, {"oid": "684f8fc04d03339faa74b4f3be5113c6ac12becf", "url": "https://github.com/telstra/open-kilda/commit/684f8fc04d03339faa74b4f3be5113c6ac12becf", "message": "Add func tests for ARP connected devices", "committedDate": "2020-03-02T13:36:02Z", "type": "forcePushed"}, {"oid": "9fb3230c9aaf8315aca2321e4de7a2b6364619cc", "url": "https://github.com/telstra/open-kilda/commit/9fb3230c9aaf8315aca2321e4de7a2b6364619cc", "message": "Add func tests for ARP connected devices", "committedDate": "2020-03-05T10:30:30Z", "type": "commit"}, {"oid": "9fb3230c9aaf8315aca2321e4de7a2b6364619cc", "url": "https://github.com/telstra/open-kilda/commit/9fb3230c9aaf8315aca2321e4de7a2b6364619cc", "message": "Add func tests for ARP connected devices", "committedDate": "2020-03-05T10:30:30Z", "type": "forcePushed"}]}