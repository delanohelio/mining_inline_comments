{"pr_number": 3425, "pr_title": "Add test for switch failure during swap endpoints", "pr_createdAt": "2020-04-28T10:46:33Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3425", "timeline": [{"oid": "e69b066610162e09beeb0bcbe65f6c0af9176f64", "url": "https://github.com/telstra/open-kilda/commit/e69b066610162e09beeb0bcbe65f6c0af9176f64", "message": "Add test for switch failure during swap endpoints", "committedDate": "2020-04-28T11:18:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg1Mzc3OQ==", "url": "https://github.com/telstra/open-kilda/pull/3425#discussion_r417853779", "bodyText": "if swPair is not found then this test will be failed\nprobably would be better to use  assumeTrue", "author": "andriidovhan", "createdAt": "2020-04-30T08:47:36Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/SwapEndpointSpec.groovy", "diffHunk": "@@ -1142,6 +1142,76 @@ switches\"() {\n         ]\n     }\n \n+    def \"System reverts both flows if fails during rule installation when swapping endpoints\"() {\n+        given: \"Two flows with different src switches and same dst\"\n+        def swPair1\n+        def swPair2 = topologyHelper.switchPairs.find { second ->\n+            swPair1 = topologyHelper.switchPairs.find { first ->\n+                first.src != second.src && first.dst == second.dst\n+            }\n+        }\n+        assert swPair1\n+        assert swPair2", "originalCommit": "e69b066610162e09beeb0bcbe65f6c0af9176f64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg1NTM2NA==", "url": "https://github.com/telstra/open-kilda/pull/3425#discussion_r417855364", "bodyText": "@Tidy ?", "author": "andriidovhan", "createdAt": "2020-04-30T08:50:16Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/SwapEndpointSpec.groovy", "diffHunk": "@@ -1142,6 +1142,76 @@ switches\"() {\n         ]\n     }\n \n+    def \"System reverts both flows if fails during rule installation when swapping endpoints\"() {", "originalCommit": "e69b066610162e09beeb0bcbe65f6c0af9176f64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg1ODM0Ng==", "url": "https://github.com/telstra/open-kilda/pull/3425#discussion_r417858346", "bodyText": "500 InternalServerError\nis it expected ?\nit seems to be an issue", "author": "andriidovhan", "createdAt": "2020-04-30T08:55:11Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/SwapEndpointSpec.groovy", "diffHunk": "@@ -1142,6 +1142,76 @@ switches\"() {\n         ]\n     }\n \n+    def \"System reverts both flows if fails during rule installation when swapping endpoints\"() {\n+        given: \"Two flows with different src switches and same dst\"\n+        def swPair1\n+        def swPair2 = topologyHelper.switchPairs.find { second ->\n+            swPair1 = topologyHelper.switchPairs.find { first ->\n+                first.src != second.src && first.dst == second.dst\n+            }\n+        }\n+        assert swPair1\n+        assert swPair2\n+        def flow1 = flowHelperV2.randomFlow(swPair1).tap {\n+            it.source.portNumber = getFreePort(swPair1.src, [swPair2.src])\n+        }\n+        def flow2 = flowHelperV2.randomFlow(swPair2).tap {\n+            it.source.portNumber = getFreePort(swPair2.src, [swPair1.src])\n+        }\n+        flowHelperV2.addFlow(flow1)\n+        flowHelperV2.addFlow(flow2)\n+\n+        when: \"Try to swap flow src endoints, but flow1 src switch does not respond\"\n+        def blockData = switchHelper.knockoutSwitch(swPair1.src, mgmtFlManager)\n+        database.setSwitchStatus(swPair1.src.dpId, SwitchStatus.ACTIVE)\n+        northbound.swapFlowEndpoint(new SwapFlowPayload(flow1.flowId, flow2.source, flow1.destination),\n+                new SwapFlowPayload(flow2.flowId, flow1.source, flow2.destination))\n+\n+        then: \"Receive error response\"\n+        def exc = thrown(HttpServerErrorException)\n+        exc.rawStatusCode == 500", "originalCommit": "e69b066610162e09beeb0bcbe65f6c0af9176f64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg1OTY1Mw==", "url": "https://github.com/telstra/open-kilda/pull/3425#discussion_r417859653", "bodyText": "delete -> Delete", "author": "andriidovhan", "createdAt": "2020-04-30T08:57:15Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/SwapEndpointSpec.groovy", "diffHunk": "@@ -1142,6 +1142,76 @@ switches\"() {\n         ]\n     }\n \n+    def \"System reverts both flows if fails during rule installation when swapping endpoints\"() {\n+        given: \"Two flows with different src switches and same dst\"\n+        def swPair1\n+        def swPair2 = topologyHelper.switchPairs.find { second ->\n+            swPair1 = topologyHelper.switchPairs.find { first ->\n+                first.src != second.src && first.dst == second.dst\n+            }\n+        }\n+        assert swPair1\n+        assert swPair2\n+        def flow1 = flowHelperV2.randomFlow(swPair1).tap {\n+            it.source.portNumber = getFreePort(swPair1.src, [swPair2.src])\n+        }\n+        def flow2 = flowHelperV2.randomFlow(swPair2).tap {\n+            it.source.portNumber = getFreePort(swPair2.src, [swPair1.src])\n+        }\n+        flowHelperV2.addFlow(flow1)\n+        flowHelperV2.addFlow(flow2)\n+\n+        when: \"Try to swap flow src endoints, but flow1 src switch does not respond\"\n+        def blockData = switchHelper.knockoutSwitch(swPair1.src, mgmtFlManager)\n+        database.setSwitchStatus(swPair1.src.dpId, SwitchStatus.ACTIVE)\n+        northbound.swapFlowEndpoint(new SwapFlowPayload(flow1.flowId, flow2.source, flow1.destination),\n+                new SwapFlowPayload(flow2.flowId, flow1.source, flow2.destination))\n+\n+        then: \"Receive error response\"\n+        def exc = thrown(HttpServerErrorException)\n+        exc.rawStatusCode == 500\n+        def error = exc.responseBodyAsString.to(MessageError)\n+        error.errorMessage == \"Could not swap endpoints\"\n+        error.errorDescription == sprintf(\"Reverted flows: [%s, %s]\", flow2.flowId, flow1.flowId)\n+\n+        and: \"First flow is reverted to Down\"\n+        Wrappers.wait(PATH_INSTALLATION_TIME) {\n+            assert northboundV2.getFlowStatus(flow1.flowId).status == FlowState.DOWN\n+        }\n+        with(northboundV2.getFlow(flow1.flowId)) {\n+            source == flow1.source\n+            destination == flow1.destination\n+        }\n+\n+        and: \"Second flow is reverted to UP\"\n+        Wrappers.wait(PATH_INSTALLATION_TIME) {\n+            assert northboundV2.getFlowStatus(flow2.flowId).status == FlowState.UP\n+        }\n+        with(northboundV2.getFlow(flow2.flowId)) {\n+            source == flow2.source\n+            destination == flow2.destination\n+        }\n+\n+        when: \"delete both flows\"", "originalCommit": "e69b066610162e09beeb0bcbe65f6c0af9176f64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2d26510dda9c06d79951836323504689308f79f9", "url": "https://github.com/telstra/open-kilda/commit/2d26510dda9c06d79951836323504689308f79f9", "message": "Add test for switch failure during swap endpoints", "committedDate": "2020-05-04T08:28:12Z", "type": "forcePushed"}, {"oid": "79a3ec0e99b3c7b9b61c4d7f52141629f3b059fc", "url": "https://github.com/telstra/open-kilda/commit/79a3ec0e99b3c7b9b61c4d7f52141629f3b059fc", "message": "Add test for switch failure during swap endpoints", "committedDate": "2020-05-04T13:58:52Z", "type": "commit"}, {"oid": "79a3ec0e99b3c7b9b61c4d7f52141629f3b059fc", "url": "https://github.com/telstra/open-kilda/commit/79a3ec0e99b3c7b9b61c4d7f52141629f3b059fc", "message": "Add test for switch failure during swap endpoints", "committedDate": "2020-05-04T13:58:52Z", "type": "forcePushed"}]}