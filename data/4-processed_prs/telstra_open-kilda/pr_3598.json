{"pr_number": 3598, "pr_title": "On reroute failure retry it with ignore bw", "pr_createdAt": "2020-07-05T12:15:53Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3598", "timeline": [{"oid": "8d68082e5b94c4e638ece115432387a01d9e1975", "url": "https://github.com/telstra/open-kilda/commit/8d68082e5b94c4e638ece115432387a01d9e1975", "message": "On reroute failure retry it with ignore bw", "committedDate": "2020-07-05T12:53:17Z", "type": "forcePushed"}, {"oid": "0596f8b5420d405bc92360fcf3bc5ea537415e67", "url": "https://github.com/telstra/open-kilda/commit/0596f8b5420d405bc92360fcf3bc5ea537415e67", "message": "Various improvements and test updates", "committedDate": "2020-07-07T13:59:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg5MTIxNw==", "url": "https://github.com/telstra/open-kilda/pull/3598#discussion_r450891217", "bodyText": "no 'both flows' here", "author": "rtretyak", "createdAt": "2020-07-07T14:06:28Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteV2Spec.groovy", "diffHunk": "@@ -603,12 +610,26 @@ class AutoRerouteV2Spec extends HealthCheckSpecification {\n         def switchToManipulate = topology.activeSwitches.find { !(it.dpId in involvedSwitches) }\n         def blockData = switchHelper.knockoutSwitch(switchToManipulate, mgmtFlManager)\n         def isSwitchActivated = false\n+        wait(WAIT_OFFSET) {\n+            def prevHistorySize = northbound.getFlowHistory(flow.flowId).size()\n+            Wrappers.timedLoop(4) {\n+                //history size should no longer change for both flows, all retries should give up", "originalCommit": "0596f8b5420d405bc92360fcf3bc5ea537415e67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg5MTcyMw==", "url": "https://github.com/telstra/open-kilda/pull/3598#discussion_r450891723", "bodyText": "withPool can be removed. It is a wrapper that allows parallel operations like 'eachParallel'", "author": "rtretyak", "createdAt": "2020-07-07T14:07:09Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteV2Spec.groovy", "diffHunk": "@@ -603,12 +610,26 @@ class AutoRerouteV2Spec extends HealthCheckSpecification {\n         def switchToManipulate = topology.activeSwitches.find { !(it.dpId in involvedSwitches) }\n         def blockData = switchHelper.knockoutSwitch(switchToManipulate, mgmtFlManager)\n         def isSwitchActivated = false\n+        wait(WAIT_OFFSET) {\n+            def prevHistorySize = northbound.getFlowHistory(flow.flowId).size()\n+            Wrappers.timedLoop(4) {\n+                //history size should no longer change for both flows, all retries should give up\n+                def newHistorySize = northbound.getFlowHistory(flow.flowId).size()\n+                assert newHistorySize == prevHistorySize\n+                withPool {", "originalCommit": "0596f8b5420d405bc92360fcf3bc5ea537415e67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg5NDMwNQ==", "url": "https://github.com/telstra/open-kilda/pull/3598#discussion_r450894305", "bodyText": "I think its safer to save the timestamp before calling reviveSwitch", "author": "rtretyak", "createdAt": "2020-07-07T14:10:37Z", "path": "src-java/testing/functional-tests/src/test/groovy/org/openkilda/functionaltests/spec/flows/AutoRerouteV2Spec.groovy", "diffHunk": "@@ -603,12 +610,26 @@ class AutoRerouteV2Spec extends HealthCheckSpecification {\n         def switchToManipulate = topology.activeSwitches.find { !(it.dpId in involvedSwitches) }\n         def blockData = switchHelper.knockoutSwitch(switchToManipulate, mgmtFlManager)\n         def isSwitchActivated = false\n+        wait(WAIT_OFFSET) {\n+            def prevHistorySize = northbound.getFlowHistory(flow.flowId).size()\n+            Wrappers.timedLoop(4) {\n+                //history size should no longer change for both flows, all retries should give up\n+                def newHistorySize = northbound.getFlowHistory(flow.flowId).size()\n+                assert newHistorySize == prevHistorySize\n+                withPool {\n+                    assert northbound.getFlowStatus(flow.flowId).status == FlowState.DOWN\n+                }\n+            sleep(500)\n+            }\n+        }\n         switchHelper.reviveSwitch(switchToManipulate, blockData)\n+        def expectedZeroReroutesTimestamp = System.currentTimeSeconds()", "originalCommit": "0596f8b5420d405bc92360fcf3bc5ea537415e67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9a109361e58b17c563a5b1ef089384346fd60af8", "url": "https://github.com/telstra/open-kilda/commit/9a109361e58b17c563a5b1ef089384346fd60af8", "message": "Various improvements and test updates", "committedDate": "2020-07-07T18:20:14Z", "type": "forcePushed"}, {"oid": "bd5a2fbc903bd7854244a4b73339522528bedefb", "url": "https://github.com/telstra/open-kilda/commit/bd5a2fbc903bd7854244a4b73339522528bedefb", "message": "Various improvements and test updates", "committedDate": "2020-07-07T18:54:38Z", "type": "forcePushed"}, {"oid": "dd3c555301659f75ebbf33e9fc19192ae218935e", "url": "https://github.com/telstra/open-kilda/commit/dd3c555301659f75ebbf33e9fc19192ae218935e", "message": "Various improvements and test updates", "committedDate": "2020-07-07T20:06:08Z", "type": "forcePushed"}, {"oid": "b43b1fcbedbf7d000280b4ea6d6a5ecbe0209014", "url": "https://github.com/telstra/open-kilda/commit/b43b1fcbedbf7d000280b4ea6d6a5ecbe0209014", "message": "Various improvements and test updates", "committedDate": "2020-07-07T21:16:33Z", "type": "forcePushed"}, {"oid": "6d2094b9aeded74275c2c93e7805f797fc6660b2", "url": "https://github.com/telstra/open-kilda/commit/6d2094b9aeded74275c2c93e7805f797fc6660b2", "message": "Various improvements and test updates", "committedDate": "2020-07-08T05:47:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMxMzY5OA==", "url": "https://github.com/telstra/open-kilda/pull/3598#discussion_r451313698", "bodyText": "In the current implementation, we have DEGRADED status only when we could not find the protected path. But in this case, this status is set for another reason. Therefore, the message Couldn't find non overlapping protected path in status_info will be incorrect.", "author": "dpoltavets", "createdAt": "2020-07-08T06:34:20Z", "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/fsm/reroute/actions/UpdateFlowStatusAction.java", "diffHunk": "@@ -48,6 +48,9 @@ protected void perform(State from, State to, Event event, FlowRerouteContext con\n         FlowStatus resultStatus = persistenceManager.getTransactionManager().doInTransaction(() -> {\n             Flow flow = getFlow(flowId, FetchStrategy.DIRECT_RELATIONS);\n             FlowStatus flowStatus = flow.computeFlowStatus();\n+            if (stateMachine.isIgnoreBandwidth() && flowStatus == FlowStatus.UP) {\n+                flowStatus = FlowStatus.DEGRADED;", "originalCommit": "6d2094b9aeded74275c2c93e7805f797fc6660b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMxODU1NA==", "url": "https://github.com/telstra/open-kilda/pull/3598#discussion_r451318554", "bodyText": "good catch, haven't seen this before rebase, fixed", "author": "timofei-durakov", "createdAt": "2020-07-08T06:47:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMxMzY5OA=="}], "type": "inlineReview"}, {"oid": "645d4013a8930f5ea5b92cc3cf29171b693b435d", "url": "https://github.com/telstra/open-kilda/commit/645d4013a8930f5ea5b92cc3cf29171b693b435d", "message": "Various improvements and test updates", "committedDate": "2020-07-08T06:45:42Z", "type": "forcePushed"}, {"oid": "289be26c2aa858cbaa6e4d07c33d3e00fcfcc533", "url": "https://github.com/telstra/open-kilda/commit/289be26c2aa858cbaa6e4d07c33d3e00fcfcc533", "message": "Various improvements and test updates", "committedDate": "2020-07-08T09:42:43Z", "type": "forcePushed"}, {"oid": "be7295cd646a0048406c7c8309e6ca2f2023aa98", "url": "https://github.com/telstra/open-kilda/commit/be7295cd646a0048406c7c8309e6ca2f2023aa98", "message": "Various improvements and test updates", "committedDate": "2020-07-08T14:47:58Z", "type": "forcePushed"}, {"oid": "baf67ae484277ba2cec52033acc36a84a9edb91f", "url": "https://github.com/telstra/open-kilda/commit/baf67ae484277ba2cec52033acc36a84a9edb91f", "message": "Various improvements and test updates", "committedDate": "2020-07-08T16:47:14Z", "type": "forcePushed"}, {"oid": "90dfa93e620265efdd291010859ae1b426b2753a", "url": "https://github.com/telstra/open-kilda/commit/90dfa93e620265efdd291010859ae1b426b2753a", "message": "Various improvements and test updates", "committedDate": "2020-07-08T18:43:21Z", "type": "forcePushed"}, {"oid": "16ffac48dab86bdb5e555b107157d651f5b5de60", "url": "https://github.com/telstra/open-kilda/commit/16ffac48dab86bdb5e555b107157d651f5b5de60", "message": "Various improvements and test updates", "committedDate": "2020-07-09T04:58:44Z", "type": "forcePushed"}, {"oid": "e1d4f8797206aa5641de0778b35ec23c4dfc5178", "url": "https://github.com/telstra/open-kilda/commit/e1d4f8797206aa5641de0778b35ec23c4dfc5178", "message": "Various improvements and test updates", "committedDate": "2020-07-09T08:06:58Z", "type": "forcePushed"}, {"oid": "f3243ac163eae9b654d40c0157696ee35acc8d3a", "url": "https://github.com/telstra/open-kilda/commit/f3243ac163eae9b654d40c0157696ee35acc8d3a", "message": "Degraded flows caused by overprovision react on switch up events", "committedDate": "2020-07-09T12:00:04Z", "type": "forcePushed"}, {"oid": "471ed813dcfbf303480abe3e26b416e1aa0158dc", "url": "https://github.com/telstra/open-kilda/commit/471ed813dcfbf303480abe3e26b416e1aa0158dc", "message": "Degraded flows caused by overprovision react on switch up events", "committedDate": "2020-07-09T18:54:19Z", "type": "forcePushed"}, {"oid": "4c1fb74dbefde7153417503d2ff9c90410cd3556", "url": "https://github.com/telstra/open-kilda/commit/4c1fb74dbefde7153417503d2ff9c90410cd3556", "message": "Degraded flows caused by overprovision react on switch up events", "committedDate": "2020-07-10T09:06:03Z", "type": "forcePushed"}, {"oid": "46a6a23dc2455845797a7b3d517a701a656b039c", "url": "https://github.com/telstra/open-kilda/commit/46a6a23dc2455845797a7b3d517a701a656b039c", "message": "On reroute failure retry it with ignore bw", "committedDate": "2020-07-10T09:15:36Z", "type": "commit"}, {"oid": "65fece4201835eb75ae7f200bf32a877c40069bb", "url": "https://github.com/telstra/open-kilda/commit/65fece4201835eb75ae7f200bf32a877c40069bb", "message": "Update autoreroute test to properly wait for a final 'down' status", "committedDate": "2020-07-10T09:15:36Z", "type": "commit"}, {"oid": "04132059dfdec63bd6a9c42c7f1858b85aaa353a", "url": "https://github.com/telstra/open-kilda/commit/04132059dfdec63bd6a9c42c7f1858b85aaa353a", "message": "Various improvements and test updates", "committedDate": "2020-07-10T09:17:37Z", "type": "commit"}, {"oid": "c443d42fcfbf664da2f2171bc0f79f3b9ca11388", "url": "https://github.com/telstra/open-kilda/commit/c443d42fcfbf664da2f2171bc0f79f3b9ca11388", "message": "Degraded flows caused by overprovision react on switch up events", "committedDate": "2020-07-10T09:17:44Z", "type": "commit"}, {"oid": "c443d42fcfbf664da2f2171bc0f79f3b9ca11388", "url": "https://github.com/telstra/open-kilda/commit/c443d42fcfbf664da2f2171bc0f79f3b9ca11388", "message": "Degraded flows caused by overprovision react on switch up events", "committedDate": "2020-07-10T09:17:44Z", "type": "forcePushed"}]}