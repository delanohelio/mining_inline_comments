{"pr_number": 3907, "pr_title": "Added zero downtime producers", "pr_createdAt": "2020-12-07T08:28:03Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3907", "timeline": [{"oid": "6dcc9a5c392123ae66f94c67c9718e8310b8affb", "url": "https://github.com/telstra/open-kilda/commit/6dcc9a5c392123ae66f94c67c9718e8310b8affb", "message": "Added messaging versioning for Kafka Producers", "committedDate": "2020-12-07T09:19:07Z", "type": "forcePushed"}, {"oid": "5c9c909a65e2d5d3223f2733edc1470151271647", "url": "https://github.com/telstra/open-kilda/commit/5c9c909a65e2d5d3223f2733edc1470151271647", "message": "Added messaging versioning for Kafka Producers", "committedDate": "2020-12-08T11:44:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA4NzMxNg==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539087316", "bodyText": "I thought run-id is for the whole project global, not specific service.", "author": "surabujin", "createdAt": "2020-12-09T08:04:06Z", "path": "confd/vars/main.yaml", "diffHunk": "@@ -176,10 +176,14 @@ kilda_server42_control_switch_to_vlan_1003: \"1003=00:00:00:00:00:00:00:03\"\n \n kilda_server42_control_kafka_group_id: \"server42-control\"\n kilda_server42_control_zeromq_connection_host: \"tcp://server42-server-stub.pendev:5555\"\n+kilda_server42_control_component_name: \"server42-control\"\n+kilda_server42_control_run_id: \"server42-control-run-id\"", "originalCommit": "5c9c909a65e2d5d3223f2733edc1470151271647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkwNjk0Mw==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539906943", "bodyText": "In generally yes. but\n\nwe need run_id property for each component to switch them one by one\nserver42 control is a special case. It's out of Kilda so we wouldn't rut two version of server42 right now.", "author": "niksv", "createdAt": "2020-12-10T06:49:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA4NzMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA5ODk1OA==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539098958", "bodyText": "why different approaches for different options i.e. .setProperty() and .put() ?", "author": "surabujin", "createdAt": "2020-12-09T08:21:09Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/topology/AbstractTopology.java", "diffHunk": "@@ -168,12 +174,26 @@ protected static int handleLaunchException(Exception error) {\n         return errorCode;\n     }\n \n+    /**\n+     * //TODO(zero_down_time) Remove when zero down time feature will be completed.\n+     *\n+     * @deprecated use getKafkaProducerProperties with parameters (component name, run id)\n+     */\n+    @Deprecated\n     private Properties getKafkaProducerProperties() {\n+        return getKafkaProducerProperties(COMMON_COMPONENT_NAME, COMMON_COMPONENT_RUN_ID);\n+    }\n+\n+    private Properties getKafkaProducerProperties(String componentName, String runId) {\n         Properties kafka = new Properties();\n \n         kafka.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());\n         kafka.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());\n         kafka.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, kafkaConfig.getHosts());\n+        kafka.setProperty(ProducerConfig.INTERCEPTOR_CLASSES_CONFIG, VersioningProducerInterceptor.class.getName());\n+        kafka.put(PRODUCER_COMPONENT_NAME_PROPERTY, componentName);", "originalCommit": "5c9c909a65e2d5d3223f2733edc1470151271647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0NzgzNw==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539847837", "bodyText": "setProperty accepts Strings. put accepts Objects. Some of these properties used to be a integer numbers, but now all of them are string. So we can use setProperty for everything.\nFixed", "author": "niksv", "createdAt": "2020-12-10T05:04:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA5ODk1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwNTQ2NQ==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539105465", "bodyText": "buildKafkaBolt createKafkaBolt makeKafkaBolt ... can we choose one name and migrate everything on it.", "author": "surabujin", "createdAt": "2020-12-09T08:31:34Z", "path": "src-java/base-topology/base-storm-topology/src/main/java/org/openkilda/wfm/topology/AbstractTopology.java", "diffHunk": "@@ -292,6 +312,17 @@ public final T getConfig() {\n         return makeKafkaBolt(topic, MessageSerializer.class);\n     }\n \n+    /**\n+     * Creates Kafka bolt, that uses {@link MessageSerializer} in order to serialize an object.\n+     *\n+     * @param topic Kafka topic\n+     * @return {@link KafkaBolt}\n+     */\n+    protected KafkaBolt<String, Message> buildKafkaBolt(", "originalCommit": "5c9c909a65e2d5d3223f2733edc1470151271647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0ODY5Mw==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539848693", "bodyText": "agree, looks like zoo. But I just overloaded existing methods", "author": "niksv", "createdAt": "2020-12-10T05:07:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwNTQ2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwNzMxNA==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539107314", "bodyText": "weird comment", "author": "surabujin", "createdAt": "2020-12-09T08:34:35Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkClient.java", "diffHunk": "@@ -73,10 +73,14 @@ protected ZooKeeper getZk() throws IOException {\n     }\n \n     protected void ensureZNode(String... path) throws KeeperException, InterruptedException {\n+        ensureZNode(new byte[0], path); // set empty value", "originalCommit": "5c9c909a65e2d5d3223f2733edc1470151271647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0ODEyNg==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539848126", "bodyText": "fixed", "author": "niksv", "createdAt": "2020-12-10T05:05:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwNzMxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTExMTU3OQ==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539111579", "bodyText": "This way setting of default value looks extremely dangerous. I would like to handle the missing node in a correct way than such default values enforcing.", "author": "surabujin", "createdAt": "2020-12-09T08:41:09Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkWatchDog.java", "diffHunk": "@@ -65,7 +67,7 @@ public ZkWatchDog(String id, String serviceName, String connectionString,\n     void validateNodes() throws KeeperException, InterruptedException {\n         super.validateNodes();\n         ensureZNode(serviceName, id, SIGNAL);\n-        ensureZNode(serviceName, id, BUILD_VERSION);\n+        ensureZNode(DEFAULT_BUILD_VERSION.getBytes(), serviceName, id, BUILD_VERSION);", "originalCommit": "5c9c909a65e2d5d3223f2733edc1470151271647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkxNTgyMA==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539915820", "bodyText": "Could you please describe how it should create a default value?", "author": "niksv", "createdAt": "2020-12-10T07:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTExMTU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEyNDYzMQ==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539124631", "bodyText": "contract violation - the caller will never know that close() request has failed and will unable to make more close attempts.", "author": "surabujin", "createdAt": "2020-12-09T09:00:10Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkWatchDog.java", "diffHunk": "@@ -169,4 +171,24 @@ protected void notifyBuildVersionObservers() {\n             observer.handle(buildVersion);\n         }\n     }\n+\n+    @Override\n+    public void close() {\n+        if (!observers.isEmpty()) {\n+            log.error(\"Could not close connection to zookeeper {}. Watch dog still have {} life cycle observers\",\n+                    connectionString, observers.size());\n+            return;", "originalCommit": "5c9c909a65e2d5d3223f2733edc1470151271647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg1MTc0Ng==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539851746", "bodyText": "fixed", "author": "niksv", "createdAt": "2020-12-10T05:16:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEyNDYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEyNTg4OA==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539125888", "bodyText": "... python approaches? But java's exceptions are heavy in comparison to the pythons.", "author": "surabujin", "createdAt": "2020-12-09T09:02:00Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/kafka/Utils.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.bluegreen.kafka;\n+\n+import java.util.Map;\n+\n+public final class Utils {\n+    private Utils() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    // TODO(zero_down_time) remove when Zero Down Time feature will be implemented\n+    public static final String COMMON_COMPONENT_NAME = \"common_component\";\n+    // TODO(zero_down_time) remove when Zero Down Time feature will be implemented\n+    public static final String COMMON_COMPONENT_RUN_ID = \"common_run_id\";\n+\n+    /**\n+     * Kafka message header to specify message version.\n+     */\n+    public static final String MESSAGE_VERSION_HEADER = \"kafka.message.version.header\";\n+    /**\n+     * Property name for Kafka producer to specify component name for producer interceptor.\n+     */\n+    public static final String PRODUCER_COMPONENT_NAME_PROPERTY = \"kafka.producer.messaging.component.name.property\";\n+    /**\n+     * Property name for Kafka producer to specify run ID for producer interceptor.\n+     */\n+    public static final String PRODUCER_RUN_ID_PROPERTY = \"kafka.producer.messaging.run.id.property\";\n+    /**\n+     * Property name for Kafka producer to specify zookeeper connection string.\n+     */\n+    public static final String PRODUCER_ZOOKEEPER_CONNECTION_STRING_PROPERTY =\n+            \"kafka.producer.messaging.zookeeper.connecting.string.property\";\n+\n+    /**\n+     * Returns value from map by key, throws exception otherwise.\n+     *\n+     * @param map map with keys and values\n+     * @param key key\n+     * @param clazz value will be cast to this class\n+     * @return value cast to the clazz\n+     */\n+    public static <T> T getValue(Map<String, ?> map, String key, Class<T> clazz) {", "originalCommit": "5c9c909a65e2d5d3223f2733edc1470151271647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkxNjc5NA==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539916794", "bodyText": "okay. How I should check that key is in map, get it or signalize about missed prop?", "author": "niksv", "createdAt": "2020-12-10T07:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEyNTg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEyODAxMQ==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539128011", "bodyText": "do not include not logic into a getter, better apply it it's result. At least it will fix this ugly name. Also, it can help to simplify the whole usage logic.", "author": "surabujin", "createdAt": "2020-12-09T09:05:06Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/kafka/interceptors/VersioningInterceptorBase.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.bluegreen.kafka.interceptors;\n+\n+import static java.lang.String.format;\n+\n+import org.openkilda.bluegreen.BuildVersionObserver;\n+import org.openkilda.bluegreen.ZkWatchDog;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.io.IOException;\n+import java.time.Instant;\n+import java.time.temporal.ChronoUnit;\n+\n+@Slf4j\n+public abstract class VersioningInterceptorBase implements BuildVersionObserver {\n+    public static final int VERSION_IS_NOT_SET_LOG_TIMEOUT = 60;\n+    public static final int CANT_CONNECT_TO_ZOOKEEPER_LOG_TIMEOUT = 60;\n+\n+    protected String connectionString;\n+    protected ZkWatchDog watchDog;\n+    protected String componentName;\n+    protected String runId;\n+    protected Instant versionIsNotSetTimestamp = Instant.MIN;\n+    protected Instant cantConnectToZooKeeperTimestamp = Instant.MIN;\n+    protected volatile byte[] version;\n+\n+    protected boolean isVersionIsNotTimeoutPassed() {", "originalCommit": "5c9c909a65e2d5d3223f2733edc1470151271647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg1MTc5NQ==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539851795", "bodyText": "renamed", "author": "niksv", "createdAt": "2020-12-10T05:17:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEyODAxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEyODg2Ng==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539128866", "bodyText": "canRetryZookeeperConnect() ?", "author": "surabujin", "createdAt": "2020-12-09T09:06:20Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/kafka/interceptors/VersioningInterceptorBase.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.bluegreen.kafka.interceptors;\n+\n+import static java.lang.String.format;\n+\n+import org.openkilda.bluegreen.BuildVersionObserver;\n+import org.openkilda.bluegreen.ZkWatchDog;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.io.IOException;\n+import java.time.Instant;\n+import java.time.temporal.ChronoUnit;\n+\n+@Slf4j\n+public abstract class VersioningInterceptorBase implements BuildVersionObserver {\n+    public static final int VERSION_IS_NOT_SET_LOG_TIMEOUT = 60;\n+    public static final int CANT_CONNECT_TO_ZOOKEEPER_LOG_TIMEOUT = 60;\n+\n+    protected String connectionString;\n+    protected ZkWatchDog watchDog;\n+    protected String componentName;\n+    protected String runId;\n+    protected Instant versionIsNotSetTimestamp = Instant.MIN;\n+    protected Instant cantConnectToZooKeeperTimestamp = Instant.MIN;\n+    protected volatile byte[] version;\n+\n+    protected boolean isVersionIsNotTimeoutPassed() {\n+        return versionIsNotSetTimestamp.plus(VERSION_IS_NOT_SET_LOG_TIMEOUT, ChronoUnit.SECONDS)\n+                .isBefore(Instant.now());\n+    }\n+\n+    protected boolean isCantConnectToZooKeeperTimeoutPassed() {", "originalCommit": "5c9c909a65e2d5d3223f2733edc1470151271647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg0OTQ4Mw==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539849483", "bodyText": "renamed both methods", "author": "niksv", "createdAt": "2020-12-10T05:09:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEyODg2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEzMjc5MQ==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539132791", "bodyText": "You do not check actual connect results. Is it ok? Should we have something like isVersionUsable() and use it instead of null comparison? It can take into account ZK connection status too.", "author": "surabujin", "createdAt": "2020-12-09T09:11:42Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/kafka/interceptors/VersioningProducerInterceptor.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.bluegreen.kafka.interceptors;\n+\n+import static org.openkilda.bluegreen.kafka.Utils.MESSAGE_VERSION_HEADER;\n+import static org.openkilda.bluegreen.kafka.Utils.PRODUCER_COMPONENT_NAME_PROPERTY;\n+import static org.openkilda.bluegreen.kafka.Utils.PRODUCER_RUN_ID_PROPERTY;\n+import static org.openkilda.bluegreen.kafka.Utils.PRODUCER_ZOOKEEPER_CONNECTION_STRING_PROPERTY;\n+import static org.openkilda.bluegreen.kafka.Utils.getValue;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.kafka.clients.producer.ProducerInterceptor;\n+import org.apache.kafka.clients.producer.ProducerRecord;\n+import org.apache.kafka.clients.producer.RecordMetadata;\n+\n+import java.time.Instant;\n+import java.util.Map;\n+\n+@Slf4j\n+public class VersioningProducerInterceptor<K, V> extends VersioningInterceptorBase\n+        implements ProducerInterceptor<K, V> {\n+\n+    public VersioningProducerInterceptor() {\n+        log.debug(\"Initializing VersioningProducerInterceptor\");\n+    }\n+\n+    @Override\n+    public ProducerRecord<K, V> onSend(ProducerRecord<K, V> record) {\n+        if (watchDog == null) {\n+            // try to reconnect\n+            initWatchDog();", "originalCommit": "5c9c909a65e2d5d3223f2733edc1470151271647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkyODIzNw==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539928237", "bodyText": "Check of connection is done here\n\n  \n    \n      open-kilda/src-java/blue-green/src/main/java/org/openkilda/bluegreen/ZkClient.java\n    \n    \n         Line 62\n      in\n      326f679\n    \n    \n    \n    \n\n        \n          \n           boolean refreshConnection(KeeperState state) throws IOException { \n        \n    \n  \n\n\nBut it's good idea to add check here too", "author": "niksv", "createdAt": "2020-12-10T07:15:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEzMjc5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEzNjU1NA==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539136554", "bodyText": "As for me it should be in base class. We should have method warnBuildVersionNotSet(), which one will incapsulate log each N seconds logic.\nPS As for me we should calc and log the amount of \"skipped\" records.", "author": "surabujin", "createdAt": "2020-12-09T09:16:51Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/kafka/interceptors/VersioningProducerInterceptor.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.bluegreen.kafka.interceptors;\n+\n+import static org.openkilda.bluegreen.kafka.Utils.MESSAGE_VERSION_HEADER;\n+import static org.openkilda.bluegreen.kafka.Utils.PRODUCER_COMPONENT_NAME_PROPERTY;\n+import static org.openkilda.bluegreen.kafka.Utils.PRODUCER_RUN_ID_PROPERTY;\n+import static org.openkilda.bluegreen.kafka.Utils.PRODUCER_ZOOKEEPER_CONNECTION_STRING_PROPERTY;\n+import static org.openkilda.bluegreen.kafka.Utils.getValue;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.kafka.clients.producer.ProducerInterceptor;\n+import org.apache.kafka.clients.producer.ProducerRecord;\n+import org.apache.kafka.clients.producer.RecordMetadata;\n+\n+import java.time.Instant;\n+import java.util.Map;\n+\n+@Slf4j\n+public class VersioningProducerInterceptor<K, V> extends VersioningInterceptorBase\n+        implements ProducerInterceptor<K, V> {\n+\n+    public VersioningProducerInterceptor() {\n+        log.debug(\"Initializing VersioningProducerInterceptor\");\n+    }\n+\n+    @Override\n+    public ProducerRecord<K, V> onSend(ProducerRecord<K, V> record) {\n+        if (watchDog == null) {\n+            // try to reconnect\n+            initWatchDog();\n+        }\n+\n+        if (record.headers().headers(MESSAGE_VERSION_HEADER).iterator().hasNext()) {\n+            log.info(\"Kafka record {} already has header {}: {}\",\n+                    record, MESSAGE_VERSION_HEADER,\n+                    new String(record.headers().headers(MESSAGE_VERSION_HEADER).iterator().next().value()));\n+            record.headers().remove(MESSAGE_VERSION_HEADER);\n+        }\n+\n+        if (version == null) {\n+            if (isVersionIsNotTimeoutPassed()) {", "originalCommit": "5c9c909a65e2d5d3223f2733edc1470151271647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg1MzI0NA==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539853244", "bodyText": "Unfortunately we have different logs and different logic for such case in producer and consumer. So we cant move it into base class", "author": "niksv", "createdAt": "2020-12-10T05:21:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEzNjU1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE0NzcwNA==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539147704", "bodyText": "Is it safe to throw IllegalArgumentException from here?", "author": "surabujin", "createdAt": "2020-12-09T09:31:47Z", "path": "src-java/blue-green/src/main/java/org/openkilda/bluegreen/kafka/interceptors/VersioningProducerInterceptor.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.bluegreen.kafka.interceptors;\n+\n+import static org.openkilda.bluegreen.kafka.Utils.MESSAGE_VERSION_HEADER;\n+import static org.openkilda.bluegreen.kafka.Utils.PRODUCER_COMPONENT_NAME_PROPERTY;\n+import static org.openkilda.bluegreen.kafka.Utils.PRODUCER_RUN_ID_PROPERTY;\n+import static org.openkilda.bluegreen.kafka.Utils.PRODUCER_ZOOKEEPER_CONNECTION_STRING_PROPERTY;\n+import static org.openkilda.bluegreen.kafka.Utils.getValue;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.kafka.clients.producer.ProducerInterceptor;\n+import org.apache.kafka.clients.producer.ProducerRecord;\n+import org.apache.kafka.clients.producer.RecordMetadata;\n+\n+import java.time.Instant;\n+import java.util.Map;\n+\n+@Slf4j\n+public class VersioningProducerInterceptor<K, V> extends VersioningInterceptorBase\n+        implements ProducerInterceptor<K, V> {\n+\n+    public VersioningProducerInterceptor() {\n+        log.debug(\"Initializing VersioningProducerInterceptor\");\n+    }\n+\n+    @Override\n+    public ProducerRecord<K, V> onSend(ProducerRecord<K, V> record) {\n+        if (watchDog == null) {\n+            // try to reconnect\n+            initWatchDog();\n+        }\n+\n+        if (record.headers().headers(MESSAGE_VERSION_HEADER).iterator().hasNext()) {\n+            log.info(\"Kafka record {} already has header {}: {}\",\n+                    record, MESSAGE_VERSION_HEADER,\n+                    new String(record.headers().headers(MESSAGE_VERSION_HEADER).iterator().next().value()));\n+            record.headers().remove(MESSAGE_VERSION_HEADER);\n+        }\n+\n+        if (version == null) {\n+            if (isVersionIsNotTimeoutPassed()) {\n+                // We will write this log every 60 seconds to do not spam in logs\n+                log.warn(\"Messaging version is not set for component {} with id {}. Skip record {}\",\n+                        componentName, runId, record);\n+                versionIsNotSetTimestamp = Instant.now();\n+            }\n+            // We can't return null record. We will return record without version.\n+            // Such records wouldn't be read by Kafka Consumer with VersioningConsumerInterceptor\n+            return record;\n+        }\n+\n+        record.headers().add(MESSAGE_VERSION_HEADER, version);\n+        return record;\n+    }\n+\n+    @Override\n+    public void onAcknowledgement(RecordMetadata metadata, Exception exception) {\n+        // nothing to do\n+    }\n+\n+    public void close() {\n+        watchDog.unsubscribe(this);\n+        watchDog.close();\n+    }\n+\n+    @Override\n+    public void configure(Map<String, ?> configs) {\n+        connectionString = getValue(configs, PRODUCER_ZOOKEEPER_CONNECTION_STRING_PROPERTY, String.class);", "originalCommit": "5c9c909a65e2d5d3223f2733edc1470151271647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg1Mzc3OQ==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539853779", "bodyText": "If we throw IllegalArgumentException for here running of a component stops. It needed for fast failing. Kilda wouldn't work without these config options", "author": "niksv", "createdAt": "2020-12-10T05:23:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE0NzcwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE1Nzc2MA==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539157760", "bodyText": "Extreme amount of kafka, producer and properties fords in one... name / definition :)", "author": "surabujin", "createdAt": "2020-12-09T09:45:13Z", "path": "confd/templates/server42/server42-control.application.properties.tmpl", "diffHunk": "@@ -41,3 +41,9 @@ spring.kafka.consumer.properties.spring.json.default.value.type=org.openkilda.se\n spring.kafka.consumer.properties.spring.json.use.type.headers=false\n spring.kafka.consumer.properties.spring.json.remove.type.headers=true\n spring.kafka.listener.missing-topics-fatal=false\n+\n+# Kafka versioning (zero_downtime)\n+spring.kafka.producer.properties.interceptor.classes=org.openkilda.bluegreen.kafka.interceptors.VersioningProducerInterceptor\n+spring.kafka.producer.properties.kafka.producer.messaging.zookeeper.connecting.string.property={{ getv \"/kilda_zookeeper_hosts\"}}/{{ getv \"/kilda_zookeeper_state_root\" }}", "originalCommit": "5c9c909a65e2d5d3223f2733edc1470151271647", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkxNDg1Mw==", "url": "https://github.com/telstra/open-kilda/pull/3907#discussion_r539914853", "bodyText": "agree. looks ugly. Let me explain.\nit consists of two parts:\n\nspring.kafka.producer.properties\nkafka.producer.messaging.zookeeper.connecting.string.property\n\nSecond one is mine. First one is spring's. I'm glad to use some simple name, but there is a problem. These props are shared.\nfrom docs  be aware that it will be sharing config namespace with other interceptors and serializers\nSo I need a unique name.\nIn other parts of code it looks okay because I used only second part there, but in server42 I had to use spring configs", "author": "niksv", "createdAt": "2020-12-10T06:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE1Nzc2MA=="}], "type": "inlineReview"}, {"oid": "326f679bb39b26e0975de85babd0fa80d3121f77", "url": "https://github.com/telstra/open-kilda/commit/326f679bb39b26e0975de85babd0fa80d3121f77", "message": "Added messaging versioning for Kafka Producers", "committedDate": "2020-12-10T05:37:51Z", "type": "forcePushed"}, {"oid": "4dabd39c6e263c71d349db31e6ed307a2b5a8ce9", "url": "https://github.com/telstra/open-kilda/commit/4dabd39c6e263c71d349db31e6ed307a2b5a8ce9", "message": "Added messaging versioning for Kafka Producers", "committedDate": "2020-12-10T07:21:07Z", "type": "forcePushed"}, {"oid": "13168e2873dd42c7750d8f36665ac4990233ff65", "url": "https://github.com/telstra/open-kilda/commit/13168e2873dd42c7750d8f36665ac4990233ff65", "message": "Added messaging versioning for Kafka Producers", "committedDate": "2020-12-10T11:23:43Z", "type": "forcePushed"}, {"oid": "76bde21e4b11fb1a1b93d46735baaf7bf626b828", "url": "https://github.com/telstra/open-kilda/commit/76bde21e4b11fb1a1b93d46735baaf7bf626b828", "message": "Added messaging versioning for Kafka Producers", "committedDate": "2020-12-10T14:08:40Z", "type": "commit"}, {"oid": "76bde21e4b11fb1a1b93d46735baaf7bf626b828", "url": "https://github.com/telstra/open-kilda/commit/76bde21e4b11fb1a1b93d46735baaf7bf626b828", "message": "Added messaging versioning for Kafka Producers", "committedDate": "2020-12-10T14:08:40Z", "type": "forcePushed"}]}