{"pr_number": 3548, "pr_title": "Design for Smart discovery feature", "pr_createdAt": "2020-06-17T09:11:03Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3548", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwMTY2NQ==", "url": "https://github.com/telstra/open-kilda/pull/3548#discussion_r441401665", "bodyText": "PACKET_OUT/PACKET_IN", "author": "surabujin", "createdAt": "2020-06-17T09:14:04Z", "path": "docs/design/network-discovery/README.md", "diffHunk": "@@ -38,6 +38,15 @@ packets/event for each \"link\" - one for each direction. And because it repeats\n periodically Open-Kilda can \"detect\" ISL-fails i.e. link-corruptions. And react\n on them.\n \n+Depending on the state of the port on the switch, the intervals between sending \n+discovery messages are different:\n+ - if the last discovery was unsuccessful, then the interval for the next \n+ discovery messages will be increased until we get a successful one;\n+ - if BFD is active on this endpoint, then regardless of whether the discovery \n+ is successful or not, the interval for discovery messages will be increased.\n+ \n+This is done in order to reduce the number of PACKET_IN messages.", "originalCommit": "f27632242d3a786034dd1d8cae89c07e67973cf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQzNDYzNg==", "url": "https://github.com/telstra/open-kilda/pull/3548#discussion_r441434636", "bodyText": "Added", "author": "dpoltavets", "createdAt": "2020-06-17T10:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwMTY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwMzQyOQ==", "url": "https://github.com/telstra/open-kilda/pull/3548#discussion_r441403429", "bodyText": "Not clear enough.\nNetwork topology will/can use different delays between discovery requests. These delay depends on discovery history for specific switch+port:", "author": "surabujin", "createdAt": "2020-06-17T09:16:54Z", "path": "docs/design/network-discovery/README.md", "diffHunk": "@@ -38,6 +38,15 @@ packets/event for each \"link\" - one for each direction. And because it repeats\n periodically Open-Kilda can \"detect\" ISL-fails i.e. link-corruptions. And react\n on them.\n \n+Depending on the state of the port on the switch, the intervals between sending ", "originalCommit": "f27632242d3a786034dd1d8cae89c07e67973cf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQzNTIwNw==", "url": "https://github.com/telstra/open-kilda/pull/3548#discussion_r441435207", "bodyText": "Thank you. This looks better.", "author": "dpoltavets", "createdAt": "2020-06-17T10:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwMzQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwNTA1Mw==", "url": "https://github.com/telstra/open-kilda/pull/3548#discussion_r441405053", "bodyText": "no... this is a terrible place to control anything except BFD state. ISL has full knowledge about its current state and used discovery and alive check tools. Only ISL itself must manage these tools.", "author": "surabujin", "createdAt": "2020-06-17T09:19:42Z", "path": "docs/design/network-discovery/bfd-port-FSM.puml", "diffHunk": "@@ -100,6 +100,8 @@ state ACTIVE {\n ACTIVE --> OFFLINE : offline\n ACTIVE --> INIT_REMOVE : disable\n ACTIVE --> INIT_CLEANUP : kill\n+ACTIVE : enter / emit enable bfd-slow-discovery", "originalCommit": "f27632242d3a786034dd1d8cae89c07e67973cf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQzNTUyNA==", "url": "https://github.com/telstra/open-kilda/pull/3548#discussion_r441435524", "bodyText": "Moved to IslFsm", "author": "dpoltavets", "createdAt": "2020-06-17T10:09:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwNTA1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwNzMzMg==", "url": "https://github.com/telstra/open-kilda/pull/3548#discussion_r441407332", "bodyText": "Where do you track \"last-discovery-was-unsuccessful\"?", "author": "surabujin", "createdAt": "2020-06-17T09:23:17Z", "path": "docs/design/network-discovery/port-FSM.puml", "diffHunk": "@@ -45,7 +45,9 @@ state OPERATIONAL {\n     UP : enter / emit port-up into report\n     UP : enter[discovery-enabled] / issue addWatch\n     UP : poll-discovery / emit discovery\n+    UP : poll-discovery[last-discovery-was-unsuccessful] / emit disable slow-discovery", "originalCommit": "f27632242d3a786034dd1d8cae89c07e67973cf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQzNjQ1MQ==", "url": "https://github.com/telstra/open-kilda/pull/3548#discussion_r441436451", "bodyText": "Flag change added", "author": "dpoltavets", "createdAt": "2020-06-17T10:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwNzMzMg=="}], "type": "inlineReview"}, {"oid": "eb95f0cb1c632803dea45015737d8763e4dbd63d", "url": "https://github.com/telstra/open-kilda/commit/eb95f0cb1c632803dea45015737d8763e4dbd63d", "message": "Design for Smart discovery feature", "committedDate": "2020-06-17T10:06:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU2MzU4Ng==", "url": "https://github.com/telstra/open-kilda/pull/3548#discussion_r441563586", "bodyText": "avoid using reverted logic for this, last-discovery-was-unsuccessful better for readability", "author": "nikitamarchenko", "createdAt": "2020-06-17T13:54:32Z", "path": "docs/design/network-discovery/port-FSM.puml", "diffHunk": "@@ -45,7 +45,11 @@ state OPERATIONAL {\n     UP : enter / emit port-up into report\n     UP : enter[discovery-enabled] / issue addWatch\n     UP : poll-discovery / emit discovery\n+    UP : poll-discovery[!last-discovery-was-successful] / emit disable slow-discovery", "originalCommit": "eb95f0cb1c632803dea45015737d8763e4dbd63d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA0MzI2Mg==", "url": "https://github.com/telstra/open-kilda/pull/3548#discussion_r442043262", "bodyText": "At the heartbeat we discussed that we should enable slow discovery only for ports without links. And since PortFsm does not know anything about links, NetworkUniIslService will make these decisions.", "author": "dpoltavets", "createdAt": "2020-06-18T08:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU2MzU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY3MTM0MA==", "url": "https://github.com/telstra/open-kilda/pull/3548#discussion_r442671340", "bodyText": "I am talking about the text view, not the whole idea.", "author": "nikitamarchenko", "createdAt": "2020-06-19T07:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU2MzU4Ng=="}], "type": "inlineReview"}, {"oid": "ed1cd9c93db5df277d60943e0aa589db74bb03de", "url": "https://github.com/telstra/open-kilda/commit/ed1cd9c93db5df277d60943e0aa589db74bb03de", "message": "Design for Smart discovery feature", "committedDate": "2020-06-18T08:00:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI0MjU1NQ==", "url": "https://github.com/telstra/open-kilda/pull/3548#discussion_r444242555", "bodyText": "This is BFD enable request - there is no guarantee it will be successfully enabled and turned on. You must not expect that BFD will work here. You have a DiscoveryBfdMonitor instance (into monitorsByPriority), it is responsible for tracking actual BFD status. Extend it to be able to fetch it's status directly from this object and relly on this status in your decisions. Also, it will give to you an obvious marker when BFD has been deactivated.\nPS Do we really need to \"tie\" this discovery mode to BFD feature? I mean used terminology... I believe we will have more triggers that will allow us to use \"slow-discovery\", not only BFD. And it will be hard to change terminology later, better to design it now. I would like to name it \"slow-discovery-mode\" or \"lazy-discovery-mode\" (current discovery mode can be named \"generic-discovery-mode\").", "author": "surabujin", "createdAt": "2020-06-23T13:54:35Z", "path": "docs/design/network-discovery/ISL-FSM.puml", "diffHunk": "@@ -50,6 +50,7 @@ state OPERATIONAL {\n \n         USABLE : enter / persist state\n         USABLE : enter [enable_bfd in DB is set] / emit bisl-bfd-enable\n+        USABLE : enter [enable_bfd in DB is set] / emit enable bfd-slow-discovery", "originalCommit": "ed1cd9c93db5df277d60943e0aa589db74bb03de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ5MTEzOA==", "url": "https://github.com/telstra/open-kilda/pull/3548#discussion_r445491138", "bodyText": "Fixed. When discussing this feature, it was decided to use different timeouts for the BFD active case and the case of the last discovery failed.", "author": "dpoltavets", "createdAt": "2020-06-25T11:31:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI0MjU1NQ=="}], "type": "inlineReview"}, {"oid": "f49a1cb6ce7e7cfcb108895947e438495fcdc614", "url": "https://github.com/telstra/open-kilda/commit/f49a1cb6ce7e7cfcb108895947e438495fcdc614", "message": "Design for Smart discovery feature", "committedDate": "2020-06-25T11:25:28Z", "type": "commit"}, {"oid": "f49a1cb6ce7e7cfcb108895947e438495fcdc614", "url": "https://github.com/telstra/open-kilda/commit/f49a1cb6ce7e7cfcb108895947e438495fcdc614", "message": "Design for Smart discovery feature", "committedDate": "2020-06-25T11:25:28Z", "type": "forcePushed"}]}