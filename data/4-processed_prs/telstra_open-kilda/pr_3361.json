{"pr_number": 3361, "pr_title": "Add inner vlan tag field into APIv2 requests/responses", "pr_createdAt": "2020-04-02T17:41:31Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3361", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0NDk0Mw==", "url": "https://github.com/telstra/open-kilda/pull/3361#discussion_r402744943", "bodyText": "empty line", "author": "niksv", "createdAt": "2020-04-03T05:31:02Z", "path": "src-java/base-topology/base-messaging/src/main/java/org/openkilda/messaging/payload/flow/FlowEndpointPayload.java", "diffHunk": "@@ -64,35 +72,22 @@\n     public FlowEndpointPayload(@JsonProperty(\"switch-id\") SwitchId switchId,\n                                @JsonProperty(\"port-id\") Integer portId,\n                                @JsonProperty(\"vlan-id\") Integer vlanId,\n+                               @JsonProperty(\"inner-vlan-id\") Integer innerVlanId,\n                                @JsonProperty(\"detect-connected-devices\")\n                                            DetectConnectedDevicesPayload detectConnectedDevices) {\n         super(switchId, portId);\n         setVlanId(vlanId);\n+        setInnerVlanId(innerVlanId);\n+", "originalCommit": "162ca92ab0be1f5294bf029a3b4374d21d2b327c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIwNDQzMA==", "url": "https://github.com/telstra/open-kilda/pull/3361#discussion_r404204430", "bodyText": "em... it looks natural there... removed.", "author": "surabujin", "createdAt": "2020-04-06T15:58:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0NDk0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0NTEyNg==", "url": "https://github.com/telstra/open-kilda/pull/3361#discussion_r402745126", "bodyText": "please add inner vlan into toString() and into hashCode()", "author": "niksv", "createdAt": "2020-04-03T05:31:51Z", "path": "src-java/base-topology/base-messaging/src/main/java/org/openkilda/messaging/payload/flow/FlowEndpointPayload.java", "diffHunk": "@@ -149,4 +144,15 @@ public String toString() {\n                 .add(\"detect-connected-devices\", detectConnectedDevices)", "originalCommit": "162ca92ab0be1f5294bf029a3b4374d21d2b327c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIwNTk0Ng==", "url": "https://github.com/telstra/open-kilda/pull/3361#discussion_r404205946", "bodyText": "done", "author": "surabujin", "createdAt": "2020-04-06T16:00:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc0NTEyNg=="}], "type": "inlineReview"}, {"oid": "f38835dcb44e1c9982fcf6e014a9e3c141ad3ecf", "url": "https://github.com/telstra/open-kilda/commit/f38835dcb44e1c9982fcf6e014a9e3c141ad3ecf", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-04-06T16:17:37Z", "type": "forcePushed"}, {"oid": "0704f40c9c951ae0c93aa7ecc77002fac01fe499", "url": "https://github.com/telstra/open-kilda/commit/0704f40c9c951ae0c93aa7ecc77002fac01fe499", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-04-07T13:27:36Z", "type": "forcePushed"}, {"oid": "6266bb43f051e1b9ec1761d3f40bdcc13e25649f", "url": "https://github.com/telstra/open-kilda/commit/6266bb43f051e1b9ec1761d3f40bdcc13e25649f", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-04-08T08:52:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYzNTEwMQ==", "url": "https://github.com/telstra/open-kilda/pull/3361#discussion_r412635101", "bodyText": "Should we declare \"src_inner_vlan\" and \"dst_inner_vlan\" using a wrapper class instead of the primitive to allow setting null values?", "author": "sergii-iakovenko", "createdAt": "2020-04-22T03:07:08Z", "path": "src-java/base-topology/base-messaging/src/main/java/org/openkilda/messaging/model/FlowDto.java", "diffHunk": "@@ -299,7 +309,7 @@ public FlowDto(String flowId,\n                 sourcePort,\n                 destinationPort,\n                 sourceVlan,\n-                destinationVlan,\n+                destinationVlan, 0, 0,", "originalCommit": "6266bb43f051e1b9ec1761d3f40bdcc13e25649f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzExNjcwMw==", "url": "https://github.com/telstra/open-kilda/pull/3361#discussion_r417116703", "bodyText": "0 is invalid VLAN id value, so we can use primitives here (at least it allow us to not add a lot of null checks).", "author": "surabujin", "createdAt": "2020-04-29T07:27:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYzNTEwMQ=="}], "type": "inlineReview"}, {"oid": "b975c811d144e79053bf079dc3bb108a8cbe3c18", "url": "https://github.com/telstra/open-kilda/commit/b975c811d144e79053bf079dc3bb108a8cbe3c18", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-04-29T07:39:19Z", "type": "forcePushed"}, {"oid": "fa19978f89a2aa3bdcf46bc5e7b41fcf875f9de6", "url": "https://github.com/telstra/open-kilda/commit/fa19978f89a2aa3bdcf46bc5e7b41fcf875f9de6", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-05-02T08:34:54Z", "type": "forcePushed"}, {"oid": "fd13a6124c7a3417132263f177a25041216b5e62", "url": "https://github.com/telstra/open-kilda/commit/fd13a6124c7a3417132263f177a25041216b5e62", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-05-04T13:27:50Z", "type": "forcePushed"}, {"oid": "0dc6684b6450524608e07c2239d56226bab95b37", "url": "https://github.com/telstra/open-kilda/commit/0dc6684b6450524608e07c2239d56226bab95b37", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-05-04T13:40:44Z", "type": "forcePushed"}, {"oid": "1eda51f333c8b2ed6bc261d18d20be8293621906", "url": "https://github.com/telstra/open-kilda/commit/1eda51f333c8b2ed6bc261d18d20be8293621906", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-05-04T14:28:49Z", "type": "forcePushed"}, {"oid": "139f77ba5b3aa11223ced1a3879d8d024a17f4f0", "url": "https://github.com/telstra/open-kilda/commit/139f77ba5b3aa11223ced1a3879d8d024a17f4f0", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-05-04T14:57:10Z", "type": "forcePushed"}, {"oid": "4110d6048b1bb972604e5d577d06237d5d321946", "url": "https://github.com/telstra/open-kilda/commit/4110d6048b1bb972604e5d577d06237d5d321946", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-05-04T18:09:46Z", "type": "forcePushed"}, {"oid": "69c032d84eb0383f3f1b74458a0a99c0633b534f", "url": "https://github.com/telstra/open-kilda/commit/69c032d84eb0383f3f1b74458a0a99c0633b534f", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-05-05T10:08:18Z", "type": "forcePushed"}, {"oid": "15d07214296a6d2ebfe3a59a0b4f510d5a9327e1", "url": "https://github.com/telstra/open-kilda/commit/15d07214296a6d2ebfe3a59a0b4f510d5a9327e1", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-05-05T10:12:47Z", "type": "forcePushed"}, {"oid": "dc92f62410b41ca29ae01b83f534fdcb7bc06958", "url": "https://github.com/telstra/open-kilda/commit/dc92f62410b41ca29ae01b83f534fdcb7bc06958", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-05-06T17:09:12Z", "type": "forcePushed"}, {"oid": "f2ea4ef8af5c8b62c5f130edcef5767a250e21e7", "url": "https://github.com/telstra/open-kilda/commit/f2ea4ef8af5c8b62c5f130edcef5767a250e21e7", "message": "(do-not-push) fix swap protected path in multiTableFlow spec", "committedDate": "2020-05-07T10:04:52Z", "type": "forcePushed"}, {"oid": "6dfdb8c5ee4f35fb6d860c0e243ffa5772446452", "url": "https://github.com/telstra/open-kilda/commit/6dfdb8c5ee4f35fb6d860c0e243ffa5772446452", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-05-07T15:49:16Z", "type": "forcePushed"}, {"oid": "8a223d5fa8958168af322cce02842d1bd1258c2b", "url": "https://github.com/telstra/open-kilda/commit/8a223d5fa8958168af322cce02842d1bd1258c2b", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-05-07T16:33:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0MzcwOA==", "url": "https://github.com/telstra/open-kilda/pull/3361#discussion_r424643708", "bodyText": "You mix 2 concat practice here, implicit use of StringBuilder and string.format. Chose one.", "author": "nikitamarchenko", "createdAt": "2020-05-13T18:25:27Z", "path": "src-java/kilda-model/src/main/java/org/openkilda/model/FlowEndpoint.java", "diffHunk": "@@ -16,48 +16,109 @@\n package org.openkilda.model;\n \n import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n import com.fasterxml.jackson.annotation.JsonProperty;\n import lombok.Builder;\n import lombok.EqualsAndHashCode;\n-import lombok.ToString;\n import lombok.Value;\n \n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n @Value\n-@ToString(callSuper = true)\n @EqualsAndHashCode(callSuper = true)\n public class FlowEndpoint extends NetworkEndpoint {\n     @JsonProperty(\"outer_vlan_id\")\n-    private final int vlanId;\n+    private final int outerVlanId;\n+\n+    @JsonProperty(\"inner_vlan_id\")\n+    private final int innerVlanId;\n \n     @JsonProperty(\"track_lldp_connected_devices\")\n     private final boolean trackLldpConnectedDevices;\n \n     @JsonProperty(\"track_arp_connected_devices\")\n     private final boolean trackArpConnectedDevices;\n \n-    public FlowEndpoint(SwitchId switchId, Integer portNumber) {\n+    public FlowEndpoint(SwitchId switchId, int portNumber) {\n         this(switchId, portNumber, 0);\n     }\n \n-    public FlowEndpoint(SwitchId switchId, Integer portNumber, int vlanId) {\n-        this(switchId, portNumber, vlanId, false, false);\n+    public FlowEndpoint(SwitchId switchId, int portNumber, int outerVlanId) {\n+        this(switchId, portNumber, outerVlanId, 0, false, false);\n+    }\n+\n+    public FlowEndpoint(SwitchId switchId, int portNumber, int outerVlanId, int innerVlanId) {\n+        this(switchId, portNumber, outerVlanId, innerVlanId, false, false);\n     }\n \n     @JsonCreator\n     @Builder(toBuilder = true)\n     public FlowEndpoint(\n             @JsonProperty(\"switch_id\") SwitchId switchId,\n             @JsonProperty(\"port_number\") Integer portNumber,\n-            @JsonProperty(\"outer_vlan_id\") int vlanId,\n+            @JsonProperty(\"outer_vlan_id\") int outerVlanId,\n+            @JsonProperty(\"inner_vlan_id\") int innerVlanId,\n             @JsonProperty(\"track_lldp_connected_devices\") boolean trackLldpConnectedDevices,\n             @JsonProperty(\"track_arp_connected_devices\") boolean trackArpConnectedDevices) {\n         super(switchId, portNumber);\n-        this.vlanId = vlanId;\n+\n         this.trackLldpConnectedDevices = trackLldpConnectedDevices;\n         this.trackArpConnectedDevices = trackArpConnectedDevices;\n+\n+        // normalize VLANs representation\n+        List<Integer> vlanStack = makeVlanStack(innerVlanId, outerVlanId);\n+        if (1 < vlanStack.size()) {\n+            this.outerVlanId = vlanStack.get(1);\n+            this.innerVlanId = vlanStack.get(0);\n+        } else if (!vlanStack.isEmpty()) {\n+            this.outerVlanId = vlanStack.get(0);\n+            this.innerVlanId = 0;\n+        } else {\n+            this.outerVlanId = 0;\n+            this.innerVlanId = 0;\n+        }\n+    }\n+\n+    @JsonIgnore\n+    public List<Integer> getVlanStack() {\n+        return makeVlanStack(innerVlanId, outerVlanId);\n+    }\n+\n+    /**\n+     * Scan provided sequence for valid VLAN IDs and return them as a list.\n+     */\n+    public static List<Integer> makeVlanStack(Integer... sequence) {\n+        return Stream.of(sequence)\n+                .filter(FlowEndpoint::isVlanIdSet)\n+                .collect(Collectors.toList());\n     }\n \n     public static boolean isVlanIdSet(Integer vlanId) {\n         return vlanId != null && 0 < vlanId;\n     }\n+\n+    @Override\n+    public String toString() {\n+        String view = String.format(\"switchId=\\\"%s\\\" port=%d\", switchId, portNumber);", "originalCommit": "8a223d5fa8958168af322cce02842d1bd1258c2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk0NTU2Mw==", "url": "https://github.com/telstra/open-kilda/pull/3361#discussion_r424945563", "bodyText": "Done.", "author": "surabujin", "createdAt": "2020-05-14T08:04:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0MzcwOA=="}], "type": "inlineReview"}, {"oid": "09b993e68681c3756aa14f6f4ae42d728927f7ab", "url": "https://github.com/telstra/open-kilda/commit/09b993e68681c3756aa14f6f4ae42d728927f7ab", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-05-14T08:03:12Z", "type": "commit"}, {"oid": "09b993e68681c3756aa14f6f4ae42d728927f7ab", "url": "https://github.com/telstra/open-kilda/commit/09b993e68681c3756aa14f6f4ae42d728927f7ab", "message": "Add inner vlan tag field into APIv2 requests/responses", "committedDate": "2020-05-14T08:03:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIzNTY1OQ==", "url": "https://github.com/telstra/open-kilda/pull/3361#discussion_r425235659", "bodyText": "nit: it's more common to have the target as the last argument. https://mapstruct.org/documentation/stable/reference/html/", "author": "sergii-iakovenko", "createdAt": "2020-05-14T15:40:05Z", "path": "src-java/flowhs-topology/flowhs-storm-topology/src/main/java/org/openkilda/wfm/topology/flowhs/mapper/RequestedFlowIncrementalMapper.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.topology.flowhs.mapper;\n+\n+import org.openkilda.model.FlowEndpoint;\n+import org.openkilda.wfm.topology.flowhs.model.RequestedFlow;\n+\n+import org.mapstruct.Mapper;\n+import org.mapstruct.Mapping;\n+import org.mapstruct.MappingTarget;\n+import org.mapstruct.ReportingPolicy;\n+import org.mapstruct.factory.Mappers;\n+\n+@Mapper(unmappedTargetPolicy = ReportingPolicy.IGNORE)\n+public abstract class RequestedFlowIncrementalMapper {\n+    public static final RequestedFlowIncrementalMapper INSTANCE = Mappers.getMapper(\n+            RequestedFlowIncrementalMapper.class);\n+\n+    @Mapping(source = \"switchId\", target = \"srcSwitch\")\n+    @Mapping(source = \"portNumber\", target = \"srcPort\")\n+    @Mapping(source = \"outerVlanId\", target = \"srcVlan\")\n+    @Mapping(source = \"innerVlanId\", target = \"srcInnerVlan\")\n+    public abstract void mapSource(@MappingTarget RequestedFlow target, FlowEndpoint endpoint);", "originalCommit": "09b993e68681c3756aa14f6f4ae42d728927f7ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}