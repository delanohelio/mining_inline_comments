{"pr_number": 3782, "pr_title": "Bfd ports LCM", "pr_createdAt": "2020-10-13T13:01:11Z", "pr_url": "https://github.com/telstra/open-kilda/pull/3782", "timeline": [{"oid": "d90c4f0f5bba0417286346730823faf21fb57ded", "url": "https://github.com/telstra/open-kilda/commit/d90c4f0f5bba0417286346730823faf21fb57ded", "message": "(do-not-push) FSM debug mode", "committedDate": "2020-10-13T18:31:13Z", "type": "forcePushed"}, {"oid": "3523d8a8e848fd36ff44772f4e062ed2b4c93727", "url": "https://github.com/telstra/open-kilda/commit/3523d8a8e848fd36ff44772f4e062ed2b4c93727", "message": "(do-not-push) FSM debug mode", "committedDate": "2020-10-16T07:46:01Z", "type": "forcePushed"}, {"oid": "13d0cd2d675c148c7ec6817e9e3b961c97f6bafa", "url": "https://github.com/telstra/open-kilda/commit/13d0cd2d675c148c7ec6817e9e3b961c97f6bafa", "message": "(do-not-push) FSM debug mode", "committedDate": "2020-10-18T18:02:47Z", "type": "forcePushed"}, {"oid": "3acd56748b2172525f77854ab8e581270c2e9cbb", "url": "https://github.com/telstra/open-kilda/commit/3acd56748b2172525f77854ab8e581270c2e9cbb", "message": "(do-not-push) FSM debug mode", "committedDate": "2020-10-19T06:03:24Z", "type": "forcePushed"}, {"oid": "cb91957e5543cb571d8db13431e4a5f1edd9b826", "url": "https://github.com/telstra/open-kilda/commit/cb91957e5543cb571d8db13431e4a5f1edd9b826", "message": "(do-not-push) FSM debug mode", "committedDate": "2020-10-19T09:50:53Z", "type": "forcePushed"}, {"oid": "5816979ade4e14f5f2a6a9992f0323ff4255bfb9", "url": "https://github.com/telstra/open-kilda/commit/5816979ade4e14f5f2a6a9992f0323ff4255bfb9", "message": "(do-not-push) FSM debug mode", "committedDate": "2020-10-19T16:57:23Z", "type": "forcePushed"}, {"oid": "48acfc11d377a556193071061a33693430eac0ff", "url": "https://github.com/telstra/open-kilda/commit/48acfc11d377a556193071061a33693430eac0ff", "message": "(do-not-push) FSM debug mode", "committedDate": "2020-10-21T09:31:44Z", "type": "forcePushed"}, {"oid": "050f87cac3a06817c65c4a6b09121b3ac8f438e1", "url": "https://github.com/telstra/open-kilda/commit/050f87cac3a06817c65c4a6b09121b3ac8f438e1", "message": "(do-not-push) FSM debug mode", "committedDate": "2020-10-21T15:13:57Z", "type": "forcePushed"}, {"oid": "96368c79de1a86b6b99aa630682c6026d882f962", "url": "https://github.com/telstra/open-kilda/commit/96368c79de1a86b6b99aa630682c6026d882f962", "message": "(do-not-push) FSM debug mode", "committedDate": "2020-10-23T08:09:46Z", "type": "forcePushed"}, {"oid": "dd4d608edc3bb016cf7d5e0438c29c51af86a335", "url": "https://github.com/telstra/open-kilda/commit/dd4d608edc3bb016cf7d5e0438c29c51af86a335", "message": "BFD related network topology structures renaming\n\nFor a more clear representation of hub-AND-spoke approach used in\nnetwork topology BFD related classes and packets were renamed.", "committedDate": "2020-10-23T14:13:08Z", "type": "commit"}, {"oid": "9597d1e5e50bc4ac2417035e74fc8693c90ef8bf", "url": "https://github.com/telstra/open-kilda/commit/9597d1e5e50bc4ac2417035e74fc8693c90ef8bf", "message": "(do-not-push) FSM debug mode", "committedDate": "2020-10-23T14:13:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5MjU4NQ==", "url": "https://github.com/telstra/open-kilda/pull/3782#discussion_r511092585", "bodyText": "Why not make \"topic\" final instead of a new variable?", "author": "sergii-iakovenko", "createdAt": "2020-10-23T19:11:40Z", "path": "src-java/grpc-speaker/grpc-service/src/main/java/org/openkilda/grpc/speaker/messaging/MessageProcessor.java", "diffHunk": "@@ -83,85 +87,105 @@ public void processRequest(Message message, String key) {\n     private void handleCommandMessage(CommandMessage command, String key) {\n         CommandData data = command.getData();\n         String correlationId = command.getCorrelationId();\n+        String topic = grpcResponseTopic;\n+\n+        CompletableFuture<MessageData> result;\n \n         if (data instanceof CreateLogicalPortRequest) {\n-            handleCreateLogicalPortRequest((CreateLogicalPortRequest) data, correlationId, key);\n+            result = handleCreateLogicalPortRequest((CreateLogicalPortRequest) data);\n         } else if (data instanceof DumpLogicalPortsRequest) {\n-            handleDumpLogicalPortsRequest((DumpLogicalPortsRequest) data, correlationId, key);\n+            result = handleDumpLogicalPortsRequest((DumpLogicalPortsRequest) data);\n         } else if (data instanceof GetSwitchInfoRequest) {\n-            handleGetSwitchInfoRequest((GetSwitchInfoRequest) data, correlationId, key);\n+            result = handleGetSwitchInfoRequest((GetSwitchInfoRequest) data);\n         } else if (data instanceof GetPacketInOutStatsRequest) {\n-            handleGetPacketInOutStatsRequest((GetPacketInOutStatsRequest) data, correlationId, key);\n+            result = handleGetPacketInOutStatsRequest((GetPacketInOutStatsRequest) data);\n+            topic = statsTopic;\n         } else if (data instanceof DeleteLogicalPortRequest) {\n-            handleDeleteLogicalPortRequest((DeleteLogicalPortRequest) data, command.getCorrelationId(), key);\n+            result = handleDeleteLogicalPortRequest((DeleteLogicalPortRequest) data);\n         } else {\n-            unhandledMessage(command);\n+            result = unhandledMessage(command);\n         }\n+\n+        final String responseTopic = topic;", "originalCommit": "9597d1e5e50bc4ac2417035e74fc8693c90ef8bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2MjQzOA==", "url": "https://github.com/telstra/open-kilda/pull/3782#discussion_r511762438", "bodyText": "Because it is changed for one message type - line 102 :(\nI have reworked the way how we manage the response topic into MessageProcessor.", "author": "surabujin", "createdAt": "2020-10-26T07:35:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA5MjU4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyMDYxMA==", "url": "https://github.com/telstra/open-kilda/pull/3782#discussion_r511120610", "bodyText": "I'd reconsider the naming for these log methods to help others understand when to use them. E.g. logDebugWithPrefix...", "author": "sergii-iakovenko", "createdAt": "2020-10-23T19:48:14Z", "path": "src-java/network-topology/network-storm-topology/src/main/java/org/openkilda/wfm/topology/network/controller/bfd/BfdLogicalPortFsm.java", "diffHunk": "@@ -0,0 +1,433 @@\n+/* Copyright 2020 Telstra Open Source\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *   you may not use this file except in compliance with the License.\n+ *   You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   Unless required by applicable law or agreed to in writing, software\n+ *   distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *   See the License for the specific language governing permissions and\n+ *   limitations under the License.\n+ */\n+\n+package org.openkilda.wfm.topology.network.controller.bfd;\n+\n+import org.openkilda.messaging.MessageData;\n+import org.openkilda.messaging.error.ErrorData;\n+import org.openkilda.messaging.info.InfoData;\n+import org.openkilda.wfm.share.model.Endpoint;\n+import org.openkilda.wfm.share.utils.AbstractBaseFsm;\n+import org.openkilda.wfm.share.utils.FsmExecutor;\n+import org.openkilda.wfm.topology.network.controller.bfd.BfdLogicalPortFsm.BfdLogicalPortFsmContext;\n+import org.openkilda.wfm.topology.network.controller.bfd.BfdLogicalPortFsm.Event;\n+import org.openkilda.wfm.topology.network.controller.bfd.BfdLogicalPortFsm.State;\n+import org.openkilda.wfm.topology.network.model.BfdSessionData;\n+import org.openkilda.wfm.topology.network.service.IBfdLogicalPortCarrier;\n+\n+import lombok.Builder;\n+import lombok.Getter;\n+import lombok.Value;\n+import lombok.extern.slf4j.Slf4j;\n+import org.squirrelframework.foundation.fsm.StateMachineBuilder;\n+import org.squirrelframework.foundation.fsm.StateMachineBuilderFactory;\n+import org.squirrelframework.foundation.fsm.StateMachineLogger;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+@Slf4j\n+public class BfdLogicalPortFsm extends AbstractBaseFsm<BfdLogicalPortFsm, State, Event, BfdLogicalPortFsmContext> {\n+    private final IBfdLogicalPortCarrier carrier;\n+\n+    private final SwitchStatusMonitor switchStatusMonitor;\n+\n+    private final Set<String> activeRequest = new HashSet<>();\n+\n+    @Getter\n+    private final Endpoint physicalEndpoint;\n+\n+    private final int logicalPortNumber;\n+\n+    private BfdSessionData sessionData;\n+\n+    public BfdLogicalPortFsm(\n+            IBfdLogicalPortCarrier carrier, SwitchStatusMonitor switchStatusMonitor,\n+            Endpoint physicalEndpoint, Integer logicalPortNumber) {\n+        this.carrier = carrier;\n+        this.switchStatusMonitor = switchStatusMonitor;\n+        this.physicalEndpoint = physicalEndpoint;\n+        this.logicalPortNumber = logicalPortNumber;\n+\n+        switchStatusMonitor.addController(this);\n+        carrier.logicalPortControllerAddNotification(physicalEndpoint);\n+    }\n+\n+    // -- external API --\n+\n+    public static BfdLogicalPortFsmFactory factory(IBfdLogicalPortCarrier carrier) {\n+        return new BfdLogicalPortFsmFactory(carrier);\n+    }\n+\n+    public void processWorkerSuccess(String requestId, InfoData response) {\n+        if (activeRequest.remove(requestId)) {\n+            logInfo(\"receive worker success response: {}\", response);\n+            BfdLogicalPortFsmContext context = BfdLogicalPortFsmContext.builder()\n+                    .workerResponse(response)\n+                    .build();\n+            BfdLogicalPortFsmFactory.EXECUTOR.fire(this, Event.WORKER_SUCCESS, context);\n+        } else {\n+            reportWorkerResponseIgnored(requestId, response);\n+        }\n+    }\n+\n+    public void processWorkerError(String requestId, ErrorData response) {\n+        if (activeRequest.remove(requestId)) {\n+            String errorMessage = response == null ? \"timeout\" : response.getErrorMessage();\n+            logError(\"receive worker error response: {}\", errorMessage);\n+            BfdLogicalPortFsmContext context = BfdLogicalPortFsmContext.builder()\n+                    .workerError(response)\n+                    .build();\n+            BfdLogicalPortFsmFactory.EXECUTOR.fire(this, Event.WORKER_ERROR, context);\n+        } else {\n+            reportWorkerResponseIgnored(requestId, response);\n+        }\n+    }\n+\n+    public Endpoint getLogicalEndpoint() {\n+        return Endpoint.of(physicalEndpoint.getDatapath(), logicalPortNumber);\n+    }\n+\n+    // -- FSM actions --\n+\n+    public void prepareEnterAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        activeRequest.clear();\n+        saveSessionData(context);\n+    }\n+\n+    public void readyEnterAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        sessionData = null;\n+    }\n+\n+    public void creatingEnterAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        sendPortCreateRequest();\n+    }\n+\n+    public void creatingExitAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        activeRequest.clear();\n+    }\n+\n+    public void operationalEnterAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        carrier.createSession(getLogicalEndpoint(), physicalEndpoint.getPortNumber());\n+        if (sessionData != null) {\n+            sendSessionEnableUpdateRequest();\n+        }\n+    }\n+\n+    public void removingEnterAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        sendPortDeleteRequest();\n+    }\n+\n+    public void stopEnterAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        carrier.logicalPortControllerDelNotification(physicalEndpoint);\n+    }\n+\n+    public void sendPortCreateAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        sendPortCreateRequest();\n+    }\n+\n+    public void renewPortCreateAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        sessionData = context.getSessionData();\n+        sendPortCreateRequest();\n+    }\n+\n+    public void reportWorkerSuccessAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        logInfo(\"success worker response {}\", context.getWorkerResponse());\n+    }\n+\n+    public void sendPortDeleteAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        sendPortDeleteRequest();\n+    }\n+\n+    public void sendSessionEnableUpdateAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        sendSessionEnableUpdateRequest(context.getSessionData());\n+    }\n+\n+    public void sendSessionDisableAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        sendSessionDisableRequest();\n+    }\n+\n+    public void sendSessionDeleteAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        sendSessionRemoveRequest();\n+    }\n+\n+    public void sendSessionFailureAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        sendSessionFailNotification();\n+    }\n+\n+    public void sendSessionOfflineAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        updateSessionOnlineStatus(false);\n+    }\n+\n+    public void sendSessionOnlineAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        updateSessionOnlineStatus(true);\n+    }\n+\n+    public void saveSessionDataAction(State from, State to, Event event, BfdLogicalPortFsmContext context) {\n+        saveSessionData(context);\n+    }\n+\n+    // -- private/service methods --\n+\n+    private void saveSessionData(BfdLogicalPortFsmContext context) {\n+        sessionData = context.getSessionData();\n+    }\n+\n+    private void sendPortCreateRequest() {\n+        Endpoint logical = getLogicalEndpoint();\n+        if (switchStatusMonitor.isOnline()) {\n+            activeRequest.add(carrier.createLogicalPort(logical, physicalEndpoint.getPortNumber()));\n+        } else {\n+            log.debug(\"Do not send logical port {} create request because the switch is offline now\", logical);\n+        }\n+    }\n+\n+    private void sendPortDeleteRequest() {\n+        Endpoint logical = getLogicalEndpoint();\n+        if (switchStatusMonitor.isOnline()) {\n+            activeRequest.add(carrier.deleteLogicalPort(logical));\n+        } else {\n+            log.debug(\"Do not send logical port {} delete request because the switch is offline now\", logical);\n+        }\n+    }\n+\n+    private void sendSessionFailNotification() {\n+        carrier.bfdKillNotification(physicalEndpoint);\n+    }\n+\n+    private void sendSessionEnableUpdateRequest() {\n+        sendSessionEnableUpdateRequest(sessionData);\n+    }\n+\n+    private void sendSessionEnableUpdateRequest(BfdSessionData data) {\n+        carrier.enableUpdateSession(physicalEndpoint, data.getReference(), data.getProperties());\n+    }\n+\n+    private void sendSessionDisableRequest() {\n+        carrier.disableSession(physicalEndpoint);\n+    }\n+\n+    private void sendSessionRemoveRequest() {\n+        carrier.deleteSession(getLogicalEndpoint());\n+    }\n+\n+    private void updateSessionOnlineStatus(boolean isOnline) {\n+        carrier.updateSessionOnlineStatus(getLogicalEndpoint(), isOnline);\n+    }\n+\n+    private void reportWorkerResponseIgnored(String requestId, MessageData response) {\n+        logDebug(\"ignore response {} with id \\\"{}\\\" in state {}, active requests: {}\",\n+                response, requestId, getCurrentState(), activeRequest);\n+    }\n+\n+    private void logDebug(String format, Object... args) {", "originalCommit": "9597d1e5e50bc4ac2417035e74fc8693c90ef8bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMTAzNw==", "url": "https://github.com/telstra/open-kilda/pull/3782#discussion_r511931037", "bodyText": "These wrappers are supposed to use for all log requests. Their goal is to identify specific FSM in logs, so they must be used always.", "author": "surabujin", "createdAt": "2020-10-26T12:44:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyMDYxMA=="}], "type": "inlineReview"}, {"oid": "b7d3f57c82ccb01cc20339095ad698e6d9edd4b9", "url": "https://github.com/telstra/open-kilda/commit/b7d3f57c82ccb01cc20339095ad698e6d9edd4b9", "message": "BFD logical port's LCM implementation\n\nBFD enable request will lead to creating a logical BFD port if it does\nnot exist. ISL removal will lead to the removal of logical BFD ports.\n\nLogical BFD ports are created using GRPC speaker and kafka as a\ntransport.", "committedDate": "2020-10-26T07:36:24Z", "type": "forcePushed"}, {"oid": "5e8db7d360c7849af89c995931536e96ff473c1e", "url": "https://github.com/telstra/open-kilda/commit/5e8db7d360c7849af89c995931536e96ff473c1e", "message": "BFD logical port's LCM implementation\n\nBFD enable request will lead to creating a logical BFD port if it does\nnot exist. ISL removal will lead to the removal of logical BFD ports.\n\nLogical BFD ports are created using GRPC speaker and kafka as a\ntransport.", "committedDate": "2020-10-26T12:40:00Z", "type": "commit"}, {"oid": "5e8db7d360c7849af89c995931536e96ff473c1e", "url": "https://github.com/telstra/open-kilda/commit/5e8db7d360c7849af89c995931536e96ff473c1e", "message": "BFD logical port's LCM implementation\n\nBFD enable request will lead to creating a logical BFD port if it does\nnot exist. ISL removal will lead to the removal of logical BFD ports.\n\nLogical BFD ports are created using GRPC speaker and kafka as a\ntransport.", "committedDate": "2020-10-26T12:40:00Z", "type": "forcePushed"}]}