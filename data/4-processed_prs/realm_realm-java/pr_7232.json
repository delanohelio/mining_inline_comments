{"pr_number": 7232, "pr_title": "Clean up local JNI references to prevent overflow", "pr_createdAt": "2020-12-04T09:00:10Z", "pr_url": "https://github.com/realm/realm-java/pull/7232", "timeline": [{"oid": "35afc6681ae10d2e35e7108e7e58a39443717d98", "url": "https://github.com/realm/realm-java/commit/35afc6681ae10d2e35e7108e7e58a39443717d98", "message": "Clean up local JNI references to prevent overflow", "committedDate": "2020-12-04T08:50:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1NzQ2Nw==", "url": "https://github.com/realm/realm-java/pull/7232#discussion_r536057467", "bodyText": "Is this being used anywhere?", "author": "cmelchior", "createdAt": "2020-12-04T12:15:29Z", "path": "realm/realm-library/src/main/cpp/java_accessor.hpp", "diffHunk": "@@ -154,6 +154,11 @@ class JObjectArrayAccessor {\n     jsize m_size;\n };\n \n+template<>\n+inline JStringAccessor JObjectArrayAccessor<JStringAccessor,jstring>::operator[](const int index) const noexcept {", "originalCommit": "35afc6681ae10d2e35e7108e7e58a39443717d98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA3Nzk4Nw==", "url": "https://github.com/realm/realm-java/pull/7232#discussion_r536077987", "bodyText": "It is used by https://github.com/realm/realm-java/pull/7232/files#diff-8905bc013670a06267a7fd4be2a36b6698ed38d2d3f442c88d1223f57e8e8772R107. The problem is the reference generated by the below GetObjectArrayElement, which is immediately passed into the JStringAccessor. I did not see any other reasonable easy way to grab it and delete without doing it through the JStringAccessor without having to verify all usages of JStringAccessor throughout our code. It is actually immediately releasable as the data is copied out in the constructor, so basically just propagating the owned argument to the inner temporary JStringCharsAccessor. Maybe delete_jstring_ref would be more appropriate.", "author": "rorbech", "createdAt": "2020-12-04T12:52:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1NzQ2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1ODYyNg==", "url": "https://github.com/realm/realm-java/pull/7232#discussion_r536058626", "bodyText": "Any reason to introduce the owned boolean for just this case? Couldn't we delete it after calling the ref after calling the completionBlock?", "author": "cmelchior", "createdAt": "2020-12-04T12:17:37Z", "path": "realm/realm-library/src/main/cpp/java_network_transport.hpp", "diffHunk": "@@ -92,7 +103,7 @@ struct JavaNetworkTransport : public app::GenericNetworkTransport {\n \n             jint http_code = env->CallIntMethod(response, get_http_code_method);\n             jint custom_code = env->CallIntMethod(response, get_custom_code_method);\n-            JStringAccessor java_body(env, (jstring) env->CallObjectMethod(response, get_body_method));\n+            JStringAccessor java_body(env, (jstring) env->CallObjectMethod(response, get_body_method), true);", "originalCommit": "35afc6681ae10d2e35e7108e7e58a39443717d98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA4MDA2NA==", "url": "https://github.com/realm/realm-java/pull/7232#discussion_r536080064", "bodyText": "Just taking advantage of the new constructor needed to delete all the temporary jstring references generated in the JObjectArrayAccessor. We could do it manually, but I assume that we have loads of JStringAccessors that received a jstring which could instantly be deleted, so I see no reason for removing nice functionality. Alternative is to define a local jstring and manually delete the reference afterwards.", "author": "rorbech", "createdAt": "2020-12-04T12:55:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1ODYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1OTQ2Mg==", "url": "https://github.com/realm/realm-java/pull/7232#discussion_r536059462", "bodyText": "This name is a bit confusing to me. Owned by who? Looking at the code, it seems to imply \"owned by this class\" so maybe \"owned_by_accessor\" or \"delete_on_free\" or pr. the comment above, just remove it? \ud83e\udd14", "author": "cmelchior", "createdAt": "2020-12-04T12:19:18Z", "path": "realm/realm-library/src/main/cpp/util.cpp", "diffHunk": "@@ -331,6 +335,7 @@ struct JStringCharsAccessor {\n     const jstring m_string;\n     const jchar* const m_data;\n     const size_t m_size;\n+    const bool m_owned;", "originalCommit": "35afc6681ae10d2e35e7108e7e58a39443717d98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA4MjMwOQ==", "url": "https://github.com/realm/realm-java/pull/7232#discussion_r536082309", "bodyText": "See other comments about the rationale. I can update the name to delete_on_free or maybe delete_jstring_ref_on_free to be very explicit.", "author": "rorbech", "createdAt": "2020-12-04T12:59:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1OTQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA4Mjg2Nw==", "url": "https://github.com/realm/realm-java/pull/7232#discussion_r536082867", "bodyText": "I'm fine with keeping this. Either of the tow names you propose there seems better to me than owned.", "author": "cmelchior", "createdAt": "2020-12-04T13:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1OTQ2Mg=="}], "type": "inlineReview"}, {"oid": "a3ce5b22453bdcdf2a1f5f77fd7fcbaecaf4dee1", "url": "https://github.com/realm/realm-java/commit/a3ce5b22453bdcdf2a1f5f77fd7fcbaecaf4dee1", "message": "More descriptive argument/member names", "committedDate": "2020-12-04T13:48:25Z", "type": "commit"}, {"oid": "6f9fad3a6510c8032d67e2102cb56b73ba3d6627", "url": "https://github.com/realm/realm-java/commit/6f9fad3a6510c8032d67e2102cb56b73ba3d6627", "message": "Merge branch 'releases' into cr/jni-reference-overflow", "committedDate": "2020-12-07T08:05:12Z", "type": "commit"}, {"oid": "cad4980186754074ab2eef1a1df7fe309f23a0bb", "url": "https://github.com/realm/realm-java/commit/cad4980186754074ab2eef1a1df7fe309f23a0bb", "message": "Add CHANGELOG entry", "committedDate": "2020-12-07T08:10:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM5ODU4NQ==", "url": "https://github.com/realm/realm-java/pull/7232#discussion_r537398585", "bodyText": "Add FIXME to ensure alignment of future updates", "author": "rorbech", "createdAt": "2020-12-07T10:34:38Z", "path": "realm/realm-library/src/main/cpp/util.cpp", "diffHunk": "@@ -306,16 +306,20 @@ struct JcharTraits {\n };\n \n struct JStringCharsAccessor {\n-    JStringCharsAccessor(JNIEnv* e, jstring s)\n+    JStringCharsAccessor(JNIEnv* e, jstring s, bool delete_jstring_ref_on_delete)\n         : m_env(e)\n         , m_string(s)\n         , m_data(e->GetStringChars(s, 0))\n         , m_size(get_size(e, s))\n+        , m_delete_jstring_ref_on_delete(delete_jstring_ref_on_delete)\n     {\n     }\n     ~JStringCharsAccessor()\n     {\n         m_env->ReleaseStringChars(m_string, m_data);\n+        if (m_delete_jstring_ref_on_delete) {", "originalCommit": "cad4980186754074ab2eef1a1df7fe309f23a0bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1ce9737185a6221c4c28956c32bcc67f75f83c83", "url": "https://github.com/realm/realm-java/commit/1ce9737185a6221c4c28956c32bcc67f75f83c83", "message": "Add TODO for revisiting deletion of local reference for JstringCharsAccessor", "committedDate": "2020-12-07T11:06:02Z", "type": "commit"}]}