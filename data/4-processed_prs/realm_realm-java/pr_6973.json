{"pr_number": 6973, "pr_title": "Fix support for multiple Realms by same user", "pr_createdAt": "2020-06-27T18:41:28Z", "pr_url": "https://github.com/realm/realm-java/pull/6973", "timeline": [{"oid": "af5eced382511266a493438277367368f8b7c05b", "url": "https://github.com/realm/realm-java/commit/af5eced382511266a493438277367368f8b7c05b", "message": "Fix support for multiple Realms by the same user and let OS calculate the file path instead of doing it in Java.", "committedDate": "2020-06-27T18:34:17Z", "type": "commit"}, {"oid": "d6d84f6e532428afc4e6c875f1078432e8b67fd5", "url": "https://github.com/realm/realm-java/commit/d6d84f6e532428afc4e6c875f1078432e8b67fd5", "message": "Fix test and Findbugs", "committedDate": "2020-06-28T16:30:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgwOTMzNg==", "url": "https://github.com/realm/realm-java/pull/6973#discussion_r446809336", "bodyText": "Was this one not intentionally left out to align feature set with other SDKs?\nI guess it could be added to the other SDKs with realm/realm-object-store#1049, but would it then also make sense to consider adding the directory method in the same go?", "author": "rorbech", "createdAt": "2020-06-29T06:55:18Z", "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/sync/SyncConfiguration.java", "diffHunk": "@@ -592,8 +581,21 @@ private void validateAndSet(URL baseUrl ) {\n             } catch (URISyntaxException e) {\n                 throw new IllegalArgumentException(\"Invalid URI: \" + baseUrl, e);\n             }\n+        }\n+\n+        /**\n+         * FIXME: Make public once https://github.com/realm/realm-object-store/pull/1049 is merged.\n+         *\n+         * Sets the filename for the Realm file on this device.\n+         */\n+        Builder name(String filename) {", "originalCommit": "d6d84f6e532428afc4e6c875f1078432e8b67fd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgxNjEzNw==", "url": "https://github.com/realm/realm-java/pull/6973#discussion_r446816137", "bodyText": "It was left out because I wasn't clear exactly how we could support it with the current OS API's. But it is pretty useful, which is why I'm adding it back in the OS PR.\nThe directory is kinda supported by using AppConfig.syncRootDirectory(), which is good enough IMO. I think it make sense for us to control the intermediate layout in order to be able to support multiple Realms from different apps/users.", "author": "cmelchior", "createdAt": "2020-06-29T07:10:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgwOTMzNg=="}], "type": "inlineReview"}, {"oid": "f6b956727bb78782004f957f214996e06f8e01cf", "url": "https://github.com/realm/realm-java/commit/f6b956727bb78782004f957f214996e06f8e01cf", "message": "Add support for multiple partions for the same user", "committedDate": "2020-08-12T10:24:58Z", "type": "commit"}, {"oid": "5c360eaabeb07dbfa6a38c5ce0540c63954546f4", "url": "https://github.com/realm/realm-java/commit/5c360eaabeb07dbfa6a38c5ce0540c63954546f4", "message": "Fix test", "committedDate": "2020-08-12T10:32:42Z", "type": "commit"}, {"oid": "e88b146b9135378e21c086967c044989a6de9d4c", "url": "https://github.com/realm/realm-java/commit/e88b146b9135378e21c086967c044989a6de9d4c", "message": "Merge branch 'v10' into cm/support-multiple-realms-pr-user\n\n# Conflicts:\n#\tCHANGELOG.md\n#\trealm/realm-library/src/androidTestObjectServer/kotlin/io/realm/UserTests.kt\n#\trealm/realm-library/src/androidTestObjectServer/kotlin/io/realm/mongodb/sync/SyncConfigurationTests.kt", "committedDate": "2020-08-12T10:53:14Z", "type": "commit"}, {"oid": "258c6642d7a5f1d66389086bd6a44a20486e5de4", "url": "https://github.com/realm/realm-java/commit/258c6642d7a5f1d66389086bd6a44a20486e5de4", "message": "Fix compiler errors", "committedDate": "2020-08-12T11:18:55Z", "type": "commit"}, {"oid": "5203339b50473e45c29ce0da05412a72c274294c", "url": "https://github.com/realm/realm-java/commit/5203339b50473e45c29ce0da05412a72c274294c", "message": "Fix unit test", "committedDate": "2020-08-13T06:59:19Z", "type": "commit"}, {"oid": "12a74debd2dd40b842ae0b30714025c29d4c6e6b", "url": "https://github.com/realm/realm-java/commit/12a74debd2dd40b842ae0b30714025c29d4c6e6b", "message": "Fix wrong logging interceptor", "committedDate": "2020-08-13T08:08:27Z", "type": "commit"}, {"oid": "3bd1fd898d4c97a973e53f3448f1d4a19f490181", "url": "https://github.com/realm/realm-java/commit/3bd1fd898d4c97a973e53f3448f1d4a19f490181", "message": "Fix JVM test", "committedDate": "2020-08-13T08:41:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg1ODI3NQ==", "url": "https://github.com/realm/realm-java/pull/6973#discussion_r469858275", "bodyText": "Is this a relevant check? Wouldn't we have sufficient details even if the user is logged out? I give that the chances of actually needing the path in that case would be quite limited.", "author": "rorbech", "createdAt": "2020-08-13T10:36:08Z", "path": "realm/realm-library/src/main/cpp/io_realm_mongodb_sync_Sync.cpp", "diffHunk": "@@ -73,3 +74,34 @@ JNIEXPORT void JNICALL Java_io_realm_mongodb_sync_Sync_nativeCreateSession(JNIEn\n     }\n     CATCH_STD()\n }\n+\n+JNIEXPORT jstring JNICALL Java_io_realm_mongodb_sync_Sync_nativeGetPathForRealm(JNIEnv* env,\n+                                                                                jclass,\n+                                                                                jstring j_user_id,\n+                                                                                jstring j_encoded_partition_value,\n+                                                                                jstring j_override_filename)\n+{\n+    try {\n+        // This is a little bit of a hack. Normally Realm Java doesn't generate the C++ SyncConfig\n+        // until the Realm is opened, but the Sync API for creating the Realm path require that\n+        // it is created up front. So we cheat and create a SyncConfig with the minimal values\n+        // needed for the path to be calculated.\n+        JStringAccessor user_id(env, j_user_id);\n+        std::shared_ptr<SyncUser> user = SyncManager::shared().get_existing_logged_in_user(user_id);", "originalCommit": "3bd1fd898d4c97a973e53f3448f1d4a19f490181", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkxNTk5NA==", "url": "https://github.com/realm/realm-java/pull/6973#discussion_r469915994", "bodyText": "The primary reason is that asking for a potentially logged out user requires both the access/refresh token as well, so it would complicate this code for a very exotic use case (which would also be a wrong use of the API).\nWe already check if the user is logged in in the SyncConfiguration constructor, so this should be quite safe unless people do this:\nval builder = SyncConfiguration.Builder(user, \"partition\")\nuser.logOut()\nval config = builder.build() // Will throw with the current code", "author": "cmelchior", "createdAt": "2020-08-13T12:32:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg1ODI3NQ=="}], "type": "inlineReview"}, {"oid": "fdd27ba13c439f1b2ed073760f7759a9c838c148", "url": "https://github.com/realm/realm-java/commit/fdd27ba13c439f1b2ed073760f7759a9c838c148", "message": "Add changelog entry", "committedDate": "2020-08-13T12:34:43Z", "type": "commit"}]}