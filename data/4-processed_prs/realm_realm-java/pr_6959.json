{"pr_number": 6959, "pr_title": "Fix ProgressListenerTests", "pr_createdAt": "2020-06-19T13:06:35Z", "pr_url": "https://github.com/realm/realm-java/pull/6959", "timeline": [{"oid": "a7fd18b40a4c53c67d5f58bb7cd50839a869f10d", "url": "https://github.com/realm/realm-java/commit/a7fd18b40a4c53c67d5f58bb7cd50839a869f10d", "message": "Remove already migrated ProgressListenerTests", "committedDate": "2020-06-19T12:02:28Z", "type": "commit"}, {"oid": "99627bce099144d1e1f1d9d80e02ee712e3855a7", "url": "https://github.com/realm/realm-java/commit/99627bce099144d1e1f1d9d80e02ee712e3855a7", "message": "Fix ProgressListenerTests", "committedDate": "2020-06-19T13:00:06Z", "type": "commit"}, {"oid": "cfb4725e0223a1a7be84b7b60d06881f45907f5c", "url": "https://github.com/realm/realm-java/commit/cfb4725e0223a1a7be84b7b60d06881f45907f5c", "message": "Add timeout to progress listener tests to get indicators of what blocks CI", "committedDate": "2020-06-22T13:34:20Z", "type": "commit"}, {"oid": "b317f5fe67584b3e7ee4c83ecedd68e45eeb1554", "url": "https://github.com/realm/realm-java/commit/b317f5fe67584b3e7ee4c83ecedd68e45eeb1554", "message": "Minor adjustments", "committedDate": "2020-06-23T07:59:59Z", "type": "commit"}, {"oid": "937dd68d943be954c32a6a2141badc7c1151ee59", "url": "https://github.com/realm/realm-java/commit/937dd68d943be954c32a6a2141badc7c1151ee59", "message": "Minor adjustments", "committedDate": "2020-06-23T10:34:05Z", "type": "commit"}, {"oid": "119875d2a77014e71386253dd0cbd5b40a2ea00b", "url": "https://github.com/realm/realm-java/commit/119875d2a77014e71386253dd0cbd5b40a2ea00b", "message": "Minor adjustments", "committedDate": "2020-06-23T10:49:58Z", "type": "commit"}, {"oid": "301b44294b89ee1a518e6da146c6fd75c917f136", "url": "https://github.com/realm/realm-java/commit/301b44294b89ee1a518e6da146c6fd75c917f136", "message": "Merge branch 'v10' into cr/sync-integration-test-progresslisteners", "committedDate": "2020-06-23T13:48:22Z", "type": "commit"}, {"oid": "2fc19be50af75d0fd99a7107939f6c89ef11f167", "url": "https://github.com/realm/realm-java/commit/2fc19be50af75d0fd99a7107939f6c89ef11f167", "message": "Minor adjustments", "committedDate": "2020-06-23T14:35:49Z", "type": "commit"}, {"oid": "d3225a5479efd4bcd98cae196d09759e6e267e5c", "url": "https://github.com/realm/realm-java/commit/d3225a5479efd4bcd98cae196d09759e6e267e5c", "message": "Minor adjustment for CI test", "committedDate": "2020-06-23T14:47:41Z", "type": "commit"}, {"oid": "c6816ae7837d3b99664ba79949c0519810e53627", "url": "https://github.com/realm/realm-java/commit/c6816ae7837d3b99664ba79949c0519810e53627", "message": "Log user exceptions in progress listeners", "committedDate": "2020-06-24T08:27:21Z", "type": "commit"}, {"oid": "3d3bdab6b9433893cfac6127186a7f63130ebe0f", "url": "https://github.com/realm/realm-java/commit/3d3bdab6b9433893cfac6127186a7f63130ebe0f", "message": "Ignoring test until upload is not stalling", "committedDate": "2020-06-24T09:58:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgyNTI4Mw==", "url": "https://github.com/realm/realm-java/pull/6959#discussion_r444825283", "bodyText": "Looks like a mistake in the old test. This isn't used for anything.", "author": "cmelchior", "createdAt": "2020-06-24T11:24:27Z", "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/ProgressListenerTests.kt", "diffHunk": "@@ -59,44 +60,39 @@ class ProgressListenerTests {\n \n     @After\n     fun tearDown() {\n-        if (this::realm.isInitialized) {\n-            realm.close()\n-        }\n         if (this::app.isInitialized) {\n             app.close()\n         }\n         RealmLog.setLevel(LogLevel.WARN)\n     }\n \n-    @Ignore(\"See https://mongodb.slack.com/archives/CQLDYRJ3V/p1587563930459100\")\n     @Test\n     fun downloadProgressListener_changesOnly() {\n         val allChangesDownloaded = CountDownLatch(1)\n-        val user1: User = app.login(Credentials.anonymous())\n+        val user1: User = app.registerUserAndLogin(TestHelper.getRandomEmail(), \"123456\")\n         val user1Config = createSyncConfig(user1)\n-        createRemoteData(user1Config)\n-        val user2: User = app.login(Credentials.anonymous())\n+        val user2: User = app.registerUserAndLogin(TestHelper.getRandomEmail(), \"123456\")\n         val user2Config = createSyncConfig(user2)\n-        val realm = Realm.getInstance(user2Config)\n-        val session: SyncSession = realm.syncSession\n-        session.addDownloadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n-            RealmLog.error(progress.toString())\n-            if (progress.isTransferComplete) {\n-                assertTransferComplete(progress, true)\n-                assertEquals(TEST_SIZE, getStoreTestDataSize(user2Config))\n-                allChangesDownloaded.countDown()\n+        Realm.getInstance(user2Config).use { realm ->\n+            createRemoteData(user1Config)\n+            realm.syncSession.addDownloadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n+                RealmLog.error(progress.toString())", "originalCommit": "3d3bdab6b9433893cfac6127186a7f63130ebe0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg1MTEwNg==", "url": "https://github.com/realm/realm-java/pull/6959#discussion_r444851106", "bodyText": "I can remove it. Is it a general pattern to avoid log statements in tests. There are other more complicated ones that seems more essential for analyzing test failures. Maybe they should just be using Android's log instead with a different tag to not cause confusion? Or should it all go", "author": "rorbech", "createdAt": "2020-06-24T12:17:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgyNTI4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg1NzQ4Mw==", "url": "https://github.com/realm/realm-java/pull/6959#discussion_r444857483", "bodyText": "We probably left them here because of issues with them and instead of trying to reproduce them with logs enabled it was easier to try to infer the behavior from the logs the first time around.\nGenerally, we shouldn't do it, but I wouldn't be strongly opposed to keeping them here.", "author": "cmelchior", "createdAt": "2020-06-24T12:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgyNTI4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg1MzgwNw==", "url": "https://github.com/realm/realm-java/pull/6959#discussion_r446853807", "bodyText": "I removed the trivial ones, but left a single one here and there.", "author": "rorbech", "createdAt": "2020-06-29T08:23:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgyNTI4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgyNjQzNQ==", "url": "https://github.com/realm/realm-java/pull/6959#discussion_r444826435", "bodyText": "Also looks like a mistake", "author": "cmelchior", "createdAt": "2020-06-24T11:27:06Z", "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/ProgressListenerTests.kt", "diffHunk": "@@ -147,155 +144,155 @@ class ProgressListenerTests {\n         val transferCompleted = AtomicInteger(0)\n         val testDone = CountDownLatch(1)\n         val config = createSyncConfig()\n-        val realm = Realm.getInstance(config)\n-        writeSampleData(realm) // Write first batch of sample data\n-        val session: SyncSession = realm.syncSession\n-        session.addUploadProgressListener(ProgressMode.INDEFINITELY) { progress ->\n-            if (progress.isTransferComplete) {\n-                when (transferCompleted.incrementAndGet()) {\n-                    1 -> {\n-                        val realm = Realm.getInstance(config)\n-                        writeSampleData(realm)\n-                        realm.close()\n-                        throw RuntimeException(\"Crashing the changelistener\")\n-                    }\n-                    2 -> {\n-                        assertTransferComplete(progress, true)\n-                        testDone.countDown()\n+        Realm.getInstance(config).use { realm ->\n+            val session: SyncSession = realm.syncSession\n+            session.addUploadProgressListener(ProgressMode.INDEFINITELY) { progress ->\n+                if (progress.isTransferComplete) {\n+                    when (transferCompleted.incrementAndGet()) {\n+                        1 -> {\n+                            Realm.getInstance(config).use { realm ->\n+                            writeSampleData(realm)\n+                            }\n+                            throw RuntimeException(\"Crashing the changelistener\")\n+                        }\n+                        2 -> {\n+                            assertTransferComplete(progress, true)\n+                            testDone.countDown()\n+                        }\n+                        else -> fail(\"Unsupported number of transfers completed: \" + transferCompleted.get())\n                     }\n-                    else -> fail(\"Unsupported number of transfers completed: \" + transferCompleted.get())\n                 }\n             }\n+            writeSampleData(realm) // Write first batch of sample data\n+            TestHelper.awaitOrFail(testDone)\n         }\n-        TestHelper.awaitOrFail(testDone)\n-        realm.close()\n     }\n \n     @Test\n     fun uploadProgressListener_changesOnly() {\n         val allChangeUploaded = CountDownLatch(1)\n         val config = createSyncConfig()\n-        val realm = Realm.getInstance(config)\n-        writeSampleData(realm)\n-        val session: SyncSession = realm.syncSession\n-        assertEquals(SyncSession.State.ACTIVE, session.state)\n-        session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n-            RealmLog.error(progress.toString());\n-            if (progress.isTransferComplete) {\n-                assertTransferComplete(progress, true)\n-                allChangeUploaded.countDown()\n+        Realm.getInstance(config).use { realm ->\n+            val session: SyncSession = realm.syncSession\n+            assertEquals(SyncSession.State.ACTIVE, session.state)\n+            writeSampleData(realm)\n+            session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n+                RealmLog.error(progress.toString());", "originalCommit": "3d3bdab6b9433893cfac6127186a7f63130ebe0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgyNjY4Nw==", "url": "https://github.com/realm/realm-java/pull/6959#discussion_r444826687", "bodyText": "Same", "author": "cmelchior", "createdAt": "2020-06-24T11:27:35Z", "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/ProgressListenerTests.kt", "diffHunk": "@@ -147,155 +144,155 @@ class ProgressListenerTests {\n         val transferCompleted = AtomicInteger(0)\n         val testDone = CountDownLatch(1)\n         val config = createSyncConfig()\n-        val realm = Realm.getInstance(config)\n-        writeSampleData(realm) // Write first batch of sample data\n-        val session: SyncSession = realm.syncSession\n-        session.addUploadProgressListener(ProgressMode.INDEFINITELY) { progress ->\n-            if (progress.isTransferComplete) {\n-                when (transferCompleted.incrementAndGet()) {\n-                    1 -> {\n-                        val realm = Realm.getInstance(config)\n-                        writeSampleData(realm)\n-                        realm.close()\n-                        throw RuntimeException(\"Crashing the changelistener\")\n-                    }\n-                    2 -> {\n-                        assertTransferComplete(progress, true)\n-                        testDone.countDown()\n+        Realm.getInstance(config).use { realm ->\n+            val session: SyncSession = realm.syncSession\n+            session.addUploadProgressListener(ProgressMode.INDEFINITELY) { progress ->\n+                if (progress.isTransferComplete) {\n+                    when (transferCompleted.incrementAndGet()) {\n+                        1 -> {\n+                            Realm.getInstance(config).use { realm ->\n+                            writeSampleData(realm)\n+                            }\n+                            throw RuntimeException(\"Crashing the changelistener\")\n+                        }\n+                        2 -> {\n+                            assertTransferComplete(progress, true)\n+                            testDone.countDown()\n+                        }\n+                        else -> fail(\"Unsupported number of transfers completed: \" + transferCompleted.get())\n                     }\n-                    else -> fail(\"Unsupported number of transfers completed: \" + transferCompleted.get())\n                 }\n             }\n+            writeSampleData(realm) // Write first batch of sample data\n+            TestHelper.awaitOrFail(testDone)\n         }\n-        TestHelper.awaitOrFail(testDone)\n-        realm.close()\n     }\n \n     @Test\n     fun uploadProgressListener_changesOnly() {\n         val allChangeUploaded = CountDownLatch(1)\n         val config = createSyncConfig()\n-        val realm = Realm.getInstance(config)\n-        writeSampleData(realm)\n-        val session: SyncSession = realm.syncSession\n-        assertEquals(SyncSession.State.ACTIVE, session.state)\n-        session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n-            RealmLog.error(progress.toString());\n-            if (progress.isTransferComplete) {\n-                assertTransferComplete(progress, true)\n-                allChangeUploaded.countDown()\n+        Realm.getInstance(config).use { realm ->\n+            val session: SyncSession = realm.syncSession\n+            assertEquals(SyncSession.State.ACTIVE, session.state)\n+            writeSampleData(realm)\n+            session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n+                RealmLog.error(progress.toString());\n+                if (progress.isTransferComplete) {\n+                    assertTransferComplete(progress, true)\n+                    allChangeUploaded.countDown()\n+                }\n             }\n+            TestHelper.awaitOrFail(allChangeUploaded)\n         }\n-        TestHelper.awaitOrFail(allChangeUploaded)\n-        realm.close()\n     }\n \n     @Test\n     fun uploadProgressListener_indefinitely() {\n         val transferCompleted = AtomicInteger(0)\n         val testDone = CountDownLatch(1)\n         val config = createSyncConfig()\n-        val realm = Realm.getInstance(config)\n-        writeSampleData(realm) // Write first batch of sample data\n-        val session: SyncSession = realm.syncSession\n-        session.addUploadProgressListener(ProgressMode.INDEFINITELY) { progress ->\n-            if (progress.isTransferComplete) {\n-                when (transferCompleted.incrementAndGet()) {\n-                    1 -> {\n-                        val realm = Realm.getInstance(config)\n-                        writeSampleData(realm)\n-                        realm.close()\n-                    }\n-                    2 -> {\n-                        assertTransferComplete(progress, true)\n-                        testDone.countDown()\n+        Realm.getInstance(config).use { realm ->\n+            val session: SyncSession = realm.syncSession\n+            session.addUploadProgressListener(ProgressMode.INDEFINITELY) { progress ->\n+                if (progress.isTransferComplete) {\n+                    when (transferCompleted.incrementAndGet()) {\n+                        1 -> {\n+                            Realm.getInstance(config).use { realm ->\n+                                writeSampleData(realm)\n+                            }\n+                        }\n+                        2 -> {\n+                            assertTransferComplete(progress, true)\n+                            testDone.countDown()\n+                        }\n+                        else -> fail(\"Unsupported number of transfers completed: \" + transferCompleted.get())\n                     }\n-                    else -> fail(\"Unsupported number of transfers completed: \" + transferCompleted.get())\n                 }\n             }\n+            writeSampleData(realm) // Write first batch of sample data\n+            TestHelper.awaitOrFail(testDone)\n         }\n-        TestHelper.awaitOrFail(testDone)\n-        realm.close()\n     }\n \n     @Test\n     fun addListenerInsideCallback() {\n         val allChangeUploaded = CountDownLatch(1)\n         val config = createSyncConfig()\n-        val realm = Realm.getInstance(config)\n-        writeSampleData(realm)\n-        val session: SyncSession = realm.syncSession\n-        session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n-            if (progress.isTransferComplete) {\n-                val realm = Realm.getInstance(config)\n-                writeSampleData(realm)\n-                realm.close()\n-                session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n-                    if (progress.isTransferComplete) {\n-                        allChangeUploaded.countDown()\n+        Realm.getInstance(config).use { realm ->\n+            val session: SyncSession = realm.syncSession\n+            writeSampleData(realm)\n+            session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n+                if (progress.isTransferComplete) {\n+                    Realm.getInstance(config).use { realm ->\n+                        writeSampleData(realm)\n+                    }\n+                    session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n+                        if (progress.isTransferComplete) {\n+                            allChangeUploaded.countDown()\n+                        }\n                     }\n                 }\n             }\n+            TestHelper.awaitOrFail(allChangeUploaded)\n         }\n-        TestHelper.awaitOrFail(allChangeUploaded)\n-        realm.close()\n     }\n \n     @Test\n     fun addListenerInsideCallback_mixProgressModes() {\n         val allChangeUploaded = CountDownLatch(3)\n         val progressCompletedReported = AtomicBoolean(false)\n         val config = createSyncConfig()\n-        val realm = Realm.getInstance(config)\n-        writeSampleData(realm)\n-        val session: SyncSession = realm.syncSession\n-        session.addUploadProgressListener(ProgressMode.INDEFINITELY) { progress ->\n-            if (progress.isTransferComplete) {\n-                allChangeUploaded.countDown()\n-                if (progressCompletedReported.compareAndSet(false, true)) {\n-                    val realm = Realm.getInstance(config)\n-                    writeSampleData(realm)\n-                    realm.close()\n-                    session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n-                        if (progress.isTransferComplete) {\n-                            allChangeUploaded.countDown()\n+        Realm.getInstance(config).use { realm ->\n+            val session: SyncSession = realm.syncSession\n+            session.addUploadProgressListener(ProgressMode.INDEFINITELY) { progress ->\n+                if (progress.isTransferComplete) {\n+                    allChangeUploaded.countDown()\n+                    if (progressCompletedReported.compareAndSet(false, true)) {\n+                        Realm.getInstance(config).use { realm ->\n+                            writeSampleData(realm)\n+                        }\n+                        session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n+                            if (progress.isTransferComplete) {\n+                                allChangeUploaded.countDown()\n+                            }\n                         }\n                     }\n                 }\n             }\n+            writeSampleData(realm)\n+            TestHelper.awaitOrFail(allChangeUploaded)\n         }\n-        TestHelper.awaitOrFail(allChangeUploaded)\n-        realm.close()\n     }\n \n     @Test\n     fun addProgressListener_triggerImmediatelyWhenRegistered() {\n         val config = createSyncConfig()\n-        val realm = Realm.getInstance(config)\n-        val session: SyncSession = realm.syncSession\n-        checkListener(session, ProgressMode.INDEFINITELY)\n-        checkListener(session, ProgressMode.CURRENT_CHANGES)\n-        realm.close()\n+        Realm.getInstance(config).use { realm ->\n+            val session: SyncSession = realm.syncSession\n+            checkListener(session, ProgressMode.INDEFINITELY)\n+            checkListener(session, ProgressMode.CURRENT_CHANGES)\n+        }\n     }\n \n     @Test\n     fun uploadListener_keepIncreasingInSize() {\n         val config = createSyncConfig()\n-        val realm = Realm.getInstance(config)\n-        val session: SyncSession = realm.syncSession\n-        for (i in 0..9) {\n-            val changesUploaded = CountDownLatch(1)\n-            writeSampleData(realm)\n-            session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n-                RealmLog.info(\"Test %s -> %s\", Integer.toString(i), progress.toString())\n-                if (progress.isTransferComplete) {\n-                    assertTransferComplete(progress, true)\n-                    changesUploaded.countDown()\n+        Realm.getInstance(config).use { realm ->\n+            val session: SyncSession = realm.syncSession\n+            for (i in 0..9) {\n+                val changesUploaded = CountDownLatch(1)\n+                writeSampleData(realm)\n+                session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n+                    RealmLog.info(\"Test %s -> %s\", Integer.toString(i), progress.toString())", "originalCommit": "3d3bdab6b9433893cfac6127186a7f63130ebe0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgyNzA0NA==", "url": "https://github.com/realm/realm-java/pull/6959#discussion_r444827044", "bodyText": "Hmm, is refreshing here really neeeded?", "author": "cmelchior", "createdAt": "2020-06-24T11:28:19Z", "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/ProgressListenerTests.kt", "diffHunk": "@@ -325,30 +322,30 @@ class ProgressListenerTests {\n \n     // Create remote data for a given user.\n     private fun createRemoteData(config: SyncConfiguration) {\n-        val realm = Realm.getInstance(config)\n-        val changesUploaded = CountDownLatch(1)\n-        writeSampleData(realm)\n-        val session: SyncSession = realm.syncSession\n-        session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES, object : ProgressListener {\n-            override fun onChange(progress: Progress) {\n-                if (progress.isTransferComplete) {\n-                    session.removeProgressListener(this)\n-                    changesUploaded.countDown()\n+        Realm.getInstance(config).use { realm ->\n+            val changesUploaded = CountDownLatch(1)\n+            val session: SyncSession = realm.syncSession\n+            writeSampleData(realm)\n+            session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES, object : ProgressListener {\n+                override fun onChange(progress: Progress) {\n+                    if (progress.isTransferComplete) {\n+                        session.removeProgressListener(this)\n+                        changesUploaded.countDown()\n+                    }\n                 }\n-            }\n-        })\n-        TestHelper.awaitOrFail(changesUploaded)\n-        realm.close()\n+            })\n+            TestHelper.awaitOrFail(changesUploaded)\n+        }\n     }\n \n     private fun getStoreTestDataSize(config: RealmConfiguration): Long {\n-        val realm: Realm = Realm.getInstance(config)\n-        val objectCounts: Long = realm.where<SyncDog>().count()\n-        realm.close()\n-        return objectCounts\n+        Realm.getInstance(config).use { realm ->\n+            realm.refresh()", "originalCommit": "3d3bdab6b9433893cfac6127186a7f63130ebe0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4ODg1Nw==", "url": "https://github.com/realm/realm-java/pull/6959#discussion_r446888857", "bodyText": "Not really. I had some troubles getting my head around the semantics of the progress listeners from the start. I reverted the change.\nConceptually it could make sense to have here as the check would most likely always make sense to do after refreshing, but due to the heavy reliance on order of operations the test are already written with the order in mind.", "author": "rorbech", "createdAt": "2020-06-29T11:10:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgyNzA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgzOTQ3Mw==", "url": "https://github.com/realm/realm-java/pull/6959#discussion_r444839473", "bodyText": "This seems like a behavioral change, where we now swallow the exception?\nNote, it is probably not a bad idea since callbacks generally shouldn't be allowed to crash here, but as a minimum, we would need a test for it + an update to the breaking section of the changelog", "author": "cmelchior", "createdAt": "2020-06-24T11:53:40Z", "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/sync/SyncSession.java", "diffHunk": "@@ -259,13 +259,21 @@ public boolean isConnected() {\n         return (sessionState == State.ACTIVE || sessionState == State.DYING) && connectionState == ConnectionState.CONNECTED;\n     }\n \n+    /**\n+     * All progress listener events from native Sync are reported to this method.\n+     */\n+    @SuppressWarnings(\"unused\")\n     synchronized void notifyProgressListener(long listenerId, long transferredBytes, long transferableBytes) {\n         Pair<ProgressListener, Progress> listener = listenerIdToProgressListenerMap.get(listenerId);\n         if (listener != null) {\n             Progress newProgressNotification = new Progress(transferredBytes, transferableBytes);\n             if (!newProgressNotification.equals(listener.second)) {\n                 listener.second = newProgressNotification;\n-                listener.first.onChange(newProgressNotification);\n+                try {\n+                    listener.first.onChange(newProgressNotification);\n+                } catch (Exception exception) {\n+                    RealmLog.error(exception);", "originalCommit": "3d3bdab6b9433893cfac6127186a7f63130ebe0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg0NjMwMA==", "url": "https://github.com/realm/realm-java/pull/6959#discussion_r444846300", "bodyText": "We also swallowed it before, just in Sync.notifyProgressListeners. Since the callback is directly on the SyncSession I just replicated it.\nMaybe this was not that obvious as the Sync.notifyProgressListener is still there even though unused, but I left it as I thought we would/reuse it when fixing the leakage of session objects.", "author": "rorbech", "createdAt": "2020-06-24T12:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgzOTQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg0NjY2Ng==", "url": "https://github.com/realm/realm-java/pull/6959#discussion_r444846666", "bodyText": "The reason why I introduced it was that we in fact have a test for it :)", "author": "rorbech", "createdAt": "2020-06-24T12:08:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgzOTQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg1NjQ5NQ==", "url": "https://github.com/realm/realm-java/pull/6959#discussion_r444856495", "bodyText": "Cool \ud83d\udc4d", "author": "cmelchior", "createdAt": "2020-06-24T12:26:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgzOTQ3Mw=="}], "type": "inlineReview"}, {"oid": "c95793af14e7d3755633a14ff972d7eb52483188", "url": "https://github.com/realm/realm-java/commit/c95793af14e7d3755633a14ff972d7eb52483188", "message": "Updates according to code review", "committedDate": "2020-06-29T08:06:49Z", "type": "commit"}, {"oid": "fd45e7b1891123848ea8d696ef271ddeacde7ba6", "url": "https://github.com/realm/realm-java/commit/fd45e7b1891123848ea8d696ef271ddeacde7ba6", "message": "Add test for initial progress listener callback on waitForInitialRemoteData", "committedDate": "2020-06-29T08:11:43Z", "type": "commit"}, {"oid": "8554e49f66c63640502fc1c1cea1680aeef0c8df", "url": "https://github.com/realm/realm-java/commit/8554e49f66c63640502fc1c1cea1680aeef0c8df", "message": "Update test server image", "committedDate": "2020-06-29T08:12:11Z", "type": "commit"}, {"oid": "b4f2cc642f2835058cad5a34e09e714f7601fc50", "url": "https://github.com/realm/realm-java/commit/b4f2cc642f2835058cad5a34e09e714f7601fc50", "message": "Ignore failing test but track issue", "committedDate": "2020-06-29T09:49:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4Njc4OQ==", "url": "https://github.com/realm/realm-java/pull/6959#discussion_r446886789", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Ignore(\"Tracked by https://github.com/realm/realm-java/issues/6976\")\n          \n          \n            \n                @Ignore(\"FIXME: Tracked by https://github.com/realm/realm-java/issues/6976\")\n          \n      \n    \n    \n  \n\nMakes it easier to find again when searching the codebase", "author": "cmelchior", "createdAt": "2020-06-29T11:05:30Z", "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/ProgressListenerTests.kt", "diffHunk": "@@ -147,171 +141,198 @@ class ProgressListenerTests {\n         val transferCompleted = AtomicInteger(0)\n         val testDone = CountDownLatch(1)\n         val config = createSyncConfig()\n-        val realm = Realm.getInstance(config)\n-        writeSampleData(realm) // Write first batch of sample data\n-        val session: SyncSession = realm.syncSession\n-        session.addUploadProgressListener(ProgressMode.INDEFINITELY) { progress ->\n-            if (progress.isTransferComplete) {\n-                when (transferCompleted.incrementAndGet()) {\n-                    1 -> {\n-                        val realm = Realm.getInstance(config)\n-                        writeSampleData(realm)\n-                        realm.close()\n-                        throw RuntimeException(\"Crashing the changelistener\")\n-                    }\n-                    2 -> {\n-                        assertTransferComplete(progress, true)\n-                        testDone.countDown()\n+        Realm.getInstance(config).use { realm ->\n+            val session: SyncSession = realm.syncSession\n+            session.addUploadProgressListener(ProgressMode.INDEFINITELY) { progress ->\n+                if (progress.isTransferComplete) {\n+                    when (transferCompleted.incrementAndGet()) {\n+                        1 -> {\n+                            Realm.getInstance(config).use { realm ->\n+                            writeSampleData(realm)\n+                            }\n+                            throw RuntimeException(\"Crashing the changelistener\")\n+                        }\n+                        2 -> {\n+                            assertTransferComplete(progress, true)\n+                            testDone.countDown()\n+                        }\n+                        else -> fail(\"Unsupported number of transfers completed: \" + transferCompleted.get())\n                     }\n-                    else -> fail(\"Unsupported number of transfers completed: \" + transferCompleted.get())\n                 }\n             }\n+            writeSampleData(realm) // Write first batch of sample data\n+            TestHelper.awaitOrFail(testDone)\n         }\n-        TestHelper.awaitOrFail(testDone)\n-        realm.close()\n     }\n \n     @Test\n     fun uploadProgressListener_changesOnly() {\n         val allChangeUploaded = CountDownLatch(1)\n         val config = createSyncConfig()\n-        val realm = Realm.getInstance(config)\n-        writeSampleData(realm)\n-        val session: SyncSession = realm.syncSession\n-        assertEquals(SyncSession.State.ACTIVE, session.state)\n-        session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n-            RealmLog.error(progress.toString());\n-            if (progress.isTransferComplete) {\n-                assertTransferComplete(progress, true)\n-                allChangeUploaded.countDown()\n+        Realm.getInstance(config).use { realm ->\n+            val session: SyncSession = realm.syncSession\n+            assertEquals(SyncSession.State.ACTIVE, session.state)\n+            writeSampleData(realm)\n+            session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n+                if (progress.isTransferComplete) {\n+                    assertTransferComplete(progress, true)\n+                    allChangeUploaded.countDown()\n+                }\n             }\n+            TestHelper.awaitOrFail(allChangeUploaded)\n         }\n-        TestHelper.awaitOrFail(allChangeUploaded)\n-        realm.close()\n     }\n \n     @Test\n     fun uploadProgressListener_indefinitely() {\n         val transferCompleted = AtomicInteger(0)\n         val testDone = CountDownLatch(1)\n         val config = createSyncConfig()\n-        val realm = Realm.getInstance(config)\n-        writeSampleData(realm) // Write first batch of sample data\n-        val session: SyncSession = realm.syncSession\n-        session.addUploadProgressListener(ProgressMode.INDEFINITELY) { progress ->\n-            if (progress.isTransferComplete) {\n-                when (transferCompleted.incrementAndGet()) {\n-                    1 -> {\n-                        val realm = Realm.getInstance(config)\n-                        writeSampleData(realm)\n-                        realm.close()\n-                    }\n-                    2 -> {\n-                        assertTransferComplete(progress, true)\n-                        testDone.countDown()\n+        Realm.getInstance(config).use { realm ->\n+            val session: SyncSession = realm.syncSession\n+            session.addUploadProgressListener(ProgressMode.INDEFINITELY) { progress ->\n+                if (progress.isTransferComplete) {\n+                    when (transferCompleted.incrementAndGet()) {\n+                        1 -> {\n+                            Realm.getInstance(config).use { realm ->\n+                                writeSampleData(realm)\n+                            }\n+                        }\n+                        2 -> {\n+                            assertTransferComplete(progress, true)\n+                            testDone.countDown()\n+                        }\n+                        else -> fail(\"Unsupported number of transfers completed: \" + transferCompleted.get())\n                     }\n-                    else -> fail(\"Unsupported number of transfers completed: \" + transferCompleted.get())\n                 }\n             }\n+            writeSampleData(realm) // Write first batch of sample data\n+            TestHelper.awaitOrFail(testDone)\n         }\n-        TestHelper.awaitOrFail(testDone)\n-        realm.close()\n     }\n \n     @Test\n     fun addListenerInsideCallback() {\n         val allChangeUploaded = CountDownLatch(1)\n         val config = createSyncConfig()\n-        val realm = Realm.getInstance(config)\n-        writeSampleData(realm)\n-        val session: SyncSession = realm.syncSession\n-        session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n-            if (progress.isTransferComplete) {\n-                val realm = Realm.getInstance(config)\n-                writeSampleData(realm)\n-                realm.close()\n-                session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n-                    if (progress.isTransferComplete) {\n-                        allChangeUploaded.countDown()\n+        Realm.getInstance(config).use { realm ->\n+            val session: SyncSession = realm.syncSession\n+            writeSampleData(realm)\n+            session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n+                if (progress.isTransferComplete) {\n+                    Realm.getInstance(config).use { realm ->\n+                        writeSampleData(realm)\n+                    }\n+                    session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n+                        if (progress.isTransferComplete) {\n+                            allChangeUploaded.countDown()\n+                        }\n                     }\n                 }\n             }\n+            TestHelper.awaitOrFail(allChangeUploaded)\n         }\n-        TestHelper.awaitOrFail(allChangeUploaded)\n-        realm.close()\n     }\n \n     @Test\n     fun addListenerInsideCallback_mixProgressModes() {\n         val allChangeUploaded = CountDownLatch(3)\n         val progressCompletedReported = AtomicBoolean(false)\n         val config = createSyncConfig()\n-        val realm = Realm.getInstance(config)\n-        writeSampleData(realm)\n-        val session: SyncSession = realm.syncSession\n-        session.addUploadProgressListener(ProgressMode.INDEFINITELY) { progress ->\n-            if (progress.isTransferComplete) {\n-                allChangeUploaded.countDown()\n-                if (progressCompletedReported.compareAndSet(false, true)) {\n-                    val realm = Realm.getInstance(config)\n-                    writeSampleData(realm)\n-                    realm.close()\n-                    session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n-                        if (progress.isTransferComplete) {\n-                            allChangeUploaded.countDown()\n+        Realm.getInstance(config).use { realm ->\n+            val session: SyncSession = realm.syncSession\n+            session.addUploadProgressListener(ProgressMode.INDEFINITELY) { progress ->\n+                if (progress.isTransferComplete) {\n+                    allChangeUploaded.countDown()\n+                    if (progressCompletedReported.compareAndSet(false, true)) {\n+                        Realm.getInstance(config).use { realm ->\n+                            writeSampleData(realm)\n+                        }\n+                        session.addUploadProgressListener(ProgressMode.CURRENT_CHANGES) { progress ->\n+                            if (progress.isTransferComplete) {\n+                                allChangeUploaded.countDown()\n+                            }\n                         }\n                     }\n                 }\n             }\n+            writeSampleData(realm)\n+            TestHelper.awaitOrFail(allChangeUploaded)\n         }\n-        TestHelper.awaitOrFail(allChangeUploaded)\n-        realm.close()\n     }\n \n     @Test\n     fun addProgressListener_triggerImmediatelyWhenRegistered() {\n         val config = createSyncConfig()\n-        val realm = Realm.getInstance(config)\n-        val session: SyncSession = realm.syncSession\n-        checkListener(session, ProgressMode.INDEFINITELY)\n-        checkListener(session, ProgressMode.CURRENT_CHANGES)\n-        realm.close()\n+        Realm.getInstance(config).use { realm ->\n+            val session: SyncSession = realm.syncSession\n+            checkDownloadListener(session, ProgressMode.INDEFINITELY)\n+            checkUploadListener(session, ProgressMode.INDEFINITELY)\n+            checkDownloadListener(session, ProgressMode.CURRENT_CHANGES)\n+            checkUploadListener(session, ProgressMode.CURRENT_CHANGES)\n+        }\n+    }\n+\n+    @Test\n+    @Ignore(\"Tracked by https://github.com/realm/realm-java/issues/6976\")", "originalCommit": "b4f2cc642f2835058cad5a34e09e714f7601fc50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "579211073da259eecde5ad6fa661d216b5867063", "url": "https://github.com/realm/realm-java/commit/579211073da259eecde5ad6fa661d216b5867063", "message": "Apply suggestions from code review\n\nCo-authored-by: Christian Melchior <christian@ilios.dk>", "committedDate": "2020-06-29T11:11:22Z", "type": "commit"}, {"oid": "6e04e2c395fa1e441eaa922e848cb6ff3c904576", "url": "https://github.com/realm/realm-java/commit/6e04e2c395fa1e441eaa922e848cb6ff3c904576", "message": "Merge branch 'v10' into cr/sync-integration-test-progresslisteners", "committedDate": "2020-06-29T11:24:44Z", "type": "commit"}]}