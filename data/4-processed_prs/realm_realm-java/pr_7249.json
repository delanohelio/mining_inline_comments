{"pr_number": 7249, "pr_title": "Fix list streams crashing if parent object was deleted.", "pr_createdAt": "2020-12-16T14:54:50Z", "pr_url": "https://github.com/realm/realm-java/pull/7249", "timeline": [{"oid": "b6890050398b65147c4398b6d7f2f5ecdb9ccd59", "url": "https://github.com/realm/realm-java/commit/b6890050398b65147c4398b6d7f2f5ecdb9ccd59", "message": "Fix list streams crashing if parent object was deleted.", "committedDate": "2020-12-16T14:48:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDg3NjMxMw==", "url": "https://github.com/realm/realm-java/pull/7249#discussion_r544876313", "bodyText": "Maybe not required for now, but I guess you could communicate through a channel now that we are in a coroutine context. That would make it cleaner when waiting for the result. Good old CSP.", "author": "rorbech", "createdAt": "2020-12-17T07:47:11Z", "path": "realm/kotlin-extensions/src/androidTest/kotlin/io/realm/CoroutinesTests.kt", "diffHunk": "@@ -924,6 +928,160 @@ class CoroutinesTests {\n         TestHelper.awaitOrFail(countDownLatch)\n     }\n \n+    @Test\n+    fun realmList_flow_parentDeletionComplete() = looperThread.runBlocking {\n+        val realm = Realm.getInstance(configuration)\n+        realm.beginTransaction()\n+        val parent = realm.createObject<AllTypes>()\n+        val list = parent.columnRealmList\n+        list.add(Dog(\"dog\"))\n+        realm.commitTransaction()\n+\n+        val collectingStarted = AtomicBoolean(false)\n+        val context = looperThread.asDispatcher()\n+        val scope = CoroutineScope(context)\n+        scope.launch {\n+            // We should only emit valid lists. If the parent of the list is invalidated\n+            // it should close the stream gracefully resulting in onComplete being called.\n+            list.toFlow()\n+                    .onEach { assertTrue(it.isValid) }\n+                    .onCompletion {\n+                        realm.close()\n+                        looperThread.testComplete()\n+                    }.collect {\n+                        collectingStarted.set(true)", "originalCommit": "b6890050398b65147c4398b6d7f2f5ecdb9ccd59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA3OTMxNA==", "url": "https://github.com/realm/realm-java/pull/7249#discussion_r545079314", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            * RxJava Flowables/Observables and Coroutine Flows would crash if they where created from a `RealmList` and the parent object holding the list was deleted. Now, the stream is disposed/closed instead. (Issue [#7242](https://github.com/realm/realm-java/issues/7242)) \n          \n          \n            \n            * RxJava Flowables/Observables and Coroutine Flows would crash if they were created from a `RealmList` and the parent object holding the list was deleted. Now, the stream is disposed/closed instead. (Issue [#7242](https://github.com/realm/realm-java/issues/7242))", "author": "edualonso", "createdAt": "2020-12-17T13:12:46Z", "path": "CHANGELOG.md", "diffHunk": "@@ -1,3 +1,19 @@\n+## 10.2.1 (YYYY-MM-DD)\n+\n+### Enhancements\n+* None.\n+\n+### Fixes\n+* RxJava Flowables/Observables and Coroutine Flows would crash if they where created from a `RealmList` and the parent object holding the list was deleted. Now, the stream is disposed/closed instead. (Issue [#7242](https://github.com/realm/realm-java/issues/7242)) ", "originalCommit": "b6890050398b65147c4398b6d7f2f5ecdb9ccd59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA4MjExMg==", "url": "https://github.com/realm/realm-java/pull/7249#discussion_r545082112", "bodyText": "\ud83d\udc4f", "author": "edualonso", "createdAt": "2020-12-17T13:17:15Z", "path": "realm/realm-library/src/testUtils/kotlin/io/realm/rule/BlockingLooperThread.kt", "diffHunk": "@@ -222,6 +208,11 @@ class BlockingLooperThread {\n         }\n     }\n \n+    fun asDispatcher(): CoroutineContext {", "originalCommit": "b6890050398b65147c4398b6d7f2f5ecdb9ccd59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5897549fa4878999a96e0b02c5deb08ec17d44a7", "url": "https://github.com/realm/realm-java/commit/5897549fa4878999a96e0b02c5deb08ec17d44a7", "message": "Merge branch 'releases' into cm/bug/stream-delete-list-parent\n\n# Conflicts:\n#\tCHANGELOG.md", "committedDate": "2021-01-12T08:29:41Z", "type": "commit"}, {"oid": "e9c964d3027fba49238854042b225f31f6b1449e", "url": "https://github.com/realm/realm-java/commit/e9c964d3027fba49238854042b225f31f6b1449e", "message": "Fix changelog", "committedDate": "2021-01-12T08:30:46Z", "type": "commit"}]}