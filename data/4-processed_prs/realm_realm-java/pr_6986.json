{"pr_number": 6986, "pr_title": "Leaking objects when registering session listeners", "pr_createdAt": "2020-07-02T17:31:26Z", "pr_url": "https://github.com/realm/realm-java/pull/6986", "timeline": [{"oid": "46a5cebf032faf6fcc0215fdfb040191835ca0f6", "url": "https://github.com/realm/realm-java/commit/46a5cebf032faf6fcc0215fdfb040191835ca0f6", "message": "Create JNI global references handler that plays along with lambda functions", "committedDate": "2020-07-02T17:18:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwMTE3Ng==", "url": "https://github.com/realm/realm-java/pull/6986#discussion_r449401176", "bodyText": "I would always add some justification as to why this could be used (e.g. the description you have in the PR).", "author": "cmelchior", "createdAt": "2020-07-03T06:35:38Z", "path": "realm/realm-library/src/main/cpp/jni_util/java_global_ref_copy.hpp", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+#ifndef REALM_JNI_UTIL_JAVA_GLOBAL_REF_COPY_HPP\n+#define REALM_JNI_UTIL_JAVA_GLOBAL_REF_COPY_HPP\n+\n+#include <jni.h>\n+\n+namespace realm {\n+    namespace jni_util {\n+\n+        // Manage the lifecycle of jobject's global ref via copy constructors", "originalCommit": "46a5cebf032faf6fcc0215fdfb040191835ca0f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwMTU0OA==", "url": "https://github.com/realm/realm-java/pull/6986#discussion_r449401548", "bodyText": "Would it make sense to rename these classes to JavaGlobalRefByMove and JavaGlobalRefByCopy? Just to make it clear from the class name? Having just JavaGlobalRef and JavaGlobalRefCopy` might be confusing?", "author": "cmelchior", "createdAt": "2020-07-03T06:36:36Z", "path": "realm/realm-library/src/main/cpp/jni_util/java_global_ref_copy.hpp", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+#ifndef REALM_JNI_UTIL_JAVA_GLOBAL_REF_COPY_HPP\n+#define REALM_JNI_UTIL_JAVA_GLOBAL_REF_COPY_HPP\n+\n+#include <jni.h>\n+\n+namespace realm {\n+    namespace jni_util {\n+\n+        // Manage the lifecycle of jobject's global ref via copy constructors\n+        class JavaGlobalRefCopy {", "originalCommit": "46a5cebf032faf6fcc0215fdfb040191835ca0f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwOTM2MQ==", "url": "https://github.com/realm/realm-java/pull/6986#discussion_r449409361", "bodyText": "Yes, it is better your proposal.", "author": "clementetb", "createdAt": "2020-07-03T06:57:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwMTU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwMzQ2Mw==", "url": "https://github.com/realm/realm-java/pull/6986#discussion_r449403463", "bodyText": "Don't we need to delete the move constructor in a similar to how the copy constructor is deleted in JavaGlobalRef?", "author": "cmelchior", "createdAt": "2020-07-03T06:41:54Z", "path": "realm/realm-library/src/main/cpp/jni_util/java_global_ref_copy.hpp", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+#ifndef REALM_JNI_UTIL_JAVA_GLOBAL_REF_COPY_HPP\n+#define REALM_JNI_UTIL_JAVA_GLOBAL_REF_COPY_HPP\n+\n+#include <jni.h>\n+\n+namespace realm {\n+    namespace jni_util {\n+\n+        // Manage the lifecycle of jobject's global ref via copy constructors\n+        class JavaGlobalRefCopy {\n+        public:\n+            JavaGlobalRefCopy();\n+\n+            JavaGlobalRefCopy(JNIEnv *env, jobject obj);\n+\n+            JavaGlobalRefCopy(const JavaGlobalRefCopy &rhs);", "originalCommit": "46a5cebf032faf6fcc0215fdfb040191835ca0f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "20c90a45f8ee15fbdf1be14238371cdac123057b", "url": "https://github.com/realm/realm-java/commit/20c90a45f8ee15fbdf1be14238371cdac123057b", "message": "Include PR requests:\nRename JavaGlobalRef helpers\nAdd better description\nRemove default move constructor\nFix other leaks", "committedDate": "2020-07-03T09:19:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0MzIyMg==", "url": "https://github.com/realm/realm-java/pull/6986#discussion_r449543222", "bodyText": "Seems like this should have been deleted?", "author": "cmelchior", "createdAt": "2020-07-03T11:51:50Z", "path": "realm/realm-library/src/main/cpp/jni_util/java_global_ref_by_copy.hpp", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+#ifndef REALM_JNI_UTIL_JAVA_GLOBAL_REF_COPY_HPP\n+#define REALM_JNI_UTIL_JAVA_GLOBAL_REF_COPY_HPP\n+\n+#include <jni.h>\n+\n+namespace realm {\n+    namespace jni_util {\n+\n+        // Manages the lifecycle of jobject's global ref via copy constructors\n+        //\n+        // It prevents leaking global references by automatically referencing and unreferencing Java objects\n+        // any time the instance is copied or destroyed. Its principal use is on data structures that don't support\n+        // moving operations such as in std::function lambdas.\n+        //\n+        // Note that there is another flavor exists: JavaGlobalRefByMove. It manages the reference lifecycle by moving\n+        // operations.\n+        // Manages the lifecycle of jobject's global ref via move constructors", "originalCommit": "20c90a45f8ee15fbdf1be14238371cdac123057b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3078e5b6024661b96d878949230c6de6004b0c55", "url": "https://github.com/realm/realm-java/commit/3078e5b6024661b96d878949230c6de6004b0c55", "message": "Fix typos", "committedDate": "2020-07-03T13:40:28Z", "type": "commit"}, {"oid": "8b21f57538dddc04be4a81518ca008676c2f81e1", "url": "https://github.com/realm/realm-java/commit/8b21f57538dddc04be4a81518ca008676c2f81e1", "message": "Add fixes in change log", "committedDate": "2020-07-03T13:44:05Z", "type": "commit"}, {"oid": "fcb395e24aaf344664f8fed1c46d3fe4f507809e", "url": "https://github.com/realm/realm-java/commit/fcb395e24aaf344664f8fed1c46d3fe4f507809e", "message": "Merge branch 'v10' into ct/RJAVA-614", "committedDate": "2020-07-03T14:09:46Z", "type": "commit"}, {"oid": "1606a222488e9023ea7fa84e45f7f6ea473c8b95", "url": "https://github.com/realm/realm-java/commit/1606a222488e9023ea7fa84e45f7f6ea473c8b95", "message": "Merge branch 'v10' into ct/RJAVA-614", "committedDate": "2020-07-03T19:59:03Z", "type": "commit"}]}