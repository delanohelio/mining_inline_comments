{"pr_number": 6884, "pr_title": "Migrating and enabling sync session integration test", "pr_createdAt": "2020-05-28T11:12:02Z", "pr_url": "https://github.com/realm/realm-java/pull/6884", "timeline": [{"oid": "f6c4d3af98c41ea5515b590d2871bdac14da24a2", "url": "https://github.com/realm/realm-java/commit/f6c4d3af98c41ea5515b590d2871bdac14da24a2", "message": "Move integration tests to Kotlin source set", "committedDate": "2020-05-26T14:56:40Z", "type": "commit"}, {"oid": "1a254cf82a57246fb212b5227b4451f2c359c3b1", "url": "https://github.com/realm/realm-java/commit/1a254cf82a57246fb212b5227b4451f2c359c3b1", "message": "Automatic conversion of integration test to Kotlin", "committedDate": "2020-05-26T15:10:10Z", "type": "commit"}, {"oid": "b25841a8066a08cb0d8287830626cac072bc6fce", "url": "https://github.com/realm/realm-java/commit/b25841a8066a08cb0d8287830626cac072bc6fce", "message": "Fix serialization of partition values", "committedDate": "2020-05-28T10:21:46Z", "type": "commit"}, {"oid": "914fa1a79bd59f1ed07bc360e1c8c8d5bda6de4a", "url": "https://github.com/realm/realm-java/commit/914fa1a79bd59f1ed07bc360e1c8c8d5bda6de4a", "message": "Revert conversion of SyncedRealmIntegrationTests to keep PR smaller", "committedDate": "2020-05-28T10:26:40Z", "type": "commit"}, {"oid": "8e3a5b980c15c8d4e59d444ffd37342c618e1468", "url": "https://github.com/realm/realm-java/commit/8e3a5b980c15c8d4e59d444ffd37342c618e1468", "message": "Updated SyncSessionTests", "committedDate": "2020-05-28T10:28:20Z", "type": "commit"}, {"oid": "5b7b4c117ba4e736a6ecb8992dcbd39aa912605d", "url": "https://github.com/realm/realm-java/commit/5b7b4c117ba4e736a6ecb8992dcbd39aa912605d", "message": "Add primary keys for synced classes", "committedDate": "2020-05-28T10:44:41Z", "type": "commit"}, {"oid": "de035639e369cb46a4ed9981ea64ff1a359b2a03", "url": "https://github.com/realm/realm-java/commit/de035639e369cb46a4ed9981ea64ff1a359b2a03", "message": "Make SyncConfigurations with diffferent partitionValue differ", "committedDate": "2020-05-28T10:51:35Z", "type": "commit"}, {"oid": "6d434c07b9f2695b8a119cc5c203a2af52e1917e", "url": "https://github.com/realm/realm-java/commit/6d434c07b9f2695b8a119cc5c203a2af52e1917e", "message": "Revert \"Add primary keys for synced classes\"\n\nThis reverts commit 5b7b4c117ba4e736a6ecb8992dcbd39aa912605d.", "committedDate": "2020-05-28T13:09:17Z", "type": "commit"}, {"oid": "fbcef54eb60ae1cf41703d4b0d457de182abaf20", "url": "https://github.com/realm/realm-java/commit/fbcef54eb60ae1cf41703d4b0d457de182abaf20", "message": "Add separate sync entities with primary keys", "committedDate": "2020-05-28T14:47:40Z", "type": "commit"}, {"oid": "e5010964214cf5be6b98c9ddf4bb437b67fdb00d", "url": "https://github.com/realm/realm-java/commit/e5010964214cf5be6b98c9ddf4bb437b67fdb00d", "message": "Move partition value serialization out of basic flavor", "committedDate": "2020-05-29T08:35:31Z", "type": "commit"}, {"oid": "661b2fc7a031b15b0c107d587784b39346ca089d", "url": "https://github.com/realm/realm-java/commit/661b2fc7a031b15b0c107d587784b39346ca089d", "message": "Merge branch 'v10' into cr/sync-integration-test-session", "committedDate": "2020-05-30T21:54:52Z", "type": "commit"}, {"oid": "8c1aa7f562f4d12dce501c54d8a15ee5e75f6a68", "url": "https://github.com/realm/realm-java/commit/8c1aa7f562f4d12dce501c54d8a15ee5e75f6a68", "message": "Fix SyncConfigruation equals", "committedDate": "2020-05-30T22:10:54Z", "type": "commit"}, {"oid": "ec7162dbb67e1bb6bd623576c5cb242bc7145630", "url": "https://github.com/realm/realm-java/commit/ec7162dbb67e1bb6bd623576c5cb242bc7145630", "message": "Add scheme with supported types only to allow testing without bad change sets", "committedDate": "2020-06-02T20:33:00Z", "type": "commit"}, {"oid": "ecf475144699be5ab276332ae69b00f9bd38df87", "url": "https://github.com/realm/realm-java/commit/ecf475144699be5ab276332ae69b00f9bd38df87", "message": "Clean up test cases for sync with different partition values", "committedDate": "2020-06-02T21:06:58Z", "type": "commit"}, {"oid": "bdb01a370ef66d9791de15e7c45e3552ff94e5ac", "url": "https://github.com/realm/realm-java/commit/bdb01a370ef66d9791de15e7c45e3552ff94e5ac", "message": "Merge branch 'v10' into cr/sync-integration-test-session\n\n# Conflicts:\n#\trealm/realm-library/build.gradle\n#\trealm/realm-library/src/objectServer/java/io/realm/internal/SyncObjectServerFacade.java\n#\trealm/realm-library/src/objectServer/java/io/realm/mongodb/sync/SyncConfiguration.java\n#\trealm/realm-library/src/syncTestUtils/kotlin/io/realm/TestSyncConfigurationFactory.kt", "committedDate": "2020-06-03T11:16:17Z", "type": "commit"}, {"oid": "fee820b010f527613b9b17d95b2078f27e5867ce", "url": "https://github.com/realm/realm-java/commit/fee820b010f527613b9b17d95b2078f27e5867ce", "message": "Merge branch 'v10' into cr/sync-integration-test-session", "committedDate": "2020-06-04T07:57:23Z", "type": "commit"}, {"oid": "72af903e6b3266b058f73968cf877821256c389d", "url": "https://github.com/realm/realm-java/commit/72af903e6b3266b058f73968cf877821256c389d", "message": "Fix sync session connection state listeners", "committedDate": "2020-06-04T10:25:14Z", "type": "commit"}, {"oid": "1760905bdfed61dda355815d246dc92b534848c2", "url": "https://github.com/realm/realm-java/commit/1760905bdfed61dda355815d246dc92b534848c2", "message": "Merge branch 'v10' into cr/sync-integration-test-session", "committedDate": "2020-06-04T15:01:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM5OTg5Mg==", "url": "https://github.com/realm/realm-java/pull/6884#discussion_r435399892", "bodyText": "Most of these will fail unless made @required, right?", "author": "cmelchior", "createdAt": "2020-06-04T16:43:32Z", "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/entities/SyncAllTypes.kt", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.entities\n+\n+import io.realm.MutableRealmInteger\n+import io.realm.RealmList\n+import io.realm.RealmObject\n+import io.realm.TestHelper\n+import io.realm.annotations.PrimaryKey\n+import io.realm.annotations.RealmField\n+import io.realm.annotations.Required\n+import org.bson.types.Decimal128\n+import org.bson.types.ObjectId\n+import java.math.BigDecimal\n+import java.util.*\n+\n+open class SyncAllTypes : RealmObject() {\n+\n+    companion object {\n+        const val CLASS_NAME = \"AllTypes\"\n+        const val FIELD_STRING = \"columnString\"\n+        const val FIELD_LONG = \"columnLong\"\n+        const val FIELD_FLOAT = \"columnFloat\"\n+        const val FIELD_DOUBLE = \"columnDouble\"\n+        const val FIELD_BOOLEAN = \"columnBoolean\"\n+        const val FIELD_DATE = \"columnDate\"\n+        const val FIELD_BINARY = \"columnBinary\"\n+        const val FIELD_MUTABLEREALMINTEGER = \"columnMutableRealmInteger\"\n+        const val FIELD_DECIMAL128 = \"columnDecimal128\"\n+        const val FIELD_OBJECT_ID = \"columnObjectId\"\n+        const val FIELD_REALMOBJECT = \"columnRealmObject\"\n+        const val FIELD_REALMLIST = \"columnRealmList\"\n+        const val FIELD_STRING_LIST = \"columnStringList\"\n+        const val FIELD_BINARY_LIST = \"columnBinaryList\"\n+        const val FIELD_BOOLEAN_LIST = \"columnBooleanList\"\n+        const val FIELD_LONG_LIST = \"columnLongList\"\n+        const val FIELD_DOUBLE_LIST = \"columnDoubleList\"\n+        const val FIELD_FLOAT_LIST = \"columnFloatList\"\n+        const val FIELD_DATE_LIST = \"columnDateList\"\n+        val INVALID_TYPES_FIELDS_FOR_DISTINCT = arrayOf(FIELD_REALMOBJECT, FIELD_REALMLIST, FIELD_DOUBLE, FIELD_FLOAT,\n+                FIELD_STRING_LIST, FIELD_BINARY_LIST, FIELD_BOOLEAN_LIST, FIELD_LONG_LIST,\n+                FIELD_DOUBLE_LIST, FIELD_FLOAT_LIST, FIELD_DATE_LIST)\n+    }\n+\n+    @PrimaryKey\n+    @RealmField(name = \"_id\")\n+    var id = ObjectId()\n+\n+    @Required\n+    var columnString = \"\"\n+    var columnLong: Long = 0\n+    var columnFloat = 0f\n+    var columnDouble = 0.0\n+    var isColumnBoolean = false\n+\n+    @Required\n+    var columnDate = Date(0)\n+\n+    @Required\n+    var columnBinary = ByteArray(0)\n+\n+    @Required\n+    var columnDecimal128 = Decimal128(BigDecimal.ZERO)\n+\n+    @Required\n+    var columnObjectId = ObjectId(TestHelper.randomObjectIdHexString())\n+    val columnRealmInteger = MutableRealmInteger.ofNull()\n+    var columnRealmObject: SyncDog? = null\n+    var columnRealmList: RealmList<SyncDog>? = null\n+    var columnStringList: RealmList<String>? = null", "originalCommit": "1760905bdfed61dda355815d246dc92b534848c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQzNzMzNg==", "url": "https://github.com/realm/realm-java/pull/6884#discussion_r435437336", "bodyText": "Yes. Tests using this are currently all ignore. It took me some time to realise that lists with null elements where not supported on the server. The initial upload worked and the subsequent sync failed because of mismatched schema as the server just \"truncated\" the nullable parameter on the initial upload. Issue is raised on the server. Will fix in another PR when the issue is also fixed on the server.", "author": "rorbech", "createdAt": "2020-06-04T17:45:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM5OTg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM5OTk5Mw==", "url": "https://github.com/realm/realm-java/pull/6884#discussion_r435399993", "bodyText": "License is duplicated", "author": "cmelchior", "createdAt": "2020-06-04T16:43:41Z", "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/entities/SyncAllTypesSchema.kt", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/**", "originalCommit": "1760905bdfed61dda355815d246dc92b534848c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQzNzg2OA==", "url": "https://github.com/realm/realm-java/pull/6884#discussion_r435437868", "bodyText": "Will fix in another PR along with the other SyncAllTypesSchema comments.", "author": "rorbech", "createdAt": "2020-06-04T17:46:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM5OTk5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQwMDc3OA==", "url": "https://github.com/realm/realm-java/pull/6884#discussion_r435400778", "bodyText": "Not sure I get having both this class and SyncAllTypes we should probably only keep one of them?", "author": "cmelchior", "createdAt": "2020-06-04T16:45:01Z", "path": "realm/realm-library/src/androidTestObjectServer/kotlin/io/realm/entities/SyncSupportedTypes.kt", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 Realm Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.realm.entities\n+\n+import io.realm.MutableRealmInteger\n+import io.realm.RealmList\n+import io.realm.RealmObject\n+import io.realm.TestHelper\n+import io.realm.annotations.PrimaryKey\n+import io.realm.annotations.RealmField\n+import io.realm.annotations.Required\n+import org.bson.types.Decimal128\n+import org.bson.types.ObjectId\n+import java.math.BigDecimal\n+import java.util.*\n+\n+open class SyncSupportedTypes : RealmObject() {", "originalCommit": "1760905bdfed61dda355815d246dc92b534848c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ0MDgxOQ==", "url": "https://github.com/realm/realm-java/pull/6884#discussion_r435440819", "bodyText": "I introduced this one to enable successful testing while keeping the SyncAllTypes to track the issues of re-syncing with the server. Did not have the overview of what actually caused the trouble (lacking server support for Double and lists with nullable elements). Will clean it up in another PR along with the other SyncAlllTypesSchema", "author": "rorbech", "createdAt": "2020-06-04T17:51:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQwMDc3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQwMTU0Nw==", "url": "https://github.com/realm/realm-java/pull/6884#discussion_r435401547", "bodyText": "We should probably rename the java_syncmanager_class variables as that is no longer accurate", "author": "cmelchior", "createdAt": "2020-06-04T16:46:12Z", "path": "realm/realm-library/src/main/cpp/io_realm_mongodb_sync_SyncSession.cpp", "diffHunk": "@@ -252,17 +252,17 @@ JNIEXPORT jlong JNICALL Java_io_realm_mongodb_sync_SyncSession_nativeAddConnecti\n             return 0;\n         }\n \n-        static JavaClass java_syncmanager_class(env, \"io/realm/mongodb/sync/Sync\");\n-        static JavaMethod java_notify_connection_listener(env, java_syncmanager_class, \"notifyConnectionListeners\", \"(Ljava/lang/String;JJ)V\", true);\n+        static JavaClass java_syncmanager_class(env, \"io/realm/mongodb/sync/SyncSession\");", "originalCommit": "1760905bdfed61dda355815d246dc92b534848c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ0MTYyOQ==", "url": "https://github.com/realm/realm-java/pull/6884#discussion_r435441629", "bodyText": "I will leave it for now, but will put a not on that in the issue for cleaning up the memory leak.", "author": "rorbech", "createdAt": "2020-06-04T17:52:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQwMTU0Nw=="}], "type": "inlineReview"}, {"oid": "c88ffd731852041ce50c3da6e2ab662ddc52f21e", "url": "https://github.com/realm/realm-java/commit/c88ffd731852041ce50c3da6e2ab662ddc52f21e", "message": "Merge branch 'v10' into cr/sync-integration-test-session", "committedDate": "2020-06-04T17:41:25Z", "type": "commit"}]}