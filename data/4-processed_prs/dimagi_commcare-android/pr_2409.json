{"pr_number": 2409, "pr_title": "[2.50.3] Lets Encrypt Root CA Change", "pr_createdAt": "2020-11-19T12:26:31Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2409", "timeline": [{"oid": "e49d4578854c2d8999d70602b2682a276457b506", "url": "https://github.com/dimagi/commcare-android/commit/e49d4578854c2d8999d70602b2682a276457b506", "message": "Deletes unused tls1.2 class", "committedDate": "2020-11-18T11:31:12Z", "type": "commit"}, {"oid": "c5979e389e8b5a48800e0f6d6dc1f019f7b69fc7", "url": "https://github.com/dimagi/commcare-android/commit/c5979e389e8b5a48800e0f6d6dc1f019f7b69fc7", "message": "Adds Lets Encrypt ISG cert", "committedDate": "2020-11-19T09:33:11Z", "type": "commit"}, {"oid": "f9c71434402b5923b34732c6562c79f74d929054", "url": "https://github.com/dimagi/commcare-android/commit/f9c71434402b5923b34732c6562c79f74d929054", "message": "test for ISRG cert", "committedDate": "2020-11-19T12:20:03Z", "type": "commit"}, {"oid": "29964b0d7ef67a6f8cb50a38d048d3c24ea9a661", "url": "https://github.com/dimagi/commcare-android/commit/29964b0d7ef67a6f8cb50a38d048d3c24ea9a661", "message": "rename", "committedDate": "2020-11-19T12:25:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkwMzYyMA==", "url": "https://github.com/dimagi/commcare-android/pull/2409#discussion_r526903620", "bodyText": "One question: Should we be adding this only below Android 7.1?", "author": "ShivamPokhriyal", "createdAt": "2020-11-19T13:53:54Z", "path": "app/src/org/commcare/CommCareApplication.java", "diffHunk": "@@ -244,6 +246,10 @@ public void onCreate() {\n         LocalePreferences.saveDeviceLocale(Locale.getDefault());\r\n     }\r\n \r\n+    private void attachISRGCert() {\r\n+        CommCareNetworkServiceGenerator.customizeRetrofitSetup(new ISRGCertConfig());\r", "originalCommit": "29964b0d7ef67a6f8cb50a38d048d3c24ea9a661", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkwNTE5Mg==", "url": "https://github.com/dimagi/commcare-android/pull/2409#discussion_r526905192", "bodyText": "Ohh nvm, just saw the check here https://github.com/dimagi/commcare-android/pull/2409/files#diff-accec8e023ea67a6abb17d85e70b38eb6f6a80aa1ead1bb96c638f81b3c2f0eaR31", "author": "ShivamPokhriyal", "createdAt": "2020-11-19T13:56:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkwMzYyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4ODEwNA==", "url": "https://github.com/dimagi/commcare-android/pull/2409#discussion_r527588104", "bodyText": "Do you need to support other platform certificates as well? Or just an LE root?\nCan you confirm this already works for existing LE certificates?", "author": "yschimke", "createdAt": "2020-11-20T10:13:03Z", "path": "app/src/org/commcare/network/ISRGCertConfig.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.commcare.network;\n+\n+import android.os.Build;\n+\n+import org.commcare.core.network.HttpBuilderConfig;\n+import org.javarosa.core.services.Logger;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.UnsupportedEncodingException;\n+import java.security.cert.Certificate;\n+import java.security.cert.CertificateException;\n+import java.security.cert.CertificateFactory;\n+import java.security.cert.X509Certificate;\n+\n+import okhttp3.OkHttpClient;\n+import okhttp3.tls.HandshakeCertificates;\n+\n+/**\n+ * Pins Lets Encrypt new root CA - ISRG Root X1\n+ *\n+ * Read https://community.letsencrypt.org/t/mobile-client-workarounds-for-isrg-issue/137807 and\n+ * https://stackoverflow.com/questions/64844311/certpathvalidatorexception-connecting-to-a-lets-encrypt-host-on-android-m-or-ea\n+ * for background.\n+ */\n+public class ISRGCertConfig implements HttpBuilderConfig {\n+\n+    @Override\n+    public OkHttpClient.Builder performCustomConfig(OkHttpClient.Builder okHttpBuilder) {\n+        boolean androidNorEarlier = Build.VERSION.SDK_INT <= 25;\n+\n+        if (androidNorEarlier) {\n+            String isgCert =\n+                    \"-----BEGIN CERTIFICATE-----\\n\" +\n+                            \"MIIFazCCA1OgAwIBAgIRAIIQz7DSQONZRGPgu2OCiwAwDQYJKoZIhvcNAQELBQAw\\n\" +\n+                            \"TzELMAkGA1UEBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2Vh\\n\" +\n+                            \"cmNoIEdyb3VwMRUwEwYDVQQDEwxJU1JHIFJvb3QgWDEwHhcNMTUwNjA0MTEwNDM4\\n\" +\n+                            \"WhcNMzUwNjA0MTEwNDM4WjBPMQswCQYDVQQGEwJVUzEpMCcGA1UEChMgSW50ZXJu\\n\" +\n+                            \"ZXQgU2VjdXJpdHkgUmVzZWFyY2ggR3JvdXAxFTATBgNVBAMTDElTUkcgUm9vdCBY\\n\" +\n+                            \"MTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAK3oJHP0FDfzm54rVygc\\n\" +\n+                            \"h77ct984kIxuPOZXoHj3dcKi/vVqbvYATyjb3miGbESTtrFj/RQSa78f0uoxmyF+\\n\" +\n+                            \"0TM8ukj13Xnfs7j/EvEhmkvBioZxaUpmZmyPfjxwv60pIgbz5MDmgK7iS4+3mX6U\\n\" +\n+                            \"A5/TR5d8mUgjU+g4rk8Kb4Mu0UlXjIB0ttov0DiNewNwIRt18jA8+o+u3dpjq+sW\\n\" +\n+                            \"T8KOEUt+zwvo/7V3LvSye0rgTBIlDHCNAymg4VMk7BPZ7hm/ELNKjD+Jo2FR3qyH\\n\" +\n+                            \"B5T0Y3HsLuJvW5iB4YlcNHlsdu87kGJ55tukmi8mxdAQ4Q7e2RCOFvu396j3x+UC\\n\" +\n+                            \"B5iPNgiV5+I3lg02dZ77DnKxHZu8A/lJBdiB3QW0KtZB6awBdpUKD9jf1b0SHzUv\\n\" +\n+                            \"KBds0pjBqAlkd25HN7rOrFleaJ1/ctaJxQZBKT5ZPt0m9STJEadao0xAH0ahmbWn\\n\" +\n+                            \"OlFuhjuefXKnEgV4We0+UXgVCwOPjdAvBbI+e0ocS3MFEvzG6uBQE3xDk3SzynTn\\n\" +\n+                            \"jh8BCNAw1FtxNrQHusEwMFxIt4I7mKZ9YIqioymCzLq9gwQbooMDQaHWBfEbwrbw\\n\" +\n+                            \"qHyGO0aoSCqI3Haadr8faqU9GY/rOPNk3sgrDQoo//fb4hVC1CLQJ13hef4Y53CI\\n\" +\n+                            \"rU7m2Ys6xt0nUW7/vGT1M0NPAgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNV\\n\" +\n+                            \"HRMBAf8EBTADAQH/MB0GA1UdDgQWBBR5tFnme7bl5AFzgAiIyBpY9umbbjANBgkq\\n\" +\n+                            \"hkiG9w0BAQsFAAOCAgEAVR9YqbyyqFDQDLHYGmkgJykIrGF1XIpu+ILlaS/V9lZL\\n\" +\n+                            \"ubhzEFnTIZd+50xx+7LSYK05qAvqFyFWhfFQDlnrzuBZ6brJFe+GnY+EgPbk6ZGQ\\n\" +\n+                            \"3BebYhtF8GaV0nxvwuo77x/Py9auJ/GpsMiu/X1+mvoiBOv/2X/qkSsisRcOj/KK\\n\" +\n+                            \"NFtY2PwByVS5uCbMiogziUwthDyC3+6WVwW6LLv3xLfHTjuCvjHIInNzktHCgKQ5\\n\" +\n+                            \"ORAzI4JMPJ+GslWYHb4phowim57iaztXOoJwTdwJx4nLCgdNbOhdjsnvzqvHu7Ur\\n\" +\n+                            \"TkXWStAmzOVyyghqpZXjFaH3pO3JLF+l+/+sKAIuvtd7u+Nxe5AW0wdeRlN8NwdC\\n\" +\n+                            \"jNPElpzVmbUq4JUagEiuTDkHzsxHpFKVK7q4+63SM1N95R1NbdWhscdCb+ZAJzVc\\n\" +\n+                            \"oyi3B43njTOQ5yOf+1CceWxG1bQVs5ZufpsMljq4Ui0/1lvh+wjChP4kqKOJ2qxq\\n\" +\n+                            \"4RgqsahDYVvTH9w7jXbyLeiNdd8XM2w9U/t7y0Ff/9yi0GE44Za4rF2LN9d11TPA\\n\" +\n+                            \"mRGunUHBcnWEvgJBQl9nJEiU0Zsnvgc/ubhPgXRR4Xq37Z0j4r7g1SgEEzwxA57d\\n\" +\n+                            \"emyPxgcYxn/eR44/KJ4EBs+lVDR3veyJm+kXQ99b21/+jh5Xos1AnX5iItreGCc=\\n\" +\n+                            \"-----END CERTIFICATE-----\";\n+\n+            try {\n+                CertificateFactory cf = CertificateFactory.getInstance(\"X.509\");\n+                Certificate isgCertificate = cf.generateCertificate(new ByteArrayInputStream(isgCert.getBytes(\"UTF-8\")));\n+\n+                HandshakeCertificates certificates = new HandshakeCertificates.Builder()\n+                        .addTrustedCertificate((X509Certificate)isgCertificate)", "originalCommit": "29964b0d7ef67a6f8cb50a38d048d3c24ea9a661", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY5NDIwMg==", "url": "https://github.com/dimagi/commcare-android/pull/2409#discussion_r527694202", "bodyText": "Do you need to support other platform certificates as well?\n\nUh yes, It's failing for other non LE certs. so seems like we need to add addPlatformTrustedCertificates() to allow for other certificates. Appreciate the catch.\n\nCan you confirm this already works for existing LE certificates?\n\nYeah this somehow works without adding the call to addPlatformTrustedCertificates(). Not sure how though!", "author": "shubham1g5", "createdAt": "2020-11-20T13:36:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4ODEwNA=="}], "type": "inlineReview"}, {"oid": "c3d4b578bae1bfdacd5f5f41548a684ecdc7da3a", "url": "https://github.com/dimagi/commcare-android/commit/c3d4b578bae1bfdacd5f5f41548a684ecdc7da3a", "message": "Adds all platform trusted CAs", "committedDate": "2020-11-20T16:10:04Z", "type": "commit"}]}