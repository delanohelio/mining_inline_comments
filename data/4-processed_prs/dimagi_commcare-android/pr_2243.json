{"pr_number": 2243, "pr_title": "Adds lazy donwnload for multimedia for App Updates", "pr_createdAt": "2020-05-21T13:00:43Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2243", "timeline": [{"oid": "c5bb68280ad26de7f775f7bca623da949e5cd5c7", "url": "https://github.com/dimagi/commcare-android/commit/c5bb68280ad26de7f775f7bca623da949e5cd5c7", "message": "Adds setting to turn on mm less updates", "committedDate": "2020-04-05T13:43:04Z", "type": "commit"}, {"oid": "1e002dfde13fa458d8bb2b611d25f710ea9f9c93", "url": "https://github.com/dimagi/commcare-android/commit/1e002dfde13fa458d8bb2b611d25f710ea9f9c93", "message": "Adds lazy atrribute to resource and update the tables", "committedDate": "2020-04-06T17:37:11Z", "type": "commit"}, {"oid": "b8540e700f11399f9ed0dd1dbc991551dda0d3d8", "url": "https://github.com/dimagi/commcare-android/commit/b8540e700f11399f9ed0dd1dbc991551dda0d3d8", "message": "Skip installation of lazy media at update time", "committedDate": "2020-04-08T13:53:46Z", "type": "commit"}, {"oid": "7f722684e29e3394fec26e066aed2dce230ebae9", "url": "https://github.com/dimagi/commcare-android/commit/7f722684e29e3394fec26e066aed2dce230ebae9", "message": "Skips install for lazy resources", "committedDate": "2020-04-09T07:19:11Z", "type": "commit"}, {"oid": "d300f2049f7715f4d34becd72cf90f7dd1b7dc8a", "url": "https://github.com/dimagi/commcare-android/commit/d300f2049f7715f4d34becd72cf90f7dd1b7dc8a", "message": "Imports", "committedDate": "2020-04-12T18:05:22Z", "type": "commit"}, {"oid": "457e56c4908a2ca6aa8b862cee4305714dfc367b", "url": "https://github.com/dimagi/commcare-android/commit/457e56c4908a2ca6aa8b862cee4305714dfc367b", "message": "Merge branch 'formSubmissionsScheduling' into multimediaChanges", "committedDate": "2020-04-12T18:11:51Z", "type": "commit"}, {"oid": "0521498d41f6a2ac6901f58b8a803f01bdda01b8", "url": "https://github.com/dimagi/commcare-android/commit/0521498d41f6a2ac6901f58b8a803f01bdda01b8", "message": "Merge branch 'master' into multimediaChanges", "committedDate": "2020-04-13T07:56:50Z", "type": "commit"}, {"oid": "076b0aa0d3b5b1b184adefcdebb71e05c839bdcf", "url": "https://github.com/dimagi/commcare-android/commit/076b0aa0d3b5b1b184adefcdebb71e05c839bdcf", "message": "better classify missing media exception", "committedDate": "2020-04-13T13:18:13Z", "type": "commit"}, {"oid": "12b64a874f189b73e5f01fa44d0bb798f53318d8", "url": "https://github.com/dimagi/commcare-android/commit/12b64a874f189b73e5f01fa44d0bb798f53318d8", "message": "Schedules download for missing media", "committedDate": "2020-04-15T07:08:39Z", "type": "commit"}, {"oid": "09c6a6b653dfc98f125cd1f792a709a71cfe9a25", "url": "https://github.com/dimagi/commcare-android/commit/09c6a6b653dfc98f125cd1f792a709a71cfe9a25", "message": "Modularize File Install", "committedDate": "2020-04-17T11:22:46Z", "type": "commit"}, {"oid": "b4edcccb32db3a977b3334b036db6c85e7f213b1", "url": "https://github.com/dimagi/commcare-android/commit/b4edcccb32db3a977b3334b036db6c85e7f213b1", "message": "initialize localreference even when it's a lazy resource", "committedDate": "2020-04-17T11:23:14Z", "type": "commit"}, {"oid": "f93d0c9d8f1fa272d6916a618d1d5ddeba6736ca", "url": "https://github.com/dimagi/commcare-android/commit/f93d0c9d8f1fa272d6916a618d1d5ddeba6736ca", "message": "Changes mm verfication to skip lazy resources", "committedDate": "2020-04-17T11:25:01Z", "type": "commit"}, {"oid": "84479cfac4c5fb4aba9f20207ef00baebf07a31e", "url": "https://github.com/dimagi/commcare-android/commit/84479cfac4c5fb4aba9f20207ef00baebf07a31e", "message": "going a bit more functional", "committedDate": "2020-04-17T11:25:46Z", "type": "commit"}, {"oid": "2511e7e1f00f4b302e6ecffdc763e368a10adf1f", "url": "https://github.com/dimagi/commcare-android/commit/2511e7e1f00f4b302e6ecffdc763e368a10adf1f", "message": "Indexes lazy property for resource", "committedDate": "2020-04-28T15:22:32Z", "type": "commit"}, {"oid": "f37a72fd0e9769adf15de0cf65f4e2859090bba9", "url": "https://github.com/dimagi/commcare-android/commit/f37a72fd0e9769adf15de0cf65f4e2859090bba9", "message": "changes verification task to account for missing media from lazy resources", "committedDate": "2020-04-30T09:41:17Z", "type": "commit"}, {"oid": "a9ea1115bb6789a2a5ee9497a36acfbe13ba9b6b", "url": "https://github.com/dimagi/commcare-android/commit/a9ea1115bb6789a2a5ee9497a36acfbe13ba9b6b", "message": "Merge branch 'formSubmissionsScheduling' into multimediaChanges", "committedDate": "2020-04-30T18:41:51Z", "type": "commit"}, {"oid": "35101bc2ebdeeb75123d2e69795be32c283dad5c", "url": "https://github.com/dimagi/commcare-android/commit/35101bc2ebdeeb75123d2e69795be32c283dad5c", "message": "Merge branch 'master' into multimediaChanges", "committedDate": "2020-04-30T18:43:57Z", "type": "commit"}, {"oid": "45e786c09aa563e5d7cb59c9afdc3581d6013f1b", "url": "https://github.com/dimagi/commcare-android/commit/45e786c09aa563e5d7cb59c9afdc3581d6013f1b", "message": "Update kotlin", "committedDate": "2020-05-01T14:02:42Z", "type": "commit"}, {"oid": "3528b6e2093ba209873e772463035d91488af79b", "url": "https://github.com/dimagi/commcare-android/commit/3528b6e2093ba209873e772463035d91488af79b", "message": "Adds structure to request individual media", "committedDate": "2020-05-01T14:03:16Z", "type": "commit"}, {"oid": "11b5010d86e234502514aa6e191190814ab2811e", "url": "https://github.com/dimagi/commcare-android/commit/11b5010d86e234502514aa6e191190814ab2811e", "message": "Merge branch 'master' into multimediaChanges", "committedDate": "2020-05-01T21:11:20Z", "type": "commit"}, {"oid": "b165701cc63342af238dc73f0112237c2a503422", "url": "https://github.com/dimagi/commcare-android/commit/b165701cc63342af238dc73f0112237c2a503422", "message": "Corrects Missing media download", "committedDate": "2020-05-02T06:56:40Z", "type": "commit"}, {"oid": "b59062399434711ef80cb26a634aedd2166ef800", "url": "https://github.com/dimagi/commcare-android/commit/b59062399434711ef80cb26a634aedd2166ef800", "message": "Media Download Hooks", "committedDate": "2020-05-02T18:19:59Z", "type": "commit"}, {"oid": "093f8b0cab0ea8e436b42d9db4812f5c28ed969e", "url": "https://github.com/dimagi/commcare-android/commit/093f8b0cab0ea8e436b42d9db4812f5c28ed969e", "message": "remove repeatition for missing media view", "committedDate": "2020-05-02T20:00:45Z", "type": "commit"}, {"oid": "2c0f8ae32222534cf1734ce60d06ab674f2a30bc", "url": "https://github.com/dimagi/commcare-android/commit/2c0f8ae32222534cf1734ce60d06ab674f2a30bc", "message": "Adds missing media pane view", "committedDate": "2020-05-03T21:34:24Z", "type": "commit"}, {"oid": "dd8e74ef612bfc5f75a93ab2a50eabc9f09c00c1", "url": "https://github.com/dimagi/commcare-android/commit/dd8e74ef612bfc5f75a93ab2a50eabc9f09c00c1", "message": "Refreshes media pane on download complete", "committedDate": "2020-05-04T22:31:33Z", "type": "commit"}, {"oid": "6f3b44f9a2ad142f433772e0fec072b355abffb2", "url": "https://github.com/dimagi/commcare-android/commit/6f3b44f9a2ad142f433772e0fec072b355abffb2", "message": "Log errors", "committedDate": "2020-05-05T19:39:34Z", "type": "commit"}, {"oid": "ae8f7ec820868b3ec26ed6a7fab79a1042e6f0f2", "url": "https://github.com/dimagi/commcare-android/commit/ae8f7ec820868b3ec26ed6a7fab79a1042e6f0f2", "message": "Sets up missing views for audio button and image", "committedDate": "2020-05-19T07:52:41Z", "type": "commit"}, {"oid": "fa814633d9fb61b17f43e591e66d3437f5995c00", "url": "https://github.com/dimagi/commcare-android/commit/fa814633d9fb61b17f43e591e66d3437f5995c00", "message": "rename", "committedDate": "2020-05-19T11:25:46Z", "type": "commit"}, {"oid": "630647502a4fd3326742059335e015db374d1b4b", "url": "https://github.com/dimagi/commcare-android/commit/630647502a4fd3326742059335e015db374d1b4b", "message": "comments", "committedDate": "2020-05-20T13:30:12Z", "type": "commit"}, {"oid": "df6c4ebc736a465c210f31b563d2206c4326e570", "url": "https://github.com/dimagi/commcare-android/commit/df6c4ebc736a465c210f31b563d2206c4326e570", "message": "comments", "committedDate": "2020-05-21T13:18:40Z", "type": "commit"}, {"oid": "ce9309c52a3a09d3b3df872e33364c06e9e6f3d5", "url": "https://github.com/dimagi/commcare-android/commit/ce9309c52a3a09d3b3df872e33364c06e9e6f3d5", "message": "Exception handelling", "committedDate": "2020-05-21T19:47:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyNzkwOQ==", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r432227909", "bodyText": "Not sure where this list is populated from, but heads up that iterating over resources is a really expensive operation on really large apps like CAS. This might need to get cached into a table which is indexed by the file URI", "author": "ctsims", "createdAt": "2020-05-29T02:49:36Z", "path": "app/src/org/commcare/engine/resource/AndroidResourceUtils.kt", "diffHunk": "@@ -0,0 +1,44 @@\n+package org.commcare.engine.resource\n+\n+import org.commcare.android.resource.installers.MediaFileAndroidInstaller\n+import org.commcare.resources.model.MissingMediaException\n+import org.commcare.resources.model.Resource\n+import org.javarosa.core.reference.InvalidReferenceException\n+import org.javarosa.core.reference.ReferenceManager\n+import java.io.File\n+import java.io.IOException\n+import java.util.*\n+\n+object AndroidResourceUtils {\n+\n+    // loops over all lazy resources and checks if one of them has the same local path as {@param problem} URI\n+    @JvmStatic\n+    fun ifUriBelongsToALazyResource(problem: MissingMediaException, lazyResources: Vector<Resource>): Boolean {\n+        for (lazyResource in lazyResources) {", "originalCommit": "ce9309c52a3a09d3b3df872e33364c06e9e6f3d5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyODI0NA==", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r432228244", "bodyText": "I think it's really risky to swallow these. IRE's are almost always the result of a bug, and the IOException is absorbing a pretty large surface area", "author": "ctsims", "createdAt": "2020-05-29T02:50:57Z", "path": "app/src/org/commcare/engine/resource/AndroidResourceUtils.kt", "diffHunk": "@@ -0,0 +1,44 @@\n+package org.commcare.engine.resource\n+\n+import org.commcare.android.resource.installers.MediaFileAndroidInstaller\n+import org.commcare.resources.model.MissingMediaException\n+import org.commcare.resources.model.Resource\n+import org.javarosa.core.reference.InvalidReferenceException\n+import org.javarosa.core.reference.ReferenceManager\n+import java.io.File\n+import java.io.IOException\n+import java.util.*\n+\n+object AndroidResourceUtils {\n+\n+    // loops over all lazy resources and checks if one of them has the same local path as {@param problem} URI\n+    @JvmStatic\n+    fun ifUriBelongsToALazyResource(problem: MissingMediaException, lazyResources: Vector<Resource>): Boolean {\n+        for (lazyResource in lazyResources) {\n+            if (matchFileUriToResource(lazyResource, problem.uri)) {\n+                return true\n+            }\n+        }\n+        return false\n+    }\n+\n+    // checks if {@param resource} has same location as that represented by {@param uri}\n+    @JvmStatic\n+    fun matchFileUriToResource(resource: Resource, uri: String?): Boolean {\n+        if (resource.installer is MediaFileAndroidInstaller) {\n+            try {\n+                val resourceUri = (resource.installer as MediaFileAndroidInstaller).localLocation\n+                val resourcePath = ReferenceManager.instance().DeriveReference(resourceUri).localURI\n+                val problemPath = ReferenceManager.instance().DeriveReference(uri).localURI\n+                if (File(resourcePath).canonicalPath.contentEquals(File(problemPath).canonicalPath)) {\n+                    return true\n+                }\n+            } catch (e: InvalidReferenceException) {\n+                e.printStackTrace()", "originalCommit": "ce9309c52a3a09d3b3df872e33364c06e9e6f3d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMzg5OQ==", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r432333899", "bodyText": "Agree", "author": "shubham1g5", "createdAt": "2020-05-29T08:28:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyODI0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyODcxNA==", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r432228714", "bodyText": "Have you timed this operation with CAS, out of curiosity?", "author": "ctsims", "createdAt": "2020-05-29T02:52:55Z", "path": "app/src/org/commcare/mediadownload/MissingMediaDownloadHelper.kt", "diffHunk": "@@ -0,0 +1,196 @@\n+package org.commcare.mediadownload\n+\n+import android.content.Context\n+import android.widget.ImageButton\n+import android.widget.Toast\n+import androidx.work.*\n+import kotlinx.coroutines.*\n+import org.commcare.CommCareApplication\n+import org.commcare.dalvik.R\n+import org.commcare.engine.resource.AndroidResourceUtils\n+import org.commcare.engine.resource.ResourceInstallUtils\n+import org.commcare.preferences.HiddenPreferences\n+import org.commcare.resources.model.*\n+import org.commcare.utils.AndroidCommCarePlatform\n+import org.commcare.utils.AndroidUtil\n+import org.commcare.utils.FileUtil\n+import org.commcare.views.dialogs.PinnedNotificationWithProgress\n+import org.javarosa.core.services.Logger\n+import org.javarosa.core.util.SizeBoundUniqueVector\n+import java.util.*\n+import java.util.concurrent.TimeUnit\n+import kotlin.collections.ArrayList\n+\n+// Contains helper functions to download lazy or missing media resources\n+object MissingMediaDownloadHelper : TableStateListener, InstallCancelled {\n+\n+    var resourceInProgress: Resource? = null\n+        private set\n+\n+    private val jobs = ArrayList<Job>()\n+    private lateinit var mPinnedNotificationProgress: PinnedNotificationWithProgress\n+\n+\n+    private const val BACK_OFF_DELAY = 5 * 60 * 1000L // 5 mins\n+    private const val REQUEST_NAME = \"missing_media_download_request\"\n+\n+    var installCancelled: InstallCancelled? = null\n+\n+    // Schedules MissingMediaDownloadWorker\n+    @JvmStatic\n+    fun scheduleMissingMediaDownload() {\n+        if (HiddenPreferences.shouldDownloadLazyMediaInBackground()) {\n+            val constraints = Constraints.Builder()\n+                    .setRequiredNetworkType(NetworkType.CONNECTED)\n+                    .setRequiresBatteryNotLow(true)\n+                    .build()\n+\n+            val downloadMissingMediaRequest = OneTimeWorkRequest.Builder(MissingMediaDownloadWorker::class.java)\n+                    .addTag(CommCareApplication.instance().currentApp.appRecord.applicationId)\n+                    .setConstraints(constraints)\n+                    .setBackoffCriteria(\n+                            BackoffPolicy.EXPONENTIAL,\n+                            BACK_OFF_DELAY,\n+                            TimeUnit.MILLISECONDS)\n+                    .build()\n+\n+            WorkManager.getInstance(CommCareApplication.instance())\n+                    .enqueueUniqueWork(\n+                            getMissingMediaDownloadRequestName(),\n+                            ExistingWorkPolicy.KEEP,\n+                            downloadMissingMediaRequest)\n+        }\n+    }\n+\n+    // Returns Unique request name for the UpdateWorker Request\n+    private fun getMissingMediaDownloadRequestName(): String {\n+        val appId = CommCareApplication.instance().currentApp.uniqueId\n+        return REQUEST_NAME + \"_\" + appId\n+    }\n+\n+\n+    // Verifies all application media and re-downloads any missing lazy resources\n+    fun downloadAllMissingMedia() {\n+        val platform = CommCareApplication.instance().commCarePlatform\n+        val global = platform.globalResourceTable\n+\n+        global.setInstallCancellationChecker(this)\n+\n+        val problems = Vector<MissingMediaException>()\n+        global.verifyInstallation(problems, platform)", "originalCommit": "ce9309c52a3a09d3b3df872e33364c06e9e6f3d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMwMTkwNg==", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r432301906", "bodyText": "I have seen it varying from 14 to 30 seconds on lower mid range to mid range devices but can imagine it taking more closer to a minute on really low end devices.", "author": "shubham1g5", "createdAt": "2020-05-29T07:24:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyODcxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyOTA5Mg==", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r432229092", "bodyText": "Same comment as above that I think this is likely to be too expensive to be practical if this list is as big as CAS's", "author": "ctsims", "createdAt": "2020-05-29T02:54:39Z", "path": "app/src/org/commcare/mediadownload/MissingMediaDownloadHelper.kt", "diffHunk": "@@ -0,0 +1,196 @@\n+package org.commcare.mediadownload\n+\n+import android.content.Context\n+import android.widget.ImageButton\n+import android.widget.Toast\n+import androidx.work.*\n+import kotlinx.coroutines.*\n+import org.commcare.CommCareApplication\n+import org.commcare.dalvik.R\n+import org.commcare.engine.resource.AndroidResourceUtils\n+import org.commcare.engine.resource.ResourceInstallUtils\n+import org.commcare.preferences.HiddenPreferences\n+import org.commcare.resources.model.*\n+import org.commcare.utils.AndroidCommCarePlatform\n+import org.commcare.utils.AndroidUtil\n+import org.commcare.utils.FileUtil\n+import org.commcare.views.dialogs.PinnedNotificationWithProgress\n+import org.javarosa.core.services.Logger\n+import org.javarosa.core.util.SizeBoundUniqueVector\n+import java.util.*\n+import java.util.concurrent.TimeUnit\n+import kotlin.collections.ArrayList\n+\n+// Contains helper functions to download lazy or missing media resources\n+object MissingMediaDownloadHelper : TableStateListener, InstallCancelled {\n+\n+    var resourceInProgress: Resource? = null\n+        private set\n+\n+    private val jobs = ArrayList<Job>()\n+    private lateinit var mPinnedNotificationProgress: PinnedNotificationWithProgress\n+\n+\n+    private const val BACK_OFF_DELAY = 5 * 60 * 1000L // 5 mins\n+    private const val REQUEST_NAME = \"missing_media_download_request\"\n+\n+    var installCancelled: InstallCancelled? = null\n+\n+    // Schedules MissingMediaDownloadWorker\n+    @JvmStatic\n+    fun scheduleMissingMediaDownload() {\n+        if (HiddenPreferences.shouldDownloadLazyMediaInBackground()) {\n+            val constraints = Constraints.Builder()\n+                    .setRequiredNetworkType(NetworkType.CONNECTED)\n+                    .setRequiresBatteryNotLow(true)\n+                    .build()\n+\n+            val downloadMissingMediaRequest = OneTimeWorkRequest.Builder(MissingMediaDownloadWorker::class.java)\n+                    .addTag(CommCareApplication.instance().currentApp.appRecord.applicationId)\n+                    .setConstraints(constraints)\n+                    .setBackoffCriteria(\n+                            BackoffPolicy.EXPONENTIAL,\n+                            BACK_OFF_DELAY,\n+                            TimeUnit.MILLISECONDS)\n+                    .build()\n+\n+            WorkManager.getInstance(CommCareApplication.instance())\n+                    .enqueueUniqueWork(\n+                            getMissingMediaDownloadRequestName(),\n+                            ExistingWorkPolicy.KEEP,\n+                            downloadMissingMediaRequest)\n+        }\n+    }\n+\n+    // Returns Unique request name for the UpdateWorker Request\n+    private fun getMissingMediaDownloadRequestName(): String {\n+        val appId = CommCareApplication.instance().currentApp.uniqueId\n+        return REQUEST_NAME + \"_\" + appId\n+    }\n+\n+\n+    // Verifies all application media and re-downloads any missing lazy resources\n+    fun downloadAllMissingMedia() {\n+        val platform = CommCareApplication.instance().commCarePlatform\n+        val global = platform.globalResourceTable\n+\n+        global.setInstallCancellationChecker(this)\n+\n+        val problems = Vector<MissingMediaException>()\n+        global.verifyInstallation(problems, platform)\n+\n+        val missingMediaResources = SizeBoundUniqueVector<Resource>(problems.size)\n+        val lazyResources = global.lazyResources\n+\n+        problems.filter { problem -> problem.type == MissingMediaException.MissingMediaExceptionType.FILE_NOT_FOUND }\n+                .map { problem ->\n+                    runCatching {\n+                        missingMediaResources.add(getLazyResourceFromMediaUri(lazyResources, problem.uri))\n+                    }.onFailure {\n+                        Logger.exception(\n+                                \"Could not map to a lazy resource while downloading missing media for uri ${problem.uri}\",\n+                                java.lang.Exception(it))\n+                    }\n+                }\n+\n+        startPinnedNotification()\n+\n+        missingMediaResources.mapIndexed { index, resource ->\n+            if (!wasInstallCancelled()) {\n+                recoverResource(platform, resource)\n+                incrementProgress(index + 1, missingMediaResources.size)\n+            }\n+        }\n+\n+        cancelNotification()\n+        global.setInstallCancellationChecker(null)\n+    }\n+\n+    /**\n+     * Downloads a resource with it's location represented by {@param mediaUri}\n+     */\n+    @JvmStatic\n+    fun requestMediaDownload(mediaUri: String, missingMediaDownloadListener: MissingMediaDownloadListener) {\n+        jobs.add(\n+                CoroutineScope(Dispatchers.Default).launch {\n+                    var result: MissingMediaDownloadResult = MissingMediaDownloadResult.Error(\"Unknown Error\")\n+                    try {\n+                        result = downloadMissingMediaResource(mediaUri)\n+                    } catch (e: Exception) {\n+                        Logger.exception(\" An error occured while recovering a missing resource\", e);\n+                        withContext(Dispatchers.Main) {\n+                            missingMediaDownloadListener.onComplete(MissingMediaDownloadResult.Exception(e))\n+                        }\n+                    }\n+\n+                    withContext(Dispatchers.Main) {\n+                        missingMediaDownloadListener.onComplete(result)\n+                    }\n+                }\n+        )\n+    }\n+\n+    private fun downloadMissingMediaResource(uri: String): MissingMediaDownloadResult {\n+        val platform = CommCareApplication.instance().commCarePlatform\n+        val global = platform.globalResourceTable\n+        val lazyResources: Vector<Resource> = global.lazyResources!!", "originalCommit": "ce9309c52a3a09d3b3df872e33364c06e9e6f3d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMwMzg4NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r432303885", "bodyText": "this particular call is quite cheap (takes .1 sec on MotoG, around .4 seconds on a low performant device I have) as we are indexing the lazy property in the Resource Table.", "author": "shubham1g5", "createdAt": "2020-05-29T07:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyOTA5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyOTI5NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r432229295", "bodyText": "Shouldn't there be a lock of some sort around each one of these jobs, or is that inherent to the job class?", "author": "ctsims", "createdAt": "2020-05-29T02:55:28Z", "path": "app/src/org/commcare/mediadownload/MissingMediaDownloadHelper.kt", "diffHunk": "@@ -0,0 +1,196 @@\n+package org.commcare.mediadownload\n+\n+import android.content.Context\n+import android.widget.ImageButton\n+import android.widget.Toast\n+import androidx.work.*\n+import kotlinx.coroutines.*\n+import org.commcare.CommCareApplication\n+import org.commcare.dalvik.R\n+import org.commcare.engine.resource.AndroidResourceUtils\n+import org.commcare.engine.resource.ResourceInstallUtils\n+import org.commcare.preferences.HiddenPreferences\n+import org.commcare.resources.model.*\n+import org.commcare.utils.AndroidCommCarePlatform\n+import org.commcare.utils.AndroidUtil\n+import org.commcare.utils.FileUtil\n+import org.commcare.views.dialogs.PinnedNotificationWithProgress\n+import org.javarosa.core.services.Logger\n+import org.javarosa.core.util.SizeBoundUniqueVector\n+import java.util.*\n+import java.util.concurrent.TimeUnit\n+import kotlin.collections.ArrayList\n+\n+// Contains helper functions to download lazy or missing media resources\n+object MissingMediaDownloadHelper : TableStateListener, InstallCancelled {\n+\n+    var resourceInProgress: Resource? = null\n+        private set\n+\n+    private val jobs = ArrayList<Job>()", "originalCommit": "ce9309c52a3a09d3b3df872e33364c06e9e6f3d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjMzMzc5Mg==", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r432333792", "bodyText": "each job in jobs depends on the synchronized  recoverResource function in this class which takes care of protecting against spawning multiple download requests for a resource. The jobs itself is only meant to provide a way for cancelling all jobs at once.  So it's fine for it to not be thread safe and have duplicate job entries as a result.", "author": "shubham1g5", "createdAt": "2020-05-29T08:28:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyOTI5NQ=="}], "type": "inlineReview"}, {"oid": "20e352c4ab5ef47ec6ae3f5346e9ce9540932a48", "url": "https://github.com/dimagi/commcare-android/commit/20e352c4ab5ef47ec6ae3f5346e9ce9540932a48", "message": "Removes exception catches", "committedDate": "2020-05-29T07:50:49Z", "type": "commit"}, {"oid": "bed4a6f7a6e795d5eebbc7688179775663027670", "url": "https://github.com/dimagi/commcare-android/commit/bed4a6f7a6e795d5eebbc7688179775663027670", "message": "Merge branch 'master' into multimediaChanges", "committedDate": "2020-05-29T09:05:05Z", "type": "commit"}, {"oid": "9865305a623cea4a4aa9125c70e960d46dbf16ce", "url": "https://github.com/dimagi/commcare-android/commit/9865305a623cea4a4aa9125c70e960d46dbf16ce", "message": "Merge branch 'master' into multimediaChanges", "committedDate": "2020-05-29T09:11:47Z", "type": "commit"}, {"oid": "a398369a989ae8ac04eef1b9a930b8dee68b302a", "url": "https://github.com/dimagi/commcare-android/commit/a398369a989ae8ac04eef1b9a930b8dee68b302a", "message": "Cancellation on unseat", "committedDate": "2020-05-29T09:33:07Z", "type": "commit"}, {"oid": "717d492cb069c74f4f1f5d215e62c4c2b1bb450e", "url": "https://github.com/dimagi/commcare-android/commit/717d492cb069c74f4f1f5d215e62c4c2b1bb450e", "message": "Merge branch 'master' into multimediaChanges", "committedDate": "2020-06-01T13:22:50Z", "type": "commit"}, {"oid": "3a20d0ca8f965b9ee6aaac5c29f9a9ee56f3eb62", "url": "https://github.com/dimagi/commcare-android/commit/3a20d0ca8f965b9ee6aaac5c29f9a9ee56f3eb62", "message": "Loops over lazy resources to install missing media", "committedDate": "2020-06-06T12:34:53Z", "type": "commit"}, {"oid": "a5fb86158cb77cb120d00ae8a1e34026b9987108", "url": "https://github.com/dimagi/commcare-android/commit/a5fb86158cb77cb120d00ae8a1e34026b9987108", "message": "Error Handling", "committedDate": "2020-06-07T11:31:35Z", "type": "commit"}, {"oid": "f44d2dcc3edb7d6f0c12ec00f7771e0e5bed9f60", "url": "https://github.com/dimagi/commcare-android/commit/f44d2dcc3edb7d6f0c12ec00f7771e0e5bed9f60", "message": "Merge branch 'master' into multimediaChanges", "committedDate": "2020-06-07T12:17:00Z", "type": "commit"}, {"oid": "7700747791ec0fb354bcf9c5cb2b9cc056adf1f5", "url": "https://github.com/dimagi/commcare-android/commit/7700747791ec0fb354bcf9c5cb2b9cc056adf1f5", "message": "Only run lazy media task once per app version", "committedDate": "2020-06-07T15:44:54Z", "type": "commit"}, {"oid": "602ae83c83e49a4159694dd6d5958543ad600763", "url": "https://github.com/dimagi/commcare-android/commit/602ae83c83e49a4159694dd6d5958543ad600763", "message": "Removes the property behind lazy media download as there is not much overhead of the download task now", "committedDate": "2020-06-07T17:59:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2MDUzNQ==", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r436760535", "bodyText": "I'm not sure why we'd ever been running lazy media installers for multiple app versions. Are we lazy installing the upgrade table as well as the installed version? or is this due to some behavior that happens after handing over between updates being applied??", "author": "ctsims", "createdAt": "2020-06-08T14:40:10Z", "path": "app/src/org/commcare/mediadownload/MissingMediaDownloadHelper.kt", "diffHunk": "@@ -72,29 +72,32 @@ object MissingMediaDownloadHelper : TableStateListener, InstallCancelled {\n      * Downloads any missing lazy resources, make sure to call this on background thread\n      */\n     fun downloadAllLazyMedia(): AppInstallStatus {\n-        val platform = CommCareApplication.instance().commCarePlatform\n-        val global = platform.globalResourceTable\n-\n-        global.setInstallCancellationChecker(this)\n-        startPinnedNotification()\n-\n-        val lazyResourceIds = global.lazyResourceIds\n-        lazyResourceIds.asSequence()\n-                .runCatching {\n-                    withIndex()\n-                            .onEach { incrementProgress(it.index + 1, lazyResourceIds.size) }\n-                            .takeWhile { !wasInstallCancelled() }\n-                            .map { global.getResource(it.value) }\n-                            .filter { isResourceMissing(it) }\n-                            .takeWhile { !wasInstallCancelled() }\n-                            .onEach { recoverResource(platform, it) }.toList()\n-                }.onFailure {\n-                    Logger.log(LogTypes.TYPE_MAINTENANCE, \"An error occured while lazy downloading a media resource : \" + it.message)\n-                    return handleRecoverResourceFailure(it).data\n-                }\n+        if (!HiddenPreferences.hasLazyMediaDownloaded()) {", "originalCommit": "7700747791ec0fb354bcf9c5cb2b9cc056adf1f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4OTcwNQ==", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r436889705", "bodyText": "Only A new app update can introduce new lazy resources, so once we have successfully run this task for version x, we don't need to run it again for the same version until user updates to a different version.\nRetrospectively, a better change here will be to just maintain a single app pref across all versions and reset that flag after an app update.", "author": "shubham1g5", "createdAt": "2020-06-08T17:54:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2MDUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5NzM3Ng==", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r436897376", "bodyText": "Ah, got it. I was reviewing by commit, which was silly, and I missed this was old. Sorry for the noise.", "author": "ctsims", "createdAt": "2020-06-08T18:08:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2MDUzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2MzIyMA==", "url": "https://github.com/dimagi/commcare-android/pull/2243#discussion_r436763220", "bodyText": "Don't we only want to retry automatically on specific errors?\nIn the handling list above, 3 of the 4 errors wouldn't be good for us to run a retry on", "author": "ctsims", "createdAt": "2020-06-08T14:43:57Z", "path": "app/src/org/commcare/mediadownload/MissingMediaDownloadWorker.kt", "diffHunk": "@@ -3,21 +3,16 @@ package org.commcare.mediadownload\n import android.content.Context\n import androidx.work.CoroutineWorker\n import androidx.work.WorkerParameters\n+import org.commcare.engine.resource.AppInstallStatus\n import org.commcare.resources.model.InstallCancelled\n \n class MissingMediaDownloadWorker(appContext: Context, workerParams: WorkerParameters)\n     : CoroutineWorker(appContext, workerParams), InstallCancelled {\n \n     override suspend fun doWork(): Result {\n         MissingMediaDownloadHelper.installCancelled = this\n-        kotlin.runCatching {\n-            MissingMediaDownloadHelper.downloadAllLazyMedia()\n-        }.onSuccess {\n-            return Result.success()\n-        }.onFailure {\n-            return Result.failure()\n-        }\n-        return Result.failure()\n+        val result = MissingMediaDownloadHelper.downloadAllLazyMedia()\n+        return if (result == AppInstallStatus.Installed) Result.success() else Result.retry()", "originalCommit": "a5fb86158cb77cb120d00ae8a1e34026b9987108", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1013ffb4cf7a2150fcf970fd632549d81de38202", "url": "https://github.com/dimagi/commcare-android/commit/1013ffb4cf7a2150fcf970fd632549d81de38202", "message": "Use single lazyMediaComplete pref and reset it after update", "committedDate": "2020-06-08T20:56:05Z", "type": "commit"}, {"oid": "ebce1e916a855ed074535f8b7bb3f4466dcbb06c", "url": "https://github.com/dimagi/commcare-android/commit/ebce1e916a855ed074535f8b7bb3f4466dcbb06c", "message": "only retry in case of non persistent failures", "committedDate": "2020-06-08T21:52:41Z", "type": "commit"}, {"oid": "6a035bf136492a1d95ca046585d4e8c8f150971a", "url": "https://github.com/dimagi/commcare-android/commit/6a035bf136492a1d95ca046585d4e8c8f150971a", "message": "Merge branch 'master' into multimediaChanges", "committedDate": "2020-06-09T07:08:47Z", "type": "commit"}, {"oid": "971a3ffd42082ee87195a78631267d2d35c1e92b", "url": "https://github.com/dimagi/commcare-android/commit/971a3ffd42082ee87195a78631267d2d35c1e92b", "message": "Removed the file missing toast for audio button", "committedDate": "2020-06-09T09:30:22Z", "type": "commit"}, {"oid": "c20179865485ea96c6c9dd65c8c7b66fb4cf9fb8", "url": "https://github.com/dimagi/commcare-android/commit/c20179865485ea96c6c9dd65c8c7b66fb4cf9fb8", "message": "Localized error message", "committedDate": "2020-06-09T09:35:41Z", "type": "commit"}, {"oid": "993cd3a53767bc0f1db7267b579193a372f22745", "url": "https://github.com/dimagi/commcare-android/commit/993cd3a53767bc0f1db7267b579193a372f22745", "message": "Reverts earlier change on disabling the audio toast and instead only show the toast when the button is visible", "committedDate": "2020-06-09T09:53:28Z", "type": "commit"}, {"oid": "04418570caf7da2bbf9ec13b70efaf34b22693ae", "url": "https://github.com/dimagi/commcare-android/commit/04418570caf7da2bbf9ec13b70efaf34b22693ae", "message": "bool -> string", "committedDate": "2020-06-10T15:15:55Z", "type": "commit"}, {"oid": "55893cbd336b7b1574854de43a4266835368d6d2", "url": "https://github.com/dimagi/commcare-android/commit/55893cbd336b7b1574854de43a4266835368d6d2", "message": "use static values for lazy values", "committedDate": "2020-06-10T17:20:13Z", "type": "commit"}, {"oid": "81afda4ef402a7fdbc5162b9b769c00b1e3a009c", "url": "https://github.com/dimagi/commcare-android/commit/81afda4ef402a7fdbc5162b9b769c00b1e3a009c", "message": "Merge branch 'master' into multimediaChanges", "committedDate": "2020-06-10T17:21:32Z", "type": "commit"}]}