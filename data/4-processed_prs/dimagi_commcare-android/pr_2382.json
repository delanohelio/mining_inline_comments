{"pr_number": 2382, "pr_title": "Add languages test", "pr_createdAt": "2020-10-19T09:51:57Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2382", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1MjY4MA==", "url": "https://github.com/dimagi/commcare-android/pull/2382#discussion_r509152680", "bodyText": "BaseTest::installApp do just the same right ?", "author": "shubham1g5", "createdAt": "2020-10-21T10:04:19Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/LanguagesTest.kt", "diffHunk": "@@ -0,0 +1,135 @@\n+package org.commcare.androidTests\n+\n+import androidx.test.espresso.Espresso\n+import androidx.test.espresso.Espresso.closeSoftKeyboard\n+import androidx.test.espresso.Espresso.onView\n+import androidx.test.espresso.action.ViewActions.click\n+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import org.commcare.CommCareApplication\n+import org.commcare.dalvik.R\n+import org.commcare.utils.CustomMatchers\n+import org.commcare.utils.InstrumentationUtility\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class LanguagesTest : BaseTest() {\n+\n+    companion object {\n+        const val CCZ_NAME = \"languages.ccz\"\n+    }\n+\n+    @Before\n+    fun setup() {\n+        if (CommCareApplication.instance().currentApp == null) {", "originalCommit": "d53d4bbef158d0a2a20b00fb1cb8bd94d1bb25c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTIxMDA4NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2382#discussion_r509210085", "bodyText": "Actually there is a very subtle difference between these 2.\nBaseTest::installApp method will install the app only when the app is not already installed.\nThis method here will install the app every time even if it's already installed. I had to use it to start with a fresh state so that the changes I make in one method doesn't affect the other method.", "author": "ShivamPokhriyal", "createdAt": "2020-10-21T11:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1MjY4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMzNzcwMw==", "url": "https://github.com/dimagi/commcare-android/pull/2382#discussion_r509337703", "bodyText": "what makes this test special that we are using a different mechanism here than other tests ?", "author": "shubham1g5", "createdAt": "2020-10-21T14:29:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1MjY4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3ODg1Nw==", "url": "https://github.com/dimagi/commcare-android/pull/2382#discussion_r509878857", "bodyText": "The tests in espresso can run in any order. Meaning testLanguageChanges can run before/after   testAppUpdate_dontInterfereLanguageChanges.\nNow, testLanguageChanges assumes that the device language is English to begin with.\nAnd testAppUpdate_dontInterfereLanguageChanges changes the device language to Hindi when it finishes.\nSo if, testAppUpdate_dontInterfereLanguageChanges runs before testLanguageChanges then testLanguageChanges would fail because \"Enter a name:\" text would've been changed.", "author": "ShivamPokhriyal", "createdAt": "2020-10-22T04:53:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1MjY4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk0MDI5OQ==", "url": "https://github.com/dimagi/commcare-android/pull/2382#discussion_r509940299", "bodyText": "Got it. thanks for the explanation. If you are looking to abstract this better you can choose to pass a force flag to the BaseTest::installApp method that if true clears the app even if it's already installed. That way we won't need to write this logic again and again for any tests that need this similar setup.", "author": "shubham1g5", "createdAt": "2020-10-22T07:32:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1MjY4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1NTEwNA==", "url": "https://github.com/dimagi/commcare-android/pull/2382#discussion_r509155104", "bodyText": "should move this to InstrumentationUtility as it's useful for most tests.", "author": "shubham1g5", "createdAt": "2020-10-21T10:08:19Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/LanguagesTest.kt", "diffHunk": "@@ -0,0 +1,135 @@\n+package org.commcare.androidTests\n+\n+import androidx.test.espresso.Espresso\n+import androidx.test.espresso.Espresso.closeSoftKeyboard\n+import androidx.test.espresso.Espresso.onView\n+import androidx.test.espresso.action.ViewActions.click\n+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import org.commcare.CommCareApplication\n+import org.commcare.dalvik.R\n+import org.commcare.utils.CustomMatchers\n+import org.commcare.utils.InstrumentationUtility\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class LanguagesTest : BaseTest() {\n+\n+    companion object {\n+        const val CCZ_NAME = \"languages.ccz\"\n+    }\n+\n+    @Before\n+    fun setup() {\n+        if (CommCareApplication.instance().currentApp == null) {\n+            InstrumentationUtility.installApp(FormEntryTest.CCZ_NAME)\n+        } else {\n+            InstrumentationUtility.uninstallCurrentApp()\n+            InstrumentationUtility.installApp(FormEntryTest.CCZ_NAME)\n+            Espresso.pressBack()\n+        }\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+    }\n+\n+    @Test\n+    fun testLanguageChanges() {\n+        InstrumentationUtility.openForm(0, 0)\n+        onView(withText(\"Enter a name:\"))\n+                .check(matches(isDisplayed()))\n+        exitForm()", "originalCommit": "d53d4bbef158d0a2a20b00fb1cb8bd94d1bb25c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTIxMDM5OQ==", "url": "https://github.com/dimagi/commcare-android/pull/2382#discussion_r509210399", "bodyText": "Agree on this, will make the changes.", "author": "ShivamPokhriyal", "createdAt": "2020-10-21T11:46:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1NTEwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1NjM0Nw==", "url": "https://github.com/dimagi/commcare-android/pull/2382#discussion_r509156347", "bodyText": "This can be generalized and move to InstrumentationUtility as selectMenu(int textId),", "author": "shubham1g5", "createdAt": "2020-10-21T10:10:14Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/LanguagesTest.kt", "diffHunk": "@@ -0,0 +1,135 @@\n+package org.commcare.androidTests\n+\n+import androidx.test.espresso.Espresso\n+import androidx.test.espresso.Espresso.closeSoftKeyboard\n+import androidx.test.espresso.Espresso.onView\n+import androidx.test.espresso.action.ViewActions.click\n+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import org.commcare.CommCareApplication\n+import org.commcare.dalvik.R\n+import org.commcare.utils.CustomMatchers\n+import org.commcare.utils.InstrumentationUtility\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class LanguagesTest : BaseTest() {\n+\n+    companion object {\n+        const val CCZ_NAME = \"languages.ccz\"\n+    }\n+\n+    @Before\n+    fun setup() {\n+        if (CommCareApplication.instance().currentApp == null) {\n+            InstrumentationUtility.installApp(FormEntryTest.CCZ_NAME)\n+        } else {\n+            InstrumentationUtility.uninstallCurrentApp()\n+            InstrumentationUtility.installApp(FormEntryTest.CCZ_NAME)\n+            Espresso.pressBack()\n+        }\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+    }\n+\n+    @Test\n+    fun testLanguageChanges() {\n+        InstrumentationUtility.openForm(0, 0)\n+        onView(withText(\"Enter a name:\"))\n+                .check(matches(isDisplayed()))\n+        exitForm()\n+        InstrumentationUtility.gotoHome()\n+        selectLanguageChangeOption()\n+        checkLanguageOptions()\n+\n+        // Confirm the options persist on rotation\n+        InstrumentationUtility.rotateLeft()\n+        checkLanguageOptions()\n+        InstrumentationUtility.rotatePortrait()\n+        checkLanguageOptions()\n+\n+        // Clicking just after rotating doesn't work for some reason, so waiting here for a moment.\n+        InstrumentationUtility.sleep(2)\n+        onView(withText(\"Hindi\"))\n+                .perform(click())\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Basic Form Tests\"))\n+                .perform(click())\n+        onView(withText(\"HIN: Languages\"))\n+                .perform(click())\n+\n+        onView(withText(\"HIN: Enter a name:\"))\n+                .check(matches(isDisplayed()))\n+\n+        // Check form language changes\n+        selectLanguageChangeOption()\n+        checkLanguageOptions()\n+        onView(withText(\"English\"))\n+                .perform(click())\n+\n+        onView(withText(\"HIN: Enter a name:\"))\n+                .check(doesNotExist())\n+        onView(withText(\"Enter a name:\"))\n+                .check(matches(isDisplayed()))\n+\n+        // Confirm app language remains the same.\n+        exitForm()\n+        onView(withText(\"HIN: Languages\"))\n+                .check(matches(isDisplayed()))\n+    }\n+\n+    @Test\n+    fun testAppUpdate_dontInterfereLanguageChanges() {\n+        selectLanguageChangeOption()\n+        checkLanguageOptions()\n+        // Change language to hindi\n+        onView(withText(\"Hindi\"))\n+                .perform(click())\n+\n+        // Update app\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Update App\"))\n+                .perform(click())\n+        onView(withText(\"Update to version 103 & log out\"))\n+                .perform(click())\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+\n+        // Confirm app language remains hindi\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Basic Form Tests\"))\n+                .perform(click())\n+        onView(withText(\"HIN: Languages\"))\n+                .check(matches(isDisplayed()))\n+    }\n+\n+    private fun selectLanguageChangeOption() {", "originalCommit": "d53d4bbef158d0a2a20b00fb1cb8bd94d1bb25c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1Nzg2MA==", "url": "https://github.com/dimagi/commcare-android/pull/2382#discussion_r509157860", "bodyText": "can reuse InstrumentationUtility.openForm(0, 0)", "author": "shubham1g5", "createdAt": "2020-10-21T10:12:49Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/LanguagesTest.kt", "diffHunk": "@@ -0,0 +1,135 @@\n+package org.commcare.androidTests\n+\n+import androidx.test.espresso.Espresso\n+import androidx.test.espresso.Espresso.closeSoftKeyboard\n+import androidx.test.espresso.Espresso.onView\n+import androidx.test.espresso.action.ViewActions.click\n+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import org.commcare.CommCareApplication\n+import org.commcare.dalvik.R\n+import org.commcare.utils.CustomMatchers\n+import org.commcare.utils.InstrumentationUtility\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class LanguagesTest : BaseTest() {\n+\n+    companion object {\n+        const val CCZ_NAME = \"languages.ccz\"\n+    }\n+\n+    @Before\n+    fun setup() {\n+        if (CommCareApplication.instance().currentApp == null) {\n+            InstrumentationUtility.installApp(FormEntryTest.CCZ_NAME)\n+        } else {\n+            InstrumentationUtility.uninstallCurrentApp()\n+            InstrumentationUtility.installApp(FormEntryTest.CCZ_NAME)\n+            Espresso.pressBack()\n+        }\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+    }\n+\n+    @Test\n+    fun testLanguageChanges() {\n+        InstrumentationUtility.openForm(0, 0)\n+        onView(withText(\"Enter a name:\"))\n+                .check(matches(isDisplayed()))\n+        exitForm()\n+        InstrumentationUtility.gotoHome()\n+        selectLanguageChangeOption()\n+        checkLanguageOptions()\n+\n+        // Confirm the options persist on rotation\n+        InstrumentationUtility.rotateLeft()\n+        checkLanguageOptions()\n+        InstrumentationUtility.rotatePortrait()\n+        checkLanguageOptions()\n+\n+        // Clicking just after rotating doesn't work for some reason, so waiting here for a moment.\n+        InstrumentationUtility.sleep(2)\n+        onView(withText(\"Hindi\"))\n+                .perform(click())\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Basic Form Tests\"))", "originalCommit": "d53d4bbef158d0a2a20b00fb1cb8bd94d1bb25c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTIxMTA5Mg==", "url": "https://github.com/dimagi/commcare-android/pull/2382#discussion_r509211092", "bodyText": "Strange, I don't know why I did this. Will change it.", "author": "ShivamPokhriyal", "createdAt": "2020-10-21T11:47:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1Nzg2MA=="}], "type": "inlineReview"}, {"oid": "c2878d830a58c75bae0881b7c363f08f559d772b", "url": "https://github.com/dimagi/commcare-android/commit/c2878d830a58c75bae0881b7c363f08f559d772b", "message": "Add languages test", "committedDate": "2020-10-21T12:42:23Z", "type": "commit"}, {"oid": "d515d5df0ccc51b0a280011bbdf181ffe5846f37", "url": "https://github.com/dimagi/commcare-android/commit/d515d5df0ccc51b0a280011bbdf181ffe5846f37", "message": "PR suggestions", "committedDate": "2020-10-21T13:05:59Z", "type": "commit"}, {"oid": "d515d5df0ccc51b0a280011bbdf181ffe5846f37", "url": "https://github.com/dimagi/commcare-android/commit/d515d5df0ccc51b0a280011bbdf181ffe5846f37", "message": "PR suggestions", "committedDate": "2020-10-21T13:05:59Z", "type": "forcePushed"}, {"oid": "8a19146e680f3f79dbcb848d83d63e1c988385b4", "url": "https://github.com/dimagi/commcare-android/commit/8a19146e680f3f79dbcb848d83d63e1c988385b4", "message": "Modify BaseTest appinstall method to use force flag", "committedDate": "2020-10-22T08:25:22Z", "type": "commit"}, {"oid": "03d49fe563a3554246024ea72e0a59886deca98f", "url": "https://github.com/dimagi/commcare-android/commit/03d49fe563a3554246024ea72e0a59886deca98f", "message": "Fix delegaterunner couldn't be loaded crash", "committedDate": "2020-10-22T09:21:19Z", "type": "commit"}]}