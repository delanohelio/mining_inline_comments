{"pr_number": 2407, "pr_title": "Support for CommCare Identity Hooks", "pr_createdAt": "2020-11-16T12:23:22Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2407", "timeline": [{"oid": "ab20f122672b4e6e9304e6cd616aa549d1800c02", "url": "https://github.com/dimagi/commcare-android/commit/ab20f122672b4e6e9304e6cd616aa549d1800c02", "message": "Merge Support Library", "committedDate": "2020-11-09T08:10:27Z", "type": "commit"}, {"oid": "847f26ac7bf24e510c8a0cf6c124f5fbefabdaeb", "url": "https://github.com/dimagi/commcare-android/commit/847f26ac7bf24e510c8a0cf6c124f5fbefabdaeb", "message": "Adds handling for generalized Indentity Provider callouts", "committedDate": "2020-11-10T19:05:48Z", "type": "commit"}, {"oid": "1c0b753ac06eed0aade36fa566d55034576ec594", "url": "https://github.com/dimagi/commcare-android/commit/1c0b753ac06eed0aade36fa566d55034576ec594", "message": "Tests for Identity Worlflows with some test cleanup", "committedDate": "2020-11-16T12:13:24Z", "type": "commit"}, {"oid": "397297c05f0d624001acaa5561262b53a6fff778", "url": "https://github.com/dimagi/commcare-android/commit/397297c05f0d624001acaa5561262b53a6fff778", "message": "Merge branch 'master' into supportLibMerge", "committedDate": "2020-11-16T12:16:45Z", "type": "commit"}, {"oid": "b57827b47f104aa5e2db3bb5c5cadde36d0cad04", "url": "https://github.com/dimagi/commcare-android/commit/b57827b47f104aa5e2db3bb5c5cadde36d0cad04", "message": "Bumps target version for support lib to be same as commcare", "committedDate": "2020-11-16T12:31:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMzMDcxMw==", "url": "https://github.com/dimagi/commcare-android/pull/2407#discussion_r524330713", "bodyText": "Woah, What does this annotation do?", "author": "ctsims", "createdAt": "2020-11-16T14:59:05Z", "path": "app/src/org/commcare/activities/EntitySelectActivity.java", "diffHunk": "@@ -664,9 +669,16 @@ private void handleSearchStringCallout(Intent intent) {\n         }\r\n     }\r\n \r\n-    private void handleFingerprintMatchCallout(Intent intent) {\r\n-        OrderedHashtable<String, String> guidToMatchConfidenceMap =\r\n-                SimprintsCalloutProcessing.getConfidenceMatchesFromCalloutResponse(intent);\r\n+    private void handleFingerprintMatchCallout(\r\n+            Intent intent,\r\n+            @IdentityCalloutHandler.IdentityProvider String identityProvider) {\r", "originalCommit": "b57827b47f104aa5e2db3bb5c5cadde36d0cad04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ1MDEyOA==", "url": "https://github.com/dimagi/commcare-android/pull/2407#discussion_r524450128", "bodyText": "This is just a more memory-efficient replacement for Enums on Android. This is a quick gide on this in case you are interested.", "author": "shubham1g5", "createdAt": "2020-11-16T17:34:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMzMDcxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM4NDc3Nw==", "url": "https://github.com/dimagi/commcare-android/pull/2407#discussion_r524384777", "bodyText": "Is there still some way to specifically choose each identity provider (with, say, an ID the same way that SimPrints works?)?\nI doubt there will often be more than one in use at a time, but I imagine inside of an app, when people configure \"Their identify provider\" they may want to choose a specific one.", "author": "ctsims", "createdAt": "2020-11-16T16:09:11Z", "path": "app/src/org/commcare/provider/IdentityCalloutHandler.java", "diffHunk": "@@ -0,0 +1,174 @@\n+package org.commcare.provider;\n+\n+import android.content.Intent;\n+\n+import org.commcare.android.javarosa.IntentCallout;\n+import org.commcare.commcaresupportlibrary.identity.IdentityResponseBuilder;\n+import org.commcare.commcaresupportlibrary.identity.model.IdentificationMatch;\n+import org.commcare.commcaresupportlibrary.identity.model.MatchResult;\n+import org.commcare.commcaresupportlibrary.identity.model.MatchStrength;\n+import org.commcare.commcaresupportlibrary.identity.model.RegistrationResult;\n+import org.commcare.commcaresupportlibrary.identity.model.VerificationMatch;\n+import org.commcare.util.LogTypes;\n+import org.javarosa.core.model.FormDef;\n+import org.javarosa.core.model.condition.EvaluationContext;\n+import org.javarosa.core.model.instance.AbstractTreeElement;\n+import org.javarosa.core.model.instance.TreeReference;\n+import org.javarosa.core.services.Logger;\n+import org.javarosa.core.services.locale.Localization;\n+import org.javarosa.core.util.OrderedHashtable;\n+\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.util.Collections;\n+import java.util.Hashtable;\n+import java.util.List;\n+import java.util.Vector;\n+\n+import androidx.annotation.StringDef;\n+\n+public class IdentityCalloutHandler {\n+\n+\n+    private static final String REF_GUID = \"guid\";\n+    private static final String REF_CONFIDENCE = \"confidence\";\n+    private static final String REF_MATCH_STRENGTH = \"match_strength\";\n+\n+    public static final String GENERALIZED_IDENTITY_PROVIDER = \"generalized_identity_provider\";\n+\n+\n+    @StringDef({GENERALIZED_IDENTITY_PROVIDER, SimprintsCalloutProcessing.SIMPRINTS_IDENTITY_PROVIDER})\n+    @Retention(RetentionPolicy.SOURCE)\n+    public @interface IdentityProvider {", "originalCommit": "b57827b47f104aa5e2db3bb5c5cadde36d0cad04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ1MzQyMQ==", "url": "https://github.com/dimagi/commcare-android/pull/2407#discussion_r524453421", "bodyText": "Choice of Identity provider totally depends on the callout action the app defines i.e. \"org.simprint.action\" vs something else. The Identity provider scpecific handling in the app only applies on the Intent reponse handling which we do by checking the format of the response in intent like here.", "author": "shubham1g5", "createdAt": "2020-11-16T17:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM4NDc3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM4NTYxNw==", "url": "https://github.com/dimagi/commcare-android/pull/2407#discussion_r524385617", "bodyText": "Is there something unique to how this app works? The pattern of having the class itself consist ~entirely of static members makes it seem like it's doing something specific that I don't quite understand, but I could also see this just being a set of helper methods.", "author": "ctsims", "createdAt": "2020-11-16T16:10:22Z", "path": "app/src/org/commcare/provider/IdentityCalloutHandler.java", "diffHunk": "@@ -0,0 +1,174 @@\n+package org.commcare.provider;\n+\n+import android.content.Intent;\n+\n+import org.commcare.android.javarosa.IntentCallout;\n+import org.commcare.commcaresupportlibrary.identity.IdentityResponseBuilder;\n+import org.commcare.commcaresupportlibrary.identity.model.IdentificationMatch;\n+import org.commcare.commcaresupportlibrary.identity.model.MatchResult;\n+import org.commcare.commcaresupportlibrary.identity.model.MatchStrength;\n+import org.commcare.commcaresupportlibrary.identity.model.RegistrationResult;\n+import org.commcare.commcaresupportlibrary.identity.model.VerificationMatch;\n+import org.commcare.util.LogTypes;\n+import org.javarosa.core.model.FormDef;\n+import org.javarosa.core.model.condition.EvaluationContext;\n+import org.javarosa.core.model.instance.AbstractTreeElement;\n+import org.javarosa.core.model.instance.TreeReference;\n+import org.javarosa.core.services.Logger;\n+import org.javarosa.core.services.locale.Localization;\n+import org.javarosa.core.util.OrderedHashtable;\n+\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.util.Collections;\n+import java.util.Hashtable;\n+import java.util.List;\n+import java.util.Vector;\n+\n+import androidx.annotation.StringDef;\n+\n+public class IdentityCalloutHandler {", "originalCommit": "b57827b47f104aa5e2db3bb5c5cadde36d0cad04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ1NTQ1MA==", "url": "https://github.com/dimagi/commcare-android/pull/2407#discussion_r524455450", "bodyText": "I was trying to mimic the SimprintsCalloutProcessing here. Both of these classed can potentially implement an Identity Provider interface though we won't be able to define all these methods as static in that case. Would that be ok ? Not sure if static methods are of a particular advantage here.", "author": "shubham1g5", "createdAt": "2020-11-16T17:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM4NTYxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM4NzQyMw==", "url": "https://github.com/dimagi/commcare-android/pull/2407#discussion_r524387423", "bodyText": "I'm presuming these were copied over ~identically from the support library and don't need new review, is that assumption correct?", "author": "ctsims", "createdAt": "2020-11-16T16:12:55Z", "path": "commcare-support-library/src/main/java/org/commcare/commcaresupportlibrary/CaseUtils.java", "diffHunk": "@@ -0,0 +1,252 @@\n+package org.commcare.commcaresupportlibrary;", "originalCommit": "b57827b47f104aa5e2db3bb5c5cadde36d0cad04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ1NjAyNw==", "url": "https://github.com/dimagi/commcare-android/pull/2407#discussion_r524456027", "bodyText": "yes. It's an exact copy so no need to review.", "author": "shubham1g5", "createdAt": "2020-11-16T17:43:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM4NzQyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ1NzI0OA==", "url": "https://github.com/dimagi/commcare-android/pull/2407#discussion_r524457248", "bodyText": "well one minor change that I had to do is target the same android versions as commcare-android in order to build successfully and avoid some resource conflicts.", "author": "shubham1g5", "createdAt": "2020-11-16T17:45:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM4NzQyMw=="}], "type": "inlineReview"}, {"oid": "776e6728f0543a1321e7592e492ecaa62aa04c86", "url": "https://github.com/dimagi/commcare-android/commit/776e6728f0543a1321e7592e492ecaa62aa04c86", "message": "Duplicate handling during identity registration", "committedDate": "2020-11-23T12:55:01Z", "type": "commit"}, {"oid": "c00603e7325557912ea711711b9d737c865cd297", "url": "https://github.com/dimagi/commcare-android/commit/c00603e7325557912ea711711b9d737c865cd297", "message": "Update identity_integration.md\n\ndoc correction", "committedDate": "2020-12-11T10:21:37Z", "type": "commit"}, {"oid": "dbffa263e9329d1eadd134567ec035da60406249", "url": "https://github.com/dimagi/commcare-android/commit/dbffa263e9329d1eadd134567ec035da60406249", "message": "Update identity_integration.md\n\nfinalize -> finalizeResponse", "committedDate": "2020-12-11T10:22:11Z", "type": "commit"}, {"oid": "a8daf62e6386779f42f1c606701a912e70d553fa", "url": "https://github.com/dimagi/commcare-android/commit/a8daf62e6386779f42f1c606701a912e70d553fa", "message": "Update identity_integration.md\n\ncorrect docs for Identification -> IdentificationMatch", "committedDate": "2020-12-15T07:22:29Z", "type": "commit"}, {"oid": "36e7cfb222c6bce3f1d8333f65e3b644e9b9ab84", "url": "https://github.com/dimagi/commcare-android/commit/36e7cfb222c6bce3f1d8333f65e3b644e9b9ab84", "message": "fixes return values for identity callouts", "committedDate": "2020-12-17T10:48:48Z", "type": "commit"}, {"oid": "bd641df727017cf294c8f0fe79733985ad4c136f", "url": "https://github.com/dimagi/commcare-android/commit/bd641df727017cf294c8f0fe79733985ad4c136f", "message": "set responses to intent question reference for identity callouts", "committedDate": "2020-12-17T11:43:48Z", "type": "commit"}, {"oid": "d7139c9aac3b6cf5be42097ebe04e917112520bc", "url": "https://github.com/dimagi/commcare-android/commit/d7139c9aac3b6cf5be42097ebe04e917112520bc", "message": "Merge branch 'supportLibMerge' of https://github.com/dimagi/commcare-android into supportLibMerge", "committedDate": "2020-12-17T11:45:02Z", "type": "commit"}]}