{"pr_number": 2299, "pr_title": "Add more tests from calabash to espresso", "pr_createdAt": "2020-07-28T10:55:28Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2299", "timeline": [{"oid": "fd4743ac0a70838deed97c62c82ffea439ce537e", "url": "https://github.com/dimagi/commcare-android/commit/fd4743ac0a70838deed97c62c82ffea439ce537e", "message": "Remove assertion", "committedDate": "2020-08-06T04:57:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAzNTQ4OA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469035488", "bodyText": "we should rename to InstallFromListTest as these tests are only about the Install from list feature.", "author": "shubham1g5", "createdAt": "2020-08-12T06:35:48Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppInstallationTest.kt", "diffHunk": "@@ -0,0 +1,199 @@\n+package org.commcare.androidTests\n+\n+import android.widget.ListView\n+import androidx.test.espresso.Espresso.closeSoftKeyboard\n+import androidx.test.espresso.Espresso.onView\n+import androidx.test.espresso.Espresso.onData\n+import androidx.test.espresso.action.ViewActions.*\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.intent.Intents.intended\n+import androidx.test.espresso.intent.matcher.IntentMatchers.hasComponent\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.platform.app.InstrumentationRegistry\n+import junit.framework.Assert.fail\n+import org.commcare.CommCareApplication\n+import org.commcare.CommCareInstrumentationTestApplication\n+import org.commcare.activities.InstallFromListActivity\n+import org.commcare.android.database.global.models.AppAvailableToInstall\n+import org.commcare.dalvik.BuildConfig\n+import org.commcare.dalvik.R\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Description\n+import org.hamcrest.Matchers.*\n+import org.hamcrest.TypeSafeMatcher\n+import org.junit.After\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppInstallationTest: BaseTest() {", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAzNjYwNA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469036604", "bodyText": "what's the reason behind repeating the closeSoftKeyboard call ?", "author": "shubham1g5", "createdAt": "2020-08-12T06:38:40Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppInstallationTest.kt", "diffHunk": "@@ -0,0 +1,199 @@\n+package org.commcare.androidTests\n+\n+import android.widget.ListView\n+import androidx.test.espresso.Espresso.closeSoftKeyboard\n+import androidx.test.espresso.Espresso.onView\n+import androidx.test.espresso.Espresso.onData\n+import androidx.test.espresso.action.ViewActions.*\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.intent.Intents.intended\n+import androidx.test.espresso.intent.matcher.IntentMatchers.hasComponent\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.platform.app.InstrumentationRegistry\n+import junit.framework.Assert.fail\n+import org.commcare.CommCareApplication\n+import org.commcare.CommCareInstrumentationTestApplication\n+import org.commcare.activities.InstallFromListActivity\n+import org.commcare.android.database.global.models.AppAvailableToInstall\n+import org.commcare.dalvik.BuildConfig\n+import org.commcare.dalvik.R\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Description\n+import org.hamcrest.Matchers.*\n+import org.hamcrest.TypeSafeMatcher\n+import org.junit.After\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppInstallationTest: BaseTest() {\n+\n+    @After\n+    fun setup() {\n+        // Uninstall app.\n+        InstrumentationUtility.uninstallCurrentApp()\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for Another User\"))\n+                .perform(click())\n+    }\n+\n+    @Test\n+    fun testAppInstall_usingMobieWorkerDetails() {\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        // Confirm the activity\n+        intended(hasComponent(InstallFromListActivity::class.java.name))\n+\n+        // Verify that we start out in mobile user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(isDisplayed()))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(not(isDisplayed())))\n+\n+        // Toggle switch\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Verify that we're now in web user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(not(isDisplayed())))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(isDisplayed()))\n+\n+        // Switch back to mobile auth view\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Test getting app list for a mobile user\n+        onView(withId(R.id.edit_username))\n+                .perform(typeText(\"test\"))\n+        closeSoftKeyboard()\n+        closeSoftKeyboard()", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM0ODkyMg==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r471348922", "bodyText": "might have added by mistake, will remove it.", "author": "ShivamPokhriyal", "createdAt": "2020-08-17T09:17:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAzNjYwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0MTU4OA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469041588", "bodyText": "we should create a method wrapping the text input and close keyboard calls and call that instead to avoid multiple close keyboard calls.", "author": "shubham1g5", "createdAt": "2020-08-12T06:50:18Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppInstallationTest.kt", "diffHunk": "@@ -0,0 +1,199 @@\n+package org.commcare.androidTests\n+\n+import android.widget.ListView\n+import androidx.test.espresso.Espresso.closeSoftKeyboard\n+import androidx.test.espresso.Espresso.onView\n+import androidx.test.espresso.Espresso.onData\n+import androidx.test.espresso.action.ViewActions.*\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.intent.Intents.intended\n+import androidx.test.espresso.intent.matcher.IntentMatchers.hasComponent\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.platform.app.InstrumentationRegistry\n+import junit.framework.Assert.fail\n+import org.commcare.CommCareApplication\n+import org.commcare.CommCareInstrumentationTestApplication\n+import org.commcare.activities.InstallFromListActivity\n+import org.commcare.android.database.global.models.AppAvailableToInstall\n+import org.commcare.dalvik.BuildConfig\n+import org.commcare.dalvik.R\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Description\n+import org.hamcrest.Matchers.*\n+import org.hamcrest.TypeSafeMatcher\n+import org.junit.After\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppInstallationTest: BaseTest() {\n+\n+    @After\n+    fun setup() {\n+        // Uninstall app.\n+        InstrumentationUtility.uninstallCurrentApp()\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for Another User\"))\n+                .perform(click())\n+    }\n+\n+    @Test\n+    fun testAppInstall_usingMobieWorkerDetails() {\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        // Confirm the activity\n+        intended(hasComponent(InstallFromListActivity::class.java.name))\n+\n+        // Verify that we start out in mobile user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(isDisplayed()))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(not(isDisplayed())))\n+\n+        // Toggle switch\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Verify that we're now in web user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(not(isDisplayed())))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(isDisplayed()))\n+\n+        // Switch back to mobile auth view\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Test getting app list for a mobile user\n+        onView(withId(R.id.edit_username))\n+                .perform(typeText(\"test\"))\n+        closeSoftKeyboard()\n+        closeSoftKeyboard()\n+        onView(withId(R.id.edit_domain))\n+                .perform(typeText(\"commcare-tests\"))\n+        closeSoftKeyboard()\n+        onView(withId(R.id.edit_password))", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0MjQwMw==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469042403", "bodyText": "very cool.", "author": "shubham1g5", "createdAt": "2020-08-12T06:52:01Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppInstallationTest.kt", "diffHunk": "@@ -0,0 +1,199 @@\n+package org.commcare.androidTests\n+\n+import android.widget.ListView\n+import androidx.test.espresso.Espresso.closeSoftKeyboard\n+import androidx.test.espresso.Espresso.onView\n+import androidx.test.espresso.Espresso.onData\n+import androidx.test.espresso.action.ViewActions.*\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.intent.Intents.intended\n+import androidx.test.espresso.intent.matcher.IntentMatchers.hasComponent\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.platform.app.InstrumentationRegistry\n+import junit.framework.Assert.fail\n+import org.commcare.CommCareApplication\n+import org.commcare.CommCareInstrumentationTestApplication\n+import org.commcare.activities.InstallFromListActivity\n+import org.commcare.android.database.global.models.AppAvailableToInstall\n+import org.commcare.dalvik.BuildConfig\n+import org.commcare.dalvik.R\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Description\n+import org.hamcrest.Matchers.*\n+import org.hamcrest.TypeSafeMatcher\n+import org.junit.After\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppInstallationTest: BaseTest() {\n+\n+    @After\n+    fun setup() {\n+        // Uninstall app.\n+        InstrumentationUtility.uninstallCurrentApp()\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for Another User\"))\n+                .perform(click())\n+    }\n+\n+    @Test\n+    fun testAppInstall_usingMobieWorkerDetails() {\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        // Confirm the activity\n+        intended(hasComponent(InstallFromListActivity::class.java.name))\n+\n+        // Verify that we start out in mobile user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(isDisplayed()))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(not(isDisplayed())))\n+\n+        // Toggle switch\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Verify that we're now in web user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(not(isDisplayed())))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(isDisplayed()))\n+\n+        // Switch back to mobile auth view\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Test getting app list for a mobile user\n+        onView(withId(R.id.edit_username))\n+                .perform(typeText(\"test\"))\n+        closeSoftKeyboard()\n+        closeSoftKeyboard()\n+        onView(withId(R.id.edit_domain))\n+                .perform(typeText(\"commcare-tests\"))\n+        closeSoftKeyboard()\n+        onView(withId(R.id.edit_password))\n+                .perform(typeText(\"123\"))\n+        closeSoftKeyboard()\n+        onView(withId(R.id.get_apps_button))\n+                .perform(click())\n+\n+        // Check that all the apps belong to commcare-tests domain\n+        for (position in 0 until getAppListSize()) {", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0MzQ4Nw==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469043487", "bodyText": "nice asserts, would be useful to bundle these both in a function that checks the validity of the seated app.", "author": "shubham1g5", "createdAt": "2020-08-12T06:54:34Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppInstallationTest.kt", "diffHunk": "@@ -0,0 +1,199 @@\n+package org.commcare.androidTests\n+\n+import android.widget.ListView\n+import androidx.test.espresso.Espresso.closeSoftKeyboard\n+import androidx.test.espresso.Espresso.onView\n+import androidx.test.espresso.Espresso.onData\n+import androidx.test.espresso.action.ViewActions.*\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.intent.Intents.intended\n+import androidx.test.espresso.intent.matcher.IntentMatchers.hasComponent\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.platform.app.InstrumentationRegistry\n+import junit.framework.Assert.fail\n+import org.commcare.CommCareApplication\n+import org.commcare.CommCareInstrumentationTestApplication\n+import org.commcare.activities.InstallFromListActivity\n+import org.commcare.android.database.global.models.AppAvailableToInstall\n+import org.commcare.dalvik.BuildConfig\n+import org.commcare.dalvik.R\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Description\n+import org.hamcrest.Matchers.*\n+import org.hamcrest.TypeSafeMatcher\n+import org.junit.After\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppInstallationTest: BaseTest() {\n+\n+    @After\n+    fun setup() {\n+        // Uninstall app.\n+        InstrumentationUtility.uninstallCurrentApp()\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for Another User\"))\n+                .perform(click())\n+    }\n+\n+    @Test\n+    fun testAppInstall_usingMobieWorkerDetails() {\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        // Confirm the activity\n+        intended(hasComponent(InstallFromListActivity::class.java.name))\n+\n+        // Verify that we start out in mobile user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(isDisplayed()))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(not(isDisplayed())))\n+\n+        // Toggle switch\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Verify that we're now in web user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(not(isDisplayed())))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(isDisplayed()))\n+\n+        // Switch back to mobile auth view\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Test getting app list for a mobile user\n+        onView(withId(R.id.edit_username))\n+                .perform(typeText(\"test\"))\n+        closeSoftKeyboard()\n+        closeSoftKeyboard()\n+        onView(withId(R.id.edit_domain))\n+                .perform(typeText(\"commcare-tests\"))\n+        closeSoftKeyboard()\n+        onView(withId(R.id.edit_password))\n+                .perform(typeText(\"123\"))\n+        closeSoftKeyboard()\n+        onView(withId(R.id.get_apps_button))\n+                .perform(click())\n+\n+        // Check that all the apps belong to commcare-tests domain\n+        for (position in 0 until getAppListSize()) {\n+            InstrumentationUtility.getSubViewInListItem(R.id.apps_list_view, position, R.id.domain)\n+                    .check(matches(withText(\"commcare-tests\")))\n+        }\n+\n+        // Check the app names\n+        matchAppInAppList(\"Case callout test for Simprints\")\n+        matchAppInAppList(\"Case Search and Claim\")\n+        matchAppInAppList(\"Integration Tests\")\n+\n+        // Install 1 of the apps\n+        onView(withText(\"Case Search and Claim\"))\n+                .perform(click())\n+\n+        assert(CommCareApplication.instance().currentApp != null, \"App is null\")", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NjYxMw==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469046613", "bodyText": "L110-130 can be moved to a before test setup", "author": "shubham1g5", "createdAt": "2020-08-12T07:01:18Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppInstallationTest.kt", "diffHunk": "@@ -0,0 +1,199 @@\n+package org.commcare.androidTests\n+\n+import android.widget.ListView\n+import androidx.test.espresso.Espresso.closeSoftKeyboard\n+import androidx.test.espresso.Espresso.onView\n+import androidx.test.espresso.Espresso.onData\n+import androidx.test.espresso.action.ViewActions.*\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.intent.Intents.intended\n+import androidx.test.espresso.intent.matcher.IntentMatchers.hasComponent\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.platform.app.InstrumentationRegistry\n+import junit.framework.Assert.fail\n+import org.commcare.CommCareApplication\n+import org.commcare.CommCareInstrumentationTestApplication\n+import org.commcare.activities.InstallFromListActivity\n+import org.commcare.android.database.global.models.AppAvailableToInstall\n+import org.commcare.dalvik.BuildConfig\n+import org.commcare.dalvik.R\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Description\n+import org.hamcrest.Matchers.*\n+import org.hamcrest.TypeSafeMatcher\n+import org.junit.After\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppInstallationTest: BaseTest() {\n+\n+    @After\n+    fun setup() {\n+        // Uninstall app.\n+        InstrumentationUtility.uninstallCurrentApp()\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for Another User\"))\n+                .perform(click())\n+    }\n+\n+    @Test\n+    fun testAppInstall_usingMobieWorkerDetails() {\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        // Confirm the activity\n+        intended(hasComponent(InstallFromListActivity::class.java.name))\n+\n+        // Verify that we start out in mobile user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(isDisplayed()))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(not(isDisplayed())))\n+\n+        // Toggle switch\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Verify that we're now in web user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(not(isDisplayed())))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(isDisplayed()))\n+\n+        // Switch back to mobile auth view\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Test getting app list for a mobile user\n+        onView(withId(R.id.edit_username))\n+                .perform(typeText(\"test\"))\n+        closeSoftKeyboard()\n+        closeSoftKeyboard()\n+        onView(withId(R.id.edit_domain))\n+                .perform(typeText(\"commcare-tests\"))\n+        closeSoftKeyboard()\n+        onView(withId(R.id.edit_password))\n+                .perform(typeText(\"123\"))\n+        closeSoftKeyboard()\n+        onView(withId(R.id.get_apps_button))\n+                .perform(click())\n+\n+        // Check that all the apps belong to commcare-tests domain\n+        for (position in 0 until getAppListSize()) {\n+            InstrumentationUtility.getSubViewInListItem(R.id.apps_list_view, position, R.id.domain)\n+                    .check(matches(withText(\"commcare-tests\")))\n+        }\n+\n+        // Check the app names\n+        matchAppInAppList(\"Case callout test for Simprints\")\n+        matchAppInAppList(\"Case Search and Claim\")\n+        matchAppInAppList(\"Integration Tests\")\n+\n+        // Install 1 of the apps\n+        onView(withText(\"Case Search and Claim\"))\n+                .perform(click())\n+\n+        assert(CommCareApplication.instance().currentApp != null, \"App is null\")\n+        assert(CommCareApplication.instance().currentApp.appRecord.displayName == \"Case Search and Claim\", \"App didn't match\")\n+    }\n+\n+    @Test\n+    fun testAppInstall_usingWebWorkerDetails() {\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        // Confirm the activity\n+        intended(hasComponent(InstallFromListActivity::class.java.name))\n+\n+        // Verify that we start out in mobile user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(isDisplayed()))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(not(isDisplayed())))\n+\n+        // Toggle switch\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Verify that we're now in web user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(not(isDisplayed())))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(isDisplayed()))", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NzIzNg==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469047236", "bodyText": "what's the reason that are we not simply touching the text as we are doing above in the testAppInstall_usingMobieWorkerDetails", "author": "shubham1g5", "createdAt": "2020-08-12T07:02:44Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppInstallationTest.kt", "diffHunk": "@@ -0,0 +1,199 @@\n+package org.commcare.androidTests\n+\n+import android.widget.ListView\n+import androidx.test.espresso.Espresso.closeSoftKeyboard\n+import androidx.test.espresso.Espresso.onView\n+import androidx.test.espresso.Espresso.onData\n+import androidx.test.espresso.action.ViewActions.*\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.intent.Intents.intended\n+import androidx.test.espresso.intent.matcher.IntentMatchers.hasComponent\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.platform.app.InstrumentationRegistry\n+import junit.framework.Assert.fail\n+import org.commcare.CommCareApplication\n+import org.commcare.CommCareInstrumentationTestApplication\n+import org.commcare.activities.InstallFromListActivity\n+import org.commcare.android.database.global.models.AppAvailableToInstall\n+import org.commcare.dalvik.BuildConfig\n+import org.commcare.dalvik.R\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Description\n+import org.hamcrest.Matchers.*\n+import org.hamcrest.TypeSafeMatcher\n+import org.junit.After\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppInstallationTest: BaseTest() {\n+\n+    @After\n+    fun setup() {\n+        // Uninstall app.\n+        InstrumentationUtility.uninstallCurrentApp()\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for Another User\"))\n+                .perform(click())\n+    }\n+\n+    @Test\n+    fun testAppInstall_usingMobieWorkerDetails() {\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        // Confirm the activity\n+        intended(hasComponent(InstallFromListActivity::class.java.name))\n+\n+        // Verify that we start out in mobile user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(isDisplayed()))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(not(isDisplayed())))\n+\n+        // Toggle switch\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Verify that we're now in web user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(not(isDisplayed())))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(isDisplayed()))\n+\n+        // Switch back to mobile auth view\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Test getting app list for a mobile user\n+        onView(withId(R.id.edit_username))\n+                .perform(typeText(\"test\"))\n+        closeSoftKeyboard()\n+        closeSoftKeyboard()\n+        onView(withId(R.id.edit_domain))\n+                .perform(typeText(\"commcare-tests\"))\n+        closeSoftKeyboard()\n+        onView(withId(R.id.edit_password))\n+                .perform(typeText(\"123\"))\n+        closeSoftKeyboard()\n+        onView(withId(R.id.get_apps_button))\n+                .perform(click())\n+\n+        // Check that all the apps belong to commcare-tests domain\n+        for (position in 0 until getAppListSize()) {\n+            InstrumentationUtility.getSubViewInListItem(R.id.apps_list_view, position, R.id.domain)\n+                    .check(matches(withText(\"commcare-tests\")))\n+        }\n+\n+        // Check the app names\n+        matchAppInAppList(\"Case callout test for Simprints\")\n+        matchAppInAppList(\"Case Search and Claim\")\n+        matchAppInAppList(\"Integration Tests\")\n+\n+        // Install 1 of the apps\n+        onView(withText(\"Case Search and Claim\"))\n+                .perform(click())\n+\n+        assert(CommCareApplication.instance().currentApp != null, \"App is null\")\n+        assert(CommCareApplication.instance().currentApp.appRecord.displayName == \"Case Search and Claim\", \"App didn't match\")\n+    }\n+\n+    @Test\n+    fun testAppInstall_usingWebWorkerDetails() {\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        // Confirm the activity\n+        intended(hasComponent(InstallFromListActivity::class.java.name))\n+\n+        // Verify that we start out in mobile user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(isDisplayed()))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(not(isDisplayed())))\n+\n+        // Toggle switch\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Verify that we're now in web user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(not(isDisplayed())))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(isDisplayed()))\n+\n+        // Test getting app list for a mobile user\n+        onView(withId(R.id.edit_email))\n+                .perform(typeText(BuildConfig.HQ_API_USERNAME))\n+        closeSoftKeyboard()\n+        onView(withId(R.id.edit_password))\n+                .perform(typeText(BuildConfig.HQ_API_PASSWORD))\n+        closeSoftKeyboard()\n+        onView(withId(R.id.get_apps_button))\n+                .perform(click())\n+\n+        // Check that we see each of the apps in this domain, plus the domain name\n+        for (position in 0 until getAppListSize()) {\n+            InstrumentationUtility.getSubViewInListItem(R.id.apps_list_view, position, R.id.domain)\n+                    .check(matches(anyOf(withText(\"commcare-tests\"), withText(\"swat\"))))\n+        }\n+\n+        matchAppInAppList(\"Case callout test for Simprints\")\n+        matchAppInAppList(\"Case Search and Claim\")\n+        matchAppInAppList(\"Demo - Form Design Patterns\")\n+        matchAppInAppList(\"Demo - Live XForm Examples\")\n+        matchAppInAppList(\"SWAT: CommCare Projects Phone Survey\")\n+        matchAppInAppList(\"SWAT: App Tracker\")\n+\n+        // Install 1 of the apps\n+        onData(allOf(`is`(instanceOf(AppAvailableToInstall::class.java)),", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM1MDc4OQ==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r471350789", "bodyText": "Ohh, actually this one's a better way to click a list item, as this will automatically scroll the list if the item is not yet visible. The above one simply clicks the view in the screen, and I forgot to update the above one, though it works cuz the list isn't big.\nSo I'll update the above one to use onData utility.", "author": "ShivamPokhriyal", "createdAt": "2020-08-17T09:20:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0NzIzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0ODE0Mg==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469048142", "bodyText": "this would be useful in all the tests and should move out to a util class", "author": "shubham1g5", "createdAt": "2020-08-12T07:04:48Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppInstallationTest.kt", "diffHunk": "@@ -0,0 +1,199 @@\n+package org.commcare.androidTests\n+\n+import android.widget.ListView\n+import androidx.test.espresso.Espresso.closeSoftKeyboard\n+import androidx.test.espresso.Espresso.onView\n+import androidx.test.espresso.Espresso.onData\n+import androidx.test.espresso.action.ViewActions.*\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.intent.Intents.intended\n+import androidx.test.espresso.intent.matcher.IntentMatchers.hasComponent\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.platform.app.InstrumentationRegistry\n+import junit.framework.Assert.fail\n+import org.commcare.CommCareApplication\n+import org.commcare.CommCareInstrumentationTestApplication\n+import org.commcare.activities.InstallFromListActivity\n+import org.commcare.android.database.global.models.AppAvailableToInstall\n+import org.commcare.dalvik.BuildConfig\n+import org.commcare.dalvik.R\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Description\n+import org.hamcrest.Matchers.*\n+import org.hamcrest.TypeSafeMatcher\n+import org.junit.After\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppInstallationTest: BaseTest() {\n+\n+    @After\n+    fun setup() {\n+        // Uninstall app.\n+        InstrumentationUtility.uninstallCurrentApp()\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for Another User\"))\n+                .perform(click())\n+    }\n+\n+    @Test\n+    fun testAppInstall_usingMobieWorkerDetails() {\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        // Confirm the activity\n+        intended(hasComponent(InstallFromListActivity::class.java.name))\n+\n+        // Verify that we start out in mobile user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(isDisplayed()))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(not(isDisplayed())))\n+\n+        // Toggle switch\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Verify that we're now in web user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(not(isDisplayed())))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(isDisplayed()))\n+\n+        // Switch back to mobile auth view\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Test getting app list for a mobile user\n+        onView(withId(R.id.edit_username))\n+                .perform(typeText(\"test\"))\n+        closeSoftKeyboard()\n+        closeSoftKeyboard()\n+        onView(withId(R.id.edit_domain))\n+                .perform(typeText(\"commcare-tests\"))\n+        closeSoftKeyboard()\n+        onView(withId(R.id.edit_password))\n+                .perform(typeText(\"123\"))\n+        closeSoftKeyboard()\n+        onView(withId(R.id.get_apps_button))\n+                .perform(click())\n+\n+        // Check that all the apps belong to commcare-tests domain\n+        for (position in 0 until getAppListSize()) {\n+            InstrumentationUtility.getSubViewInListItem(R.id.apps_list_view, position, R.id.domain)\n+                    .check(matches(withText(\"commcare-tests\")))\n+        }\n+\n+        // Check the app names\n+        matchAppInAppList(\"Case callout test for Simprints\")\n+        matchAppInAppList(\"Case Search and Claim\")\n+        matchAppInAppList(\"Integration Tests\")\n+\n+        // Install 1 of the apps\n+        onView(withText(\"Case Search and Claim\"))\n+                .perform(click())\n+\n+        assert(CommCareApplication.instance().currentApp != null, \"App is null\")\n+        assert(CommCareApplication.instance().currentApp.appRecord.displayName == \"Case Search and Claim\", \"App didn't match\")\n+    }\n+\n+    @Test\n+    fun testAppInstall_usingWebWorkerDetails() {\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"See Apps for My User\"))\n+                .perform(click())\n+        // Confirm the activity\n+        intended(hasComponent(InstallFromListActivity::class.java.name))\n+\n+        // Verify that we start out in mobile user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(isDisplayed()))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(not(isDisplayed())))\n+\n+        // Toggle switch\n+        onView(withClassName(endsWith(\"Switch\")))\n+                .perform(click())\n+\n+        // Verify that we're now in web user auth mode\n+        onView(withId(R.id.edit_domain))\n+                .check(matches(not(isDisplayed())))\n+        onView(withId(R.id.edit_email))\n+                .check(matches(isDisplayed()))\n+\n+        // Test getting app list for a mobile user\n+        onView(withId(R.id.edit_email))\n+                .perform(typeText(BuildConfig.HQ_API_USERNAME))\n+        closeSoftKeyboard()\n+        onView(withId(R.id.edit_password))\n+                .perform(typeText(BuildConfig.HQ_API_PASSWORD))\n+        closeSoftKeyboard()\n+        onView(withId(R.id.get_apps_button))\n+                .perform(click())\n+\n+        // Check that we see each of the apps in this domain, plus the domain name\n+        for (position in 0 until getAppListSize()) {\n+            InstrumentationUtility.getSubViewInListItem(R.id.apps_list_view, position, R.id.domain)\n+                    .check(matches(anyOf(withText(\"commcare-tests\"), withText(\"swat\"))))\n+        }\n+\n+        matchAppInAppList(\"Case callout test for Simprints\")\n+        matchAppInAppList(\"Case Search and Claim\")\n+        matchAppInAppList(\"Demo - Form Design Patterns\")\n+        matchAppInAppList(\"Demo - Live XForm Examples\")\n+        matchAppInAppList(\"SWAT: CommCare Projects Phone Survey\")\n+        matchAppInAppList(\"SWAT: App Tracker\")\n+\n+        // Install 1 of the apps\n+        onData(allOf(`is`(instanceOf(AppAvailableToInstall::class.java)),\n+                withAppName(\"SWAT: App Tracker\")))\n+                .perform(click())\n+\n+        assert(CommCareApplication.instance().currentApp != null, \"App is null\")\n+        assert(CommCareApplication.instance().currentApp.appRecord.displayName == \"SWAT: App Tracker\", \"App didn't match\")\n+    }\n+\n+    private fun withAppName(appName: String): TypeSafeMatcher<AppAvailableToInstall> {\n+        return object: TypeSafeMatcher<AppAvailableToInstall>() {\n+            override fun describeTo(description: Description) {\n+                description.appendText(\"will match if $appName is present in the App List\")\n+            }\n+\n+            override fun matchesSafely(item: AppAvailableToInstall): Boolean {\n+                return item.appName == appName\n+            }\n+\n+        }\n+    }\n+\n+    private fun matchAppInAppList(appName: String) {\n+        onData(allOf(`is`(instanceOf(AppAvailableToInstall::class.java)),\n+                withAppName(appName)))\n+                .check(matches(isDisplayed()))\n+    }\n+\n+    private fun getAppListSize(): Int {\n+        val application = InstrumentationRegistry.getInstrumentation().targetContext.applicationContext\n+                as CommCareInstrumentationTestApplication\n+        var activity = application.currentActivity as InstallFromListActivity<*>\n+        val listView = activity.findViewById<ListView>(R.id.apps_list_view)\n+        return listView.adapter.count\n+    }\n+}\n+/**\n+ * A workaround to Failed resolution of: Lkotlin/_Assertions;\n+ * This will fail the test if the value is false.\n+ */\n+public fun assert(value: Boolean, failMsg: String) {", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA0OTA4OA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469049088", "bodyText": "I didn't realize you have swtiched to Kotlin for tests in this PR untill I saw companion \ud83d\udcaf", "author": "shubham1g5", "createdAt": "2020-08-12T07:06:49Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppUpdateTest.kt", "diffHunk": "@@ -0,0 +1,195 @@\n+package org.commcare.androidTests\n+\n+import android.content.Context\n+import android.net.wifi.WifiManager\n+import android.os.Build\n+import androidx.test.espresso.Espresso.*\n+import androidx.test.espresso.action.ViewActions.click\n+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.platform.app.InstrumentationRegistry\n+import org.commcare.dalvik.R\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Matchers.endsWith\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppUpdateTest: BaseTest() {\n+\n+    companion object {", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA1MjQ5Mg==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469052492", "bodyText": "we should have a function to go back to the home activity which just presses back until home activity", "author": "shubham1g5", "createdAt": "2020-08-12T07:13:58Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppUpdateTest.kt", "diffHunk": "@@ -0,0 +1,195 @@\n+package org.commcare.androidTests\n+\n+import android.content.Context\n+import android.net.wifi.WifiManager\n+import android.os.Build\n+import androidx.test.espresso.Espresso.*\n+import androidx.test.espresso.action.ViewActions.click\n+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.platform.app.InstrumentationRegistry\n+import org.commcare.dalvik.R\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Matchers.endsWith\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppUpdateTest: BaseTest() {\n+\n+    companion object {\n+        const val CCZ_NAME = \"app_update.ccz\"\n+        const val APP_NAME = \"Update Test\"\n+    }\n+\n+    @Before\n+    fun setup() {\n+        installApp(APP_NAME, CCZ_NAME)\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+    }\n+\n+    @Test\n+    fun testAppUpdate() {\n+        InstrumentationUtility.enableDeveloperMode()\n+        // Enable app update item.\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Settings\"))\n+                .perform(click())\n+        onView(withText(\"Developer Options\"))\n+                .perform(click())\n+        onView(withText(\"Show Update Options Item\"))\n+                .perform(click())\n+        onView(withText(\"Enabled\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // Make sure the update endpoint is set to \"Latest starred version\"\n+        onView(withText(\"Update Options\"))\n+                .perform(click())\n+        onView(withText(\"Latest starred version\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // check base form content\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Module Three\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Module One\"))\n+                .perform(click())\n+        onView(withText(\"Example 1\"))\n+                .perform(click())\n+        onView(withText(\"A text question\"))\n+                .check(matches(isDisplayed()))\n+        closeSoftKeyboard()\n+        pressBack()\n+        onView(withText(R.string.do_not_save))\n+                .perform(click())\n+        pressBack()\n+\n+        // make sure case list doesn't have status column\n+        onView(withText(\"Module Two\"))\n+                .perform(click())\n+        onView(withText(\"Update Case\"))\n+                .perform(click())\n+        onView(withText(\"Status\"))\n+                .check(doesNotExist())\n+        pressBack()", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA1Mzc2MA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469053760", "bodyText": "I see the calabsh test for this is running some rotation checks here along with a test to see if the update progress is saved when we come back to the update screen. Those are critical update behaviours that should be tested as part of this test.", "author": "shubham1g5", "createdAt": "2020-08-12T07:16:31Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppUpdateTest.kt", "diffHunk": "@@ -0,0 +1,195 @@\n+package org.commcare.androidTests\n+\n+import android.content.Context\n+import android.net.wifi.WifiManager\n+import android.os.Build\n+import androidx.test.espresso.Espresso.*\n+import androidx.test.espresso.action.ViewActions.click\n+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.platform.app.InstrumentationRegistry\n+import org.commcare.dalvik.R\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Matchers.endsWith\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppUpdateTest: BaseTest() {\n+\n+    companion object {\n+        const val CCZ_NAME = \"app_update.ccz\"\n+        const val APP_NAME = \"Update Test\"\n+    }\n+\n+    @Before\n+    fun setup() {\n+        installApp(APP_NAME, CCZ_NAME)\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+    }\n+\n+    @Test\n+    fun testAppUpdate() {\n+        InstrumentationUtility.enableDeveloperMode()\n+        // Enable app update item.\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Settings\"))\n+                .perform(click())\n+        onView(withText(\"Developer Options\"))\n+                .perform(click())\n+        onView(withText(\"Show Update Options Item\"))\n+                .perform(click())\n+        onView(withText(\"Enabled\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // Make sure the update endpoint is set to \"Latest starred version\"\n+        onView(withText(\"Update Options\"))\n+                .perform(click())\n+        onView(withText(\"Latest starred version\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // check base form content\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Module Three\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Module One\"))\n+                .perform(click())\n+        onView(withText(\"Example 1\"))\n+                .perform(click())\n+        onView(withText(\"A text question\"))\n+                .check(matches(isDisplayed()))\n+        closeSoftKeyboard()\n+        pressBack()\n+        onView(withText(R.string.do_not_save))\n+                .perform(click())\n+        pressBack()\n+\n+        // make sure case list doesn't have status column\n+        onView(withText(\"Module Two\"))\n+                .perform(click())\n+        onView(withText(\"Update Case\"))\n+                .perform(click())\n+        onView(withText(\"Status\"))\n+                .check(doesNotExist())\n+        pressBack()\n+        pressBack()\n+        pressBack()\n+\n+        // download the app update\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Update App\"))\n+                .perform(click())\n+        onView(withText(\"Current version: 2\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Update to version 11 & log out\"))", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM1MTkwMw==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r471351903", "bodyText": "Ahh okay. One of the reasons I didn't do it is because espresso doesn't support rotating devices. I'll use uiautomator to rotate the device.", "author": "ShivamPokhriyal", "createdAt": "2020-08-17T09:22:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA1Mzc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk4ODI2OA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r472988268", "bodyText": "@shubham1g5 I came back to this today, and I guess you're hinting at stopping the update in between.\nAnd I don't think it's possible to click on the stop button(since espresso is gonna wait for the update to finish before doing any operation) \ud83d\ude05\nI'll try to do it using internal commcare methods maybe, but yeah just an FYI.", "author": "ShivamPokhriyal", "createdAt": "2020-08-19T12:24:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA1Mzc2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5NjYxMw==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r472996613", "bodyText": "Interestingly, I never removed this stuff \ud83e\udd23 \n  \n    \n      commcare-android/app/instrumentation-tests/AndroidManifest.xml\n    \n    \n         Line 6\n      in\n      ce581c3\n    \n    \n    \n    \n\n        \n          \n           <uses-sdk tools:overrideLibrary=\"android_libs.ub_uiautomator\"/>", "author": "ShivamPokhriyal", "createdAt": "2020-08-19T12:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA1Mzc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA1Njc2OA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469056768", "bodyText": "should be implemented.", "author": "shubham1g5", "createdAt": "2020-08-12T07:22:23Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppUpdateTest.kt", "diffHunk": "@@ -0,0 +1,195 @@\n+package org.commcare.androidTests\n+\n+import android.content.Context\n+import android.net.wifi.WifiManager\n+import android.os.Build\n+import androidx.test.espresso.Espresso.*\n+import androidx.test.espresso.action.ViewActions.click\n+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.platform.app.InstrumentationRegistry\n+import org.commcare.dalvik.R\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Matchers.endsWith\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppUpdateTest: BaseTest() {\n+\n+    companion object {\n+        const val CCZ_NAME = \"app_update.ccz\"\n+        const val APP_NAME = \"Update Test\"\n+    }\n+\n+    @Before\n+    fun setup() {\n+        installApp(APP_NAME, CCZ_NAME)\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+    }\n+\n+    @Test\n+    fun testAppUpdate() {\n+        InstrumentationUtility.enableDeveloperMode()\n+        // Enable app update item.\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Settings\"))\n+                .perform(click())\n+        onView(withText(\"Developer Options\"))\n+                .perform(click())\n+        onView(withText(\"Show Update Options Item\"))\n+                .perform(click())\n+        onView(withText(\"Enabled\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // Make sure the update endpoint is set to \"Latest starred version\"\n+        onView(withText(\"Update Options\"))\n+                .perform(click())\n+        onView(withText(\"Latest starred version\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // check base form content\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Module Three\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Module One\"))\n+                .perform(click())\n+        onView(withText(\"Example 1\"))\n+                .perform(click())\n+        onView(withText(\"A text question\"))\n+                .check(matches(isDisplayed()))\n+        closeSoftKeyboard()\n+        pressBack()\n+        onView(withText(R.string.do_not_save))\n+                .perform(click())\n+        pressBack()\n+\n+        // make sure case list doesn't have status column\n+        onView(withText(\"Module Two\"))\n+                .perform(click())\n+        onView(withText(\"Update Case\"))\n+                .perform(click())\n+        onView(withText(\"Status\"))\n+                .check(doesNotExist())\n+        pressBack()\n+        pressBack()\n+        pressBack()\n+\n+        // download the app update\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Update App\"))\n+                .perform(click())\n+        onView(withText(\"Current version: 2\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Update to version 11 & log out\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Update to version 11 & log out\"))\n+                .perform(click())\n+\n+        // Login into the updated version\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+\n+        //TODO check that a sync is triggered automatically", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA1OTI5Mg==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469059292", "bodyText": "are there other espresso APIs that let you turn on and off internet, our end goal here is to be able to simulate internet on and off on the device.", "author": "shubham1g5", "createdAt": "2020-08-12T07:27:21Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppUpdateTest.kt", "diffHunk": "@@ -0,0 +1,195 @@\n+package org.commcare.androidTests\n+\n+import android.content.Context\n+import android.net.wifi.WifiManager\n+import android.os.Build\n+import androidx.test.espresso.Espresso.*\n+import androidx.test.espresso.action.ViewActions.click\n+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.platform.app.InstrumentationRegistry\n+import org.commcare.dalvik.R\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Matchers.endsWith\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppUpdateTest: BaseTest() {\n+\n+    companion object {\n+        const val CCZ_NAME = \"app_update.ccz\"\n+        const val APP_NAME = \"Update Test\"\n+    }\n+\n+    @Before\n+    fun setup() {\n+        installApp(APP_NAME, CCZ_NAME)\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+    }\n+\n+    @Test\n+    fun testAppUpdate() {\n+        InstrumentationUtility.enableDeveloperMode()\n+        // Enable app update item.\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Settings\"))\n+                .perform(click())\n+        onView(withText(\"Developer Options\"))\n+                .perform(click())\n+        onView(withText(\"Show Update Options Item\"))\n+                .perform(click())\n+        onView(withText(\"Enabled\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // Make sure the update endpoint is set to \"Latest starred version\"\n+        onView(withText(\"Update Options\"))\n+                .perform(click())\n+        onView(withText(\"Latest starred version\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // check base form content\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Module Three\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Module One\"))\n+                .perform(click())\n+        onView(withText(\"Example 1\"))\n+                .perform(click())\n+        onView(withText(\"A text question\"))\n+                .check(matches(isDisplayed()))\n+        closeSoftKeyboard()\n+        pressBack()\n+        onView(withText(R.string.do_not_save))\n+                .perform(click())\n+        pressBack()\n+\n+        // make sure case list doesn't have status column\n+        onView(withText(\"Module Two\"))\n+                .perform(click())\n+        onView(withText(\"Update Case\"))\n+                .perform(click())\n+        onView(withText(\"Status\"))\n+                .check(doesNotExist())\n+        pressBack()\n+        pressBack()\n+        pressBack()\n+\n+        // download the app update\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Update App\"))\n+                .perform(click())\n+        onView(withText(\"Current version: 2\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Update to version 11 & log out\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Update to version 11 & log out\"))\n+                .perform(click())\n+\n+        // Login into the updated version\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+\n+        //TODO check that a sync is triggered automatically\n+\n+        // Check updated data, including multimedia\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Module Three\"))\n+                .check(doesNotExist())\n+        onView(withText(\"Module One\"))\n+                .perform(click())\n+        onView(withText(\"Example 1\"))\n+                .perform(click())\n+        onView(withText(\"Question with audio\"))\n+                .check(matches(isDisplayed()))\n+        onView(withClassName(endsWith(\"AudioPlaybackButton\")))\n+                .check(matches(isDisplayed()))\n+        closeSoftKeyboard()\n+        pressBack()\n+        onView(withText(R.string.do_not_save))\n+                .perform(click())\n+        pressBack()\n+\n+        // make sure case list `Status` column was added\n+        onView(withText(\"Module Two\"))\n+                .perform(click())\n+        onView(withText(\"Update Case\"))\n+                .perform(click())\n+        onView(withText(\"Status\"))\n+                .check(matches(isDisplayed()))\n+        pressBack()\n+        pressBack()\n+        pressBack()\n+\n+        // make sure there are no new updates\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Update App\"))\n+                .perform(click())\n+        onView(withText(\"Current version: 11\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Recheck\"))\n+                .perform(click())\n+        onView(withText(\"Current version: 11\"))\n+                .check(matches(isDisplayed()))\n+        pressBack()\n+\n+        // Change the update endpoint to \"Latest version\"\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Settings\"))\n+                .perform(click())\n+        onView(withText(\"Update Options\"))\n+                .perform(click())\n+        onView(withText(\"Latest version\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // Confirm that you can now see an update. And Update the app.\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Update App\"))\n+                .perform(click())\n+        onView(withText(\"Update to version 22 & log out\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Update to version 22 & log out\"))\n+                .perform(click())\n+\n+        // Login again\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+        //TODO Check that sync is triggered automatically\n+\n+        // Check updates in base form\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Module One, renamed\"))\n+                .check(matches(isDisplayed()))\n+        pressBack()\n+\n+        // The below tests will only work on a pre-android Q device.\n+        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.Q) {\n+            changeWifi(false)\n+            InstrumentationUtility.openOptionsMenu()\n+            onView(withText(\"Update App\"))\n+                    .perform(click())\n+            onView(withText(\"No network connectivity\"))\n+                    .perform(click())\n+            changeWifi(true)\n+        }\n+    }\n+\n+    /**\n+     * Starting with Android Q, applications are not allowed to enable/disable Wi-Fi.", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM1MjI2NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r471352265", "bodyText": "I don't think there is such an API in espresso.", "author": "ShivamPokhriyal", "createdAt": "2020-08-17T09:23:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA1OTI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA1OTU1Ng==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469059556", "bodyText": "should move to a util class.", "author": "shubham1g5", "createdAt": "2020-08-12T07:27:52Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppUpdateTest.kt", "diffHunk": "@@ -0,0 +1,195 @@\n+package org.commcare.androidTests\n+\n+import android.content.Context\n+import android.net.wifi.WifiManager\n+import android.os.Build\n+import androidx.test.espresso.Espresso.*\n+import androidx.test.espresso.action.ViewActions.click\n+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.platform.app.InstrumentationRegistry\n+import org.commcare.dalvik.R\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Matchers.endsWith\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppUpdateTest: BaseTest() {\n+\n+    companion object {\n+        const val CCZ_NAME = \"app_update.ccz\"\n+        const val APP_NAME = \"Update Test\"\n+    }\n+\n+    @Before\n+    fun setup() {\n+        installApp(APP_NAME, CCZ_NAME)\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+    }\n+\n+    @Test\n+    fun testAppUpdate() {\n+        InstrumentationUtility.enableDeveloperMode()\n+        // Enable app update item.\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Settings\"))\n+                .perform(click())\n+        onView(withText(\"Developer Options\"))\n+                .perform(click())\n+        onView(withText(\"Show Update Options Item\"))\n+                .perform(click())\n+        onView(withText(\"Enabled\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // Make sure the update endpoint is set to \"Latest starred version\"\n+        onView(withText(\"Update Options\"))\n+                .perform(click())\n+        onView(withText(\"Latest starred version\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // check base form content\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Module Three\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Module One\"))\n+                .perform(click())\n+        onView(withText(\"Example 1\"))\n+                .perform(click())\n+        onView(withText(\"A text question\"))\n+                .check(matches(isDisplayed()))\n+        closeSoftKeyboard()\n+        pressBack()\n+        onView(withText(R.string.do_not_save))\n+                .perform(click())\n+        pressBack()\n+\n+        // make sure case list doesn't have status column\n+        onView(withText(\"Module Two\"))\n+                .perform(click())\n+        onView(withText(\"Update Case\"))\n+                .perform(click())\n+        onView(withText(\"Status\"))\n+                .check(doesNotExist())\n+        pressBack()\n+        pressBack()\n+        pressBack()\n+\n+        // download the app update\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Update App\"))\n+                .perform(click())\n+        onView(withText(\"Current version: 2\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Update to version 11 & log out\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Update to version 11 & log out\"))\n+                .perform(click())\n+\n+        // Login into the updated version\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+\n+        //TODO check that a sync is triggered automatically\n+\n+        // Check updated data, including multimedia\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Module Three\"))\n+                .check(doesNotExist())\n+        onView(withText(\"Module One\"))\n+                .perform(click())\n+        onView(withText(\"Example 1\"))\n+                .perform(click())\n+        onView(withText(\"Question with audio\"))\n+                .check(matches(isDisplayed()))\n+        onView(withClassName(endsWith(\"AudioPlaybackButton\")))\n+                .check(matches(isDisplayed()))\n+        closeSoftKeyboard()\n+        pressBack()\n+        onView(withText(R.string.do_not_save))\n+                .perform(click())\n+        pressBack()\n+\n+        // make sure case list `Status` column was added\n+        onView(withText(\"Module Two\"))\n+                .perform(click())\n+        onView(withText(\"Update Case\"))\n+                .perform(click())\n+        onView(withText(\"Status\"))\n+                .check(matches(isDisplayed()))\n+        pressBack()\n+        pressBack()\n+        pressBack()\n+\n+        // make sure there are no new updates\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Update App\"))\n+                .perform(click())\n+        onView(withText(\"Current version: 11\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Recheck\"))\n+                .perform(click())\n+        onView(withText(\"Current version: 11\"))\n+                .check(matches(isDisplayed()))\n+        pressBack()\n+\n+        // Change the update endpoint to \"Latest version\"\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Settings\"))\n+                .perform(click())\n+        onView(withText(\"Update Options\"))\n+                .perform(click())\n+        onView(withText(\"Latest version\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // Confirm that you can now see an update. And Update the app.\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Update App\"))\n+                .perform(click())\n+        onView(withText(\"Update to version 22 & log out\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Update to version 22 & log out\"))\n+                .perform(click())\n+\n+        // Login again\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+        //TODO Check that sync is triggered automatically\n+\n+        // Check updates in base form\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Module One, renamed\"))\n+                .check(matches(isDisplayed()))\n+        pressBack()\n+\n+        // The below tests will only work on a pre-android Q device.\n+        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.Q) {\n+            changeWifi(false)\n+            InstrumentationUtility.openOptionsMenu()\n+            onView(withText(\"Update App\"))\n+                    .perform(click())\n+            onView(withText(\"No network connectivity\"))\n+                    .perform(click())\n+            changeWifi(true)\n+        }\n+    }\n+\n+    /**\n+     * Starting with Android Q, applications are not allowed to enable/disable Wi-Fi.\n+     */\n+    private fun changeWifi(enable: Boolean) {", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA2MDM5Ng==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469060396", "bodyText": "An @After should not be called setup. You can use tearDown instead as the method name.", "author": "shubham1g5", "createdAt": "2020-08-12T07:29:31Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppInstallationTest.kt", "diffHunk": "@@ -0,0 +1,199 @@\n+package org.commcare.androidTests\n+\n+import android.widget.ListView\n+import androidx.test.espresso.Espresso.closeSoftKeyboard\n+import androidx.test.espresso.Espresso.onView\n+import androidx.test.espresso.Espresso.onData\n+import androidx.test.espresso.action.ViewActions.*\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.intent.Intents.intended\n+import androidx.test.espresso.intent.matcher.IntentMatchers.hasComponent\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.platform.app.InstrumentationRegistry\n+import junit.framework.Assert.fail\n+import org.commcare.CommCareApplication\n+import org.commcare.CommCareInstrumentationTestApplication\n+import org.commcare.activities.InstallFromListActivity\n+import org.commcare.android.database.global.models.AppAvailableToInstall\n+import org.commcare.dalvik.BuildConfig\n+import org.commcare.dalvik.R\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Description\n+import org.hamcrest.Matchers.*\n+import org.hamcrest.TypeSafeMatcher\n+import org.junit.After\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppInstallationTest: BaseTest() {\n+\n+    @After\n+    fun setup() {", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTA4MDMwMg==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r469080302", "bodyText": "nit: we should abstract these matcher functions into their own class.", "author": "shubham1g5", "createdAt": "2020-08-12T08:06:30Z", "path": "app/instrumentation-tests/src/org/commcare/utils/InstrumentationUtility.java", "diffHunk": "@@ -211,6 +234,80 @@ public void describeTo(Description description) {\n         };\n     }\n \n+    /**\n+     * Matches the listView item count with the @param size\n+     * Note: Only works for listview.\n+     */\n+    public static Matcher<View> matchListSize(int size) {", "originalCommit": "26deba4928cda04c911f0a9ae5e5caba6ac13d40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "afd02a0aa163534a1643c44dc923415e5801e021", "url": "https://github.com/dimagi/commcare-android/commit/afd02a0aa163534a1643c44dc923415e5801e021", "message": "Add tests for form submission errors", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "b088fe79ea5d76a5a16049d46ace4f54f141206d", "url": "https://github.com/dimagi/commcare-android/commit/b088fe79ea5d76a5a16049d46ace4f54f141206d", "message": "Add tests for app update", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "c283f3f4eca5a63f8ddea523bdaabbc0bc3a51c3", "url": "https://github.com/dimagi/commcare-android/commit/c283f3f4eca5a63f8ddea523bdaabbc0bc3a51c3", "message": "Add tests for app installation using app list", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "a39bc90f7056d099715ce05935b1e5782e722c10", "url": "https://github.com/dimagi/commcare-android/commit/a39bc90f7056d099715ce05935b1e5782e722c10", "message": "Enable network logging in browserstack", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "598e5fb63c36c5cb6a2a40ffde74860ef786c3bd", "url": "https://github.com/dimagi/commcare-android/commit/598e5fb63c36c5cb6a2a40ffde74860ef786c3bd", "message": "Get current activity from test application", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "f6644830726c833c12485b0977330cd5cdd8da2e", "url": "https://github.com/dimagi/commcare-android/commit/f6644830726c833c12485b0977330cd5cdd8da2e", "message": "Remove assertion", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "23918cb4741f32c095354f87c28813f23073e296", "url": "https://github.com/dimagi/commcare-android/commit/23918cb4741f32c095354f87c28813f23073e296", "message": "Workaround for kotlin.assert method not found", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "fb840bf98426123c74d69f780eb39217b47ee7d3", "url": "https://github.com/dimagi/commcare-android/commit/fb840bf98426123c74d69f780eb39217b47ee7d3", "message": "Add tests for lookup table sync", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "f97a1daec88862a640e3ab0d65831ef7dc4bd855", "url": "https://github.com/dimagi/commcare-android/commit/f97a1daec88862a640e3ab0d65831ef7dc4bd855", "message": "Add tests for Sync Recovery", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "faf3f426277eb65e1d843f6f6111038867dc6db1", "url": "https://github.com/dimagi/commcare-android/commit/faf3f426277eb65e1d843f6f6111038867dc6db1", "message": "Use sendBroadcastSync in asyncRestore tests", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "c0baec916e2ba4c33a0fc0bf5cb8dec6f9a56f2a", "url": "https://github.com/dimagi/commcare-android/commit/c0baec916e2ba4c33a0fc0bf5cb8dec6f9a56f2a", "message": "Add proguard rule for sendBroadcastSync", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "005ed46a496f15e5adf242867c173420646887e2", "url": "https://github.com/dimagi/commcare-android/commit/005ed46a496f15e5adf242867c173420646887e2", "message": "Use custom assert method", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "4fa9bde15b4c13252ff605f8c04395f1dbd6646a", "url": "https://github.com/dimagi/commcare-android/commit/4fa9bde15b4c13252ff605f8c04395f1dbd6646a", "message": "Add suggested changes", "committedDate": "2020-08-19T09:36:38Z", "type": "commit"}, {"oid": "7e1430a332ba710f9d88f90c77880852e4b80e65", "url": "https://github.com/dimagi/commcare-android/commit/7e1430a332ba710f9d88f90c77880852e4b80e65", "message": "Add more suggested changes", "committedDate": "2020-08-21T13:57:33Z", "type": "commit"}, {"oid": "7e1430a332ba710f9d88f90c77880852e4b80e65", "url": "https://github.com/dimagi/commcare-android/commit/7e1430a332ba710f9d88f90c77880852e4b80e65", "message": "Add more suggested changes", "committedDate": "2020-08-21T13:57:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1NzIwNA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475057204", "bodyText": "Can't we use SyncDetailCalculations.getLastSyncTime directly ?", "author": "shubham1g5", "createdAt": "2020-08-22T07:10:07Z", "path": "app/instrumentation-tests/src/org/commcare/CommCareInstrumentationTestApplication.java", "diffHunk": "@@ -64,6 +65,11 @@ public void onActivityDestroyed(@NonNull Activity activity) {\n     public Activity getCurrentActivity() {\n         return currentActivity;\n     }\n-    \n \n+    public static long getLastSyncTime(String userName) {", "originalCommit": "7e1430a332ba710f9d88f90c77880852e4b80e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2MDE1Ng==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475060156", "bodyText": "Nice, Didn't know it existed.", "author": "ShivamPokhriyal", "createdAt": "2020-08-22T07:47:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1NzIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1NzUxOA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475057518", "bodyText": "the sdk check should go inside the method changeWifi itself.", "author": "shubham1g5", "createdAt": "2020-08-22T07:14:04Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppUpdateTest.kt", "diffHunk": "@@ -0,0 +1,209 @@\n+package org.commcare.androidTests\n+\n+import android.os.Build\n+import androidx.test.espresso.Espresso.*\n+import androidx.test.espresso.action.ViewActions.click\n+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import org.commcare.CommCareInstrumentationTestApplication\n+import org.commcare.dalvik.R\n+import org.commcare.utils.*\n+import org.hamcrest.Matchers.endsWith\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppUpdateTest: BaseTest() {\n+\n+    companion object {\n+        const val CCZ_NAME = \"app_update.ccz\"\n+        const val APP_NAME = \"Update Test\"\n+        const val USERNAME = \"user_with_no_data\"\n+        const val PASSWORD = \"123\"\n+    }\n+\n+    @Before\n+    fun setup() {\n+        installApp(APP_NAME, CCZ_NAME)\n+        InstrumentationUtility.login(USERNAME, PASSWORD)\n+    }\n+\n+    @Test\n+    fun testAppUpdate() {\n+        InstrumentationUtility.enableDeveloperMode()\n+        // Enable app update item.\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Settings\"))\n+                .perform(click())\n+        onView(withText(\"Developer Options\"))\n+                .perform(click())\n+        onView(withText(\"Show Update Options Item\"))\n+                .perform(click())\n+        onView(withText(\"Enabled\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // Make sure the update endpoint is set to \"Latest starred version\"\n+        onView(withText(\"Update Options\"))\n+                .perform(click())\n+        onView(withText(\"Latest starred version\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // check base form content\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Module Three\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Module One\"))\n+                .perform(click())\n+        onView(withText(\"Example 1\"))\n+                .perform(click())\n+        onView(withText(\"A text question\"))\n+                .check(matches(isDisplayed()))\n+        closeSoftKeyboard()\n+        pressBack()\n+        onView(withText(R.string.do_not_save))\n+                .perform(click())\n+        pressBack()\n+\n+        // make sure case list doesn't have status column\n+        onView(withText(\"Module Two\"))\n+                .perform(click())\n+        onView(withText(\"Update Case\"))\n+                .perform(click())\n+        onView(withText(\"Status\"))\n+                .check(doesNotExist())\n+        gotoHome()\n+\n+        // download the app update\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Update App\"))\n+                .perform(click())\n+        onView(withText(\"Current version: 2\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Update to version 11 & log out\"))\n+                .check(matches(isDisplayed()))\n+        // Disable Wifi and make sure update is saved.\n+        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.Q) {", "originalCommit": "7e1430a332ba710f9d88f90c77880852e4b80e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA5ODAxOQ==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475098019", "bodyText": "Ohh, Actually, I need to put the check here as well, cuz the below assertion,\nonView(withText(\"No network connectivity\"))\n                    .perform(click())\n\nWould only work when the wifi is actually disabled. Otherwise it'd fail the test.\nThough still adding the check inside changeWifi method.", "author": "ShivamPokhriyal", "createdAt": "2020-08-22T14:47:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1NzUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIxNTkyNA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475215924", "bodyText": "since the test is anyway going to fail, it's better that we fail explicitly from inside of the changeWifi. We don't want to pass the test if these tests run on devices >=10, instead we should make sure that these tests don't run on these devices at all.", "author": "shubham1g5", "createdAt": "2020-08-23T12:51:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1NzUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIxNzI4Mw==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475217283", "bodyText": "Ahh well going slightly back on this. I think the right behaviour for us here is to 1. decouple the functionality we are testing (in this case \"persistency of the update state\") that depends on the changeWifi into a separate test so that we can still test all other update functionality on > 10 devices  2. Annotate the new test with something like sdk < 10 which makes the > 10 devices skips this test automatically (not sure if Instrumentaion tests support this annotation but unit tests does and would be a good thing to explore for us).", "author": "shubham1g5", "createdAt": "2020-08-23T13:05:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1NzUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIxNzUzOQ==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475217539", "bodyText": "since the test is anyway going to fail,\n\nThe test isn't gonna fail, unless we remove the if here.\nAlso, I'm not really sure if we should fail the test just because of this limitation, when the thing we're testing is so trivial.", "author": "ShivamPokhriyal", "createdAt": "2020-08-23T13:08:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1NzUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIxNzk1NA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475217954", "bodyText": "which makes the > 10 devices skips this test automatically\n\nThis sounds better. Will check on how to do this.", "author": "ShivamPokhriyal", "createdAt": "2020-08-23T13:12:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1NzUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODE0Mw==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475058143", "bodyText": "what's the difference between InstrumentationHelpers and InstrumentationUtility ?", "author": "shubham1g5", "createdAt": "2020-08-22T07:22:09Z", "path": "app/instrumentation-tests/src/org/commcare/utils/InstrumentationHelpers.kt", "diffHunk": "@@ -0,0 +1,30 @@\n+package org.commcare.utils", "originalCommit": "7e1430a332ba710f9d88f90c77880852e4b80e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2MDI0NA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475060244", "bodyText": "Not much, InstrumentationUtility is in java, and It seemed like the kotlin extensions don't really work in java(it showed compile error to me) Espresso.onView(ViewMatchers.withId(R.id.home_gridview_buttons)).isPresent() isPresent() is an extension here.", "author": "ShivamPokhriyal", "createdAt": "2020-08-22T07:49:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODE0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIxNTE1Mw==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475215153", "bodyText": "It's a bit confusing to have 2 different classes for same purpose. I think we should merge the 2 classes by either migrating the InstrumentationUtility to kotlin or InstrumentationHelpers to java.", "author": "shubham1g5", "createdAt": "2020-08-23T12:44:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODE0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIxNzU2NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475217565", "bodyText": "Gotcha, will move to kotlin", "author": "ShivamPokhriyal", "createdAt": "2020-08-23T13:08:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODE0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODIyOA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475058228", "bodyText": "does this method throw an exception if it's called on api >= Q", "author": "shubham1g5", "createdAt": "2020-08-22T07:23:26Z", "path": "app/instrumentation-tests/src/org/commcare/utils/InstrumentationUtility.java", "diffHunk": "@@ -188,27 +215,59 @@ public void perform(UiController uiController, final View view) {\n     }\n \n     /**\n-     * In case a view contains more than 1 items of same type,\n-     * use this to select the item at @param position.\n-     * NOTE:- position is 1 based.\n+     * Matches total occurrences of child inside parent with count.\n      */\n-    public static <T> Matcher<T> find(Matcher<T> matcher, int position) {\n-        return new BaseMatcher<T>() {\n-            int count = 0;\n-            @Override\n-            public boolean matches(Object item) {\n-                if (matcher.matches(item)) {\n-                    count++;\n-                    return count == position;\n-                }\n-                return false;\n-            }\n+    public static void matchChildCount(Class<?> parent, Class<?> child, int count) {\n+        onView(withClassName(is(parent.getCanonicalName())))\n+                .check(matches(\n+                        CustomMatchers.withChildViewCount(count,\n+                                withClassName(is(child.getCanonicalName())))\n+                ));\n+    }\n \n-            @Override\n-            public void describeTo(Description description) {\n-                description.appendText(\"will return \" + position + \" matching item\");\n-            }\n-        };\n+    /**\n+     * Returns the count of total number of items present in the listView.\n+     * @param resId Resource reference to the list.\n+     */\n+    public static int getListSize(@IdRes int resId) {\n+        CommCareInstrumentationTestApplication application =\n+                (CommCareInstrumentationTestApplication) InstrumentationRegistry\n+                        .getInstrumentation()\n+                        .getTargetContext()\n+                        .getApplicationContext();\n+        Activity activity = application.getCurrentActivity();\n+        ListView listView = activity.findViewById(resId);\n+        return listView.getAdapter().getCount();\n+    }\n+\n+    /**\n+     * This method will toggle the wifi state in mobile.\n+     * Starting with Android Q, applications are not allowed to enable/disable Wi-Fi.\n+     */\n+    public static void changeWifi(boolean enable) {", "originalCommit": "7e1430a332ba710f9d88f90c77880852e4b80e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2MDM4MQ==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475060381", "bodyText": "Not sure, perhaps it doesn't give an exception(at least that's what the docs seems to hint).", "author": "ShivamPokhriyal", "createdAt": "2020-08-22T07:50:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODIyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIxNTM4OQ==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475215389", "bodyText": "I see, we should throw an error ourselves in that case so that we fail clearly and explicitly and avoid future confusions in case someone decides to run these tests on > Q device.", "author": "shubham1g5", "createdAt": "2020-08-23T12:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODIyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODQ5Mg==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475058492", "bodyText": "is there no api to check for the current activity in espresso ?", "author": "shubham1g5", "createdAt": "2020-08-22T07:26:30Z", "path": "app/instrumentation-tests/src/org/commcare/utils/InstrumentationHelpers.kt", "diffHunk": "@@ -0,0 +1,30 @@\n+package org.commcare.utils\n+\n+import androidx.test.espresso.Espresso\n+import androidx.test.espresso.matcher.ViewMatchers\n+import junit.framework.Assert\n+import org.commcare.dalvik.R\n+\n+\n+/**\n+ * A workaround to Failed resolution of: Lkotlin/_Assertions;\n+ * This will fail the test if the value is false.\n+ */\n+fun assert(value: Boolean, failMsg: String) {\n+    if (!value) {\n+        Assert.fail(\"Assertion Failed: $failMsg\")\n+    }\n+}\n+\n+/**\n+ * A utility to pressBack until Home screen is reached at most 6 times.\n+ */\n+fun gotoHome() {\n+    for (i in 0..5) { // Try atmost 6 times.\n+        if (Espresso.onView(ViewMatchers.withId(R.id.home_gridview_buttons)).isPresent()) {", "originalCommit": "7e1430a332ba710f9d88f90c77880852e4b80e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2MDQ0NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475060445", "bodyText": "Yeah intended api can be used here.", "author": "ShivamPokhriyal", "createdAt": "2020-08-22T07:51:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODQ5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA5OTk3OA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475099978", "bodyText": "Ohh, I was wrong here, intended can't be used cuz it merely checks whether the activity is present in the list of recorded intents(kinda think of it as activity stack).", "author": "ShivamPokhriyal", "createdAt": "2020-08-22T15:11:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODQ5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIxNDc3Ng==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475214776", "bodyText": "I see, thanks for looking.", "author": "shubham1g5", "createdAt": "2020-08-23T12:41:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODQ5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODc2NA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475058764", "bodyText": "is there an outcome that onView().check(matches(isDisplayed())) doesn't serve because of which we need this ?", "author": "shubham1g5", "createdAt": "2020-08-22T07:30:05Z", "path": "app/instrumentation-tests/src/org/commcare/utils/ViewInteraction+Extension.kt", "diffHunk": "@@ -0,0 +1,20 @@\n+package org.commcare.utils\n+\n+import androidx.test.espresso.NoMatchingViewException\n+import androidx.test.espresso.ViewInteraction\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.matcher.ViewMatchers.isDisplayed\n+\n+/**\n+ * A utility view interaction to check whether a view is present in the screen or not.\n+ * Espresso APIs are designed away from conditional logic by only allowing test actions and assertions.\n+ * So it's kinda against what espresso tells you to do.\n+ */\n+fun ViewInteraction.isPresent(): Boolean {", "originalCommit": "7e1430a332ba710f9d88f90c77880852e4b80e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2MDYwOA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475060608", "bodyText": "So the espresso APIs would only allow you to do some action or assertion and they'd fail the test if the action or assertion can't be performed.\nonView().check(matches(isDisplayed())) is used to assert that the view is actually displayed and it would throw an exception and fail the test if the view isn't displayed. This isPresent method here is used to check whether or not a view is displayed and simply returns a boolean without failing or throwing any exception. These conditional logics are not present in espresso.", "author": "ShivamPokhriyal", "createdAt": "2020-08-22T07:54:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODc2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIxNjM4OQ==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475216389", "bodyText": "Ahh I see, that makes a ton on sense. I think having the comment just say that this method is same as onView().check(matches(isDisplayed())) but doesn't throw an exception would much more clearly convey the need of this function.", "author": "shubham1g5", "createdAt": "2020-08-23T12:56:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODc2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIxODAyOQ==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475218029", "bodyText": "Sounds good. will amend the comment.", "author": "ShivamPokhriyal", "createdAt": "2020-08-23T13:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODc2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODk0OA==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r475058948", "bodyText": "can you elaborate on what conditional logic are you referring to here ?", "author": "shubham1g5", "createdAt": "2020-08-22T07:32:37Z", "path": "app/instrumentation-tests/src/org/commcare/utils/ViewInteraction+Extension.kt", "diffHunk": "@@ -0,0 +1,20 @@\n+package org.commcare.utils\n+\n+import androidx.test.espresso.NoMatchingViewException\n+import androidx.test.espresso.ViewInteraction\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.matcher.ViewMatchers.isDisplayed\n+\n+/**\n+ * A utility view interaction to check whether a view is present in the screen or not.\n+ * Espresso APIs are designed away from conditional logic by only allowing test actions and assertions.", "originalCommit": "7e1430a332ba710f9d88f90c77880852e4b80e65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ead53ca41a35a2c22cb824d1a21f92409a235b34", "url": "https://github.com/dimagi/commcare-android/commit/ead53ca41a35a2c22cb824d1a21f92409a235b34", "message": "Fix import of package level function", "committedDate": "2020-08-22T11:52:05Z", "type": "commit"}, {"oid": "3b66bc54a68239ae380da2a14bf1f1ebb7eac109", "url": "https://github.com/dimagi/commcare-android/commit/3b66bc54a68239ae380da2a14bf1f1ebb7eac109", "message": "Fix InstallFromListTest and Use getLastSyncTime directly", "committedDate": "2020-08-22T15:13:46Z", "type": "commit"}, {"oid": "e4e13e7bb02b7dae5b85453a230c8bdb01f14fa5", "url": "https://github.com/dimagi/commcare-android/commit/e4e13e7bb02b7dae5b85453a230c8bdb01f14fa5", "message": "Convert InstrumentationUtility to kotlin", "committedDate": "2020-08-23T14:52:52Z", "type": "commit"}, {"oid": "26a68d8118e0498faf3d6aba1bf011b3f1234fff", "url": "https://github.com/dimagi/commcare-android/commit/26a68d8118e0498faf3d6aba1bf011b3f1234fff", "message": "Decouple app update persistence test", "committedDate": "2020-08-24T07:32:41Z", "type": "commit"}, {"oid": "2d132ebf0bd63dd3136e07897bbfbc502d4ebcba", "url": "https://github.com/dimagi/commcare-android/commit/2d132ebf0bd63dd3136e07897bbfbc502d4ebcba", "message": "Fix InstallFromListTest", "committedDate": "2020-08-24T07:56:49Z", "type": "commit"}, {"oid": "342bbc38d797c0e99f55534a2f6685e49c63843d", "url": "https://github.com/dimagi/commcare-android/commit/342bbc38d797c0e99f55534a2f6685e49c63843d", "message": "Merge branch 'master' into espresso-tests", "committedDate": "2020-08-25T04:41:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1ODcyNw==", "url": "https://github.com/dimagi/commcare-android/pull/2299#discussion_r476358727", "bodyText": "nice!", "author": "shubham1g5", "createdAt": "2020-08-25T10:55:07Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/AppUpdateTest.kt", "diffHunk": "@@ -0,0 +1,236 @@\n+package org.commcare.androidTests\n+\n+import android.os.Build\n+import androidx.test.espresso.Espresso.*\n+import androidx.test.espresso.action.ViewActions.click\n+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import androidx.test.filters.SdkSuppress\n+import org.commcare.dalvik.R\n+import org.commcare.utils.*\n+import org.hamcrest.Matchers.endsWith\n+import org.junit.After\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class AppUpdateTest: BaseTest() {\n+\n+    companion object {\n+        const val CCZ_NAME = \"app_update.ccz\"\n+        const val APP_NAME = \"Update Test\"\n+        const val USERNAME = \"user_with_no_data\"\n+        const val PASSWORD = \"123\"\n+    }\n+\n+    @Before\n+    fun setup() {\n+        installApp(APP_NAME, CCZ_NAME)\n+        InstrumentationUtility.login(USERNAME, PASSWORD)\n+    }\n+\n+    @After\n+    fun tearDown() {\n+        InstrumentationUtility.logout()\n+        InstrumentationUtility.uninstallCurrentApp()\n+    }\n+\n+    @Test\n+    fun testAppUpdate() {\n+        InstrumentationUtility.enableDeveloperMode()\n+        // Enable app update item.\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Settings\"))\n+                .perform(click())\n+        onView(withText(\"Developer Options\"))\n+                .perform(click())\n+        onView(withText(\"Show Update Options Item\"))\n+                .perform(click())\n+        onView(withText(\"Enabled\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // Make sure the update endpoint is set to \"Latest starred version\"\n+        onView(withText(\"Update Options\"))\n+                .perform(click())\n+        onView(withText(\"Latest starred version\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // check base form content\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Module Three\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Module One\"))\n+                .perform(click())\n+        onView(withText(\"Example 1\"))\n+                .perform(click())\n+        onView(withText(\"A text question\"))\n+                .check(matches(isDisplayed()))\n+        closeSoftKeyboard()\n+        pressBack()\n+        onView(withText(R.string.do_not_save))\n+                .perform(click())\n+        pressBack()\n+\n+        // make sure case list doesn't have status column\n+        onView(withText(\"Module Two\"))\n+                .perform(click())\n+        onView(withText(\"Update Case\"))\n+                .perform(click())\n+        onView(withText(\"Status\"))\n+                .check(doesNotExist())\n+        InstrumentationUtility.gotoHome()\n+\n+        // download the app update\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Update App\"))\n+                .perform(click())\n+        onView(withText(\"Current version: 2\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Update to version 11 & log out\"))\n+                .check(matches(isDisplayed()))\n+\n+        // Record LastSyncTime\n+        var lastSyncTime = SyncDetailCalculations.getLastSyncTime()\n+\n+        // Update app\n+        onView(withText(\"Update to version 11 & log out\"))\n+                .perform(click())\n+\n+        // Login into the updated version\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+\n+        // Check that a sync is triggered automatically\n+        InstrumentationUtility.assert(SyncDetailCalculations.getLastSyncTime() > lastSyncTime,\n+                \"Sync not triggered automatically\")\n+\n+        // Check updated data, including multimedia\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Module Three\"))\n+                .check(doesNotExist())\n+        onView(withText(\"Module One\"))\n+                .perform(click())\n+        onView(withText(\"Example 1\"))\n+                .perform(click())\n+        onView(withText(\"Question with audio\"))\n+                .check(matches(isDisplayed()))\n+        onView(withClassName(endsWith(\"AudioPlaybackButton\")))\n+                .check(matches(isDisplayed()))\n+        closeSoftKeyboard()\n+        pressBack()\n+        onView(withText(R.string.do_not_save))\n+                .perform(click())\n+        pressBack()\n+\n+        // make sure case list `Status` column was added\n+        onView(withText(\"Module Two\"))\n+                .perform(click())\n+        onView(withText(\"Update Case\"))\n+                .perform(click())\n+        onView(withText(\"Status\"))\n+                .check(matches(isDisplayed()))\n+        InstrumentationUtility.gotoHome()\n+\n+        // make sure there are no new updates\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Update App\"))\n+                .perform(click())\n+        onView(withText(\"Current version: 11\"))\n+                .check(matches(isDisplayed()))\n+        onView(withText(\"Recheck\"))\n+                .perform(click())\n+        onView(withText(\"Current version: 11\"))\n+                .check(matches(isDisplayed()))\n+        pressBack()\n+\n+        // Change the update endpoint to \"Latest version\"\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Settings\"))\n+                .perform(click())\n+        onView(withText(\"Update Options\"))\n+                .perform(click())\n+        onView(withText(\"Latest version\"))\n+                .perform(click())\n+        pressBack()\n+\n+        // Confirm that you can now see an update. And Update the app.\n+        InstrumentationUtility.openOptionsMenu()\n+        onView(withText(\"Update App\"))\n+                .perform(click())\n+        onView(withText(\"Update to version 22 & log out\"))\n+                .check(matches(isDisplayed()))\n+\n+        // Record the last sync time.\n+        lastSyncTime = SyncDetailCalculations.getLastSyncTime()\n+\n+        // Update app\n+        onView(withText(\"Update to version 22 & log out\"))\n+                .perform(click())\n+\n+        // Login again\n+        InstrumentationUtility.login(\"user_with_no_data\", \"123\")\n+\n+        // Check that login triggers sync\n+        InstrumentationUtility.assert(SyncDetailCalculations.getLastSyncTime() > lastSyncTime,\n+                \"Sync not triggered automatically\")\n+\n+        // Check updates in base form\n+        onView(withText(\"Start\"))\n+                .perform(click())\n+        onView(withText(\"Module One, renamed\"))\n+                .check(matches(isDisplayed()))\n+    }\n+\n+    @SdkSuppress(maxSdkVersion = Build.VERSION_CODES.Q)", "originalCommit": "342bbc38d797c0e99f55534a2f6685e49c63843d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f0f5de39f8bd68af30c9645caa63899f6c242285", "url": "https://github.com/dimagi/commcare-android/commit/f0f5de39f8bd68af30c9645caa63899f6c242285", "message": "Merge branch 'master' into espresso-tests", "committedDate": "2020-08-25T11:03:17Z", "type": "commit"}]}