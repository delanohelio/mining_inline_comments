{"pr_number": 2202, "pr_title": "Rate limit error message improvement", "pr_createdAt": "2020-03-27T06:33:02Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2202", "timeline": [{"oid": "e25391df8dc905c2ded6e9fa7bd92caa336527e7", "url": "https://github.com/dimagi/commcare-android/commit/e25391df8dc905c2ded6e9fa7bd92caa336527e7", "message": "Show detailed error popup for rate limit errors", "committedDate": "2020-03-30T07:14:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4MDMwNQ==", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r400080305", "bodyText": "This should depend on a custom property from the application settings on HQ so that we can disable it selectively for preojects like ICDS.", "author": "shubham1g5", "createdAt": "2020-03-30T10:18:09Z", "path": "app/src/org/commcare/activities/SyncCapableCommCareActivity.java", "diffHunk": "@@ -45,6 +46,7 @@\n     private SyncIconState syncStateForIcon;\n     private SyncIconTrigger lastIconTrigger;\n     private MenuItem currentSyncMenuItem;\n+    private boolean showRateLimitDialog = true;", "originalCommit": "e25391df8dc905c2ded6e9fa7bd92caa336527e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE3NzIyMg==", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r400177222", "bodyText": "Got it! Sounds good.", "author": "ShivamPokhriyal", "createdAt": "2020-03-30T13:09:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4MDMwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4Mjk1Mw==", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r400082953", "bodyText": "This will mean even if user said he don't wanna see the dialog again, it will appear again in the next session. I think a better behaviour will be to save it in app preferences and then expose a setting that allows user to toggel this behaviour.", "author": "shubham1g5", "createdAt": "2020-03-30T10:22:33Z", "path": "app/src/org/commcare/activities/SyncCapableCommCareActivity.java", "diffHunk": "@@ -213,6 +215,24 @@ public void handleFormSendResult(String message, boolean success) {\n         }\n     }\n \n+    public void showRateLimitError() {\n+        if (!showRateLimitDialog) {\n+            handleFormSendResult(Localization.get(\"sync.fail.rate.limited.server.error\"), false);\n+            return;\n+        }\n+        String title = Localization.get(\"form.send.rate.limit.error.title\");\n+        String message = Localization.get(\"form.send.rate.limit.error.message\");\n+        StandardAlertDialog dialog = StandardAlertDialog.getBasicAlertDialog(this, title,\n+                message, null);\n+\n+        dialog.setNegativeButton(Localization.get(\"dialog.do.not.show.again\"), (dialog1, which) -> {\n+            showRateLimitDialog = false;", "originalCommit": "e25391df8dc905c2ded6e9fa7bd92caa336527e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE3ODgwNQ==", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r400178805", "bodyText": "Makes sense. My initial thought was to make sure user gets a detailed popup in every session.", "author": "ShivamPokhriyal", "createdAt": "2020-03-30T13:11:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4Mjk1Mw=="}], "type": "inlineReview"}, {"oid": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6", "url": "https://github.com/dimagi/commcare-android/commit/db31de40b2420cc9cafb695d722b5a8fcf0ea9a6", "message": "Update popup text according to spec", "committedDate": "2020-04-07T07:22:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5NzIwNw==", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404697207", "bodyText": "This string get used by data pull not form submission, so if user is coming here that means form submission has been successful already.", "author": "shubham1g5", "createdAt": "2020-04-07T10:16:39Z", "path": "app/assets/locales/android_translatable_strings.txt", "diffHunk": "@@ -116,11 +117,16 @@ sync.fail.bad.data=Server provided improperly formatted data, please try again o\n sync.fail.bad.local=Your information was fetched, but a problem occurred with the log in. Please try again.\r\n sync.fail.bad.network=Couldn't contact server. Please make sure an internet connection is available or try again later.\r\n sync.fail.server.error=The server encountered an error processing your data. Please try again later. If the problem persists, contact CommCare Support.\r\n-sync.fail.rate.limited.server.error=Our servers are unavailable at this time. Please try again later.\r\n+sync.fail.rate.limited.server.error=Form submission rate limit reached. Your forms are being saved locally and will be submitted to the server later.\r", "originalCommit": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDczNjQxMw==", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404736413", "bodyText": "Ohh, I missed that. The same string is also used to show rate limit error in form upload. It's better to separate the two strings.", "author": "ShivamPokhriyal", "createdAt": "2020-04-07T11:28:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5NzIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc0NzY2MA==", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404747660", "bodyText": "Ahh, I misused this key in the first place.", "author": "ShivamPokhriyal", "createdAt": "2020-04-07T11:50:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5NzIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5OTAxMw==", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404699013", "bodyText": "can we prefix they keys like rate.limit.error.diaglog..... just to make them more specific.", "author": "shubham1g5", "createdAt": "2020-04-07T10:19:46Z", "path": "app/assets/locales/android_translatable_strings.txt", "diffHunk": "@@ -116,11 +117,16 @@ sync.fail.bad.data=Server provided improperly formatted data, please try again o\n sync.fail.bad.local=Your information was fetched, but a problem occurred with the log in. Please try again.\r\n sync.fail.bad.network=Couldn't contact server. Please make sure an internet connection is available or try again later.\r\n sync.fail.server.error=The server encountered an error processing your data. Please try again later. If the problem persists, contact CommCare Support.\r\n-sync.fail.rate.limited.server.error=Our servers are unavailable at this time. Please try again later.\r\n+sync.fail.rate.limited.server.error=Form submission rate limit reached. Your forms are being saved locally and will be submitted to the server later.\r\n sync.fail.unknown=An unexpected issue occurred during sync. Please try to sync again.\r\n sync.fail.unsent=Having issues communicating with the server to send forms. Will try again later.\r\n sync.fail.individual=1 or more forms failed to send due to individual problems. See quarantined forms for details.\r\n \r\n+form.send.rate.limit.error.title=You've reached your form submission rate limit\r\n+form.send.rate.limit.error.message=Form submissions will be saved locally on your phone until rate limiting expires. Not to worry, all forms will be auto-synced to the server later. Contact your CommCare admin for more information.\r\n+dialog.button.do.not.show.again=Don\u2019t show again\r", "originalCommit": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcwMTQ4NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404701485", "bodyText": "use form submission specific error message rather than sync", "author": "shubham1g5", "createdAt": "2020-04-07T10:24:03Z", "path": "app/src/org/commcare/activities/RecoveryActivity.java", "diffHunk": "@@ -96,28 +96,37 @@ protected void deliverResult(RecoveryActivity receiver, FormUploadResult result)\n \r\n                         int successfulSends = this.getSuccessfulSends();\r\n \r\n-                        if (result == FormUploadResult.FULL_SUCCESS) {\r\n-                            receiver.updateStatus(StringUtils.getStringRobust(\r\n-                                    RecoveryActivity.this,\r\n-                                    R.string.recovery_forms_send_successful,\r\n-                                    String.valueOf(successfulSends)));\r\n-                            receiver.attemptRecovery();\r\n-                        } else if (result == FormUploadResult.FAILURE) {\r\n-                            String failureMessage = successfulSends > 0 ?\r\n-                                    StringUtils.getStringRobust(\r\n-                                            RecoveryActivity.this,\r\n-                                            R.string.recovery_forms_send_failure) :\r\n-                                    StringUtils.getStringRobust(\r\n-                                            RecoveryActivity.this,\r\n-                                            R.string.recovery_forms_send_parital_success,\r\n-                                            String.valueOf(successfulSends));\r\n-                            receiver.updateStatus(failureMessage);\r\n-                        } else if (result == FormUploadResult.TRANSPORT_FAILURE) {\r\n-                            receiver.updateStatus(R.string.recovery_forms_send_network_error);\r\n-                        } else if (result == FormUploadResult.RECORD_FAILURE) {\r\n-                            receiver.updateStatus(Localization.get(\"sync.fail.individual\"));\r\n-                        } else if (result == FormUploadResult.AUTH_OVER_HTTP) {\r\n-                            receiver.updateStatus(Localization.get(\"auth.over.http\"));\r\n+                        switch (result) {\r\n+                            case FULL_SUCCESS:\r\n+                                receiver.updateStatus(StringUtils.getStringRobust(\r\n+                                        RecoveryActivity.this,\r\n+                                        R.string.recovery_forms_send_successful,\r\n+                                        String.valueOf(successfulSends)));\r\n+                                receiver.attemptRecovery();\r\n+                                break;\r\n+                            case FAILURE:\r\n+                                String failureMessage = successfulSends > 0 ?\r\n+                                        StringUtils.getStringRobust(\r\n+                                                RecoveryActivity.this,\r\n+                                                R.string.recovery_forms_send_failure) :\r\n+                                        StringUtils.getStringRobust(\r\n+                                                RecoveryActivity.this,\r\n+                                                R.string.recovery_forms_send_parital_success,\r\n+                                                String.valueOf(successfulSends));\r\n+                                receiver.updateStatus(failureMessage);\r\n+                                break;\r\n+                            case TRANSPORT_FAILURE:\r\n+                                receiver.updateStatus(R.string.recovery_forms_send_network_error);\r\n+                                break;\r\n+                            case RECORD_FAILURE:\r\n+                                receiver.updateStatus(Localization.get(\"sync.fail.individual\"));\r\n+                                break;\r\n+                            case AUTH_OVER_HTTP:\r\n+                                receiver.updateStatus(Localization.get(\"auth.over.http\"));\r\n+                                break;\r\n+                            case RATE_LIMITED:\r\n+                                receiver.updateStatus(Localization.get(\"sync.fail.rate.limited.server.error\"));\r", "originalCommit": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcwNzIzOA==", "url": "https://github.com/dimagi/commcare-android/pull/2202#discussion_r404707238", "bodyText": "should show the form submission specific message.", "author": "shubham1g5", "createdAt": "2020-04-07T10:34:25Z", "path": "app/src/org/commcare/activities/SyncCapableCommCareActivity.java", "diffHunk": "@@ -213,6 +215,28 @@ public void handleFormSendResult(String message, boolean success) {\n         }\n     }\n \n+    public void showRateLimitError(boolean userTriggered) {\n+\n+        if (HiddenPreferences.isRateLimitPopupDisabled() || !userTriggered) {\n+            handleFormSendResult(Localization.get(\"sync.fail.rate.limited.server.error\"), false);", "originalCommit": "db31de40b2420cc9cafb695d722b5a8fcf0ea9a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fd460738bb8befb4031f8e2d2c33474dbdb0dcc9", "url": "https://github.com/dimagi/commcare-android/commit/fd460738bb8befb4031f8e2d2c33474dbdb0dcc9", "message": "Show detailed toast for rate limit error on form submissions", "committedDate": "2020-05-03T02:11:59Z", "type": "commit"}, {"oid": "7bbd0fb3e4a3ca4ce53ce799155af377b01783d1", "url": "https://github.com/dimagi/commcare-android/commit/7bbd0fb3e4a3ca4ce53ce799155af377b01783d1", "message": "Add 429 error check in restore request", "committedDate": "2020-05-03T02:11:59Z", "type": "commit"}, {"oid": "a4d4e22f7a07f759f57a5d5729457b736a8bc6b1", "url": "https://github.com/dimagi/commcare-android/commit/a4d4e22f7a07f759f57a5d5729457b736a8bc6b1", "message": "Show detailed error popup for rate limit errors", "committedDate": "2020-05-03T02:12:43Z", "type": "commit"}, {"oid": "d3aa671d83c12feeb4e16a4ce60f13186b06948a", "url": "https://github.com/dimagi/commcare-android/commit/d3aa671d83c12feeb4e16a4ce60f13186b06948a", "message": "Show rate-limit popup only for user-triggered syncs", "committedDate": "2020-05-03T02:12:43Z", "type": "commit"}, {"oid": "fcc980f8a4d64b5d3ddcfcffa9638511c3c715e7", "url": "https://github.com/dimagi/commcare-android/commit/fcc980f8a4d64b5d3ddcfcffa9638511c3c715e7", "message": "Use preferences to decide whether or not to show rate-limit-popup", "committedDate": "2020-05-03T02:13:44Z", "type": "commit"}, {"oid": "e53fc07d779b608cde56665c833459e19421e7c3", "url": "https://github.com/dimagi/commcare-android/commit/e53fc07d779b608cde56665c833459e19421e7c3", "message": "Add option for users to enable rate-limit popup", "committedDate": "2020-05-03T02:13:44Z", "type": "commit"}, {"oid": "e13836fe864df6af7f04da4c5cb0c87422b10206", "url": "https://github.com/dimagi/commcare-android/commit/e13836fe864df6af7f04da4c5cb0c87422b10206", "message": "Update popup text according to spec", "committedDate": "2020-05-03T02:13:44Z", "type": "commit"}, {"oid": "ca54f521a16af7fc2f4ecd28b5c978ef73642992", "url": "https://github.com/dimagi/commcare-android/commit/ca54f521a16af7fc2f4ecd28b5c978ef73642992", "message": "Improve translatable strings for rate limit message", "committedDate": "2020-05-03T02:13:44Z", "type": "commit"}, {"oid": "ca54f521a16af7fc2f4ecd28b5c978ef73642992", "url": "https://github.com/dimagi/commcare-android/commit/ca54f521a16af7fc2f4ecd28b5c978ef73642992", "message": "Improve translatable strings for rate limit message", "committedDate": "2020-05-03T02:13:44Z", "type": "forcePushed"}]}