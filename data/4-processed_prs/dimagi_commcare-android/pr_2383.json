{"pr_number": 2383, "pr_title": "Add case list search and sort tests ", "pr_createdAt": "2020-10-20T05:52:27Z", "pr_url": "https://github.com/dimagi/commcare-android/pull/2383", "timeline": [{"oid": "387406fa9751c20694c5392b1194baac7bccc502", "url": "https://github.com/dimagi/commcare-android/commit/387406fa9751c20694c5392b1194baac7bccc502", "message": "Add case list search tests", "committedDate": "2020-10-20T13:21:57Z", "type": "commit"}, {"oid": "67996a4057912a803b1e5bea344d6bbb111cd697", "url": "https://github.com/dimagi/commcare-android/commit/67996a4057912a803b1e5bea344d6bbb111cd697", "message": "Add case list sort tests", "committedDate": "2020-10-20T13:21:57Z", "type": "commit"}, {"oid": "67996a4057912a803b1e5bea344d6bbb111cd697", "url": "https://github.com/dimagi/commcare-android/commit/67996a4057912a803b1e5bea344d6bbb111cd697", "message": "Add case list sort tests", "committedDate": "2020-10-20T13:21:57Z", "type": "forcePushed"}, {"oid": "efd7bf26a5818f14262903e6db53b8da0c465e09", "url": "https://github.com/dimagi/commcare-android/commit/efd7bf26a5818f14262903e6db53b8da0c465e09", "message": "Fix case list search test", "committedDate": "2020-10-21T06:07:15Z", "type": "commit"}, {"oid": "800a73667f5c5f5491c6030a332bf90aeca5519f", "url": "https://github.com/dimagi/commcare-android/commit/800a73667f5c5f5491c6030a332bf90aeca5519f", "message": "Fix import issues", "committedDate": "2020-10-21T06:47:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEwODE5OA==", "url": "https://github.com/dimagi/commcare-android/pull/2383#discussion_r509108198", "bodyText": "reason is outlined here and we should retain that comment.", "author": "shubham1g5", "createdAt": "2020-10-21T08:57:31Z", "path": "app/instrumentation-tests/src/org/commcare/androidTests/CaseListSearchTest.kt", "diffHunk": "@@ -0,0 +1,138 @@\n+package org.commcare.androidTests\n+\n+import android.content.res.Resources\n+import androidx.test.espresso.Espresso\n+import androidx.test.espresso.Espresso.closeSoftKeyboard\n+import androidx.test.espresso.Espresso.onView\n+import androidx.test.espresso.action.ViewActions.click\n+import androidx.test.espresso.action.ViewActions.typeText\n+import androidx.test.espresso.assertion.ViewAssertions.doesNotExist\n+import androidx.test.espresso.assertion.ViewAssertions.matches\n+import androidx.test.espresso.matcher.ViewMatchers.*\n+import androidx.test.ext.junit.runners.AndroidJUnit4\n+import androidx.test.filters.LargeTest\n+import org.commcare.dalvik.R\n+import org.commcare.utils.CustomMatchers\n+import org.commcare.utils.InstrumentationUtility\n+import org.hamcrest.Matchers.*\n+import org.junit.Before\n+import org.junit.Test\n+import org.junit.runner.RunWith\n+\n+@RunWith(AndroidJUnit4::class)\n+@LargeTest\n+class CaseListSearchTest: BaseTest() {\n+\n+    companion object {\n+        const val CCZ_NAME = \"test_list_search.ccz\"\n+        const val APP_NAME = \"Test: List Searching\"\n+        val entities = arrayOf(\"Christy\", \"Matthew\", \"Steven\", \"Tuco\")\n+    }\n+\n+    @Before\n+    fun setup() {\n+        installApp(APP_NAME, CCZ_NAME)\n+        InstrumentationUtility.login(\"test_list_search\", \"123\")\n+    }\n+\n+    @Test\n+    fun testSearch() {\n+        gotoSearchTestModule()\n+\n+        // Confirm 4 items in the list\n+        onView(withId(R.id.screen_entity_select_list))\n+                .check(matches(CustomMatchers.matchListSize(4)))\n+        matchListItems(entities)\n+\n+        onView(withId(R.id.search_action_bar))\n+                .perform(click())\n+\n+        val searchTextId = Resources.getSystem().getIdentifier(\"android:id/search_src_text\", null, null)\n+\n+        // type `c` and search\n+        onView(withClassName(endsWith(\"SearchAutoComplete\")))\n+                .perform(typeText(\"c\"))\n+        matchList(2, 4, \"c\", arrayOf(entities[0], entities[3]))\n+\n+        // type `h` and search\n+        onView(withClassName(endsWith(\"SearchAutoComplete\")))\n+                .perform(typeText(\"h\"))\n+        matchList(1, 4, \"ch\", arrayOf(entities[0]))\n+\n+        // Confirm it persists on rotation\n+        InstrumentationUtility.rotateLeft()\n+        Espresso.closeSoftKeyboard()\n+        matchList(1, 4, \"ch\", arrayOf(entities[0]))\n+\n+        InstrumentationUtility.rotatePortrait()\n+        Espresso.closeSoftKeyboard()\n+        matchList(1, 4, \"ch\", arrayOf(entities[0]))\n+\n+        onView(allOf(withClassName(endsWith(\"ImageView\")), withContentDescription(\"Clear query\")))\n+                .perform(click())\n+        onView(withText(containsString(\"results for your search\")))\n+                .check(matches(not(isDisplayed())))\n+        matchListItems(entities)\n+\n+        onView(withText(\"Search Tests\"))\n+                .check(doesNotExist())\n+        InstrumentationUtility.gotoHome()\n+\n+        // Start Over\n+        gotoSearchTestModule()\n+\n+        // Clearing searches the other way\n+        onView(withId(R.id.search_action_bar))\n+                .perform(click())\n+        onView(withClassName(endsWith(\"SearchAutoComplete\")))\n+                .perform(typeText(\"x\"))\n+        matchList(0, 4, \"x\", null)\n+        closeSoftKeyboard()\n+        // Use back to clear search\n+        // For some weird reasons, pressing back once doesn't work with searchview.", "originalCommit": "800a73667f5c5f5491c6030a332bf90aeca5519f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTExOTU2NQ==", "url": "https://github.com/dimagi/commcare-android/pull/2383#discussion_r509119565", "bodyText": "Actually the first back press there is to hide the keyboard, which I'm already doing here using closeSoftKeyboard().\nI added this comment because it was working earlier but after rebasing with master it isn't anymore.", "author": "ShivamPokhriyal", "createdAt": "2020-10-21T09:14:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEwODE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEyMTEwOA==", "url": "https://github.com/dimagi/commcare-android/pull/2383#discussion_r509121108", "bodyText": "Or maybe closeSoftKeyboard() doesn't remove focus from search edit text which is again something related with searchview only.", "author": "ShivamPokhriyal", "createdAt": "2020-10-21T09:16:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEwODE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI4NzMyNg==", "url": "https://github.com/dimagi/commcare-android/pull/2383#discussion_r513287326", "bodyText": "@shubham1g5 bumping you for your thoughts on this.", "author": "ShivamPokhriyal", "createdAt": "2020-10-28T09:16:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEwODE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5NDQzNQ==", "url": "https://github.com/dimagi/commcare-android/pull/2383#discussion_r513294435", "bodyText": "@ShivamPokhriyal My point was just that if we know the reason for this behaviour we should state that as comment instead of being ambiguous. You are the best person in capacity to validate your reasoning here and append the comment accordingly, so I will let you decide on any action item on this. This is not a big deal and PR is approved from my side.", "author": "shubham1g5", "createdAt": "2020-10-28T09:28:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEwODE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI5ODg1MQ==", "url": "https://github.com/dimagi/commcare-android/pull/2383#discussion_r513298851", "bodyText": "Cool, I'll keep it as is then.", "author": "ShivamPokhriyal", "createdAt": "2020-10-28T09:34:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEwODE5OA=="}], "type": "inlineReview"}]}