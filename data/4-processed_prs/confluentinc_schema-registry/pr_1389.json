{"pr_number": 1389, "pr_title": "DG-91 Ability to permanently delete schemas", "pr_createdAt": "2020-03-14T00:26:40Z", "pr_url": "https://github.com/confluentinc/schema-registry/pull/1389", "timeline": [{"oid": "43e786fe13d66573696cddd0f1ffa6a0ed57ae9e", "url": "https://github.com/confluentinc/schema-registry/commit/43e786fe13d66573696cddd0f1ffa6a0ed57ae9e", "message": "DG-91 Ability to permamently delete schemas", "committedDate": "2020-03-14T00:25:20Z", "type": "commit"}, {"oid": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "url": "https://github.com/confluentinc/schema-registry/commit/0e51704e349b9d23ab5a83349985d5bfb32edce8", "message": "Removed unused enum", "committedDate": "2020-03-16T16:27:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1MzQ3OQ==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394653479", "bodyText": "The query param should be deleted to be consistent with other endpoints.  Also the parameter should be named lookupDeletedSchema for consistency", "author": "rayokota", "createdAt": "2020-03-18T21:35:59Z", "path": "client/src/main/java/io/confluent/kafka/schemaregistry/client/rest/RestService.java", "diffHunk": "@@ -768,6 +768,19 @@ public String getLatestVersionSchemaOnly(String subject)\n     return response;\n   }\n \n+  public List<Integer> getAllVersions(Map<String, String> requestProperties,\n+                                      String subject,\n+                                      boolean includeDeleted)\n+          throws IOException, RestClientException {\n+    UriBuilder builder = UriBuilder.fromPath(\"/subjects/{subject}/versions\");\n+    builder.queryParam(\"includeDeleted\", includeDeleted);", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NzYxMA==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394677610", "bodyText": "Also we should add a deleted query param on SubjectsResource.list as well.", "author": "rayokota", "createdAt": "2020-03-18T22:32:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1MzQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk1ODY2Mw==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r395958663", "bodyText": "Fixed", "author": "maverick64", "createdAt": "2020-03-21T03:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1MzQ3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1NDM3Mg==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394654372", "bodyText": "before being permanently deleted", "author": "rayokota", "createdAt": "2020-03-18T21:38:03Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/exceptions/SchemaVersionNotSoftDeletedException.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.kafka.schemaregistry.exceptions;\n+\n+public class SchemaVersionNotSoftDeletedException extends SchemaRegistryException {\n+  private final String subject;\n+  private final String version;\n+\n+  public SchemaVersionNotSoftDeletedException(String subject, String version) {\n+    super(\"Subject:\" + subject + \" Version:\"\n+            + version + \" must be deleted first before permanent delete.\");", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk1ODY2Nw==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r395958667", "bodyText": "Fixed", "author": "maverick64", "createdAt": "2020-03-21T03:56:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1NDM3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1NDYyMw==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394654623", "bodyText": "before being permanently deleted", "author": "rayokota", "createdAt": "2020-03-18T21:38:37Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/exceptions/SubjectNotSoftDeletedException.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.kafka.schemaregistry.exceptions;\n+\n+public class SubjectNotSoftDeletedException extends SchemaRegistryException {\n+  public SubjectNotSoftDeletedException(String subject) {\n+    super(\"Subject \" + subject + \" must be deleted first before permanent delete.\");", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk1ODY3MQ==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r395958671", "bodyText": "Fixed", "author": "maverick64", "createdAt": "2020-03-21T03:56:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1NDYyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1NTAwNQ==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394655005", "bodyText": "Subject '%s' has been soft-deleted.", "author": "rayokota", "createdAt": "2020-03-18T21:39:34Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/rest/exceptions/Errors.java", "diffHunk": "@@ -30,6 +30,20 @@\n   public static final String SCHEMA_NOT_FOUND_MESSAGE = \"Schema not found\";\n   public static final String SCHEMA_NOT_FOUND_MESSAGE_FORMAT = \"Schema %s not found\";\n   public static final int SCHEMA_NOT_FOUND_ERROR_CODE = 40403;\n+  public static final String SUBJECT_SOFT_DELETED_MESSAGE_FORMAT = \"Subject '%s' exists in soft deleted format.\"", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk1ODY4Nw==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r395958687", "bodyText": "Fixed", "author": "maverick64", "createdAt": "2020-03-21T03:57:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1NTAwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1NTQ2OA==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394655468", "bodyText": "before being permanently deleted", "author": "rayokota", "createdAt": "2020-03-18T21:40:33Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/rest/exceptions/Errors.java", "diffHunk": "@@ -30,6 +30,20 @@\n   public static final String SCHEMA_NOT_FOUND_MESSAGE = \"Schema not found\";\n   public static final String SCHEMA_NOT_FOUND_MESSAGE_FORMAT = \"Schema %s not found\";\n   public static final int SCHEMA_NOT_FOUND_ERROR_CODE = 40403;\n+  public static final String SUBJECT_SOFT_DELETED_MESSAGE_FORMAT = \"Subject '%s' exists in soft deleted format.\"\n+          + \"Set permanent=true to delete permanently\";\n+  public static final int SUBJECT_SOFT_DELETED_ERROR_CODE = 40404;\n+  public static final String SUBJECT_NOT_SOFT_DELETED_MESSAGE_FORMAT = \"Subject '%s' was not deleted \"\n+          + \"first before permanent delete\";", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk1ODY4NA==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r395958684", "bodyText": "Fixed", "author": "maverick64", "createdAt": "2020-03-21T03:56:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1NTQ2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1NTUxMQ==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394655511", "bodyText": "before being permanently deleted", "author": "rayokota", "createdAt": "2020-03-18T21:40:39Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/rest/exceptions/Errors.java", "diffHunk": "@@ -30,6 +30,20 @@\n   public static final String SCHEMA_NOT_FOUND_MESSAGE = \"Schema not found\";\n   public static final String SCHEMA_NOT_FOUND_MESSAGE_FORMAT = \"Schema %s not found\";\n   public static final int SCHEMA_NOT_FOUND_ERROR_CODE = 40403;\n+  public static final String SUBJECT_SOFT_DELETED_MESSAGE_FORMAT = \"Subject '%s' exists in soft deleted format.\"\n+          + \"Set permanent=true to delete permanently\";\n+  public static final int SUBJECT_SOFT_DELETED_ERROR_CODE = 40404;\n+  public static final String SUBJECT_NOT_SOFT_DELETED_MESSAGE_FORMAT = \"Subject '%s' was not deleted \"\n+          + \"first before permanent delete\";\n+  public static final int SUBJECT_NOT_SOFT_DELETED_ERROR_CODE = 40405;\n+  public static final String SCHEMAVERSION_SOFT_DELETED_MESSAGE_FORMAT = \"Subject '%s' Version %s exists in soft deleted format.\"\n+          + \"Set permanent=true to delete permanently\";\n+  public static final int SCHEMAVERSION_SOFT_DELETED_ERROR_CODE = 40406;\n+  public static final String SCHEMAVERSION_NOT_SOFT_DELETED_MESSAGE_FORMAT = \"Subject '%s' Version %s was not deleted \"\n+          + \"first before permanent delete\";", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1NTc0Ng==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394655746", "bodyText": "exists in soft deleted format. -> was soft-deleted.", "author": "rayokota", "createdAt": "2020-03-18T21:41:13Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/rest/exceptions/Errors.java", "diffHunk": "@@ -30,6 +30,20 @@\n   public static final String SCHEMA_NOT_FOUND_MESSAGE = \"Schema not found\";\n   public static final String SCHEMA_NOT_FOUND_MESSAGE_FORMAT = \"Schema %s not found\";\n   public static final int SCHEMA_NOT_FOUND_ERROR_CODE = 40403;\n+  public static final String SUBJECT_SOFT_DELETED_MESSAGE_FORMAT = \"Subject '%s' exists in soft deleted format.\"\n+          + \"Set permanent=true to delete permanently\";\n+  public static final int SUBJECT_SOFT_DELETED_ERROR_CODE = 40404;\n+  public static final String SUBJECT_NOT_SOFT_DELETED_MESSAGE_FORMAT = \"Subject '%s' was not deleted \"\n+          + \"first before permanent delete\";\n+  public static final int SUBJECT_NOT_SOFT_DELETED_ERROR_CODE = 40405;\n+  public static final String SCHEMAVERSION_SOFT_DELETED_MESSAGE_FORMAT = \"Subject '%s' Version %s exists in soft deleted format.\"", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1NjM2MA==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394656360", "bodyText": "Change query param to deleted, variable name to lookupDeletedSchema.", "author": "rayokota", "createdAt": "2020-03-18T21:42:37Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/rest/resources/SubjectVersionsResource.java", "diffHunk": "@@ -182,15 +183,16 @@ public String getSchemaOnly(\n       @ApiResponse(code = 500, message = \"Error code 50001 -- Error in the backend data store\")})\n   public List<Integer> listVersions(\n       @ApiParam(value = \"Name of the Subject\", required = true)\n-        @PathParam(\"subject\") String subject) {\n+        @PathParam(\"subject\") String subject,\n+      @QueryParam(\"includeDeleted\") boolean includeDeleted) {", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1NjU4OA==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394656588", "bodyText": "nit: need space before @PathParam", "author": "rayokota", "createdAt": "2020-03-18T21:43:04Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/rest/resources/SubjectVersionsResource.java", "diffHunk": "@@ -305,7 +307,8 @@ public void deleteSchemaVersion(\n       final @Suspended AsyncResponse asyncResponse,\n       @Context HttpHeaders headers,\n       @ApiParam(value = \"Name of the Subject\", required = true)@PathParam(\"subject\") String subject,\n-      @ApiParam(value = VERSION_PARAM_DESC, required = true)@PathParam(\"version\") String version) {\n+      @ApiParam(value = VERSION_PARAM_DESC, required = true)@PathParam(\"version\") String version,", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY2MzE1Nw==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394663157", "bodyText": "nit: space before colon, also maybe rename i -> version", "author": "rayokota", "createdAt": "2020-03-18T21:58:00Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/storage/KafkaSchemaRegistry.java", "diffHunk": "@@ -617,23 +631,36 @@ public void deleteSchemaVersionOrForward(\n       kafkaStore.waitUntilKafkaReaderReachesLastOffset(subject, kafkaStoreTimeoutMs);\n       List<Integer> deletedVersions = new ArrayList<>();\n       int deleteWatermarkVersion = 0;\n-      Iterator<Schema> schemasToBeDeleted = getAllVersions(subject, false);\n+      Iterator<Schema> schemasToBeDeleted = getAllVersions(subject, permanentDelete);\n       while (schemasToBeDeleted.hasNext()) {\n         deleteWatermarkVersion = schemasToBeDeleted.next().getVersion();\n         SchemaKey key = new SchemaKey(subject, deleteWatermarkVersion);\n         if (!lookupCache.referencesSchema(key).isEmpty()) {\n           throw new ReferenceExistsException(key.toString());\n         }\n+        if (permanentDelete) {\n+          SchemaValue schemaValue = (SchemaValue) lookupCache.get(key);\n+          if (!schemaValue.isDeleted()) {\n+            throw new SubjectNotSoftDeletedException(subject);\n+          }\n+        }\n         deletedVersions.add(deleteWatermarkVersion);\n       }\n-      DeleteSubjectKey key = new DeleteSubjectKey(subject);\n-      DeleteSubjectValue value = new DeleteSubjectValue(subject, deleteWatermarkVersion);\n-      kafkaStore.put(key, value);\n-      if (getMode(subject) != null) {\n-        deleteMode(subject);\n-      }\n-      if (getCompatibilityLevel(subject) != null) {\n-        deleteSubjectCompatibility(subject);\n+\n+      if (!permanentDelete) {\n+        DeleteSubjectKey key = new DeleteSubjectKey(subject);\n+        DeleteSubjectValue value = new DeleteSubjectValue(subject, deleteWatermarkVersion);\n+        kafkaStore.put(key, value);\n+        if (getMode(subject) != null) {\n+          deleteMode(subject);\n+        }\n+        if (getCompatibilityLevel(subject) != null) {\n+          deleteSubjectCompatibility(subject);\n+        }\n+      } else {\n+        for (Integer i: deletedVersions) {", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY2MzQ4Nw==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394663487", "bodyText": "nit: return schema != null", "author": "rayokota", "createdAt": "2020-03-18T21:58:41Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/storage/KafkaSchemaRegistry.java", "diffHunk": "@@ -861,6 +894,13 @@ public Schema validateAndGetSchema(String subject, VersionId versionId, boolean\n     return schema;\n   }\n \n+  public boolean schemaVersionExists(String subject, VersionId versionId, boolean\n+          returnDeletedSchema) throws SchemaRegistryException {\n+    final int version = versionId.getVersionId();\n+    Schema schema = this.get(subject, version, returnDeletedSchema);\n+    return !(schema == null);", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NDg0OQ==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394674849", "bodyText": "nit: permanent -> permanentDelete", "author": "rayokota", "createdAt": "2020-03-18T22:27:21Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/storage/KafkaSchemaRegistry.java", "diffHunk": "@@ -554,7 +556,8 @@ public int registerOrForward(String subject,\n \n   @Override\n   public void deleteSchemaVersion(String subject,\n-                                  Schema schema)\n+                                  Schema schema,\n+                                  boolean permanent)", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NDkxMA==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394674910", "bodyText": "nit: permanent -> permanentDelete", "author": "rayokota", "createdAt": "2020-03-18T22:27:33Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/storage/KafkaSchemaRegistry.java", "diffHunk": "@@ -587,16 +599,17 @@ public void deleteSchemaVersion(String subject,\n \n   public void deleteSchemaVersionOrForward(\n       Map<String, String> headerProperties, String subject,\n-      Schema schema) throws SchemaRegistryException {\n+      Schema schema, boolean permanent) throws SchemaRegistryException {", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NTMyNg==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394675326", "bodyText": "nit: permanent -> permanentDelete", "author": "rayokota", "createdAt": "2020-03-18T22:28:15Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/storage/KafkaSchemaRegistry.java", "diffHunk": "@@ -746,13 +776,15 @@ private void forwardUpdateCompatibilityLevelRequestToMaster(\n   private void forwardDeleteSchemaVersionRequestToMaster(\n       Map<String, String> headerProperties,\n       String subject,\n-      Integer version) throws SchemaRegistryRequestForwardingException {\n+      Integer version,\n+      boolean permanent) throws SchemaRegistryRequestForwardingException {", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NTg0Nw==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394675847", "bodyText": "nit: lookupDeleted -> lookupDeletedSubjects", "author": "rayokota", "createdAt": "2020-03-18T22:28:55Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/storage/KafkaSchemaRegistry.java", "diffHunk": "@@ -1033,9 +1073,10 @@ public SchemaString get(\n     return subjects;\n   }\n \n-  public boolean hasSubjects(String subject) throws SchemaRegistryStoreException {\n+  public boolean hasSubjects(String subject, boolean lookupDeleted)", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NjEwMQ==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394676101", "bodyText": "nit: lookupDeletedSubject -> lookupDeletedSubjects", "author": "rayokota", "createdAt": "2020-03-18T22:29:14Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/storage/LookupCache.java", "diffHunk": "@@ -121,7 +121,7 @@ CompatibilityLevel compatibilityLevel(String subject,\n    * @param subject the subject, or null for all subjects\n    * @return whether there exist matching schemas\n    */\n-  boolean hasSubjects(String subject) throws StoreException;\n+  boolean hasSubjects(String subject, boolean lookupDeletedSubject) throws StoreException;", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NjM3MQ==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394676371", "bodyText": "nit: permanent -> permanentDelete", "author": "rayokota", "createdAt": "2020-03-18T22:29:35Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/storage/SchemaRegistry.java", "diffHunk": "@@ -68,7 +69,8 @@ boolean isCompatible(String subject,\n \n   void close();\n \n-  void deleteSchemaVersion(String subject, Schema schema) throws SchemaRegistryException;\n+  void deleteSchemaVersion(String subject, Schema schema,\n+                           boolean permanent) throws SchemaRegistryException;", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk1ODY5MA==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r395958690", "bodyText": "Fixed", "author": "maverick64", "createdAt": "2020-03-21T03:57:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NjM3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NjUxOA==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394676518", "bodyText": "nit: permanent -> permanentDelete", "author": "rayokota", "createdAt": "2020-03-18T22:29:53Z", "path": "client/src/main/java/io/confluent/kafka/schemaregistry/client/rest/RestService.java", "diffHunk": "@@ -828,6 +841,22 @@ public Integer deleteSchemaVersion(\n     return response;\n   }\n \n+  public Integer deleteSchemaVersion(\n+          Map<String, String> requestProperties,\n+          String subject,\n+          String version,\n+          boolean permanent", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk1ODY5OA==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r395958698", "bodyText": "Fixed", "author": "maverick64", "createdAt": "2020-03-21T03:57:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NjUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NjY0Mw==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394676643", "bodyText": "nit: permanent -> permanentDelete", "author": "rayokota", "createdAt": "2020-03-18T22:30:14Z", "path": "client/src/main/java/io/confluent/kafka/schemaregistry/client/rest/RestService.java", "diffHunk": "@@ -841,6 +870,21 @@ public Integer deleteSchemaVersion(\n     return response;\n   }\n \n+  public List<Integer> deleteSubject(\n+          Map<String, String> requestProperties,\n+          String subject,\n+          boolean permanent", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk1ODcwMQ==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r395958701", "bodyText": "Fixed", "author": "maverick64", "createdAt": "2020-03-21T03:57:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3NjY0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3Njg0OA==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394676848", "bodyText": "nit: lookupDeletedSubject -> lookupDeletedSubjects", "author": "rayokota", "createdAt": "2020-03-18T22:30:46Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/storage/InMemoryCache.java", "diffHunk": "@@ -232,19 +232,19 @@ public Mode mode(String subject,\n   }\n \n   @Override\n-  public boolean hasSubjects(String subject) {\n-    return hasSubjects(matchingPredicate(subject));\n+  public boolean hasSubjects(String subject, boolean lookupDeletedSubject) {", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk1ODcwOA==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r395958708", "bodyText": "Fixed", "author": "maverick64", "createdAt": "2020-03-21T03:57:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3Njg0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk1ODcxOA==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r395958718", "bodyText": "Fixed", "author": "maverick64", "createdAt": "2020-03-21T03:57:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3Njg0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3Njk3Nw==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r394676977", "bodyText": "nit: lookupDeletedSubject -> lookupDeletedSubjects", "author": "rayokota", "createdAt": "2020-03-18T22:31:06Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/storage/InMemoryCache.java", "diffHunk": "@@ -232,19 +232,19 @@ public Mode mode(String subject,\n   }\n \n   @Override\n-  public boolean hasSubjects(String subject) {\n-    return hasSubjects(matchingPredicate(subject));\n+  public boolean hasSubjects(String subject, boolean lookupDeletedSubject) {\n+    return hasSubjects(matchingPredicate(subject), lookupDeletedSubject);\n   }\n \n-  public boolean hasSubjects(Predicate<String> match) {\n+  public boolean hasSubjects(Predicate<String> match, boolean lookupDeletedSubject) {", "originalCommit": "0e51704e349b9d23ab5a83349985d5bfb32edce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk1ODcyNA==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r395958724", "bodyText": "Fixed", "author": "maverick64", "createdAt": "2020-03-21T03:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY3Njk3Nw=="}], "type": "inlineReview"}, {"oid": "eb52eb42506e74ee760d21ca4c22d27dd76e458e", "url": "https://github.com/confluentinc/schema-registry/commit/eb52eb42506e74ee760d21ca4c22d27dd76e458e", "message": "Addressed PR comments", "committedDate": "2020-03-21T02:57:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzNTY4Nw==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r396635687", "bodyText": "Use the UriBuilder with queryParam as with other methods in this class.", "author": "rayokota", "createdAt": "2020-03-23T17:41:11Z", "path": "client/src/main/java/io/confluent/kafka/schemaregistry/client/rest/RestService.java", "diffHunk": "@@ -786,6 +786,16 @@ public String getLatestVersionSchemaOnly(String subject)\n     return getAllSubjects(DEFAULT_REQUEST_PROPERTIES);\n   }\n \n+  public List<String> getAllSubjects(boolean deletedSubjects)\n+          throws IOException, RestClientException {\n+    List<String> response = httpRequest(\"/subjects\"\n+                    + (deletedSubjects ? \"?deleted=true\" : \"\"),", "originalCommit": "eb52eb42506e74ee760d21ca4c22d27dd76e458e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzNzQxMQ==", "url": "https://github.com/confluentinc/schema-registry/pull/1389#discussion_r396637411", "bodyText": "nit: needs space after colons, \"Subject: \" and \" Version: \"", "author": "rayokota", "createdAt": "2020-03-23T17:43:41Z", "path": "core/src/main/java/io/confluent/kafka/schemaregistry/exceptions/SchemaVersionNotSoftDeletedException.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.kafka.schemaregistry.exceptions;\n+\n+public class SchemaVersionNotSoftDeletedException extends SchemaRegistryException {\n+  private final String subject;\n+  private final String version;\n+\n+  public SchemaVersionNotSoftDeletedException(String subject, String version) {\n+    super(\"Subject:\" + subject + \" Version:\"", "originalCommit": "eb52eb42506e74ee760d21ca4c22d27dd76e458e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2d18e0c78c8c4990631c1fae2d054c117d850e6b", "url": "https://github.com/confluentinc/schema-registry/commit/2d18e0c78c8c4990631c1fae2d054c117d850e6b", "message": "Address PR comments", "committedDate": "2020-03-24T05:25:18Z", "type": "commit"}]}