{"pr_number": 253, "pr_title": "HH-113801 improve support for multiple DBs", "pr_createdAt": "2020-07-30T10:40:52Z", "pr_url": "https://github.com/hhru/nuts-and-bolts/pull/253", "timeline": [{"oid": "91ee0e9124fbf75bfa6cab27edb74fc092048d55", "url": "https://github.com/hhru/nuts-and-bolts/commit/91ee0e9124fbf75bfa6cab27edb74fc092048d55", "message": "HH-113801 improve support for multiple DBs", "committedDate": "2020-07-30T10:37:32Z", "type": "commit"}, {"oid": "7b7be685bbf772abcc2df8e3962dde777c4b9772", "url": "https://github.com/hhru/nuts-and-bolts/commit/7b7be685bbf772abcc2df8e3962dde777c4b9772", "message": "HH-113801 add jackson to root dependencyManagement", "committedDate": "2020-07-30T10:47:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk0Njk5Mw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r462946993", "bodyText": "\u0412\u0441\u0435\u0433\u0434\u0430 \u0431\u044b\u043b \u043f\u0440\u043e\u0442\u0438\u0432 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u044f \u044d\u0442\u043e\u0439 \u0444\u0438\u0447\u0438 \u0441\u043f\u0440\u0438\u043d\u0433\u0430, \u044d\u0442\u043e \u0441\u043a\u043e\u0432\u044b\u0432\u0430\u0435\u0442 \u0440\u0430\u0437\u0440\u0430\u0431\u043e\u0442\u043a\u0443.\n\u0417\u0430\u0445\u043e\u0447\u0435\u0442 \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440 \u043a\u0442\u043e-\u0442\u043e \u0441\u0434\u0435\u043b\u0430\u0442\u044c 2 \u0431\u0438\u043d\u0430 DataSourceContextTransactionManagerImpl \u0438 DataSourceContextTransactionManagerProxy \u0438 \u043d\u0430\u0431 \u0432\u0437\u043e\u0440\u0432\u0451\u0442\u0441\u044f.\n\u0414\u043b\u044f \u0442\u0430\u043a\u0438\u0445 \u0441\u043b\u0443\u0447\u0430\u0435\u0432 \u044f \u0431\u044b \u043b\u0438\u0431\u043e \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043b \u043a\u043b\u0430\u0441\u0441 \u043e\u0431\u0451\u0440\u0442\u043a\u0443, \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u044e\u0449\u0438\u0439 Map'\u0443 \u043b\u0438\u0431\u043e \u0443\u0436 \u0435\u0441\u043b\u0438 \u0441\u043e\u0432\u0441\u0435\u043c \u0445\u043e\u0447\u0435\u0442\u0441\u044f \u0432 \u0442\u0430\u043a\u043e\u043c \u0441\u0438\u043d\u0442\u0430\u043a\u0441\u0438\u0441\u0435 \u043a\u0432\u0430\u043b\u0438\u0444\u0438\u043a\u0430\u0442\u043e\u0440.", "author": "pvorlov", "createdAt": "2020-07-30T12:02:27Z", "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/NabHibernateCommonConfig.java", "diffHunk": "@@ -6,43 +6,55 @@\n import org.hibernate.SessionFactory;\n import org.hibernate.boot.registry.BootstrapServiceRegistryBuilder;\n import org.hibernate.integrator.spi.Integrator;\n+import org.springframework.context.ApplicationContext;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n import org.springframework.context.annotation.EnableAspectJAutoProxy;\n import org.springframework.orm.hibernate5.HibernateTransactionManager;\n \n import javax.sql.DataSource;\n import java.util.Properties;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n import org.springframework.transaction.annotation.EnableTransactionManagement;\n import ru.hh.nab.hibernate.transaction.DataSourceContextTransactionManager;\n import ru.hh.nab.hibernate.transaction.ExecuteOnDataSourceAspect;\n import ru.hh.nab.hibernate.transaction.TransactionalScope;\n \n+import static java.util.stream.Collectors.toMap;\n+\n @Configuration\n @EnableTransactionManagement(order = 0)\n @EnableAspectJAutoProxy\n public class NabHibernateCommonConfig {\n \n   @Bean\n-  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory, DataSource routingDataSource) {\n+  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory, DataSource dataSource) {\n     HibernateTransactionManager simpleTransactionManager = new HibernateTransactionManager(sessionFactory);\n-    simpleTransactionManager.setDataSource(routingDataSource);\n+    simpleTransactionManager.setDataSource(dataSource);\n     return new DataSourceContextTransactionManager(simpleTransactionManager);\n   }\n \n   @Bean\n-  ExecuteOnDataSourceAspect executeOnDataSourceAspect(DataSourceContextTransactionManager transactionManager, SessionFactory sessionFactory) {\n-    return new ExecuteOnDataSourceAspect(transactionManager, sessionFactory);\n+  ExecuteOnDataSourceAspect executeOnDataSourceAspect(ApplicationContext applicationContext) {\n+    var txManagers\n+      = Stream.of(applicationContext.getBeanNamesForType(DataSourceContextTransactionManager.class))", "originalCommit": "7b7be685bbf772abcc2df8e3962dde777c4b9772", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3MDM2NQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r462970365", "bodyText": "\u043f\u043e\u0447\u0435\u043c\u0443 \u0432\u0437\u043e\u0440\u0432\u0435\u0442\u0441\u044f-\u0442\u043e?", "author": "dzharikhin", "createdAt": "2020-07-30T12:47:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk0Njk5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3NDU5NQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r462974595", "bodyText": "\u041d\u0443 \u043a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u043e \u0441\u0435\u0439\u0447\u0430\u0441 \u043c\u043e\u0436\u0435\u0442 \u043d\u0435 \u0432\u0437\u043e\u0440\u0432\u0451\u0442\u0441\u044f, \u043d\u043e \u0435\u0441\u043b\u0438 \u043c\u044b \u0432 \u0430\u0441\u043f\u0435\u043a\u0442\u0435 \u0437\u0430\u0445\u043e\u0442\u0438\u043c \u0441\u0434\u0435\u043b\u0430\u0442\u044c txManagers.values().forEach \u0442\u043e \u0437\u0430\u0434\u0435\u043d\u0435\u043c \u043a\u043b\u0430\u0441\u0441, \u043a\u043e\u0442\u043e\u0440\u044b\u0439 \u0434\u043b\u044f \u044d\u0442\u043e\u0433\u043e \u043d\u0435 \u043f\u0440\u0435\u0434\u043d\u0430\u0437\u043d\u0430\u0447\u0430\u043b\u0441\u044f \u0438 \u043c\u043e\u0436\u0435\u043c \u0432\u044b\u0437\u0432\u0430\u0442\u044c \u0441\u0430\u0439\u0434-\u044d\u0444\u0444\u0435\u043a\u0442\u044b", "author": "pvorlov", "createdAt": "2020-07-30T12:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk0Njk5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAxNTU3MQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463015571", "bodyText": "@transactional \u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442 \u0431\u0435\u0437 \u043a\u0432\u0430\u043b\u0438\u0444\u0430\u0435\u0440\u043e\u0432. \u0431\u0443\u0434\u0435\u0442 \u043a\u0430\u043a-\u0442\u043e \u0441\u0442\u0440\u0430\u043d\u043d\u043e, \u0435\u0441\u043b\u0438 \u0442\u044b \u043c\u043e\u0436\u0435\u0448\u044c \u0432 transactional, \u043d\u043e \u043d\u0435 \u043c\u043e\u0436\u0435\u0448\u044c \u0432 executeondatasource", "author": "dzharikhin", "createdAt": "2020-07-30T13:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk0Njk5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAzNTIyNg==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463035226", "bodyText": "\u041e\u043a, \u0441\u043f\u0440\u0430\u0432\u0435\u0434\u043b\u0438\u0432\u043e", "author": "pvorlov", "createdAt": "2020-07-30T14:25:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk0Njk5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2NzAzNQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r462967035", "bodyText": "\u0412 \u0434\u043e\u043a\u0435 \u043d\u0430\u043f\u0438\u0441\u0430\u043d\u043e, \u0447\u0442\u043e \u043e\u043d \u0430\u043a\u0442\u0438\u0432\u0438\u0440\u043e\u0432\u0430\u043d \u043f\u043e \u0434\u0435\u0444\u043e\u043b\u0442\u0443. \u0414\u0443\u043c\u0430\u044e \u043c\u043e\u0436\u043d\u043e \u0443\u0431\u0440\u0430\u0442\u044c", "author": "pvorlov", "createdAt": "2020-07-30T12:41:26Z", "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/NabHibernateCommonConfig.java", "diffHunk": "@@ -30,9 +30,9 @@\n public class NabHibernateCommonConfig {\n \n   @Bean\n-  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory, DataSource dataSource) {\n+  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory) {\n     HibernateTransactionManager simpleTransactionManager = new HibernateTransactionManager(sessionFactory);\n-    simpleTransactionManager.setDataSource(dataSource);\n+    simpleTransactionManager.setAutodetectDataSource(true);", "originalCommit": "6ce06f3a920178b26a15eaecf5d7cb39af003379", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3MDg0OA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r462970848", "bodyText": "\u044f \u0431\u044b \u043e\u0441\u0442\u0430\u0432\u0438\u043b - \u043d\u0430\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043f\u043e\u043d\u044f\u0442\u043d\u043e, \u043d\u0430\u0432\u043e\u0434\u0438\u0442 \u043d\u0430 \u043c\u044b\u0441\u043b\u0438 \u0447\u0442\u043e \u0442\u0430\u043c \u043f\u0440\u043e\u0438\u0441\u0445\u043e\u0434\u0438\u0442", "author": "dzharikhin", "createdAt": "2020-07-30T12:48:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2NzAzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3MTQ2Nw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r462971467", "bodyText": "\u0410 \u0434\u0430\u0432\u0430\u0439 \u043b\u0443\u0447\u0448\u0435 \u0432 \u043a\u043e\u043d\u0441\u0442\u0440\u0443\u043a\u0442\u043e\u0440\u0435 \u043f\u0440\u0438\u043d\u0438\u043c\u0430\u0442\u044c HibernateTransactionManager", "author": "pvorlov", "createdAt": "2020-07-30T12:49:13Z", "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/transaction/DataSourceContextTransactionManager.java", "diffHunk": "@@ -19,6 +21,11 @@ public DataSourceContextTransactionManager(PlatformTransactionManager delegate)\n     this.delegate = delegate;\n   }\n \n+  //fuuuuuuck\n+  SessionFactory getSessionFactory() {", "originalCommit": "6ce06f3a920178b26a15eaecf5d7cb39af003379", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAxNjE2Mw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463016163", "bodyText": "\u0442\u0430\u043a \u0435\u043c\u0443 \u0432\u0440\u043e\u0434\u0435 \u043d\u0435 \u043d\u0430\u0434\u043e) \u043e\u043d \u0442\u0438\u043f\u0430 \u043c\u043e\u0436\u0435\u0442 \u0432 \u043b\u044e\u0431\u043e\u0439)", "author": "dzharikhin", "createdAt": "2020-07-30T13:58:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3MTQ2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAzNjU3MA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463036570", "bodyText": "\u041d\u0443 \u043d\u0435 \u043c\u043e\u0436\u0435\u0442 \u0436\u0435 \u043f\u043e \u0444\u0430\u043a\u0442\u0443, \u043a \u0442\u043e\u043c\u0443 \u0436\u0435 \u044d\u0442\u043e \u043d\u0430\u0448 \u043a\u043b\u0430\u0441\u0441. \u041c\u044b \u043d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u0432\u044b\u0438\u0433\u0440\u044b\u0432\u0430\u0435\u043c \u043e\u0442 \u044d\u0442\u043e\u0439 \u0430\u0431\u0441\u0442\u0440\u0430\u043a\u0446\u0438\u0438.", "author": "pvorlov", "createdAt": "2020-07-30T14:26:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3MTQ2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3NzgzMg==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r462977832", "bodyText": "\u0427\u0442\u043e \u0432\u0441\u0451-\u0442\u0430\u043a\u0438 \u043f\u043e\u0434\u0440\u0430\u0437\u0443\u043c\u0435\u0432\u0430\u0435\u0442\u0441\u044f \u043f\u043e\u0434 \u043f\u0435\u0440\u0435\u0438\u043c\u0435\u043d\u043e\u0432\u0430\u043d\u0438\u0435\u043c? \u0427\u0442\u043e \u043c\u044b \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u043c \u043c\u0430\u0441\u0442\u0435\u0440 \u0438\u043b\u0438 \u0447\u0442\u043e \u0432 \u0441\u0435\u0440\u0441\u0438\u0441\u0430\u0445 \u043d\u0430\u0434\u043e \u0431\u0443\u0434\u0435\u0442 \u043f\u0435\u0440\u0435\u0438\u043c\u0435\u043d\u043e\u0432\u044b\u0432\u0430\u0442\u044c routingDataSource? \u0415\u0441\u043b\u0438 \u0432\u0442\u043e\u0440\u043e\u0435 \u0442\u043e \u0437\u0430\u0447\u0435\u043c?", "author": "pvorlov", "createdAt": "2020-07-30T13:00:15Z", "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/NabHibernateCommonConfig.java", "diffHunk": "@@ -6,43 +6,52 @@\n import org.hibernate.SessionFactory;\n import org.hibernate.boot.registry.BootstrapServiceRegistryBuilder;\n import org.hibernate.integrator.spi.Integrator;\n+import org.springframework.context.ApplicationContext;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n import org.springframework.context.annotation.EnableAspectJAutoProxy;\n import org.springframework.orm.hibernate5.HibernateTransactionManager;\n \n import javax.sql.DataSource;\n import java.util.Properties;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n import org.springframework.transaction.annotation.EnableTransactionManagement;\n import ru.hh.nab.hibernate.transaction.DataSourceContextTransactionManager;\n import ru.hh.nab.hibernate.transaction.ExecuteOnDataSourceAspect;\n import ru.hh.nab.hibernate.transaction.TransactionalScope;\n \n+import static java.util.stream.Collectors.toMap;\n+\n @Configuration\n @EnableTransactionManagement(order = 0)\n @EnableAspectJAutoProxy\n public class NabHibernateCommonConfig {\n \n   @Bean\n-  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory, DataSource routingDataSource) {\n+  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory) {\n     HibernateTransactionManager simpleTransactionManager = new HibernateTransactionManager(sessionFactory);\n-    simpleTransactionManager.setDataSource(routingDataSource);\n+    simpleTransactionManager.setAutodetectDataSource(true);\n     return new DataSourceContextTransactionManager(simpleTransactionManager);\n   }\n \n   @Bean\n-  ExecuteOnDataSourceAspect executeOnDataSourceAspect(DataSourceContextTransactionManager transactionManager, SessionFactory sessionFactory) {\n-    return new ExecuteOnDataSourceAspect(transactionManager, sessionFactory);\n+  ExecuteOnDataSourceAspect executeOnDataSourceAspect(ApplicationContext applicationContext) {\n+    var txManagers\n+      = Stream.of(applicationContext.getBeanNamesForType(DataSourceContextTransactionManager.class))\n+        .collect(toMap(Function.identity(), beanName -> applicationContext.getBean(beanName, DataSourceContextTransactionManager.class)));\n+    return new ExecuteOnDataSourceAspect(txManagers);\n   }\n \n   @Bean\n-  NabSessionFactoryBean sessionFactoryBean(DataSource routingDataSource, Properties hibernateProperties,\n+  NabSessionFactoryBean sessionFactory(DataSource dataSource, Properties hibernateProperties,", "originalCommit": "6ce06f3a920178b26a15eaecf5d7cb39af003379", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAxNTYyNA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463015624", "bodyText": "\u0435\u0441\u043b\u0438 \u0432 \u0441\u0435\u0440\u0432\u0438\u0441\u0430\u0445 \u0431\u043e\u043b\u0435\u0435 \u043e\u0434\u043d\u043e\u0433\u043e DS, \u0442\u043e \u0434\u0430, \u043d\u0430\u0434\u043e \u0431\u0443\u0434\u0435\u0442 \u043f\u0435\u0440\u0435\u0438\u043c\u0435\u043d\u043e\u0432\u0430\u0442\u044c. \u0435\u0441\u043b\u0438 \u043e\u0434\u0438\u043d - \u043d\u0435 \u043d\u0430\u0434\u043e", "author": "dzharikhin", "createdAt": "2020-07-30T13:57:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3NzgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAzNzY1MA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463037650", "bodyText": "\u0410 \u0437\u0430\u0447\u0435\u043c? \u041f\u0443\u0441\u0442\u044c \u043e\u0441\u0442\u0430\u0451\u0442\u0441\u044f routingDataSource, \u043d\u0438\u043a\u043e\u043c\u0443 \u043d\u0435 \u043d\u0430\u0434\u043e \u043c\u0438\u0433\u0440\u0438\u0440\u043e\u0432\u0430\u0442\u044c, \u0432\u0441\u0435 \u0443\u0436\u0435 \u043f\u0440\u0438\u0432\u044b\u043a\u043b\u0438", "author": "pvorlov", "createdAt": "2020-07-30T14:28:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3NzgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA0MTgyNA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463041824", "bodyText": "\u0442\u0430\u043a \u0430 \u043a\u0442\u043e \u043f\u0440\u0438\u0432\u044b\u043a? \u0441\u0435\u0441\u0441\u0438\u044f, hhid, negotiations - \u0432\u0435\u0437\u0434\u0435 \u043d\u0430\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f dataSource)", "author": "dzharikhin", "createdAt": "2020-07-30T14:34:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3NzgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA1ODEyMQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463058121", "bodyText": "\u043e\u043a", "author": "pvorlov", "createdAt": "2020-07-30T14:55:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3NzgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk4Mzc3NQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r462983775", "bodyText": "\u041d\u0435 \u043d\u0440\u0430\u0432\u0438\u0442\u0441\u044f \u043c\u043d\u0435 \u044d\u0442\u043e\u0442 default. \u0423\u0436 \u043b\u0443\u0447\u0448\u0435 \u0432\u043e\u043e\u0431\u0449\u0435 \u0431\u0435\u0437 \u043d\u0435\u0433\u043e \u0447\u0435\u043c \u043f\u043e\u043b\u0430\u0433\u0430\u0442\u044c\u0441\u044f \u043d\u0430 \u0441\u0442\u0440\u043e\u043a\u0438.\n\u0410 \u0447\u0442\u043e \u0435\u0441\u043b\u0438 \u043f\u043e\u043f\u0440\u043e\u0431\u043e\u0432\u0430\u0442\u044c \u0447\u0435\u0440\u0435\u0437 \u043a\u0432\u0430\u043b\u0438\u0444\u0438\u043a\u0430\u0442\u043e\u0440\u044b? \u0414\u043e\u043a\u0430 \u0434\u043b\u044f @ Transactional \u043f\u0438\u0448\u0435\u0442 \"matching the qualifier value (or the bean name)\"\n\u0415\u0441\u043b\u0438 \u0431\u0440\u0430\u0442\u044c \u0432 \u043f\u0440\u0438\u043c\u0435\u0440 negotiation \u0442\u043e \u043c\u043e\u0436\u043d\u043e \u0431\u044b\u043b\u043e \u0431\u044b \u043f\u043e\u043f\u0440\u043e\u0431\u043e\u0432\u0430\u0442\u044c \u0434\u043b\u044f \u0430\u043a\u0442\u0438\u0432\u043d\u044b\u0445 \u043f\u0435\u0440\u0435\u043f\u0438\u0441\u043e\u043a \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c \u0432\u0441\u0442\u0440\u043e\u0435\u043d\u043d\u044b\u0439 \u043a\u0432\u0430\u043b\u0438\u0444\u043a\u0430\u0442\u043e\u0440 @ Default \u0430 \u0434\u043b\u044f \u0430\u0440\u0445\u0438\u0432\u043d\u043e\u0433\u043e \u0437\u0430\u0432\u0435\u0441\u0442\u0438 \u0441\u0432\u043e\u0439.", "author": "pvorlov", "createdAt": "2020-07-30T13:10:26Z", "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/transaction/ExecuteOnDataSource.java", "diffHunk": "@@ -25,4 +25,6 @@\n   boolean overrideByRequestScope() default false;\n \n   DataSourceCacheMode cacheMode() default DataSourceCacheMode.NORMAL;\n+\n+  String txManager() default \"transactionManager\";", "originalCommit": "6ce06f3a920178b26a15eaecf5d7cb39af003379", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAxNjYxNg==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463016616", "bodyText": "\u041e\u0442\u043a\u0443\u0434\u0430 \u0443 \u0442\u0435\u0431\u044f \u043b\u044e\u0431\u043e\u0432\u044c \u043a \u0430\u043d\u043d\u043e\u0442\u0430\u0446\u0438\u044f\u043c?) \u043e\u043d\u0438 \u0436 \u043d\u0438\u0447\u0435\u043c \u043d\u0435 \u043b\u0443\u0447\u0448\u0435 \u0438\u043c\u0435\u043d)", "author": "dzharikhin", "createdAt": "2020-07-30T13:59:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk4Mzc3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAyMDMwNg==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463020306", "bodyText": "\u043c\u043d\u0435 \u0442\u043e\u0436\u0435 \u0431\u043e\u043b\u044c\u0448\u0435 \u0430\u043d\u043d\u043e\u0442\u0430\u0446\u0438\u0438 \u0441 \u043a\u0432\u0430\u043b\u0438\u0444\u0430\u0435\u0440\u0430\u043c\u0438 \u0431\u043e\u043b\u044c\u0448\u0435 \u043d\u0440\u0430\u0432\u044f\u0442\u0441\u044f. \u0418\u043b\u0438 \u043a\u043e\u043d\u0441\u0442\u0430\u043d\u0442\u0443 \u043f\u043e\u0434\u0441\u043e\u0432\u044b\u0432\u0430\u0442\u044c. \u0418\u0441\u043a\u0430\u0442\u044c \u043f\u0440\u043e\u0449\u0435", "author": "heruv1m", "createdAt": "2020-07-30T14:04:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk4Mzc3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA0NDUzOQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463044539", "bodyText": "+1 \u043a \u043f\u0440\u043e\u0449\u0435 \u0438\u0441\u043a\u0430\u0442\u044c. \u042d\u0442\u043e \u043e\u0441\u043d\u043e\u0432\u043d\u043e\u0439 \u043f\u043e\u0438\u043d\u0442 \u043f\u0440\u043e \u043b\u044e\u0431\u043e\u0432\u044c \u043a \u0430\u043d\u043d\u043e\u0442\u0430\u0446\u0438\u044f\u043c.\n\u0427\u0442\u043e \u043a\u0430\u0441\u0430\u0435\u0442\u0441\u044f Spring'\u0430 \u0442\u043e \u0443 \u043c\u0435\u043d\u044f \u0431\u043e\u043b\u044c\u0448\u0430\u044f \u043d\u0435\u043b\u044e\u0431\u043e\u0432\u044c \u043a \u0440\u0435\u0437\u043e\u043b\u0432\u0438\u043d\u0433\u0443 \u043f\u043e \u0438\u043c\u0435\u043d\u0438 \u0431\u0438\u043d\u0430:\n\n\u0421\u043e\u0432\u0441\u0435\u043c \u043d\u0435\u043e\u0447\u0435\u0432\u0438\u0434\u043d\u043e \u043a\u043e\u0433\u0434\u0430 \u0442\u044b \u043f\u043e\u043c\u0435\u043d\u044f\u043b \u0438\u043c\u044f \u043a\u0430\u0437\u0430\u043b\u043e\u0441\u044c \u0431\u044b \u043b\u043e\u043a\u0430\u043b\u044c\u043d\u043e\u0439 \u043f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u043e\u0439 \u0438 \u043f\u0440\u043e\u0435\u043a\u0442 \u0431\u043e\u043b\u044c\u0448\u0435 \u043d\u0435 \u0441\u0442\u0430\u0440\u0442\u0443\u0435\u0442.\n\u041a\u043e\u0433\u0434\u0430 \u043c\u044b \u0442\u0430\u043a \u0434\u0435\u043b\u0430\u0435\u043c \u043d\u0430\u0434 \u043d\u0430\u043c\u0438 \u0444\u0440\u043e\u043d\u0442\u0430\u043d\u044b \u0441\u043c\u0435\u044e\u0442\u0441\u044f: https://hhru.slack.com/archives/C06P8LGAZ/p1563371364148800?thread_ts=1563370651.145200&cid=C06P8LGAZ\n\u0427\u0442\u043e \u0441\u0438\u043b\u044c\u043d\u043e \u0445\u0443\u0436\u0435 \u044d\u0442\u043e \u043d\u0430\u0440\u0443\u0448\u0430\u0435\u0442 IoC:  \u0438\u043c\u044f \u0431\u0438\u043d\u0430 \u0434\u043e\u043b\u0436\u043d\u043e \u0431\u044b\u0442\u044c \u0443\u043d\u0438\u043a\u0430\u043b\u044c\u043d\u043e, \u044d\u0442\u043e \u043d\u0438\u0447\u0435\u043c \u043d\u0435 \u043b\u0443\u0447\u0448\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u044f new\n\n\u0427\u0442\u043e \u043a\u0430\u0441\u0430\u0435\u0442\u0441\u044f \u043a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u043e \u044d\u0442\u043e\u0433\u043e \u0441\u043b\u0443\u0447\u0430\u044f: \u0442\u043e \u043c\u043d\u0435 \u0445\u043e\u0447\u0435\u0442\u0441\u044f \u0447\u0442\u043e\u0431\u044b \u0430\u0441\u043f\u0435\u043a\u0442 nab'\u0430 \u0440\u0430\u0437\u0440\u0443\u043b\u0438\u0432\u0430\u043b \u0434\u0435\u0444\u043e\u043b\u0442 \u0430 \u043d\u0435 \u0437\u0430\u0445\u0430\u0440\u0434\u043a\u043e\u0436\u0435\u043d\u043d\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430. \u0422\u044b \u0441\u0430\u043c \u043d\u0430\u043f\u0438\u0441\u0430\u043b: \u043d\u0435\u043a\u0440\u0443\u0442\u043e \u043a\u043e\u0433\u0434\u0430 @ Transactional \u043c\u043e\u0436\u0435\u0442 \u0430 @ ExecuteInDataSource \u043d\u0435 \u043c\u043e\u0436\u0435\u0442 :)", "author": "pvorlov", "createdAt": "2020-07-30T14:37:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk4Mzc3NQ=="}], "type": "inlineReview"}, {"oid": "810aec83f2b322c9ee5f98b5405dec1b78ae8489", "url": "https://github.com/hhru/nuts-and-bolts/commit/810aec83f2b322c9ee5f98b5405dec1b78ae8489", "message": "HH-113801 no need to set ds in txManager", "committedDate": "2020-07-30T13:14:41Z", "type": "commit"}, {"oid": "810aec83f2b322c9ee5f98b5405dec1b78ae8489", "url": "https://github.com/hhru/nuts-and-bolts/commit/810aec83f2b322c9ee5f98b5405dec1b78ae8489", "message": "HH-113801 no need to set ds in txManager", "committedDate": "2020-07-30T13:14:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwMDE0Ng==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463000146", "bodyText": "\u0414\u0430\u0432\u0430\u0439 \u0443\u0431\u0435\u0440\u0451\u043c \u0438 \u043e\u0441\u0442\u0430\u0432\u0438\u043c \u0434\u0435\u0444\u043e\u043b\u0442\u044b.\n\u0422\u0435 \u0443 \u043a\u043e\u0433\u043e 2 \u0434\u0430\u0442\u0430\u0441\u043e\u0440\u0441\u0430 \u043f\u0443\u0441\u0442\u044c \u0441\u0432\u043e\u0438 \u043a\u043b\u0430\u0441\u0441\u044b \u043f\u0438\u0448\u0443\u0442.", "author": "pvorlov", "createdAt": "2020-07-30T13:35:20Z", "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/transaction/TransactionalScope.java", "diffHunk": "@@ -5,22 +5,22 @@\n \n public class TransactionalScope {\n \n-  @Transactional(readOnly = true)\n+  @Transactional(value = \"transactionManager\", readOnly = true)", "originalCommit": "810aec83f2b322c9ee5f98b5405dec1b78ae8489", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAxNzYyMw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463017623", "bodyText": "\u043d\u0435 \u043f\u043e\u043d\u044f\u043b \u043f\u0440\u043e \u0447\u0442\u043e \u0442\u044b", "author": "dzharikhin", "createdAt": "2020-07-30T14:00:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwMDE0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA0NjI0Mg==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463046242", "bodyText": "\u0423\u0434\u0430\u043b\u0438\u0442\u044c value \u043f\u0440\u0435\u0434\u043b\u0430\u0433\u0430\u044e", "author": "pvorlov", "createdAt": "2020-07-30T14:39:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwMDE0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA1ODI3Nw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463058277", "bodyText": "\u043d\u0443\u0443\u0443.. \u0434\u0430\u0432\u0430\u0439)", "author": "dzharikhin", "createdAt": "2020-07-30T14:56:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwMDE0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwMzM5MA==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463003390", "bodyText": "\u0414\u0443\u043c\u0430\u044e \u043d\u0430\u0434\u043e \u043f\u0440\u0438\u0434\u0443\u0441\u043c\u043e\u0442\u0440\u0435\u0442\u044c \u0441\u043b\u0443\u0447\u0430\u0439 \u043a\u043e\u0433\u0434\u0430 txManager \u0432 \u0430\u043d\u043d\u043e\u0442\u0430\u0446\u0438\u0438 null \u0438\u043b\u0438 \u043f\u0443\u0441\u0442\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430. \u042d\u0442\u043e \u043d\u0435 \u0431\u0443\u0434\u0435\u0442 \u0441\u043a\u043e\u0432\u044b\u0432\u0430\u0442\u044c \u043d\u0430\u0441 \u0432 \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0438 \u0431\u0438\u043d\u0430 \u0435\u0441\u043b\u0438 \u0432\u0441\u0435\u0433\u043e \u043e\u0434\u0438\u043d transactionManager, \u0447\u0442\u043e\u0431\u044b \u0440\u0430\u0431\u043e\u0442\u0430\u043b\u043e \u0430\u043d\u0430\u043b\u043e\u0433\u0438\u0447\u043d\u043e @ Transactional\n\u0415\u0441\u043b\u0438 \u043f\u0443\u0441\u0442\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430 \u0438\u043b\u0438 null \u0438 \u0432 \u043c\u0430\u043f\u043a \u043e\u0434\u0438\u043d \u043c\u0435\u043d\u0435\u0434\u0436\u0435\u0440 - \u0431\u0435\u0440\u0451\u043c \u0435\u0433\u043e\n\u0418\u043d\u0430\u0447\u0435 exception", "author": "pvorlov", "createdAt": "2020-07-30T13:40:10Z", "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/transaction/ExecuteOnDataSourceAspect.java", "diffHunk": "@@ -27,13 +28,15 @@ public Object executeOnSpecialDataSource(final ProceedingJoinPoint pjp, final Ex\n         && TransactionSynchronizationManager.isSynchronizationActive()) {\n       return pjp.proceed();\n     }\n+    DataSourceContextTransactionManager transactionManager = txManagers.get(executeOnDataSource.txManager());", "originalCommit": "810aec83f2b322c9ee5f98b5405dec1b78ae8489", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwODc1Mg==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463008752", "bodyText": "\u0420\u0430\u043d\u044c\u0448\u0435 \u043d\u0430\u0431 \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u043e\u043c \u0441\u043e\u0437\u0434\u0430\u0432\u0430\u043b transactionManager. \u0422\u0443\u043f\u0435\u0440\u044c \u0443 \u043d\u0430\u0441 \u0447\u0430\u0441\u0442\u044c \u0441\u043e\u0437\u0434\u0430\u0451\u0442 nab \u0430 \u0447\u0430\u0441\u0442\u044c \u0441\u043e\u0437\u0434\u0430\u0451\u0442 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435. \u042d\u0442\u043e \u0432\u0435\u0440\u0431\u043e\u0437\u043d\u043e \u0438 \u043d\u0435\u0443\u0434\u043e\u0431\u043d\u043e. \u0427\u0442\u043e \u0435\u0441\u043b\u0438 \u0441\u043e\u0437\u0434\u0430\u0432\u0430\u0442\u044c \u0434\u0438\u043d\u0430\u043c\u0438\u0447\u0435\u0441\u043a\u043e\u0435 \u043a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u0431\u0438\u043d\u043e\u0432 \u0447\u0435\u0440\u0435\u0437 BeanFactoryPostProcessor?", "author": "pvorlov", "createdAt": "2020-07-30T13:48:06Z", "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/NabHibernateCommonConfig.java", "diffHunk": "@@ -6,43 +6,52 @@\n import org.hibernate.SessionFactory;\n import org.hibernate.boot.registry.BootstrapServiceRegistryBuilder;\n import org.hibernate.integrator.spi.Integrator;\n+import org.springframework.context.ApplicationContext;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n import org.springframework.context.annotation.EnableAspectJAutoProxy;\n import org.springframework.orm.hibernate5.HibernateTransactionManager;\n \n import javax.sql.DataSource;\n import java.util.Properties;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n import org.springframework.transaction.annotation.EnableTransactionManagement;\n import ru.hh.nab.hibernate.transaction.DataSourceContextTransactionManager;\n import ru.hh.nab.hibernate.transaction.ExecuteOnDataSourceAspect;\n import ru.hh.nab.hibernate.transaction.TransactionalScope;\n \n+import static java.util.stream.Collectors.toMap;\n+\n @Configuration\n @EnableTransactionManagement(order = 0)\n @EnableAspectJAutoProxy\n public class NabHibernateCommonConfig {\n \n   @Bean\n-  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory, DataSource routingDataSource) {\n+  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory) {", "originalCommit": "810aec83f2b322c9ee5f98b5405dec1b78ae8489", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAxNDE5OQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463014199", "bodyText": "\u0432 \u043d\u0430\u0431\u0435 \u043d\u0435\u0442 \u0446\u0435\u043b\u0438 \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u0430\u0442\u044c \u043c\u043d\u043e\u0433\u043e \u0431\u0430\u0437, \u0447\u0442\u043e\u0431\u044b \u0431\u044b\u043b\u043e \u0443\u0434\u043e\u0431\u043d\u043e. \u0432\u0441\u0435-\u0442\u0430\u043a\u0438 \u0443\u0434\u043e\u0431\u043d\u043e, \u044d\u0442\u043e \u043a\u043e\u0433\u0434\u0430 \u0443 \u0442\u0435\u0431\u044f \u043e\u0434\u043d\u0430 \u0431\u0430\u0437\u0430.\n\u043d\u043e \u0435\u0441\u0442\u044c \u0446\u0435\u043b\u044c \u0441\u0434\u0435\u043b\u0430\u0442\u044c \u0442\u0430\u043a, \u0447\u0442\u043e\u0431\u044b \u0431\u0430\u0437\u0443 \u043c\u043e\u0436\u043d\u043e \u0431\u044b\u043b\u043e \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0438 \u043d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u043e\u0442\u0440\u044b\u0432\u0430\u043b\u043e\u0441\u044c", "author": "dzharikhin", "createdAt": "2020-07-30T13:55:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwODc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA0ODQ1OQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463048459", "bodyText": "\u042d\u0442\u043e \u043d\u0435 \u043f\u0440\u043e\u0442\u0438\u0432\u043e\u0440\u0435\u0447\u0438\u0442 \u0442\u043e\u043c\u0443 \u0447\u0442\u043e \u044f \u043d\u0430\u043f\u0438\u0441\u0430\u043b. \"\u0447\u0442\u043e\u0431\u044b \u0431\u0430\u0437\u0443 \u043c\u043e\u0436\u043d\u043e \u0431\u044b\u043b\u043e \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c\" \u043c\u043e\u0436\u043d\u043e \u0440\u0435\u0430\u043b\u0438\u0437\u043e\u0432\u0430\u0442\u044c \u043f\u043e \u0440\u0430\u0437\u043d\u043e\u043c\u0443:\n\n\u041c\u043e\u0436\u043d\u043e \u043e\u043f\u0438\u0441\u044b\u0432\u0430\u044f SecondRoutingDataSource, SecondTransactionManager, SecondSessionFactory\n\u0410 \u043c\u043e\u0436\u043d\u043e \u043e\u043f\u0438\u0441\u0430\u0432  SecondRoutingDataSource \u0430 SecondTransactionManager, SecondSessionFactory \u0447\u0442\u043e\u0431\u044b \u043d\u0430\u0431 \u0441\u043e\u0437\u0434\u0430\u043b \u0441\u0430\u043c", "author": "pvorlov", "createdAt": "2020-07-30T14:42:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwODc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA3NDA0Nw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463074047", "bodyText": "(2) - \u044d\u0442\u043e \u0443\u0436\u0435 \u043c\u0430\u0433\u0438\u044f. \u041a\u0442\u043e \u0442\u0430\u043c \u043c\u043d\u0435 \u0447\u0442\u043e \u0441\u043e\u0437\u0434\u0430\u043b, \u043a\u0430\u043a \u0441\u043e\u0437\u0434\u0430\u043b, \u043a\u0430\u043a\u043e\u0435 \u0438\u043c\u044f \u043c\u043d\u0435 \u0432 transactional \u043f\u0438\u0441\u0430\u0442\u044c. \u043d\u0435, \u043d\u0435 \u0445\u043e\u0447\u0443.\n\u0445\u043e\u0447\u0435\u0448\u044c \u0432\u0442\u043e\u0440\u0443\u044e \u0431\u0430\u0437\u0443 - \u0443\u0436 3 \u0431\u0438\u043d\u0430 \u043e\u0441\u0438\u043b\u044c, \u043f\u043e\u0436\u0430\u043b\u0443\u0439\u0441\u0442\u0430. \u043f\u043b\u044e\u0441 \u0442\u0430\u043c \u0435\u0449\u0435 \u0432\u0441\u044f\u043a\u043e\u0435 \u0442\u0430\u043a\u043e\u0435 \u0435\u0441\u0442\u044c https://github.com/hhru/nuts-and-bolts/blob/master/nab-hibernate/src/main/java/ru/hh/nab/hibernate/NabHibernateCommonConfig.java#L41-L42\n\u043e\u043d\u043e \u0442\u0435\u0431\u0435 \u0432\u043e\u043e\u0431\u0449\u0435 \u043d\u0435 \u043d\u0430\u0434\u043e \u0440\u0430\u0437 \u0443\u0436 \u0442\u044b \u0432\u0441\u0435 \u0434\u0435\u043b\u0430\u0435\u0448\u044c \u0441\u0430\u043c", "author": "dzharikhin", "createdAt": "2020-07-30T15:18:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwODc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5MTExMQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463091111", "bodyText": "\u0421 \u0438\u043c\u0435\u043d\u0435\u043c \u0434\u0430, \u043d\u0435\u043e\u0447\u0435\u0432\u0438\u0434\u043d\u043e. \u041e\u043a.", "author": "pvorlov", "createdAt": "2020-07-30T15:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwODc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAxMDIwMw==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463010203", "bodyText": "\u0414\u0443\u043c\u0430\u044e \u0432\u0441\u0435 sessionFactory \u0442\u043e\u0436\u0435 \u043d\u0430\u0434\u043e \u0441\u043e\u0437\u0434\u0430\u0432\u0430\u0442\u044c \u0434\u0438\u043d\u0430\u043c\u0438\u0447\u0435\u0441\u043a\u0438 \u0447\u0435\u0440\u0435\u0437 BeanFactoryPostProcessor \u0447\u0442\u043e\u0431\u044b \u0431\u044b\u043b\u043e \u043c\u0435\u043d\u044c\u0448\u0435 \u043a\u043e\u0434\u0430 \u0432 \u0441\u0435\u0440\u0432\u0438\u0441\u0430\u0445", "author": "pvorlov", "createdAt": "2020-07-30T13:50:12Z", "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/NabHibernateCommonConfig.java", "diffHunk": "@@ -6,43 +6,52 @@\n import org.hibernate.SessionFactory;\n import org.hibernate.boot.registry.BootstrapServiceRegistryBuilder;\n import org.hibernate.integrator.spi.Integrator;\n+import org.springframework.context.ApplicationContext;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n import org.springframework.context.annotation.EnableAspectJAutoProxy;\n import org.springframework.orm.hibernate5.HibernateTransactionManager;\n \n import javax.sql.DataSource;\n import java.util.Properties;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n import org.springframework.transaction.annotation.EnableTransactionManagement;\n import ru.hh.nab.hibernate.transaction.DataSourceContextTransactionManager;\n import ru.hh.nab.hibernate.transaction.ExecuteOnDataSourceAspect;\n import ru.hh.nab.hibernate.transaction.TransactionalScope;\n \n+import static java.util.stream.Collectors.toMap;\n+\n @Configuration\n @EnableTransactionManagement(order = 0)\n @EnableAspectJAutoProxy\n public class NabHibernateCommonConfig {\n \n   @Bean\n-  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory, DataSource routingDataSource) {\n+  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory) {\n     HibernateTransactionManager simpleTransactionManager = new HibernateTransactionManager(sessionFactory);\n-    simpleTransactionManager.setDataSource(routingDataSource);\n+    simpleTransactionManager.setAutodetectDataSource(true);\n     return new DataSourceContextTransactionManager(simpleTransactionManager);\n   }\n \n   @Bean\n-  ExecuteOnDataSourceAspect executeOnDataSourceAspect(DataSourceContextTransactionManager transactionManager, SessionFactory sessionFactory) {\n-    return new ExecuteOnDataSourceAspect(transactionManager, sessionFactory);\n+  ExecuteOnDataSourceAspect executeOnDataSourceAspect(ApplicationContext applicationContext) {\n+    var txManagers\n+      = Stream.of(applicationContext.getBeanNamesForType(DataSourceContextTransactionManager.class))\n+        .collect(toMap(Function.identity(), beanName -> applicationContext.getBean(beanName, DataSourceContextTransactionManager.class)));\n+    return new ExecuteOnDataSourceAspect(txManagers);\n   }\n \n   @Bean\n-  NabSessionFactoryBean sessionFactoryBean(DataSource routingDataSource, Properties hibernateProperties,\n+  NabSessionFactoryBean sessionFactory(DataSource dataSource, Properties hibernateProperties,", "originalCommit": "810aec83f2b322c9ee5f98b5405dec1b78ae8489", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9a17651f93eaf9529b6249384db68067460e61f1", "url": "https://github.com/hhru/nuts-and-bolts/commit/9a17651f93eaf9529b6249384db68067460e61f1", "message": "HH-113801 aspect works with one txManager by default", "committedDate": "2020-07-30T14:31:12Z", "type": "commit"}, {"oid": "f9581d54decfe6535ad4cdd5c60e4d778578d06a", "url": "https://github.com/hhru/nuts-and-bolts/commit/f9581d54decfe6535ad4cdd5c60e4d778578d06a", "message": "HH-113801 if u wanna txBean in multi db - DIY", "committedDate": "2020-07-30T14:57:21Z", "type": "commit"}, {"oid": "f9581d54decfe6535ad4cdd5c60e4d778578d06a", "url": "https://github.com/hhru/nuts-and-bolts/commit/f9581d54decfe6535ad4cdd5c60e4d778578d06a", "message": "HH-113801 if u wanna txBean in multi db - DIY", "committedDate": "2020-07-30T14:57:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA2MjAxNg==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463062016", "bodyText": "\u0412\u043e\u0437\u043c\u043e\u0436\u043d\u043e \u043c\u044b\u0441\u043b\u044c \u043f\u043e\u0442\u0435\u0440\u044f\u043b\u0430\u0441\u044c \u0432 \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0445: \u0432\u043e\u0442 \u0442\u0443\u0442 \u044f @ Primary \u043f\u0440\u0435\u0434\u043b\u0430\u0433\u0430\u044e \u043d\u0430\u0432\u0435\u0441\u0438\u0442\u044c.\n\u0422\u043e\u0433\u0434\u0430 \u043c\u043e\u0436\u043d\u043e \u0443\u0431\u0440\u0430\u0442\u044c transactionManager \u0438\u0437 TransactionalScope\n\u041f\u043b\u044e\u0441 \u043d\u0435 \u043d\u0430\u0434\u043e \u0431\u0443\u0434\u0435\u0442 \u0435\u0441\u043b\u0438 \u043d\u0435\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u0434\u0430\u0442\u0430\u0441\u043e\u0440\u0441\u043e\u0432 \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0442\u044c \u0434\u043b\u044f \u0434\u0435\u0444\u043e\u043b\u0442\u043e\u0432\u043e\u0433\u043e \u0432 \u043a\u0430\u0436\u0434\u043e\u043c @ transactional \u0434\u0435\u0444\u043e\u043b\u0442\u043e\u0432\u044b\u0439 TransactionManager", "author": "pvorlov", "createdAt": "2020-07-30T15:01:06Z", "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/NabHibernateCommonConfig.java", "diffHunk": "@@ -6,43 +6,52 @@\n import org.hibernate.SessionFactory;\n import org.hibernate.boot.registry.BootstrapServiceRegistryBuilder;\n import org.hibernate.integrator.spi.Integrator;\n+import org.springframework.context.ApplicationContext;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n import org.springframework.context.annotation.EnableAspectJAutoProxy;\n import org.springframework.orm.hibernate5.HibernateTransactionManager;\n \n import javax.sql.DataSource;\n import java.util.Properties;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n import org.springframework.transaction.annotation.EnableTransactionManagement;\n import ru.hh.nab.hibernate.transaction.DataSourceContextTransactionManager;\n import ru.hh.nab.hibernate.transaction.ExecuteOnDataSourceAspect;\n import ru.hh.nab.hibernate.transaction.TransactionalScope;\n \n+import static java.util.stream.Collectors.toMap;\n+\n @Configuration\n @EnableTransactionManagement(order = 0)\n @EnableAspectJAutoProxy\n public class NabHibernateCommonConfig {\n \n   @Bean", "originalCommit": "9a17651f93eaf9529b6249384db68067460e61f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA2NDcyMQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463064721", "bodyText": "\u0447\u0442\u043e \u0442\u0430\u043a\u043e\u0435 @ Default?", "author": "dzharikhin", "createdAt": "2020-07-30T15:04:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA2MjAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5MTgxNQ==", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463091815", "bodyText": "\u041f\u0435\u0440\u0435\u043c\u0443\u0442\u0430\u043b, \u0441\u043e\u0440\u0438. \u0418\u043c\u0435\u043b \u0432\u0432\u0438\u0434\u0443 @ Primary. (@ Default \u0430\u043d\u0430\u043b\u043e\u0433 @ Primary \u0434\u043b\u044f CDI)", "author": "pvorlov", "createdAt": "2020-07-30T15:43:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA2MjAxNg=="}], "type": "inlineReview"}, {"oid": "f14ca190d1f67249a61713c6801abecf09b8e4f0", "url": "https://github.com/hhru/nuts-and-bolts/commit/f14ca190d1f67249a61713c6801abecf09b8e4f0", "message": "HH-113801 bind to hibernate", "committedDate": "2020-07-30T15:10:45Z", "type": "commit"}, {"oid": "350d1517635c645c1c8d0dae9996e41ed47bffac", "url": "https://github.com/hhru/nuts-and-bolts/commit/350d1517635c645c1c8d0dae9996e41ed47bffac", "message": "HH-113801 use primary as fallback", "committedDate": "2020-07-30T16:31:47Z", "type": "commit"}]}