{"pr_number": 6126, "pr_title": "fix: create /var/lib/kafka-streams directory on RPM installation", "pr_createdAt": "2020-08-31T21:20:03Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6126", "timeline": [{"oid": "d80882283e0fa90ff49af5d8a72ba24625bcee66", "url": "https://github.com/confluentinc/ksql/commit/d80882283e0fa90ff49af5d8a72ba24625bcee66", "message": "fix: create /var/lib/kafka-streams directory on RPM installation", "committedDate": "2020-08-31T21:17:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwODgxMw==", "url": "https://github.com/confluentinc/ksql/pull/6126#discussion_r480408813", "bodyText": "any reason why we removed this?", "author": "agavra", "createdAt": "2020-08-31T21:28:01Z", "path": "debian/confluent-ksqldb.postinst", "diffHunk": "@@ -10,25 +10,28 @@ case \"$1\" in\n \t(getent group $_group 2>&1 >/dev/null) || addgroup --quiet --system $_group\n         adduser --system --disabled-password --disabled-login --home /var/empty \\\n                 --no-create-home --quiet --force-badname --ingroup $_group $_user\n+                \n+  # Set explicit kafka-streams directory if not set\n+  ksqldb_config=/etc/ksqldb/ksql-server.properties\n+  if [ -f $ksqldb_config ]; then\n+    if ! grep '^state.dir=' $ksqldb_config >/dev/null 2>&1; then\n+      echo \"state.dir=/var/lib/kafka-streams\" >> $ksqldb_config\n+    fi\n+  fi                \n \n \t_permwarn=\n-\tfor dir in /var/log/confluent ; do\n-\t    if [ $dir = /var/log/confluent ]; then\n-\t\t# Confluent log directory should be writable by group\n+\tfor dir in /var/log/confluent /var/lib/kafka-streams ; do\n+\t\t# Confluent log and kafka-streams directories should be writable by group\n \t\t_perm=\"chown ${_user}:${_group} $dir && chmod u+wx,g+wx,o= $dir\"\n-\t    else\n-\t\t# Other dirs are only readable by group\n-\t\t_perm=\"chown ${_user}:${_group} $dir && chmod u+wx,g+r,o= $dir\"", "originalCommit": "d80882283e0fa90ff49af5d8a72ba24625bcee66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwODcwMw==", "url": "https://github.com/confluentinc/ksql/pull/6126#discussion_r488108703", "bodyText": "It's not used. It was supposed to set a read-only permission on groups for directories other than /var/log/confluent. But that's the only directory it was used, so this line was never triggered.\nThis was the code before:\nfor dir in /var/log/confluent ; do\n  if [ $dir = /var/log/confluent ]; then\n    // read/write perms\n  else\n    // read-only perms\n  fi", "author": "spena", "createdAt": "2020-09-14T17:37:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwODgxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwODg3Mg==", "url": "https://github.com/confluentinc/ksql/pull/6126#discussion_r480408872", "bodyText": "nit: indentation seems off?", "author": "agavra", "createdAt": "2020-08-31T21:28:09Z", "path": "debian/confluent-ksqldb.postinst", "diffHunk": "@@ -10,25 +10,28 @@ case \"$1\" in\n \t(getent group $_group 2>&1 >/dev/null) || addgroup --quiet --system $_group\n         adduser --system --disabled-password --disabled-login --home /var/empty \\\n                 --no-create-home --quiet --force-badname --ingroup $_group $_user\n+                \n+  # Set explicit kafka-streams directory if not set\n+  ksqldb_config=/etc/ksqldb/ksql-server.properties\n+  if [ -f $ksqldb_config ]; then\n+    if ! grep '^state.dir=' $ksqldb_config >/dev/null 2>&1; then\n+      echo \"state.dir=/var/lib/kafka-streams\" >> $ksqldb_config\n+    fi\n+  fi                \n \n \t_permwarn=\n-\tfor dir in /var/log/confluent ; do\n-\t    if [ $dir = /var/log/confluent ]; then\n-\t\t# Confluent log directory should be writable by group\n+\tfor dir in /var/log/confluent /var/lib/kafka-streams ; do\n+\t\t# Confluent log and kafka-streams directories should be writable by group\n \t\t_perm=\"chown ${_user}:${_group} $dir && chmod u+wx,g+wx,o= $dir\"\n-\t    else\n-\t\t# Other dirs are only readable by group\n-\t\t_perm=\"chown ${_user}:${_group} $dir && chmod u+wx,g+r,o= $dir\"\n-\t    fi\n-\n-\t    if [ ! -d $dir ]; then\n-\t\techo \"Creating directory $dir with owner $_user:$_group\"\n-\t\tmkdir -p $dir\n-\t\teval $_perm\n-\t    else\n-\t\techo \"Notice: Not creating existing directory $dir, ensure proper permissions for user $_user group $_group\"\n-\t\t_permwarn=\"${_permwarn}${_perm}\\n\"\n-\t    fi\n+\n+    if [ ! -d $dir ]; then", "originalCommit": "d80882283e0fa90ff49af5d8a72ba24625bcee66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwNzgwNQ==", "url": "https://github.com/confluentinc/ksql/pull/6126#discussion_r488107805", "bodyText": "Um, editor problems. I fixed them.", "author": "spena", "createdAt": "2020-09-14T17:36:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwODg3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwOTA5Mg==", "url": "https://github.com/confluentinc/ksql/pull/6126#discussion_r480409092", "bodyText": "same as above", "author": "agavra", "createdAt": "2020-08-31T21:28:38Z", "path": "debian/confluent-ksqldb.spec.in", "diffHunk": "@@ -27,16 +27,19 @@ _group=confluent\n getent group $_group 2>&1 >/dev/null || groupadd -r $_group\n getent passwd $_user 2>&1 >/dev/null || \\\n     useradd -r -g $_group --home-dir /tmp --no-create-home -s /sbin/nologin -c \"Confluent KSQL\" $_user\n+    \n+# Set explicit kafka-streams directory if not set\n+ksqldb_config=/etc/ksqldb/ksql-server.properties\n+if [ -f $ksqldb_config ]; then\n+  if ! grep '^state.dir=' $ksqldb_config >/dev/null 2>&1; then\n+    echo \"state.dir=/var/lib/kafka-streams\" >> $ksqldb_config\n+  fi\n+fi    \n \n _permwarn=\n-for dir in /var/log/confluent ; do\n-    if [ $dir = /var/log/confluent ]; then\n-        # Confluent log directory should be writable by group\n-        _perm=\"chown ${_user}:${_group} $dir && chmod u+wx,g+wx,o= $dir\"\n-    else\n-        # Other dirs are only readable by group\n-        _perm=\"chown ${_user}:${_group} $dir && chmod u+wx,g+r,o= $dir\"", "originalCommit": "d80882283e0fa90ff49af5d8a72ba24625bcee66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwOTAwOQ==", "url": "https://github.com/confluentinc/ksql/pull/6126#discussion_r488109009", "bodyText": "Same answer", "author": "spena", "createdAt": "2020-09-14T17:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwOTA5Mg=="}], "type": "inlineReview"}, {"oid": "4f4a6316911c265fc703131026fa600dcdd8281e", "url": "https://github.com/confluentinc/ksql/commit/4f4a6316911c265fc703131026fa600dcdd8281e", "message": "fix: fix indentation", "committedDate": "2020-09-14T17:38:38Z", "type": "commit"}]}