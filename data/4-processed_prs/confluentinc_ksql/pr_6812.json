{"pr_number": 6812, "pr_title": "refactor: Tune Package Relationship", "pr_createdAt": "2020-12-21T21:12:46Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6812", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ1NDI2Ng==", "url": "https://github.com/confluentinc/ksql/pull/6812#discussion_r551454266", "bodyText": "previously, the release process didn't include bumping anything in these files - at a minimum, we should add this as a manual step to the release wiki but that is of course always error prone (as people tend to miss manual steps). Is there any way to either automate this or have an automatic verification that we're not producing duplicate packages? (Or if this is in your plans and this is just something incremental, that is OK as well)", "author": "agavra", "createdAt": "2021-01-04T17:19:24Z", "path": "debian/confluent-ksqldb.spec.in", "diffHunk": "@@ -11,8 +11,7 @@ Vendor: Confluent, Inc.\n Packager: Confluent Packaging <packages@confluent.io>\n BuildArch: noarch\n \n-Requires: confluent-rest-utils\n-\n+Provides: community-ksqldb = 0.14.0", "originalCommit": "420b467941c03636c14f55f8854042993552b651", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ2MzAzNg==", "url": "https://github.com/confluentinc/ksql/pull/6812#discussion_r551463036", "bodyText": "Is there any way to either automate this or have an automatic verification that we're not producing duplicate packages?\n\nI'll do some Makefile hackery so this will be an input into the process to define the value to make it optional.", "author": "andrewegel", "createdAt": "2021-01-04T17:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ1NDI2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ3OTU3OA==", "url": "https://github.com/confluentinc/ksql/pull/6812#discussion_r551479578", "bodyText": "sounds good, feel free to have that as a follow-up or just tacked onto this PR (I assume you're talking about the Makefile in this folder) otherwise LGTM", "author": "agavra", "createdAt": "2021-01-04T18:08:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ1NDI2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEyMTg1Nw==", "url": "https://github.com/confluentinc/ksql/pull/6812#discussion_r552121857", "bodyText": "I spent yesterday attempting to tune things here, but unfortunately Debian doesn't make this very easy to have \"inputs\" to their package metadata (debian/control). Any solution I come up with will be rather ugly here, so for the time being I think we need to march forward with this change (I added 1 more enhancement), as the change still \"improves\" the code base.\nWe can address your concerns in the release job.", "author": "andrewegel", "createdAt": "2021-01-05T18:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ1NDI2Ng=="}], "type": "inlineReview"}, {"oid": "db2e2bbc1160f023bcf80793fb1c565f5718385d", "url": "https://github.com/confluentinc/ksql/commit/db2e2bbc1160f023bcf80793fb1c565f5718385d", "message": "refactor: Tune Package Relationship\n\n- Remove dependency on rest-utils as its not needed.\n- Add Virtual Package \"Provides\" to \"provide\" comminuty-ksqldb release.\n- Conditinalize RPM_VERSION setting.", "committedDate": "2021-01-04T22:30:28Z", "type": "forcePushed"}, {"oid": "c3ba03972cb425097413a16c0f6b520dd368c138", "url": "https://github.com/confluentinc/ksql/commit/c3ba03972cb425097413a16c0f6b520dd368c138", "message": "refactor: Tune Package Relationship\n\n- Remove dependency on rest-utils as its not needed.\n- Add Virtual Package \"Provides\" to \"provide\" comminuty-ksqldb release.\n- Conditinalize RPM_VERSION setting.\n- Fix VERSION default value: Use maven helpers to query project version.", "committedDate": "2021-01-05T17:24:09Z", "type": "forcePushed"}, {"oid": "8e4043b273fe2f56f4c637756543a807daaa90ab", "url": "https://github.com/confluentinc/ksql/commit/8e4043b273fe2f56f4c637756543a807daaa90ab", "message": "refactor: Tune Package Relationship\n\n- Remove dependency on rest-utils as its not needed.\n- Add Virtual Package \"Provides\" to \"provide\" comminuty-ksqldb release.\n- Conditinalize RPM_VERSION setting.\n- Fix VERSION default value: Use maven helpers to query project version.", "committedDate": "2021-01-06T03:57:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg5MjUwMw==", "url": "https://github.com/confluentinc/ksql/pull/6812#discussion_r552892503", "bodyText": "out of curiosity why are we touching these files?", "author": "agavra", "createdAt": "2021-01-06T18:35:22Z", "path": "debian/Makefile", "diffHunk": "@@ -51,13 +52,15 @@ ifeq ($(APPLY_PATCHES),yes)\n \tgit reset --hard HEAD\n \tcat debian/patches/series | xargs -iPATCH bash -c 'patch -p1 < debian/patches/PATCH'\n endif\n+\ttouch apply-patches", "originalCommit": "8e4043b273fe2f56f4c637756543a807daaa90ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjkzNTQ5OQ==", "url": "https://github.com/confluentinc/ksql/pull/6812#discussion_r552935499", "bodyText": "TL:DR: I put these here so when we execute:\n# Build Deb\ngit checkout -b debian-0.14.0-ksqldb origin/0.14.0-ksqldb\ndch --newversion \"6.1.0-0.ksqldb0.14.0\" \"Release version 6.1.0-0.ksqldb0.14.0\"\ndch --release --distribution unstable \"\"\ngit commit ...\ngbp buildpackage -us -uc --git-debian-branch=\"debian-0.14.0-ksqldb\" --git-upstream-tree=0.14.0-ksqldb --git-builder=\"debuild --set-envvar=VERSION=0.14.0  -i -I\"\n# Build RPM\nmake RPM_VERSION=6.1.0 VERSION=0.14.0 PACKAGE_TYPE=rpm REVISION=ksqldb -f debian/Makefile rpm\n# Build ZIP & TGZ\nmake VERSION=0.14.0 PACKAGE_TYPE=archive -f debian/Makefile archive\n\nIn that order, it doesn't have to execute the build target every time I call make (gbp buildpackage uses Make under the hood to build the Debian package), as in we build once (mvn install) then re-use that built-out directly subsequent times.\nLonger:\nGNU Make under the hood looks for a file named the target, if it doesn't find said file, then it executes the rules (under the target) to generate that target, then moves to the next target that required this target to be ran. If the file has a newer timestamp than its upstream targets, it re-executes the target block. Make works this way because it was designed for doing incremental builds for C/C++ code - as in you'd see %.o: %.c targets whose block would run GCC to compile a source file (anything ending in .c) into a object file (a gcc .o object file), which would then be used up higher as a build goal to build a binary executable or a shared library. This way you change a single .c file, and Make (based on timestamps) would deduce what \"things\" to rebuild and re-link.\nThen you have examples like this, where it completely discards that feature of Make, and this is a minor \"hack\" to get things working. The alternative is that it gets rebuilt every time, leading to a (future) longer build & release Pipeline for KSQLDB. There is a minor cost: Developers will need to run make clean in order to get a fresh new build (which I'll add to the clean target), but I doubt that many developers use these code paths often, and are mostly here for Confluent's purposes.", "author": "andrewegel", "createdAt": "2021-01-06T20:02:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg5MjUwMw=="}], "type": "inlineReview"}, {"oid": "8acfa9ee8a1839a9d60737781235f40394b1e87f", "url": "https://github.com/confluentinc/ksql/commit/8acfa9ee8a1839a9d60737781235f40394b1e87f", "message": "refactor: Tune Package Relationship\n\n- Remove dependency on rest-utils as its not needed.\n- Add Virtual Package \"Provides\" to \"provide\" comminuty-ksqldb release.\n- Conditinalize RPM_VERSION setting.\n- Fix VERSION default value: Use maven helpers to query project version.\n- Add touch <target> in build and apply-patches for incremental build\nsupport (otherwise we'd have to rebuild ksql for every package type).\nAlso cleaned this up in the clean target", "committedDate": "2021-01-06T20:07:21Z", "type": "commit"}, {"oid": "8acfa9ee8a1839a9d60737781235f40394b1e87f", "url": "https://github.com/confluentinc/ksql/commit/8acfa9ee8a1839a9d60737781235f40394b1e87f", "message": "refactor: Tune Package Relationship\n\n- Remove dependency on rest-utils as its not needed.\n- Add Virtual Package \"Provides\" to \"provide\" comminuty-ksqldb release.\n- Conditinalize RPM_VERSION setting.\n- Fix VERSION default value: Use maven helpers to query project version.\n- Add touch <target> in build and apply-patches for incremental build\nsupport (otherwise we'd have to rebuild ksql for every package type).\nAlso cleaned this up in the clean target", "committedDate": "2021-01-06T20:07:21Z", "type": "forcePushed"}]}