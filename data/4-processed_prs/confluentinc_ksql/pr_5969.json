{"pr_number": 5969, "pr_title": "feat: add config for suppress buffer", "pr_createdAt": "2020-08-07T21:24:00Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5969", "timeline": [{"oid": "24d5a1410b96115d94f5f6a9bbd002d2e5f82008", "url": "https://github.com/confluentinc/ksql/commit/24d5a1410b96115d94f5f6a9bbd002d2e5f82008", "message": "fix: add config to disable suppress andbound buffer size", "committedDate": "2020-08-06T22:20:38Z", "type": "commit"}, {"oid": "a93ad762c1bd8b01cc8758644ae7c4dad697c745", "url": "https://github.com/confluentinc/ksql/commit/a93ad762c1bd8b01cc8758644ae7c4dad697c745", "message": "fix: add suppress feature flag and buffer configs", "committedDate": "2020-08-07T17:55:40Z", "type": "commit"}, {"oid": "3e8d7343ababddc236b14c54472d9f59cc47a399", "url": "https://github.com/confluentinc/ksql/commit/3e8d7343ababddc236b14c54472d9f59cc47a399", "message": "fix: fix checkstyle", "committedDate": "2020-08-07T18:10:16Z", "type": "commit"}, {"oid": "0ed4ec739b44f5aa591bedfcf7747a3f9781cc85", "url": "https://github.com/confluentinc/ksql/commit/0ed4ec739b44f5aa591bedfcf7747a3f9781cc85", "message": "fix: fix checstyle violation", "committedDate": "2020-08-07T21:22:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMjMxMA==", "url": "https://github.com/confluentinc/ksql/pull/5969#discussion_r467312310", "bodyText": "let's explicitly call out that -1L is \"unbounded\" and also we should describe the failure behavior (i.e. what happens if the bound is filled?)", "author": "agavra", "createdAt": "2020-08-07T22:27:55Z", "path": "ksqldb-common/src/main/java/io/confluent/ksql/util/KsqlConfig.java", "diffHunk": "@@ -304,10 +304,14 @@\n       + \"KSQL metastore backup files are located.\";\n \n   public static final String KSQL_SUPPRESS_ENABLED = \"ksql.suppress.enabled\";\n-  public static final Boolean KSQL_SUPPRESS_ENABLED_DEFAULT = false;\n+  public static final Boolean KSQL_SUPPRESS_ENABLED_DEFAULT = true;\n   public static final String KSQL_SUPPRESS_ENABLED_DOC =\n       \"Feature flag for suppression, specifically EMIT FINAL\";\n \n+  public static final String KSQL_SUPPRESS_BUFFER_SIZE = \"ksql.suppress.buffer.size\";\n+  public static final Long KSQL_SUPPRESS_BUFFER_SIZE_DEFAULT = -1L;\n+  public static final String KSQL_SUPPRESS_BUFFER_SIZE_DOC =\n+      \"Bound the size of the buffer used for suppression\";", "originalCommit": "0ed4ec739b44f5aa591bedfcf7747a3f9781cc85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMjQyMw==", "url": "https://github.com/confluentinc/ksql/pull/5969#discussion_r467312423", "bodyText": "let's just toss in the config name here so that it's easier for people to track it down\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    throw new KsqlException(\"Suppression is currently disabled in the KsqlConfig.\");\n          \n          \n            \n                    throw new KsqlException(\"Suppression is currently disabled. You can enable it by setting \" + KsqlConfig.KSQL_SUPPRESS_ENABLED + \" to true\");", "author": "agavra", "createdAt": "2020-08-07T22:28:26Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/LogicalPlanner.java", "diffHunk": "@@ -143,6 +145,9 @@ public OutputNode buildPlan() {\n \n     if (analysis.getRefinementInfo().isPresent()\n         && analysis.getRefinementInfo().get().getOutputRefinement() == OutputRefinement.FINAL) {\n+      if (!ksqlConfig.getBoolean(KsqlConfig.KSQL_SUPPRESS_ENABLED)) {\n+        throw new KsqlException(\"Suppression is currently disabled in the KsqlConfig.\");", "originalCommit": "0ed4ec739b44f5aa591bedfcf7747a3f9781cc85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMjcwMQ==", "url": "https://github.com/confluentinc/ksql/pull/5969#discussion_r467312701", "bodyText": "nit: used?", "author": "agavra", "createdAt": "2020-08-07T22:29:28Z", "path": "ksqldb-engine/src/test/java/io/confluent/ksql/planner/LogicalPlannerTest.java", "diffHunk": "@@ -45,6 +44,8 @@\n import io.confluent.ksql.util.KsqlException;\n import io.confluent.ksql.util.MetaStoreFixture;\n import java.util.Collections;\n+\n+import org.apache.kafka.common.config.ConfigDef;", "originalCommit": "0ed4ec739b44f5aa591bedfcf7747a3f9781cc85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMjk5Mg==", "url": "https://github.com/confluentinc/ksql/pull/5969#discussion_r467312992", "bodyText": "nit: add //given //when //then", "author": "agavra", "createdAt": "2020-08-07T22:30:30Z", "path": "ksqldb-engine/src/test/java/io/confluent/ksql/planner/LogicalPlannerTest.java", "diffHunk": "@@ -319,6 +323,20 @@ public void shouldThrowOnNonWindowedAggregationSuppressions() {\n \n     assertThat(e.getMessage(), containsString(\"EMIT FINAL is only supported for windowed aggregations.\"));\n   }\n+\n+  @Test\n+  public void shouldThrowOnSuppressDisabledInConfig() {", "originalCommit": "0ed4ec739b44f5aa591bedfcf7747a3f9781cc85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMzEwNA==", "url": "https://github.com/confluentinc/ksql/pull/5969#discussion_r467313104", "bodyText": "I think checkstyle forces this to be final", "author": "agavra", "createdAt": "2020-08-07T22:31:05Z", "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/TableSuppressBuilder.java", "diffHunk": "@@ -91,6 +93,18 @@ public TableSuppressBuilder() {\n             keySerde,\n             valueSerde\n         );\n+\n+    final Suppressed.StrictBufferConfig strictBufferConfig;\n+    long maxBytes = queryBuilder.getKsqlConfig().getLong(KsqlConfig.KSQL_SUPPRESS_BUFFER_SIZE);", "originalCommit": "0ed4ec739b44f5aa591bedfcf7747a3f9781cc85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMzE3MA==", "url": "https://github.com/confluentinc/ksql/pull/5969#discussion_r467313170", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (maxBytes == -1) {\n          \n          \n            \n                if (maxBytes < 0) {\n          \n      \n    \n    \n  \n\nnit: sometimes people typo", "author": "agavra", "createdAt": "2020-08-07T22:31:21Z", "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/TableSuppressBuilder.java", "diffHunk": "@@ -91,6 +93,18 @@ public TableSuppressBuilder() {\n             keySerde,\n             valueSerde\n         );\n+\n+    final Suppressed.StrictBufferConfig strictBufferConfig;\n+    long maxBytes = queryBuilder.getKsqlConfig().getLong(KsqlConfig.KSQL_SUPPRESS_BUFFER_SIZE);\n+\n+    if (maxBytes == -1) {", "originalCommit": "0ed4ec739b44f5aa591bedfcf7747a3f9781cc85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b748f32f4306ab937b2dfd4e3b7a0b73f712561d", "url": "https://github.com/confluentinc/ksql/commit/b748f32f4306ab937b2dfd4e3b7a0b73f712561d", "message": "fix: address feedback", "committedDate": "2020-08-09T19:25:16Z", "type": "commit"}, {"oid": "fed21aeec1d4b025cef42e33b024270542103891", "url": "https://github.com/confluentinc/ksql/commit/fed21aeec1d4b025cef42e33b024270542103891", "message": "fix: add commmit suggestions", "committedDate": "2020-08-09T19:33:10Z", "type": "commit"}, {"oid": "fed21aeec1d4b025cef42e33b024270542103891", "url": "https://github.com/confluentinc/ksql/commit/fed21aeec1d4b025cef42e33b024270542103891", "message": "fix: add commmit suggestions", "committedDate": "2020-08-09T19:33:10Z", "type": "forcePushed"}, {"oid": "59439c38bf8a548b92dd242a72300873e876d497", "url": "https://github.com/confluentinc/ksql/commit/59439c38bf8a548b92dd242a72300873e876d497", "message": "fix: import order", "committedDate": "2020-08-09T19:47:23Z", "type": "commit"}, {"oid": "88eeba0c5cd5f64ffb90d82b8f3d0984d79d0b0a", "url": "https://github.com/confluentinc/ksql/commit/88eeba0c5cd5f64ffb90d82b8f3d0984d79d0b0a", "message": "test: fix tablesuppressbuilder test", "committedDate": "2020-08-09T20:02:47Z", "type": "commit"}, {"oid": "88eeba0c5cd5f64ffb90d82b8f3d0984d79d0b0a", "url": "https://github.com/confluentinc/ksql/commit/88eeba0c5cd5f64ffb90d82b8f3d0984d79d0b0a", "message": "test: fix tablesuppressbuilder test", "committedDate": "2020-08-09T20:02:47Z", "type": "forcePushed"}, {"oid": "79a685dcbece1b4b0cbefc9da07301672e77a925", "url": "https://github.com/confluentinc/ksql/commit/79a685dcbece1b4b0cbefc9da07301672e77a925", "message": "test: fix logical planner test", "committedDate": "2020-08-09T21:17:46Z", "type": "commit"}, {"oid": "79a685dcbece1b4b0cbefc9da07301672e77a925", "url": "https://github.com/confluentinc/ksql/commit/79a685dcbece1b4b0cbefc9da07301672e77a925", "message": "test: fix logical planner test", "committedDate": "2020-08-09T21:17:46Z", "type": "forcePushed"}, {"oid": "d598f70f71bed12d38b477dfbb58bfc5b6bb61bc", "url": "https://github.com/confluentinc/ksql/commit/d598f70f71bed12d38b477dfbb58bfc5b6bb61bc", "message": "Merge branch 'master' into suppress-buffer", "committedDate": "2020-08-09T21:28:37Z", "type": "commit"}]}