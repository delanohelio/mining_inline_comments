{"pr_number": 5138, "pr_title": "refactor: Consolidate API config", "pr_createdAt": "2020-04-22T13:45:28Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5138", "timeline": [{"oid": "d9faaa9729d9f177ac99883d26fed1b5a3f9e379", "url": "https://github.com/confluentinc/ksql/commit/d9faaa9729d9f177ac99883d26fed1b5a3f9e379", "message": "consolidate server config", "committedDate": "2020-04-22T14:52:05Z", "type": "forcePushed"}, {"oid": "cc16a0962f8e196a6c651928995fcbf657d9b3c7", "url": "https://github.com/confluentinc/ksql/commit/cc16a0962f8e196a6c651928995fcbf657d9b3c7", "message": "consolidate server config", "committedDate": "2020-04-22T15:52:46Z", "type": "forcePushed"}, {"oid": "cfb3e50cda40eb59c4e283cae744b18b3122c9ff", "url": "https://github.com/confluentinc/ksql/commit/cfb3e50cda40eb59c4e283cae744b18b3122c9ff", "message": "consolidate server config", "committedDate": "2020-04-22T16:25:30Z", "type": "forcePushed"}, {"oid": "ade18132d95972ed43a06d48f30d7e44ec4ced4e", "url": "https://github.com/confluentinc/ksql/commit/ade18132d95972ed43a06d48f30d7e44ec4ced4e", "message": "consolidate server config", "committedDate": "2020-04-22T19:00:04Z", "type": "forcePushed"}, {"oid": "24181456519ef8c1031576176b4194b4ff01be08", "url": "https://github.com/confluentinc/ksql/commit/24181456519ef8c1031576176b4194b4ff01be08", "message": "consolidate server config", "committedDate": "2020-04-23T08:52:19Z", "type": "forcePushed"}, {"oid": "bca377a4637d4e7f25204d86e0273fa2e772435a", "url": "https://github.com/confluentinc/ksql/commit/bca377a4637d4e7f25204d86e0273fa2e772435a", "message": "consolidate server config", "committedDate": "2020-04-23T09:27:19Z", "type": "forcePushed"}, {"oid": "13dc84c3ade5d71e18fa5372d4f922377f8ecb3c", "url": "https://github.com/confluentinc/ksql/commit/13dc84c3ade5d71e18fa5372d4f922377f8ecb3c", "message": "consolidate server config", "committedDate": "2020-04-23T10:25:04Z", "type": "commit"}, {"oid": "13dc84c3ade5d71e18fa5372d4f922377f8ecb3c", "url": "https://github.com/confluentinc/ksql/commit/13dc84c3ade5d71e18fa5372d4f922377f8ecb3c", "message": "consolidate server config", "committedDate": "2020-04-23T10:25:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI1NDkyNQ==", "url": "https://github.com/confluentinc/ksql/pull/5138#discussion_r414254925", "bodyText": "This PR contains breaking changes, such as this config rename from ssl.client.auth to ssl.client.authentication. Can you add a BREAKING CHANGE: description into the PR description and commit message (when merging this PR) with details?\nI think we should also add a check for the old config (ssl.client.auth) and fail startup if the old config is specified, in order to alert users to the breaking change, since the current behavior of silently ignoring the old config and using the default value of the new config does not seem acceptable.", "author": "vcrfxia", "createdAt": "2020-04-24T02:55:19Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/KsqlRestConfig.java", "diffHunk": "@@ -90,31 +96,28 @@\n \n   public static final String AUTHENTICATION_ROLES_CONFIG = \"authentication.roles\";\n   public static final String AUTHENTICATION_ROLES_DOC = \"Valid roles to authenticate against.\";\n-  public static final List<String> AUTHENTICATION_ROLES_DEFAULT =\n-      Collections.unmodifiableList(Arrays.asList(\"*\"));\n+  public static final List<String> AUTHENTICATION_ROLES_DEFAULT = Collections.singletonList(\"*\");\n \n-  public static final String SSL_KEYSTORE_LOCATION_CONFIG = \"ssl.keystore.location\";\n-  protected static final String SSL_KEYSTORE_LOCATION_DOC =\n-      \"Location of the keystore file to use for SSL. This is required for HTTPS.\";\n   protected static final String SSL_KEYSTORE_LOCATION_DEFAULT = \"\";\n-  public static final String SSL_KEYSTORE_PASSWORD_CONFIG = \"ssl.keystore.password\";\n-  protected static final String SSL_KEYSTORE_PASSWORD_DOC =\n-      \"The store password for the keystore file.\";\n   protected static final String SSL_KEYSTORE_PASSWORD_DEFAULT = \"\";\n \n-  public static final String SSL_TRUSTSTORE_LOCATION_CONFIG = \"ssl.truststore.location\";\n-  protected static final String SSL_TRUSTSTORE_LOCATION_DOC =\n-      \"Location of the trust store. Required only to authenticate HTTPS clients.\";\n   protected static final String SSL_TRUSTSTORE_LOCATION_DEFAULT = \"\";\n-  public static final String SSL_TRUSTSTORE_PASSWORD_CONFIG = \"ssl.truststore.password\";\n-  protected static final String SSL_TRUSTSTORE_PASSWORD_DOC =\n-      \"The store password for the trust store file.\";\n   protected static final String SSL_TRUSTSTORE_PASSWORD_DEFAULT = \"\";\n \n-  public static final String SSL_CLIENT_AUTH_CONFIG = \"ssl.client.auth\";\n-  protected static final String SSL_CLIENT_AUTH_DOC =\n-      \"Whether or not to require the https client to authenticate via the server's trust store.\";\n-  protected static final boolean SSL_CLIENT_AUTH_DEFAULT = false;\n+  public static final String SSL_CLIENT_AUTHENTICATION_CONFIG = \"ssl.client.authentication\";", "originalCommit": "13dc84c3ade5d71e18fa5372d4f922377f8ecb3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMzNTI0MA==", "url": "https://github.com/confluentinc/ksql/pull/5138#discussion_r414335240", "bodyText": "ack", "author": "purplefox", "createdAt": "2020-04-24T06:46:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI1NDkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM1MDQ2Mw==", "url": "https://github.com/confluentinc/ksql/pull/5138#discussion_r414350463", "bodyText": "What I've done is added code so we support the old deprecated client auth and warn in the logs if it's used. Basically the same check that rest-utils does here https://github.com/confluentinc/rest-utils/blob/master/core/src/main/java/io/confluent/rest/ApplicationServer.java#L206\nSo it shouldn't be.a breaking change.", "author": "purplefox", "createdAt": "2020-04-24T07:17:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI1NDkyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcwMTMxMg==", "url": "https://github.com/confluentinc/ksql/pull/5138#discussion_r414701312", "bodyText": "Sounds good, though we should update the docs to introduce the new config and say the old one is deprecated.", "author": "vcrfxia", "createdAt": "2020-04-24T16:21:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI1NDkyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI1NTM5MA==", "url": "https://github.com/confluentinc/ksql/pull/5138#discussion_r414255390", "bodyText": "Do we need a null check on keyStorePassword here (and on trustStorePassword below)? The old code had a null check that's been removed. Haven't looked into whether it's actually needed or not.", "author": "vcrfxia", "createdAt": "2020-04-24T02:56:43Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/Server.java", "diffHunk": "@@ -240,30 +243,32 @@ private static HttpServerOptions createHttpServerOptions(final ApiServerConfig a\n     if (tls) {\n       options.setUseAlpn(true).setSsl(true);\n \n-      final String keyStorePath = apiServerConfig.getString(ApiServerConfig.TLS_KEY_STORE_PATH);\n-      final String keyStorePassword = apiServerConfig\n-          .getString(ApiServerConfig.TLS_KEY_STORE_PASSWORD);\n+      final String keyStorePath = ksqlRestConfig\n+          .getString(SslConfigs.SSL_KEYSTORE_LOCATION_CONFIG);\n+      final Password keyStorePassword = ksqlRestConfig\n+          .getPassword(SslConfigs.SSL_KEYSTORE_PASSWORD_CONFIG);\n       if (keyStorePath != null && !keyStorePath.isEmpty()) {\n         options.setKeyStoreOptions(\n-            new JksOptions().setPath(keyStorePath).setPassword(keyStorePassword));\n+            new JksOptions().setPath(keyStorePath).setPassword(keyStorePassword.value()));", "originalCommit": "13dc84c3ade5d71e18fa5372d4f922377f8ecb3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMzNjAwNw==", "url": "https://github.com/confluentinc/ksql/pull/5138#discussion_r414336007", "bodyText": "I don't think it can be null as the default is \"\".", "author": "purplefox", "createdAt": "2020-04-24T06:48:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI1NTM5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI1NTY0Nw==", "url": "https://github.com/confluentinc/ksql/pull/5138#discussion_r414255647", "bodyText": "nit: can we use KsqlRestConfig.SSL_KEYSTORE_LOCATION_CONFIG instead? And similarly for the other appearances of SslConfigs in this file, and in ListenersTest.java and TlsTest.java.", "author": "vcrfxia", "createdAt": "2020-04-24T02:57:39Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/Server.java", "diffHunk": "@@ -273,7 +278,8 @@ private static HttpServerOptions createHttpServerOptions(final ApiServerConfig a\n           throw new ConfigException(\"Invalid URI scheme should be http or https: \" + listenerName);\n         }\n         if (\"https\".equalsIgnoreCase(scheme)) {\n-          final String keyStoreLocation = config.getString(ApiServerConfig.TLS_KEY_STORE_PATH);\n+          final String keyStoreLocation = config\n+              .getString(SslConfigs.SSL_KEYSTORE_LOCATION_CONFIG);", "originalCommit": "13dc84c3ade5d71e18fa5372d4f922377f8ecb3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMzNjA1OQ==", "url": "https://github.com/confluentinc/ksql/pull/5138#discussion_r414336059", "bodyText": "ack", "author": "purplefox", "createdAt": "2020-04-24T06:48:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI1NTY0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM0ODg4OA==", "url": "https://github.com/confluentinc/ksql/pull/5138#discussion_r414348888", "bodyText": "We don't redefine these constants in KsqlRestConfig - as there doesn't seem to be any point - and we want them to be the same anyway.", "author": "purplefox", "createdAt": "2020-04-24T07:14:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI1NTY0Nw=="}], "type": "inlineReview"}, {"oid": "4d11fb6fce23383614f1a8112cdb171e4e49dc76", "url": "https://github.com/confluentinc/ksql/commit/4d11fb6fce23383614f1a8112cdb171e4e49dc76", "message": "Support the old deprecated client auth and warn if specified", "committedDate": "2020-04-24T07:14:58Z", "type": "commit"}, {"oid": "69cce692be0be51718cbcd574163866e729d95d8", "url": "https://github.com/confluentinc/ksql/commit/69cce692be0be51718cbcd574163866e729d95d8", "message": "small fix", "committedDate": "2020-04-24T07:15:53Z", "type": "commit"}, {"oid": "fcb625b0a47bd5fb69c87841ff6f0fc96c6aec78", "url": "https://github.com/confluentinc/ksql/commit/fcb625b0a47bd5fb69c87841ff6f0fc96c6aec78", "message": "do not support bearer", "committedDate": "2020-04-24T07:18:43Z", "type": "commit"}]}