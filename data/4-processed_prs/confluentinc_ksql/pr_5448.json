{"pr_number": 5448, "pr_title": "feat(client): support (non-streaming) insert into in Java client", "pr_createdAt": "2020-05-20T23:54:57Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5448", "timeline": [{"oid": "8f672934ea44055a2f7b8a7d9371b8ca602387d0", "url": "https://github.com/confluentinc/ksql/commit/8f672934ea44055a2f7b8a7d9371b8ca602387d0", "message": "feat(client): support (non-streaming) insert into in Java client", "committedDate": "2020-05-20T23:28:08Z", "type": "commit"}, {"oid": "1ea812c506f4eba80f866f0a912a33944689d04f", "url": "https://github.com/confluentinc/ksql/commit/1ea812c506f4eba80f866f0a912a33944689d04f", "message": "feat(client): support inserting multiple rows at once", "committedDate": "2020-05-20T23:39:38Z", "type": "commit"}, {"oid": "38accc45ebf2b14874bffa5e903141ecd3e0c86c", "url": "https://github.com/confluentinc/ksql/commit/38accc45ebf2b14874bffa5e903141ecd3e0c86c", "message": "chore: checkstyle and javadocs", "committedDate": "2020-05-20T23:51:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3MjkyNA==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r428372924", "bodyText": "Should this be ERROR_CODE_NOT_FOUND instead?", "author": "vcrfxia", "createdAt": "2020-05-20T23:58:05Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/impl/InsertsStreamEndpoint.java", "diffHunk": "@@ -66,17 +68,20 @@ private DataSource getDataSource(\n   ) {\n     final DataSource dataSource = metaStore.getSource(sourceName);\n     if (dataSource == null) {\n-      throw new KsqlException(\"Cannot insert values into an unknown stream: \"\n-          + sourceName);\n+      throw new KsqlApiException(\n+          \"Cannot insert values into an unknown stream: \" + sourceName, ERROR_CODE_BAD_STATEMENT);", "originalCommit": "38accc45ebf2b14874bffa5e903141ecd3e0c86c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4NzQ2Ng==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r429087466", "bodyText": "I think BAD_STATEMENT is ok. NOT _FOUND is more if the uri doesn't exist.", "author": "purplefox", "createdAt": "2020-05-22T07:30:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM3MjkyNA=="}], "type": "inlineReview"}, {"oid": "3b244de077369605fe07cbe03dbab312c2eb9f10", "url": "https://github.com/confluentinc/ksql/commit/3b244de077369605fe07cbe03dbab312c2eb9f10", "message": "Merge branch 'master' into java-client-insert-stream", "committedDate": "2020-05-21T00:03:51Z", "type": "commit"}, {"oid": "1af46b9f60de725db827aca21fd44c1ed9799bb9", "url": "https://github.com/confluentinc/ksql/commit/1af46b9f60de725db827aca21fd44c1ed9799bb9", "message": "test: fix test", "committedDate": "2020-05-21T16:10:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2Mjc3OA==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r428662778", "bodyText": "Why are we converting to double here? Surely this will lose precision in some cases?", "author": "purplefox", "createdAt": "2020-05-21T13:49:30Z", "path": "ksqldb-api-client/src/main/java/io/confluent/ksql/api/client/KsqlArray.java", "diffHunk": "@@ -282,7 +282,7 @@ public KsqlArray add(final Boolean value) {\n    * @return a reference to this\n    */\n   public KsqlArray add(final BigDecimal value) {\n-    delegate.add(value);\n+    delegate.add(value.doubleValue());", "originalCommit": "3b244de077369605fe07cbe03dbab312c2eb9f10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIzNTA4OA==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r429235088", "bodyText": "The Vert.x JSON types don't accept BigDecimal. For example,\nnew JsonArray().add(new BigDecimal(11.1));\n\nresults in\njava.lang.IllegalStateException: Illegal type in JsonObject: class java.math.BigDecimal\n\n\tat io.vertx.core.json.JsonObject.checkAndCopy(JsonObject.java:1072)\n\tat io.vertx.core.json.JsonArray.add(JsonArray.java:446)", "author": "vcrfxia", "createdAt": "2020-05-22T13:07:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2Mjc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMxNDA3Mg==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r429314072", "bodyText": "What if the BigDecimal is added as a String? Will the row get properly deserialized on the server before inserting?", "author": "purplefox", "createdAt": "2020-05-22T15:28:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2Mjc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2Mjk5MA==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r429362990", "bodyText": "Pretty sure the answer is no but I'll answer more definitely in a follow-up PR -- I've got one in the works to add server and client integration tests for inserting types such as decimal, array, map, etc (and fix a bug the new tests exposed) :)\nGoing to merge this and #5456 first to avoid merge hell with myself.", "author": "vcrfxia", "createdAt": "2020-05-22T17:12:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2Mjc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ4OTg5Mw==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r429489893", "bodyText": "Hey @purplefox I stand corrected! This PR adds integration test coverage for inserting decimals (and also arrays and maps) and works fine if we serialize BigDecimal as a string instead of a double: #5469\nAs mentioned in the PR description, the drawback is that we now have an inconsistency where the decimal type is treated differently in terms of allowable casts, compared to the other numeric types. For example:\nfinal KsqlObject obj = new KsqlObject().put(\"f1\", new BigDecimal(\"1.13\")).put(\"f2\", 12.23);\nSystem.out.println(obj.getString(\"f1\")); // This succeeds\nSystem.out.println(obj.getString(\"f2\")); // This fails with \"java.lang.ClassCastException: java.lang.Double cannot be cast to java.lang.CharSequence\"\n\nI think the drawback is acceptable so I've made the change.", "author": "vcrfxia", "createdAt": "2020-05-22T23:38:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2Mjc3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2MzM0Ng==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r428663346", "bodyText": "Slight optimisation: Use Collections.singletonList", "author": "purplefox", "createdAt": "2020-05-21T13:50:20Z", "path": "ksqldb-api-client/src/main/java/io/confluent/ksql/api/client/impl/ClientImpl.java", "diffHunk": "@@ -118,20 +121,55 @@ public BatchedQueryResult executeQuery(\n   }\n \n   @Override\n-  public CompletableFuture<Void> insertInto(\n-      final String streamName, final Map<String, Object> row) {\n-    return null; // not yet implemented\n+  public CompletableFuture<Void> insertInto(final String streamName, final KsqlObject row) {\n+    final List<KsqlObject> rows = new ArrayList<>();", "originalCommit": "3b244de077369605fe07cbe03dbab312c2eb9f10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4MjgzNQ==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r429082835", "bodyText": "I see that you're waiting for the whole body and parsing it manually here.\nWhen you come to do the streaming insert response this technique won't work and you'll need to use RecordParser - and then you'll end up with two ways of parsing the response.\nI think it would be simpler and easier to just use RecordParser for all cases - this will just spit out the response lines so you don't have to do any manual parsing.", "author": "purplefox", "createdAt": "2020-05-22T07:18:57Z", "path": "ksqldb-api-client/src/main/java/io/confluent/ksql/api/client/impl/ClientImpl.java", "diffHunk": "@@ -213,6 +246,48 @@ private HttpClientRequest configureBasicAuth(final HttpClientRequest request) {\n     }\n   }\n \n+  private static void handleInsertIntoResponse(\n+      final HttpClientResponse response,\n+      final CompletableFuture<Void> cf,\n+      final int numRows\n+  ) {\n+    if (response.statusCode() == OK.code()) {\n+      response.bodyHandler(buffer -> {", "originalCommit": "1af46b9f60de725db827aca21fd44c1ed9799bb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4NjQ3NA==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r429086474", "bodyText": "If we don't support batch inserts, then this becomes a lot simpler too :)", "author": "purplefox", "createdAt": "2020-05-22T07:27:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4MjgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI5Njg0Nw==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r429296847", "bodyText": "Switched to RecordParser. Might have to refactor this again when we support streaming inserts, though. We'll see.", "author": "vcrfxia", "createdAt": "2020-05-22T14:56:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4MjgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4NTkwMw==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r429085903", "bodyText": "I don't think it's useful to have an insertInto method that takes a List of Rows. When inserting rows, the actual inserts can occur our of order, and it's possible that some inserts could succeed and some could fail. Returning a single CompletableFuture means that we couldn't tell the user about individual success or failure of inserts. So on failure, it might be that some of the inserts actually succeeded, leaving the system in an inconsistent state and the user not being able to do anything useful to correct it.\nAt some point I hope we will support transactions on the client. At that point I think it would make sense to support batch inserts like this, but not until then. With transactions we can guarantee that all the inserts succeed or none.", "author": "purplefox", "createdAt": "2020-05-22T07:26:28Z", "path": "ksqldb-api-client/src/main/java/io/confluent/ksql/api/client/Client.java", "diffHunk": "@@ -71,9 +71,32 @@\n    */\n   BatchedQueryResult executeQuery(String sql, Map<String, Object> properties);\n \n-  CompletableFuture<Void> insertInto(String streamName, Map<String, Object> row);\n+  /**\n+   * Inserts a row into a ksqlDB stream.\n+   *\n+   * <p>The {@code CompletableFuture} will be failed if a non-200 response is received from the\n+   * server, or if the server encounters an error while processing the insertion.\n+   *\n+   * @param streamName name of the target stream\n+   * @param row the row to insert. Keys are column names and values are column values.\n+   * @return a future that completes once the server response is received\n+   */\n+  CompletableFuture<Void> insertInto(String streamName, KsqlObject row);\n+\n+  /**\n+   * Inserts the specified row(s) into a ksqlDB stream.\n+   *\n+   * <p>The {@code CompletableFuture} will be failed if a non-200 response is received from the\n+   * server, or if the server encounters an error while processing the insertion(s).\n+   *\n+   * @param streamName name of the target stream\n+   * @param rows the rows to insert. For each row, the keys are column names and values are\n+   *        column values.\n+   * @return a future that completes once the server response is received\n+   */\n+  CompletableFuture<Void> insertInto(String streamName, List<KsqlObject> rows);", "originalCommit": "1af46b9f60de725db827aca21fd44c1ed9799bb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4NjE0OQ==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r429086149", "bodyText": "This is the reason I didn't include a batch insert method like this on the original prototype.", "author": "purplefox", "createdAt": "2020-05-22T07:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4NTkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIzOTgzNQ==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r429239835", "bodyText": "Hmm OK. My reasoning for adding the batch insert was that it seems inefficient to require the users to open a separate HTTP connection for each insert, but I guess once we implement the streaming insert we can encourage them to use that instead. I'll remove the batch insert method in light of your concern that the non-transactional nature will be confusing.", "author": "vcrfxia", "createdAt": "2020-05-22T13:17:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4NTkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI2MDA4MQ==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r429260081", "bodyText": "a separate HTTP connection for each insert\n\nThe client pools connections so it won't use a new one for each insert.", "author": "purplefox", "createdAt": "2020-05-22T13:54:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4NTkwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4OTA1Mg==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r429089052", "bodyText": "The logic here is similar to the failure handler in QueryStreamHandler, perhaps could consider combining it?", "author": "purplefox", "createdAt": "2020-05-22T07:34:12Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/InsertsStreamHandler.java", "diffHunk": "@@ -159,11 +160,17 @@ private void handleArgs(final Buffer buff) {\n \n     private Void handleInsertSubscriberException(final Throwable t,", "originalCommit": "1af46b9f60de725db827aca21fd44c1ed9799bb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI5NzMxNw==", "url": "https://github.com/confluentinc/ksql/pull/5448#discussion_r429297317", "bodyText": "Done -- refactored into ServerUtils.", "author": "vcrfxia", "createdAt": "2020-05-22T14:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4OTA1Mg=="}], "type": "inlineReview"}, {"oid": "a0b9efc9a3d8ce94e26c856533fad4bd3359fa58", "url": "https://github.com/confluentinc/ksql/commit/a0b9efc9a3d8ce94e26c856533fad4bd3359fa58", "message": "chore: remove batch insert", "committedDate": "2020-05-22T13:26:54Z", "type": "commit"}, {"oid": "670642adb46e0b1446c9e27502d77c05a2f50251", "url": "https://github.com/confluentinc/ksql/commit/670642adb46e0b1446c9e27502d77c05a2f50251", "message": "refactor: de-dup server endpoint exception handling", "committedDate": "2020-05-22T13:35:45Z", "type": "commit"}, {"oid": "fc724f00a025e46204703faea01751ca509e8006", "url": "https://github.com/confluentinc/ksql/commit/fc724f00a025e46204703faea01751ca509e8006", "message": "refactor: switch to using RecordParser", "committedDate": "2020-05-22T13:56:57Z", "type": "commit"}, {"oid": "c7cdd95c4a03163f4c0644b44ea9bd7a0e368d82", "url": "https://github.com/confluentinc/ksql/commit/c7cdd95c4a03163f4c0644b44ea9bd7a0e368d82", "message": "refactor: de-dup response handling logic", "committedDate": "2020-05-22T14:49:07Z", "type": "commit"}]}