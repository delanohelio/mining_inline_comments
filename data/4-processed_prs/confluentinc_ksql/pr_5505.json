{"pr_number": 5505, "pr_title": "feat: new UDFs for array max/min/sort", "pr_createdAt": "2020-05-28T21:32:28Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5505", "timeline": [{"oid": "537274c048785b94866ebddff27b584a9b3952fb", "url": "https://github.com/confluentinc/ksql/commit/537274c048785b94866ebddff27b584a9b3952fb", "message": "new UDFs for array max/min/sort", "committedDate": "2020-05-28T21:29:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE2NzQ3MQ==", "url": "https://github.com/confluentinc/ksql/pull/5505#discussion_r432167471", "bodyText": "I'm guessing this isn't the intended description.", "author": "derekjn", "createdAt": "2020-05-28T22:53:50Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/function/udf/array/ArrayMax.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and limitations under the\n+ * License.\n+ */\n+\n+package io.confluent.ksql.function.udf.array;\n+\n+import io.confluent.ksql.function.udf.Udf;\n+import io.confluent.ksql.function.udf.UdfDescription;\n+import io.confluent.ksql.function.udf.UdfParameter;\n+import java.util.List;\n+\n+/**\n+ * This UDF traverses the elements of an Array field to find and return the maximum contained value.\n+ */\n+@UdfDescription(\n+    name = \"array_max\",\n+    description = \"Return the maximum value from within an array of primitive values, according to\"\n+        + \" their natural sort order. If the array is NULL, or contains only NULLs, return NULL.\")\n+public class ArrayMax {\n+\n+  @Udf\n+  public <T extends Comparable<? super T>> T arrayMax(@UdfParameter(\n+      description = \"The array to sort\") final List<T> input) {", "originalCommit": "537274c048785b94866ebddff27b584a9b3952fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3NDc5OA==", "url": "https://github.com/confluentinc/ksql/pull/5505#discussion_r432174798", "bodyText": "good catch, thx!", "author": "blueedgenick", "createdAt": "2020-05-28T23:16:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE2NzQ3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3ODEyNg==", "url": "https://github.com/confluentinc/ksql/pull/5505#discussion_r432178126", "bodyText": "addressed", "author": "blueedgenick", "createdAt": "2020-05-28T23:27:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE2NzQ3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE2NzczOQ==", "url": "https://github.com/confluentinc/ksql/pull/5505#discussion_r432167739", "bodyText": "I'm guessing this isn't the intended description.", "author": "derekjn", "createdAt": "2020-05-28T22:54:41Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/function/udf/array/ArrayMin.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and limitations under the\n+ * License.\n+ */\n+\n+package io.confluent.ksql.function.udf.array;\n+\n+import io.confluent.ksql.function.udf.Udf;\n+import io.confluent.ksql.function.udf.UdfDescription;\n+import io.confluent.ksql.function.udf.UdfParameter;\n+import java.util.List;\n+\n+/**\n+ * This UDF traverses the elements of an Array field to find and return the minimum contained value.\n+ */\n+@UdfDescription(\n+    name = \"array_min\",\n+    description = \"Return the minimum value from within an array of primitive values, according to\"\n+        + \" their natural sort order. If the array is NULL, or contains only NULLs, return NULL.\")\n+public class ArrayMin {\n+\n+  @Udf\n+  public <T extends Comparable<? super T>> T arrayMin(@UdfParameter(\n+      description = \"The array to sort\") final List<T> input) {", "originalCommit": "537274c048785b94866ebddff27b584a9b3952fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3ODE3MA==", "url": "https://github.com/confluentinc/ksql/pull/5505#discussion_r432178170", "bodyText": "fixed", "author": "blueedgenick", "createdAt": "2020-05-28T23:28:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE2NzczOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3MDg0NQ==", "url": "https://github.com/confluentinc/ksql/pull/5505#discussion_r432170845", "bodyText": "I know this array literal isn't intended to be a valid argument, but it may be worth using single quotes here since ARRAY[\"foo\", \"bar\"] wouldn't parse.", "author": "derekjn", "createdAt": "2020-05-28T23:03:58Z", "path": "docs/developer-guide/ksqldb-reference/scalar-functions.md", "diffHunk": "@@ -158,31 +156,60 @@ Given an array, checks if a search value is contained in the array.\n \n Accepts any `ARRAY` type. The type of the second param must match the element type of the `ARRAY`.\n \n-### `JSON_ARRAY_CONTAINS`\n+### `ARRAY_LENGTH`\n \n ```sql\n-JSON_ARRAY_CONTAINS('[1, 2, 3]', 3)\n+ARRAY_LENGTH(ARRAY[1, 2, 3])\n ```\n \n-Given a `STRING` containing a JSON array, checks if a search value is contained in the array.\n+Given an array, return the number of elements in the array.\n \n-Returns `false` if the first parameter does not contain a JSON array.\n+If the supplied parameter is NULL the method returns NULL.\n \n-### `ARRAY`\n+### ``ARRAY_MAX``\n \n ```sql\n-ARRAY[col1, col2, ...]\n+ARRAY_MAX([\"foo\", \"bar\", \"baz\"])\n ```\n \n-Construct an array from a variable number of inputs.\n+Returns the maximum value from within a given array of primitive elements (not arrays of other arrays, or maps, or structs, or combinations thereof). \n \n-### `MAP`\n+Array entries are compared according to their natural sort order, which sorts the various data-types per the following examples:\n+- ```array_max[-1, 2, NULL, 0] -> 2```\n+- ```array_max[false, NULL, true] -> true```\n+- ```array_max[\"Foo\", \"Bar\", NULL, \"baz\"] -> \"baz\"``` (lower-case characters are \"greater\" than upper-case characters)\n+\n+If the array field is NULL, or contains only NULLs, then NULL is returned.\n+\n+### ``ARRAY_MIN``\n \n ```sql\n-MAP(key VARCHAR := value, ...)\n+ARRAY_MIN([\"foo\", \"bar\", \"baz\"])\n ```\n \n-Construct a map from specific key-value tuples.\n+Returns the minimum value from within a given array of primitive elements (not arrays of other arrays, or maps, or structs, or combinations thereof). \n+\n+Array entries are compared according to their natural sort order, which sorts the various data-types per the following examples:\n+- ```array_min[-1, 2, NULL, 0] -> -1```\n+- ```array_min[false, NULL, true] -> false```\n+- ```array_min[\"Foo\", \"Bar\", NULL, \"baz\"] -> \"Bar\"```\n+\n+If the array field is NULL, or contains only NULLs, then NULL is returned.\n+\n+### ``ARRAY_SORT``\n+\n+```sql\n+ARRAY_SORT([\"foo\", \"bar\", \"baz\"])", "originalCommit": "537274c048785b94866ebddff27b584a9b3952fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3ODI1NQ==", "url": "https://github.com/confluentinc/ksql/pull/5505#discussion_r432178255", "bodyText": "fixed all the occurrences i could find", "author": "blueedgenick", "createdAt": "2020-05-28T23:28:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3MDg0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3MTE4Nw==", "url": "https://github.com/confluentinc/ksql/pull/5505#discussion_r432171187", "bodyText": "I think it would be worth adding a note and example or two about the optional ASC or DESC order specifier since that's pretty useful.", "author": "derekjn", "createdAt": "2020-05-28T23:05:08Z", "path": "docs/developer-guide/ksqldb-reference/scalar-functions.md", "diffHunk": "@@ -158,31 +156,60 @@ Given an array, checks if a search value is contained in the array.\n \n Accepts any `ARRAY` type. The type of the second param must match the element type of the `ARRAY`.\n \n-### `JSON_ARRAY_CONTAINS`\n+### `ARRAY_LENGTH`\n \n ```sql\n-JSON_ARRAY_CONTAINS('[1, 2, 3]', 3)\n+ARRAY_LENGTH(ARRAY[1, 2, 3])\n ```\n \n-Given a `STRING` containing a JSON array, checks if a search value is contained in the array.\n+Given an array, return the number of elements in the array.\n \n-Returns `false` if the first parameter does not contain a JSON array.\n+If the supplied parameter is NULL the method returns NULL.\n \n-### `ARRAY`\n+### ``ARRAY_MAX``\n \n ```sql\n-ARRAY[col1, col2, ...]\n+ARRAY_MAX([\"foo\", \"bar\", \"baz\"])\n ```\n \n-Construct an array from a variable number of inputs.\n+Returns the maximum value from within a given array of primitive elements (not arrays of other arrays, or maps, or structs, or combinations thereof). \n \n-### `MAP`\n+Array entries are compared according to their natural sort order, which sorts the various data-types per the following examples:\n+- ```array_max[-1, 2, NULL, 0] -> 2```\n+- ```array_max[false, NULL, true] -> true```\n+- ```array_max[\"Foo\", \"Bar\", NULL, \"baz\"] -> \"baz\"``` (lower-case characters are \"greater\" than upper-case characters)\n+\n+If the array field is NULL, or contains only NULLs, then NULL is returned.\n+\n+### ``ARRAY_MIN``\n \n ```sql\n-MAP(key VARCHAR := value, ...)\n+ARRAY_MIN([\"foo\", \"bar\", \"baz\"])\n ```\n \n-Construct a map from specific key-value tuples.\n+Returns the minimum value from within a given array of primitive elements (not arrays of other arrays, or maps, or structs, or combinations thereof). \n+\n+Array entries are compared according to their natural sort order, which sorts the various data-types per the following examples:\n+- ```array_min[-1, 2, NULL, 0] -> -1```\n+- ```array_min[false, NULL, true] -> false```\n+- ```array_min[\"Foo\", \"Bar\", NULL, \"baz\"] -> \"Bar\"```\n+\n+If the array field is NULL, or contains only NULLs, then NULL is returned.\n+\n+### ``ARRAY_SORT``\n+\n+```sql\n+ARRAY_SORT([\"foo\", \"bar\", \"baz\"])\n+```\n+\n+Given an array of primitive elements (not arrays of other arrays, or maps, or structs, or combinations thereof), returns an array of the same elements sorted according to their natural sort order. Any NULLs contained in the array will always be moved to the end.", "originalCommit": "537274c048785b94866ebddff27b584a9b3952fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3NjUyMA==", "url": "https://github.com/confluentinc/ksql/pull/5505#discussion_r432176520", "bodyText": "yep, oversight on my part. adding now", "author": "blueedgenick", "createdAt": "2020-05-28T23:22:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3MTE4Nw=="}], "type": "inlineReview"}, {"oid": "942e68fc6bf780f1e96e53f8ecdbbcc8fd866b3a", "url": "https://github.com/confluentinc/ksql/commit/942e68fc6bf780f1e96e53f8ecdbbcc8fd866b3a", "message": "fix minor checkstyle thing - not sure why this one didn't show up locally", "committedDate": "2020-05-28T23:14:26Z", "type": "commit"}, {"oid": "bc617e4d5964e2bf9c73e92c8aad65c89c61c60a", "url": "https://github.com/confluentinc/ksql/commit/bc617e4d5964e2bf9c73e92c8aad65c89c61c60a", "message": "address Derek's feedback", "committedDate": "2020-05-28T23:27:12Z", "type": "commit"}, {"oid": "67802daf5c598f356f79a47078db72d29097da4b", "url": "https://github.com/confluentinc/ksql/commit/67802daf5c598f356f79a47078db72d29097da4b", "message": "add pointless historical plan files", "committedDate": "2020-05-29T19:26:59Z", "type": "commit"}]}