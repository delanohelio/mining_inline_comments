{"pr_number": 6726, "pr_title": "feat: Adds table scans to pull queries", "pr_createdAt": "2020-12-05T00:28:41Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6726", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMyOTg2NQ==", "url": "https://github.com/confluentinc/ksql/pull/6726#discussion_r545329865", "bodyText": "Can we please add Javadocs for this class? It's getting more and more complex and for a first-timer looking at it, it's impossible to figure out what the purpose of the class is, what the algorithm is and what the methods and data structures represent", "author": "vpapavas", "createdAt": "2020-12-17T18:59:34Z", "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/materialization/ks/KsLocator.java", "diffHunk": "@@ -43,12 +48,14 @@\n import org.apache.kafka.streams.KafkaStreams;\n import org.apache.kafka.streams.KeyQueryMetadata;\n import org.apache.kafka.streams.state.HostInfo;\n+import org.apache.kafka.streams.state.StreamsMetadata;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n /**\n  * Kafka Streams implementation of {@link Locator}.\n  */", "originalCommit": "cf5af26e00bfc4728ced4bb8c06fdb210a6effe5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUyNTY3Mw==", "url": "https://github.com/confluentinc/ksql/pull/6726#discussion_r551525673", "bodyText": "Sure.  Added many more comments.", "author": "AlanConfluent", "createdAt": "2021-01-04T19:38:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMyOTg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzMTg5MA==", "url": "https://github.com/confluentinc/ksql/pull/6726#discussion_r545331890", "bodyText": "We should add tests in KsLocatorTest to make sure that the data structures are populated correctly with all active and standby partitions the underlying store has", "author": "vpapavas", "createdAt": "2020-12-17T19:02:50Z", "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/materialization/ks/KsLocator.java", "diffHunk": "@@ -108,20 +146,42 @@\n \n       keysByPartition.putIfAbsent(metadata.partition(), new LinkedHashSet<>());\n       keysByPartition.get(metadata.partition()).add(key);\n+      metadataList.add(metadata);\n+    }\n+    return new Metadata(metadataList, Optional.of(keysByPartition));\n+  }\n \n-      if (locationsByPartition.containsKey(metadata.partition())) {\n-        continue;\n-      }\n+  private Metadata getMetadataForAllPartitions(final Set<Integer> filterPartitions) {", "originalCommit": "cf5af26e00bfc4728ced4bb8c06fdb210a6effe5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYwODIzOQ==", "url": "https://github.com/confluentinc/ksql/pull/6726#discussion_r551608239", "bodyText": "Good call.  Forgot to test that.  Added a test that covers this case.", "author": "AlanConfluent", "createdAt": "2021-01-04T22:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzMTg5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzMjQ4Mg==", "url": "https://github.com/confluentinc/ksql/pull/6726#discussion_r545332482", "bodyText": "Why is this?", "author": "vpapavas", "createdAt": "2020-12-17T19:03:51Z", "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/materialization/ks/KsMaterializedSessionTable.java", "diffHunk": "@@ -65,6 +66,12 @@\n     }\n   }\n \n+  @Override\n+  public Iterator<WindowedRow> get(final int partition, final Range<Instant> windowStartBounds,\n+      final Range<Instant> windowEndBounds) {\n+    throw new MaterializationException(\"Table scan unsupported on session tables\");", "originalCommit": "cf5af26e00bfc4728ced4bb8c06fdb210a6effe5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzMDU0Mg==", "url": "https://github.com/confluentinc/ksql/pull/6726#discussion_r551630542", "bodyText": "Session tables don't support table scans at the moment.  They have to be added in the future.  I think our only choice for now is to throw an error.", "author": "AlanConfluent", "createdAt": "2021-01-04T23:33:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzMjQ4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzNjU4Nw==", "url": "https://github.com/confluentinc/ksql/pull/6726#discussion_r545336587", "bodyText": "What's the purpose of this iterator? Why do we need a special class? I see that this is used to close the iterator? Aren't iterators closed when done automatically?", "author": "vpapavas", "createdAt": "2020-12-17T19:10:49Z", "path": "ksqldb-common/src/main/java/io/confluent/ksql/util/IteratorUtil.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.util;\n+\n+import com.google.common.collect.ImmutableList;\n+import java.util.Iterator;\n+import java.util.NoSuchElementException;\n+\n+public final class IteratorUtil {\n+\n+  private IteratorUtil() {}\n+\n+  public static <T> Iterator<T> onComplete(final Iterator<T> iterator, final Runnable runnable) {\n+    return new IteratorWithCallbacks<T>(iterator, runnable);\n+  }\n+\n+  public static <T> Iterator<T> of(final T... elements) {\n+    return ImmutableList.copyOf(elements).iterator();\n+  }\n+\n+  private static class IteratorWithCallbacks<T> implements Iterator<T> {\n+\n+    private final Iterator<T> backingIterator;\n+    private final Runnable completeRunnable;", "originalCommit": "cf5af26e00bfc4728ced4bb8c06fdb210a6effe5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUyNTM2MA==", "url": "https://github.com/confluentinc/ksql/pull/6726#discussion_r551525360", "bodyText": "Normal iterators don't have a close method.  The ones returned by streams do after a lookup.  Previously, I believe we were using the auto close functionality but this requires iterating through it all in one shot.  In this case, since we're returning an iterator, we aren't just returning one big complete list of rows so we can't rely on that.  Also, once we do everything async, we may not even consume all of the rows before the client closes the connection.\nSo to address this, I created a callback mechanism on the iterator that calls the callback on completion.  In this case, it does it for the special streams close call, which otherwise wouldn't be called.", "author": "AlanConfluent", "createdAt": "2021-01-04T19:37:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzNjU4Nw=="}], "type": "inlineReview"}, {"oid": "49cf640bd647997150ef24dcfa20e28a5556c267", "url": "https://github.com/confluentinc/ksql/commit/49cf640bd647997150ef24dcfa20e28a5556c267", "message": "feat: Adds table scans to pull queries", "committedDate": "2021-01-05T00:17:11Z", "type": "commit"}, {"oid": "413ae02cb0de152fcb074ee26da280479ca663d4", "url": "https://github.com/confluentinc/ksql/commit/413ae02cb0de152fcb074ee26da280479ca663d4", "message": "Adds rest query translation tests", "committedDate": "2021-01-05T00:24:45Z", "type": "commit"}, {"oid": "0480cc59d7cae9cf3c99bc485d9b7bd0995983ac", "url": "https://github.com/confluentinc/ksql/commit/0480cc59d7cae9cf3c99bc485d9b7bd0995983ac", "message": "Deletes whereinfo change since it's not necessary", "committedDate": "2021-01-05T00:25:42Z", "type": "commit"}, {"oid": "13a100be429805c7497e69efed3f688db6f4e5fc", "url": "https://github.com/confluentinc/ksql/commit/13a100be429805c7497e69efed3f688db6f4e5fc", "message": "Addresses feedback", "committedDate": "2021-01-05T00:25:42Z", "type": "commit"}, {"oid": "83c0914a8baff7891f08f0f7ce1ace80040a1750", "url": "https://github.com/confluentinc/ksql/commit/83c0914a8baff7891f08f0f7ce1ace80040a1750", "message": "Refactors to not use KeyQueryMetadata everywhere", "committedDate": "2021-01-05T00:25:42Z", "type": "commit"}, {"oid": "c15ca6aafcd45fd090672cd979a41e745f95fb9f", "url": "https://github.com/confluentinc/ksql/commit/c15ca6aafcd45fd090672cd979a41e745f95fb9f", "message": "Remove alan test file", "committedDate": "2021-01-05T00:28:26Z", "type": "commit"}, {"oid": "dcacda696c6f8f312539f4193d93ac09aae780a1", "url": "https://github.com/confluentinc/ksql/commit/dcacda696c6f8f312539f4193d93ac09aae780a1", "message": "Fix compile after rebase", "committedDate": "2021-01-05T01:26:54Z", "type": "commit"}, {"oid": "dcacda696c6f8f312539f4193d93ac09aae780a1", "url": "https://github.com/confluentinc/ksql/commit/dcacda696c6f8f312539f4193d93ac09aae780a1", "message": "Fix compile after rebase", "committedDate": "2021-01-05T01:26:54Z", "type": "forcePushed"}, {"oid": "fb6c9bd18027fcce3fdb5ec2a83610fc8f66f032", "url": "https://github.com/confluentinc/ksql/commit/fb6c9bd18027fcce3fdb5ec2a83610fc8f66f032", "message": "Fix warning, reworked some locator code", "committedDate": "2021-01-05T03:38:35Z", "type": "commit"}, {"oid": "3b763baa314551bf3bf7d292906c889cf21ec551", "url": "https://github.com/confluentinc/ksql/commit/3b763baa314551bf3bf7d292906c889cf21ec551", "message": "Remove bad import", "committedDate": "2021-01-05T17:53:39Z", "type": "commit"}, {"oid": "10d02968aa275823e35dfaa295909dbfc309f922", "url": "https://github.com/confluentinc/ksql/commit/10d02968aa275823e35dfaa295909dbfc309f922", "message": "Fix test", "committedDate": "2021-01-05T18:15:30Z", "type": "commit"}, {"oid": "4ea5a6701efdfd6a8d738726d500f57bf71f2695", "url": "https://github.com/confluentinc/ksql/commit/4ea5a6701efdfd6a8d738726d500f57bf71f2695", "message": "Get old message back for tests", "committedDate": "2021-01-05T19:16:18Z", "type": "commit"}]}