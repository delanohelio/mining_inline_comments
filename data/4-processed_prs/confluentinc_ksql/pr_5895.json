{"pr_number": 5895, "pr_title": "fix: adds a handler to gracefully shutdown", "pr_createdAt": "2020-07-29T08:38:13Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5895", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM0MTc3Mw==", "url": "https://github.com/confluentinc/ksql/pull/5895#discussion_r462341773", "bodyText": "Was it a bug that this was here previously, since it means triggerShutdown() was being called from both StandaloneExecutor and KsqlServerMain? (Checking my understanding for why this was removed.)", "author": "vcrfxia", "createdAt": "2020-07-29T14:27:02Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/StandaloneExecutor.java", "diffHunk": "@@ -129,12 +129,17 @@ public void startAsync() {\n       versionChecker.start(KsqlModuleType.SERVER, properties);\n     } catch (final Exception e) {\n       log.error(\"Failed to start KSQL Server with query file: \" + queriesFile, e);\n-      triggerShutdown();", "originalCommit": "c36cb530e7611b76b7f3dd07bf8d471c827b3a3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2MzQ0OA==", "url": "https://github.com/confluentinc/ksql/pull/5895#discussion_r462563448", "bodyText": "I don't think it's a bug necessarily (since triggerShutdown is idempotent). Just not needed.", "author": "rodesai", "createdAt": "2020-07-29T20:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM0MTc3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM0NDgyMA==", "url": "https://github.com/confluentinc/ksql/pull/5895#discussion_r462344820", "bodyText": "I'm not understanding this test. Are we missing an expectLastCall(); after this line?", "author": "vcrfxia", "createdAt": "2020-07-29T14:30:51Z", "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/server/KsqlServerMainTest.java", "diffHunk": "@@ -90,6 +96,23 @@ public void shouldStopAppOnErrorStarting() throws Exception {\n     verify(executable);\n   }\n \n+  @Test\n+  public void shouldNotifyAppOnTerminate() throws Exception {\n+    // Given:\n+    final Capture<Runnable> captureShutdownHandler = newCapture();\n+    shutdownHandler.execute(capture(captureShutdownHandler));\n+    executable.notifyTerminated();", "originalCommit": "c36cb530e7611b76b7f3dd07bf8d471c827b3a3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2NjQwOQ==", "url": "https://github.com/confluentinc/ksql/pull/5895#discussion_r462566409", "bodyText": "oof yeah - fixed", "author": "rodesai", "createdAt": "2020-07-29T20:24:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM0NDgyMA=="}], "type": "inlineReview"}, {"oid": "cd96c84757b80a822103116e06ab5608fccae1e3", "url": "https://github.com/confluentinc/ksql/commit/cd96c84757b80a822103116e06ab5608fccae1e3", "message": "fix: adds a handler to gracefully shutdown service\n\nCouple changes related to application lifecycle management. Firstly, adds a shutdown handler\nthat gracefully shuts down the service when the jvm determines its time to shut down (e.g.\nwhen it receives a termination signal). Secondly, this patch reorganizes some of the startup,\nsteady-state, and shutdown code to make shutdown easier to reason about. Specifically, all\nthese methods are now called from the same thread, so both the thread-safety and order of\nexecution are guaranteed. All the shutdown hook does is notify the main thread and then wait\nfor it to exit.", "committedDate": "2020-07-29T19:48:43Z", "type": "commit"}, {"oid": "39f91cd06f6313cbecaf278629d5eb374e2527cf", "url": "https://github.com/confluentinc/ksql/commit/39f91cd06f6313cbecaf278629d5eb374e2527cf", "message": "review feedback", "committedDate": "2020-07-29T20:17:16Z", "type": "commit"}, {"oid": "39f91cd06f6313cbecaf278629d5eb374e2527cf", "url": "https://github.com/confluentinc/ksql/commit/39f91cd06f6313cbecaf278629d5eb374e2527cf", "message": "review feedback", "committedDate": "2020-07-29T20:17:16Z", "type": "forcePushed"}, {"oid": "5ed1ce09e55a9bb2c92841fb7aacc2918393b349", "url": "https://github.com/confluentinc/ksql/commit/5ed1ce09e55a9bb2c92841fb7aacc2918393b349", "message": "don't wait for terminates during the test", "committedDate": "2020-07-30T03:00:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE2Mzg3Mw==", "url": "https://github.com/confluentinc/ksql/pull/5895#discussion_r463163873", "bodyText": "Should we use CAS if startAsync is mistakenly triggered multiple times?", "author": "guozhangwang", "createdAt": "2020-07-30T17:41:21Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/KsqlRestApplication.java", "diffHunk": "@@ -305,7 +304,7 @@ public void startAsync() {\n         pullQueryExecutor\n     );\n \n-    startAsyncThread = Thread.currentThread();\n+    startAsyncThreadRef.set(Thread.currentThread());", "originalCommit": "5ed1ce09e55a9bb2c92841fb7aacc2918393b349", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyMDg2NA==", "url": "https://github.com/confluentinc/ksql/pull/5895#discussion_r465320864", "bodyText": "Makes sense. We could move this to be the first thing in the method and then throw if it's ever non-null.", "author": "rodesai", "createdAt": "2020-08-04T20:47:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE2Mzg3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE3NTY5Ng==", "url": "https://github.com/confluentinc/ksql/pull/5895#discussion_r463175696", "bodyText": "For my own clarification: why we design tryStartApp itself to be blocking until shutdown, instead of letting this function to return after startup procedure completed, and then having another shutdown function that block until shutdown completes?", "author": "guozhangwang", "createdAt": "2020-07-30T18:01:35Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/KsqlServerMain.java", "diffHunk": "@@ -55,29 +58,46 @@ public static void main(final String[] args) {\n       final Optional<String> queriesFile = serverOptions.getQueriesFile(properties);\n       final Executable executable = createExecutable(\n           properties, queriesFile, installDir, ksqlConfig);\n-      new KsqlServerMain(executable).tryStartApp();\n+      new KsqlServerMain(\n+          executable,\n+          r -> Runtime.getRuntime().addShutdownHook(new Thread(r))\n+      ).tryStartApp();\n     } catch (final Exception e) {\n       log.error(\"Failed to start KSQL\", e);\n       System.exit(-1);\n     }\n   }\n \n-  KsqlServerMain(final Executable executable) {\n+  KsqlServerMain(final Executable executable, final Executor shutdownHandler) {\n     this.executable = Objects.requireNonNull(executable, \"executable\");\n+    this.shutdownHandler = Objects.requireNonNull(shutdownHandler, \"shutdownHandler\");\n   }\n \n   void tryStartApp() throws Exception {\n+    final CountDownLatch latch = new CountDownLatch(1);", "originalCommit": "5ed1ce09e55a9bb2c92841fb7aacc2918393b349", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxOTAwNw==", "url": "https://github.com/confluentinc/ksql/pull/5895#discussion_r465319007", "bodyText": "I think this might just be my C background talking, but the pattern I've gotten used to is to have the main thread own the application's lifecycle. It starts up all services, waits for a notification to initiate shutdown, and then orchestrates the shutdown process. This pattern makes a great deal of sense in that world because usually you'd write your shutdown in response to a signal, and a signal handler should not block. I think following this pattern in Java makes sense too for the following reasons:\n\nI wasn't totally sure what constraints the jvm would run the shutdown thread under. It seemed simplest to just have it do as little as possible and let the main thread manage shutdown\nThis gives you the guarantee that start is only ever called before shutdown, so it's easier to reason about the two (no synchronization needed, don't need to worry about entering start after calling shutdown).", "author": "rodesai", "createdAt": "2020-08-04T20:43:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE3NTY5Ng=="}], "type": "inlineReview"}]}