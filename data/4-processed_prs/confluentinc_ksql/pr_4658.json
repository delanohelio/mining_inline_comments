{"pr_number": 4658, "pr_title": "fix: don't cleanup topics on engine close", "pr_createdAt": "2020-02-27T17:41:41Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4658", "timeline": [{"oid": "876a543f89d9b47135680f4adc719641fd8dab29", "url": "https://github.com/confluentinc/ksql/commit/876a543f89d9b47135680f4adc719641fd8dab29", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>", "committedDate": "2020-02-27T17:42:50Z", "type": "forcePushed"}, {"oid": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513", "url": "https://github.com/confluentinc/ksql/commit/7c7a222a12fcdc10a14fae39e5c7a722a2ab7513", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>", "committedDate": "2020-02-27T17:46:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NDcxNA==", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385274714", "bodyText": "How about?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                verifyNoMoreInteractions(closeCallback);\n          \n          \n            \n                verify(kafkaStreams).close(Duration.ofMillis(closeTimeout));\n          \n          \n            \n                verify(closeCallback, never()).accept(any());\n          \n      \n    \n    \n  \n\nOr add another test that checks ks.close is called on stop.", "author": "big-andy-coates", "createdAt": "2020-02-27T17:56:09Z", "path": "ksql-engine/src/test/java/io/confluent/ksql/util/QueryMetadataTest.java", "diffHunk": "@@ -136,6 +137,15 @@ public void shouldCloseKStreamsAppOnCloseThenCloseCallback() {\n     inOrder.verify(closeCallback).accept(query);\n   }\n \n+  @Test\n+  public void shouldNotCallCloseCallbackOnStop() {\n+    // When:\n+    query.stop();\n+\n+    // Then:\n+    verifyNoMoreInteractions(closeCallback);", "originalCommit": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4MjQxOQ==", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385282419", "bodyText": "Added an additional test", "author": "agavra", "createdAt": "2020-02-27T18:10:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NDcxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NTYwNw==", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385275607", "bodyText": "I'd be tempted to make this abstract and move this impl to PersistentQuery.\nNo biggie, just feels cleaner to me.", "author": "big-andy-coates", "createdAt": "2020-02-27T17:57:41Z", "path": "ksql-engine/src/main/java/io/confluent/ksql/util/QueryMetadata.java", "diffHunk": "@@ -169,14 +169,41 @@ public boolean hasEverBeenStarted() {\n     return everStarted;\n   }\n \n-  public void close() {\n+\n+  /**\n+   * Stops the query without cleaning up the external resources\n+   * so that it can be resumed when we call {@link #start()}.\n+   *\n+   * <p>NOTE: {@link TransientQueryMetadata} overrides this method\n+   * since any time a transient query is stopped the external resources\n+   * should be cleaned up.</p>\n+   *\n+   * @see #close()\n+   */\n+  public void stop() {\n+    close(false);\n+  }", "originalCommit": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4MTY3OQ==", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385281679", "bodyText": "I wanted to do that, but there's a place where QueryMetadata is actually being instantiated directly. Not sure if that's a bug, but I didn't want to deal with it now.", "author": "agavra", "createdAt": "2020-02-27T18:09:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NTYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5NDAyMQ==", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385294021", "bodyText": "Really? Sounds like a bug!", "author": "big-andy-coates", "createdAt": "2020-02-27T18:32:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NTYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMwNzIzNQ==", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385307235", "bodyText": "Looks like this is used from the new API code: for transient queries. So this should default to cleaning up internal topics.", "author": "big-andy-coates", "createdAt": "2020-02-27T18:57:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NTYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMwOTI3OQ==", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385309279", "bodyText": "so we should switch this to close(true) as we want transient queries to delete internal state.\nThis will also mean we need to remove the overloaded version from TransientQueryMetadata and add the following overload to PersistentQueryMetadata\n@Override\npublic void stop() {\n    close(false);\n  }", "author": "big-andy-coates", "createdAt": "2020-02-27T19:01:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NTYwNw=="}], "type": "inlineReview"}, {"oid": "a6ae256e6e19b62b228e463007e95dde9ca6bbdb", "url": "https://github.com/confluentinc/ksql/commit/a6ae256e6e19b62b228e463007e95dde9ca6bbdb", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>", "committedDate": "2020-02-27T18:08:27Z", "type": "forcePushed"}, {"oid": "de929b12aa00384f5451d34698bc2bd4c73d87f1", "url": "https://github.com/confluentinc/ksql/commit/de929b12aa00384f5451d34698bc2bd4c73d87f1", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>\nCo-authored-by: Andy Coates <big-andy-coates@users.noreply.github.com>", "committedDate": "2020-02-27T18:08:48Z", "type": "forcePushed"}, {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312", "url": "https://github.com/confluentinc/ksql/commit/d237f85079583fd3c1f9af72ea2f0cab02240312", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>\nCo-authored-by: Andy Coates <big-andy-coates@users.noreply.github.com>", "committedDate": "2020-02-27T18:11:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4OTEyMQ==", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385289121", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                verify(topicClient, times(0)).deleteInternalTopics(any());\n          \n          \n            \n                verify(topicClient, never()).deleteInternalTopics(any());", "author": "big-andy-coates", "createdAt": "2020-02-27T18:23:47Z", "path": "ksql-engine/src/test/java/io/confluent/ksql/engine/KsqlEngineTest.java", "diffHunk": "@@ -676,6 +677,64 @@ public void shouldCleanUpInternalTopicsOnClose() {\n     verify(topicClient).deleteInternalTopics(query.getQueryApplicationId());\n   }\n \n+  @Test\n+  public void shouldCleanUpInternalTopicsOnEngineCloseForTransientQueries() {\n+    // Given:\n+    final QueryMetadata query = KsqlEngineTestUtil.executeQuery(\n+        serviceContext,\n+        ksqlEngine,\n+        \"select * from test1 EMIT CHANGES;\",\n+        KSQL_CONFIG, Collections.emptyMap()\n+    );\n+\n+    query.start();\n+\n+    // When:\n+    ksqlEngine.close();\n+\n+    // Then:\n+    verify(topicClient).deleteInternalTopics(query.getQueryApplicationId());\n+    verifyNoMoreInteractions(topicClient);\n+  }\n+\n+  @Test\n+  public void shouldNotCleanUpInternalTopicsOnEngineCloseForPersistentQueries() {\n+    // Given:\n+    final List<QueryMetadata> query = KsqlEngineTestUtil.execute(\n+        serviceContext,\n+        ksqlEngine,\n+        \"create stream persistent as select * from test1 EMIT CHANGES;\",\n+        KSQL_CONFIG, Collections.emptyMap()\n+    );\n+\n+    query.get(0).start();\n+\n+    // When:\n+    ksqlEngine.close();\n+\n+    // Then (there are no transient queries, so no internal topics should be deleted):\n+    verify(topicClient, times(0)).deleteInternalTopics(any());", "originalCommit": "d237f85079583fd3c1f9af72ea2f0cab02240312", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5MDAxNg==", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385290016", "bodyText": "nit: not necessary.", "author": "big-andy-coates", "createdAt": "2020-02-27T18:25:28Z", "path": "ksql-engine/src/test/java/io/confluent/ksql/engine/KsqlEngineTest.java", "diffHunk": "@@ -676,6 +677,64 @@ public void shouldCleanUpInternalTopicsOnClose() {\n     verify(topicClient).deleteInternalTopics(query.getQueryApplicationId());\n   }\n \n+  @Test\n+  public void shouldCleanUpInternalTopicsOnEngineCloseForTransientQueries() {\n+    // Given:\n+    final QueryMetadata query = KsqlEngineTestUtil.executeQuery(\n+        serviceContext,\n+        ksqlEngine,\n+        \"select * from test1 EMIT CHANGES;\",\n+        KSQL_CONFIG, Collections.emptyMap()\n+    );\n+\n+    query.start();\n+\n+    // When:\n+    ksqlEngine.close();\n+\n+    // Then:\n+    verify(topicClient).deleteInternalTopics(query.getQueryApplicationId());\n+    verifyNoMoreInteractions(topicClient);", "originalCommit": "d237f85079583fd3c1f9af72ea2f0cab02240312", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5MDM1Mg==", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385290352", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                verify(kafkaStreams, times(0)).cleanUp();\n          \n          \n            \n                verify(kafkaStreams, never()).cleanUp();", "author": "big-andy-coates", "createdAt": "2020-02-27T18:26:05Z", "path": "ksql-engine/src/test/java/io/confluent/ksql/util/QueryMetadataTest.java", "diffHunk": "@@ -147,6 +167,15 @@ public void shouldCleanUpKStreamsAppAfterCloseOnClose() {\n     inOrder.verify(kafkaStreams).cleanUp();\n   }\n \n+  @Test\n+  public void shouldNotCleanUpKStreamsAppOnStop() {\n+    // When:\n+    query.stop();\n+\n+    // Then:\n+    verify(kafkaStreams, times(0)).cleanUp();", "originalCommit": "d237f85079583fd3c1f9af72ea2f0cab02240312", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5MDU1Mw==", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385290553", "bodyText": "If the order is important, then I'd test the order too...", "author": "big-andy-coates", "createdAt": "2020-02-27T18:26:27Z", "path": "ksql-engine/src/test/java/io/confluent/ksql/util/TransientQueryMetadataTest.java", "diffHunk": "@@ -87,4 +88,22 @@ public void shouldCloseQueueBeforeTopologyToAvoidDeadLock() {\n     inOrder.verify(rowQueue).close();\n     inOrder.verify(kafkaStreams).close(any());\n   }\n+\n+  @Test\n+  public void shouldCleanupOnStop() {\n+    // When:\n+    query.stop();\n+\n+    // Then:\n+    verify(kafkaStreams).close(any());\n+  }\n+\n+  @Test\n+  public void shouldCallCallbackOnStop() {\n+    // When:\n+    query.stop();\n+\n+    // Then:\n+    verify(closeCallback).accept(query);\n+  }", "originalCommit": "d237f85079583fd3c1f9af72ea2f0cab02240312", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0b52acefa514182556c7ea1ee3d85d5fa6ff75fc", "url": "https://github.com/confluentinc/ksql/commit/0b52acefa514182556c7ea1ee3d85d5fa6ff75fc", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>\nCo-authored-by: Andy Coates <big-andy-coates@users.noreply.github.com>", "committedDate": "2020-02-27T18:30:15Z", "type": "commit"}, {"oid": "0b52acefa514182556c7ea1ee3d85d5fa6ff75fc", "url": "https://github.com/confluentinc/ksql/commit/0b52acefa514182556c7ea1ee3d85d5fa6ff75fc", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>\nCo-authored-by: Andy Coates <big-andy-coates@users.noreply.github.com>", "committedDate": "2020-02-27T18:30:15Z", "type": "forcePushed"}, {"oid": "f52591d832c91c97907a60fe21362596958851b2", "url": "https://github.com/confluentinc/ksql/commit/f52591d832c91c97907a60fe21362596958851b2", "message": "chore: make QMD abstract", "committedDate": "2020-02-27T19:20:19Z", "type": "commit"}, {"oid": "f52591d832c91c97907a60fe21362596958851b2", "url": "https://github.com/confluentinc/ksql/commit/f52591d832c91c97907a60fe21362596958851b2", "message": "chore: make QMD abstract", "committedDate": "2020-02-27T19:20:19Z", "type": "forcePushed"}]}