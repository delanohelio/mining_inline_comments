{"pr_number": 4653, "pr_title": "fix: CommandRunner metric has correct metric displayed when thread dies", "pr_createdAt": "2020-02-27T00:06:38Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4653", "timeline": [{"oid": "6d5be45a44999d20fa56bedbae547ab21cd5ef2f", "url": "https://github.com/confluentinc/ksql/commit/6d5be45a44999d20fa56bedbae547ab21cd5ef2f", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead", "committedDate": "2020-02-27T00:09:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1NTE5MA==", "url": "https://github.com/confluentinc/ksql/pull/4653#discussion_r384855190", "bodyText": "Can we just get rid of this and set the status to ERROR if we haven't polled in a while?", "author": "rodesai", "createdAt": "2020-02-27T00:50:33Z", "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java", "diffHunk": "@@ -262,12 +266,15 @@ private void terminateCluster(final Command command) {\n   CommandRunnerStatus checkCommandRunnerStatus() {\n     final Pair<QueuedCommand, Instant> currentCommand = currentCommandRef.get();\n     if (currentCommand == null) {\n-      return CommandRunnerStatus.RUNNING;\n+      return lastPollTime.get() == null ||\n+          Duration.between(lastPollTime.get(), clock.instant()).toMillis()\n+              < NEW_CMDS_TIMEOUT.toMillis() * 3\n+              ? CommandRunnerStatus.RUNNING : CommandRunnerStatus.ERROR;", "originalCommit": "6d5be45a44999d20fa56bedbae547ab21cd5ef2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5NDc2MQ==", "url": "https://github.com/confluentinc/ksql/pull/4653#discussion_r385294761", "bodyText": "We only start polling after we processPriorCommands so this could still be useful in the case of the CommandRunner getting stuck on start up.", "author": "stevenpyzhang", "createdAt": "2020-02-27T18:34:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1NTE5MA=="}], "type": "inlineReview"}, {"oid": "9251d032407d07d8dd98933a62d46dcbe7b608a8", "url": "https://github.com/confluentinc/ksql/commit/9251d032407d07d8dd98933a62d46dcbe7b608a8", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead", "committedDate": "2020-02-27T20:40:23Z", "type": "forcePushed"}, {"oid": "11155cf8812cab889acfd8d0543e42471fe02bda", "url": "https://github.com/confluentinc/ksql/commit/11155cf8812cab889acfd8d0543e42471fe02bda", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead", "committedDate": "2020-02-27T23:26:53Z", "type": "forcePushed"}, {"oid": "235f5bdf83b4586825a4c871ff5afcea46b94cc5", "url": "https://github.com/confluentinc/ksql/commit/235f5bdf83b4586825a4c871ff5afcea46b94cc5", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead", "committedDate": "2020-02-28T00:38:11Z", "type": "forcePushed"}, {"oid": "eda865dbdd2d9d75438991912a0a619045dd7133", "url": "https://github.com/confluentinc/ksql/commit/eda865dbdd2d9d75438991912a0a619045dd7133", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead", "committedDate": "2020-03-02T20:05:01Z", "type": "forcePushed"}, {"oid": "aef463889aa45bffeddfa292b21a5a66fb0953cc", "url": "https://github.com/confluentinc/ksql/commit/aef463889aa45bffeddfa292b21a5a66fb0953cc", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead", "committedDate": "2020-03-02T21:24:41Z", "type": "forcePushed"}, {"oid": "310350de5286cbfea06c125e649fab82cabf575d", "url": "https://github.com/confluentinc/ksql/commit/310350de5286cbfea06c125e649fab82cabf575d", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead", "committedDate": "2020-03-02T21:51:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIzODk0NQ==", "url": "https://github.com/confluentinc/ksql/pull/4653#discussion_r387238945", "bodyText": "why do we need this additional status? Once it's here we have to support it forever. Why is it not enough to know that the runner is up or down?", "author": "rodesai", "createdAt": "2020-03-03T19:20:05Z", "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java", "diffHunk": "@@ -64,11 +64,13 @@\n \n   private final CommandRunnerStatusMetric commandRunnerStatusMetric;\n   private final AtomicReference<Pair<QueuedCommand, Instant>> currentCommandRef;\n+  private final AtomicReference<Instant> lastPollTime;\n   private final Duration commandRunnerHealthTimeout;\n   private final Clock clock;\n \n   public enum CommandRunnerStatus {\n     RUNNING,\n+    STUCK,", "originalCommit": "310350de5286cbfea06c125e649fab82cabf575d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg5MTU1OA==", "url": "https://github.com/confluentinc/ksql/pull/4653#discussion_r387891558", "bodyText": "I thought it would be helpful to be able to tell the difference between if the CommandRunner thread is stuck on a particular Command or the thread itself has died.\nIf we do force the server to shut down whenever the CommandRunner thread dies, then this additional status won't be needed.", "author": "stevenpyzhang", "createdAt": "2020-03-04T19:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIzODk0NQ=="}], "type": "inlineReview"}, {"oid": "b69ad12a61c3309dadeca5422bcd6b976f2163ab", "url": "https://github.com/confluentinc/ksql/commit/b69ad12a61c3309dadeca5422bcd6b976f2163ab", "message": "fix: CommandRunner metric has correct metric displayed when thread dies", "committedDate": "2020-03-18T22:03:07Z", "type": "commit"}, {"oid": "b69ad12a61c3309dadeca5422bcd6b976f2163ab", "url": "https://github.com/confluentinc/ksql/commit/b69ad12a61c3309dadeca5422bcd6b976f2163ab", "message": "fix: CommandRunner metric has correct metric displayed when thread dies", "committedDate": "2020-03-18T22:03:07Z", "type": "forcePushed"}, {"oid": "11c084996cca1669fbe9e59bcfd98a6644b1c74f", "url": "https://github.com/confluentinc/ksql/commit/11c084996cca1669fbe9e59bcfd98a6644b1c74f", "message": "get rid of the stuck status", "committedDate": "2020-03-20T18:40:48Z", "type": "commit"}, {"oid": "11c084996cca1669fbe9e59bcfd98a6644b1c74f", "url": "https://github.com/confluentinc/ksql/commit/11c084996cca1669fbe9e59bcfd98a6644b1c74f", "message": "get rid of the stuck status", "committedDate": "2020-03-20T18:40:48Z", "type": "forcePushed"}]}