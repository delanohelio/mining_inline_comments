{"pr_number": 5533, "pr_title": "Explicit keys", "pr_createdAt": "2020-06-03T00:42:14Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5533", "timeline": [{"oid": "2dd637e9cf239345d5574a57edf9336fa6f6851a", "url": "https://github.com/confluentinc/ksql/commit/2dd637e9cf239345d5574a57edf9336fa6f6851a", "message": "feat: explicit keys\n\nimplements: [KLIP-29](https://github.com/confluentinc/ksql/pull/5530)\n\nfixes: https://github.com/confluentinc/ksql/issues/5303\nfixes: https://github.com/confluentinc/ksql/issues/4678\n\nThis change sees ksqlDB no longer adding an implicit `ROWKEY STRING` key column to created streams or primary key column to created tables when no key column is explicitly provided in the `CREATE` statement.\n\nBREAKING CHANGE\n\n`CREATE TABLE` statements will now fail if not `PRIMARY KEY` column is provided.\n\nFor example, a statement such as:\n\n```sql\nCREATE TABLE FOO (name STRING) WITH (kafka_topic='foo', value_format='json');\n```\n\nWill need to be updated to include the definition of the PRIMARY KEY, e.g.\n\n```sql\nCREATE TABLE FOO (ID STRING PRIMARY KEY, name STRING) WITH (kafka_topic='foo', value_format='json');\n```\n\nIf using schema inference, i.e. loading the value columns of the topic from the Schema Registry, the primary key can be provided as a partial schema, e.g.\n\n```sql\n-- FOO will have value columns loaded from the Schema Registry\nCREATE TABLE FOO (ID INT PRIMARY KEY) WITH (kafka_topic='foo', value_format='avro');\n```\n\n`CREATE STREAM` statements that do not define a `KEY` column will no longer have an implicit `ROWKEY` key column.\n\nFor example:\n\n```sql\nCREATE STREAM BAR (NAME STRING) WITH (...);\n```\n\nThe above statement would previously have resulted in a stream with two columns: `ROWKEY STRING KEY` and `NAME STRING`.\nWith this change the above statement will result in a stream with only the `NAME STRING` column.\n\nStreams will no KEY column will be serialized to Kafka topics with a `null` key.", "committedDate": "2020-06-03T00:40:10Z", "type": "commit"}, {"oid": "97b86a3ba5fb79c3da5561f5888bd28441db72c5", "url": "https://github.com/confluentinc/ksql/commit/97b86a3ba5fb79c3da5561f5888bd28441db72c5", "message": "docs: docs", "committedDate": "2020-06-03T00:40:27Z", "type": "commit"}, {"oid": "e952d9133ae0ab5f60957f82acfbd91223062e89", "url": "https://github.com/confluentinc/ksql/commit/e952d9133ae0ab5f60957f82acfbd91223062e89", "message": "test: test changes", "committedDate": "2020-06-03T00:41:05Z", "type": "commit"}, {"oid": "6ddfdeef9514ecbcd830709afb628da8e06428f0", "url": "https://github.com/confluentinc/ksql/commit/6ddfdeef9514ecbcd830709afb628da8e06428f0", "message": "test: historical plans", "committedDate": "2020-06-03T00:41:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI2MjcwNg==", "url": "https://github.com/confluentinc/ksql/pull/5533#discussion_r434262706", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    {\"topic\": \"input\", \"key\": null, \"value\": {\"ID\": 1, \"F0\": 2}}\n          \n          \n            \n                    {\"topic\": \"input\", \"key\": null, \"value\": {\"ID\": 1, \"F0\": 2}},\n          \n          \n            \n                    {\"topic\": \"input\", \"key\": \"foo\", \"value\": {\"ID\": 1, \"F0\": 2}}\n          \n      \n    \n    \n  \n\nlet's also test what happens when there is a key in the message but one isn't declared", "author": "agavra", "createdAt": "2020-06-03T01:39:03Z", "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/elements.json", "diffHunk": "@@ -859,6 +859,52 @@\n           {\"name\": \"OUTPUT\", \"type\": \"stream\", \"schema\": \"ID INT KEY, ID_COPY INT\"}\n         ]\n       }\n+    },\n+    {\n+      \"name\": \"table without primary key fails\",\n+      \"statements\": [\n+        \"CREATE TABLE INPUT (ID INT, F0 INT) WITH (kafka_topic='input', value_format='JSON');\"\n+      ],\n+      \"expectedException\": {\n+        \"type\": \"io.confluent.ksql.util.KsqlStatementException\",\n+        \"message\": \"Tables require a PRIMARY KEY. Please define the PRIMARY KEY.\"\n+      }\n+    },\n+    {\n+      \"name\": \"table without primary key fails - schema inference\",\n+      \"statements\": [\n+        \"CREATE TABLE INPUT WITH (kafka_topic='input', value_format='Avro');\"\n+      ],\n+      \"topics\": [\n+        {\n+          \"name\": \"input\",\n+          \"schema\": {\"name\": \"blah\", \"type\": \"record\", \"fields\": [{\"name\": \"c1\", \"type\": \"int\"}]},\n+          \"format\": \"AVRO\"\n+        }\n+      ],\n+      \"expectedException\": {\n+        \"type\": \"io.confluent.ksql.util.KsqlException\",\n+        \"message\": \"Tables require a PRIMARY KEY. Please define the PRIMARY KEY.\\nUse a partial schema to define the primary key and still load the value columns from the Schema Registry, for example:\\n\\tCREATE TABLE INPUT (ID INT PRIMARY KEY) WITH (...);\"\n+      }\n+    },\n+    {\n+      \"name\": \"stream without key column\",\n+      \"statements\": [\n+        \"CREATE STREAM INPUT (ID INT, F0 INT) WITH (kafka_topic='input', value_format='JSON');\",\n+        \"CREATE STREAM OUTPUT AS SELECT * FROM INPUT;\"\n+      ],\n+      \"inputs\": [\n+        {\"topic\": \"input\", \"key\": null, \"value\": {\"ID\": 1, \"F0\": 2}}", "originalCommit": "e952d9133ae0ab5f60957f82acfbd91223062e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQyMDExOQ==", "url": "https://github.com/confluentinc/ksql/pull/5533#discussion_r434420119", "bodyText": "sure.", "author": "big-andy-coates", "createdAt": "2020-06-03T09:06:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI2MjcwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI2MzU4Ng==", "url": "https://github.com/confluentinc/ksql/pull/5533#discussion_r434263586", "bodyText": "dont want to be too picky, but let's also add a stream no-key --> table join", "author": "agavra", "createdAt": "2020-06-03T01:42:49Z", "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/joins.json", "diffHunk": "@@ -1966,6 +1966,26 @@\n       \"outputs\": [\n         {\"topic\": \"OUTPUT\", \"key\": \"user_0\", \"value\": {\"IMPRESSION_ID\": 24, \"URL\": \"urlA\"}, \"timestamp\":  12}\n       ]\n+    },\n+    {\n+      \"name\": \"streams with no key columns\",", "originalCommit": "e952d9133ae0ab5f60957f82acfbd91223062e89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ0MjM2OQ==", "url": "https://github.com/confluentinc/ksql/pull/5533#discussion_r434442369", "bodyText": "done", "author": "big-andy-coates", "createdAt": "2020-06-03T09:43:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI2MzU4Ng=="}], "type": "inlineReview"}, {"oid": "2f5ac03f6f5f9e2f2ca3cfbe977c71352463d2da", "url": "https://github.com/confluentinc/ksql/commit/2f5ac03f6f5f9e2f2ca3cfbe977c71352463d2da", "message": "Merge branch 'master' into explicit_keys", "committedDate": "2020-06-03T08:45:26Z", "type": "commit"}, {"oid": "e2819615d98deadbd379b02d150e8690dc549eeb", "url": "https://github.com/confluentinc/ksql/commit/e2819615d98deadbd379b02d150e8690dc549eeb", "message": "Merge branch 'master' into explicit_keys", "committedDate": "2020-06-03T09:06:08Z", "type": "commit"}, {"oid": "48853b4b3369d4fd978bf1ed30504a3022631792", "url": "https://github.com/confluentinc/ksql/commit/48853b4b3369d4fd978bf1ed30504a3022631792", "message": "chore: requested changes", "committedDate": "2020-06-03T09:40:11Z", "type": "commit"}]}