{"pr_number": 4216, "pr_title": "perf: Improves pull query performance by making the default schema service a singleton", "pr_createdAt": "2020-01-03T22:11:07Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4216", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM3MzM0Mg==", "url": "https://github.com/confluentinc/ksql/pull/4216#discussion_r363373342", "bodyText": "If we're adding a factory method, can we make the constructor private or package private?", "author": "big-andy-coates", "createdAt": "2020-01-06T16:34:52Z", "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/context/KsqlRestServiceContextBinder.java", "diffHunk": "@@ -31,9 +35,19 @@\n public class KsqlRestServiceContextBinder extends AbstractBinder {\n   public KsqlRestServiceContextBinder(\n       final KsqlConfig ksqlConfig,\n-      final KsqlSecurityExtension securityExtension\n+      final KsqlSecurityExtension securityExtension,\n+      final Supplier<SchemaRegistryClient> schemaRegistryClientSupplier\n   ) {\n-    KsqlRestServiceContextFactory.configure(ksqlConfig, securityExtension);\n+    KsqlRestServiceContextFactory.configure(ksqlConfig, securityExtension,\n+        schemaRegistryClientSupplier);\n+  }\n+\n+  public static BiFunction<KsqlConfig, KsqlSecurityExtension, Binder> createFactory(", "originalCommit": "f38dff4a83f0e03a2597b33307ce142458842598", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkxNTcxMw==", "url": "https://github.com/confluentinc/ksql/pull/4216#discussion_r363915713", "bodyText": "Done", "author": "AlanConfluent", "createdAt": "2020-01-07T19:37:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM3MzM0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM3NDY2MA==", "url": "https://github.com/confluentinc/ksql/pull/4216#discussion_r363374660", "bodyText": "nit: add null check please", "author": "big-andy-coates", "createdAt": "2020-01-06T16:37:55Z", "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/resources/streaming/WSQueryEndpoint.java", "diffHunk": "@@ -178,7 +184,8 @@ public WSQueryEndpoint(\n     this.defaultServiceContextFactory =\n         Objects.requireNonNull(defaultServiceContextFactory, \"defaultServiceContextFactory\");\n     this.serverState = Objects.requireNonNull(serverState, \"serverState\");\n-    this.errorHandler = Objects.requireNonNull(errorHandler, \"errorHandler\");;\n+    this.errorHandler = Objects.requireNonNull(errorHandler, \"errorHandler\");\n+    this.schemaRegistryClientSupplier = schemaRegistryClientSupplier;", "originalCommit": "f38dff4a83f0e03a2597b33307ce142458842598", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkzMjA3Mg==", "url": "https://github.com/confluentinc/ksql/pull/4216#discussion_r363932072", "bodyText": "Added", "author": "AlanConfluent", "createdAt": "2020-01-07T20:17:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM3NDY2MA=="}], "type": "inlineReview"}, {"oid": "7f17c6186bf1ebf2e2ce4383c8c67f36ec8a19ed", "url": "https://github.com/confluentinc/ksql/commit/7f17c6186bf1ebf2e2ce4383c8c67f36ec8a19ed", "message": "perf: Improves pull query performance by making the schema registry client a singleton.", "committedDate": "2020-01-08T01:29:57Z", "type": "forcePushed"}, {"oid": "fb0d936f2c5850e0c2e825181faccdad9dd0a73e", "url": "https://github.com/confluentinc/ksql/commit/fb0d936f2c5850e0c2e825181faccdad9dd0a73e", "message": "perf: Improves pull query performance by making the schema registry client a singleton.", "committedDate": "2020-01-08T21:06:51Z", "type": "forcePushed"}, {"oid": "e00cbe4e15635d0d5a7852c45d0e20ca5774bf4b", "url": "https://github.com/confluentinc/ksql/commit/e00cbe4e15635d0d5a7852c45d0e20ca5774bf4b", "message": "perf: Improves pull query performance by making the schema registry client a singleton.", "committedDate": "2020-01-08T21:49:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ2NTg3NA==", "url": "https://github.com/confluentinc/ksql/pull/4216#discussion_r364465874", "bodyText": "I can't add a comment in the dispose method. But you have to make sure not to close this default serviceContext on the dispose. The dispose is called after a REST request finished.\nBtw, could you rename this variable to defaultServiceContext or serverServiceContext? so we know this is used as the default.", "author": "spena", "createdAt": "2020-01-08T22:03:52Z", "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/context/KsqlSecurityContextBinderFactory.java", "diffHunk": "@@ -89,10 +88,7 @@ public KsqlSecurityContext provide() {\n         Optional.ofNullable(request.getHeader(HttpHeaders.AUTHORIZATION));\n \n     if (!securityExtension.getUserContextProvider().isPresent()) {\n-      return new KsqlSecurityContext(\n-          Optional.ofNullable(principal),\n-          defaultServiceContextFactory.create(ksqlConfig, authHeader)\n-      );\n+      return new KsqlSecurityContext(Optional.ofNullable(principal), serviceContext);", "originalCommit": "e00cbe4e15635d0d5a7852c45d0e20ca5774bf4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3MDQzNQ==", "url": "https://github.com/confluentinc/ksql/pull/4216#discussion_r364470435", "bodyText": "Removed the dispose.  Sorry, forgot that from our conversation.\nRenamed as well.", "author": "AlanConfluent", "createdAt": "2020-01-08T22:16:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ2NTg3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ2ODQ5OA==", "url": "https://github.com/confluentinc/ksql/pull/4216#discussion_r364468498", "bodyText": "I think this createFactory method is not necessary. The default serviceContext is passed to the KsqlRestApplication in the previous line. With that, you can configure the KsqlSecurityContextBinder in the configureBaseApplication method like:\nconfig.register(serviceContextBinderFactory.apply(ksqlConfigNoPort, securityExtension, serviceContext));", "author": "spena", "createdAt": "2020-01-08T22:10:58Z", "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/KsqlRestApplication.java", "diffHunk": "@@ -469,7 +470,7 @@ static KsqlRestApplication buildApplication(\n         versionCheckerFactory,\n         Integer.MAX_VALUE,\n         serviceContext,\n-        KsqlSecurityContextBinder::new);\n+        KsqlSecurityContextBinder.createFactory(serviceContext));", "originalCommit": "e00cbe4e15635d0d5a7852c45d0e20ca5774bf4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3MzU5OA==", "url": "https://github.com/confluentinc/ksql/pull/4216#discussion_r364473598", "bodyText": "Ah, yeah.  I was kind of trying to fit the existing types, but you're right.  Simplified to:\nconfig.register(new KsqlSecurityContextBinder(\n        ksqlConfigNoPort, securityExtension, serviceContext));", "author": "AlanConfluent", "createdAt": "2020-01-08T22:24:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ2ODQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUzNDE1NA==", "url": "https://github.com/confluentinc/ksql/pull/4216#discussion_r364534154", "bodyText": "Doesn't work quite that way, per our below discussion.", "author": "AlanConfluent", "createdAt": "2020-01-09T02:25:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ2ODQ5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ2OTA1OA==", "url": "https://github.com/confluentinc/ksql/pull/4216#discussion_r364469058", "bodyText": "Is this necessary if we you pass all the require parameters during the construction of the class?", "author": "spena", "createdAt": "2020-01-08T22:12:26Z", "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/context/KsqlSecurityContextBinder.java", "diffHunk": "@@ -31,9 +34,17 @@\n public class KsqlSecurityContextBinder extends AbstractBinder {\n   public KsqlSecurityContextBinder(\n       final KsqlConfig ksqlConfig,\n-      final KsqlSecurityExtension securityExtension\n+      final KsqlSecurityExtension securityExtension,\n+      final ServiceContext serviceContext\n   ) {\n-    KsqlSecurityContextBinderFactory.configure(ksqlConfig, securityExtension);\n+    KsqlSecurityContextBinderFactory.configure(ksqlConfig, securityExtension, serviceContext);\n+  }\n+\n+  public static BiFunction<KsqlConfig, KsqlSecurityExtension, Binder> createFactory(", "originalCommit": "e00cbe4e15635d0d5a7852c45d0e20ca5774bf4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3MzY3Mg==", "url": "https://github.com/confluentinc/ksql/pull/4216#discussion_r364473672", "bodyText": "Nope, removed.", "author": "AlanConfluent", "createdAt": "2020-01-08T22:24:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ2OTA1OA=="}], "type": "inlineReview"}, {"oid": "683907bb46feec3cc00605417f0b54f963087977", "url": "https://github.com/confluentinc/ksql/commit/683907bb46feec3cc00605417f0b54f963087977", "message": "perf: Improves pull query performance by making the schema registry client a singleton.", "committedDate": "2020-01-08T22:47:26Z", "type": "commit"}, {"oid": "683907bb46feec3cc00605417f0b54f963087977", "url": "https://github.com/confluentinc/ksql/commit/683907bb46feec3cc00605417f0b54f963087977", "message": "perf: Improves pull query performance by making the schema registry client a singleton.", "committedDate": "2020-01-08T22:47:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ4NzU1Mw==", "url": "https://github.com/confluentinc/ksql/pull/4216#discussion_r364487553", "bodyText": "Oops, I didn't mean to remove it. This is the tricky line but easy to fix. The ServiceContext must be closed only when a default is not used (so it is created in the last line of the provide method).\nIt can be fixed by keeping a boolean flag to track if the getServiceContext() can be closed or not. Perhapsa variable like mustClose to False when the defaultServiceContext is used?", "author": "spena", "createdAt": "2020-01-08T23:04:26Z", "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/context/KsqlSecurityContextBinderFactory.java", "diffHunk": "@@ -108,6 +104,5 @@ public KsqlSecurityContext provide() {\n \n   @Override\n   public void dispose(final KsqlSecurityContext ksqlSecurityContext) {\n-    ksqlSecurityContext.getServiceContext().close();", "originalCommit": "683907bb46feec3cc00605417f0b54f963087977", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUzMjc2NA==", "url": "https://github.com/confluentinc/ksql/pull/4216#discussion_r364532764", "bodyText": "This closes the admin client and doesn't make sense to do with a singleton because a subsequent request will need it.", "author": "AlanConfluent", "createdAt": "2020-01-09T02:18:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ4NzU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ4ODA0MQ==", "url": "https://github.com/confluentinc/ksql/pull/4216#discussion_r364488041", "bodyText": "Is this safe to remove? I think it was added to mock some unit tests. If they're passing, then I'm good with this, but if not, then you might need to return it.", "author": "spena", "createdAt": "2020-01-08T23:05:58Z", "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/KsqlRestApplication.java", "diffHunk": "@@ -468,18 +464,15 @@ static KsqlRestApplication buildApplication(\n         restConfig,\n         versionCheckerFactory,\n         Integer.MAX_VALUE,\n-        serviceContext,\n-        KsqlSecurityContextBinder::new);\n+        serviceContext);\n   }\n \n   static KsqlRestApplication buildApplication(\n       final String metricsPrefix,\n       final KsqlRestConfig restConfig,\n       final Function<Supplier<Boolean>, VersionCheckerAgent> versionCheckerFactory,\n       final int maxStatementRetries,\n-      final ServiceContext serviceContext,\n-      final BiFunction<KsqlConfig, KsqlSecurityExtension, Binder> serviceContextBinderFactory", "originalCommit": "683907bb46feec3cc00605417f0b54f963087977", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUzMjQ5Nw==", "url": "https://github.com/confluentinc/ksql/pull/4216#discussion_r364532497", "bodyText": "Yes, I discovered this was required.  Added it back.", "author": "AlanConfluent", "createdAt": "2020-01-09T02:17:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ4ODA0MQ=="}], "type": "inlineReview"}, {"oid": "2ec856d027ad873643d97f663c447fefde778e2b", "url": "https://github.com/confluentinc/ksql/commit/2ec856d027ad873643d97f663c447fefde778e2b", "message": "Turned it back to not have singleton ServiceContext", "committedDate": "2020-01-09T01:50:21Z", "type": "commit"}, {"oid": "f0a306b10c09b73ab0f1f687bacf5df4851bf1bb", "url": "https://github.com/confluentinc/ksql/commit/f0a306b10c09b73ab0f1f687bacf5df4851bf1bb", "message": "Reverts it for WSQueryEndpoint too", "committedDate": "2020-01-09T02:22:55Z", "type": "commit"}]}