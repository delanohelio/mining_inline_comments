{"pr_number": 4821, "pr_title": "refactor: Process logger", "pr_createdAt": "2020-03-19T10:10:55Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4821", "timeline": [{"oid": "3aed09829f139a89f87df99fd3aa9d4da294e6c3", "url": "https://github.com/confluentinc/ksql/commit/3aed09829f139a89f87df99fd3aa9d4da294e6c3", "message": "refactor: easier access/mocking of processing logger\n\nThis commit all the steps needed to access a processing logger into the query builder, (which already knows the query id).", "committedDate": "2020-03-18T19:07:55Z", "type": "commit"}, {"oid": "9515d06b874f073f94cf2f7a9276c8f88382be43", "url": "https://github.com/confluentinc/ksql/commit/9515d06b874f073f94cf2f7a9276c8f88382be43", "message": "refactor: have ProcessingLogger.error accept object not function\n\nThis makes it easier to add unit tests that test _what_ is being logged.", "committedDate": "2020-03-19T10:06:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkxODU0OQ==", "url": "https://github.com/confluentinc/ksql/pull/4821#discussion_r394918549", "bodyText": "bug: note how error is never set in the returned message!", "author": "big-andy-coates", "createdAt": "2020-03-19T10:13:47Z", "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/timestamp/LoggingTimestampExtractor.java", "diffHunk": "@@ -82,26 +78,4 @@ public long extract(final GenericRow row) {\n   TimestampExtractor getDelegate() {\n     return delegate;\n   }\n-\n-  public Function<ProcessingLogConfig, SchemaAndValue> timestampExtractErroMsg(\n-      final Exception e,\n-      final String row\n-  ) {\n-    return config -> {\n-      final Struct message = new Struct(ProcessingLogMessageSchema.PROCESSING_LOG_SCHEMA);\n-      final Struct error = new Struct(MessageType.RECORD_PROCESSING_ERROR.getSchema());\n-\n-      error.put(ProcessingLogMessageSchema.RECORD_PROCESSING_ERROR_FIELD_MESSAGE, e.getMessage());\n-\n-      if (config.getBoolean(ProcessingLogConfig.INCLUDE_ROWS)) {\n-        error.put(ProcessingLogMessageSchema.RECORD_PROCESSING_ERROR_FIELD_RECORD, row.toString());\n-      }\n-\n-      final List<String> cause = ErrorMessageUtil.getErrorMessages(e);\n-      cause.remove(0);\n-      error.put(ProcessingLogMessageSchema.RECORD_PROCESSING_ERROR_FIELD_CAUSE, cause);\n-\n-      return new SchemaAndValue(ProcessingLogMessageSchema.PROCESSING_LOG_SCHEMA, message);\n-    };", "originalCommit": "9515d06b874f073f94cf2f7a9276c8f88382be43", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bc2d8b3f9526d44a0e8702491f14bd8d481be83d", "url": "https://github.com/confluentinc/ksql/commit/bc2d8b3f9526d44a0e8702491f14bd8d481be83d", "message": "refactor: remove KsqlQueryBuilder.getProcessingLogContext\n\nAs its only used in tests now - fixed tests.", "committedDate": "2020-03-19T10:23:39Z", "type": "commit"}, {"oid": "d4fbcaaa307a5356cd6296c199b6bd2c4f5a0de1", "url": "https://github.com/confluentinc/ksql/commit/d4fbcaaa307a5356cd6296c199b6bd2c4f5a0de1", "message": "chore: fix spotbugs", "committedDate": "2020-03-19T11:40:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ0OTY4NA==", "url": "https://github.com/confluentinc/ksql/pull/4821#discussion_r395449684", "bodyText": "nit: I think you can just chain the put:\nreturn new Struct(MessageType.PRODUCTION_ERROR.getSchema())\n    .put(ProcessingLogMessageSchema.PRODUCTION_ERROR_FIELD_MESSAGE, errorMsg);", "author": "rodesai", "createdAt": "2020-03-20T05:56:36Z", "path": "ksqldb-common/src/main/java/io/confluent/ksql/errors/ProductionExceptionHandlerUtil.java", "diffHunk": "@@ -61,19 +61,44 @@ public void configure(final Map<String, ?> configs) {\n     abstract ProductionExceptionHandlerResponse getResponse();\n   }\n \n-  private static Function<ProcessingLogConfig, SchemaAndValue> productionError(\n-      final String errorMsg) {\n-    return (config) -> {\n+  public static final class ProductionError implements ProcessingLogger.ErrorMessage {\n+\n+    private final String errorMsg;\n+\n+    public ProductionError(final String errorMsg) {\n+      this.errorMsg = errorMsg == null ? \"\" : errorMsg;\n+    }\n+\n+    @Override\n+    public SchemaAndValue get(final ProcessingLogConfig config) {\n       final Struct struct = new Struct(ProcessingLogMessageSchema.PROCESSING_LOG_SCHEMA);\n       struct.put(ProcessingLogMessageSchema.TYPE, MessageType.PRODUCTION_ERROR.getTypeId());\n-      final Struct productionError =\n-          new Struct(MessageType.PRODUCTION_ERROR.getSchema());\n-      struct.put(ProcessingLogMessageSchema.PRODUCTION_ERROR, productionError);\n-      productionError.put(\n-          ProcessingLogMessageSchema.PRODUCTION_ERROR_FIELD_MESSAGE,\n-          errorMsg);\n+      struct.put(ProcessingLogMessageSchema.PRODUCTION_ERROR, productionError());\n       return new SchemaAndValue(ProcessingLogMessageSchema.PROCESSING_LOG_SCHEMA, struct);\n-    };\n+    }\n+\n+    @Override\n+    public boolean equals(final Object o) {\n+      if (this == o) {\n+        return true;\n+      }\n+      if (o == null || getClass() != o.getClass()) {\n+        return false;\n+      }\n+      final ProductionError that = (ProductionError) o;\n+      return Objects.equals(errorMsg, that.errorMsg);\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+      return Objects.hash(errorMsg);\n+    }\n+\n+    private Struct productionError() {\n+      final Struct productionError = new Struct(MessageType.PRODUCTION_ERROR.getSchema());", "originalCommit": "9515d06b874f073f94cf2f7a9276c8f88382be43", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1MDIwMA==", "url": "https://github.com/confluentinc/ksql/pull/4821#discussion_r395450200", "bodyText": "nit: consider adding a recommendation that the implementer should lazy-initialize the error message, particularly if the message is being logged on a performance-critical path on which logging would typically be disabled.", "author": "rodesai", "createdAt": "2020-03-20T05:59:22Z", "path": "ksqldb-common/src/main/java/io/confluent/ksql/logging/processing/ProcessingLogger.java", "diffHunk": "@@ -15,14 +15,30 @@\n \n package io.confluent.ksql.logging.processing;\n \n-import java.util.function.Function;\n import org.apache.kafka.connect.data.SchemaAndValue;\n \n public interface ProcessingLogger {\n+\n+  /**\n+   * The interface all error message types must implement.\n+   */\n+  interface ErrorMessage {\n+\n+    /**\n+     * Called to convert the error message into a structured message.", "originalCommit": "9515d06b874f073f94cf2f7a9276c8f88382be43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU4MTA0OA==", "url": "https://github.com/confluentinc/ksql/pull/4821#discussion_r395581048", "bodyText": "done.", "author": "big-andy-coates", "createdAt": "2020-03-20T11:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1MDIwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1MjY0Mg==", "url": "https://github.com/confluentinc/ksql/pull/4821#discussion_r395452642", "bodyText": "can we add a test case to LoggingTimestampExtractorTest?", "author": "rodesai", "createdAt": "2020-03-20T06:12:39Z", "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/timestamp/LoggingTimestampExtractor.java", "diffHunk": "@@ -70,7 +65,8 @@ public long extract(final GenericRow row) {\n     try {\n       return delegate.extract(row);\n     } catch (final Exception e) {\n-      logger.error(timestampExtractErroMsg(e, row.toString()));\n+      logger.error(RecordProcessingError.recordProcessingError(", "originalCommit": "9515d06b874f073f94cf2f7a9276c8f88382be43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU5MDY3NA==", "url": "https://github.com/confluentinc/ksql/pull/4821#discussion_r395590674", "bodyText": "Certainly can - as it's now easy now with this change!", "author": "big-andy-coates", "createdAt": "2020-03-20T11:59:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1MjY0Mg=="}], "type": "inlineReview"}, {"oid": "e6c6e3a9a46cc67f9f7149dbebf46392a67c0684", "url": "https://github.com/confluentinc/ksql/commit/e6c6e3a9a46cc67f9f7149dbebf46392a67c0684", "message": "chore: rohan's changes", "committedDate": "2020-03-20T12:00:37Z", "type": "commit"}]}