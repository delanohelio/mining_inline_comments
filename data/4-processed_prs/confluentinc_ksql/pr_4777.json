{"pr_number": 4777, "pr_title": "fix: add transfer-encoding:chunked header if Jetty omits this", "pr_createdAt": "2020-03-14T08:02:02Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4777", "timeline": [{"oid": "e32d3b4b320b227966a957be334a31256cb0e176", "url": "https://github.com/confluentinc/ksql/commit/e32d3b4b320b227966a957be334a31256cb0e176", "message": "fix: add transfer-encoding:chunked header if Jetty omits this in response with no content-length", "committedDate": "2020-03-14T07:57:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc5NDg1MQ==", "url": "https://github.com/confluentinc/ksql/pull/4777#discussion_r392794851", "bodyText": "Is the response actually formatted as if it were a chunked response (length of current chunk followed by carriage return, newline, content, etc.)? It's not, right? Then how come this workaround doesn't result in issues decoding the server response from the client that made the request?", "author": "vcrfxia", "createdAt": "2020-03-16T05:56:07Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/ProxyHandler.java", "diffHunk": "@@ -134,7 +134,18 @@ private static void responseHandler(final HttpClientResponse clientResponse,\n     Pipe.pipe(clientResponse, serverResponse, () -> {\n       final MultiMap trailers = clientResponse.trailers();\n       serverResponse.trailers().setAll(trailers);\n-    });\n+    }, () -> checkFirstWrite(clientResponse, serverResponse));\n+  }\n+\n+  // Vert.x requires that content-length is set if not chunked but Jetty sometimes sends\n+  // response with no content-length and not chunked, so we workaround this by adding a\n+  // tranfer encoding response header with chunked in this case\n+  private static void checkFirstWrite(final HttpClientResponse clientResponse,\n+      final HttpServerResponse serverResponse) {\n+    if (clientResponse.getHeader(\"content-length\") == null\n+        && clientResponse.getHeader(\"transfer-encoding\") == null) {\n+      serverResponse.putHeader(\"transfer-encoding\", \"chunked\");", "originalCommit": "e32d3b4b320b227966a957be334a31256cb0e176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgzOTkyMA==", "url": "https://github.com/confluentinc/ksql/pull/4777#discussion_r392839920", "bodyText": "Chunked transfer encoding must always be acceptable on a client as per spec: (see 14.3.9): https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html", "author": "purplefox", "createdAt": "2020-03-16T08:02:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc5NDg1MQ=="}], "type": "inlineReview"}, {"oid": "a71f654c5fb2bd695ed199d1896b8bbf9a039494", "url": "https://github.com/confluentinc/ksql/commit/a71f654c5fb2bd695ed199d1896b8bbf9a039494", "message": "added test", "committedDate": "2020-03-16T08:29:40Z", "type": "commit"}]}