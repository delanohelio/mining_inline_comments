{"pr_number": 4859, "pr_title": "fix: Filter out hosts with no lag info by default", "pr_createdAt": "2020-03-21T00:23:55Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4859", "timeline": [{"oid": "0358eb9db66bc0483cc031e5c87b3f4ef5ca8004", "url": "https://github.com/confluentinc/ksql/commit/0358eb9db66bc0483cc031e5c87b3f4ef5ca8004", "message": "fix: Make the default behavior when there's no lag information to filter hosts", "committedDate": "2020-03-21T00:21:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU2NDM3NQ==", "url": "https://github.com/confluentinc/ksql/pull/4859#discussion_r396564375", "bodyText": "lol - which one's conservative: including or excluding? ;)", "author": "big-andy-coates", "createdAt": "2020-03-23T16:02:12Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/MaximumLagFilter.java", "diffHunk": "@@ -66,8 +66,8 @@ public boolean filter(final KsqlHostInfo hostInfo) {\n           final long offsetLag = Math.max(endOffset - hostLag.getCurrentOffsetPosition(), 0);\n           return offsetLag <= allowedOffsetLag;\n         })\n-        // If we don't have lag info, we'll be conservative and include the host\n-        .orElse(true);\n+        // If we don't have lag info, we'll be conservative and not include the host", "originalCommit": "0358eb9db66bc0483cc031e5c87b3f4ef5ca8004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3OTIzOQ==", "url": "https://github.com/confluentinc/ksql/pull/4859#discussion_r396579239", "bodyText": ":).In addition would be good to capture the intent here.", "author": "vinothchandar", "createdAt": "2020-03-23T16:21:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU2NDM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY1MzcwNQ==", "url": "https://github.com/confluentinc/ksql/pull/4859#discussion_r396653705", "bodyText": "I'll update the comments a bit.  The question as to what's more conservative has to do with whether we're favoring HA or some crude notion of consistency (enforced by lag filtering) and what additional changes might be made in light of this behavior.\nIn short, we were previously going to forward the lag checking to the active/standby host if the router host didn't have lag info.  In this sense, it was honoring HA to let it pass through and hope the other host could make a lag decision.  Unfortunately, after discussing, it turns out that doing this properly under various scenarios is more complex than it seems.  So, to honor the lag filtering, the simplest approach is to wait until lags exist at the router, and to maximize HA by minimizing this missing lag window.\nHopefully that summary sheds a little light on the comment changes!  :-)", "author": "AlanConfluent", "createdAt": "2020-03-23T18:07:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU2NDM3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU2NTA4MQ==", "url": "https://github.com/confluentinc/ksql/pull/4859#discussion_r396565081", "bodyText": "Catching and swallowing in a test util...  are we sure this is the right approach?", "author": "big-andy-coates", "createdAt": "2020-03-23T16:03:04Z", "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/integration/HighAvailabilityTestUtil.java", "diffHunk": "@@ -181,7 +182,10 @@ public static void sendLagReportingRequest(\n           .exceptionally(t -> {\n             LOG.error(\"Unexpected exception in async request\", t);\n             return null;\n-          });\n+          })\n+      .get();\n+    } catch (Exception e) {\n+      LOG.error(\"Error waiting on lag report\", e);", "originalCommit": "0358eb9db66bc0483cc031e5c87b3f4ef5ca8004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY1NDU2OQ==", "url": "https://github.com/confluentinc/ksql/pull/4859#discussion_r396654569", "bodyText": "You're right, I should let it bubble up and fail immediately (as opposed to letting a following assertion fail).  The important part was calling get since the async aspect was causing tests to have some flakiness.", "author": "AlanConfluent", "createdAt": "2020-03-23T18:09:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU2NTA4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4Mjc1NQ==", "url": "https://github.com/confluentinc/ksql/pull/4859#discussion_r396582755", "bodyText": "should the test name change given the semantics are inverted now? might be good to rename in the same shouldXXX form", "author": "vinothchandar", "createdAt": "2020-03-23T16:26:23Z", "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/server/MaximumLagFilterTest.java", "diffHunk": "@@ -94,7 +94,7 @@ public void filter_hostNoLag() {\n         PARTITION).get();\n \n     // Then:\n-    assertTrue(filter.filter(HOST1));\n+    assertFalse(filter.filter(HOST1));", "originalCommit": "0358eb9db66bc0483cc031e5c87b3f4ef5ca8004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY1ODMwNg==", "url": "https://github.com/confluentinc/ksql/pull/4859#discussion_r396658306", "bodyText": "Done", "author": "AlanConfluent", "createdAt": "2020-03-23T18:15:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4Mjc1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4NjI5MA==", "url": "https://github.com/confluentinc/ksql/pull/4859#discussion_r396586290", "bodyText": "whats the new error? could we assert on that still", "author": "vinothchandar", "createdAt": "2020-03-23T16:31:08Z", "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/integration/PullQueryRoutingFunctionalTest.java", "diffHunk": "@@ -336,8 +336,6 @@ public void shouldFilterLaggyServers() {\n     KsqlErrorMessage errorMessage = makePullQueryRequestWithError(clusterFormation.router.right,\n         sql, LAG_FILTER_25);\n     Assert.assertEquals(40001, errorMessage.getErrorCode());\n-    Assert.assertTrue(errorMessage.getMessage()", "originalCommit": "0358eb9db66bc0483cc031e5c87b3f4ef5ca8004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY2MTc2Mg==", "url": "https://github.com/confluentinc/ksql/pull/4859#discussion_r396661762", "bodyText": "I added this back.  I was originally trying to mitigate some periodic flakiness, but I fixed that elsewhere.", "author": "AlanConfluent", "createdAt": "2020-03-23T18:20:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4NjI5MA=="}], "type": "inlineReview"}, {"oid": "d36c81ae1b90908c1f08f2be0ef6438124aa66ab", "url": "https://github.com/confluentinc/ksql/commit/d36c81ae1b90908c1f08f2be0ef6438124aa66ab", "message": "Feedback", "committedDate": "2020-03-23T18:19:14Z", "type": "commit"}]}