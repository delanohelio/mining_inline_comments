{"pr_number": 5329, "pr_title": "test(client): additional test coverage for push+pull query support", "pr_createdAt": "2020-05-11T04:02:31Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5329", "timeline": [{"oid": "b8fa0776ab503d058cbf56b5da94966c64e3a7c8", "url": "https://github.com/confluentinc/ksql/commit/b8fa0776ab503d058cbf56b5da94966c64e3a7c8", "message": "chore: introduce ColumnType", "committedDate": "2020-05-09T21:35:20Z", "type": "commit"}, {"oid": "ecd2bb834dc04566f8a8ecfd4b6708657eadd7ef", "url": "https://github.com/confluentinc/ksql/commit/ecd2bb834dc04566f8a8ecfd4b6708657eadd7ef", "message": "chore: introduce KsqlObject and KsqlArray", "committedDate": "2020-05-09T21:35:21Z", "type": "commit"}, {"oid": "99ab24956b5f229e25d2c95923fbf4d6d0c28bf6", "url": "https://github.com/confluentinc/ksql/commit/99ab24956b5f229e25d2c95923fbf4d6d0c28bf6", "message": "refactor: rename Row#getObject() to Row#getValue()", "committedDate": "2020-05-09T21:35:43Z", "type": "commit"}, {"oid": "d4ed9555661fb350d9ddce43cdd3974b5a7202db", "url": "https://github.com/confluentinc/ksql/commit/d4ed9555661fb350d9ddce43cdd3974b5a7202db", "message": "refactor: rename QueryResult to StreamedQueryResult", "committedDate": "2020-05-09T21:49:11Z", "type": "commit"}, {"oid": "c0331e3c56ad856cd3c0e7e3f47c8576c59758a9", "url": "https://github.com/confluentinc/ksql/commit/c0331e3c56ad856cd3c0e7e3f47c8576c59758a9", "message": "chore: add BatchedQueryResult", "committedDate": "2020-05-09T22:01:22Z", "type": "commit"}, {"oid": "255d17e89eee77c29970a6f5143371f58f7f50b3", "url": "https://github.com/confluentinc/ksql/commit/255d17e89eee77c29970a6f5143371f58f7f50b3", "message": "test: add test for tls mutual auth", "committedDate": "2020-05-10T17:42:06Z", "type": "commit"}, {"oid": "14fffae3cb122d9c62d323a06be4c777f3c6fe46", "url": "https://github.com/confluentinc/ksql/commit/14fffae3cb122d9c62d323a06be4c777f3c6fe46", "message": "fix: add test for StreamedQueryResult#isComplete()", "committedDate": "2020-05-10T22:41:47Z", "type": "commit"}, {"oid": "78995671b098ef0df831bee0fc050f7663e901c3", "url": "https://github.com/confluentinc/ksql/commit/78995671b098ef0df831bee0fc050f7663e901c3", "message": "test: add test for streaming push query with limit", "committedDate": "2020-05-10T23:42:14Z", "type": "commit"}, {"oid": "00228ef27feb1b11e29e35e43f01f4cff72d84e5", "url": "https://github.com/confluentinc/ksql/commit/00228ef27feb1b11e29e35e43f01f4cff72d84e5", "message": "test: integration test equivalents of StreamedQueryResultImplTest", "committedDate": "2020-05-10T23:58:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk2MzY4MA==", "url": "https://github.com/confluentinc/ksql/pull/5329#discussion_r422963680", "bodyText": "Would be nice to add a couple of tests which do the following:\n\nTerminate the connection from the server side and verify that the query results is completed on the client\nEnds the response (before limit) on the server side and verify that the query result is complete on client.", "author": "purplefox", "createdAt": "2020-05-11T11:09:09Z", "path": "ksqldb-api-client/src/test/java/io/confluent/ksql/api/client/ClientTest.java", "diffHunk": "@@ -168,10 +223,42 @@ public void shouldHandleErrorResponseFromStreamQuery() {\n     );\n \n     // Then\n+    assertThat(e.getCause(), instanceOf(KsqlRestClientException.class));\n     assertThat(e.getCause().getMessage(), containsString(\"Received 400 response from server\"));\n     assertThat(e.getCause().getMessage(), containsString(\"invalid query blah\"));\n   }\n \n+  @Test\n+  public void shouldFailPollStreamedQueryResultIfSubscribed() throws Exception {\n+    // Given\n+    final StreamedQueryResult streamedQueryResult =\n+        javaClient.streamQuery(DEFAULT_PUSH_QUERY, DEFAULT_PUSH_QUERY_REQUEST_PROPERTIES).get();\n+    streamedQueryResult.subscribe(new TestSubscriber<>());\n+\n+    // When\n+    final Exception e = assertThrows(IllegalStateException.class, streamedQueryResult::poll);\n+\n+    // Then\n+    assertThat(e.getMessage(), containsString(\"Cannot poll if subscriber has been set\"));\n+  }\n+\n+  @Test\n+  public void shouldFailSubscribeStreamedQueryResultIfPolling() throws Exception {\n+    // Given\n+    final StreamedQueryResult streamedQueryResult =\n+        javaClient.streamQuery(DEFAULT_PUSH_QUERY, DEFAULT_PUSH_QUERY_REQUEST_PROPERTIES).get();\n+    streamedQueryResult.poll(1, TimeUnit.NANOSECONDS);\n+\n+    // When\n+    final Exception e = assertThrows(\n+        IllegalStateException.class,\n+        () -> streamedQueryResult.subscribe(new TestSubscriber<>())\n+    );\n+\n+    // Then\n+    assertThat(e.getMessage(), containsString(\"Cannot set subscriber if polling\"));\n+  }\n+", "originalCommit": "00228ef27feb1b11e29e35e43f01f4cff72d84e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM0NzE2Mw==", "url": "https://github.com/confluentinc/ksql/pull/5329#discussion_r423347163", "bodyText": "What do you mean by \"terminate the connection from the server\"? Would that be if the server encounters an exception, or something else? Is this the same as \"ends the response on the server side\"?", "author": "vcrfxia", "createdAt": "2020-05-11T22:05:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk2MzY4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3Mjc0Mg==", "url": "https://github.com/confluentinc/ksql/pull/5329#discussion_r423372742", "bodyText": "I guess the connection could also be terminated if the query were terminated via /close-query. I can add a test for that as well.", "author": "vcrfxia", "createdAt": "2020-05-11T23:16:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjk2MzY4MA=="}], "type": "inlineReview"}, {"oid": "3731a9ed185e912b32a1d6012929b48747586272", "url": "https://github.com/confluentinc/ksql/commit/3731a9ed185e912b32a1d6012929b48747586272", "message": "Merge branch 'master' into java-client-test-coverage", "committedDate": "2020-05-11T23:07:58Z", "type": "commit"}, {"oid": "cbc498ad78de002436332ecddb9664d8b8e9e95c", "url": "https://github.com/confluentinc/ksql/commit/cbc498ad78de002436332ecddb9664d8b8e9e95c", "message": "test: remove racy checks", "committedDate": "2020-05-11T23:18:34Z", "type": "commit"}]}