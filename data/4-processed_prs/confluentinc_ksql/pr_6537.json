{"pr_number": 6537, "pr_title": "fix: '-e/-f' CLI parameters are not handling session variables correctly", "pr_createdAt": "2020-10-28T15:12:06Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6537", "timeline": [{"oid": "c8a89cd827171f5d32e7be18edfd2aa1916e8939", "url": "https://github.com/confluentinc/ksql/commit/c8a89cd827171f5d32e7be18edfd2aa1916e8939", "message": "fix: allow '-e' parameter to use variable substitution", "committedDate": "2020-10-28T14:01:55Z", "type": "commit"}, {"oid": "d243699b9916961b9dc7503856d8abeab7cc8f83", "url": "https://github.com/confluentinc/ksql/commit/d243699b9916961b9dc7503856d8abeab7cc8f83", "message": "fix: SHOW VARIABLES is not working with RUN SCRIPT and '-f' parameter", "committedDate": "2020-10-28T14:42:47Z", "type": "commit"}, {"oid": "26323d6d2f5b5f9ac079fae9fc022fa90ae79821", "url": "https://github.com/confluentinc/ksql/commit/26323d6d2f5b5f9ac079fae9fc022fa90ae79821", "message": "fix: RUN SCRIPT and '-f' parameter do not handle PRINT/SELECT queries", "committedDate": "2020-10-28T15:09:29Z", "type": "commit"}, {"oid": "fcd8cf2e07ede4fdb4c173b86ad7b82eb08f984f", "url": "https://github.com/confluentinc/ksql/commit/fcd8cf2e07ede4fdb4c173b86ad7b82eb08f984f", "message": "test: enable variable subst. in CliTest test case", "committedDate": "2020-10-28T16:27:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU5MzcwMw==", "url": "https://github.com/confluentinc/ksql/pull/6537#discussion_r513593703", "bodyText": "nit: would help future reviews if we javadoc that this is used only for the -e usecase", "author": "agavra", "createdAt": "2020-10-28T16:37:40Z", "path": "ksqldb-cli/src/main/java/io/confluent/ksql/cli/Cli.java", "diffHunk": "@@ -220,10 +219,9 @@ public void runScript(final String scriptFile) {\n   public void runCommand(final String command) {", "originalCommit": "fcd8cf2e07ede4fdb4c173b86ad7b82eb08f984f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY1MDU3Ng==", "url": "https://github.com/confluentinc/ksql/pull/6537#discussion_r513650576", "bodyText": "should we use Iterables.getOnlyElement here to make sure it fails if there's more than 1?", "author": "agavra", "createdAt": "2020-10-28T17:55:51Z", "path": "ksqldb-cli/src/main/java/io/confluent/ksql/cli/Cli.java", "diffHunk": "@@ -354,22 +352,21 @@ private boolean isVariableSubstitutionEnabled() {\n     return KsqlConfig.KSQL_VARIABLE_SUBSTITUTION_ENABLE_DEFAULT;\n   }\n \n-  private List<ParsedStatement> substituteVariables(final List<ParsedStatement> statements) {\n+  private ParsedStatement substituteVariables(final ParsedStatement statement) {\n     if (isVariableSubstitutionEnabled()) {\n-      return statements.stream()\n-          .map(stmt -> VariableSubstitutor.substitute(stmt, sessionVariables))\n-          .flatMap(replacedSql -> KSQL_PARSER.parse(replacedSql).stream())\n-          .collect(Collectors.toList());\n+      final String replacedStmt = VariableSubstitutor.substitute(statement, sessionVariables);\n+      return KSQL_PARSER.parse(replacedStmt).get(0);", "originalCommit": "fcd8cf2e07ede4fdb4c173b86ad7b82eb08f984f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY1MTQ5MQ==", "url": "https://github.com/confluentinc/ksql/pull/6537#discussion_r513651491", "bodyText": "this has never been released, right? should be safe to change", "author": "agavra", "createdAt": "2020-10-28T17:57:07Z", "path": "ksqldb-rest-model/src/main/java/io/confluent/ksql/rest/entity/VariablesList.java", "diffHunk": "@@ -80,7 +80,7 @@ public String toString() {\n   @JsonCreator\n   public VariablesList(\n       @JsonProperty(\"statementText\") final String statementText,\n-      @JsonProperty(\"properties\") final List<Variable> variables\n+      @JsonProperty(\"variables\") final List<Variable> variables", "originalCommit": "fcd8cf2e07ede4fdb4c173b86ad7b82eb08f984f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY2MDUxMg==", "url": "https://github.com/confluentinc/ksql/pull/6537#discussion_r513660512", "bodyText": "Yeap, never released, so we're good here.", "author": "spena", "createdAt": "2020-10-28T18:10:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY1MTQ5MQ=="}], "type": "inlineReview"}]}