{"pr_number": 6166, "pr_title": "bug: Improved error message for reserved keywords", "pr_createdAt": "2020-09-09T03:19:34Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6166", "timeline": [{"oid": "2ee4f8db76ad5820d8b9a54175392f4a870c307c", "url": "https://github.com/confluentinc/ksql/commit/2ee4f8db76ad5820d8b9a54175392f4a870c307c", "message": "adds support for 0x, X'', x'' type hex in udf:encode", "committedDate": "2020-08-27T19:46:44Z", "type": "commit"}, {"oid": "a404b0b11b1de09717f0a7c7e6eb87c221c61791", "url": "https://github.com/confluentinc/ksql/commit/a404b0b11b1de09717f0a7c7e6eb87c221c61791", "message": "added one line of comment", "committedDate": "2020-08-28T17:37:27Z", "type": "commit"}, {"oid": "d61f269371b4edb316cb55482d925f37eb3f3211", "url": "https://github.com/confluentinc/ksql/commit/d61f269371b4edb316cb55482d925f37eb3f3211", "message": "added some more tests for odd length hex and corrupted hex", "committedDate": "2020-08-28T18:39:52Z", "type": "commit"}, {"oid": "d56a975bd6d18318f4001fd2c0e5353433c21f9e", "url": "https://github.com/confluentinc/ksql/commit/d56a975bd6d18318f4001fd2c0e5353433c21f9e", "message": "remove input.json from pr", "committedDate": "2020-08-31T18:15:54Z", "type": "commit"}, {"oid": "4dc753ffb176df1efe2b8039d2452352c736c179", "url": "https://github.com/confluentinc/ksql/commit/4dc753ffb176df1efe2b8039d2452352c736c179", "message": "changed error message", "committedDate": "2020-09-09T02:04:18Z", "type": "commit"}, {"oid": "f0b8725f57bf62f65e59ee22521e28cf776a1645", "url": "https://github.com/confluentinc/ksql/commit/f0b8725f57bf62f65e59ee22521e28cf776a1645", "message": "added tests for non-reserved keywords", "committedDate": "2020-09-09T02:16:18Z", "type": "commit"}, {"oid": "06e8f76c978c98de99a91a45c731ca865320fa8c", "url": "https://github.com/confluentinc/ksql/commit/06e8f76c978c98de99a91a45c731ca865320fa8c", "message": "added tests for non-reserved keywords 2", "committedDate": "2020-09-09T02:27:19Z", "type": "commit"}, {"oid": "4b74a36672f2e22453bb1d9d04fde87680449614", "url": "https://github.com/confluentinc/ksql/commit/4b74a36672f2e22453bb1d9d04fde87680449614", "message": "added tests for non-reserved keywords 3", "committedDate": "2020-09-09T02:34:09Z", "type": "commit"}, {"oid": "ea13718660092a4f1225d343f8b26dded6eb9cb8", "url": "https://github.com/confluentinc/ksql/commit/ea13718660092a4f1225d343f8b26dded6eb9cb8", "message": "removed files from commit", "committedDate": "2020-09-09T02:46:21Z", "type": "commit"}, {"oid": "8f6f39616175932d2099fe41fcdcfe791b21c8bf", "url": "https://github.com/confluentinc/ksql/commit/8f6f39616175932d2099fe41fcdcfe791b21c8bf", "message": "undeleted files'\n'", "committedDate": "2020-09-09T02:52:04Z", "type": "commit"}, {"oid": "930eea506a2643c847f6fdc29ad88f2985a8b418", "url": "https://github.com/confluentinc/ksql/commit/930eea506a2643c847f6fdc29ad88f2985a8b418", "message": "Merge branch 'reserved_keyword_error_message'\n\n# Conflicts:\n#\tksqldb-engine/src/main/java/io/confluent/ksql/function/udf/string/Encode.java\n#\tksqldb-engine/src/test/java/io/confluent/ksql/function/udf/string/EncodeTest.java\n#\tksqldb-functional-tests/src/test/resources/query-validation-tests/encode.json", "committedDate": "2020-09-09T03:08:12Z", "type": "commit"}, {"oid": "ac5fc94affe225ff3cc87da9597adedcaf2d2904", "url": "https://github.com/confluentinc/ksql/commit/ac5fc94affe225ff3cc87da9597adedcaf2d2904", "message": "added comments", "committedDate": "2020-09-09T03:21:39Z", "type": "commit"}, {"oid": "2f46f5d11fd4e4370092edd8b4b8ed49947bf875", "url": "https://github.com/confluentinc/ksql/commit/2f46f5d11fd4e4370092edd8b4b8ed49947bf875", "message": "added comments 2", "committedDate": "2020-09-09T03:23:37Z", "type": "commit"}, {"oid": "699487a26d3c07dcb857157b23b38119f9273cf5", "url": "https://github.com/confluentinc/ksql/commit/699487a26d3c07dcb857157b23b38119f9273cf5", "message": "added comments 3", "committedDate": "2020-09-09T03:26:50Z", "type": "commit"}, {"oid": "549c6e6b927d70a5218b4bde78c18606acbd09ef", "url": "https://github.com/confluentinc/ksql/commit/549c6e6b927d70a5218b4bde78c18606acbd09ef", "message": "fix: changed the error message", "committedDate": "2020-09-09T03:28:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgzMzYxNA==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r485833614", "bodyText": "It's better if you create a new class that has a list of the non-reserved keywords and then create there a method that returns all the not-allowed-to-use keywords by using also the SqlBaseParser.VOCABULARY. This way, if we ever need to use them in other places, we don't have to hardcode them again. It will make the code reusable and extendable. You can call the class KsqlParserUtils and have it public.", "author": "vpapavas", "createdAt": "2020-09-09T18:39:34Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/DefaultKsqlParser.java", "diffHunk": "@@ -130,4 +144,103 @@ private static String getStatementString(final SingleStatementContext singleStat\n         singleStatementContext.stop.getStopIndex()\n     ));\n   }\n+\n+  //checks if the error is a reserved keyword error by checking the message and offendingSymbol\n+  private static boolean isKeywordError(final String message, final Object offendingSymbol) {\n+    final String tokenName = ((CommonToken) offendingSymbol).getText().toLowerCase();\n+\n+    final Pattern keywordPattern = Pattern.compile(\"extraneous input.*expecting.*\");\n+    final Matcher m = keywordPattern.matcher(message);\n+    return reservedKeywords.contains(tokenName) && m.find();\n+  }\n+\n+  //Set of keywords minus the non-reserved ones\n+  private static final HashSet<String> reservedKeywords = new HashSet<>(Arrays.asList(\"advance\",", "originalCommit": "549c6e6b927d70a5218b4bde78c18606acbd09ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMzNjIwNQ==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r487336205", "bodyText": "added", "author": "cprasad1", "createdAt": "2020-09-11T23:50:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgzMzYxNA=="}], "type": "inlineReview"}, {"oid": "e0ea950bc6f4f74a449a24329df7de3b62ce01d2", "url": "https://github.com/confluentinc/ksql/commit/e0ea950bc6f4f74a449a24329df7de3b62ce01d2", "message": "removed hardcoding of keywords and added tests", "committedDate": "2020-09-11T23:49:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM0Mjc0OQ==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r487342749", "bodyText": "we should build this once statically and reuse it - no need to build it every time this method is called. And we should also refactor FunctionNameValidator so that this code is reused instead of copy-pasting it", "author": "agavra", "createdAt": "2020-09-12T00:28:04Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/KsqlParserUtil.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.parser;\n+\n+import com.google.common.collect.ImmutableSet;\n+import org.antlr.v4.runtime.CharStreams;\n+import org.antlr.v4.runtime.CommonTokenStream;\n+import org.antlr.v4.runtime.Vocabulary;\n+\n+public final class KsqlParserUtil {\n+\n+  private KsqlParserUtil() {\n+  }\n+\n+  public static boolean isReserved(final String token) {\n+\n+    final SqlBaseLexer sqlBaseLexer = new SqlBaseLexer(\n+            new CaseInsensitiveStream(CharStreams.fromString(token)));\n+    final CommonTokenStream tokenStream = new CommonTokenStream(sqlBaseLexer);\n+    final SqlBaseParser sqlBaseParser = new SqlBaseParser(tokenStream);\n+\n+    final SqlBaseParser.NonReservedContext nonReservedContext = sqlBaseParser.nonReserved();\n+    if (nonReservedContext.exception == null) {\n+      // if the token does not match \"nonReserved\", then we expect the above\n+      // method call to \"throw\" an exception\n+      return false;\n+    }\n+\n+    // this part was taken directly from FunctionNameValidator\n+    final Vocabulary vocabulary = SqlBaseParser.VOCABULARY;\n+    final int tokens = vocabulary.getMaxTokenType();\n+    final ImmutableSet.Builder<String> builder = ImmutableSet.builder();\n+\n+    for (int i = 0; i < tokens; i++) {\n+      final String symbolicName = vocabulary.getSymbolicName(i);\n+      if (symbolicName != null) {\n+        final String keyWord = symbolicName.toLowerCase();\n+        builder.add(keyWord);\n+      }\n+    }\n+\n+    final ImmutableSet<String> allVocab = builder.build();", "originalCommit": "e0ea950bc6f4f74a449a24329df7de3b62ce01d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM0MjkwNw==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r487342907", "bodyText": "we should make sure to remove the normal error listeners, otherwise whenever we call this (expecting an error) it'll get logged to stdout", "author": "agavra", "createdAt": "2020-09-12T00:29:12Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/KsqlParserUtil.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.parser;\n+\n+import com.google.common.collect.ImmutableSet;\n+import org.antlr.v4.runtime.CharStreams;\n+import org.antlr.v4.runtime.CommonTokenStream;\n+import org.antlr.v4.runtime.Vocabulary;\n+\n+public final class KsqlParserUtil {\n+\n+  private KsqlParserUtil() {\n+  }\n+\n+  public static boolean isReserved(final String token) {\n+\n+    final SqlBaseLexer sqlBaseLexer = new SqlBaseLexer(\n+            new CaseInsensitiveStream(CharStreams.fromString(token)));\n+    final CommonTokenStream tokenStream = new CommonTokenStream(sqlBaseLexer);\n+    final SqlBaseParser sqlBaseParser = new SqlBaseParser(tokenStream);\n+\n+    final SqlBaseParser.NonReservedContext nonReservedContext = sqlBaseParser.nonReserved();\n+    if (nonReservedContext.exception == null) {", "originalCommit": "e0ea950bc6f4f74a449a24329df7de3b62ce01d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM0MzA3OQ==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r487343079", "bodyText": "I would spend some time with a debugger and see if there's another way we can check if this doesn't match other than if there's an exception. There might be a cleaner way, I just hacked this together really quickly to prove that it was possible. Let me know if you can't find anything", "author": "agavra", "createdAt": "2020-09-12T00:30:16Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/KsqlParserUtil.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.parser;\n+\n+import com.google.common.collect.ImmutableSet;\n+import org.antlr.v4.runtime.CharStreams;\n+import org.antlr.v4.runtime.CommonTokenStream;\n+import org.antlr.v4.runtime.Vocabulary;\n+\n+public final class KsqlParserUtil {\n+\n+  private KsqlParserUtil() {\n+  }\n+\n+  public static boolean isReserved(final String token) {\n+\n+    final SqlBaseLexer sqlBaseLexer = new SqlBaseLexer(\n+            new CaseInsensitiveStream(CharStreams.fromString(token)));\n+    final CommonTokenStream tokenStream = new CommonTokenStream(sqlBaseLexer);\n+    final SqlBaseParser sqlBaseParser = new SqlBaseParser(tokenStream);\n+\n+    final SqlBaseParser.NonReservedContext nonReservedContext = sqlBaseParser.nonReserved();", "originalCommit": "e0ea950bc6f4f74a449a24329df7de3b62ce01d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwMzM2OQ==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r489703369", "bodyText": "This seems to be the only way to do it for me. Tried to condense it down (seems to be a lot of work for checking something simple)", "author": "cprasad1", "createdAt": "2020-09-16T19:27:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM0MzA3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM0MzIyMA==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r487343220", "bodyText": "nit: javadoc :)", "author": "agavra", "createdAt": "2020-09-12T00:31:00Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/KsqlParserUtil.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.parser;\n+\n+import com.google.common.collect.ImmutableSet;\n+import org.antlr.v4.runtime.CharStreams;\n+import org.antlr.v4.runtime.CommonTokenStream;\n+import org.antlr.v4.runtime.Vocabulary;\n+\n+public final class KsqlParserUtil {\n+\n+  private KsqlParserUtil() {\n+  }\n+\n+  public static boolean isReserved(final String token) {", "originalCommit": "e0ea950bc6f4f74a449a24329df7de3b62ce01d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM0MzI4Nw==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r487343287", "bodyText": "super nit: I think ParserUtil is probably fine (I don't like the pattern of adding Ksql in front of everything \ud83d\ude02 )\nand in fact, I think there's already a ParserUtil class that we can just pop this into", "author": "agavra", "createdAt": "2020-09-12T00:31:21Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/KsqlParserUtil.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.parser;\n+\n+import com.google.common.collect.ImmutableSet;\n+import org.antlr.v4.runtime.CharStreams;\n+import org.antlr.v4.runtime.CommonTokenStream;\n+import org.antlr.v4.runtime.Vocabulary;\n+\n+public final class KsqlParserUtil {", "originalCommit": "e0ea950bc6f4f74a449a24329df7de3b62ce01d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM0MzQ1OA==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r487343458", "bodyText": "nit: should be javadoc, not comment", "author": "agavra", "createdAt": "2020-09-12T00:32:16Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/DefaultKsqlParser.java", "diffHunk": "@@ -130,4 +142,14 @@ private static String getStatementString(final SingleStatementContext singleStat\n         singleStatementContext.stop.getStopIndex()\n     ));\n   }\n+\n+  //checks if the error is a reserved keyword error by checking the message and offendingSymbol", "originalCommit": "e0ea950bc6f4f74a449a24329df7de3b62ce01d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM0MzU1Ng==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r487343556", "bodyText": "nit: this pattern should be compiled once and reused", "author": "agavra", "createdAt": "2020-09-12T00:32:55Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/DefaultKsqlParser.java", "diffHunk": "@@ -130,4 +142,14 @@ private static String getStatementString(final SingleStatementContext singleStat\n         singleStatementContext.stop.getStopIndex()\n     ));\n   }\n+\n+  //checks if the error is a reserved keyword error by checking the message and offendingSymbol\n+  private static boolean isKeywordError(final String message, final Object offendingSymbol) {\n+    final String tokenName = ((CommonToken) offendingSymbol).getText().toLowerCase();\n+\n+    final Pattern keywordPattern = Pattern.compile(\"extraneous input.*expecting.*\");", "originalCommit": "e0ea950bc6f4f74a449a24329df7de3b62ce01d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM0MzYxMQ==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r487343611", "bodyText": "nit: we should flip the order here. m.find() is probably significantly cheaper than going through the full blown parser rules\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return KsqlParserUtil.isReserved(tokenName) && m.find();\n          \n          \n            \n                return m.find() && KsqlParserUtil.isReserved(tokenName);", "author": "agavra", "createdAt": "2020-09-12T00:33:25Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/DefaultKsqlParser.java", "diffHunk": "@@ -130,4 +142,14 @@ private static String getStatementString(final SingleStatementContext singleStat\n         singleStatementContext.stop.getStopIndex()\n     ));\n   }\n+\n+  //checks if the error is a reserved keyword error by checking the message and offendingSymbol\n+  private static boolean isKeywordError(final String message, final Object offendingSymbol) {\n+    final String tokenName = ((CommonToken) offendingSymbol).getText().toLowerCase();\n+\n+    final Pattern keywordPattern = Pattern.compile(\"extraneous input.*expecting.*\");\n+    final Matcher m = keywordPattern.matcher(message);\n+    return KsqlParserUtil.isReserved(tokenName) && m.find();", "originalCommit": "e0ea950bc6f4f74a449a24329df7de3b62ce01d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM0Mzc2NQ==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r487343765", "bodyText": "we should have an instanceOf check here - are we sure that for all exceptions the offendingSymbol is a CommonToken? What happens if it's not a CommonToken?\nAlso we should use Token instead of CommonToken as it's more resilient to underlying implementation changes", "author": "agavra", "createdAt": "2020-09-12T00:34:38Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/DefaultKsqlParser.java", "diffHunk": "@@ -130,4 +142,14 @@ private static String getStatementString(final SingleStatementContext singleStat\n         singleStatementContext.stop.getStopIndex()\n     ));\n   }\n+\n+  //checks if the error is a reserved keyword error by checking the message and offendingSymbol\n+  private static boolean isKeywordError(final String message, final Object offendingSymbol) {\n+    final String tokenName = ((CommonToken) offendingSymbol).getText().toLowerCase();", "originalCommit": "e0ea950bc6f4f74a449a24329df7de3b62ce01d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxNTA5MQ==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r489715091", "bodyText": "if it is not a Token then we should just return false as if the underlying error happens to be a reservedKeywordError then it has to be a Token so we would just default to the default error handling procedure if that isn't the case", "author": "cprasad1", "createdAt": "2020-09-16T19:49:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM0Mzc2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM0MzkxNw==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r487343917", "bodyText": "since we're doing this exact check down inside isKeywordError we should just pull it out here and pass in the text directly", "author": "agavra", "createdAt": "2020-09-12T00:35:25Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/DefaultKsqlParser.java", "diffHunk": "@@ -47,7 +51,15 @@ public void syntaxError(\n         final String message,\n         final RecognitionException e\n     ) {\n-      throw new ParsingException(message, e, line, charPositionInLine);\n+      //Checks if the error is a reserved keyword error\n+      if (isKeywordError(message, offendingSymbol)) {\n+        final String tokenName = ((CommonToken) offendingSymbol).getText();", "originalCommit": "e0ea950bc6f4f74a449a24329df7de3b62ce01d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "90463a1490254a83c09aa20410666ab7fe8ce7bd", "url": "https://github.com/confluentinc/ksql/commit/90463a1490254a83c09aa20410666ab7fe8ce7bd", "message": "refactored code", "committedDate": "2020-09-16T20:34:11Z", "type": "commit"}, {"oid": "7e6916a70ea1ba9bdeaa7626ef71e31b8ba5764c", "url": "https://github.com/confluentinc/ksql/commit/7e6916a70ea1ba9bdeaa7626ef71e31b8ba5764c", "message": "not a good time to mess up git", "committedDate": "2020-09-16T21:17:17Z", "type": "commit"}, {"oid": "7e6916a70ea1ba9bdeaa7626ef71e31b8ba5764c", "url": "https://github.com/confluentinc/ksql/commit/7e6916a70ea1ba9bdeaa7626ef71e31b8ba5764c", "message": "not a good time to mess up git", "committedDate": "2020-09-16T21:17:17Z", "type": "forcePushed"}, {"oid": "5c539a125a8260753ef1411bb1bdf44063d6ec29", "url": "https://github.com/confluentinc/ksql/commit/5c539a125a8260753ef1411bb1bdf44063d6ec29", "message": "cleaned up imports", "committedDate": "2020-09-16T21:34:02Z", "type": "commit"}, {"oid": "bf9edbe7f8379cecadcb7befedd23b886bf99e9c", "url": "https://github.com/confluentinc/ksql/commit/bf9edbe7f8379cecadcb7befedd23b886bf99e9c", "message": "cleaning up", "committedDate": "2020-09-16T21:45:50Z", "type": "commit"}, {"oid": "c8d3dd50aac98540d2e3ada3e85003c1897e705b", "url": "https://github.com/confluentinc/ksql/commit/c8d3dd50aac98540d2e3ada3e85003c1897e705b", "message": "cleaned up imports more", "committedDate": "2020-09-16T22:24:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMTM1OQ==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r489821359", "bodyText": "Could you move the comment to the method used for checking the function name and change the class javadoc to be that the class provides methods for checking whether keywords are java or ksql reserved?", "author": "vpapavas", "createdAt": "2020-09-17T00:13:22Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/util/ParserKeywordValidatorUtil.java", "diffHunk": "@@ -26,9 +26,10 @@\n /**", "originalCommit": "c8d3dd50aac98540d2e3ada3e85003c1897e705b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgzMDE2Mg==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r489830162", "bodyText": "done", "author": "cprasad1", "createdAt": "2020-09-17T00:46:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMTM1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMjQwNg==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r489822406", "bodyText": "I am a bit confused about the double negation in the comment :P If the token is a reserved token, then there will be an exception thrown?", "author": "vpapavas", "createdAt": "2020-09-17T00:17:26Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/util/ParserUtil.java", "diffHunk": "@@ -212,4 +220,31 @@ public static JsonObject convertJsonFieldCase(final JsonObject obj) {\n     }\n     return new JsonObject(convertedMap);\n   }\n+\n+  /**\n+   * Checks if the token is a reserved keyword or not\n+   * @param token the String that caused the parsing error\n+   * @return true if the token is a reserved keyword according to SqlBase.g4\n+   *         false otherwise\n+   */\n+  public static boolean isReserved(final String token) {\n+\n+    final SqlBaseLexer sqlBaseLexer = new SqlBaseLexer(\n+            new CaseInsensitiveStream(CharStreams.fromString(token)));\n+    final CommonTokenStream tokenStream = new CommonTokenStream(sqlBaseLexer);\n+    final SqlBaseParser sqlBaseParser = new SqlBaseParser(tokenStream);\n+\n+    sqlBaseParser.removeErrorListeners();\n+\n+    final SqlBaseParser.NonReservedContext nonReservedContext = sqlBaseParser.nonReserved();\n+    if (nonReservedContext.exception == null) {", "originalCommit": "c8d3dd50aac98540d2e3ada3e85003c1897e705b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgzOTI5Ng==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r489839296", "bodyText": "If we call nonReservedWord and if it successfully parses, then we just parsed through a nonReserved word as defined in SqlBase.g4. if it fails (throws an exception) then it still has the potential to be reserved and we continue checking for that. @agavra  is this assessment correct?", "author": "cprasad1", "createdAt": "2020-09-17T01:03:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMjQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQwNTIxMw==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r490405213", "bodyText": "yes, your comment here is better written than the way I phrased it originally! I think Vicky is right perhaps we should have the contrapositive of what I wrote:\nif no exception was \"thrown\" when calling the nonReserved rule, then this word matches that rule and is not reserved", "author": "agavra", "createdAt": "2020-09-17T16:40:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMjQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ2NTk5NA==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r490465994", "bodyText": "ok done", "author": "cprasad1", "createdAt": "2020-09-17T18:22:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMjQwNg=="}], "type": "inlineReview"}, {"oid": "c9b3f7b250abb81ba5662aaebbd747d569f7eecd", "url": "https://github.com/confluentinc/ksql/commit/c9b3f7b250abb81ba5662aaebbd747d569f7eecd", "message": "changed javadoc for ParserKeywordValidatorUtil.java", "committedDate": "2020-09-17T00:46:08Z", "type": "commit"}, {"oid": "3f979573ccbb4a00895bc7972951b5e737dc1620", "url": "https://github.com/confluentinc/ksql/commit/3f979573ccbb4a00895bc7972951b5e737dc1620", "message": "removed useless import", "committedDate": "2020-09-17T06:22:58Z", "type": "commit"}, {"oid": "e593bcb4c98b72b99ea017fea2c3a6d840adcbde", "url": "https://github.com/confluentinc/ksql/commit/e593bcb4c98b72b99ea017fea2c3a6d840adcbde", "message": "changed comment to contrapositive in ParserUtil.java", "committedDate": "2020-09-17T18:22:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwMjI1Nw==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r493002257", "bodyText": "we usually suppress checkstyle warnings with comments instead of @SuppressWarnings for example:\n  // CHECKSTYLE_RULES.OFF: ClassDataAbstractionCoupling\n  public final class ParserUtil {\n    // CHECKSTYLE_RULES.ON: ClassDataAbstractionCoupling", "author": "agavra", "createdAt": "2020-09-22T20:07:14Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/util/ParserUtil.java", "diffHunk": "@@ -37,11 +39,15 @@\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Optional;\n+import java.util.Set;\n import java.util.regex.Pattern;\n+import org.antlr.v4.runtime.CharStreams;\n+import org.antlr.v4.runtime.CommonTokenStream;\n import org.antlr.v4.runtime.ParserRuleContext;\n import org.antlr.v4.runtime.Token;\n import org.antlr.v4.runtime.tree.TerminalNode;\n \n+@SuppressWarnings(\"checkstyle:ClassDataAbstractionCoupling\")", "originalCommit": "e593bcb4c98b72b99ea017fea2c3a6d840adcbde", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwMzA4NQ==", "url": "https://github.com/confluentinc/ksql/pull/6166#discussion_r493003085", "bodyText": "maybe also suggest to the user that escaping it will work:\ncreate stream `size` as select ...\nthat will work", "author": "agavra", "createdAt": "2020-09-22T20:08:54Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/DefaultKsqlParser.java", "diffHunk": "@@ -47,7 +50,16 @@ public void syntaxError(\n         final String message,\n         final RecognitionException e\n     ) {\n-      throw new ParsingException(message, e, line, charPositionInLine);\n+      if (offendingSymbol instanceof Token && isKeywordError(\n+              message, ((Token) offendingSymbol).getText())) {\n+        //Checks if the error is a reserved keyword error\n+        final String tokenName = ((Token) offendingSymbol).getText();\n+        final String newMessage =\n+                \"\\\"\" + tokenName + \"\\\" is a reserved keyword and it can't be used as an identifier\";", "originalCommit": "e593bcb4c98b72b99ea017fea2c3a6d840adcbde", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cb47a99caa0617a9ce1c70b0a3d9ed17e7ab3749", "url": "https://github.com/confluentinc/ksql/commit/cb47a99caa0617a9ce1c70b0a3d9ed17e7ab3749", "message": "added better error message", "committedDate": "2020-09-22T22:53:27Z", "type": "commit"}, {"oid": "b7cde316d4b3f897ade6d043385c77b5e8ff97d5", "url": "https://github.com/confluentinc/ksql/commit/b7cde316d4b3f897ade6d043385c77b5e8ff97d5", "message": "should build", "committedDate": "2020-09-23T01:46:12Z", "type": "commit"}, {"oid": "0c1ce1d670ee41d36fde1db851309ca8987f787f", "url": "https://github.com/confluentinc/ksql/commit/0c1ce1d670ee41d36fde1db851309ca8987f787f", "message": "should build1", "committedDate": "2020-09-23T02:08:24Z", "type": "commit"}]}