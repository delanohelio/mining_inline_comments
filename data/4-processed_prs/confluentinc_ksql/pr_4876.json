{"pr_number": 4876, "pr_title": "refactor: cloud-first ksqldb releases", "pr_createdAt": "2020-03-23T22:32:52Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4876", "timeline": [{"oid": "d1401bcc5a2a45e4695f363d459c46e88f5745cb", "url": "https://github.com/confluentinc/ksql/commit/d1401bcc5a2a45e4695f363d459c46e88f5745cb", "message": "chore: bump ksqlDB version to 0.8.0 and update CP dependency", "committedDate": "2020-03-12T16:41:59Z", "type": "commit"}, {"oid": "3c3292d65ec82c57e05028a74188fe2c7d49d048", "url": "https://github.com/confluentinc/ksql/commit/3c3292d65ec82c57e05028a74188fe2c7d49d048", "message": "fix: update docker artifact name in light of module rename", "committedDate": "2020-03-12T17:27:12Z", "type": "commit"}, {"oid": "93ec21eb58585416f35e8edd64257572b51c5178", "url": "https://github.com/confluentinc/ksql/commit/93ec21eb58585416f35e8edd64257572b51c5178", "message": "build: add building ccloud image into release pipeline", "committedDate": "2020-03-12T23:25:44Z", "type": "commit"}, {"oid": "e03ee6b806b2dfbc97784a1d8297d4aa7c04f302", "url": "https://github.com/confluentinc/ksql/commit/e03ee6b806b2dfbc97784a1d8297d4aa7c04f302", "message": "fix: look for artifacts in staging s3 bucket", "committedDate": "2020-03-12T23:37:00Z", "type": "commit"}, {"oid": "e1180da6a990a07b9b6bfc1caa38d78f0828f484", "url": "https://github.com/confluentinc/ksql/commit/e1180da6a990a07b9b6bfc1caa38d78f0828f484", "message": "chore: temporarily remove slack notification to avoid spamming channel for tests", "committedDate": "2020-03-12T23:45:51Z", "type": "commit"}, {"oid": "90a2daba9cf4a1b2e4cc543857e6d2a19139f753", "url": "https://github.com/confluentinc/ksql/commit/90a2daba9cf4a1b2e4cc543857e6d2a19139f753", "message": "fix: fixes", "committedDate": "2020-03-13T20:49:02Z", "type": "commit"}, {"oid": "ea03a8367c4cbd18808a7a2f456116f0641cc9cc", "url": "https://github.com/confluentinc/ksql/commit/ea03a8367c4cbd18808a7a2f456116f0641cc9cc", "message": "chore: temporarily change cc-docker-ksql branch until PR is merged", "committedDate": "2020-03-13T20:49:55Z", "type": "commit"}, {"oid": "34e0e5e32b72f512da5d53802c20178f9920bff6", "url": "https://github.com/confluentinc/ksql/commit/34e0e5e32b72f512da5d53802c20178f9920bff6", "message": "chore: temporarily disable ksqldb build to focus on testing cc-docker-ksql portion", "committedDate": "2020-03-13T20:56:51Z", "type": "commit"}, {"oid": "b7575b27da4fef482c8f05f1717ed32dcf6e41a5", "url": "https://github.com/confluentinc/ksql/commit/b7575b27da4fef482c8f05f1717ed32dcf6e41a5", "message": "fix: more fixes", "committedDate": "2020-03-13T22:19:39Z", "type": "commit"}, {"oid": "a3ce192de3fc744fa0b7c7b499cc1cc46fedd2c6", "url": "https://github.com/confluentinc/ksql/commit/a3ce192de3fc744fa0b7c7b499cc1cc46fedd2c6", "message": "Merge branch 'ksql-db-release' into ksql-db-release-cloud-first-release", "committedDate": "2020-03-13T22:27:07Z", "type": "commit"}, {"oid": "f2ff9b19a7011c0d38d4c57d6c44da4fd964d8fb", "url": "https://github.com/confluentinc/ksql/commit/f2ff9b19a7011c0d38d4c57d6c44da4fd964d8fb", "message": "chore: temporarily set isPrJob to false for testing purposes", "committedDate": "2020-03-13T22:37:33Z", "type": "commit"}, {"oid": "d9d4dafe7d1d776cb4dba6e5291511aad8e1384c", "url": "https://github.com/confluentinc/ksql/commit/d9d4dafe7d1d776cb4dba6e5291511aad8e1384c", "message": "Revert \"chore: temporarily set isPrJob to false for testing purposes\"\n\nThis reverts commit f2ff9b19a7011c0d38d4c57d6c44da4fd964d8fb.", "committedDate": "2020-03-13T22:37:53Z", "type": "commit"}, {"oid": "ae8e37d685835cbc55b25000bac2f7d0f7b83b83", "url": "https://github.com/confluentinc/ksql/commit/ae8e37d685835cbc55b25000bac2f7d0f7b83b83", "message": "fix: more fixes", "committedDate": "2020-03-13T22:38:26Z", "type": "commit"}, {"oid": "7c00fe068b00b5533f48383aefc7ca99504cef30", "url": "https://github.com/confluentinc/ksql/commit/7c00fe068b00b5533f48383aefc7ca99504cef30", "message": "fix: more fixes", "committedDate": "2020-03-13T22:54:40Z", "type": "commit"}, {"oid": "8cc39a2c6a5f07b10888efe0794a1aed92c6e890", "url": "https://github.com/confluentinc/ksql/commit/8cc39a2c6a5f07b10888efe0794a1aed92c6e890", "message": "bump beta packaging version", "committedDate": "2020-03-21T08:03:01Z", "type": "commit"}, {"oid": "91fbf59592209d961e919439e699d15d68023cdb", "url": "https://github.com/confluentinc/ksql/commit/91fbf59592209d961e919439e699d15d68023cdb", "message": "build: switch to common jenkins credentials for cloud build", "committedDate": "2020-03-23T18:54:09Z", "type": "commit"}, {"oid": "aed71b67fc51b8bffe08fc6dc388f877eeaf9521", "url": "https://github.com/confluentinc/ksql/commit/aed71b67fc51b8bffe08fc6dc388f877eeaf9521", "message": "chore: backout unnecessary changes to maven settings template", "committedDate": "2020-03-23T18:58:31Z", "type": "commit"}, {"oid": "e79b453779308bba121aa2c096be6b84eddc32f3", "url": "https://github.com/confluentinc/ksql/commit/e79b453779308bba121aa2c096be6b84eddc32f3", "message": "build: pass packaging beta version to downstream", "committedDate": "2020-03-23T19:01:39Z", "type": "commit"}, {"oid": "4df4659bd6ec46c020185aa58272595461dfe397", "url": "https://github.com/confluentinc/ksql/commit/4df4659bd6ec46c020185aa58272595461dfe397", "message": "chore: backout temporary changes and other cleanup", "committedDate": "2020-03-23T20:09:33Z", "type": "commit"}, {"oid": "632c13f598ebec7e8755da8c53f860a49f619191", "url": "https://github.com/confluentinc/ksql/commit/632c13f598ebec7e8755da8c53f860a49f619191", "message": "Merge branch 'ksql-db-release' into ksql-db-release-cloud-first-release", "committedDate": "2020-03-23T20:18:41Z", "type": "commit"}, {"oid": "19a084eb7c1797694b9c1f294b408e0341505855", "url": "https://github.com/confluentinc/ksql/commit/19a084eb7c1797694b9c1f294b408e0341505855", "message": "chore: pass packaging build number to downstream", "committedDate": "2020-03-23T20:56:46Z", "type": "commit"}, {"oid": "695ed42e4eed56a6ce5ec175a28d369cff776a73", "url": "https://github.com/confluentinc/ksql/commit/695ed42e4eed56a6ce5ec175a28d369cff776a73", "message": "fix: missed a spot", "committedDate": "2020-03-23T21:35:17Z", "type": "commit"}, {"oid": "268d1290dae303974f61126bbf227d554ef271aa", "url": "https://github.com/confluentinc/ksql/commit/268d1290dae303974f61126bbf227d554ef271aa", "message": "chore: remove unneeded block from cloud image section", "committedDate": "2020-03-23T21:44:57Z", "type": "commit"}, {"oid": "cd9b250481022540c585be741453aae42d360657", "url": "https://github.com/confluentinc/ksql/commit/cd9b250481022540c585be741453aae42d360657", "message": "build: trigger cc-docker-ksql build as separate job", "committedDate": "2020-03-23T22:31:58Z", "type": "commit"}, {"oid": "a12ca5f4fa565dca20c9cab2e53ce6ed2c098805", "url": "https://github.com/confluentinc/ksql/commit/a12ca5f4fa565dca20c9cab2e53ce6ed2c098805", "message": "Merge branch 'ksql-db-release' into ksql-db-release-cloud-first-release-2", "committedDate": "2020-03-24T21:12:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUzMjgyNg==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r397532826", "bodyText": "this doesn't have to be a sha right? In fact, assuming cloud-first releases this could just be the tag we used for the cloud-release.", "author": "rodesai", "createdAt": "2020-03-24T23:58:40Z", "path": "Jenkinsfile", "diffHunk": "@@ -16,20 +16,23 @@ def baseConfig = {\n \n def defaultParams = [\n     booleanParam(name: 'RELEASE_BUILD',\n-        description: 'Is this a release build.',\n+        description: 'Is this a release build. If so, GIT_REVISION must be specified, and only on-prem images will be built.',\n         defaultValue: false),\n     string(name: 'GIT_REVISION',", "originalCommit": "a12ca5f4fa565dca20c9cab2e53ce6ed2c098805", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODMwMDgxNQ==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398300815", "bodyText": "It doesn't have to be a SHA, it can also be a branch name or Git tag. However, directly using the tag from a previous build doesn't work since the tags have CP dependencies updated to be beta packaging builds, which means the job fails to process the pom since the job isn't configured with the packaging beta maven repo.\n(Tried just now to confirm and the error was\n20:30:04  [FATAL] Non-resolvable parent POM for io.confluent.ksql:ksqldb-parent:0.8.0: Could not find artifact io.confluent:rest-utils-parent:pom:6.0.0-beta200310175819 in confluent (https://****-confluent-packages-beta-maven.s3-us-west-2.amazonaws.com/6.0.0-beta200320180305/1/maven) and 'parent.relativePath' points at wrong local POM @ line 22, column 13\n\n)", "author": "vcrfxia", "createdAt": "2020-03-26T03:41:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUzMjgyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODMwMDk4Mg==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398300982", "bodyText": "The way we'd reproduce an earlier build is to go to the Git tag, find the parent SHA, and specify that SHA in the build.", "author": "vcrfxia", "createdAt": "2020-03-26T03:42:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUzMjgyNg=="}], "type": "inlineReview"}, {"oid": "d9021289f095bcad7a3986322e5a1d7cf909fd25", "url": "https://github.com/confluentinc/ksql/commit/d9021289f095bcad7a3986322e5a1d7cf909fd25", "message": "chore: feedback", "committedDate": "2020-03-26T01:14:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcxODM2Ng==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398718366", "bodyText": "when you say only on-prem images will be built you mean it won't trigger the cloud build, correct? because this build only builds on-prem images anyways, right. maybe we can change this to just say won't trigger cloud build because it makes it seem like this job could actually do that. i am thinking this wording is probably just left over from the original draft where this was doing both builds.", "author": "elismaga", "createdAt": "2020-03-26T16:36:32Z", "path": "Jenkinsfile", "diffHunk": "@@ -16,20 +16,23 @@ def baseConfig = {\n \n def defaultParams = [\n     booleanParam(name: 'RELEASE_BUILD',\n-        description: 'Is this a release build.',\n+        description: 'Is this a release build. If so, GIT_REVISION must be specified, and only on-prem images will be built.',", "originalCommit": "d9021289f095bcad7a3986322e5a1d7cf909fd25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkyMzk2MA==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398923960", "bodyText": "Yeah, leftover from an earlier version as you said. I've updated this.", "author": "vcrfxia", "createdAt": "2020-03-26T22:12:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcxODM2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcxOTg0Ng==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398719846", "bodyText": "i'm confused by this. the cloud build is downstream from this so why would you need to enter the git sha for cloud when building this? it seems like this makes the ksqldb on prem build dependent on the cloud ksql build.", "author": "elismaga", "createdAt": "2020-03-26T16:38:23Z", "path": "Jenkinsfile", "diffHunk": "@@ -16,20 +16,23 @@ def baseConfig = {\n \n def defaultParams = [\n     booleanParam(name: 'RELEASE_BUILD',\n-        description: 'Is this a release build.',\n+        description: 'Is this a release build. If so, GIT_REVISION must be specified, and only on-prem images will be built.',\n         defaultValue: false),\n     string(name: 'GIT_REVISION',\n-        description: 'The git SHA to create the release build from.',\n+        description: 'The git SHA to build ksqlDB from.',\n+        defaultValue: ''),\n+    string(name: 'CCLOUD_GIT_REVISION',\n+        description: 'The cc-docker-ksql git SHA to build the CCloud ksqlDB image from.',", "originalCommit": "d9021289f095bcad7a3986322e5a1d7cf909fd25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkyNDUxNg==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398924516", "bodyText": "Also leftover from an earlier iteration. Removed.", "author": "vcrfxia", "createdAt": "2020-03-26T22:13:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcxOTg0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyNDg1NA==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398724854", "bodyText": "if you are going to append the build number then you need to remove the snapshot qualifier. i made a more detailed comment about this in the cloud PR since I reviewed that one first", "author": "elismaga", "createdAt": "2020-03-26T16:45:03Z", "path": "Jenkinsfile", "diffHunk": "@@ -74,9 +77,13 @@ def job = {\n \n         // For a release build we remove the -SNAPSHOT from the version.\n         config.ksql_db_version = config.ksql_db_version.tokenize(\"-\")[0]\n+\n+        config.ksql_db_artifact_version = config.ksql_db_version\n         config.docker_tag = config.ksql_db_version\n     } else {\n-        config.docker_tag = config.ksql_db_version.tokenize(\"-\")[0] + '-' + env.BUILD_NUMBER\n+        // For non-release builds, we append the build number to the maven artifacts and docker image tag\n+        config.ksql_db_artifact_version = config.ksql_db_version + '-' + env.BUILD_NUMBER", "originalCommit": "d9021289f095bcad7a3986322e5a1d7cf909fd25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkyNDc3OQ==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398924779", "bodyText": "Yup, responded on the other PR. Updated here as well.", "author": "vcrfxia", "createdAt": "2020-03-26T22:14:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyNDg1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyNTI4Ng==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398725286", "bodyText": "is this comment still relevant since we don't build cloud images here?", "author": "elismaga", "createdAt": "2020-03-26T16:45:36Z", "path": "Jenkinsfile", "diffHunk": "@@ -146,6 +153,8 @@ def job = {\n         return null\n     }\n \n+    // Build on-prem ksqlDB image", "originalCommit": "d9021289f095bcad7a3986322e5a1d7cf909fd25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkyNDgzNQ==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398924835", "bodyText": "Nope, removed.", "author": "vcrfxia", "createdAt": "2020-03-26T22:14:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyNTI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyODgyNA==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398728824", "bodyText": "can we make this if not release build then do the extra stage and trigger the cloud build.", "author": "elismaga", "createdAt": "2020-03-26T16:50:09Z", "path": "Jenkinsfile", "diffHunk": "@@ -319,13 +328,35 @@ def job = {\n                     sh \"docker push ${config.dockerRegistry}${dockerRepo}:master-latest\"\n \n                     if (config.release) {\n-                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n-                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n+                        // docker_tag for release builds does not include the build number\n+                        // here we add it back so an image version with the build number always exists\n+                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-beta${env.BUILD_NUMBER}\"\n+                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-beta${env.BUILD_NUMBER}\"\n                     }\n                 }\n             }\n         }\n     }\n+\n+    // Build CCloud ksqlDB image\n+\n+    if (config.release) {", "originalCommit": "d9021289f095bcad7a3986322e5a1d7cf909fd25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkyNDk0OA==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398924948", "bodyText": "Done. Also made it so the downstream is not triggered for PR jobs, which was a bug in the previous iteration of this PR.", "author": "vcrfxia", "createdAt": "2020-03-26T22:14:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyODgyNA=="}], "type": "inlineReview"}, {"oid": "4d8383acf1f0ec0fd7a18e132c09ac7a4a856ef6", "url": "https://github.com/confluentinc/ksql/commit/4d8383acf1f0ec0fd7a18e132c09ac7a4a856ef6", "message": "fix: eli's feedback", "committedDate": "2020-03-26T22:24:45Z", "type": "commit"}, {"oid": "91f7b030da78e39bdc6c51c2b2694eda81ae714a", "url": "https://github.com/confluentinc/ksql/commit/91f7b030da78e39bdc6c51c2b2694eda81ae714a", "message": "chore: create git tag after maven build", "committedDate": "2020-03-26T22:29:11Z", "type": "commit"}, {"oid": "1d62ff6aea894622886c3e673f786a438c48955c", "url": "https://github.com/confluentinc/ksql/commit/1d62ff6aea894622886c3e673f786a438c48955c", "message": "chore: make default git revision more prominent", "committedDate": "2020-03-27T17:02:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU1OTg0Ng==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r400559846", "bodyText": "we won't ever be doing snapshot builds anymore correct? So if you just remove the -SNAPSHOT from the ksql_db_version variable in the config you don't need the tokenize call here or line 77 anymore. would you still need this new variable config.ksql_db_artifact_version?", "author": "elismaga", "createdAt": "2020-03-30T23:44:20Z", "path": "Jenkinsfile", "diffHunk": "@@ -82,7 +79,7 @@ def job = {\n         config.docker_tag = config.ksql_db_version\n     } else {\n         // For non-release builds, we append the build number to the maven artifacts and docker image tag\n-        config.ksql_db_artifact_version = config.ksql_db_version + '-' + env.BUILD_NUMBER\n+        config.ksql_db_artifact_version = config.ksql_db_version.tokenize(\"-\")[0] + '-' + env.BUILD_NUMBER", "originalCommit": "4d8383acf1f0ec0fd7a18e132c09ac7a4a856ef6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NjUyNA==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401246524", "bodyText": "Great point. An added benefit of this is that the build param KSQLDB_VERSION and the config var ksql_db_version are now of the same form, removing some existing confusion around the two.\nMade the update, though I left docker_tag as a separate var from ksql_db_artifact_version even though they're always the same since I think subsequent lines in this script are easier to read that way.", "author": "vcrfxia", "createdAt": "2020-03-31T22:13:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU1OTg0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU2MDk1Ng==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r400560956", "bodyText": "I would prefer we didn't use the beta qualifier in the artifact version.", "author": "elismaga", "createdAt": "2020-03-30T23:48:09Z", "path": "Jenkinsfile", "diffHunk": "@@ -74,13 +75,17 @@ def job = {\n \n         // For a release build we remove the -SNAPSHOT from the version.\n         config.ksql_db_version = config.ksql_db_version.tokenize(\"-\")[0]\n+\n+        config.ksql_db_artifact_version = config.ksql_db_version\n         config.docker_tag = config.ksql_db_version\n     } else {\n-        config.docker_tag = config.ksql_db_version.tokenize(\"-\")[0] + '-' + env.BUILD_NUMBER\n+        // For non-release builds, we append the build number to the maven artifacts and docker image tag\n+        config.ksql_db_artifact_version = config.ksql_db_version.tokenize(\"-\")[0] + '-' + env.BUILD_NUMBER\n+        config.docker_tag = config.ksql_db_version.tokenize(\"-\")[0] + '-beta' + env.BUILD_NUMBER", "originalCommit": "1d62ff6aea894622886c3e673f786a438c48955c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NTczNg==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401245736", "bodyText": "As discussed offline, I've updated the docker tag, maven artifact version, and git tag to all use -rc instead of -beta.", "author": "vcrfxia", "createdAt": "2020-03-31T22:11:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU2MDk1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU2MzM0OQ==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r400563349", "bodyText": "i would prefer we remove the \"-beta\" qualifier", "author": "elismaga", "createdAt": "2020-03-30T23:55:55Z", "path": "Jenkinsfile", "diffHunk": "@@ -319,13 +324,31 @@ def job = {\n                     sh \"docker push ${config.dockerRegistry}${dockerRepo}:master-latest\"\n \n                     if (config.release) {\n-                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n-                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n+                        // docker_tag for release builds does not include the build number\n+                        // here we add it back so an image version with the build number always exists\n+                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-beta${env.BUILD_NUMBER}\"", "originalCommit": "1d62ff6aea894622886c3e673f786a438c48955c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NTc2OA==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401245768", "bodyText": "As above.", "author": "vcrfxia", "createdAt": "2020-03-31T22:11:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU2MzM0OQ=="}], "type": "inlineReview"}, {"oid": "bf5927fb8906165af306cd120e40de1f3e9fd3a6", "url": "https://github.com/confluentinc/ksql/commit/bf5927fb8906165af306cd120e40de1f3e9fd3a6", "message": "Merge branch 'ksql-db-release' into ksql-db-release-cloud-first-release-2", "committedDate": "2020-03-31T22:03:06Z", "type": "commit"}, {"oid": "8cfa30b892f72c9679e2e6db6cb35e2a9288caad", "url": "https://github.com/confluentinc/ksql/commit/8cfa30b892f72c9679e2e6db6cb35e2a9288caad", "message": "chore: bump to next ksqldb release version", "committedDate": "2020-03-31T22:03:33Z", "type": "commit"}, {"oid": "1a40d3f9a689f5c01a4d41732450ab31558c1079", "url": "https://github.com/confluentinc/ksql/commit/1a40d3f9a689f5c01a4d41732450ab31558c1079", "message": "chore: update maven artifact version and docker image tag", "committedDate": "2020-03-31T22:05:36Z", "type": "commit"}, {"oid": "d138ec6313fd6e22f7666f756f877f39dd9daff3", "url": "https://github.com/confluentinc/ksql/commit/d138ec6313fd6e22f7666f756f877f39dd9daff3", "message": "chore: clean up snapshot from ksqldb version", "committedDate": "2020-03-31T22:10:24Z", "type": "commit"}, {"oid": "94cd165cf73f1ee6211c6d3708c83cf02c068a84", "url": "https://github.com/confluentinc/ksql/commit/94cd165cf73f1ee6211c6d3708c83cf02c068a84", "message": "chore: combine sh blocks", "committedDate": "2020-03-31T23:02:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4Njk3OQ==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401886979", "bodyText": "you can move these up to line 171 along with other call to writeFile, and then you only need one sh block.", "author": "elismaga", "createdAt": "2020-04-01T20:23:34Z", "path": "Jenkinsfile", "diffHunk": "@@ -175,10 +176,9 @@ def job = {\n                                 set +x\n \n                                 LOGIN_CMD=$(aws ecr get-login --no-include-email --region us-west-2)\n-\n                                 $LOGIN_CMD\n-                            '''\n-                            sh '''\n+\n+                                set -x\n                                 echo $ARTIFACTORY_PASSWORD | docker login confluent-docker.jfrog.io -u $ARTIFACTORY_USERNAME --password-stdin\n                             '''\n                             writeFile file:'create-pip-conf-with-jfrog.sh', text:libraryResource('scripts/create-pip-conf-with-jfrog.sh')", "originalCommit": "94cd165cf73f1ee6211c6d3708c83cf02c068a84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2NzQ4NA==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401967484", "bodyText": "Done.", "author": "vcrfxia", "createdAt": "2020-04-01T23:26:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4Njk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4ODA4Mw==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401888083", "bodyText": "seems odd to use the docker_tag here instead of the artifact version, even though they are the same thing.", "author": "elismaga", "createdAt": "2020-04-01T20:25:39Z", "path": "Jenkinsfile", "diffHunk": "@@ -226,13 +216,23 @@ def job = {\n                                 sh cmd\n                             }\n                             step([$class: 'hudson.plugins.findbugs.FindBugsPublisher', pattern: '**/*bugsXml.xml'])\n+\n+                            if (!config.isPrJob) {\n+                                def git_tag = \"v${config.docker_tag}-ksqldb\"", "originalCommit": "94cd165cf73f1ee6211c6d3708c83cf02c068a84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2NzcyMA==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401967720", "bodyText": "Don't feel strongly one way or the other. I've updated it to be the artifact version.", "author": "vcrfxia", "createdAt": "2020-04-01T23:27:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4ODA4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4ODQzMw==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401888433", "bodyText": "i don't know if this is just a display problem with the diff, but it seems like you have a space between \"${config.\" and \"cp_version}\".", "author": "elismaga", "createdAt": "2020-04-01T20:26:21Z", "path": "Jenkinsfile", "diffHunk": "@@ -226,13 +216,23 @@ def job = {\n                                 sh cmd\n                             }\n                             step([$class: 'hudson.plugins.findbugs.FindBugsPublisher', pattern: '**/*bugsXml.xml'])\n+\n+                            if (!config.isPrJob) {\n+                                def git_tag = \"v${config.docker_tag}-ksqldb\"\n+                                sh \"git add .\"\n+                                sh \"git commit -m \\\"build: Setting project version ${config.ksql_db_artifact_version} and parent version ${config. cp_version}.\\\"\"", "originalCommit": "94cd165cf73f1ee6211c6d3708c83cf02c068a84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2Nzc2Nw==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401967767", "bodyText": "Good catch -- fixed.", "author": "vcrfxia", "createdAt": "2020-04-01T23:27:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4ODQzMw=="}], "type": "inlineReview"}, {"oid": "86c308465545de2bbdf6a69f6087563d7fb9a193", "url": "https://github.com/confluentinc/ksql/commit/86c308465545de2bbdf6a69f6087563d7fb9a193", "message": "fix: more feedback", "committedDate": "2020-04-01T23:24:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2ODUyOQ==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401968529", "bodyText": "Added this so dependency images are cleaned up in addition to the built ones. The script doesn't pull dependencies in PROMOTE_TO_PRODUCTION mode and the dependency repo doesn't exist in the production registry, but I think that should be fine? As in, trying to clean up a registry + repo combination that doesn't exist shouldn't cause the script to error. Please correct me if I'm mistaken.", "author": "vcrfxia", "createdAt": "2020-04-01T23:29:39Z", "path": "Jenkinsfile", "diffHunk": "@@ -319,18 +318,36 @@ def job = {\n                     sh \"docker push ${config.dockerRegistry}${dockerRepo}:master-latest\"\n \n                     if (config.release) {\n-                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n-                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n+                        // docker_tag for release builds does not include the build number\n+                        // here we add it back so an image version with the build number always exists\n+                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-rc${env.BUILD_NUMBER}\"\n+                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-rc${env.BUILD_NUMBER}\"\n                     }\n                 }\n             }\n         }\n     }\n+\n+    // Build CCloud ksqlDB image\n+\n+    if (!config.release && !config.isPrJob) {\n+        stage('Trigger CCloud ksqlDB Docker image job') {\n+            build job: \"confluentinc/cc-docker-ksql/master\",\n+                wait: false,\n+                parameters: [\n+                    booleanParam(name: \"NIGHTLY_BUILD\", value: true),\n+                    string(name: \"NIGHTLY_BUILD_NUMBER\", value: \"${env.BUILD_NUMBER}\"),\n+                    string(name: \"CP_BETA_VERSION\", value: \"${config.cp_version}\"),\n+                    string(name: \"CP_BETA_BUILD_NUMBER\", value: \"${config.packaging_build_number}\"),\n+                    string(name: \"KSQLDB_ARTIFACT_VERSION\", value: \"${config.ksql_db_artifact_version}\")\n+                ]\n+        }\n+    }\n }\n \n def post = {\n     withDockerServer([uri: dockerHost()]) {\n-        repos = config.dockerArtifacts + config.dockerRepos\n+        repos = config.dockerArtifacts + config.dockerRepos + config.dockerPullDeps", "originalCommit": "86c308465545de2bbdf6a69f6087563d7fb9a193", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5OTIxNw==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401999217", "bodyText": "@vcrfxia Apologies, but I got that wrong and I mentioned some more detail in the other PR. You only want to delete the images you build.", "author": "elismaga", "createdAt": "2020-04-02T01:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2ODUyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3MjEyOQ==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r402072129", "bodyText": "No worries, reverted the cleanup logic change.", "author": "vcrfxia", "createdAt": "2020-04-02T06:10:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2ODUyOQ=="}], "type": "inlineReview"}, {"oid": "836ee4cb2e4d1b6a61a708ac865483bdd37b6a47", "url": "https://github.com/confluentinc/ksql/commit/836ee4cb2e4d1b6a61a708ac865483bdd37b6a47", "message": "fix: undo cleanup change", "committedDate": "2020-04-02T06:08:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyNjU3Mw==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r403326573", "bodyText": "1 nit here: would it be better to just pass in an opaque version string here rather than the beta version and the nightly build number and having the cc-docker-ksql build reconstruct the ksqldb rc version? It would be easier to keep it consistent this way (in case we change the format of the ksqldb rc version).", "author": "rodesai", "createdAt": "2020-04-03T20:51:15Z", "path": "Jenkinsfile", "diffHunk": "@@ -319,13 +318,31 @@ def job = {\n                     sh \"docker push ${config.dockerRegistry}${dockerRepo}:master-latest\"\n \n                     if (config.release) {\n-                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n-                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n+                        // docker_tag for release builds does not include the build number\n+                        // here we add it back so an image version with the build number always exists\n+                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-rc${env.BUILD_NUMBER}\"\n+                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-rc${env.BUILD_NUMBER}\"\n                     }\n                 }\n             }\n         }\n     }\n+\n+    // Build CCloud ksqlDB image\n+\n+    if (!config.release && !config.isPrJob) {\n+        stage('Trigger CCloud ksqlDB Docker image job') {\n+            build job: \"confluentinc/cc-docker-ksql/master\",\n+                wait: false,\n+                parameters: [\n+                    booleanParam(name: \"NIGHTLY_BUILD\", value: true),\n+                    string(name: \"NIGHTLY_BUILD_NUMBER\", value: \"${env.BUILD_NUMBER}\"),", "originalCommit": "836ee4cb2e4d1b6a61a708ac865483bdd37b6a47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM1MTUxNg==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r403351516", "bodyText": "Discussed offline. Decision was to remove the parameter NIGHTLY_BUILD_NUMBER and have the cc-docker-ksql build construct its docker image tag from KSQLDB_ARTIFACT_VERSION directly. The beta version params are separate.", "author": "vcrfxia", "createdAt": "2020-04-03T21:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyNjU3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM2MTc4OA==", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r403361788", "bodyText": "Nvm, decided to leave this as is in order to allow more flexibility for the downstream image tag format.", "author": "vcrfxia", "createdAt": "2020-04-03T22:14:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyNjU3Mw=="}], "type": "inlineReview"}, {"oid": "7ff7fc58e80e5c5b38f32be8b5f014a251b331de", "url": "https://github.com/confluentinc/ksql/commit/7ff7fc58e80e5c5b38f32be8b5f014a251b331de", "message": "chore: remove downstream build param", "committedDate": "2020-04-03T21:46:15Z", "type": "commit"}, {"oid": "c8547bee6c5d3c3597f308d2cce835252d50f209", "url": "https://github.com/confluentinc/ksql/commit/c8547bee6c5d3c3597f308d2cce835252d50f209", "message": "Merge branch 'ksql-db-release' into ksql-db-release-cloud-first-release-2", "committedDate": "2020-04-03T22:06:40Z", "type": "commit"}, {"oid": "d35fa560078e8b5bd2d395c82f3702d2132772d0", "url": "https://github.com/confluentinc/ksql/commit/d35fa560078e8b5bd2d395c82f3702d2132772d0", "message": "chore: add back downstream build param", "committedDate": "2020-04-03T22:11:58Z", "type": "commit"}]}