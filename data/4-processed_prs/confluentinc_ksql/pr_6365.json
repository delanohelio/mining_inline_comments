{"pr_number": 6365, "pr_title": "Query schemas", "pr_createdAt": "2020-10-06T16:41:33Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6365", "timeline": [{"oid": "8854de7a2b114d4d5be3b1ee525ec51bf0560a5c", "url": "https://github.com/confluentinc/ksql/commit/8854de7a2b114d4d5be3b1ee525ec51bf0560a5c", "message": "test: capture key and value formats as part of `QuerySchemas`\n\nWhen building a query, the `KsqlQueryBuilder` captures the schema and serde features used when creating each value serde.  This is later used by QTT to build historical plans that capture this information, giving us confidence that any changes we make aren't changing the schema and serde features being used by historical queries.\n\nThis commit extends this to capture details from _key_ serde, not just _value_ serde, and to capture full `KeyFormat` and `ValueFormat` info.\n\nThe benefit is two fold:  increased test coverage of historical plans and its a necessary improvement to enable testing of non-KAFKA key formats. A follow up PR will improve the `TopicInfoCache` to use this more detailed information.", "committedDate": "2020-10-06T16:32:59Z", "type": "commit"}, {"oid": "353e90280c6829c34a59193b391da046c5011a46", "url": "https://github.com/confluentinc/ksql/commit/353e90280c6829c34a59193b391da046c5011a46", "message": "test: historical plans", "committedDate": "2020-10-06T16:38:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU2NjE2Mg==", "url": "https://github.com/confluentinc/ksql/pull/6365#discussion_r500566162", "bodyText": "Is it worth adding a unit test to cover the merge() functionality required for tracking both key and value schema for the same logger prefix? I don't see coverage for that at the moment but I also don't feel too strongly since this code is essentially test-only.", "author": "vcrfxia", "createdAt": "2020-10-06T20:09:52Z", "path": "ksqldb-execution/src/test/java/io/confluent/ksql/execution/builder/KsqlQueryBuilderTest.java", "diffHunk": "@@ -234,39 +241,44 @@ public void shouldBuildValueSerde() {\n   }\n \n   @Test\n-  public void shouldTrackSchemasUsed() {\n+  public void shouldTrackKeySchemasUsed() {\n     // When:\n-    ksqlQueryBuilder.buildValueSerde(\n+    ksqlQueryBuilder.buildKeySerde(\n         FORMAT_INFO,\n-        SOME_SCHEMA,\n+        PHYSICAL_SCHEMA,\n         queryContext\n     );\n \n     // Then:\n-    final Map<String, PhysicalSchema> schemas = ksqlQueryBuilder.getSchemas().getSchemas();\n+    final Map<String, SchemaInfo> schemas = ksqlQueryBuilder.getSchemas().getSchemas();\n     assertThat(schemas.entrySet(), hasSize(1));\n-    assertThat(schemas.get(\"fred.context\"), is(SOME_SCHEMA));\n+    assertThat(schemas.get(\"fred.context\"), is(new SchemaInfo(\n+        LOGICAL_SCHEMA,\n+        Optional.of(KeyFormat.nonWindowed(\n+            FormatInfo.of(\"AVRO\", ImmutableMap.of(\"fullSchemaName\", \"io.confluent.ksql\")),\n+            SerdeFeatures.of(SerdeFeature.UNWRAP_SINGLES))),\n+        Optional.empty()\n+    )));\n   }\n \n   @Test\n-  public void shouldTrackSchemasTakingIntoAccountSerdeFeatures() {\n-    // Given:\n-    final PhysicalSchema schema = PhysicalSchema.from(\n-        SOME_SCHEMA.logicalSchema(),\n-        SerdeFeatures.of(),\n-        SerdeFeatures.of(SerdeFeature.UNWRAP_SINGLES)\n-    );\n-\n+  public void shouldTrackValueSchemasUsed() {", "originalCommit": "8854de7a2b114d4d5be3b1ee525ec51bf0560a5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU5MDU3MA==", "url": "https://github.com/confluentinc/ksql/pull/6365#discussion_r500590570", "bodyText": "I'll add to the follow up PR.", "author": "big-andy-coates", "createdAt": "2020-10-06T20:56:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU2NjE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU5NjkyMw==", "url": "https://github.com/confluentinc/ksql/pull/6365#discussion_r500596923", "bodyText": "see #6366", "author": "big-andy-coates", "createdAt": "2020-10-06T21:08:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU2NjE2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU2NjE5Mw==", "url": "https://github.com/confluentinc/ksql/pull/6365#discussion_r500566193", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void shouldRoundNoKeyFormat() {\n          \n          \n            \n              public void shouldRoundTripNoKeyFormat() {\n          \n      \n    \n    \n  \n\nand similarly for the other test below.", "author": "vcrfxia", "createdAt": "2020-10-06T20:09:55Z", "path": "ksqldb-functional-tests/src/test/java/io/confluent/ksql/test/model/SchemaNodeTest.java", "diffHunk": "@@ -39,7 +49,12 @@ public void shouldRoundTrip() {\n   }\n \n   @Test\n-  public void shouldRoundTripWithoutFeatures() {\n-    ModelTester.assertRoundTrip(NO_SERDE_FEATURES);\n+  public void shouldRoundNoKeyFormat() {", "originalCommit": "8854de7a2b114d4d5be3b1ee525ec51bf0560a5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU5MDYwMg==", "url": "https://github.com/confluentinc/ksql/pull/6365#discussion_r500590602", "bodyText": "I'll add to the follow up PR.", "author": "big-andy-coates", "createdAt": "2020-10-06T20:56:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU2NjE5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU5NjkwNQ==", "url": "https://github.com/confluentinc/ksql/pull/6365#discussion_r500596905", "bodyText": "see #6366", "author": "big-andy-coates", "createdAt": "2020-10-06T21:08:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU2NjE5Mw=="}], "type": "inlineReview"}]}