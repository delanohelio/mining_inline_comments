{"pr_number": 6553, "pr_title": "feat: add WITH clause and QUERY_ID property to INSERT INTO statements", "pr_createdAt": "2020-10-30T20:11:17Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6553", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM1MzM4OA==", "url": "https://github.com/confluentinc/ksql/pull/6553#discussion_r515353388", "bodyText": "I chose ID as the best name for this property. However, if it is confusing with the ID keyword in the schema (i.e. ID id int), then we can consider these options.\nwith (id = 'my_id')\nwith (query_id = 'my_id')\nwith (name = 'my_id')\nwith (alias = 'my_id')", "author": "spena", "createdAt": "2020-10-30T20:13:11Z", "path": "ksqldb-common/src/main/java/io/confluent/ksql/properties/with/InsertIntoConfigs.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.properties.with;\n+\n+import org.apache.kafka.common.config.ConfigDef;\n+\n+/**\n+ * 'With Clause' properties for 'INSERT INTO' statements.\n+ */\n+public final class InsertIntoConfigs {\n+  public static final String QUERY_ID_PROPERTY = \"ID\";", "originalCommit": "e2f2f6eaa7f811dcd6b86fcb3ea11938906835b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwNzgzMw==", "url": "https://github.com/confluentinc/ksql/pull/6553#discussion_r517007833", "bodyText": "I think originally I liked id, but now my preference is query_id \ud83d\ude02 it gives a little bit more clarity into what exactly it is. cc @colinhicks", "author": "agavra", "createdAt": "2020-11-03T23:06:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM1MzM4OA=="}], "type": "inlineReview"}, {"oid": "0c24324cac724808277d04779ec1b3c1d3802df3", "url": "https://github.com/confluentinc/ksql/commit/0c24324cac724808277d04779ec1b3c1d3802df3", "message": "feat: add WITH clause and ID property to INSERT INTO statements", "committedDate": "2020-11-02T16:42:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwNzk3Mg==", "url": "https://github.com/confluentinc/ksql/pull/6553#discussion_r517007972", "bodyText": "let's have some more detailed documentation here. What is it used for? what happens if it isn't supplied? what are valid values? is it case insensitive?", "author": "agavra", "createdAt": "2020-11-03T23:07:18Z", "path": "ksqldb-common/src/main/java/io/confluent/ksql/properties/with/InsertIntoConfigs.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.properties.with;\n+\n+import org.apache.kafka.common.config.ConfigDef;\n+\n+/**\n+ * 'With Clause' properties for 'INSERT INTO' statements.\n+ */\n+public final class InsertIntoConfigs {\n+  public static final String QUERY_ID_PROPERTY = \"ID\";\n+\n+  private static final ConfigDef CONFIG_DEF = new ConfigDef()\n+      .define(\n+          QUERY_ID_PROPERTY,\n+          ConfigDef.Type.STRING,\n+          null,\n+          ConfigDef.Importance.LOW,\n+          \"Custom query ID to use for INSERT INTO queries\"", "originalCommit": "0c24324cac724808277d04779ec1b3c1d3802df3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwOTc5OQ==", "url": "https://github.com/confluentinc/ksql/pull/6553#discussion_r517609799", "bodyText": "Done", "author": "spena", "createdAt": "2020-11-04T20:24:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwNzk3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwODI5MQ==", "url": "https://github.com/confluentinc/ksql/pull/6553#discussion_r517008291", "bodyText": "we should make this a ConfigDef.Validator and validate it as part of the config def", "author": "agavra", "createdAt": "2020-11-03T23:08:09Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/QueryIdUtil.java", "diffHunk": "@@ -24,18 +24,62 @@\n import io.confluent.ksql.query.QueryId;\n import io.confluent.ksql.query.id.QueryIdGenerator;\n import io.confluent.ksql.util.KsqlException;\n+\n+import java.util.Arrays;\n+import java.util.Optional;\n import java.util.Set;\n import java.util.concurrent.ThreadLocalRandom;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n \n /**\n  * Utility for constructing {@link QueryId}s - separate from {@code EngineExecutor} for\n  * easy access to unit testing.\n  */\n-final class QueryIdUtil {\n+public final class QueryIdUtil {\n+  private static final Pattern VALID_QUERY_ID = Pattern.compile(\"[A-Za-z0-9_]+\");\n+  private static final ReservedQueryIdsPrefixes[] PREFIXES = ReservedQueryIdsPrefixes.values();\n+\n+  public enum ReservedQueryIdsPrefixes {\n+    INSERT(\"INSERTQUERY_\"),\n+    CTAS(\"CTAS_\"),\n+    CSAS(\"CSAS_\");\n+\n+    private final String prefix;\n+    ReservedQueryIdsPrefixes(final String prefix) {\n+      this.prefix = prefix;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      return prefix;\n+    }\n+  }\n \n   private QueryIdUtil() {\n   }\n \n+  private static void validateWithQueryId(final String queryId) {", "originalCommit": "0c24324cac724808277d04779ec1b3c1d3802df3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwOTAzMA==", "url": "https://github.com/confluentinc/ksql/pull/6553#discussion_r517609030", "bodyText": "I initially thought of this, but I decided to do the validation in the QueryIdUtil to make sure that whoever wants to use that class, then they pass the right QueryID string. I don't think nobody else will use it, but I think is a better design as the buildId is the one will check IDs are correct.\nUnless you have another reason to use the Validator?", "author": "spena", "createdAt": "2020-11-04T20:22:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwODI5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMjI0MQ==", "url": "https://github.com/confluentinc/ksql/pull/6553#discussion_r517622241", "bodyText": "yeah that makes sense", "author": "agavra", "createdAt": "2020-11-04T20:48:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwODI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwOTgzMg==", "url": "https://github.com/confluentinc/ksql/pull/6553#discussion_r517009832", "bodyText": "should we also validate to make sure they don't register the same queryID twice? (please add a test for this)", "author": "agavra", "createdAt": "2020-11-03T23:12:41Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/QueryIdUtil.java", "diffHunk": "@@ -49,14 +93,21 @@ static QueryId buildId(\n       final MetaStore metaStore,\n       final QueryIdGenerator idGenerator,\n       final OutputNode outputNode,\n-      final boolean createOrReplaceEnabled) {\n+      final boolean createOrReplaceEnabled,\n+      final Optional<String> withQueryId) {\n+    if (withQueryId.isPresent()) {", "originalCommit": "0c24324cac724808277d04779ec1b3c1d3802df3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwOTQxNw==", "url": "https://github.com/confluentinc/ksql/pull/6553#discussion_r517609417", "bodyText": "Done. I added the validation in the EngineExecutor 'cause is the one that knows about IDs by calling the engineContext.getPersistentQuery.", "author": "spena", "createdAt": "2020-11-04T20:23:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwOTgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAxMDI1Nw==", "url": "https://github.com/confluentinc/ksql/pull/6553#discussion_r517010257", "bodyText": "let's specify here that this is only intended to be used by INSERT INTO - that way we can remove it when we remove INSERT INTO", "author": "agavra", "createdAt": "2020-11-03T23:14:03Z", "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/tree/QueryContainer.java", "diffHunk": "@@ -33,4 +35,11 @@\n    * @return the sink info.\n    */\n   Sink getSink();\n+\n+  /**\n+   * Return an optional query ID if specified by the user", "originalCommit": "0c24324cac724808277d04779ec1b3c1d3802df3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwOTcyOQ==", "url": "https://github.com/confluentinc/ksql/pull/6553#discussion_r517609729", "bodyText": "Done", "author": "spena", "createdAt": "2020-11-04T20:23:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAxMDI1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAxMDYyMw==", "url": "https://github.com/confluentinc/ksql/pull/6553#discussion_r517010623", "bodyText": "Can we add a test in RecoveryTest to make sure we can recover create/terminate with custom query IDs?", "author": "agavra", "createdAt": "2020-11-03T23:14:59Z", "path": "ksqldb-engine/src/test/java/io/confluent/ksql/engine/KsqlEngineTest.java", "diffHunk": "@@ -347,6 +347,31 @@ public void shouldThrowWhenInsertIntoSchemaDoesNotMatch() {\n         is(\"insert into bar select orderTime, itemid from orders;\")));\n   }\n \n+  @Test\n+  public void shouldExecuteInsertIntoWithCustomQueryId() {", "originalCommit": "0c24324cac724808277d04779ec1b3c1d3802df3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwOTQ3NA==", "url": "https://github.com/confluentinc/ksql/pull/6553#discussion_r517609474", "bodyText": "Done", "author": "spena", "createdAt": "2020-11-04T20:23:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAxMDYyMw=="}], "type": "inlineReview"}, {"oid": "3b669215474ea1c6d10302aca259e262a5029ed6", "url": "https://github.com/confluentinc/ksql/commit/3b669215474ea1c6d10302aca259e262a5029ed6", "message": "chore: work on PR feedback and Almog's suggestions\n\n- Change ID to QUERY_ID\n- Better comments in InsertIntoConfigs\n- Check if new QueryId already exists\n- Add RecoverTest test", "committedDate": "2020-11-04T20:19:05Z", "type": "forcePushed"}, {"oid": "f9d7d70a9eedc4377d1411f3c0344194e1447083", "url": "https://github.com/confluentinc/ksql/commit/f9d7d70a9eedc4377d1411f3c0344194e1447083", "message": "chore: fix test", "committedDate": "2020-11-05T15:40:45Z", "type": "forcePushed"}, {"oid": "66ce5e75c60b1234b7f88a59243734ea14fc97aa", "url": "https://github.com/confluentinc/ksql/commit/66ce5e75c60b1234b7f88a59243734ea14fc97aa", "message": "chore: fix test", "committedDate": "2020-11-05T21:49:19Z", "type": "forcePushed"}, {"oid": "e06547ce5069a84fa4bafc5f30bf54f120a8d33b", "url": "https://github.com/confluentinc/ksql/commit/e06547ce5069a84fa4bafc5f30bf54f120a8d33b", "message": "feat: add WITH clause and ID property to INSERT INTO statements", "committedDate": "2020-11-06T14:51:53Z", "type": "commit"}, {"oid": "5e6d37e3111114e90318b0bca8e151114efdc256", "url": "https://github.com/confluentinc/ksql/commit/5e6d37e3111114e90318b0bca8e151114efdc256", "message": "chore: work on PR feedback and Almog's suggestions\n\n- Change ID to QUERY_ID\n- Better comments in InsertIntoConfigs\n- Check if new QueryId already exists\n- Add RecoverTest test", "committedDate": "2020-11-06T14:51:53Z", "type": "commit"}, {"oid": "075bc02f8363e6fda60ba998e25fd047b1b96d31", "url": "https://github.com/confluentinc/ksql/commit/075bc02f8363e6fda60ba998e25fd047b1b96d31", "message": "chore: fix test", "committedDate": "2020-11-06T14:51:53Z", "type": "commit"}, {"oid": "075bc02f8363e6fda60ba998e25fd047b1b96d31", "url": "https://github.com/confluentinc/ksql/commit/075bc02f8363e6fda60ba998e25fd047b1b96d31", "message": "chore: fix test", "committedDate": "2020-11-06T14:51:53Z", "type": "forcePushed"}]}