{"pr_number": 5743, "pr_title": "fix: windowed tables now have cleanup policy compact+delete", "pr_createdAt": "2020-07-01T00:26:35Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5743", "timeline": [{"oid": "0d656012fa67e01c969db4cb6b7334137832e35c", "url": "https://github.com/confluentinc/ksql/commit/0d656012fa67e01c969db4cb6b7334137832e35c", "message": "fix: windowed tables now have cleanup policy compact+delete", "committedDate": "2020-06-30T23:29:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ2NDMzMA==", "url": "https://github.com/confluentinc/ksql/pull/5743#discussion_r448464330", "bodyText": "it seems that for create stream previously we were using the default for the cluster, but now we've changed that to explicitly specify delete. Is that correct/desired?", "author": "agavra", "createdAt": "2020-07-01T16:00:53Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/topic/TopicCreateInjector.java", "diffHunk": "@@ -175,13 +183,12 @@ public TopicCreateInjector(\n \n   private TopicProperties createTopic(\n       final Builder topicPropertiesBuilder,\n-      final boolean shouldCompactTopic\n+      final String topicCleanUpPolicy\n   ) {\n     final TopicProperties info = topicPropertiesBuilder.build();\n \n-    final Map<String, ?> config = shouldCompactTopic\n-        ? ImmutableMap.of(TopicConfig.CLEANUP_POLICY_CONFIG, TopicConfig.CLEANUP_POLICY_COMPACT)\n-        : Collections.emptyMap();\n+    final Map<String, ?> config =\n+        ImmutableMap.of(TopicConfig.CLEANUP_POLICY_CONFIG, topicCleanUpPolicy);", "originalCommit": "0d656012fa67e01c969db4cb6b7334137832e35c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ5ODgwMg==", "url": "https://github.com/confluentinc/ksql/pull/5743#discussion_r448498802", "bodyText": "The default is delete: https://kafka.apache.org/documentation/#cleanup.policy\nI thought explicitly specifying the policy was cleaner than having empty vs non-empty maps, but if there are situations you're concerned about in terms of correctness we should definitely investigate / return to passing empty maps.", "author": "vcrfxia", "createdAt": "2020-07-01T17:01:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ2NDMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUwMzM2Mg==", "url": "https://github.com/confluentinc/ksql/pull/5743#discussion_r448503362", "bodyText": "Something to check is to see if the CREATE STREAM code path will change the config of a topic to delete if it already exists. Another thing to consider if it's possible (though I wouldn't understand why anyone would do this) to change the default for the cluster for cleanup.policy. If neither of these are a real concern, then I'm happy making it explicit", "author": "agavra", "createdAt": "2020-07-01T17:10:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ2NDMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE5Njc2Ng==", "url": "https://github.com/confluentinc/ksql/pull/5743#discussion_r451196766", "bodyText": "Turns out it's possible to change the default cleanup.policy using the broker config log.cleanup.policy. I've switched this PR back to specifying empty configs in the case of streams in order to avoid a breaking change, but this behavior (using the default for streams and forcing tables to be compacted) feels weird to me. Is it preferable to use the broker default for streams, rather than specifying delete?", "author": "vcrfxia", "createdAt": "2020-07-07T23:20:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ2NDMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE5OTMzMA==", "url": "https://github.com/confluentinc/ksql/pull/5743#discussion_r451199330", "bodyText": "Good question, there's definitely a strong argument toward forcing delete for streams... I could be convinced either way, perhaps now I'm actually leaning a little bit toward your original code.", "author": "agavra", "createdAt": "2020-07-07T23:29:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ2NDMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg3MzMzMw==", "url": "https://github.com/confluentinc/ksql/pull/5743#discussion_r451873333", "bodyText": "OK, I'll go with the original then.\nRegarding your other question:\n\nSomething to check is to see if the CREATE STREAM code path will change the config of a topic to delete if it already exists.\n\nThis never happens since the KafkaTopicClient does not update topics if they exist. (It also doesn't even validate the cleanup policy, only number of replicas and partitions: \n  \n    \n      ksql/ksqldb-engine/src/main/java/io/confluent/ksql/services/KafkaTopicClientImpl.java\n    \n    \n         Line 96\n      in\n      220f7aa\n    \n    \n    \n    \n\n        \n          \n           validateTopicProperties(topic, numPartitions, replicationFactor); \n        \n    \n  \n\n)", "author": "vcrfxia", "createdAt": "2020-07-08T23:08:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ2NDMzMA=="}], "type": "inlineReview"}, {"oid": "5770306c711d3ea3cbef86c9aec169aaff9472e8", "url": "https://github.com/confluentinc/ksql/commit/5770306c711d3ea3cbef86c9aec169aaff9472e8", "message": "fix: kafka topic client now properly handles compact delete", "committedDate": "2020-07-06T17:27:12Z", "type": "commit"}, {"oid": "7ca1560a75dcfcb233bc3519d87f3d824c9c2c2a", "url": "https://github.com/confluentinc/ksql/commit/7ca1560a75dcfcb233bc3519d87f3d824c9c2c2a", "message": "chore: use default instead of specifying delete", "committedDate": "2020-07-07T23:18:20Z", "type": "commit"}, {"oid": "df833719743d21de22e18536580b23b07aa2bfbc", "url": "https://github.com/confluentinc/ksql/commit/df833719743d21de22e18536580b23b07aa2bfbc", "message": "Revert \"chore: use default instead of specifying delete\"\n\nThis reverts commit 7ca1560a75dcfcb233bc3519d87f3d824c9c2c2a.", "committedDate": "2020-07-08T23:03:11Z", "type": "commit"}]}