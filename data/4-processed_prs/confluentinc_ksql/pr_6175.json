{"pr_number": 6175, "pr_title": "docs: klip-36: grace period for stream-stream joins", "pr_createdAt": "2020-09-10T02:04:48Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6175", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2OTUzMQ==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r486669531", "bodyText": "Are there plans to remove the old syntax eventually?\nFor my own education: my understanding was that GRACE PERIOD is optional in aggregations? Is this correct? Would it be optional for stream-stream joins, too?\nFor Kafka Streams, we had a discussions about making it a mandatory parameter.", "author": "mjsax", "createdAt": "2020-09-10T22:31:24Z", "path": "design-proposals/klip-36-grace-stream-stream-joins.md", "diffHunk": "@@ -0,0 +1,102 @@\n+# KLIP 36 - GRACE period for stream-stream joins\n+\n+**Author**: agavra | \n+**Release Target**: 0.14 | \n+**Status**: In Discussion | \n+**Discussion**: TBD\n+\n+**tl;dr:** _Support controlling the GRACE period for a stream-stream join to improve disk space\n+utilization for small windows_\n+           \n+## Motivation and background\n+\n+As described in https://github.com/confluentinc/ksql/issues/6152, the ability to specify\n+the grace period for stream-stream joins allows more control over the disk space utilization.\n+This is because a window needs to stay on disk until the grace period has elapsed in order to\n+ensure that any events that come in timestamped during an old window can be processed as long\n+as the grace period is active. This means that for windows dramatically smaller than the grace\n+period (e.g. a minute) we need to keep that level of granularity for the default 24 hour window.\n+\n+## What is in scope\n+\n+- Syntax for specifying grace period within stream-stream joins\n+\n+## What is not in scope\n+\n+- N/A\n+\n+## Value/Return\n+\n+Enables onboarding use cases that perform stream-stream joins on high cardinality, high throughput\n+datasets with small windows without exhausting too much disk space.\n+\n+## Public APIS\n+\n+Stream-stream joins require use of `WITHIN` clauses:\n+\n+```\n+JOIN <stream> WITHIN <time unit> ON <condition>\n+```\n+\n+This will be expanded to support a more complex `withinExpression` that leverages the same\n+syntax as aggregation windows:\n+\n+```\n+JOIN <stream> WITHIN (SIZE <time unit>, GRACE PERIOD <time unit>) ON <condition>\n+```\n+\n+The old syntax will still be supported for backwards compatibility.", "originalCommit": "bc8c0fb147df1c95a87ca2610c1f89a6ccf98e18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3NDA2Mg==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r486674062", "bodyText": "Are there plans to remove the old syntax eventually?\n\nI think it would make sense to remove the old syntax for 1.0.\n\nWould it be optional for stream-stream joins, too?\n\nYes (this is necessary to allow the old syntax as well)", "author": "agavra", "createdAt": "2020-09-10T22:43:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2OTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4MzgyMg==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r486683822", "bodyText": "Well, even if we make it required, we could still set 24h if the old syntax is used, when translating the old to the new internally?", "author": "mjsax", "createdAt": "2020-09-10T23:14:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2OTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMzMDU1NA==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r492330554", "bodyText": "With reference to recent discussions around supporting older versions of the syntax for longer...  we'd likely want to support the old syntax for a while.", "author": "big-andy-coates", "createdAt": "2020-09-21T20:35:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2OTUzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2OTc4NA==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r486669784", "bodyText": "Ah, so it should be optionally?", "author": "mjsax", "createdAt": "2020-09-10T22:32:08Z", "path": "design-proposals/klip-36-grace-stream-stream-joins.md", "diffHunk": "@@ -0,0 +1,102 @@\n+# KLIP 36 - GRACE period for stream-stream joins\n+\n+**Author**: agavra | \n+**Release Target**: 0.14 | \n+**Status**: In Discussion | \n+**Discussion**: TBD\n+\n+**tl;dr:** _Support controlling the GRACE period for a stream-stream join to improve disk space\n+utilization for small windows_\n+           \n+## Motivation and background\n+\n+As described in https://github.com/confluentinc/ksql/issues/6152, the ability to specify\n+the grace period for stream-stream joins allows more control over the disk space utilization.\n+This is because a window needs to stay on disk until the grace period has elapsed in order to\n+ensure that any events that come in timestamped during an old window can be processed as long\n+as the grace period is active. This means that for windows dramatically smaller than the grace\n+period (e.g. a minute) we need to keep that level of granularity for the default 24 hour window.\n+\n+## What is in scope\n+\n+- Syntax for specifying grace period within stream-stream joins\n+\n+## What is not in scope\n+\n+- N/A\n+\n+## Value/Return\n+\n+Enables onboarding use cases that perform stream-stream joins on high cardinality, high throughput\n+datasets with small windows without exhausting too much disk space.\n+\n+## Public APIS\n+\n+Stream-stream joins require use of `WITHIN` clauses:\n+\n+```\n+JOIN <stream> WITHIN <time unit> ON <condition>\n+```\n+\n+This will be expanded to support a more complex `withinExpression` that leverages the same\n+syntax as aggregation windows:\n+\n+```\n+JOIN <stream> WITHIN (SIZE <time unit>, GRACE PERIOD <time unit>) ON <condition>\n+```\n+\n+The old syntax will still be supported for backwards compatibility.\n+\n+## Design\n+\n+The `WITHIN` clause will be converted into a `KsqlWindowExpression`, and then converted into\n+a `JoinWindows grace(final Duration afterWindowEnd)` call on the `JoinWindows` in the \n+`StreamStreamJoinBuilder`.\n+\n+## Test plan\n+\n+We will add the usual QTT tests to ensure that the system respects the new retention limits\n+and manually test to ensure that we clean up the RocksDB state for expired windows.\n+\n+## LOEs and Delivery Milestones\n+\n+Small LOE - under 2 weeks of engineering time to deliver the syntax and implementation.\n+\n+## Documentation Updates\n+\n+The entry in `join-streams-and-tables.md` will be updated to include the following:\n+\n+```md\n+When you join two streams, you must specify a WITHIN clause for matching\n+records that both occur within a specified time interval and optionally a", "originalCommit": "bc8c0fb147df1c95a87ca2610c1f89a6ccf98e18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwNjk2NQ==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r486706965", "bodyText": "Curious to hear what other people think? Should GRACE PERIOD be optional? The current default of 24h is rather \"random\" and using a default of zero implies bad out-of-the-box behavior with regard to out-of-order data -- we would discard out-of-order records very aggressively as later records.", "author": "mjsax", "createdAt": "2020-09-11T00:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2OTc4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY3MjU0MA==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r488672540", "bodyText": "Making it optional would follow the current pattern when you specify the grace period on a windowed aggregation.  As to the default of 24h, I'm not sure what the right answer here is.  For my specific use case of KSQL it's way too big, although for someone else it could be too small.  Ideally I'd like a init parameter I could set to have better control over the default behavior.  Then a 24h value  as a default is probably a good starting point.", "author": "thomas-tomlinson", "createdAt": "2020-09-15T13:36:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2OTc4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIzMDc5Mw==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r491230793", "bodyText": "Making it optional would follow the current pattern when you specify the grace period on a windowed aggregation.\n\nYes, but I am wondering if it should be mandatory for windowed aggregations, too? (Might be it's own KLIP thought.)\n\nAs to the default of 24h, I'm not sure what the right answer here is.\n\nI guess there is no right answer. This is exactly my point: if there is no reasonable default, it seems to imply that there shouldn't be any default but it should be mandatory?", "author": "mjsax", "createdAt": "2020-09-18T23:11:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2OTc4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMzMjk0Nw==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r492332947", "bodyText": "I think long term if should be required. However, we need to be backwards compatible, which means in the medium term it needs to be optional.\nPersonally, I would change the wording from and optionally `` to and it is recommended to supply a`.\nIn the docs I'd also detail what the default it and explain what the trade of is here, i.e. longer grace period means more storage, shorter grace period means less storage required.", "author": "big-andy-coates", "createdAt": "2020-09-21T20:40:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2OTc4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg0NDMxNw==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r492844317", "bodyText": "I agree with @big-andy-coates, considering backward compatibility. We should recommend setting the grace period, but not require it for now.", "author": "colinhicks", "createdAt": "2020-09-22T15:46:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2OTc4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3MDAyNQ==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r486670025", "bodyText": "late -> out-of-order\nor better will define for how long out-of-order records will be accepted.", "author": "mjsax", "createdAt": "2020-09-10T22:32:48Z", "path": "design-proposals/klip-36-grace-stream-stream-joins.md", "diffHunk": "@@ -0,0 +1,102 @@\n+# KLIP 36 - GRACE period for stream-stream joins\n+\n+**Author**: agavra | \n+**Release Target**: 0.14 | \n+**Status**: In Discussion | \n+**Discussion**: TBD\n+\n+**tl;dr:** _Support controlling the GRACE period for a stream-stream join to improve disk space\n+utilization for small windows_\n+           \n+## Motivation and background\n+\n+As described in https://github.com/confluentinc/ksql/issues/6152, the ability to specify\n+the grace period for stream-stream joins allows more control over the disk space utilization.\n+This is because a window needs to stay on disk until the grace period has elapsed in order to\n+ensure that any events that come in timestamped during an old window can be processed as long\n+as the grace period is active. This means that for windows dramatically smaller than the grace\n+period (e.g. a minute) we need to keep that level of granularity for the default 24 hour window.\n+\n+## What is in scope\n+\n+- Syntax for specifying grace period within stream-stream joins\n+\n+## What is not in scope\n+\n+- N/A\n+\n+## Value/Return\n+\n+Enables onboarding use cases that perform stream-stream joins on high cardinality, high throughput\n+datasets with small windows without exhausting too much disk space.\n+\n+## Public APIS\n+\n+Stream-stream joins require use of `WITHIN` clauses:\n+\n+```\n+JOIN <stream> WITHIN <time unit> ON <condition>\n+```\n+\n+This will be expanded to support a more complex `withinExpression` that leverages the same\n+syntax as aggregation windows:\n+\n+```\n+JOIN <stream> WITHIN (SIZE <time unit>, GRACE PERIOD <time unit>) ON <condition>\n+```\n+\n+The old syntax will still be supported for backwards compatibility.\n+\n+## Design\n+\n+The `WITHIN` clause will be converted into a `KsqlWindowExpression`, and then converted into\n+a `JoinWindows grace(final Duration afterWindowEnd)` call on the `JoinWindows` in the \n+`StreamStreamJoinBuilder`.\n+\n+## Test plan\n+\n+We will add the usual QTT tests to ensure that the system respects the new retention limits\n+and manually test to ensure that we clean up the RocksDB state for expired windows.\n+\n+## LOEs and Delivery Milestones\n+\n+Small LOE - under 2 weeks of engineering time to deliver the syntax and implementation.\n+\n+## Documentation Updates\n+\n+The entry in `join-streams-and-tables.md` will be updated to include the following:\n+\n+```md\n+When you join two streams, you must specify a WITHIN clause for matching\n+records that both occur within a specified time interval and optionally a\n+grace period. The WITHIN clause will specify the \"look back\" period on \n+the non-triggering stream while the grace period will define how late a record", "originalCommit": "bc8c0fb147df1c95a87ca2610c1f89a6ccf98e18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3MTAwMg==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r486671002", "bodyText": "This seems like some optimization potential? If one joins specifies a grace-period, we could auto-set it for the other join, too, saving storage but not losing any results?", "author": "mjsax", "createdAt": "2020-09-10T22:35:22Z", "path": "design-proposals/klip-36-grace-stream-stream-joins.md", "diffHunk": "@@ -0,0 +1,102 @@\n+# KLIP 36 - GRACE period for stream-stream joins\n+\n+**Author**: agavra | \n+**Release Target**: 0.14 | \n+**Status**: In Discussion | \n+**Discussion**: TBD\n+\n+**tl;dr:** _Support controlling the GRACE period for a stream-stream join to improve disk space\n+utilization for small windows_\n+           \n+## Motivation and background\n+\n+As described in https://github.com/confluentinc/ksql/issues/6152, the ability to specify\n+the grace period for stream-stream joins allows more control over the disk space utilization.\n+This is because a window needs to stay on disk until the grace period has elapsed in order to\n+ensure that any events that come in timestamped during an old window can be processed as long\n+as the grace period is active. This means that for windows dramatically smaller than the grace\n+period (e.g. a minute) we need to keep that level of granularity for the default 24 hour window.\n+\n+## What is in scope\n+\n+- Syntax for specifying grace period within stream-stream joins\n+\n+## What is not in scope\n+\n+- N/A\n+\n+## Value/Return\n+\n+Enables onboarding use cases that perform stream-stream joins on high cardinality, high throughput\n+datasets with small windows without exhausting too much disk space.\n+\n+## Public APIS\n+\n+Stream-stream joins require use of `WITHIN` clauses:\n+\n+```\n+JOIN <stream> WITHIN <time unit> ON <condition>\n+```\n+\n+This will be expanded to support a more complex `withinExpression` that leverages the same\n+syntax as aggregation windows:\n+\n+```\n+JOIN <stream> WITHIN (SIZE <time unit>, GRACE PERIOD <time unit>) ON <condition>\n+```\n+\n+The old syntax will still be supported for backwards compatibility.\n+\n+## Design\n+\n+The `WITHIN` clause will be converted into a `KsqlWindowExpression`, and then converted into\n+a `JoinWindows grace(final Duration afterWindowEnd)` call on the `JoinWindows` in the \n+`StreamStreamJoinBuilder`.\n+\n+## Test plan\n+\n+We will add the usual QTT tests to ensure that the system respects the new retention limits\n+and manually test to ensure that we clean up the RocksDB state for expired windows.\n+\n+## LOEs and Delivery Milestones\n+\n+Small LOE - under 2 weeks of engineering time to deliver the syntax and implementation.\n+\n+## Documentation Updates\n+\n+The entry in `join-streams-and-tables.md` will be updated to include the following:\n+\n+```md\n+When you join two streams, you must specify a WITHIN clause for matching\n+records that both occur within a specified time interval and optionally a\n+grace period. The WITHIN clause will specify the \"look back\" period on \n+the non-triggering stream while the grace period will define how late a record\n+may arrive before being processed.\n+\n+For valid time units, see [Time Units](../syntax-reference.md#time-units).\n+\n+Here's an example stream-stream-stream join that combines `orders`, `payments` and `shipments` \n+streams. The resulting ``shipped_orders`` stream contains all orders paid within 1 hour of when\n+the order was placed, and shipped within 2 hours of the payment being received. \n+\n+   CREATE STREAM shipped_orders AS\n+     SELECT \n+        o.id as orderId \n+        o.itemid as itemId,\n+        s.id as shipmentId,\n+        p.id as paymentId\n+     FROM orders o\n+        INNER JOIN payments p WITHIN 1 HOURS ON p.id = o.id\n+        INNER JOIN shipments s WITHIN (SIZE 2 HOURS, GRACE PERIOD 30 MINUTES) ON s.id = o.id;", "originalCommit": "bc8c0fb147df1c95a87ca2610c1f89a6ccf98e18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3NTUwNg==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r486675506", "bodyText": "Shouldn't it be valid to have different grace periods on different windows? Why would we want to auto-set it for the other window? I think you understand something I don't \ud83d\ude02", "author": "agavra", "createdAt": "2020-09-10T22:48:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3MTAwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY4NTI3Mg==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r486685272", "bodyText": "Well, you can of course allow this, but it won't buy the user anything (depending on the order of the joins). It seems the lower grace period of the second join limits what you get in your result anyway? If the first join allows to join two records that are 20h old, the result timestamp of the intermediate record would be 20h, too, and thus the second join would drop it.\nThere would be some details to figure out, ie, maybe think hard (or formally prove) that it's safe to reduce the grace period (but this might not necessarily be part of the KLIP I guess -- was just a thought and we might want to track it at least with a ticket).", "author": "mjsax", "createdAt": "2020-09-10T23:19:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3MTAwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwNDkxMA==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r486704910", "bodyText": "I figured your reasoning would be something along those lines, but I wasn't sure that that hold for all window size/grace period combinations. I need to wrap my head around it a little more (I'll try to get back with a more concrete example), but I'm not convinced that that's always safe to drop - e.g. what would happen if the second window size was much larger than the first window size in your example?", "author": "agavra", "createdAt": "2020-09-11T00:28:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3MTAwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwNTk5NQ==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r486705995", "bodyText": "Agreed. It's not totally straightforward when we can do what... And as I said, we don't need to make it part of the KLIP. But we should have a ticket \"Optimize grace periods for chained stream-stream joins\" (maybe with one or two illustrating examples) -- just to make sure we get to it at some point. We also don't need to implement it as part of the KLIP.", "author": "mjsax", "createdAt": "2020-09-11T00:32:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3MTAwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ3MDgwMA==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r490470800", "bodyText": "I am a bit confused here by terminology. The WITHIN clause applies to the non-triggering join argument/to the join argument on which it is specified? This means, in this example that we check the timestamp of the record of payments? And the GRACE clause applies as well to the join argument on which it is specified? In this example, shipments? So, to accept out-of-order records we just check the timestamp of shipment records?", "author": "vpapavas", "createdAt": "2020-09-17T18:30:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3MTAwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIyOTgyMQ==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r491229821", "bodyText": "The grace period is base on \"stream-time\" progress. Ie, if an out-of-order record comes in, with ts < stream-time - grace-period the record is dropped. So records from either input may be dropped as late. Note that \"stream-time\" is advanced based on records of both input streams.\nDoes this answer your question?", "author": "mjsax", "createdAt": "2020-09-18T23:06:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY3MTAwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMzNTIzMw==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r492335233", "bodyText": "We should probably avoid breaking changes in the syntax until we have a mechanism for dealing with them and supporting multiple language versions.  That said, I guess the KLIP can still detail what the final outcome should be, even if we delay implementing the breaking change for a bit.", "author": "big-andy-coates", "createdAt": "2020-09-21T20:44:40Z", "path": "design-proposals/klip-36-grace-stream-stream-joins.md", "diffHunk": "@@ -0,0 +1,102 @@\n+# KLIP 36 - GRACE period for stream-stream joins\n+\n+**Author**: agavra | \n+**Release Target**: 0.14 | \n+**Status**: In Discussion | \n+**Discussion**: TBD\n+\n+**tl;dr:** _Support controlling the GRACE period for a stream-stream join to improve disk space\n+utilization for small windows_\n+           \n+## Motivation and background\n+\n+As described in https://github.com/confluentinc/ksql/issues/6152, the ability to specify\n+the grace period for stream-stream joins allows more control over the disk space utilization.\n+This is because a window needs to stay on disk until the grace period has elapsed in order to\n+ensure that any events that come in timestamped during an old window can be processed as long\n+as the grace period is active. This means that for windows dramatically smaller than the grace\n+period (e.g. a minute) we need to keep that level of granularity for the default 24 hour window.\n+\n+## What is in scope\n+\n+- Syntax for specifying grace period within stream-stream joins\n+\n+## What is not in scope\n+\n+- N/A\n+\n+## Value/Return\n+\n+Enables onboarding use cases that perform stream-stream joins on high cardinality, high throughput\n+datasets with small windows without exhausting too much disk space.\n+\n+## Public APIS\n+\n+Stream-stream joins require use of `WITHIN` clauses:\n+\n+```\n+JOIN <stream> WITHIN <time unit> ON <condition>\n+```\n+\n+This will be expanded to support a more complex `withinExpression` that leverages the same\n+syntax as aggregation windows:\n+\n+```\n+JOIN <stream> WITHIN (SIZE <time unit>, GRACE PERIOD <time unit>) ON <condition>\n+```\n+\n+The old syntax will still be supported for backwards compatibility.\n+\n+## Design\n+\n+The `WITHIN` clause will be converted into a `KsqlWindowExpression`, and then converted into\n+a `JoinWindows grace(final Duration afterWindowEnd)` call on the `JoinWindows` in the \n+`StreamStreamJoinBuilder`.\n+\n+## Test plan\n+\n+We will add the usual QTT tests to ensure that the system respects the new retention limits\n+and manually test to ensure that we clean up the RocksDB state for expired windows.\n+\n+## LOEs and Delivery Milestones\n+\n+Small LOE - under 2 weeks of engineering time to deliver the syntax and implementation.\n+\n+## Documentation Updates\n+\n+The entry in `join-streams-and-tables.md` will be updated to include the following:\n+\n+```md\n+When you join two streams, you must specify a WITHIN clause for matching\n+records that both occur within a specified time interval and optionally a\n+grace period. The WITHIN clause will specify the \"look back\" period on \n+the non-triggering stream while the grace period will define how late a record\n+may arrive before being processed.\n+\n+For valid time units, see [Time Units](../syntax-reference.md#time-units).\n+\n+Here's an example stream-stream-stream join that combines `orders`, `payments` and `shipments` \n+streams. The resulting ``shipped_orders`` stream contains all orders paid within 1 hour of when\n+the order was placed, and shipped within 2 hours of the payment being received. \n+\n+   CREATE STREAM shipped_orders AS\n+     SELECT \n+        o.id as orderId \n+        o.itemid as itemId,\n+        s.id as shipmentId,\n+        p.id as paymentId\n+     FROM orders o\n+        INNER JOIN payments p WITHIN 1 HOURS ON p.id = o.id\n+        INNER JOIN shipments s WITHIN (SIZE 2 HOURS, GRACE PERIOD 30 MINUTES) ON s.id = o.id;\n+```\n+\n+## Compatibility Implications\n+\n+- We should consider whether we want to support the older syntax or require all new joins\n+    to use the `(SIZE <size>, GRACE PERIOD <size>)` syntax (noting that `GRACE PERIOD` will\n+    be optional).", "originalCommit": "bc8c0fb147df1c95a87ca2610c1f89a6ccf98e18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMjUxMg==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r492702512", "bodyText": "It's too bad there's no easy way to automate this. I was wondering if we could do something similar to KsMaterializationFunctionalTest which verifies retention for windowed aggregates (link) but we'd have to expose the state stores for that which feels like overkill for purposes of testing.", "author": "vcrfxia", "createdAt": "2020-09-22T12:44:28Z", "path": "design-proposals/klip-36-grace-stream-stream-joins.md", "diffHunk": "@@ -0,0 +1,102 @@\n+# KLIP 36 - GRACE period for stream-stream joins\n+\n+**Author**: agavra | \n+**Release Target**: 0.14 | \n+**Status**: In Discussion | \n+**Discussion**: TBD\n+\n+**tl;dr:** _Support controlling the GRACE period for a stream-stream join to improve disk space\n+utilization for small windows_\n+           \n+## Motivation and background\n+\n+As described in https://github.com/confluentinc/ksql/issues/6152, the ability to specify\n+the grace period for stream-stream joins allows more control over the disk space utilization.\n+This is because a window needs to stay on disk until the grace period has elapsed in order to\n+ensure that any events that come in timestamped during an old window can be processed as long\n+as the grace period is active. This means that for windows dramatically smaller than the grace\n+period (e.g. a minute) we need to keep that level of granularity for the default 24 hour window.\n+\n+## What is in scope\n+\n+- Syntax for specifying grace period within stream-stream joins\n+\n+## What is not in scope\n+\n+- N/A\n+\n+## Value/Return\n+\n+Enables onboarding use cases that perform stream-stream joins on high cardinality, high throughput\n+datasets with small windows without exhausting too much disk space.\n+\n+## Public APIS\n+\n+Stream-stream joins require use of `WITHIN` clauses:\n+\n+```\n+JOIN <stream> WITHIN <time unit> ON <condition>\n+```\n+\n+This will be expanded to support a more complex `withinExpression` that leverages the same\n+syntax as aggregation windows:\n+\n+```\n+JOIN <stream> WITHIN (SIZE <time unit>, GRACE PERIOD <time unit>) ON <condition>\n+```\n+\n+The old syntax will still be supported for backwards compatibility.\n+\n+## Design\n+\n+The `WITHIN` clause will be converted into a `KsqlWindowExpression`, and then converted into\n+a `JoinWindows grace(final Duration afterWindowEnd)` call on the `JoinWindows` in the \n+`StreamStreamJoinBuilder`.\n+\n+## Test plan\n+\n+We will add the usual QTT tests to ensure that the system respects the new retention limits\n+and manually test to ensure that we clean up the RocksDB state for expired windows.", "originalCommit": "bc8c0fb147df1c95a87ca2610c1f89a6ccf98e18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg1ODIxOQ==", "url": "https://github.com/confluentinc/ksql/pull/6175#discussion_r493858219", "bodyText": "I think the saving grace here is that we can test that we properly set the grace period, and then trust that Kafka Streams tests their public APIs (we can't test everything in Kafka Streams - but that's OK)", "author": "agavra", "createdAt": "2020-09-23T19:56:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMjUxMg=="}], "type": "inlineReview"}, {"oid": "d3455cc566640975847c6b80748d7a2a63634698", "url": "https://github.com/confluentinc/ksql/commit/d3455cc566640975847c6b80748d7a2a63634698", "message": "docs: klip-36: grace period for stream-stream joins", "committedDate": "2020-09-23T19:58:56Z", "type": "commit"}, {"oid": "c07a10740e8775838f162604780174dc0f1d4b47", "url": "https://github.com/confluentinc/ksql/commit/c07a10740e8775838f162604780174dc0f1d4b47", "message": "docs: minor updates", "committedDate": "2020-09-23T19:58:57Z", "type": "commit"}, {"oid": "c07a10740e8775838f162604780174dc0f1d4b47", "url": "https://github.com/confluentinc/ksql/commit/c07a10740e8775838f162604780174dc0f1d4b47", "message": "docs: minor updates", "committedDate": "2020-09-23T19:58:57Z", "type": "forcePushed"}]}