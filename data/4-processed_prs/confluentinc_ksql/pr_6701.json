{"pr_number": 6701, "pr_title": "fix: Makes response codes rate limited as well as prints a message when it is hit", "pr_createdAt": "2020-12-02T02:31:52Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6701", "timeline": [{"oid": "7f1edb14d0045ba9c0188c28698bbcb50fa124d1", "url": "https://github.com/confluentinc/ksql/commit/7f1edb14d0045ba9c0188c28698bbcb50fa124d1", "message": "fix: Makes response codes rate limited as well as prints a message when it is hit", "committedDate": "2020-12-02T02:28:48Z", "type": "commit"}, {"oid": "8673feccf6c3eac95958ed110e4bb16fbee184d3", "url": "https://github.com/confluentinc/ksql/commit/8673feccf6c3eac95958ed110e4bb16fbee184d3", "message": "Fix test name", "committedDate": "2020-12-02T02:30:35Z", "type": "commit"}, {"oid": "48282a47e0339128a381871336b39004f9a27e9f", "url": "https://github.com/confluentinc/ksql/commit/48282a47e0339128a381871336b39004f9a27e9f", "message": "Adds some more pairs to map test case", "committedDate": "2020-12-02T17:16:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUzMDMzMA==", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r534530330", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            logging.  This is useful for limiting certain 4XX errors that you\n          \n          \n            \n            logging. This is useful for limiting certain 4XX errors that you", "author": "JimGalasyn", "createdAt": "2020-12-02T22:39:53Z", "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -612,11 +612,13 @@ property has the value `KSQL_PROCESSING_LOG`.\n Toggles whether or not the processing log should include rows in log\n messages. By default, this property has the value `false`.\n \n-### ksql.logging.server.skipped.response.codes\n+### ksql.logging.server.rate.limited.response.codes\n \n-A comma-separated list of HTTP response codes to skip during server\n-request logging. This is useful for ignoring certain 4XX errors that you\n-might not want to show up in the logs.\n+A list of `path:rate_limit` pairs, to limit the rate of server request\n+logging.  This is useful for limiting certain 4XX errors that you", "originalCommit": "48282a47e0339128a381871336b39004f9a27e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6836df9edc6a3a5be388f5adeaba02bc1187970c", "url": "https://github.com/confluentinc/ksql/commit/6836df9edc6a3a5be388f5adeaba02bc1187970c", "message": "Apply suggestions from code review\n\nCo-authored-by: Jim Galasyn <jim.galasyn@confluent.io>", "committedDate": "2020-12-03T17:51:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxNTc4OQ==", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r535715789", "bodyText": "Clarify the units of the rate limit (and also for the other config below). Appears to be number of messages per second?", "author": "vcrfxia", "createdAt": "2020-12-03T23:14:30Z", "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -612,11 +612,13 @@ property has the value `KSQL_PROCESSING_LOG`.\n Toggles whether or not the processing log should include rows in log\n messages. By default, this property has the value `false`.\n \n-### ksql.logging.server.skipped.response.codes\n+### ksql.logging.server.rate.limited.response.codes\n \n-A comma-separated list of HTTP response codes to skip during server\n-request logging. This is useful for ignoring certain 4XX errors that you\n-might not want to show up in the logs.\n+A list of `path:rate_limit` pairs, to limit the rate of server request", "originalCommit": "6836df9edc6a3a5be388f5adeaba02bc1187970c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ3MjkxMg==", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r536472912", "bodyText": "I clarified it's qps and even explicitly write out 10 logs per second as an example.", "author": "AlanConfluent", "createdAt": "2020-12-05T01:23:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxNTc4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxNTc5OQ==", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r535715799", "bodyText": "Mention that a message will be logged (at most once every five seconds) if the threshold is hit? (And same for the other config below.)", "author": "vcrfxia", "createdAt": "2020-12-03T23:14:32Z", "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -612,11 +612,13 @@ property has the value `KSQL_PROCESSING_LOG`.\n Toggles whether or not the processing log should include rows in log\n messages. By default, this property has the value `false`.\n \n-### ksql.logging.server.skipped.response.codes\n+### ksql.logging.server.rate.limited.response.codes\n \n-A comma-separated list of HTTP response codes to skip during server\n-request logging. This is useful for ignoring certain 4XX errors that you\n-might not want to show up in the logs.\n+A list of `path:rate_limit` pairs, to limit the rate of server request\n+logging. This is useful for limiting certain 4XX errors that you\n+might not want to blow up in the logs. \n+This setting enables seeing the logs when the request rate is low \n+and dropping them when they go over the threshold.", "originalCommit": "6836df9edc6a3a5be388f5adeaba02bc1187970c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ3MzQ4NQ==", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r536473485", "bodyText": "Done", "author": "AlanConfluent", "createdAt": "2020-12-05T01:25:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxNTc5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxNjEyNA==", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r535716124", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              // Print \"You hit a rate limit\" every 5 seconds\n          \n          \n            \n              // Print \"You hit a rate limit\" at most once every 5 seconds", "author": "vcrfxia", "createdAt": "2020-12-03T23:15:20Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/LoggingRateLimiter.java", "diffHunk": "@@ -26,13 +27,23 @@\n import java.util.Map.Entry;\n import java.util.concurrent.ConcurrentHashMap;\n import java.util.function.Function;\n+import org.slf4j.Logger;\n \n class LoggingRateLimiter {\n+  // Print \"You hit a rate limit\" every 5 seconds", "originalCommit": "6836df9edc6a3a5be388f5adeaba02bc1187970c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxNzEzMg==", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r535717132", "bodyText": "Would it be better to initialize the rate limiters up front, rather than calling computeIfAbsent on each request? I don't have a sense of how large this optimization is, feels minor but I also feel it can't hurt. Feel free to disagree.", "author": "vcrfxia", "createdAt": "2020-12-03T23:17:44Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/LoggingRateLimiter.java", "diffHunk": "@@ -45,13 +56,33 @@\n     requireNonNull(ksqlRestConfig);\n     this.rateLimiterFactory = requireNonNull(rateLimiterFactory);\n     this.rateLimitedPaths = getRateLimitedRequestPaths(ksqlRestConfig);\n+    this.rateLimitedResponseCodes = getRateLimitedResponseCodes(ksqlRestConfig);\n+    this.pathLimitHit = rateLimiterFactory.apply(LIMIT_HIT_LOG_RATE);\n+    this.responseCodeLimitHit = rateLimiterFactory.apply(LIMIT_HIT_LOG_RATE);\n   }\n \n-  public boolean shouldLog(final String path) {\n+  public boolean shouldLog(final Logger logger, final String path, final int responseCode) {\n     if (rateLimitedPaths.containsKey(path)) {\n       final double rateLimit = rateLimitedPaths.get(path);\n-      rateLimiters.computeIfAbsent(path, (k) -> rateLimiterFactory.apply(rateLimit));\n-      return rateLimiters.get(path).tryAcquire();\n+      rateLimitersByPath.computeIfAbsent(path, (k) -> rateLimiterFactory.apply(rateLimit));", "originalCommit": "6836df9edc6a3a5be388f5adeaba02bc1187970c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ5NDY4Ng==", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r536494686", "bodyText": "Yeah, you're right.  The data is static and not large, so why not just make an immutable map instead on initialization?\nI was originally thinking it might be dynamic, but it's not currently.", "author": "AlanConfluent", "createdAt": "2020-12-05T03:27:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxNzEzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxNzI4NA==", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r535717284", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Already validated as all ints\n          \n          \n            \n                // Already validated as having int keys and double values", "author": "vcrfxia", "createdAt": "2020-12-03T23:18:06Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/LoggingRateLimiter.java", "diffHunk": "@@ -64,4 +95,12 @@ public boolean shouldLog(final String path) {\n             entry -> Double.parseDouble(entry.getValue())));\n   }\n \n+  private static Map<Integer, Double> getRateLimitedResponseCodes(final KsqlRestConfig config) {\n+    // Already validated as all ints", "originalCommit": "6836df9edc6a3a5be388f5adeaba02bc1187970c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxODkyOQ==", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r535718929", "bodyText": "We're currently logging for internal endpoints (used in server-to-server communication for multi-node clusters), right? Would it make sense to disable logging for those by default? (I don't feel strongly one way or the other -- you have more context than I do about when/how often those endpoints are hit.)", "author": "vcrfxia", "createdAt": "2020-12-03T23:21:57Z", "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -612,11 +612,13 @@ property has the value `KSQL_PROCESSING_LOG`.\n Toggles whether or not the processing log should include rows in log\n messages. By default, this property has the value `false`.\n \n-### ksql.logging.server.skipped.response.codes\n+### ksql.logging.server.rate.limited.response.codes\n \n-A comma-separated list of HTTP response codes to skip during server\n-request logging. This is useful for ignoring certain 4XX errors that you\n-might not want to show up in the logs.\n+A list of `path:rate_limit` pairs, to limit the rate of server request\n+logging. This is useful for limiting certain 4XX errors that you\n+might not want to blow up in the logs. \n+This setting enables seeing the logs when the request rate is low \n+and dropping them when they go over the threshold.\n \n ### ksql.logging.server.rate.limited.request.paths", "originalCommit": "6836df9edc6a3a5be388f5adeaba02bc1187970c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ3Mzg2Ng==", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r536473866", "bodyText": "Yes, currently we log all requests, regardless of internal/external status.  I think this could be useful if we're trying to trace pull queries falling back on standbys after failures.  We can see if this ends up being useful and potentially remove internal if not.", "author": "AlanConfluent", "createdAt": "2020-12-05T01:27:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxODkyOQ=="}], "type": "inlineReview"}, {"oid": "1c0ec7a1831f58107c61b7d0fc886bdae67985e2", "url": "https://github.com/confluentinc/ksql/commit/1c0ec7a1831f58107c61b7d0fc886bdae67985e2", "message": "Feedback", "committedDate": "2020-12-05T03:25:24Z", "type": "commit"}, {"oid": "1c0ec7a1831f58107c61b7d0fc886bdae67985e2", "url": "https://github.com/confluentinc/ksql/commit/1c0ec7a1831f58107c61b7d0fc886bdae67985e2", "message": "Feedback", "committedDate": "2020-12-05T03:25:24Z", "type": "forcePushed"}, {"oid": "be9466426eb287001617948fdbace88172900443", "url": "https://github.com/confluentinc/ksql/commit/be9466426eb287001617948fdbace88172900443", "message": "Lint", "committedDate": "2020-12-05T03:45:18Z", "type": "commit"}]}