{"pr_number": 6295, "pr_title": "fix: JSON format to set correct scale of decimals", "pr_createdAt": "2020-09-24T15:20:46Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6295", "timeline": [{"oid": "bb31ed747ee6a0bc5522df6ce79d0bb9a7f4ee78", "url": "https://github.com/confluentinc/ksql/commit/bb31ed747ee6a0bc5522df6ce79d0bb9a7f4ee78", "message": "fix: JSON format should correct scale of decimals when deserializing\n\nIt is the responsibility of the format to ensure the data returned matches the required schema. This includes the scale of decimals. The JSON format was not correctly setting the scale of decimals when deserializing. For example, give:\n\n```sql\nCREATE STREAM S (ID INT KEY, PRICE DECIMAL(10,2) WITH (kafka_topic='S', formats='JSON');\n```\n\nThe above creates a stream with a single value column `PRICE` which should have a scale of `2`, i.e. two decimal places.\n\nIf the data in tbe Kafka record's value was to have the incorrect, e.g.\n\n```json\n{\n   \"price\": 12\n}\n```\n\nor\n\n```json\n{\n   \"price\": 12.1\n}\n```\n\nThen the deserializer was returning the decimal as provided, i.e. `12` or `12.1`. However, this is incorrect as the schema of the column states is has a scale of two. So all values for the column should have the scale set to two, i.e. the above examples should deserialize to `12.00` and `12.10`. With this change they no do.", "committedDate": "2020-09-24T15:19:41Z", "type": "commit"}, {"oid": "5bfcaeced663ad71e450931c7a9c39dcf5fbd0e2", "url": "https://github.com/confluentinc/ksql/commit/5bfcaeced663ad71e450931c7a9c39dcf5fbd0e2", "message": "test: updated QTT", "committedDate": "2020-09-24T15:20:08Z", "type": "commit"}, {"oid": "9bb34f94c7e6cf228e29d1cff60c94c47ca2fbbc", "url": "https://github.com/confluentinc/ksql/commit/9bb34f94c7e6cf228e29d1cff60c94c47ca2fbbc", "message": "test: fix test", "committedDate": "2020-09-25T12:27:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAyNzk3MQ==", "url": "https://github.com/confluentinc/ksql/pull/6295#discussion_r496027971", "bodyText": "Does ksqlDB always throw when deserializing decimals that don't fit into the specified precision/scale? What about when casting from other numeric types to decimals? There's no way for the user to specify rounding behavior? (Asking in case you know off the top of your head. If not I can poke around the code, not seeing anything in the docs one way or the other.)", "author": "vcrfxia", "createdAt": "2020-09-28T15:15:43Z", "path": "ksqldb-serde/src/test/java/io/confluent/ksql/serde/json/KsqlJsonDeserializerTest.java", "diffHunk": "@@ -538,6 +538,40 @@ public void shouldDeserializeDecimalsWithoutStrippingTrailingZeros() {\n     assertThat(result, is(new BigDecimal(\"10.0\")));\n   }\n \n+  @Test\n+  public void shouldFixScaleWhenDeserializingDecimalsWithTooSmallAScale() {\n+    // Given:\n+    final KsqlJsonDeserializer<BigDecimal> deserializer =\n+        givenDeserializerForSchema(DecimalUtil.builder(4, 3).build(), BigDecimal.class);\n+\n+    final byte[] bytes = addMagic(\"1.1\".getBytes(UTF_8));\n+\n+    // When:\n+    final Object result = deserializer.deserialize(SOME_TOPIC, bytes);\n+\n+    // Then:\n+    assertThat(result, is(new BigDecimal(\"1.100\")));\n+  }\n+\n+  @Test\n+  public void shouldThrowIfDecimalHasLargerScale() {", "originalCommit": "9bb34f94c7e6cf228e29d1cff60c94c47ca2fbbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3NjQ0NQ==", "url": "https://github.com/confluentinc/ksql/pull/6295#discussion_r496076445", "bodyText": "@agavra can probably answer more definitely than me, as he did the initial work. However, I believe a deserializer should throw if the deserialized value doesn't fit in the ksql decimal scale and precision.  (See DecimalUtil.ensureFit). This isn't necessary for some formats, e.g. AVRO, as the Avro schema dictates scale and precision, and the ksql schema is driven from the Avro one.\nCasting is supported, and I'm assuming ensureFit is being called appropriately.\nI don't think there's any way for a user to specify rounding behaviour, though I'm fairly certain it was discussed during the design, but punted to a later feature.", "author": "big-andy-coates", "createdAt": "2020-09-28T16:21:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAyNzk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3MDYwNw==", "url": "https://github.com/confluentinc/ksql/pull/6295#discussion_r496870607", "bodyText": "it's been a while since i've looked at the code but I agree with what Andy is saying. As far as casting is concerned, we hardcode the scale/precision for casts:\n  /**\n   * Schema of an INT up-cast to a DECIMAL\n   */\n  public static final SqlDecimal INT_UPCAST_TO_DECIMAL = SqlDecimal.of(10, 0);\n\n  /**\n   * Schema of an BIGINT up-cast to a DECIMAL\n   */\n  public static final SqlDecimal BIGINT_UPCAST_TO_DECIMAL = SqlDecimal.of(19, 0);\nAnd then for double we do some other magic", "author": "agavra", "createdAt": "2020-09-29T16:21:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAyNzk3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAyOTU4MA==", "url": "https://github.com/confluentinc/ksql/pull/6295#discussion_r496029580", "bodyText": "What's the philosophy behind when it makes sense to copy the underlying error message into the new error message?", "author": "vcrfxia", "createdAt": "2020-09-28T15:17:11Z", "path": "ksqldb-serde/src/main/java/io/confluent/ksql/serde/json/KsqlJsonDeserializer.java", "diffHunk": "@@ -126,7 +126,7 @@ public T deserialize(final String topic, final byte[] bytes) {\n       return SerdeUtils.castToTargetType(coerced, targetType);\n     } catch (final Exception e) {\n       throw new SerializationException(\n-          \"Failed to deserialize \" + target + \" from topic: \" + topic, e);\n+          \"Failed to deserialize \" + target + \" from topic: \" + topic + \". \" + e.getMessage(), e);", "originalCommit": "9bb34f94c7e6cf228e29d1cff60c94c47ca2fbbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3MzQ1OA==", "url": "https://github.com/confluentinc/ksql/pull/6295#discussion_r496073458", "bodyText": "Humm.. hard to give a hard and fast rule, but I generally make this change if otherwise the user would be presented with a less than useful error message.  In this case, I added it to make debugging easier... both for us and for users interacting with the processing logger.  Having the cause's message as part of the top level message means you can quickly understand what's happening without having to scroll through exception call stacks.", "author": "big-andy-coates", "createdAt": "2020-09-28T16:16:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAyOTU4MA=="}], "type": "inlineReview"}]}