{"pr_number": 4450, "pr_title": "chore: support window bound columns in selection of windowed group by", "pr_createdAt": "2020-02-05T16:53:15Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4450", "timeline": [{"oid": "b0ceb05ac56259b1d689bea47c0ea47adcfd79a1", "url": "https://github.com/confluentinc/ksql/commit/b0ceb05ac56259b1d689bea47c0ea47adcfd79a1", "message": "chore: support window bound columns in selection of windowed group by\n\nKSQL currently lets you take a non-windowed stream and perform a windowed group by:\n\n```sql\nCREATE TABLE T as SELECT stuff FROM S WINDOW TUMBLING (SIZE 1 SECOND) group by something;\n```\n\nWhich is essentially grouping by not just `something`, but also implicitly by the window bounds.\n\nThis might be more correctly written with a Tumbling table function:\n\n```sql\nCREATE TABLE T as SELECT stuff FROM Tumbling(S, SIZE 1 SECOND) group by something, windowstart, windowend;\n```\n\nWhere the Tumbling table function returns one row for each row in `S`, with the addition of the `windowstart` and `windowend` columns.   (Note: Hopping and session table functions are also possible, though in the case of the latter the table function would also emit retractions).\n\nIn a correct SQL model `windowstart` and `windowend` would therefore be available as fields within the selection, e.g.\n\n```\nCREATE TABLE T as SELECT windowstart, windowend, something, count() FROM Tumbling(S, SIZE 1 SECOND) group by something, windowstart, windowend;\n```\n\nThis change makes such awesomeness possible.", "committedDate": "2020-02-05T16:39:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM4NTM5Ng==", "url": "https://github.com/confluentinc/ksql/pull/4450#discussion_r375385396", "bodyText": "Note: the dodgily named Aggregate-Aggregate-WindowSelect2 node here will go with the next PR.  It's temporary only.", "author": "big-andy-coates", "createdAt": "2020-02-05T17:02:29Z", "path": "ksql-streams/src/main/java/io/confluent/ksql/execution/streams/StreamAggregateBuilder.java", "diffHunk": "@@ -187,6 +191,19 @@ private StreamAggregateBuilder() {\n             resultSchema\n         );\n \n+    reduced = reduced.transformValues(\n+        () -> new KsTransformer<>(new WindowBoundsPopulator()),\n+        Named.as(StreamsUtil.buildOpName(\n+            AggregateBuilderUtils.windowSelectContext(aggregate)\n+        ) + \"2\")\n+    );", "originalCommit": "b0ceb05ac56259b1d689bea47c0ea47adcfd79a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA1NTA4NA==", "url": "https://github.com/confluentinc/ksql/pull/4450#discussion_r376055084", "bodyText": "REmoved in #4459", "author": "big-andy-coates", "createdAt": "2020-02-06T20:07:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM4NTM5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ1ODgzNQ==", "url": "https://github.com/confluentinc/ksql/pull/4450#discussion_r375458835", "bodyText": "this is not really the right error message right? in this case the column is used in the select, but it's not supported because it's a parameter to an aggregate function.", "author": "rodesai", "createdAt": "2020-02-05T19:23:44Z", "path": "ksql-engine/src/main/java/io/confluent/ksql/analyzer/AggregateAnalyzer.java", "diffHunk": "@@ -36,21 +37,26 @@\n   private final MutableAggregateAnalysis aggregateAnalysis;\n   private final QualifiedColumnReferenceExp defaultArgument;\n   private final FunctionRegistry functionRegistry;\n+  private final boolean hasWindowExpression;\n \n   AggregateAnalyzer(\n       final MutableAggregateAnalysis aggregateAnalysis,\n       final QualifiedColumnReferenceExp defaultArgument,\n+      final boolean hasWindowExpression,\n       final FunctionRegistry functionRegistry\n   ) {\n     this.aggregateAnalysis = Objects.requireNonNull(aggregateAnalysis, \"aggregateAnalysis\");\n     this.defaultArgument = Objects.requireNonNull(defaultArgument, \"defaultArgument\");\n     this.functionRegistry = Objects.requireNonNull(functionRegistry, \"functionRegistry\");\n+    this.hasWindowExpression = hasWindowExpression;\n   }\n \n   void processSelect(final Expression expression) {\n     final Set<ColumnReferenceExp> nonAggParams = new HashSet<>();\n     final AggregateVisitor visitor = new AggregateVisitor((aggFuncName, node) -> {\n-      if (!aggFuncName.isPresent()) {\n+      if (aggFuncName.isPresent()) {\n+        throwOnWindowBoundColumnIfWindowedAggregate(node);", "originalCommit": "b0ceb05ac56259b1d689bea47c0ea47adcfd79a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTkxNzQyOA==", "url": "https://github.com/confluentinc/ksql/pull/4450#discussion_r375917428", "bodyText": "Error message submitted in next PR will be explicit about not being able to use window bounds as parameters to UDAFs.", "author": "big-andy-coates", "createdAt": "2020-02-06T15:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ1ODgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA1NDk4OA==", "url": "https://github.com/confluentinc/ksql/pull/4450#discussion_r376054988", "bodyText": "Fix in #4459", "author": "big-andy-coates", "createdAt": "2020-02-06T20:07:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ1ODgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ2MDk3MA==", "url": "https://github.com/confluentinc/ksql/pull/4450#discussion_r375460970", "bodyText": "Should we drop unaliased column references to windowstart/windowend from the list of select expressions? That way a user can project windowstart/windowend without an alias.", "author": "rodesai", "createdAt": "2020-02-05T19:27:42Z", "path": "ksql-engine/src/main/java/io/confluent/ksql/planner/LogicalPlanner.java", "diffHunk": "@@ -418,7 +418,8 @@ private LogicalSchema buildAggregateSchema(\n     }\n \n     final LogicalSchema sourceSchema = buildProjectionSchema(\n-        sourcePlanNode.getSchema(),\n+        sourcePlanNode.getSchema()", "originalCommit": "b0ceb05ac56259b1d689bea47c0ea47adcfd79a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTkxODk3Mw==", "url": "https://github.com/confluentinc/ksql/pull/4450#discussion_r375918973", "bodyText": "Sorry, I don't follow what you mean.  Can you explain more?\n\nThat way a user can project windowstart/windowend without an alias.\n\nDo you mean be able to do:\nSELECT Foo.WINDOWSTART, WINDOWEND FROM FOO ...\n???\nBoth aliased and non-aliased window bounds columns are supported.", "author": "big-andy-coates", "createdAt": "2020-02-06T15:53:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ2MDk3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTkzNDU3Ng==", "url": "https://github.com/confluentinc/ksql/pull/4450#discussion_r375934576", "bodyText": "Ah, I now understand.  Already on my radar. #4458 tracks.", "author": "big-andy-coates", "createdAt": "2020-02-06T16:17:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ2MDk3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ3ODIwOQ==", "url": "https://github.com/confluentinc/ksql/pull/4450#discussion_r375478209", "bodyText": "Should we do this in a separate step? Once we support using key columns directly we won't need to project these into the value anymore right?", "author": "rodesai", "createdAt": "2020-02-05T20:01:37Z", "path": "ksql-streams/src/main/java/io/confluent/ksql/execution/streams/StreamAggregateBuilder.java", "diffHunk": "@@ -187,6 +191,19 @@ private StreamAggregateBuilder() {\n             resultSchema\n         );\n \n+    reduced = reduced.transformValues(", "originalCommit": "b0ceb05ac56259b1d689bea47c0ea47adcfd79a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTkyMTQ3NQ==", "url": "https://github.com/confluentinc/ksql/pull/4450#discussion_r375921475", "bodyText": "Humm... well, introduction of structured keys is very likely to be a breaking change anyway. However, I can see your point.  This would fit well as a separate step, but I'm up against it on the clock.  Would you have time to split this? (Wait for the follow up PR before you do).  Otherwise, I'll add it to my list and do my best to get it done before the release.", "author": "big-andy-coates", "createdAt": "2020-02-06T15:57:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ3ODIwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA1NDg2Ng==", "url": "https://github.com/confluentinc/ksql/pull/4450#discussion_r376054866", "bodyText": "Thinking on this more... I'm not sure adding another step really helps in this situation.\nIf we add the extra step, then once we have structured keys and the window bounds columns can just be in the key schema, then we'd no longer need the extra step.  New plans could just omit it, but existing plans would still contain it.  So the step would likely become a no-op, but we'd need to keep it around for compatibility sakes\nContrast this to what would happen if we kept this where it is.  When structured keys is done we can just delete this bit of code from here.  New and old plans will now still have the same steps and will still both work.  No need for some legacy step to be kept around.", "author": "big-andy-coates", "createdAt": "2020-02-06T20:06:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ3ODIwOQ=="}], "type": "inlineReview"}]}