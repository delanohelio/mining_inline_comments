{"pr_number": 875, "pr_title": "chore(aws-api-appsync): consolidate serde logic", "pr_createdAt": "2020-10-01T20:23:38Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/875", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxNzUyMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/875#discussion_r498517523", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static void withDeserializers(GsonBuilder builder) {\n          \n          \n            \n                private static void withAdapters(GsonBuilder builder) {", "author": "richardmcclellan", "createdAt": "2020-10-01T21:16:17Z", "path": "aws-api-appsync/src/main/java/com/amplifyframework/api/aws/GsonFactory.java", "diffHunk": "@@ -26,28 +26,62 @@\n import com.google.gson.GsonBuilder;\n \n import java.util.Collections;\n+import java.util.Date;\n import java.util.Map;\n \n-final class GsonFactory {\n+/**\n+ * A utility to create a {@link Gson} instance with serialization and deserialization\n+ * suitable for various Amplify and AppSync types.\n+ */\n+public final class GsonFactory {\n     private GsonFactory() {}\n \n-    static Gson create() {\n+    /**\n+     * Creates a new {@link Gson} instance with basic serializers and deserializers\n+     * needed by Amplify and AppSync.\n+     * @return A {@link Gson} instance that may be used to convert Amplify and AppSync\n+     *         types to/from JSON\n+     */\n+    public static Gson create() {\n         return create(Collections.emptyMap());\n     }\n \n-    static Gson create(@NonNull Map<Class<?>, Object> additionalAdapters) {\n-        GsonBuilder builder = new GsonBuilder();\n+    /**\n+     * Creates a new {@link Gson} instance by adding basic serialization and deserialization\n+     * adapters on top of anything that may be configured in the provided {@link GsonBuilder}.\n+     * Note that already-configured attached to the builder may be overridden.\n+     * @param builder A {@link GsonBuilder}\n+     * @return A {@link Gson} instance\n+     */\n+    public static Gson create(GsonBuilder builder) {\n         withDeserializers(builder);\n-        withAdditionalAdapters(builder, additionalAdapters);\n         return builder.create();\n     }\n \n+    /**\n+     * Creates a new {@link Gson} instance with basic serializers and deserializers,\n+     * in addition to the provided ser-de adapters. If an adapter is provided for a system\n+     * type, it will be overridden by the system's internal adapter, and the provided copy\n+     * will have no effect.\n+     * @param additionalAdapters {@link Gson} type adapters for custom types\n+     * @return A {@link Gson} instance that may be used to deserialize Amplify and AppSync JSON,\n+     *          including JSON which includes additional types handled by the provided\n+     *          adapters\n+     */\n+    public static Gson create(@NonNull Map<Class<?>, Object> additionalAdapters) {\n+        GsonBuilder builder = new GsonBuilder();\n+        withAdditionalAdapters(builder, additionalAdapters);\n+        withDeserializers(builder);\n+        return create(builder);\n+    }\n+\n     private static void withDeserializers(GsonBuilder builder) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1NjM1Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/875#discussion_r499056357", "bodyText": "I'm a little confused by having two separate factories, ApiGsonFactory, and DataStoreGsonFactory.  From what I can tell, this is how you are using them:\n\nApiGsonFactory\n\nAPI request serialization\nAPI response deserialization\nDataStore response deserialization\n\n\nDataStoreApiFactory\n\nDataStore request serialization\nSQLite (de)serialization of custom types\n\n\n\nThe DataStore AppSyncClient is using the API category under the hood, and hence is using the ApiGsonFactory for  all of the network operations - sync, mutate, subscribe.\nI would suggest either:\n\nJust have one GsonFactory with everything\nHave an ApiGsonFactory which is used for all API related (de)serialization in both API & DataStore, and a CustomTypeGsonFactory, which is used for (de)serialization of custom types to SQLite", "author": "richardmcclellan", "createdAt": "2020-10-02T21:23:25Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/DataStoreGsonFactory.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore;\n+\n+import com.amplifyframework.api.graphql.GsonResponseAdapters;\n+import com.amplifyframework.core.model.query.predicate.GsonPredicateAdapters;\n+import com.amplifyframework.core.model.temporal.GsonTemporalAdapters;\n+import com.amplifyframework.core.model.types.GsonJavaTypeAdapters;\n+import com.amplifyframework.datastore.appsync.ModelWithMetadataDeserializer;\n+import com.amplifyframework.datastore.syncengine.TimeBasedUuidTypeAdapter;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+\n+/**\n+ * A utility to create Gson instances for the DataStore plugin.\n+ */\n+public final class DataStoreGsonFactory {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA3NTcxNA==", "url": "https://github.com/aws-amplify/amplify-android/pull/875#discussion_r499075714", "bodyText": "I should be able to achieve (1). It is the last change I was toying with, prior to putting up the latest version. Let me go back and see that option to its natural conclusion.", "author": "jamesonwilliams", "createdAt": "2020-10-02T22:30:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1NjM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA4ODQ5Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/875#discussion_r499088492", "bodyText": "Awesome.  Other than that, the PR looks great.  Nice cleanup!", "author": "richardmcclellan", "createdAt": "2020-10-02T23:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1NjM1Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "4482a7dced30598a394c48a835bc08d594615749", "url": "https://github.com/aws-amplify/amplify-android/commit/4482a7dced30598a394c48a835bc08d594615749", "message": "chore(aws-api-appsync): consolidate serde logic\n\nAround the code base, Gson is used with various different\nconfigurations. However, most uses require the same basic set of\nserializers and deserializers, to handle custom Amplify and AppSync\ntypes.\n\nTo address this, the serializers and deserializers are consolidated\n(mostly) into the aws-api-appsync module. Gson construction now occurs\nuniformy from the provided GsonFactory.\n\nResolves: https://github.com/aws-amplify/amplify-android/issues/848", "committedDate": "2020-10-02T23:58:24Z", "type": "commit"}, {"oid": "4482a7dced30598a394c48a835bc08d594615749", "url": "https://github.com/aws-amplify/amplify-android/commit/4482a7dced30598a394c48a835bc08d594615749", "message": "chore(aws-api-appsync): consolidate serde logic\n\nAround the code base, Gson is used with various different\nconfigurations. However, most uses require the same basic set of\nserializers and deserializers, to handle custom Amplify and AppSync\ntypes.\n\nTo address this, the serializers and deserializers are consolidated\n(mostly) into the aws-api-appsync module. Gson construction now occurs\nuniformy from the provided GsonFactory.\n\nResolves: https://github.com/aws-amplify/amplify-android/issues/848", "committedDate": "2020-10-02T23:58:24Z", "type": "forcePushed"}]}