{"pr_number": 906, "pr_title": "feat(aws-api): support owner-based auth with oidc", "pr_createdAt": "2020-10-14T17:49:53Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/906", "timeline": [{"oid": "30d99888f337b908e8bae26bfd7472e693b3c00e", "url": "https://github.com/aws-amplify/amplify-android/commit/30d99888f337b908e8bae26bfd7472e693b3c00e", "message": "feat(aws-api): support owner-based auth with oidc", "committedDate": "2020-10-14T17:44:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4MTU5MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/906#discussion_r504981591", "bodyText": "What needs to happen to support this?\nInstead of leaving this TODO here, can we either:\n\nAdd support for it\nOr, throw an exception if a customer tries to use it?", "author": "richardmcclellan", "createdAt": "2020-10-14T21:26:23Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -383,13 +388,13 @@ private String getIdentityValue(String identityClaim) throws ApiException {\n         return identityValue;\n     }\n \n-    private ArrayList<String> getUserGroups() throws ApiException {\n-        CognitoUserPoolsAuthProvider cognitoProvider = getAuthProvider();\n+    private ArrayList<String> getUserGroups(AuthorizationType authType) throws ApiException {\n+        // TODO: this doesn't work with OIDC right now. Implement custom groups claim.", "originalCommit": "30d99888f337b908e8bae26bfd7472e693b3c00e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgxNDA1Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/906#discussion_r507814056", "bodyText": "Will be addressed in a separate PR to support custom group claims", "author": "raphkim", "createdAt": "2020-10-19T14:47:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4MTU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg0Mzg3Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/906#discussion_r507843873", "bodyText": "Implementing in a separate PR is fine.  To merge this now though, could you just replace the TODO with something like this:\nif(AuthorizationType.OPENID_CONNECT.equals(authType)) {\n    throw new ApiException(\"Custom group claims with OIDC are not supported yet\");\n}", "author": "richardmcclellan", "createdAt": "2020-10-19T15:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4MTU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4NjExMA==", "url": "https://github.com/aws-amplify/amplify-android/pull/906#discussion_r504986110", "bodyText": "getPayload can throw an CognitoParameterInvalidException.  Can we catch it and wrap it in an APIException?  You could throw the same one that is thrown for a JsonException below.", "author": "richardmcclellan", "createdAt": "2020-10-14T21:36:08Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -383,13 +388,13 @@ private String getIdentityValue(String identityClaim) throws ApiException {\n         return identityValue;\n     }\n \n-    private ArrayList<String> getUserGroups() throws ApiException {\n-        CognitoUserPoolsAuthProvider cognitoProvider = getAuthProvider();\n+    private ArrayList<String> getUserGroups(AuthorizationType authType) throws ApiException {\n+        // TODO: this doesn't work with OIDC right now. Implement custom groups claim.\n         ArrayList<String> groups = new ArrayList<>();\n         final String GROUPS_KEY = \"cognito:groups\";\n \n         try {\n-            JSONObject accessToken = CognitoJWTParser.getPayload(cognitoProvider.getLatestAuthToken());\n+            JSONObject accessToken = CognitoJWTParser.getPayload(getAuthToken(authType));", "originalCommit": "30d99888f337b908e8bae26bfd7472e693b3c00e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk4NjkwMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/906#discussion_r504986903", "bodyText": "Can we catch a CognitoParameterInvalidException here as well?", "author": "richardmcclellan", "createdAt": "2020-10-14T21:37:53Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -358,17 +364,16 @@ private boolean isReadRestrictingStaticGroup(AuthRule authRule) {\n             && authRule.getOperationsOrDefault().contains(ModelOperation.READ);\n     }\n \n-    private String getIdentityValue(String identityClaim) throws ApiException {\n-        CognitoUserPoolsAuthProvider cognitoProvider = getAuthProvider();\n-\n-        String identityValue;\n+    private String getIdentityValue(String identityClaim, AuthorizationType authType) throws ApiException {\n+        String identityValue = null;\n \n         try {\n             identityValue = CognitoJWTParser\n-                    .getPayload(cognitoProvider.getLatestAuthToken())\n+                    .getPayload(getAuthToken(authType))", "originalCommit": "30d99888f337b908e8bae26bfd7472e693b3c00e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1ODM1OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/906#discussion_r505158359", "bodyText": "The last few PRs for auth have gone right into the main body of this AWSApiPlugin. I'm worried about this. We should really be breaking the auth logic out into smaller classes.\nPlugins, in a perfect world, are simply adapters between our business logic and the Amplify framework.\nHowever, increasingly, this AWSApiPlugin is host to business logic.\n@raphkim The model you used for your Predictions category -- where you had business logic services, and used the plugin as a thin-veneer into them -- was architecturally correct, for example.", "author": "jamesonwilliams", "createdAt": "2020-10-15T04:35:05Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -409,20 +414,34 @@ private String getIdentityValue(String identityClaim) throws ApiException {\n         return groups;\n     }\n \n-    private CognitoUserPoolsAuthProvider getAuthProvider() throws ApiException {\n-        CognitoUserPoolsAuthProvider cognitoProvider = authProvider.getCognitoUserPoolsAuthProvider();\n-        if (cognitoProvider == null) {\n-            try {\n-                cognitoProvider = new DefaultCognitoUserPoolsAuthProvider();\n-            } catch (ApiException exception) {\n+    private String getAuthToken(AuthorizationType authType) throws ApiException {", "originalCommit": "30d99888f337b908e8bae26bfd7472e693b3c00e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgxMjk0Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/906#discussion_r507812947", "bodyText": "to be addressed in a separate PR", "author": "raphkim", "createdAt": "2020-10-19T14:46:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1ODM1OQ=="}], "type": "inlineReview"}, {"oid": "a488b769b0b8618106860b2eee8c425bb91e3466", "url": "https://github.com/aws-amplify/amplify-android/commit/a488b769b0b8618106860b2eee8c425bb91e3466", "message": "address pr comments", "committedDate": "2020-10-16T08:41:07Z", "type": "commit"}, {"oid": "12d37e4f30d50dc9d7fd1c585901f9fb34540570", "url": "https://github.com/aws-amplify/amplify-android/commit/12d37e4f30d50dc9d7fd1c585901f9fb34540570", "message": "fix unit test", "committedDate": "2020-10-16T09:12:33Z", "type": "commit"}, {"oid": "40faff3e83939cd3e3242944343c8074f9ad873a", "url": "https://github.com/aws-amplify/amplify-android/commit/40faff3e83939cd3e3242944343c8074f9ad873a", "message": "replace todo message with exception", "committedDate": "2020-10-19T20:25:57Z", "type": "commit"}]}