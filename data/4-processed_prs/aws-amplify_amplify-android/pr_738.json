{"pr_number": 738, "pr_title": "feat(aws-auth-cognito): implement device tracking", "pr_createdAt": "2020-08-19T16:49:11Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/738", "timeline": [{"oid": "0255d962ed0953aadd26202a6de79553533a81a6", "url": "https://github.com/aws-amplify/amplify-android/commit/0255d962ed0953aadd26202a6de79553533a81a6", "message": "feat(aws-auth-cognito): implement device tracking", "committedDate": "2020-08-19T10:16:32Z", "type": "commit"}, {"oid": "2c06a0553b4ca21fb307d17886041d3b92d1e6b9", "url": "https://github.com/aws-amplify/amplify-android/commit/2c06a0553b4ca21fb307d17886041d3b92d1e6b9", "message": "Merge branch 'main' of https://github.com/aws-amplify/amplify-android into auth-device", "committedDate": "2020-08-19T10:16:52Z", "type": "commit"}, {"oid": "907572b89595236707a5126f4d300abbab1c5f6c", "url": "https://github.com/aws-amplify/amplify-android/commit/907572b89595236707a5126f4d300abbab1c5f6c", "message": "Add more synchronous methods", "committedDate": "2020-08-19T16:48:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxMjY3Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/738#discussion_r473212677", "bodyText": "Did you verify we can't get the device names from AWSMobileClient?", "author": "TrekSoft", "createdAt": "2020-08-19T17:43:52Z", "path": "aws-auth-cognito/src/main/java/com/amplifyframework/auth/cognito/AWSCognitoAuthPlugin.java", "diffHunk": "@@ -510,6 +515,99 @@ public void onError(Exception exception) {\n         }\n     }\n \n+    @Override\n+    public void rememberDevice(\n+            @NonNull Action onSuccess,\n+            @NonNull Consumer<AuthException> onException\n+    ) {\n+        awsMobileClient.getDeviceOperations().updateStatus(true, new Callback<Void>() {\n+            @Override\n+            public void onResult(Void result) {\n+                onSuccess.call();\n+            }\n+\n+            @Override\n+            public void onError(Exception exception) {\n+                onException.accept(new AuthException(\n+                        \"An error occurred while remembering a device\",\n+                        exception,\n+                        \"See attached exception for more details\"\n+                ));\n+            }\n+        });\n+    }\n+\n+    @Override\n+    public void forgetDevice(\n+            @NonNull Action onSuccess,\n+            @NonNull Consumer<AuthException> onException\n+    ) {\n+        awsMobileClient.getDeviceOperations().forget(new Callback<Void>() {\n+            @Override\n+            public void onResult(Void result) {\n+                onSuccess.call();\n+            }\n+\n+            @Override\n+            public void onError(Exception exception) {\n+                onException.accept(new AuthException(\n+                        \"An error occurred while forgetting a device\",\n+                        exception,\n+                        \"See attached exception for more details\"\n+                ));\n+            }\n+        });\n+    }\n+\n+    @Override\n+    public void forgetDevice(\n+            @NonNull AuthDevice device,\n+            @NonNull Action onSuccess,\n+            @NonNull Consumer<AuthException> onException\n+    ) {\n+        awsMobileClient.getDeviceOperations().forget(device.getDeviceId(), new Callback<Void>() {\n+            @Override\n+            public void onResult(Void result) {\n+                onSuccess.call();\n+            }\n+\n+            @Override\n+            public void onError(Exception exception) {\n+                onException.accept(new AuthException(\n+                        \"An error occurred while forgetting a device\",\n+                        exception,\n+                        \"See attached exception for more details\"\n+                ));\n+            }\n+        });\n+    }\n+\n+    @Override\n+    public void fetchDevices(\n+            @NonNull Consumer<List<AuthDevice>> onSuccess,\n+            @NonNull Consumer<AuthException> onException\n+    ) {\n+        awsMobileClient.getDeviceOperations().list(new Callback<ListDevicesResult>() {\n+            @Override\n+            public void onResult(ListDevicesResult result) {\n+                List<AuthDevice> devices = new ArrayList<>();\n+                for (Device device : result.getDevices()) {\n+                    devices.add(AuthDevice.fromId(device.getDeviceKey()));", "originalCommit": "907572b89595236707a5126f4d300abbab1c5f6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0NDc2Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/738#discussion_r474144762", "bodyText": "Will verify with jithin or someone else before I push this!", "author": "raphkim", "createdAt": "2020-08-20T17:10:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxMjY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIwMDY2Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/738#discussion_r474200663", "bodyText": "https://github.com/aws-amplify/amplify-ios/blob/main/AmplifyPlugins/Auth/AWSCognitoAuthPlugin/Support/Utils/Device%2BExtension.swift\nSwift appears to be ignoring name when creating a device also.", "author": "raphkim", "createdAt": "2020-08-20T18:51:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxMjY3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3OTAzNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/738#discussion_r473579037", "bodyText": "Passing the dummy new Object() into the Await util is okay. But you don't need to return it.\nSuccess can be == doesn't throw an exception.\nI'd update this for every method that uses this pattern.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /**\n          \n          \n            \n                 * Forgets the current device synchronously.\n          \n          \n            \n                 * @param device Auth device to forget\n          \n          \n            \n                 * @return Dummy object - just indicates it completed successfully\n          \n          \n            \n                 * @throws AuthException exception\n          \n          \n            \n                 */\n          \n          \n            \n                public Object forgetDevice(@NonNull AuthDevice device) throws AuthException {\n          \n          \n            \n                    return Await.<Object, AuthException>result(AUTH_OPERATION_TIMEOUT_MS, (onResult, onError) ->\n          \n          \n            \n                            asyncDelegate.forgetDevice(device, () -> onResult.accept(new Object()), onError)\n          \n          \n            \n                    );\n          \n          \n            \n                }\n          \n          \n            \n                /**\n          \n          \n            \n                 * Forgets the current device.\n          \n          \n            \n                 * @param device Auth device to forget\n          \n          \n            \n                 * @throws AuthException On failure to forget the provided device\n          \n          \n            \n                 */\n          \n          \n            \n                public void forgetDevice(@NonNull AuthDevice device) throws AuthException {\n          \n          \n            \n                    Await.<Object, AuthException>result(AUTH_OPERATION_TIMEOUT_MS, (onResult, onError) ->\n          \n          \n            \n                            asyncDelegate.forgetDevice(device, () -> onResult.accept(new Object()), onError)\n          \n          \n            \n                    );\n          \n          \n            \n                }", "author": "jamesonwilliams", "createdAt": "2020-08-20T04:18:58Z", "path": "testutils/src/main/java/com/amplifyframework/testutils/sync/SynchronousAuth.java", "diffHunk": "@@ -252,11 +254,52 @@ public Object confirmResetPassword(\n      */\n     @NonNull\n     public AuthSession fetchAuthSession() throws AuthException {\n-        return Await.<AuthSession, AuthException>result(AUTH_OPERATION_TIMEOUT_MS, (onResult, onError) ->\n-                asyncDelegate.fetchAuthSession(onResult, onError)\n+        return Await.result(AUTH_OPERATION_TIMEOUT_MS, asyncDelegate::fetchAuthSession);\n+    }\n+\n+    /**\n+     * Remembers current device synchronously.\n+     * @return Dummy object - just indicates it completed successfully\n+     * @throws AuthException exception\n+     */\n+    public Object rememberDevice() throws AuthException {\n+        return Await.<Object, AuthException>result(AUTH_OPERATION_TIMEOUT_MS, (onResult, onError) ->\n+                asyncDelegate.rememberDevice(() -> onResult.accept(new Object()), onError)\n+        );\n+    }\n+\n+    /**\n+     * Forgets the current device synchronously.\n+     * @return Dummy object - just indicates it completed successfully\n+     * @throws AuthException exception\n+     */\n+    public Object forgetDevice() throws AuthException {\n+        return Await.<Object, AuthException>result(AUTH_OPERATION_TIMEOUT_MS, (onResult, onError) ->\n+                asyncDelegate.forgetDevice(() -> onResult.accept(new Object()), onError)\n+        );\n+    }\n+\n+    /**\n+     * Forgets the current device synchronously.\n+     * @param device Auth device to forget\n+     * @return Dummy object - just indicates it completed successfully\n+     * @throws AuthException exception\n+     */\n+    public Object forgetDevice(@NonNull AuthDevice device) throws AuthException {\n+        return Await.<Object, AuthException>result(AUTH_OPERATION_TIMEOUT_MS, (onResult, onError) ->\n+                asyncDelegate.forgetDevice(device, () -> onResult.accept(new Object()), onError)\n         );\n     }", "originalCommit": "907572b89595236707a5126f4d300abbab1c5f6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0NTE4MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/738#discussion_r474145180", "bodyText": "This is the pattern that I usually follow, but I was trying to match the other methods in this class.", "author": "raphkim", "createdAt": "2020-08-20T17:10:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU3OTAzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4MDI4MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/738#discussion_r473580280", "bodyText": "Naming: this should be forgetCurrentDevice(), to clearly distinguish it from forgetDevice(AuthDevice specificDevice). I would not compromise the naming just to match iOS. We should ask the iOS team to update their name if they're not using this, too.", "author": "jamesonwilliams", "createdAt": "2020-08-20T04:24:26Z", "path": "testutils/src/main/java/com/amplifyframework/testutils/sync/SynchronousAuth.java", "diffHunk": "@@ -252,11 +254,52 @@ public Object confirmResetPassword(\n      */\n     @NonNull\n     public AuthSession fetchAuthSession() throws AuthException {\n-        return Await.<AuthSession, AuthException>result(AUTH_OPERATION_TIMEOUT_MS, (onResult, onError) ->\n-                asyncDelegate.fetchAuthSession(onResult, onError)\n+        return Await.result(AUTH_OPERATION_TIMEOUT_MS, asyncDelegate::fetchAuthSession);\n+    }\n+\n+    /**\n+     * Remembers current device synchronously.\n+     * @return Dummy object - just indicates it completed successfully\n+     * @throws AuthException exception\n+     */\n+    public Object rememberDevice() throws AuthException {\n+        return Await.<Object, AuthException>result(AUTH_OPERATION_TIMEOUT_MS, (onResult, onError) ->\n+                asyncDelegate.rememberDevice(() -> onResult.accept(new Object()), onError)\n+        );\n+    }\n+\n+    /**\n+     * Forgets the current device synchronously.\n+     * @return Dummy object - just indicates it completed successfully\n+     * @throws AuthException exception\n+     */\n+    public Object forgetDevice() throws AuthException {", "originalCommit": "907572b89595236707a5126f4d300abbab1c5f6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0NjA1Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/738#discussion_r474146056", "bodyText": "They have it set up such that AuthDevice parameter is nullable, and if none is passed, the method exhibits above behavior. It was in my discretion to overload the method and make AuthDevice a @NonNull parameter to go along with Android specific pattern. I believe it is okay to rename this method as you suggest.", "author": "raphkim", "createdAt": "2020-08-20T17:12:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4MDI4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4MDQ2Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/738#discussion_r473580466", "bodyText": "Since we have a forceDevice(AuthDevice specificDevice), I suggest that we call this rememberCurrentDevice(). (Same for Rx bindings, of course, as well.)", "author": "jamesonwilliams", "createdAt": "2020-08-20T04:25:15Z", "path": "testutils/src/main/java/com/amplifyframework/testutils/sync/SynchronousAuth.java", "diffHunk": "@@ -252,11 +254,52 @@ public Object confirmResetPassword(\n      */\n     @NonNull\n     public AuthSession fetchAuthSession() throws AuthException {\n-        return Await.<AuthSession, AuthException>result(AUTH_OPERATION_TIMEOUT_MS, (onResult, onError) ->\n-                asyncDelegate.fetchAuthSession(onResult, onError)\n+        return Await.result(AUTH_OPERATION_TIMEOUT_MS, asyncDelegate::fetchAuthSession);\n+    }\n+\n+    /**\n+     * Remembers current device synchronously.\n+     * @return Dummy object - just indicates it completed successfully\n+     * @throws AuthException exception\n+     */\n+    public Object rememberDevice() throws AuthException {", "originalCommit": "907572b89595236707a5126f4d300abbab1c5f6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4MTcyMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/738#discussion_r473581723", "bodyText": "Extra parens\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return toSingle((delegate::fetchDevices));\n          \n          \n            \n                    return toSingle(delegate::fetchDevices);", "author": "jamesonwilliams", "createdAt": "2020-08-20T04:30:17Z", "path": "rxbindings/src/main/java/com/amplifyframework/rx/RxAuthBinding.java", "diffHunk": "@@ -126,6 +128,26 @@ public void handleWebUISignInResponse(Intent intent) {\n         return toSingle(delegate::fetchAuthSession);\n     }\n \n+    @Override\n+    public Completable rememberDevice() {\n+        return toCompletable(delegate::rememberDevice);\n+    }\n+\n+    @Override\n+    public Completable forgetDevice() {\n+        return toCompletable(delegate::forgetDevice);\n+    }\n+\n+    @Override\n+    public Completable forgetDevice(@NonNull AuthDevice device) {\n+        return toCompletable((onComplete, onError) -> delegate.forgetDevice(device, onComplete, onError));\n+    }\n+\n+    @Override\n+    public Single<List<AuthDevice>> fetchDevices() {\n+        return toSingle((delegate::fetchDevices));", "originalCommit": "907572b89595236707a5126f4d300abbab1c5f6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9f6bd22f773ac1a34489e9ace56c184dbfa63b87", "url": "https://github.com/aws-amplify/amplify-android/commit/9f6bd22f773ac1a34489e9ace56c184dbfa63b87", "message": "pr suggestions from jameson", "committedDate": "2020-08-23T20:44:28Z", "type": "commit"}, {"oid": "4983a72c056a2be5878fc79e98934a58302c5e91", "url": "https://github.com/aws-amplify/amplify-android/commit/4983a72c056a2be5878fc79e98934a58302c5e91", "message": "add component test", "committedDate": "2020-08-23T21:10:54Z", "type": "commit"}, {"oid": "e5a3667f004c970b0973bf314fd334fce8bb0713", "url": "https://github.com/aws-amplify/amplify-android/commit/e5a3667f004c970b0973bf314fd334fce8bb0713", "message": "add rxbindings test", "committedDate": "2020-08-24T08:18:28Z", "type": "commit"}, {"oid": "180033bfd2dc1034d98fa151175a5175a26a4320", "url": "https://github.com/aws-amplify/amplify-android/commit/180033bfd2dc1034d98fa151175a5175a26a4320", "message": "checkstyle fixup", "committedDate": "2020-08-24T15:57:53Z", "type": "commit"}]}