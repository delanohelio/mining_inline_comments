{"pr_number": 635, "pr_title": "feat(datastore) Add support for owner based auth", "pr_createdAt": "2020-07-11T05:54:43Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/635", "timeline": [{"oid": "9282510e91ae3bdd27d7e40bd0ea43cdf97b207a", "url": "https://github.com/aws-amplify/amplify-android/commit/9282510e91ae3bdd27d7e40bd0ea43cdf97b207a", "message": "Rename Quotes to Wrap and add a couple more helper methods", "committedDate": "2020-06-24T15:08:23Z", "type": "commit"}, {"oid": "bc411298dad9b61e63c9a7f238500fb96842ab1c", "url": "https://github.com/aws-amplify/amplify-android/commit/bc411298dad9b61e63c9a7f238500fb96842ab1c", "message": "feat(api): refactor GraphQlRequestFactory and add owner based auth", "committedDate": "2020-06-24T15:08:23Z", "type": "commit"}, {"oid": "2cb0042952b45cddea52c87ab0a9b9e18880275a", "url": "https://github.com/aws-amplify/amplify-android/commit/2cb0042952b45cddea52c87ab0a9b9e18880275a", "message": "Fix integration test failures", "committedDate": "2020-06-24T22:06:53Z", "type": "commit"}, {"oid": "08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9", "url": "https://github.com/aws-amplify/amplify-android/commit/08b00e98a5b47dbd2599cbc1f4ef8ebc7947d1e9", "message": "Merge from main", "committedDate": "2020-06-29T22:01:28Z", "type": "commit"}, {"oid": "bab4cdd592eb95795f0cd6dff22d5324f30db36a", "url": "https://github.com/aws-amplify/amplify-android/commit/bab4cdd592eb95795f0cd6dff22d5324f30db36a", "message": "Merge branch 'main' into rm/ownerauth", "committedDate": "2020-07-07T01:27:09Z", "type": "commit"}, {"oid": "59018cdb7f0e9d7e253b6206dc8f0cba002fe141", "url": "https://github.com/aws-amplify/amplify-android/commit/59018cdb7f0e9d7e253b6206dc8f0cba002fe141", "message": "Rename setAuthProvider to setOwner", "committedDate": "2020-07-07T07:07:16Z", "type": "commit"}, {"oid": "961866975bac76962ce64276093c0bd5406eced3", "url": "https://github.com/aws-amplify/amplify-android/commit/961866975bac76962ce64276093c0bd5406eced3", "message": "Early return if failure instead of starting a GraphQLOperation", "committedDate": "2020-07-07T07:16:35Z", "type": "commit"}, {"oid": "a25e3c6230436b98b62866620061493fafa49c27", "url": "https://github.com/aws-amplify/amplify-android/commit/a25e3c6230436b98b62866620061493fafa49c27", "message": "Pass OperationType into SelectionSet so it can figure out when to wrap with pagination details internally", "committedDate": "2020-07-07T07:25:18Z", "type": "commit"}, {"oid": "7e48a5f9c83e2402ff8c55b5b4a44968cd3b70c5", "url": "https://github.com/aws-amplify/amplify-android/commit/7e48a5f9c83e2402ff8c55b5b4a44968cd3b70c5", "message": "Refactor SelectionSet.Node copy constructor to call other constructor", "committedDate": "2020-07-07T07:30:16Z", "type": "commit"}, {"oid": "29764599cd2da945a1a0fd13980acd347f8ec09d", "url": "https://github.com/aws-amplify/amplify-android/commit/29764599cd2da945a1a0fd13980acd347f8ec09d", "message": "Make variables final on AppSyncGraphQLRequest.Builder", "committedDate": "2020-07-07T07:33:15Z", "type": "commit"}, {"oid": "73c064cc0de31e807091af8084b1015c38825571", "url": "https://github.com/aws-amplify/amplify-android/commit/73c064cc0de31e807091af8084b1015c38825571", "message": "Fix AppSyncGraphQLRequest toString implementation", "committedDate": "2020-07-07T07:35:21Z", "type": "commit"}, {"oid": "16eabc24bb64e59d2ca01c0c4410ddfd1b7cbf53", "url": "https://github.com/aws-amplify/amplify-android/commit/16eabc24bb64e59d2ca01c0c4410ddfd1b7cbf53", "message": "Use static import to make casing conversion less verbose", "committedDate": "2020-07-07T07:44:06Z", "type": "commit"}, {"oid": "c6929030ed2b5892a3fb94f0de33d3c68303cfe6", "url": "https://github.com/aws-amplify/amplify-android/commit/c6929030ed2b5892a3fb94f0de33d3c68303cfe6", "message": "Fix SelectionSetTest failures", "committedDate": "2020-07-07T07:50:20Z", "type": "commit"}, {"oid": "235af37bb7fcb3585a3d1db16e9eb17b337df717", "url": "https://github.com/aws-amplify/amplify-android/commit/235af37bb7fcb3585a3d1db16e9eb17b337df717", "message": "checkstyle", "committedDate": "2020-07-07T08:01:04Z", "type": "commit"}, {"oid": "f3e879beb0b61359cbda571990acc9ade94aa1b9", "url": "https://github.com/aws-amplify/amplify-android/commit/f3e879beb0b61359cbda571990acc9ade94aa1b9", "message": "Revert \"Use static import to make casing conversion less verbose\"\n\nThis reverts commit 16eabc24bb64e59d2ca01c0c4410ddfd1b7cbf53.", "committedDate": "2020-07-07T08:01:13Z", "type": "commit"}, {"oid": "71a2e1b15bf9a6e6e2883ee68af9203487e0c7a6", "url": "https://github.com/aws-amplify/amplify-android/commit/71a2e1b15bf9a6e6e2883ee68af9203487e0c7a6", "message": "checkstyle", "committedDate": "2020-07-07T08:26:07Z", "type": "commit"}, {"oid": "c80f4624b4e5ada6f508bb1dab6406001fece689", "url": "https://github.com/aws-amplify/amplify-android/commit/c80f4624b4e5ada6f508bb1dab6406001fece689", "message": "Move factory methods to inner class of SelectionSet", "committedDate": "2020-07-07T17:52:31Z", "type": "commit"}, {"oid": "787dc8bed952dbe0487a07a65f393257e45528e2", "url": "https://github.com/aws-amplify/amplify-android/commit/787dc8bed952dbe0487a07a65f393257e45528e2", "message": "checkstyle", "committedDate": "2020-07-07T19:06:33Z", "type": "commit"}, {"oid": "884dd9c13dc0bb2e66858b5d492ac1e6ca4a9a25", "url": "https://github.com/aws-amplify/amplify-android/commit/884dd9c13dc0bb2e66858b5d492ac1e6ca4a9a25", "message": "Empty.check instead of isEmpty", "committedDate": "2020-07-07T21:04:54Z", "type": "commit"}, {"oid": "9d7cd964ad4fac23a45c2c1a618986469576c918", "url": "https://github.com/aws-amplify/amplify-android/commit/9d7cd964ad4fac23a45c2c1a618986469576c918", "message": "Added Empty.check String helper method", "committedDate": "2020-07-07T22:32:15Z", "type": "commit"}, {"oid": "2d72f886cde8a4afc109dbe13e46d26ea3f28662", "url": "https://github.com/aws-amplify/amplify-android/commit/2d72f886cde8a4afc109dbe13e46d26ea3f28662", "message": "Add check so that owner is only added for AuthStrategy.OWNER", "committedDate": "2020-07-07T22:33:18Z", "type": "commit"}, {"oid": "10ba2fd502d498bf9d25c9f5e59edbdf382ef4b0", "url": "https://github.com/aws-amplify/amplify-android/commit/10ba2fd502d498bf9d25c9f5e59edbdf382ef4b0", "message": "Add unit tests for adding owner field", "committedDate": "2020-07-07T22:33:42Z", "type": "commit"}, {"oid": "59b1f34358c56f36358e89fdfa2bd97e0cb57a64", "url": "https://github.com/aws-amplify/amplify-android/commit/59b1f34358c56f36358e89fdfa2bd97e0cb57a64", "message": "Remove addition of owner field to selection set per mdlaws feedback", "committedDate": "2020-07-07T22:34:59Z", "type": "commit"}, {"oid": "66d5d65ba21d7b2046180673f1fb1ed0458124a6", "url": "https://github.com/aws-amplify/amplify-android/commit/66d5d65ba21d7b2046180673f1fb1ed0458124a6", "message": "Add logic to filter out owner field if null for mutations", "committedDate": "2020-07-08T00:00:05Z", "type": "commit"}, {"oid": "64f2b284f89ea3509dc3ca35ef759abbb2873e37", "url": "https://github.com/aws-amplify/amplify-android/commit/64f2b284f89ea3509dc3ca35ef759abbb2873e37", "message": "Fix AWSApiPluginTests", "committedDate": "2020-07-08T00:30:03Z", "type": "commit"}, {"oid": "65a4652743e0919b3f177624a29bb08947a73294", "url": "https://github.com/aws-amplify/amplify-android/commit/65a4652743e0919b3f177624a29bb08947a73294", "message": "Fix checkstyle", "committedDate": "2020-07-08T00:34:06Z", "type": "commit"}, {"oid": "6c28a1d6cb9b189e47f59b562673f0b9f42405aa", "url": "https://github.com/aws-amplify/amplify-android/commit/6c28a1d6cb9b189e47f59b562673f0b9f42405aa", "message": "checkstyle", "committedDate": "2020-07-08T00:57:59Z", "type": "commit"}, {"oid": "54581b2527f1c7b08e282a0304bf470eefd3e0cf", "url": "https://github.com/aws-amplify/amplify-android/commit/54581b2527f1c7b08e282a0304bf470eefd3e0cf", "message": "Use Empty.check utility", "committedDate": "2020-07-08T06:04:30Z", "type": "commit"}, {"oid": "c4ef088b58bf9cc89c8342c3716c2496b60d831c", "url": "https://github.com/aws-amplify/amplify-android/commit/c4ef088b58bf9cc89c8342c3716c2496b60d831c", "message": "dashes in test resource file names for readability", "committedDate": "2020-07-08T14:48:28Z", "type": "commit"}, {"oid": "f12b652d29f0e35368f637658bb827bdbe5a5cdc", "url": "https://github.com/aws-amplify/amplify-android/commit/f12b652d29f0e35368f637658bb827bdbe5a5cdc", "message": "Use Wrap.inDoubleQuotes", "committedDate": "2020-07-08T15:15:13Z", "type": "commit"}, {"oid": "a54299117ce9a884cd560a540dcf7c14464d59af", "url": "https://github.com/aws-amplify/amplify-android/commit/a54299117ce9a884cd560a540dcf7c14464d59af", "message": "dont use trim in SelectionSetTest", "committedDate": "2020-07-08T16:39:41Z", "type": "commit"}, {"oid": "aba24dcfa7b5c02bda89bc622271c7eee7896b0e", "url": "https://github.com/aws-amplify/amplify-android/commit/aba24dcfa7b5c02bda89bc622271c7eee7896b0e", "message": "Use NoOpConsumer.create()", "committedDate": "2020-07-08T16:47:25Z", "type": "commit"}, {"oid": "5f33c7cf47ff1c6fb59e0eec4bc626c7283f19b9", "url": "https://github.com/aws-amplify/amplify-android/commit/5f33c7cf47ff1c6fb59e0eec4bc626c7283f19b9", "message": "Use Empty.check everywhere", "committedDate": "2020-07-08T16:50:00Z", "type": "commit"}, {"oid": "737ca35d7722c8272d268dd94a2c6f03d5a78ebb", "url": "https://github.com/aws-amplify/amplify-android/commit/737ca35d7722c8272d268dd94a2c6f03d5a78ebb", "message": "Create Operation enum representing GraphQL operations", "committedDate": "2020-07-08T19:44:46Z", "type": "commit"}, {"oid": "5854555b5199366fddd274c6f77ce5262bb4de1d", "url": "https://github.com/aws-amplify/amplify-android/commit/5854555b5199366fddd274c6f77ce5262bb4de1d", "message": "Merge branch 'main' into rm/ownerauth", "committedDate": "2020-07-08T23:38:48Z", "type": "commit"}, {"oid": "dc8f0f46783cf83e45956f115aac0bb8696504e2", "url": "https://github.com/aws-amplify/amplify-android/commit/dc8f0f46783cf83e45956f115aac0bb8696504e2", "message": "Capitalize first letter of modelName", "committedDate": "2020-07-11T03:23:34Z", "type": "commit"}, {"oid": "8ae35ea2d2c8bcdb8156d10018ed384ea8d578f6", "url": "https://github.com/aws-amplify/amplify-android/commit/8ae35ea2d2c8bcdb8156d10018ed384ea8d578f6", "message": "Move AppSyncGraphQLRequest from aws-api to aws-api-appsync", "committedDate": "2020-07-11T03:36:37Z", "type": "commit"}, {"oid": "0d7a032475bc52c840fd7cb46f3bf43272f7684a", "url": "https://github.com/aws-amplify/amplify-android/commit/0d7a032475bc52c840fd7cb46f3bf43272f7684a", "message": "feat(datastore) Add support for owner based auth in datastore", "committedDate": "2020-07-11T05:49:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NDA1Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r453164057", "bodyText": "Oh okay, I got this after a second. This is cool.\nMight help to illustrate by adding this into the comment, like:\n<indent>{\n<indent><margin><original>\n<indent>}", "author": "jamesonwilliams", "createdAt": "2020-07-11T06:43:19Z", "path": "core/src/main/java/com/amplifyframework/util/Wrap.java", "diffHunk": "@@ -66,6 +67,21 @@ public static String inBraces(@Nullable String original) {\n         return \"{\" + original + \"}\";\n     }\n \n+    /**", "originalCommit": "0d7a032475bc52c840fd7cb46f3bf43272f7684a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkwMTI4OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r453901288", "bodyText": "Good idea.  It's actually like this:\n<space>{\n<margin><indent><original>\n<margin>}\n\nI'll update the comment!", "author": "richardmcclellan", "createdAt": "2020-07-13T20:07:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NDA1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NDM5OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r453164398", "bodyText": "Is this needed?", "author": "jamesonwilliams", "createdAt": "2020-07-11T06:47:58Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/GsonGraphQLResponseFactory.java", "diffHunk": "@@ -19,6 +19,7 @@\n \n import com.amplifyframework.AmplifyException;\n import com.amplifyframework.api.ApiException;\n+import com.amplifyframework.api.aws.appsync.AppSyncGraphQLRequest;", "originalCommit": "0d7a032475bc52c840fd7cb46f3bf43272f7684a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkxOTQ2NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r453919464", "bodyText": "When I moved AppSyncGraphQLRequest to the aws-api-appsync module, I moved it into an appsync sub package, but thinking about it now, I don't think there's really a reason to do that.  I will move everything in the api.aws.appsync package to api.aws.", "author": "richardmcclellan", "createdAt": "2020-07-13T20:41:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NDM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NDQwNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r453164405", "bodyText": "Needed?", "author": "jamesonwilliams", "createdAt": "2020-07-11T06:48:05Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncPaginatedResultDeserializer.java", "diffHunk": "@@ -15,6 +15,7 @@\n \n package com.amplifyframework.api.aws;\n \n+import com.amplifyframework.api.aws.appsync.AppSyncGraphQLRequest;", "originalCommit": "0d7a032475bc52c840fd7cb46f3bf43272f7684a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkxOTU3Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r453919573", "bodyText": "Will move, as mentioned in previous comment.", "author": "richardmcclellan", "createdAt": "2020-07-13T20:41:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NDQwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NDUwMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r453164502", "bodyText": "Instead of mutating the request, can you create a new copy, with the owner field re-populated?\ne.g.\nGIzmo newGizmo = oldGizmo.newBuilder().setSpinnerWidgetActive(true).build();", "author": "jamesonwilliams", "createdAt": "2020-07-11T06:49:37Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AWSApiPlugin.java", "diffHunk": "@@ -260,11 +261,9 @@ public void configure(\n         if (graphQLRequest instanceof AppSyncGraphQLRequest) {\n             try {\n                 AppSyncGraphQLRequest<R> request = (AppSyncGraphQLRequest<R>) graphQLRequest;\n-                CognitoUserPoolsAuthProvider cognitoProvider = authProvider.getCognitoUserPoolsAuthProvider();\n-                if (cognitoProvider == null) {\n-                    cognitoProvider = new DefaultCognitoUserPoolsAuthProvider();\n+                if (request.isOwnerArgumentRequired()) {\n+                    request.setOwner(getUsername());", "originalCommit": "0d7a032475bc52c840fd7cb46f3bf43272f7684a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NDU3OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r453164578", "bodyText": "I think these are already running at 28, aren't they? There should be a robolectric.properties somewhere under src/test, that sets the sdk target for all the test suites.", "author": "jamesonwilliams", "createdAt": "2020-07-11T06:50:35Z", "path": "aws-api-appsync/src/test/java/com/amplifyframework/api/aws/appsync/SelectionSetTest.java", "diffHunk": "@@ -33,8 +34,13 @@\n      * @throws AmplifyException if a ModelSchema can't be derived from Post.class\n      */\n     @Test\n+    @Config(sdk = 28)", "originalCommit": "0d7a032475bc52c840fd7cb46f3bf43272f7684a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkyMjYzMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r453922631", "bodyText": "Ahh, this is a new module, and I hadn't added a robolectric.properties file yet.  Just added one, and removed this annotation.", "author": "richardmcclellan", "createdAt": "2020-07-13T20:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NDU3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NDYxNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r453164617", "bodyText": "(Copy of builder / immutable comment, here too)", "author": "jamesonwilliams", "createdAt": "2020-07-11T06:50:55Z", "path": "aws-api-appsync/src/test/java/com/amplifyframework/api/aws/appsync/AppSyncGraphQLRequestTest.java", "diffHunk": "@@ -120,9 +105,12 @@ private boolean isOwnerArgumentAdded(Class<? extends Model> clazz, OperationType\n         AppSyncGraphQLRequest<Model> request = AppSyncGraphQLRequest.builder()\n                 .modelClass(clazz)\n                 .operationType(operationType)\n+                .requestOptions(new DefaultGraphQLRequestOptions())\n                 .responseType(clazz)\n                 .build();\n-        request.setOwner(authProvider);\n+        if (request.isOwnerArgumentRequired()) {\n+            request.setOwner(\"johndoe\");", "originalCommit": "0d7a032475bc52c840fd7cb46f3bf43272f7684a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NDcyMA==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r453164720", "bodyText": "@Override\n\n\nPassing thought -- I wonder if we should have made an explicit buildGraphQlDocument() or something. toString() can often just have a pretty-print of the object state, which isn't necessarily in any particular standard form. Not really a big deal.", "author": "jamesonwilliams", "createdAt": "2020-07-11T06:52:41Z", "path": "aws-api-appsync/src/main/java/com/amplifyframework/api/aws/appsync/SelectionSet.java", "diffHunk": "@@ -87,6 +91,15 @@ public SelectionSet(String value, Set<SelectionSet> nodes) {\n      */\n     @Override\n     public String toString() {\n+        return toString(\"\");\n+    }\n+\n+    /**\n+     * Generates the String value of the SelectionSet for a GraphQL query document.\n+     * @param margin a margin with which to prefix each field of the selection set.\n+     * @return String value of the SelectionSet for a GraphQL query document.\n+     */\n+    public String toString(String margin) {", "originalCommit": "0d7a032475bc52c840fd7cb46f3bf43272f7684a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkyNTIzNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r453925235", "bodyText": "@Override\n\n\nI do have @OverRide on the toString() method, but this is toString(String margin), so it's not overriding anything.\n\nPassing thought -- I wonder if we should have made an explicit buildGraphQlDocument() or something. toString() can often just have a pretty-print of the object state, which isn't necessarily in any particular standard form. Not really a big deal.\n\nI thought about this too.  But I decided to just use toString() because I would still need to override toString() anyway to provide a useful description for debugging purposes, and toString() would just end up calling buildGraphQlDocument() anyway.", "author": "richardmcclellan", "createdAt": "2020-07-13T20:51:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NDcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NTA1Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r453165052", "bodyText": "You could use an enum for this, to help disambiguate the meaning of the boolean, and save some chars in this long-winded java method name, perhaps?\nHere is one such idea -- can still use iteration:\nLeafSelectionBehavior leafSelectionBehavior();\nwith:\nenum LeafSelectionBehavior {\n    JUST_ID,\n    ALL_FIELDS\n}", "author": "jamesonwilliams", "createdAt": "2020-07-11T06:56:19Z", "path": "aws-api-appsync/src/main/java/com/amplifyframework/api/aws/appsync/GraphQLRequestOptions.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws.appsync;\n+\n+import com.amplifyframework.core.model.Model;\n+\n+import java.util.List;\n+\n+/**\n+ * Options to be provided to a {@link AppSyncGraphQLRequest.Builder}.  When provisioning an AppSync API, there are some\n+ * key differences in the way the GraphQL operations are generated depending on whether DataStore is enabled.  For\n+ * example, _deleted, _lastChangedAt, and _version fields are added to each {@link Model} when using DataStore, but not\n+ * when using API, which means a GraphQLRequest should request these fields only if DataStore is enabled.  This options\n+ * object encapsulates these differences to help build the {@link AppSyncGraphQLRequest}.\n+ */\n+public interface GraphQLRequestOptions {\n+\n+    /**\n+     * Returns list of fields to be requested when the response type is a list of {@link Model} objects.\n+     * Examples: \"nextToken\",  \"startedAt\".\n+     *\n+     * @return list of pagination fields.\n+     */\n+    List<String> paginationFields();\n+\n+    /**\n+     * Returns list of metadata fields that should be requested for a {@link Model}.\n+     * Examples:  \"_deleted\", \"_lastChangedAt\", \"_version\".\n+     *\n+     * @return list of metadata fields\n+     */\n+    List<String> modelMetaFields();\n+\n+    /**\n+     * Returns name of field that should wrap {@link Model} fields.\n+     * Example: \"items\".\n+     *\n+     * @return name of field that should wrap {@link Model} fields.\n+     */\n+    String listField();\n+\n+    /**\n+     * Returns the maximum depth to traverse a {@link Model} when building the {@link SelectionSet}.\n+     * @return the maximum depth to traverse a {@link Model} when building the {@link SelectionSet}.\n+     */\n+    int maxDepth();\n+\n+    /**\n+     * Returns whether to request all fields or only the id field for leaf nodes when building the {@link SelectionSet}.\n+     * @return whether to request all fields or only the id field for leaf nodes when building the {@link SelectionSet}.\n+     */\n+    boolean onlyRequestIdForLeafSelectionSetNodes();", "originalCommit": "0d7a032475bc52c840fd7cb46f3bf43272f7684a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NTEzOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r453165138", "bodyText": "Can we get this in the builder, somehow, to keep the class immutable?", "author": "jamesonwilliams", "createdAt": "2020-07-11T06:57:45Z", "path": "aws-api-appsync/src/main/java/com/amplifyframework/api/aws/appsync/AppSyncGraphQLRequest.java", "diffHunk": "@@ -107,33 +105,29 @@ public void setVariable(String key, String type, String value) {\n     }\n \n     /**\n-     * Used to add owner argument from authProvider if needed.\n-     * @param authProvider CognitoUserPoolsAuthProvider for obtaining the username to set as the owner field.\n-     * @throws ApiException if request requires owner argument and authProvider or authProvider.getUsername() is null.\n+     * Returns whether owner argument is required for this request based on the model's {@link AuthRule}s.\n+     * @return whether owner argument is required for this request based on the model's {@link AuthRule}s.\n      */\n-    public void setOwner(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n+    public boolean isOwnerArgumentRequired() {\n         for (AuthRule authRule : modelSchema.getAuthRules()) {\n             if (isOwnerArgumentRequired(authRule)) {\n-                setVariable(authRule.getOwnerFieldOrDefault(), \"String!\", getUsername(authProvider));\n+                return true;\n             }\n         }\n+        return false;\n     }\n \n-    private String getUsername(CognitoUserPoolsAuthProvider authProvider) throws ApiException {\n-        if (authProvider == null) {\n-            throw new ApiException(\n-                    \"Attempted to subscribe to a model with owner based authorization without a Cognito provider\",\n-                    \"Did you add the AWSCognitoAuthPlugin to Amplify before configuring it?\"\n-            );\n-        }\n-        String username = authProvider.getUsername();\n-        if (username == null) {\n-            throw new ApiException(\n-                    \"Attempted to subscribe to a model with owner based authorization without a username\",\n-                    \"Make sure that a user is logged in before subscribing to a model with owner based auth\"\n-            );\n+    /**\n+     * Used to add owner argument from authProvider if needed.\n+     * @param owner username from CognitoUserPoolsAuthProvider to set as the owner field.\n+     * @throws ApiException if request requires owner argument and authProvider or authProvider.getUsername() is null.\n+     */\n+    public void setOwner(String owner) {", "originalCommit": "0d7a032475bc52c840fd7cb46f3bf43272f7684a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg3NDQ5OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r453874498", "bodyText": "I tried to figure out a way to do that, but there's no good way to do it, without making breaking changes to public interfaces.\nCustomers use the ModelSubscription factory to create a GraphQLRequest object, and then pass it to Amplify.API.subscribe(...).    Then, in AWSApiPlugin, I call setOwner to add the username input.   The factory cannot do this unfortunately because it doesn't have a reference to the CognitoUserPoolsProvider.  Only the AWSApiPlugin has this reference.", "author": "richardmcclellan", "createdAt": "2020-07-13T19:16:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE2NTEzOA=="}], "type": "inlineReview"}, {"oid": "67889641baa5393eeeee57ee65aa169e47d2302e", "url": "https://github.com/aws-amplify/amplify-android/commit/67889641baa5393eeeee57ee65aa169e47d2302e", "message": "Update comment for Wrap.inPrettyBraces", "committedDate": "2020-07-13T20:35:16Z", "type": "commit"}, {"oid": "b52c3fcfd8f7ac39898d956a2a719e00b346ae5b", "url": "https://github.com/aws-amplify/amplify-android/commit/b52c3fcfd8f7ac39898d956a2a719e00b346ae5b", "message": "Move source files in aws-appsync-api from aws.api.appsync to aws.api package", "committedDate": "2020-07-13T20:39:58Z", "type": "commit"}, {"oid": "e4687324f06d51086994c9c0adadf90d6ac29b22", "url": "https://github.com/aws-amplify/amplify-android/commit/e4687324f06d51086994c9c0adadf90d6ac29b22", "message": "Use robolectric properties file instead of annotation", "committedDate": "2020-07-13T20:47:44Z", "type": "commit"}, {"oid": "45af461934fe129b2ef80cd5dd2a4d64ae52ca0f", "url": "https://github.com/aws-amplify/amplify-android/commit/45af461934fe129b2ef80cd5dd2a4d64ae52ca0f", "message": "LeafSerializationBehavior enum", "committedDate": "2020-07-13T21:02:39Z", "type": "commit"}, {"oid": "d7466012477e2e49ae13208551d03d819ae1dacc", "url": "https://github.com/aws-amplify/amplify-android/commit/d7466012477e2e49ae13208551d03d819ae1dacc", "message": "Flip Operation and OperationType", "committedDate": "2020-07-13T22:07:13Z", "type": "commit"}, {"oid": "46d7f1b42590b3a5c6b32690a4d482cae339cc86", "url": "https://github.com/aws-amplify/amplify-android/commit/46d7f1b42590b3a5c6b32690a4d482cae339cc86", "message": "Rename setVariable to variable", "committedDate": "2020-07-13T22:09:30Z", "type": "commit"}, {"oid": "b0e2e48dafe1d5fc71dd0510d19ceab763535298", "url": "https://github.com/aws-amplify/amplify-android/commit/b0e2e48dafe1d5fc71dd0510d19ceab763535298", "message": "Fix compile issues from merge", "committedDate": "2020-07-13T22:16:02Z", "type": "commit"}, {"oid": "ee36aa7c0fe64973946487e7113871c70390adc5", "url": "https://github.com/aws-amplify/amplify-android/commit/ee36aa7c0fe64973946487e7113871c70390adc5", "message": "Merge branch 'main' into rm/datastore-auth", "committedDate": "2020-07-13T23:01:47Z", "type": "commit"}, {"oid": "e7f731d50c2598df6e957aea37bd10ff7adb1f81", "url": "https://github.com/aws-amplify/amplify-android/commit/e7f731d50c2598df6e957aea37bd10ff7adb1f81", "message": "Fix errors from the merge", "committedDate": "2020-07-13T23:48:58Z", "type": "commit"}, {"oid": "b5ec44646c7081e80a321a2533a56686a132b2ab", "url": "https://github.com/aws-amplify/amplify-android/commit/b5ec44646c7081e80a321a2533a56686a132b2ab", "message": "Remove setters from AppSyncGraphQLRequest so it cant be mutated, and add a newBuilder method", "committedDate": "2020-07-14T08:13:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1OTYxMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r454559612", "bodyText": "Ought these to be Immutable.of(build.variables) and Immutable.of(builder.variableTypes)?", "author": "jamesonwilliams", "createdAt": "2020-07-14T18:29:55Z", "path": "aws-api-appsync/src/main/java/com/amplifyframework/api/aws/AppSyncGraphQLRequest.java", "diffHunk": "@@ -60,97 +51,34 @@\n      * Constructor for AppSyncGraphQLRequest.\n      * @throw AmplifyException if a ModelSchema can't be derived from the provided model class\n      */\n-    private AppSyncGraphQLRequest(Builder builder) throws AmplifyException {\n+    private AppSyncGraphQLRequest(Builder builder) {\n         super(builder.responseType, new GsonVariablesSerializer());\n-        this.modelSchema = ModelSchema.fromModelClass(builder.modelClass);\n-        this.selectionSet = SelectionSet.Factory.fromModelClass(builder.modelClass,\n-                builder.operationType,\n-                DEFAULT_DEPTH);\n-        this.operationType = builder.operationType;\n+        this.modelSchema = builder.modelSchema;\n+        this.operation = builder.operation;\n+        this.selectionSet = builder.selectionSet;\n         this.variables = builder.variables;\n         this.variableTypes = builder.variableTypes;", "originalCommit": "b5ec44646c7081e80a321a2533a56686a132b2ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU2MDA2Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r454560062", "bodyText": "Can you mark the non-primitive return types as @NonNull (or, if it is the case, @Nullable)?", "author": "jamesonwilliams", "createdAt": "2020-07-14T18:30:36Z", "path": "aws-api-appsync/src/main/java/com/amplifyframework/api/aws/GraphQLRequestOptions.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import com.amplifyframework.core.model.Model;\n+\n+import java.util.List;\n+\n+/**\n+ * Options to be provided to a {@link AppSyncGraphQLRequest.Builder}.  When provisioning an AppSync API, there are some\n+ * key differences in the way the GraphQL operations are generated depending on whether DataStore is enabled.  For\n+ * example, _deleted, _lastChangedAt, and _version fields are added to each {@link Model} when using DataStore, but not\n+ * when using API, which means a GraphQLRequest should request these fields only if DataStore is enabled.  This options\n+ * object encapsulates these differences to help build the {@link AppSyncGraphQLRequest}.\n+ */\n+public interface GraphQLRequestOptions {", "originalCommit": "b5ec44646c7081e80a321a2533a56686a132b2ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU2MDU1NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/635#discussion_r454560554", "bodyText": "Collections.singletonList(...)", "author": "jamesonwilliams", "createdAt": "2020-07-14T18:31:27Z", "path": "aws-api-appsync/src/test/java/com/amplifyframework/api/aws/DefaultGraphQLRequestOptions.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.api.aws;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+\n+public final class DefaultGraphQLRequestOptions implements GraphQLRequestOptions {\n+    private static final String ITEMS_KEY = \"items\";\n+    private static final String NEXT_TOKEN_KEY = \"nextToken\";\n+\n+    @Override\n+    public List<String> paginationFields() {\n+        return Arrays.asList(NEXT_TOKEN_KEY);", "originalCommit": "b5ec44646c7081e80a321a2533a56686a132b2ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9b052f77f7be9b0d2f5f7e18ddcaaed1843e4e59", "url": "https://github.com/aws-amplify/amplify-android/commit/9b052f77f7be9b0d2f5f7e18ddcaaed1843e4e59", "message": "Add unit test for AppSyncGraphQLRequest newBuilder", "committedDate": "2020-07-14T20:05:31Z", "type": "commit"}, {"oid": "b0e5596ae1d4100f42fe72aa62026447050b6e61", "url": "https://github.com/aws-amplify/amplify-android/commit/b0e5596ae1d4100f42fe72aa62026447050b6e61", "message": "Immutable.of", "committedDate": "2020-07-14T22:29:43Z", "type": "commit"}, {"oid": "e34dc69ac1f42f3f570e11d6ae643f75dd128ecc", "url": "https://github.com/aws-amplify/amplify-android/commit/e34dc69ac1f42f3f570e11d6ae643f75dd128ecc", "message": "@NonNull", "committedDate": "2020-07-14T22:29:56Z", "type": "commit"}, {"oid": "7d0c7805a6e31db982f5fd1c06a168552c51223d", "url": "https://github.com/aws-amplify/amplify-android/commit/7d0c7805a6e31db982f5fd1c06a168552c51223d", "message": "Collections.singletonList", "committedDate": "2020-07-14T22:32:34Z", "type": "commit"}]}