{"pr_number": 496, "pr_title": "[aws-datastore] adding predicate parameter to the necessary APIs", "pr_createdAt": "2020-05-20T14:09:12Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/496", "timeline": [{"oid": "5c1f3fafcfcf1a2bd58c0f288ef960fa7e4ad134", "url": "https://github.com/aws-amplify/amplify-android/commit/5c1f3fafcfcf1a2bd58c0f288ef960fa7e4ad134", "message": "[aws-datastore] adding predicate parameter to the necessary APIs", "committedDate": "2020-05-20T13:57:22Z", "type": "commit"}, {"oid": "2cd4471bdc7a070364a0cbb8c60cd9326cf70d9d", "url": "https://github.com/aws-amplify/amplify-android/commit/2cd4471bdc7a070364a0cbb8c60cd9326cf70d9d", "message": "Merge remote-tracking branch 'origin/master' into rjuliano/dspredicate-param", "committedDate": "2020-05-20T20:58:45Z", "type": "commit"}, {"oid": "c25b5aa95629f37a290855224ec897095381a036", "url": "https://github.com/aws-amplify/amplify-android/commit/c25b5aa95629f37a290855224ec897095381a036", "message": "Adding overloads to cleanup the PR a bit", "committedDate": "2020-05-21T00:50:16Z", "type": "commit"}, {"oid": "9b91a27e3ecf55380b826e46356326d866d2c1d9", "url": "https://github.com/aws-amplify/amplify-android/commit/9b91a27e3ecf55380b826e46356326d866d2c1d9", "message": "Minor tweaks", "committedDate": "2020-05-21T01:02:07Z", "type": "commit"}, {"oid": "1f5f3e39b1bfa8b595f365833c6752654b93287e", "url": "https://github.com/aws-amplify/amplify-android/commit/1f5f3e39b1bfa8b595f365833c6752654b93287e", "message": "move comments", "committedDate": "2020-05-21T01:17:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MDY1Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428940657", "bodyText": "it feels like buildUpdateDoc should take the predicate and not a boolean indicating there's a predicate.\nI guess ideally buildUpdateDocument should return a GraphQLDocument or something like that, instead a String, the it would build the buildDocument would be a self-contained document factory.\nI understand this can be a big undertaking for the moment, so feel free to take this feedback for a future improvement (maybe create a ticket?)", "author": "drochetti", "createdAt": "2020-05-21T22:02:48Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSyncClient.java", "diffHunk": "@@ -143,16 +144,36 @@ public static AppSyncClient via(@NonNull GraphQLBehavior api) {\n         return new NoOpCancelable();\n     }\n \n+    /**\n+     * Uses Amplify API to make a mutation which will only apply if the version sent matches the server version.\n+     *\n+     * @param model      An instance of the Model with the values to mutate\n+     * @param version    The version of the model we have\n+     * @param onResponse Invoked when response data is available.\n+     * @param onFailure  Invoked on failure to obtain response data\n+     * @return A {@link Cancelable} to provide a means to cancel the asynchronous operation\n+     */\n+    @NonNull\n+    @Override\n+    public <T extends Model> Cancelable update(\n+            @NonNull T model,\n+            @NonNull Integer version,\n+            @NonNull Consumer<GraphQLResponse<ModelWithMetadata<T>>> onResponse,\n+            @NonNull Consumer<DataStoreException> onFailure) {\n+        return update(model, version, null, onResponse, onFailure);\n+    }\n+\n     @SuppressWarnings(\"unchecked\") // (Class<T>)\n     @NonNull\n     @Override\n     public <T extends Model> Cancelable update(\n             @NonNull T model,\n             @NonNull Integer version,\n+            @Nullable QueryPredicate predicate,\n             @NonNull Consumer<GraphQLResponse<ModelWithMetadata<T>>> onResponse,\n             @NonNull Consumer<DataStoreException> onFailure) {\n         try {\n-            final String doc = AppSyncRequestFactory.buildUpdateDoc(model.getClass());\n+            final String doc = AppSyncRequestFactory.buildUpdateDoc(model.getClass(), predicate != null);", "originalCommit": "1f5f3e39b1bfa8b595f365833c6752654b93287e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3MjEwMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428972102", "bodyText": "^ I agree with this.", "author": "jamesonwilliams", "createdAt": "2020-05-21T23:45:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MDY1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI5OTA0Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r429299047", "bodyText": "My original intent was to do just that. However, as I started going through the interactions with the API category, it looked like it was going to require a larger refactor. I'm going to create an issue so we can track this though.", "author": "rjuliano", "createdAt": "2020-05-22T15:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MDY1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MjM0OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428942349", "bodyText": "this is repeat often it seems, maybe an overload is worth it?", "author": "drochetti", "createdAt": "2020-05-21T22:07:14Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutboxTest.java", "diffHunk": "@@ -294,7 +294,7 @@ public void existingUpdateIncomingCreationYieldsError() throws DataStoreExceptio\n             .name(\"Tony with improvements applied\")\n             .build();\n         PendingMutation<BlogOwner> existingUpdate =\n-            PendingMutation.update(modelInExistingMutation, BlogOwner.class);\n+            PendingMutation.update(modelInExistingMutation, BlogOwner.class, null);", "originalCommit": "1f5f3e39b1bfa8b595f365833c6752654b93287e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3Mzk4NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428973985", "bodyText": "^ Agree.\nFor these predicates, around the entire code base, we either need to:\n\n\nProvide overloads. One does not require a predicate, the other requires a non-null predicate. This makes it clear to the user what's going on, and we refuse to have our user supply a semantic null.\n\n\nDon't provide an overload, just have a required param. If we do this, we need  a factory which can create a non-null sentinel, e.g.\n\n\nQueryPredicates.matchAll() // returns something that is not `null`.\n\nThen internally, we can do like:\nif (isSentinelValue(queryPredicate)) {\n    // do whatever the null meant.\n}\n\nin practice, that is:\nif QueryPredicates.matchAll().equals(queryPredicate)) {\n    // match all!\n}", "author": "jamesonwilliams", "createdAt": "2020-05-21T23:52:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MjM0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwMDA5Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r429300097", "bodyText": "I addressed this by adding overloads for now.", "author": "rjuliano", "createdAt": "2020-05-22T15:02:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MjM0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkzOTEzMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428939133", "bodyText": "Nit: inconsistent capitalization of model", "author": "jpignata", "createdAt": "2020-05-21T21:59:02Z", "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/appsync/SynchronousAppSync.java", "diffHunk": "@@ -93,8 +94,23 @@ public static SynchronousAppSync using(@NonNull AppSync appSync) {\n     @NonNull\n     public <T extends Model> GraphQLResponse<ModelWithMetadata<T>> update(\n         @NonNull T model, @NonNull Integer version) throws DataStoreException {\n+        return update(model, version, null);\n+    }\n+\n+    /**\n+     * Uses Amplify API to make a mutation which will only apply if the version sent matches the server version.\n+     * @param model An instance of the Model with the values to mutate", "originalCommit": "1f5f3e39b1bfa8b595f365833c6752654b93287e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwNTk0OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r429005948", "bodyText": "Yeah...there's about 16 or so of those. If it's ok, I would like to handle stuff like this in a follow up PR. I fixed the one I added, but I'll leave the other ones for alone for now as to not bloat the PR (any more than it already is) \ud83e\udd26", "author": "rjuliano", "createdAt": "2020-05-22T02:05:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkzOTEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkzOTQyOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428939428", "bodyText": "Is there a standard order where these kinds of type parameters should be listed?", "author": "jpignata", "createdAt": "2020-05-21T21:59:51Z", "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/appsync/SynchronousAppSync.java", "diffHunk": "@@ -93,8 +94,23 @@ public static SynchronousAppSync using(@NonNull AppSync appSync) {\n     @NonNull\n     public <T extends Model> GraphQLResponse<ModelWithMetadata<T>> update(\n         @NonNull T model, @NonNull Integer version) throws DataStoreException {\n+        return update(model, version, null);\n+    }\n+\n+    /**\n+     * Uses Amplify API to make a mutation which will only apply if the version sent matches the server version.\n+     * @param model An instance of the Model with the values to mutate\n+     * @param version The version of the model we have\n+     * @param <T> The type of data in the response. Must extend Model.", "originalCommit": "1f5f3e39b1bfa8b595f365833c6752654b93287e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3MDIzOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428970239", "bodyText": "Conventionally, the type params are usually after all other @param.\nCheckstyle has the AtClause rule to compare JavaDoc @foo and @bar, but not within @foos.", "author": "jamesonwilliams", "createdAt": "2020-05-21T23:38:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkzOTQyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MDE0MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428940141", "bodyText": "Is this necessary? Seems shorter in your revision.", "author": "jpignata", "createdAt": "2020-05-21T22:01:27Z", "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/appsync/SynchronousAppSync.java", "diffHunk": "@@ -107,11 +123,31 @@ public static SynchronousAppSync using(@NonNull AppSync appSync) {\n      * @return Response data from AppSync.\n      * @throws DataStoreException On failure to obtain response data\n      */\n+    @SuppressWarnings(\"LineLength\")", "originalCommit": "1f5f3e39b1bfa8b595f365833c6752654b93287e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwNjI0Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r429006246", "bodyText": "Removed it.", "author": "rjuliano", "createdAt": "2020-05-22T02:06:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MDE0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MDQ1Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428940457", "bodyText": "Anyway to avoid this? (newline before the throws?)", "author": "jpignata", "createdAt": "2020-05-21T22:02:20Z", "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/appsync/SynchronousAppSync.java", "diffHunk": "@@ -107,11 +123,31 @@ public static SynchronousAppSync using(@NonNull AppSync appSync) {\n      * @return Response data from AppSync.\n      * @throws DataStoreException On failure to obtain response data\n      */\n+    @SuppressWarnings(\"LineLength\")\n     @NonNull\n     <T extends Model> GraphQLResponse<ModelWithMetadata<T>> delete(\n-            @NonNull Class<T> clazz, @NonNull String objectId, @NonNull Integer version) throws DataStoreException {\n+        @NonNull Class<T> clazz, @NonNull String objectId, @NonNull Integer version) throws DataStoreException {\n+        return delete(clazz, objectId, version, null);\n+    }\n+\n+    /**\n+     * Uses Amplify API to make a mutation which will only apply if the version sent matches the server version.\n+     * @param clazz The class of the object being deleted\n+     * @param objectId ID id of the object to delete\n+     * @param version The version of the model we have\n+     * @param predicate The condition to be applied to the delete.\n+     * @param <T> The type of data in the response. Must extend Model.\n+     * @return Response data from AppSync.\n+     * @throws DataStoreException On failure to obtain response data\n+     */\n+    @SuppressWarnings(\"LineLength\")", "originalCommit": "1f5f3e39b1bfa8b595f365833c6752654b93287e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3MTUwNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428971505", "bodyText": "We can swing the params down onto a new line.\nMy personal style is to indent +8 off the method block, which differentiates it from the method body, and the method signature.\n@NonNull\n<T extends Model> GraphQLResponse<ModelWithMetadata<T>> delete(\n        @NonNull Class<T> clazz,\n        @NonNull String objectId,\n        @NonNull Integer version,\n        @Nullable QueryPredicate predicate)\n        throws DataStoreException {\n    doStuffHereAtPlus4();\n    coolStuffOnly();\n    thatIs();\n}\n\nThe rule is basically \"Chomp down vars in a method signature, and indent by 8.\"\nI know of no tool that is able to uniquely distinguish this case, from other line-wrapping or indentation cases.\nMy personal style is to use +4 spaces as indentation in all other situations in a Java document.\nWell,\nfinal class MyClass implements\n        SameTypeOfThing,\n        Here {\n    public void soThatYouCanTellItIsntThisMethodEasily() {\n    }\n}", "author": "jamesonwilliams", "createdAt": "2020-05-21T23:43:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MDQ1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwNzIyMA==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r429007220", "bodyText": "Fixed.", "author": "rjuliano", "createdAt": "2020-05-22T02:10:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MDQ1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MTAyOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428941029", "bodyText": "\"Id ID id\" ;)", "author": "jpignata", "createdAt": "2020-05-21T22:03:43Z", "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/appsync/SynchronousAppSync.java", "diffHunk": "@@ -107,11 +123,31 @@ public static SynchronousAppSync using(@NonNull AppSync appSync) {\n      * @return Response data from AppSync.\n      * @throws DataStoreException On failure to obtain response data\n      */\n+    @SuppressWarnings(\"LineLength\")\n     @NonNull\n     <T extends Model> GraphQLResponse<ModelWithMetadata<T>> delete(\n-            @NonNull Class<T> clazz, @NonNull String objectId, @NonNull Integer version) throws DataStoreException {\n+        @NonNull Class<T> clazz, @NonNull String objectId, @NonNull Integer version) throws DataStoreException {\n+        return delete(clazz, objectId, version, null);\n+    }\n+\n+    /**\n+     * Uses Amplify API to make a mutation which will only apply if the version sent matches the server version.\n+     * @param clazz The class of the object being deleted\n+     * @param objectId ID id of the object to delete", "originalCommit": "1f5f3e39b1bfa8b595f365833c6752654b93287e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwNjkzMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r429006931", "bodyText": "Oh the possibilities \ud83d\ude03 I'll fix IT though.", "author": "rjuliano", "createdAt": "2020-05-22T02:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MTAyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MjIyNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428942227", "bodyText": "Can you extract a local here to communicate what this bool does? Alternatively, should we pass something other than a bool here to avoid the construction here on 238?", "author": "jpignata", "createdAt": "2020-05-21T22:06:50Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSyncClient.java", "diffHunk": "@@ -173,22 +197,47 @@ public static AppSyncClient via(@NonNull GraphQLBehavior api) {\n         return new NoOpCancelable();\n     }\n \n+    /**\n+     * Uses Amplify API to make a mutation which will only apply if the version sent matches the server version.\n+     *\n+     * @param clazz      The class of the object being deleted\n+     * @param objectId   ID id of the object to delete\n+     * @param version    The version of the model we have\n+     * @param onResponse Invoked when response data is available.\n+     * @param onFailure  Invoked on failure to obtain response data\n+     * @return A {@link Cancelable} to provide a means to cancel the asynchronous operation\n+     */\n+    @NonNull\n+    @Override\n+    public <T extends Model> Cancelable delete(\n+            @NonNull Class<T> clazz,\n+            @NonNull String objectId,\n+            @NonNull Integer version,\n+            @NonNull Consumer<GraphQLResponse<ModelWithMetadata<T>>> onResponse,\n+            @NonNull Consumer<DataStoreException> onFailure) {\n+        return delete(clazz, objectId, version, null, onResponse, onFailure);\n+    }\n+\n     @NonNull\n     @Override\n     public <T extends Model> Cancelable delete(\n             @NonNull Class<T> clazz,\n             @NonNull String objectId,\n             @NonNull Integer version,\n+            @Nullable QueryPredicate predicate,\n             @NonNull Consumer<GraphQLResponse<ModelWithMetadata<T>>> onResponse,\n             @NonNull Consumer<DataStoreException> onFailure) {\n         try {\n-            final String doc = AppSyncRequestFactory.buildDeletionDoc(clazz);\n+            final String doc = AppSyncRequestFactory.buildDeletionDoc(clazz, predicate != null);", "originalCommit": "1f5f3e39b1bfa8b595f365833c6752654b93287e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3MjY4Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428972683", "bodyText": "Daniel and I agree we should just pass down the predicate, here. Even if it just means predicate != null is checked as a method-local implementation detail.\nAlternately, I am always tryign to get people to do:\nenum LabeledBoolean {\n    STATE_A,\n    STATE_B\n}\n\nwith\nexerciseBehavior(LabeledBoolean.STATE_A);\n\nIt's a more legible experience to read that, than exerciseBeahvior(false) -- the false is meaningless until I read the code.", "author": "jamesonwilliams", "createdAt": "2020-05-21T23:47:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MjIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAxODQ3Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r429018473", "bodyText": "I had something like that stashed away somewhere but can't seem to find it. I'll get it changed though.", "author": "rjuliano", "createdAt": "2020-05-22T03:01:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MjIyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MzMwNg==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428943306", "bodyText": "wea?", "author": "jpignata", "createdAt": "2020-05-21T22:09:54Z", "path": "aws-datastore/src/test/resources/update-blog-owner-with-predicate.txt", "diffHunk": "@@ -0,0 +1,13 @@\n+mutation UpdateBlogOwner($input:UpdateBlogOwnerInput!, $condition:ModelBlogOwnerConditionInput) {\n+  updateBlogOwner(input:$input, condition:$condition) {\n+    blog {\n+      id\n+    }\n+    id\n+    name\n+    wea", "originalCommit": "1f5f3e39b1bfa8b595f365833c6752654b93287e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NDM2MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428974361", "bodyText": "Heh. So, I grabbed this schema from a developer. Francisco, I think?  He was actively testing something. Anyway, our BlogOwner has a wea field baked into it. I don't recall where I got the schema, or what was being tested with the wea.", "author": "jamesonwilliams", "createdAt": "2020-05-21T23:54:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MzMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4MjcxNg==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428982716", "bodyText": "In the jungle, the mighty jungle.. o-wimowea\n, o-wimowea.", "author": "jpignata", "createdAt": "2020-05-22T00:25:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MzMwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0NDEzNg==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428944136", "bodyText": "This is a lot of null passing. Maybe we need to support this signature sans predicate?", "author": "jpignata", "createdAt": "2020-05-21T22:12:13Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/syncengine/PersistentMutationOutboxTest.java", "diffHunk": "@@ -691,13 +694,13 @@ public void nextItemForModelIdReturnsFirstEnqueued() throws DataStoreException {\n         BlogOwner originalJoe = BlogOwner.builder()\n             .name(\"Joe Swanson\")\n             .build();\n-        PendingMutation<BlogOwner> firstMutation = PendingMutation.update(originalJoe, BlogOwner.class);\n+        PendingMutation<BlogOwner> firstMutation = PendingMutation.update(originalJoe, BlogOwner.class, null);\n         storage.save(originalJoe, converter.toRecord(firstMutation));\n \n         BlogOwner updatedJoe = originalJoe.copyOfBuilder()\n             .name(\"Joe Swanson, MD. (He finished med school, I guess?)\")\n             .build();\n-        PendingMutation<BlogOwner> secondMutation = PendingMutation.update(updatedJoe, BlogOwner.class);\n+        PendingMutation<BlogOwner> secondMutation = PendingMutation.update(updatedJoe, BlogOwner.class, null);", "originalCommit": "1f5f3e39b1bfa8b595f365833c6752654b93287e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3MDQwOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428970409", "bodyText": "Can this be stripped, now?", "author": "jamesonwilliams", "createdAt": "2020-05-21T23:39:20Z", "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/AppSyncClientInstrumentationTest.java", "diffHunk": "@@ -249,12 +256,20 @@ public void testAllOperations() throws DataStoreException {\n      * @return Model hat was deleted from endpoint, coupled with metadata about the deletion\n      * @throws DataStoreException If API delete call fails to render any response from AppSync endpoint\n      */\n+    @NonNull\n+    private <T extends Model> ModelWithMetadata<T> delete(\n+        @NonNull Class<T> clazz, String modelId, int version)\n+        throws DataStoreException {\n+        return delete(clazz, modelId, version, null);\n+    }\n+\n     @SuppressWarnings(\"SameParameterValue\") // Reads better with details in one place", "originalCommit": "1f5f3e39b1bfa8b595f365833c6752654b93287e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAwNTE1Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r429005156", "bodyText": "I'll give it a shot", "author": "rjuliano", "createdAt": "2020-05-22T02:01:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3MDQwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAyMDYxNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r429020617", "bodyText": "Removed it.", "author": "rjuliano", "createdAt": "2020-05-22T03:11:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3MDQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3MTg5Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428971893", "bodyText": "\"Uses Amplify API\"-- isn't true, in the interface. Even theAppSyncClientonly needs aGraphQLBehavior, doesn't it? Amplify.APIis a very specificGraphQLBehavior. mock(GraphQLBehavior)is one counter-example; this may be used to fulfill theupdate` contract.", "author": "jamesonwilliams", "createdAt": "2020-05-21T23:44:58Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSync.java", "diffHunk": "@@ -92,11 +93,50 @@\n             @NonNull Consumer<DataStoreException> onFailure\n     );\n \n+    /**\n+     * Uses Amplify API to make a mutation which will only apply if the version sent matches the server version.", "originalCommit": "1f5f3e39b1bfa8b595f365833c6752654b93287e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3MTkzNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428971937", "bodyText": "Same here", "author": "jamesonwilliams", "createdAt": "2020-05-21T23:45:07Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSync.java", "diffHunk": "@@ -92,11 +93,50 @@\n             @NonNull Consumer<DataStoreException> onFailure\n     );\n \n+    /**\n+     * Uses Amplify API to make a mutation which will only apply if the version sent matches the server version.\n+     * @param model An instance of the Model with the values to mutate\n+     * @param version The version of the model we have\n+     * @param predicate Condition to use for the update.\n+     * @param onResponse Invoked when response data is available.\n+     * @param onFailure Invoked on failure to obtain response data\n+     * @param <T> The type of data in the response. Must extend Model.\n+     * @return A {@link Cancelable} to provide a means to cancel the asynchronous operation\n+     */\n+    @NonNull\n+    <T extends Model> Cancelable update(\n+            @NonNull T model,\n+            @NonNull Integer version,\n+            @Nullable QueryPredicate predicate,\n+            @NonNull Consumer<GraphQLResponse<ModelWithMetadata<T>>> onResponse,\n+            @NonNull Consumer<DataStoreException> onFailure\n+    );\n+\n+    /**\n+     * Uses Amplify API to make a mutation which will only apply if the version sent matches the server version.", "originalCommit": "1f5f3e39b1bfa8b595f365833c6752654b93287e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3MjAwNg==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r428972006", "bodyText": "The other ones in this doc are using +8 off the method start", "author": "jamesonwilliams", "createdAt": "2020-05-21T23:45:23Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/appsync/AppSync.java", "diffHunk": "@@ -92,11 +93,50 @@\n             @NonNull Consumer<DataStoreException> onFailure\n     );\n \n+    /**\n+     * Uses Amplify API to make a mutation which will only apply if the version sent matches the server version.\n+     * @param model An instance of the Model with the values to mutate\n+     * @param version The version of the model we have\n+     * @param predicate Condition to use for the update.\n+     * @param onResponse Invoked when response data is available.\n+     * @param onFailure Invoked on failure to obtain response data\n+     * @param <T> The type of data in the response. Must extend Model.\n+     * @return A {@link Cancelable} to provide a means to cancel the asynchronous operation\n+     */\n+    @NonNull\n+    <T extends Model> Cancelable update(\n+            @NonNull T model,\n+            @NonNull Integer version,\n+            @Nullable QueryPredicate predicate,\n+            @NonNull Consumer<GraphQLResponse<ModelWithMetadata<T>>> onResponse,\n+            @NonNull Consumer<DataStoreException> onFailure\n+    );\n+\n+    /**\n+     * Uses Amplify API to make a mutation which will only apply if the version sent matches the server version.\n+     * @param clazz The class of the object being deleted\n+     * @param objectId ID id of the object to delete\n+     * @param version The version of the model we have\n+     * @param onResponse Invoked when response data is available.\n+     * @param onFailure Invoked on failure to obtain response data\n+     * @param <T> The type of data in the response. Must extend Model.\n+     * @return A {@link Cancelable} to provide a means to cancel the asynchronous operation\n+     */\n+    @NonNull\n+    <T extends Model> Cancelable delete(\n+        @NonNull Class<T> clazz,", "originalCommit": "1f5f3e39b1bfa8b595f365833c6752654b93287e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAxODEyMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/496#discussion_r429018122", "bodyText": "Fixed", "author": "rjuliano", "createdAt": "2020-05-22T02:59:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3MjAwNg=="}], "type": "inlineReview"}, {"oid": "c097eb85426e6f908a823be44bde76293c48af9c", "url": "https://github.com/aws-amplify/amplify-android/commit/c097eb85426e6f908a823be44bde76293c48af9c", "message": "Implement conflict resolution rules for existing and incoming mutations for the same model (#498)\n\nThe PR is a follow up to #496. It contains the business logic that handles conflicts when multiple mutations for the same model and enqueued. It takes into account whether a condition was included with the update/delete.", "committedDate": "2020-05-22T00:17:00Z", "type": "commit"}, {"oid": "80498d590d9218b0c0a19a4a7fb2675bb4e66ae6", "url": "https://github.com/aws-amplify/amplify-android/commit/80498d590d9218b0c0a19a4a7fb2675bb4e66ae6", "message": "PR feedback", "committedDate": "2020-05-22T03:09:31Z", "type": "commit"}, {"oid": "ef527604355abd2320cadbf5fc76c29257dc28b7", "url": "https://github.com/aws-amplify/amplify-android/commit/ef527604355abd2320cadbf5fc76c29257dc28b7", "message": "Merge branch 'rjuliano/dspredicate-param' of github.com:aws-amplify/amplify-android into rjuliano/dspredicate-param", "committedDate": "2020-05-22T03:10:44Z", "type": "commit"}]}