{"pr_number": 497, "pr_title": "Auth Integration for Storage", "pr_createdAt": "2020-05-20T21:04:08Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/497", "timeline": [{"oid": "a1138f9ff4d406a6d4768dcab0564e18857ba192", "url": "https://github.com/aws-amplify/amplify-android/commit/a1138f9ff4d406a6d4768dcab0564e18857ba192", "message": "Adds Options Object", "committedDate": "2020-05-15T21:00:07Z", "type": "commit"}, {"oid": "92260c39c69746cf9af8b2a5efcf1f39d927ee45", "url": "https://github.com/aws-amplify/amplify-android/commit/92260c39c69746cf9af8b2a5efcf1f39d927ee45", "message": "Adds signInWithWebUI and signInWithSocialWebUI", "committedDate": "2020-05-19T00:22:15Z", "type": "commit"}, {"oid": "a374cd97a4853d96f06aca4862e9ce5ec65fbff0", "url": "https://github.com/aws-amplify/amplify-android/commit/a374cd97a4853d96f06aca4862e9ce5ec65fbff0", "message": "Merge remote-tracking branch 'origin/master' into ddaudeli/HostedUI", "committedDate": "2020-05-19T00:38:33Z", "type": "commit"}, {"oid": "a3ddc7d337a38d317f364c9c9a795908daa74b1f", "url": "https://github.com/aws-amplify/amplify-android/commit/a3ddc7d337a38d317f364c9c9a795908daa74b1f", "message": "Integrates Auth Category in Storage", "committedDate": "2020-05-20T19:56:51Z", "type": "commit"}, {"oid": "05df99a5d00d6f5c7c816d2f503e70b3e9395d7b", "url": "https://github.com/aws-amplify/amplify-android/commit/05df99a5d00d6f5c7c816d2f503e70b3e9395d7b", "message": "Removes last instance of AWSMobileClient directly", "committedDate": "2020-05-20T20:54:07Z", "type": "commit"}, {"oid": "37fd7172c29d186e72e10164f55b70a0f07d3d4e", "url": "https://github.com/aws-amplify/amplify-android/commit/37fd7172c29d186e72e10164f55b70a0f07d3d4e", "message": "Merge remote-tracking branch 'origin/master' into ddaudeli/AuthIntegration", "committedDate": "2020-05-20T20:58:45Z", "type": "commit"}, {"oid": "ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c", "url": "https://github.com/aws-amplify/amplify-android/commit/ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c", "message": "Fixes comment", "committedDate": "2020-05-20T21:03:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwODAzMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428308033", "bodyText": "extra line", "author": "raphkim", "createdAt": "2020-05-20T21:07:57Z", "path": "aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/AWSAuthProvider.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.storage.s3;\n+\n+import com.amplifyframework.storage.StorageException;\n+\n+import com.amazonaws.auth.AWSCredentialsProvider;\n+\n+/**\n+ * Internal interface for providing AWS specific Auth information.\n+ */\n+public interface AWSAuthProvider {\n+    /**\n+     * Get the identity ID of the currently logged in user if they are registered in identity pools.\n+     * @return the identity ID of the currently logged in user.\n+     * @throws StorageException  If the proper Auth plugin isn't added or identity id is unavailable\n+     */\n+    String getIdentityId() throws StorageException;\n+", "originalCommit": "ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2NTg5NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428365894", "bodyText": "Got it", "author": "TrekSoft", "createdAt": "2020-05-20T23:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwODAzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwOTM1MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428309351", "bodyText": "Nit: why do both plugin and service need the reference to the auth provider? If the service is going to have access to it, then the plugin shouldn't need it right?\nAlso, you should keep only one reference of MobileClientAWSAuthProvider() rather than instantiating two separately.", "author": "raphkim", "createdAt": "2020-05-20T21:10:43Z", "path": "aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/AWSS3StoragePlugin.java", "diffHunk": "@@ -82,22 +80,27 @@\n      * Constructs the AWS S3 Storage Plugin initializing the executor service.\n      */\n     public AWSS3StoragePlugin() {\n-        this(\n-            (context, region, bucket) ->\n-                    new AWSS3StorageService(context, region, bucket, false),\n-            () -> AWSMobileClient.getInstance().getIdentityId()\n-        );\n+        this((context, region, bucket) ->\n+                new AWSS3StorageService(context, region, bucket, new MobileClientAWSAuthProvider(), false),\n+                new MobileClientAWSAuthProvider());", "originalCommit": "ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxOTc2Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428319767", "bodyText": "Java's requirements that this(...) or super(...) must exist in the first line --\nThis is one reason I use factory methods all of the the place, cause then you can do:\nstatic Gizmo create() {\n    allKinds();\n    ofMagical();\n    thangsBefore();\n    return new Gizmo(kFine, iAmReady, now);\n}\n\nAnyway, we are stuck with a no-args constructor as our plugin instantiation API.\nTo \"cope\" with this, you could do like:\nclass GizmoPlugin {\n    GizmoPlugin() {\n        this(defaultFidgetSpinner(), defaultDongler());\n    }\n\n    GizmoPlugin(FidgetSpinner spinner, Dongler dongler) {\n        this(spinner, dongler, spinner, dongler); // if implementing a few needed interfaces from one component\n    }\n  \n   GizmoPlugin(\n        Fidget fidget,\n        AbstractDongler abstractDongler,\n        Spinner spinner,\n        DonglerBase donlgerBase) {\n     }\n\n    static defaultFidgetSpindler() {\n        // cook one up, bruh.\n    }\n}", "author": "jamesonwilliams", "createdAt": "2020-05-20T21:32:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwOTM1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2NTY1NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428365654", "bodyText": "Yeah so I thought about both these things - I had kept them separate since the Storage Service was specifically focused on storage methods and thought it would corrupt it to have the auth methods in there as well. And since the call to the constructor has to be the first line in the method it didn't work to create a common initialization of the auth provider.\nHowever, since you also feel it should just be available from the service, I'll go ahead and do that.\nEDIT: Haha apparently Jameson's comment hadn't shown before I posted this. I guess for now I'll just use his suggestion for addressing the single instantiation and leave AuthProvider as separate from the StorageService since it really is a totally different concept. Then later as we address this with a final solution we can see what makes sense.", "author": "TrekSoft", "createdAt": "2020-05-20T23:33:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwOTM1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxMjE0MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428312140", "bodyText": "Nit: AWSMobileClientAuthProvider instead?", "author": "raphkim", "createdAt": "2020-05-20T21:16:48Z", "path": "aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/MobileClientAWSAuthProvider.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.storage.s3;\n+\n+import com.amplifyframework.core.Amplify;\n+import com.amplifyframework.storage.StorageException;\n+\n+import com.amazonaws.auth.AWSCredentialsProvider;\n+import com.amazonaws.mobile.client.AWSMobileClient;\n+\n+/**\n+ * Static utility class internal to the plugin to interface with Auth.\n+ */\n+public final class MobileClientAWSAuthProvider implements AWSAuthProvider {", "originalCommit": "ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2NTg0OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428365849", "bodyText": "Kk", "author": "TrekSoft", "createdAt": "2020-05-20T23:34:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxMjE0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMDg3Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428320872", "bodyText": "I think the Identity ID is actually a Cognito thing, not an AWS thing. So, your interface maybe should be called CognitoIdentityProvider.", "author": "jamesonwilliams", "createdAt": "2020-05-20T21:35:08Z", "path": "aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/AWSAuthProvider.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.storage.s3;\n+\n+import com.amplifyframework.storage.StorageException;\n+\n+import com.amazonaws.auth.AWSCredentialsProvider;\n+\n+/**\n+ * Internal interface for providing AWS specific Auth information.\n+ */\n+public interface AWSAuthProvider {\n+    /**\n+     * Get the identity ID of the currently logged in user if they are registered in identity pools.\n+     * @return the identity ID of the currently logged in user.\n+     * @throws StorageException  If the proper Auth plugin isn't added or identity id is unavailable\n+     */\n+    String getIdentityId() throws StorageException;", "originalCommit": "ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2NTczMA==", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428365730", "bodyText": "Fair enough", "author": "TrekSoft", "createdAt": "2020-05-20T23:34:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMDg3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMTg5NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428321894", "bodyText": "Can you scope this to only the new auth lines that throw it?\nfinal String maybeVar;\ntry {\n   maybeVar = getIt();\n} catch (StorageException varNotAvailable) {\n   blowUp();\n}\n// maybeVar is now a legit var.", "author": "jamesonwilliams", "createdAt": "2020-05-20T21:37:18Z", "path": "aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/operation/AWSS3StorageDownloadFileOperation.java", "diffHunk": "@@ -76,11 +81,20 @@ public void start() {\n             return;\n         }\n \n-        String serviceKey = S3Keys.createServiceKey(\n-                getRequest().getAccessLevel(),\n-                getRequest().getTargetIdentityId(),\n-                getRequest().getKey()\n-        );\n+        String serviceKey;\n+\n+        try {\n+            serviceKey = S3Keys.createServiceKey(\n+                    getRequest().getAccessLevel(),\n+                    getRequest().getTargetIdentityId() != null\n+                            ? getRequest().getTargetIdentityId()\n+                            : awsAuthProvider.getIdentityId(),\n+                    getRequest().getKey()\n+            );\n+        } catch (StorageException exception) {", "originalCommit": "ca96ef3f42dc82c62b61ebb88516c6c4fcd6a60c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2NTgwMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/497#discussion_r428365803", "bodyText": "Sure", "author": "TrekSoft", "createdAt": "2020-05-20T23:34:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMTg5NA=="}], "type": "inlineReview"}, {"oid": "35d6818d931a5730a2d079d26992249ec8e25863", "url": "https://github.com/aws-amplify/amplify-android/commit/35d6818d931a5730a2d079d26992249ec8e25863", "message": "Addresses PR feedback", "committedDate": "2020-05-20T23:58:26Z", "type": "commit"}, {"oid": "5a50d8dde5e38096baaf3d75edf4f8cd46661c2d", "url": "https://github.com/aws-amplify/amplify-android/commit/5a50d8dde5e38096baaf3d75edf4f8cd46661c2d", "message": "More PR feedback", "committedDate": "2020-05-20T23:59:36Z", "type": "commit"}]}