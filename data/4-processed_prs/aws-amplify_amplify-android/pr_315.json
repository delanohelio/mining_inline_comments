{"pr_number": 315, "pr_title": "Versions in datastore", "pr_createdAt": "2020-03-20T07:38:46Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/315", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3NjE0MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395676141", "bodyText": "This looks like the default equals functionality - is there a need to override it that I'm missing here?", "author": "TrekSoft", "createdAt": "2020-03-20T14:32:46Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/storage/StorageItemChange.java", "diffHunk": "@@ -133,12 +131,13 @@ public T item() {\n      * @param recordFactory A component capable of generating records.\n      * @return A Record representation of this instance.\n      */\n+    @NonNull\n     public Record toRecord(@NonNull RecordFactory recordFactory) {\n         return Objects.requireNonNull(recordFactory).toRecord(this);\n     }\n \n     @Override\n-    public boolean equals(Object thatObject) {\n+    public boolean equals(@Nullable Object thatObject) {\n         if (this == thatObject) {\n             return true;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc1NzE0Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395757147", "bodyText": "The default equals(...) works like this:\n\nfor any non-null reference values x and y, this method returns true if and only if x and y refer to the same object (x == y has the value true).\n\nSo, that'd be equivalent to an implementation like return this == thatObject.\nBut here, I say, \"okay, if they're the same object, yea, they're equal. BUT ALSO.... they're equal if they're fields are equal, even if they're not the same object.\"", "author": "jamesonwilliams", "createdAt": "2020-03-20T16:36:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3NjE0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgwNDI1MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395804251", "bodyText": "Argh, the diff made it look like there was nothing more to this method than what's shown above. Ignore this comment.", "author": "TrekSoft", "createdAt": "2020-03-20T17:59:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3NjE0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4NjQ1Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395686452", "bodyText": "What's the idea behind using caps to distinguish between these two classes vs. a naming difference?", "author": "TrekSoft", "createdAt": "2020-03-20T14:48:23Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -85,20 +103,78 @@ void stopDrainingMutationOutbox() {\n     }\n \n     /**\n-     * To process a StorageItemChange, we try to publish it to the remote GraphQL\n-     * API. If that succeeds, then we can remove it from the outbox. Otherwise,\n-     * we have to keep the mutation in the outbox, so that we can try to publish\n-     * it again later, when network conditions become favorable again.\n+     * Attempt to publish a change (update, delete, creation) over the network.\n      * @param storageItemChange A storage item change to be published to remote API\n-     * @return A single which completes with the successfully published item, or errors\n+     * @return A single which completes with the successfully published item, or emits error\n      *         if the publication fails\n      */\n-    @SuppressWarnings(\"checkstyle:MethodTypeParameterName\") // The generics are complex, so use meaningful names\n     private <MODEL extends Model, SIC extends StorageItemChange<MODEL>> Single<SIC> publishToNetwork(", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc1ODE3NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395758174", "bodyText": "I could use <M extends Model, S extends StorageItemChange<M>>, I guess.\nSince there are so many generic types, and several types around here start with an M (Model, ModelMetadata, ModelWithMetadata, etc.) I thought it'd be clearer to read if I was explicit with the MODEL, etc.", "author": "jamesonwilliams", "createdAt": "2020-03-20T16:37:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4NjQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgwNTk3Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395805973", "bodyText": "Ok, what's the difference between MODEL and Model? Would it make sense to give MODEL a name that reflects that difference?", "author": "TrekSoft", "createdAt": "2020-03-20T18:02:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4NjQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg3Mzc2Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395873767", "bodyText": "Update: I got rid of all this crap, in a subsequent update. It ends up being easier to read with just the <T extends Model> that we use eery where else.", "author": "jamesonwilliams", "createdAt": "2020-03-20T20:26:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4NjQ1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcwNzQzMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395707432", "bodyText": "Do you think in this case it'd make sense to throw a custom error with an explanation if it is null since this isn't checking input provided by the customer but rather the result we're returning? Same for below on line 73?", "author": "TrekSoft", "createdAt": "2020-03-20T15:18:42Z", "path": "core/src/main/java/com/amplifyframework/core/model/ModelSchemaRegistry.java", "diffHunk": "@@ -57,8 +55,10 @@ public synchronized void load(@NonNull Set<Class<? extends Model>> models) throw\n      *                        {@link Class#getSimpleName()} method.\n      * @return the ModelSchema object for the given Model class.\n      */\n+    @NonNull\n     public synchronized ModelSchema getModelSchemaForModelClass(@NonNull String classSimpleName) {\n-        return modelSchemaMap.get(classSimpleName);\n+        final ModelSchema result = modelSchemaMap.get(classSimpleName);\n+        return Objects.requireNonNull(result);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc1ODc1NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395758755", "bodyText": "Hm, yes, I agree. I'll update this.", "author": "jamesonwilliams", "createdAt": "2020-03-20T16:38:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcwNzQzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcwODI3Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395708277", "bodyText": "Why do we have what looks like the same enum here as well as in StorageItemChange.java in the DataStore project?", "author": "TrekSoft", "createdAt": "2020-03-20T15:19:52Z", "path": "core/src/main/java/com/amplifyframework/datastore/DataStoreItemChange.java", "diffHunk": "@@ -259,9 +263,14 @@ public String toString() {\n      */\n     public enum Type {\n         /**\n-         * An item has been saved into the DataStore.\n+         * An item with a new ID has been saved into the DataStore.\n+         */\n+        CREATE,", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc1OTk4MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395759981", "bodyText": "True, yea. The local storage module and the public DataStore API share a number of features. In this case, the enum is entirely the same.\nI could use just one, but I'd need a name for it that made sense for both.\nLogically speaking, one is talking about changes to the DataStore, and one is talking about changes to an internal system component (the storage adapter). Which theoretically could be different, but in practice, aren't really.", "author": "jamesonwilliams", "createdAt": "2020-03-20T16:40:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcwODI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgwNDkyNA==", "url": "https://github.com/aws-amplify/amplify-android/pull/315#discussion_r395804924", "bodyText": "Ah, ok yeah if they have different meanings than that makes sense to have the two.", "author": "TrekSoft", "createdAt": "2020-03-20T18:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcwODI3Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "44099623494636d9d41f359ab76529f2efa97ee7", "url": "https://github.com/aws-amplify/amplify-android/commit/44099623494636d9d41f359ab76529f2efa97ee7", "message": "[aws-datastore] Perform base sync at startup and save model versions\n\nPerform a base sync as part of starting up the DataStore.\n\nModelMetadata is used to record the version of particular models managed\nby the DataStore. A table for this structure must be created while the\nstorage adapter is initializing.\n\nItems coming back from the base sync must be applied with respect to the\ntopological ordering of their model classes. For example, given a\nrelationship:\n\n 1 Blog - n Posts - n Comments\n\nThe blog must be created, so that a post can \"belongsTo\" it, and the\npost must be created next, so that a comment can \"belongsTo\" that.", "committedDate": "2020-03-21T03:51:18Z", "type": "commit"}, {"oid": "b32cf9a48dde4fb120d1e9a3307725b30ef6c864", "url": "https://github.com/aws-amplify/amplify-android/commit/b32cf9a48dde4fb120d1e9a3307725b30ef6c864", "message": "[aws-datastore] Separate create and update types for storage adapter\n\nWhile publishing a local change, the sync engine needs to know if the\nchange was a create or an update.\n\nThe storage adatper knows whether or not a save resulted in the creation\nof a new record, or an update to an existing record. So, the storage\napdater is able to communicate out this information to its listeners.", "committedDate": "2020-03-21T03:51:18Z", "type": "commit"}, {"oid": "20d99b8c6b755c15dd61e89f99150321b9cc7087", "url": "https://github.com/aws-amplify/amplify-android/commit/20d99b8c6b755c15dd61e89f99150321b9cc7087", "message": "[aws-datastore] Don't ignore update and delete outbox tests", "committedDate": "2020-03-21T03:51:54Z", "type": "commit"}, {"oid": "b5ef0fd8ccbf373deebe9e066b5add9973628250", "url": "https://github.com/aws-amplify/amplify-android/commit/b5ef0fd8ccbf373deebe9e066b5add9973628250", "message": "[aws-datastore] Handle create update and delete in MutationProcessor\n\nWhile draining changes from the mutation outbox, correctly handle all\nof create, update, delete.\n\nPreviously, only creations were being dispatched.\n\nUpdates and deletes additionally require the presence of a version, in\nthe outgoing request to AppSync.", "committedDate": "2020-03-21T03:51:54Z", "type": "commit"}, {"oid": "13a001d81c15717d7d1b4da3be9d3e09eb67b422", "url": "https://github.com/aws-amplify/amplify-android/commit/13a001d81c15717d7d1b4da3be9d3e09eb67b422", "message": "[aws-datastore] All network data passed through merger\n\nSyncProcessor, MutationProcessor, SubscriptionProcessor all forward\ntheir GraphQLResponse entities - as ModelWithMetadata - into a new\nMerger component.\n\nAll versioning information is obtained from a new VersionRegistry\ncomponent.\n\nBoth VersionRegistry and Merger wrap the LocalStorageAdapter.", "committedDate": "2020-03-21T06:21:10Z", "type": "commit"}, {"oid": "13a001d81c15717d7d1b4da3be9d3e09eb67b422", "url": "https://github.com/aws-amplify/amplify-android/commit/13a001d81c15717d7d1b4da3be9d3e09eb67b422", "message": "[aws-datastore] All network data passed through merger\n\nSyncProcessor, MutationProcessor, SubscriptionProcessor all forward\ntheir GraphQLResponse entities - as ModelWithMetadata - into a new\nMerger component.\n\nAll versioning information is obtained from a new VersionRegistry\ncomponent.\n\nBoth VersionRegistry and Merger wrap the LocalStorageAdapter.", "committedDate": "2020-03-21T06:21:10Z", "type": "forcePushed"}, {"oid": "13a001d81c15717d7d1b4da3be9d3e09eb67b422", "url": "https://github.com/aws-amplify/amplify-android/commit/13a001d81c15717d7d1b4da3be9d3e09eb67b422", "message": "[aws-datastore] All network data passed through merger\n\nSyncProcessor, MutationProcessor, SubscriptionProcessor all forward\ntheir GraphQLResponse entities - as ModelWithMetadata - into a new\nMerger component.\n\nAll versioning information is obtained from a new VersionRegistry\ncomponent.\n\nBoth VersionRegistry and Merger wrap the LocalStorageAdapter.", "committedDate": "2020-03-21T06:21:10Z", "type": "forcePushed"}]}