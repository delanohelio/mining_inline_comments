{"pr_number": 658, "pr_title": "fix(api): now correctly signs requests with query string params", "pr_createdAt": "2020-07-21T15:06:48Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/658", "timeline": [{"oid": "4cdf3037c2f5870ad11fd03b0fb65bfbd47f2cf5", "url": "https://github.com/aws-amplify/amplify-android/commit/4cdf3037c2f5870ad11fd03b0fb65bfbd47f2cf5", "message": "Re-encode URL inside request factory", "committedDate": "2020-07-20T18:32:53Z", "type": "commit"}, {"oid": "51f74e85afd374a14166d3dd707ff5c995bc9786", "url": "https://github.com/aws-amplify/amplify-android/commit/51f74e85afd374a14166d3dd707ff5c995bc9786", "message": "Make API signer service name account for REST", "committedDate": "2020-07-21T14:33:33Z", "type": "commit"}, {"oid": "3fc55d4766e40124004e5a7d12a44c9c6a5f955d", "url": "https://github.com/aws-amplify/amplify-android/commit/3fc55d4766e40124004e5a7d12a44c9c6a5f955d", "message": "Add query string param in signer", "committedDate": "2020-07-21T14:57:52Z", "type": "commit"}, {"oid": "f5057021d135c5ebd52724dc3c377be0c7be8d9a", "url": "https://github.com/aws-amplify/amplify-android/commit/f5057021d135c5ebd52724dc3c377be0c7be8d9a", "message": "Checkstyle fixup", "committedDate": "2020-07-21T15:09:16Z", "type": "commit"}, {"oid": "9fed76a6d34c712bbe63c45bf0fe8c0de2376868", "url": "https://github.com/aws-amplify/amplify-android/commit/9fed76a6d34c712bbe63c45bf0fe8c0de2376868", "message": "Null-check query", "committedDate": "2020-07-21T15:12:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5MTgwOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/658#discussion_r458491808", "bodyText": "This enters the project from a transitive dependency. IMO we should minimize our use of com.amazonaws.* overall, and try to stick to public APIs related to the per-category functionalities.\nSince you're only using it for an isBlank(...) check, use our Empty.check(...) instead.", "author": "jamesonwilliams", "createdAt": "2020-07-22T02:09:54Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/sigv4/AppSyncSigV4SignerInterceptor.java", "diffHunk": "@@ -25,9 +25,15 @@\n import com.amazonaws.auth.AWSCredentialsProvider;\n import com.amazonaws.http.HttpMethodName;\n import com.amazonaws.util.IOUtils;\n+import com.amazonaws.util.StringUtils;", "originalCommit": "9fed76a6d34c712bbe63c45bf0fe8c0de2376868", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ5MzIzMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/658#discussion_r458493231", "bodyText": "I had some similar code recently and @richardmcclellan raised some good points: what would happen here if the URL were malformed? Is a null pointer or out-of-range error thrown?", "author": "jamesonwilliams", "createdAt": "2020-07-22T02:15:12Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/sigv4/AppSyncSigV4SignerInterceptor.java", "diffHunk": "@@ -221,23 +236,23 @@ public Response intercept(Chain chain) throws IOException {\n         return chain.proceed(okReqBuilder.build());\n     }\n \n-    // Utility method to convert string to human-readable format\n-    private String toHumanReadableAscii(String str) {\n-        for (int i = 0, length = str.length(), c; i < length; i += Character.charCount(c)) {\n-            c = str.codePointAt(i);\n-            if (c > '\\u001f' && c < '\\u007f') {\n-                continue;\n-            }\n-            Buffer buffer = new Buffer();\n-            buffer.writeUtf8(str, 0, i);\n-            for (int j = i; j < length; j += Character.charCount(c)) {\n-                c = str.codePointAt(j);\n-                if (c > '\\u001f' && c < '\\u007f') {\n-                    buffer.writeUtf8CodePoint(c);\n-                }\n-            }\n-            return buffer.readUtf8();\n+    // Extracts query string parameters from a URL.\n+    // Source: https://stackoverflow.com/questions/13592236/parse-a-uri-string-into-name-value-collection\n+    @NonNull\n+    private static Map<String, String> splitQuery(URL url) throws UnsupportedEncodingException {\n+        Map<String, String> queryPairs = new LinkedHashMap<>();\n+        String query = url.getQuery();\n+        if (StringUtils.isBlank(query)) {\n+            return Collections.emptyMap();\n+        }\n+        String[] pairs = query.split(\"&\");\n+        for (String pair : pairs) {", "originalCommit": "9fed76a6d34c712bbe63c45bf0fe8c0de2376868", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "28ab2ce983d451887483ea80bc4d86551a8cab64", "url": "https://github.com/aws-amplify/amplify-android/commit/28ab2ce983d451887483ea80bc4d86551a8cab64", "message": "Apply PR suggestions", "committedDate": "2020-07-23T18:32:49Z", "type": "commit"}, {"oid": "fec16cbb02cbb52d3dcd68017e8fc67e1efb73a8", "url": "https://github.com/aws-amplify/amplify-android/commit/fec16cbb02cbb52d3dcd68017e8fc67e1efb73a8", "message": "Checkstyle fixup", "committedDate": "2020-07-23T19:04:31Z", "type": "commit"}]}