{"pr_number": 439, "pr_title": "[aws-datastore] PendingMutations are now Comparable according to their creation times", "pr_createdAt": "2020-05-07T22:14:41Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/439", "timeline": [{"oid": "765802ad488e6392fab01d7d0f7167f510fe88ce", "url": "https://github.com/aws-amplify/amplify-android/commit/765802ad488e6392fab01d7d0f7167f510fe88ce", "message": "[aws-datastore] PendingMutations are now Comparable by creation time\n\nChanges the ID type of the `PendingMutation`. The `PendingMutation` now\nhas its own UUID. A mechnism still exists to obtain the ID of the\nassociated model:\n\n    pendingMutation.getMutationId();\n    pendingMutation.getMutatedItem().getId();\n\nThe `PendingMuation.PersistentRecord` now has *two* IDs, a \"mutation\nID\", and a \"decoded model ID\":\n\n    record.getId();\n    record.getDecodedModelId();\n\nPreviously, the getId() on the record would return the same ID as\n`pendingMutation.getMutatedItem().getId()`.\n\nAfter this change, the mutation ID is uniquely for the PendingMutation\nitself. This ID is also of a different type. It is a time-based UUIDv1.\nThis type of UUID was chosen as it may be sorted according to its\ntimestamp. And as a consequence, `PendingMutation`s themselves may now\nbe sorted by their UUIDv1s. `PendingMutation.PersistentRecord`s use this\nas their primary `getId()` value.\n\nThe old ID of `PendingMutation.PersistentRecord` is now available by\n`getDecodedModelIs()`. This is the ID of the _associated model_ -- the\nthing that had undergone some mutation, to begin with. As before, this\nUUID is still a v4 UUID, maintained for its technical superiority over\nthe time-based V1. This value is stored on the record, so that we can\nstill query for records based on _model ID_, which is what is generally\nused aroudn the DataStore system.", "committedDate": "2020-05-07T22:14:22Z", "type": "commit"}, {"oid": "0417ec72949f793ee42f77ac8d1b20052ac839f5", "url": "https://github.com/aws-amplify/amplify-android/commit/0417ec72949f793ee42f77ac8d1b20052ac839f5", "message": "touchups", "committedDate": "2020-05-08T03:08:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjExNTcyNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/439#discussion_r422115725", "bodyText": "This was the first method that came to mind when I read the PR intro. Looks like you got it covered \ud83d\udc4d", "author": "rjuliano", "createdAt": "2020-05-08T12:30:57Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationOutbox.java", "diffHunk": "@@ -65,8 +66,10 @@\n     @NonNull\n     Single<Boolean> hasPendingMutation(@NonNull String modelId) {", "originalCommit": "0417ec72949f793ee42f77ac8d1b20052ac839f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE0MDczNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/439#discussion_r422140737", "bodyText": "Other than for testing purposes, do we want to leave this instance method callable from any class within this package?\nThis is very low risk, but my only thought is that we want to ensure these time-based UUIDs are generated on the local device only right?", "author": "rjuliano", "createdAt": "2020-05-08T13:24:58Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/PendingMutation.java", "diffHunk": "@@ -38,34 +37,55 @@\n  * logic onto them, before ultimately uploading to a remote endpoint.\n  * @param <T> Type of model that has experienced a mutation\n  */\n-public final class PendingMutation<T extends Model> {\n+public final class PendingMutation<T extends Model> implements Comparable<PendingMutation<? extends Model>> {\n     private final T mutatedItem;\n     private final Class<T> classOfMutatedItem;\n     private final Type mutationType;\n+    private final TimeBasedUuid mutationId;\n \n-    private PendingMutation(T mutatedItem, Class<T> classOfMutatedItem, Type mutationType) {\n+    private PendingMutation(TimeBasedUuid mutationId, T mutatedItem, Class<T> classOfMutatedItem, Type mutationType) {\n+        this.mutationId = mutationId;\n         this.mutatedItem = mutatedItem;\n         this.classOfMutatedItem = classOfMutatedItem;\n         this.mutationType = mutationType;\n     }\n \n     /**\n-     * Creates a {@link PendingMutation}.\n+     * Creates a {@link PendingMutation}, using a provided mutation ID.\n+     * @param mutationId A globally-unique, *time-based* ID for this mutation event;\n+     *                   the ID is used for temporal ordering of mutations\n      * @param mutatedItem The item that undergone a mutation\n      * @param classOfMutatedItem The class of the item that has undergone mutation\n      * @param mutationType Type of mutation\n      * @param <T> The type of the item that has undergone mutation\n      * @return A {@link PendingMutation}\n      */\n     static <T extends Model> PendingMutation<T> instance(", "originalCommit": "0417ec72949f793ee42f77ac8d1b20052ac839f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI3NDg1OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/439#discussion_r422274859", "bodyText": "This version is actually used by the Gson deserializer, when we convert back from a (peristable) PersistentRecord. This is how we \"recover\" the stored timestamp, back into a PendingMutation.", "author": "jamesonwilliams", "createdAt": "2020-05-08T17:36:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE0MDczNw=="}], "type": "inlineReview"}]}