{"pr_number": 633, "pr_title": "feat(DataStore) add sorting", "pr_createdAt": "2020-07-09T23:37:58Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/633", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxOTc5Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/633#discussion_r452619797", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \", sortInput=\" + sortBy +\n          \n          \n            \n                            \", sortBy=\" + sortBy +", "author": "jamesonwilliams", "createdAt": "2020-07-10T04:47:14Z", "path": "core/src/main/java/com/amplifyframework/core/model/query/QueryOptions.java", "diffHunk": "@@ -102,6 +141,7 @@ public String toString() {\n         return \"QueryOptions{\" +\n                 \"queryPredicate=\" + queryPredicate +\n                 \", paginationInput=\" + paginationInput +\n+                \", sortInput=\" + sortBy +", "originalCommit": "40c45db42571a1ae5ee97c2480afab9df70fb5af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg1NTE3Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/633#discussion_r457855173", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /**\n          \n          \n            \n                 * Returns the {@code sortInput} property.\n          \n          \n            \n                 * @return the {@code sortInput} property.\n          \n          \n            \n                 */\n          \n          \n            \n                /**\n          \n          \n            \n                 * Returns the {@code sortBy} property.\n          \n          \n            \n                 * @return the {@code sortBy} property.\n          \n          \n            \n                 */", "author": "jamesonwilliams", "createdAt": "2020-07-21T05:59:50Z", "path": "core/src/main/java/com/amplifyframework/core/model/query/QueryOptions.java", "diffHunk": "@@ -78,6 +107,15 @@ public QueryPaginationInput getPaginationInput() {\n         return paginationInput;\n     }\n \n+    /**\n+     * Returns the {@code sortInput} property.\n+     * @return the {@code sortInput} property.\n+     */", "originalCommit": "40c45db42571a1ae5ee97c2480afab9df70fb5af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "056445018ba6ac89e575c931a71961c0ab6f063b", "url": "https://github.com/aws-amplify/amplify-android/commit/056445018ba6ac89e575c931a71961c0ab6f063b", "message": "feat(datastore) add sorting", "committedDate": "2020-08-18T21:44:15Z", "type": "commit"}, {"oid": "4e88cada73c3c231826bc249282bb3949f53c343", "url": "https://github.com/aws-amplify/amplify-android/commit/4e88cada73c3c231826bc249282bb3949f53c343", "message": "Update core/src/main/java/com/amplifyframework/core/model/query/QueryOptions.java\n\nCo-authored-by: Jameson Williams <jhwill@amazon.com>", "committedDate": "2020-08-18T21:44:15Z", "type": "commit"}, {"oid": "ea84d0d7f8fc2b8c02b00b375e9005eba183f194", "url": "https://github.com/aws-amplify/amplify-android/commit/ea84d0d7f8fc2b8c02b00b375e9005eba183f194", "message": "Update core/src/main/java/com/amplifyframework/core/model/query/QueryOptions.java\n\nCo-authored-by: Jameson Williams <jhwill@amazon.com>", "committedDate": "2020-08-18T21:44:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU5NjUyMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/633#discussion_r473596522", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class QuerySortBy {\n          \n          \n            \n            public final class QuerySortBy {", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:12:20Z", "path": "core/src/main/java/com/amplifyframework/core/model/query/QuerySortBy.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.core.model.query;\n+\n+/**\n+ * A simple data structure that holds sort information that can be applied queries.\n+ */\n+public class QuerySortBy {", "originalCommit": "a642aaab6f6f172df6a038bec2ed0affacc6ea37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU5Njg1OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/633#discussion_r473596858", "bodyText": "field accessors, equals, toString, hashCode, all that Jazz? (If only we could use Kotlin data classes, sigh.)", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:12:55Z", "path": "core/src/main/java/com/amplifyframework/core/model/query/QuerySortBy.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.core.model.query;\n+\n+/**\n+ * A simple data structure that holds sort information that can be applied queries.\n+ */\n+public class QuerySortBy {\n+    private final String field;\n+    private final QuerySortOrder sortOrder;\n+\n+    /**\n+     * Constructor for {@code QuerySortBy}.\n+     *\n+     * @param field name of field to sort by.\n+     * @param sortOrder order to sort by, either ASCENDING or DESCENDING.\n+     */\n+    public QuerySortBy(String field, QuerySortOrder sortOrder) {\n+        this.field = field;\n+        this.sortOrder = sortOrder;\n+    }", "originalCommit": "a642aaab6f6f172df6a038bec2ed0affacc6ea37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU5NzE0Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/633#discussion_r473597147", "bodyText": "Probably room for rewording", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:13:24Z", "path": "core/src/main/java/com/amplifyframework/core/model/query/QuerySortBy.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.core.model.query;\n+\n+/**\n+ * A simple data structure that holds sort information that can be applied queries.", "originalCommit": "a642aaab6f6f172df6a038bec2ed0affacc6ea37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYwMzAzNg==", "url": "https://github.com/aws-amplify/amplify-android/pull/633#discussion_r473603036", "bodyText": "The new sorted and matches change QueryOptions into a mutable class.\nOne ~easy solution would be to have these generate clones, that \"patch\" the field of interest.\ne.g.\n    public QueryOptions sorted(@NonNull final QuerySortBy... sortBy) {\n        return new QueryOptions(queryPredicate, paginationInput, Immutable.of(Arrays.asList(sortBy)));\n    }\nAlso, it would certainly be cool* if we could build up the list of QuerySortBy through subsequent appended calls:\nWhere.sorted(User.LAST_NAME.ascending())\n    .sorted(User.FIRST_NAME.ascending())\n    .sorted(User.CREATED_AT.descending())\nIf we were to support that, I guess the impl of this method would be more like:\n    public QueryOptions sorted(@NonNull final QuerySortBy... sortBy) {\n        List<QuerySortBy> augmentedList = new ArrayList<>(this.sortBy);\n        augmentedList.addAll(Immutable.of(sortBy));\n        return new QueryOptions(queryPredicate, paginationInput, Immutable.of(augmentedList));\n    }", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:23:12Z", "path": "core/src/main/java/com/amplifyframework/core/model/query/QueryOptions.java", "diffHunk": "@@ -60,6 +78,17 @@ public QueryOptions paginated(@NonNull final QueryPaginationInput paginationInpu\n         return this;\n     }\n \n+    /**\n+     * Updates the current options with a given {@code sortBy}.\n+     *\n+     * @param sortBy sorting information\n+     * @return current options with an updated {@code sortBy}.\n+     */\n+    public QueryOptions sorted(@NonNull final QuerySortBy... sortBy) {", "originalCommit": "a642aaab6f6f172df6a038bec2ed0affacc6ea37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYwMzc2NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/633#discussion_r473603764", "bodyText": "Mostly same discussion on this one as sorted(...) I think, except without the list building crap. TLDR, See if you can return a new copy of QueryOptions instead of mutating this instance. This will keep the options object immutable.", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:24:29Z", "path": "core/src/main/java/com/amplifyframework/core/model/query/QueryOptions.java", "diffHunk": "@@ -22,28 +22,46 @@\n import com.amplifyframework.core.model.query.predicate.QueryPredicate;\n import com.amplifyframework.core.model.query.predicate.QueryPredicates;\n \n+import java.util.Arrays;\n+import java.util.List;\n+\n /**\n  * A data structure that provides a query construction mechanism that consolidates all query-related\n  * options (e.g. predicates, pagination, etc) and allows consumers to build queries in a fluent way.\n  */\n public final class QueryOptions {\n     private QueryPredicate queryPredicate;\n     private QueryPaginationInput paginationInput;\n+    private List<QuerySortBy> sortBy;\n \n     /**\n      * This class should be created using the factory methods such as {@link Where#matchesAll()}\n      * and {@link Where#matches(QueryPredicate)}.\n      */\n     QueryOptions(\n             @Nullable QueryPredicate queryPredicate,\n-            @Nullable QueryPaginationInput paginationInput\n+            @Nullable QueryPaginationInput paginationInput,\n+            @Nullable List<QuerySortBy> sortBy\n     ) {\n         this.queryPredicate = queryPredicate == null ? QueryPredicates.all() : queryPredicate;\n         this.paginationInput = paginationInput;\n+        this.sortBy = sortBy;\n     }\n \n     QueryOptions() {\n-        this(null, null);\n+        this(null, null, null);\n+    }\n+\n+    /**\n+     * Update the current options with a given {@code queryPredicate}.\n+     *\n+     * @param queryPredicate predicate.\n+     * @return current options with an updated {@code queryPredicate}.\n+     */\n+    @NonNull\n+    public QueryOptions matches(@NonNull final QueryPredicate queryPredicate) {", "originalCommit": "a642aaab6f6f172df6a038bec2ed0affacc6ea37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d6f61ccdd15b537d2aca3584f0b65026727e22cb", "url": "https://github.com/aws-amplify/amplify-android/commit/d6f61ccdd15b537d2aca3584f0b65026727e22cb", "message": "Add implementation for sorting", "committedDate": "2020-08-20T18:17:52Z", "type": "commit"}, {"oid": "d6f61ccdd15b537d2aca3584f0b65026727e22cb", "url": "https://github.com/aws-amplify/amplify-android/commit/d6f61ccdd15b537d2aca3584f0b65026727e22cb", "message": "Add implementation for sorting", "committedDate": "2020-08-20T18:17:52Z", "type": "forcePushed"}, {"oid": "bb0a6894b03e9e4bd3434853bb5c9894149d5d20", "url": "https://github.com/aws-amplify/amplify-android/commit/bb0a6894b03e9e4bd3434853bb5c9894149d5d20", "message": "Address PR feedback", "committedDate": "2020-08-20T19:42:53Z", "type": "commit"}, {"oid": "6b48cce7e8fa7010f0984fd0d440b2e1ac62b3f0", "url": "https://github.com/aws-amplify/amplify-android/commit/6b48cce7e8fa7010f0984fd0d440b2e1ac62b3f0", "message": "Merge branch 'main' into rm/sort", "committedDate": "2020-08-20T20:56:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxNTU2NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/633#discussion_r477515564", "bodyText": "Nit: Instead of \"columnName of the column\" it may be more clear to say \"name of the column\"", "author": "eeatonaws", "createdAt": "2020-08-26T18:52:18Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/storage/sqlite/adapter/SQLiteTable.java", "diffHunk": "@@ -173,6 +175,22 @@ public String getPrimaryKeyColumnName() {\n         return Immutable.of(foreignKeys);\n     }\n \n+    /**\n+     * Returns the SQLiteColumn for the provided columnName.\n+     * @param columnName columnName of the column", "originalCommit": "6b48cce7e8fa7010f0984fd0d440b2e1ac62b3f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxNjU1Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/633#discussion_r477516556", "bodyText": "Since the return value of this method will not be null, you could annotate this method with @NonNull.", "author": "eeatonaws", "createdAt": "2020-08-26T18:54:09Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/storage/sqlite/SqlKeyword.java", "diffHunk": "@@ -203,6 +223,21 @@ public static SqlKeyword fromQueryPredicateGroup(@NonNull QueryPredicateGroup.Ty\n         return sqlKeyword;\n     }\n \n+    /**\n+     * Retrieve the SQL specific keyword for the query sort order type.\n+     * @param sortOrder the query sort order type\n+     * @return the SQL specific keyword\n+     */", "originalCommit": "6b48cce7e8fa7010f0984fd0d440b2e1ac62b3f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1NzQxNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/633#discussion_r477557417", "bodyText": "Should the first \"@\" in @{@link QueryField#ascending()} be removed?", "author": "eeatonaws", "createdAt": "2020-08-26T20:04:09Z", "path": "core/src/main/java/com/amplifyframework/core/model/query/QuerySortBy.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.core.model.query;\n+\n+import androidx.annotation.NonNull;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.core.model.query.predicate.QueryField;\n+import com.amplifyframework.datastore.DataStoreCategoryBehavior;\n+\n+import java.util.Objects;\n+\n+/**\n+ * A data structure representing a model field and an order to sort by (ascending or descending), used to specify the\n+ * order of results from {@link DataStoreCategoryBehavior#query(Class, QueryOptions, Consumer, Consumer)}.\n+ *\n+ * The preferred way to create a QuerySortBy is with the @{@link QueryField#ascending()} and", "originalCommit": "6b48cce7e8fa7010f0984fd0d440b2e1ac62b3f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3NjkyMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/633#discussion_r477576921", "bodyText": "Good catch!", "author": "richardmcclellan", "createdAt": "2020-08-26T20:42:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1NzQxNw=="}], "type": "inlineReview"}, {"oid": "3a727dce0feb3679d9033ba71e511070eb8b1b90", "url": "https://github.com/aws-amplify/amplify-android/commit/3a727dce0feb3679d9033ba71e511070eb8b1b90", "message": "Make QueryOptions.sorted override the entire list of QuerySortBys instead of appending to the existing one", "committedDate": "2020-08-26T20:38:43Z", "type": "commit"}, {"oid": "a98e63b866f71d2119e51ea59f384f20ac279dce", "url": "https://github.com/aws-amplify/amplify-android/commit/a98e63b866f71d2119e51ea59f384f20ac279dce", "message": "PR feedback", "committedDate": "2020-08-26T20:42:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3OTQ0OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/633#discussion_r477579448", "bodyText": "Nit: \"the\" is repeated twice in this comment (\"with the the given\")", "author": "eeatonaws", "createdAt": "2020-08-26T20:46:52Z", "path": "core/src/main/java/com/amplifyframework/core/model/query/QueryOptions.java", "diffHunk": "@@ -56,8 +73,17 @@\n      */\n     @NonNull\n     public QueryOptions paginated(@NonNull final QueryPaginationInput paginationInput) {\n-        this.paginationInput = paginationInput;\n-        return this;\n+        return new QueryOptions(queryPredicate, paginationInput, sortBy);\n+    }\n+\n+    /**\n+     * Returns an immutable copy of the current query options with the the given {@code sortBy} arguments.", "originalCommit": "a98e63b866f71d2119e51ea59f384f20ac279dce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU4MDA1MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/633#discussion_r477580051", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return new QueryOptions(queryPredicate, paginationInput, Arrays.asList(querySortBy));\n          \n          \n            \n                    return new QueryOptions(queryPredicate, paginationInput, Arrays.asList(Objects.requireNonNull(querySortBy)));", "author": "eeatonaws", "createdAt": "2020-08-26T20:48:07Z", "path": "core/src/main/java/com/amplifyframework/core/model/query/QueryOptions.java", "diffHunk": "@@ -56,8 +73,17 @@\n      */\n     @NonNull\n     public QueryOptions paginated(@NonNull final QueryPaginationInput paginationInput) {\n-        this.paginationInput = paginationInput;\n-        return this;\n+        return new QueryOptions(queryPredicate, paginationInput, sortBy);\n+    }\n+\n+    /**\n+     * Returns an immutable copy of the current query options with the the given {@code sortBy} arguments.\n+     *\n+     * @param querySortBy sorting information.\n+     * @return current options with an updated {@code sortBy}.\n+     */\n+    public QueryOptions sorted(@NonNull final QuerySortBy... querySortBy) {\n+        return new QueryOptions(queryPredicate, paginationInput, Arrays.asList(querySortBy));", "originalCommit": "a98e63b866f71d2119e51ea59f384f20ac279dce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6f8568339f5098fc849e1c8e7c78c8ba7548d9b4", "url": "https://github.com/aws-amplify/amplify-android/commit/6f8568339f5098fc849e1c8e7c78c8ba7548d9b4", "message": "Remove extra the", "committedDate": "2020-08-26T20:50:15Z", "type": "commit"}, {"oid": "702f52efddedb9a63a20005be9ebfe5f5b8db3d9", "url": "https://github.com/aws-amplify/amplify-android/commit/702f52efddedb9a63a20005be9ebfe5f5b8db3d9", "message": "Update core/src/main/java/com/amplifyframework/core/model/query/QueryOptions.java\n\nCo-authored-by: eeatonaws <67125657+eeatonaws@users.noreply.github.com>", "committedDate": "2020-08-26T20:51:13Z", "type": "commit"}, {"oid": "d2b1211b01c5ea2ae5112763157f3cd4924e0718", "url": "https://github.com/aws-amplify/amplify-android/commit/d2b1211b01c5ea2ae5112763157f3cd4924e0718", "message": "More requireNotNull", "committedDate": "2020-08-26T20:54:05Z", "type": "commit"}]}