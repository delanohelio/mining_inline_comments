{"pr_number": 608, "pr_title": "ci: improve integration test retry logic", "pr_createdAt": "2020-06-26T16:28:34Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/608", "timeline": [{"oid": "20b72fd22f6abb5172a88b1b4352ccb03eb365db", "url": "https://github.com/aws-amplify/amplify-android/commit/20b72fd22f6abb5172a88b1b4352ccb03eb365db", "message": "Retry integration tests, one module at a time", "committedDate": "2020-06-26T01:02:30Z", "type": "commit"}, {"oid": "a651c0e48bb6fb482d89ef923b27470f90fe8a55", "url": "https://github.com/aws-amplify/amplify-android/commit/a651c0e48bb6fb482d89ef923b27470f90fe8a55", "message": "Add ./", "committedDate": "2020-06-26T01:53:09Z", "type": "commit"}, {"oid": "2a92bfda9d5bea72d81e06fde65adaaa24bfa382", "url": "https://github.com/aws-amplify/amplify-android/commit/2a92bfda9d5bea72d81e06fde65adaaa24bfa382", "message": "Debugging", "committedDate": "2020-06-26T02:23:37Z", "type": "commit"}, {"oid": "40057b68183cbb9a5fcb968fd17f3ff5a6e683e5", "url": "https://github.com/aws-amplify/amplify-android/commit/40057b68183cbb9a5fcb968fd17f3ff5a6e683e5", "message": "fix", "committedDate": "2020-06-26T02:37:29Z", "type": "commit"}, {"oid": "1bfe40a7802bef0c8e30d4e283b80748ed48861b", "url": "https://github.com/aws-amplify/amplify-android/commit/1bfe40a7802bef0c8e30d4e283b80748ed48861b", "message": "Remove debug code", "committedDate": "2020-06-26T02:47:44Z", "type": "commit"}, {"oid": "2ae191578423da4a9ce9fba09c7de3a945a2ba61", "url": "https://github.com/aws-amplify/amplify-android/commit/2ae191578423da4a9ce9fba09c7de3a945a2ba61", "message": "Add logging", "committedDate": "2020-06-26T03:03:14Z", "type": "commit"}, {"oid": "c9d5562f15fc465656bd58d9d076ba06893081bb", "url": "https://github.com/aws-amplify/amplify-android/commit/c9d5562f15fc465656bd58d9d076ba06893081bb", "message": "more logging", "committedDate": "2020-06-26T03:09:56Z", "type": "commit"}, {"oid": "9be069f4b1bffa6a052aabfacc4e58d13cbb4d2a", "url": "https://github.com/aws-amplify/amplify-android/commit/9be069f4b1bffa6a052aabfacc4e58d13cbb4d2a", "message": "Fix indents", "committedDate": "2020-06-26T03:32:01Z", "type": "commit"}, {"oid": "3b69a21cd1c3354122417d9db05000195732d0d9", "url": "https://github.com/aws-amplify/amplify-android/commit/3b69a21cd1c3354122417d9db05000195732d0d9", "message": "printf instead of echo so that \\n works", "committedDate": "2020-06-26T06:22:32Z", "type": "commit"}, {"oid": "80faab09b7af58694f08398cad1173c8a55bed6d", "url": "https://github.com/aws-amplify/amplify-android/commit/80faab09b7af58694f08398cad1173c8a55bed6d", "message": "Update expected hash as codecov.io/bash script appears to have changed", "committedDate": "2020-06-26T06:30:19Z", "type": "commit"}, {"oid": "e7a4716f7cdbf5891098c40e7cc54e8431571852", "url": "https://github.com/aws-amplify/amplify-android/commit/e7a4716f7cdbf5891098c40e7cc54e8431571852", "message": "Add our own timeout, shorter than the circleci timeout, so we can retry", "committedDate": "2020-06-26T07:48:51Z", "type": "commit"}, {"oid": "38542db090899606837f77bb868e210488cf51ef", "url": "https://github.com/aws-amplify/amplify-android/commit/38542db090899606837f77bb868e210488cf51ef", "message": "Revert \"Add our own timeout, shorter than the circleci timeout, so we can retry\"\n\nThis reverts commit e7a4716f7cdbf5891098c40e7cc54e8431571852.", "committedDate": "2020-06-26T15:05:06Z", "type": "commit"}, {"oid": "0165d7d7e69429e29f3b4ab76b30721ddbfeb960", "url": "https://github.com/aws-amplify/amplify-android/commit/0165d7d7e69429e29f3b4ab76b30721ddbfeb960", "message": "circle test 1", "committedDate": "2020-06-26T15:16:34Z", "type": "commit"}, {"oid": "0cdb124c0d61f5892dba073d67278bacb1b6c146", "url": "https://github.com/aws-amplify/amplify-android/commit/0cdb124c0d61f5892dba073d67278bacb1b6c146", "message": "circle test 2", "committedDate": "2020-06-26T15:16:45Z", "type": "commit"}, {"oid": "e1380b8631faa836b150056bd0c719bd947b8786", "url": "https://github.com/aws-amplify/amplify-android/commit/e1380b8631faa836b150056bd0c719bd947b8786", "message": "circle test 3", "committedDate": "2020-06-26T15:16:54Z", "type": "commit"}, {"oid": "ed29dd406d4687998347fa1496ddcf6dbc241bcc", "url": "https://github.com/aws-amplify/amplify-android/commit/ed29dd406d4687998347fa1496ddcf6dbc241bcc", "message": "Fix logging", "committedDate": "2020-06-26T16:48:59Z", "type": "commit"}, {"oid": "964c7a5f489296eef0aa42431d708d19f0fae616", "url": "https://github.com/aws-amplify/amplify-android/commit/964c7a5f489296eef0aa42431d708d19f0fae616", "message": "logging", "committedDate": "2020-06-26T17:35:31Z", "type": "commit"}, {"oid": "aa84929e9565513f82d60d0c437fa154dd766201", "url": "https://github.com/aws-amplify/amplify-android/commit/aa84929e9565513f82d60d0c437fa154dd766201", "message": "logging and comments", "committedDate": "2020-06-26T17:39:50Z", "type": "commit"}, {"oid": "2cbd3efd0a9c6b6a2a7659b50ba0fd52e6c58b43", "url": "https://github.com/aws-amplify/amplify-android/commit/2cbd3efd0a9c6b6a2a7659b50ba0fd52e6c58b43", "message": "Intentionally make a test fail to confirm circle task also fails", "committedDate": "2020-06-26T18:33:20Z", "type": "commit"}, {"oid": "9f2d18d8d5a01482cc83498a8d2d52c612e50543", "url": "https://github.com/aws-amplify/amplify-android/commit/9f2d18d8d5a01482cc83498a8d2d52c612e50543", "message": "Revert \"Intentionally make a test fail to confirm circle task also fails\"\n\nThis reverts commit 2cbd3efd0a9c6b6a2a7659b50ba0fd52e6c58b43.", "committedDate": "2020-06-26T18:33:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM5MjQ4OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/608#discussion_r446392489", "bodyText": "So this might change more than we expected. Should we vendor this? What's the right (and secure) way? @jamesonwilliams", "author": "jpignata", "createdAt": "2020-06-26T20:22:18Z", "path": ".circleci/config.yml", "diffHunk": "@@ -118,15 +118,15 @@ jobs:\n             .circleci/copy-configs\n       - run:\n           name: Run integration test\n-          command: .circleci/retry.sh 3 ./gradlew connectedDebugAndroidTest --no-daemon\n+          command: .circleci/run-integration-tests.sh\n       - run:\n           name: Store coverage data\n           command: |\n               .circleci/retry.sh 3 ./gradlew jacocoFullReport --no-daemon\n               tmp_file=\"$(mktemp)\"\n               curl -s https://codecov.io/bash > \"$tmp_file\"\n               actual_hash=\"$(cat $tmp_file | cksum | cut -f 1 -d\\ )\"\n-              expected_hash='2175291078'\n+              expected_hash='261829867'", "originalCommit": "9f2d18d8d5a01482cc83498a8d2d52c612e50543", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0NTU4Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/608#discussion_r446445582", "bodyText": "Yeah, I had that thought too.  I went ahead and copied it into our repo for now.  The downside is it will probably require manual updates, but not sure of another option that is safe.", "author": "richardmcclellan", "createdAt": "2020-06-26T23:03:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM5MjQ4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ1NTM4Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/608#discussion_r446455382", "bodyText": "I made a separate PR for this: #609", "author": "richardmcclellan", "createdAt": "2020-06-26T23:55:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM5MjQ4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM5MzUwNg==", "url": "https://github.com/aws-amplify/amplify-android/pull/608#discussion_r446393506", "bodyText": "I know this wasn't your code, but I think you need parentheses here. See shellcheck's wiki. Might be a good thing to run on shell scripts we modify.", "author": "jpignata", "createdAt": "2020-06-26T20:24:52Z", "path": ".circleci/retry.sh", "diffHunk": "@@ -1,23 +1,25 @@\n #!/bin/bash\n # Usage: retry.sh <max_tries> <command to run>\n \n+tag=\"RETRY\"\n readonly max_tries=$1\n readonly command=\"${@: 2}\"", "originalCommit": "9f2d18d8d5a01482cc83498a8d2d52c612e50543", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0MTIwOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/608#discussion_r446441208", "bodyText": "It is my code actually, I'm just not an expert with bash scripts :).  Thanks for sharing the shellcheck tool - I just used it to verify the problem and confirm a fix!", "author": "richardmcclellan", "createdAt": "2020-06-26T22:44:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM5MzUwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM5Mzk1Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/608#discussion_r446393957", "bodyText": "Nit: missing double quotes on the variable", "author": "jpignata", "createdAt": "2020-06-26T20:25:59Z", "path": ".circleci/run-integration-tests.sh", "diffHunk": "@@ -0,0 +1,22 @@\n+#!/bin/bash\n+\n+tag=\"RUN_INTEGRATION_TESTS\"\n+return_code=0\n+\n+# List all available gradle tasks, grep for the integration test tasks, and then use cut to strip the task description\n+# and just return the name of the task, one for each module (e.g. aws-api:connectedDebugAndroidTest)\n+tasks=($(./gradlew tasks --all | grep connectedDebugAndroidTest | cut -d \" \" -f 1))\n+\n+# Run the integration tests for each module.  Make up to 3 attempts on each module before failing.\n+for task in \"${tasks[@]}\"; do\n+  echo \"$tag: Starting $task\"\n+  .circleci/retry.sh 3 ./gradlew $task --no-daemon", "originalCommit": "9f2d18d8d5a01482cc83498a8d2d52c612e50543", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0MTA0MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/608#discussion_r446441040", "bodyText": "Fixed!", "author": "richardmcclellan", "createdAt": "2020-06-26T22:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM5Mzk1Nw=="}], "type": "inlineReview"}, {"oid": "ba9931a4c12a1e998461011907144ccfb74844a6", "url": "https://github.com/aws-amplify/amplify-android/commit/ba9931a4c12a1e998461011907144ccfb74844a6", "message": "Fix shellcheck issues", "committedDate": "2020-06-26T22:24:15Z", "type": "commit"}, {"oid": "ba9931a4c12a1e998461011907144ccfb74844a6", "url": "https://github.com/aws-amplify/amplify-android/commit/ba9931a4c12a1e998461011907144ccfb74844a6", "message": "Fix shellcheck issues", "committedDate": "2020-06-26T22:24:15Z", "type": "forcePushed"}]}