{"pr_number": 355, "pr_title": "[aws-storage-s3] Test against StorageCategory not Amplify", "pr_createdAt": "2020-04-07T04:46:04Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/355", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "deec96fe64c90e0ae8fb5d372be7d8e17ad623b3", "url": "https://github.com/aws-amplify/amplify-android/commit/deec96fe64c90e0ae8fb5d372be7d8e17ad623b3", "message": "[aws-storage-s3] Test against StorageCategory not Amplify\n\nAmplify is a process-wide singleton, that can be configured only once.\nIt maintains state until the process dies. This is true of its reference\nto the Amplify.Storage category (and its pluings) as well.\n\nThis is a brittle way to test the functionality of storage. Better is to\ncreate fresh instances of the StorageCategory, and run assertions\nagainst them.", "committedDate": "2020-04-07T04:53:26Z", "type": "commit"}, {"oid": "deec96fe64c90e0ae8fb5d372be7d8e17ad623b3", "url": "https://github.com/aws-amplify/amplify-android/commit/deec96fe64c90e0ae8fb5d372be7d8e17ad623b3", "message": "[aws-storage-s3] Test against StorageCategory not Amplify\n\nAmplify is a process-wide singleton, that can be configured only once.\nIt maintains state until the process dies. This is true of its reference\nto the Amplify.Storage category (and its pluings) as well.\n\nThis is a brittle way to test the functionality of storage. Better is to\ncreate fresh instances of the StorageCategory, and run assertions\nagainst them.", "committedDate": "2020-04-07T04:53:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyODc3Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/355#discussion_r404628777", "bodyText": "nit: Not sure if it's a convention that is documented somewhere, but I think context is always the first argument if it is required. It already bothers me that our configure methods break this pattern haha.", "author": "raphkim", "createdAt": "2020-04-07T08:26:44Z", "path": "aws-storage-s3/src/androidTest/java/com/amplifyframework/storage/s3/TestStorageCategory.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.storage.s3;\n+\n+import android.content.Context;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.RawRes;\n+\n+import com.amplifyframework.AmplifyException;\n+import com.amplifyframework.core.AmplifyConfiguration;\n+import com.amplifyframework.core.category.CategoryConfiguration;\n+import com.amplifyframework.core.category.CategoryType;\n+import com.amplifyframework.storage.StorageCategory;\n+\n+import java.util.Objects;\n+\n+/**\n+ * Factory for creating {@link StorageCategory} instance suitable for test.\n+ */\n+final class TestStorageCategory {\n+    private TestStorageCategory() {}\n+\n+    /**\n+     * Creates an instance of {@link StorageCategory} using the provided configuration resource.\n+     * @param resourceId Android resource ID for a configuration file\n+     * @param context Android Context\n+     * @return A StorageCategory instance using the provided configuration\n+     */\n+    static StorageCategory create(@RawRes int resourceId, @NonNull Context context) {", "originalCommit": "deec96fe64c90e0ae8fb5d372be7d8e17ad623b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgzNTQ3OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/355#discussion_r404835478", "bodyText": "Hmm, true. I've never seen that written anywhere, but it \"feels\" true enough... I'll update all locations in the PR.", "author": "jamesonwilliams", "createdAt": "2020-04-07T14:05:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyODc3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzMDMzMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/355#discussion_r404630332", "bodyText": "Hmm, I guess having smaller default value is fine since SynchronousStorage does allow timeout override for especially long operations (e.g. large file upload)", "author": "raphkim", "createdAt": "2020-04-07T08:29:06Z", "path": "testutils/src/main/java/com/amplifyframework/testutils/sync/SynchronousStorage.java", "diffHunk": "@@ -38,25 +40,33 @@\n  * code, where we want to make a series of sequential assertions after\n  * performing various operations.\n  */\n-@SuppressWarnings(\"unused\")\n public final class SynchronousStorage {\n-    // 5 seconds seemed to be insufficient to reliably cover both initial auth calls + storage network ops\n-    private static final long STORAGE_OPERATION_TIMEOUT_MS = TimeUnit.SECONDS.toMillis(10);\n+    private static final long STORAGE_OPERATION_TIMEOUT_MS = TimeUnit.SECONDS.toMillis(5);", "originalCommit": "deec96fe64c90e0ae8fb5d372be7d8e17ad623b3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzMTY0Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/355#discussion_r404631642", "bodyText": "nit: context as first parameter?", "author": "raphkim", "createdAt": "2020-04-07T08:31:13Z", "path": "aws-storage-s3/src/androidTest/java/com/amplifyframework/storage/s3/UserCredentials.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.storage.s3;\n+\n+import android.content.Context;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.RawRes;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.testutils.Resources;\n+import com.amplifyframework.util.Immutable;\n+\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+final class UserCredentials implements Iterable<UserCredentials.Credential> {\n+    private static final String CREDENTIALS_RESOURCE_NAME = \"credentials\";\n+    private final List<Credential> credentials;\n+\n+    private UserCredentials(List<Credential> credentials) {\n+        this.credentials = credentials;\n+    }\n+\n+    static UserCredentials create(@NonNull IdentityIdSource identityIdSource, @NonNull Context context) {", "originalCommit": "deec96fe64c90e0ae8fb5d372be7d8e17ad623b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgzNjg1Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/355#discussion_r404836856", "bodyText": "done", "author": "jamesonwilliams", "createdAt": "2020-04-07T14:07:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzMTY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzMjQxNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/355#discussion_r404632417", "bodyText": "this is clean, and likely reusable for other categories like API :)\nAs far as I know, we lack tests for testing schemas that contain @auth", "author": "raphkim", "createdAt": "2020-04-07T08:32:31Z", "path": "aws-storage-s3/src/androidTest/java/com/amplifyframework/storage/s3/UserCredentials.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.storage.s3;\n+\n+import android.content.Context;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.RawRes;\n+import androidx.core.util.ObjectsCompat;\n+\n+import com.amplifyframework.testutils.Resources;\n+import com.amplifyframework.util.Immutable;\n+\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+final class UserCredentials implements Iterable<UserCredentials.Credential> {", "originalCommit": "deec96fe64c90e0ae8fb5d372be7d8e17ad623b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgzNjc4Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/355#discussion_r404836783", "bodyText": "Thanks! Yea, it'd be cool to re-use this in the other modules.\nI started to move it into testutils. But I think right now the credentials.json is in the storage tests bucket in S3. Maybe we could move the two things at the same time, later.", "author": "jamesonwilliams", "createdAt": "2020-04-07T14:07:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzMjQxNw=="}], "type": "inlineReview"}, {"oid": "8c34bfc0a87dfaa162f556cd2ec651c8b346bdbd", "url": "https://github.com/aws-amplify/amplify-android/commit/8c34bfc0a87dfaa162f556cd2ec651c8b346bdbd", "message": "Address Raph's PR feedback", "committedDate": "2020-04-07T14:25:50Z", "type": "commit"}, {"oid": "8c34bfc0a87dfaa162f556cd2ec651c8b346bdbd", "url": "https://github.com/aws-amplify/amplify-android/commit/8c34bfc0a87dfaa162f556cd2ec651c8b346bdbd", "message": "Address Raph's PR feedback", "committedDate": "2020-04-07T14:25:50Z", "type": "forcePushed"}]}