{"pr_number": 1033, "pr_title": "fix(aws-datastore): deleting nonexistent model instance no longer fails", "pr_createdAt": "2020-12-09T00:08:34Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/1033", "timeline": [{"oid": "83f81b0588d0214331e79cdd854c038fb4229f56", "url": "https://github.com/aws-amplify/amplify-android/commit/83f81b0588d0214331e79cdd854c038fb4229f56", "message": "no longer fail on attempting to delete nonexistent model", "committedDate": "2020-12-09T00:04:37Z", "type": "commit"}, {"oid": "936037e71df30edeb70863059ff6ee946b08fdcb", "url": "https://github.com/aws-amplify/amplify-android/commit/936037e71df30edeb70863059ff6ee946b08fdcb", "message": "add test", "committedDate": "2020-12-09T00:04:37Z", "type": "commit"}, {"oid": "9fcb0524433352b7b6735ec34e27632192e7202c", "url": "https://github.com/aws-amplify/amplify-android/commit/9fcb0524433352b7b6735ec34e27632192e7202c", "message": "minor whitespace fixup", "committedDate": "2020-12-09T00:08:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkwNTMyMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/1033#discussion_r538905322", "bodyText": "Much better error message here!", "author": "richardmcclellan", "createdAt": "2020-12-09T00:11:44Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/storage/sqlite/SQLiteStorageAdapter.java", "diffHunk": "@@ -499,22 +513,18 @@ public void query(\n                     return;\n                 }\n \n-                DataStoreException problem = null;\n                 synchronized (sqlCommand.getCompiledSqlStatement()) {\n                     final SQLiteStatement compiledSqlStatement = sqlCommand.getCompiledSqlStatement();\n                     compiledSqlStatement.clearBindings();\n                     bindStatementToValues(sqlCommand, null);\n                     // executeUpdateDelete returns the number of rows affected.\n                     final int rowsDeleted = compiledSqlStatement.executeUpdateDelete();\n-                    if (rowsDeleted != 1) {\n-                        problem = new DataStoreException(\n-                            \"Wanted to delete one row, but deleted \" + rowsDeleted + \" rows.\",\n-                            \"This is likely a bug. Please report to AWS.\"\n-                        );\n-                    }\n                     compiledSqlStatement.clearBindings();\n-                    if (problem != null) {\n-                        throw problem;\n+                    if (rowsDeleted == 0) {\n+                        throw new DataStoreException(\n+                            \"Failed to meet condition. Model was not deleted.\",", "originalCommit": "9fcb0524433352b7b6735ec34e27632192e7202c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkwODQwNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/1033#discussion_r538908407", "bodyText": "Two questions here:\nDoes this mean we perform two operations on SQL? A lookup and the a delete? Performance wise that\u2019s probably okay for our delete API. Might have implications for atomicity of the operation.\nSecond more important - should we fire an event on the observe method here? Would the sync engine care about observing this case?", "author": "jamesonwilliams", "createdAt": "2020-12-09T00:19:36Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/storage/sqlite/SQLiteStorageAdapter.java", "diffHunk": "@@ -481,6 +481,20 @@ public void query(\n                 final SQLiteTable sqliteTable = SQLiteTable.fromSchema(modelSchema);\n                 final String primaryKeyName = sqliteTable.getPrimaryKeyColumnName();\n \n+                if (!dataExistsInSQLiteTable(sqliteTable.getName(), primaryKeyName, item.getId())) {", "originalCommit": "9fcb0524433352b7b6735ec34e27632192e7202c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkxNDY4OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/1033#discussion_r538914689", "bodyText": "Does this mean we perform two operations on SQL? A lookup and the a delete?\n\nThis lookup is already performed in save to determine whether item should be created or updated. There hasn't been an issue there so far, so it will be fine.\n\nshould we fire an event on the observe method here?\n\nNo change took place in the database, so I don't see the need for the sync engine to worry about it.", "author": "raphkim", "createdAt": "2020-12-09T00:36:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkwODQwNw=="}], "type": "inlineReview"}]}