{"pr_number": 488, "pr_title": "[aws-api] add pagination", "pr_createdAt": "2020-05-19T19:40:04Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/488", "timeline": [{"oid": "b8cb5d760eeb47fc359e4a97f63344b19ab82340", "url": "https://github.com/aws-amplify/amplify-android/commit/b8cb5d760eeb47fc359e4a97f63344b19ab82340", "message": "Refactor GraphQLResponseFactory into JsonDeserializers", "committedDate": "2020-05-18T22:11:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY1OTU2Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r427659562", "bodyText": "The current Checkstyle likes android and androidx together.", "author": "jamesonwilliams", "createdAt": "2020-05-19T23:37:41Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncGraphQLOperation.java", "diffHunk": "@@ -16,6 +16,7 @@\n package com.amplifyframework.api.aws;\n \n import android.annotation.SuppressLint;\n+", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQxNzE0OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r428417149", "bodyText": "Fixed!", "author": "richardmcclellan", "createdAt": "2020-05-21T02:52:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY1OTU2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MTA0Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r427661046", "bodyText": "Looks reasonable, remember to add equals, hashCode, toString before pushing", "author": "jamesonwilliams", "createdAt": "2020-05-19T23:42:38Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncPage.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.amplifyframework.api.aws;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.GraphQLResponse;\n+import com.amplifyframework.api.graphql.Page;\n+\n+final class AppSyncPage<M> extends Page<M> {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQxNzEwMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r428417102", "bodyText": "Added in latest commit!", "author": "richardmcclellan", "createdAt": "2020-05-21T02:52:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MTA0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MTc4Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r427661782", "bodyText": "I guess this will mutate the existing request. It'd be better to return a new, immutable copy.\nTo illustate, consider what happens when:\nGraphQLRequest request = buildOne();\nrequest.getVaraiables() // state A \nnew AppSyncPage(response, request, token).getRequestForNextPage();\nrequest.getVariables(); // state B.", "author": "jamesonwilliams", "createdAt": "2020-05-19T23:44:54Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncPage.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.amplifyframework.api.aws;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.GraphQLResponse;\n+import com.amplifyframework.api.graphql.Page;\n+\n+final class AppSyncPage<M> extends Page<M> {\n+    private final String NEXT_TOKEN_KEY = \"nextToken\";\n+\n+    private GraphQLRequest<Page<M>> request;\n+    private String nextToken;\n+\n+    public AppSyncPage(@NonNull GraphQLResponse<Iterable<M>> response,\n+                       @NonNull GraphQLRequest<Page<M>> request,\n+                       String nextToken) {\n+        super(response);\n+        this.request = request;\n+        this.nextToken = nextToken;\n+    }\n+\n+    @Override\n+    public boolean hasNextPage() {\n+        return nextToken != null;\n+    }\n+\n+    @Override\n+    public GraphQLRequest<Page<M>> getRequestForNextPage() {\n+        this.request.addVariable(NEXT_TOKEN_KEY, nextToken);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ1MDAzNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r428450037", "bodyText": "I added a GraphQLRequest copy constructor, and am returning a copy.  The value returned is still NOT immutable though, because GraphQLRequest has public methods that support some mutation (e.g. putVariable, addFragment)\nI think that @drochetti might be refactoring GraphQLRequest right now anyway as part of making GraphQLRequest builder/helpers, so we should revisit this after that work is done.", "author": "richardmcclellan", "createdAt": "2020-05-21T05:20:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MTc4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MjIyMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r427662223", "bodyText": "Ah, I guess this thing here, the listTodos and under. This is the \"page\" right?", "author": "jamesonwilliams", "createdAt": "2020-05-19T23:46:05Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/AppSyncPageDeserializer.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.amplifyframework.api.aws;\n+\n+import com.amplifyframework.api.graphql.GraphQLRequest;\n+import com.amplifyframework.api.graphql.GraphQLResponse;\n+import com.amplifyframework.api.graphql.Page;\n+import com.google.gson.JsonDeserializationContext;\n+import com.google.gson.JsonDeserializer;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParseException;\n+import com.google.gson.reflect.TypeToken;\n+\n+import java.lang.reflect.ParameterizedType;\n+import java.lang.reflect.Type;\n+\n+/**\n+ * Takes an input such as the following and deserializes to an AppSyncPage\n+ * {\n+ *   \"data\": {\n+ *     \"listTodos\": {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQxNzkxMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r428417912", "bodyText": "This actually was correct based on the design I had implemented yesterday.  I've updated the implementation to the design we discussed last night, which removes the top two levels. (and I have updated this comment).", "author": "richardmcclellan", "createdAt": "2020-05-21T02:55:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MjIyMw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM1MjUyMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r428352523", "bodyText": "I'm open to suggestions on other names for this class.  We actually already have a Page object defined in core, which is used for local pagination via DataStore, so it's kinda confusing to have this one with the same name.", "author": "richardmcclellan", "createdAt": "2020-05-20T22:53:26Z", "path": "core/src/main/java/com/amplifyframework/api/graphql/Page.java", "diffHunk": "@@ -0,0 +1,9 @@\n+package com.amplifyframework.api.graphql;\n+\n+public abstract class Page<M> {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg3NTA1Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r428875057", "bodyText": "Does PaginatedResult reflect the intent? (or something along those lines)", "author": "drochetti", "createdAt": "2020-05-21T19:47:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM1MjUyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkwNDY0NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r428904644", "bodyText": "I like that!  I'll update it.", "author": "richardmcclellan", "createdAt": "2020-05-21T20:45:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM1MjUyMw=="}], "type": "inlineReview"}, {"oid": "d6fba48dbc1cee1568bd1c953c290978ffd0da5a", "url": "https://github.com/aws-amplify/amplify-android/commit/d6fba48dbc1cee1568bd1c953c290978ffd0da5a", "message": "Refactor API so that the response object type can be any provided Type and add API pagination support", "committedDate": "2020-05-20T22:54:15Z", "type": "forcePushed"}, {"oid": "d6fba48dbc1cee1568bd1c953c290978ffd0da5a", "url": "https://github.com/aws-amplify/amplify-android/commit/d6fba48dbc1cee1568bd1c953c290978ffd0da5a", "message": "Refactor API so that the response object type can be any provided Type and add API pagination support", "committedDate": "2020-05-20T22:54:15Z", "type": "commit"}, {"oid": "8a4d00541d8afc6dc393960349d802eee063bf1b", "url": "https://github.com/aws-amplify/amplify-android/commit/8a4d00541d8afc6dc393960349d802eee063bf1b", "message": "Checkstyle issues", "committedDate": "2020-05-21T02:06:26Z", "type": "commit"}, {"oid": "7cd28c7464cb0c04b5828c6d98873c732cdae4ca", "url": "https://github.com/aws-amplify/amplify-android/commit/7cd28c7464cb0c04b5828c6d98873c732cdae4ca", "message": "Merge from master", "committedDate": "2020-05-21T02:13:23Z", "type": "commit"}, {"oid": "c0fa1f311dcb9fc909ab1320b3fde8ac67cf1682", "url": "https://github.com/aws-amplify/amplify-android/commit/c0fa1f311dcb9fc909ab1320b3fde8ac67cf1682", "message": "Add unit test", "committedDate": "2020-05-21T15:05:47Z", "type": "commit"}, {"oid": "ff2bbd95335b0bff0597949ca70e22a6fbf13ca2", "url": "https://github.com/aws-amplify/amplify-android/commit/ff2bbd95335b0bff0597949ca70e22a6fbf13ca2", "message": "Create TypeMaker utility class to wrap creating of Types so we arent leaking Gson TypeToken all over the codebase", "committedDate": "2020-05-21T15:55:33Z", "type": "commit"}, {"oid": "578c6b1a2f234119e10aed86b181270c22883796", "url": "https://github.com/aws-amplify/amplify-android/commit/578c6b1a2f234119e10aed86b181270c22883796", "message": "Allow TypeMaker.getParameterizedType to accept multiple args", "committedDate": "2020-05-21T16:46:06Z", "type": "commit"}, {"oid": "269ed552f41fa15ca746d6048cc98152e93fae8a", "url": "https://github.com/aws-amplify/amplify-android/commit/269ed552f41fa15ca746d6048cc98152e93fae8a", "message": "Rename Page to PaginatedResult so it is named the same thing as the Page for local datastore pagination", "committedDate": "2020-05-21T22:50:32Z", "type": "commit"}, {"oid": "d5c8cd1b6901f24d57ba48849c33fa8b7ade5aa7", "url": "https://github.com/aws-amplify/amplify-android/commit/d5c8cd1b6901f24d57ba48849c33fa8b7ade5aa7", "message": "Fix checkstyle", "committedDate": "2020-05-21T23:02:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2NzQ3Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r427667473", "bodyText": "Whoa", "author": "jamesonwilliams", "createdAt": "2020-05-20T00:02:12Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/GsonFactory.java", "diffHunk": "@@ -60,7 +59,10 @@ private static void withDeserializers(GsonBuilder builder) {\n             .registerTypeAdapter(AWSTime.class, new TemporalDeserializers.AWSTimeDeserializer())\n             .registerTypeAdapter(AWSTimestamp.class, new TemporalDeserializers.AWSTimestampDeserializer())\n             .registerTypeAdapter(AWSDateTime.class, new TemporalDeserializers.AWSDateTimeDeserializer())\n-            .registerTypeAdapter(GraphQLResponse.Error.class, new GsonErrorDeserializer());\n+            .registerTypeAdapter(GraphQLResponse.class, new GraphQLResponseDeserializer())\n+            .registerTypeAdapter(GraphQLResponse.Error.class, new GsonErrorDeserializer())\n+            .registerTypeHierarchyAdapter(Iterable.class, new IterableDeserializer())", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5Mjk5MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/488#discussion_r428992990", "bodyText": "Yess!!! Love it :-D", "author": "jamesonwilliams", "createdAt": "2020-05-22T01:07:57Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/GsonErrorDeserializer.java", "diffHunk": "@@ -66,7 +65,7 @@\n                     message = context.deserialize(value, String.class);\n                     break;\n                 case LOCATIONS_KEY:\n-                    Type locationsType = new TypeToken<List<GraphQLLocation>>() {}.getType();\n+                    Type locationsType = TypeMaker.getParameterizedType(List.class, GraphQLLocation.class);", "originalCommit": "d5c8cd1b6901f24d57ba48849c33fa8b7ade5aa7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}