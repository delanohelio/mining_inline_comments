{"pr_number": 108, "pr_title": "ENH: throws Exception in KNNVectorFieldMapper.parse API when circuit breaker trips", "pr_createdAt": "2020-05-10T22:22:20Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108", "timeline": [{"oid": "05a884a5f55608f43a2aea8c405d7f5637c22432", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/05a884a5f55608f43a2aea8c405d7f5637c22432", "message": "ENH: Throws exception in KNNVectorFieldMapper.parse API when circuit trips and add IT", "committedDate": "2020-05-10T22:18:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3NTg3OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#discussion_r423375878", "bodyText": "Should there also be a cluster setting like \"CircuitBreakerOnTripEnableWriteBlock\" so that users have the ability to opt out of the write block?", "author": "jmazanec15", "createdAt": "2020-05-11T23:26:18Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorFieldMapper.java", "diffHunk": "@@ -242,6 +242,10 @@ public void parse(ParseContext context) throws IOException {\n                                                     \"update knn.plugin.enabled setting to true\");\n         }\n \n+        if (KNNSettings.isCircuitBreakerTriggered()) {", "originalCommit": "05a884a5f55608f43a2aea8c405d7f5637c22432", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM4NjAxNg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#discussion_r423386016", "bodyText": "IMO it would keep their performance at risk. Better to put write blocks on knn index and provide alert. They still have option to take risk by increasing knn.memory.circuit_breaker.limit percentage to a higher value", "author": "vamshin", "createdAt": "2020-05-11T23:58:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3NTg3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI4OTE3Mg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#discussion_r425289172", "bodyText": "That makes sense.", "author": "jmazanec15", "createdAt": "2020-05-14T16:55:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3NTg3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3NDUxMQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#discussion_r423474511", "bodyText": "can we change message on the following lines \"Indexing knn vector fields is rejected as circuit breaker triggered. Check _opendistro/_knn/stats for detailed state\"", "author": "vamshin", "createdAt": "2020-05-12T05:43:47Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorFieldMapper.java", "diffHunk": "@@ -242,6 +242,10 @@ public void parse(ParseContext context) throws IOException {\n                                                     \"update knn.plugin.enabled setting to true\");\n         }\n \n+        if (KNNSettings.isCircuitBreakerTriggered()) {\n+            throw new IllegalStateException(\"Cannot update KNN vector field when circuit breaker is triggered.\");", "originalCommit": "05a884a5f55608f43a2aea8c405d7f5637c22432", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI1MzY4OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#discussion_r425253688", "bodyText": "Sure.", "author": "chenqi0805", "createdAt": "2020-05-14T16:04:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3NDUxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3NTAwNw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#discussion_r423475007", "bodyText": "As an extension to this same test case, can we unset knn.circuit_breaker.triggered flag and assert new doc could be added? Same with below test case.", "author": "vamshin", "createdAt": "2020-05-12T05:45:26Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/index/KNNESIT.java", "diffHunk": "@@ -35,6 +35,20 @@ public void testAddKNNDoc() throws Exception {\n         addKnnDoc(INDEX_NAME, \"1\", FIELD_NAME, vector);\n     }\n \n+    /**\n+     * Block adding new docs to KNN index when circuit breaker trips\n+     */\n+    public void testAddKNNDocBlockedWhenCbTrips() throws Exception {\n+        createKnnIndex(INDEX_NAME, createKnnIndexMapping(FIELD_NAME, 2));\n+        updateClusterSettings(\"knn.circuit_breaker.triggered\", \"true\");\n+\n+        Float[] vector  = {6.0f, 6.0f};\n+        ResponseException ex = expectThrows(\n+                ResponseException.class, () -> addKnnDoc(INDEX_NAME, \"1\", FIELD_NAME, vector));\n+        assertThat(EntityUtils.toString(ex.getResponse().getEntity()),\n+                containsString(\"Cannot update KNN vector field when circuit breaker is triggered.\"));\n+    }", "originalCommit": "05a884a5f55608f43a2aea8c405d7f5637c22432", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI1Mzg5Ng==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#discussion_r425253896", "bodyText": "Sure.", "author": "chenqi0805", "createdAt": "2020-05-14T16:05:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3NTAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk4MjAyNw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#discussion_r425982027", "bodyText": "Sorry I should have mentioned this with my last comment. Can we also check there is no impact to searches when Circuit breaker triggers.  You can add a new test or change existing test\nSteps\n\nset CB triggered false\nAdd 4 docs\nperform knn search (should be able to get the docs)\nset CB triggered true\nAdd 5th doc (should be rejected)\nperform knn search (should be able to get the docs)\nse CB triggered false\nAdd 5th doc (should be accpeted)\nperform knn search (should be able to get the docs)", "author": "vamshin", "createdAt": "2020-05-15T18:40:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3NTAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk5NDMwMg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#discussion_r425994302", "bodyText": "Np. I will add it. I think the test should pass as long as search does not go through the parser in vector mapper.", "author": "chenqi0805", "createdAt": "2020-05-15T19:03:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3NTAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk5NzQ0Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/108#discussion_r425997443", "bodyText": "thank you. Yes it should but this will act as a safety check for future code changes as well to ensure searches work fine even if CB triggered.", "author": "vamshin", "createdAt": "2020-05-15T19:10:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ3NTAwNw=="}], "type": "inlineReview"}, {"oid": "b69f89495a8f464500230d974633f671b074be9d", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/b69f89495a8f464500230d974633f671b074be9d", "message": "Modify error message and enhance test cases", "committedDate": "2020-05-14T16:13:56Z", "type": "commit"}, {"oid": "1f09e6681361f20358e245ff1bc501179c006b86", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/1f09e6681361f20358e245ff1bc501179c006b86", "message": "TST: add and search when CB trips", "committedDate": "2020-05-15T20:36:02Z", "type": "commit"}]}