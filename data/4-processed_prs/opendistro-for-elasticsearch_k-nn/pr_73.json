{"pr_number": 73, "pr_title": "k-NN CI/CD GitHub Actions", "pr_createdAt": "2020-03-20T13:13:14Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/73", "timeline": [{"oid": "7a99e7a2773c16ebe1ca519ef72880be0563677a", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/7a99e7a2773c16ebe1ca519ef72880be0563677a", "message": "Create CI.yml", "committedDate": "2020-03-20T13:10:10Z", "type": "commit"}, {"oid": "c2a35e5fdc4589eff094f60d91e468018334f71f", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/c2a35e5fdc4589eff094f60d91e468018334f71f", "message": "Create CD.yml", "committedDate": "2020-03-20T13:11:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2MTgzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/73#discussion_r395761831", "bodyText": "So, this will basically trigger whenever we create a tag that starts in v for releases correct?", "author": "jmazanec15", "createdAt": "2020-03-20T16:43:59Z", "path": ".github/workflows/CD.yml", "diffHunk": "@@ -0,0 +1,42 @@\n+name: Build and Release k-NN\n+on:\n+  push:\n+    tags: \n+      - v*", "originalCommit": "c2a35e5fdc4589eff094f60d91e468018334f71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3NDEzOQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/73#discussion_r395774139", "bodyText": "Yes", "author": "rishabh6788", "createdAt": "2020-03-20T17:05:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2MTgzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2MjU5Ng==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/73#discussion_r395762596", "bodyText": "build buildDeb buildRpm  can be build release.", "author": "jmazanec15", "createdAt": "2020-03-20T16:45:18Z", "path": ".github/workflows/CD.yml", "diffHunk": "@@ -0,0 +1,42 @@\n+name: Build and Release k-NN\n+on:\n+  push:\n+    tags: \n+      - v*\n+\n+jobs:\n+  Build-k-NN:\n+    strategy:\n+      matrix:\n+        java: [12]\n+\n+    name: Build and Release k-NN Plugin\n+    runs-on: ubuntu-latest\n+\n+    steps:\n+      - name: Checkout k-NN\n+        uses: actions/checkout@v1\n+        \n+      - name: Configure AWS\n+        uses: aws-actions/configure-aws-credentials@v1\n+        with:\n+          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}\n+          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}\n+          aws-region: us-east-1\n+      \n+      - name: Setup Java ${{ matrix.java }}\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: ${{ matrix.java }}\n+      \n+      - name: Run build\n+        run: |\n+          ./gradlew build buildDeb buildRpm --console=plain -Dbuild.snapshot=false", "originalCommit": "c2a35e5fdc4589eff094f60d91e468018334f71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3NTUxMA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/73#discussion_r395775510", "bodyText": "will update this.", "author": "rishabh6788", "createdAt": "2020-03-20T17:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2MjU5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2NDMwMw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/73#discussion_r395764303", "bodyText": "Does sleep 15 ever produce errors when the cluster isn't ready after 15 seconds?", "author": "jmazanec15", "createdAt": "2020-03-20T16:48:09Z", "path": ".github/workflows/CI.yml", "diffHunk": "@@ -0,0 +1,59 @@\n+name: Build and Test k-NN\n+on:\n+  push:\n+    branches:\n+      - master\n+      - opendistro-*\n+\n+jobs:\n+  Build-k-NN:\n+    strategy:\n+      matrix:\n+        java: [12]\n+\n+    name: Build and Test k-NN Plugin\n+    runs-on: ubuntu-latest\n+\n+    steps:\n+      - name: Checkout k-NN\n+        uses: actions/checkout@v1\n+        \n+      - name: Setup Java ${{ matrix.java }}\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: ${{ matrix.java }}\n+      \n+      - name: Run build\n+        run: |\n+          ./gradlew build\n+          ls -ltr build/distributions/\n+          \n+      - name: Pull and Run Docker\n+        run: |\n+          plugin=`ls build/distributions/*.zip`\n+          version=`echo $plugin|awk -F- '{print $3}'| cut -d. -f 1-3`\n+          plugin_version=`echo $plugin|awk -F- '{print $3}'| cut -d. -f 1-4`\n+          echo $version\n+          cd ..\n+          \n+          if docker pull opendistroforelasticsearch/opendistroforelasticsearch:$version\n+          then\n+            echo \"FROM opendistroforelasticsearch/opendistroforelasticsearch:$version\" >> Dockerfile\n+            echo \"RUN if [ -d /usr/share/elasticsearch/plugins/opendistro_security ]; then /usr/share/elasticsearch/bin/elasticsearch-plugin remove opendistro_security; fi\" >> Dockerfile\n+            echo \"RUN if [ -d /usr/share/elasticsearch/plugins/opendistro-knn ]; then /usr/share/elasticsearch/bin/elasticsearch-plugin remove opendistro-knn; fi\" >> Dockerfile\n+            echo \"ADD k-NN/build/distributions/opendistro-knn-$plugin_version.zip /tmp/\" >> Dockerfile\n+            echo \"RUN /usr/share/elasticsearch/bin/elasticsearch-plugin install --batch file:/tmp/opendistro-knn-$plugin_version.zip\" >> Dockerfile\n+            \n+            docker build -t odfe-knn:test .\n+          fi\n+          \n+      - name: Run Docker Image\n+        run: |\n+          cd ..\n+          docker run -p 9200:9200 -d -p 9600:9600 -e \"discovery.type=single-node\" odfe-knn:test\n+          sleep 15", "originalCommit": "c2a35e5fdc4589eff094f60d91e468018334f71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3NTI3OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/73#discussion_r395775278", "bodyText": "No. This is for the cluster to initialize and get ready.", "author": "rishabh6788", "createdAt": "2020-03-20T17:07:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2NDMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc4MDUzOQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/73#discussion_r395780539", "bodyText": "Sorry, what I meant to ask is 15 second sleep always enough time?", "author": "jmazanec15", "createdAt": "2020-03-20T17:16:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2NDMwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2NTEyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/73#discussion_r395765125", "bodyText": "Is the purpose of this line to check that the cluster is running?", "author": "jmazanec15", "createdAt": "2020-03-20T16:49:35Z", "path": ".github/workflows/CI.yml", "diffHunk": "@@ -0,0 +1,59 @@\n+name: Build and Test k-NN\n+on:\n+  push:\n+    branches:\n+      - master\n+      - opendistro-*\n+\n+jobs:\n+  Build-k-NN:\n+    strategy:\n+      matrix:\n+        java: [12]\n+\n+    name: Build and Test k-NN Plugin\n+    runs-on: ubuntu-latest\n+\n+    steps:\n+      - name: Checkout k-NN\n+        uses: actions/checkout@v1\n+        \n+      - name: Setup Java ${{ matrix.java }}\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: ${{ matrix.java }}\n+      \n+      - name: Run build\n+        run: |\n+          ./gradlew build\n+          ls -ltr build/distributions/\n+          \n+      - name: Pull and Run Docker\n+        run: |\n+          plugin=`ls build/distributions/*.zip`\n+          version=`echo $plugin|awk -F- '{print $3}'| cut -d. -f 1-3`\n+          plugin_version=`echo $plugin|awk -F- '{print $3}'| cut -d. -f 1-4`\n+          echo $version\n+          cd ..\n+          \n+          if docker pull opendistroforelasticsearch/opendistroforelasticsearch:$version\n+          then\n+            echo \"FROM opendistroforelasticsearch/opendistroforelasticsearch:$version\" >> Dockerfile\n+            echo \"RUN if [ -d /usr/share/elasticsearch/plugins/opendistro_security ]; then /usr/share/elasticsearch/bin/elasticsearch-plugin remove opendistro_security; fi\" >> Dockerfile\n+            echo \"RUN if [ -d /usr/share/elasticsearch/plugins/opendistro-knn ]; then /usr/share/elasticsearch/bin/elasticsearch-plugin remove opendistro-knn; fi\" >> Dockerfile\n+            echo \"ADD k-NN/build/distributions/opendistro-knn-$plugin_version.zip /tmp/\" >> Dockerfile\n+            echo \"RUN /usr/share/elasticsearch/bin/elasticsearch-plugin install --batch file:/tmp/opendistro-knn-$plugin_version.zip\" >> Dockerfile\n+            \n+            docker build -t odfe-knn:test .\n+          fi\n+          \n+      - name: Run Docker Image\n+        run: |\n+          cd ..\n+          docker run -p 9200:9200 -d -p 9600:9600 -e \"discovery.type=single-node\" odfe-knn:test\n+          sleep 15\n+          curl -XGET http://localhost:9200/_cat/plugins", "originalCommit": "c2a35e5fdc4589eff094f60d91e468018334f71f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3NTI1NQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/73#discussion_r395775255", "bodyText": "Yes, to test whether ES is up and running.", "author": "rishabh6788", "createdAt": "2020-03-20T17:07:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2NTEyNQ=="}], "type": "inlineReview"}, {"oid": "3031c5603f478eb73c07fbc7b80d6fb58f6c1577", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/3031c5603f478eb73c07fbc7b80d6fb58f6c1577", "message": "Update CD.yml", "committedDate": "2020-03-20T17:10:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MTI3Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/73#discussion_r395941273", "bodyText": "Why do we need to remove security plugin?", "author": "vamshin", "createdAt": "2020-03-21T00:26:39Z", "path": ".github/workflows/CI.yml", "diffHunk": "@@ -0,0 +1,59 @@\n+name: Build and Test k-NN\n+on:\n+  push:\n+    branches:\n+      - master\n+      - opendistro-*\n+\n+jobs:\n+  Build-k-NN:\n+    strategy:\n+      matrix:\n+        java: [12]\n+\n+    name: Build and Test k-NN Plugin\n+    runs-on: ubuntu-latest\n+\n+    steps:\n+      - name: Checkout k-NN\n+        uses: actions/checkout@v1\n+        \n+      - name: Setup Java ${{ matrix.java }}\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: ${{ matrix.java }}\n+      \n+      - name: Run build\n+        run: |\n+          ./gradlew build\n+          ls -ltr build/distributions/\n+          \n+      - name: Pull and Run Docker\n+        run: |\n+          plugin=`ls build/distributions/*.zip`\n+          version=`echo $plugin|awk -F- '{print $3}'| cut -d. -f 1-3`\n+          plugin_version=`echo $plugin|awk -F- '{print $3}'| cut -d. -f 1-4`\n+          echo $version\n+          cd ..\n+          \n+          if docker pull opendistroforelasticsearch/opendistroforelasticsearch:$version\n+          then\n+            echo \"FROM opendistroforelasticsearch/opendistroforelasticsearch:$version\" >> Dockerfile\n+            echo \"RUN if [ -d /usr/share/elasticsearch/plugins/opendistro_security ]; then /usr/share/elasticsearch/bin/elasticsearch-plugin remove opendistro_security; fi\" >> Dockerfile", "originalCommit": "3031c5603f478eb73c07fbc7b80d6fb58f6c1577", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA5MzQyNA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/73#discussion_r396093424", "bodyText": "The ESRestTest Client uses http by default. Need to disable the security plugin to call the rest api over http.", "author": "rishabh6788", "createdAt": "2020-03-22T13:25:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MTI3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIzMzQxNQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/73#discussion_r396233415", "bodyText": "Lets add it as a comment.", "author": "vamshin", "createdAt": "2020-03-23T06:25:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MTI3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUwNDIwOA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/73#discussion_r396504208", "bodyText": "Added.", "author": "rishabh6788", "createdAt": "2020-03-23T14:44:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MTI3Mw=="}], "type": "inlineReview"}, {"oid": "61affaff9c14fce6f25715b6696f1a778c83622a", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/61affaff9c14fce6f25715b6696f1a778c83622a", "message": "Update CI.yml", "committedDate": "2020-03-23T14:44:41Z", "type": "commit"}, {"oid": "29ab6ddd4f6b8224807ece1effd6114ce6172c67", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/29ab6ddd4f6b8224807ece1effd6114ce6172c67", "message": "updated to Java 13", "committedDate": "2020-03-24T19:40:19Z", "type": "commit"}]}