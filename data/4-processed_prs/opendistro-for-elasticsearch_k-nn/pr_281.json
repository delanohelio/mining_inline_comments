{"pr_number": 281, "pr_title": "Support k-NN similarity functions in painless scripting", "pr_createdAt": "2020-12-11T23:59:34Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281", "timeline": [{"oid": "2787c5d770f2a5c572a75fd75f7837be8098ee4c", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/2787c5d770f2a5c572a75fd75f7837be8098ee4c", "message": "Add IndexFieldDataBuilder\n\nPainless scripting uses IndexFieldDataBuilder to load field data values. Hence, override\nfielddataBuilder to return instance of KNNVectorIndexFieldData.Builder.\nSubsequently, this builder is responsible for returning ScriptDocValues which\nwill be used as argument in our Whitlisting knn custome methods.", "committedDate": "2020-12-11T00:48:43Z", "type": "commit"}, {"oid": "21f801096fade1d89bb0d9531168768ce8f0812a", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/21f801096fade1d89bb0d9531168768ce8f0812a", "message": "Add new methods for whitelisting\n\nAdded new methods which will be whitelisted for users to\ncall in source field for painless scripting.", "committedDate": "2020-12-11T23:47:54Z", "type": "commit"}, {"oid": "10dd92741091567b8ca66001b2aba9985eeb370e", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/10dd92741091567b8ca66001b2aba9985eeb370e", "message": "Create Whitelist text file\n\nAdd Extension class and return list of whitelisted method.\nUpdate gradle to add dependencies to painless.", "committedDate": "2020-12-11T23:53:09Z", "type": "commit"}, {"oid": "94d227790caa9a5bfc99fdd27db6497cbcaa1348", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/94d227790caa9a5bfc99fdd27db6497cbcaa1348", "message": "Remove Test Annotation\n\ntest annotation is forbidden", "committedDate": "2020-12-12T00:41:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU4OTQxMQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542589411", "bodyText": "fielddataBuilder should be fieldDataBuilder based on IndexFieldData", "author": "jmazanec15", "createdAt": "2020-12-14T17:58:05Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorFieldMapper.java", "diffHunk": "@@ -207,6 +210,12 @@ public Query termQuery(Object value, QueryShardContext context) {\n         public int getDimension() {\n             return dimension;\n         }\n+\n+        @Override\n+        public IndexFieldData.Builder fielddataBuilder(String fullyQualifiedIndexName, Supplier<SearchLookup> searchLookup) {", "originalCommit": "94d227790caa9a5bfc99fdd27db6497cbcaa1348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyMDM2NQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542820365", "bodyText": "Did you mean method name? if so, it is from parent class. i am overriding it here", "author": "VijayanB", "createdAt": "2020-12-14T21:37:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU4OTQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg1ODIxOA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542858218", "bodyText": "Oh haha yes you are correct, my mistake", "author": "jmazanec15", "createdAt": "2020-12-14T22:13:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU4OTQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU5MDY2Nw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542590667", "bodyText": "Why is this indented?", "author": "jmazanec15", "createdAt": "2020-12-14T17:59:54Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -50,7 +90,7 @@ public static float l2Squared(float[] queryVector, float[] inputVector) {\n      * @return cosine score\n      */\n     public static float cosinesimilOptimized(float[] queryVector, float[] inputVector, float normQueryVector) {\n-        float dotProduct = 0.0f;\n+            float dotProduct = 0.0f;", "originalCommit": "94d227790caa9a5bfc99fdd27db6497cbcaa1348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyMzMyMw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542823323", "bodyText": "ACk. Will apply reformat code in next commit.", "author": "VijayanB", "createdAt": "2020-12-14T21:40:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU5MDY2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU5NDMyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542594325", "bodyText": "This should be cosineSimilarityOptimized, no?", "author": "jmazanec15", "createdAt": "2020-12-14T18:05:12Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -64,6 +104,35 @@ public static float cosinesimilOptimized(float[] queryVector, float[] inputVecto\n         return (float) (dotProduct / (Math.sqrt(normalizedProduct)));\n     }\n \n+    /**\n+     * Whitelisted method for users that can be used script to avoid repeated calculation of normalization\n+     * for query vector for each filtered documents\n+     * example\n+     *  \"script\": {\n+     *         \"source\": \"cosineSimilarity(params.query_vector, docs[field], 1.0) \",", "originalCommit": "94d227790caa9a5bfc99fdd27db6497cbcaa1348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyMzY4OQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542823689", "bodyText": "Ack.", "author": "VijayanB", "createdAt": "2020-12-14T21:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU5NDMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkwMzU0Ng==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542903546", "bodyText": "addressed your rename comment, hence keeping cosineSimilarity as overloaded.", "author": "VijayanB", "createdAt": "2020-12-14T22:58:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU5NDMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5ODc1NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544498754", "bodyText": "Makes sense", "author": "jmazanec15", "createdAt": "2020-12-16T17:46:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU5NDMyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwMzQwOA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542603408", "bodyText": "I think this interface is vague: cosineSimilarityOptimized does not give a user any information about how this function differs from cosineSimilarity. If cosineSimilarity can be optimized, why even provide cosineSimilarity?\nThe Cosine similarity is A . B / (||A|| x ||B||). The difference between the two functions is that cosineSimilarityOptimized has the user pass in both the query vector and the magnitude of the query vector. Assuming the query vector is A, ||A|| does not change throughout the query. So time is saved by computing ||A|| separately and then passing it into the function. Also, I think normQueryVector may not be the appropriate term. Normalization refers to the process of making a vector have a magnitude of one.\nMy proposal is to switch it to the following interface:\ncosineSimilarity(List <Number> queryVector, KNNVectorScriptDocValues docValues, Number queryVectorMagnitude)", "author": "jmazanec15", "createdAt": "2020-12-14T18:18:33Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -64,6 +104,35 @@ public static float cosinesimilOptimized(float[] queryVector, float[] inputVecto\n         return (float) (dotProduct / (Math.sqrt(normalizedProduct)));\n     }\n \n+    /**\n+     * Whitelisted method for users that can be used script to avoid repeated calculation of normalization\n+     * for query vector for each filtered documents\n+     * example\n+     *  \"script\": {\n+     *         \"source\": \"cosineSimilarity(params.query_vector, docs[field], 1.0) \",\n+     *         \"params\": {\n+     *           \"query_vector\": [1, 2, 3.4],\n+     *           \"field\": \"my_dense_vector\"\n+     *         }\n+     *       }\n+     *\n+     * @param queryVector query vector\n+     * @param docValues script doc values\n+     * @param normQueryVector normalized query vector value.\n+     * @return cosine score\n+     */\n+    public static float cosineSimilarityOptimized(", "originalCommit": "94d227790caa9a5bfc99fdd27db6497cbcaa1348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg5MDk0NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542890944", "bodyText": "Ack", "author": "VijayanB", "createdAt": "2020-12-14T22:45:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwMzQwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwNTE0OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542605148", "bodyText": "Nit: \"Whitelisted cosineSimilarity method that can be used in a script to avoid repeated calculation of normalization for the query vector.\nExample:\n...\n\"", "author": "jmazanec15", "createdAt": "2020-12-14T18:20:18Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -64,6 +104,35 @@ public static float cosinesimilOptimized(float[] queryVector, float[] inputVecto\n         return (float) (dotProduct / (Math.sqrt(normalizedProduct)));\n     }\n \n+    /**\n+     * Whitelisted method for users that can be used script to avoid repeated calculation of normalization", "originalCommit": "94d227790caa9a5bfc99fdd27db6497cbcaa1348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg5MDgxOA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542890818", "bodyText": "Ack", "author": "VijayanB", "createdAt": "2020-12-14T22:45:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwNTE0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwNzE1MQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542607151", "bodyText": "Is this redundant with line 46?", "author": "jmazanec15", "createdAt": "2020-12-14T18:22:08Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorScriptDocValues.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.util.Objects;\n+\n+public final class KNNVectorScriptDocValues extends ScriptDocValues<float[]> {\n+\n+    private final BinaryDocValues binaryDocValues;\n+    private boolean docExists;\n+\n+    public KNNVectorScriptDocValues(BinaryDocValues binaryDocValues) {\n+        this.binaryDocValues = binaryDocValues;\n+    }\n+\n+    @Override\n+    public void setNextDocId(int docId) throws IOException {\n+        if (binaryDocValues.advanceExact(docId)) {\n+            docExists = true;\n+            return;\n+        }\n+        docExists=false;\n+    }\n+\n+    public float[] getValue() throws IOException{\n+        if (!docExists) {\n+            throw new IllegalArgumentException(\"no value found for the corresponding doc ID\");\n+        }\n+        BytesRef value = binaryDocValues.binaryValue();\n+        Objects.requireNonNull(value);", "originalCommit": "94d227790caa9a5bfc99fdd27db6497cbcaa1348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkwMTM3Nw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542901377", "bodyText": "ACk", "author": "VijayanB", "createdAt": "2020-12-14T22:55:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwNzE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwNzQ1OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542607458", "bodyText": "space before catch", "author": "jmazanec15", "createdAt": "2020-12-14T18:22:25Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorScriptDocValues.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.util.Objects;\n+\n+public final class KNNVectorScriptDocValues extends ScriptDocValues<float[]> {\n+\n+    private final BinaryDocValues binaryDocValues;\n+    private boolean docExists;\n+\n+    public KNNVectorScriptDocValues(BinaryDocValues binaryDocValues) {\n+        this.binaryDocValues = binaryDocValues;\n+    }\n+\n+    @Override\n+    public void setNextDocId(int docId) throws IOException {\n+        if (binaryDocValues.advanceExact(docId)) {\n+            docExists = true;\n+            return;\n+        }\n+        docExists=false;\n+    }\n+\n+    public float[] getValue() throws IOException{\n+        if (!docExists) {\n+            throw new IllegalArgumentException(\"no value found for the corresponding doc ID\");\n+        }\n+        BytesRef value = binaryDocValues.binaryValue();\n+        Objects.requireNonNull(value);\n+        ByteArrayInputStream byteStream = new ByteArrayInputStream(value.bytes, value.offset, value.length);\n+        ObjectInputStream objectStream = new ObjectInputStream(byteStream);\n+        try {\n+            return (float[]) objectStream.readObject();\n+        }catch (ClassNotFoundException e) {", "originalCommit": "94d227790caa9a5bfc99fdd27db6497cbcaa1348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg5MTI1OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542891258", "bodyText": "Ack. Applying reformat code.", "author": "VijayanB", "createdAt": "2020-12-14T22:45:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwNzQ1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwOTYwNQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542609605", "bodyText": "Is this thread safe? I am wondering if this is the correct place to determine if a value exists for that doc.", "author": "jmazanec15", "createdAt": "2020-12-14T18:24:22Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorScriptDocValues.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.util.Objects;\n+\n+public final class KNNVectorScriptDocValues extends ScriptDocValues<float[]> {\n+\n+    private final BinaryDocValues binaryDocValues;\n+    private boolean docExists;\n+\n+    public KNNVectorScriptDocValues(BinaryDocValues binaryDocValues) {\n+        this.binaryDocValues = binaryDocValues;\n+    }\n+\n+    @Override\n+    public void setNextDocId(int docId) throws IOException {\n+        if (binaryDocValues.advanceExact(docId)) {\n+            docExists = true;", "originalCommit": "94d227790caa9a5bfc99fdd27db6497cbcaa1348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg5MTk2OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542891968", "bodyText": "other scriptdocs like BInary, doesn't make this thread safe. Nevertheless, synchronized the methods to make sure we will not have race conditions.", "author": "VijayanB", "createdAt": "2020-12-14T22:46:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwOTYwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU0NjE2Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544546163", "bodyText": "I see. Refer to comment below about count", "author": "jmazanec15", "createdAt": "2020-12-16T18:58:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwOTYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYxMTQ5MQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542611491", "bodyText": "nit: add endline", "author": "jmazanec15", "createdAt": "2020-12-14T18:26:00Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorDVLeafFieldDataTests.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import com.amazon.opendistroforelasticsearch.knn.KNNTestCase;\n+import org.apache.lucene.analysis.MockAnalyzer;\n+import org.apache.lucene.document.BinaryDocValuesField;\n+import org.apache.lucene.document.Document;\n+import org.apache.lucene.document.FieldType;\n+import org.apache.lucene.index.DirectoryReader;\n+import org.apache.lucene.index.IndexWriter;\n+import org.apache.lucene.index.IndexWriterConfig;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.store.Directory;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+import org.junit.Before;\n+\n+import java.io.IOException;\n+\n+public class KNNVectorDVLeafFieldDataTests extends KNNTestCase {\n+\n+    private static final String MOCK_INDEX_FIELD_NAME = \"test-index-field-name\";\n+    private LeafReaderContext leafReaderContext;\n+    private Directory directory;\n+    private DirectoryReader reader;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        super.setUp();\n+        directory = newDirectory();\n+        createKNNVectorDocument(directory);\n+        reader = DirectoryReader.open(directory);\n+        leafReaderContext = reader.getContext().leaves().get(0);\n+    }\n+\n+    private void createKNNVectorDocument(Directory directory) throws IOException {\n+        IndexWriterConfig conf = newIndexWriterConfig(new MockAnalyzer(random()));\n+        IndexWriter writer = new IndexWriter(directory, conf);\n+        Document knnDocument = new Document();\n+        knnDocument.add(\n+                new BinaryDocValuesField(\n+                        MOCK_INDEX_FIELD_NAME,\n+                        new VectorField(MOCK_INDEX_FIELD_NAME, new float[]{1.0f, 2.0f}, new FieldType()).binaryValue()));\n+        writer.addDocument(knnDocument);\n+        writer.commit();\n+        writer.close();\n+    }\n+\n+    @Override\n+    public void tearDown() throws Exception {\n+        super.tearDown();\n+        reader.close();\n+        directory.close();\n+    }\n+\n+    public void testGetScriptValues() {\n+        KNNVectorDVLeafFieldData leafFieldData = new KNNVectorDVLeafFieldData(leafReaderContext.reader(), MOCK_INDEX_FIELD_NAME);\n+        ScriptDocValues<float[]> scriptValues = leafFieldData.getScriptValues();\n+        assertNotNull(scriptValues);\n+        assertTrue(scriptValues instanceof KNNVectorScriptDocValues);\n+    }\n+\n+    public void testGetScriptValuesWrongFieldName() {\n+        KNNVectorDVLeafFieldData leafFieldData = new KNNVectorDVLeafFieldData(leafReaderContext.reader(), \"\");\n+        expectThrows(IllegalStateException.class,\n+                () -> leafFieldData.getScriptValues());\n+    }\n+\n+    public void testRamBytesUsed() {\n+        KNNVectorDVLeafFieldData leafFieldData = new KNNVectorDVLeafFieldData(leafReaderContext.reader(), \"\");\n+        assertEquals(0, leafFieldData.ramBytesUsed());\n+    }\n+\n+    public void testGetBytesValues() {\n+        KNNVectorDVLeafFieldData leafFieldData = new KNNVectorDVLeafFieldData(leafReaderContext.reader(), \"\");\n+        expectThrows(UnsupportedOperationException.class,\n+                () -> leafFieldData.getBytesValues());\n+    }\n+}", "originalCommit": "94d227790caa9a5bfc99fdd27db6497cbcaa1348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkwMjAzNA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542902034", "bodyText": "ack", "author": "VijayanB", "createdAt": "2020-12-14T22:56:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYxMTQ5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYxMzEyMg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542613122", "bodyText": "nit: add endline", "author": "jmazanec15", "createdAt": "2020-12-14T18:27:23Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorIndexFieldDataTests.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import com.amazon.opendistroforelasticsearch.knn.KNNTestCase;\n+import org.apache.lucene.analysis.MockAnalyzer;\n+import org.apache.lucene.document.Document;\n+import org.apache.lucene.index.DirectoryReader;\n+import org.apache.lucene.index.IndexWriter;\n+import org.apache.lucene.index.IndexWriterConfig;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.store.Directory;\n+import org.elasticsearch.search.aggregations.support.CoreValuesSourceType;\n+import org.junit.Before;\n+\n+import java.io.IOException;\n+\n+public class KNNVectorIndexFieldDataTests extends KNNTestCase {\n+\n+    private static final String MOCK_INDEX_FIELD_NAME = \"test-index-field-name\";\n+    private KNNVectorIndexFieldData indexFieldData;\n+    private Directory directory;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        super.setUp();\n+        indexFieldData = new KNNVectorIndexFieldData(MOCK_INDEX_FIELD_NAME, CoreValuesSourceType.BYTES);\n+        directory = newDirectory();\n+        createEmptyDocument(directory);\n+    }\n+\n+    private void createEmptyDocument(Directory directory) throws IOException {\n+        IndexWriterConfig conf = newIndexWriterConfig(new MockAnalyzer(random()));\n+        IndexWriter writer = new IndexWriter(directory, conf);\n+        writer.addDocument(new Document());\n+        writer.commit();\n+        writer.close();\n+    }\n+\n+    @Override\n+    public void tearDown() throws Exception {\n+        super.tearDown();\n+        directory.close();\n+    }\n+\n+    public void testGetFieldName() {\n+        assertEquals(MOCK_INDEX_FIELD_NAME, indexFieldData.getFieldName());\n+    }\n+\n+    public void testGetValuesSourceType() {\n+        assertEquals(CoreValuesSourceType.BYTES, indexFieldData.getValuesSourceType());\n+    }\n+\n+    public void testLoad() throws IOException {\n+        final DirectoryReader reader = DirectoryReader.open(directory);\n+        LeafReaderContext leafReaderContext = reader.getContext().leaves().get(0);\n+        KNNVectorDVLeafFieldData leafFieldData = indexFieldData.load(leafReaderContext);\n+        assertNotNull(leafFieldData);\n+        reader.close();\n+    }\n+\n+    public void testLoadDirect() throws IOException {\n+        final DirectoryReader reader = DirectoryReader.open(directory);\n+        LeafReaderContext leafReaderContext = reader.getContext().leaves().get(0);\n+        KNNVectorDVLeafFieldData leafFieldData = indexFieldData.loadDirect(leafReaderContext);\n+        assertNotNull(leafFieldData);\n+        reader.close();\n+    }\n+\n+    public void testSortField() {\n+\n+        expectThrows(UnsupportedOperationException.class,\n+                () -> indexFieldData.sortField(null, null, null, false));\n+    }\n+\n+    public void testNewBucketedSort() {\n+\n+        expectThrows(UnsupportedOperationException.class,\n+                () -> indexFieldData.newBucketedSort(null, null, null, null, null, null, 0, null));\n+    }\n+}", "originalCommit": "94d227790caa9a5bfc99fdd27db6497cbcaa1348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkwMTg2OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542901868", "bodyText": "Ack", "author": "VijayanB", "createdAt": "2020-12-14T22:56:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYxMzEyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYxNDE0NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542614144", "bodyText": "add endline", "author": "jmazanec15", "createdAt": "2020-12-14T18:28:15Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorScriptDocValuesTests.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import com.amazon.opendistroforelasticsearch.knn.KNNTestCase;\n+import org.apache.lucene.analysis.MockAnalyzer;\n+import org.apache.lucene.document.BinaryDocValuesField;\n+import org.apache.lucene.document.Document;\n+import org.apache.lucene.document.FieldType;\n+import org.apache.lucene.index.DirectoryReader;\n+import org.apache.lucene.index.IndexWriter;\n+import org.apache.lucene.index.IndexWriterConfig;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.store.Directory;\n+import org.junit.Assert;\n+import org.junit.Before;\n+\n+import java.io.IOException;\n+\n+public class KNNVectorScriptDocValuesTests extends KNNTestCase {\n+\n+    private static final String MOCK_INDEX_FIELD_NAME = \"test-index-field-name\";\n+    private static final float[] SAMPLE_VECTOR_DATA = new float[]{1.0f, 2.0f};\n+    private KNNVectorScriptDocValues scriptDocValues;\n+    private Directory directory;\n+    private DirectoryReader reader;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        super.setUp();\n+        directory = newDirectory();\n+        createKNNVectorDocument(directory);\n+        reader = DirectoryReader.open(directory);\n+        LeafReaderContext leafReaderContext = reader.getContext().leaves().get(0);\n+        scriptDocValues = new KNNVectorScriptDocValues(leafReaderContext.reader().getBinaryDocValues(MOCK_INDEX_FIELD_NAME));\n+    }\n+\n+    private void createKNNVectorDocument(Directory directory) throws IOException {\n+        IndexWriterConfig conf = newIndexWriterConfig(new MockAnalyzer(random()));\n+        IndexWriter writer = new IndexWriter(directory, conf);\n+        Document knnDocument = new Document();\n+        knnDocument.add(\n+                new BinaryDocValuesField(\n+                        MOCK_INDEX_FIELD_NAME,\n+                        new VectorField(MOCK_INDEX_FIELD_NAME, SAMPLE_VECTOR_DATA, new FieldType()).binaryValue()));\n+        writer.addDocument(knnDocument);\n+        writer.commit();\n+        writer.close();\n+    }\n+\n+    @Override\n+    public void tearDown() throws Exception {\n+        super.tearDown();\n+        reader.close();\n+        directory.close();\n+    }\n+\n+    public void testGetValue() throws IOException {\n+        scriptDocValues.setNextDocId(0);\n+        Assert.assertArrayEquals(SAMPLE_VECTOR_DATA, scriptDocValues.getValue(), 0.1f);\n+    }\n+\n+    public void testSize() throws IOException {\n+        Assert.assertEquals(0, scriptDocValues.size());\n+        scriptDocValues.setNextDocId(0);\n+        Assert.assertEquals(1, scriptDocValues.size());\n+    }\n+\n+    public void testGet() throws IOException {\n+        expectThrows(UnsupportedOperationException.class,\n+                () -> scriptDocValues.get(0));\n+    }\n+}", "originalCommit": "94d227790caa9a5bfc99fdd27db6497cbcaa1348", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkwMTc2Nw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r542901767", "bodyText": "Ack", "author": "VijayanB", "createdAt": "2020-12-14T22:56:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYxNDE0NA=="}], "type": "inlineReview"}, {"oid": "dfe7e917d61c72f2659f39555b1bbdbf11e14cea", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/dfe7e917d61c72f2659f39555b1bbdbf11e14cea", "message": "Fixed code review comments\n1. Made KNNScriptDocValues thread safe\n2. reformat code\n3. rename cosinesimiloptimized.", "committedDate": "2020-12-14T22:49:45Z", "type": "commit"}, {"oid": "690c5a9092a090ef546ffdd560ede209c60a0a61", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/690c5a9092a090ef546ffdd560ede209c60a0a61", "message": "Remove nonnull check", "committedDate": "2020-12-14T22:55:11Z", "type": "commit"}, {"oid": "5f1a9a055f1f8ec0c2f8e591b3e0a414ccb3231d", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/5f1a9a055f1f8ec0c2f8e591b3e0a414ccb3231d", "message": "Fixed formatting errors", "committedDate": "2020-12-15T01:11:02Z", "type": "commit"}, {"oid": "aa7a4869b4448bf59c234f0711865a773f9e2d30", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/aa7a4869b4448bf59c234f0711865a773f9e2d30", "message": "Add Integration test\n\nAdd painless scripting score to verify whether following methods\nare available for users.\n1. l2Squared\n2. cosineSimilarity(queryVector,doc[field])\n3. cosineSimilarity(queryVector,doc[field],normalizedVector)", "committedDate": "2020-12-15T21:16:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ4NDc1NQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544484755", "bodyText": "Why throw IllegalArgumentException? It seems like it maybe should be an IllegalStateException.", "author": "jmazanec15", "createdAt": "2020-12-16T17:26:28Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorScriptDocValues.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+\n+// This class is thread safe, since docExists is synchronized at an instance level\n+public final class KNNVectorScriptDocValues extends ScriptDocValues<float[]> {\n+\n+    private final BinaryDocValues binaryDocValues;\n+    private boolean docExists;\n+\n+    public KNNVectorScriptDocValues(BinaryDocValues binaryDocValues) {\n+        this.binaryDocValues = binaryDocValues;\n+    }\n+\n+    @Override\n+    public void setNextDocId(int docId) throws IOException {\n+        synchronized (this) {\n+            if (binaryDocValues.advanceExact(docId)) {\n+                docExists = true;\n+                return;\n+            }\n+            docExists = false;\n+        }\n+    }\n+\n+    public synchronized float[] getValue() throws IOException {\n+        if (!docExists) {\n+            throw new IllegalArgumentException(\"no value found for the corresponding doc ID\");", "originalCommit": "aa7a4869b4448bf59c234f0711865a773f9e2d30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUzNzQ1MA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544537450", "bodyText": "Ack", "author": "VijayanB", "createdAt": "2020-12-16T18:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ4NDc1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ4ODUxNw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544488517", "bodyText": "Should this extend BinaryScriptDocValues<float[]>? Here is the code.\nI think if we go this route, we do not have to have docExists boolean.", "author": "jmazanec15", "createdAt": "2020-12-16T17:31:47Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorScriptDocValues.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+\n+// This class is thread safe, since docExists is synchronized at an instance level\n+public final class KNNVectorScriptDocValues extends ScriptDocValues<float[]> {", "originalCommit": "aa7a4869b4448bf59c234f0711865a773f9e2d30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxNzk2MQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544517961", "bodyText": "Thats a good point. That was my first attempt, but BinaryScriptDocValues is not public, hence we can't extend it.", "author": "VijayanB", "createdAt": "2020-12-16T18:15:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ4ODUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU0NDE3NQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544544175", "bodyText": "Ah, I see. That makes sense. In terms of docExists, I think we should follow the convention of using count instead. What do you think?", "author": "jmazanec15", "createdAt": "2020-12-16T18:55:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ4ODUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU0ODIyMg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544548222", "bodyText": "We can do that too, but i kept consistent with our other implementation as here\nhttps://github.com/opendistro-for-elasticsearch/k-NN/blob/master/src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoreScript.java#L138", "author": "VijayanB", "createdAt": "2020-12-16T19:01:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ4ODUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcxNzE4OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544717188", "bodyText": "You are right. We probably don't need to make that change now.", "author": "jmazanec15", "createdAt": "2020-12-17T00:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ4ODUxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5MDI5Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544490293", "bodyText": "Should this extend AbstractBinaryDVLeafFieldData?", "author": "jmazanec15", "createdAt": "2020-12-16T17:34:29Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorDVLeafFieldData.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.index.LeafReader;\n+import org.elasticsearch.index.fielddata.LeafFieldData;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+import org.elasticsearch.index.fielddata.SortedBinaryDocValues;\n+\n+import java.io.IOException;\n+\n+public class KNNVectorDVLeafFieldData implements LeafFieldData {", "originalCommit": "aa7a4869b4448bf59c234f0711865a773f9e2d30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUyMTc2Mg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544521762", "bodyText": "same as above. The class is not public.", "author": "VijayanB", "createdAt": "2020-12-16T18:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5MDI5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5ODMxMg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544498312", "bodyText": "Should we catch the specific exception here?", "author": "jmazanec15", "createdAt": "2020-12-16T17:46:16Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -34,18 +37,55 @@\n     public static float l2Squared(float[] queryVector, float[] inputVector) {\n         float squaredDistance = 0;\n         for (int i = 0; i < inputVector.length; i++) {\n-            float diff = queryVector[i]-inputVector[i];\n+            float diff = queryVector[i] - inputVector[i];\n             squaredDistance += diff * diff;\n         }\n         return squaredDistance;\n     }\n \n+    private static float[] toFloat(List<Number> inputVector) {\n+        Objects.requireNonNull(inputVector);\n+        float[] value = new float[inputVector.size()];\n+        int index = 0;\n+        for (final Number val : inputVector) {\n+            value[index++] = val.floatValue();\n+        }\n+        return value;\n+    }\n+\n+    /**\n+     * Whitelisted l2Squared method for users to calculate L2 squared distance between query vector\n+     * and document vectors\n+     * Example\n+     *  \"script\": {\n+     *         \"source\": \"1/(1 + l2Squared(params.query_vector, doc[params.field]))\",\n+     *         \"params\": {\n+     *           \"query_vector\": [1, 2, 3.4],\n+     *           \"field\": \"my_dense_vector\"\n+     *         }\n+     *       }\n+     *\n+     * @param queryVector query vector\n+     * @param docValues   script doc values\n+     * @return L2 score\n+     */\n+    public static float l2Squared(List<Number> queryVector, KNNVectorScriptDocValues docValues) {\n+        float[] knnDocVector;\n+        try {\n+            knnDocVector = docValues.getValue();\n+        } catch (Exception e) {", "originalCommit": "aa7a4869b4448bf59c234f0711865a773f9e2d30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU0MjkxMQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544542911", "bodyText": "getValue can throw RuntimeException & IOException, i see three option here\n\nLet docValues throw exception as it is and catch all individual exception here and return Float.Min like now,\nUpdate getValue to throw only RuntimeException, and catch only RuntimeException here\nJust update catch (Exception e) to catch ( RuntimeException | IOException e )\n\ni don't see any difference in all three since at the end outcome is same, but if you have strong opinion on one vs other, i can change it . if you see any other option i can make change it as well.", "author": "VijayanB", "createdAt": "2020-12-16T18:53:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5ODMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcxNzQzOA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544717438", "bodyText": "Makes sense, Option 1 us good with me", "author": "jmazanec15", "createdAt": "2020-12-17T00:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5ODMxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5ODU3OQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544498579", "bodyText": "Out of curiosity, any reason for these tabs here?", "author": "jmazanec15", "createdAt": "2020-12-16T17:46:37Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -34,18 +37,55 @@\n     public static float l2Squared(float[] queryVector, float[] inputVector) {\n         float squaredDistance = 0;\n         for (int i = 0; i < inputVector.length; i++) {\n-            float diff = queryVector[i]-inputVector[i];\n+            float diff = queryVector[i] - inputVector[i];\n             squaredDistance += diff * diff;\n         }\n         return squaredDistance;\n     }\n \n+    private static float[] toFloat(List<Number> inputVector) {\n+        Objects.requireNonNull(inputVector);\n+        float[] value = new float[inputVector.size()];\n+        int index = 0;\n+        for (final Number val : inputVector) {\n+            value[index++] = val.floatValue();\n+        }\n+        return value;\n+    }\n+\n+    /**\n+     * Whitelisted l2Squared method for users to calculate L2 squared distance between query vector\n+     * and document vectors\n+     * Example\n+     *  \"script\": {\n+     *         \"source\": \"1/(1 + l2Squared(params.query_vector, doc[params.field]))\",\n+     *         \"params\": {\n+     *           \"query_vector\": [1, 2, 3.4],\n+     *           \"field\": \"my_dense_vector\"\n+     *         }\n+     *       }\n+     *\n+     * @param queryVector query vector\n+     * @param docValues   script doc values\n+     * @return L2 score\n+     */\n+    public static float l2Squared(List<Number> queryVector, KNNVectorScriptDocValues docValues) {\n+        float[] knnDocVector;\n+        try {\n+            knnDocVector = docValues.getValue();\n+        } catch (Exception e) {\n+            logger.debug(\"Failed to get vector from doc. Returning minimum score to put this result to end\", e);\n+            return Float.MIN_VALUE;\n+        }\n+        return l2Squared(toFloat(queryVector), knnDocVector);\n+    }\n+\n     /**\n      * This method can be used script to avoid repeated calculation of normalization\n      * for query vector for each filtered documents\n      *\n-     * @param queryVector query vector\n-     * @param inputVector input vector\n+     * @param queryVector     query vector", "originalCommit": "aa7a4869b4448bf59c234f0711865a773f9e2d30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUyNTc2Ng==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544525766", "bodyText": "", "author": "VijayanB", "createdAt": "2020-12-16T18:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5ODU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU0NDg2Nw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544544867", "bodyText": "Oh okay, makes sense. Yes, in the future I think we should use some kind of linter to keep style consistent.", "author": "jmazanec15", "createdAt": "2020-12-16T18:56:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5ODU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU0ODczNA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544548734", "bodyText": "i agree.", "author": "VijayanB", "createdAt": "2020-12-16T19:02:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5ODU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5OTcxMA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544499710", "bodyText": "The other part of my comment suggested changing this name to queryVectorMagnitude. normQueryVector makes it seem like the user should pass in the normalized query vector, not the magnitude of the query vector.", "author": "jmazanec15", "createdAt": "2020-12-16T17:48:12Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/KNNScoringUtil.java", "diffHunk": "@@ -64,6 +104,35 @@ public static float cosinesimilOptimized(float[] queryVector, float[] inputVecto\n         return (float) (dotProduct / (Math.sqrt(normalizedProduct)));\n     }\n \n+    /**\n+     * Whitelisted cosineSimilarity method that can be used in a script to avoid repeated\n+     * calculation of normalization for the query vector.\n+     * Example:\n+     *  \"script\": {\n+     *         \"source\": \"cosineSimilarity(params.query_vector, docs[field], 1.0) \",\n+     *         \"params\": {\n+     *           \"query_vector\": [1, 2, 3.4],\n+     *           \"field\": \"my_dense_vector\"\n+     *         }\n+     *       }\n+     *\n+     * @param queryVector     query vector\n+     * @param docValues       script doc values\n+     * @param normQueryVector normalized query vector value.", "originalCommit": "aa7a4869b4448bf59c234f0711865a773f9e2d30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUyNzU2NQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544527565", "bodyText": "I see. I will update it, on side note, i don't think user will see this variable name since they will only see datatype.", "author": "VijayanB", "createdAt": "2020-12-16T18:29:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5OTcxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUwMTI1Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544501253", "bodyText": "Which style tool did you use for formatting? I think it might make sense to add some kind of styling framework to the code so that we stay consistent (I am not suggesting adding it in this PR, but it might make sense to add in the future).", "author": "jmazanec15", "createdAt": "2020-12-16T17:50:33Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/KNNRestTestCase.java", "diffHunk": "@@ -418,15 +419,15 @@ protected void deleteKnnDoc(String index, String docId) throws IOException {\n      */\n     protected void updateClusterSettings(String settingKey, Object value) throws Exception {\n         XContentBuilder builder = XContentFactory.jsonBuilder()\n-                       .startObject()\n-                       .startObject(\"persistent\")\n-                       .field(settingKey, value)\n-                       .endObject()\n-                       .endObject();\n+                .startObject()", "originalCommit": "aa7a4869b4448bf59c234f0711865a773f9e2d30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU0NDA0Mg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544544042", "bodyText": "i am using the one which comes with Intellij", "author": "VijayanB", "createdAt": "2020-12-16T18:55:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUwMTI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU0NTE3MA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544545170", "bodyText": "Refer to above", "author": "jmazanec15", "createdAt": "2020-12-16T18:57:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUwMTI1Mw=="}], "type": "inlineReview"}, {"oid": "71f4a60e9930ea03087463a164d3581b2833876a", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/71f4a60e9930ea03087463a164d3581b2833876a", "message": "Fixed review comments\n\n1. updated exception type.\n2. Added test", "committedDate": "2020-12-16T19:17:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgyOTE0Mg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544829142", "bodyText": "do we need synchronized here?", "author": "vamshin", "createdAt": "2020-12-17T05:49:27Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorScriptDocValues.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+\n+// This class is thread safe, since docExists is synchronized at an instance level\n+public final class KNNVectorScriptDocValues extends ScriptDocValues<float[]> {\n+\n+    private final BinaryDocValues binaryDocValues;\n+    private boolean docExists;\n+\n+    public KNNVectorScriptDocValues(BinaryDocValues binaryDocValues) {\n+        this.binaryDocValues = binaryDocValues;\n+    }\n+\n+    @Override\n+    public void setNextDocId(int docId) throws IOException {\n+        synchronized (this) {", "originalCommit": "71f4a60e9930ea03087463a164d3581b2833876a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMxMDM2Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r545310363", "bodyText": "I added thread safe to prevent any race condition based on feedback, since docExists setting is happening in one place and reading is happening on another place. If there is not threat with race condition then definitely we can remove this. At the end, it comes to do we need to make this instance thread safe or not? What do you think?", "author": "VijayanB", "createdAt": "2020-12-17T18:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgyOTE0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzMjQ4Nw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r545332487", "bodyText": "Good point. Do you have pointers to any other base classes extending  ScriptDocValues<> doing synchronization? My understanding is each search request should have its own instance and documents are iterated sequentially so synchronization should not be required. If you see any base class doing this we can definitely consider.", "author": "vamshin", "createdAt": "2020-12-17T19:03:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgyOTE0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExMjE2NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r546112164", "bodyText": "Removed synchronization.", "author": "VijayanB", "createdAt": "2020-12-18T22:03:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgyOTE0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgzMzc5MQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544833791", "bodyText": "Do we need synchronized here?  Avoid synchronization in the places not needed as it could hamper performance.", "author": "vamshin", "createdAt": "2020-12-17T06:02:37Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNVectorScriptDocValues.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import org.apache.lucene.index.BinaryDocValues;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+\n+// This class is thread safe, since docExists is synchronized at an instance level\n+public final class KNNVectorScriptDocValues extends ScriptDocValues<float[]> {\n+\n+    private final BinaryDocValues binaryDocValues;\n+    private boolean docExists;\n+\n+    public KNNVectorScriptDocValues(BinaryDocValues binaryDocValues) {\n+        this.binaryDocValues = binaryDocValues;\n+    }\n+\n+    @Override\n+    public void setNextDocId(int docId) throws IOException {\n+        synchronized (this) {\n+            if (binaryDocValues.advanceExact(docId)) {\n+                docExists = true;\n+                return;\n+            }\n+            docExists = false;\n+        }\n+    }\n+\n+    public synchronized float[] getValue() throws IOException {\n+        if (!docExists) {\n+            throw new IllegalStateException(\"no value found for the corresponding doc ID\");\n+        }\n+        BytesRef value = binaryDocValues.binaryValue();\n+        ByteArrayInputStream byteStream = new ByteArrayInputStream(value.bytes, value.offset, value.length);\n+        ObjectInputStream objectStream = new ObjectInputStream(byteStream);\n+        try {\n+            return (float[]) objectStream.readObject();\n+        } catch (ClassNotFoundException e) {\n+            throw new RuntimeException((e));\n+        }\n+    }\n+\n+    @Override\n+    public int size() {\n+        synchronized (this) {", "originalCommit": "71f4a60e9930ea03087463a164d3581b2833876a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMwODAyNA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r545308024", "bodyText": "I added so that docExists is synchronized. Since it is just one instruction, i think i can remove this.", "author": "VijayanB", "createdAt": "2020-12-17T18:26:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgzMzc5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzMDE5OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r545330198", "bodyText": "Yes please. I have not seen other places doing this. We can remove this.", "author": "vamshin", "createdAt": "2020-12-17T19:00:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgzMzc5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExMjI1NQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r546112255", "bodyText": "Removed", "author": "VijayanB", "createdAt": "2020-12-18T22:03:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgzMzc5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDg0NTIzMA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r544845230", "bodyText": "How about we have a document without the vector and then assert that particular doc comes at the end of the result? Same for both CosineTestData as well.", "author": "vamshin", "createdAt": "2020-12-17T06:34:30Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/knn/plugin/script/PainlessScriptScoringIT.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.script;\n+\n+import com.amazon.opendistroforelasticsearch.knn.KNNRestTestCase;\n+import com.amazon.opendistroforelasticsearch.knn.KNNResult;\n+import org.apache.http.util.EntityUtils;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.index.query.MatchAllQueryBuilder;\n+import org.elasticsearch.index.query.QueryBuilder;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.script.Script;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class PainlessScriptScoringIT extends KNNRestTestCase {\n+\n+\n+    private Map<String, Float[]> getL2TestData() {\n+        Map<String, Float[]> data = new HashMap<>();\n+        data.put(\"1\", new Float[]{6.0f, 6.0f});", "originalCommit": "71f4a60e9930ea03087463a164d3581b2833876a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE2NjM4MQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/281#discussion_r546166381", "bodyText": "Added test data.", "author": "VijayanB", "createdAt": "2020-12-19T01:02:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDg0NTIzMA=="}], "type": "inlineReview"}, {"oid": "436aff37cd3059e29ff74306fe94099574b6bdd0", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/436aff37cd3059e29ff74306fe94099574b6bdd0", "message": "Fix review comments\n\n1. Requires dimension must be consistent between query vector and input vector\n2. Remove thread safe for KNNScriptDocValues\n3. Throw exception if document doesn't contains vector field.", "committedDate": "2020-12-18T22:00:44Z", "type": "commit"}, {"oid": "cf32fec672b0afa195027b174faaadaf5c521318", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/cf32fec672b0afa195027b174faaadaf5c521318", "message": "Fixed lint errors", "committedDate": "2020-12-19T00:27:23Z", "type": "commit"}, {"oid": "ff846d9270e9712d45bb284e9480da3a3a62af0b", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ff846d9270e9712d45bb284e9480da3a3a62af0b", "message": "Add test case to check size\n\nTo avoid exception, user's can use size method to validate.", "committedDate": "2020-12-22T00:22:17Z", "type": "commit"}, {"oid": "dedba6d2bcde8aae9d368e4f4a29fd38abe53985", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/dedba6d2bcde8aae9d368e4f4a29fd38abe53985", "message": "Extract constant", "committedDate": "2020-12-22T00:24:18Z", "type": "commit"}, {"oid": "9722abb795e343dfb98de67938bd077b80272de1", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/9722abb795e343dfb98de67938bd077b80272de1", "message": "Update error message\n\nInclude error message with additional details on how to fix the\nproblem.", "committedDate": "2020-12-22T23:08:24Z", "type": "commit"}, {"oid": "db29a858f80d3023f89aa78822c076ef4030d186", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/db29a858f80d3023f89aa78822c076ef4030d186", "message": "Update error message\n\nAdd field name as part of error message", "committedDate": "2020-12-22T23:20:45Z", "type": "commit"}, {"oid": "06c66010b6949553c9affe05936c57042e19aeac", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/06c66010b6949553c9affe05936c57042e19aeac", "message": "Refactor ScoreScirpt\n\nUse scriptdoc to extract values from segment.", "committedDate": "2020-12-24T19:18:37Z", "type": "commit"}, {"oid": "44b2acea301e4dd75bdba14b96c8f48f162e443e", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/44b2acea301e4dd75bdba14b96c8f48f162e443e", "message": "Refactor ScoreScript\n\nUse KNNScriptDocValues to retrieve float[] from the\ndocument instead of explicity retrieval.", "committedDate": "2020-12-24T19:31:06Z", "type": "commit"}]}