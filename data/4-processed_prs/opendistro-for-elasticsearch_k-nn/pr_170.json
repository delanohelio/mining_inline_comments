{"pr_number": 170, "pr_title": "Add Github action to build library artifacts", "pr_createdAt": "2020-07-17T20:26:46Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/170", "timeline": [{"oid": "10d73e167436bf64b1e37892f66d4b3005b54c47", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/10d73e167436bf64b1e37892f66d4b3005b54c47", "message": "build libraries in containers", "committedDate": "2020-07-17T16:29:23Z", "type": "commit"}, {"oid": "ed5a3704fbc5f980de01194d8658b679dce78e3f", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ed5a3704fbc5f980de01194d8658b679dce78e3f", "message": "fix library artifact builds", "committedDate": "2020-07-17T16:32:17Z", "type": "commit"}, {"oid": "dd8fde231ca9dead21ea3c446cdc5c56d3cea458", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/dd8fde231ca9dead21ea3c446cdc5c56d3cea458", "message": "fixed RPM/DEB/ZIP build and release", "committedDate": "2020-07-17T19:33:47Z", "type": "commit"}, {"oid": "f0584bd5dc12c9d11e15e6eaa063ba24640fc881", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/f0584bd5dc12c9d11e15e6eaa063ba24640fc881", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/k-NN into library-artifact-actions", "committedDate": "2020-07-17T19:36:46Z", "type": "commit"}, {"oid": "527e0097ddc0a3be327a1914f33a20818cf5c4aa", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/527e0097ddc0a3be327a1914f33a20818cf5c4aa", "message": "Update README with information about library artifacts", "committedDate": "2020-07-17T19:38:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY2NDEwMg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/170#discussion_r456664102", "bodyText": "As we discussed @jmazanec15 since CentOS have the lowest version of glibc, it would make sense to compile all distros of knnlib (zip/deb/rpm) in CentOS.", "author": "peterzhuamazon", "createdAt": "2020-07-17T20:40:21Z", "path": ".github/workflows/CD.yml", "diffHunk": "@@ -68,3 +39,105 @@ jobs:\n           aws s3 cp $rpm_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/rpms/opendistro-knn/\n           aws s3 cp $deb_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/debs/opendistro-knn/\n           aws cloudfront create-invalidation --distribution-id E1VG5HMIWI4SA2 --paths \"/*\"\n+\n+  library-build-and-ship-zip-and-rpm:\n+    name: Build k-NN JNI Library for Zip and RPM\n+    runs-on: ubuntu-latest\n+    container:\n+      image: centos:7\n+    strategy:\n+      matrix:\n+        java: [14]\n+        compiler: [g++]\n+    steps:\n+      - name: Checkout k-NN\n+        uses: actions/checkout@v1\n+        with:\n+          submodules: true\n+\n+      - name: Configure AWS Credentials\n+        uses: aws-actions/configure-aws-credentials@v1\n+        with:\n+          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}\n+          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}\n+          aws-region: us-east-1\n+\n+      - name: Setup Java ${{ matrix.java }}\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: ${{ matrix.java }}\n+\n+      - name: Install dependencies\n+        run: |\n+          yum update -y\n+          yum install -y cmake rpm-build gcc-c++ make\n+\n+      - name: Build and ship library RPM and ZIP\n+        env:\n+          CXX: ${{ matrix.compiler }}\n+        run: |\n+          cd jni\n+          sed -i 's/-march=native/-march=x86-64/g' external/nmslib/similarity_search/CMakeLists.txt\n+          cmake .\n+          make package\n+\n+          cd packages\n+          folder_name=`ls ./*.rpm | sed 's|\\(.*\\)\\..*|\\1|'`\n+          zip_name=$folder_name\".zip\"\n+          mkdir $folder_name\n+          cp ../release/*.so $folder_name\n+          zip -r $zip_name $folder_name/*\n+          cd ..\n+\n+          zip_artifact=`ls packages/*.zip`\n+          rpm_artifact=`ls packages/*.rpm`\n+\n+          aws s3 cp $zip_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/opendistro-libs/opendistro-knnlib/\n+          aws s3 cp $rpm_artifact s3://artifacts.opendistroforelasticsearch.amazon.com/downloads/rpms/opendistro-knnlib/\n+          aws cloudfront create-invalidation --distribution-id E1VG5HMIWI4SA2 --paths \"/*\"\n+\n+  library-build-and-ship-deb:", "originalCommit": "527e0097ddc0a3be327a1914f33a20818cf5c4aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY2OTUyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/170#discussion_r456669525", "bodyText": "Yes, I believe that makes sense. Will test artifacts built there on other systems.", "author": "jmazanec15", "createdAt": "2020-07-17T20:54:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY2NDEwMg=="}], "type": "inlineReview"}, {"oid": "d0688c5df0c661b5795eb02bf78e36ac50d394ca", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/d0688c5df0c661b5795eb02bf78e36ac50d394ca", "message": "switch to centos for DEB", "committedDate": "2020-07-17T21:13:07Z", "type": "commit"}, {"oid": "ab411494846dd359a511befc9fe5c39a337627dc", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/ab411494846dd359a511befc9fe5c39a337627dc", "message": "updated centos to install dpkg", "committedDate": "2020-07-17T22:46:56Z", "type": "commit"}, {"oid": "2284e4f15a09452dc883bf894af2cc66c4b86276", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/2284e4f15a09452dc883bf894af2cc66c4b86276", "message": "add refresh repolist", "committedDate": "2020-07-17T22:48:33Z", "type": "commit"}]}