{"pr_number": 162, "pr_title": "Add Warmup API to load indices graphs into memory", "pr_createdAt": "2020-07-09T18:27:38Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162", "timeline": [{"oid": "acec5d068d293f439582d3a1e71aff53829714d4", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/acec5d068d293f439582d3a1e71aff53829714d4", "message": "PoC for warmup api", "committedDate": "2020-06-12T06:37:37Z", "type": "commit"}, {"oid": "2435a51adc0a2505108c9783007e432fd65a9b84", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/2435a51adc0a2505108c9783007e432fd65a9b84", "message": "warmup API enhancement", "committedDate": "2020-06-24T17:21:30Z", "type": "commit"}, {"oid": "e41fdfc9c5141716c79b4b113479b8c760a312fb", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/e41fdfc9c5141716c79b4b113479b8c760a312fb", "message": "refactored transport layer for warmup", "committedDate": "2020-06-29T01:09:17Z", "type": "commit"}, {"oid": "f8f081461028aead63555e7e0fede64bd51b2dff", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/f8f081461028aead63555e7e0fede64bd51b2dff", "message": "changed to use searcher for getting index reader", "committedDate": "2020-07-08T21:15:34Z", "type": "commit"}, {"oid": "7a2df2f931f8d5d3e9655fa2ccb64e824adea794", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/7a2df2f931f8d5d3e9655fa2ccb64e824adea794", "message": "changed interace for loading multiple hnsw segments", "committedDate": "2020-07-08T21:16:03Z", "type": "commit"}, {"oid": "78d8847d07c3876ca5c722ad2c528b5f3c696e1c", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/78d8847d07c3876ca5c722ad2c528b5f3c696e1c", "message": "minor cleanup", "committedDate": "2020-07-08T21:16:34Z", "type": "commit"}, {"oid": "539314f13ffcf716f50dc300214be30c2b0e34f5", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/539314f13ffcf716f50dc300214be30c2b0e34f5", "message": "minor change", "committedDate": "2020-07-08T21:17:27Z", "type": "commit"}, {"oid": "f24a9840fd400c1ee805cfbdfd05881c9fb463b8", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/f24a9840fd400c1ee805cfbdfd05881c9fb463b8", "message": "added test cases for warmup api", "committedDate": "2020-07-08T21:18:25Z", "type": "commit"}, {"oid": "5c41ba138f33940a4b947b111f4944b8e7da051f", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/5c41ba138f33940a4b947b111f4944b8e7da051f", "message": "WIP: rest test cases for Warmup", "committedDate": "2020-07-08T21:19:10Z", "type": "commit"}, {"oid": "0f8eb5441a172d24a9b945e4d8d166bdd7025583", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/0f8eb5441a172d24a9b945e4d8d166bdd7025583", "message": "remove unnecessary code", "committedDate": "2020-07-08T21:24:13Z", "type": "commit"}, {"oid": "d24f0fcb261a6adec0dc64750adac1c9016a9c7a", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/d24f0fcb261a6adec0dc64750adac1c9016a9c7a", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/k-NN into warmup", "committedDate": "2020-07-08T21:24:23Z", "type": "commit"}, {"oid": "660ac1d4f106ba3c0fceed01d57971771510d23a", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/660ac1d4f106ba3c0fceed01d57971771510d23a", "message": "adding not k-NN index exception handling in rest layer", "committedDate": "2020-07-09T16:15:12Z", "type": "commit"}, {"oid": "06c95dc18dbf36298547ebb1728ded9012bf04c1", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/06c95dc18dbf36298547ebb1728ded9012bf04c1", "message": "added rest test cases for warmup API", "committedDate": "2020-07-09T17:22:59Z", "type": "commit"}, {"oid": "2812f87314f7c4e6d27a1b8db5185f02e23c1973", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/2812f87314f7c4e6d27a1b8db5185f02e23c1973", "message": "added comments", "committedDate": "2020-07-09T17:45:59Z", "type": "commit"}, {"oid": "6b592b78dbacddd2f787fd1d2da9d791ae19724a", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/6b592b78dbacddd2f787fd1d2da9d791ae19724a", "message": "clean up comments", "committedDate": "2020-07-09T17:50:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2NjQ5Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r452966493", "bodyText": "remove \"the Index\" and just leave \"the IndexShard\"?", "author": "kaituo", "createdAt": "2020-07-10T17:06:07Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexShard.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.codec.KNNCodecUtil;\n+import com.amazon.opendistroforelasticsearch.knn.index.v1736.KNNIndex;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.lucene.index.FilterLeafReader;\n+import org.apache.lucene.index.IndexReader;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.index.SegmentInfo;\n+import org.apache.lucene.index.SegmentReader;\n+import org.elasticsearch.index.engine.Engine;\n+import org.elasticsearch.index.shard.IndexShard;\n+import org.elasticsearch.index.shard.ShardPath;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * KNNIndexShard wraps IndexShard and adds methods to perform k-NN related operations against the shard\n+ */\n+public class KNNIndexShard {\n+    private IndexShard indexShard;\n+    private KNNIndexCache knnIndexCache;\n+\n+    private static Logger logger = LogManager.getLogger(KNNIndexShard.class);\n+\n+    /**\n+     * Constructor to generate KNNIndexShard. We do not perform validation that the Index the IndexShard is from", "originalCommit": "6b592b78dbacddd2f787fd1d2da9d791ae19724a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM3NTMwNw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455375307", "bodyText": "I think I wiil change to \"We do not perform validation that the index the shard is from\"", "author": "jmazanec15", "createdAt": "2020-07-15T21:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2NjQ5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2ODUxOQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r452968519", "bodyText": "What if resolve(fileName) returns null?", "author": "kaituo", "createdAt": "2020-07-10T17:10:24Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexShard.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.codec.KNNCodecUtil;\n+import com.amazon.opendistroforelasticsearch.knn.index.v1736.KNNIndex;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.lucene.index.FilterLeafReader;\n+import org.apache.lucene.index.IndexReader;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.index.SegmentInfo;\n+import org.apache.lucene.index.SegmentReader;\n+import org.elasticsearch.index.engine.Engine;\n+import org.elasticsearch.index.shard.IndexShard;\n+import org.elasticsearch.index.shard.ShardPath;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * KNNIndexShard wraps IndexShard and adds methods to perform k-NN related operations against the shard\n+ */\n+public class KNNIndexShard {\n+    private IndexShard indexShard;\n+    private KNNIndexCache knnIndexCache;\n+\n+    private static Logger logger = LogManager.getLogger(KNNIndexShard.class);\n+\n+    /**\n+     * Constructor to generate KNNIndexShard. We do not perform validation that the Index the IndexShard is from\n+     * is in fact a k-NN Index (index.knn = true). This may make sense to add later, but for now the operations for\n+     * KNNIndexShards that are not from a k-NN index should be no-ops.\n+     *\n+     * @param indexShard IndexShard to be wrapped.\n+     */\n+    public KNNIndexShard(IndexShard indexShard) {\n+        this.indexShard = indexShard;\n+        this.knnIndexCache = KNNIndexCache.getInstance();\n+    }\n+\n+    /**\n+     * Return the underlying IndexShard\n+     *\n+     * @return IndexShard\n+     */\n+    public IndexShard getIndexShard() {\n+        return indexShard;\n+    }\n+\n+    /**\n+     * Return the name of the shards index\n+     *\n+     * @return Name of shard's index\n+     */\n+    public String getIndexName() {\n+        return indexShard.shardId().getIndexName();\n+    }\n+\n+    /**\n+     * Load all of the HNSW graphs for this shard into the cache. Note that getIndices is called to prevent loading\n+     * in duplicates.\n+     *\n+     * @return a List of KNNIndex's from this shard that are in the cache after this operation.\n+     * @throws IOException Thrown when getting the HNSW Paths to be loaded in\n+     */\n+    public List<KNNIndex> warmup() throws IOException {\n+        logger.info(\"[KNN] Warming up index: \" + getIndexName());\n+        Engine.Searcher searcher = indexShard.acquireSearcher(\"knn-warmup\");\n+        List<KNNIndex> indices;\n+        try {\n+            indices = knnIndexCache.getIndices(getHNSWPaths(searcher.getIndexReader()), getIndexName());\n+            searcher.close();\n+        } catch (IOException ex) {\n+            searcher.close();\n+            throw ex;\n+        }\n+        return indices;\n+    }\n+\n+    /**\n+     * For the given shard, get all of its HNSW paths\n+     *\n+     * @param indexReader IndexReader to read the file paths for the shard\n+     * @return List of HNSW Paths\n+     * @throws IOException Thrown when the SegmentReader is attempting to read the segments files\n+     */\n+    public List<String> getHNSWPaths(IndexReader indexReader) throws IOException {\n+        List<String> hnswFiles = new ArrayList<>();\n+        for (LeafReaderContext leafReaderContext : indexReader.leaves()) {\n+            SegmentReader reader = (SegmentReader) FilterLeafReader.unwrap(leafReaderContext.reader());\n+            hnswFiles.addAll(reader.getSegmentInfo().files().stream()\n+                    .filter(fileName -> fileName.endsWith(getHNSWFileExtension(reader.getSegmentInfo().info)))\n+                    .map(fileName -> shardPath().resolveIndex().resolve(fileName).toString())", "originalCommit": "6b592b78dbacddd2f787fd1d2da9d791ae19724a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM4MDc4Mg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455380782", "bodyText": "resolve(fileName) should not return null because we get the fileNames from the indexReader. However, I can add a test case to confirm the behavior.", "author": "jmazanec15", "createdAt": "2020-07-15T21:48:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2ODUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxNDIzOA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455414238", "bodyText": "Actually, fileName has the @NotNull annotation. So it cannot be null.", "author": "jmazanec15", "createdAt": "2020-07-15T23:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2ODUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk0NTkyMg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455945922", "bodyText": "Could you point me where annotation is?", "author": "kaituo", "createdAt": "2020-07-16T17:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2ODUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk3MTk0OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455971948", "bodyText": "I see it in the source code in intellij. I think Intellij may have added the annotation.\n\nI am not sure what this implies. Do you know what this does @kaituo ?", "author": "jmazanec15", "createdAt": "2020-07-16T18:01:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2ODUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk5MzI1Nw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455993257", "bodyText": "maybe https://www.jetbrains.com/help/idea/nullable-and-notnull-annotations.html#notnull", "author": "kaituo", "createdAt": "2020-07-16T18:37:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk2ODUxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDExOTIxMA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r454119210", "bodyText": "class doc missing", "author": "vamshin", "createdAt": "2020-07-14T05:56:13Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/transport/KNNWarmupResponse.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.transport;\n+\n+import org.elasticsearch.action.support.DefaultShardOperationFailedException;\n+import org.elasticsearch.action.support.broadcast.BroadcastResponse;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+public class KNNWarmupResponse extends BroadcastResponse implements ToXContentObject {", "originalCommit": "6b592b78dbacddd2f787fd1d2da9d791ae19724a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM5MDk2OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455390968", "bodyText": "Will take care.", "author": "jmazanec15", "createdAt": "2020-07-15T22:02:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDExOTIxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDExOTI3OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r454119278", "bodyText": "class doc missing. You might want to take care in other places as wel", "author": "vamshin", "createdAt": "2020-07-14T05:56:26Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/transport/KNNWarmupRequest.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.transport;\n+\n+import org.elasticsearch.action.support.broadcast.BroadcastRequest;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+\n+import java.io.IOException;\n+\n+public class KNNWarmupRequest extends BroadcastRequest<KNNWarmupRequest> {", "originalCommit": "6b592b78dbacddd2f787fd1d2da9d791ae19724a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM5MDg5Mw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455390893", "bodyText": "Will take care of it thanks.", "author": "jmazanec15", "createdAt": "2020-07-15T22:02:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDExOTI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyMDEyMQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r454120121", "bodyText": "+1 for making it async.\nwe could log here saying that warm up initiated. Should we capture the number of warmup requests in the knn stats?", "author": "vamshin", "createdAt": "2020-07-14T05:59:02Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/rest/RestKNNWarmupHandler.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.rest;\n+\n+import com.amazon.opendistroforelasticsearch.knn.common.exception.KNNInvalidIndexException;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.KNNPlugin;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.transport.KNNWarmupAction;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.transport.KNNWarmupRequest;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.index.Index;\n+import org.elasticsearch.rest.BaseRestHandler;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.amazon.opendistroforelasticsearch.knn.index.KNNSettings.KNN_INDEX;\n+import static org.elasticsearch.action.support.IndicesOptions.strictExpandOpen;\n+\n+/**\n+ * RestHandler for k-NN index warmup API. API provides the ability for a user to load specific indices' k-NN graphs\n+ * into memory.\n+ */\n+public class RestKNNWarmupHandler extends BaseRestHandler {\n+    public static String NAME = \"knn_warmup_action\";\n+\n+    private IndexNameExpressionResolver indexNameExpressionResolver;\n+    private ClusterService clusterService;\n+\n+    public RestKNNWarmupHandler(Settings settings, RestController controller, ClusterService clusterService,\n+                                IndexNameExpressionResolver indexNameExpressionResolver) {\n+        this.clusterService = clusterService;\n+        this.indexNameExpressionResolver = indexNameExpressionResolver;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public List<Route> routes() {\n+        return ImmutableList.of(\n+                new Route(RestRequest.Method.GET, KNNPlugin.KNN_BASE_URI + \"/warmup/{index}\")\n+        );\n+    }\n+\n+    @Override\n+    protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient client) {\n+        KNNWarmupRequest knnWarmupRequest = createKNNWarmupRequest(request);\n+        return channel -> client.execute(KNNWarmupAction.INSTANCE, knnWarmupRequest, new RestToXContentListener<>(channel));", "originalCommit": "6b592b78dbacddd2f787fd1d2da9d791ae19724a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwODc2NQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455408765", "bodyText": "I can add the log statement. I am not sure if it is useful to know how many warmup requests there have been.", "author": "jmazanec15", "createdAt": "2020-07-15T22:49:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyMDEyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyMTI2Ng==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r454121266", "bodyText": "We could update log to tell the exact setting name. How about below message\n\nthrow new KNNInvalidIndexException(index.getName(),\n\"Warmup request rejected as one of the index has 'index.knn' setting set to false\");\n\n\nShould we loop through the indices and mention full list of indices that are invalid instead of exiting on the first error?\n\n\nHow about making indexNames from String array to set and pass this as a ImmutableSet to KNNWarmupRequest. This was we could avoid duplicates.", "author": "vamshin", "createdAt": "2020-07-14T06:02:16Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/rest/RestKNNWarmupHandler.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.rest;\n+\n+import com.amazon.opendistroforelasticsearch.knn.common.exception.KNNInvalidIndexException;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.KNNPlugin;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.transport.KNNWarmupAction;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.transport.KNNWarmupRequest;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.index.Index;\n+import org.elasticsearch.rest.BaseRestHandler;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.amazon.opendistroforelasticsearch.knn.index.KNNSettings.KNN_INDEX;\n+import static org.elasticsearch.action.support.IndicesOptions.strictExpandOpen;\n+\n+/**\n+ * RestHandler for k-NN index warmup API. API provides the ability for a user to load specific indices' k-NN graphs\n+ * into memory.\n+ */\n+public class RestKNNWarmupHandler extends BaseRestHandler {\n+    public static String NAME = \"knn_warmup_action\";\n+\n+    private IndexNameExpressionResolver indexNameExpressionResolver;\n+    private ClusterService clusterService;\n+\n+    public RestKNNWarmupHandler(Settings settings, RestController controller, ClusterService clusterService,\n+                                IndexNameExpressionResolver indexNameExpressionResolver) {\n+        this.clusterService = clusterService;\n+        this.indexNameExpressionResolver = indexNameExpressionResolver;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public List<Route> routes() {\n+        return ImmutableList.of(\n+                new Route(RestRequest.Method.GET, KNNPlugin.KNN_BASE_URI + \"/warmup/{index}\")\n+        );\n+    }\n+\n+    @Override\n+    protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient client) {\n+        KNNWarmupRequest knnWarmupRequest = createKNNWarmupRequest(request);\n+        return channel -> client.execute(KNNWarmupAction.INSTANCE, knnWarmupRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    private KNNWarmupRequest createKNNWarmupRequest(RestRequest request) {\n+        String[] indexNames = Strings.splitStringByCommaToArray(request.param(\"index\"));\n+        Index[] indices =  indexNameExpressionResolver.concreteIndices(clusterService.state(), strictExpandOpen(),\n+                indexNames);\n+\n+        Arrays.stream(indices).forEach(index -> {\n+            if (!\"true\".equals(clusterService.state().metadata().getIndexSafe(index).getSettings().get(KNN_INDEX))) {\n+                throw new KNNInvalidIndexException(index.getName(),\n+                        \"Unable to create warmup index that has 'knn' setting set to false\");", "originalCommit": "6b592b78dbacddd2f787fd1d2da9d791ae19724a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM5MDgyMg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455390822", "bodyText": "Makes sense\nYes, I think that would be better design.\nYes that makes sense. Will change that.", "author": "jmazanec15", "createdAt": "2020-07-15T22:02:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyMTI2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkwODgzMw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455908833", "bodyText": "For Point 3, KNNWarmupRequest extends BroadcastRequest which takes an array of indices. So, I do not think I should modify that. Additionally, KNNWarmupTransportAction extends TransportBroadcastByNodeAction, which deduplicates the indices here, so I am not sure change 3 is necessary.", "author": "jmazanec15", "createdAt": "2020-07-16T16:17:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyMTI2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk0Nzk2NA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455947964", "bodyText": "For 1, do we want to return the index name that has 'index.knn' setting to be false?", "author": "kaituo", "createdAt": "2020-07-16T17:21:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyMTI2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxMTQ1NQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r456011455", "bodyText": "Correct. Actually list of index names that have index.knn setting to false.", "author": "vamshin", "createdAt": "2020-07-16T19:10:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyMTI2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyMjY5OQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r454122699", "bodyText": "if indexNames empty, return from here with proper log message?", "author": "vamshin", "createdAt": "2020-07-14T06:06:21Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/rest/RestKNNWarmupHandler.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.plugin.rest;\n+\n+import com.amazon.opendistroforelasticsearch.knn.common.exception.KNNInvalidIndexException;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.KNNPlugin;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.transport.KNNWarmupAction;\n+import com.amazon.opendistroforelasticsearch.knn.plugin.transport.KNNWarmupRequest;\n+import com.google.common.collect.ImmutableList;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.index.Index;\n+import org.elasticsearch.rest.BaseRestHandler;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.amazon.opendistroforelasticsearch.knn.index.KNNSettings.KNN_INDEX;\n+import static org.elasticsearch.action.support.IndicesOptions.strictExpandOpen;\n+\n+/**\n+ * RestHandler for k-NN index warmup API. API provides the ability for a user to load specific indices' k-NN graphs\n+ * into memory.\n+ */\n+public class RestKNNWarmupHandler extends BaseRestHandler {\n+    public static String NAME = \"knn_warmup_action\";\n+\n+    private IndexNameExpressionResolver indexNameExpressionResolver;\n+    private ClusterService clusterService;\n+\n+    public RestKNNWarmupHandler(Settings settings, RestController controller, ClusterService clusterService,\n+                                IndexNameExpressionResolver indexNameExpressionResolver) {\n+        this.clusterService = clusterService;\n+        this.indexNameExpressionResolver = indexNameExpressionResolver;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public List<Route> routes() {\n+        return ImmutableList.of(\n+                new Route(RestRequest.Method.GET, KNNPlugin.KNN_BASE_URI + \"/warmup/{index}\")\n+        );\n+    }\n+\n+    @Override\n+    protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient client) {\n+        KNNWarmupRequest knnWarmupRequest = createKNNWarmupRequest(request);\n+        return channel -> client.execute(KNNWarmupAction.INSTANCE, knnWarmupRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    private KNNWarmupRequest createKNNWarmupRequest(RestRequest request) {\n+        String[] indexNames = Strings.splitStringByCommaToArray(request.param(\"index\"));", "originalCommit": "6b592b78dbacddd2f787fd1d2da9d791ae19724a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM5MDM5Nw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455390397", "bodyText": "Will add this check.", "author": "jmazanec15", "createdAt": "2020-07-15T22:01:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyMjY5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk0MDM5OQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455940399", "bodyText": "Actually, because I only register this route, it is impossible to pass in no indices. Instead, it fails with the following:\ncurl ${HOST_NAME}/_opendistro/_knn/warmup?pretty\n{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"illegal_argument_exception\",\n        \"reason\" : \"request [/_opendistro/_knn/warmup] contains unrecognized parameter: [nodeId]\"\n      }\n    ],\n    \"type\" : \"illegal_argument_exception\",\n    \"reason\" : \"request [/_opendistro/_knn/warmup] contains unrecognized parameter: [nodeId]\"\n  },\n  \"status\" : 400\n}\n\nIt actually does not reach this rest handler. Is this okay?", "author": "jmazanec15", "createdAt": "2020-07-16T17:09:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyMjY5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAwNzI3OA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r456007278", "bodyText": "makes sense. Thanks", "author": "vamshin", "createdAt": "2020-07-16T19:02:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyMjY5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyNDMxNQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r454124315", "bodyText": "is getRestHandlers always called after getMappers? Making sure clusterService is not null.", "author": "vamshin", "createdAt": "2020-07-14T06:10:49Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/plugin/KNNPlugin.java", "diffHunk": "@@ -143,8 +148,10 @@\n                                              Supplier<DiscoveryNodes> nodesInCluster) {\n \n         RestKNNStatsHandler restKNNStatsHandler = new RestKNNStatsHandler(settings, restController, knnStats);\n+        RestKNNWarmupHandler restKNNWarmupHandler = new RestKNNWarmupHandler(settings, restController, clusterService,", "originalCommit": "6b592b78dbacddd2f787fd1d2da9d791ae19724a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM4OTEwNg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455389106", "bodyText": "Do you mean createComponents, not getMappers?\nAnd yes\n\ncreateComponents\ngetRestHandlers", "author": "jmazanec15", "createdAt": "2020-07-15T21:58:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyNDMxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM5NTY4Nw==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455395687", "bodyText": "Sorry. I meant CreateComponent. Thanks for confirming.", "author": "vamshin", "createdAt": "2020-07-15T22:14:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyNDMxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyNzIzOA==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r454127238", "bodyText": "move searcher.close() to finally block and you could remove from catch", "author": "vamshin", "createdAt": "2020-07-14T06:18:29Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/knn/index/KNNIndexShard.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ *   Licensed under the Apache License, Version 2.0 (the \"License\").\n+ *   You may not use this file except in compliance with the License.\n+ *   A copy of the License is located at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *   or in the \"license\" file accompanying this file. This file is distributed\n+ *   on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ *   express or implied. See the License for the specific language governing\n+ *   permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.knn.index;\n+\n+import com.amazon.opendistroforelasticsearch.knn.index.codec.KNNCodecUtil;\n+import com.amazon.opendistroforelasticsearch.knn.index.v1736.KNNIndex;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.lucene.index.FilterLeafReader;\n+import org.apache.lucene.index.IndexReader;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.index.SegmentInfo;\n+import org.apache.lucene.index.SegmentReader;\n+import org.elasticsearch.index.engine.Engine;\n+import org.elasticsearch.index.shard.IndexShard;\n+import org.elasticsearch.index.shard.ShardPath;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * KNNIndexShard wraps IndexShard and adds methods to perform k-NN related operations against the shard\n+ */\n+public class KNNIndexShard {\n+    private IndexShard indexShard;\n+    private KNNIndexCache knnIndexCache;\n+\n+    private static Logger logger = LogManager.getLogger(KNNIndexShard.class);\n+\n+    /**\n+     * Constructor to generate KNNIndexShard. We do not perform validation that the Index the IndexShard is from\n+     * is in fact a k-NN Index (index.knn = true). This may make sense to add later, but for now the operations for\n+     * KNNIndexShards that are not from a k-NN index should be no-ops.\n+     *\n+     * @param indexShard IndexShard to be wrapped.\n+     */\n+    public KNNIndexShard(IndexShard indexShard) {\n+        this.indexShard = indexShard;\n+        this.knnIndexCache = KNNIndexCache.getInstance();\n+    }\n+\n+    /**\n+     * Return the underlying IndexShard\n+     *\n+     * @return IndexShard\n+     */\n+    public IndexShard getIndexShard() {\n+        return indexShard;\n+    }\n+\n+    /**\n+     * Return the name of the shards index\n+     *\n+     * @return Name of shard's index\n+     */\n+    public String getIndexName() {\n+        return indexShard.shardId().getIndexName();\n+    }\n+\n+    /**\n+     * Load all of the HNSW graphs for this shard into the cache. Note that getIndices is called to prevent loading\n+     * in duplicates.\n+     *\n+     * @return a List of KNNIndex's from this shard that are in the cache after this operation.\n+     * @throws IOException Thrown when getting the HNSW Paths to be loaded in\n+     */\n+    public List<KNNIndex> warmup() throws IOException {\n+        logger.info(\"[KNN] Warming up index: \" + getIndexName());\n+        Engine.Searcher searcher = indexShard.acquireSearcher(\"knn-warmup\");\n+        List<KNNIndex> indices;\n+        try {\n+            indices = knnIndexCache.getIndices(getHNSWPaths(searcher.getIndexReader()), getIndexName());\n+            searcher.close();", "originalCommit": "6b592b78dbacddd2f787fd1d2da9d791ae19724a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM3NjA4Mg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r455376082", "bodyText": "Good suggestion. Will update", "author": "jmazanec15", "createdAt": "2020-07-15T21:43:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyNzIzOA=="}], "type": "inlineReview"}, {"oid": "bd541947f88aca92c0a759bc8bae300f589922ae", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/bd541947f88aca92c0a759bc8bae300f589922ae", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/k-NN into warmup", "committedDate": "2020-07-15T21:19:18Z", "type": "commit"}, {"oid": "c60cd080a5be02c531c10f3bfc0d1401a303d5dc", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/c60cd080a5be02c531c10f3bfc0d1401a303d5dc", "message": "add end line to file", "committedDate": "2020-07-15T22:56:38Z", "type": "commit"}, {"oid": "5859f19bbafc6e89e2987d08e8a2eef66065211b", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/5859f19bbafc6e89e2987d08e8a2eef66065211b", "message": "minor style/comment fixes", "committedDate": "2020-07-15T23:05:47Z", "type": "commit"}, {"oid": "f9a29b1eec81ae90e845259260c7d58ac2afa508", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/f9a29b1eec81ae90e845259260c7d58ac2afa508", "message": "added class doc", "committedDate": "2020-07-15T23:42:37Z", "type": "commit"}, {"oid": "5e01bcf9176c04348eb96683068617e7250c8726", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/5e01bcf9176c04348eb96683068617e7250c8726", "message": "added end lines", "committedDate": "2020-07-15T23:45:17Z", "type": "commit"}, {"oid": "219fe2fed478ebc1be583a994a89bd9b7ad8e7de", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/219fe2fed478ebc1be583a994a89bd9b7ad8e7de", "message": "enhanced logging and exception", "committedDate": "2020-07-16T17:21:38Z", "type": "commit"}, {"oid": "477f35781bb1f92a0ab3ef5257906dde3aecea32", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/477f35781bb1f92a0ab3ef5257906dde3aecea32", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/k-NN into warmup", "committedDate": "2020-07-16T17:21:49Z", "type": "commit"}, {"oid": "b5aa1e6f0d44511b2bd71b6e4170199d3d59b9af", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/b5aa1e6f0d44511b2bd71b6e4170199d3d59b9af", "message": "update NMSLIB version", "committedDate": "2020-07-16T18:01:32Z", "type": "commit"}, {"oid": "843527ee357161bad89ee96c24ba925d33baff26", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/843527ee357161bad89ee96c24ba925d33baff26", "message": "updated README with warmup API info", "committedDate": "2020-07-16T21:16:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA4NjU1MQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r456086551", "bodyText": "Minor: In places where we mention memory should we be explicit calling native memory or off-heap to set context where the graphs are actually loaded?", "author": "vamshin", "createdAt": "2020-07-16T21:24:41Z", "path": "README.md", "diffHunk": "@@ -404,6 +404,35 @@ GET /_opendistro/_knn/HYMrXXsBSamUkcAjhjeN0w/stats/circuit_breaker_triggered,gra\n }\n ```\n \n+## Warmup API\n+### Overview\n+The HNSW graphs used to perform k-Approximate Nearest Neighbor Search are stored as `.hnsw` files with the other Lucene segment files. In order to perform search on these graphs, they need to be loaded into memory. If the graphs have not yet been loaded into memory, upon search, they will first be loaded and then searched. This can cause high latency during initial queries. To avoid this, users will often run random queries during a warmup period. After this warmup period, the graphs will be loaded into memory and their production workloads can begin. This process is indirect and requires extra effort. ", "originalCommit": "843527ee357161bad89ee96c24ba925d33baff26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA4NzM0Ng==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r456087346", "bodyText": "Sure, will update", "author": "jmazanec15", "createdAt": "2020-07-16T21:26:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA4NjU1MQ=="}], "type": "inlineReview"}, {"oid": "379bd4e04ceddd6c3c16dece8bd0b16f2727ce34", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/379bd4e04ceddd6c3c16dece8bd0b16f2727ce34", "message": "minor change to warmup API documentation", "committedDate": "2020-07-16T21:28:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA5MDk0Mg==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r456090942", "bodyText": "Should we also call out Idempotency with the warmup api? warmup api ensures only the graphs belonging to the segments that did not get loaded are loaded to memory. Existing graphs would be untouched?", "author": "vamshin", "createdAt": "2020-07-16T21:34:18Z", "path": "README.md", "diffHunk": "@@ -404,6 +404,35 @@ GET /_opendistro/_knn/HYMrXXsBSamUkcAjhjeN0w/stats/circuit_breaker_triggered,gra\n }\n ```\n \n+## Warmup API\n+### Overview\n+The HNSW graphs used to perform k-Approximate Nearest Neighbor Search are stored as `.hnsw` files with the other Lucene segment files. In order to perform search on these graphs, they need to be loaded into native memory. If the graphs have not yet been loaded into native memory, upon search, they will first be loaded and then searched. This can cause high latency during initial queries. To avoid this, users will often run random queries during a warmup period. After this warmup period, the graphs will be loaded into native memory and their production workloads can begin. This process is indirect and requires extra effort. ", "originalCommit": "379bd4e04ceddd6c3c16dece8bd0b16f2727ce34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjEwNjAwOQ==", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/pull/162#discussion_r456106009", "bodyText": "Sure, I can call this out.", "author": "jmazanec15", "createdAt": "2020-07-16T22:07:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA5MDk0Mg=="}], "type": "inlineReview"}, {"oid": "4b08b20cb7db4ef855a06780ce0c962a19a6be61", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/4b08b20cb7db4ef855a06780ce0c962a19a6be61", "message": "update warmup api docs", "committedDate": "2020-07-16T22:09:42Z", "type": "commit"}, {"oid": "6ce10088574171b4a6d6213f21be48039754921a", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/6ce10088574171b4a6d6213f21be48039754921a", "message": "Merge branch 'master' of https://github.com/opendistro-for-elasticsearch/k-NN into warmup", "committedDate": "2020-07-20T20:57:42Z", "type": "commit"}, {"oid": "b465e1010b10cdfc2b319bc66cf4ed69e7b1c9f8", "url": "https://github.com/opendistro-for-elasticsearch/k-NN/commit/b465e1010b10cdfc2b319bc66cf4ed69e7b1c9f8", "message": "clean up loadIndex", "committedDate": "2020-07-21T05:36:09Z", "type": "commit"}]}