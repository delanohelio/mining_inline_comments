{"pr_number": 529, "pr_title": "Add openid connect quickstart test", "pr_createdAt": "2020-04-17T16:13:13Z", "pr_url": "https://github.com/quarkusio/quarkus-quickstarts/pull/529", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDgzNjI1Ng==", "url": "https://github.com/quarkusio/quarkus-quickstarts/pull/529#discussion_r410836256", "bodyText": "Wondering if this property can use a random port (and set by a Quarkus Test Resource)", "author": "cescoffier", "createdAt": "2020-04-19T07:06:54Z", "path": "security-oauth2-quickstart/src/main/resources/application.properties", "diffHunk": "@@ -1,3 +1,4 @@\n-quarkus.oauth2.client-id=client_id\n+quarkus.oauth2.enabled=true\n+quarkus.oauth2.client-id=backend-service\n quarkus.oauth2.client-secret=secret\n-quarkus.oauth2.introspection-url=http://oauth-server/introspect\n\\ No newline at end of file\n+quarkus.oauth2.introspection-url=http://localhost:8180/auth/realms/quarkus/protocol/openid-connect/token/introspect", "originalCommit": "04bead224a4764e09a1230685776e9b98467d2b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYwMjkwOQ==", "url": "https://github.com/quarkusio/quarkus-quickstarts/pull/529#discussion_r411602909", "bodyText": "This configuration is overwritten during at QuarkusTestResource creation. I was not able to delete this configuration because the following error occurs if not written.\nio.quarkus.runtime.configuration.ConfigurationException: client-id, client-secret and introspection-url must be configured when the oauth2 extension is enabled\n\nI was able to set port via a QuarkusTestResource\nhttps://github.com/cemnura/quarkus-quickstarts/blob/156a80d7f3a07e04b2c06d2aa9e11d88efad2960/security-oauth2-quickstart/src/test/java/org/acme/security/oauth2/KeycloakResource.java#L15-L27", "author": "cemnura", "createdAt": "2020-04-20T18:37:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDgzNjI1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDgzNjQ4MQ==", "url": "https://github.com/quarkusio/quarkus-quickstarts/pull/529#discussion_r410836481", "bodyText": "So we cannot use TestContainer like this, as the lifecycle is different from the Quarkus lifecycle.\nYou need to use a Quarkus Test Resource, and BTW, it will also let you set some properties dynamically.\nCheck how the Kafka quickstart is built as an example.", "author": "cescoffier", "createdAt": "2020-04-19T07:08:19Z", "path": "security-oauth2-quickstart/src/test/java/org/acme/security/oauth2/TokenSecuredResourceTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.acme.security.oauth2;\n+\n+import io.quarkus.test.junit.QuarkusTest;\n+import io.restassured.RestAssured;\n+import org.junit.ClassRule;\n+import org.junit.jupiter.api.Test;\n+import org.testcontainers.containers.BindMode;\n+import org.testcontainers.containers.FixedHostPortGenericContainer;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.junit.jupiter.Container;\n+import org.testcontainers.junit.jupiter.Testcontainers;\n+\n+@Testcontainers\n+@QuarkusTest\n+public class TokenSecuredResourceTest {\n+\n+    private static final String KEYCLOAK_SERVER_URL = System.getProperty(\"keycloak.url\", \"http://localhost:8180/auth\");", "originalCommit": "04bead224a4764e09a1230685776e9b98467d2b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDg2MzY4OQ==", "url": "https://github.com/quarkusio/quarkus-quickstarts/pull/529#discussion_r410863689", "bodyText": "I will check how the Kafka quickstart is built.", "author": "cemnura", "createdAt": "2020-04-19T09:39:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDgzNjQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDgzNjYyOQ==", "url": "https://github.com/quarkusio/quarkus-quickstarts/pull/529#discussion_r410836629", "bodyText": "This should be moved to a Quarkus Test Resources, and probably bound to a free port.\nAlso, I'm surprised about @ClassRule as it's a Junit 4 annotation.", "author": "cescoffier", "createdAt": "2020-04-19T07:09:18Z", "path": "security-oauth2-quickstart/src/test/java/org/acme/security/oauth2/TokenSecuredResourceTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.acme.security.oauth2;\n+\n+import io.quarkus.test.junit.QuarkusTest;\n+import io.restassured.RestAssured;\n+import org.junit.ClassRule;\n+import org.junit.jupiter.api.Test;\n+import org.testcontainers.containers.BindMode;\n+import org.testcontainers.containers.FixedHostPortGenericContainer;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.junit.jupiter.Container;\n+import org.testcontainers.junit.jupiter.Testcontainers;\n+\n+@Testcontainers\n+@QuarkusTest\n+public class TokenSecuredResourceTest {\n+\n+    private static final String KEYCLOAK_SERVER_URL = System.getProperty(\"keycloak.url\", \"http://localhost:8180/auth\");\n+    private static final String KEYCLOAK_REALM = \"quarkus\";\n+\n+    @ClassRule\n+    @Container\n+    private static GenericContainer keycloak = new FixedHostPortGenericContainer(\"quay.io/keycloak/keycloak:9.0.3\")", "originalCommit": "04bead224a4764e09a1230685776e9b98467d2b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDg2MzQ1NA==", "url": "https://github.com/quarkusio/quarkus-quickstarts/pull/529#discussion_r410863454", "bodyText": "Okey I will move try to move this and try to bound to a free port.\nYes you are correct @ClassRule is a Junit4 annotation. I misread the testcontainer documentation. I will be removing this in general.", "author": "cemnura", "createdAt": "2020-04-19T09:38:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDgzNjYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDgzNjc1Nw==", "url": "https://github.com/quarkusio/quarkus-quickstarts/pull/529#discussion_r410836757", "bodyText": "What the goal of this file?", "author": "cescoffier", "createdAt": "2020-04-19T07:10:16Z", "path": "security-oauth2-quickstart/src/test/resources/.notes", "diffHunk": "@@ -0,0 +1,66 @@\n+curl -X POST \\", "originalCommit": "04bead224a4764e09a1230685776e9b98467d2b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDg2MjQ2Nw==", "url": "https://github.com/quarkusio/quarkus-quickstarts/pull/529#discussion_r410862467", "bodyText": "These where my notes when developing this qucikstart. I thought that I may improve the documentation using these commands.", "author": "cemnura", "createdAt": "2020-04-19T09:33:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDgzNjc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYwMzMwNA==", "url": "https://github.com/quarkusio/quarkus-quickstarts/pull/529#discussion_r411603304", "bodyText": "I will delete these files when I am going to squash commits.", "author": "cemnura", "createdAt": "2020-04-20T18:37:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDgzNjc1Nw=="}], "type": "inlineReview"}, {"oid": "a71bc157aea5662057235d503ef7bc1e761e0579", "url": "https://github.com/quarkusio/quarkus-quickstarts/commit/a71bc157aea5662057235d503ef7bc1e761e0579", "message": "Added test for security-oauth2-quickstart\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-04-20T08:58:36Z", "type": "forcePushed"}, {"oid": "156a80d7f3a07e04b2c06d2aa9e11d88efad2960", "url": "https://github.com/quarkusio/quarkus-quickstarts/commit/156a80d7f3a07e04b2c06d2aa9e11d88efad2960", "message": "Added test for security-oauth2-quickstart\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-04-20T18:33:41Z", "type": "forcePushed"}, {"oid": "c66b83b5aaf1cba3353dc99ef4e0fdf416653346", "url": "https://github.com/quarkusio/quarkus-quickstarts/commit/c66b83b5aaf1cba3353dc99ef4e0fdf416653346", "message": "Added openid connect quickstart test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-10-10T21:25:21Z", "type": "forcePushed"}, {"oid": "7366b62f104951d73a4a7cd8583bed665a5c5412", "url": "https://github.com/quarkusio/quarkus-quickstarts/commit/7366b62f104951d73a4a7cd8583bed665a5c5412", "message": "Added openid connect quickstart test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-10-10T21:31:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjgzNDM1NA==", "url": "https://github.com/quarkusio/quarkus-quickstarts/pull/529#discussion_r502834354", "bodyText": "@sberyozkin  This is a demo Keycloak mock server using WireMock for evaluation. Is missing protocol/openid-connect/token path mock.", "author": "cemnura", "createdAt": "2020-10-10T21:30:52Z", "path": "security-openid-connect-quickstart/src/test/java/org/acme/security/openid/connect/KeycloakTestResource.java", "diffHunk": "@@ -0,0 +1,92 @@\n+package org.acme.security.openid.connect;\n+\n+import com.github.tomakehurst.wiremock.WireMockServer;\n+import com.github.tomakehurst.wiremock.client.WireMock;\n+import io.quarkus.test.common.QuarkusTestResourceLifecycleManager;\n+\n+import javax.ws.rs.core.MediaType;\n+import java.util.Collections;\n+import java.util.Map;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;\n+import static com.github.tomakehurst.wiremock.client.WireMock.get;\n+import static com.github.tomakehurst.wiremock.client.WireMock.post;\n+import static com.github.tomakehurst.wiremock.client.WireMock.stubFor;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlEqualTo;\n+import static com.github.tomakehurst.wiremock.core.WireMockConfiguration.options;\n+\n+public class KeycloakTestResource implements QuarkusTestResourceLifecycleManager {", "originalCommit": "c66b83b5aaf1cba3353dc99ef4e0fdf416653346", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzNzY5NA==", "url": "https://github.com/quarkusio/quarkus-quickstarts/pull/529#discussion_r503537694", "bodyText": "I have deleted this class from this PR and moving it to the main quarkus repository", "author": "cemnura", "createdAt": "2020-10-12T21:20:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjgzNDM1NA=="}], "type": "inlineReview"}, {"oid": "c2d0cb2643dbcca986b8466281173baf588a350b", "url": "https://github.com/quarkusio/quarkus-quickstarts/commit/c2d0cb2643dbcca986b8466281173baf588a350b", "message": "Added openid connect quickstart test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-10-12T21:18:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA5MjQ2Mg==", "url": "https://github.com/quarkusio/quarkus-quickstarts/pull/529#discussion_r504092462", "bodyText": "@cemnura Can you please have a single test class (say BearerTokenAuthenticationTest) combining both admin and user resources tests - to have KC started and stopped once and avoid some instability.", "author": "sberyozkin", "createdAt": "2020-10-13T16:27:41Z", "path": "security-openid-connect-quickstart/src/test/java/org/acme/security/openid/connect/UsersResourceTest.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package org.acme.security.openid.connect;\n+\n+import io.quarkus.test.common.QuarkusTestResource;\n+import io.quarkus.test.junit.QuarkusTest;\n+import io.restassured.RestAssured;\n+import org.eclipse.microprofile.config.inject.ConfigProperty;\n+import org.junit.jupiter.api.Test;\n+\n+@QuarkusTest\n+@QuarkusTestResource(KeycloakServer.class)\n+public class UsersResourceTest {", "originalCommit": "c2d0cb2643dbcca986b8466281173baf588a350b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIyNDY5MA==", "url": "https://github.com/quarkusio/quarkus-quickstarts/pull/529#discussion_r504224690", "bodyText": "@sberyozkin gladly. Resolving ASAP.", "author": "cemnura", "createdAt": "2020-10-13T20:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA5MjQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMwNzI4NQ==", "url": "https://github.com/quarkusio/quarkus-quickstarts/pull/529#discussion_r504307285", "bodyText": "I combined the test classes into one class being BearerTokenAuthenticationTest.", "author": "cemnura", "createdAt": "2020-10-13T23:03:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA5MjQ2Mg=="}], "type": "inlineReview"}, {"oid": "d4b2ff1a2bf620f350c105f233a56eb9fb79c371", "url": "https://github.com/quarkusio/quarkus-quickstarts/commit/d4b2ff1a2bf620f350c105f233a56eb9fb79c371", "message": "Added openid connect quickstart test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-10-13T22:15:30Z", "type": "forcePushed"}, {"oid": "7571170100331b7067471e8adde056327cc5d61e", "url": "https://github.com/quarkusio/quarkus-quickstarts/commit/7571170100331b7067471e8adde056327cc5d61e", "message": "Added openid connect quickstart test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-10-14T11:18:33Z", "type": "forcePushed"}, {"oid": "40cdf9d981918d1b9787da242d3816831314519f", "url": "https://github.com/quarkusio/quarkus-quickstarts/commit/40cdf9d981918d1b9787da242d3816831314519f", "message": "Added openid connect quickstart test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-10-14T11:24:01Z", "type": "commit"}, {"oid": "40cdf9d981918d1b9787da242d3816831314519f", "url": "https://github.com/quarkusio/quarkus-quickstarts/commit/40cdf9d981918d1b9787da242d3816831314519f", "message": "Added openid connect quickstart test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-10-14T11:24:01Z", "type": "forcePushed"}]}