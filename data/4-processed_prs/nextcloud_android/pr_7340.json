{"pr_number": 7340, "pr_title": "Directly start foreground service", "pr_createdAt": "2020-11-17T11:08:50Z", "pr_url": "https://github.com/nextcloud/android/pull/7340", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5MzU5MQ==", "url": "https://github.com/nextcloud/android/pull/7340#discussion_r525593591", "bodyText": "This is nasty. But if we need this workaround, I'd put it in onCreate().", "author": "ezaquarii", "createdAt": "2020-11-17T23:28:17Z", "path": "src/main/java/com/nextcloud/client/media/PlayerService.kt", "diffHunk": "@@ -101,6 +101,13 @@ class PlayerService : Service() {\n         stop.action = ACTION_STOP\n         val pendingStop = PendingIntent.getService(this, 0, stop, 0)\n         notificationBuilder.addAction(0, \"STOP\", pendingStop)\n+\n+        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.O) {", "originalCommit": "41dcb04a13591a3efd35a4dc8fbb1ef51c1a593c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg2Mzg0NQ==", "url": "https://github.com/nextcloud/android/pull/7340#discussion_r525863845", "bodyText": "True, this is not meant to be the final version.\nI just did a quick PR for testing, so that user can give feedback.", "author": "tobiasKaminsky", "createdAt": "2020-11-18T07:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5MzU5MQ=="}], "type": "inlineReview"}, {"oid": "8f17962bd8bcd9c5390b897798f3cf3ecdaa7f56", "url": "https://github.com/nextcloud/android/commit/8f17962bd8bcd9c5390b897798f3cf3ecdaa7f56", "message": "Fix falsely starting player service when previewing video\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-11-18T07:48:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE0MDQ0OA==", "url": "https://github.com/nextcloud/android/pull/7340#discussion_r527140448", "bodyText": "This looks like a solution for this case.\nHowever, because stopAudio() results in Intent being sent to a service and thus it starts the service, the call is simply not safe to use in other places. I think we should internally call Service.stopSelf() if there is nothing to play as well.", "author": "ezaquarii", "createdAt": "2020-11-19T19:24:10Z", "path": "src/main/java/com/owncloud/android/ui/preview/PreviewMediaFragment.java", "diffHunk": "@@ -324,7 +324,9 @@ public void onStart() {\n                 mMultiListContainer.setVisibility(View.GONE);\n                 mPreviewContainer.setVisibility(View.VISIBLE);\n             } else if (MimeTypeUtil.isVideo(file)) {\n-                stopAudio();\n+                if (mMediaPlayerServiceConnection.isConnected() && mMediaPlayerServiceConnection.isPlaying()) {\n+                    stopAudio();\n+                }", "originalCommit": "8f17962bd8bcd9c5390b897798f3cf3ecdaa7f56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUxNTIzNw==", "url": "https://github.com/nextcloud/android/pull/7340#discussion_r527515237", "bodyText": "In PreviewMediaFragment onStart() I tried to bind to an existing player service.\nReason is:\n\nstart a long audio file\nstart a video\naudio stops, video sound is played, but audio notification is still there (and cannot be resumed)\n\nSo my quick idea was to bind to audio service when starting video and stop audio service.\nBut this does not work.", "author": "tobiasKaminsky", "createdAt": "2020-11-20T08:17:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE0MDQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUyMDYwNg==", "url": "https://github.com/nextcloud/android/pull/7340#discussion_r527520606", "bodyText": "Fixed with adding a \"play/pause\" button.", "author": "tobiasKaminsky", "createdAt": "2020-11-20T08:27:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE0MDQ0OA=="}], "type": "inlineReview"}, {"oid": "be223883c230e0f946944da1660204aaf27201e1", "url": "https://github.com/nextcloud/android/commit/be223883c230e0f946944da1660204aaf27201e1", "message": "Fix falsely starting player service when previewing video\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-11-20T08:39:38Z", "type": "commit"}, {"oid": "343561a013c3fdbe84fc71f2ab3db786e54dfbbf", "url": "https://github.com/nextcloud/android/commit/343561a013c3fdbe84fc71f2ab3db786e54dfbbf", "message": "Add toggle function\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-11-20T08:39:38Z", "type": "commit"}, {"oid": "343561a013c3fdbe84fc71f2ab3db786e54dfbbf", "url": "https://github.com/nextcloud/android/commit/343561a013c3fdbe84fc71f2ab3db786e54dfbbf", "message": "Add toggle function\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-11-20T08:39:38Z", "type": "forcePushed"}]}