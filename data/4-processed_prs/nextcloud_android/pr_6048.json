{"pr_number": 6048, "pr_title": "New download manager", "pr_createdAt": "2020-05-12T01:07:30Z", "pr_url": "https://github.com/nextcloud/android/pull/6048", "timeline": [{"oid": "a7248338efa5f756a29014a14dddc6000e400e4a", "url": "https://github.com/nextcloud/android/commit/a7248338efa5f756a29014a14dddc6000e400e4a", "message": "New download manager", "committedDate": "2020-05-13T00:09:21Z", "type": "forcePushed"}, {"oid": "8bf48f89244eb5a94ed23bff1406fa51d2e9d8d8", "url": "https://github.com/nextcloud/android/commit/8bf48f89244eb5a94ed23bff1406fa51d2e9d8d8", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-05-16T23:39:10Z", "type": "forcePushed"}, {"oid": "bced7e3d568c665aeafd3cc4e510b006d718a762", "url": "https://github.com/nextcloud/android/commit/bced7e3d568c665aeafd3cc4e510b006d718a762", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-05-17T00:00:47Z", "type": "forcePushed"}, {"oid": "d49295e9dd28151f45dfa428f2353987bc2d2634", "url": "https://github.com/nextcloud/android/commit/d49295e9dd28151f45dfa428f2353987bc2d2634", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-05-17T00:02:52Z", "type": "forcePushed"}, {"oid": "a59a6e01841a6d105cc425492319035d0df81423", "url": "https://github.com/nextcloud/android/commit/a59a6e01841a6d105cc425492319035d0df81423", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-05-18T22:57:33Z", "type": "forcePushed"}, {"oid": "2bd5cf7a4b21e60d9bf428f3433a881b68abad9e", "url": "https://github.com/nextcloud/android/commit/2bd5cf7a4b21e60d9bf428f3433a881b68abad9e", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-05-18T23:04:54Z", "type": "forcePushed"}, {"oid": "3570a7da862a58ceb25d6a9c96117df5543867fb", "url": "https://github.com/nextcloud/android/commit/3570a7da862a58ceb25d6a9c96117df5543867fb", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-05-19T19:11:48Z", "type": "forcePushed"}, {"oid": "70ab37d17d5862a3e611344bf630e968baf61d32", "url": "https://github.com/nextcloud/android/commit/70ab37d17d5862a3e611344bf630e968baf61d32", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-05-19T22:41:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcxMDMzNw==", "url": "https://github.com/nextcloud/android/pull/6048#discussion_r431710337", "bodyText": "This and the next 2 lines is only needed in one special case (FDA:2255), but it should not be hardcoded.", "author": "tobiasKaminsky", "createdAt": "2020-05-28T09:41:09Z", "path": "src/main/java/com/nextcloud/client/files/downloader/DownloadTask.kt", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Nextcloud Android client application\n+ *\n+ * @author Chris Narkiewicz\n+ * Copyright (C) 2020 Chris Narkiewicz <hello@ezaquarii.com>\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package com.nextcloud.client.files.downloader\n+\n+import android.content.ContentResolver\n+import android.content.Context\n+import com.nextcloud.client.core.IsCancelled\n+import com.owncloud.android.datamodel.FileDataStorageManager\n+import com.owncloud.android.datamodel.OCFile\n+import com.owncloud.android.lib.common.OwnCloudClient\n+import com.owncloud.android.operations.DownloadFileOperation\n+import com.owncloud.android.ui.fragment.OCFileListFragment\n+import com.owncloud.android.utils.MimeTypeUtil\n+import java.io.File\n+\n+/**\n+ * This runnable object encapsulates file download logic. It has been extracted to wrap\n+ * network operation and storage manager interactions, as those pose testing challenges\n+ * that cannot be addressed due to large number of dependencies.\n+ *\n+ * This design can be regarded as intermediary refactoring step.\n+ */\n+class DownloadTask(\n+    val context: Context,\n+    val contentResolver: ContentResolver,\n+    val clientProvider: () -> OwnCloudClient\n+) {\n+\n+    /**\n+     * This class is a helper factory to to keep static dependencies\n+     * injection out of the downloader instance.\n+     *\n+     * @param context Context\n+     * @param clientProvider Provide client - this must be called on background thread\n+     * @param contentResolver content resovler used to access file storage\n+     */\n+    class Factory(\n+        private val context: Context,\n+        private val clientProvider: () -> OwnCloudClient,\n+        private val contentResolver: ContentResolver\n+    ) {\n+        fun create(): DownloadTask {\n+            return DownloadTask(context, contentResolver, clientProvider)\n+        }\n+    }\n+\n+    fun download(request: Request, progress: (Int) -> Unit, isCancelled: IsCancelled): Boolean {\n+        val op = DownloadFileOperation(\n+            request.user.toPlatformAccount(),\n+            request.file,\n+            OCFileListFragment.DOWNLOAD_SEND,", "originalCommit": "70ab37d17d5862a3e611344bf630e968baf61d32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2MzY0Mg==", "url": "https://github.com/nextcloud/android/pull/6048#discussion_r435563642", "bodyText": "@tobiasKaminsky\nThe thing is that DownloadFileOperation does not use those values for anything.\nIt seems to me that it just carries them around so FileDownloader can action finished operation.\nThere is nothing wrong with that approach, but since new downloader implementation does not support sending downloaded files anywhere at this moment, we don't need those values.\nI'm also pretty sure that we won't use them in the future, because new implementation splits request, download state and download code into separate entitites and it doesn't have access to DownloadFileOperation instance, becuase download mechanism is hidden behind opaque function/lambda interface.\nAt first glance, information about post-download actions should be carried by Request and actioned in DownloaderService when downloader signals completion or failure.\nHowever, it's pretty pointless to put those hardcoded values here, so I'll add an overloaded constructor for this case.", "author": "ezaquarii", "createdAt": "2020-06-04T21:29:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcxMDMzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3MjIyMQ==", "url": "https://github.com/nextcloud/android/pull/6048#discussion_r435572221", "bodyText": "@tobiasKaminsky Let me know if you'd like to migrate more use cases to the downloader as part of this PR - in such case, we'll need to add this functionality. If this is not the case, I think we can skip it. I'm confident that the design is ready to support this feature with minimal effort when we decide migrate preview functionality to the new API.", "author": "ezaquarii", "createdAt": "2020-06-04T21:49:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcxMDMzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcxMTU5NA==", "url": "https://github.com/nextcloud/android/pull/6048#discussion_r431711594", "bodyText": "With the new approach, is this roundtrip via FDSM needed, as we already have the OCFile?", "author": "tobiasKaminsky", "createdAt": "2020-05-28T09:43:22Z", "path": "src/main/java/com/owncloud/android/ui/fragment/contactsbackup/ContactListFragment.java", "diffHunk": "@@ -497,19 +503,16 @@ public int hashCode() {\n         }\n     }\n \n-    private class DownloadFinishReceiver extends BroadcastReceiver {\n-\n-        @Override\n-        public void onReceive(Context context, Intent intent) {\n-            if (FileDownloader.getDownloadFinishMessage().equalsIgnoreCase(intent.getAction())) {\n-                String downloadedRemotePath = intent.getStringExtra(FileDownloader.EXTRA_REMOTE_PATH);\n-\n-                FileDataStorageManager storageManager = new FileDataStorageManager(user.toPlatformAccount(),\n-                                                                                   context.getContentResolver());\n-                ocFile = storageManager.getFileByPath(downloadedRemotePath);\n-                loadContactsTask.execute();\n-            }\n+    private Unit onDownloadUpdate(Download download) {\n+        final Activity activity = getActivity();\n+        if (download.getState() == DownloadState.COMPLETED && activity != null) {\n+            String downloadedRemotePath = download.getRequest().getFile().getRemotePath();\n+            FileDataStorageManager storageManager = new FileDataStorageManager(user.toPlatformAccount(),\n+                                                                               activity.getContentResolver());\n+            ocFile = storageManager.getFileByPath(downloadedRemotePath);", "originalCommit": "70ab37d17d5862a3e611344bf630e968baf61d32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEzNDQ2Nw==", "url": "https://github.com/nextcloud/android/pull/6048#discussion_r432134467", "bodyText": "OCFile in download status is part of the Request, so it's not updated.\nDownloadStatus does not carry result OCFile, but this can be changed.", "author": "ezaquarii", "createdAt": "2020-05-28T21:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcxMTU5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0OTE3MA==", "url": "https://github.com/nextcloud/android/pull/6048#discussion_r435549170", "bodyText": "@tobiasKaminsky Downloaded OCFile is now exposed in the download status.", "author": "ezaquarii", "createdAt": "2020-06-04T21:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcxMTU5NA=="}], "type": "inlineReview"}, {"oid": "a3cba24c3f8e03946b8e8714404dbd0b52c678f8", "url": "https://github.com/nextcloud/android/commit/a3cba24c3f8e03946b8e8714404dbd0b52c678f8", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-05-28T09:07:03Z", "type": "forcePushed"}, {"oid": "5ac6c0ac31131c0f8f8075207330b7a841bb723a", "url": "https://github.com/nextcloud/android/commit/5ac6c0ac31131c0f8f8075207330b7a841bb723a", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-06-04T21:03:59Z", "type": "forcePushed"}, {"oid": "13952754805d2e8573c3e6880783a45554c07ec2", "url": "https://github.com/nextcloud/android/commit/13952754805d2e8573c3e6880783a45554c07ec2", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-06-04T21:49:45Z", "type": "forcePushed"}, {"oid": "fdb55182031ec3ee24cc7b1ab44add8b4981d8e7", "url": "https://github.com/nextcloud/android/commit/fdb55182031ec3ee24cc7b1ab44add8b4981d8e7", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-06-04T21:53:13Z", "type": "forcePushed"}, {"oid": "5c8bc9c238167948a816b7725d754804301b568a", "url": "https://github.com/nextcloud/android/commit/5c8bc9c238167948a816b7725d754804301b568a", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-06-04T21:57:22Z", "type": "forcePushed"}, {"oid": "7812cceecaa86751656dc09dd3bdc4d95ae39744", "url": "https://github.com/nextcloud/android/commit/7812cceecaa86751656dc09dd3bdc4d95ae39744", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-06-04T22:02:42Z", "type": "forcePushed"}, {"oid": "168a15f2997cb5979645f5d4cf471fb2042a4743", "url": "https://github.com/nextcloud/android/commit/168a15f2997cb5979645f5d4cf471fb2042a4743", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-06-05T21:05:02Z", "type": "forcePushed"}, {"oid": "08b1fe156a93fc94a6a500bdc3994b920cac9e51", "url": "https://github.com/nextcloud/android/commit/08b1fe156a93fc94a6a500bdc3994b920cac9e51", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-06-06T14:17:39Z", "type": "forcePushed"}, {"oid": "6ed8a8814348c47dd8af01e199a907762b4a49eb", "url": "https://github.com/nextcloud/android/commit/6ed8a8814348c47dd8af01e199a907762b4a49eb", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-06-19T21:31:32Z", "type": "forcePushed"}, {"oid": "069328c04b44eceb522155e7ee15a9fa2c3bc540", "url": "https://github.com/nextcloud/android/commit/069328c04b44eceb522155e7ee15a9fa2c3bc540", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-06-20T23:40:22Z", "type": "forcePushed"}, {"oid": "3bbf7e7480e498be3b79018aaf69b6d75ea018a0", "url": "https://github.com/nextcloud/android/commit/3bbf7e7480e498be3b79018aaf69b6d75ea018a0", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-06-30T06:14:46Z", "type": "forcePushed"}, {"oid": "651801a98302e9def64230d956fa38515dd4a87e", "url": "https://github.com/nextcloud/android/commit/651801a98302e9def64230d956fa38515dd4a87e", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-06-30T06:15:22Z", "type": "forcePushed"}, {"oid": "2f19f02aa7b805fc45034a0fbe6de33647451d4c", "url": "https://github.com/nextcloud/android/commit/2f19f02aa7b805fc45034a0fbe6de33647451d4c", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-07-05T21:21:01Z", "type": "forcePushed"}, {"oid": "d528977828a09c311711ed2006113ee0c039a63d", "url": "https://github.com/nextcloud/android/commit/d528977828a09c311711ed2006113ee0c039a63d", "message": "suppress lint warning\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-07-15T12:37:07Z", "type": "forcePushed"}, {"oid": "71f398f784c8649ec4a81eab82bb426f8635cf35", "url": "https://github.com/nextcloud/android/commit/71f398f784c8649ec4a81eab82bb426f8635cf35", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-07-16T21:27:26Z", "type": "forcePushed"}, {"oid": "aba95541a46648b97ca9f51ace253f2bacd83d30", "url": "https://github.com/nextcloud/android/commit/aba95541a46648b97ca9f51ace253f2bacd83d30", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-07-16T21:49:31Z", "type": "forcePushed"}, {"oid": "d20e246314ac4832312c57e4fed6f9d8092affbb", "url": "https://github.com/nextcloud/android/commit/d20e246314ac4832312c57e4fed6f9d8092affbb", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-07-17T07:16:48Z", "type": "forcePushed"}, {"oid": "75b9fa855146d0731a5ee4ae7f7e722887cc2013", "url": "https://github.com/nextcloud/android/commit/75b9fa855146d0731a5ee4ae7f7e722887cc2013", "message": "New download manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-07-20T10:28:47Z", "type": "commit"}, {"oid": "5a9d5780180f4975075a5150087f7a3edab5faa0", "url": "https://github.com/nextcloud/android/commit/5a9d5780180f4975075a5150087f7a3edab5faa0", "message": "supprss lint warning\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-07-20T10:28:50Z", "type": "commit"}, {"oid": "5a9d5780180f4975075a5150087f7a3edab5faa0", "url": "https://github.com/nextcloud/android/commit/5a9d5780180f4975075a5150087f7a3edab5faa0", "message": "supprss lint warning\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-07-20T10:28:50Z", "type": "forcePushed"}]}