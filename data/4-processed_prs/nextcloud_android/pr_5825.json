{"pr_number": 5825, "pr_title": "send push to deck app, if installed", "pr_createdAt": "2020-04-07T14:48:32Z", "pr_url": "https://github.com/nextcloud/android/pull/5825", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk2MzQ5MQ==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r404963491", "bodyText": "should be a constant", "author": "AndyScherzinger", "createdAt": "2020-04-07T16:53:53Z", "path": "src/main/java/com/owncloud/android/jobs/NotificationJob.java", "diffHunk": "@@ -161,15 +161,31 @@ private void sendNotification(Notification notification, User user) {\n         RichObject file = notification.subjectRichParameters.get(\"file\");\n \n         Intent intent;\n-        if (file == null) {\n-            intent = new Intent(context, NotificationsActivity.class);\n+        if (\"deck\".equalsIgnoreCase(notification.app)) {", "originalCommit": "20342555f30c81da14404804b8b7a635da9d2505", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI1MzIzNQ==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r405253235", "bodyText": "True, currently this is a PoC to see if this works out with Deck\u2026\nAfter that I'll enhance code \ud83d\udc4d", "author": "tobiasKaminsky", "createdAt": "2020-04-08T04:36:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk2MzQ5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMzNzYwMQ==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409337601", "bodyText": "This is also fixed in the meantime, it's a constant in DeckNotificationHandler.", "author": "stefan-niedermann", "createdAt": "2020-04-16T07:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk2MzQ5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyMTczNw==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r407921737", "bodyText": "I am not sure if we want do make this all constants, @AndyScherzinger ?", "author": "tobiasKaminsky", "createdAt": "2020-04-14T07:27:38Z", "path": "src/main/java/com/owncloud/android/jobs/NotificationJob.java", "diffHunk": "@@ -243,6 +251,36 @@ private void sendNotification(Notification notification, User user) {\n         notificationManager.notify(notification.getNotificationId(), notificationBuilder.build());\n     }\n \n+    /**\n+     * Returns an intent to start the Deck app if it is installed. If it is not installed, it will return null.\n+     */\n+    @Nullable\n+    private Intent getDeckIntent(@NonNull final Notification notification, @NonNull final User user) {\n+        final String baseDeckApplicationId = \"it.niedermann.nextcloud.deck\";\n+        final String activityToStart = \"it.niedermann.nextcloud.deck.ui.PushNotificationActivity\";\n+        final String[] flavors = new String[]{\"\", \".play\", \".dev\"};\n+        for (String flavor : flavors) {\n+            final Intent intent = new Intent().setClassName(baseDeckApplicationId + flavor, activityToStart);\n+            if (context.getPackageManager().resolveActivity(\n+                intent, 0) != null) {\n+                Log.i(TAG, \"Found deck app flavor \\\"\" + flavor + \"\\\"\");\n+                return intent\n+                    .putExtra(\"account\", user.getAccountName())", "originalCommit": "9b1e21594eeea23156d804acaa54d6659ca57000", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3MjY5Mg==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r408372692", "bodyText": "Well, if it is kind of a key / fixed value than I'd say it should be a constant", "author": "AndyScherzinger", "createdAt": "2020-04-14T19:11:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyMTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwMzUyMw==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r408403523", "bodyText": "Entire Deck interaction should be extracted into it's own module with a well defined API.", "author": "ezaquarii", "createdAt": "2020-04-14T20:07:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyMTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2NTgzOA==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r408965838", "bodyText": "@ezaquarii what exactly do you propose? We have limited data that make actually sense to pass to a 3rd-party client. Basically the data consists of a Notification and a User-object. Some ideas:\n\nEven if Deck is currently the only 3rd-party-app subscribing to push notifications this way, i believe, that other apps will follow in the future\nDefine the API for each 3rd-party client the same by passing \"all\" the data that we have\n\nThis means one clear contract\nLetting the 3rd-party-client define the contract will result in chaos, and the main app will be the pain point to update.\nThe main app should be the provider, the consumers should have to follow\n\n\nWe could name each argument like the correspond variable name (that's how it currently is)\nInstead of reading and passing each property on its own, pass the whole objects (User is a Parcelable and Notification should be a Serializable). For users of the android-library this would make stuff even easier, because they can reuse the classes (Deck does not use android-library).\nSome kind of swagger/open-api-contract, but that seems too blown up for me", "author": "stefan-niedermann", "createdAt": "2020-04-15T16:14:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyMTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2NzA4NA==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r408967084", "bodyText": "About an own feature module: This makes sense, but i am not experienced enough with android / gradle modules to make such an integration. I tried to swap out the Deck related stuff into an own method, but i would be grateful if you could swap it out into an own module like you proposed @ezaquarii \ud83d\ude42", "author": "stefan-niedermann", "createdAt": "2020-04-15T16:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyMTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE5NTAwNg==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409195006", "bodyText": "@stefan-niedermann Let's not overengineer it. This is simply not the place to have some 3rd party plumbing, especially that this Job object will be refactored in few days (by me), and I'm vitally interested in not dealing with any extra complexities here. :)\nLet's just create a package (com.nextcloud.client.integrations or something like this) and put a class there with all Deck-specific plumbing. Let this component export a business-oriented interface that anybody who doesn't know anything about Deck can use:\ninterface Deck {\n    /**\n      * Tell us what the it does and what we can do with it\n      */ \n    fun frobnicateDeck(doughnuts: BoxOfDoughnuts)\n}\nSince I have no clue what Deck is, please treat this example as a figure of speech.\nIt just illustrates the level of complexity I'd like to see when dealing with your app.\nMaybe frobnication requires an intent with 137 magic keys and values carefully chosen during 7th full moon night, or maybe it hides a Rube Goldberg machine. We don't care here - it's sealed and maintained by somebody who knows better. As a user, all I need to know is that it expects a box of \ud83c\udf69s.\nI'd start your work from the interface design. Come up with something and we'll guide you from there.", "author": "ezaquarii", "createdAt": "2020-04-15T23:37:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyMTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIwMTQxOA==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409201418", "bodyText": "I tried to swap out the Deck related stuff into an own method,\n\nThat's a good start. Put in into a class and that's the level of sophistication that will work for us here. :)", "author": "ezaquarii", "createdAt": "2020-04-15T23:57:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyMTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI5NjA2MQ==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409296061", "bodyText": "I'll try it, thanks :)", "author": "stefan-niedermann", "createdAt": "2020-04-16T05:46:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyMTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxNDc5MQ==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409714791", "bodyText": "LGTM!", "author": "ezaquarii", "createdAt": "2020-04-16T17:07:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyMTczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMzMjA2Ng==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409332066", "bodyText": "Please have this as a separate class and file.", "author": "tobiasKaminsky", "createdAt": "2020-04-16T07:15:35Z", "path": "src/main/java/com/nextcloud/client/integration/NotificationHandler.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package com.nextcloud.client.integration;\n+\n+import android.content.Intent;\n+\n+import com.nextcloud.client.account.User;\n+import com.owncloud.android.lib.resources.notifications.models.Notification;\n+\n+import androidx.annotation.NonNull;\n+\n+public interface NotificationHandler {\n+\n+    @NonNull\n+    Intent handleNotification(@NonNull final Notification notification,\n+                              @NonNull final User user) throws AppNotInstalledException, AppCannotHandelNotificationException;\n+\n+    class AppNotInstalledException extends Exception {", "originalCommit": "783ed8353056462a0fb6b3ffb1fe24c8a6ffeb40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMzMjE5NA==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409332194", "bodyText": "Same here :-)\n(and typo in handle)", "author": "tobiasKaminsky", "createdAt": "2020-04-16T07:15:53Z", "path": "src/main/java/com/nextcloud/client/integration/NotificationHandler.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package com.nextcloud.client.integration;\n+\n+import android.content.Intent;\n+\n+import com.nextcloud.client.account.User;\n+import com.owncloud.android.lib.resources.notifications.models.Notification;\n+\n+import androidx.annotation.NonNull;\n+\n+public interface NotificationHandler {\n+\n+    @NonNull\n+    Intent handleNotification(@NonNull final Notification notification,\n+                              @NonNull final User user) throws AppNotInstalledException, AppCannotHandelNotificationException;\n+\n+    class AppNotInstalledException extends Exception {\n+    }\n+\n+    class AppCannotHandelNotificationException extends Exception {", "originalCommit": "783ed8353056462a0fb6b3ffb1fe24c8a6ffeb40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMzMjYyOA==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409332628", "bodyText": "Can you add GPL3+ header for all new files?", "author": "tobiasKaminsky", "createdAt": "2020-04-16T07:16:46Z", "path": "src/main/java/com/nextcloud/client/integration/NotificationHandler.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package com.nextcloud.client.integration;", "originalCommit": "783ed8353056462a0fb6b3ffb1fe24c8a6ffeb40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2MjE5NA==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409462194", "bodyText": "Ok, so this is agood start, but we'd like to further massage it into shape.\nFirst, \"handle\" means nothing, so this interface is not better than a Runnable.\nIt says that it \"handles\" something, but it the code is a factory... it doesn't make sense for me.\nLets start with the following questions:\n\nwhat is the business goal of this module?\nlet's put a javadoc that explains what we use it for\n\nOnce we have those 2 established, we can think about a better structure.\nI'm guessing - from the PR title - that the proper API would sound something like sendPushToDeck().", "author": "ezaquarii", "createdAt": "2020-04-16T10:48:31Z", "path": "src/main/java/com/nextcloud/client/integration/NotificationHandler.java", "diffHunk": "@@ -0,0 +1,15 @@\n+package com.nextcloud.client.integration;\n+\n+import android.content.Intent;\n+\n+import com.nextcloud.client.account.User;\n+import com.owncloud.android.lib.resources.notifications.models.Notification;\n+\n+import androidx.annotation.NonNull;\n+\n+public interface NotificationHandler {\n+\n+    @NonNull\n+    Intent handleNotification(@NonNull final Notification notification,", "originalCommit": "ab07d879ac4155927ca6aa9b175022f9c303a4dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5MTg2OQ==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409691869", "bodyText": "I think we found a proper name: DeckApi with a method called createForwardToDeckActionIntent. I also added some java doc in commit 6a2536f", "author": "stefan-niedermann", "createdAt": "2020-04-16T16:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2MjE5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2MzYwMQ==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409463601", "bodyText": "This method throws 2 checked exception, making it cumbersome to use. If you really need to handle excepton, please use 1 type.\nBut honestly I'd not throw anything. People don't know how to handle them. I'd consider using com.nextcloud.java.util.Optional instead.", "author": "ezaquarii", "createdAt": "2020-04-16T10:51:12Z", "path": "src/main/java/com/nextcloud/client/integration/deck/DeckNotificationHandler.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Nextcloud application\n+ *\n+ * @author Stefan Niedermann\n+ * Copyright (C) 2020 Stefan Niedermann <info@niedermann.it>\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.nextcloud.client.integration.deck;\n+\n+import android.content.Context;\n+import android.content.Intent;\n+import android.content.pm.PackageManager;\n+import android.util.Log;\n+\n+import com.nextcloud.client.account.User;\n+import com.nextcloud.client.integration.AppCannotHandleNotificationException;\n+import com.nextcloud.client.integration.AppNotInstalledException;\n+import com.nextcloud.client.integration.NotificationHandler;\n+import com.owncloud.android.lib.resources.notifications.models.Notification;\n+\n+import androidx.annotation.NonNull;\n+\n+public class DeckNotificationHandler implements NotificationHandler {\n+\n+    private static final String TAG = DeckNotificationHandler.class.getSimpleName();\n+\n+    private static final String APP_NAME = \"deck\";\n+    private static final String DECK_APP_ID_BASE = \"it.niedermann.nextcloud.deck\";\n+    private static final String[] DECK_APP_ID_FLAVOR_SUFFIXES = new String[]{\"\", \".play\", \".dev\"};\n+    private static final String DECK_ACTIVITY_TO_START = \"it.niedermann.nextcloud.deck.ui.PushNotificationActivity\";\n+\n+    private final PackageManager packageManager;\n+\n+    public DeckNotificationHandler(@NonNull Context context) {\n+        this.packageManager = context.getPackageManager();\n+    }\n+\n+    @NonNull\n+    @Override\n+    public Intent handleNotification(@NonNull Notification notification, @NonNull User user) throws AppNotInstalledException, AppCannotHandleNotificationException {", "originalCommit": "ab07d879ac4155927ca6aa9b175022f9c303a4dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ3NTIyMw==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409475223", "bodyText": "@stefan-niedermann\nHavind said that - I'm still not convinced that this handleNotification is a right abstraction for the business scenario you are implementing. Let's clarify that before we move forward.", "author": "ezaquarii", "createdAt": "2020-04-16T11:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2MzYwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY0MDc1Nw==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409640757", "bodyText": "Optional is used now \u2714\ufe0f", "author": "stefan-niedermann", "createdAt": "2020-04-16T15:18:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2MzYwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2NzIyMA==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409467220", "bodyText": "We still have a bunch of deck related logic in a wrong place. Also, I have no idea what it does.\nPleae bear in mind that this Job will be deleted.", "author": "ezaquarii", "createdAt": "2020-04-16T10:57:26Z", "path": "src/main/java/com/owncloud/android/jobs/NotificationJob.java", "diffHunk": "@@ -160,16 +164,21 @@ private void sendNotification(Notification notification, User user) {\n         SecureRandom randomId = new SecureRandom();\n         RichObject file = notification.subjectRichParameters.get(\"file\");\n \n+        final NotificationHandler deckNotificationHandler = new DeckNotificationHandler(context);\n         Intent intent;\n-        if (file == null) {\n-            intent = new Intent(context, NotificationsActivity.class);\n-        } else {\n-            intent = new Intent(context, FileDisplayActivity.class);\n-            intent.setAction(Intent.ACTION_VIEW);\n-            intent.putExtra(FileDisplayActivity.KEY_FILE_ID, file.id);\n+        try {", "originalCommit": "ab07d879ac4155927ca6aa9b175022f9c303a4dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY0MDk0NA==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409640944", "bodyText": "Think we solved it at our phone call :)", "author": "stefan-niedermann", "createdAt": "2020-04-16T15:18:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2NzIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ3MjA3OQ==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409472079", "bodyText": "Please remove this - we don't need to spam logs.", "author": "ezaquarii", "createdAt": "2020-04-16T11:07:01Z", "path": "src/main/java/com/nextcloud/client/integration/deck/DeckNotificationHandler.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Nextcloud application\n+ *\n+ * @author Stefan Niedermann\n+ * Copyright (C) 2020 Stefan Niedermann <info@niedermann.it>\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.nextcloud.client.integration.deck;\n+\n+import android.content.Context;\n+import android.content.Intent;\n+import android.content.pm.PackageManager;\n+import android.util.Log;\n+\n+import com.nextcloud.client.account.User;\n+import com.nextcloud.client.integration.AppCannotHandleNotificationException;\n+import com.nextcloud.client.integration.AppNotInstalledException;\n+import com.nextcloud.client.integration.NotificationHandler;\n+import com.owncloud.android.lib.resources.notifications.models.Notification;\n+\n+import androidx.annotation.NonNull;\n+\n+public class DeckNotificationHandler implements NotificationHandler {\n+\n+    private static final String TAG = DeckNotificationHandler.class.getSimpleName();\n+\n+    private static final String APP_NAME = \"deck\";\n+    private static final String DECK_APP_ID_BASE = \"it.niedermann.nextcloud.deck\";\n+    private static final String[] DECK_APP_ID_FLAVOR_SUFFIXES = new String[]{\"\", \".play\", \".dev\"};\n+    private static final String DECK_ACTIVITY_TO_START = \"it.niedermann.nextcloud.deck.ui.PushNotificationActivity\";\n+\n+    private final PackageManager packageManager;\n+\n+    public DeckNotificationHandler(@NonNull Context context) {\n+        this.packageManager = context.getPackageManager();\n+    }\n+\n+    @NonNull\n+    @Override\n+    public Intent handleNotification(@NonNull Notification notification, @NonNull User user) throws AppNotInstalledException, AppCannotHandleNotificationException {\n+        if (!APP_NAME.equalsIgnoreCase(notification.app)) {\n+            throw new AppCannotHandleNotificationException();\n+        }\n+        for (String flavor : DECK_APP_ID_FLAVOR_SUFFIXES) {\n+            final Intent intent = new Intent().setClassName(DECK_APP_ID_BASE + flavor, DECK_ACTIVITY_TO_START);\n+            if (packageManager.resolveActivity(intent, 0) != null) {\n+                Log.i(TAG, \"Found deck app flavor \\\"\" + flavor + \"\\\"\");\n+                return intent\n+                    .putExtra(\"account\", user.getAccountName())\n+                    .putExtra(\"link\", notification.getLink())\n+                    .putExtra(\"objectId\", notification.getObjectId())\n+                    .putExtra(\"subject\", notification.getSubject())\n+                    .putExtra(\"subjectRich\", notification.getSubjectRich())\n+                    .putExtra(\"message\", notification.getMessage())\n+                    .putExtra(\"messageRich\", notification.getMessageRich())\n+                    .putExtra(\"user\", notification.getUser())\n+                    .putExtra(\"nid\", notification.getNotificationId())\n+                    .addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);\n+            }\n+        }\n+        Log.v(TAG, \"Couldn't find any installed deck app.\");", "originalCommit": "ab07d879ac4155927ca6aa9b175022f9c303a4dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTUzNTcxMQ==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r409535711", "bodyText": "Fixed", "author": "stefan-niedermann", "createdAt": "2020-04-16T12:59:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ3MjA3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIxOTcwMg==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r410219702", "bodyText": "Please here also license header", "author": "tobiasKaminsky", "createdAt": "2020-04-17T13:24:54Z", "path": "src/main/java/com/nextcloud/client/integration/deck/DeckApi.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.nextcloud.client.integration.deck;", "originalCommit": "b4b2925bbaae28049c79813dca9797f4ab7c6c5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIxOTkxNw==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r410219917", "bodyText": "If it does not fit in 120 chars, plese wrap paramater", "author": "tobiasKaminsky", "createdAt": "2020-04-17T13:25:14Z", "path": "src/main/java/com/nextcloud/client/integration/deck/DeckApi.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.nextcloud.client.integration.deck;\n+\n+import android.app.PendingIntent;\n+\n+import com.nextcloud.client.account.User;\n+import com.nextcloud.java.util.Optional;\n+import com.owncloud.android.lib.resources.notifications.models.Notification;\n+\n+import androidx.annotation.NonNull;\n+\n+/**\n+ * This API is for an integration with the <a href=\"https://github.com/stefan-niedermann/nextcloud-deck\">Nextcloud\n+ * Deck</a> app for android.\n+ */\n+public interface DeckApi {\n+\n+    /**\n+     * Creates a PendingIntent that can be used in a NotificationBuilder to start the Deck app\n+     *\n+     * @param notification Notification object that should be processed\n+     * @param user         The user that is affected by the notification\n+     * @return Optional with a PendingIntent or an empty Optional if the notification is not from the\n+     * <a href=\"https://apps.nextcloud.com/apps/deck\">Deck server app</a>.\n+     */\n+    @NonNull\n+    Optional<PendingIntent> createForwardToDeckActionIntent(@NonNull final Notification notification, @NonNull final User user);", "originalCommit": "b4b2925bbaae28049c79813dca9797f4ab7c6c5a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MTQzOQ==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r410371439", "bodyText": "This log stanza should be removed.\n\nwe don't need to spam logs with this information, at least not at info level\nWe have our own logger that can be accessed by Log_OC helper or (better) Logger interface.", "author": "ezaquarii", "createdAt": "2020-04-17T17:36:54Z", "path": "src/main/java/com/nextcloud/client/integration/deck/DeckApiImpl.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Nextcloud application\n+ *\n+ * @author Stefan Niedermann\n+ * Copyright (C) 2020 Stefan Niedermann <info@niedermann.it>\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.nextcloud.client.integration.deck;\n+\n+import android.app.PendingIntent;\n+import android.content.Context;\n+import android.content.Intent;\n+import android.util.Log;\n+\n+import com.nextcloud.client.account.User;\n+import com.nextcloud.java.util.Optional;\n+import com.owncloud.android.lib.resources.notifications.models.Notification;\n+\n+import androidx.annotation.NonNull;\n+\n+public class DeckApiImpl implements DeckApi {\n+\n+    private static final String TAG = DeckApiImpl.class.getSimpleName();\n+\n+    private static final String APP_NAME = \"deck\";\n+    private static final String DECK_APP_ID_BASE = \"it.niedermann.nextcloud.deck\";\n+    private static final String[] DECK_APP_ID_FLAVOR_SUFFIXES = new String[]{\"\", \".play\", \".dev\"};\n+    private static final String DECK_ACTIVITY_TO_START = \"it.niedermann.nextcloud.deck.ui.PushNotificationActivity\";\n+\n+    private static final String EXTRA_ACCOUNT = \"account\";\n+    private static final String EXTRA_LINK = \"link\";\n+    private static final String EXTRA_OBJECT_ID = \"objectId\";\n+    private static final String EXTRA_SUBJECT = \"subject\";\n+    private static final String EXTRA_SUBJECT_RICH = \"subjectRich\";\n+    private static final String EXTRA_MESSAGE = \"message\";\n+    private static final String EXTRA_MESSAGE_RICH = \"messageRich\";\n+    private static final String EXTRA_USER = \"user\";\n+    private static final String EXTRA_NID = \"nid\";\n+\n+    private final Context context;\n+\n+    public DeckApiImpl(@NonNull Context context) {\n+        this.context = context;\n+    }\n+\n+    @NonNull\n+    @Override\n+    public Optional<PendingIntent> createForwardToDeckActionIntent(@NonNull Notification notification, @NonNull User user) {\n+        if (APP_NAME.equalsIgnoreCase(notification.app)) {\n+            final Intent intent = new Intent();\n+            for (String flavor : DECK_APP_ID_FLAVOR_SUFFIXES) {\n+                intent.setClassName(DECK_APP_ID_BASE + flavor, DECK_ACTIVITY_TO_START);\n+                if (context.getPackageManager().resolveActivity(intent, 0) != null) {\n+                    Log.i(TAG, \"Found deck app flavor \\\"\" + flavor + \"\\\"\");", "originalCommit": "717f49829e299f6d2c5bf7d5b62cc8ebf125f09a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM5OTg2OQ==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r410399869", "bodyText": "I removed logging", "author": "stefan-niedermann", "createdAt": "2020-04-17T18:31:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MTQzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4MzgxMA==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r410383810", "bodyText": "The diagram tells that it passes account and some kind of \"event\".\nCan we clarify what this API is doing exactly?\nMy posposal (after consulting the source code):\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /**\n          \n          \n            \n                 * Creates a PendingIntent that can be used in a NotificationBuilder to start the Deck app\n          \n          \n            \n                 *\n          \n          \n            \n                 * @param notification Notification object that should be processed\n          \n          \n            \n                 * @param user         The user that is affected by the notification\n          \n          \n            \n                 * @return Optional with a PendingIntent or an empty Optional if the notification is not from the\n          \n          \n            \n                 * <a href=\"https://apps.nextcloud.com/apps/deck\">Deck server app</a>.\n          \n          \n            \n                 */\n          \n          \n            \n                /**\n          \n          \n            \n                * Creates a PendingIntent that can be used in a NotificationBuilder to open the notification link in Deck app \n          \n          \n            \n                * @see Deck Server App - https://apps.nextcloud.com/apps/deck\n          \n          \n            \n                *\n          \n          \n            \n                * @param notification Notification that could be forwarded to Deck\n          \n          \n            \n                * @param user         The user that is affected by the notification\n          \n          \n            \n                * @return If notification can be consumed by Deck, a PendingIntent openinig notification link in Deck app; empty value otherwise\n          \n          \n            \n                */", "author": "ezaquarii", "createdAt": "2020-04-17T18:00:32Z", "path": "src/main/java/com/nextcloud/client/integration/deck/DeckApi.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Nextcloud application\n+ *\n+ * @author Stefan Niedermann\n+ * Copyright (C) 2020 Stefan Niedermann <info@niedermann.it>\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.nextcloud.client.integration.deck;\n+\n+import android.app.PendingIntent;\n+\n+import com.nextcloud.client.account.User;\n+import com.nextcloud.java.util.Optional;\n+import com.owncloud.android.lib.resources.notifications.models.Notification;\n+\n+import androidx.annotation.NonNull;\n+\n+/**\n+ * This API is for an integration with the <a href=\"https://github.com/stefan-niedermann/nextcloud-deck\">Nextcloud\n+ * Deck</a> app for android.\n+ */\n+public interface DeckApi {\n+\n+    /**\n+     * Creates a PendingIntent that can be used in a NotificationBuilder to start the Deck app\n+     *\n+     * @param notification Notification object that should be processed\n+     * @param user         The user that is affected by the notification\n+     * @return Optional with a PendingIntent or an empty Optional if the notification is not from the\n+     * <a href=\"https://apps.nextcloud.com/apps/deck\">Deck server app</a>.\n+     */", "originalCommit": "717f49829e299f6d2c5bf7d5b62cc8ebf125f09a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQwMDYzOA==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r410400638", "bodyText": "I don't intend to block this PR with further massaging - we can follow-up when merging #5892 as well, so feel free to go ahead and merge.", "author": "ezaquarii", "createdAt": "2020-04-17T18:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4MzgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQwMjgxNw==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r410402817", "bodyText": "I adapted your proposal (but kept the <a href...-style for the @see-annotation (because it will then be rendered as a link)\n\nThe diagram tells that it passes account and some kind of \"event\".\n\nThis can currently be for example\n\nUser A assigns a card to User B\nUser A mentions User B in a comment on a card\n...\n\nBut this are internals of the Deck app and can change. The actual payload / content of the event is not relevant for the File app and should therefore omitted in the documentation IMHO.", "author": "stefan-niedermann", "createdAt": "2020-04-17T18:37:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4MzgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQwNjMxMw==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r410406313", "bodyText": "But this are internals of the Deck app and can change. The actual payload / content of the event is not relevant for the File app\n\nAgree, if Deck content is opaque, it's implementation detail that should not be leaking into the caller.", "author": "ezaquarii", "createdAt": "2020-04-17T18:44:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4MzgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4ODgxMQ==", "url": "https://github.com/nextcloud/android/pull/5825#discussion_r410488811", "bodyText": "Issue found: Avoid unused private fields such as 'TAG'.", "author": "nextcloud-android-bot", "createdAt": "2020-04-17T21:55:26Z", "path": "src/main/java/com/nextcloud/client/integration/deck/DeckApiImpl.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Nextcloud application\n+ *\n+ * @author Stefan Niedermann\n+ * Copyright (C) 2020 Stefan Niedermann <info@niedermann.it>\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.nextcloud.client.integration.deck;\n+\n+import android.app.PendingIntent;\n+import android.content.Context;\n+import android.content.Intent;\n+import android.content.pm.PackageManager;\n+\n+import com.nextcloud.client.account.User;\n+import com.nextcloud.java.util.Optional;\n+import com.owncloud.android.lib.resources.notifications.models.Notification;\n+\n+import androidx.annotation.NonNull;\n+\n+public class DeckApiImpl implements DeckApi {\n+\n+    private static final String TAG = DeckApiImpl.class.getSimpleName();", "originalCommit": "b0509d2a22bb38a8e831b02291330fab6e401f62", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b0ab109e5dfe27bf3dc2ef0102c41cca38635b4e", "url": "https://github.com/nextcloud/android/commit/b0ab109e5dfe27bf3dc2ef0102c41cca38635b4e", "message": "Move Deck integration logic to own package\n\nhttps://github.com/stefan-niedermann/nextcloud-deck/issues/208", "committedDate": "2020-05-12T11:10:51Z", "type": "commit"}, {"oid": "ee882187fbf9eed30681fd08422e8677b47a51ee", "url": "https://github.com/nextcloud/android/commit/ee882187fbf9eed30681fd08422e8677b47a51ee", "message": "Move Deck exception classes into own files\n\nhttps://github.com/stefan-niedermann/nextcloud-deck/issues/208", "committedDate": "2020-05-12T11:10:55Z", "type": "commit"}, {"oid": "37aa694a52fabde7a0136b4eece2321edb0d4330", "url": "https://github.com/nextcloud/android/commit/37aa694a52fabde7a0136b4eece2321edb0d4330", "message": "Add GPL headers\n\nhttps://github.com/stefan-niedermann/nextcloud-deck/issues/208", "committedDate": "2020-05-12T11:10:58Z", "type": "commit"}, {"oid": "a751523c2045c73de79c329e9075b9ce288dc988", "url": "https://github.com/nextcloud/android/commit/a751523c2045c73de79c329e9075b9ce288dc988", "message": "Fix typo in handle\n\nhttps://github.com/stefan-niedermann/nextcloud-deck/issues/208", "committedDate": "2020-05-12T11:10:59Z", "type": "commit"}, {"oid": "40e1f089f48bb2fccdf6506cb0022a1af487520e", "url": "https://github.com/nextcloud/android/commit/40e1f089f48bb2fccdf6506cb0022a1af487520e", "message": "Added default serialVersionUID for new Exception classes\n\nhttps://github.com/stefan-niedermann/nextcloud-deck/issues/208", "committedDate": "2020-05-12T11:11:01Z", "type": "commit"}, {"oid": "dfb3d8d15f2a2ca6193f5c8dd2a7e8bab56e5e48", "url": "https://github.com/nextcloud/android/commit/dfb3d8d15f2a2ca6193f5c8dd2a7e8bab56e5e48", "message": "Small refactorings\n\nhttps://github.com/stefan-niedermann/nextcloud-deck/issues/208", "committedDate": "2020-05-12T11:11:01Z", "type": "commit"}, {"oid": "ad8eaff22b01624029b357fa810ee8f8680b3504", "url": "https://github.com/nextcloud/android/commit/ad8eaff22b01624029b357fa810ee8f8680b3504", "message": "Don't spam logs\n\nhttps://github.com/stefan-niedermann/nextcloud-deck/issues/208", "committedDate": "2020-05-12T11:11:01Z", "type": "commit"}, {"oid": "820f6745e10b412444a7638b63de0d45d2e7650f", "url": "https://github.com/nextcloud/android/commit/820f6745e10b412444a7638b63de0d45d2e7650f", "message": "Don't instantiate intent each time in the for loop\n\nhttps://github.com/stefan-niedermann/nextcloud-deck/issues/208", "committedDate": "2020-05-12T11:11:01Z", "type": "commit"}, {"oid": "9a00819286fd081a4dd17853c2cd762e08fbb7c5", "url": "https://github.com/nextcloud/android/commit/9a00819286fd081a4dd17853c2cd762e08fbb7c5", "message": "Use Optional for DeckIntegration and better name for interface\n\nhttps://github.com/stefan-niedermann/nextcloud-deck/issues/208", "committedDate": "2020-05-12T11:11:03Z", "type": "commit"}, {"oid": "53a1344e47ab2914e1f0310ed87b06011743ce48", "url": "https://github.com/nextcloud/android/commit/53a1344e47ab2914e1f0310ed87b06011743ce48", "message": "Rename interface and implementation for Deck integration\n\nhttps://github.com/stefan-niedermann/nextcloud-deck/issues/208", "committedDate": "2020-05-12T11:11:06Z", "type": "commit"}, {"oid": "10437c9d8225d6bf2cc143bedc09677f22aa6cd6", "url": "https://github.com/nextcloud/android/commit/10437c9d8225d6bf2cc143bedc09677f22aa6cd6", "message": "Add some java doc\n\nhttps://github.com/stefan-niedermann/nextcloud-deck/issues/208", "committedDate": "2020-05-12T11:11:08Z", "type": "commit"}, {"oid": "19deab3fba1be8b2ec9ab24a46abe8e4998a712c", "url": "https://github.com/nextcloud/android/commit/19deab3fba1be8b2ec9ab24a46abe8e4998a712c", "message": "Internal refactoring of the DeckApiImpl\n\nhttps://github.com/stefan-niedermann/nextcloud-deck/issues/208", "committedDate": "2020-05-12T11:11:10Z", "type": "commit"}, {"oid": "a9a2c06a1bd836286ddd12647f064577af9b7eef", "url": "https://github.com/nextcloud/android/commit/a9a2c06a1bd836286ddd12647f064577af9b7eef", "message": "Add license header and code format\n\nhttps://github.com/stefan-niedermann/nextcloud-deck/issues/208", "committedDate": "2020-05-12T11:11:12Z", "type": "commit"}, {"oid": "24cbc66a92b3db4b30f84f40577fd89ee65f19f7", "url": "https://github.com/nextcloud/android/commit/24cbc66a92b3db4b30f84f40577fd89ee65f19f7", "message": "Removed logging\n\nhttps://github.com/stefan-niedermann/nextcloud-deck/issues/208", "committedDate": "2020-05-12T11:11:12Z", "type": "commit"}, {"oid": "c0bd6b1a515382b779a39e1772a0b3cf43fb700d", "url": "https://github.com/nextcloud/android/commit/c0bd6b1a515382b779a39e1772a0b3cf43fb700d", "message": "Adjusted javadoc\n\nhttps://github.com/stefan-niedermann/nextcloud-deck/issues/208", "committedDate": "2020-05-12T11:11:12Z", "type": "commit"}, {"oid": "b10038cced218a5f664d89a9a28c0b58b37c5e5e", "url": "https://github.com/nextcloud/android/commit/b10038cced218a5f664d89a9a28c0b58b37c5e5e", "message": "DeckApi unit test\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-05-12T11:11:14Z", "type": "commit"}, {"oid": "b10038cced218a5f664d89a9a28c0b58b37c5e5e", "url": "https://github.com/nextcloud/android/commit/b10038cced218a5f664d89a9a28c0b58b37c5e5e", "message": "DeckApi unit test\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-05-12T11:11:14Z", "type": "forcePushed"}, {"oid": "54d4acf216e8470b76cfcd6f539334d1748c1a96", "url": "https://github.com/nextcloud/android/commit/54d4acf216e8470b76cfcd6f539334d1748c1a96", "message": "Fix after rebase\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-05-12T14:20:17Z", "type": "commit"}, {"oid": "54d4acf216e8470b76cfcd6f539334d1748c1a96", "url": "https://github.com/nextcloud/android/commit/54d4acf216e8470b76cfcd6f539334d1748c1a96", "message": "Fix after rebase\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-05-12T14:20:17Z", "type": "forcePushed"}]}