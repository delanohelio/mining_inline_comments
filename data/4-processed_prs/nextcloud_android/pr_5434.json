{"pr_number": 5434, "pr_title": "Migrate account list to new user model", "pr_createdAt": "2020-02-09T03:01:35Z", "pr_url": "https://github.com/nextcloud/android/pull/5434", "timeline": [{"oid": "d63b9e95d5521b7b392cacb9247a525022c34388", "url": "https://github.com/nextcloud/android/commit/d63b9e95d5521b7b392cacb9247a525022c34388", "message": "Migrate account list to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-09T03:29:25Z", "type": "forcePushed"}, {"oid": "c3df42239a555cf664266cbbfadfa81b8acd9bce", "url": "https://github.com/nextcloud/android/commit/c3df42239a555cf664266cbbfadfa81b8acd9bce", "message": "Migrate account list to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-09T10:22:58Z", "type": "forcePushed"}, {"oid": "4cf6c3d858ae34f19393428bce74b59749ae00ab", "url": "https://github.com/nextcloud/android/commit/4cf6c3d858ae34f19393428bce74b59749ae00ab", "message": "Migrate account list to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-09T10:26:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc3MTg0OA==", "url": "https://github.com/nextcloud/android/pull/5434#discussion_r376771848", "bodyText": "Issue found: Avoid instantiating new objects inside loops", "author": "nextcloud-android-bot", "createdAt": "2020-02-09T10:26:33Z", "path": "src/main/java/com/owncloud/android/ui/activity/ManageAccountsActivity.java", "diffHunk": "@@ -223,25 +233,20 @@ private void initializeComponentGetters() {\n         }\n     }\n \n-    /**\n-     * creates the account list items list including the add-account action in case multiaccount_support is enabled.\n-     *\n-     * @return list of account list items\n-     */\n-    private List<AccountListItem> getAccountListItems() {\n-        Account[] accountList = AccountManager.get(this).getAccountsByType(MainApp.getAccountType(this));\n-        List<AccountListItem> adapterAccountList = new ArrayList<>(accountList.length);\n-        for (Account account : accountList) {\n-            boolean pendingForRemoval = arbitraryDataProvider.getBooleanValue(account, PENDING_FOR_REMOVAL);\n-            adapterAccountList.add(new AccountListItem(account, !pendingForRemoval));\n+    private List<UserListItem> getUserListItems() {\n+        List<User> users = accountManager.getAllUsers();\n+        List<UserListItem> userListItems = new ArrayList<>(users.size());\n+        for (User user : users) {\n+            boolean pendingForRemoval = arbitraryDataProvider.getBooleanValue(user.toPlatformAccount(),\n+                                                                              PENDING_FOR_REMOVAL);\n+            userListItems.add(new UserListItem(user, !pendingForRemoval));", "originalCommit": "c3df42239a555cf664266cbbfadfa81b8acd9bce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f49c6c3cf4813ff65dd14b8297ce10cddc3521b0", "url": "https://github.com/nextcloud/android/commit/f49c6c3cf4813ff65dd14b8297ce10cddc3521b0", "message": "Migrate account list to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-09T10:54:10Z", "type": "forcePushed"}, {"oid": "5965fe90ebeb83c68ba7681a298367ba8901f190", "url": "https://github.com/nextcloud/android/commit/5965fe90ebeb83c68ba7681a298367ba8901f190", "message": "Migrate account list to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-10T15:52:14Z", "type": "forcePushed"}, {"oid": "d4b688e71758455818efed2855b1c7f248ea9fbc", "url": "https://github.com/nextcloud/android/commit/d4b688e71758455818efed2855b1c7f248ea9fbc", "message": "Migrate account list to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-10T15:56:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE1NTE3OA==", "url": "https://github.com/nextcloud/android/pull/5434#discussion_r377155178", "bodyText": "DOH! Gihub is diffing wrong files!\nThis should be diffed against old AccountListAdapter, that has become UserListAdapter, becuase it shows users.\nOld UserListAdapter has become ShareeListAdapter, bacuse it shows users sharing a file.", "author": "ezaquarii", "createdAt": "2020-02-10T16:02:14Z", "path": "src/main/java/com/owncloud/android/ui/adapter/UserListAdapter.java", "diffHunk": "@@ -1,449 +1,339 @@\n /*", "originalCommit": "d4b688e71758455818efed2855b1c7f248ea9fbc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f49c6c3cf4813ff65dd14b8297ce10cddc3521b0", "url": "https://github.com/nextcloud/android/commit/f49c6c3cf4813ff65dd14b8297ce10cddc3521b0", "message": "Migrate account list to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-09T10:54:10Z", "type": "forcePushed"}, {"oid": "4a548acf4255369e8ef53149df4862ab78ce2a4d", "url": "https://github.com/nextcloud/android/commit/4a548acf4255369e8ef53149df4862ab78ce2a4d", "message": "Migrate account list to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-10T17:25:11Z", "type": "forcePushed"}, {"oid": "48d9b58306dc652627fda31074c3d0d6f57a196c", "url": "https://github.com/nextcloud/android/commit/48d9b58306dc652627fda31074c3d0d6f57a196c", "message": "Migrate account list to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-10T17:29:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwODkyOA==", "url": "https://github.com/nextcloud/android/pull/5434#discussion_r377208928", "bodyText": "This was UserListAdapter, renamed into Sharee*. Github is confused.", "author": "ezaquarii", "createdAt": "2020-02-10T17:31:01Z", "path": "src/main/java/com/owncloud/android/ui/adapter/ShareeListAdapter.java", "diffHunk": "@@ -0,0 +1,453 @@\n+/*", "originalCommit": "48d9b58306dc652627fda31074c3d0d6f57a196c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9fbaf2c9fd1f7f3f71e64599dcf79c980180ad8e", "url": "https://github.com/nextcloud/android/commit/9fbaf2c9fd1f7f3f71e64599dcf79c980180ad8e", "message": "Migrate account list to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-10T20:49:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ5NDU1MA==", "url": "https://github.com/nextcloud/android/pull/5434#discussion_r377494550", "bodyText": "This would lead to a direct return after clicking on the user/account.\nAs far as I know, we had an empty for this previously.\nCan we have this?\nI can write a test case for this.", "author": "tobiasKaminsky", "createdAt": "2020-02-11T08:31:16Z", "path": "src/main/java/com/owncloud/android/ui/activity/UserInfoActivity.java", "diffHunk": "@@ -116,15 +118,22 @@\n     private Unbinder unbinder;\n \n     private UserInfo userInfo;\n-    private Account account;\n+    private User user;\n \n     @Override\n     public void onCreate(Bundle savedInstanceState) {\n         Log_OC.v(TAG, \"onCreate() start\");\n         super.onCreate(savedInstanceState);\n         Bundle bundle = getIntent().getExtras();\n \n-        account = Parcels.unwrap(bundle.getParcelable(KEY_ACCOUNT));\n+        final Account account = Parcels.unwrap(bundle.getParcelable(KEY_ACCOUNT));\n+        Optional<User> optionalUser = accountManager.getUser(account != null ? account.name : \"\");\n+        if(!optionalUser.isPresent()) {\n+            finish();", "originalCommit": "9fbaf2c9fd1f7f3f71e64599dcf79c980180ad8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0469cf15d2c54fa112e800048974660323405eec", "url": "https://github.com/nextcloud/android/commit/0469cf15d2c54fa112e800048974660323405eec", "message": "Migrate account list to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-11T23:39:59Z", "type": "forcePushed"}, {"oid": "53024d1cd1bb6b2e829f64d68ce29a2fcf795262", "url": "https://github.com/nextcloud/android/commit/53024d1cd1bb6b2e829f64d68ce29a2fcf795262", "message": "Migrate account list to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-12T07:31:38Z", "type": "commit"}, {"oid": "53024d1cd1bb6b2e829f64d68ce29a2fcf795262", "url": "https://github.com/nextcloud/android/commit/53024d1cd1bb6b2e829f64d68ce29a2fcf795262", "message": "Migrate account list to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-12T07:31:38Z", "type": "forcePushed"}, {"oid": "0569b0de6543bfaf78d689c8b4296ca24fc2bdd3", "url": "https://github.com/nextcloud/android/commit/0569b0de6543bfaf78d689c8b4296ca24fc2bdd3", "message": "Screenshot tests ManageAccountsActivity\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-02-12T08:34:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEwNDM1NA==", "url": "https://github.com/nextcloud/android/pull/5434#discussion_r378104354", "bodyText": "Issue found: Avoid instantiating new objects inside loops", "author": "nextcloud-android-bot", "createdAt": "2020-02-12T08:38:13Z", "path": "src/main/java/com/owncloud/android/ui/dialog/MultipleAccountsDialog.java", "diffHunk": "@@ -117,21 +120,21 @@ public Dialog onCreateDialog(Bundle savedInstanceState) {\n      *\n      * @return list of account list items\n      */\n-    private List<AccountListItem> getAccountListItems() {\n-        Account[] accountList = accountManager.getAccounts();\n-        List<AccountListItem> adapterAccountList = new ArrayList<>(accountList.length);\n-        for (Account account : accountList) {\n-            adapterAccountList.add(new AccountListItem(account));\n+    private List<UserListItem> getAccountListItems() {\n+        List<User> users = accountManager.getAllUsers();\n+        List<UserListItem> adapterUserList = new ArrayList<>(users.size());\n+        for (User user : users) {\n+            adapterUserList.add(new UserListItem(user));", "originalCommit": "0569b0de6543bfaf78d689c8b4296ca24fc2bdd3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEwNDM2Ng==", "url": "https://github.com/nextcloud/android/pull/5434#discussion_r378104366", "bodyText": "Issue found: Avoid instantiating new objects inside loops", "author": "nextcloud-android-bot", "createdAt": "2020-02-12T08:38:14Z", "path": "src/main/java/com/owncloud/android/ui/activity/ManageAccountsActivity.java", "diffHunk": "@@ -223,25 +232,20 @@ private void initializeComponentGetters() {\n         }\n     }\n \n-    /**\n-     * creates the account list items list including the add-account action in case multiaccount_support is enabled.\n-     *\n-     * @return list of account list items\n-     */\n-    private List<AccountListItem> getAccountListItems() {\n-        Account[] accountList = AccountManager.get(this).getAccountsByType(MainApp.getAccountType(this));\n-        List<AccountListItem> adapterAccountList = new ArrayList<>(accountList.length);\n-        for (Account account : accountList) {\n-            boolean pendingForRemoval = arbitraryDataProvider.getBooleanValue(account, PENDING_FOR_REMOVAL);\n-            adapterAccountList.add(new AccountListItem(account, !pendingForRemoval));\n+    private List<UserListItem> getUserListItems() {\n+        List<User> users = accountManager.getAllUsers();\n+        List<UserListItem> userListItems = new ArrayList<>(users.size());\n+        for (User user : users) {\n+            boolean pendingForRemoval = arbitraryDataProvider.getBooleanValue(user.toPlatformAccount(),\n+                                                                              PENDING_FOR_REMOVAL);\n+            userListItems.add(new UserListItem(user, !pendingForRemoval));", "originalCommit": "0569b0de6543bfaf78d689c8b4296ca24fc2bdd3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEwNDM3Nw==", "url": "https://github.com/nextcloud/android/pull/5434#discussion_r378104377", "bodyText": "Issue found: Deeply nested if..then statements are hard to read", "author": "nextcloud-android-bot", "createdAt": "2020-02-12T08:38:15Z", "path": "src/main/java/com/owncloud/android/ui/activity/ManageAccountsActivity.java", "diffHunk": "@@ -155,9 +155,12 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n         if (resultCode == KEY_DELETE_CODE && data != null) {\n             Bundle bundle = data.getExtras();\n             if (bundle != null && bundle.containsKey(UserInfoActivity.KEY_ACCOUNT)) {\n-                Account account = Parcels.unwrap(bundle.getParcelable(UserInfoActivity.KEY_ACCOUNT));\n-                accountName = account.name;\n-                performAccountRemoval(account);\n+                final Account account = Parcels.unwrap(bundle.getParcelable(UserInfoActivity.KEY_ACCOUNT));\n+                if (account != null) {", "originalCommit": "0569b0de6543bfaf78d689c8b4296ca24fc2bdd3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}