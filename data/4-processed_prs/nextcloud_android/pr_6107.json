{"pr_number": 6107, "pr_title": "Fix upload and wrote tests", "pr_createdAt": "2020-05-19T18:30:25Z", "pr_url": "https://github.com/nextcloud/android/pull/6107", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyNjU2NA==", "url": "https://github.com/nextcloud/android/pull/6107#discussion_r427526564", "bodyText": "what if that fails? can the test be repeated again?", "author": "ezaquarii", "createdAt": "2020-05-19T18:51:52Z", "path": "src/androidTest/java/com/owncloud/android/UploadIT.java", "diffHunk": "@@ -183,4 +184,151 @@ public void testUploadInNonExistingFolder() {\n         // cleanup\n         new RemoveFileOperation(\"/testUpload/\", false, account, false, targetContext).execute(client, getStorageManager());\n     }\n+\n+    @Test\n+    public void testUploadOnChargingOnlyButNotCharging() {\n+        OCUpload ocUpload = new OCUpload(FileStorageUtils.getSavePath(account.name) + \"/empty.txt\",\n+                                         \"/testUpload/notCharging.txt\", account.name);\n+        ocUpload.setWhileChargingOnly(true);\n+\n+        UploadFileOperation newUpload = new UploadFileOperation(\n+            storageManager,\n+            connectivityServiceMock,\n+            powerManagementServiceMock,\n+            account,\n+            null,\n+            ocUpload,\n+            FileUploader.NameCollisionPolicy.DEFAULT,\n+            FileUploader.LOCAL_BEHAVIOUR_COPY,\n+            targetContext,\n+            false,\n+            true\n+        );\n+        newUpload.setRemoteFolderToBeCreated();\n+        newUpload.addRenameUploadListener(() -> {\n+            // dummy\n+        });\n+\n+        RemoteOperationResult result = newUpload.execute(client, getStorageManager());\n+        assertFalse(result.toString(), result.isSuccess());\n+    }\n+\n+    @Test\n+    public void testUploadOnChargingOnlyAndCharging() {\n+        PowerManagementService powerManagementServiceMock = new PowerManagementService() {\n+            @Override\n+            public boolean isPowerSavingEnabled() {\n+                return false;\n+            }\n+\n+            @Override\n+            public boolean isPowerSavingExclusionAvailable() {\n+                return false;\n+            }\n+\n+            @NotNull\n+            @Override\n+            public BatteryStatus getBattery() {\n+                return new BatteryStatus(true, 100);\n+            }\n+        };\n+\n+        OCUpload ocUpload = new OCUpload(FileStorageUtils.getSavePath(account.name) + \"/empty.txt\",\n+                                         \"/testUpload/charging.txt\", account.name);\n+        ocUpload.setWhileChargingOnly(true);\n+\n+        UploadFileOperation newUpload = new UploadFileOperation(\n+            storageManager,\n+            connectivityServiceMock,\n+            powerManagementServiceMock,\n+            account,\n+            null,\n+            ocUpload,\n+            FileUploader.NameCollisionPolicy.DEFAULT,\n+            FileUploader.LOCAL_BEHAVIOUR_COPY,\n+            targetContext,\n+            false,\n+            true\n+        );\n+        newUpload.setRemoteFolderToBeCreated();\n+        newUpload.addRenameUploadListener(() -> {\n+            // dummy\n+        });\n+\n+        RemoteOperationResult result = newUpload.execute(client, getStorageManager());\n+        assertTrue(result.toString(), result.isSuccess());\n+\n+        // cleanup\n+        new RemoveFileOperation(\"/testUpload/\", false, account, false, targetContext).execute(client, getStorageManager());", "originalCommit": "867d83d98ee1791b212ddb61f2b88524a8c0341a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAxMTY4Ng==", "url": "https://github.com/nextcloud/android/pull/6107#discussion_r428011686", "bodyText": "If this fails something is seriously broken and then I think it is ok that this (or any following) test fails.", "author": "tobiasKaminsky", "createdAt": "2020-05-20T13:30:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyNjU2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyNzAyMw==", "url": "https://github.com/nextcloud/android/pull/6107#discussion_r427527023", "bodyText": "This setup seems to be repetive. We could do it in:\n@Before\nvoid setUp() { ... }", "author": "ezaquarii", "createdAt": "2020-05-19T18:52:44Z", "path": "src/androidTest/java/com/owncloud/android/UploadIT.java", "diffHunk": "@@ -183,4 +184,151 @@ public void testUploadInNonExistingFolder() {\n         // cleanup\n         new RemoveFileOperation(\"/testUpload/\", false, account, false, targetContext).execute(client, getStorageManager());\n     }\n+\n+    @Test\n+    public void testUploadOnChargingOnlyButNotCharging() {\n+        OCUpload ocUpload = new OCUpload(FileStorageUtils.getSavePath(account.name) + \"/empty.txt\",\n+                                         \"/testUpload/notCharging.txt\", account.name);\n+        ocUpload.setWhileChargingOnly(true);\n+\n+        UploadFileOperation newUpload = new UploadFileOperation(\n+            storageManager,\n+            connectivityServiceMock,\n+            powerManagementServiceMock,\n+            account,\n+            null,\n+            ocUpload,\n+            FileUploader.NameCollisionPolicy.DEFAULT,\n+            FileUploader.LOCAL_BEHAVIOUR_COPY,\n+            targetContext,\n+            false,\n+            true\n+        );\n+        newUpload.setRemoteFolderToBeCreated();\n+        newUpload.addRenameUploadListener(() -> {\n+            // dummy\n+        });\n+\n+        RemoteOperationResult result = newUpload.execute(client, getStorageManager());\n+        assertFalse(result.toString(), result.isSuccess());\n+    }\n+\n+    @Test\n+    public void testUploadOnChargingOnlyAndCharging() {\n+        PowerManagementService powerManagementServiceMock = new PowerManagementService() {\n+            @Override\n+            public boolean isPowerSavingEnabled() {\n+                return false;\n+            }\n+\n+            @Override\n+            public boolean isPowerSavingExclusionAvailable() {\n+                return false;\n+            }\n+\n+            @NotNull\n+            @Override\n+            public BatteryStatus getBattery() {\n+                return new BatteryStatus(true, 100);\n+            }\n+        };\n+\n+        OCUpload ocUpload = new OCUpload(FileStorageUtils.getSavePath(account.name) + \"/empty.txt\",\n+                                         \"/testUpload/charging.txt\", account.name);\n+        ocUpload.setWhileChargingOnly(true);\n+\n+        UploadFileOperation newUpload = new UploadFileOperation(", "originalCommit": "867d83d98ee1791b212ddb61f2b88524a8c0341a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAxNDU1NA==", "url": "https://github.com/nextcloud/android/pull/6107#discussion_r428014554", "bodyText": "It is, and for unmodified uploads I have \"testUpload(\u2026)\".\nBut the 4 new added tests have slightly modifications:\n\nuse special connectivtyServiceMock / powerManagementServiceMock\nuse different values for onWifiOnly/whileChargingOnly\n\nSo for better readability I would keep it this way.", "author": "tobiasKaminsky", "createdAt": "2020-05-20T13:34:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyNzAyMw=="}], "type": "inlineReview"}, {"oid": "20d04d6fa52b051de9773822fd713329a1ed02d2", "url": "https://github.com/nextcloud/android/commit/20d04d6fa52b051de9773822fd713329a1ed02d2", "message": "Fix upload and wrote tests\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-05-20T13:47:34Z", "type": "forcePushed"}, {"oid": "89c9838442f72977a41948d4e21aa3f232f174ae", "url": "https://github.com/nextcloud/android/commit/89c9838442f72977a41948d4e21aa3f232f174ae", "message": "Fix upload and wrote tests\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-05-20T13:49:07Z", "type": "commit"}, {"oid": "1a4be987d978136f03b6d1c2a02ec0bbac205932", "url": "https://github.com/nextcloud/android/commit/1a4be987d978136f03b6d1c2a02ec0bbac205932", "message": "Fix upload and wrote tests\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-05-20T14:43:59Z", "type": "commit"}, {"oid": "1a4be987d978136f03b6d1c2a02ec0bbac205932", "url": "https://github.com/nextcloud/android/commit/1a4be987d978136f03b6d1c2a02ec0bbac205932", "message": "Fix upload and wrote tests\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-05-20T14:43:59Z", "type": "forcePushed"}]}