{"pr_number": 5879, "pr_title": "Migrate files sync related jobs to WorkManager API", "pr_createdAt": "2020-04-15T19:32:45Z", "pr_url": "https://github.com/nextcloud/android/pull/5879", "timeline": [{"oid": "93e700fc66b295bfe7d498f61263820b802210c8", "url": "https://github.com/nextcloud/android/commit/93e700fc66b295bfe7d498f61263820b802210c8", "message": "Migrate FilesSyncJob to WorkManager API\n\nFilesSyncJob has been migrated to new WorkManager API:\n* FilesSyncJob.java converted to FilesSyncWork.kt\n* FilesSyncJob removed from code\n* Extended ETM screen to allow scheduling immediate\n  TestJob (for development experimentation)\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-15T19:34:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA4ODMwNQ==", "url": "https://github.com/nextcloud/android/pull/5879#discussion_r409088305", "bodyText": "This is FilesSyncJob.java auto-converted to Kotlin + few minor stylisting tweaks to satisfy Detekt and Ktlint. There is no functional change relative to old job logic.", "author": "ezaquarii", "createdAt": "2020-04-15T19:39:42Z", "path": "src/main/java/com/nextcloud/client/jobs/FilesSyncWork.kt", "diffHunk": "@@ -0,0 +1,234 @@\n+/*\n+ * Nextcloud Android client application\n+ *\n+ * @author Mario Danic\n+ * @author Chris Narkiewicz\n+ * Copyright (C) 2017 Mario Danic\n+ * Copyright (C) 2017 Nextcloud\n+ * Copyright (C) 2020 Chris Narkiewicz\n+ *\n+ * This program is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE\n+ * License as published by the Free Software Foundation; either\n+ * version 3 of the License, or any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU AFFERO GENERAL PUBLIC LICENSE for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public\n+ * License along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package com.nextcloud.client.jobs\n+\n+import android.content.ContentResolver\n+import android.content.Context\n+import android.content.res.Resources\n+import android.os.Build\n+import android.os.PowerManager\n+import android.os.PowerManager.WakeLock\n+import android.text.TextUtils\n+import androidx.exifinterface.media.ExifInterface\n+import androidx.work.Worker\n+import androidx.work.WorkerParameters\n+import com.nextcloud.client.account.UserAccountManager\n+import com.nextcloud.client.core.Clock\n+import com.nextcloud.client.device.PowerManagementService\n+import com.nextcloud.client.network.ConnectivityService\n+import com.nextcloud.client.preferences.AppPreferences\n+import com.owncloud.android.MainApp\n+import com.owncloud.android.R\n+import com.owncloud.android.datamodel.ArbitraryDataProvider\n+import com.owncloud.android.datamodel.FilesystemDataProvider\n+import com.owncloud.android.datamodel.MediaFolderType\n+import com.owncloud.android.datamodel.SyncedFolder\n+import com.owncloud.android.datamodel.SyncedFolderProvider\n+import com.owncloud.android.datamodel.UploadsStorageManager\n+import com.owncloud.android.files.services.FileUploader\n+import com.owncloud.android.lib.common.utils.Log_OC\n+import com.owncloud.android.operations.UploadFileOperation\n+import com.owncloud.android.ui.activity.SettingsActivity\n+import com.owncloud.android.utils.FileStorageUtils\n+import com.owncloud.android.utils.FilesSyncHelper\n+import com.owncloud.android.utils.MimeType\n+import com.owncloud.android.utils.MimeTypeUtil\n+import java.io.File\n+import java.text.ParsePosition\n+import java.text.SimpleDateFormat\n+import java.util.Locale\n+import java.util.TimeZone\n+\n+@Suppress(\"LongParameterList\") // legacy code\n+class FilesSyncWork(", "originalCommit": "93e700fc66b295bfe7d498f61263820b802210c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "419918f7dc720ee86f2381bf090508be94e950e0", "url": "https://github.com/nextcloud/android/commit/419918f7dc720ee86f2381bf090508be94e950e0", "message": "Migrate FilesSyncJob to WorkManager API\n\nFilesSyncJob has been migrated to new WorkManager API:\n* FilesSyncJob.java converted to FilesSyncWork.kt\n* FilesSyncJob removed from code\n* Extended ETM screen to allow scheduling immediate\n  TestJob (for development experimentation)\n* OfflineSyncJob.java conveted to OfflineSyncWork.kt\n* Fixed re-scheduling of content observer\n\nFixes #5881\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-15T22:21:50Z", "type": "forcePushed"}, {"oid": "d82c77b332ea30a985a17b0d901813a74e7a787e", "url": "https://github.com/nextcloud/android/commit/d82c77b332ea30a985a17b0d901813a74e7a787e", "message": "Migrate FilesSyncJob to WorkManager API\n\nFilesSyncJob has been migrated to new WorkManager API:\n* FilesSyncJob.java converted to FilesSyncWork.kt\n* FilesSyncJob removed from code\n* Extended ETM screen to allow scheduling immediate\n  TestJob (for development experimentation)\n* OfflineSyncJob.java conveted to OfflineSyncWork.kt\n* OfflineSyncJob removed from code\n* Fixed re-scheduling of content observer work\n\nFixes #5881\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-15T22:27:30Z", "type": "forcePushed"}, {"oid": "9e6c4e96e9a2c151ce04cb80cc55bdf0bdf88bdc", "url": "https://github.com/nextcloud/android/commit/9e6c4e96e9a2c151ce04cb80cc55bdf0bdf88bdc", "message": "Migrate FilesSyncJob and OfflineSyncJob to WorkManager API\n\nFilesSyncJob has been migrated to new WorkManager API:\n* FilesSyncJob.java converted to FilesSyncWork.kt\n* FilesSyncJob removed from code\n* Extended ETM screen to allow scheduling immediate\n  TestJob (for development experimentation)\n* OfflineSyncJob.java conveted to OfflineSyncWork.kt\n* OfflineSyncJob removed from code\n* Fixed re-scheduling of content observer work\n\nFixes #5881\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-15T22:28:56Z", "type": "forcePushed"}, {"oid": "46c1c24ee4b3d6b8aa4fb5d4e29db0ea28c17352", "url": "https://github.com/nextcloud/android/commit/46c1c24ee4b3d6b8aa4fb5d4e29db0ea28c17352", "message": "Migrate FilesSyncJob and OfflineSyncJob to WorkManager API\n\nFilesSyncJob has been migrated to new WorkManager API:\n* FilesSyncJob.java converted to FilesSyncWork.kt\n* FilesSyncJob removed from code\n* Extended ETM screen to allow scheduling immediate\n  TestJob (for development experimentation)\n* OfflineSyncJob.java conveted to OfflineSyncWork.kt\n* OfflineSyncJob removed from code\n* Fixed re-scheduling of content observer work\n\nFixes #5881\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-15T22:32:23Z", "type": "forcePushed"}, {"oid": "44f169a88f2292bc3d8effca37e2828dc67caea2", "url": "https://github.com/nextcloud/android/commit/44f169a88f2292bc3d8effca37e2828dc67caea2", "message": "Migrate FilesSyncJob and OfflineSyncJob to WorkManager API\n\nFilesSyncJob has been migrated to new WorkManager API:\n* FilesSyncJob.java converted to FilesSyncWork.kt\n* FilesSyncJob removed from code\n* Extended ETM screen to allow scheduling immediate\n  TestJob (for development experimentation)\n* OfflineSyncJob.java conveted to OfflineSyncWork.kt\n* OfflineSyncJob removed from code\n* Fixed re-scheduling of content observer work\n* MediaFoldersDetectionJob.java converted to\n  MediaFoldersDetectionWork.kt\n* MediaFolderDetectionJob removed from code\n\nFixes #5881\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-15T23:09:08Z", "type": "forcePushed"}, {"oid": "fb15e68e032b84bee3de2f1f51832855f0f78d85", "url": "https://github.com/nextcloud/android/commit/fb15e68e032b84bee3de2f1f51832855f0f78d85", "message": "Migrate file sync related jobs to WorkManager API\n\n* FilesSyncJob.java converted to FilesSyncWork.kt\n* FilesSyncJob removed from code\n* Extended ETM screen to allow scheduling immediate\n  TestJob (for development experimentation)\n* OfflineSyncJob.java conveted to OfflineSyncWork.kt\n* OfflineSyncJob removed from code\n* Fixed re-scheduling of content observer work\n* MediaFoldersDetectionJob.java converted to\n  MediaFoldersDetectionWork.kt\n* MediaFolderDetectionJob removed from code\n\nFixes #5881\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-16T00:08:24Z", "type": "forcePushed"}, {"oid": "87341c957aece81eaed59567fad3b62386704742", "url": "https://github.com/nextcloud/android/commit/87341c957aece81eaed59567fad3b62386704742", "message": "Migrate file sync related jobs to WorkManager API\n\n* FilesSyncJob.java converted to FilesSyncWork.kt\n* FilesSyncJob removed from code\n* Extended ETM screen to allow scheduling immediate\n  TestJob (for development experimentation)\n* OfflineSyncJob.java conveted to OfflineSyncWork.kt\n* OfflineSyncJob removed from code\n* Fixed re-scheduling of content observer work\n* MediaFoldersDetectionJob.java converted to\n  MediaFoldersDetectionWork.kt\n* MediaFolderDetectionJob removed from code\n\nFixes #5881\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-16T09:39:30Z", "type": "forcePushed"}, {"oid": "67e189be872b379522f5108492a3bed5cbb71720", "url": "https://github.com/nextcloud/android/commit/67e189be872b379522f5108492a3bed5cbb71720", "message": "Migrate file sync related jobs to WorkManager API\n\n* FilesSyncJob.java converted to FilesSyncWork.kt\n* FilesSyncJob removed from code\n* Extended ETM screen to allow scheduling immediate\n  TestJob (for development experimentation)\n* OfflineSyncJob.java conveted to OfflineSyncWork.kt\n* OfflineSyncJob removed from code\n* Fixed re-scheduling of content observer work\n* MediaFoldersDetectionJob.java converted to\n  MediaFoldersDetectionWork.kt\n* MediaFolderDetectionJob removed from code\n\nFixes #5881\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-16T09:44:28Z", "type": "forcePushed"}, {"oid": "90b598d47dc438a96444162842e993c39d854dc5", "url": "https://github.com/nextcloud/android/commit/90b598d47dc438a96444162842e993c39d854dc5", "message": "Migrate file sync related jobs to WorkManager API\n\n* FilesSyncJob.java converted to FilesSyncWork.kt\n* FilesSyncJob removed from code\n* Extended ETM screen to allow scheduling immediate\n  TestJob (for development experimentation)\n* OfflineSyncJob.java conveted to OfflineSyncWork.kt\n* OfflineSyncJob removed from code\n* Fixed re-scheduling of content observer work\n* MediaFoldersDetectionJob.java converted to\n  MediaFoldersDetectionWork.kt\n* MediaFolderDetectionJob removed from code\n\nFixes #5881\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-16T09:51:15Z", "type": "forcePushed"}, {"oid": "22f9279a3b8a1a6f28f8c524223e0db0ac747f9b", "url": "https://github.com/nextcloud/android/commit/22f9279a3b8a1a6f28f8c524223e0db0ac747f9b", "message": "Migrate file sync related jobs to WorkManager API\n\n* FilesSyncJob.java converted to FilesSyncWork.kt\n* FilesSyncJob removed from code\n* Extended ETM screen to allow scheduling immediate\n  TestJob (for development experimentation)\n* OfflineSyncJob.java conveted to OfflineSyncWork.kt\n* OfflineSyncJob removed from code\n* Fixed re-scheduling of content observer work\n* MediaFoldersDetectionJob.java converted to\n  MediaFoldersDetectionWork.kt\n* MediaFolderDetectionJob removed from code\n\nFixes #5881\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-16T11:51:38Z", "type": "forcePushed"}, {"oid": "34f724c48dddeda06dfea84a4241d4d52010cd02", "url": "https://github.com/nextcloud/android/commit/34f724c48dddeda06dfea84a4241d4d52010cd02", "message": "Start files sync job when enabling auto upload\n\nThis is #5885 solution ported to BackgroundJobManager API.\n\nFixes #5882\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-16T17:02:31Z", "type": "forcePushed"}, {"oid": "5ea217ee7ffae23c841f6aee32e3a81c2168e839", "url": "https://github.com/nextcloud/android/commit/5ea217ee7ffae23c841f6aee32e3a81c2168e839", "message": "Start files sync job when enabling auto upload\n\nThis is #5885 solution ported to BackgroundJobManager API.\n\nFixes #5882\nFixes #5898\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-18T13:06:22Z", "type": "forcePushed"}, {"oid": "77c4a3e6a58c69065197eb7ac263f241d9dbcca6", "url": "https://github.com/nextcloud/android/commit/77c4a3e6a58c69065197eb7ac263f241d9dbcca6", "message": "Migrate file sync related jobs to WorkManager API\n\n* FilesSyncJob.java converted to FilesSyncWork.kt\n* FilesSyncJob removed from code\n* Extended ETM screen to allow scheduling immediate\n  TestJob (for development experimentation)\n* OfflineSyncJob.java conveted to OfflineSyncWork.kt\n* OfflineSyncJob removed from code\n* Fixed re-scheduling of content observer work\n* MediaFoldersDetectionJob.java converted to\n  MediaFoldersDetectionWork.kt\n* MediaFolderDetectionJob removed from code\n\nFixes #5881\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-23T09:45:01Z", "type": "commit"}, {"oid": "d0a6fdc2da9400ce7877b7d7ad0a21c7f50d6f25", "url": "https://github.com/nextcloud/android/commit/d0a6fdc2da9400ce7877b7d7ad0a21c7f50d6f25", "message": "Start files sync job when enabling auto upload\n\nThis is #5885 solution ported to BackgroundJobManager API.\n\nFixes #5882\nFixes #5898\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-23T09:45:02Z", "type": "commit"}, {"oid": "d0a6fdc2da9400ce7877b7d7ad0a21c7f50d6f25", "url": "https://github.com/nextcloud/android/commit/d0a6fdc2da9400ce7877b7d7ad0a21c7f50d6f25", "message": "Start files sync job when enabling auto upload\n\nThis is #5885 solution ported to BackgroundJobManager API.\n\nFixes #5882\nFixes #5898\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-23T09:45:02Z", "type": "forcePushed"}, {"oid": "d6ad8f6c2f708ae37cfe9165daf16053f1ffee06", "url": "https://github.com/nextcloud/android/commit/d6ad8f6c2f708ae37cfe9165daf16053f1ffee06", "message": "Drone: update FindBugs results to reflect reduced error/warning count [skip ci]\n\nSigned-off-by: nextcloud-android-bot <android@nextcloud.com>", "committedDate": "2020-04-23T09:52:27Z", "type": "commit"}]}