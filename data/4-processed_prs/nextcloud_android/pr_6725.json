{"pr_number": 6725, "pr_title": "Improve performance of DocumentsProvider#isChildDocument()", "pr_createdAt": "2020-08-17T18:55:52Z", "pr_url": "https://github.com/nextcloud/android/pull/6725", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxMjM4MA==", "url": "https://github.com/nextcloud/android/pull/6725#discussion_r471712380", "bodyText": "This is an unrelated change I am hoping to sneak in here. Seeing this \"error\" in the logs is quite distracting when debugging things.\nIf you'd want to keep this as an error level log message, we should add a check if that file already exists.", "author": "grote", "createdAt": "2020-08-17T18:57:06Z", "path": "src/main/java/com/owncloud/android/operations/DownloadFileOperation.java", "diffHunk": "@@ -172,7 +172,8 @@ protected RemoteOperationResult run(OwnCloudClient client) {\n             etag = downloadOperation.getEtag();\n             newFile = new File(getSavePath());\n             if (!newFile.getParentFile().mkdirs()) {\n-                Log_OC.e(TAG, \"Unable to create parent folder \" + newFile.getParentFile().getAbsolutePath());\n+                // File#mkdirs() also returns false when the directory already existed, so this not a hard error\n+                Log_OC.d(TAG, \"Unable to create parent folder \" + newFile.getParentFile().getAbsolutePath());", "originalCommit": "a34325068803a4ea5dacb2b2572bb9ffb11d3141", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQxMDEzNg==", "url": "https://github.com/nextcloud/android/pull/6725#discussion_r475410136", "bodyText": "Can you change to !newFile.getParentFile().exists() &&!newFile.getParentFile().mkdirs()\nthen we only try to create the folder if it does not exist and thus the error is correct, if it fails.", "author": "tobiasKaminsky", "createdAt": "2020-08-24T07:59:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxMjM4MA=="}], "type": "inlineReview"}, {"oid": "2066d7b115db4cb4f24edee67e451259235024de", "url": "https://github.com/nextcloud/android/commit/2066d7b115db4cb4f24edee67e451259235024de", "message": "Improve performance of DocumentsProvider#isChildDocument()\n\nThe old solution iterates through all parents of the child until it\nfinds the given parent or the storage root.\nThis has been show to be very expensive in empirical tests.\n\nTherefore, this commit introduces a more efficient solution that simply\ncompares the file paths of child and given parent.\nIt also ensures that parent and child belong to the same account.\n\nReviewers need to take extra care that this change does not introduce\nsecurity issues by claiming a document is a child of a parent when it is\nreally not.\n\nSigned-off-by: Torsten Grote <t@grobox.de>", "committedDate": "2020-08-17T18:58:41Z", "type": "forcePushed"}, {"oid": "b8d90f2d8091c0e24595be69d5539e9687f69f8e", "url": "https://github.com/nextcloud/android/commit/b8d90f2d8091c0e24595be69d5539e9687f69f8e", "message": "DocumentsProvider: Take into account that files can be null\n\nThis can happen when files are deleted via the DocumentsProvider before\nother asynchronous operations had a chance to complete.", "committedDate": "2020-08-19T15:11:42Z", "type": "forcePushed"}, {"oid": "2c4ffb0774af4cf5a7fa8801d07df71211990e20", "url": "https://github.com/nextcloud/android/commit/2c4ffb0774af4cf5a7fa8801d07df71211990e20", "message": "DocumentsProvider: Take into account that files can be null\n\nThis can happen when files are deleted via the DocumentsProvider before\nother asynchronous operations had a chance to complete.\n\nSigned-off-by: Torsten Grote <t@grobox.de>", "committedDate": "2020-08-19T15:13:10Z", "type": "forcePushed"}, {"oid": "e8870334d2e89df4a898909f1a9faa362dbc0781", "url": "https://github.com/nextcloud/android/commit/e8870334d2e89df4a898909f1a9faa362dbc0781", "message": "Improve performance of DocumentsProvider#isChildDocument()\n\nThe old solution iterates through all parents of the child until it\nfinds the given parent or the storage root.\nThis has been show to be very expensive in empirical tests.\n\nTherefore, this commit introduces a more efficient solution that simply\ncompares the file paths of child and given parent.\nIt also ensures that parent and child belong to the same account.\n\nReviewers need to take extra care that this change does not introduce\nsecurity issues by claiming a document is a child of a parent when it is\nreally not.\n\nSigned-off-by: Torsten Grote <t@grobox.de>", "committedDate": "2020-08-25T12:32:48Z", "type": "commit"}, {"oid": "e8870334d2e89df4a898909f1a9faa362dbc0781", "url": "https://github.com/nextcloud/android/commit/e8870334d2e89df4a898909f1a9faa362dbc0781", "message": "Improve performance of DocumentsProvider#isChildDocument()\n\nThe old solution iterates through all parents of the child until it\nfinds the given parent or the storage root.\nThis has been show to be very expensive in empirical tests.\n\nTherefore, this commit introduces a more efficient solution that simply\ncompares the file paths of child and given parent.\nIt also ensures that parent and child belong to the same account.\n\nReviewers need to take extra care that this change does not introduce\nsecurity issues by claiming a document is a child of a parent when it is\nreally not.\n\nSigned-off-by: Torsten Grote <t@grobox.de>", "committedDate": "2020-08-25T12:32:48Z", "type": "forcePushed"}]}