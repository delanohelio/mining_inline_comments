{"pr_number": 5546, "pr_title": "Migrations manager", "pr_createdAt": "2020-02-28T23:39:26Z", "pr_url": "https://github.com/nextcloud/android/pull/5546", "timeline": [{"oid": "bf3f398dd565e91d066cd2593fae331604fa1447", "url": "https://github.com/nextcloud/android/commit/bf3f398dd565e91d066cd2593fae331604fa1447", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-29T22:31:16Z", "type": "forcePushed"}, {"oid": "9e00fd0dcbc82924d3e972718d4da99989cccff2", "url": "https://github.com/nextcloud/android/commit/9e00fd0dcbc82924d3e972718d4da99989cccff2", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-29T22:53:31Z", "type": "forcePushed"}, {"oid": "e34999b49e79054ee1214fa0a8a9e8d65a7b2092", "url": "https://github.com/nextcloud/android/commit/e34999b49e79054ee1214fa0a8a9e8d65a7b2092", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-01T06:43:46Z", "type": "forcePushed"}, {"oid": "c930137860869e2b0fc6279f96e986ee10d364c2", "url": "https://github.com/nextcloud/android/commit/c930137860869e2b0fc6279f96e986ee10d364c2", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-01T08:35:04Z", "type": "forcePushed"}, {"oid": "553a52ec20b431a4de028e37e26d5995bbe6cce9", "url": "https://github.com/nextcloud/android/commit/553a52ec20b431a4de028e37e26d5995bbe6cce9", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-01T21:47:21Z", "type": "forcePushed"}, {"oid": "e51b8e70690c4fd052da88d37a925de97d718f99", "url": "https://github.com/nextcloud/android/commit/e51b8e70690c4fd052da88d37a925de97d718f99", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-03T06:11:33Z", "type": "forcePushed"}, {"oid": "e80c2a0e2cddee877b4c6b4c07143fcaa328353a", "url": "https://github.com/nextcloud/android/commit/e80c2a0e2cddee877b4c6b4c07143fcaa328353a", "message": "Enabled migration manager in MainApp\n\nMigration manager added to DI.\n\nMigration manager called in place of legacy migration code.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-03T23:17:48Z", "type": "forcePushed"}, {"oid": "62407e5c5c60f1b4bfec363c362527c4fc13bd2d", "url": "https://github.com/nextcloud/android/commit/62407e5c5c60f1b4bfec363c362527c4fc13bd2d", "message": "Properly signal error when user id migration fails\n\nPrevious implementation was returning success status\nwhen *any* account was migrated, despite possible\nfailures.\n\nReturn error when any account fails to be migrated.\n\nThe migration remines idempotent and can be re-run\nagain, until if finally succeeds.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-04T06:14:29Z", "type": "forcePushed"}, {"oid": "22c9c7a1b6317ecac730147c17d4aaa1537b23a8", "url": "https://github.com/nextcloud/android/commit/22c9c7a1b6317ecac730147c17d4aaa1537b23a8", "message": "Properly signal error when user id migration fails\n\nPrevious implementation was returning success status\nwhen *any* account was migrated, despite possible\nfailures.\n\nReturn error when any account fails to be migrated.\n\nThe migration remines idempotent and can be re-run\nagain, until if finally succeeds.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-04T06:16:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI2MTQ4Mg==", "url": "https://github.com/nextcloud/android/pull/5546#discussion_r388261482", "bodyText": "typo: account", "author": "tobiasKaminsky", "createdAt": "2020-03-05T12:26:36Z", "path": "src/main/java/com/nextcloud/client/migrations/Migrations.kt", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Nextcloud Android client application\n+ *\n+ * @author Chris Narkiewicz\n+ * Copyright (C) 2020 Chris Narkiewicz <hello@ezaquarii.com>\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package com.nextcloud.client.migrations\n+\n+import com.nextcloud.client.account.UserAccountManager\n+import javax.inject.Inject\n+import kotlin.IllegalStateException\n+\n+/**\n+ * This class collects all migration steps and provides API to supply those\n+ * steps to [MigrationsManager] for execution.\n+ *\n+ * Note to maintainers: put all migration routines here and export collection of\n+ * opaque [Runnable]s via steps property.\n+ */\n+class Migrations @Inject constructor(\n+    private val userAccountManager: UserAccountManager\n+) {\n+\n+    /**\n+     * @param id Step id; id must be unique\n+     * @param description Human readable migration step description\n+     * @param function Migration runnable object\n+     * @param mandatory If true, failing migration will cause an exception; if false, it will be skipped and repeated\n+     *                  again on next startup\n+     */\n+    data class Step(val id: Int, val description: String, val function: Runnable, val mandatory: Boolean = true)\n+\n+    /**\n+     * List of migration steps. Those steps will be loaded and run by [MigrationsManager]\n+     */\n+    val steps: List<Step> = listOf(\n+        Step(0, \"migrate user id\", Runnable { migrateUserId() }, false)\n+    ).sortedBy { it.id }\n+\n+    fun migrateUserId() {\n+        val allAccuntsHaveUserId = userAccountManager.migrateUserId()", "originalCommit": "22c9c7a1b6317ecac730147c17d4aaa1537b23a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2NDk3Mg==", "url": "https://github.com/nextcloud/android/pull/5546#discussion_r388564972", "bodyText": "fixed the typo", "author": "ezaquarii", "createdAt": "2020-03-05T21:05:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI2MTQ4Mg=="}], "type": "inlineReview"}, {"oid": "7d4f446586a8cd639e2947a0cbc133ef651b867e", "url": "https://github.com/nextcloud/android/commit/7d4f446586a8cd639e2947a0cbc133ef651b867e", "message": "Properly signal error when user id migration fails\n\nPrevious implementation was returning success status\nwhen *any* account was migrated, despite possible\nfailures.\n\nReturn error when any account fails to be migrated.\n\nThe migration remines idempotent and can be re-run\nagain, until if finally succeeds.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-05T21:03:40Z", "type": "forcePushed"}, {"oid": "b87bf1f10e631786dfee9203813835595f615292", "url": "https://github.com/nextcloud/android/commit/b87bf1f10e631786dfee9203813835595f615292", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-06T09:35:56Z", "type": "commit"}, {"oid": "1ab8d98d8510a0168bc4139e47f7758fc56988d2", "url": "https://github.com/nextcloud/android/commit/1ab8d98d8510a0168bc4139e47f7758fc56988d2", "message": "Support for optional migrations\n\nOptional migrations care not causing migration failure\nand can be applied again on next application run.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-06T09:35:57Z", "type": "commit"}, {"oid": "439dd4ff780fe9501be1a066ea1f99d7884aae2a", "url": "https://github.com/nextcloud/android/commit/439dd4ff780fe9501be1a066ea1f99d7884aae2a", "message": "Removed MigrationManager Robolectric tests\n\nRobolectric tests are removed as we don't want to emulate\nplatform.\n\nRenamed instrumentation tests to match expected naming.\n\nUpdated detekt rule to allow human readable test function\nnames in kt files. This naming convention was adopted in\ntest code to enable human-readable test reports, but\nDEX does not support spaces in names. Underscore _ is\na good replacement providnig similar level of readability.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-06T09:35:57Z", "type": "commit"}, {"oid": "9ef27576e1742ff5fdabc99bfd52baddf53b818b", "url": "https://github.com/nextcloud/android/commit/9ef27576e1742ff5fdabc99bfd52baddf53b818b", "message": "Enabled migration manager in MainApp\n\nMigration manager added to DI.\n\nMigration manager called in place of legacy migration code.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-06T09:35:57Z", "type": "commit"}, {"oid": "1ba288e5e68a1918baffda2cec45fe6a4b310333", "url": "https://github.com/nextcloud/android/commit/1ba288e5e68a1918baffda2cec45fe6a4b310333", "message": "Properly signal error when user id migration fails\n\nPrevious implementation was returning success status\nwhen *any* account was migrated, despite possible\nfailures.\n\nReturn error when any account fails to be migrated.\n\nThe migration remines idempotent and can be re-run\nagain, until if finally succeeds.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-06T09:35:57Z", "type": "commit"}, {"oid": "5872a973a799e088501f4e19d08c231488d9ad19", "url": "https://github.com/nextcloud/android/commit/5872a973a799e088501f4e19d08c231488d9ad19", "message": "Bump after rebase\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-03-06T09:36:10Z", "type": "commit"}, {"oid": "5872a973a799e088501f4e19d08c231488d9ad19", "url": "https://github.com/nextcloud/android/commit/5872a973a799e088501f4e19d08c231488d9ad19", "message": "Bump after rebase\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-03-06T09:36:10Z", "type": "forcePushed"}]}