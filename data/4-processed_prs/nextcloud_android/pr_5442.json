{"pr_number": 5442, "pr_title": "Fix crash during text file creation", "pr_createdAt": "2020-02-10T06:53:06Z", "pr_url": "https://github.com/nextcloud/android/pull/5442", "timeline": [{"oid": "080d5d3bb5055f3376226d03b48b56ddd41815eb", "url": "https://github.com/nextcloud/android/commit/080d5d3bb5055f3376226d03b48b56ddd41815eb", "message": "Fix crash during text file creation\n\nFixes #5330\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-10T06:53:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg5MTQ1MA==", "url": "https://github.com/nextcloud/android/pull/5442#discussion_r376891450", "bodyText": "This is pretty common error I see. Both activities and fragments are passed as weak references to avoid leaks, but in case of fragment we must check if it has been detached.", "author": "ezaquarii", "createdAt": "2020-02-10T06:55:36Z", "path": "src/main/java/com/owncloud/android/ui/dialog/ChooseTemplateDialogFragment.java", "diffHunk": "@@ -241,35 +242,36 @@ protected String doInBackground(Void... voids) {\n                     new DirectEditingCreateFileRemoteOperation(path,\n                                                                creator.getEditor(),\n                                                                creator.getId(),\n-                                                               template.getTitle())\n-                        .execute(client);\n-\n-                if (result.isSuccess()) {\n-                    // get file\n-                    RemoteOperationResult newFileResult = new ReadFileRemoteOperation(path)\n-                            .execute(client);\n-\n-                    if (newFileResult.isSuccess()) {\n-                        OCFile temp = FileStorageUtils.fillOCFile((RemoteFile) newFileResult.getData().get(0));\n-\n-                        if (chooseTemplateDialogFragmentWeakReference.get() != null) {\n-                            FileDataStorageManager storageManager = new FileDataStorageManager(\n-                                user.toPlatformAccount(),\n-                                chooseTemplateDialogFragmentWeakReference.get().requireContext().getContentResolver());", "originalCommit": "080d5d3bb5055f3376226d03b48b56ddd41815eb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzAwODY3NQ==", "url": "https://github.com/nextcloud/android/pull/5442#discussion_r377008675", "bodyText": "There is also \"isAdded\" or \"isDetached\", which we can use, or?\ngetContext is: return mHost == null ? null : mHost.getContext()\nisAdded is: return mHost != null && mAdded\nSo isAdded might even the more extensive check, or?", "author": "tobiasKaminsky", "createdAt": "2020-02-10T11:32:16Z", "path": "src/main/java/com/owncloud/android/ui/dialog/ChooseTemplateDialogFragment.java", "diffHunk": "@@ -241,35 +242,36 @@ protected String doInBackground(Void... voids) {\n                     new DirectEditingCreateFileRemoteOperation(path,\n                                                                creator.getEditor(),\n                                                                creator.getId(),\n-                                                               template.getTitle())\n-                        .execute(client);\n-\n-                if (result.isSuccess()) {\n-                    // get file\n-                    RemoteOperationResult newFileResult = new ReadFileRemoteOperation(path)\n-                            .execute(client);\n-\n-                    if (newFileResult.isSuccess()) {\n-                        OCFile temp = FileStorageUtils.fillOCFile((RemoteFile) newFileResult.getData().get(0));\n-\n-                        if (chooseTemplateDialogFragmentWeakReference.get() != null) {\n-                            FileDataStorageManager storageManager = new FileDataStorageManager(\n-                                user.toPlatformAccount(),\n-                                chooseTemplateDialogFragmentWeakReference.get().requireContext().getContentResolver());\n-                            storageManager.saveFile(temp);\n-                            file = storageManager.getFileByPath(path);\n-\n-                            return result.getData().get(0).toString();\n-                        }\n-                         else {\n-                             return \"\";\n-                        }\n-                    } else {\n-                        return \"\";\n-                    }\n-                } else {\n+                                                               template.getTitle()).execute(client);\n+                if (!result.isSuccess()) {\n+                    return \"\";\n+                }\n+\n+                RemoteOperationResult newFileResult = new ReadFileRemoteOperation(path).execute(client);\n+                if (!newFileResult.isSuccess()) {\n                     return \"\";\n                 }\n+\n+                OCFile temp = FileStorageUtils.fillOCFile((RemoteFile) newFileResult.getData().get(0));\n+\n+                final ChooseTemplateDialogFragment fragment = chooseTemplateDialogFragmentWeakReference.get();\n+                if (fragment == null) {\n+                    return \"\";\n+                }\n+\n+                final Context context = fragment.getContext();\n+                if (context == null) {", "originalCommit": "9780677626fdce6dcc21ebd23c861a04066dfdc9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE0Mjk1Mg==", "url": "https://github.com/nextcloud/android/pull/5442#discussion_r379142952", "bodyText": "Yes, you can use that, as it calls @NonNull FragmentHostCallback.getContext().\nHowever, because subsequent call to getContext() is not @NonNull, linter will still complain that you use nullable Context, encouraging another, rendundant check.\nBecause the action run here is not related to UI elements displayed on the screen, we can rely on Context check without risk of any glitches.\nAndroid API is not a pinnacle of software engineering, and Fragment API is of particularly bad reputation in general. I'd say that looking for an inspiration for best practices in the official documentation is rather risky endeavour. :)", "author": "ezaquarii", "createdAt": "2020-02-13T21:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzAwODY3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMzNjczNg==", "url": "https://github.com/nextcloud/android/pull/5442#discussion_r379336736", "bodyText": "True.\nThen let us keep it this way \ud83d\udc4d", "author": "tobiasKaminsky", "createdAt": "2020-02-14T09:47:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzAwODY3NQ=="}], "type": "inlineReview"}, {"oid": "9c9541c1d73c144742b5c94dda51f5c2e3f07ec7", "url": "https://github.com/nextcloud/android/commit/9c9541c1d73c144742b5c94dda51f5c2e3f07ec7", "message": "Fix crash during text file creation\n\nFixes #5330\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-13T22:08:31Z", "type": "forcePushed"}, {"oid": "7583fab7e71b50c720b123ae14679ebab1eb88d6", "url": "https://github.com/nextcloud/android/commit/7583fab7e71b50c720b123ae14679ebab1eb88d6", "message": "Fix crash during text file creation\n\nFixes #5330\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-02-13T22:34:20Z", "type": "forcePushed"}, {"oid": "0977c37916079f984d500dc700a19c76a9862d76", "url": "https://github.com/nextcloud/android/commit/0977c37916079f984d500dc700a19c76a9862d76", "message": "Fix crash during text file creation\n\nFixes #5330\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-02-17T08:30:37Z", "type": "commit"}, {"oid": "0977c37916079f984d500dc700a19c76a9862d76", "url": "https://github.com/nextcloud/android/commit/0977c37916079f984d500dc700a19c76a9862d76", "message": "Fix crash during text file creation\n\nFixes #5330\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-02-17T08:30:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0MTUwNQ==", "url": "https://github.com/nextcloud/android/pull/5442#discussion_r380041505", "bodyText": "Issue found: Avoid declaring a variable if it is unreferenced before a possible exit point.", "author": "nextcloud-android-bot", "createdAt": "2020-02-17T08:34:15Z", "path": "src/main/java/com/owncloud/android/ui/dialog/ChooseTemplateDialogFragment.java", "diffHunk": "@@ -241,35 +242,36 @@ protected String doInBackground(Void... voids) {\n                     new DirectEditingCreateFileRemoteOperation(path,\n                                                                creator.getEditor(),\n                                                                creator.getId(),\n-                                                               template.getTitle())\n-                        .execute(client);\n-\n-                if (result.isSuccess()) {\n-                    // get file\n-                    RemoteOperationResult newFileResult = new ReadFileRemoteOperation(path)\n-                            .execute(client);\n-\n-                    if (newFileResult.isSuccess()) {\n-                        OCFile temp = FileStorageUtils.fillOCFile((RemoteFile) newFileResult.getData().get(0));\n-\n-                        if (chooseTemplateDialogFragmentWeakReference.get() != null) {\n-                            FileDataStorageManager storageManager = new FileDataStorageManager(\n-                                user.toPlatformAccount(),\n-                                chooseTemplateDialogFragmentWeakReference.get().requireContext().getContentResolver());\n-                            storageManager.saveFile(temp);\n-                            file = storageManager.getFileByPath(path);\n-\n-                            return result.getData().get(0).toString();\n-                        }\n-                         else {\n-                             return \"\";\n-                        }\n-                    } else {\n-                        return \"\";\n-                    }\n-                } else {\n+                                                               template.getTitle()).execute(client);\n+                if (!result.isSuccess()) {\n+                    return \"\";\n+                }\n+\n+                RemoteOperationResult newFileResult = new ReadFileRemoteOperation(path).execute(client);\n+                if (!newFileResult.isSuccess()) {\n                     return \"\";\n                 }\n+\n+                OCFile temp = FileStorageUtils.fillOCFile((RemoteFile) newFileResult.getData().get(0));", "originalCommit": "0977c37916079f984d500dc700a19c76a9862d76", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}