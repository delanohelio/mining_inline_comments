{"pr_number": 5756, "pr_title": "Migrate contacts import job to new API", "pr_createdAt": "2020-03-27T23:45:45Z", "pr_url": "https://github.com/nextcloud/android/pull/5756", "timeline": [{"oid": "606c82f69cb0f96b5dc7ecedacfb1bc2cf3f988d", "url": "https://github.com/nextcloud/android/commit/606c82f69cb0f96b5dc7ecedacfb1bc2cf3f988d", "message": "Migrate contacts import job to new API\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-27T23:48:14Z", "type": "forcePushed"}, {"oid": "5204ba754105ad62c3cc0c7c9fcf9b4c2508b6fb", "url": "https://github.com/nextcloud/android/commit/5204ba754105ad62c3cc0c7c9fcf9b4c2508b6fb", "message": "Migrate contacts import job to new API\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-28T22:07:03Z", "type": "commit"}, {"oid": "5204ba754105ad62c3cc0c7c9fcf9b4c2508b6fb", "url": "https://github.com/nextcloud/android/commit/5204ba754105ad62c3cc0c7c9fcf9b4c2508b6fb", "message": "Migrate contacts import job to new API\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-03-28T22:07:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcxNTU1Nw==", "url": "https://github.com/nextcloud/android/pull/5756#discussion_r399715557", "bodyText": "Issue found: Avoid instantiating new objects inside loops", "author": "nextcloud-android-bot", "createdAt": "2020-03-28T22:10:07Z", "path": "src/main/java/com/owncloud/android/ui/fragment/contactsbackup/ContactListFragment.java", "diffHunk": "@@ -409,10 +399,10 @@ private void getAccountForImport() {\n                     String name = cursor.getString(cursor.getColumnIndex(ContactsContract.RawContacts.ACCOUNT_NAME));\n                     String type = cursor.getString(cursor.getColumnIndex(ContactsContract.RawContacts.ACCOUNT_TYPE));\n \n-                    ContactAccount account = new ContactAccount(name, name, type);\n+                    ContactsAccount account = new ContactsAccount(name, name, type);", "originalCommit": "5204ba754105ad62c3cc0c7c9fcf9b4c2508b6fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxNzM1OA==", "url": "https://github.com/nextcloud/android/pull/5756#discussion_r404917358", "bodyText": "Rename only. No logic chage intended at this tage so I propose we wontfix it.", "author": "ezaquarii", "createdAt": "2020-04-07T15:49:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcxNTU1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcxNTU1OQ==", "url": "https://github.com/nextcloud/android/pull/5756#discussion_r399715559", "bodyText": "Issue found: ComplexMethod - 12/10 - [doWork] at /src/src/main/java/com/nextcloud/client/jobs/ContactsImportWork.kt:59:18", "author": "nextcloud-android-bot", "createdAt": "2020-03-28T22:10:08Z", "path": "src/main/java/com/nextcloud/client/jobs/ContactsImportWork.kt", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Nextcloud Android client application\n+ *\n+ * @author Tobias Kaminsky\n+ * Copyright (C) 2017 Tobias Kaminsky\n+ * Copyright (C) 2017 Nextcloud GmbH.\n+ * Copyright (C) 2020 Chris Narkiewicz <hello@ezaquarii.com>\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package com.nextcloud.client.jobs\n+\n+import android.content.ContentResolver\n+import android.content.Context\n+import android.database.Cursor\n+import android.net.Uri\n+import android.provider.ContactsContract\n+import androidx.work.Worker\n+import androidx.work.WorkerParameters\n+import com.nextcloud.client.logger.Logger\n+import com.owncloud.android.ui.fragment.contactsbackup.ContactListFragment\n+import com.owncloud.android.ui.fragment.contactsbackup.ContactListFragment.VCardComparator\n+import ezvcard.Ezvcard\n+import ezvcard.VCard\n+import third_parties.ezvcard_android.ContactOperations\n+import java.io.File\n+import java.io.IOException\n+import java.util.ArrayList\n+import java.util.Collections\n+import java.util.TreeMap\n+\n+class ContactsImportWork(\n+    appContext: Context,\n+    params: WorkerParameters,\n+    private val logger: Logger,\n+    private val contentResolver: ContentResolver\n+) : Worker(appContext, params) {\n+\n+    companion object {\n+        const val TAG = \"ContactsImportWork\"\n+        const val ACCOUNT_TYPE = \"account_type\"\n+        const val ACCOUNT_NAME = \"account_name\"\n+        const val VCARD_FILE_PATH = \"vcard_file_path\"\n+        const val SELECTED_CONTACTS_INDICES = \"selected_contacts_indices\"\n+    }\n+\n+    override fun doWork(): Result {", "originalCommit": "5204ba754105ad62c3cc0c7c9fcf9b4c2508b6fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxNjM4Mg==", "url": "https://github.com/nextcloud/android/pull/5756#discussion_r404916382", "bodyText": "This is legacy code copied and converted to Kotlin. No changes to logic are intended at this stage to limit the risk.", "author": "ezaquarii", "createdAt": "2020-04-07T15:48:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcxNTU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcxNTU2MQ==", "url": "https://github.com/nextcloud/android/pull/5756#discussion_r399715561", "bodyText": "Issue found: NestedBlockDepth - 4/4 - [doWork] at /src/src/main/java/com/nextcloud/client/jobs/ContactsImportWork.kt:59:18", "author": "nextcloud-android-bot", "createdAt": "2020-03-28T22:10:09Z", "path": "src/main/java/com/nextcloud/client/jobs/ContactsImportWork.kt", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Nextcloud Android client application\n+ *\n+ * @author Tobias Kaminsky\n+ * Copyright (C) 2017 Tobias Kaminsky\n+ * Copyright (C) 2017 Nextcloud GmbH.\n+ * Copyright (C) 2020 Chris Narkiewicz <hello@ezaquarii.com>\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package com.nextcloud.client.jobs\n+\n+import android.content.ContentResolver\n+import android.content.Context\n+import android.database.Cursor\n+import android.net.Uri\n+import android.provider.ContactsContract\n+import androidx.work.Worker\n+import androidx.work.WorkerParameters\n+import com.nextcloud.client.logger.Logger\n+import com.owncloud.android.ui.fragment.contactsbackup.ContactListFragment\n+import com.owncloud.android.ui.fragment.contactsbackup.ContactListFragment.VCardComparator\n+import ezvcard.Ezvcard\n+import ezvcard.VCard\n+import third_parties.ezvcard_android.ContactOperations\n+import java.io.File\n+import java.io.IOException\n+import java.util.ArrayList\n+import java.util.Collections\n+import java.util.TreeMap\n+\n+class ContactsImportWork(\n+    appContext: Context,\n+    params: WorkerParameters,\n+    private val logger: Logger,\n+    private val contentResolver: ContentResolver\n+) : Worker(appContext, params) {\n+\n+    companion object {\n+        const val TAG = \"ContactsImportWork\"\n+        const val ACCOUNT_TYPE = \"account_type\"\n+        const val ACCOUNT_NAME = \"account_name\"\n+        const val VCARD_FILE_PATH = \"vcard_file_path\"\n+        const val SELECTED_CONTACTS_INDICES = \"selected_contacts_indices\"\n+    }\n+\n+    override fun doWork(): Result {", "originalCommit": "5204ba754105ad62c3cc0c7c9fcf9b4c2508b6fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxNjU1Mg==", "url": "https://github.com/nextcloud/android/pull/5756#discussion_r404916552", "bodyText": "This is legacy code copied and converted to Kotlin. No changes to logic are intended at this stage to limit the risk.", "author": "ezaquarii", "createdAt": "2020-04-07T15:48:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcxNTU2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcxNTU2NQ==", "url": "https://github.com/nextcloud/android/pull/5756#discussion_r399715565", "bodyText": "Issue found: TooGenericExceptionCaught - [e] at /src/src/main/java/com/nextcloud/client/jobs/ContactsImportWork.kt:103:18", "author": "nextcloud-android-bot", "createdAt": "2020-03-28T22:10:10Z", "path": "src/main/java/com/nextcloud/client/jobs/ContactsImportWork.kt", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Nextcloud Android client application\n+ *\n+ * @author Tobias Kaminsky\n+ * Copyright (C) 2017 Tobias Kaminsky\n+ * Copyright (C) 2017 Nextcloud GmbH.\n+ * Copyright (C) 2020 Chris Narkiewicz <hello@ezaquarii.com>\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package com.nextcloud.client.jobs\n+\n+import android.content.ContentResolver\n+import android.content.Context\n+import android.database.Cursor\n+import android.net.Uri\n+import android.provider.ContactsContract\n+import androidx.work.Worker\n+import androidx.work.WorkerParameters\n+import com.nextcloud.client.logger.Logger\n+import com.owncloud.android.ui.fragment.contactsbackup.ContactListFragment\n+import com.owncloud.android.ui.fragment.contactsbackup.ContactListFragment.VCardComparator\n+import ezvcard.Ezvcard\n+import ezvcard.VCard\n+import third_parties.ezvcard_android.ContactOperations\n+import java.io.File\n+import java.io.IOException\n+import java.util.ArrayList\n+import java.util.Collections\n+import java.util.TreeMap\n+\n+class ContactsImportWork(\n+    appContext: Context,\n+    params: WorkerParameters,\n+    private val logger: Logger,\n+    private val contentResolver: ContentResolver\n+) : Worker(appContext, params) {\n+\n+    companion object {\n+        const val TAG = \"ContactsImportWork\"\n+        const val ACCOUNT_TYPE = \"account_type\"\n+        const val ACCOUNT_NAME = \"account_name\"\n+        const val VCARD_FILE_PATH = \"vcard_file_path\"\n+        const val SELECTED_CONTACTS_INDICES = \"selected_contacts_indices\"\n+    }\n+\n+    override fun doWork(): Result {\n+        val vCardFilePath = inputData.getString(VCARD_FILE_PATH) ?: \"\"\n+        val contactsAccountName = inputData.getString(ACCOUNT_NAME)\n+        val contactsAccountType = inputData.getString(ACCOUNT_TYPE)\n+        val selectedContactsIndices = inputData.getIntArray(SELECTED_CONTACTS_INDICES) ?: IntArray(0)\n+\n+        val file = File(vCardFilePath)\n+        val vCards = ArrayList<VCard>()\n+\n+        var cursor: Cursor? = null\n+        try {\n+            val operations = ContactOperations(applicationContext, contactsAccountName, contactsAccountType)\n+            vCards.addAll(Ezvcard.parse(file).all())\n+            Collections.sort(vCards, VCardComparator())\n+            cursor = contentResolver.query(\n+                ContactsContract.Contacts.CONTENT_URI,\n+                null,\n+                null,\n+                null,\n+                null\n+            )\n+            val ownContactMap = TreeMap<VCard, Long?>(VCardComparator())\n+            if (cursor != null && cursor.count > 0) {\n+                cursor.moveToFirst()\n+                for (i in 0 until cursor.count) {\n+                    val vCard = getContactFromCursor(cursor)\n+                    if (vCard != null) {\n+                        ownContactMap[vCard] = cursor.getLong(cursor.getColumnIndex(\"NAME_RAW_CONTACT_ID\"))\n+                    }\n+                    cursor.moveToNext()\n+                }\n+            }\n+            for (contactIndex in selectedContactsIndices) {\n+                val vCard = vCards[contactIndex]\n+                if (ContactListFragment.getDisplayName(vCard).isEmpty()) {\n+                    if (!ownContactMap.containsKey(vCard)) {\n+                        operations.insertContact(vCard)\n+                    } else {\n+                        operations.updateContact(vCard, ownContactMap[vCard])\n+                    }\n+                } else {\n+                    operations.insertContact(vCard) // Insert All the contacts without name\n+                }\n+            }\n+        } catch (e: Exception) {", "originalCommit": "5204ba754105ad62c3cc0c7c9fcf9b4c2508b6fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxNjY3OA==", "url": "https://github.com/nextcloud/android/pull/5756#discussion_r404916678", "bodyText": "This is legacy code copied and converted to Kotlin. No changes to logic are intended at this stage to limit the risk.", "author": "ezaquarii", "createdAt": "2020-04-07T15:48:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcxNTU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk2ODQ0MQ==", "url": "https://github.com/nextcloud/android/pull/5756#discussion_r399968441", "bodyText": "shouldn't we rather log the whole exception as in stack trace?", "author": "AndyScherzinger", "createdAt": "2020-03-30T07:06:58Z", "path": "src/main/java/com/nextcloud/client/jobs/ContactsImportWork.kt", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Nextcloud Android client application\n+ *\n+ * @author Tobias Kaminsky\n+ * Copyright (C) 2017 Tobias Kaminsky\n+ * Copyright (C) 2017 Nextcloud GmbH.\n+ * Copyright (C) 2020 Chris Narkiewicz <hello@ezaquarii.com>\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package com.nextcloud.client.jobs\n+\n+import android.content.ContentResolver\n+import android.content.Context\n+import android.database.Cursor\n+import android.net.Uri\n+import android.provider.ContactsContract\n+import androidx.work.Worker\n+import androidx.work.WorkerParameters\n+import com.nextcloud.client.logger.Logger\n+import com.owncloud.android.ui.fragment.contactsbackup.ContactListFragment\n+import com.owncloud.android.ui.fragment.contactsbackup.ContactListFragment.VCardComparator\n+import ezvcard.Ezvcard\n+import ezvcard.VCard\n+import third_parties.ezvcard_android.ContactOperations\n+import java.io.File\n+import java.io.IOException\n+import java.util.ArrayList\n+import java.util.Collections\n+import java.util.TreeMap\n+\n+class ContactsImportWork(\n+    appContext: Context,\n+    params: WorkerParameters,\n+    private val logger: Logger,\n+    private val contentResolver: ContentResolver\n+) : Worker(appContext, params) {\n+\n+    companion object {\n+        const val TAG = \"ContactsImportWork\"\n+        const val ACCOUNT_TYPE = \"account_type\"\n+        const val ACCOUNT_NAME = \"account_name\"\n+        const val VCARD_FILE_PATH = \"vcard_file_path\"\n+        const val SELECTED_CONTACTS_INDICES = \"selected_contacts_indices\"\n+    }\n+\n+    override fun doWork(): Result {\n+        val vCardFilePath = inputData.getString(VCARD_FILE_PATH) ?: \"\"\n+        val contactsAccountName = inputData.getString(ACCOUNT_NAME)\n+        val contactsAccountType = inputData.getString(ACCOUNT_TYPE)\n+        val selectedContactsIndices = inputData.getIntArray(SELECTED_CONTACTS_INDICES) ?: IntArray(0)\n+\n+        val file = File(vCardFilePath)\n+        val vCards = ArrayList<VCard>()\n+\n+        var cursor: Cursor? = null\n+        try {\n+            val operations = ContactOperations(applicationContext, contactsAccountName, contactsAccountType)\n+            vCards.addAll(Ezvcard.parse(file).all())\n+            Collections.sort(vCards, VCardComparator())\n+            cursor = contentResolver.query(\n+                ContactsContract.Contacts.CONTENT_URI,\n+                null,\n+                null,\n+                null,\n+                null\n+            )\n+            val ownContactMap = TreeMap<VCard, Long?>(VCardComparator())\n+            if (cursor != null && cursor.count > 0) {\n+                cursor.moveToFirst()\n+                for (i in 0 until cursor.count) {\n+                    val vCard = getContactFromCursor(cursor)\n+                    if (vCard != null) {\n+                        ownContactMap[vCard] = cursor.getLong(cursor.getColumnIndex(\"NAME_RAW_CONTACT_ID\"))\n+                    }\n+                    cursor.moveToNext()\n+                }\n+            }\n+            for (contactIndex in selectedContactsIndices) {\n+                val vCard = vCards[contactIndex]\n+                if (ContactListFragment.getDisplayName(vCard).isEmpty()) {\n+                    if (!ownContactMap.containsKey(vCard)) {\n+                        operations.insertContact(vCard)\n+                    } else {\n+                        operations.updateContact(vCard, ownContactMap[vCard])\n+                    }\n+                } else {\n+                    operations.insertContact(vCard) // Insert All the contacts without name\n+                }\n+            }\n+        } catch (e: Exception) {\n+            logger.e(TAG, \"${e.message}\")", "originalCommit": "5204ba754105ad62c3cc0c7c9fcf9b4c2508b6fb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk2ODU5NA==", "url": "https://github.com/nextcloud/android/pull/5756#discussion_r399968594", "bodyText": "same here, no logging of the StackTrace", "author": "AndyScherzinger", "createdAt": "2020-03-30T07:07:17Z", "path": "src/main/java/com/nextcloud/client/jobs/ContactsImportWork.kt", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Nextcloud Android client application\n+ *\n+ * @author Tobias Kaminsky\n+ * Copyright (C) 2017 Tobias Kaminsky\n+ * Copyright (C) 2017 Nextcloud GmbH.\n+ * Copyright (C) 2020 Chris Narkiewicz <hello@ezaquarii.com>\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package com.nextcloud.client.jobs\n+\n+import android.content.ContentResolver\n+import android.content.Context\n+import android.database.Cursor\n+import android.net.Uri\n+import android.provider.ContactsContract\n+import androidx.work.Worker\n+import androidx.work.WorkerParameters\n+import com.nextcloud.client.logger.Logger\n+import com.owncloud.android.ui.fragment.contactsbackup.ContactListFragment\n+import com.owncloud.android.ui.fragment.contactsbackup.ContactListFragment.VCardComparator\n+import ezvcard.Ezvcard\n+import ezvcard.VCard\n+import third_parties.ezvcard_android.ContactOperations\n+import java.io.File\n+import java.io.IOException\n+import java.util.ArrayList\n+import java.util.Collections\n+import java.util.TreeMap\n+\n+class ContactsImportWork(\n+    appContext: Context,\n+    params: WorkerParameters,\n+    private val logger: Logger,\n+    private val contentResolver: ContentResolver\n+) : Worker(appContext, params) {\n+\n+    companion object {\n+        const val TAG = \"ContactsImportWork\"\n+        const val ACCOUNT_TYPE = \"account_type\"\n+        const val ACCOUNT_NAME = \"account_name\"\n+        const val VCARD_FILE_PATH = \"vcard_file_path\"\n+        const val SELECTED_CONTACTS_INDICES = \"selected_contacts_indices\"\n+    }\n+\n+    override fun doWork(): Result {\n+        val vCardFilePath = inputData.getString(VCARD_FILE_PATH) ?: \"\"\n+        val contactsAccountName = inputData.getString(ACCOUNT_NAME)\n+        val contactsAccountType = inputData.getString(ACCOUNT_TYPE)\n+        val selectedContactsIndices = inputData.getIntArray(SELECTED_CONTACTS_INDICES) ?: IntArray(0)\n+\n+        val file = File(vCardFilePath)\n+        val vCards = ArrayList<VCard>()\n+\n+        var cursor: Cursor? = null\n+        try {\n+            val operations = ContactOperations(applicationContext, contactsAccountName, contactsAccountType)\n+            vCards.addAll(Ezvcard.parse(file).all())\n+            Collections.sort(vCards, VCardComparator())\n+            cursor = contentResolver.query(\n+                ContactsContract.Contacts.CONTENT_URI,\n+                null,\n+                null,\n+                null,\n+                null\n+            )\n+            val ownContactMap = TreeMap<VCard, Long?>(VCardComparator())\n+            if (cursor != null && cursor.count > 0) {\n+                cursor.moveToFirst()\n+                for (i in 0 until cursor.count) {\n+                    val vCard = getContactFromCursor(cursor)\n+                    if (vCard != null) {\n+                        ownContactMap[vCard] = cursor.getLong(cursor.getColumnIndex(\"NAME_RAW_CONTACT_ID\"))\n+                    }\n+                    cursor.moveToNext()\n+                }\n+            }\n+            for (contactIndex in selectedContactsIndices) {\n+                val vCard = vCards[contactIndex]\n+                if (ContactListFragment.getDisplayName(vCard).isEmpty()) {\n+                    if (!ownContactMap.containsKey(vCard)) {\n+                        operations.insertContact(vCard)\n+                    } else {\n+                        operations.updateContact(vCard, ownContactMap[vCard])\n+                    }\n+                } else {\n+                    operations.insertContact(vCard) // Insert All the contacts without name\n+                }\n+            }\n+        } catch (e: Exception) {\n+            logger.e(TAG, \"${e.message}\")\n+        } finally {\n+            cursor?.close()\n+        }\n+\n+        return Result.success()\n+    }\n+\n+    private fun getContactFromCursor(cursor: Cursor): VCard? {\n+        val lookupKey = cursor.getString(cursor.getColumnIndex(ContactsContract.Contacts.LOOKUP_KEY))\n+        val uri = Uri.withAppendedPath(ContactsContract.Contacts.CONTENT_VCARD_URI, lookupKey)\n+        var vCard: VCard? = null\n+        try {\n+            contentResolver.openInputStream(uri).use { inputStream ->\n+                val vCardList = ArrayList<VCard>()\n+                vCardList.addAll(Ezvcard.parse(inputStream).all())\n+                if (vCardList.size > 0) {\n+                    vCard = vCardList[0]\n+                }\n+            }\n+        } catch (e: IOException) {\n+            logger.d(TAG, \"${e.message}\")", "originalCommit": "5204ba754105ad62c3cc0c7c9fcf9b4c2508b6fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUyODUyMg==", "url": "https://github.com/nextcloud/android/pull/5756#discussion_r405528522", "bodyText": "#5835", "author": "ezaquarii", "createdAt": "2020-04-08T13:34:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk2ODU5NA=="}], "type": "inlineReview"}]}