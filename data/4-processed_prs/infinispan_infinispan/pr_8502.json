{"pr_number": 8502, "pr_title": "ISPN-12053 Remove jetty-client from the REST testsuite", "pr_createdAt": "2020-06-24T15:27:41Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8502", "timeline": [{"oid": "900697b95a10c1d3ee3ce3337d6a0f6e277011b7", "url": "https://github.com/infinispan/infinispan/commit/900697b95a10c1d3ee3ce3337d6a0f6e277011b7", "message": "ISPN-12053 Remove jetty-client from the REST testsuite", "committedDate": "2020-06-24T16:27:26Z", "type": "forcePushed"}, {"oid": "87eacfbc9bfe0b09154b7c175a54cb51eadc615a", "url": "https://github.com/infinispan/infinispan/commit/87eacfbc9bfe0b09154b7c175a54cb51eadc615a", "message": "ISPN-12053 Remove jetty-client from the REST testsuite", "committedDate": "2020-06-25T08:35:52Z", "type": "forcePushed"}, {"oid": "34589b616075cd22c74f4b9487536b7391fbf011", "url": "https://github.com/infinispan/infinispan/commit/34589b616075cd22c74f4b9487536b7391fbf011", "message": "ISPN-12053 Remove jetty-client from the REST testsuite", "committedDate": "2020-06-25T08:36:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk1OTU4Mw==", "url": "https://github.com/infinispan/infinispan/pull/8502#discussion_r446959583", "bodyText": "nitpick: javadoc?", "author": "pruivo", "createdAt": "2020-06-29T13:12:09Z", "path": "client/rest-client/src/main/java/org/infinispan/client/rest/RestCacheClient.java", "diffHunk": "@@ -101,6 +119,8 @@\n     */\n    CompletionStage<RestResponse> put(String key, RestEntity value);\n \n+   CompletionStage<RestResponse> put(String key, RestEntity value, String... flags);", "originalCommit": "34589b616075cd22c74f4b9487536b7391fbf011", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk2MDc4OQ==", "url": "https://github.com/infinispan/infinispan/pull/8502#discussion_r446960789", "bodyText": "is this only for the next release cycle?", "author": "pruivo", "createdAt": "2020-06-29T13:13:55Z", "path": "client/rest-client/src/main/java/org/infinispan/client/rest/impl/okhttp/RestSchemasClientOkHttp.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package org.infinispan.client.rest.impl.okhttp;\n+\n+import static org.infinispan.client.rest.impl.okhttp.RestClientOkHttp.TEXT_PLAIN;\n+import static org.infinispan.client.rest.impl.okhttp.RestClientOkHttp.sanitize;\n+\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.client.rest.RestResponse;\n+import org.infinispan.client.rest.RestSchemaClient;\n+\n+import okhttp3.Request;\n+import okhttp3.RequestBody;\n+\n+/**\n+ * @since 12.0", "originalCommit": "34589b616075cd22c74f4b9487536b7391fbf011", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4MzExNg==", "url": "https://github.com/infinispan/infinispan/pull/8502#discussion_r446983116", "bodyText": "Do we have another 11.x release?", "author": "gustavonalle", "createdAt": "2020-06-29T13:45:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk2MDc4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4NTU2OA==", "url": "https://github.com/infinispan/infinispan/pull/8502#discussion_r446985568", "bodyText": "yes, 11.0.1.Final is needed to be consumed downstream.", "author": "pruivo", "createdAt": "2020-06-29T13:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk2MDc4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4Njk3OQ==", "url": "https://github.com/infinispan/infinispan/pull/8502#discussion_r446986979", "bodyText": "ok, I will change it", "author": "gustavonalle", "createdAt": "2020-06-29T13:50:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk2MDc4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4ODU0Ng==", "url": "https://github.com/infinispan/infinispan/pull/8502#discussion_r446988546", "bodyText": "we can keep this on hold until we branch 11.x (that should happen this week)", "author": "pruivo", "createdAt": "2020-06-29T13:52:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk2MDc4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk5NDYwNA==", "url": "https://github.com/infinispan/infinispan/pull/8502#discussion_r446994604", "bodyText": "+1\nThis is a not needed in 11.x anyway", "author": "gustavonalle", "createdAt": "2020-06-29T14:01:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk2MDc4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3MTYwMg==", "url": "https://github.com/infinispan/infinispan/pull/8502#discussion_r446971602", "bodyText": "why a String and not a Collection/Array?", "author": "pruivo", "createdAt": "2020-06-29T13:29:11Z", "path": "client/rest-client/src/main/java/org/infinispan/client/rest/RestResponse.java", "diffHunk": "@@ -17,6 +17,11 @@\n \n    Map<String, List<String>> headers();\n \n+   /**\n+    * Returns the value of a header as a String. For multi-valued headers, values are separated by comma.\n+    */\n+   String getHeader(String header);", "originalCommit": "34589b616075cd22c74f4b9487536b7391fbf011", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4MzczMQ==", "url": "https://github.com/infinispan/infinispan/pull/8502#discussion_r446983731", "bodyText": "Because 99% of the headers are single values...And there is another method for them (the multivalues)", "author": "gustavonalle", "createdAt": "2020-06-29T13:46:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3MTYwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3MjIzNA==", "url": "https://github.com/infinispan/infinispan/pull/8502#discussion_r446972234", "bodyText": "well, can be final as well.", "author": "pruivo", "createdAt": "2020-06-29T13:30:05Z", "path": "client/rest-client/src/main/java/org/infinispan/client/rest/impl/okhttp/RestResponseOkHttp.java", "diffHunk": "@@ -10,16 +10,19 @@\n import org.infinispan.commons.dataconversion.MediaType;\n \n import okhttp3.Response;\n+import okhttp3.ResponseBody;\n \n /**\n  * @author Tristan Tarrant &lt;tristan@infinispan.org&gt;\n  * @since 10.0\n  **/\n public class RestResponseOkHttp implements RestResponse {\n    Response response;", "originalCommit": "34589b616075cd22c74f4b9487536b7391fbf011", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3MjY2Ng==", "url": "https://github.com/infinispan/infinispan/pull/8502#discussion_r446972666", "bodyText": "why caching the body? it seems to be simple field access.", "author": "pruivo", "createdAt": "2020-06-29T13:30:44Z", "path": "client/rest-client/src/main/java/org/infinispan/client/rest/impl/okhttp/RestResponseOkHttp.java", "diffHunk": "@@ -10,16 +10,19 @@\n import org.infinispan.commons.dataconversion.MediaType;\n \n import okhttp3.Response;\n+import okhttp3.ResponseBody;\n \n /**\n  * @author Tristan Tarrant &lt;tristan@infinispan.org&gt;\n  * @since 10.0\n  **/\n public class RestResponseOkHttp implements RestResponse {\n    Response response;\n+   private final ResponseBody body;\n \n    RestResponseOkHttp(Response response) {\n       this.response = response;\n+      this.body = this.response.body();", "originalCommit": "34589b616075cd22c74f4b9487536b7391fbf011", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4NDE0NA==", "url": "https://github.com/infinispan/infinispan/pull/8502#discussion_r446984144", "bodyText": "The body can be consumed only once, then it starts throwing errors...", "author": "gustavonalle", "createdAt": "2020-06-29T13:46:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3MjY2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3NDEzOA==", "url": "https://github.com/infinispan/infinispan/pull/8502#discussion_r446974138", "bodyText": "nitpick: use TEXT_PLAIN?", "author": "pruivo", "createdAt": "2020-06-29T13:32:48Z", "path": "client/rest-client/src/main/java/org/infinispan/client/rest/impl/okhttp/RestSchemasClientOkHttp.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package org.infinispan.client.rest.impl.okhttp;\n+\n+import static org.infinispan.client.rest.impl.okhttp.RestClientOkHttp.TEXT_PLAIN;\n+import static org.infinispan.client.rest.impl.okhttp.RestClientOkHttp.sanitize;\n+\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.client.rest.RestResponse;\n+import org.infinispan.client.rest.RestSchemaClient;\n+\n+import okhttp3.Request;\n+import okhttp3.RequestBody;\n+\n+/**\n+ * @since 12.0\n+ */\n+public class RestSchemasClientOkHttp implements RestSchemaClient {\n+\n+   private final RestClientOkHttp client;\n+   private final String baseUrl;\n+\n+   public RestSchemasClientOkHttp(RestClientOkHttp client) {\n+      this.client = client;\n+      this.baseUrl = String.format(\"%s%s/v2/schemas\", client.getBaseURL(), client.getConfiguration().contextPath())\n+            .replaceAll(\"//\", \"/\");\n+   }\n+\n+   @Override\n+   public CompletionStage<RestResponse> names() {\n+      return client.execute(baseUrl);\n+   }\n+\n+   @Override\n+   public CompletionStage<RestResponse> post(String schemaName, String schemaContents) {\n+      Request.Builder builder = new Request.Builder();\n+      RequestBody body = RequestBody.create(TEXT_PLAIN, schemaContents);\n+      builder.url(schemaUrl(schemaName)).post(body);\n+      return client.execute(builder);\n+   }\n+\n+   @Override\n+   public CompletionStage<RestResponse> put(String schemaName, String schemaContents) {\n+      Request.Builder builder = new Request.Builder();\n+      RequestBody body = RequestBody.create(TEXT_PLAIN, schemaContents);\n+      builder.url(schemaUrl(schemaName)).put(body);\n+      return client.execute(builder);\n+   }\n+\n+   @Override\n+   public CompletionStage<RestResponse> delete(String schemaName) {\n+      Request.Builder builder = new Request.Builder();\n+      builder.url(schemaUrl(schemaName)).delete();\n+      return client.execute(builder);\n+   }\n+\n+   @Override\n+   public CompletionStage<RestResponse> get(String schemaName) {\n+      Request.Builder builder = new Request.Builder();\n+      builder.header(\"Accept\", \"text/plain\");", "originalCommit": "34589b616075cd22c74f4b9487536b7391fbf011", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "874b881bc9e58ede9f93d212b0a01a28fb6a955d", "url": "https://github.com/infinispan/infinispan/commit/874b881bc9e58ede9f93d212b0a01a28fb6a955d", "message": "ISPN-12053 Remove jetty-client from the REST testsuite", "committedDate": "2020-06-30T13:33:06Z", "type": "forcePushed"}, {"oid": "a9080b71eee964ccac9998782d9792e76b87e414", "url": "https://github.com/infinispan/infinispan/commit/a9080b71eee964ccac9998782d9792e76b87e414", "message": "ISPN-12053 Remove jetty-client from the REST testsuite", "committedDate": "2020-06-30T13:39:13Z", "type": "forcePushed"}, {"oid": "dabe05aa60146155b7d4d3d5015883fab82b2d8b", "url": "https://github.com/infinispan/infinispan/commit/dabe05aa60146155b7d4d3d5015883fab82b2d8b", "message": "ISPN-12053 Remove jetty-client from the REST testsuite", "committedDate": "2020-06-30T14:34:02Z", "type": "commit"}, {"oid": "dabe05aa60146155b7d4d3d5015883fab82b2d8b", "url": "https://github.com/infinispan/infinispan/commit/dabe05aa60146155b7d4d3d5015883fab82b2d8b", "message": "ISPN-12053 Remove jetty-client from the REST testsuite", "committedDate": "2020-06-30T14:34:02Z", "type": "forcePushed"}]}