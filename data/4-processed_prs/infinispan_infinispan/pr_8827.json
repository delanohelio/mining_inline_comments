{"pr_number": 8827, "pr_title": "ISPN-11614 PersistenceMarshaller should utilise an independent Serialization context", "pr_createdAt": "2020-11-03T17:55:11Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8827", "timeline": [{"oid": "a8217459ad600f6a86e92f6e788840f7ca02fec1", "url": "https://github.com/infinispan/infinispan/commit/a8217459ad600f6a86e92f6e788840f7ca02fec1", "message": "jpa wip", "committedDate": "2020-11-03T19:04:13Z", "type": "forcePushed"}, {"oid": "19d14e94c883852d3594fd8a43b2890d5ba5f8a9", "url": "https://github.com/infinispan/infinispan/commit/19d14e94c883852d3594fd8a43b2890d5ba5f8a9", "message": "jpa wip", "committedDate": "2020-11-03T20:29:05Z", "type": "forcePushed"}, {"oid": "7976f89d24c27d2af67f48026d8aa91b4bfe2cca", "url": "https://github.com/infinispan/infinispan/commit/7976f89d24c27d2af67f48026d8aa91b4bfe2cca", "message": "jpa wip", "committedDate": "2020-11-03T21:38:02Z", "type": "forcePushed"}, {"oid": "a8deafe9355eb7c6721628f8dcacd51d2683ecb8", "url": "https://github.com/infinispan/infinispan/commit/a8deafe9355eb7c6721628f8dcacd51d2683ecb8", "message": "Add cascading context checks to Protostream Transcoder", "committedDate": "2020-11-05T08:23:20Z", "type": "forcePushed"}, {"oid": "5e01e6021d931cbe684d630034f19ea2375353b8", "url": "https://github.com/infinispan/infinispan/commit/5e01e6021d931cbe684d630034f19ea2375353b8", "message": "Add cascading context checks to Protostream Transcoder", "committedDate": "2020-11-05T16:35:12Z", "type": "forcePushed"}, {"oid": "8b80911d6b36a8770af6879a42f53fd0a0d38754", "url": "https://github.com/infinispan/infinispan/commit/8b80911d6b36a8770af6879a42f53fd0a0d38754", "message": "ISPN-11426 Add UUID to core SerializationContexts\n\nUtilise FIXED64 in UUIDBridge", "committedDate": "2020-11-16T18:00:37Z", "type": "forcePushed"}, {"oid": "baf96985c29714cfb998b9d3d716d49e54bacec6", "url": "https://github.com/infinispan/infinispan/commit/baf96985c29714cfb998b9d3d716d49e54bacec6", "message": "ISPN-12093 Service loaded SCIs not registered with the SerializationContextRegistry", "committedDate": "2020-11-16T18:52:37Z", "type": "forcePushed"}, {"oid": "3403986ee660abd5591ef156da5ae3a45fb0152b", "url": "https://github.com/infinispan/infinispan/commit/3403986ee660abd5591ef156da5ae3a45fb0152b", "message": "ISPN-12093 Service loaded SCIs not registered with the SerializationContextRegistry", "committedDate": "2020-11-16T20:05:59Z", "type": "forcePushed"}, {"oid": "96447665f412d36407a1976eae2792db9388f57b", "url": "https://github.com/infinispan/infinispan/commit/96447665f412d36407a1976eae2792db9388f57b", "message": "ISPN-12093 Service loaded SCIs not registered with the SerializationContextRegistry", "committedDate": "2020-11-16T20:12:21Z", "type": "forcePushed"}, {"oid": "1eb34105df35afd1308d542a624fe731ec7354b9", "url": "https://github.com/infinispan/infinispan/commit/1eb34105df35afd1308d542a624fe731ec7354b9", "message": "ISPN-12093 Service loaded SCIs not registered with the SerializationContextRegistry", "committedDate": "2020-11-19T11:36:12Z", "type": "forcePushed"}, {"oid": "70e3f119243a55a6420cc378509ebca7fb87db93", "url": "https://github.com/infinispan/infinispan/commit/70e3f119243a55a6420cc378509ebca7fb87db93", "message": "ISPN-12093 Service loaded SCIs not registered with the SerializationContextRegistry", "committedDate": "2020-11-23T10:59:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUwNjgwNw==", "url": "https://github.com/infinispan/infinispan/pull/8827#discussion_r531506807", "bodyText": "This doesn't look like a getAndSet but getAndAdd", "author": "tristantarrant", "createdAt": "2020-11-27T10:16:19Z", "path": "commons/all/src/main/java/org/infinispan/commons/util/ByRef.java", "diffHunk": "@@ -84,6 +84,12 @@ public void set(long i) {\n          ref = i;\n       }\n \n+      public long getAndSet(long i) {\n+         long ret = ref;\n+         ref += i;", "originalCommit": "70e3f119243a55a6420cc378509ebca7fb87db93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "db3ae9d77a59a05c02d3b0c4b0da95ba83667467", "url": "https://github.com/infinispan/infinispan/commit/db3ae9d77a59a05c02d3b0c4b0da95ba83667467", "message": "ISPN-12093 Service loaded SCIs not registered with the SerializationContextRegistry", "committedDate": "2020-11-27T10:23:14Z", "type": "forcePushed"}, {"oid": "54030d3b5105c18f9ea064401516c876a3037c11", "url": "https://github.com/infinispan/infinispan/commit/54030d3b5105c18f9ea064401516c876a3037c11", "message": "Ignore .attach_pid* files", "committedDate": "2020-11-27T11:07:42Z", "type": "forcePushed"}, {"oid": "8848bcb281ec182f71bf59368e3b3960775fb316", "url": "https://github.com/infinispan/infinispan/commit/8848bcb281ec182f71bf59368e3b3960775fb316", "message": "Ignore .attach_pid* files", "committedDate": "2020-11-27T15:47:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk1NTE1MA==", "url": "https://github.com/infinispan/infinispan/pull/8827#discussion_r533955150", "bodyText": "Why the removal?", "author": "gustavonalle", "createdAt": "2020-12-02T07:43:29Z", "path": "core/src/test/java/org/infinispan/eviction/impl/MemoryBasedEvictionFunctionalStoreAsBinaryTest.java", "diffHunk": "@@ -39,8 +37,4 @@ public void testCustomClass() throws Exception {\n       }\n       assertTrue(cache.getAdvancedCache().getDataContainer().size() < numberInserted);\n    }\n-\n-   public void testJGroupsAddress() {\n-      cache.put(\"key\", new JGroupsAddress(new UUID()));\n-   }", "originalCommit": "8848bcb281ec182f71bf59368e3b3960775fb316", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA1MTUyNg==", "url": "https://github.com/infinispan/infinispan/pull/8827#discussion_r534051526", "bodyText": "This test no longer makes sense with the separation of the internal and user contexts, as it's trying to store the internal class JGroupsAddress.\nWe could keep the test and add a JGroupsAddress SCI to the configuration, but I don't think this is worthwhile as testCustomClass essentially does the same thing albeit with a different class.", "author": "ryanemerson", "createdAt": "2020-12-02T10:18:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk1NTE1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk1NjYwNA==", "url": "https://github.com/infinispan/infinispan/pull/8827#discussion_r533956604", "bodyText": "should not commit?", "author": "gustavonalle", "createdAt": "2020-12-02T07:46:36Z", "path": "persistence/rocksdb/src/test/resources/11_0_x_rocksdb_data/data/LOG", "diffHunk": "@@ -0,0 +1,256 @@\n+2020/11/23-10:53:43.160947 7f5a5c2ea700 RocksDB version: 6.8.1", "originalCommit": "8848bcb281ec182f71bf59368e3b3960775fb316", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk1Njg4OA==", "url": "https://github.com/infinispan/infinispan/pull/8827#discussion_r533956888", "bodyText": "Same applies to everything from the data/ folder I suppose", "author": "gustavonalle", "createdAt": "2020-12-02T07:47:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk1NjYwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA1MjU0Nw==", "url": "https://github.com/infinispan/infinispan/pull/8827#discussion_r534052547", "bodyText": "We need to commit the data/ dir as this contains the 11.0.x which we migrate to the new format on startup in the RocksDBStoreCompatibilityTest", "author": "ryanemerson", "createdAt": "2020-12-02T10:19:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk1NjYwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk1NzM2Mw==", "url": "https://github.com/infinispan/infinispan/pull/8827#discussion_r533957363", "bodyText": "Should not commit this (I think)", "author": "gustavonalle", "createdAt": "2020-12-02T07:48:13Z", "path": "persistence/rocksdb/src/test/resources/11_0_x_rocksdb_data/expired/OPTIONS-000005", "diffHunk": "@@ -0,0 +1,165 @@\n+# This is a RocksDB option file.", "originalCommit": "8848bcb281ec182f71bf59368e3b3960775fb316", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA4Njg2OA==", "url": "https://github.com/infinispan/infinispan/pull/8827#discussion_r534086868", "bodyText": "Yep, seems to be ok to remove", "author": "ryanemerson", "createdAt": "2020-12-02T11:13:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk1NzM2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk2MTcwNg==", "url": "https://github.com/infinispan/infinispan/pull/8827#discussion_r533961706", "bodyText": "Does it have a Protostream JIRA to have this workaround removed?", "author": "gustavonalle", "createdAt": "2020-12-02T07:57:01Z", "path": "core/src/main/java/org/infinispan/encoding/ProtostreamTranscoder.java", "diffHunk": "@@ -132,27 +124,92 @@ private boolean isWrapped(MediaType mediaType) {\n    }\n \n    private byte[] marshall(Object decoded, MediaType destinationType) throws IOException {\n-      try {\n-         if (isWrapped(destinationType)) return ProtobufUtil.toWrappedByteArray(ctx(), decoded);\n-         return ProtobufUtil.toByteArray(ctx(), decoded);\n-      } catch (IllegalArgumentException iae) {\n-         throw new MarshallingException(iae.getMessage());\n+      ImmutableSerializationContext ctx = getCtxForMarshalling(decoded);\n+      if (isWrapped(destinationType)) {\n+         return ProtobufUtil.toWrappedByteArray(ctx, decoded);\n       }\n+      return ProtobufUtil.toByteArray(ctx, decoded);\n    }\n \n    private Object unmarshall(byte[] bytes, MediaType contentType, MediaType destinationType) throws IOException {\n+      if (isWrapped(contentType))\n+         return unmarshallCascading(bytes);\n+\n+      String type = destinationType.getClassType();\n+      if (type == null) throw logger.missingTypeForUnwrappedPayload();\n+      Class<?> destination = Util.loadClass(type, classLoader);\n+      ImmutableSerializationContext ctx = getCtxForMarshalling(destination);\n+      return ProtobufUtil.fromByteArray(ctx, bytes, destination);\n+   }\n+\n+   private Object unmarshallCascading(byte[] bytes) throws IOException {\n+      // First try to unmarshalling with the user context", "originalCommit": "8848bcb281ec182f71bf59368e3b3960775fb316", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA2NzMyNQ==", "url": "https://github.com/infinispan/infinispan/pull/8827#discussion_r534067325", "bodyText": "Yes IPROTO-139. I'll add comments to the workaround methods.", "author": "ryanemerson", "createdAt": "2020-12-02T10:41:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk2MTcwNg=="}], "type": "inlineReview"}, {"oid": "e59f93879e6ef85b845163c9a5154700f0f6ffac", "url": "https://github.com/infinispan/infinispan/commit/e59f93879e6ef85b845163c9a5154700f0f6ffac", "message": "Ignore .attach_pid* files", "committedDate": "2020-12-02T11:13:27Z", "type": "forcePushed"}, {"oid": "e62860fc0ae7d2080b4936d167910ffac9695594", "url": "https://github.com/infinispan/infinispan/commit/e62860fc0ae7d2080b4936d167910ffac9695594", "message": "Ignore .attach_pid* files", "committedDate": "2020-12-03T11:35:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgyNTkxNg==", "url": "https://github.com/infinispan/infinispan/pull/8827#discussion_r537825916", "bodyText": "It seems you don't need this ByRef if you change allocate to return a ByteBuffer instead.", "author": "wburns", "createdAt": "2020-12-07T20:55:08Z", "path": "core/src/main/java/org/infinispan/persistence/file/SingleFileStore.java", "diffHunk": "@@ -213,27 +221,20 @@ public boolean isAvailable() {\n     * Rebuilds the in-memory index from file.\n     */\n    private void rebuildIndex() throws Exception {\n-      ByteBuffer buf = ByteBuffer.allocate(KEY_POS_11_0);\n+      ByRef<ByteBuffer> buf = new ByRef<>(ByteBuffer.allocate(KEY_POS_LATEST));", "originalCommit": "e62860fc0ae7d2080b4936d167910ffac9695594", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ4NjA0OA==", "url": "https://github.com/infinispan/infinispan/pull/8827#discussion_r540486048", "bodyText": "I wonder should we confirm if the prior marshaller could be used? What if a DBA deletes the metadata table. I wonder if we should catch the exception and maybe mention that as a possibility?", "author": "wburns", "createdAt": "2020-12-10T20:48:11Z", "path": "persistence/jdbc/src/main/java/org/infinispan/persistence/jdbc/stringbased/JdbcStringBasedStore.java", "diffHunk": "@@ -160,6 +183,66 @@ public void start() {\n       }\n    }\n \n+   private void migrateFromV11() throws SQLException {\n+      // If a custom user marshaller was previously used, no need to update rows\n+      if (ctx.getGlobalConfiguration().serialization().marshaller() != null)\n+         return;\n+\n+      Connection conn = null;\n+      PreparedStatement ps = null;\n+      ResultSet rs = null;\n+      try {\n+         conn = connectionFactory.getConnection();\n+         conn.setAutoCommit(false);\n+         String sql = tableManager.getLoadNonExpiredAllRowsSql();\n+         ps = conn.prepareStatement(sql);\n+         ps.setLong(1, timeService.wallClockTime());\n+         rs = ps.executeQuery();\n+\n+         Marshaller userMarshaller = marshaller.getUserMarshaller();\n+         try (PreparedStatement upsertBatch = conn.prepareStatement(tableManager.getUpdateRowSql())) {\n+            int batchSize = 0;\n+            while (rs.next()) {\n+               batchSize++;\n+               InputStream inputStream = rs.getBinaryStream(1);\n+               String keyStr = rs.getString(2);\n+               long timestamp = rs.getLong(3);\n+               int segment = keyPartitioner == null ? -1 : rs.getInt(4);\n+\n+               MarshalledValue mv = unmarshall(inputStream, marshaller);", "originalCommit": "e62860fc0ae7d2080b4936d167910ffac9695594", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0NTk0NQ==", "url": "https://github.com/infinispan/infinispan/pull/8827#discussion_r541045945", "bodyText": "We could, however this will only be the case for Infinispan 12. From Infinispan 13 I think we should throw an exception if !createOnStart and the meta table doesn't exist as it's not possible to distinguish between 11 and 12 data if no meta table exists.", "author": "ryanemerson", "createdAt": "2020-12-11T15:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ4NjA0OA=="}], "type": "inlineReview"}, {"oid": "78dc6079137cd739688fd423c0cbad9e7138abdb", "url": "https://github.com/infinispan/infinispan/commit/78dc6079137cd739688fd423c0cbad9e7138abdb", "message": "SFS Remove ByRef for ByteBuffer", "committedDate": "2020-12-11T15:55:03Z", "type": "forcePushed"}, {"oid": "4f00f961c5716a63c82378e55e74c5b8d1bd9fda", "url": "https://github.com/infinispan/infinispan/commit/4f00f961c5716a63c82378e55e74c5b8d1bd9fda", "message": "Ignore .attach_pid* files", "committedDate": "2020-12-14T15:13:04Z", "type": "forcePushed"}, {"oid": "11f5abeee241038f5f94ef8f4ac51ca0605a33ff", "url": "https://github.com/infinispan/infinispan/commit/11f5abeee241038f5f94ef8f4ac51ca0605a33ff", "message": "ISPN-11614 PersistenceMarshaller should utilise an independent SerializationContext for user types\n\nUser marshaller instance now created via MarshallerFactory\n\nAdd cascading context checks to Protostream Transcoder", "committedDate": "2020-12-15T17:25:31Z", "type": "commit"}, {"oid": "ebb1a44eb20ab580d3cb3da27a2caa4931970d52", "url": "https://github.com/infinispan/infinispan/commit/ebb1a44eb20ab580d3cb3da27a2caa4931970d52", "message": "ISPN-11614 AbstractInternalProtoStreamMarshaller utilised by PersistenceMarshallerImpl", "committedDate": "2020-12-15T17:25:31Z", "type": "commit"}, {"oid": "c4a35ef28f53eb8dd9f5de347d7c499bd7f7b406", "url": "https://github.com/infinispan/infinispan/commit/c4a35ef28f53eb8dd9f5de347d7c499bd7f7b406", "message": "ISPN-11614 Stores updated to migrate incompatible data from 11.x -> 12.x\n\nAffected stores:\n- SFS\n- SIFS\n- JDBC\n- RocksDb", "committedDate": "2020-12-15T17:25:31Z", "type": "commit"}, {"oid": "9177f84d62e307283bff840c34c84e3fda7aba04", "url": "https://github.com/infinispan/infinispan/commit/9177f84d62e307283bff840c34c84e3fda7aba04", "message": "ISPN-11426 Add UUID to core SerializationContexts\n\nUtilise FIXED64 in UUIDBridge", "committedDate": "2020-12-15T17:25:31Z", "type": "commit"}, {"oid": "80b795e4a97c82f162265ab2e5309c1effd7d863", "url": "https://github.com/infinispan/infinispan/commit/80b795e4a97c82f162265ab2e5309c1effd7d863", "message": "ISPN-12093 Service loaded SCIs not registered with the SerializationContextRegistry", "committedDate": "2020-12-15T17:25:31Z", "type": "commit"}, {"oid": "5a6b3c212959013ffaa8aaf5766dc62cca4d4a47", "url": "https://github.com/infinispan/infinispan/commit/5a6b3c212959013ffaa8aaf5766dc62cca4d4a47", "message": "Ignore .attach_pid* files", "committedDate": "2020-12-15T17:25:31Z", "type": "commit"}, {"oid": "5a6b3c212959013ffaa8aaf5766dc62cca4d4a47", "url": "https://github.com/infinispan/infinispan/commit/5a6b3c212959013ffaa8aaf5766dc62cca4d4a47", "message": "Ignore .attach_pid* files", "committedDate": "2020-12-15T17:25:31Z", "type": "forcePushed"}]}