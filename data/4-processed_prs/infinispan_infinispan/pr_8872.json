{"pr_number": 8872, "pr_title": "ISPN-12464 Update to Hibernate Search 6.0.0.CR1", "pr_createdAt": "2020-11-18T17:13:13Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8872", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyOTkyNg==", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r528529926", "bodyText": "Are you sure about this? I think we discussed this at some point and the Search 6 defaults weren't acceptable for Infinispan. I.e. for each index 10 indexing queues, and for each cache about as many threads as the number of processor cores available to the JVM on startup.\nNote that having more indexing queues than threads is not useful.", "author": "yrodiere", "createdAt": "2020-11-23T08:21:30Z", "path": "query/src/main/java/org/infinispan/search/mapper/mapping/impl/IndexProperties.java", "diffHunk": "@@ -31,25 +28,21 @@ public void setProperty(String key, Object value) {\n    }\n \n    public void setProperties(Map<String, Object> properties) {\n-      properties.entrySet().stream()\n-            .forEach(property -> setProperty(property.getKey(), property.getValue()) );\n+      properties.forEach(this::setProperty);\n    }\n \n    public ConfigurationPropertySource createPropertySource(ConfigurationPropertyChecker propertyChecker) {\n       ConfigurationPropertySource basePropertySource =\n             propertyChecker.wrap(ConfigurationPropertySource.fromMap(backendProperties))\n-                  .withPrefix(BACKEND_PROPERTIES_PREFIX);\n+                  .withPrefix(EngineSettings.BACKEND);\n       ConfigurationPropertySource propertySource =\n             basePropertySource.withOverride(ConfigurationPropertySource.fromMap(engineProperties));\n       defaultProperties();\n       return propertySource;\n    }\n \n    private void defaultProperties() {\n-      engineProperties.put(\"hibernate.search.default_backend\", INFINISPAN_BACKEND_NAME);\n       backendProperties.put(\"type\", \"lucene\");\n       backendProperties.put(\"analysis.configurer\", new DefaultAnalysisConfigurer());\n-      backendProperties.put(\"thread_pool.size\", \"1\");\n-      backendProperties.put(\"index_defaults.indexing.queue_count\", \"1\");", "originalCommit": "ae952d808f48bc929bc1d5d06fef34b99bb2ab79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY2OTI2NA==", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r528669264", "bodyText": "Noted, I revamped the config in #8815, and those will become Infinispan level properties. I was planning handling the defaults there.", "author": "gustavonalle", "createdAt": "2020-11-23T12:30:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyOTkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTM1MDYwMw==", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r529350603", "bodyText": "I have moved the defaults to the new config PR at #8815, thanks @yrodiere", "author": "gustavonalle", "createdAt": "2020-11-24T09:33:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyOTkyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMjM1Nw==", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r528532357", "bodyText": "FWIW, NRT is enabled by default. This doesn't enable it, it just changes the commit interval from 1,000ms to 10,000ms.", "author": "yrodiere", "createdAt": "2020-11-23T08:26:24Z", "path": "query/src/test/resources/nrt-performance-writer.xml", "diffHunk": "@@ -24,7 +24,7 @@\n                <indexed-entity>org.infinispan.query.test.Person</indexed-entity>\n             </indexed-entities>\n             <!-- Enabled fastest writer: NRT backend -->\n-            <property name=\"index_defaults.io.commit_interval\">10000</property>\n+            <property name=\"io.commit_interval\">10000</property>", "originalCommit": "ae952d808f48bc929bc1d5d06fef34b99bb2ab79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY3MTI0MQ==", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r528671241", "bodyText": "yes, I am aware. This file is reminiscent of a very old test that needs to be revisit after  due to #8815 too", "author": "gustavonalle", "createdAt": "2020-11-23T12:34:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMjM1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMzE3MQ==", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r528533171", "bodyText": "Same comment about sharding: it will be driven by the segment IDs, not the document IDs.", "author": "yrodiere", "createdAt": "2020-11-23T08:28:02Z", "path": "query/src/test/resources/nrt-performance-writer.xml", "diffHunk": "@@ -37,11 +37,11 @@\n             -->\n \n             <!-- Enable sharding on writers -->\n-            <property name=\"index_defaults.sharding.strategy\">hash</property>\n-            <property name=\"index_defaults.sharding.number_of_shards\">6</property>\n+            <property name=\"sharding.strategy\">hash</property>\n+            <property name=\"sharding.number_of_shards\">6</property>", "originalCommit": "ae952d808f48bc929bc1d5d06fef34b99bb2ab79", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMzU0MA==", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r528533540", "bodyText": "FYI, Hibernate Search uses the routing keys for sharding when they are provided, not the document IDs.\nInfinispan uses the segment IDs as routing keys.\nNot sure it changes anything, but I thought you would want to know.", "author": "yrodiere", "createdAt": "2020-11-23T08:28:47Z", "path": "query/src/test/resources/nrt-performance-writer-infinispandirectory.xml", "diffHunk": "@@ -31,12 +31,12 @@\n             <!-- Write indexes in Infinispan -->\n             <property name=\"directory.type\">local-heap</property>\n             <!-- Enable sharding on writers -->\n-            <property name=\"index_defaults.sharding.strategy\">hash</property>\n-            <property name=\"index_defaults.sharding.number_of_shards\">6</property>\n+            <property name=\"sharding.strategy\">hash</property>\n+            <property name=\"sharding.number_of_shards\">6</property>", "originalCommit": "ae952d808f48bc929bc1d5d06fef34b99bb2ab79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY3MjM5NQ==", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r528672395", "bodyText": "Regarding shards: the plan is to not expose it to the user whatsoever.", "author": "gustavonalle", "createdAt": "2020-11-23T12:36:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMzU0MA=="}], "type": "inlineReview"}, {"oid": "25c3d431e1428bbe363aa641a3b81b5670e98bc8", "url": "https://github.com/infinispan/infinispan/commit/25c3d431e1428bbe363aa641a3b81b5670e98bc8", "message": "ISPN-12464 Update to Hibernate Search 6.0.0.CR1", "committedDate": "2020-11-24T07:32:08Z", "type": "commit"}, {"oid": "47d4dae95b61e399277b7777a02ebc6bbfc07ab9", "url": "https://github.com/infinispan/infinispan/commit/47d4dae95b61e399277b7777a02ebc6bbfc07ab9", "message": "ISPN-12464 Fix timeout test failure and clarify javadoc", "committedDate": "2020-11-24T07:32:08Z", "type": "forcePushed"}, {"oid": "dce7ac83e424d37a2fd4135689a17e78e2e936a3", "url": "https://github.com/infinispan/infinispan/commit/dce7ac83e424d37a2fd4135689a17e78e2e936a3", "message": "ISPN-12464 Fix timeout test failure and clarify javadoc", "committedDate": "2020-11-24T13:42:01Z", "type": "commit"}, {"oid": "dce7ac83e424d37a2fd4135689a17e78e2e936a3", "url": "https://github.com/infinispan/infinispan/commit/dce7ac83e424d37a2fd4135689a17e78e2e936a3", "message": "ISPN-12464 Fix timeout test failure and clarify javadoc", "committedDate": "2020-11-24T13:42:01Z", "type": "forcePushed"}]}