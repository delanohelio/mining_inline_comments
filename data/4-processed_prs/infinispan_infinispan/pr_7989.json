{"pr_number": 7989, "pr_title": "ISPN-11198 rolling upgrade docs", "pr_createdAt": "2020-03-04T13:57:06Z", "pr_url": "https://github.com/infinispan/infinispan/pull/7989", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc0NzAwMQ==", "url": "https://github.com/infinispan/infinispan/pull/7989#discussion_r387747001", "bodyText": "@ryanemerson for remote cache stores with source clusters for older versions, e.g. remote store that points to a 9.4 cluster, do users need to add the jboss marshaller to the remote store config?", "author": "oraNod", "createdAt": "2020-03-04T15:36:05Z", "path": "documentation/src/main/asciidoc/topics/ref_rolling_upgrade_remote_store.adoc", "diffHunk": "@@ -0,0 +1,32 @@\n+[id='upgrade_remote_store']\n+= Remote Cache Stores for Rolling Upgrades\n+You must use specific remote cache store configuration to perform rolling\n+upgrades, as follows:\n+\n+[source,xml,options=\"nowrap\",subs=attributes+]\n+----\n+<persistence passivation=\"false\"> <1>\n+   <remote-store xmlns=\"urn:infinispan:config:store:remote:{schemaversion}\"\n+                 cache=\"myDistCache\" <2>\n+                 hotrod-wrapping=\"true\" <3>\n+                 shared=\"true\" <4>\n+                 marshaller=\"\" <5>", "originalCommit": "dd719a6030cbd5669cb9b0c565354175d11b0bf3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0Njc2Ng==", "url": "https://github.com/infinispan/infinispan/pull/7989#discussion_r402846766", "bodyText": "nope. I tested migration to RHDG 8 from 7.3, 7.2, ..., 6.6.2 using this config:\n{\n    \"distributed-cache\":{\n        \"mode\":\"SYNC\",\n        \"persistence\":{\n            \"remote-store\":{\n                \"protocol-version\":\"2.5\",\n                \"hotrod-wrapping\":true,\n                \"raw-values\":true,\n                \"cache\":\"default\",\n                \"remote-server\":{\n                    \"host\":\"127.0.0.1\",\n                    \"port\":11222\n                }\n            }\n        }\n    }\n}", "author": "gustavonalle", "createdAt": "2020-04-03T08:47:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc0NzAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0NzAxMw==", "url": "https://github.com/infinispan/infinispan/pull/7989#discussion_r402847013", "bodyText": "https://github.com/gustavonalle/rolling/", "author": "gustavonalle", "createdAt": "2020-04-03T08:47:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc0NzAwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc0ODMzNQ==", "url": "https://github.com/infinispan/infinispan/pull/7989#discussion_r387748335", "bodyText": "@gustavonalle the migratorName should always be \"hotrod\" unless you use a custom migrator? could we set that as the default so users only need the parameter if they use some other migrator?", "author": "oraNod", "createdAt": "2020-03-04T15:37:58Z", "path": "core/src/main/java/org/infinispan/upgrade/RollingUpgradeManager.java", "diffHunk": "@@ -40,10 +40,10 @@\n    @Inject GlobalConfiguration globalConfiguration;\n \n    @ManagedOperation(\n-         description = \"Synchronizes data from the old cluster to this using the specified migrator\",\n-         displayName = \"Synchronizes data from the old cluster to this using the specified migrator\"\n+         description = \"Synchronizes data from source clusters to target clusters with the specified migrator.\",\n+         displayName = \"Synchronizes data from source clusters to target clusters with the specified migrator.\"\n    )\n-   public long synchronizeData(@Parameter(name=\"migratorName\", description=\"The name of the migrator to use\") String migratorName) throws Exception {\n+   public long synchronizeData(@Parameter(name=\"migratorName\", description=\"Specifies the name of the migrator to use. Set hotrod as the value unless using custom migrators.\") String migratorName) throws Exception {", "originalCommit": "dd719a6030cbd5669cb9b0c565354175d11b0bf3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc2NjU1Nw==", "url": "https://github.com/infinispan/infinispan/pull/7989#discussion_r389766557", "bodyText": "The only one usable is 'hotrod'. We could set it as 'default'\nhttps://issues.redhat.com/browse/ISPN-11442", "author": "gustavonalle", "createdAt": "2020-03-09T15:27:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc0ODMzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc5MjcwOA==", "url": "https://github.com/infinispan/infinispan/pull/7989#discussion_r389792708", "bodyText": "nice, one less parameter", "author": "oraNod", "createdAt": "2020-03-09T16:06:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc0ODMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc1MDg4NQ==", "url": "https://github.com/infinispan/infinispan/pull/7989#discussion_r387750885", "bodyText": "@gustavonalle you can call switchToCluster(clusterName) for Hot Rod Java clients to start sending requests to the target cluster, isn't that so?\nthe existing docs for rolling upgrade say to update the config and restart clients. but I think that might depend on the client implementation. for Java clients there's no need to restart.", "author": "oraNod", "createdAt": "2020-03-04T15:41:39Z", "path": "documentation/src/main/asciidoc/topics/proc_setting_up_target_clusters.adoc", "diffHunk": "@@ -1,26 +1,24 @@\n+[id='upgrade_target']\n = Setting Up Target Clusters\n+Set up a target cluster that runs the {brandname} version to which you want to\n+upgrade and add a remote cache store so the target cluster can load data from\n+the source cluster.\n \n-. Start the target cluster with unique network properties or a different JGroups cluster name to keep it separate from the source cluster.\n-. Configure a `RemoteCacheStore` on the target cluster for each cache you want to migrate from the source cluster.\n-+\n-`RemoteCacheStore` settings::\n-+\n-* `remote-server` must point to the source cluster via the `outbound-socket-binding` property.\n-* `remoteCacheName` must match the cache name on the source cluster.\n-* `hotrod-wrapping` must be `true` (enabled).\n-* `shared` must be `true` (enabled).\n-* `purge` must be `false` (disabled).\n-* `passivation` must be `false` (disabled).\n-* `protocol-version` matches the Hot Rod protocol version of the source cluster.\n-+\n-.Example `RemoteCacheStore` Configuration\n-[source,xml,options=\"nowrap\",subs=attributes+]\n-----\n-include::config_examples/remote_cache_store.xml[]\n-----\n+.Prerequisites\n+\n+. Download and install the appropriate {brandname} version for the target\n+cluster.\n+\n+.Procedure\n+\n+. Configure the target cluster with unique network properties or a different\n+JGroups cluster name to keep it separate from the source cluster.\n+. Add a `RemoteCacheStore` on the target cluster for each cache you want\n+to migrate from the source cluster.\n +\n-. Configure the target cluster to handle all client requests instead of the source cluster:\n-.. Configure all clients to point to the target cluster instead of the source cluster.\n-.. Restart each client node.\n+Remote cache stores use the Hot Rod protocol to retrieve data from remote\n+{brandname} clusters. When you add the remote cache store to the target\n+cluster, it can lazily load data from the source cluster to handle client\n+requests.\n +\n-The target cluster lazily loads data from the source cluster on demand via `RemoteCacheStore`.\n+. Switch clients over to the target cluster so it starts handling all requests.", "originalCommit": "dd719a6030cbd5669cb9b0c565354175d11b0bf3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc2NzAwMw==", "url": "https://github.com/infinispan/infinispan/pull/7989#discussion_r389767003", "bodyText": "I am not familiar with switchToCluster(clusterName), is this for X-Site probably?", "author": "gustavonalle", "createdAt": "2020-03-09T15:28:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc1MDg4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc5MjIwMw==", "url": "https://github.com/infinispan/infinispan/pull/7989#discussion_r389792203", "bodyText": "yeah, switchToCluster() is for xsite but I wonder if it could be used in this scenario as well?", "author": "oraNod", "createdAt": "2020-03-09T16:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc1MDg4NQ=="}], "type": "inlineReview"}, {"oid": "74a6630f547b15dd42f500f5807a1491934e624b", "url": "https://github.com/infinispan/infinispan/commit/74a6630f547b15dd42f500f5807a1491934e624b", "message": "ISPN-11198 rolling upgrade docs", "committedDate": "2020-03-04T16:23:38Z", "type": "forcePushed"}, {"oid": "b289402e19ba6a6f1745f031397f4f55e9c2868a", "url": "https://github.com/infinispan/infinispan/commit/b289402e19ba6a6f1745f031397f4f55e9c2868a", "message": "ISPN-11198 rolling upgrade docs", "committedDate": "2020-03-10T10:01:26Z", "type": "forcePushed"}, {"oid": "3b54cacf4ee050cb037c9b544e277cf74520d23d", "url": "https://github.com/infinispan/infinispan/commit/3b54cacf4ee050cb037c9b544e277cf74520d23d", "message": "ISPN-11198 rolling upgrade docs", "committedDate": "2020-03-13T14:41:56Z", "type": "forcePushed"}, {"oid": "d889e70972ce7834e15e11152877ba1a407883af", "url": "https://github.com/infinispan/infinispan/commit/d889e70972ce7834e15e11152877ba1a407883af", "message": "ISPN-11198 rolling upgrade docs", "committedDate": "2020-03-19T11:45:06Z", "type": "forcePushed"}, {"oid": "d84bd260e467e9c352bed48f9b053dbb076b1627", "url": "https://github.com/infinispan/infinispan/commit/d84bd260e467e9c352bed48f9b053dbb076b1627", "message": "ISPN-11198 rolling upgrade docs", "committedDate": "2020-03-24T12:53:45Z", "type": "forcePushed"}, {"oid": "d2597afce97eabc3bf6a7dde5f2389b47aaead2a", "url": "https://github.com/infinispan/infinispan/commit/d2597afce97eabc3bf6a7dde5f2389b47aaead2a", "message": "ISPN-11198 rolling upgrade docs", "committedDate": "2020-03-26T09:30:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0MTE0NQ==", "url": "https://github.com/infinispan/infinispan/pull/7989#discussion_r402841145", "bodyText": "You can migrate to same version as well", "author": "gustavonalle", "createdAt": "2020-04-03T08:41:01Z", "path": "core/src/main/java/org/infinispan/upgrade/RollingUpgradeManager.java", "diffHunk": "@@ -22,14 +22,14 @@\n import org.infinispan.util.logging.LogFactory;\n \n /**\n- * This component handles the control hooks to handle migrating from one version of Infinispan to\n- * another.\n+ * RollingUpgradeManager handles the synchronization of data between Infinispan\n+ * clusters when performing rolling upgrades.\n  *\n  * @author Manik Surtani\n  * @author Tristan Tarrant\n  * @since 5.2\n  */\n-@MBean(objectName = \"RollingUpgradeManager\", description = \"This component handles the control hooks to handle migrating data from one version of Infinispan to another\")\n+@MBean(objectName = \"RollingUpgradeManager\", description = \"Handles the migration of data when upgrading to new versions.\")", "originalCommit": "d2597afce97eabc3bf6a7dde5f2389b47aaead2a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0MTk0Nw==", "url": "https://github.com/infinispan/infinispan/pull/7989#discussion_r402841947", "bodyText": "The 'read batch' is just how many entries are read at a time, not synchronized", "author": "gustavonalle", "createdAt": "2020-04-03T08:41:58Z", "path": "core/src/main/java/org/infinispan/upgrade/RollingUpgradeManager.java", "diffHunk": "@@ -53,12 +53,12 @@ public long synchronizeData(@Parameter(name=\"migratorName\", description=\"The nam\n    }\n \n    @ManagedOperation(\n-           description = \"Synchronizes data from the old cluster to this using the specified migrator\",\n-           displayName = \"Synchronizes data from the old cluster to this using the specified migrator\"\n+           description = \"Synchronizes data from source clusters to target clusters with the specified migrator.\",\n+           displayName = \"Synchronizes data from source clusters to target clusters with the specified migrator.\"\n    )\n-   public long synchronizeData(@Parameter(name = \"migratorName\", description = \"The name of the migrator to use\") String migratorName,\n-                               @Parameter(name = \"readBatch\", description = \"Numbers of entries transferred at a time from the old cluster\") int readBatch,\n-                               @Parameter(name = \"threads\", description = \"Number of threads per node used to write data to the new cluster\") int threads) throws Exception {\n+   public long synchronizeData(@Parameter(name = \"migratorName\", description = \"Specifies the name of the migrator to use. Set hotrod as the value unless using custom migrators.\") String migratorName,\n+                               @Parameter(name = \"readBatch\", description = \"Specifies how many entries to synchronize at a time from source clusters. Default is 10000.\") int readBatch,", "originalCommit": "d2597afce97eabc3bf6a7dde5f2389b47aaead2a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0MjY3Mg==", "url": "https://github.com/infinispan/infinispan/pull/7989#discussion_r402842672", "bodyText": "Not necessarily the latests version, but it could be the same version", "author": "gustavonalle", "createdAt": "2020-04-03T08:42:51Z", "path": "documentation/src/main/asciidoc/stories/assembly_server_upgrades.adoc", "diffHunk": "@@ -0,0 +1,13 @@\n+[id='upgrade']\n+:context: server\n+= Upgrading {brandname} Servers\n+Perform rolling upgrades of your {brandname} clusters to start using the\n+latest version without downtime or data loss.", "originalCommit": "d2597afce97eabc3bf6a7dde5f2389b47aaead2a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0NDIyMA==", "url": "https://github.com/infinispan/infinispan/pull/7989#discussion_r402844220", "bodyText": "I just added a REST call to perform all those JMX ops, could you add them here?", "author": "gustavonalle", "createdAt": "2020-04-03T08:44:34Z", "path": "documentation/src/main/asciidoc/topics/proc_upgrading_sync_data.adoc", "diffHunk": "@@ -0,0 +1,26 @@\n+[id='sync_data']\n+= Synchronizing Data to Target Clusters\n+When your target cluster is running and handling client requests using a remote\n+cache store to load data on demand, you can synchronize data from the source\n+cluster to the target cluster.\n+\n+This operation reads data from the source cluster and writes it to the target\n+cluster. Data migrates to all nodes in the target cluster in parallel, with\n+each node receiving a subset of the data. You must perform the synchronization\n+for each cache in your {brandname} configuration.\n+\n+.Procedure\n+\n+. Start the synchronization operation for each cache in your {brandname}\n+configuration that you want to migrate to the target cluster.\n++\n+* JMX: Invoke `synchronizeData(migratorName=hotrod)` on the `RollingUpgradeManager` MBean.\n++\n+. Disconnect each node in the target cluster from the source cluster.\n++\n+* JMX: Invoke `disconnectSource(migratorName=hotrod)` on the `RollingUpgradeManager` MBean.", "originalCommit": "d2597afce97eabc3bf6a7dde5f2389b47aaead2a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fd575a3b91683b052e5f311fa14413ebe32a5f37", "url": "https://github.com/infinispan/infinispan/commit/fd575a3b91683b052e5f311fa14413ebe32a5f37", "message": "ISPN-11198 RU add REST invocations + feedback", "committedDate": "2020-04-22T17:04:36Z", "type": "forcePushed"}, {"oid": "bf1e3ea065bd8a1ecfbcc8e7aea9ca5976cf96e1", "url": "https://github.com/infinispan/infinispan/commit/bf1e3ea065bd8a1ecfbcc8e7aea9ca5976cf96e1", "message": "ISPN-11198 RU add REST invocations + feedback", "committedDate": "2020-04-28T07:43:50Z", "type": "forcePushed"}, {"oid": "724f3705088449ed705b1ccfa3713e4358847663", "url": "https://github.com/infinispan/infinispan/commit/724f3705088449ed705b1ccfa3713e4358847663", "message": "fixing upgrade guide", "committedDate": "2020-04-28T16:50:39Z", "type": "forcePushed"}, {"oid": "fc6138bbccd7825261aea50d9506d1e2fd9d3179", "url": "https://github.com/infinispan/infinispan/commit/fc6138bbccd7825261aea50d9506d1e2fd9d3179", "message": "ISPN-11198 rolling upgrade docs", "committedDate": "2020-04-29T11:52:03Z", "type": "forcePushed"}, {"oid": "5bc7ef55eef1886742292b37d7182025a0aa3cac", "url": "https://github.com/infinispan/infinispan/commit/5bc7ef55eef1886742292b37d7182025a0aa3cac", "message": "ISPN-11198 rolling upgrade docs", "committedDate": "2020-04-30T08:14:48Z", "type": "commit"}, {"oid": "5bc7ef55eef1886742292b37d7182025a0aa3cac", "url": "https://github.com/infinispan/infinispan/commit/5bc7ef55eef1886742292b37d7182025a0aa3cac", "message": "ISPN-11198 rolling upgrade docs", "committedDate": "2020-04-30T08:14:48Z", "type": "forcePushed"}]}