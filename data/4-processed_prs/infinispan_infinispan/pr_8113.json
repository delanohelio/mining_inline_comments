{"pr_number": 8113, "pr_title": "ISPN-11541 Add internal metadata to write commands", "pr_createdAt": "2020-03-26T18:27:16Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8113", "timeline": [{"oid": "ae96055673d295d759ac7c2f8c0ef0527957fef1", "url": "https://github.com/infinispan/infinispan/commit/ae96055673d295d759ac7c2f8c0ef0527957fef1", "message": "ISPN-11541 Add internal metadata to write commands", "committedDate": "2020-03-27T09:38:35Z", "type": "forcePushed"}, {"oid": "919a3c71c7309d3a57307403f76c0c95857b4e93", "url": "https://github.com/infinispan/infinispan/commit/919a3c71c7309d3a57307403f76c0c95857b4e93", "message": "ISPN-11541 Add internal metadata to write commands", "committedDate": "2020-03-30T08:46:35Z", "type": "forcePushed"}, {"oid": "38d1bd6936899a842cd82357ec1dc3e8aab62194", "url": "https://github.com/infinispan/infinispan/commit/38d1bd6936899a842cd82357ec1dc3e8aab62194", "message": "ISPN-11541 Add internal metadata to write commands", "committedDate": "2020-04-06T15:14:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc5NjI0OQ==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404796249", "bodyText": "Is this still meant to be commented?\nIf we're removing this, should it be a separate commit/Jira?", "author": "ryanemerson", "createdAt": "2020-04-07T13:11:31Z", "path": "core/src/main/java/org/infinispan/factories/InterceptorChainFactory.java", "diffHunk": "@@ -125,9 +124,10 @@ private AsyncInterceptorChain buildInterceptorChain() {\n       }\n       interceptorChain.appendInterceptor(createInterceptor(new InvocationContextInterceptor(), InvocationContextInterceptor.class), false);\n \n-      if (!configuration.transaction().transactionMode().isTransactional()) {\n-         interceptorChain.appendInterceptor(createInterceptor(new VersionInterceptor(), VersionInterceptor.class), false);\n-      }\n+      //TODO! why adding version for replace?\n+      //if (!configuration.transaction().transactionMode().isTransactional()) {\n+      //   interceptorChain.appendInterceptor(createInterceptor(new VersionInterceptor(), VersionInterceptor.class), false);\n+      //}", "originalCommit": "38d1bd6936899a842cd82357ec1dc3e8aab62194", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkwNjQwMQ==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404906401", "bodyText": "I forgot to ask @gustavonalle about it. Is the VersionInterceptor still needed?\nIt sets some version for the replace commands and I didn't find any usage of that version.\nIt breaks the xsite tests if non-tx cache (on site 1) backups to a tx cache (on site 2).", "author": "pruivo", "createdAt": "2020-04-07T15:35:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc5NjI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkyOTkzMQ==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404929931", "bodyText": "I am not sure TBH. This is a relic from the compat mode times", "author": "gustavonalle", "createdAt": "2020-04-07T16:05:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc5NjI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk5NTU5Ng==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404995596", "bodyText": "oh... I found a failure... EmbeddedRestMemcachedHotRodTest fails without it.\nI need to drop the version in the receiver site... bah...", "author": "pruivo", "createdAt": "2020-04-07T17:43:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc5NjI0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgwNTY3OQ==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404805679", "bodyText": "We should add MetaParamsInternalMetadata to CommandsFactory#buildPutKeyValueCommand.\nSimilarly, I noticed that the internal metadata is not  set in ProtobufMetadataManagerInterceptor. How are internal commands handled by xsite, should this be set there as well?", "author": "ryanemerson", "createdAt": "2020-04-07T13:24:50Z", "path": "core/src/main/java/org/infinispan/statetransfer/StateConsumerImpl.java", "diffHunk": "@@ -733,6 +733,7 @@ protected IntSet getOwnedSegments(ConsistentHash consistentHash) {\n       InternalMetadataImpl metadata = new InternalMetadataImpl(e);\n       PutKeyValueCommand put = commandsFactory.buildPutKeyValueCommand(e.getKey(), e.getValue(), segmentId,\n                                                                        metadata, STATE_TRANSFER_FLAGS);\n+      put.setInternalMetadata(e.getInternalMetadata());", "originalCommit": "38d1bd6936899a842cd82357ec1dc3e8aab62194", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxMDU0MA==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404910540", "bodyText": "We should add MetaParamsInternalMetadata to CommandsFactory#buildPutKeyValueCommand.\n\nI didn't add it because I want to try to avoid touching too much interface... it would require a lot of changes everywhere and most of the places, the value is null.\n\nSimilarly, I noticed that the internal metadata is not set in ProtobufMetadataManagerInterceptor.\nIs it needed? and set it to what exactly? (sorry, no idea what ProtobufMetadataManagerInterceptor is)\n\nThe current xsite impl doesn't use it.\nIn the new one, the internal metadata is set by the primary owner before replicating it to the backup owners.\nIt is also used by the state transfer so the joiners can set the correct versions.", "author": "pruivo", "createdAt": "2020-04-07T15:40:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgwNTY3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgwNjg5Mg==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404806892", "bodyText": "Unless this method will be used more in follow up changes, this method seems unnecessary.", "author": "ryanemerson", "createdAt": "2020-04-07T13:26:30Z", "path": "core/src/main/java/org/infinispan/xsite/ClusteredCacheBackupReceiver.java", "diffHunk": "@@ -208,6 +207,10 @@ private XSiteStatePushCommand newStatePushCommand(List<XSiteState> stateList) {\n       return commandsFactory.buildXSiteStatePushCommand(stateList.toArray(new XSiteState[0]), 0);\n    }\n \n+   private ClusteringDependentLogic getClusteringDependentLogic() {\n+      return cache.getComponentRegistry().getComponent(ClusteringDependentLogic.class);\n+   }", "originalCommit": "38d1bd6936899a842cd82357ec1dc3e8aab62194", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxMDczMg==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404910732", "bodyText": "I can remove it. It isn't used yet...", "author": "pruivo", "createdAt": "2020-04-07T15:40:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgwNjg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc4OTIwNQ==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404789205", "bodyText": "Is there no way we can trim this somehow... a ConcurrentHashMap for every functional command is a lot of bloat. Why not just 1 like we did with the other metadata?", "author": "wburns", "createdAt": "2020-04-07T13:00:44Z", "path": "core/src/main/java/org/infinispan/commands/functional/AbstractWriteManyCommand.java", "diffHunk": "@@ -20,6 +24,7 @@\n    long flags;\n    DataConversion keyDataConversion;\n    DataConversion valueDataConversion;\n+   Map<Object, MetaParamsInternalMetadata> internalMetadataMap;", "originalCommit": "38d1bd6936899a842cd82357ec1dc3e8aab62194", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxMjAxMQ==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404912011", "bodyText": "The internal metadata is stored per key. Each key will have a different version.", "author": "pruivo", "createdAt": "2020-04-07T15:42:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc4OTIwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc0ODY1MA==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404748650", "bodyText": "Can we use an immutable empty list here?", "author": "johnou", "createdAt": "2020-04-07T11:52:02Z", "path": "core/src/main/java/org/infinispan/commands/functional/AbstractWriteManyCommand.java", "diffHunk": "@@ -30,13 +35,15 @@ protected AbstractWriteManyCommand(CommandInvocationId commandInvocationId,\n       this.flags = params.toFlagsBitSet();\n       this.keyDataConversion = keyDataConversion;\n       this.valueDataConversion = valueDataConversion;\n+      this.internalMetadataMap = new ConcurrentHashMap<>();", "originalCommit": "38d1bd6936899a842cd82357ec1dc3e8aab62194", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxNDcwOA==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404914708", "bodyText": "no, otherwise I will get an UnsupportedException when I try to put metadata there.\nIt can be null but then I will have to put some null checks before get/put and do a proper synchronization around it. I would rather not do it.", "author": "pruivo", "createdAt": "2020-04-07T15:46:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc0ODY1MA=="}], "type": "inlineReview"}, {"oid": "11252ee28ccfe69b57b71577db60086f6ff8c999", "url": "https://github.com/infinispan/infinispan/commit/11252ee28ccfe69b57b71577db60086f6ff8c999", "message": "ISPN-11541 Add internal metadata to write commands", "committedDate": "2020-04-07T15:46:49Z", "type": "forcePushed"}, {"oid": "d853df100da2eb427ced45fe8068b43c78ab2df0", "url": "https://github.com/infinispan/infinispan/commit/d853df100da2eb427ced45fe8068b43c78ab2df0", "message": "ISPN-11541 Add internal metadata to write commands", "committedDate": "2020-04-07T17:56:32Z", "type": "forcePushed"}, {"oid": "c577dd6cf42a84b93281b8464b43a9535aae8b56", "url": "https://github.com/infinispan/infinispan/commit/c577dd6cf42a84b93281b8464b43a9535aae8b56", "message": "ISPN-11541 Add internal metadata to write commands", "committedDate": "2020-04-08T08:36:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0NTU3Nw==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r406045577", "bodyText": "Unnecessary override of isValid, it's the same as ValidResponse impl.", "author": "ryanemerson", "createdAt": "2020-04-09T08:36:26Z", "path": "core/src/main/java/org/infinispan/remoting/responses/PrepareResponse.java", "diffHunk": "@@ -0,0 +1,111 @@\n+package org.infinispan.remoting.responses;\n+\n+import static org.infinispan.commons.marshall.MarshallUtil.marshallMap;\n+import static org.infinispan.commons.marshall.MarshallUtil.unmarshallMap;\n+\n+import java.io.IOException;\n+import java.io.ObjectInput;\n+import java.io.ObjectOutput;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.infinispan.commons.marshall.AbstractExternalizer;\n+import org.infinispan.container.versioning.IncrementableEntryVersion;\n+import org.infinispan.marshall.core.Ids;\n+import org.infinispan.transaction.impl.WriteSkewHelper;\n+\n+/**\n+ * A {@link ValidResponse} used by Optimistic Transactions.\n+ * <p>\n+ * It contains the new {@link IncrementableEntryVersion} for each key updated.\n+ * <p>\n+ * To be extended in the future.\n+ *\n+ * @author Pedro Ruivo\n+ * @since 11.0\n+ */\n+public class PrepareResponse extends ValidResponse {\n+\n+   public static final Externalizer EXTERNALIZER = new Externalizer();\n+\n+   private Map<Object, IncrementableEntryVersion> newWriteSkewVersions;\n+\n+   public static void writeTo(PrepareResponse response, ObjectOutput output) throws IOException {\n+      marshallMap(response.newWriteSkewVersions, output);\n+   }\n+\n+   public static PrepareResponse readFrom(ObjectInput input) throws IOException, ClassNotFoundException {\n+      PrepareResponse response = new PrepareResponse();\n+      response.newWriteSkewVersions = unmarshallMap(input, HashMap::new);\n+      return response;\n+   }\n+\n+   public static PrepareResponse asPrepareResponse(Object rv) {\n+      assert rv == null || rv instanceof PrepareResponse;\n+      return rv == null ? new PrepareResponse() : (PrepareResponse) rv;\n+   }\n+\n+   @Override\n+   public boolean isSuccessful() {\n+      return true;\n+   }\n+\n+   @Override\n+   public boolean isValid() {\n+      return true;", "originalCommit": "c577dd6cf42a84b93281b8464b43a9535aae8b56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA3MzA5MQ==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r406073091", "bodyText": "\ud83d\udc4d", "author": "pruivo", "createdAt": "2020-04-09T09:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0NTU3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0NTg1OQ==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r406045859", "bodyText": "Should we throw new UnsupportedOperationException(); here the same as in UnsureResponse as it should never be called?", "author": "ryanemerson", "createdAt": "2020-04-09T08:36:56Z", "path": "core/src/main/java/org/infinispan/remoting/responses/PrepareResponse.java", "diffHunk": "@@ -0,0 +1,111 @@\n+package org.infinispan.remoting.responses;\n+\n+import static org.infinispan.commons.marshall.MarshallUtil.marshallMap;\n+import static org.infinispan.commons.marshall.MarshallUtil.unmarshallMap;\n+\n+import java.io.IOException;\n+import java.io.ObjectInput;\n+import java.io.ObjectOutput;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.infinispan.commons.marshall.AbstractExternalizer;\n+import org.infinispan.container.versioning.IncrementableEntryVersion;\n+import org.infinispan.marshall.core.Ids;\n+import org.infinispan.transaction.impl.WriteSkewHelper;\n+\n+/**\n+ * A {@link ValidResponse} used by Optimistic Transactions.\n+ * <p>\n+ * It contains the new {@link IncrementableEntryVersion} for each key updated.\n+ * <p>\n+ * To be extended in the future.\n+ *\n+ * @author Pedro Ruivo\n+ * @since 11.0\n+ */\n+public class PrepareResponse extends ValidResponse {\n+\n+   public static final Externalizer EXTERNALIZER = new Externalizer();\n+\n+   private Map<Object, IncrementableEntryVersion> newWriteSkewVersions;\n+\n+   public static void writeTo(PrepareResponse response, ObjectOutput output) throws IOException {\n+      marshallMap(response.newWriteSkewVersions, output);\n+   }\n+\n+   public static PrepareResponse readFrom(ObjectInput input) throws IOException, ClassNotFoundException {\n+      PrepareResponse response = new PrepareResponse();\n+      response.newWriteSkewVersions = unmarshallMap(input, HashMap::new);\n+      return response;\n+   }\n+\n+   public static PrepareResponse asPrepareResponse(Object rv) {\n+      assert rv == null || rv instanceof PrepareResponse;\n+      return rv == null ? new PrepareResponse() : (PrepareResponse) rv;\n+   }\n+\n+   @Override\n+   public boolean isSuccessful() {\n+      return true;\n+   }\n+\n+   @Override\n+   public boolean isValid() {\n+      return true;\n+   }\n+\n+   @Override\n+   public Object getResponseValue() {\n+      return null; //not used!", "originalCommit": "c577dd6cf42a84b93281b8464b43a9535aae8b56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA3MzM0NA==", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r406073344", "bodyText": "I can change it\n\ud83d\udc4d", "author": "pruivo", "createdAt": "2020-04-09T09:24:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0NTg1OQ=="}], "type": "inlineReview"}, {"oid": "7438ff694eaff60c55a32bfb43ff756923f5ce4f", "url": "https://github.com/infinispan/infinispan/commit/7438ff694eaff60c55a32bfb43ff756923f5ce4f", "message": "ISPN-11541 Add internal metadata to write commands", "committedDate": "2020-04-09T09:24:24Z", "type": "forcePushed"}, {"oid": "2e3d496db7eb0d4db8c23a3a32c3c48f064a2536", "url": "https://github.com/infinispan/infinispan/commit/2e3d496db7eb0d4db8c23a3a32c3c48f064a2536", "message": "ISPN-11541 Add internal metadata to write commands", "committedDate": "2020-04-13T10:19:32Z", "type": "commit"}, {"oid": "2e3d496db7eb0d4db8c23a3a32c3c48f064a2536", "url": "https://github.com/infinispan/infinispan/commit/2e3d496db7eb0d4db8c23a3a32c3c48f064a2536", "message": "ISPN-11541 Add internal metadata to write commands", "committedDate": "2020-04-13T10:19:32Z", "type": "forcePushed"}]}