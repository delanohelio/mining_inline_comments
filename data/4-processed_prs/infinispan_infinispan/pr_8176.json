{"pr_number": 8176, "pr_title": "ISPN-11601 Remove KeyFilter", "pr_createdAt": "2020-04-07T09:47:42Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8176", "timeline": [{"oid": "6a9777b8393ea9e4ccccdca34f5acd99a83450de", "url": "https://github.com/infinispan/infinispan/commit/6a9777b8393ea9e4ccccdca34f5acd99a83450de", "message": "ISPN-11601 Remove KeyFilter", "committedDate": "2020-04-07T13:52:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxODU3Mg==", "url": "https://github.com/infinispan/infinispan/pull/8176#discussion_r405018572", "bodyText": "Can make this one line and remove brackets now.", "author": "wburns", "createdAt": "2020-04-07T18:20:34Z", "path": "core/src/test/java/org/infinispan/notifications/cachelistener/cluster/AbstractClusterListenerTest.java", "diffHunk": "@@ -734,4 +730,11 @@ public void testMetadataExpirationConverterSuccessNotOwner() {\n       verifySimpleExpirationEvents(clusterListener, clusterListener.hasIncludeState() ? 2 : 1, key, expectedValue);\n    }\n \n+   private CacheEventFilter<Object, String> filter(Object keyToFilter) {\n+      return (Serializable & CacheEventFilter<Object, String>)\n+            (k, oldValue, oldMetadata, newValue, newMetadata, eventType) -> {\n+         boolean retVal = Objects.equals(k, keyToFilter);", "originalCommit": "6a9777b8393ea9e4ccccdca34f5acd99a83450de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxOTg1NA==", "url": "https://github.com/infinispan/infinispan/pull/8176#discussion_r405019854", "bodyText": "This looks wrong, we aren't using the filter anymore.", "author": "wburns", "createdAt": "2020-04-07T18:22:38Z", "path": "counter/src/main/java/org/infinispan/counter/impl/listener/CounterManagerNotificationManager.java", "diffHunk": "@@ -119,7 +120,8 @@ public synchronized void listenOn(Cache<CounterKey, CounterValue> cache) throws\n          topologyListener.register(cache);\n       }\n       if (!listenersRegistered) {\n-         this.cache.addListener(valueListener, CounterKeyFilter.getInstance());\n+         this.cache.addFilteredListener(valueListener, null, null,", "originalCommit": "6a9777b8393ea9e4ccccdca34f5acd99a83450de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAyMDQ4Mg==", "url": "https://github.com/infinispan/infinispan/pull/8176#discussion_r405020482", "bodyText": "Also the override to specify the events is more for remote, not for embedded as we can properly ascertain this from the annotations of the methods.", "author": "wburns", "createdAt": "2020-04-07T18:23:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxOTg1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzNzQ3NQ==", "url": "https://github.com/infinispan/infinispan/pull/8176#discussion_r405037475", "bodyText": "This looks wrong, we aren't using the filter anymore.\n\nPreviously we were using CounterKeyFilter whose accept method is return key instanceof CounterKey; which will always be the case for the counter cache. As CounterManagerNotificationManager is in a .impl package this isn't API, so AFAIK it will work for our internal needs without a filter.", "author": "ryanemerson", "createdAt": "2020-04-07T18:51:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxOTg1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAyMDkxNg==", "url": "https://github.com/infinispan/infinispan/pull/8176#discussion_r405020916", "bodyText": "Shouldn't need to specify the event types, as this is handled by the annotation itself. This is for remote listeners which we don't have access to the annotations at this point.", "author": "wburns", "createdAt": "2020-04-07T18:24:23Z", "path": "counter/src/main/java/org/infinispan/counter/impl/manager/CounterConfigurationManager.java", "diffHunk": "@@ -84,7 +85,7 @@ public void start() {\n       Map<String, CounterConfiguration> persisted = storage.loadAll();\n       persisted.forEach((name, cfg) -> stateCache.putIfAbsent(stateKey(name), cfg));\n       counterCacheStarted.set(false);\n-      stateCache.addListener(listener, new ScopeFilter(COUNTER_SCOPE));\n+      stateCache.addFilteredListener(listener, new ScopeFilter(COUNTER_SCOPE), null, Util.asSet(CacheEntryCreated.class, CacheEntryModified.class));", "originalCommit": "6a9777b8393ea9e4ccccdca34f5acd99a83450de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzNTA1Mw==", "url": "https://github.com/infinispan/infinispan/pull/8176#discussion_r405035053", "bodyText": "I didn't realise it was for remote. I figured that it might be more efficient explicitly stating them ... I didn't look into the internals. I'll update now \ud83d\udc4d", "author": "ryanemerson", "createdAt": "2020-04-07T18:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAyMDkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAyMTA4MQ==", "url": "https://github.com/infinispan/infinispan/pull/8176#discussion_r405021081", "bodyText": "Unneeded.", "author": "wburns", "createdAt": "2020-04-07T18:24:39Z", "path": "lucene/lucene-directory/src/test/java/org/infinispan/lucene/cacheloader/CacheLoaderAPITest.java", "diffHunk": "@@ -11,8 +11,8 @@\n import org.infinispan.commons.test.CommonsTestingUtil;\n import org.infinispan.commons.util.Util;\n import org.infinispan.configuration.cache.ConfigurationBuilder;\n-import org.infinispan.container.impl.InternalEntryFactory;\n import org.infinispan.container.entries.InternalCacheEntry;\n+import org.infinispan.container.impl.InternalEntryFactory;", "originalCommit": "6a9777b8393ea9e4ccccdca34f5acd99a83450de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4f8ec7809e72ff1801e7db8ba9aad75d4ee5c807", "url": "https://github.com/infinispan/infinispan/commit/4f8ec7809e72ff1801e7db8ba9aad75d4ee5c807", "message": "ISPN-11601 Remove KeyFilter", "committedDate": "2020-04-07T18:52:51Z", "type": "commit"}, {"oid": "4f8ec7809e72ff1801e7db8ba9aad75d4ee5c807", "url": "https://github.com/infinispan/infinispan/commit/4f8ec7809e72ff1801e7db8ba9aad75d4ee5c807", "message": "ISPN-11601 Remove KeyFilter", "committedDate": "2020-04-07T18:52:51Z", "type": "forcePushed"}]}