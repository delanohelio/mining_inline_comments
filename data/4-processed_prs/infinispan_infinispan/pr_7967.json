{"pr_number": 7967, "pr_title": "ISPN-11384 Cannot create OFF_HEAP caches dynamically", "pr_createdAt": "2020-02-28T16:51:10Z", "pr_url": "https://github.com/infinispan/infinispan/pull/7967", "timeline": [{"oid": "fce647fab3ef696ff5c6154233a6fd6111298cfa", "url": "https://github.com/infinispan/infinispan/commit/fce647fab3ef696ff5c6154233a6fd6111298cfa", "message": "ISPN-11384 Cannot create OFF_HEAP caches dynamically", "committedDate": "2020-02-28T16:46:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwOTYyNA==", "url": "https://github.com/infinispan/infinispan/pull/7967#discussion_r385809624", "bodyText": "Any idea why storageType is not an attribute like the others?", "author": "danberindei", "createdAt": "2020-02-28T16:58:04Z", "path": "core/src/main/java/org/infinispan/configuration/cache/MemoryStorageConfiguration.java", "diffHunk": "@@ -66,12 +66,15 @@ public boolean equals(Object o) {\n \n       MemoryStorageConfiguration that = (MemoryStorageConfiguration) o;\n \n-      return attributes.equals(that.attributes);\n+      if (!attributes.equals(that.attributes)) return false;\n+      return storageType == that.storageType;", "originalCommit": "fce647fab3ef696ff5c6154233a6fd6111298cfa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgxMTE1NQ==", "url": "https://github.com/infinispan/infinispan/pull/7967#discussion_r385811155", "bodyText": "because this is how it is rendered:\n<memory>\n    <off-heap size=\"10000000\" eviction=\"MEMORY\"/>\n</memory>", "author": "gustavonalle", "createdAt": "2020-02-28T17:00:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwOTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgxMjIxNg==", "url": "https://github.com/infinispan/infinispan/pull/7967#discussion_r385812216", "bodyText": "It looks like an element to me, with its own attributes. This is a recurring issue throughout the  configuration, many things are declared as Attribute but the way it is written to the XML is random, sometimes as an attribute, sometimes as an element, sometimes as a mixture of both...", "author": "gustavonalle", "createdAt": "2020-02-28T17:03:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwOTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgxMzkwMw==", "url": "https://github.com/infinispan/infinispan/pull/7967#discussion_r385813903", "bodyText": "The original intent was because each storage type would have different attributes and this way we could have validation in the parser. To be honest now with recent changes, there is no reason it should be a separate element anymore imo.", "author": "wburns", "createdAt": "2020-02-28T17:06:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwOTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgxNTE3OQ==", "url": "https://github.com/infinispan/infinispan/pull/7967#discussion_r385815179", "bodyText": "It was an attribute before, but I moved some things around when doing the JSON stuff to bring the serialized (XML/JSON) representation closer to the class representation, in the sense that an attribute is a value, and an element is a container of values and other elements", "author": "gustavonalle", "createdAt": "2020-02-28T17:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwOTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgxNzEwOQ==", "url": "https://github.com/infinispan/infinispan/pull/7967#discussion_r385817109", "bodyText": "Oh sorry I was getting confused by xml attribute and attribute in this config class. I didn't even realize it was broken out in 16467c9#diff-d99d40293ec9b3f29e5a8658769c6629", "author": "wburns", "createdAt": "2020-02-28T17:14:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwOTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgyMzY0NQ==", "url": "https://github.com/infinispan/infinispan/pull/7967#discussion_r385823645", "bodyText": "Thinking about it, it should've been broken out more, since <off-heap> has its own particular attributes, same for <object> and <binary>. I simply \"promoted\" storage type to the top element/configuration class, but the attributes are still flattened inside it, as they were before", "author": "gustavonalle", "createdAt": "2020-02-28T17:22:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwOTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgyMzk2MA==", "url": "https://github.com/infinispan/infinispan/pull/7967#discussion_r385823960", "bodyText": "@wburns I would have loved it if off-heap had size and object had count ;)\n@gustavonalle IMO it's still an attribute, it's just represented as an element name in the XML, like the cache mode is represented in the XML as the name of the cache element.", "author": "danberindei", "createdAt": "2020-02-28T17:23:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwOTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgyNDQ0MA==", "url": "https://github.com/infinispan/infinispan/pull/7967#discussion_r385824440", "bodyText": "@danberindei that may be a bit more confusing for the user, but I am fine with changing this for 11.0 if we wanted.", "author": "wburns", "createdAt": "2020-02-28T17:24:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwOTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgyOTgzNg==", "url": "https://github.com/infinispan/infinispan/pull/7967#discussion_r385829836", "bodyText": "@danberindei I prefer Attribute written as XML/JSON attributes :)\nThe JSON serializer requires this currently and potentially the XML serialization could be dropped and made generic provided the randomness of the configurations are kept at a minimum", "author": "gustavonalle", "createdAt": "2020-02-28T17:37:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwOTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMyMDMwMQ==", "url": "https://github.com/infinispan/infinispan/pull/7967#discussion_r386320301", "bodyText": "@gustavonalle I would also prefer XML/JSSON attributes to be Attribute in the programmatic config and XML/JSON elements to be builder classes, but I think the right way to do that is to make the storage type an attribute in XML/JSON, not to make it a \"not a builder, not an attribute\" in the programmatic configuration.", "author": "danberindei", "createdAt": "2020-03-02T10:48:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwOTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMyMTc2NQ==", "url": "https://github.com/infinispan/infinispan/pull/7967#discussion_r386321765", "bodyText": "@wburns sorry, I meant eviction=\"COUNT\" count=\"100\" and eviction=\"MEMORY\" size=\"100\", it's not really about off-heap vs object.\neviction-count=\"100\" and eviction-memory=\"100\" would be even more concise, the only complication with representing them as 2 attributes is we must allow one attribute to override the other when inheriting from a template but we must raise an error if both attributes are set in the same configuration.", "author": "danberindei", "createdAt": "2020-03-02T10:51:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwOTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjMyNjIxNA==", "url": "https://github.com/infinispan/infinispan/pull/7967#discussion_r386326214", "bodyText": "@danberindei Would you want to change the config and xsd for both 10.1.x and 11.x instead of this PR?", "author": "gustavonalle", "createdAt": "2020-03-02T11:00:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwOTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM1MzE5OQ==", "url": "https://github.com/infinispan/infinispan/pull/7967#discussion_r386353199", "bodyText": "@danberindei btw, the storage type is currently a builder: \n  \n    \n      infinispan/core/src/main/java/org/infinispan/configuration/cache/MemoryStorageConfigurationBuilder.java\n    \n    \n         Line 20\n      in\n      487cbc9\n    \n    \n    \n    \n\n        \n          \n           public class MemoryStorageConfigurationBuilder extends AbstractConfigurationChildBuilder implements Builder<MemoryStorageConfiguration>, ConfigurationBuilderInfo {", "author": "gustavonalle", "createdAt": "2020-03-02T12:02:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwOTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkzNDUxMA==", "url": "https://github.com/infinispan/infinispan/pull/7967#discussion_r387934510", "bodyText": "That's actually the memory() builder.", "author": "danberindei", "createdAt": "2020-03-04T21:06:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwOTYyNA=="}], "type": "inlineReview"}]}