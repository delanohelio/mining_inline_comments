{"pr_number": 8766, "pr_title": "ISPN-8241 Refactor RocksDB clearThreshold", "pr_createdAt": "2020-10-09T18:57:05Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8766", "timeline": [{"oid": "91ae9d6cab7a4c9a0d16f57eafe5c1c1258990e4", "url": "https://github.com/infinispan/infinispan/commit/91ae9d6cab7a4c9a0d16f57eafe5c1c1258990e4", "message": "ISPN-8241 Refactor RocksDB clearThreshold", "committedDate": "2020-10-13T18:53:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIwNTAzOQ==", "url": "https://github.com/infinispan/infinispan/pull/8766#discussion_r504205039", "bodyText": "This cannot use the clearThreshold here. You can end up deleting the db could include entries that aren't in the IntSet. All we can do is iterate over the entries.", "author": "wburns", "createdAt": "2020-10-13T19:31:25Z", "path": "persistence/rocksdb/src/main/java/org/infinispan/persistence/rocksdb/RocksDBStore.java", "diffHunk": "@@ -741,36 +741,32 @@ RocksDB open(Path location, DBOptions options) throws RocksDBException {\n             boolean destroyDatabase = false;\n             try (ReadOptions readOptions = new ReadOptions().setFillCache(false)) {\n                RocksIterator optionalIterator = wrapIterator(db, readOptions, -1);\n-               if (optionalIterator != null && (configuration.clearThreshold() > 0 || segments == null)) {\n-                  try (RocksIterator it = optionalIterator) {\n-                     for (it.seekToFirst(); it.isValid(); it.next()) {\n-                        byte[] keyBytes = it.key();\n-                        if (segments != null) {\n-                           Object key = unmarshall(keyBytes);\n-                           int segment = keyPartitioner.getSegment(key);\n-                           if (segments.contains(segment)) {\n-                              db.delete(defaultColumnFamilyHandle, keyBytes);\n-                           }\n-                        } else {\n-                           db.delete(defaultColumnFamilyHandle, keyBytes);\n-                           count++;\n-\n-                           if (count > configuration.clearThreshold()) {\n-                              destroyDatabase = true;\n-                              break;\n+               if (optionalIterator != null) {\n+                  if (segments == null) {\n+                     deleteRange(defaultColumnFamilyHandle, optionalIterator);\n+                  } else {\n+                     if (configuration.clearThreshold() > 0) {", "originalCommit": "91ae9d6cab7a4c9a0d16f57eafe5c1c1258990e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b34db95a6b106075ca4771c1cc543bc77cfd446c", "url": "https://github.com/infinispan/infinispan/commit/b34db95a6b106075ca4771c1cc543bc77cfd446c", "message": "ISPN-8241 Refactor RocksDB clearThreshold", "committedDate": "2020-10-13T21:18:23Z", "type": "forcePushed"}, {"oid": "b3f7a17621c08868dd906a520a88aa763e920064", "url": "https://github.com/infinispan/infinispan/commit/b3f7a17621c08868dd906a520a88aa763e920064", "message": "ISPN-8241 Refactor RocksDB clearThreshold", "committedDate": "2020-10-13T21:32:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI1NDc3MA==", "url": "https://github.com/infinispan/infinispan/pull/8766#discussion_r509254770", "bodyText": "This is equivalent to new byte[] {(byte) 0xff}, it creates an array with a single byte element.", "author": "danberindei", "createdAt": "2020-10-21T12:57:19Z", "path": "persistence/rocksdb/src/main/java/org/infinispan/persistence/rocksdb/RocksDBStore.java", "diffHunk": "@@ -78,6 +77,9 @@\n    private static final Log log = LogFactory.getLog(MethodHandles.lookup().lookupClass(), Log.class);\n    private static final boolean trace = log.isTraceEnabled();\n \n+   private static final byte[] BEGIN_KEY = new byte[0];\n+   private static final byte[] END_KEY = new byte[] {(byte) 0xffffffff};", "originalCommit": "b3f7a17621c08868dd906a520a88aa763e920064", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ1MjM4OQ==", "url": "https://github.com/infinispan/infinispan/pull/8766#discussion_r509452389", "bodyText": "I would suggest changing this method as it is really just clearing all entries for this column family handle.", "author": "wburns", "createdAt": "2020-10-21T17:01:31Z", "path": "persistence/rocksdb/src/main/java/org/infinispan/persistence/rocksdb/RocksDBStore.java", "diffHunk": "@@ -1077,4 +993,18 @@ private void putExpireDbData(ExpiryEntry entry) throws RocksDBException {\n          expiredDb.put(expiryBytes, entry.keyBytes);\n       }\n    }\n+\n+   /*\n+    * Instead of iterate in RocksIterator we use the first and last byte array\n+    */\n+   private void deleteRange(ColumnFamilyHandle handle) {", "originalCommit": "b3f7a17621c08868dd906a520a88aa763e920064", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ1NDQ5NQ==", "url": "https://github.com/infinispan/infinispan/pull/8766#discussion_r509454495", "bodyText": "This is testing clear.", "author": "wburns", "createdAt": "2020-10-21T17:05:03Z", "path": "persistence/rocksdb/src/test/java/org/infinispan/persistence/rocksdb/RocksDBStoreTest.java", "diffHunk": "@@ -155,4 +157,53 @@ public void testSegmentsRemovedAndAdded() {\n \n       assertTrue(store.contains(key));\n    }\n+\n+   // deleteRange uses a magic begin and end key. we assert that everything was removed\n+   public void testDeleteRange() {", "originalCommit": "b3f7a17621c08868dd906a520a88aa763e920064", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ1NDcyNg==", "url": "https://github.com/infinispan/infinispan/pull/8766#discussion_r509454726", "bodyText": "This is testing removeSegments", "author": "wburns", "createdAt": "2020-10-21T17:05:26Z", "path": "persistence/rocksdb/src/test/java/org/infinispan/persistence/rocksdb/RocksDBStoreTest.java", "diffHunk": "@@ -155,4 +157,53 @@ public void testSegmentsRemovedAndAdded() {\n \n       assertTrue(store.contains(key));\n    }\n+\n+   // deleteRange uses a magic begin and end key. we assert that everything was removed\n+   public void testDeleteRange() {\n+      for (int i = 0; i < 100; i++) {\n+         String key = \"key-\" + i;\n+         String value = \"value-\" + i;\n+         InternalCacheEntry entry = TestInternalCacheEntryFactory.create(key, value);\n+         MarshallableEntry me = MarshalledEntryUtil.create(entry, getMarshaller());\n+         store.write(me);\n+         assertTrue(store.contains(key));\n+      }\n+\n+      store.clear();\n+\n+      for (int i = 0; i < 100; i++) {\n+         String key = \"key-\" + i;\n+         boolean contains = store.contains(key);\n+         assertFalse(contains);\n+      }\n+   }\n+\n+   // deleteRange uses a magic begin and end key. we assert that only the data from the give segment was removed\n+   public void testDeleteRangeForGivenSegment() {", "originalCommit": "b3f7a17621c08868dd906a520a88aa763e920064", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI4NzEyMg==", "url": "https://github.com/infinispan/infinispan/pull/8766#discussion_r509287122", "bodyText": "This is inherited from the old code, but using wrapIterator complicates things unnecessarily, this is in NonSegmentedRocksDBHandler so we know the iterator is always non-null.", "author": "danberindei", "createdAt": "2020-10-21T13:33:58Z", "path": "persistence/rocksdb/src/main/java/org/infinispan/persistence/rocksdb/RocksDBStore.java", "diffHunk": "@@ -737,48 +739,25 @@ RocksDB open(Path location, DBOptions options) throws RocksDBException {\n \n       CompletionStage<Void> clear(IntSet segments) {\n          return blockingManager.runBlocking(() -> {\n-            long count = 0;\n-            boolean destroyDatabase = false;\n-            try (ReadOptions readOptions = new ReadOptions().setFillCache(false)) {\n-               RocksIterator optionalIterator = wrapIterator(db, readOptions, -1);\n-               if (optionalIterator != null && (configuration.clearThreshold() > 0 || segments == null)) {\n-                  try (RocksIterator it = optionalIterator) {\n-                     for (it.seekToFirst(); it.isValid(); it.next()) {\n-                        byte[] keyBytes = it.key();\n-                        if (segments != null) {\n+            if (segments == null) {\n+               deleteRange(defaultColumnFamilyHandle);\n+            } else {\n+               try (ReadOptions readOptions = new ReadOptions().setFillCache(false)) {\n+                  RocksIterator optionalIterator = wrapIterator(db, readOptions, -1);", "originalCommit": "b3f7a17621c08868dd906a520a88aa763e920064", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5NzU3Ng==", "url": "https://github.com/infinispan/infinispan/pull/8766#discussion_r509297576", "bodyText": "The name doesn't sound right, because it can't delete a range, only all the entries in the column family.", "author": "danberindei", "createdAt": "2020-10-21T13:46:18Z", "path": "persistence/rocksdb/src/main/java/org/infinispan/persistence/rocksdb/RocksDBStore.java", "diffHunk": "@@ -1077,4 +993,18 @@ private void putExpireDbData(ExpiryEntry entry) throws RocksDBException {\n          expiredDb.put(expiryBytes, entry.keyBytes);\n       }\n    }\n+\n+   /*\n+    * Instead of iterate in RocksIterator we use the first and last byte array\n+    */\n+   private void deleteRange(ColumnFamilyHandle handle) {", "originalCommit": "b3f7a17621c08868dd906a520a88aa763e920064", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMwMTYyMQ==", "url": "https://github.com/infinispan/infinispan/pull/8766#discussion_r509301621", "bodyText": "The test doesn't explicitly use DeleteRange, so I'd call it testClear instead.", "author": "danberindei", "createdAt": "2020-10-21T13:49:29Z", "path": "persistence/rocksdb/src/test/java/org/infinispan/persistence/rocksdb/RocksDBStoreTest.java", "diffHunk": "@@ -155,4 +157,53 @@ public void testSegmentsRemovedAndAdded() {\n \n       assertTrue(store.contains(key));\n    }\n+\n+   // deleteRange uses a magic begin and end key. we assert that everything was removed\n+   public void testDeleteRange() {", "originalCommit": "b3f7a17621c08868dd906a520a88aa763e920064", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMwNDM1MQ==", "url": "https://github.com/infinispan/infinispan/pull/8766#discussion_r509304351", "bodyText": "On the on hand, 100 keys is way too much. On the other hand, all 100 keys start with the protostream prefix + the same bytes of \"key-\". We need to test a key that has more 0xff bytes than the last key in our DeleteRange call.", "author": "danberindei", "createdAt": "2020-10-21T13:51:43Z", "path": "persistence/rocksdb/src/test/java/org/infinispan/persistence/rocksdb/RocksDBStoreTest.java", "diffHunk": "@@ -155,4 +157,53 @@ public void testSegmentsRemovedAndAdded() {\n \n       assertTrue(store.contains(key));\n    }\n+\n+   // deleteRange uses a magic begin and end key. we assert that everything was removed\n+   public void testDeleteRange() {\n+      for (int i = 0; i < 100; i++) {", "originalCommit": "b3f7a17621c08868dd906a520a88aa763e920064", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkzNjQ0OA==", "url": "https://github.com/infinispan/infinispan/pull/8766#discussion_r509936448", "bodyText": "There's already a testSegmentsRemovedAndAdded method, we should improve that, and again we don't need 100 keys.", "author": "danberindei", "createdAt": "2020-10-22T07:25:42Z", "path": "persistence/rocksdb/src/test/java/org/infinispan/persistence/rocksdb/RocksDBStoreTest.java", "diffHunk": "@@ -155,4 +157,53 @@ public void testSegmentsRemovedAndAdded() {\n \n       assertTrue(store.contains(key));\n    }\n+\n+   // deleteRange uses a magic begin and end key. we assert that everything was removed\n+   public void testDeleteRange() {\n+      for (int i = 0; i < 100; i++) {\n+         String key = \"key-\" + i;\n+         String value = \"value-\" + i;\n+         InternalCacheEntry entry = TestInternalCacheEntryFactory.create(key, value);\n+         MarshallableEntry me = MarshalledEntryUtil.create(entry, getMarshaller());\n+         store.write(me);\n+         assertTrue(store.contains(key));\n+      }\n+\n+      store.clear();\n+\n+      for (int i = 0; i < 100; i++) {\n+         String key = \"key-\" + i;\n+         boolean contains = store.contains(key);\n+         assertFalse(contains);\n+      }\n+   }\n+\n+   // deleteRange uses a magic begin and end key. we assert that only the data from the give segment was removed\n+   public void testDeleteRangeForGivenSegment() {", "originalCommit": "b3f7a17621c08868dd906a520a88aa763e920064", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkzNjg0Mg==", "url": "https://github.com/infinispan/infinispan/pull/8766#discussion_r509936842", "bodyText": "The deprecation needs to be added in the builder and XSD as well, and the parser needs to ignore it.", "author": "danberindei", "createdAt": "2020-10-22T07:26:24Z", "path": "persistence/rocksdb/src/main/java/org/infinispan/persistence/rocksdb/configuration/RocksDBStoreConfiguration.java", "diffHunk": "@@ -105,6 +105,11 @@ public int expiryQueueSize() {\n       return expiration.expiryQueueSize();\n    }\n \n+   /**\n+    * @deprecated clearThreshold is no longer being used.\n+    * @return the configured clear threshold\n+    */\n+   @Deprecated", "originalCommit": "b3f7a17621c08868dd906a520a88aa763e920064", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDIxNjU3Ng==", "url": "https://github.com/infinispan/infinispan/pull/8766#discussion_r510216576", "bodyText": "I updated my dan_ISPN-8241_RocksDBStore branch with some changes to ignore the element if the schema version is < 12 or to throw an exception otherwise.", "author": "danberindei", "createdAt": "2020-10-22T14:38:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkzNjg0Mg=="}], "type": "inlineReview"}, {"oid": "b4152bfae4fd766694255161053c655a0d382312", "url": "https://github.com/infinispan/infinispan/commit/b4152bfae4fd766694255161053c655a0d382312", "message": "ISPN-8241 Refactor RocksDB clearThreshold", "committedDate": "2020-10-22T16:23:47Z", "type": "commit"}, {"oid": "c1f637a3d390214f130c71f9977e8e87686d24be", "url": "https://github.com/infinispan/infinispan/commit/c1f637a3d390214f130c71f9977e8e87686d24be", "message": "ISPN-8241 Deprecate RocksDB clearThreshold\n\nRocksDBStore now uses DeleteRange to clear the database or a\ncolumn family.", "committedDate": "2020-10-22T16:26:17Z", "type": "forcePushed"}, {"oid": "0359a01dd18140ee6cf0384919922103b7699406", "url": "https://github.com/infinispan/infinispan/commit/0359a01dd18140ee6cf0384919922103b7699406", "message": "ISPN-8241 Deprecate RocksDB clearThreshold\n\nRocksDBStore now uses DeleteRange to clear the database or a\ncolumn family.", "committedDate": "2020-10-22T18:29:34Z", "type": "commit"}, {"oid": "0359a01dd18140ee6cf0384919922103b7699406", "url": "https://github.com/infinispan/infinispan/commit/0359a01dd18140ee6cf0384919922103b7699406", "message": "ISPN-8241 Deprecate RocksDB clearThreshold\n\nRocksDBStore now uses DeleteRange to clear the database or a\ncolumn family.", "committedDate": "2020-10-22T18:29:34Z", "type": "forcePushed"}]}