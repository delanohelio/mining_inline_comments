{"pr_number": 8212, "pr_title": "ISPN-10428 clarify path usage for single file stores", "pr_createdAt": "2020-04-16T19:21:35Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8212", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5NjA5OA==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r409796098", "bodyText": "@ryanemerson I'm curious about the programmatic configuration. docs provide this example:\nConfigurationBuilder b = new ConfigurationBuilder();\nb.persistence()\n    .addSingleFileStore()\n    .location(\"myDataStore\")\n    .maxEntries(5000);\n\nthis is for library right? is there a way to configure persistence via Hot Rod other than using XMLStringConfiguration to pass a cache definition that includes file-store?", "author": "oraNod", "createdAt": "2020-04-16T19:25:57Z", "path": "documentation/src/main/asciidoc/topics/ref_cache_store_sfs.adoc", "diffHunk": "@@ -19,9 +19,26 @@ defragmented.\n \n .Declarative configuration\n \n+* For embedded deployments, {brandname} stores data to the current working\n+directory. To store data in a different location, specify the absolute path to\n+that directory as the value, as in the following example:\n+\n+[source,xml,options=\"nowrap\",subs=attributes+]\n+----\n+<persistence>\n+\u00a0\u00a0 <file-store path=\"/path/to/myDataStore\" max-entries=\"5000\"/>\n+</persistence>\n+----\n+\n+* For server deployments, {brandname} stores data in `{server_home}/data`. You\n+should not specify a `path` for Single File cache stores with {brandname} \n+server.\n+\n [source,xml,options=\"nowrap\",subs=attributes+]\n ----\n-include::config_examples/persistence_file_store.xml[]\n+<persistence>\n+\u00a0\u00a0 <file-store max-entries=\"5000\"/>\n+</persistence>", "originalCommit": "0529c945aa155e0e3b9df9dd0bfe0f659afe0062", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIyMTk2MA==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r411221960", "bodyText": "Yep this is for library. There's no other way to configure persistence via Hot Rod as there is no other way to configure caches. Persistence configuration is just a sub-module of the overall cache configuration which doesn't get any special treatment.", "author": "ryanemerson", "createdAt": "2020-04-20T09:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5NjA5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgxMDkxNA==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r412810914", "bodyText": "FYI that Tristan added this to the Hot Rod client props recently: \n  \n    \n      infinispan/client/hotrod-client/src/main/java/org/infinispan/client/hotrod/configuration/package-info.java\n    \n    \n         Line 413\n      in\n      1ffe539\n    \n    \n    \n    \n\n        \n          \n            *           <td><b>infinispan.client.hotrod.cache.<i>cachename</i>.configuration</b></td>", "author": "oraNod", "createdAt": "2020-04-22T09:11:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5NjA5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgxMjY5OA==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r412812698", "bodyText": "actually here's RemoteCacheConfigurationBuilder.java 4ecc499#diff-f98cef32f0dccd584e5609d2e33b48b9R68", "author": "oraNod", "createdAt": "2020-04-22T09:13:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5NjA5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgyOTM4OQ==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r412829389", "bodyText": "Yep,  that PR was badly timed with my comment \ud83d\ude04", "author": "ryanemerson", "createdAt": "2020-04-22T09:37:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5NjA5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgzODM5NQ==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r412838395", "bodyText": "ha. I wasn't sure if you'd seen that or not. it actually helps me solve a problem because docs often show programmatic examples that only apply to embedded but we don't always make that clear.", "author": "oraNod", "createdAt": "2020-04-22T09:50:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5NjA5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIyNzQ0NA==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r411227444", "bodyText": "This isn't correct on master anymore due to https://issues.redhat.com/browse/ISPN-11556. If the value of path is an absolute path, then that value must be a sub path of globalState.persistentLocation or an exception is thrown.\nFor example:\n// Global configuration\nglobalState().persistentLocation(`/tmp/example/`);\n...\n// Cache configuration\n1. config.addSingleFileStore().location('/tmp/example/file-store-absolute'`)\n2. config.addSingleFileStore().location('file-store-relative'`)\n3. config.addSingleFileStore().location('/example/`)\nExample 1 and 2 are valid and result in a file-store being created at /tmp/example/file-store-absolute and /tmp/example/file-store-relative.\nExample 3 is invalid as the root is different, i.e. /example != /tmp/example and so a CacheConfigurationException is thrown.", "author": "ryanemerson", "createdAt": "2020-04-20T09:23:58Z", "path": "documentation/src/main/asciidoc/topics/ref_cache_store_sfs.adoc", "diffHunk": "@@ -19,9 +19,26 @@ defragmented.\n \n .Declarative configuration\n \n+* For embedded deployments, {brandname} stores data to the current working\n+directory. To store data in a different location, specify the absolute path to\n+that directory as the value, as in the following example:\n+\n+[source,xml,options=\"nowrap\",subs=attributes+]\n+----\n+<persistence>\n+\u00a0\u00a0 <file-store path=\"/path/to/myDataStore\" max-entries=\"5000\"/>", "originalCommit": "0529c945aa155e0e3b9df9dd0bfe0f659afe0062", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIzMzM0NA==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r411233344", "bodyText": "So if the path and relative-to attributes in a configuration xml result in a path that is absolute and not a child of globalstate.persistenceLocation, an exception will be thrown.", "author": "ryanemerson", "createdAt": "2020-04-20T09:32:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIyNzQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg1NzUxNg==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r412857516", "bodyText": "thanks @ryanemerson ! shall I adjust for 10.1.x and push the docs commit to the backport for ISPN-11556? I think I just need to remove the ConfigSingleFileStoreRemote.java example from 10.1.x.", "author": "oraNod", "createdAt": "2020-04-22T10:18:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIyNzQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg4NDIxNw==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r412884217", "bodyText": "@oraNod why omit ConfigSingleFileStoreRemote? That is still valid in 10.1.x", "author": "ryanemerson", "createdAt": "2020-04-22T11:01:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIyNzQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg5NDgxMQ==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r412894811", "bodyText": "you're right, thanks. I didn't see the backport when I commented. that makes it easier.", "author": "oraNod", "createdAt": "2020-04-22T11:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIyNzQ0NA=="}], "type": "inlineReview"}, {"oid": "c27bf9330995afed9c38388425202f1827be32d2", "url": "https://github.com/infinispan/infinispan/commit/c27bf9330995afed9c38388425202f1827be32d2", "message": "ISPN-10428 SFS configuration docs", "committedDate": "2020-04-22T10:16:30Z", "type": "forcePushed"}, {"oid": "5c7afd991ddde264e4a6ce5f3b289880a86534c5", "url": "https://github.com/infinispan/infinispan/commit/5c7afd991ddde264e4a6ce5f3b289880a86534c5", "message": "ISPN-10428 clarify path usage for single file stores", "committedDate": "2020-04-22T10:16:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg4NzkwOA==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r412887908", "bodyText": "This is a bit strong. AFAIK in the server you can still change the location of globalstate.persistentLocation, also it would be possible to store in another subdir if desired. For example \"path=subDir\" will result in the store being located at `{server_home/data/subDir/.dat}.\nAlso, I'm not sure if the globalState.persistentLocation can be configured to exist outside of {server_home}. @tristantarrant Can you clarify?", "author": "ryanemerson", "createdAt": "2020-04-22T11:08:23Z", "path": "documentation/src/main/asciidoc/topics/ref_cache_store_sfs.adoc", "diffHunk": "@@ -19,18 +19,69 @@ defragmented.\n \n .Declarative configuration\n \n+* For embedded deployments, {brandname} stores data in the global persistent\n+location. Use the `path` attribute to specify a directory that is relative to\n+the global persistent location, as in the following example:\n+\n+[source,xml,options=\"nowrap\",subs=attributes+]\n+----\n+<persistence>\n+\u00a0\u00a0 <file-store path=\"path/to/myDataStore\" max-entries=\"5000\"/>\n+</persistence>\n+----\n+\n+{brandname} throws the following exception if you attempt to use a directory\n+outside the global persistent location:\n+\n+----\n+ISPN000558: \"The store location 'foo' is not a child of the global persistent location 'bar'\"\n+----\n+\n+For example, you configure your global persistent location as follows:\n+\n+[source,xml,options=\"nowrap\",subs=attributes+]\n+----\n+<global-state>\n+   <persistent-location path=\"/tmp/example\" relative-to=\"my.data\"/>\n+</global-state>\n+----\n+\n+To set an absolute path for the Single File store configuration, you must do so as follows:\n+\n+[source,xml,options=\"nowrap\",subs=attributes+]\n+----\n+<persistence>\n+\u00a0\u00a0 <file-store path=\"/tmp/example/path/to/myDataStore\" max-entries=\"5000\"/>\n+</persistence>\n+----\n+\n+* For server deployments, {brandname} stores data in `{server_home}/data`. You\n+should not specify a `path` for Single File cache stores with {brandname}\n+server.\n+", "originalCommit": "5c7afd991ddde264e4a6ce5f3b289880a86534c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA3OTIzOQ==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r413079239", "bodyText": "@ryanemerson I've done some local testing and changed the global persistent location to be outside the server home dir. it is also possible to set file-store path to a directory relative to the global persistent location. if I set a file-store path to an absolute directory, ISPN080028 gets thrown.", "author": "oraNod", "createdAt": "2020-04-22T15:23:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg4NzkwOA=="}], "type": "inlineReview"}, {"oid": "3045a8eea2c3f456383a4a4a88833d5d5597685b", "url": "https://github.com/infinispan/infinispan/commit/3045a8eea2c3f456383a4a4a88833d5d5597685b", "message": "ISPN-10428 clarify path usage for single file stores", "committedDate": "2020-04-22T16:02:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY1MjA4NA==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r413652084", "bodyText": "This should be the file-store xml I think", "author": "ryanemerson", "createdAt": "2020-04-23T09:16:40Z", "path": "documentation/src/main/asciidoc/topics/proc_setting_persistent_location.adoc", "diffHunk": "@@ -40,8 +37,33 @@ public GlobalStateConfigurationBuilder persistentLocation(String path, String re\n }\n ----\n \n-{brandname} logs the following message if you attempt to use a directory\n-outside the global persistent location with file-based cache stores:\n+.File-Based Cache Stores and Global Persistent Location\n+\n+When using file-based cache stores, you can optionally specify filesystem directories for storage. These paths are relative to the global persistent location.\n+\n+For example, you configure your global persistent location as follows:\n+\n+[source,xml,options=\"nowrap\",subs=attributes+]\n+----\n+<global-state>\n+   <persistent-location path=\"/tmp/example\" relative-to=\"my.data\"/>\n+</global-state>\n+----\n+\n+You then configure a Single File cache store that uses a path named\n+`myDataStore` as follows:\n+\n+[source,xml,options=\"nowrap\",subs=attributes+]\n+----\n+<global-state>\n+   <persistent-location path=\"myDataStore\" relative-to=\"my.data\"/>\n+</global-state>", "originalCommit": "3045a8eea2c3f456383a4a4a88833d5d5597685b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcxNDkxNQ==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r413714915", "bodyText": "yes it should. nice catch.", "author": "oraNod", "createdAt": "2020-04-23T10:52:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY1MjA4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY1MjMxNQ==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r413652315", "bodyText": "It will be /tmp/example/myDataStore/<cache-name>.dat", "author": "ryanemerson", "createdAt": "2020-04-23T09:16:58Z", "path": "documentation/src/main/asciidoc/topics/proc_setting_persistent_location.adoc", "diffHunk": "@@ -40,8 +37,33 @@ public GlobalStateConfigurationBuilder persistentLocation(String path, String re\n }\n ----\n \n-{brandname} logs the following message if you attempt to use a directory\n-outside the global persistent location with file-based cache stores:\n+.File-Based Cache Stores and Global Persistent Location\n+\n+When using file-based cache stores, you can optionally specify filesystem directories for storage. These paths are relative to the global persistent location.\n+\n+For example, you configure your global persistent location as follows:\n+\n+[source,xml,options=\"nowrap\",subs=attributes+]\n+----\n+<global-state>\n+   <persistent-location path=\"/tmp/example\" relative-to=\"my.data\"/>\n+</global-state>\n+----\n+\n+You then configure a Single File cache store that uses a path named\n+`myDataStore` as follows:\n+\n+[source,xml,options=\"nowrap\",subs=attributes+]\n+----\n+<global-state>\n+   <persistent-location path=\"myDataStore\" relative-to=\"my.data\"/>\n+</global-state>\n+----\n+\n+In this case, the configuration results in a Single File cache store in `/tmp/example/myDataStore/.dat`", "originalCommit": "3045a8eea2c3f456383a4a4a88833d5d5597685b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY1NjUzMQ==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r413656531", "bodyText": "I think the use of the word \"relative\" is confusing here as it has different meanings when talking about paths:\nhttps://en.wikipedia.org/wiki/Path_(computing)#Absolute_and_relative_paths\nHow about:\n\"Specifies a filesystem directory for data. The value can be a relative or absolute path. Relative paths are created relative to the configured global persistent location. Whereas absolute paths must be a subdirectory of the global persistent location, otherwise an exception is thrown.\"", "author": "ryanemerson", "createdAt": "2020-04-23T09:23:06Z", "path": "core/src/main/resources/schema/infinispan-config-11.0.xsd", "diffHunk": "@@ -1858,9 +1858,10 @@\n         <xs:attribute name=\"path\" type=\"xs:string\">\n           <xs:annotation>\n             <xs:documentation>\n-              Defines a location in the root path, specified in \"relative-to\",\n-              where the cache state is stored. Defaults to the name of the\n-              cache container.\n+              Specifies a filesystem directory for data. The value should\n+              always be relative to the global persistent location. If you set", "originalCommit": "3045a8eea2c3f456383a4a4a88833d5d5597685b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyMTk2Mg==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r413721962", "bodyText": "thanks, @ryanemerson that is spot on. tbh I felt I was missing some nuances in the wording. this is an excellent review!", "author": "oraNod", "createdAt": "2020-04-23T11:03:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY1NjUzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY1NzYxMQ==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r413657611", "bodyText": "\"When using file-based cache stores, you can optionally specify filesystem directories for storage. Unless absolute paths are declared, these are always relative to the global persistent location.\" ?", "author": "ryanemerson", "createdAt": "2020-04-23T09:24:38Z", "path": "documentation/src/main/asciidoc/topics/proc_setting_persistent_location.adoc", "diffHunk": "@@ -40,8 +37,33 @@ public GlobalStateConfigurationBuilder persistentLocation(String path, String re\n }\n ----\n \n-{brandname} logs the following message if you attempt to use a directory\n-outside the global persistent location with file-based cache stores:\n+.File-Based Cache Stores and Global Persistent Location\n+\n+When using file-based cache stores, you can optionally specify filesystem directories for storage. These paths are relative to the global persistent location.", "originalCommit": "3045a8eea2c3f456383a4a4a88833d5d5597685b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY1ODUyMw==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r413658523", "bodyText": "\"an absolute path\"", "author": "ryanemerson", "createdAt": "2020-04-23T09:25:52Z", "path": "documentation/src/main/asciidoc/topics/proc_setting_persistent_location.adoc", "diffHunk": "@@ -40,8 +37,33 @@ public GlobalStateConfigurationBuilder persistentLocation(String path, String re\n }\n ----\n \n-{brandname} logs the following message if you attempt to use a directory\n-outside the global persistent location with file-based cache stores:\n+.File-Based Cache Stores and Global Persistent Location\n+\n+When using file-based cache stores, you can optionally specify filesystem directories for storage. These paths are relative to the global persistent location.\n+\n+For example, you configure your global persistent location as follows:\n+\n+[source,xml,options=\"nowrap\",subs=attributes+]\n+----\n+<global-state>\n+   <persistent-location path=\"/tmp/example\" relative-to=\"my.data\"/>\n+</global-state>\n+----\n+\n+You then configure a Single File cache store that uses a path named\n+`myDataStore` as follows:\n+\n+[source,xml,options=\"nowrap\",subs=attributes+]\n+----\n+<global-state>\n+   <persistent-location path=\"myDataStore\" relative-to=\"my.data\"/>\n+</global-state>\n+----\n+\n+In this case, the configuration results in a Single File cache store in `/tmp/example/myDataStore/.dat`\n+\n+If you attempt to set a path that resides outside the global persistent", "originalCommit": "3045a8eea2c3f456383a4a4a88833d5d5597685b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY1OTEzNw==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r413659137", "bodyText": "This has the same issue as the xsd description.", "author": "ryanemerson", "createdAt": "2020-04-23T09:26:44Z", "path": "documentation/src/main/asciidoc/topics/ref_cache_store_sfs.adoc", "diffHunk": "@@ -17,20 +17,35 @@ is used only if an entry can fit within it. Likewise, if you remove all entries\n from memory, the single file store does not decrease in size or become\n defragmented.\n \n+{brandname} stores data in the global persistent location. You can optionally\n+specify a filesystem directory with the `path` attribute but the value should\n+always be relative to the global persistent location.", "originalCommit": "3045a8eea2c3f456383a4a4a88833d5d5597685b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzcyNDMwNg==", "url": "https://github.com/infinispan/infinispan/pull/8212#discussion_r413724306", "bodyText": "Let's remove this. Info belongs with the global persistent location content.", "author": "oraNod", "createdAt": "2020-04-23T11:07:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY1OTEzNw=="}], "type": "inlineReview"}, {"oid": "c9db6134b60eaee59c103e38ed7f44900ff83dd1", "url": "https://github.com/infinispan/infinispan/commit/c9db6134b60eaee59c103e38ed7f44900ff83dd1", "message": "ISPN-10428 ryan emerson doc review", "committedDate": "2020-04-23T11:09:03Z", "type": "forcePushed"}, {"oid": "65abeb8dea1f530e965095659c74b15294967db3", "url": "https://github.com/infinispan/infinispan/commit/65abeb8dea1f530e965095659c74b15294967db3", "message": "ISPN-10428 clarify path usage for single file stores", "committedDate": "2020-04-23T11:22:20Z", "type": "commit"}, {"oid": "65abeb8dea1f530e965095659c74b15294967db3", "url": "https://github.com/infinispan/infinispan/commit/65abeb8dea1f530e965095659c74b15294967db3", "message": "ISPN-10428 clarify path usage for single file stores", "committedDate": "2020-04-23T11:22:20Z", "type": "forcePushed"}]}