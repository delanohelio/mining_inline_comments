{"pr_number": 7856, "pr_title": "ISPN-11298 Create TakeOfflineManager", "pr_createdAt": "2020-02-07T10:48:22Z", "pr_url": "https://github.com/infinispan/infinispan/pull/7856", "timeline": [{"oid": "37afdc1676089509e2f0af4d41e2e82169dea691", "url": "https://github.com/infinispan/infinispan/commit/37afdc1676089509e2f0af4d41e2e82169dea691", "message": "ISPN-11298 Create TakeOfflineManager", "committedDate": "2020-02-12T14:55:54Z", "type": "forcePushed"}, {"oid": "d998b66a779075461ded2a418bcfe3a11ffebfbf", "url": "https://github.com/infinispan/infinispan/commit/d998b66a779075461ded2a418bcfe3a11ffebfbf", "message": "ISPN-11298 Create TakeOfflineManager", "committedDate": "2020-02-17T12:00:21Z", "type": "forcePushed"}, {"oid": "e4f20314da119a732d491b66556d0ea596b26ef0", "url": "https://github.com/infinispan/infinispan/commit/e4f20314da119a732d491b66556d0ea596b26ef0", "message": "ISPN-11298 Create TakeOfflineManager", "committedDate": "2020-02-19T18:21:44Z", "type": "forcePushed"}, {"oid": "96d31da979dd054cc580e7819a3eabed4916487d", "url": "https://github.com/infinispan/infinispan/commit/96d31da979dd054cc580e7819a3eabed4916487d", "message": "ISPN-11298 Create TakeOfflineManager", "committedDate": "2020-02-21T16:09:39Z", "type": "forcePushed"}, {"oid": "24e0c7565c567f66a58f4abf89ed5703d757542c", "url": "https://github.com/infinispan/infinispan/commit/24e0c7565c567f66a58f4abf89ed5703d757542c", "message": "ISPN-11298 Create TakeOfflineManager", "committedDate": "2020-02-24T17:58:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU3NjcwMw==", "url": "https://github.com/infinispan/infinispan/pull/7856#discussion_r385576703", "bodyText": "Old Javadoc?", "author": "ryanemerson", "createdAt": "2020-02-28T08:59:31Z", "path": "core/src/main/java/org/infinispan/xsite/status/TakeOfflineManager.java", "diffHunk": "@@ -0,0 +1,95 @@\n+package org.infinispan.xsite.status;\n+\n+import java.util.Map;\n+\n+import org.infinispan.configuration.cache.TakeOfflineConfiguration;\n+import org.infinispan.configuration.cache.TakeOfflineConfigurationBuilder;\n+import org.infinispan.remoting.transport.XSiteResponse;\n+\n+/**\n+ * It keeps tracks of cross-site requests to take sites offline when certain failures conditions happen.\n+ * <p>\n+ * Those condition are configured in {@link TakeOfflineConfiguration}.\n+ *\n+ * @author Pedro Ruivo\n+ * @since 11.0\n+ */\n+public interface TakeOfflineManager {\n+\n+   /**\n+    * Registers a cross-site request made.\n+    * <p>\n+    * Handles the response for the request and takes action in case of failure.\n+    *\n+    * @param response The cross-site response.\n+    */\n+   void registerRequest(XSiteResponse response);\n+\n+   /**\n+    * Returns the site state for site {@code siteName}.\n+    * <p>\n+    * The site can be {@link SiteState#ONLINE} or {@link SiteState#OFFLINE}. If it doesn't exist, {@link\n+    * SiteState#NOT_FOUND} is returned.\n+    *\n+    * @param siteName The remote site name.\n+    * @return The {@link SiteState}.\n+    */\n+   SiteState getSiteState(String siteName);\n+\n+   /**\n+    * It changes the {@link TakeOfflineConfiguration} for site {@code siteName}.\n+    * <p>\n+    * If the {@code siteName} doesn't exist, this method is a no-op.\n+    *\n+    * @param siteName      The remote site name.\n+    * @param afterFailures The new {@link TakeOfflineConfigurationBuilder#afterFailures(int)} or {@code null} for no\n+    *                      changes.\n+    * @param minTimeToWait The new {@link TakeOfflineConfigurationBuilder#minTimeToWait(long)} or {@code null} for no\n+    *                      changes.\n+    */\n+   void amendConfiguration(String siteName, Integer afterFailures, Long minTimeToWait);\n+\n+   /**\n+    * It returns the current {@link TakeOfflineConfiguration} for site {@code siteName}.\n+    *\n+    * @param siteName The remote site name.\n+    * @return The current {@link TakeOfflineConfiguration} or {@code null} if the site {@code siteName} doesn't exist.\n+    */\n+   TakeOfflineConfiguration getConfiguration(String siteName);\n+\n+   /**\n+    * It returns a {@link Map} with the sites name and their state (Online or Offline).\n+    * <p>\n+    * If a site is online, then its value is {@link Boolean#TRUE}, otherwise is {@link Boolean#FALSE}.\n+    *\n+    * @return A {@link Map} with the site state.\n+    */\n+   Map<String, Boolean> status();\n+\n+   /*\n+    * Brings a site with the given name back online.\n+    */", "originalCommit": "24e0c7565c567f66a58f4abf89ed5703d757542c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU4NDI3Nw==", "url": "https://github.com/infinispan/infinispan/pull/7856#discussion_r385584277", "bodyText": "yeah sorry!", "author": "pruivo", "createdAt": "2020-02-28T09:17:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU3NjcwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU3ODcyMA==", "url": "https://github.com/infinispan/infinispan/pull/7856#discussion_r385578720", "bodyText": "Why do we no need to register the request when we didn't before? AFAICT, there was no call to XSiteResponse#whenCompleted previously", "author": "ryanemerson", "createdAt": "2020-02-28T09:04:31Z", "path": "core/src/main/java/org/infinispan/xsite/BackupSenderImpl.java", "diffHunk": "@@ -244,21 +173,18 @@ private void sendTo(XSiteReplicateCommand command, Collection<XSiteBackup> xSite\n       if (rpcManager == null) {\n          for (XSiteBackup backup : xSiteBackups) {\n             XSiteResponse cs = transport.backupRemotely(backup, command);\n+            takeOfflineManager.registerRequest(cs);", "originalCommit": "24e0c7565c567f66a58f4abf89ed5703d757542c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU4NTQ1MA==", "url": "https://github.com/infinispan/infinispan/pull/7856#discussion_r385585450", "bodyText": "the previous one is here\nhttps://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/xsite/BackupSenderImpl.java#L418\nThe old method updates the offline status and handles the exception. in this PR, it only handles the exception.", "author": "pruivo", "createdAt": "2020-02-28T09:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU3ODcyMA=="}], "type": "inlineReview"}, {"oid": "efd1072c262af938910adc770575c5025865ae44", "url": "https://github.com/infinispan/infinispan/commit/efd1072c262af938910adc770575c5025865ae44", "message": "ISPN-11298 Create TakeOfflineManager", "committedDate": "2020-02-28T09:23:49Z", "type": "forcePushed"}, {"oid": "3049645aaa7c9e75aba1f8483ce5668b3d29b435", "url": "https://github.com/infinispan/infinispan/commit/3049645aaa7c9e75aba1f8483ce5668b3d29b435", "message": "ISPN-11298 Create TakeOfflineManager", "committedDate": "2020-02-28T13:47:53Z", "type": "commit"}, {"oid": "3049645aaa7c9e75aba1f8483ce5668b3d29b435", "url": "https://github.com/infinispan/infinispan/commit/3049645aaa7c9e75aba1f8483ce5668b3d29b435", "message": "ISPN-11298 Create TakeOfflineManager", "committedDate": "2020-02-28T13:47:53Z", "type": "forcePushed"}]}