{"pr_number": 8722, "pr_title": "ISPN-12362 Upgrade to protostream 4.3.4.Final", "pr_createdAt": "2020-09-28T18:41:53Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8722", "timeline": [{"oid": "9ca5deaf01b063bb5968ffac8cad0a652c307e05", "url": "https://github.com/infinispan/infinispan/commit/9ca5deaf01b063bb5968ffac8cad0a652c307e05", "message": "ISPN-12362 Upgrade to protostream 4.3.4.Final", "committedDate": "2020-09-28T20:45:13Z", "type": "forcePushed"}, {"oid": "3fdc4b7395a1da57bbce3f38e084fa834cb57fe8", "url": "https://github.com/infinispan/infinispan/commit/3fdc4b7395a1da57bbce3f38e084fa834cb57fe8", "message": "ISPN-12362 Upgrade to protostream 4.3.4.Final", "committedDate": "2020-10-01T10:27:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIxNzM5Ng==", "url": "https://github.com/infinispan/infinispan/pull/8722#discussion_r498217396", "bodyText": "The latest version won't include the bug \ud83d\ude09", "author": "ryanemerson", "createdAt": "2020-10-01T12:48:54Z", "path": "documentation/src/main/asciidoc/topics/upgrading.adoc", "diffHunk": "@@ -65,6 +65,19 @@ provided configuration. The possible statuses of the cache health are now HEALTH\n \n The Kryo and Protostuff marshallers have been deprecated and will be removed in Infinispan 15.0\n \n+=== {brandname} now uses a version of the ProtoStream API that includes a bug", "originalCommit": "22da54c1f43ff4c099bda2cfe4ee7f66370df2f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI1MDEzNQ==", "url": "https://github.com/infinispan/infinispan/pull/8722#discussion_r498250135", "bodyText": "Maybe I misinterpreted this: \"But since getEnclosingClass() always returns null that leads to all types wrongly becoming top level types in the generated schema starting with 4.3.0 when this bug appeared.\"\nISPN 12 upgrades to 4.3.4 which is the version where the bug appears, isn't that so?", "author": "oraNod", "createdAt": "2020-10-01T13:37:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIxNzM5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI2NTczNw==", "url": "https://github.com/infinispan/infinispan/pull/8722#discussion_r498265737", "bodyText": "ISPN 12 upgrades to 4.3.4 which is the version where the bug appears, isn't that so?\n\nNo, 4.3.4 introduces a fix to a bug, but fixing that bug changes behaviour.", "author": "ryanemerson", "createdAt": "2020-10-01T13:58:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIxNzM5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMwMjYxMg==", "url": "https://github.com/infinispan/infinispan/pull/8722#discussion_r498302612", "bodyText": "OK. Should be good now. Thanks for bearing with me and explaining the details.", "author": "oraNod", "createdAt": "2020-10-01T14:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIxNzM5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIxOTQ5Ng==", "url": "https://github.com/infinispan/infinispan/pull/8722#discussion_r498219496", "bodyText": "It might be easier to state that if you have previously used annotated nested classes for your types AND you have persisted these, it's necessary to refactor said classes so that they are top-level in order for the persisted data to be read.\nIf no stores are used, then it's not necessary todo anything \ud83d\ude04", "author": "ryanemerson", "createdAt": "2020-10-01T12:52:13Z", "path": "documentation/src/main/asciidoc/topics/upgrading.adoc", "diffHunk": "@@ -65,6 +65,19 @@ provided configuration. The possible statuses of the cache health are now HEALTH\n \n The Kryo and Protostuff marshallers have been deprecated and will be removed in Infinispan 15.0\n \n+=== {brandname} now uses a version of the ProtoStream API that includes a bug\n+that can affect upgrade from previous {brandname} versions. \n+\n+Protobuf message types that you generate with annotation processing at compile\n+time must have the same nesting in your annotated Java classes. If the nesting\n+in your generated messages does not match the nesting in your classes, then\n+data incompatibility issues can occur.\n+\n+However, the current version of the ProtoStream API does not correctly nest\n+message types. For this reason, if you have Java classes that include Protobuf\n+annotations, you should not nest those annotations. All Protobuf annotations in\n+your Java classes should be at top-level.\n+", "originalCommit": "22da54c1f43ff4c099bda2cfe4ee7f66370df2f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI1NjM3OQ==", "url": "https://github.com/infinispan/infinispan/pull/8722#discussion_r498256379", "bodyText": "Gotcha. I spotted your comment about binary compatibility for persisted messages. I'll revise.", "author": "oraNod", "createdAt": "2020-10-01T13:46:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIxOTQ5Ng=="}], "type": "inlineReview"}, {"oid": "a359d08dc8135fce7e6a236dfe24d8b64dc02b67", "url": "https://github.com/infinispan/infinispan/commit/a359d08dc8135fce7e6a236dfe24d8b64dc02b67", "message": "ISPN-12362 Upgrade guide note", "committedDate": "2020-10-01T14:49:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMxMDgyMg==", "url": "https://github.com/infinispan/infinispan/pull/8722#discussion_r498310822", "bodyText": "I think we can remove this paragraph. The subsequent paragraph explains the issue and what needs to be done, this just confuses me tbh.", "author": "ryanemerson", "createdAt": "2020-10-01T14:57:28Z", "path": "documentation/src/main/asciidoc/topics/upgrading.adoc", "diffHunk": "@@ -65,6 +65,21 @@ provided configuration. The possible statuses of the cache health are now HEALTH\n \n The Kryo and Protostuff marshallers have been deprecated and will be removed in Infinispan 15.0\n \n+=== {brandname} includes an upgraded version of the ProtoStream API that can\n+affect upgrade from previous {brandname} versions.\n+\n+Protobuf message types that you generate with annotation processing at compile\n+time must have the same nesting in your annotated Java classes. If the nesting\n+in your generated messages does not match the nesting in your classes, then\n+data incompatibility issues can occur.", "originalCommit": "a359d08dc8135fce7e6a236dfe24d8b64dc02b67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e82c45a8980066ba77fc33a3c3001846960067d9", "url": "https://github.com/infinispan/infinispan/commit/e82c45a8980066ba77fc33a3c3001846960067d9", "message": "ISPN-12362 Upgrade guide note", "committedDate": "2020-10-01T15:10:36Z", "type": "forcePushed"}, {"oid": "1cba74e4ccec46fde8bc671d8d6c76af776e6a4f", "url": "https://github.com/infinispan/infinispan/commit/1cba74e4ccec46fde8bc671d8d6c76af776e6a4f", "message": "ISPN-12362 Upgrade guide note", "committedDate": "2020-10-01T15:14:20Z", "type": "forcePushed"}, {"oid": "0a947c2ec590d81c1e170ed038b37ba8bf807760", "url": "https://github.com/infinispan/infinispan/commit/0a947c2ec590d81c1e170ed038b37ba8bf807760", "message": "ISPN-12362 Upgrade to protostream 4.3.4.Final", "committedDate": "2020-10-01T15:31:56Z", "type": "commit"}, {"oid": "af5256a98bae7fc0ebd71c297822f17d586844ae", "url": "https://github.com/infinispan/infinispan/commit/af5256a98bae7fc0ebd71c297822f17d586844ae", "message": "ISPN-12362 Upgrade guide note", "committedDate": "2020-10-01T15:34:45Z", "type": "commit"}, {"oid": "af5256a98bae7fc0ebd71c297822f17d586844ae", "url": "https://github.com/infinispan/infinispan/commit/af5256a98bae7fc0ebd71c297822f17d586844ae", "message": "ISPN-12362 Upgrade guide note", "committedDate": "2020-10-01T15:34:45Z", "type": "forcePushed"}]}