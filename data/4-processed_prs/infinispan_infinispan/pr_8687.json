{"pr_number": 8687, "pr_title": "ISPN-12319 XSite Response should allow a value", "pr_createdAt": "2020-09-11T15:36:09Z", "pr_url": "https://github.com/infinispan/infinispan/pull/8687", "timeline": [{"oid": "3f1f616e3fae976e962e44b39c307ebc4293e249", "url": "https://github.com/infinispan/infinispan/commit/3f1f616e3fae976e962e44b39c307ebc4293e249", "message": "ISPN-12319 XSite Response should allow a value", "committedDate": "2020-09-11T16:02:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE0NTM2OA==", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r487145368", "bodyText": "can you add the generics to org.infinispan.remoting.transport.RetryOnFailureXSiteCommand#newInstance()?\njust to remove the warnings from IDEA", "author": "pruivo", "createdAt": "2020-09-11T16:08:30Z", "path": "core/src/main/java/org/infinispan/remoting/transport/RetryOnFailureXSiteCommand.java", "diffHunk": "@@ -18,16 +18,16 @@\n  * @author Pedro Ruivo\n  * @since 7.0\n  */\n-public class RetryOnFailureXSiteCommand {\n+public class RetryOnFailureXSiteCommand<O> {\n \n    public static final RetryPolicy NO_RETRY = new MaxRetriesPolicy(0);\n    private static final Log log = LogFactory.getLog(RetryOnFailureXSiteCommand.class);\n    private static final boolean trace = log.isTraceEnabled();\n    private final XSiteBackup xSiteBackup;\n-   private final XSiteReplicateCommand command;\n+   private final XSiteReplicateCommand<O> command;\n    private final RetryPolicy retryPolicy;\n \n-   private RetryOnFailureXSiteCommand(XSiteBackup backup, XSiteReplicateCommand command, RetryPolicy retryPolicy) {\n+   private RetryOnFailureXSiteCommand(XSiteBackup backup, XSiteReplicateCommand<O> command, RetryPolicy retryPolicy) {", "originalCommit": "3f1f616e3fae976e962e44b39c307ebc4293e249", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2OTA2Nw==", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r487169067", "bodyText": "Sure, just missed that one.", "author": "wburns", "createdAt": "2020-09-11T16:52:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE0NTM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE0NzkwOA==", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r487147908", "bodyText": "nitpick\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     complete((O) response.getResponseValue());\n          \n          \n            \n                     //noinspection unchecked\n          \n          \n            \n                     complete((O) response.getResponseValue());", "author": "pruivo", "createdAt": "2020-09-11T16:13:16Z", "path": "core/src/main/java/org/infinispan/remoting/transport/impl/XSiteResponseImpl.java", "diffHunk": "@@ -38,12 +39,12 @@ public void whenCompleted(XSiteResponseCompleted xSiteResponseCompleted) {\n    }\n \n    @Override\n-   public void accept(Object o, Throwable throwable) {\n+   public void accept(ValidResponse response, Throwable throwable) {\n       durationNanos = timeService.timeDuration(sendTimeNanos, TimeUnit.NANOSECONDS);\n       if (throwable != null) {\n          completeExceptionally(throwable);\n       } else {\n-         complete(null);\n+         complete((O) response.getResponseValue());", "originalCommit": "3f1f616e3fae976e962e44b39c307ebc4293e249", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2OTg4Nw==", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r487169887", "bodyText": "\ud83d\udc4d", "author": "wburns", "createdAt": "2020-09-11T16:54:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE0NzkwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE1MTM1Mw==", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r487151353", "bodyText": "-1 CacheRpcCommand doesn't require anything from the BackupReceiver and you have the ComponentRegistry available in GlobalInboundInvocationHandler\nI would change XSiteReplicateCommand to the following and make the if-else in SingleXSiteRpcCommand\n   public CompletionStage<O> performInLocalSite(ComponentRegistry registry, boolean preserveOrder) {\n      //by default, the command is executed against BackupReceiver.\n      return execute(registry.getBackupReceiver().running(), preserveOrder);\n   }\n   //abstract? or not?\n   public abstract CompletionStage<O> execute(BackupReceiver receiver, boolean preserveOrder);", "author": "pruivo", "createdAt": "2020-09-11T16:19:36Z", "path": "core/src/main/java/org/infinispan/xsite/ClusteredCacheBackupReceiver.java", "diffHunk": "@@ -200,13 +202,20 @@ private static PrivateMetadata internalMetadata(IracMetadata metadata) {\n    }\n \n    @Override\n-   public final CompletionStage<Void> handleRemoteCommand(VisitableCommand command, boolean preserveOrder) {\n+   public final CompletionStage<Object> handleRemoteCommand(ReplicableCommand command, boolean preserveOrder) {\n+      //currently, it only handles sync xsite requests.\n+      //async xsite requests are handle by the other methods.\n+      assert !preserveOrder;\n       try {\n-         //currently, it only handles sync xsite requests.\n-         //async xsite requests are handle by the other methods.\n-         assert !preserveOrder;\n-         //noinspection unchecked\n-         return (CompletableFuture<Void>) command.acceptVisitor(null, defaultHandler);\n+         if (command instanceof VisitableCommand) {\n+            //noinspection unchecked\n+            return (CompletionStage<Object>) ((VisitableCommand)command).acceptVisitor(null, defaultHandler);\n+         } else if (command instanceof CacheRpcCommand) {", "originalCommit": "3f1f616e3fae976e962e44b39c307ebc4293e249", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE3MzIxMQ==", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r487173211", "bodyText": "Okay, I will undo the ClusteredCacheBackupReceiver part and change it up a bit more.", "author": "wburns", "createdAt": "2020-09-11T17:00:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE1MTM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE1MTc5NA==", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r487151794", "bodyText": "Also, don't need to spend CPU throwing the exception. you can create the CF with it directly (completedExceptionFuture())", "author": "pruivo", "createdAt": "2020-09-11T16:20:20Z", "path": "core/src/main/java/org/infinispan/xsite/ClusteredCacheBackupReceiver.java", "diffHunk": "@@ -200,13 +202,20 @@ private static PrivateMetadata internalMetadata(IracMetadata metadata) {\n    }\n \n    @Override\n-   public final CompletionStage<Void> handleRemoteCommand(VisitableCommand command, boolean preserveOrder) {\n+   public final CompletionStage<Object> handleRemoteCommand(ReplicableCommand command, boolean preserveOrder) {\n+      //currently, it only handles sync xsite requests.\n+      //async xsite requests are handle by the other methods.\n+      assert !preserveOrder;\n       try {\n-         //currently, it only handles sync xsite requests.\n-         //async xsite requests are handle by the other methods.\n-         assert !preserveOrder;\n-         //noinspection unchecked\n-         return (CompletableFuture<Void>) command.acceptVisitor(null, defaultHandler);\n+         if (command instanceof VisitableCommand) {\n+            //noinspection unchecked\n+            return (CompletionStage<Object>) ((VisitableCommand)command).acceptVisitor(null, defaultHandler);\n+         } else if (command instanceof CacheRpcCommand) {\n+            //noinspection unchecked\n+            return (CompletionStage<Object>) ((CacheRpcCommand) command).invokeAsync(componentRegistry);\n+         } else {\n+            throw new UnsupportedOperationException(\"Only VisitableCommand and CacheRpcCommand is allowed!\");", "originalCommit": "3f1f616e3fae976e962e44b39c307ebc4293e249", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2OTgxMA==", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r487169810", "bodyText": "I personally don't think it is worth to add more code for a case that shouldn't ever happen.", "author": "wburns", "createdAt": "2020-09-11T16:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE1MTc5NA=="}], "type": "inlineReview"}, {"oid": "dedb66b81c815434dd0f80f365573cec26432042", "url": "https://github.com/infinispan/infinispan/commit/dedb66b81c815434dd0f80f365573cec26432042", "message": "ISPN-12319 XSite Response should allow a value", "committedDate": "2020-09-14T17:03:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwMzkyOA==", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r488103928", "bodyText": "nitpick:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  }\n          \n          \n            \n                  else {\n          \n          \n            \n                  } else {", "author": "pruivo", "createdAt": "2020-09-14T17:28:58Z", "path": "core/src/main/java/org/infinispan/xsite/SingleXSiteRpcCommand.java", "diffHunk": "@@ -34,8 +37,23 @@ public SingleXSiteRpcCommand() {\n    }\n \n    @Override\n-   public CompletionStage<Void> performInLocalSite(BackupReceiver receiver, boolean preserveOrder) {\n-      return receiver.handleRemoteCommand(command, preserveOrder);\n+   public CompletionStage<Object> performInLocalSite(ComponentRegistry registry, boolean preserveOrder) {\n+      // Need to check VisitableCommand before CacheRpcCommand as PrepareCommand implements both but need to visit\n+      if (command instanceof VisitableCommand) {\n+         return super.performInLocalSite(registry, preserveOrder);\n+      }\n+      else {", "originalCommit": "dedb66b81c815434dd0f80f365573cec26432042", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwNDE0MQ==", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r488104141", "bodyText": "nitpick:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return (CompletionStage<Object>) ((CacheRpcCommand) command).invokeAsync(registry);\n          \n          \n            \n                        //noinspection unchecked\n          \n          \n            \n                        return (CompletionStage<Object>) ((CacheRpcCommand) command).invokeAsync(registry);", "author": "pruivo", "createdAt": "2020-09-14T17:29:20Z", "path": "core/src/main/java/org/infinispan/xsite/SingleXSiteRpcCommand.java", "diffHunk": "@@ -34,8 +37,23 @@ public SingleXSiteRpcCommand() {\n    }\n \n    @Override\n-   public CompletionStage<Void> performInLocalSite(BackupReceiver receiver, boolean preserveOrder) {\n-      return receiver.handleRemoteCommand(command, preserveOrder);\n+   public CompletionStage<Object> performInLocalSite(ComponentRegistry registry, boolean preserveOrder) {\n+      // Need to check VisitableCommand before CacheRpcCommand as PrepareCommand implements both but need to visit\n+      if (command instanceof VisitableCommand) {\n+         return super.performInLocalSite(registry, preserveOrder);\n+      }\n+      else {\n+         try {\n+            return (CompletionStage<Object>) ((CacheRpcCommand) command).invokeAsync(registry);", "originalCommit": "dedb66b81c815434dd0f80f365573cec26432042", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwNTAzNg==", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r488105036", "bodyText": "nitpick:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  XSiteReplicateCommand command = mock(XSiteReplicateCommand.class);\n          \n          \n            \n                  XSiteReplicateCommand<?> command = mock(XSiteReplicateCommand.class);", "author": "pruivo", "createdAt": "2020-09-14T17:30:57Z", "path": "core/src/test/java/org/infinispan/jmx/PerCacheInboundHandlerMBeanTest.java", "diffHunk": "@@ -82,7 +82,7 @@ public void testStats() throws Throwable {\n       assertEquals(Boolean.TRUE, mBeanServer.getAttribute(objName, \"StatisticsEnabled\"));\n \n       XSiteReplicateCommand command = mock(XSiteReplicateCommand.class);", "originalCommit": "dedb66b81c815434dd0f80f365573cec26432042", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9de719b2fd31f89ac6f99c4103e8939c3034c3be", "url": "https://github.com/infinispan/infinispan/commit/9de719b2fd31f89ac6f99c4103e8939c3034c3be", "message": "ISPN-12319 XSite Response should allow a value", "committedDate": "2020-09-14T17:51:12Z", "type": "commit"}, {"oid": "9de719b2fd31f89ac6f99c4103e8939c3034c3be", "url": "https://github.com/infinispan/infinispan/commit/9de719b2fd31f89ac6f99c4103e8939c3034c3be", "message": "ISPN-12319 XSite Response should allow a value", "committedDate": "2020-09-14T17:51:12Z", "type": "forcePushed"}]}