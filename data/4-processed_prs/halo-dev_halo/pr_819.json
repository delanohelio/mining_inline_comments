{"pr_number": 819, "pr_title": "feat: Support Rename and Edit Staitc Files (#573)", "pr_createdAt": "2020-05-03T14:02:07Z", "pr_url": "https://github.com/halo-dev/halo/pull/819", "timeline": [{"oid": "b6e3039a74a7e2f7333f17875a5ed8d840880a9a", "url": "https://github.com/halo-dev/halo/commit/b6e3039a74a7e2f7333f17875a5ed8d840880a9a", "message": "Add rename API", "committedDate": "2020-05-03T01:18:42Z", "type": "commit"}, {"oid": "5a310ff10dd9fbbf09aaab5645eda067d775a4a8", "url": "https://github.com/halo-dev/halo/commit/5a310ff10dd9fbbf09aaab5645eda067d775a4a8", "message": "Add save API", "committedDate": "2020-05-03T11:51:44Z", "type": "commit"}, {"oid": "896be524214f3911911d6f546aaa100992dc1f27", "url": "https://github.com/halo-dev/halo/commit/896be524214f3911911d6f546aaa100992dc1f27", "message": "Add unit test for rename API", "committedDate": "2020-05-03T13:29:27Z", "type": "commit"}, {"oid": "8d5bfddfae628bcdfed2d33e6bfc4201eb35723e", "url": "https://github.com/halo-dev/halo/commit/8d5bfddfae628bcdfed2d33e6bfc4201eb35723e", "message": "Fix an indentation", "committedDate": "2020-05-03T14:16:21Z", "type": "commit"}, {"oid": "41bb33d69eb56b08bf6509049147d961634ac45a", "url": "https://github.com/halo-dev/halo/commit/41bb33d69eb56b08bf6509049147d961634ac45a", "message": "Add a space before '{'", "committedDate": "2020-05-03T14:22:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MDkxNg==", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419190916", "bodyText": "\u8bf7\u81ea\u5b9a\u4e49 Param \u66ff\u4ee3 Map\u3002", "author": "JohnNiang", "createdAt": "2020-05-04T02:10:22Z", "path": "src/main/java/run/halo/app/controller/admin/api/StaticStorageController.java", "diffHunk": "@@ -49,4 +50,17 @@ public void upload(String basePath,\n                        @RequestPart(\"file\") MultipartFile file) {\n         staticStorageService.upload(basePath, file);\n     }\n+\n+    @PostMapping(\"rename\")\n+    @ApiOperation(\"Renames static file\")\n+    public void rename(String basePath,\n+                       String newName) {\n+        staticStorageService.rename(basePath, newName);\n+    }\n+\n+    @PutMapping(\"save\")\n+    @ApiOperation(\"Save static file\")\n+    public void save(@RequestBody Map<String, String> data) {", "originalCommit": "41bb33d69eb56b08bf6509049147d961634ac45a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTIwNDY4OA==", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419204688", "bodyText": "\u4ffa\u4e5f\u662f\uff01", "author": "ruibaby", "createdAt": "2020-05-04T03:57:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MDkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MTE1MA==", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419191150", "bodyText": "\u8fd9\u91cc\u5efa\u8bae\u66f4\u6539\u4e3a\uff1a@PostMapping(\"files\")", "author": "JohnNiang", "createdAt": "2020-05-04T02:12:25Z", "path": "src/main/java/run/halo/app/controller/admin/api/StaticStorageController.java", "diffHunk": "@@ -49,4 +50,17 @@ public void upload(String basePath,\n                        @RequestPart(\"file\") MultipartFile file) {\n         staticStorageService.upload(basePath, file);\n     }\n+\n+    @PostMapping(\"rename\")\n+    @ApiOperation(\"Renames static file\")\n+    public void rename(String basePath,\n+                       String newName) {\n+        staticStorageService.rename(basePath, newName);\n+    }\n+\n+    @PutMapping(\"save\")", "originalCommit": "41bb33d69eb56b08bf6509049147d961634ac45a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5NDYzMw==", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419194633", "bodyText": "\u8fd9\u8fb9\u6211\u53c2\u8003\u7684\u662fThemeController.java\u7684updateContentBy\u65b9\u6cd5\uff0c\u7528\u7684\u662fPUT\u8bf7\u6c42", "author": "Arexh", "createdAt": "2020-05-04T02:40:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MTE1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5NTE0MQ==", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419195141", "bodyText": "Okay", "author": "JohnNiang", "createdAt": "2020-05-04T02:44:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MTE1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MTI1Ng==", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419191256", "bodyText": "\u5199\u5165\u524d\u662f\u5426\u9700\u8981\u68c0\u67e5\u4e00\u4e0b\u8be5\u6587\u4ef6\u662f\u5426\u5b58\u5728\u5462\uff1f", "author": "JohnNiang", "createdAt": "2020-05-04T02:13:37Z", "path": "src/main/java/run/halo/app/service/impl/StaticStorageServiceImpl.java", "diffHunk": "@@ -167,6 +166,42 @@ public void upload(String basePath, MultipartFile file) {\n         }\n     }\n \n+    @Override\n+    public void rename(String basePath, String newName) {\n+        Assert.notNull(basePath, \"Base path must not be null\");\n+        Assert.notNull(newName, \"New name must not be null\");\n+\n+        Path pathToRename;\n+\n+        if (StringUtils.startsWith(newName, API_FOLDER_NAME)) {\n+            throw new FileOperationException(\"\u91cd\u547d\u540d\u540d\u79f0 \" + newName + \" \u4e0d\u5408\u6cd5\");\n+        }\n+\n+        pathToRename = Paths.get(staticDir.toString(), basePath);\n+\n+        try {\n+            FileUtils.rename(pathToRename, newName);\n+            onChange();\n+        } catch (FileAlreadyExistsException e) {\n+            throw new FileOperationException(\"\u8be5\u8def\u5f84\u4e0b\u540d\u79f0 \" + newName + \" \u5df2\u5b58\u5728\");\n+        } catch (IOException e) {\n+            throw new FileOperationException(\"\u91cd\u547d\u540d \" + pathToRename.toString() + \" \u5931\u8d25\");\n+        }\n+    }\n+\n+    @Override\n+    public void save(String basePath, String content) {\n+        Assert.notNull(basePath, \"Base path must not be null\");\n+\n+        Path path = Paths.get(staticDir.toString(), basePath);\n+\n+        try {\n+            Files.write(path, content.getBytes(StandardCharsets.UTF_8));", "originalCommit": "41bb33d69eb56b08bf6509049147d961634ac45a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MTMyNQ==", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419191325", "bodyText": "\u8fd9\u91cc\u662f\u5426\u5b58\u5728 Directory traversal \u98ce\u9669\u5462\uff1f", "author": "JohnNiang", "createdAt": "2020-05-04T02:14:06Z", "path": "src/main/java/run/halo/app/service/impl/StaticStorageServiceImpl.java", "diffHunk": "@@ -167,6 +166,42 @@ public void upload(String basePath, MultipartFile file) {\n         }\n     }\n \n+    @Override\n+    public void rename(String basePath, String newName) {\n+        Assert.notNull(basePath, \"Base path must not be null\");\n+        Assert.notNull(newName, \"New name must not be null\");\n+\n+        Path pathToRename;\n+\n+        if (StringUtils.startsWith(newName, API_FOLDER_NAME)) {\n+            throw new FileOperationException(\"\u91cd\u547d\u540d\u540d\u79f0 \" + newName + \" \u4e0d\u5408\u6cd5\");\n+        }\n+\n+        pathToRename = Paths.get(staticDir.toString(), basePath);\n+\n+        try {\n+            FileUtils.rename(pathToRename, newName);\n+            onChange();\n+        } catch (FileAlreadyExistsException e) {\n+            throw new FileOperationException(\"\u8be5\u8def\u5f84\u4e0b\u540d\u79f0 \" + newName + \" \u5df2\u5b58\u5728\");\n+        } catch (IOException e) {\n+            throw new FileOperationException(\"\u91cd\u547d\u540d \" + pathToRename.toString() + \" \u5931\u8d25\");\n+        }\n+    }\n+\n+    @Override\n+    public void save(String basePath, String content) {\n+        Assert.notNull(basePath, \"Base path must not be null\");\n+\n+        Path path = Paths.get(staticDir.toString(), basePath);", "originalCommit": "41bb33d69eb56b08bf6509049147d961634ac45a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE5MTQ0OA==", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419191448", "bodyText": "\u53ef\u4ee5\u7701\u7565 toString() \u65b9\u6cd5\uff0c\u8fd9\u6837\u8fd8\u53ef\u80fd\u4f1a\u9020\u6210 NPE\u3002", "author": "JohnNiang", "createdAt": "2020-05-04T02:15:10Z", "path": "src/main/java/run/halo/app/utils/FileUtils.java", "diffHunk": "@@ -77,6 +77,24 @@ public static void deleteFolder(@NonNull Path deletingPath) throws IOException {\n         log.info(\"Deleted [{}] successfully\", deletingPath);\n     }\n \n+    /**\n+     * Renames file or folder.\n+     *\n+     * @param pathToRename file path to rename must not be null\n+     * @param newName new name must not be null\n+     */\n+    public static void rename(@NonNull Path pathToRename, @NonNull String newName) throws IOException {\n+        Assert.notNull(pathToRename, \"File path to rename must not be null\");\n+        Assert.notNull(newName, \"New name must not be null\");\n+\n+        Path newPath = pathToRename.resolveSibling(newName);\n+        log.info(\"Rename [{}] to [{}]\", pathToRename.toString(), newPath.toString());", "originalCommit": "41bb33d69eb56b08bf6509049147d961634ac45a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cca4e83b241748108f7325044aada8d22082d22f", "url": "https://github.com/halo-dev/halo/commit/cca4e83b241748108f7325044aada8d22082d22f", "message": "Add a Param and some invalid checks", "committedDate": "2020-05-04T04:02:32Z", "type": "commit"}, {"oid": "8a1423301af0e987944a93485fc42dcf13a30c97", "url": "https://github.com/halo-dev/halo/commit/8a1423301af0e987944a93485fc42dcf13a30c97", "message": "Change comments", "committedDate": "2020-05-04T04:15:16Z", "type": "commit"}, {"oid": "06dc9556b7d17d6c112803640e16ab45eaf49b99", "url": "https://github.com/halo-dev/halo/commit/06dc9556b7d17d6c112803640e16ab45eaf49b99", "message": "Change test annotation", "committedDate": "2020-05-04T05:21:14Z", "type": "commit"}, {"oid": "1bb3c0184b621b670ac9ed90b246cae5f6485719", "url": "https://github.com/halo-dev/halo/commit/1bb3c0184b621b670ac9ed90b246cae5f6485719", "message": "Delete impl test unit", "committedDate": "2020-05-04T05:25:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTY2NA==", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419825664", "bodyText": "\u5efa\u8bae\u7528 run.halo.app.utils.FileUtils#checkDirectoryTraversal(String, String) \u6765\u68c0\u67e5\u8def\u5f84\u662f\u5426\u5408\u6cd5\u3002", "author": "JohnNiang", "createdAt": "2020-05-05T01:54:37Z", "path": "src/main/java/run/halo/app/service/impl/StaticStorageServiceImpl.java", "diffHunk": "@@ -167,6 +166,50 @@ public void upload(String basePath, MultipartFile file) {\n         }\n     }\n \n+    @Override\n+    public void rename(String basePath, String newName) {\n+        Assert.notNull(basePath, \"Base path must not be null\");\n+        Assert.notNull(newName, \"New name must not be null\");\n+\n+        Path pathToRename;\n+\n+        if (StringUtils.startsWith(newName, API_FOLDER_NAME)) {\n+            throw new FileOperationException(\"\u91cd\u547d\u540d\u540d\u79f0 \" + newName + \" \u4e0d\u5408\u6cd5\");\n+        }\n+\n+        pathToRename = Paths.get(staticDir.toString(), basePath);", "originalCommit": "1bb3c0184b621b670ac9ed90b246cae5f6485719", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg3MzE1Nw==", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419873157", "bodyText": "\u5df2\u6539\uff0c\u53e6\u5916\u6211\u53d1\u73b0StaticStorageServiceImpl.java\u7684delete, createFolder, upload\u4e5f\u6709\u540c\u6837\u7684\u95ee\u9898\uff0c\u76ee\u524d\u5747\u5df2\u4fee\u6539\u5e76\u901a\u8fc7\u7f51\u7edc\u8bf7\u6c42\u7684\u6d4b\u8bd5", "author": "Arexh", "createdAt": "2020-05-05T05:37:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTY2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTk1Mg==", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419825952", "bodyText": "\u4e5f\u8bb8\u5e94\u8be5\u518d\u589e\u52a0\u4e00\u4e2a\u5173\u4e8e directory traversal \u7684\u6d4b\u8bd5\u3002", "author": "JohnNiang", "createdAt": "2020-05-05T01:56:08Z", "path": "src/test/java/run/halo/app/utils/FileUtilsTest.java", "diffHunk": "@@ -108,4 +109,90 @@ public void dbFileReadTest() throws IOException {\n             log.debug(\"Buffer String: [{}]\", bufString);\n         }\n     }\n+", "originalCommit": "1bb3c0184b621b670ac9ed90b246cae5f6485719", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg3NDA0OQ==", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r419874049", "bodyText": "Impl\u7684\u6d4b\u8bd5\u5355\u5143\u8981\u600e\u4e48\u5199\uff1f\u4e0a\u6b21\u6211\u63d0\u4ea4\u4e86\u4e00\u4e2a\u6d4b\u8bd5\uff0c\u7ed3\u679c\u5bfc\u81f4\u9694\u58c1\u7684\u6d4b\u8bd5\u6302\u4e86\uff0c\u4f30\u8ba1\u662f\u6ce8\u89e3\u5199\u7684\u4e0d\u5bf9\u3002\u53ef\u4ee5\u7ed9\u4e2aImplTest\u7684\u6837\u4f8b\u4ee3\u7801\u5417\uff1f", "author": "Arexh", "createdAt": "2020-05-05T05:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTk1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI3MjEzMg==", "url": "https://github.com/halo-dev/halo/pull/819#discussion_r420272132", "bodyText": "\u65e9\u4e0a\u7ed9\u4f60\u56de\u590d\u3002", "author": "JohnNiang", "createdAt": "2020-05-05T17:11:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTgyNTk1Mg=="}], "type": "inlineReview"}, {"oid": "b1175fabcab94221bf657ddc6fc6fc73edd34fcf", "url": "https://github.com/halo-dev/halo/commit/b1175fabcab94221bf657ddc6fc6fc73edd34fcf", "message": "Add directory traversal check for static file operations", "committedDate": "2020-05-05T05:27:02Z", "type": "commit"}]}