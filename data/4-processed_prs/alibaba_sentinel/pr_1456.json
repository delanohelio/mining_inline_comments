{"pr_number": 1456, "pr_title": "Add OkHttp integration", "pr_createdAt": "2020-05-06T09:51:23Z", "pr_url": "https://github.com/alibaba/Sentinel/pull/1456", "timeline": [{"oid": "80f85eeaab9d815e3b4230dada5507e91e65f485", "url": "https://github.com/alibaba/Sentinel/commit/80f85eeaab9d815e3b4230dada5507e91e65f485", "message": "okhttp", "committedDate": "2020-05-06T09:49:57Z", "type": "commit"}, {"oid": "7476ca2b148aa712e75bb42b7c3bebc6551da8e2", "url": "https://github.com/alibaba/Sentinel/commit/7476ca2b148aa712e75bb42b7c3bebc6551da8e2", "message": "fix", "committedDate": "2020-05-06T10:00:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg2NzMxNg==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r420867316", "bodyText": "Make it provided?", "author": "sczyh30", "createdAt": "2020-05-06T15:07:30Z", "path": "sentinel-adapter/sentinel-okhttp-adapter/pom.xml", "diffHunk": "@@ -0,0 +1,69 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+<parent>\n+    <artifactId>sentinel-adapter</artifactId>\n+    <groupId>com.alibaba.csp</groupId>\n+    <version>1.8.0-SNAPSHOT</version>\n+</parent>\n+<modelVersion>4.0.0</modelVersion>\n+\n+<artifactId>sentinel-okhttp-adapter</artifactId>\n+<packaging>jar</packaging>\n+\n+<properties>\n+    <java.source.version>1.8</java.source.version>\n+    <java.target.version>1.8</java.target.version>\n+    <okhttp.version>3.6.0</okhttp.version>\n+    <spring.boot.version>2.1.3.RELEASE</spring.boot.version>\n+    <spring-test.version>5.1.5.RELEASE</spring-test.version>\n+</properties>\n+\n+<dependencies>\n+    <dependency>\n+        <groupId>com.alibaba.csp</groupId>\n+        <artifactId>sentinel-core</artifactId>\n+    </dependency>\n+\n+    <dependency>\n+        <groupId>com.squareup.okhttp3</groupId>\n+        <artifactId>okhttp</artifactId>\n+        <version>${okhttp.version}</version>\n+    </dependency>", "originalCommit": "7476ca2b148aa712e75bb42b7c3bebc6551da8e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE4NzQ4Mw==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421187483", "bodyText": "fixed", "author": "zhaoyuguang", "createdAt": "2020-05-07T01:32:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg2NzMxNg=="}], "type": "inlineReview"}, {"oid": "1b1b482547d98ef8e5e9e71b5076cc0d1193f55e", "url": "https://github.com/alibaba/Sentinel/commit/1b1b482547d98ef8e5e9e71b5076cc0d1193f55e", "message": "fix", "committedDate": "2020-05-07T01:32:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE5NjQ4MQ==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421196481", "bodyText": "Does OkHttp require JDK 1.8 or later? If not, we could set it to 1.7.", "author": "sczyh30", "createdAt": "2020-05-07T02:05:22Z", "path": "sentinel-adapter/sentinel-okhttp-adapter/pom.xml", "diffHunk": "@@ -0,0 +1,70 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+<parent>\n+    <artifactId>sentinel-adapter</artifactId>\n+    <groupId>com.alibaba.csp</groupId>\n+    <version>1.8.0-SNAPSHOT</version>\n+</parent>\n+<modelVersion>4.0.0</modelVersion>\n+\n+<artifactId>sentinel-okhttp-adapter</artifactId>\n+<packaging>jar</packaging>\n+\n+<properties>\n+    <java.source.version>1.8</java.source.version>", "originalCommit": "1b1b482547d98ef8e5e9e71b5076cc0d1193f55e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIyNjA5Mw==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421226093", "bodyText": "\u5df2\u5220\u9664\u5462", "author": "zhaoyuguang", "createdAt": "2020-05-07T04:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE5NjQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE5Njc1MA==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421196750", "bodyText": "How about OkHttpResourceExtractor or other better?", "author": "sczyh30", "createdAt": "2020-05-07T02:06:29Z", "path": "sentinel-adapter/sentinel-okhttp-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/okhttp/cleaner/OkHttpUrlCleaner.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.alibaba.csp.sentinel.adapter.okhttp.cleaner;\n+\n+import okhttp3.Connection;\n+import okhttp3.Request;\n+\n+/**\n+ * @author zhaoyuguang\n+ */\n+\n+public interface OkHttpUrlCleaner {", "originalCommit": "1b1b482547d98ef8e5e9e71b5076cc0d1193f55e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIyNjIwMQ==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421226201", "bodyText": "\u662f\u7684\uff0cclass name\u548cmethod\u540d\u79f0\u4fee\u6539\u4e86", "author": "zhaoyuguang", "createdAt": "2020-05-07T04:03:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE5Njc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE5NzIxMw==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421197213", "bodyText": "How about carrying HTTP method prefix in the resource name? And it could be better if users could add customized prefix here (e.g. okhttp:xxx).", "author": "sczyh30", "createdAt": "2020-05-07T02:08:10Z", "path": "sentinel-adapter/sentinel-okhttp-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/okhttp/cleaner/DefaultOkHttpUrlCleaner.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.alibaba.csp.sentinel.adapter.okhttp.cleaner;\n+\n+import okhttp3.Connection;\n+import okhttp3.Request;\n+\n+/**\n+ * @author zhaoyuguang\n+ */\n+\n+public class DefaultOkHttpUrlCleaner implements OkHttpUrlCleaner {\n+\n+    @Override\n+    public String clean(Request request, Connection connection) {\n+        return request.url().toString();", "originalCommit": "1b1b482547d98ef8e5e9e71b5076cc0d1193f55e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIyNjYyNA==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421226624", "bodyText": "\u6069 \u9ed8\u8ba4\u7684DefaultOkHttpResourceExtractor \u589e\u52a0\u4e86HTTP METHOD+\":\"\u7684\u8bb0\u5f55\uff0c\u4e14\u589e\u52a0\u4e86 config\u91cc\u9762\u7684prefix\u5c5e\u6027 \u9ed8\u8ba4\"\"", "author": "zhaoyuguang", "createdAt": "2020-05-07T04:05:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE5NzIxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE5NzM5OA==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421197398", "bodyText": "Remove the redundant blank line?", "author": "sczyh30", "createdAt": "2020-05-07T02:08:50Z", "path": "sentinel-adapter/sentinel-okhttp-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/okhttp/SentinelOkHttpInterceptor.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.alibaba.csp.sentinel.adapter.okhttp;\n+\n+import com.alibaba.csp.sentinel.*;\n+import com.alibaba.csp.sentinel.adapter.okhttp.config.SentinelOkHttpConfig;\n+import com.alibaba.csp.sentinel.slots.block.BlockException;\n+import okhttp3.Interceptor;\n+import okhttp3.Response;\n+\n+import java.io.IOException;\n+\n+/**\n+ * @author zhaoyuguang\n+ */\n+", "originalCommit": "1b1b482547d98ef8e5e9e71b5076cc0d1193f55e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIyNjc0MA==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421226740", "bodyText": "fixed", "author": "zhaoyuguang", "createdAt": "2020-05-07T04:05:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE5NzM5OA=="}], "type": "inlineReview"}, {"oid": "593ba141e74f2da3eed1678933b0297c1820201f", "url": "https://github.com/alibaba/Sentinel/commit/593ba141e74f2da3eed1678933b0297c1820201f", "message": "fix", "committedDate": "2020-05-07T03:15:46Z", "type": "commit"}, {"oid": "708c614695f56b61082f4c3088de5ac86ae63f9a", "url": "https://github.com/alibaba/Sentinel/commit/708c614695f56b61082f4c3088de5ac86ae63f9a", "message": "fix md", "committedDate": "2020-05-07T03:22:04Z", "type": "commit"}, {"oid": "219e65c74d7952764854e56606a595595ce3d23b", "url": "https://github.com/alibaba/Sentinel/commit/219e65c74d7952764854e56606a595595ce3d23b", "message": "fix", "committedDate": "2020-05-07T03:27:45Z", "type": "commit"}, {"oid": "b1a9fbca9a27f4b21330e60770899f3f68401161", "url": "https://github.com/alibaba/Sentinel/commit/b1a9fbca9a27f4b21330e60770899f3f68401161", "message": "fix ci", "committedDate": "2020-05-07T03:32:00Z", "type": "commit"}, {"oid": "cde6958d031df41a65b7ae8ecfe422911dbc0006", "url": "https://github.com/alibaba/Sentinel/commit/cde6958d031df41a65b7ae8ecfe422911dbc0006", "message": "fix", "committedDate": "2020-05-07T03:37:17Z", "type": "commit"}, {"oid": "e9d8825209e2a83c4ab64bdcc51fc3511585817b", "url": "https://github.com/alibaba/Sentinel/commit/e9d8825209e2a83c4ab64bdcc51fc3511585817b", "message": "fix", "committedDate": "2020-05-07T03:49:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM4NzM3MQ==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421387371", "bodyText": "#Line38  check not null for prefix not extractor.\n#Line47 OkHttpResourceExtractor, extractor and cleaner seems not very uniform, but it's OK : )\n@see SentinelOkHttpConfigTest#testConfigSetPrefix.", "author": "cdfive", "createdAt": "2020-05-07T10:01:07Z", "path": "sentinel-adapter/sentinel-okhttp-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/okhttp/config/SentinelOkHttpConfig.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.alibaba.csp.sentinel.adapter.okhttp.config;\n+\n+import com.alibaba.csp.sentinel.adapter.okhttp.cleaner.DefaultOkHttpResourceExtractor;\n+import com.alibaba.csp.sentinel.adapter.okhttp.cleaner.OkHttpResourceExtractor;\n+import com.alibaba.csp.sentinel.adapter.okhttp.fallback.DefaultOkHttpFallback;\n+import com.alibaba.csp.sentinel.adapter.okhttp.fallback.OkHttpFallback;\n+import com.alibaba.csp.sentinel.util.AssertUtil;\n+\n+/**\n+ * @author zhaoyuguang\n+ */\n+public final class SentinelOkHttpConfig {\n+\n+    private static volatile String prefix = \"\";\n+    private static volatile OkHttpResourceExtractor extractor = new DefaultOkHttpResourceExtractor();\n+    private static volatile OkHttpFallback fallback = new DefaultOkHttpFallback();\n+\n+    public static String getPrefix() {\n+        return prefix;\n+    }\n+\n+    public static void setPrefix(String prefix) {\n+        AssertUtil.notNull(extractor, \"prefix cannot be null\");\n+        SentinelOkHttpConfig.prefix = prefix;\n+    }\n+\n+    public static OkHttpResourceExtractor getExtractor() {\n+        return extractor;\n+    }\n+\n+    public static void setExtractor(OkHttpResourceExtractor extractor) {\n+        AssertUtil.notNull(extractor, \"cleaner cannot be null\");\n+        SentinelOkHttpConfig.extractor = extractor;\n+    }", "originalCommit": "e9d8825209e2a83c4ab64bdcc51fc3511585817b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM5OTk5MQ==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421399991", "bodyText": "code & testcase \u4fee\u590d\u4e86\uff0c \u5199\u6b63\u89c4\u4ee5\u514d\u6709\u6b67\u4e49", "author": "zhaoyuguang", "createdAt": "2020-05-07T10:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM4NzM3MQ=="}], "type": "inlineReview"}, {"oid": "182273a17d75a7bc064f87e82758a17edd8d730a", "url": "https://github.com/alibaba/Sentinel/commit/182273a17d75a7bc064f87e82758a17edd8d730a", "message": "fix", "committedDate": "2020-05-07T10:22:11Z", "type": "commit"}, {"oid": "111bf62fede0a17ee051776ebcbd2f55337e38a9", "url": "https://github.com/alibaba/Sentinel/commit/111bf62fede0a17ee051776ebcbd2f55337e38a9", "message": "fix", "committedDate": "2020-05-07T10:22:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQwMTIzNw==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421401237", "bodyText": "Spring is used for only unit test,  here whether it can be removed?", "author": "cdfive", "createdAt": "2020-05-07T10:25:59Z", "path": "sentinel-adapter/sentinel-okhttp-adapter/README.md", "diffHunk": "@@ -0,0 +1,63 @@\n+# Sentinel Spring OkHttp Adapter", "originalCommit": "e9d8825209e2a83c4ab64bdcc51fc3511585817b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQwMjU2OA==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421402568", "bodyText": "copy \u522b\u7684 readme \u5fd8\u8bb0\u5220\u4e86", "author": "zhaoyuguang", "createdAt": "2020-05-07T10:28:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQwMTIzNw=="}], "type": "inlineReview"}, {"oid": "ad223bb59a2ef442445174f0447e8cc68401cbfb", "url": "https://github.com/alibaba/Sentinel/commit/ad223bb59a2ef442445174f0447e8cc68401cbfb", "message": "fix", "committedDate": "2020-05-07T10:27:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQwMzA1OQ==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421403059", "bodyText": "It's better to indent here, make the format good looking.", "author": "cdfive", "createdAt": "2020-05-07T10:29:27Z", "path": "sentinel-adapter/sentinel-okhttp-adapter/pom.xml", "diffHunk": "@@ -0,0 +1,68 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+<parent>\n+    <artifactId>sentinel-adapter</artifactId>\n+    <groupId>com.alibaba.csp</groupId>\n+    <version>1.8.0-SNAPSHOT</version>\n+</parent>\n+<modelVersion>4.0.0</modelVersion>\n+\n+<artifactId>sentinel-okhttp-adapter</artifactId>\n+<packaging>jar</packaging>\n+\n+<properties>\n+    <okhttp.version>3.6.0</okhttp.version>\n+    <spring.boot.version>2.1.3.RELEASE</spring.boot.version>\n+    <spring-test.version>5.1.5.RELEASE</spring-test.version>\n+</properties>\n+\n+<dependencies>\n+    <dependency>\n+        <groupId>com.alibaba.csp</groupId>\n+        <artifactId>sentinel-core</artifactId>\n+    </dependency>\n+\n+    <dependency>\n+        <groupId>com.squareup.okhttp3</groupId>\n+        <artifactId>okhttp</artifactId>\n+        <version>${okhttp.version}</version>\n+        <scope>provided</scope>\n+    </dependency>\n+\n+    <dependency>\n+        <groupId>junit</groupId>\n+        <artifactId>junit</artifactId>\n+        <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+        <groupId>org.mockito</groupId>\n+        <artifactId>mockito-core</artifactId>\n+        <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+        <groupId>com.alibaba</groupId>\n+        <artifactId>fastjson</artifactId>\n+        <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+        <groupId>org.springframework.boot</groupId>\n+        <artifactId>spring-boot-starter-web</artifactId>\n+        <version>${spring.boot.version}</version>\n+        <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+        <groupId>org.springframework.boot</groupId>\n+        <artifactId>spring-boot-test</artifactId>\n+        <version>${spring.boot.version}</version>\n+        <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+        <groupId>org.springframework</groupId>\n+        <artifactId>spring-test</artifactId>\n+        <version>${spring-test.version}</version>\n+        <scope>test</scope>\n+    </dependency>\n+</dependencies>\n+</project>", "originalCommit": "e9d8825209e2a83c4ab64bdcc51fc3511585817b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQxOTk3Nw==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421419977", "bodyText": "fixed", "author": "zhaoyuguang", "createdAt": "2020-05-07T11:02:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQwMzA1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQwMzY3OQ==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421403679", "bodyText": "1999-2020 is better, since time goes by.", "author": "cdfive", "createdAt": "2020-05-07T10:30:32Z", "path": "sentinel-adapter/sentinel-okhttp-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/okhttp/SentinelOkHttpInterceptor.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 1999-2018 Alibaba Group Holding Ltd.", "originalCommit": "e9d8825209e2a83c4ab64bdcc51fc3511585817b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQyMDE4Nw==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421420187", "bodyText": "\u6069 \u6682\u4e14\u5427\u672c\u63d0\u4ea4\u6d89\u53ca\u7684\u6539\u4e86", "author": "zhaoyuguang", "createdAt": "2020-05-07T11:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQwMzY3OQ=="}], "type": "inlineReview"}, {"oid": "108184a3d24b9ac375f208d695d023891f92f0c4", "url": "https://github.com/alibaba/Sentinel/commit/108184a3d24b9ac375f208d695d023891f92f0c4", "message": "fix", "committedDate": "2020-05-07T11:00:16Z", "type": "commit"}, {"oid": "6ab51b96a15d81577fb9834d089e0d808b67f1ab", "url": "https://github.com/alibaba/Sentinel/commit/6ab51b96a15d81577fb9834d089e0d808b67f1ab", "message": "Update pom.xml", "committedDate": "2020-05-07T11:01:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzODUxNw==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421938517", "bodyText": "This can be omitted in demo, since sentinel-okhttp-adapter has the dependency. Adding it is all right, but new user will feel uncertain if this is is must when he use this adapter.", "author": "cdfive", "createdAt": "2020-05-08T04:59:43Z", "path": "sentinel-demo/sentinel-demo-okhttp/pom.xml", "diffHunk": "@@ -0,0 +1,49 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>sentinel-demo</artifactId>\n+        <groupId>com.alibaba.csp</groupId>\n+        <version>1.8.0-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>sentinel-demo-okhttp</artifactId>\n+\n+    <properties>\n+        <spring.boot.version>2.1.3.RELEASE</spring.boot.version>\n+        <okhttp.version>3.6.0</okhttp.version>\n+    </properties>\n+\n+    <dependencies>\n+        <dependency>\n+            <groupId>com.alibaba.csp</groupId>\n+            <artifactId>sentinel-core</artifactId>\n+        </dependency>", "originalCommit": "6ab51b96a15d81577fb9834d089e0d808b67f1ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk1MDIxMA==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421950210", "bodyText": "\u6069 \u4fee\u590d\u4e86 \u4e4b\u524d\u8fd8\u5947\u602a idea\u4e3a\u5565\u62a5\u8b66\u544a\u5462\n\n\u7a0d\u540e \u6211\u5728\u5176\u4ed6pr \u628a\u5176\u4ed6demo \u7c7b\u4f3c\u4e5f\u4e00\u8d77fix\u4e86", "author": "zhaoyuguang", "createdAt": "2020-05-08T05:43:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkzODUxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NDM3NA==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421944374", "bodyText": "How about also adding demo for post method?\nWhen I add a post controller for test:\n@PostMapping(\"/okhttp/post\")\npublic String post(HttpServletRequest request) throws Exception {\n    byte[] body = StreamUtils.copyToByteArray(request.getInputStream());\n    System.out.println(new String(body));\n    return \"post\";\n}\n\n@RequestMapping(\"/okhttp/testcase/post\")\npublic String testcasePost() throws Exception {\n    MediaType mediaType = MediaType.parse(\"application/json; charset=utf-8\");\n    String requestBody = \"{\\\"name\\\":\\\"cdfive\\\"}\";\n    OkHttpClient client = new OkHttpClient.Builder()\n            .addInterceptor(new SentinelOkHttpInterceptor())\n            .build();\n    Request request = new Request.Builder()\n            .url(\"http://localhost:\" + port + \"/okhttp/post\")\n            .post(RequestBody.create(mediaType, requestBody))\n            .build();\n    Response response = client.newCall(request).execute();\n    return response.body().string();\n}\nI find the resource name in dashboard are:\nhttp://localhost:8085/okhttp/back\nhttp://localhost:8085/okhttp/post\nThey have no GET or POST, and also no okhttp: prefix\nThis is due to the custom extrator in OkHttpDemoApplication class.\nMy point is whether the interface OkHttpResourceExtractor#extract(Request request, Connection connection)\ngranularity is too big? When user use their custom extrator, they can't be benefit from or reuse the logic of DefaultOkHttpResourceExtractor, which provide common prefix and method logic.\nThe UrlCleaner interface in sentinel-web-servlet module can be referred.\nUrlCleaner: String clean(String originUrl);\nand the CommonFilter append the http method prefix outside the clean method.\nNow, the advantage of DefaultOkHttpResourceExtractor is that it allows users to define resources completely when use their custom extrator.\nIt may need take info consideration compromise in design and decide which is better.\nHow about your option? @sczyh30 @zhaoyuguang", "author": "cdfive", "createdAt": "2020-05-08T05:22:00Z", "path": "sentinel-demo/sentinel-demo-okhttp/src/main/java/com/alibaba/csp/sentinel/demo/okhttp/controller/OkHttpTestController.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 1999-2020 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.alibaba.csp.sentinel.demo.okhttp.controller;\n+\n+import com.alibaba.csp.sentinel.adapter.okhttp.SentinelOkHttpInterceptor;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Request;\n+import okhttp3.Response;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.web.bind.annotation.PathVariable;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+import java.io.IOException;\n+\n+/**\n+ * @author zhaoyuguang\n+ */\n+@RestController\n+public class OkHttpTestController {\n+\n+    @Value(\"${server.port}\")\n+    private Integer port;\n+\n+    @RequestMapping(\"/okhttp/back\")\n+    public String back() {\n+        return \"Welcome Back!\";\n+    }\n+\n+    @RequestMapping(\"/okhttp/back/{id}\")\n+    public String back(@PathVariable String id) {\n+        return \"Welcome Back! \" + id;\n+    }\n+\n+    @RequestMapping(\"/okhttp/testcase/{id}\")\n+    public String testcase(@PathVariable String id) throws Exception {\n+        return getRemoteString(id);\n+    }\n+\n+    @RequestMapping(\"/okhttp/testcase\")\n+    public String testcase() throws Exception {\n+        return getRemoteString(null);\n+    }", "originalCommit": "6ab51b96a15d81577fb9834d089e0d808b67f1ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0ODk3OQ==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421948979", "bodyText": "\u6069 prefix\u9ed8\u8ba4\u662f\u7a7a\u7684\uff0cdemo\u4e2d \u81ea\u5b9a\u4e49\u63d0\u53d6\u5668\u5199\u7684\u7c97\u66b4\u4e00\u70b9\u5462\n        SentinelOkHttpConfig.setExtractor(new OkHttpResourceExtractor() {\n            @Override\n            public String extract(Request request, Connection connection) {\n                String url = request.url().toString();\n                String regex = \"/okhttp/back/\";\n                if (url.contains(regex)) {\n                    url = url.substring(0, url.indexOf(regex) + regex.length()) + \"{id}\";\n                }\n                return url;\n            }\n        });\n\u6211\u8fd8\u662f\u5efa\u8bae\u7ed9\u7528\u6237\u5f00\u653e \u7adf\u53ef\u80fd\u591a\u7684\u53c2\u6570\uff0cissue #1287 \u53cd\u5e94\u7684\u5c31\u50cf\u66f4\u9ad8\u9636\u7684\u5b9a\u4e49\u8d44\u6e90", "author": "zhaoyuguang", "createdAt": "2020-05-08T05:38:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NDM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk4NjQ0Nw==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421986447", "bodyText": "\u5f00\u653e\u66f4\u591a\u7684\u53c2\u6570\u6ca1\u95ee\u9898\uff0cprefix:method:url\uff0c\u53ea\u662fprefix:method\u770b\u8981\u4e0d\u8981\u56fa\u5b9a\uff0c\n\u6bd4\u5982\uff1a\nString extract(String target, Request request, Connection connection)\n\u6216\u8005 String extract(String url, Request request, Connection connection)\n\u8ba9\u6574\u4e2atarget\u6216\u8005url\u7528\u6237\u8fdb\u4e00\u6b65\u81ea\u5b9a\u4e49\u3002\n\u4e2a\u4eba\u89c9\u5f97\u73b0\u5728\u8fd9\u6837\u4e5f\u4e0d\u9519\uff0c\u7075\u6d3b\u6027\u6700\u5927\u3002\u53ea\u662f\u6b63\u597d\u60f3\u5230\u8fd9\u4e2a\u53c2\u8003\u4e0b\u54c8~", "author": "cdfive", "createdAt": "2020-05-08T07:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NDM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk5MTM4OQ==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r421991389", "bodyText": "target \u548c url \u662f\u54ea\u91cc\u6765\u7684\u5462\uff1f\u662fokhttp-adapter\u9ed8\u8ba4\u63d0\u53d6\u51fa\u6765\u7684 \u7136\u540e\u63d0\u4f9b\u7ed9\u7528\u6237\u4e48\uff1f", "author": "zhaoyuguang", "createdAt": "2020-05-08T07:32:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NDM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAzMzI4Ng==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r422033286", "bodyText": "@zhaoyuguang \u5927\u6982\u60f3\u5230\u8fd92\u4e2a\u601d\u8def\uff1a\n1.\u5148\u7528prefix:method:url\u5904\u7406\u597d\uff0c\u5047\u8bbe\u5904\u7406\u540e\u503c\u4e3atarget\uff0c\n\u7136\u540e\u901a\u8fc7\u63a5\u53e3String extract(String target, Request request, Connection connection)\u8ba9\u7528\u6237\u8fdb\u4e00\u6b65\u81ea\u5b9a\u4e49\u5904\u7406\uff0c\u9ed8\u8ba4\u8fd4\u56detarget\u3002\n2.\u5148\u5f97\u5230url\uff0c\n\u7136\u540e\u901a\u8fc7\u63a5\u53e3String extract(String url, Request request, Connection connection)\u8ba9\u7528\u6237\u81ea\u5b9a\u4e49\u5904\u7406\uff0c\u9ed8\u8ba4\u8fd4\u56deurl\uff0c\n\u6700\u540e\u5728\u524d\u9762\u52a0\u4e0aprefix:method:\u3002\n\u7b2c1\u79cd\u662f\u6574\u4f53\u7528\u524d\u7f00\u5904\u7406\u597d\uff0c\u7531\u7528\u6237\u8fdb\u4e00\u6b65\u5904\u7406\uff1b\n\u7b2c2\u79cd\u662f\u7528\u6237\u5904\u7406url\u540e\uff0c\u518d\u52a0\u524d\u7f00\uff1b\n\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff1a\u4e24\u79cd\u91cc\u9762\u7684prefix\u5982\u679c\u4e0d\u9700\u8981\u6216\u8005\u8981\u81ea\u5b9a\u4e49\u90fd\u53ef\u4ee5\u901a\u8fc7(SentinelOkHttpConfig#setPrefix)\u8bbe\u7f6e\uff1b\u4f46method\u76ee\u524d\u6682\u65f6\u4e0d\u884c\u3002\nweb-servlet\u6a21\u5757\u7684CommonFilter\u5c31\u662f\u7b2c2\u79cd\u65b9\u5f0f\u3002\n\u4e0a\u97622\u79cd\u5c31\u662f\u6709\u4e00\u5b9a\u7684\u89c4\u5219\u7ea6\u5b9a\uff0c\u5728\u6b64\u57fa\u7840\u4e0a\u81ea\u5b9a\u4e49\uff1b\n\u76ee\u524d\u7684\u65b9\u5f0f\u662f\u6700\u7075\u6d3b\uff0c\u5982\u679c\u7528\u6237\u81ea\u5b9a\u4e49\uff0c\u5219\u6574\u4e2a\u8d44\u6e90\u540d\u90fd\u81ea\u5b9a\u4e49\u3002\n@sczyh30 \u5bbf\u4f55\u7a7a\u4e86\u4e5f\u770b\u770b\u5462~", "author": "cdfive", "createdAt": "2020-05-08T09:05:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NDM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM1ODM4Mg==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r424358382", "bodyText": "\u8fd9\u91cc\u53eb ResourceExtractor \u7684\u539f\u56e0\u662f\u4e0d\u5e0c\u671b\u7ed9\u7528\u6237\u201c\u53ea\u80fd\u5c06 URL \u4f5c\u4e3a\u8d44\u6e90\u540d\u201d\u7684\u5370\u8c61\u3002\u5efa\u8bae prefix \u53ef\u4ee5\u653e\u5230 extractor \u5916\u8fb9\uff0c\u7136\u540e method:URL \u8fd9\u79cd \u5c31\u4f5c\u4e3a\u9ed8\u8ba4\u5b9e\u73b0\u597d\u4e86\uff0c\u7528\u6237\u6709\u9700\u8981 \u5c31\u81ea\u5b9a\u4e49\u3002", "author": "sczyh30", "createdAt": "2020-05-13T11:15:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NDM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwMzExOA==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r424903118", "bodyText": "\u4f7f\u7528\u4e86 \u7b2c\u4e8c\u79cd ResourceExtractor \u65b9\u6cd5\u662f\nString extract(String url, Request request, Connection connection);\nurl\u9ed8\u8ba4\u662fmethod:URL", "author": "zhaoyuguang", "createdAt": "2020-05-14T06:40:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NDM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwNzIyMw==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r424907223", "bodyText": "\u4f20\u5165\u7684 URL \u91cc\u9762\u5c31\u4e0d\u8981\u5e26 ${method}: \u4e86\uff0c\u53c2\u6570\u5c31\u6309\u7167 URL \u6765\u4f20\u5165\uff0c\u53ea\u4e0d\u8fc7 default extractor \u91cc\u9762\u7684\u5b9e\u73b0\u5e26\u4e0a\u8fd9\u4e2a method \u524d\u7f00\uff1b\u53e6\u5916\u603b\u7684\u90a3\u4e2a prefix \u5e26\u5230 interceptor \u91cc\u9762\u6765\u4f5c\u4e3a\u603b\u4f53\u63a7\u5236\u7684\uff0c\u5982\u679c\u6709\u914d\u5c31 append \u4e0a\u6765\u3002", "author": "sczyh30", "createdAt": "2020-05-14T06:50:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NDM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk2NTU5MA==", "url": "https://github.com/alibaba/Sentinel/pull/1456#discussion_r424965590", "bodyText": "Fixed \u62bd\u7a7a review\u4e0b", "author": "zhaoyuguang", "createdAt": "2020-05-14T08:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk0NDM3NA=="}], "type": "inlineReview"}, {"oid": "ed1209f5d6a8a53ce285014951b306f4caa094ac", "url": "https://github.com/alibaba/Sentinel/commit/ed1209f5d6a8a53ce285014951b306f4caa094ac", "message": "fix", "committedDate": "2020-05-08T05:41:04Z", "type": "commit"}, {"oid": "1e3b346ba613d38dd74d165a34d138a43f61726f", "url": "https://github.com/alibaba/Sentinel/commit/1e3b346ba613d38dd74d165a34d138a43f61726f", "message": "Merge branch 'zhaoyuguang_20' of https://github.com/zhaoyuguang/Sentinel into zhaoyuguang_20", "committedDate": "2020-05-08T05:41:16Z", "type": "commit"}, {"oid": "a5d7e02f6cf38d27c0b6bd9f7aef8d4889ad22eb", "url": "https://github.com/alibaba/Sentinel/commit/a5d7e02f6cf38d27c0b6bd9f7aef8d4889ad22eb", "message": "fix", "committedDate": "2020-05-14T06:36:49Z", "type": "commit"}, {"oid": "c144ac682df27727e14dfd42d00f65e234fe64e6", "url": "https://github.com/alibaba/Sentinel/commit/c144ac682df27727e14dfd42d00f65e234fe64e6", "message": "fix", "committedDate": "2020-05-14T08:29:48Z", "type": "commit"}]}