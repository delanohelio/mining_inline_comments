{"pr_number": 2567, "pr_title": "Fix reachability checks in the presence of @GenerateUncached.", "pr_createdAt": "2020-06-14T15:31:26Z", "pr_url": "https://github.com/oracle/graal/pull/2567", "timeline": [{"oid": "17a7b911fb330d4968b219b3936e0640f429ef4e", "url": "https://github.com/oracle/graal/commit/17a7b911fb330d4968b219b3936e0640f429ef4e", "message": "take uncached specializations into account for reachability analysis", "committedDate": "2020-06-11T23:51:51Z", "type": "commit"}, {"oid": "a2de7cf0854ce46fd91f9e87fd4be46fb212917b", "url": "https://github.com/oracle/graal/commit/a2de7cf0854ce46fd91f9e87fd4be46fb212917b", "message": "code format fix", "committedDate": "2020-06-14T15:21:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxMjcyNw==", "url": "https://github.com/oracle/graal/pull/2567#discussion_r441012727", "bodyText": "Maybe rename this field reachableUncached to makle it clearer what it means.\nA specialization is not uncached by itself.\nAt the same time it would make sense to rename SpecializationData#reachable to reachableCached.", "author": "chumer", "createdAt": "2020-06-16T17:13:57Z", "path": "truffle/src/com.oracle.truffle.dsl.processor/src/com/oracle/truffle/dsl/processor/model/SpecializationData.java", "diffHunk": "@@ -353,10 +355,18 @@ public void setReachable(boolean reachable) {\n         this.reachable = reachable;\n     }\n \n+    public void setUncached(boolean uncached) {", "originalCommit": "a2de7cf0854ce46fd91f9e87fd4be46fb212917b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyNDMxMw==", "url": "https://github.com/oracle/graal/pull/2567#discussion_r441024313", "bodyText": "This would be confusing. The isUncached field does not mean \"is it reachable in the uncached node?\", but rather \"is this specialization taken into account when generating the uncached node?\". It has nothing to do with actual reachability, just a helper field.\nI've only cached it here to avoid some map lookups, but honestly maybe we'd be better off just doing those lookups and not add more fields here?", "author": "kustosz", "createdAt": "2020-06-16T17:33:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxMjcyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyOTMxMg==", "url": "https://github.com/oracle/graal/pull/2567#discussion_r441029312", "bodyText": "You are right. Sorry for my confusion.", "author": "chumer", "createdAt": "2020-06-16T17:42:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxMjcyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxNDA2OQ==", "url": "https://github.com/oracle/graal/pull/2567#discussion_r441014069", "bodyText": "I think this could be merged into initializeReachability. It is fine if this one computes cached and uncached reachability.", "author": "chumer", "createdAt": "2020-06-16T17:16:18Z", "path": "truffle/src/com.oracle.truffle.dsl.processor/src/com/oracle/truffle/dsl/processor/parser/NodeParser.java", "diffHunk": "@@ -1748,6 +1749,13 @@ private void collectIncludes(SpecializationData specialization, Set<Specializati\n         }\n     }\n \n+    private static void initializeUncached(final NodeData node) {", "originalCommit": "a2de7cf0854ce46fd91f9e87fd4be46fb212917b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAyNDc0OA==", "url": "https://github.com/oracle/graal/pull/2567#discussion_r441024748", "bodyText": "Again, the intializeReachability methods computes both kinds of reachability. This one only initializes a helper field.", "author": "kustosz", "createdAt": "2020-06-16T17:34:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAxNDA2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1MjU1Mg==", "url": "https://github.com/oracle/graal/pull/2567#discussion_r441052552", "bodyText": "initializeUncached uses SpecializationData.getReplaces indirectly that gets initialized in resolveReplaces later.\nHow about we merge initializeUncached with resolveReplaces. And rename SpecializationData#uncached to Specialization#replaced. This probably needs to be a flattened set again in order to fix the failing test.", "author": "chumer", "createdAt": "2020-06-16T18:19:59Z", "path": "truffle/src/com.oracle.truffle.dsl.processor/src/com/oracle/truffle/dsl/processor/parser/NodeParser.java", "diffHunk": "@@ -1576,6 +1576,7 @@ private void initializeSpecializations(List<? extends Element> elements, final N\n         initializeUninitialized(node);\n         initializeOrder(node);\n         initializePolymorphism(node); // requires specializations\n+        initializeUncached(node);", "originalCommit": "a2de7cf0854ce46fd91f9e87fd4be46fb212917b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3NTM0OA==", "url": "https://github.com/oracle/graal/pull/2567#discussion_r441075348", "bodyText": "Done, indeed makes the code simpler :)", "author": "kustosz", "createdAt": "2020-06-16T18:58:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1MjU1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQxNzkwNw==", "url": "https://github.com/oracle/graal/pull/2567#discussion_r441417907", "bodyText": "Perfect. Thanks!", "author": "chumer", "createdAt": "2020-06-17T09:39:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1MjU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1MzU3OQ==", "url": "https://github.com/oracle/graal/pull/2567#discussion_r441053579", "bodyText": "Here is a failing test.\n\n @GenerateUncached\n    abstract static class ReachabilityUncached4 extends ReachabilityUncached {\n\n        @Specialization\n        int s0(@Cached(\"foo()\") int cached) {\n            return cached;\n        }\n\n        @Specialization(replaces = \"s0\")\n        int s1() {\n            return 1;\n        }\n\n        @Specialization(replaces = \"s1\")\n        int s2() {\n            return 1;\n        }\n    }\n\n\nI think that one should work too but doesn't.", "author": "chumer", "createdAt": "2020-06-16T18:21:06Z", "path": "truffle/src/com.oracle.truffle.api.dsl.test/src/com/oracle/truffle/api/dsl/test/ReachabilityTest.java", "diffHunk": "@@ -301,4 +304,62 @@ int do1() throws RuntimeException {\n \n     }\n \n+    abstract static class ReachabilityUncached extends Node {\n+        abstract int execute();\n+\n+        int foo() {\n+            return 0;\n+        }\n+    }\n+\n+    @GenerateUncached\n+    abstract static class ReachabilityUncached1 extends ReachabilityUncached {\n+        @Specialization\n+        int doCached(@Cached(\"foo()\") int cached) {\n+            return cached;\n+        }\n+\n+        @Specialization(replaces = \"doCached\")\n+        int doUncached() {\n+            return 1;\n+        }\n+    }\n+\n+    @GenerateUncached\n+    abstract static class ReachabilityUncached2 extends ReachabilityUncached {", "originalCommit": "a2de7cf0854ce46fd91f9e87fd4be46fb212917b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3NjMzNQ==", "url": "https://github.com/oracle/graal/pull/2567#discussion_r441076335", "bodyText": "I don't understand what's wrong with this example. It fails with Specialization is not reachable. It is shadowed by s0(int).. And that is true \u2013 s1 is replaced and as such is never a part of the uncached node. So normal rules apply here (as if @GenerateUncached was not present).", "author": "kustosz", "createdAt": "2020-06-16T19:00:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1MzU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQxNzc0NQ==", "url": "https://github.com/oracle/graal/pull/2567#discussion_r441417745", "bodyText": "You are right. I tried somehow to construct a case where the missing handling of transitivity was a problem. But it seems it never was.", "author": "chumer", "createdAt": "2020-06-17T09:39:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1MzU3OQ=="}], "type": "inlineReview"}, {"oid": "6b95aef79e4108b8604cc22269125d24a6017bc7", "url": "https://github.com/oracle/graal/commit/6b95aef79e4108b8604cc22269125d24a6017bc7", "message": "rename uncached to replaced, unify logic", "committedDate": "2020-06-16T18:57:50Z", "type": "commit"}]}