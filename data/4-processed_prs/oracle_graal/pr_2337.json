{"pr_number": 2337, "pr_title": "Allow building with OpenJDK 11u and vendor jlink plugins", "pr_createdAt": "2020-04-10T16:09:42Z", "pr_url": "https://github.com/oracle/graal/pull/2337", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA1Mzg0MQ==", "url": "https://github.com/oracle/graal/pull/2337#discussion_r407053841", "bodyText": "I don't think -XX:ThreadPriorityPolicy is related to -XX:+EnableJVMCIProduct is it?", "author": "dougxc", "createdAt": "2020-04-11T11:43:38Z", "path": "sdk/mx.sdk/mx_sdk_vm.py", "diffHunk": "@@ -649,19 +661,22 @@ def jlink_new_jdk(jdk, dst_jdk_dir, module_dists,\n         jlink.append('--keep-packaged-modules=' + join(dst_jdk_dir, 'jmods'))\n \n         if jdk_has_new_jlink_options(jdk):\n-            if jdk_omits_warning_for_jlink_set_ThreadPriorityPolicy(jdk):\n-                thread_priority_policy_option = ' -XX:ThreadPriorityPolicy=1'\n-            else:\n-                mx.logv('[Creating JDK without -XX:ThreadPriorityPolicy=1]')\n-                thread_priority_policy_option = ''\n-\n-            if any((m.name == 'jdk.internal.vm.compiler' for m in modules)):\n-                jlink.append('--add-options=-XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCIProduct -XX:-UnlockExperimentalVMOptions' + thread_priority_policy_option)\n+            if jdk_supports_enablejvmciproduct(jdk):", "originalCommit": "623e6733604ea8b364704fd1f1583721057cceaf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA1NDg3Nw==", "url": "https://github.com/oracle/graal/pull/2337#discussion_r408054877", "bodyText": "No, but isn't -XX:ThreadPriorityPolicy=1 intended for libgraal usage? If so, isn't EnableJVMCIProduct enabling libgraal. That was my thinking anyway. Happy to change that, though.", "author": "jerboaa", "createdAt": "2020-04-14T11:10:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA1Mzg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA2MjYxNQ==", "url": "https://github.com/oracle/graal/pull/2337#discussion_r408062615", "bodyText": "No, setting ThreadPriorityPolicy is independent of libgraal so that should be reflected here.", "author": "dougxc", "createdAt": "2020-04-14T11:25:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA1Mzg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA3MzQ5Ng==", "url": "https://github.com/oracle/graal/pull/2337#discussion_r408073496", "bodyText": "OK, thanks! Should be fixed now.", "author": "jerboaa", "createdAt": "2020-04-14T11:47:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA1Mzg0MQ=="}], "type": "inlineReview"}, {"oid": "5f3f57eec95587494c93744abbbf2c268e2042e4", "url": "https://github.com/oracle/graal/commit/5f3f57eec95587494c93744abbbf2c268e2042e4", "message": "Allow building with OpenJDK 11u and vendor plugins", "committedDate": "2020-04-14T11:46:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA4Mzk2MA==", "url": "https://github.com/oracle/graal/pull/2337#discussion_r408083960", "bodyText": "You need the following to make ThreadPriorityPolicy still be applied when EnableJVMCIProduct is not supported :\nif thread_priority_policy_option:\n    jlink.append('--add-options=' + thread_priority_policy_option.strip())", "author": "dougxc", "createdAt": "2020-04-14T12:07:01Z", "path": "sdk/mx.sdk/mx_sdk_vm.py", "diffHunk": "@@ -655,13 +667,16 @@ def jlink_new_jdk(jdk, dst_jdk_dir, module_dists,\n                 mx.logv('[Creating JDK without -XX:ThreadPriorityPolicy=1]')\n                 thread_priority_policy_option = ''\n \n-            if any((m.name == 'jdk.internal.vm.compiler' for m in modules)):\n-                jlink.append('--add-options=-XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCIProduct -XX:-UnlockExperimentalVMOptions' + thread_priority_policy_option)\n+            if jdk_supports_enablejvmciproduct(jdk):\n+                if any((m.name == 'jdk.internal.vm.compiler' for m in modules)):\n+                    jlink.append('--add-options=-XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCIProduct -XX:-UnlockExperimentalVMOptions' + thread_priority_policy_option)\n+                else:\n+                    # Don't default to using JVMCI as JIT unless Graal is being updated in the image.\n+                    # This avoids unexpected issues with using the out-of-date Graal compiler in\n+                    # the JDK itself.\n+                    jlink.append('--add-options=-XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCIProduct -XX:-UseJVMCICompiler -XX:-UnlockExperimentalVMOptions' + thread_priority_policy_option)\n             else:\n-                # Don't default to using JVMCI as JIT unless Graal is being updated in the image.\n-                # This avoids unexpected issues with using the out-of-date Graal compiler in\n-                # the JDK itself.\n-                jlink.append('--add-options=-XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCIProduct -XX:-UseJVMCICompiler -XX:-UnlockExperimentalVMOptions' + thread_priority_policy_option)\n+                mx.logv('[Creating JDK without -XX:+EnableJVMCIProduct]')", "originalCommit": "5f3f57eec95587494c93744abbbf2c268e2042e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEzMDc5NA==", "url": "https://github.com/oracle/graal/pull/2337#discussion_r408130794", "bodyText": "Right, sorry about that. Should be fixed now. More thoughts?", "author": "jerboaa", "createdAt": "2020-04-14T13:21:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA4Mzk2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEzMjk2OQ==", "url": "https://github.com/oracle/graal/pull/2337#discussion_r408132969", "bodyText": "looks good", "author": "dougxc", "createdAt": "2020-04-14T13:24:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA4Mzk2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzNDc0Mw==", "url": "https://github.com/oracle/graal/pull/2337#discussion_r408234743", "bodyText": "Thanks very much for the review, Doug!", "author": "jerboaa", "createdAt": "2020-04-14T15:36:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA4Mzk2MA=="}], "type": "inlineReview"}, {"oid": "5b5486779de863c5b153408b8cf923436f75c6e4", "url": "https://github.com/oracle/graal/commit/5b5486779de863c5b153408b8cf923436f75c6e4", "message": "Allow building with OpenJDK 11u and vendor plugins", "committedDate": "2020-04-14T13:20:25Z", "type": "commit"}, {"oid": "5b5486779de863c5b153408b8cf923436f75c6e4", "url": "https://github.com/oracle/graal/commit/5b5486779de863c5b153408b8cf923436f75c6e4", "message": "Allow building with OpenJDK 11u and vendor plugins", "committedDate": "2020-04-14T13:20:25Z", "type": "forcePushed"}]}