{"pr_number": 2459, "pr_title": "Debug info test", "pr_createdAt": "2020-05-14T14:51:24Z", "pr_url": "https://github.com/oracle/graal/pull/2459", "timeline": [{"oid": "30f558658563ffe58df42a92883690a32065142e", "url": "https://github.com/oracle/graal/commit/30f558658563ffe58df42a92883690a32065142e", "message": "script error", "committedDate": "2020-05-17T21:41:00Z", "type": "forcePushed"}, {"oid": "df530554538a5cd0db8ebc2aab4c0514f027c027", "url": "https://github.com/oracle/graal/commit/df530554538a5cd0db8ebc2aab4c0514f027c027", "message": "use format", "committedDate": "2020-05-18T08:02:46Z", "type": "forcePushed"}, {"oid": "04e247c940c0552bf4739d1cd049d55679021371", "url": "https://github.com/oracle/graal/commit/04e247c940c0552bf4739d1cd049d55679021371", "message": "correct info rexp to cater for variant output", "committedDate": "2020-05-19T20:30:26Z", "type": "forcePushed"}, {"oid": "4152d5cc64a1e2718f2e074d6953a40077882f95", "url": "https://github.com/oracle/graal/commit/4152d5cc64a1e2718f2e074d6953a40077882f95", "message": "locate jdk src.zip correctly on 1.8", "committedDate": "2020-05-20T09:00:18Z", "type": "commit"}, {"oid": "c599e19d72cd9abaf246d4dbcb9337af30ed7935", "url": "https://github.com/oracle/graal/commit/c599e19d72cd9abaf246d4dbcb9337af30ed7935", "message": "add DebugInfoSourceCacheRoot option to allow debug sources cache location to be specified", "committedDate": "2020-05-20T09:01:21Z", "type": "commit"}, {"oid": "a21f51aef1705ea06ec50aeb126f67851abafe06", "url": "https://github.com/oracle/graal/commit/a21f51aef1705ea06ec50aeb126f67851abafe06", "message": "hook debuginfotest into gate", "committedDate": "2020-05-20T09:05:49Z", "type": "forcePushed"}, {"oid": "e6dac22ef5a20ae211708c07804236ebc80c9a48", "url": "https://github.com/oracle/graal/commit/e6dac22ef5a20ae211708c07804236ebc80c9a48", "message": "add mx debuginfotest command and link into _run_gate", "committedDate": "2020-05-20T10:24:40Z", "type": "commit"}, {"oid": "bc3cb87f363410e674f12280a0ea59ddf0d1b2bc", "url": "https://github.com/oracle/graal/commit/bc3cb87f363410e674f12280a0ea59ddf0d1b2bc", "message": "hook debuginfotest into gate", "committedDate": "2020-05-20T10:25:11Z", "type": "commit"}, {"oid": "bc3cb87f363410e674f12280a0ea59ddf0d1b2bc", "url": "https://github.com/oracle/graal/commit/bc3cb87f363410e674f12280a0ea59ddf0d1b2bc", "message": "hook debuginfotest into gate", "committedDate": "2020-05-20T10:25:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE5ODM4NQ==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430198385", "bodyText": "s/use dot/used to", "author": "olpaw", "createdAt": "2020-05-26T07:07:21Z", "path": "substratevm/DEBUGINFO.md", "diffHunk": "@@ -16,14 +16,16 @@ argument to the GenerateDebugInfo option.\n \n The GenerateDebugInfo option also enables caching of sources for any\n JDK runtime classes, GraalVM classes and application classes which can\n-be located during native image generation. The cache is created under\n-local subdirectory sources. It is used to configure source file search\n-path roots for the debugger. Files in the cache are located in a\n-directory hierarchy that matches the file path information included in\n-the native image debug records. The source cache should contain all\n-the files needed to debug the generated image and nothing more. This\n-local cache provides a convenient way of making just the necessary\n-sources available to the debugger/IDE when debugging a native image.\n+be located during native image generation. By default the cache is\n+created under local subdirectory sources (a command line option can be\n+use dot specifiy an alternative location). It is used to configure", "originalCommit": "bc3cb87f363410e674f12280a0ea59ddf0d1b2bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzMTIzMA==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430931230", "bodyText": "done", "author": "adinn", "createdAt": "2020-05-27T08:04:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE5ODM4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIwMTg4NQ==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430201885", "bodyText": "replace all print with mx.log", "author": "olpaw", "createdAt": "2020-05-26T07:14:41Z", "path": "substratevm/mx.substratevm/mx_substratevm.py", "diffHunk": "@@ -700,6 +711,36 @@ def _collector(x):\n         if actual_output != expected_output:\n             raise Exception('Unexpected output: ' + str(actual_output) + \"  !=  \" + str(expected_output))\n \n+def _debuginfotest(native_image, javac_command, path, build_only, args):\n+    mkpath(path)\n+    parent = os.path.dirname(path)\n+    print(\"parent=%s\"%parent)", "originalCommit": "bc3cb87f363410e674f12280a0ea59ddf0d1b2bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzMTMyOQ==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430931329", "bodyText": "done", "author": "adinn", "createdAt": "2020-05-27T08:05:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIwMTg4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIwNTUxMA==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430205510", "bodyText": "It's better to issue an error message here instead of silently fixing a users bad option argument. Otherwise we are breeding such command line invocations.", "author": "olpaw", "createdAt": "2020-05-26T07:22:14Z", "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/SubstrateOptions.java", "diffHunk": "@@ -469,4 +469,14 @@ protected void onValueUpdate(EconomicMap<OptionKey<?>, Object> values, Integer o\n     @Option(help = \"Search path for source files for Application or GraalVM classes (list of comma-separated directories or jar files)\")//\n     public static final HostedOptionKey<String[]> DebugInfoSourceSearchPath = new HostedOptionKey<String[]>(null) {\n     };\n+    @Option(help = \"Directory under which to create source file cache for Application or GraalVM classes\")//\n+    public static final HostedOptionKey<String> DebugInfoSourceCacheRoot = new HostedOptionKey<String>(\"sources\") {\n+        @Override\n+        protected void onValueUpdate(EconomicMap<OptionKey<?>, Object> values, String oldValue, String newValue) {\n+            // disallow null or empty string\n+            if (newValue == null || newValue.length() == 0) {", "originalCommit": "bc3cb87f363410e674f12280a0ea59ddf0d1b2bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMzOTc1NQ==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430339755", "bodyText": "Ok. What would be the appropriate way to make the user aware of the error? Do I throw an exception to stop the native image run? Should Can log an error message and force an exit? Or do I log a warning message, reset the value to the default and carry on. Is there a standard API to implement the latter actions?", "author": "adinn", "createdAt": "2020-05-26T11:22:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIwNTUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM1OTI3MA==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430359270", "bodyText": "See e.g. NativeImageOptions.getCStandard() on how we usually do this.", "author": "olpaw", "createdAt": "2020-05-26T12:01:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIwNTUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM4Mjc3Mg==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430382772", "bodyText": "Ok, thanks. Got it.", "author": "adinn", "createdAt": "2020-05-26T12:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIwNTUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzMTQwNQ==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430931405", "bodyText": "done", "author": "adinn", "createdAt": "2020-05-27T08:05:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIwNTUxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIxNzUzOQ==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430217539", "bodyText": "Providing a custom javac-command does not make much sense. Since your test is in the com.oracle.svm.test project it will be built automatically as part of running mx build anyway (building it again is redundant). You can use classpath('com.oracle.svm.test') to get the classpath argument you need to pass to native-image when you want to build Hello.", "author": "olpaw", "createdAt": "2020-05-26T07:45:32Z", "path": "substratevm/mx.substratevm/mx_substratevm.py", "diffHunk": "@@ -1008,6 +1049,29 @@ def helloworld(args, config=None):\n     )\n \n \n+@mx.command(suite_name=suite.name, command_name='debuginfotest', usage_msg='[options]')\n+def debuginfotest(args, config=None):\n+    \"\"\"\n+    builds a debuginfo Hello native image and tests it with gdb.\n+    \"\"\"\n+    parser = ArgumentParser(prog='mx debuginfotest')\n+    all_args = ['--output-path', '--javac-command', '--build-only']\n+    masked_args = [_mask(arg, all_args) for arg in args]\n+    parser.add_argument(all_args[0], metavar='<output-path>', nargs=1, help='Path of the generated image', default=[svmbuild_dir(suite)])\n+    parser.add_argument(all_args[1], metavar='<javac-command>', help='A javac command to be used', default=mx.get_jdk().javac)", "originalCommit": "bc3cb87f363410e674f12280a0ea59ddf0d1b2bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIxODE5MQ==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430218191", "bodyText": "See https://github.com/oracle/graal/pull/2459/files#r430217539", "author": "olpaw", "createdAt": "2020-05-26T07:46:35Z", "path": "substratevm/mx.substratevm/mx_substratevm.py", "diffHunk": "@@ -700,6 +711,36 @@ def _collector(x):\n         if actual_output != expected_output:\n             raise Exception('Unexpected output: ' + str(actual_output) + \"  !=  \" + str(expected_output))\n \n+def _debuginfotest(native_image, javac_command, path, build_only, args):\n+    mkpath(path)\n+    parent = os.path.dirname(path)\n+    print(\"parent=%s\"%parent)\n+    sourcepath = join(parent, 'src/com.oracle.svm.test/src/')\n+    print(\"sourcepath=%s\"%sourcepath)\n+    sourcecache = join(path, 'sources')\n+    print(\"sourcecache=%s\"%sourcecache)\n+    hello_source = join(sourcepath, 'hello/Hello.java')\n+    print('javac %s'%(['-sourcepath', sourcepath, '-d', path, hello_source]))\n+    mx.run(javac_command + ['-sourcepath', sourcepath, '-d', path, hello_source])", "originalCommit": "bc3cb87f363410e674f12280a0ea59ddf0d1b2bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzMTUxOQ==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430931519", "bodyText": "done", "author": "adinn", "createdAt": "2020-05-27T08:05:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDIxODE5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0NDE5Nw==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430244197", "bodyText": "No need to hardcode src/com.oracle.svm.test/src/. You can use mx.project('com.oracle.svm.test').source_dirs()", "author": "olpaw", "createdAt": "2020-05-26T08:31:53Z", "path": "substratevm/mx.substratevm/mx_substratevm.py", "diffHunk": "@@ -700,6 +711,36 @@ def _collector(x):\n         if actual_output != expected_output:\n             raise Exception('Unexpected output: ' + str(actual_output) + \"  !=  \" + str(expected_output))\n \n+def _debuginfotest(native_image, javac_command, path, build_only, args):\n+    mkpath(path)\n+    parent = os.path.dirname(path)\n+    print(\"parent=%s\"%parent)\n+    sourcepath = join(parent, 'src/com.oracle.svm.test/src/')", "originalCommit": "bc3cb87f363410e674f12280a0ea59ddf0d1b2bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzMTY0Nw==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430931647", "bodyText": "done", "author": "adinn", "createdAt": "2020-05-27T08:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0NDE5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0ODgyOQ==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430248829", "bodyText": "s/sued/used", "author": "olpaw", "createdAt": "2020-05-26T08:39:36Z", "path": "substratevm/mx.substratevm/testhello.py", "diffHunk": "@@ -0,0 +1,227 @@\n+# pylint: skip-file\n+#\n+# A test script for use from gdb. It can be sued to drive execution of", "originalCommit": "bc3cb87f363410e674f12280a0ea59ddf0d1b2bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzMzQ4OQ==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430933489", "bodyText": "done", "author": "adinn", "createdAt": "2020-05-27T08:08:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0ODgyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI1MjA4Mw==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430252083", "bodyText": "you could use\nself.rexps = [re.compile(regexp) for regexp in regexps]", "author": "olpaw", "createdAt": "2020-05-26T08:44:58Z", "path": "substratevm/mx.substratevm/testhello.py", "diffHunk": "@@ -0,0 +1,227 @@\n+# pylint: skip-file\n+#\n+# A test script for use from gdb. It can be sued to drive execution of\n+# a native image version of test app Hello and check that the debug\n+# info is valid.\n+#\n+# Assumes you have already executed\n+#\n+# $ javac hello/Hello.java\n+# $ mx native-image -H:GenerateDebugInfo=1 hello.hello\n+#\n+# Run test\n+#\n+# gdb -d /path/to/sources/src -d /path/to/sources/graal -d /path/to/sources/jdk -x testhello.py /path/to/hello\n+#\n+# exit status 0 means all is well 1 means test failed\n+#\n+# n.b. assumes the sourcefile cache is in local dir sources\n+\n+import re\n+import sys\n+\n+# A helper class which checks that a sequence of lines of output\n+# from a gdb command matches a sequence of per-line regular\n+# expressions\n+\n+class Checker:\n+    # Create a checker to check gdb command output text.\n+    # name - string to help identify the check if we have a failure.\n+    # regexps - a list of regular expressions which must match.\n+    # successive lines of checked\n+    def __init__(self, name, regexps):\n+        self.name = name\n+        compiled = []\n+        if not isinstance(regexps, list):\n+            regexps = [regexps]\n+        for regexp in regexps:", "originalCommit": "bc3cb87f363410e674f12280a0ea59ddf0d1b2bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwMDgwNA==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430900804", "bodyText": "After this change the following bits\ncompiled = []\n\nfor regexp in regexps:\n    compiled.append(re.compile(regexp))\n\nare dead code. Please remove them.", "author": "olpaw", "createdAt": "2020-05-27T07:08:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI1MjA4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI1MzUyMA==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430253520", "bodyText": "s/split('\\n')/splitlines()", "author": "olpaw", "createdAt": "2020-05-26T08:47:19Z", "path": "substratevm/mx.substratevm/testhello.py", "diffHunk": "@@ -0,0 +1,227 @@\n+# pylint: skip-file\n+#\n+# A test script for use from gdb. It can be sued to drive execution of\n+# a native image version of test app Hello and check that the debug\n+# info is valid.\n+#\n+# Assumes you have already executed\n+#\n+# $ javac hello/Hello.java\n+# $ mx native-image -H:GenerateDebugInfo=1 hello.hello\n+#\n+# Run test\n+#\n+# gdb -d /path/to/sources/src -d /path/to/sources/graal -d /path/to/sources/jdk -x testhello.py /path/to/hello\n+#\n+# exit status 0 means all is well 1 means test failed\n+#\n+# n.b. assumes the sourcefile cache is in local dir sources\n+\n+import re\n+import sys\n+\n+# A helper class which checks that a sequence of lines of output\n+# from a gdb command matches a sequence of per-line regular\n+# expressions\n+\n+class Checker:\n+    # Create a checker to check gdb command output text.\n+    # name - string to help identify the check if we have a failure.\n+    # regexps - a list of regular expressions which must match.\n+    # successive lines of checked\n+    def __init__(self, name, regexps):\n+        self.name = name\n+        compiled = []\n+        if not isinstance(regexps, list):\n+            regexps = [regexps]\n+        for regexp in regexps:\n+            compiled.append(re.compile(regexp))\n+        self.rexps = compiled\n+\n+    # Check that successive lines of a gdb command's output text\n+    # match the corresponding regexp patterns provided when this\n+    # Checker was created.\n+    # text - the full output of a gdb comand run by calling\n+    # gdb.execute and passing to_string = True.\n+    # Exits with status 1 if there are less lines in the text\n+    # than regexp patterns or if any line fails to match the\n+    # corresponding pattern otherwise prints the text and returns\n+    # the set of matches.\n+    def check(self, text, skip_fails=True):\n+        lines = text.split('\\n')", "originalCommit": "bc3cb87f363410e674f12280a0ea59ddf0d1b2bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzMjcxMg==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430932712", "bodyText": "done", "author": "adinn", "createdAt": "2020-05-27T08:07:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI1MzUyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMxMzI4Nw==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430313287", "bodyText": "0x([0-9a-f]+ is a common substring that might be worth reusing .i.e use\naddress_pattern_str = '0x([0-9a-f]+'", "author": "olpaw", "createdAt": "2020-05-26T10:30:05Z", "path": "substratevm/mx.substratevm/testhello.py", "diffHunk": "@@ -0,0 +1,227 @@\n+# pylint: skip-file\n+#\n+# A test script for use from gdb. It can be sued to drive execution of\n+# a native image version of test app Hello and check that the debug\n+# info is valid.\n+#\n+# Assumes you have already executed\n+#\n+# $ javac hello/Hello.java\n+# $ mx native-image -H:GenerateDebugInfo=1 hello.hello\n+#\n+# Run test\n+#\n+# gdb -d /path/to/sources/src -d /path/to/sources/graal -d /path/to/sources/jdk -x testhello.py /path/to/hello\n+#\n+# exit status 0 means all is well 1 means test failed\n+#\n+# n.b. assumes the sourcefile cache is in local dir sources\n+\n+import re\n+import sys\n+\n+# A helper class which checks that a sequence of lines of output\n+# from a gdb command matches a sequence of per-line regular\n+# expressions\n+\n+class Checker:\n+    # Create a checker to check gdb command output text.\n+    # name - string to help identify the check if we have a failure.\n+    # regexps - a list of regular expressions which must match.\n+    # successive lines of checked\n+    def __init__(self, name, regexps):\n+        self.name = name\n+        compiled = []\n+        if not isinstance(regexps, list):\n+            regexps = [regexps]\n+        for regexp in regexps:\n+            compiled.append(re.compile(regexp))\n+        self.rexps = compiled\n+\n+    # Check that successive lines of a gdb command's output text\n+    # match the corresponding regexp patterns provided when this\n+    # Checker was created.\n+    # text - the full output of a gdb comand run by calling\n+    # gdb.execute and passing to_string = True.\n+    # Exits with status 1 if there are less lines in the text\n+    # than regexp patterns or if any line fails to match the\n+    # corresponding pattern otherwise prints the text and returns\n+    # the set of matches.\n+    def check(self, text, skip_fails=True):\n+        lines = text.split('\\n')\n+        rexps = self.rexps\n+        num_lines = len(lines)\n+        num_rexps = len(rexps)\n+        line_idx = 0\n+        matches = []\n+        for i in range(0, (num_rexps)):\n+            rexp = rexps[i]\n+            match = None\n+            while line_idx < num_lines and match is None:\n+                line = lines[line_idx]\n+                match = rexp.match(line)\n+                if  match is None:\n+                    if not skip_fails:\n+                        print('Checker %s: match %d failed at line %d %s\\n'%(self.name, i, line_idx, line))\n+                        print(self)\n+                        print(text)\n+                        sys.exit(1)\n+                else:\n+                    matches.append(match)\n+                line_idx += 1\n+        if len(matches) < num_rexps:\n+            print('Checker %s: insufficient matching lines %d for regular expressions %d'%(self.name, len(matches), num_rexps))\n+            print(self)\n+            print(text)\n+            sys.exit(1)\n+        print(text)\n+        return matches\n+\n+    # Format a Checker as a string\n+    def __str__(self):\n+        rexps = self.rexps\n+        result = 'Checker %s '%(self.name)\n+        result += '{\\n'\n+        for rexp in rexps:\n+            result += '  %s\\n'%(rexp)\n+        result += '}\\n'\n+        return result\n+\n+def execute(command):\n+    print('(gdb) %s'%(command))\n+    return gdb.execute(command, to_string=True)\n+\n+# Configure this gdb session\n+\n+# ensure file listings show only the current line\n+execute(\"set listsize 1\")\n+\n+# Start of actual test code\n+#\n+\n+def test():\n+\n+    # disable prompting to continue output\n+    execute(\"set pagination off\")\n+    # set a break point at hello.Hello::main\n+    # expect \"Breakpoint 1 at 0x[0-9a-f]+: file hello.Hello.java, line 64.\"\n+    exec_string = execute(\"break hello.Hello::main\")\n+    rexp = \"Breakpoint 1 at 0x([0-9a-f]+): file hello/Hello\\\\.java, line 64\\\\.\"", "originalCommit": "bc3cb87f363410e674f12280a0ea59ddf0d1b2bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMxNzM4OQ==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430317389", "bodyText": "Using raw strings will make your patterns much more readable.\nhttps://docs.python.org/3/library/re.html?highlight=raw%20string%20notation", "author": "olpaw", "createdAt": "2020-05-26T10:38:06Z", "path": "substratevm/mx.substratevm/testhello.py", "diffHunk": "@@ -0,0 +1,227 @@\n+# pylint: skip-file\n+#\n+# A test script for use from gdb. It can be sued to drive execution of\n+# a native image version of test app Hello and check that the debug\n+# info is valid.\n+#\n+# Assumes you have already executed\n+#\n+# $ javac hello/Hello.java\n+# $ mx native-image -H:GenerateDebugInfo=1 hello.hello\n+#\n+# Run test\n+#\n+# gdb -d /path/to/sources/src -d /path/to/sources/graal -d /path/to/sources/jdk -x testhello.py /path/to/hello\n+#\n+# exit status 0 means all is well 1 means test failed\n+#\n+# n.b. assumes the sourcefile cache is in local dir sources\n+\n+import re\n+import sys\n+\n+# A helper class which checks that a sequence of lines of output\n+# from a gdb command matches a sequence of per-line regular\n+# expressions\n+\n+class Checker:\n+    # Create a checker to check gdb command output text.\n+    # name - string to help identify the check if we have a failure.\n+    # regexps - a list of regular expressions which must match.\n+    # successive lines of checked\n+    def __init__(self, name, regexps):\n+        self.name = name\n+        compiled = []\n+        if not isinstance(regexps, list):\n+            regexps = [regexps]\n+        for regexp in regexps:\n+            compiled.append(re.compile(regexp))\n+        self.rexps = compiled\n+\n+    # Check that successive lines of a gdb command's output text\n+    # match the corresponding regexp patterns provided when this\n+    # Checker was created.\n+    # text - the full output of a gdb comand run by calling\n+    # gdb.execute and passing to_string = True.\n+    # Exits with status 1 if there are less lines in the text\n+    # than regexp patterns or if any line fails to match the\n+    # corresponding pattern otherwise prints the text and returns\n+    # the set of matches.\n+    def check(self, text, skip_fails=True):\n+        lines = text.split('\\n')\n+        rexps = self.rexps\n+        num_lines = len(lines)\n+        num_rexps = len(rexps)\n+        line_idx = 0\n+        matches = []\n+        for i in range(0, (num_rexps)):\n+            rexp = rexps[i]\n+            match = None\n+            while line_idx < num_lines and match is None:\n+                line = lines[line_idx]\n+                match = rexp.match(line)\n+                if  match is None:\n+                    if not skip_fails:\n+                        print('Checker %s: match %d failed at line %d %s\\n'%(self.name, i, line_idx, line))\n+                        print(self)\n+                        print(text)\n+                        sys.exit(1)\n+                else:\n+                    matches.append(match)\n+                line_idx += 1\n+        if len(matches) < num_rexps:\n+            print('Checker %s: insufficient matching lines %d for regular expressions %d'%(self.name, len(matches), num_rexps))\n+            print(self)\n+            print(text)\n+            sys.exit(1)\n+        print(text)\n+        return matches\n+\n+    # Format a Checker as a string\n+    def __str__(self):\n+        rexps = self.rexps\n+        result = 'Checker %s '%(self.name)\n+        result += '{\\n'\n+        for rexp in rexps:\n+            result += '  %s\\n'%(rexp)\n+        result += '}\\n'\n+        return result\n+\n+def execute(command):\n+    print('(gdb) %s'%(command))\n+    return gdb.execute(command, to_string=True)\n+\n+# Configure this gdb session\n+\n+# ensure file listings show only the current line\n+execute(\"set listsize 1\")\n+\n+# Start of actual test code\n+#\n+\n+def test():\n+\n+    # disable prompting to continue output\n+    execute(\"set pagination off\")\n+    # set a break point at hello.Hello::main\n+    # expect \"Breakpoint 1 at 0x[0-9a-f]+: file hello.Hello.java, line 64.\"\n+    exec_string = execute(\"break hello.Hello::main\")\n+    rexp = \"Breakpoint 1 at 0x([0-9a-f]+): file hello/Hello\\\\.java, line 64\\\\.\"\n+    checker = Checker('break main', rexp)\n+    checker.check(exec_string)\n+\n+    # run the program\n+    execute(\"run\")\n+\n+    # list the line at the breakpoint\n+    # expect \"64\t        Greeter greeter = Greeter.greeter(args);\"\n+    exec_string = execute(\"list\")\n+    checker = Checker(\"list bp 1\", \"64[ \\t]+Greeter greeter = Greeter\\\\.greeter\\\\(args\\\\);\")\n+    checker.check(exec_string, skip_fails=False)\n+\n+    # run a backtrace\n+    # expect \"#0  hello.Hello::main(java.lang.String[]).* at hello.Hello.java:64\"\n+    # expect \"#1  0x[0-9a-f]+ in com.oracle.svm.core.code.IsolateEnterStub::JavaMainWrapper_run_.* at [a-z/]+/JavaMainWrapper.java:[0-9]+\"\n+    exec_string = execute(\"backtrace\")\n+    checker = Checker(\"backtrace hello.Hello::main\",\n+                      [\"#0[ \\t]+hello\\\\.Hello::main\\\\(java\\\\.lang\\\\.String\\\\[\\\\]\\\\).* at hello/Hello\\\\.java:64\",\n+                       \"#1[ \\t]+0x[0-9a-f]+ in com\\\\.oracle\\\\.svm\\\\.core\\\\.code\\\\.IsolateEnterStub::JavaMainWrapper_run_.* at [a-z/]+/JavaMainWrapper\\\\.java:[0-9]+\"\n+                      ])\n+    checker.check(exec_string, skip_fails=False)\n+\n+    # look up PrintStream::println methods\n+    # expect \"All functions matching regular expression \"java.io.PrintStream::println\":\"\n+    # expect \"\"\n+    # expect \"File java.base/java/io/PrintStream.java:\"\n+    # expect \"      void java.io.PrintStream::println(java.lang.Object)(void);\"\n+    # expect \"      void java.io.PrintStream::println(java.lang.String)(void);\"\n+    exec_string = execute(\"info func java.io.PrintStream::println\")\n+#    checker = Checker(\"info func java.io.PrintStream::println\",\n+#                      [\"All functions matching regular expression \\\"java\\\\.io\\\\.PrintStream::println\\\":\",\n+#                       \"\",\n+#                       \"File .*java/io/PrintStream.java:\",\n+#                       \"[ \\t]*void java.io.PrintStream::println\\\\(java\\\\.lang\\\\.Object\\\\)\\\\(void\\\\);\",\n+#                       \"[ \\t]*void java.io.PrintStream::println\\\\(java\\\\.lang\\\\.String\\\\)\\\\(void\\\\);\",\n+#                      ])\n+    checker = Checker(\"info func java.io.PrintStream::println\",\n+                      \"[ \\t]*void java.io.PrintStream::println\\\\(java\\\\.lang\\\\.String\\\\)\")\n+    checker.check(exec_string)\n+\n+    # set a break point at PrintStream::println(String)\n+    # expect \"Breakpoint 2 at 0x[0-9a-f]+: java.base/java/io/PrintStream.java, line [0-9]+.\"\n+    exec_string = execute(\"break java.io.PrintStream::println(java.lang.String)\")\n+    rexp = \"Breakpoint 2 at 0x([0-9a-f]+): file .*java/io/PrintStream\\\\.java, line [0-9]+\\\\.\"\n+    checker = Checker('break println', rexp)\n+    checker.check(exec_string, skip_fails=False)\n+\n+    # step into method call\n+    execute(\"step\")\n+\n+    # list current line\n+    # expect \"31\t            if (args.length == 0) {\"\n+    exec_string = execute(\"list\")\n+    rexp = \"31[ \\t]+if \\\\(args\\\\.length == 0\\\\) {\"\n+    checker = Checker('list hello.Hello.Greeter::greeter', rexp)\n+    checker.check(exec_string, skip_fails=False)\n+\n+    # run a backtrace\n+    # expect \"#0  hello.Hello.greeter::greeter(java.lang.String[]).* at hello.Hello.java:31\"\n+    # expect \"#1  0x[0-9a-f]+ in hello.Hello::main(java.lang.String[]).* at hello.Hello.java:64\"\n+    # expect \"#2  0x[0-9a-f]+ in com.oracle.svm.core.code.IsolateEnterStub::JavaMainWrapper_run_.* at [a-z/]+/JavaMainWrapper.java:[0-9]+\"\n+    exec_string = execute(\"backtrace\")\n+    checker = Checker(\"backtrace hello.Hello.Greeter::greeter\",\n+                      [\"#0[ \\t]+hello\\\\.Hello\\\\.Greeter::greeter\\\\(java\\\\.lang\\\\.String\\\\[\\\\]\\\\).* at hello/Hello\\\\.java:31\",", "originalCommit": "bc3cb87f363410e674f12280a0ea59ddf0d1b2bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzMjc5MA==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430932790", "bodyText": "done", "author": "adinn", "createdAt": "2020-05-27T08:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMxNzM4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwMTIwOA==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430901208", "bodyText": "Very nice! \ud83d\udc4d", "author": "olpaw", "createdAt": "2020-05-27T07:09:10Z", "path": "substratevm/mx.substratevm/testhello.py", "diffHunk": "@@ -101,12 +101,20 @@ def execute(command):\n \n def test():\n \n+    # define some useful patterns\n+    address_pattern = '0x[0-9a-f]+'", "originalCommit": "006f2a8e822e29611cd6b054d4a1cb5fe0059f5e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwMzg3MQ==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430903871", "bodyText": "Now that you have that abstraction in-between you could take the checking one level further by returning a Path here and react on InvalidPathException during construction (Paths.get) with a sensible UserError.abort message.", "author": "olpaw", "createdAt": "2020-05-27T07:14:41Z", "path": "substratevm/src/com.oracle.svm.core/src/com/oracle/svm/core/SubstrateOptions.java", "diffHunk": "@@ -470,13 +472,13 @@ protected void onValueUpdate(EconomicMap<OptionKey<?>, Object> values, Integer o\n     public static final HostedOptionKey<String[]> DebugInfoSourceSearchPath = new HostedOptionKey<String[]>(null) {\n     };\n     @Option(help = \"Directory under which to create source file cache for Application or GraalVM classes\")//\n-    public static final HostedOptionKey<String> DebugInfoSourceCacheRoot = new HostedOptionKey<String>(\"sources\") {\n-        @Override\n-        protected void onValueUpdate(EconomicMap<OptionKey<?>, Object> values, String oldValue, String newValue) {\n-            // disallow null or empty string\n-            if (newValue == null || newValue.length() == 0) {\n-                DebugInfoSourceCacheRoot.update(values, oldValue);\n-            }\n+    public static final HostedOptionKey<String> DebugInfoSourceCacheRoot = new HostedOptionKey<String>(\"sources\");\n+\n+    public static String getDebugInfoSourceCacheRoot() {", "originalCommit": "006f2a8e822e29611cd6b054d4a1cb5fe0059f5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk1MTE1MQ==", "url": "https://github.com/oracle/graal/pull/2459#discussion_r430951151", "bodyText": "done", "author": "adinn", "createdAt": "2020-05-27T08:38:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwMzg3MQ=="}], "type": "inlineReview"}, {"oid": "95d13ac97cca5a472097bf636c553fa1982f0699", "url": "https://github.com/oracle/graal/commit/95d13ac97cca5a472097bf636c553fa1982f0699", "message": "fixes for review comments", "committedDate": "2020-05-27T08:03:03Z", "type": "forcePushed"}, {"oid": "2cd73a953d273fd68e3dfecb934273e666a483b9", "url": "https://github.com/oracle/graal/commit/2cd73a953d273fd68e3dfecb934273e666a483b9", "message": "fixes for review comments", "committedDate": "2020-05-27T08:36:56Z", "type": "commit"}, {"oid": "2cd73a953d273fd68e3dfecb934273e666a483b9", "url": "https://github.com/oracle/graal/commit/2cd73a953d273fd68e3dfecb934273e666a483b9", "message": "fixes for review comments", "committedDate": "2020-05-27T08:36:56Z", "type": "forcePushed"}, {"oid": "904859e2c24375fd010bb81336fd8ec1f0404de1", "url": "https://github.com/oracle/graal/commit/904859e2c24375fd010bb81336fd8ec1f0404de1", "message": "Style fix", "committedDate": "2020-05-27T09:26:47Z", "type": "commit"}, {"oid": "7cf361f6996d6b74c50b3ed7987c80c1e62dd5f9", "url": "https://github.com/oracle/graal/commit/7cf361f6996d6b74c50b3ed7987c80c1e62dd5f9", "message": "Fix checkstyle issues", "committedDate": "2020-05-27T10:05:09Z", "type": "commit"}, {"oid": "93dabb297aaae737380d811c5eeb9ebe31d4607b", "url": "https://github.com/oracle/graal/commit/93dabb297aaae737380d811c5eeb9ebe31d4607b", "message": "Add missing copyright header", "committedDate": "2020-05-27T13:02:33Z", "type": "commit"}, {"oid": "92337dfada77f57874e53115ad986404a9855358", "url": "https://github.com/oracle/graal/commit/92337dfada77f57874e53115ad986404a9855358", "message": "Fix FindBugs warning about possible NPE", "committedDate": "2020-05-27T13:21:56Z", "type": "commit"}, {"oid": "52174b008a7e152d9f32c0517374036a07297620", "url": "https://github.com/oracle/graal/commit/52174b008a7e152d9f32c0517374036a07297620", "message": "Prevent SubstrateOptions.getDebugInfoSourceCacheRoot() at SourceCache.<clinit> time\n\nAt the time of SourceCache clinit HostedOptionValues Singleton in not\nyet available thus DebugInfoSourceCacheRoot.getValue() cannot be used at\nSourceCache clinit time.", "committedDate": "2020-05-27T14:38:44Z", "type": "commit"}]}