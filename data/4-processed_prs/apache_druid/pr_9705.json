{"pr_number": 9705, "pr_title": "add joins to column tree menu", "pr_createdAt": "2020-04-15T17:32:12Z", "pr_url": "https://github.com/apache/druid/pull/9705", "timeline": [{"oid": "503f1660fb6fa34e6a0f6e16ff6e3051aa41662d", "url": "https://github.com/apache/druid/commit/503f1660fb6fa34e6a0f6e16ff6e3051aa41662d", "message": "add joins to column tree menu", "committedDate": "2020-04-15T17:28:58Z", "type": "commit"}, {"oid": "38580217b705c26224714d1ea17c088e1f129728", "url": "https://github.com/apache/druid/commit/38580217b705c26224714d1ea17c088e1f129728", "message": "fix capitalization", "committedDate": "2020-04-15T20:21:05Z", "type": "commit"}, {"oid": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d", "url": "https://github.com/apache/druid/commit/cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d", "message": "add keyword, keep columns if replaced", "committedDate": "2020-04-16T01:52:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1OTUwMw==", "url": "https://github.com/apache/druid/pull/9705#discussion_r409259503", "bodyText": "capitalization", "author": "vogievetsky", "createdAt": "2020-04-16T03:28:12Z", "path": "web-console/src/views/query-view/column-tree/column-tree-menu/string-menu-items/string-menu-items.tsx", "diffHunk": "@@ -163,13 +167,80 @@ export const StringMenuItems = React.memo(function StringMenuItems(props: String\n     );\n   }\n \n+  function renderJoinMenu(): JSX.Element | undefined {\n+    const { schema, table, columnName, parsedQuery, onQueryChange } = props;\n+    if (schema !== 'lookup' || !parsedQuery) return;\n+\n+    const { originalTableColumn, lookupColumn } = getCurrentColumns(parsedQuery, table);\n+\n+    return (\n+      <>\n+        <MenuItem\n+          icon={IconNames.JOIN_TABLE}\n+          text={parsedQuery.joinTable ? `Replace Join` : `Join`}", "originalCommit": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1OTU2OA==", "url": "https://github.com/apache/druid/pull/9705#discussion_r409259568", "bodyText": "Cap", "author": "vogievetsky", "createdAt": "2020-04-16T03:28:28Z", "path": "web-console/src/views/query-view/column-tree/column-tree-menu/string-menu-items/string-menu-items.tsx", "diffHunk": "@@ -163,13 +167,80 @@ export const StringMenuItems = React.memo(function StringMenuItems(props: String\n     );\n   }\n \n+  function renderJoinMenu(): JSX.Element | undefined {\n+    const { schema, table, columnName, parsedQuery, onQueryChange } = props;\n+    if (schema !== 'lookup' || !parsedQuery) return;\n+\n+    const { originalTableColumn, lookupColumn } = getCurrentColumns(parsedQuery, table);\n+\n+    return (\n+      <>\n+        <MenuItem\n+          icon={IconNames.JOIN_TABLE}\n+          text={parsedQuery.joinTable ? `Replace Join` : `Join`}\n+        >\n+          <MenuItem\n+            icon={IconNames.LEFT_JOIN}\n+            text={`Left Join`}", "originalCommit": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1OTY2MA==", "url": "https://github.com/apache/druid/pull/9705#discussion_r409259660", "bodyText": "ditto", "author": "vogievetsky", "createdAt": "2020-04-16T03:28:49Z", "path": "web-console/src/views/query-view/column-tree/column-tree-menu/string-menu-items/string-menu-items.tsx", "diffHunk": "@@ -163,13 +167,80 @@ export const StringMenuItems = React.memo(function StringMenuItems(props: String\n     );\n   }\n \n+  function renderJoinMenu(): JSX.Element | undefined {\n+    const { schema, table, columnName, parsedQuery, onQueryChange } = props;\n+    if (schema !== 'lookup' || !parsedQuery) return;\n+\n+    const { originalTableColumn, lookupColumn } = getCurrentColumns(parsedQuery, table);\n+\n+    return (\n+      <>\n+        <MenuItem\n+          icon={IconNames.JOIN_TABLE}\n+          text={parsedQuery.joinTable ? `Replace Join` : `Join`}\n+        >\n+          <MenuItem\n+            icon={IconNames.LEFT_JOIN}\n+            text={`Left Join`}\n+            onClick={() => {\n+              onQueryChange(\n+                parsedQuery.addJoin(\n+                  'LEFT',\n+                  SqlRef.fromString(table, schema).upgrade(),\n+                  SqlMulti.sqlMultiFactory('=', [\n+                    SqlRef.fromString(columnName, table, 'lookup'),\n+                    SqlRef.fromString(\n+                      lookupColumn === columnName ? originalTableColumn : 'XXX',\n+                      parsedQuery.getTableName(),\n+                    ),\n+                  ]),\n+                ),\n+                false,\n+              );\n+            }}\n+          />\n+          <MenuItem\n+            icon={IconNames.INNER_JOIN}\n+            text={`Inner Join`}\n+            onClick={() => {\n+              onQueryChange(\n+                parsedQuery.addJoin(\n+                  'INNER',\n+                  SqlRef.fromString(table, schema).upgrade(),\n+                  SqlMulti.sqlMultiFactory('=', [\n+                    SqlRef.fromString(columnName, table, 'lookup'),\n+                    SqlRef.fromString(\n+                      lookupColumn === columnName ? originalTableColumn : 'XXX',\n+                      parsedQuery.getTableName(),\n+                    ),\n+                  ]),\n+                ),\n+                false,\n+              );\n+            }}\n+          />\n+        </MenuItem>\n+        {parsedQuery.onExpression &&\n+          parsedQuery.onExpression instanceof SqlMulti &&\n+          parsedQuery.onExpression.containsColumn(columnName) && (\n+            <MenuItem\n+              icon={IconNames.EXCHANGE}\n+              text={`Remove Join`}", "originalCommit": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MDAxNQ==", "url": "https://github.com/apache/druid/pull/9705#discussion_r409260015", "bodyText": "Cap", "author": "vogievetsky", "createdAt": "2020-04-16T03:30:05Z", "path": "web-console/src/views/query-view/column-tree/column-tree.tsx", "diffHunk": "@@ -188,6 +214,73 @@ export class ColumnTree extends React.PureComponent<ColumnTreeProps, ColumnTreeS\n                                 }}\n                               />\n                             )}\n+                            {parsedQuery && schema === 'lookup' && (\n+                              <MenuItem\n+                                popoverProps={{ openOnTargetFocus: false }}\n+                                icon={IconNames.JOIN_TABLE}\n+                                text={parsedQuery.joinTable ? `Replace Join` : `Join`}", "originalCommit": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MDE2MQ==", "url": "https://github.com/apache/druid/pull/9705#discussion_r409260161", "bodyText": "Sentence case", "author": "vogievetsky", "createdAt": "2020-04-16T03:30:43Z", "path": "web-console/src/views/query-view/column-tree/column-tree.tsx", "diffHunk": "@@ -188,6 +214,73 @@ export class ColumnTree extends React.PureComponent<ColumnTreeProps, ColumnTreeS\n                                 }}\n                               />\n                             )}\n+                            {parsedQuery && schema === 'lookup' && (\n+                              <MenuItem\n+                                popoverProps={{ openOnTargetFocus: false }}\n+                                icon={IconNames.JOIN_TABLE}\n+                                text={parsedQuery.joinTable ? `Replace Join` : `Join`}\n+                              >\n+                                <MenuItem\n+                                  icon={IconNames.LEFT_JOIN}\n+                                  text={`Left Join`}\n+                                  onClick={() => {\n+                                    const { lookupColumn, originalTableColumn } = getCurrentColumns(\n+                                      parsedQuery,\n+                                      table,\n+                                    );\n+                                    props.onQueryStringChange(\n+                                      parsedQuery.addJoin(\n+                                        'LEFT',\n+                                        SqlRef.fromString(table, schema).upgrade(),\n+                                        SqlMulti.sqlMultiFactory('=', [\n+                                          SqlRef.fromString(lookupColumn, table, 'lookup'),\n+                                          SqlRef.fromString(\n+                                            originalTableColumn,\n+                                            parsedQuery.getTableName(),\n+                                          ),\n+                                        ]),\n+                                      ),\n+                                      false,\n+                                    );\n+                                  }}\n+                                />\n+                                <MenuItem\n+                                  icon={IconNames.INNER_JOIN}\n+                                  text={`Inner Join`}", "originalCommit": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MDIwNA==", "url": "https://github.com/apache/druid/pull/9705#discussion_r409260204", "bodyText": "Cap", "author": "vogievetsky", "createdAt": "2020-04-16T03:30:53Z", "path": "web-console/src/views/query-view/column-tree/column-tree.tsx", "diffHunk": "@@ -188,6 +214,73 @@ export class ColumnTree extends React.PureComponent<ColumnTreeProps, ColumnTreeS\n                                 }}\n                               />\n                             )}\n+                            {parsedQuery && schema === 'lookup' && (\n+                              <MenuItem\n+                                popoverProps={{ openOnTargetFocus: false }}\n+                                icon={IconNames.JOIN_TABLE}\n+                                text={parsedQuery.joinTable ? `Replace Join` : `Join`}\n+                              >\n+                                <MenuItem\n+                                  icon={IconNames.LEFT_JOIN}\n+                                  text={`Left Join`}", "originalCommit": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MDIyOA==", "url": "https://github.com/apache/druid/pull/9705#discussion_r409260228", "bodyText": "Cap", "author": "vogievetsky", "createdAt": "2020-04-16T03:31:02Z", "path": "web-console/src/views/query-view/column-tree/column-tree.tsx", "diffHunk": "@@ -188,6 +214,73 @@ export class ColumnTree extends React.PureComponent<ColumnTreeProps, ColumnTreeS\n                                 }}\n                               />\n                             )}\n+                            {parsedQuery && schema === 'lookup' && (\n+                              <MenuItem\n+                                popoverProps={{ openOnTargetFocus: false }}\n+                                icon={IconNames.JOIN_TABLE}\n+                                text={parsedQuery.joinTable ? `Replace Join` : `Join`}\n+                              >\n+                                <MenuItem\n+                                  icon={IconNames.LEFT_JOIN}\n+                                  text={`Left Join`}\n+                                  onClick={() => {\n+                                    const { lookupColumn, originalTableColumn } = getCurrentColumns(\n+                                      parsedQuery,\n+                                      table,\n+                                    );\n+                                    props.onQueryStringChange(\n+                                      parsedQuery.addJoin(\n+                                        'LEFT',\n+                                        SqlRef.fromString(table, schema).upgrade(),\n+                                        SqlMulti.sqlMultiFactory('=', [\n+                                          SqlRef.fromString(lookupColumn, table, 'lookup'),\n+                                          SqlRef.fromString(\n+                                            originalTableColumn,\n+                                            parsedQuery.getTableName(),\n+                                          ),\n+                                        ]),\n+                                      ),\n+                                      false,\n+                                    );\n+                                  }}\n+                                />\n+                                <MenuItem\n+                                  icon={IconNames.INNER_JOIN}\n+                                  text={`Inner Join`}\n+                                  onClick={() => {\n+                                    const { lookupColumn, originalTableColumn } = getCurrentColumns(\n+                                      parsedQuery,\n+                                      table,\n+                                    );\n+                                    props.onQueryStringChange(\n+                                      parsedQuery.addJoin(\n+                                        'INNER',\n+                                        SqlRef.fromString(table, schema).upgrade(),\n+                                        SqlMulti.sqlMultiFactory('=', [\n+                                          SqlRef.fromString(lookupColumn, table, 'lookup'),\n+                                          SqlRef.fromString(\n+                                            originalTableColumn,\n+                                            parsedQuery.getTableName(),\n+                                          ),\n+                                        ]),\n+                                      ),\n+                                      false,\n+                                    );\n+                                  }}\n+                                />\n+                              </MenuItem>\n+                            )}\n+                            {parsedQuery &&\n+                              parsedQuery.joinTable &&\n+                              parsedQuery.joinTable.table === table && (\n+                                <MenuItem\n+                                  icon={IconNames.EXCHANGE}\n+                                  text={`Remove Join`}", "originalCommit": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MDYxOA==", "url": "https://github.com/apache/druid/pull/9705#discussion_r409260618", "bodyText": "What about RIGHT? Are there any other keywords that are now supported that should go here?", "author": "vogievetsky", "createdAt": "2020-04-16T03:32:35Z", "path": "web-console/lib/keywords.js", "diffHunk": "@@ -34,6 +34,10 @@ exports.SQL_KEYWORDS = [\n   'DESC',\n   'LIMIT',\n   'UNION ALL',\n+  'JOIN',\n+  'LEFT',\n+  'INNER',\n+  'ON',", "originalCommit": "cf4e8fda7b91f3fde2e529b4679f9a78c68e4b0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b0a4e3901c8768c42ab584197d80b2baeb690d62", "url": "https://github.com/apache/druid/commit/b0a4e3901c8768c42ab584197d80b2baeb690d62", "message": "actually fix capitalization", "committedDate": "2020-04-16T03:41:19Z", "type": "commit"}, {"oid": "3b7772bf1591834f0a031f1a622b9937af7efac4", "url": "https://github.com/apache/druid/commit/3b7772bf1591834f0a031f1a622b9937af7efac4", "message": "add keywords", "committedDate": "2020-04-16T03:43:00Z", "type": "commit"}]}