{"pr_number": 10496, "pr_title": "Web console: show segment sizes in rows not bytes", "pr_createdAt": "2020-10-08T22:16:44Z", "pr_url": "https://github.com/apache/druid/pull/10496", "timeline": [{"oid": "0e41e4bb7775831e67af42553ac6079e31f30358", "url": "https://github.com/apache/druid/commit/0e41e4bb7775831e67af42553ac6079e31f30358", "message": "added query error suggestions", "committedDate": "2020-10-08T01:06:00Z", "type": "commit"}, {"oid": "3779bf2541c417b032c30bb728484aca3a529c7e", "url": "https://github.com/apache/druid/commit/3779bf2541c417b032c30bb728484aca3a529c7e", "message": "simplify the SQLs", "committedDate": "2020-10-08T20:39:14Z", "type": "commit"}, {"oid": "7616d7f167e57c7e488df8edcdb55a9daff73e3b", "url": "https://github.com/apache/druid/commit/7616d7f167e57c7e488df8edcdb55a9daff73e3b", "message": "change segment size display to rows", "committedDate": "2020-10-08T21:06:59Z", "type": "commit"}, {"oid": "5b695b98ddf9a362c6316a2a255017bb585ca63a", "url": "https://github.com/apache/druid/commit/5b695b98ddf9a362c6316a2a255017bb585ca63a", "message": "suggestion tests", "committedDate": "2020-10-08T22:08:00Z", "type": "commit"}, {"oid": "761ba2a778945cb98d7658ffd00eca1f6f50a324", "url": "https://github.com/apache/druid/commit/761ba2a778945cb98d7658ffd00eca1f6f50a324", "message": "update snapshot", "committedDate": "2020-10-08T22:10:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2MjQwNQ==", "url": "https://github.com/apache/druid/pull/10496#discussion_r502162405", "bodyText": "what does mq and mc stand for?", "author": "suneet-s", "createdAt": "2020-10-09T03:18:23Z", "path": "web-console/src/utils/druid-query.ts", "diffHunk": "@@ -92,12 +97,55 @@ export class DruidError extends Error {\n     return;\n   }\n \n+  static getSuggestion(errorMessage: string): QuerySuggestion | undefined {\n+    // == is used instead of =\n+    if (errorMessage.includes('Encountered \"= =\" at')) {\n+      return {\n+        label: `Replace == with =`,\n+        fn: str => {\n+          if (!str.includes('==')) return;\n+          return str.replace(/==/g, '=');\n+        },\n+      };\n+    }\n+\n+    // Incorrect quoting on table\n+    const mq = errorMessage.match(/Column '([^']+)' not found in any table/);\n+    if (mq) {\n+      const literalString = mq[1];\n+      return {\n+        label: `Replace \"${literalString}\" with '${literalString}'`,\n+        fn: str => {\n+          if (!str.includes(`\"${literalString}\"`)) return;\n+          return str.replace(`\"${literalString}\"`, `'${literalString}'`);\n+        },\n+      };\n+    }\n+\n+    // , before FROM\n+    const mc = errorMessage.match(/Encountered \"(FROM)\" at/i);", "originalCommit": "761ba2a778945cb98d7658ffd00eca1f6f50a324", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2MzQ5OQ==", "url": "https://github.com/apache/druid/pull/10496#discussion_r502163499", "bodyText": "what if == is part of a literal? Does str#replace replace all instances of the regex in the string? Similar comments for other uses of replace function in this code block", "author": "suneet-s", "createdAt": "2020-10-09T03:23:22Z", "path": "web-console/src/utils/druid-query.ts", "diffHunk": "@@ -92,12 +97,55 @@ export class DruidError extends Error {\n     return;\n   }\n \n+  static getSuggestion(errorMessage: string): QuerySuggestion | undefined {\n+    // == is used instead of =\n+    if (errorMessage.includes('Encountered \"= =\" at')) {\n+      return {\n+        label: `Replace == with =`,\n+        fn: str => {\n+          if (!str.includes('==')) return;\n+          return str.replace(/==/g, '=');", "originalCommit": "761ba2a778945cb98d7658ffd00eca1f6f50a324", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU1NDcxOA==", "url": "https://github.com/apache/druid/pull/10496#discussion_r502554718", "bodyText": "yeah it is pretty blunt, just replaces all the == with =... Maybe it should be aware of the line markers in the error text", "author": "vogievetsky", "createdAt": "2020-10-09T16:49:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2MzQ5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NjAxMA==", "url": "https://github.com/apache/druid/pull/10496#discussion_r502166010", "bodyText": "Is this wide enough to handle 7 digits for min, avg and max?\nFrom the doc linked in this PR it's generally recommended for each segment to have around 5 million rows\nDo you think it's users would want to see a rounded number instead - something like 2.1M instead of 2,105,248\n^ just a thought", "author": "suneet-s", "createdAt": "2020-10-09T03:34:33Z", "path": "web-console/src/views/datasource-view/datasource-view.tsx", "diffHunk": "@@ -1011,11 +1006,11 @@ GROUP BY 1`;\n               ),\n             },\n             {\n-              Header: twoLines('Segment size (MB)', 'min / avg / max'),\n+              Header: twoLines('Segment size (rows)', 'minimum / average / maximum'),\n               show: hiddenColumns.exists('Segment size'),\n               accessor: 'avg_segment_size',\n               filterable: false,\n-              width: 150,\n+              width: 220,", "originalCommit": "761ba2a778945cb98d7658ffd00eca1f6f50a324", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU1NjQwOQ==", "url": "https://github.com/apache/druid/pull/10496#discussion_r502556409", "bodyText": "I wanted them all to be consistently formatted with the same abbreviation. So not to have 7.6 M, 4.3 k, and 233  all in the same column. What if we format it as millions with 3 digits:\n5.343 M, 0.004 M, 0.000 M\nWhat do you think?", "author": "vogievetsky", "createdAt": "2020-10-09T16:52:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NjAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU3MjM4OQ==", "url": "https://github.com/apache/druid/pull/10496#discussion_r502572389", "bodyText": "I don't have a strong opinion on this, and will defer to your judgement.\nThe risk with rounding to millions is that for smaller datasources, it could always show 0.000 M\nI wonder if the UI could use the largest rounding per datasource. So you could have something like\nDS1    5.343 M, 0.004 M, 0.000 M\nDS2    0.320 k, 0.120 k, 321.1 k\n\n^ even in this example, I'm really confused about how to pick whether to keep it as 321.1 k or 0.321 M\nNumber formatting isn't my forte \ud83d\ude43", "author": "suneet-s", "createdAt": "2020-10-09T17:24:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NjAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk4NjM3Mw==", "url": "https://github.com/apache/druid/pull/10496#discussion_r502986373", "bodyText": "What do you think about\n\nThe only numbers that would be rendered as 0.000 M would be numbers <= 500 so we could display them directly.\nSide note: There is a style pass happening on a different branch that would change the font to one that has monospaced numbers", "author": "vogievetsky", "createdAt": "2020-10-12T00:17:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NjAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAwNTIxNg==", "url": "https://github.com/apache/druid/pull/10496#discussion_r503005216", "bodyText": "\ud83d\udc4d", "author": "suneet-s", "createdAt": "2020-10-12T02:14:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NjAxMA=="}], "type": "inlineReview"}, {"oid": "cef736db24f173bc27b84cd251a5e27ac3cd215a", "url": "https://github.com/apache/druid/commit/cef736db24f173bc27b84cd251a5e27ac3cd215a", "message": "make error detection more robust", "committedDate": "2020-10-10T00:32:01Z", "type": "commit"}, {"oid": "052c29127094c085a5d662e8e515e012a3b442fe", "url": "https://github.com/apache/druid/commit/052c29127094c085a5d662e8e515e012a3b442fe", "message": "remove errant console log", "committedDate": "2020-10-10T00:33:37Z", "type": "commit"}, {"oid": "491c8c0c2d7a2a1ca86f2b01be1c400945ba48cc", "url": "https://github.com/apache/druid/commit/491c8c0c2d7a2a1ca86f2b01be1c400945ba48cc", "message": "fix imports", "committedDate": "2020-10-10T00:34:16Z", "type": "commit"}, {"oid": "c73483ffc921f968df38390b349f117328883437", "url": "https://github.com/apache/druid/commit/c73483ffc921f968df38390b349f117328883437", "message": "put suggestion on top", "committedDate": "2020-10-10T00:45:00Z", "type": "commit"}, {"oid": "874b5c6f5bb91e7607511aa14c6b3be28a98eb47", "url": "https://github.com/apache/druid/commit/874b5c6f5bb91e7607511aa14c6b3be28a98eb47", "message": "better error rendering", "committedDate": "2020-10-10T04:32:49Z", "type": "commit"}, {"oid": "426b68fb8b8ff5f3fdf35e3bd687639fa14d58d7", "url": "https://github.com/apache/druid/commit/426b68fb8b8ff5f3fdf35e3bd687639fa14d58d7", "message": "format as millions", "committedDate": "2020-10-12T00:26:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3NjMyNQ==", "url": "https://github.com/apache/druid/pull/10496#discussion_r503576325", "bodyText": "nit: should this be min_segment_rows ... instead of size?", "author": "suneet-s", "createdAt": "2020-10-12T23:02:06Z", "path": "web-console/src/views/datasource-view/datasource-view.tsx", "diffHunk": "@@ -144,42 +144,41 @@ function progress(done: number, awaiting: number): number {\n \n const PERCENT_BRACES = [formatPercent(1)];\n \n-interface Datasource {\n-  datasource: string;\n-  rules: Rule[];\n-  compactionConfig?: CompactionConfig;\n-  compactionStatus?: CompactionStatus;\n-  [key: string]: any;\n+interface DatasourceQueryResultRow {\n+  readonly datasource: string;\n+  readonly num_segments: number;\n+  readonly num_available_segments: number;\n+  readonly num_segments_to_load: number;\n+  readonly num_segments_to_drop: number;\n+  readonly total_data_size: number;\n+  readonly replicated_size: number;\n+  readonly min_segment_size: number;\n+  readonly avg_segment_size: number;\n+  readonly max_segment_size: number;", "originalCommit": "426b68fb8b8ff5f3fdf35e3bd687639fa14d58d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA4MzYxOA==", "url": "https://github.com/apache/druid/pull/10496#discussion_r504083618", "bodyText": "fixed", "author": "vogievetsky", "createdAt": "2020-10-13T16:17:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3NjMyNQ=="}], "type": "inlineReview"}, {"oid": "e5e29a5a6a6ca3e2ba7788ed8fede494e73082db", "url": "https://github.com/apache/druid/commit/e5e29a5a6a6ca3e2ba7788ed8fede494e73082db", "message": "add .druid.pid to gitignore", "committedDate": "2020-10-13T16:01:43Z", "type": "commit"}, {"oid": "5726fabf695b775701d1d80cb969543971bc2100", "url": "https://github.com/apache/druid/commit/5726fabf695b775701d1d80cb969543971bc2100", "message": "rename segment_size to segment_rows, fix visability, fix divide by zero", "committedDate": "2020-10-13T16:13:32Z", "type": "commit"}, {"oid": "080d49f8b2eaa02c3e028cff48caa1006bd6e03d", "url": "https://github.com/apache/druid/commit/080d49f8b2eaa02c3e028cff48caa1006bd6e03d", "message": "update snapshots", "committedDate": "2020-10-13T18:45:47Z", "type": "commit"}]}