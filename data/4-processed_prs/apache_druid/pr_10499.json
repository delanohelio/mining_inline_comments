{"pr_number": 10499, "pr_title": "support for vectorizing expressions with non-existent inputs, more consistent type handling for non-vectorized expressions", "pr_createdAt": "2020-10-09T20:06:51Z", "pr_url": "https://github.com/apache/druid/pull/10499", "timeline": [{"oid": "d3c3347b3cf2c9e3c48b2011f6b6da2ade11179c", "url": "https://github.com/apache/druid/commit/d3c3347b3cf2c9e3c48b2011f6b6da2ade11179c", "message": "support for vectorizing expressions with non-existent inputs, more consistent type handling for non-vectorized expressions", "committedDate": "2020-10-09T18:11:37Z", "type": "commit"}, {"oid": "24a0bebcdf7ab346dc8930e058eb7a552312297c", "url": "https://github.com/apache/druid/commit/24a0bebcdf7ab346dc8930e058eb7a552312297c", "message": "inspector", "committedDate": "2020-10-09T19:23:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5NDMzOQ==", "url": "https://github.com/apache/druid/pull/10499#discussion_r508194339", "bodyText": "What do result and other mean?", "author": "jihoonson", "createdAt": "2020-10-20T03:56:32Z", "path": "core/src/main/java/org/apache/druid/math/expr/ExprTypeConversion.java", "diffHunk": "@@ -31,22 +31,40 @@\n    * Infer the output type of a list of possible 'conditional' expression outputs (where any of these could be the\n    * output expression if the corresponding case matching expression evaluates to true)\n    */\n-  static ExprType conditional(Expr.InputBindingTypes inputTypes, List<Expr> args)\n+  static ExprType conditional(Expr.InputBindingInspector inspector, List<Expr> args)\n   {\n     ExprType type = null;\n     for (Expr arg : args) {\n       if (arg.isNullLiteral()) {\n         continue;\n       }\n       if (type == null) {\n-        type = arg.getOutputType(inputTypes);\n+        type = arg.getOutputType(inspector);\n       } else {\n-        type = doubleMathFunction(type, arg.getOutputType(inputTypes));\n+        type = function(type, arg.getOutputType(inspector));\n       }\n     }\n     return type;\n   }\n \n+  /**\n+   * Given 2 'input' types, which might not be fully trustable, choose the most appropriate combined type for\n+   * non-vectorized, per-row type detection. In this mode, null values are {@link ExprType#STRING} typed, despite\n+   * potentially coming from an underlying numeric column. This method is not well suited for array handling\n+   */\n+  public static ExprType autoDetect(ExprEval result, ExprEval other)", "originalCommit": "24a0bebcdf7ab346dc8930e058eb7a552312297c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgwMDA5MA==", "url": "https://github.com/apache/druid/pull/10499#discussion_r508800090", "bodyText": "ah those are not very good variable names, eval and otherEval probably would've been better", "author": "clintropolis", "createdAt": "2020-10-20T19:56:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5NDMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxNDY3OQ==", "url": "https://github.com/apache/druid/pull/10499#discussion_r510514679", "bodyText": "Can you add a part to the javadoc about when the input types would not be trustable (is it because of the string nulls from numeric columns, or are there other cases)?", "author": "jon-wei", "createdAt": "2020-10-22T23:35:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5NDMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU4NTI5OQ==", "url": "https://github.com/apache/druid/pull/10499#discussion_r510585299", "bodyText": "Can you add a part to the javadoc about when the input types would not be trustable (is it because of the string nulls from numeric columns, or are there other cases)?\n\nI have this blurb:\n\nIn this mode, null values are {@link ExprType#STRING} typed, despite potentially coming from an underlying numeric column\n\nbut I have added the missing column case too", "author": "clintropolis", "createdAt": "2020-10-23T04:23:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5NDMzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxNDIxMA==", "url": "https://github.com/apache/druid/pull/10499#discussion_r510514210", "bodyText": "Can you update the javadoc for this method with the mixed type case and the reasoning behind preferring the non-string type?", "author": "jon-wei", "createdAt": "2020-10-22T23:33:55Z", "path": "core/src/main/java/org/apache/druid/math/expr/ExprTypeConversion.java", "diffHunk": "@@ -74,6 +93,15 @@ public static ExprType operator(@Nullable ExprType type, @Nullable ExprType othe\n       return ExprType.STRING;\n     }\n \n+    // non-vectorized expressions\n+    if (type == ExprType.STRING) {", "originalCommit": "24a0bebcdf7ab346dc8930e058eb7a552312297c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU4NTIwNw==", "url": "https://github.com/apache/druid/pull/10499#discussion_r510585207", "bodyText": "Oh, this check isn't actually necessary anymore, it was from an intermediary state this branch was in prior to adding the autoDetect function when I was instead trying to use this in the eval of operator expressions.", "author": "clintropolis", "createdAt": "2020-10-23T04:22:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUxNDIxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUyNDExNg==", "url": "https://github.com/apache/druid/pull/10499#discussion_r510524116", "bodyText": "shoulComputeOutput -> shouldComputeOutput", "author": "jon-wei", "createdAt": "2020-10-22T23:59:57Z", "path": "processing/src/main/java/org/apache/druid/segment/virtual/ExpressionPlanner.java", "diffHunk": "@@ -135,18 +137,29 @@ public static ExpressionPlan plan(ColumnInspector inspector, Expr expression)\n         traits.add(ExpressionPlan.Trait.NON_SCALAR_INPUTS);\n       }\n \n-      if (!maybeMultiValued.isEmpty()) {\n+      if (!noCapabilities.isEmpty()) {\n         traits.add(ExpressionPlan.Trait.UNKNOWN_INPUTS);\n       }\n \n+      if (!maybeMultiValued.isEmpty()) {\n+        traits.add(ExpressionPlan.Trait.INCOMPLETE_INPUTS);\n+      }\n+\n       // if expression needs transformed, lets do it\n       if (!needsApplied.isEmpty()) {\n         traits.add(ExpressionPlan.Trait.NEEDS_APPLIED);\n       }\n     }\n \n-    // only set output type\n-    if (ExpressionPlan.none(traits, ExpressionPlan.Trait.UNKNOWN_INPUTS, ExpressionPlan.Trait.NEEDS_APPLIED)) {\n+    // only set output type if we are pretty confident about input types\n+    final boolean shoulComputeOutput = ExpressionPlan.none(", "originalCommit": "24a0bebcdf7ab346dc8930e058eb7a552312297c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a537344c7fb3718f7a77110e7a45332535c21e23", "url": "https://github.com/apache/druid/commit/a537344c7fb3718f7a77110e7a45332535c21e23", "message": "Merge remote-tracking branch 'upstream/master' into vector-nil-expr", "committedDate": "2020-10-23T03:40:25Z", "type": "commit"}, {"oid": "5acd0f03ddd51326edb1d0c54608e242067bd3aa", "url": "https://github.com/apache/druid/commit/5acd0f03ddd51326edb1d0c54608e242067bd3aa", "message": "changes", "committedDate": "2020-10-23T04:12:55Z", "type": "commit"}, {"oid": "06b233c99269f3f19194dbbcaad6d888ac53c91e", "url": "https://github.com/apache/druid/commit/06b233c99269f3f19194dbbcaad6d888ac53c91e", "message": "more test", "committedDate": "2020-10-23T04:21:04Z", "type": "commit"}, {"oid": "6a58eb31d7fe76f7f66844ab2f9c47b284652eb8", "url": "https://github.com/apache/druid/commit/6a58eb31d7fe76f7f66844ab2f9c47b284652eb8", "message": "clean", "committedDate": "2020-10-23T04:22:14Z", "type": "commit"}]}