{"pr_number": 10714, "pr_title": "use actual dataInterval in cache key", "pr_createdAt": "2020-12-29T10:22:04Z", "pr_url": "https://github.com/apache/druid/pull/10714", "timeline": [{"oid": "8836c9f478eb6f49da3a5ef59c7d8d44fe30ee3d", "url": "https://github.com/apache/druid/commit/8836c9f478eb6f49da3a5ef59c7d8d44fe30ee3d", "message": "use actual dataInterval in cache key", "committedDate": "2020-12-29T10:16:19Z", "type": "commit"}, {"oid": "27f50085539debe32bfdce0141aa6487ab736ba2", "url": "https://github.com/apache/druid/commit/27f50085539debe32bfdce0141aa6487ab736ba2", "message": "fix ut fail", "committedDate": "2020-12-30T13:05:10Z", "type": "commit"}, {"oid": "27f50085539debe32bfdce0141aa6487ab736ba2", "url": "https://github.com/apache/druid/commit/27f50085539debe32bfdce0141aa6487ab736ba2", "message": "fix ut fail", "committedDate": "2020-12-30T13:05:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc1NTY2Nw==", "url": "https://github.com/apache/druid/pull/10714#discussion_r553755667", "bodyText": "I think there's an off by one here: storageAdapter.getMaxTime() is the highest timestamp in the segment, but the end of actualDataInterval is exclusive, and so it doesn't include that highest timestamp. I think doing segmentMaxTime.plus(1) will fix it. There's a similar issue in ServerManager.", "author": "gianm", "createdAt": "2021-01-08T05:53:15Z", "path": "server/src/main/java/org/apache/druid/segment/realtime/appenderator/SinkQuerySegmentWalker.java", "diffHunk": "@@ -230,10 +232,15 @@ public SinkQuerySegmentWalker(\n                       // 1) Only use caching if data is immutable\n                       // 2) Hydrants are not the same between replicas, make sure cache is local\n                       if (hydrantDefinitelySwapped && cache.isLocal()) {\n+                        StorageAdapter storageAdapter = segmentAndCloseable.lhs.asStorageAdapter();\n+                        long segmentMinTime = storageAdapter.getMinTime().getMillis();\n+                        long segmentMaxTime = storageAdapter.getMaxTime().getMillis();\n+                        Interval actualDataInterval = Intervals.utc(segmentMinTime, segmentMaxTime);", "originalCommit": "27f50085539debe32bfdce0141aa6487ab736ba2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjM2MjczMQ==", "url": "https://github.com/apache/druid/pull/10714#discussion_r556362731", "bodyText": "yes, you are right, will fix it", "author": "kaijianding", "createdAt": "2021-01-13T09:04:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc1NTY2Nw=="}], "type": "inlineReview"}, {"oid": "fee9798ca623c5edb2391b35effd98c382227a4c", "url": "https://github.com/apache/druid/commit/fee9798ca623c5edb2391b35effd98c382227a4c", "message": "fix segmentMaxTime exclusive", "committedDate": "2021-01-13T09:13:26Z", "type": "commit"}]}