{"pr_number": 10686, "pr_title": "k8s-int-test-build: zk-less druid cluster and http based segment/task managment", "pr_createdAt": "2020-12-17T00:06:40Z", "pr_url": "https://github.com/apache/druid/pull/10686", "timeline": [{"oid": "107bcc6cdacf3a11efad31d2324eb420fe57c29a", "url": "https://github.com/apache/druid/commit/107bcc6cdacf3a11efad31d2324eb420fe57c29a", "message": "zk-less druid cluster in k8s build", "committedDate": "2020-12-17T00:03:22Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "04c488e52c98a49107eeff586c81b838ee69110f", "url": "https://github.com/apache/druid/commit/04c488e52c98a49107eeff586c81b838ee69110f", "message": "attempt to fix build and use http based remote task management", "committedDate": "2020-12-17T16:44:52Z", "type": "commit"}, {"oid": "04c488e52c98a49107eeff586c81b838ee69110f", "url": "https://github.com/apache/druid/commit/04c488e52c98a49107eeff586c81b838ee69110f", "message": "attempt to fix build and use http based remote task management", "committedDate": "2020-12-17T16:44:52Z", "type": "forcePushed"}, {"oid": "d8f3f2177c4ee6c9fe63b0bf143fe89995afbb20", "url": "https://github.com/apache/druid/commit/d8f3f2177c4ee6c9fe63b0bf143fe89995afbb20", "message": "mm/router logs for debugging", "committedDate": "2020-12-17T22:55:39Z", "type": "commit"}, {"oid": "b769b0e961dfae401820102d38a56bf87f5a448a", "url": "https://github.com/apache/druid/commit/b769b0e961dfae401820102d38a56bf87f5a448a", "message": "add default account k8s role and binding for pod, configMap access", "committedDate": "2020-12-18T21:33:31Z", "type": "commit"}, {"oid": "b769b0e961dfae401820102d38a56bf87f5a448a", "url": "https://github.com/apache/druid/commit/b769b0e961dfae401820102d38a56bf87f5a448a", "message": "add default account k8s role and binding for pod, configMap access", "committedDate": "2020-12-18T21:33:31Z", "type": "forcePushed"}, {"oid": "d17489c358588dff678b4a08c9eb2cdb0e9fe175", "url": "https://github.com/apache/druid/commit/d17489c358588dff678b4a08c9eb2cdb0e9fe175", "message": "fix issue", "committedDate": "2020-12-18T23:30:48Z", "type": "commit"}, {"oid": "263dd77e4d4663fc39a8446711996a879ecfbd3d", "url": "https://github.com/apache/druid/commit/263dd77e4d4663fc39a8446711996a879ecfbd3d", "message": "change router port to 8088 for common readinessProbe", "committedDate": "2020-12-19T13:34:57Z", "type": "commit"}, {"oid": "f8bb7b119583e3c483e7034bba654364f3988f97", "url": "https://github.com/apache/druid/commit/f8bb7b119583e3c483e7034bba654364f3988f97", "message": "break build_run_k8s_cluster.sh into separate scripts", "committedDate": "2020-12-19T15:23:55Z", "type": "commit"}, {"oid": "a0d43c722aa2413b82fece8ca641fbb274775ac1", "url": "https://github.com/apache/druid/commit/a0d43c722aa2413b82fece8ca641fbb274775ac1", "message": "revert changes to K8sDruidNodeAnnouncer.java", "committedDate": "2020-12-19T15:24:40Z", "type": "commit"}, {"oid": "d1debfff434fa8360575e867dab3524606bb4e2b", "url": "https://github.com/apache/druid/commit/d1debfff434fa8360575e867dab3524606bb4e2b", "message": "k8s extension doc update", "committedDate": "2020-12-19T15:43:01Z", "type": "commit"}, {"oid": "32277c770f322963553585fefea86ae59583d7c0", "url": "https://github.com/apache/druid/commit/32277c770f322963553585fefea86ae59583d7c0", "message": "add license to new file", "committedDate": "2020-12-19T20:08:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5NTcxNQ==", "url": "https://github.com/apache/druid/pull/10686#discussion_r546495715", "bodyText": "Just curious. Which kind of druid server needs these add labels to self-pod, List and Watch other Pods, create ConfigMap permissions? MiddleManager or all the druid servers.", "author": "zhangyue19921010", "createdAt": "2020-12-21T03:49:18Z", "path": "docs/development/extensions-core/kubernetes.md", "diffHunk": "@@ -57,3 +55,34 @@ Additionally, this extension has following configuration.\n |`druid.discovery.k8s.renewDeadline`|`Duration`|Lease renewal period used by Leader.|PT17S|No|\n |`druid.discovery.k8s.retryPeriod`|`Duration`|Retry wait used by Leader Election algorithm on failed operations.|PT5S|No|\n \n+### Gotchas\n+\n+- Label/Annotation path in each pod spec MUST EXIST, which is easily satisfied if there is at least one label/annotation in the pod spec already. This limitation may be removed in future.\n+- Druid Pods need permissions to be able to add labels to self-pod, List and Watch other Pods, create ConfigMap for leader election. Assuming, \"default\" service account is used by Druid pods, you might need to add following or something similar Kubernetes Role and Role Binding.", "originalCommit": "32277c770f322963553585fefea86ae59583d7c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQxODIzNg==", "url": "https://github.com/apache/druid/pull/10686#discussion_r549418236", "bodyText": "everyone needs pod list/update .\ncreate/update ConfigMap is needed only by coordinators/overlords which participate in leader election ... but read ConfigMap is needed by all so as to know who the leader is. That said, I haven't tested such granularity and would just give same permission to all pods.", "author": "himanshug", "createdAt": "2020-12-28T17:06:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5NTcxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5NTgwNQ==", "url": "https://github.com/apache/druid/pull/10686#discussion_r546495805", "bodyText": "nit: /usr/local/bin/kubectl could be replaced by $KUBECTL. The same as sudo /usr/local/bin/kubectl get svc", "author": "zhangyue19921010", "createdAt": "2020-12-21T03:49:49Z", "path": "integration-tests/script/setup_druid_on_k8s.sh", "diffHunk": "@@ -0,0 +1,54 @@\n+#!/usr/bin/env bash\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+set -e\n+\n+export KUBECTL=\"sudo /usr/local/bin/kubectl\"\n+\n+# setup client keystore\n+cd integration-tests\n+./docker/tls/generate-client-certs-and-keystores.sh\n+rm -rf docker/client_tls\n+cp -r client_tls docker/client_tls\n+cd ..\n+\n+# Build Docker images for pods\n+mvn -B -ff -q dependency:go-offline \\\n+      install \\\n+      -Pdist,bundle-contrib-exts \\\n+      -Pskip-static-checks,skip-tests \\\n+      -Dmaven.javadoc.skip=true\n+\n+docker build -t druid/cluster:v1 -f distribution/docker/DockerfileBuildTarAdvanced .\n+\n+# This tmp dir is used for MiddleManager pod and Historical Pod to cache segments.\n+mkdir tmp\n+chmod 777 tmp\n+\n+$KUBECTL apply -f integration-tests/k8s/role-and-binding.yaml\n+sed -i \"s|REPLACE_VOLUMES|`pwd`|g\" integration-tests/k8s/tiny-cluster.yaml\n+$KUBECTL apply -f integration-tests/k8s/tiny-cluster.yaml\n+\n+# Wait 4 * 15 seconds to launch pods.\n+#count=0\n+#JSONPATH='{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}'; until sudo /usr/local/bin/kubectl -n default get pods -lapp=travis-example -o jsonpath=\"$JSONPATH\" 2>&1 | grep -q \"Ready=True\"; do sleep 4;if [ $count -eq 15 ];then break 2 ;else let \"count++\";fi;echo $i;echo \"waiting for travis-example deployment to be available\"; sudo /usr/local/bin/kubectl get pods -n default; done\n+sleep 120\n+\n+## Debug And FastFail\n+\n+sudo /usr/local/bin/kubectl get pod", "originalCommit": "32277c770f322963553585fefea86ae59583d7c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQxODI4MA==", "url": "https://github.com/apache/druid/pull/10686#discussion_r549418280", "bodyText": "changed", "author": "himanshug", "createdAt": "2020-12-28T17:06:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5NTgwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5NTkwNw==", "url": "https://github.com/apache/druid/pull/10686#discussion_r546495907", "bodyText": "nit: It seems that export KUBECTL=\"sudo /usr/local/bin/kubectl\" is never used in setup_k8s_cluster.sh . Maybe can be removed?", "author": "zhangyue19921010", "createdAt": "2020-12-21T03:50:25Z", "path": "integration-tests/script/setup_k8s_cluster.sh", "diffHunk": "@@ -0,0 +1,35 @@\n+#!/usr/bin/env bash\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+set -e\n+\n+# Set Necessary ENV\n+export CHANGE_MINIKUBE_NONE_USER=true\n+export MINIKUBE_WANTUPDATENOTIFICATION=false\n+export MINIKUBE_WANTREPORTERRORPROMPT=false\n+export MINIKUBE_HOME=$HOME\n+export KUBECONFIG=$HOME/.kube/config\n+export KUBECTL=\"sudo /usr/local/bin/kubectl\"", "originalCommit": "32277c770f322963553585fefea86ae59583d7c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQxODMzNQ==", "url": "https://github.com/apache/druid/pull/10686#discussion_r549418335", "bodyText": "changed", "author": "himanshug", "createdAt": "2020-12-28T17:06:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ5NTkwNw=="}], "type": "inlineReview"}, {"oid": "a69f199064ecaeb8a9182183b1f9dbc4355e85c5", "url": "https://github.com/apache/druid/commit/a69f199064ecaeb8a9182183b1f9dbc4355e85c5", "message": "address review comments", "committedDate": "2020-12-28T17:03:48Z", "type": "commit"}, {"oid": "f6fd694d2e7a2a1ac186eb413ccfdeec86cfbe10", "url": "https://github.com/apache/druid/commit/f6fd694d2e7a2a1ac186eb413ccfdeec86cfbe10", "message": "do not try to load lookups at startup to improve cluster startup time", "committedDate": "2021-01-05T21:41:16Z", "type": "commit"}]}