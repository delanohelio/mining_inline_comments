{"pr_number": 10285, "pr_title": "Add note about aggregations on floats", "pr_createdAt": "2020-08-14T18:23:30Z", "pr_url": "https://github.com/apache/druid/pull/10285", "timeline": [{"oid": "faba13870535b0dcf92c7ce952a4e74657c53878", "url": "https://github.com/apache/druid/commit/faba13870535b0dcf92c7ce952a4e74657c53878", "message": "Add note about aggreations on floats\n\nFloating point math is known to be unstable. Due to the way aggregators work\nacross segments it's possible for the same query operating on the same data to\nproduce slightly different results.\n\nThe same problem exists with any aggregators that are not commutative since\nthe merge order across segments is not guaranteed.", "committedDate": "2020-08-14T18:22:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgwOTQwNg==", "url": "https://github.com/apache/druid/pull/10285#discussion_r470809406", "bodyText": "Similar comment.", "author": "gianm", "createdAt": "2020-08-14T18:49:49Z", "path": "docs/querying/sql.md", "diffHunk": "@@ -232,6 +232,10 @@ possible for two aggregators in the same SQL query to have different filters.\n \n Only the COUNT aggregation can accept DISTINCT.\n \n+> The order of aggregation operations across segments is not deterministic. This means that non-commutative aggregation\n+> functions can produce inconsistent results across the same query. Any functions that operate on an input type of \"float\"\n+> may also see these differences in aggregation results across multiple query runs.", "originalCommit": "faba13870535b0dcf92c7ce952a4e74657c53878", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgwOTUxNg==", "url": "https://github.com/apache/druid/pull/10285#discussion_r470809516", "bodyText": "Double and float are both floating-point, so should behave the same way in this regard.", "author": "gianm", "createdAt": "2020-08-14T18:50:02Z", "path": "docs/development/extensions-core/stats.md", "diffHunk": "@@ -44,6 +44,13 @@ This algorithm was proven to be numerically stable by J.L. Barlow in\n \"Error analysis of a pairwise summation algorithm to compute sample variance\"\n Numer. Math, 58 (1991) pp. 583--590\n \n+> As with all [aggregators](../../querying/sql.md#aggregation-functions), the order of operations across segments is\n+> non-deterministic. This means that if this aggregator is used with an input type of \"float\", the result of the\n+> aggregation will not be precisely the same across multiple runs of the query.\n+>\n+> To produce consistent results, either cast the input type to a \"double\" or round the variance to", "originalCommit": "faba13870535b0dcf92c7ce952a4e74657c53878", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "363feb69743d71b3fb2e59af71bb92c65de4623b", "url": "https://github.com/apache/druid/commit/363feb69743d71b3fb2e59af71bb92c65de4623b", "message": "Also talk about doubles", "committedDate": "2020-08-14T23:05:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2MDg1OA==", "url": "https://github.com/apache/druid/pull/10285#discussion_r471660858", "bodyText": "operates -> operate", "author": "jon-wei", "createdAt": "2020-08-17T17:52:46Z", "path": "docs/querying/sql.md", "diffHunk": "@@ -232,6 +232,13 @@ possible for two aggregators in the same SQL query to have different filters.\n \n Only the COUNT aggregation can accept DISTINCT.\n \n+> The order of aggregation operations across segments is not deterministic. This means that non-commutative aggregation\n+> functions can produce inconsistent results across the same query. \n+>\n+> Functions that operates on an input type of \"float\" or \"double\" may also see these differences in aggregation", "originalCommit": "363feb69743d71b3fb2e59af71bb92c65de4623b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2NTk1Ng==", "url": "https://github.com/apache/druid/pull/10285#discussion_r471665956", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            > Functions that operates on an input type of \"float\" or \"double\" may also see these differences in aggregation\n          \n          \n            \n            > Functions that operate on an input type of \"float\" or \"double\" may also see these differences in aggregation", "author": "suneet-s", "createdAt": "2020-08-17T18:02:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2MDg1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2MTM4NQ==", "url": "https://github.com/apache/druid/pull/10285#discussion_r471661385", "bodyText": "Suggest \"may\" instead of \"will\"", "author": "jon-wei", "createdAt": "2020-08-17T17:53:52Z", "path": "docs/development/extensions-core/stats.md", "diffHunk": "@@ -44,6 +44,13 @@ This algorithm was proven to be numerically stable by J.L. Barlow in\n \"Error analysis of a pairwise summation algorithm to compute sample variance\"\n Numer. Math, 58 (1991) pp. 583--590\n \n+> As with all [aggregators](../../querying/sql.md#aggregation-functions), the order of operations across segments is\n+> non-deterministic. This means that if this aggregator operates with an input type of \"float\" or \"double\", the result\n+> of the aggregation will not be precisely the same across multiple runs of the query.", "originalCommit": "363feb69743d71b3fb2e59af71bb92c65de4623b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2NTgyNw==", "url": "https://github.com/apache/druid/pull/10285#discussion_r471665827", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            > of the aggregation will not be precisely the same across multiple runs of the query.\n          \n          \n            \n            > of the aggregation may not be precisely the same across multiple runs of the query.", "author": "suneet-s", "createdAt": "2020-08-17T18:01:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2MTM4NQ=="}], "type": "inlineReview"}, {"oid": "e0deb1eb1f6d0e9e55946a4d54524b57773dbd82", "url": "https://github.com/apache/druid/commit/e0deb1eb1f6d0e9e55946a4d54524b57773dbd82", "message": "Apply suggestions from code review", "committedDate": "2020-08-17T18:02:26Z", "type": "commit"}]}