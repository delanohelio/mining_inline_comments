{"pr_number": 9183, "pr_title": "fix topn aggregation on numeric columns with null values", "pr_createdAt": "2020-01-14T10:15:56Z", "pr_url": "https://github.com/apache/druid/pull/9183", "timeline": [{"oid": "ae47598b211d8dccbe6eb919177347a9e0e90df2", "url": "https://github.com/apache/druid/commit/ae47598b211d8dccbe6eb919177347a9e0e90df2", "message": "fix topn issue with aggregating on numeric columns with null values", "committedDate": "2020-01-14T10:08:43Z", "type": "commit"}, {"oid": "c6927517bc6848ccd6a1cc3341586fad8d6dc318", "url": "https://github.com/apache/druid/commit/c6927517bc6848ccd6a1cc3341586fad8d6dc318", "message": "adjustments", "committedDate": "2020-01-16T11:26:29Z", "type": "commit"}, {"oid": "7f91915fef820e3c2d647e81ef5d92dc3f942ebf", "url": "https://github.com/apache/druid/commit/7f91915fef820e3c2d647e81ef5d92dc3f942ebf", "message": "Merge remote-tracking branch 'upstream/master' into topn-agg-numeric-null-columns", "committedDate": "2020-01-16T22:44:08Z", "type": "commit"}, {"oid": "515af98ae6a366028cdcefb554d42294bc46d034", "url": "https://github.com/apache/druid/commit/515af98ae6a366028cdcefb554d42294bc46d034", "message": "rename", "committedDate": "2020-01-16T22:44:22Z", "type": "commit"}, {"oid": "777bf78b02241314f609feb192502eb03146b1b6", "url": "https://github.com/apache/druid/commit/777bf78b02241314f609feb192502eb03146b1b6", "message": "add more tests", "committedDate": "2020-01-17T01:47:38Z", "type": "commit"}, {"oid": "ac2d66ee6aeab38263bd6f4ef276d4522140964e", "url": "https://github.com/apache/druid/commit/ac2d66ee6aeab38263bd6f4ef276d4522140964e", "message": "fix comments", "committedDate": "2020-01-17T02:40:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc0ODY3Nw==", "url": "https://github.com/apache/druid/pull/9183#discussion_r367748677", "bodyText": "I think the initAggregateStore call could be moved into HeapBasedTopNAlgorithm.scanAndAggregate since both impls call it as the first step", "author": "jon-wei", "createdAt": "2020-01-17T02:56:05Z", "path": "processing/src/main/java/org/apache/druid/query/topn/types/NullableNumericTopNColumnAggregatesProcessor.java", "diffHunk": "@@ -0,0 +1,137 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.query.topn.types;\n+\n+import org.apache.druid.common.config.NullHandling;\n+import org.apache.druid.query.aggregation.Aggregator;\n+import org.apache.druid.query.topn.BaseTopNAlgorithm;\n+import org.apache.druid.query.topn.TopNParams;\n+import org.apache.druid.query.topn.TopNQuery;\n+import org.apache.druid.query.topn.TopNResultBuilder;\n+import org.apache.druid.segment.BaseNullableColumnValueSelector;\n+import org.apache.druid.segment.Cursor;\n+import org.apache.druid.segment.StorageAdapter;\n+\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+public abstract class NullableNumericTopNColumnAggregatesProcessor<Selector extends BaseNullableColumnValueSelector>\n+    implements TopNColumnAggregatesProcessor<Selector>\n+{\n+  private final boolean hasNulls = !NullHandling.replaceWithDefault();\n+  final Function<Object, Comparable<?>> converter;\n+  Aggregator[] nullValueAggregates;\n+\n+  protected NullableNumericTopNColumnAggregatesProcessor(Function<Object, Comparable<?>> converter)\n+  {\n+    this.converter = converter;\n+  }\n+\n+  abstract Aggregator[] getValueAggregators(TopNQuery query, Selector selector, Cursor cursor);\n+\n+  abstract Map<?, Aggregator[]> getAggregatesStore();\n+\n+  abstract Comparable<?> convertAggregatorStoreKeyToColumnValue(Object aggregatorStoreKey);\n+\n+  @Override\n+  public int getCardinality(Selector selector)\n+  {\n+    return TopNParams.CARDINALITY_UNKNOWN;\n+  }\n+\n+  @Override\n+  public Aggregator[][] getRowSelector(TopNQuery query, TopNParams params, StorageAdapter storageAdapter)\n+  {\n+    return null;\n+  }\n+\n+  @Override\n+  public long scanAndAggregate(\n+      TopNQuery query,\n+      Selector selector,\n+      Cursor cursor,\n+      Aggregator[][] rowSelector\n+  )\n+  {\n+    initAggregateStore();", "originalCommit": "ac2d66ee6aeab38263bd6f4ef276d4522140964e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc0ODk1MQ==", "url": "https://github.com/apache/druid/pull/9183#discussion_r367748951", "bodyText": "Can you add javadocs for the abstract methods?", "author": "jon-wei", "createdAt": "2020-01-17T02:57:49Z", "path": "processing/src/main/java/org/apache/druid/query/topn/types/NullableNumericTopNColumnAggregatesProcessor.java", "diffHunk": "@@ -0,0 +1,137 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.query.topn.types;\n+\n+import org.apache.druid.common.config.NullHandling;\n+import org.apache.druid.query.aggregation.Aggregator;\n+import org.apache.druid.query.topn.BaseTopNAlgorithm;\n+import org.apache.druid.query.topn.TopNParams;\n+import org.apache.druid.query.topn.TopNQuery;\n+import org.apache.druid.query.topn.TopNResultBuilder;\n+import org.apache.druid.segment.BaseNullableColumnValueSelector;\n+import org.apache.druid.segment.Cursor;\n+import org.apache.druid.segment.StorageAdapter;\n+\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+public abstract class NullableNumericTopNColumnAggregatesProcessor<Selector extends BaseNullableColumnValueSelector>\n+    implements TopNColumnAggregatesProcessor<Selector>\n+{\n+  private final boolean hasNulls = !NullHandling.replaceWithDefault();\n+  final Function<Object, Comparable<?>> converter;\n+  Aggregator[] nullValueAggregates;\n+\n+  protected NullableNumericTopNColumnAggregatesProcessor(Function<Object, Comparable<?>> converter)\n+  {\n+    this.converter = converter;\n+  }\n+\n+  abstract Aggregator[] getValueAggregators(TopNQuery query, Selector selector, Cursor cursor);", "originalCommit": "ac2d66ee6aeab38263bd6f4ef276d4522140964e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6130e6a5ca196644aa59f0e0708437c93699e089", "url": "https://github.com/apache/druid/commit/6130e6a5ca196644aa59f0e0708437c93699e089", "message": "more javadocs", "committedDate": "2020-01-17T03:05:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNDI2NQ==", "url": "https://github.com/apache/druid/pull/9183#discussion_r368104265", "bodyText": "nit: I wish someday we could remove duplicate static values for this..", "author": "jihoonson", "createdAt": "2020-01-17T19:39:51Z", "path": "processing/src/main/java/org/apache/druid/query/topn/BaseTopNAlgorithm.java", "diffHunk": "@@ -79,7 +78,7 @@ public void run(\n       @Nullable TopNQueryMetrics queryMetrics\n   )\n   {\n-    if (params.getCardinality() != TopNColumnSelectorStrategy.CARDINALITY_UNKNOWN) {\n+    if (params.getCardinality() != TopNParams.CARDINALITY_UNKNOWN) {", "originalCommit": "6130e6a5ca196644aa59f0e0708437c93699e089", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEyNjY3Mw==", "url": "https://github.com/apache/druid/pull/9183#discussion_r368126673", "bodyText": "I agree but do not want to settle this up in this PR, part of the problem is that different parts of the code use different values to indicate unknown cardinality...", "author": "clintropolis", "createdAt": "2020-01-17T20:39:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNDI2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNzc5OA==", "url": "https://github.com/apache/druid/pull/9183#discussion_r368107798", "bodyText": "nit: TopNColumnAggregatesProcessorFactory?", "author": "jihoonson", "createdAt": "2020-01-17T19:48:38Z", "path": "processing/src/main/java/org/apache/druid/query/topn/types/TopNColumnSelectorStrategyFactory.java", "diffHunk": "@@ -23,10 +23,14 @@\n import org.apache.druid.java.util.common.IAE;\n import org.apache.druid.query.dimension.ColumnSelectorStrategyFactory;\n import org.apache.druid.segment.ColumnValueSelector;\n+import org.apache.druid.segment.DimensionHandlerUtils;\n import org.apache.druid.segment.column.ColumnCapabilities;\n import org.apache.druid.segment.column.ValueType;\n \n-public class TopNColumnSelectorStrategyFactory implements ColumnSelectorStrategyFactory<TopNColumnSelectorStrategy>\n+import java.util.function.Function;\n+\n+public class TopNColumnSelectorStrategyFactory", "originalCommit": "6130e6a5ca196644aa59f0e0708437c93699e089", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODExMDEwNQ==", "url": "https://github.com/apache/druid/pull/9183#discussion_r368110105", "bodyText": "Probably better to use computeIfAbsent() since it computes hash less time.", "author": "jihoonson", "createdAt": "2020-01-17T19:54:19Z", "path": "processing/src/main/java/org/apache/druid/query/topn/types/LongTopNColumnAggregatesProcessor.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.query.topn.types;\n+\n+import it.unimi.dsi.fastutil.longs.Long2ObjectMap;\n+import it.unimi.dsi.fastutil.longs.Long2ObjectOpenHashMap;\n+import org.apache.druid.query.aggregation.Aggregator;\n+import org.apache.druid.query.topn.BaseTopNAlgorithm;\n+import org.apache.druid.query.topn.TopNQuery;\n+import org.apache.druid.segment.BaseLongColumnValueSelector;\n+import org.apache.druid.segment.Cursor;\n+\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+public class LongTopNColumnAggregatesProcessor\n+    extends NullableNumericTopNColumnAggregatesProcessor<BaseLongColumnValueSelector>\n+{\n+  private Long2ObjectMap<Aggregator[]> aggregatesStore;\n+\n+  public LongTopNColumnAggregatesProcessor(Function<Object, Comparable<?>> converter)\n+  {\n+    super(converter);\n+  }\n+\n+  @Override\n+  Aggregator[] getValueAggregators(TopNQuery query, BaseLongColumnValueSelector selector, Cursor cursor)\n+  {\n+    long key = selector.getLong();\n+    Aggregator[] aggs = aggregatesStore.get(key);", "originalCommit": "6130e6a5ca196644aa59f0e0708437c93699e089", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODExMzg0Nw==", "url": "https://github.com/apache/druid/pull/9183#discussion_r368113847", "bodyText": "Same for double and float types.", "author": "jihoonson", "createdAt": "2020-01-17T20:03:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODExMDEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEyNjM5OA==", "url": "https://github.com/apache/druid/pull/9183#discussion_r368126398", "bodyText": "Yeah, i thought about that but was too lazy and just copied the old codes, will change.", "author": "clintropolis", "createdAt": "2020-01-17T20:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODExMDEwNQ=="}], "type": "inlineReview"}, {"oid": "3c9778ffadfa3b97d076ff3f1ef39ad6ea123305", "url": "https://github.com/apache/druid/commit/3c9778ffadfa3b97d076ff3f1ef39ad6ea123305", "message": "computeIfAbsent", "committedDate": "2020-01-18T00:15:05Z", "type": "commit"}]}