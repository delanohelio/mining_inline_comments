{"pr_number": 10085, "pr_title": "Filter http requests by http method", "pr_createdAt": "2020-06-26T16:48:53Z", "pr_url": "https://github.com/apache/druid/pull/10085", "timeline": [{"oid": "01e2eff2cec4681d7ee741be6e400220c6a11af7", "url": "https://github.com/apache/druid/commit/01e2eff2cec4681d7ee741be6e400220c6a11af7", "message": "Filter http requests by http method\n\nAdd a config that allows a user which http methods to allow against their\nDruid server.\n\nDruid will only accept http requests with the method: GET, PUT, POST, DELETE\nand OPTIONS.\nIf a Druid admin wants to allow other methods, they can do so by using the\nServerConfig#allowedHttpMethods config.\n\nIf a Druid user would like to disallow OPTIONS, this can be done by changing\nthe AuthConfig#allowUnauthenticatedHttpOptions config", "committedDate": "2020-06-26T16:46:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMwNTU0Mw==", "url": "https://github.com/apache/druid/pull/10085#discussion_r446305543", "bodyText": "\"HTTP\" should be capitalized when it appears in normal text like this.", "author": "gianm", "createdAt": "2020-06-26T17:05:47Z", "path": "docs/configuration/index.md", "diffHunk": "@@ -1312,6 +1312,7 @@ Druid uses Jetty to serve HTTP requests.\n |`druid.server.http.maxQueryTimeout`|Maximum allowed value (in milliseconds) for `timeout` parameter. See [query-context](../querying/query-context.html) to know more about `timeout`. Query is rejected if the query context `timeout` is greater than this value. |Long.MAX_VALUE|\n |`druid.server.http.maxRequestHeaderSize`|Maximum size of a request header in bytes. Larger headers consume more memory and can make a server more vulnerable to denial of service attacks.|8 * 1024|\n |`druid.server.http.enableForwardedRequestCustomizer`|If enabled, adds Jetty ForwardedRequestCustomizer which reads X-Forwarded-* request headers to manipulate servlet request object when Druid is used behind a proxy.|false|\n+|`druid.server.http.allowedHttpMethods`|List of http methods allowed in addition to the ones needed by Druid. GET, PUT, POST, DELETE and OPTIONS are always allowed. `druid.auth.allowUnauthenticatedHttpOptions` can be used to disable the OPTIONS method.|[]|", "originalCommit": "01e2eff2cec4681d7ee741be6e400220c6a11af7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMwNjU5OQ==", "url": "https://github.com/apache/druid/pull/10085#discussion_r446306599", "bodyText": "A couple things about the design of the properties:\n\nI don't think Druid itself uses OPTIONS requests. AFAIK, they are only needed for people that are using CORS, which Druid doesn't support innately but can be supported through extensions: #6026. So, OPTIONS shouldn't be part of the \"always allowed\" list.\ndruid.auth.allowUnauthenticatedHttpOptions today can't be used to disable OPTIONS, it only controls whether or not it can be used without authentication.\n\nTaking these into account, I'd suggest designing and documenting them like this:\n\n\n\nProperty\nDescription\nDefault\n\n\n\n\ndruid.server.http.allowedHttpMethods\nList of HTTP methods that should be allowed in addition to the ones required by Druid APIs. Druid APIs require GET, PUT, POST, and DELETE, which are always allowed. This option is not useful unless you have installed an extension that needs these additional HTTP methods or that adds functionality related to CORS. None of Druid's bundled extensions require these methods.\n[]\n\n\ndruid.auth.allowUnauthenticatedHttpOptions\nIf true, allow HTTP OPTIONS requests by unauthenticated users. This is primarily useful for supporting CORS preflight requests, which Druid does not support directly, but which can be enabled using third-party extensions.Note that you must add \"OPTIONS\" to druid.server.http.allowedHttpMethods.Also note that disabling authentication checks for OPTIONS requests will allow unauthenticated users to determine what Druid endpoints are valid (by checking if the OPTIONS request returns a 200 instead of 404). Enabling this option will reveal information about server configuration, including information about what extensions are loaded, to unauthenticated users.\nfalse", "author": "gianm", "createdAt": "2020-06-26T17:08:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMwNTU0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ1MDk4Mg==", "url": "https://github.com/apache/druid/pull/10085#discussion_r446450982", "bodyText": "\ud83d\udc4d thanks for the suggestion. Done.", "author": "suneet-s", "createdAt": "2020-06-26T23:29:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMwNTU0Mw=="}], "type": "inlineReview"}, {"oid": "29c2a873635a93da365aba3174101ecfea7b8238", "url": "https://github.com/apache/druid/commit/29c2a873635a93da365aba3174101ecfea7b8238", "message": "Exclude OPTIONS from always supported HTTP methods\n\nAdd HEAD as an allowed method for web console e2e tests", "committedDate": "2020-06-27T00:21:42Z", "type": "commit"}, {"oid": "8ee669c0dfa40e17f228c49975899367b4fce0a8", "url": "https://github.com/apache/druid/commit/8ee669c0dfa40e17f228c49975899367b4fce0a8", "message": "Merge remote-tracking branch 'upstream/master' into jetty", "committedDate": "2020-06-27T01:10:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NDY5MQ==", "url": "https://github.com/apache/druid/pull/10085#discussion_r446474691", "bodyText": "nit (since not related to this PR): Can't you do a GET on /status/health?", "author": "maytasm", "createdAt": "2020-06-27T02:43:28Z", "path": "web-console/script/druid", "diffHunk": "@@ -73,10 +73,12 @@ function _build_distribution() {\n   _log \"Building druid distribution\"\n \n   (\n+    # Add HEAD as an allowed HTTP method since this is how we check when the Druid service is ready.", "originalCommit": "29c2a873635a93da365aba3174101ecfea7b8238", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ4NDE2OA==", "url": "https://github.com/apache/druid/pull/10085#discussion_r446484168", "bodyText": "I think this is checking to see if the web console is up. I'm not sure if a GET /status/health is equivalent. The nice side-benefit of this is I get an integration test for free \ud83d\ude07", "author": "suneet-s", "createdAt": "2020-06-27T04:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3NDY5MQ=="}], "type": "inlineReview"}, {"oid": "61b257be845a5c13796790bffdaee42210b12182", "url": "https://github.com/apache/druid/commit/61b257be845a5c13796790bffdaee42210b12182", "message": "fix docs", "committedDate": "2020-06-27T02:54:34Z", "type": "commit"}, {"oid": "d60f42e68150c328b19a18ef20adadfc75da0486", "url": "https://github.com/apache/druid/commit/d60f42e68150c328b19a18ef20adadfc75da0486", "message": "fix security IT", "committedDate": "2020-06-27T03:03:07Z", "type": "commit"}, {"oid": "a024e3c57ab9e8b0218e334a6065dfc5c62d15a3", "url": "https://github.com/apache/druid/commit/a024e3c57ab9e8b0218e334a6065dfc5c62d15a3", "message": "Actually fix the web console e2e tests", "committedDate": "2020-06-27T03:50:48Z", "type": "commit"}, {"oid": "f8029cf6a4f807f925e5f8367862782392cbb34d", "url": "https://github.com/apache/druid/commit/f8029cf6a4f807f925e5f8367862782392cbb34d", "message": "Ignore icode coverage for nitialization classes", "committedDate": "2020-06-29T18:03:01Z", "type": "commit"}, {"oid": "4b968ab8559573000de60ebbaa6716976b11c4ef", "url": "https://github.com/apache/druid/commit/4b968ab8559573000de60ebbaa6716976b11c4ef", "message": "Merge remote-tracking branch 'upstream/master' into jetty", "committedDate": "2020-06-29T18:03:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MzM1MQ==", "url": "https://github.com/apache/druid/pull/10085#discussion_r447163351", "bodyText": "This functionality isn't related to authentication. It would more properly belong in JettyServerInitUtils.", "author": "gianm", "createdAt": "2020-06-29T18:18:54Z", "path": "server/src/main/java/org/apache/druid/server/security/AuthenticationUtils.java", "diffHunk": "@@ -27,6 +27,16 @@\n \n public class AuthenticationUtils\n {\n+  public static void addAllowHttpMethodsFilter(ServletContextHandler root, List<String> allowedHttpMethods)", "originalCommit": "4b968ab8559573000de60ebbaa6716976b11c4ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzMTY2MA==", "url": "https://github.com/apache/druid/pull/10085#discussion_r447231660", "bodyText": "Done", "author": "suneet-s", "createdAt": "2020-06-29T20:24:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MzM1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NDAxMQ==", "url": "https://github.com/apache/druid/pull/10085#discussion_r447164011", "bodyText": "Very small nit: HttpMethod.OPTIONS is better than the bare string.", "author": "gianm", "createdAt": "2020-06-29T18:20:07Z", "path": "server/src/test/java/org/apache/druid/initialization/ServerConfigTest.java", "diffHunk": "@@ -51,13 +54,27 @@ public void testSerde() throws Exception\n         defaultConfig.getUnannouncePropagationDelay(),\n         defaultConfig.getInflateBufferSize(),\n         defaultConfig.getCompressionLevel(),\n-        true\n+        true,\n+        ImmutableList.of(\"OPTIONS\")", "originalCommit": "4b968ab8559573000de60ebbaa6716976b11c4ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzMTYxNA==", "url": "https://github.com/apache/druid/pull/10085#discussion_r447231614", "bodyText": "Done", "author": "suneet-s", "createdAt": "2020-06-29T20:24:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NDAxMQ=="}], "type": "inlineReview"}, {"oid": "857443866ff47feb034edea233db0548ca8ca828", "url": "https://github.com/apache/druid/commit/857443866ff47feb034edea233db0548ca8ca828", "message": "code review", "committedDate": "2020-06-29T20:38:28Z", "type": "commit"}]}