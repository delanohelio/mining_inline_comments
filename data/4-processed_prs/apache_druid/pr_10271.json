{"pr_number": 10271, "pr_title": "Web console: fix json input", "pr_createdAt": "2020-08-13T01:41:54Z", "pr_url": "https://github.com/apache/druid/pull/10271", "timeline": [{"oid": "78a035de284c940aa58a2faa503c5a02f6c23690", "url": "https://github.com/apache/druid/commit/78a035de284c940aa58a2faa503c5a02f6c23690", "message": "fix json input", "committedDate": "2020-08-13T01:27:51Z", "type": "commit"}, {"oid": "eff2956d828290e8ec02f6b8fb08569a8c7fdf91", "url": "https://github.com/apache/druid/commit/eff2956d828290e8ec02f6b8fb08569a8c7fdf91", "message": "tidy up", "committedDate": "2020-08-13T01:41:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk0MTk5Mg==", "url": "https://github.com/apache/druid/pull/10271#discussion_r469941992", "bodyText": "What's not the best about it and why is it good enough?", "author": "gianm", "createdAt": "2020-08-13T13:15:11Z", "path": "web-console/src/components/json-input/json-input.tsx", "diffHunk": "@@ -37,6 +38,17 @@ function stringifyJson(item: any): string {\n   }\n }\n \n+// Not the best way to check for deep equality but good enough for what we need", "originalCommit": "eff2956d828290e8ec02f6b8fb08569a8c7fdf91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA3MTQ1MA==", "url": "https://github.com/apache/druid/pull/10271#discussion_r470071450", "bodyText": "Here is an in depth look at it https://www.mattzeunert.com/2016/01/28/javascript-deep-equal.html\nTL;DR the method implemented here would not work for this case for example:\nJSON.stringify({a: 1, b: 2}) !== JSON.stringify({b: 2, a: 1})\nBut that is ok because in practice the object output from the JSON input will be the same it later gets back. And if that check fails the worst that will happen is that the cursor would jump. It is also hard to find a decent object deep-equals library that does not come with a bunch of dependencies (as it tries to do a 100% thorough job) and a lot of file size.", "author": "vogievetsky", "createdAt": "2020-08-13T16:21:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk0MTk5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk0MjYxNw==", "url": "https://github.com/apache/druid/pull/10271#discussion_r469942617", "bodyText": "My understanding is that these __snapshot__ files are automatically generated for testing purposes. @vogievetsky how would you suggest reviewing them?", "author": "gianm", "createdAt": "2020-08-13T13:16:08Z", "path": "web-console/src/components/auto-form/__snapshots__/auto-form.spec.tsx.snap", "diffHunk": "@@ -2,521 +2,135 @@\n \n exports[`auto-form snapshot matches snapshot 1`] = `\n <div\n-  class=\"auto-form\"", "originalCommit": "eff2956d828290e8ec02f6b8fb08569a8c7fdf91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA3NjI4NA==", "url": "https://github.com/apache/druid/pull/10271#discussion_r470076284", "bodyText": "That is correct.\nHere is how I review them:\nThe snapshot change is either tiny or structural (huge) there is no in between.\n\nIf the change is tiny:\n  Review the changed lines and understand what caused that change. Was a class or some other property added / removed? Does it make sense?\n\nIf the change is structural:\n  Do not review the individual lines, only review which snapshot files changed. Does it make sense that the snapshot of this component changed so drastically?\n\nIn this case all the changes are structural. I have wrapped the JSON Input in an extra div (for good reason) which causes all the snapshots of its inner workings to be indented by an extra level. This causes huge diffs. Seeing as I will have huge changed in these snapshots anyway I changed them to be shallow rendered (which they should have been from the start - but better late than never). This explains the structural nature of the change. You are free to comment on whether or not you think it is a good idea. (see below)", "author": "vogievetsky", "createdAt": "2020-08-13T16:28:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk0MjYxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk0MzA1Mw==", "url": "https://github.com/apache/druid/pull/10271#discussion_r469943053", "bodyText": "Is this also test code?", "author": "gianm", "createdAt": "2020-08-13T13:16:50Z", "path": "web-console/src/components/auto-form/auto-form.spec.tsx", "diffHunk": "@@ -16,14 +16,14 @@\n  * limitations under the License.\n  */\n \n-import { render } from '@testing-library/react';\n+import { shallow } from 'enzyme';", "originalCommit": "eff2956d828290e8ec02f6b8fb08569a8c7fdf91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA3Nzg1Nw==", "url": "https://github.com/apache/druid/pull/10271#discussion_r470077857", "bodyText": "Yup, this changes the virtual rendered from a DOM renderer import { render } from '@testing-library/react'; to a shallow react component level renderer import { shallow } from 'enzyme'; for the snapshots.\nThis change makes sense because the auto-form does not really make any of its own cool DOM it only assembles other components so testing their deep structure should not be its concern - otherwise it will have structural changes in the snapshots every-time someone changes the JSON Input", "author": "vogievetsky", "createdAt": "2020-08-13T16:31:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk0MzA1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2MTA3Mw==", "url": "https://github.com/apache/druid/pull/10271#discussion_r469961073", "bodyText": "\ud83d\ude31", "author": "gianm", "createdAt": "2020-08-13T13:43:28Z", "path": "web-console/src/components/json-input/json-input.tsx", "diffHunk": "@@ -48,52 +60,93 @@ interface JsonInputProps {\n \n export const JsonInput = React.memo(function JsonInput(props: JsonInputProps) {\n   const { onChange, placeholder, focus, width, height, value } = props;\n-  const stringifiedValue = stringifyJson(value);\n-  const [stringValue, setStringValue] = useState(stringifiedValue);\n-  const [blurred, setBlurred] = useState(false);\n-\n-  let parsedValue: any;\n-  try {\n-    parsedValue = parseHjson(stringValue);\n-  } catch {}\n-  if (typeof parsedValue !== 'object') parsedValue = undefined;\n+  const [internalValue, setInternalValue] = useState<InternalValue>(() => ({\n+    value,\n+    stringified: stringifyJson(value),\n+  }));\n+  const [showErrorIfNeeded, setShowErrorIfNeeded] = useState(false);\n+  const aceEditor = useRef<Editor | undefined>();\n \n-  if (parsedValue !== undefined && stringifyJson(parsedValue) !== stringifiedValue) {\n-    setStringValue(stringifiedValue);\n-  }\n+  useEffect(() => {\n+    if (!deepEqual(value, internalValue.value)) {\n+      setInternalValue({\n+        value,\n+        stringified: stringifyJson(value),\n+      });\n+    }\n+  }, [value]);\n \n+  const internalValueError = internalValue.error;\n   return (\n-    <AceEditor\n-      className={classNames('json-input', { invalid: parsedValue === undefined && blurred })}\n-      mode=\"hjson\"\n-      theme=\"solarized_dark\"\n-      onChange={(inputJson: string) => {\n-        try {\n-          const value = parseHjson(inputJson);\n-          onChange(value);\n-        } catch {}\n-        setStringValue(inputJson);\n-      }}\n-      onFocus={() => setBlurred(false)}\n-      onBlur={() => setBlurred(true)}\n-      focus={focus}\n-      fontSize={12}\n-      width={width || '100%'}\n-      height={height || '8vh'}\n-      showPrintMargin={false}\n-      showGutter={false}\n-      value={stringValue}\n-      placeholder={placeholder}\n-      editorProps={{\n-        $blockScrolling: Infinity,\n-      }}\n-      setOptions={{\n-        enableBasicAutocompletion: false,\n-        enableLiveAutocompletion: false,\n-        showLineNumbers: false,\n-        tabSize: 2,\n-      }}\n-      style={{}}\n-    />\n+    <div className={classNames('json-input', { invalid: showErrorIfNeeded && internalValueError })}>\n+      <AceEditor\n+        mode=\"hjson\"\n+        theme=\"solarized_dark\"\n+        onChange={(inputJson: string) => {\n+          let value: any;\n+          let error: Error | undefined;\n+          try {\n+            value = parseHjson(inputJson);\n+          } catch (e) {\n+            error = e;\n+          }\n+\n+          setInternalValue({\n+            value,\n+            error,\n+            stringified: inputJson,\n+          });\n+\n+          if (!error) {\n+            onChange(value);\n+          }\n+\n+          if (showErrorIfNeeded) {\n+            setShowErrorIfNeeded(false);\n+          }\n+        }}\n+        onBlur={() => setShowErrorIfNeeded(true)}\n+        focus={focus}\n+        fontSize={12}\n+        width={width || '100%'}\n+        height={height || '8vh'}\n+        showPrintMargin={false}\n+        showGutter={false}\n+        value={internalValue.stringified}\n+        placeholder={placeholder}\n+        editorProps={{\n+          $blockScrolling: Infinity,\n+        }}\n+        setOptions={{\n+          enableBasicAutocompletion: false,\n+          enableLiveAutocompletion: false,\n+          showLineNumbers: false,\n+          tabSize: 2,\n+        }}\n+        style={{}}\n+        onLoad={(editor: any) => {\n+          aceEditor.current = editor;\n+        }}\n+      />\n+      {showErrorIfNeeded && internalValueError && (\n+        <div\n+          className=\"json-error\"\n+          onClick={() => {\n+            if (!aceEditor.current || !internalValueError) return;\n+\n+            // Message would be something like:\n+            // `Found '}' where a key name was expected at line 26,7`", "originalCommit": "eff2956d828290e8ec02f6b8fb08569a8c7fdf91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk3NjE1Mw==", "url": "https://github.com/apache/druid/pull/10271#discussion_r469976153", "bodyText": "I suppose this won't always work; is that ok?", "author": "gianm", "createdAt": "2020-08-13T14:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2MTA3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA4MDU4NA==", "url": "https://github.com/apache/druid/pull/10271#discussion_r470080584", "bodyText": "Yeah, it it does not find /line (\\d+),(\\d+)/ it would just not do anything due to the if (!m) return; which is cool I think. But as I write this I realize it would be great to add a test to make sure that if the error format changes in the Hjson library in a future version we catch that - will do.", "author": "vogievetsky", "createdAt": "2020-08-13T16:35:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2MTA3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA4ODI1OA==", "url": "https://github.com/apache/druid/pull/10271#discussion_r470088258", "bodyText": "Done 8eb77e9", "author": "vogievetsky", "createdAt": "2020-08-13T16:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2MTA3Mw=="}], "type": "inlineReview"}, {"oid": "8eb77e92e23487a0c391e770bcec010545758c6e", "url": "https://github.com/apache/druid/commit/8eb77e92e23487a0c391e770bcec010545758c6e", "message": "add error extraction test", "committedDate": "2020-08-13T16:48:08Z", "type": "commit"}]}