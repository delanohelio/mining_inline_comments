{"pr_number": 10413, "pr_title": "Add last_compaction_state to sys.segments table", "pr_createdAt": "2020-09-21T23:33:30Z", "pr_url": "https://github.com/apache/druid/pull/10413", "timeline": [{"oid": "e5b8cb189edb0770f6e41a46030349836623ad20", "url": "https://github.com/apache/druid/commit/e5b8cb189edb0770f6e41a46030349836623ad20", "message": "Add is_compacted to sys.segments table", "committedDate": "2020-09-21T23:25:31Z", "type": "commit"}, {"oid": "09b8f9bf4def85911ef8ce18e7bcad12dff89548", "url": "https://github.com/apache/druid/commit/09b8f9bf4def85911ef8ce18e7bcad12dff89548", "message": "change is_compacted to last_compaction_state", "committedDate": "2020-09-22T00:31:34Z", "type": "commit"}, {"oid": "33959d2fd5183ebf08c45e1b61a953d4301dc382", "url": "https://github.com/apache/druid/commit/33959d2fd5183ebf08c45e1b61a953d4301dc382", "message": "fix tests", "committedDate": "2020-09-22T20:02:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMTI0NQ==", "url": "https://github.com/apache/druid/pull/10413#discussion_r493031245", "bodyText": "super nit - to link to where the default is.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * compaction task (true by default).\n          \n          \n            \n               * compaction task (true by default). {@link org.apache.druid.indexing.common.task.Tasks#DEFAULT_STORE_COMPACTION_STATE}.", "author": "suneet-s", "createdAt": "2020-09-22T21:01:19Z", "path": "core/src/main/java/org/apache/druid/timeline/DataSegment.java", "diffHunk": "@@ -100,7 +100,7 @@\n   /**\n    * Stores some configurations of the compaction task which created this segment.\n    * This field is filled in the metadata store only when \"storeCompactionState\" is set true in the context of the\n-   * compaction task which is false by default.\n+   * compaction task (true by default).", "originalCommit": "33959d2fd5183ebf08c45e1b61a953d4301dc382", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIwNTA3Mg==", "url": "https://github.com/apache/druid/pull/10413#discussion_r493205072", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-09-23T05:25:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMTI0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMjgwMw==", "url": "https://github.com/apache/druid/pull/10413#discussion_r493032803", "bodyText": "The PR description talks about being able to identify performance issues where looking at last_compaction_state can help. Should we add some example sql statements below to explain how to identify the 3 issues outlined in the PR description?", "author": "suneet-s", "createdAt": "2020-09-22T21:04:32Z", "path": "docs/querying/sql.md", "diffHunk": "@@ -1086,6 +1086,7 @@ Segments table provides details on all Druid segments, whether they are publishe\n |shardSpec|STRING|The toString of specific `ShardSpec`|\n |dimensions|STRING|The dimensions of the segment|\n |metrics|STRING|The metrics of the segment|\n+|last_compaction_state|STRING|The configurations of the compaction task which created this segment. May be null if segment was not created by compaction task.|\n \n For example to retrieve all segments for datasource \"wikipedia\", use the query:", "originalCommit": "33959d2fd5183ebf08c45e1b61a953d4301dc382", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIwNzU0Mg==", "url": "https://github.com/apache/druid/pull/10413#discussion_r493207542", "bodyText": "Done. It's very basic example but any one with proficient SQL can probably think of better things to query.", "author": "maytasm", "createdAt": "2020-09-23T05:33:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzMjgwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzNzExNQ==", "url": "https://github.com/apache/druid/pull/10413#discussion_r493037115", "bodyText": "CompactionState includes the PartitionsSpec and indexSpec.\nWhat should a caller of the API do with these?\nThe compaction state appears to be an unbounded json object. Do we foresee any issues around serializing the entire json blob every time we need to call the sys table?", "author": "suneet-s", "createdAt": "2020-09-22T21:13:22Z", "path": "sql/src/main/java/org/apache/druid/sql/calcite/schema/SystemSchema.java", "diffHunk": "@@ -311,7 +312,8 @@ public TableType getJdbcTableType()\n                 val.isOvershadowed() ? IS_OVERSHADOWED_TRUE : IS_OVERSHADOWED_FALSE,\n                 segment.getShardSpec(),\n                 segment.getDimensions(),\n-                segment.getMetrics()\n+                segment.getMetrics(),\n+                segment.getLastCompactionState()", "originalCommit": "33959d2fd5183ebf08c45e1b61a953d4301dc382", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIxNTU2MA==", "url": "https://github.com/apache/druid/pull/10413#discussion_r493215560", "bodyText": "Both PartitionsSpec and indexSpec can be helpful in determining the cause of query performance issue. We will also want to know what segments auto compaction will compact as both of those Spec determine that. 'indexSpec' can also impact query performance (see shape shifting PR).\nCompactionState is a small json and is already stored in memory as part of the DataSegment. We are also returning the shardSpec so this should not be a problem.", "author": "maytasm", "createdAt": "2020-09-23T05:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzNzExNQ=="}], "type": "inlineReview"}, {"oid": "0c9727e66efd9bcff08893aa4fc021e348dc95bc", "url": "https://github.com/apache/druid/commit/0c9727e66efd9bcff08893aa4fc021e348dc95bc", "message": "fix tests", "committedDate": "2020-09-22T22:17:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA4NTg1MA==", "url": "https://github.com/apache/druid/pull/10413#discussion_r493085850", "bodyText": "I think you should use putIfAbsent. That will allow the user to provide a STORE_COMPACTION_STATE_KEY that is different from the default value of true if needed.\nAlso nit: use a constant for the default value", "author": "suneet-s", "createdAt": "2020-09-22T23:18:42Z", "path": "indexing-service/src/main/java/org/apache/druid/indexing/common/task/CompactionTask.java", "diffHunk": "@@ -422,6 +422,7 @@ ParallelIndexSupervisorTask newTask(String taskId, ParallelIndexIngestionSpec in\n   {\n     final Map<String, Object> newContext = new HashMap<>(getContext());\n     newContext.put(CTX_KEY_APPENDERATOR_TRACKING_TASK_ID, getId());\n+    newContext.put(CompactSegments.STORE_COMPACTION_STATE_KEY, getContextValue(Tasks.STORE_COMPACTION_STATE_KEY, true));", "originalCommit": "0c9727e66efd9bcff08893aa4fc021e348dc95bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIzNTg5NA==", "url": "https://github.com/apache/druid/pull/10413#discussion_r493235894", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-09-23T06:48:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA4NTg1MA=="}], "type": "inlineReview"}, {"oid": "7ea1d41074d7b37958b7111a4789dc12ac2fcf02", "url": "https://github.com/apache/druid/commit/7ea1d41074d7b37958b7111a4789dc12ac2fcf02", "message": "address comments", "committedDate": "2020-09-23T06:48:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc3OTk3NQ==", "url": "https://github.com/apache/druid/pull/10413#discussion_r493779975", "bodyText": "Suggested re-write to talk about the problem an admin would be looking to solve more explicitly.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If you want to retrieve segment that was compacted (ANY compaction):\n          \n          \n            \n            \n          \n          \n            \n            ```sql\n          \n          \n            \n            SELECT * FROM sys.segments WHERE last_compaction_state is not null\n          \n          \n            \n            ```\n          \n          \n            \n            If you want to know whether segments in the wikipedia table are not compacted, and therefore may be contributing to query slowness, you can run a query like this to tell you how many segments have not been compacted per interval.\n          \n          \n            \n            \n          \n          \n            \n            ```sql\n          \n          \n            \n            SELECT start, end, count(*) FROM sys.segments WHERE datasource = 'wikipedia' and last_compaction_state is not null group by 1, 2\n          \n      \n    \n    \n  \n\nIf you find that queries that hit these intervals are slow - consider enabling compaction to produce more optimal segments.", "author": "suneet-s", "createdAt": "2020-09-23T17:52:03Z", "path": "docs/querying/sql.md", "diffHunk": "@@ -1108,6 +1108,18 @@ GROUP BY 1\n ORDER BY 2 DESC\n ```\n \n+If you want to retrieve segment that was compacted (ANY compaction):\n+\n+```sql\n+SELECT * FROM sys.segments WHERE last_compaction_state is not null\n+```", "originalCommit": "7ea1d41074d7b37958b7111a4789dc12ac2fcf02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkwOTU4Mg==", "url": "https://github.com/apache/druid/pull/10413#discussion_r493909582", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-09-23T21:36:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc3OTk3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4MjAyMA==", "url": "https://github.com/apache/druid/pull/10413#discussion_r493782020", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            or if you want to retrieve segment that was compacted only by a particular compaction spec (such as that of the auto compaction):\n          \n          \n            \n            Sometimes, you may have updated your compaction spec to a more optimal spec. In these cases you can find which segments are using the latest compaction spec using a query like the one below:\n          \n      \n    \n    \n  \n\nCan you also add instructions on how to produce the last_compaction_state blob from the web console. If I'm looking at the compaction config for a datasource - can I copy something to paste in the where clause here?", "author": "suneet-s", "createdAt": "2020-09-23T17:55:27Z", "path": "docs/querying/sql.md", "diffHunk": "@@ -1108,6 +1108,18 @@ GROUP BY 1\n ORDER BY 2 DESC\n ```\n \n+If you want to retrieve segment that was compacted (ANY compaction):\n+\n+```sql\n+SELECT * FROM sys.segments WHERE last_compaction_state is not null\n+```\n+\n+or if you want to retrieve segment that was compacted only by a particular compaction spec (such as that of the auto compaction):", "originalCommit": "7ea1d41074d7b37958b7111a4789dc12ac2fcf02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkwOTk1MA==", "url": "https://github.com/apache/druid/pull/10413#discussion_r493909950", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-09-23T21:37:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4MjAyMA=="}], "type": "inlineReview"}]}