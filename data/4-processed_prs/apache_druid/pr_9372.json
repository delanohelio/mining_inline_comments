{"pr_number": 9372, "pr_title": "Add config option for namespacePrefix", "pr_createdAt": "2020-02-17T16:12:36Z", "pr_url": "https://github.com/apache/druid/pull/9372", "timeline": [{"oid": "c24cf77fa168cd953855af7b1b6bb65f5516f1d3", "url": "https://github.com/apache/druid/commit/c24cf77fa168cd953855af7b1b6bb65f5516f1d3", "message": "Add config option for namespacePrefix\n\nopentsdb emitter sends metric names to opentsdb verbatim as what druid\nnames them, for example \"query.count\", this doesn't fit well with a\ncentral opentsdb server which might have namespaced metrics, for example\n\"druid.query.count\". This adds support for adding an optional prefix.\n\nThe prefix also gets a trailing dot (.), after it, so the metric name\nbecomes <namespacePrefix>.<metricname>\n\nconfigureable as \"druid.emitter.opentsdb.namespacePrefix\", as\ndocumented.\n\nCo-authored-by: Martin Gerholm <martin.gerholm@deltaprojects.com>\nSigned-off-by: Martin Gerholm <martin.gerholm@deltaprojects.com>\nSigned-off-by: Bj\u00f6rn Zettergren <bjorn.zettergren@deltaprojects.com>", "committedDate": "2020-02-17T16:06:48Z", "type": "commit"}, {"oid": "1d3f05fadd9c63a1d3dbfce6ef9746d85a3d4623", "url": "https://github.com/apache/druid/commit/1d3f05fadd9c63a1d3dbfce6ef9746d85a3d4623", "message": "Spelling for PR #9372\n\nAdded \"namespacePrefix\" to .spelling exceptions, it's a variable name\nused in documentation for opentsdb-emitter.", "committedDate": "2020-02-18T08:56:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU4NzUxMw==", "url": "https://github.com/apache/druid/pull/9372#discussion_r380587513", "bodyText": "Space prefix ? Maybe you should change \"legendary druid\" to \"\" or rename the variable.", "author": "QiuMM", "createdAt": "2020-02-18T10:33:09Z", "path": "extensions-contrib/opentsdb-emitter/src/test/java/org/apache/druid/emitter/opentsdb/EventConverterTest.java", "diffHunk": "@@ -32,23 +32,29 @@\n \n public class EventConverterTest\n {\n-  private EventConverter converter;\n+  private EventConverter converterWithPrefix;\n+  private EventConverter converterWithSpacePrefix;\n+  private EventConverter converterWithoutPrefix;\n \n   @Before\n   public void setUp()\n   {\n-    converter = new EventConverter(new ObjectMapper(), null);\n+    converterWithPrefix = new EventConverter(new ObjectMapper(), null, \"druid\");\n+    converterWithSpacePrefix = new EventConverter(new ObjectMapper(), null, \"legendary druid\");", "originalCommit": "1d3f05fadd9c63a1d3dbfce6ef9746d85a3d4623", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzNDcyNw==", "url": "https://github.com/apache/druid/pull/9372#discussion_r380634727", "bodyText": "You're right, i'll rename the variable to converterWithPrefixContainingSpace, and add another test for converterWithPrefixContainingEmptyString (\"\").\nHow does that sound?", "author": "bjozet", "createdAt": "2020-02-18T12:14:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU4NzUxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE0NjU1Nw==", "url": "https://github.com/apache/druid/pull/9372#discussion_r381146557", "bodyText": "Sounds good.", "author": "QiuMM", "createdAt": "2020-02-19T08:44:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU4NzUxMw=="}], "type": "inlineReview"}, {"oid": "7ef78e1f96b27254d43bd5d1a02dcc6775ad8840", "url": "https://github.com/apache/druid/commit/7ef78e1f96b27254d43bd5d1a02dcc6775ad8840", "message": "fixing tests for PR #9372\n\nchanged naming of variables to be more descriptive\nadded test of prefix being an empty string: \"\".\nadded a conditional to buildNamespacePrefix to check for empty string\nbeing fed if EventConverter called without OpentsdbEmitterConfig\ninstance.", "committedDate": "2020-02-18T14:11:03Z", "type": "commit"}, {"oid": "d0527e0185abf40248ff224c03218a9ca9385353", "url": "https://github.com/apache/druid/commit/d0527e0185abf40248ff224c03218a9ca9385353", "message": "fixing checkstyle errors for PR #9372\n\nused == to compare literal string, should be equals()", "committedDate": "2020-02-18T22:23:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA3NDkyNw==", "url": "https://github.com/apache/druid/pull/9372#discussion_r381074927", "bodyText": "nit: I think this might be a fair bit cleaner to rework this method to take the metric name and do the call to sanitize in here, maybe something like:\nprivate String buildMetric(String metric)\n{\n  final String sanitized = sanitize(metric);\n  if (Strings.isNullOrEmpty(namespacePrefix)) {\n    return sanitized;\n  } else {\n    return StringUtils.format(\"%s.%s\", namespacePrefix, sanitized);\n  }  \n}\n\nthen creating the OpentsdbEvent can just be\n    ...\n    return new OpentsdbEvent(buildMetric(metric), timestamp, value, tags);", "author": "clintropolis", "createdAt": "2020-02-19T04:44:20Z", "path": "extensions-contrib/opentsdb-emitter/src/main/java/org/apache/druid/emitter/opentsdb/EventConverter.java", "diffHunk": "@@ -41,17 +41,24 @@\n   private static final Pattern WHITESPACE = Pattern.compile(\"[\\\\s]+\");\n \n   private final Map<String, Set<String>> metricMap;\n+  private final String namespacePrefix;\n \n-  public EventConverter(ObjectMapper mapper, String metricMapPath)\n+  public EventConverter(ObjectMapper mapper, String metricMapPath, String namespacePrefix)\n   {\n     metricMap = readMap(mapper, metricMapPath);\n+    this.namespacePrefix = namespacePrefix;\n   }\n \n   protected String sanitize(String metric)\n   {\n     return WHITESPACE.matcher(metric.trim()).replaceAll(\"_\").replace('/', '.');\n   }\n \n+  private String buildNamespace()", "originalCommit": "d0527e0185abf40248ff224c03218a9ca9385353", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwODYxOQ==", "url": "https://github.com/apache/druid/pull/9372#discussion_r381208619", "bodyText": "Makes perfect sense, i've added  buildMetric more or like what you suggested.", "author": "bjozet", "createdAt": "2020-02-19T10:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA3NDkyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA3NTkxOA==", "url": "https://github.com/apache/druid/pull/9372#discussion_r381075918", "bodyText": "can namespacePrefix actually be empty here (other than the unit tests creating an EventConverter directly) since OpentsdbEmitterConfig looks like it will coerce the value to null in its constructor?", "author": "clintropolis", "createdAt": "2020-02-19T04:49:27Z", "path": "extensions-contrib/opentsdb-emitter/src/main/java/org/apache/druid/emitter/opentsdb/EventConverter.java", "diffHunk": "@@ -41,17 +41,24 @@\n   private static final Pattern WHITESPACE = Pattern.compile(\"[\\\\s]+\");\n \n   private final Map<String, Set<String>> metricMap;\n+  private final String namespacePrefix;\n \n-  public EventConverter(ObjectMapper mapper, String metricMapPath)\n+  public EventConverter(ObjectMapper mapper, String metricMapPath, String namespacePrefix)\n   {\n     metricMap = readMap(mapper, metricMapPath);\n+    this.namespacePrefix = namespacePrefix;\n   }\n \n   protected String sanitize(String metric)\n   {\n     return WHITESPACE.matcher(metric.trim()).replaceAll(\"_\").replace('/', '.');\n   }\n \n+  private String buildNamespace()\n+  {\n+    return (namespacePrefix == null || \"\".equals(namespacePrefix)) ? \"\" : sanitize(namespacePrefix) + \".\";", "originalCommit": "d0527e0185abf40248ff224c03218a9ca9385353", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwOTA3MA==", "url": "https://github.com/apache/druid/pull/9372#discussion_r381209070", "bodyText": "You're right, i've removed the tests for it, since it's the only place where it can happen. And i guess no-one is gonna call EventConverter outside of the extension.", "author": "bjozet", "createdAt": "2020-02-19T10:37:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA3NTkxOA=="}], "type": "inlineReview"}, {"oid": "fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3", "url": "https://github.com/apache/druid/commit/fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3", "message": "cleaned up and updated PR #9372\n\nCreated a buildMetric function as suggested by clintropolis, and\nremoved redundant tests for empty strings as they're only used when\ncalling EventConverter directly without going through\nOpentsdbEmitterConfig.", "committedDate": "2020-02-19T10:25:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY1MjMxMA==", "url": "https://github.com/apache/druid/pull/9372#discussion_r381652310", "bodyText": "I think this can just check namespacePrefix == null now", "author": "clintropolis", "createdAt": "2020-02-20T01:37:56Z", "path": "extensions-contrib/opentsdb-emitter/src/main/java/org/apache/druid/emitter/opentsdb/EventConverter.java", "diffHunk": "@@ -54,9 +55,14 @@ protected String sanitize(String metric)\n     return WHITESPACE.matcher(metric.trim()).replaceAll(\"_\").replace('/', '.');\n   }\n \n-  private String buildNamespace()\n+  private String buildMetric(String metric)\n   {\n-    return (namespacePrefix == null || \"\".equals(namespacePrefix)) ? \"\" : sanitize(namespacePrefix) + \".\";\n+    final String sanitized = sanitize(metric);\n+    if (Strings.isNullOrEmpty(namespacePrefix)) {", "originalCommit": "fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4NjI2Mw==", "url": "https://github.com/apache/druid/pull/9372#discussion_r381986263", "bodyText": "Fixed in latest commit", "author": "bjozet", "createdAt": "2020-02-20T13:07:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY1MjMxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgyNjg1NQ==", "url": "https://github.com/apache/druid/pull/9372#discussion_r381826855", "bodyText": "nit: I think rename testSerDeserOpentsdbEmitterConfigWithSpaceNamespace to testSerDeserOpentsdbEmitterConfigWithNamespaceContainingSpace would be better.", "author": "QiuMM", "createdAt": "2020-02-20T07:38:45Z", "path": "extensions-contrib/opentsdb-emitter/src/test/java/org/apache/druid/emitter/opentsdb/OpentsdbEmitterConfigTest.java", "diffHunk": "@@ -39,10 +39,41 @@ public void setUp()\n   @Test\n   public void testSerDeserOpentsdbEmitterConfig() throws Exception\n   {\n-    OpentsdbEmitterConfig opentsdbEmitterConfig = new OpentsdbEmitterConfig(\"localhost\", 9999, 2000, 2000, 200, 2000, 10000L, null);\n+    OpentsdbEmitterConfig opentsdbEmitterConfig = new OpentsdbEmitterConfig(\"localhost\", 9999, 2000, 2000, 200, 2000, 10000L, null, \"druid\");\n     String opentsdbEmitterConfigString = mapper.writeValueAsString(opentsdbEmitterConfig);\n     OpentsdbEmitterConfig expectedOpentsdbEmitterConfig = mapper.readerFor(OpentsdbEmitterConfig.class)\n                                                                 .readValue(opentsdbEmitterConfigString);\n     Assert.assertEquals(expectedOpentsdbEmitterConfig, opentsdbEmitterConfig);\n   }\n+\n+  @Test\n+  public void testSerDeserOpentsdbEmitterConfigWithSpaceNamespace() throws Exception", "originalCommit": "fc0ce6e9e2c4cb28d9be06aa6c9be44461e1acc3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk1ODQ4NA==", "url": "https://github.com/apache/druid/pull/9372#discussion_r381958484", "bodyText": "Well spotted, didn't think much of test names when refactoring. And actually, I should bring all test-names in line with same naming convention, for clarity. In this file the tests were named like <...>Namespace<...>, and in EventConverterTest.java they're called <...>Prefix<...>, they should all be <...>NamespacePrefix<...>. I'll update them all. :)", "author": "bjozet", "createdAt": "2020-02-20T12:05:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgyNjg1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4NjM0MA==", "url": "https://github.com/apache/druid/pull/9372#discussion_r381986340", "bodyText": "committed", "author": "bjozet", "createdAt": "2020-02-20T13:07:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgyNjg1NQ=="}], "type": "inlineReview"}, {"oid": "01e83fb5e38f194b2599f9600dc90083bfac573f", "url": "https://github.com/apache/druid/commit/01e83fb5e38f194b2599f9600dc90083bfac573f", "message": "consistent naming of tests PR #9372\n\nChanged names of tests in files to match better with what it was\nactually testing\n\nchanged check for Strings.isNullOrEmpty to just check for `null`, as\nempty string valued `namespacePrefix` is handled in\nOpentsdbEmitterConfig.", "committedDate": "2020-02-20T12:48:03Z", "type": "commit"}]}