{"pr_number": 9523, "pr_title": "Ability to Delete task logs and segments from Azure Storage", "pr_createdAt": "2020-03-17T01:46:50Z", "pr_url": "https://github.com/apache/druid/pull/9523", "timeline": [{"oid": "752a819d3b17883165f893c09d7f97eab6d090b7", "url": "https://github.com/apache/druid/commit/752a819d3b17883165f893c09d7f97eab6d090b7", "message": "Ability to Delete task logs and segments from Azure Storage\n\n* implement ability to delete all tasks logs or all task logs\n  written before a particular date when written to Azure storage\n\n* implement ability to delete all segments from Azure deep storage", "committedDate": "2020-03-17T01:44:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MjMwNA==", "url": "https://github.com/apache/druid/pull/9523#discussion_r394182304", "bodyText": "nit: formatting\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                log.info(\"Deleting all segment files from Azure storage location [bucket: '%s' prefix: '%s']\",\n          \n          \n            \n                         segmentConfig.getContainer(), segmentConfig.getPrefix()\n          \n          \n            \n                );\n          \n          \n            \n                log.info(\n          \n          \n            \n                    \"Deleting all segment files from Azure storage location [bucket: '%s' prefix: '%s']\",\n          \n          \n            \n                    segmentConfig.getContainer(),\n          \n          \n            \n                    segmentConfig.getPrefix()\n          \n          \n            \n                );", "author": "clintropolis", "createdAt": "2020-03-18T08:42:27Z", "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentKiller.java", "diffHunk": "@@ -72,9 +86,26 @@ public void kill(DataSegment segment) throws SegmentLoadingException\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all segment files from Azure storage location [bucket: '%s' prefix: '%s']\",\n+             segmentConfig.getContainer(), segmentConfig.getPrefix()\n+    );", "originalCommit": "752a819d3b17883165f893c09d7f97eab6d090b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY4MDU4OA==", "url": "https://github.com/apache/druid/pull/9523#discussion_r394680588", "bodyText": "done", "author": "zachjsh", "createdAt": "2020-03-18T22:41:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MjMwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4Mjg1MQ==", "url": "https://github.com/apache/druid/pull/9523#discussion_r394182851", "bodyText": "Heh, should probably be\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  log.error(\"Error occurred while deleting segment files from s3. Error: %s\", e.getMessage());\n          \n          \n            \n                  log.error(\"Error occurred while deleting segment files from Azure. Error: %s\", e.getMessage());", "author": "clintropolis", "createdAt": "2020-03-18T08:43:25Z", "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentKiller.java", "diffHunk": "@@ -72,9 +86,26 @@ public void kill(DataSegment segment) throws SegmentLoadingException\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all segment files from Azure storage location [bucket: '%s' prefix: '%s']\",\n+             segmentConfig.getContainer(), segmentConfig.getPrefix()\n+    );\n+    try {\n+      AzureUtils.deleteObjectsInPath(\n+          azureStorage,\n+          inputDataConfig,\n+          accountConfig,\n+          azureCloudBlobIterableFactory,\n+          segmentConfig.getContainer(),\n+          segmentConfig.getPrefix(),\n+          Predicates.alwaysTrue()\n+      );\n+    }\n+    catch (Exception e) {\n+      log.error(\"Error occurred while deleting segment files from s3. Error: %s\", e.getMessage());", "originalCommit": "752a819d3b17883165f893c09d7f97eab6d090b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY4MDU2NQ==", "url": "https://github.com/apache/druid/pull/9523#discussion_r394680565", "bodyText": "done", "author": "zachjsh", "createdAt": "2020-03-18T22:41:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4Mjg1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MzMwNw==", "url": "https://github.com/apache/druid/pull/9523#discussion_r394183307", "bodyText": "same wrong cloud\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  log.error(\"Error occurred while deleting task log files from s3. Error: %s\", e.getMessage());\n          \n          \n            \n                  log.error(\"Error occurred while deleting task log files from Azure. Error: %s\", e.getMessage());", "author": "clintropolis", "createdAt": "2020-03-18T08:44:11Z", "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureTaskLogs.java", "diffHunk": "@@ -151,14 +167,36 @@ private String getTaskReportsKey(String taskid)\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n+             config.getContainer(), config.getPrefix()\n+    );\n+\n+    long now = timeSupplier.getAsLong();\n+    killOlderThan(now);\n   }\n \n   @Override\n-  public void killOlderThan(long timestamp)\n+  public void killOlderThan(long timestamp) throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: '%s' prefix: '%s'] older than %s.\",\n+             config.getContainer(), config.getPrefix(), new Date(timestamp)\n+    );\n+    try {\n+      AzureUtils.deleteObjectsInPath(\n+          azureStorage,\n+          inputDataConfig,\n+          accountConfig,\n+          azureCloudBlobIterableFactory,\n+          config.getContainer(),\n+          config.getPrefix(),\n+          (object) -> object.getLastModifed().getTime() < timestamp\n+      );\n+    }\n+    catch (Exception e) {\n+      log.error(\"Error occurred while deleting task log files from s3. Error: %s\", e.getMessage());", "originalCommit": "752a819d3b17883165f893c09d7f97eab6d090b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY4MDUzNg==", "url": "https://github.com/apache/druid/pull/9523#discussion_r394680536", "bodyText": "done", "author": "zachjsh", "createdAt": "2020-03-18T22:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4MzMwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4Mzc1NA==", "url": "https://github.com/apache/druid/pull/9523#discussion_r394183754", "bodyText": "same comment about 1 line per arg formatting if spans multiple lines\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                log.info(\"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n          \n          \n            \n                         config.getContainer(), config.getPrefix()\n          \n          \n            \n                );\n          \n          \n            \n                log.info(\n          \n          \n            \n                    \"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n          \n          \n            \n                    config.getContainer(),\n          \n          \n            \n                    config.getPrefix()\n          \n          \n            \n                );", "author": "clintropolis", "createdAt": "2020-03-18T08:45:05Z", "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureTaskLogs.java", "diffHunk": "@@ -151,14 +167,36 @@ private String getTaskReportsKey(String taskid)\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n+             config.getContainer(), config.getPrefix()\n+    );", "originalCommit": "752a819d3b17883165f893c09d7f97eab6d090b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY4MDQ5OA==", "url": "https://github.com/apache/druid/pull/9523#discussion_r394680498", "bodyText": "done", "author": "zachjsh", "createdAt": "2020-03-18T22:41:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4Mzc1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4NDM4MA==", "url": "https://github.com/apache/druid/pull/9523#discussion_r394184380", "bodyText": "same formatting nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                log.info(\"Deleting all task logs from Azure storage location [bucket: '%s' prefix: '%s'] older than %s.\",\n          \n          \n            \n                         config.getContainer(), config.getPrefix(), new Date(timestamp)\n          \n          \n            \n                );\n          \n          \n            \n                log.info(\n          \n          \n            \n                    \"Deleting all task logs from Azure storage location [bucket: '%s' prefix: '%s'] older than %s.\",\n          \n          \n            \n                    config.getContainer(),\n          \n          \n            \n                    config.getPrefix(),\n          \n          \n            \n                    new Date(timestamp)\n          \n          \n            \n                );\n          \n      \n    \n    \n  \n\nsorry there isn't a style rule for this, last we checked it wasn't possible to do, but it's been a while so it might be worth checking on again...", "author": "clintropolis", "createdAt": "2020-03-18T08:46:14Z", "path": "extensions-core/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureTaskLogs.java", "diffHunk": "@@ -151,14 +167,36 @@ private String getTaskReportsKey(String taskid)\n   }\n \n   @Override\n-  public void killAll()\n+  public void killAll() throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: %s    prefix: %s].\",\n+             config.getContainer(), config.getPrefix()\n+    );\n+\n+    long now = timeSupplier.getAsLong();\n+    killOlderThan(now);\n   }\n \n   @Override\n-  public void killOlderThan(long timestamp)\n+  public void killOlderThan(long timestamp) throws IOException\n   {\n-    throw new UnsupportedOperationException(\"not implemented\");\n+    log.info(\"Deleting all task logs from Azure storage location [bucket: '%s' prefix: '%s'] older than %s.\",\n+             config.getContainer(), config.getPrefix(), new Date(timestamp)\n+    );", "originalCommit": "752a819d3b17883165f893c09d7f97eab6d090b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY4MDQ2Nw==", "url": "https://github.com/apache/druid/pull/9523#discussion_r394680467", "bodyText": "done", "author": "zachjsh", "createdAt": "2020-03-18T22:40:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4NDM4MA=="}], "type": "inlineReview"}, {"oid": "92ec5a90038efed64a47a4228d81f80e5b775ebb", "url": "https://github.com/apache/druid/commit/92ec5a90038efed64a47a4228d81f80e5b775ebb", "message": "* Address review comments", "committedDate": "2020-03-18T22:40:14Z", "type": "commit"}]}