{"pr_number": 9941, "pr_title": "Prevent JOIN reducing to a JOIN with constant in the ON condition", "pr_createdAt": "2020-05-28T02:10:56Z", "pr_url": "https://github.com/apache/druid/pull/9941", "timeline": [{"oid": "8b1742f97e0707db8896fcc3d1ee975411d3f2ed", "url": "https://github.com/apache/druid/commit/8b1742f97e0707db8896fcc3d1ee975411d3f2ed", "message": "Prevent Join reducing to on constant condition", "committedDate": "2020-05-28T02:04:04Z", "type": "commit"}, {"oid": "2600c3f2d778c26533fc707a571ddf888fa5b170", "url": "https://github.com/apache/druid/commit/2600c3f2d778c26533fc707a571ddf888fa5b170", "message": "Prevent Join reducing to on constant condition", "committedDate": "2020-05-28T03:31:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg3ODE2Nw==", "url": "https://github.com/apache/druid/pull/9941#discussion_r431878167", "bodyText": "What are your thoughts on having a list of rules that are excluded in the codebase somewhere (maybe just commented out in here). That way we can add documentation in the code about why each rule was excluded.\nIf any of the reasoning for why a rule was removed from this list changes, it would be easy to add back the rules to transform to more efficient queries.", "author": "suneet-s", "createdAt": "2020-05-28T14:28:26Z", "path": "sql/src/main/java/org/apache/druid/sql/calcite/planner/Rules.java", "diffHunk": "@@ -130,7 +130,6 @@\n           ReduceExpressionsRule.FILTER_INSTANCE,\n           ReduceExpressionsRule.CALC_INSTANCE,\n           ReduceExpressionsRule.WINDOW_INSTANCE,\n-          ReduceExpressionsRule.JOIN_INSTANCE,", "originalCommit": "2600c3f2d778c26533fc707a571ddf888fa5b170", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyOTE0MA==", "url": "https://github.com/apache/druid/pull/9941#discussion_r432229140", "bodyText": "Done. Added comments.", "author": "maytasm", "createdAt": "2020-05-29T02:54:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg3ODE2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4NDA4MQ==", "url": "https://github.com/apache/druid/pull/9941#discussion_r431884081", "bodyText": "Can you add a test that fails a query with the shape defined in #9942", "author": "suneet-s", "createdAt": "2020-05-28T14:34:16Z", "path": "sql/src/test/java/org/apache/druid/sql/calcite/CalciteQueryTest.java", "diffHunk": "@@ -13884,6 +13885,318 @@ public void testQueryContextOuterLimit() throws Exception\n     );\n   }\n \n+  @Test\n+  public void testCountOnSemiJoinSingleColumn() throws Exception\n+  {\n+    testQuery(\n+        \"SELECT dim1 FROM foo WHERE dim1 IN (SELECT dim1 FROM foo WHERE dim1 = '10.1')\\n\",\n+        ImmutableList.of(\n+            newScanQueryBuilder()\n+                .dataSource(\n+                    join(\n+                        new TableDataSource(CalciteTests.DATASOURCE1),\n+                        new QueryDataSource(\n+                            GroupByQuery.builder()\n+                                        .setDataSource(CalciteTests.DATASOURCE1)\n+                                        .setInterval(querySegmentSpec(Filtration.eternity()))\n+                                        .setDimFilter(\n+                                            selector(\"dim1\", \"10.1\", null)\n+                                        )\n+                                        .setGranularity(Granularities.ALL)\n+                                        .setDimensions(dimensions(new DefaultDimensionSpec(\"dim1\", \"d0\")))\n+                                        .setContext(QUERY_CONTEXT_DEFAULT)\n+                                        .build()\n+                        ),\n+                        \"j0.\",\n+                        equalsCondition(DruidExpression.fromColumn(\"dim1\"), DruidExpression.fromColumn(\"j0.d0\")),\n+                        JoinType.INNER\n+                    )\n+                )\n+                .intervals(querySegmentSpec(Filtration.eternity()))\n+                .virtualColumns(expressionVirtualColumn(\"v0\", \"\\'10.1\\'\", ValueType.STRING))\n+                .columns(\"v0\")\n+                .context(QUERY_CONTEXT_DEFAULT)\n+                .build()\n+        ),\n+        ImmutableList.of(\n+            new Object[]{\"10.1\"}\n+        )\n+    );\n+  }\n+\n+  @Test\n+  public void testLeftJoinOnTwoInlineDataSourcesWithTimeFilter() throws Exception\n+  {\n+    testQuery(\n+        \"with abc as\\n\"\n+        + \"(\\n\"\n+        + \"  SELECT dim1, \\\"__time\\\", m1 from foo WHERE \\\"dim1\\\" = '10.1' AND \\\"__time\\\" >= '1999'\\n\"\n+        + \")\\n\"\n+        + \"SELECT t1.dim1, t1.\\\"__time\\\" from abc as t1 LEFT JOIN abc as t2 on t1.dim1 = t2.dim1 WHERE t1.dim1 = '10.1'\\n\",\n+        ImmutableList.of(\n+            newScanQueryBuilder()\n+                .dataSource(\n+                    join(\n+                        new QueryDataSource(\n+                            newScanQueryBuilder()\n+                                .dataSource(CalciteTests.DATASOURCE1)\n+                                .intervals(\n+                                    querySegmentSpec(\n+                                        Intervals.utc(\n+                                            DateTimes.of(\"1999-01-01\").getMillis(),\n+                                            JodaUtils.MAX_INSTANT\n+                                        )\n+                                    )\n+                                )\n+                                .filters(new SelectorDimFilter(\"dim1\", \"10.1\", null))\n+                                .virtualColumns(expressionVirtualColumn(\"v0\", \"\\'10.1\\'\", ValueType.STRING))\n+                                .columns(ImmutableList.of(\"__time\", \"v0\"))\n+                                .resultFormat(ScanQuery.ResultFormat.RESULT_FORMAT_COMPACTED_LIST)\n+                                .context(QUERY_CONTEXT_DEFAULT)\n+                                .build()\n+                        ),\n+                        new QueryDataSource(\n+                            newScanQueryBuilder()\n+                                .dataSource(CalciteTests.DATASOURCE1)\n+                                .intervals(\n+                                    querySegmentSpec(\n+                                        Intervals.utc(\n+                                            DateTimes.of(\"1999-01-01\").getMillis(),\n+                                            JodaUtils.MAX_INSTANT\n+                                        )\n+                                    )\n+                                )\n+                                .filters(new SelectorDimFilter(\"dim1\", \"10.1\", null))\n+                                .virtualColumns(expressionVirtualColumn(\"v0\", \"\\'10.1\\'\", ValueType.STRING))\n+                                .columns(ImmutableList.of(\"v0\"))\n+                                .resultFormat(ScanQuery.ResultFormat.RESULT_FORMAT_COMPACTED_LIST)\n+                                .context(QUERY_CONTEXT_DEFAULT)\n+                                .build()\n+                        ),\n+                        \"j0.\",\n+                        equalsCondition(DruidExpression.fromColumn(\"v0\"), DruidExpression.fromColumn(\"j0.v0\")),\n+                        JoinType.LEFT\n+                    )\n+                )\n+                .intervals(querySegmentSpec(Filtration.eternity()))\n+                .virtualColumns(expressionVirtualColumn(\"_v0\", \"\\'10.1\\'\", ValueType.STRING))\n+                .columns(\"__time\", \"_v0\")\n+                .filters(new SelectorDimFilter(\"v0\", \"10.1\", null))\n+                .context(QUERY_CONTEXT_DEFAULT)\n+                .build()\n+        ),\n+        ImmutableList.of(\n+            new Object[]{\"10.1\", 946771200000L}\n+        )\n+    );\n+  }\n+\n+  @Test\n+  public void testLeftJoinOnTwoInlineDataSourcesWithOuterWhere() throws Exception\n+  {\n+    testQuery(\n+        \"with abc as\\n\"\n+        + \"(\\n\"\n+        + \"  SELECT dim1, \\\"__time\\\", m1 from foo WHERE \\\"dim1\\\" = '10.1'\\n\"\n+        + \")\\n\"\n+        + \"SELECT t1.dim1, t1.\\\"__time\\\" from abc as t1 LEFT JOIN abc as t2 on t1.dim1 = t2.dim1 WHERE t1.dim1 = '10.1'\\n\",\n+        ImmutableList.of(\n+            newScanQueryBuilder()\n+                .dataSource(\n+                    join(\n+                        new QueryDataSource(\n+                            newScanQueryBuilder()\n+                                .dataSource(CalciteTests.DATASOURCE1)\n+                                .intervals(querySegmentSpec(Filtration.eternity()))\n+                                .filters(new SelectorDimFilter(\"dim1\", \"10.1\", null))\n+                                .virtualColumns(expressionVirtualColumn(\"v0\", \"\\'10.1\\'\", ValueType.STRING))\n+                                .columns(ImmutableList.of(\"__time\", \"v0\"))\n+                                .resultFormat(ScanQuery.ResultFormat.RESULT_FORMAT_COMPACTED_LIST)\n+                                .context(QUERY_CONTEXT_DEFAULT)\n+                                .build()\n+                        ),\n+                        new QueryDataSource(\n+                            newScanQueryBuilder()\n+                                .dataSource(CalciteTests.DATASOURCE1)\n+                                .intervals(querySegmentSpec(Filtration.eternity()))\n+                                .filters(new SelectorDimFilter(\"dim1\", \"10.1\", null))\n+                                .columns(ImmutableList.of(\"dim1\"))\n+                                .resultFormat(ScanQuery.ResultFormat.RESULT_FORMAT_COMPACTED_LIST)\n+                                .context(QUERY_CONTEXT_DEFAULT)\n+                                .build()\n+                        ),\n+                        \"j0.\",\n+                        equalsCondition(DruidExpression.fromColumn(\"v0\"), DruidExpression.fromColumn(\"j0.dim1\")),\n+                        JoinType.LEFT\n+                    )\n+                )\n+                .intervals(querySegmentSpec(Filtration.eternity()))\n+                .virtualColumns(expressionVirtualColumn(\"_v0\", \"\\'10.1\\'\", ValueType.STRING))\n+                .columns(\"__time\", \"_v0\")\n+                .filters(new SelectorDimFilter(\"v0\", \"10.1\", null))\n+                .context(QUERY_CONTEXT_DEFAULT)\n+                .build()\n+        ),\n+        ImmutableList.of(\n+            new Object[]{\"10.1\", 946771200000L}\n+        )\n+    );\n+  }\n+\n+  @Test\n+  public void testLeftJoinOnTwoInlineDataSources() throws Exception\n+  {\n+    testQuery(\n+        \"with abc as\\n\"\n+        + \"(\\n\"\n+        + \"  SELECT dim1, \\\"__time\\\", m1 from foo WHERE \\\"dim1\\\" = '10.1'\\n\"\n+        + \")\\n\"\n+        + \"SELECT t1.dim1, t1.\\\"__time\\\" from abc as t1 LEFT JOIN abc as t2 on t1.dim1 = t2.dim1\\n\",\n+        ImmutableList.of(\n+            newScanQueryBuilder()\n+                .dataSource(\n+                    join(\n+                        new QueryDataSource(\n+                            newScanQueryBuilder()\n+                                .dataSource(CalciteTests.DATASOURCE1)\n+                                .intervals(querySegmentSpec(Filtration.eternity()))\n+                                .filters(new SelectorDimFilter(\"dim1\", \"10.1\", null))\n+                                .virtualColumns(expressionVirtualColumn(\"v0\", \"\\'10.1\\'\", ValueType.STRING))\n+                                .columns(ImmutableList.of(\"__time\", \"v0\"))\n+                                .resultFormat(ScanQuery.ResultFormat.RESULT_FORMAT_COMPACTED_LIST)\n+                                .context(QUERY_CONTEXT_DEFAULT)\n+                                .build()\n+                        ),\n+                        new QueryDataSource(\n+                            newScanQueryBuilder()\n+                                .dataSource(CalciteTests.DATASOURCE1)\n+                                .intervals(querySegmentSpec(Filtration.eternity()))\n+                                .filters(new SelectorDimFilter(\"dim1\", \"10.1\", null))\n+                                .columns(ImmutableList.of(\"dim1\"))\n+                                .resultFormat(ScanQuery.ResultFormat.RESULT_FORMAT_COMPACTED_LIST)\n+                                .context(QUERY_CONTEXT_DEFAULT)\n+                                .build()\n+                        ),\n+                        \"j0.\",\n+                        equalsCondition(DruidExpression.fromColumn(\"v0\"), DruidExpression.fromColumn(\"j0.dim1\")),\n+                        JoinType.LEFT\n+                    )\n+                )\n+                .intervals(querySegmentSpec(Filtration.eternity()))\n+                .virtualColumns(expressionVirtualColumn(\"_v0\", \"\\'10.1\\'\", ValueType.STRING))\n+                .columns(\"__time\", \"_v0\")\n+                .context(QUERY_CONTEXT_DEFAULT)\n+                .build()\n+        ),\n+        ImmutableList.of(\n+            new Object[]{\"10.1\", 946771200000L}\n+        )\n+    );\n+  }\n+\n+  @Test\n+  public void testInnerJoinOnTwoInlineDataSourcesWithOuterWhere() throws Exception\n+  {\n+    testQuery(\n+        \"with abc as\\n\"\n+        + \"(\\n\"\n+        + \"  SELECT dim1, \\\"__time\\\", m1 from foo WHERE \\\"dim1\\\" = '10.1'\\n\"\n+        + \")\\n\"\n+        + \"SELECT t1.dim1, t1.\\\"__time\\\" from abc as t1 INNER JOIN abc as t2 on t1.dim1 = t2.dim1 WHERE t1.dim1 = '10.1'\\n\",\n+        ImmutableList.of(\n+            newScanQueryBuilder()\n+                .dataSource(\n+                    join(\n+                        new QueryDataSource(\n+                            newScanQueryBuilder()\n+                                .dataSource(CalciteTests.DATASOURCE1)\n+                                .intervals(querySegmentSpec(Filtration.eternity()))\n+                                .filters(new SelectorDimFilter(\"dim1\", \"10.1\", null))\n+                                .virtualColumns(expressionVirtualColumn(\"v0\", \"\\'10.1\\'\", ValueType.STRING))\n+                                .columns(ImmutableList.of(\"__time\", \"v0\"))\n+                                .resultFormat(ScanQuery.ResultFormat.RESULT_FORMAT_COMPACTED_LIST)\n+                                .context(QUERY_CONTEXT_DEFAULT)\n+                                .build()\n+                        ),\n+                        new QueryDataSource(\n+                            newScanQueryBuilder()\n+                                .dataSource(CalciteTests.DATASOURCE1)\n+                                .intervals(querySegmentSpec(Filtration.eternity()))\n+                                .filters(new SelectorDimFilter(\"dim1\", \"10.1\", null))\n+                                .columns(ImmutableList.of(\"dim1\"))\n+                                .resultFormat(ScanQuery.ResultFormat.RESULT_FORMAT_COMPACTED_LIST)\n+                                .context(QUERY_CONTEXT_DEFAULT)\n+                                .build()\n+                        ),\n+                        \"j0.\",\n+                        equalsCondition(DruidExpression.fromColumn(\"v0\"), DruidExpression.fromColumn(\"j0.dim1\")),\n+                        JoinType.INNER\n+                    )\n+                )\n+                .intervals(querySegmentSpec(Filtration.eternity()))\n+                .virtualColumns(expressionVirtualColumn(\"_v0\", \"\\'10.1\\'\", ValueType.STRING))\n+                .columns(\"__time\", \"_v0\")\n+                .filters(new NotDimFilter(new SelectorDimFilter(\"v0\", null, null)))\n+                .context(QUERY_CONTEXT_DEFAULT)\n+                .build()\n+        ),\n+        ImmutableList.of(\n+            new Object[]{\"10.1\", 946771200000L}\n+        )\n+    );\n+  }\n+\n+  @Test\n+  public void testInnerJoinOnTwoInlineDataSources() throws Exception\n+  {\n+    testQuery(\n+        \"with abc as\\n\"\n+        + \"(\\n\"\n+        + \"  SELECT dim1, \\\"__time\\\", m1 from foo WHERE \\\"dim1\\\" = '10.1'\\n\"\n+        + \")\\n\"\n+        + \"SELECT t1.dim1, t1.\\\"__time\\\" from abc as t1 INNER JOIN abc as t2 on t1.dim1 = t2.dim1\\n\",\n+        ImmutableList.of(\n+            newScanQueryBuilder()\n+                .dataSource(\n+                    join(\n+                        new QueryDataSource(\n+                            newScanQueryBuilder()\n+                                .dataSource(CalciteTests.DATASOURCE1)\n+                                .intervals(querySegmentSpec(Filtration.eternity()))\n+                                .filters(new SelectorDimFilter(\"dim1\", \"10.1\", null))\n+                                .virtualColumns(expressionVirtualColumn(\"v0\", \"\\'10.1\\'\", ValueType.STRING))\n+                                .columns(ImmutableList.of(\"__time\", \"v0\"))\n+                                .resultFormat(ScanQuery.ResultFormat.RESULT_FORMAT_COMPACTED_LIST)\n+                                .context(QUERY_CONTEXT_DEFAULT)\n+                                .build()\n+                        ),\n+                        new QueryDataSource(\n+                            newScanQueryBuilder()\n+                                .dataSource(CalciteTests.DATASOURCE1)\n+                                .intervals(querySegmentSpec(Filtration.eternity()))\n+                                .filters(new SelectorDimFilter(\"dim1\", \"10.1\", null))\n+                                .columns(ImmutableList.of(\"dim1\"))\n+                                .resultFormat(ScanQuery.ResultFormat.RESULT_FORMAT_COMPACTED_LIST)\n+                                .context(QUERY_CONTEXT_DEFAULT)\n+                                .build()\n+                        ),\n+                        \"j0.\",\n+                        equalsCondition(DruidExpression.fromColumn(\"v0\"), DruidExpression.fromColumn(\"j0.dim1\")),\n+                        JoinType.INNER\n+                    )\n+                )\n+                .intervals(querySegmentSpec(Filtration.eternity()))\n+                .virtualColumns(expressionVirtualColumn(\"_v0\", \"\\'10.1\\'\", ValueType.STRING))\n+                .columns(\"__time\", \"_v0\")\n+                .context(QUERY_CONTEXT_DEFAULT)\n+                .build()\n+        ),\n+        ImmutableList.of(\n+            new Object[]{\"10.1\", 946771200000L}\n+        )\n+    );\n+  }\n+", "originalCommit": "2600c3f2d778c26533fc707a571ddf888fa5b170", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyOTI3MA==", "url": "https://github.com/apache/druid/pull/9941#discussion_r432229270", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-05-29T02:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4NDA4MQ=="}], "type": "inlineReview"}, {"oid": "e7dd9197e5c22b7523de7461a2ec7b69c9f2bb73", "url": "https://github.com/apache/druid/commit/e7dd9197e5c22b7523de7461a2ec7b69c9f2bb73", "message": "addreess comments", "committedDate": "2020-05-29T03:08:20Z", "type": "commit"}, {"oid": "b3d57113ea8c30149abaf042814991e728446214", "url": "https://github.com/apache/druid/commit/b3d57113ea8c30149abaf042814991e728446214", "message": "Resolve merge conflict", "committedDate": "2020-05-29T03:21:01Z", "type": "commit"}, {"oid": "b78f93aa575cd881f846802c48f06f9eb723f0dd", "url": "https://github.com/apache/druid/commit/b78f93aa575cd881f846802c48f06f9eb723f0dd", "message": "set queryContext in tests", "committedDate": "2020-05-29T03:33:12Z", "type": "commit"}]}