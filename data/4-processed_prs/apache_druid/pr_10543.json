{"pr_number": 10543, "pr_title": "Avatica protobuf", "pr_createdAt": "2020-10-30T16:22:33Z", "pr_url": "https://github.com/apache/druid/pull/10543", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0MTg5Mw==", "url": "https://github.com/apache/druid/pull/10543#discussion_r534441893", "bodyText": "What is this variable for?", "author": "jihoonson", "createdAt": "2020-12-02T19:55:30Z", "path": "server/src/main/java/org/apache/druid/server/AsyncQueryForwardingServlet.java", "diffHunk": "@@ -88,6 +92,7 @@\n   private static final String OBJECTMAPPER_ATTRIBUTE = \"org.apache.druid.proxy.objectMapper\";\n \n   private static final int CANCELLATION_TIMEOUT_MILLIS = 500;\n+  private static final long serialVersionUID = 2026655693637894524L;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE5NjcyNw==", "url": "https://github.com/apache/druid/pull/10543#discussion_r535196727", "bodyText": "It's because I'm using the transient keyword below and the class is serializable (documentation) and basically to satisfy LGMT", "author": "lkm", "createdAt": "2020-12-03T12:43:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0MTg5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1NTc3MQ==", "url": "https://github.com/apache/druid/pull/10543#discussion_r545455771", "bodyText": "I think we can ignore LGTM in this case. Please delete this too.", "author": "jihoonson", "createdAt": "2020-12-17T22:52:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0MTg5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0MjA3Mw==", "url": "https://github.com/apache/druid/pull/10543#discussion_r534442073", "bodyText": "What is transient keyword for?", "author": "jihoonson", "createdAt": "2020-12-02T19:55:51Z", "path": "server/src/main/java/org/apache/druid/server/AsyncQueryForwardingServlet.java", "diffHunk": "@@ -119,6 +124,7 @@ private static void handleException(HttpServletResponse response, ObjectMapper o\n   private final RequestLogger requestLogger;\n   private final GenericQueryMetricsFactory queryMetricsFactory;\n   private final AuthenticatorMapper authenticatorMapper;\n+  private final transient ProtobufTranslation protobufTranslation;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE5NTcwNQ==", "url": "https://github.com/apache/druid/pull/10543#discussion_r535195705", "bodyText": "The servlet is serializable and the ProtobufTranslation isn't, so this is required", "author": "lkm", "createdAt": "2020-12-03T12:41:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0MjA3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc0MTQxOA==", "url": "https://github.com/apache/druid/pull/10543#discussion_r535741418", "bodyText": "Hmm, I didn't know that the servlet is serializable. However, it seems that Jetty doesn't support serializing servlets anyway. I would suggest to not add it since it can be misleading as other variables are not transient.", "author": "jihoonson", "createdAt": "2020-12-04T00:15:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0MjA3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEwMzQwMA==", "url": "https://github.com/apache/druid/pull/10543#discussion_r544103400", "bodyText": "After removing transient spotbugs is failing with\norg.apache.calcite.avatica.remote.ProtobufTranslationImpl stored into non-transient field", "author": "lkm", "createdAt": "2020-12-16T08:28:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0MjA3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUwNTU2NQ==", "url": "https://github.com/apache/druid/pull/10543#discussion_r545505565", "bodyText": "You can add an exclusion rule for it here.", "author": "jihoonson", "createdAt": "2020-12-18T01:03:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0MjA3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0NTA1OA==", "url": "https://github.com/apache/druid/pull/10543#discussion_r534445058", "bodyText": "These if clause seems fragile from changes on Avatica request types (such as new request type), but I'm not sure if there is a better way..", "author": "jihoonson", "createdAt": "2020-12-02T20:01:07Z", "path": "server/src/main/java/org/apache/druid/server/AsyncQueryForwardingServlet.java", "diffHunk": "@@ -449,6 +463,95 @@ static String getAvaticaConnectionId(Map<String, Object> requestMap)\n     return (String) connectionIdObj;\n   }\n \n+  static String getAvaticaProtobufConnectionId(Service.Request request)\n+  {\n+    if (request instanceof Service.CatalogsRequest) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE2NDgyNg==", "url": "https://github.com/apache/druid/pull/10543#discussion_r535164826", "bodyText": "Agreed, it's a bit fragile, however, that, I'm afraid, is the nature of protobufs. I'm not sure how likely they are to add new request types without significant overhaul to Calcite though", "author": "lkm", "createdAt": "2020-12-03T12:01:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0NTA1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0NjQ5Nw==", "url": "https://github.com/apache/druid/pull/10543#discussion_r534446497", "bodyText": "I'm wondering if we can use the same path for both Avatica and Json, but accept a query parameter to choose one of them. I think it could be better in terms of maintenance. In AsyncQueryForwardingServlet, it seems that you can check the query string. In DruidAvaticaHandler, it can have two delegates for JSON and protobuf and calls one of them based on query string in the request.", "author": "jihoonson", "createdAt": "2020-12-02T20:03:30Z", "path": "sql/src/main/java/org/apache/druid/sql/avatica/DruidAvaticaProtobufHandler.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.avatica;\n+\n+import com.google.inject.Inject;\n+import org.apache.calcite.avatica.remote.LocalService;\n+import org.apache.calcite.avatica.remote.Service;\n+import org.apache.calcite.avatica.server.AvaticaProtobufHandler;\n+import org.apache.druid.guice.annotations.Self;\n+import org.apache.druid.server.DruidNode;\n+import org.eclipse.jetty.server.Request;\n+\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+\n+public class DruidAvaticaProtobufHandler extends AvaticaProtobufHandler\n+{\n+  public static final String AVATICA_PATH = \"/druid/v2/sql/avatica-pb/\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE2MzI1OA==", "url": "https://github.com/apache/druid/pull/10543#discussion_r535163258", "bodyText": "The problem is the drivers. If we want to support JDBC and golang drivers, I'm not sure they would be happy with always appending a query param to the url. The other option I can think of that may work is to auto-detect it when the first letter of the post is [ or { (ie. json), that just seemed a bit dirty to me", "author": "lkm", "createdAt": "2020-12-03T11:59:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0NjQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc0MTQwMA==", "url": "https://github.com/apache/druid/pull/10543#discussion_r535741400", "bodyText": "I see. It sounds reasonable to me.", "author": "jihoonson", "createdAt": "2020-12-04T00:15:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0NjQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI4MTM1Ng==", "url": "https://github.com/apache/druid/pull/10543#discussion_r543281356", "bodyText": "@jihoonson To be clear, do you think I should go the JSON sniffer way instead of having a separate endpoint?", "author": "lkm", "createdAt": "2020-12-15T11:56:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0NjQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUwNTEwNA==", "url": "https://github.com/apache/druid/pull/10543#discussion_r545505104", "bodyText": "No, I think having a separate endpoint makes sense.", "author": "jihoonson", "createdAt": "2020-12-18T01:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ0NjQ5Nw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY5NDUzMw==", "url": "https://github.com/apache/druid/pull/10543#discussion_r551694533", "bodyText": "side note, since we now have avatica stuff as dependencies to this project, it probably makes sense in a follow-up to modify the JSON version to use the types like this is doing instead of deserializing to a map.", "author": "clintropolis", "createdAt": "2021-01-05T03:17:35Z", "path": "server/src/main/java/org/apache/druid/server/AsyncQueryForwardingServlet.java", "diffHunk": "@@ -457,6 +470,95 @@ static String getAvaticaConnectionId(Map<String, Object> requestMap)\n     return (String) connectionIdObj;\n   }\n \n+  static String getAvaticaProtobufConnectionId(Service.Request request)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc5MjQwOQ==", "url": "https://github.com/apache/druid/pull/10543#discussion_r572792409", "bodyText": "I'm not sure how much there is to gain from that, what are you thinking would be the advantage? Also, looking through it I can't find an easy to use class like ProtobufTranslationImpl for json.", "author": "lkm", "createdAt": "2021-02-09T11:03:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY5NDUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzMxNTYxNQ==", "url": "https://github.com/apache/druid/pull/10543#discussion_r587315615", "bodyText": "BTW, I guess the reason would be defensive for the most part, to more strongly type the check so that whenever we upgrade the library, stuff would fail at compile time instead of just fail in strange ways at run time if any of the requests ever change, however unlikely.\nSome of the unit tests for the json path are using the avatica types for json to test this area already, so was just thinking since its used as a runtime depend now we could use the expected types for non tests too. But yeah, its definitely not necessary and doesn't provide a lot of gain, nor do I think we should do it in this PR or anything.", "author": "clintropolis", "createdAt": "2021-03-04T09:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY5NDUzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY5NjkwMQ==", "url": "https://github.com/apache/druid/pull/10543#discussion_r551696901", "bodyText": "super nitpick: I think it might be nicer to spell out the endpoint e.g. /druid/v2/sql/avatica-protobuf/ instead of /druid/v2/sql/avatica-pb/, but I don't feel super strongly about this and is also ok as it is", "author": "clintropolis", "createdAt": "2021-01-05T03:27:29Z", "path": "sql/src/main/java/org/apache/druid/sql/avatica/DruidAvaticaProtobufHandler.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.sql.avatica;\n+\n+import com.google.inject.Inject;\n+import org.apache.calcite.avatica.remote.LocalService;\n+import org.apache.calcite.avatica.remote.Service;\n+import org.apache.calcite.avatica.server.AvaticaProtobufHandler;\n+import org.apache.druid.guice.annotations.Self;\n+import org.apache.druid.server.DruidNode;\n+import org.eclipse.jetty.server.Request;\n+\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+\n+public class DruidAvaticaProtobufHandler extends AvaticaProtobufHandler\n+{\n+  public static final String AVATICA_PATH = \"/druid/v2/sql/avatica-pb/\";", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc2OTM3Ng==", "url": "https://github.com/apache/druid/pull/10543#discussion_r572769376", "bodyText": "Happy to, I don't feel strongly about it either", "author": "lkm", "createdAt": "2021-02-09T10:32:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY5NjkwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY5NzkyMA==", "url": "https://github.com/apache/druid/pull/10543#discussion_r551697920", "bodyText": "i wonder if this was causing some problem before... looking at other implementations some do check for null on this field, \ud83d\udc4d", "author": "clintropolis", "createdAt": "2021-01-05T03:32:03Z", "path": "sql/src/main/java/org/apache/druid/sql/avatica/DruidMeta.java", "diffHunk": "@@ -104,8 +104,10 @@ public void openConnection(final ConnectionHandle ch, final Map<String, String>\n   {\n     // Build connection context.\n     final ImmutableMap.Builder<String, Object> context = ImmutableMap.builder();\n-    for (Map.Entry<String, String> entry : info.entrySet()) {\n-      context.put(entry);\n+    if (info != null) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY5ODU2NQ==", "url": "https://github.com/apache/druid/pull/10543#discussion_r551698565", "bodyText": "nit: I wonder if this test would be better using @RunWith(JUnitParamsRunner.class)  with the different handler implementations instead of making it an abstract class", "author": "clintropolis", "createdAt": "2021-01-05T03:34:34Z", "path": "sql/src/test/java/org/apache/druid/sql/avatica/DruidAvaticaHandlerTest.java", "diffHunk": "@@ -101,7 +101,7 @@\n import java.util.concurrent.Executors;\n import java.util.concurrent.ThreadLocalRandom;\n \n-public class DruidAvaticaHandlerTest extends CalciteTestBase\n+public abstract class DruidAvaticaHandlerTest extends CalciteTestBase", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc2OTAzNA==", "url": "https://github.com/apache/druid/pull/10543#discussion_r572769034", "bodyText": "Would that not make the test harder to read? You mean parameterising each test case? I was going for a lighter touch approach, the abstracted methods are called in setUp, which would then need rewriting", "author": "lkm", "createdAt": "2021-02-09T10:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY5ODU2NQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "35a4fb31a7889134825443e0f1713239b78a4383", "url": "https://github.com/apache/druid/commit/35a4fb31a7889134825443e0f1713239b78a4383", "message": "Add Calcite Avatica protobuf handler", "committedDate": "2021-03-31T13:49:24Z", "type": "commit"}, {"oid": "35a4fb31a7889134825443e0f1713239b78a4383", "url": "https://github.com/apache/druid/commit/35a4fb31a7889134825443e0f1713239b78a4383", "message": "Add Calcite Avatica protobuf handler", "committedDate": "2021-03-31T13:49:24Z", "type": "forcePushed"}]}