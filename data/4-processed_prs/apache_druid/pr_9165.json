{"pr_number": 9165, "pr_title": "Forbid easily misused HashSet and HashMap constructors", "pr_createdAt": "2020-01-10T21:59:01Z", "pr_url": "https://github.com/apache/druid/pull/9165", "timeline": [{"oid": "33160aa6fd3ebef58ece747590ce189260ca7b1c", "url": "https://github.com/apache/druid/commit/33160aa6fd3ebef58ece747590ce189260ca7b1c", "message": "Forbid easily misused HashSet and HashMap constructors", "committedDate": "2020-01-10T21:44:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI4MTEzOQ==", "url": "https://github.com/apache/druid/pull/9165#discussion_r367281139", "bodyText": "LinkedHashMap should be prohibited, too, even though there is no method ready in Guava. A polyfill method could be added to CollectionUtils.", "author": "leventov", "createdAt": "2020-01-16T08:16:51Z", "path": "codestyle/druid-forbidden-apis.txt", "diffHunk": "@@ -31,6 +31,12 @@ java.lang.String#replace(java.lang.CharSequence,java.lang.CharSequence) @ Use on\n java.lang.String#replaceAll(java.lang.String,java.lang.String) @ Use one of the appropriate methods in StringUtils instead, or compile and cache a Pattern explicitly\n java.lang.String#replaceFirst(java.lang.String,java.lang.String) @ Use String.indexOf() and substring methods, or compile and cache a Pattern explicitly\n java.nio.file.Files#createTempDirectory(java.lang.String prefix,java.nio.file.FileAttribute...) @ Use org.apache.druid.java.util.common.FileUtils.createTempDir()\n+java.util.HashMap#<init>(int) @ Use com.google.common.collect.Maps#newHashMapWithExpectedSize(int) instead\n+java.util.HashMap#<init>(int, float) @ Use com.google.common.collect.Maps#newHashMapWithExpectedSize(int) instead\n+java.util.HashSet#<init>(int) @ Use com.google.collect.Sets#newHashSetWithExpectedSize(int) instead\n+java.util.HashSet#<init>(int, float) @ Use com.google.collect.Sets#newHashSetWithExpectedSize(int) instead\n+java.util.LinkedHashSet#<init>(int) @ Use com.google.collect.Sets#newLinkedHashSatWithExpectedSize(int) instead\n+java.util.LinkedHashSet#<init>(int, float) @ Use com.google.collect.Sets#newLinkedHashSatWithExpectedSize(int) instead", "originalCommit": "33160aa6fd3ebef58ece747590ce189260ca7b1c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5b10662517f7087e8677cf15ec30805acc8a3905", "url": "https://github.com/apache/druid/commit/5b10662517f7087e8677cf15ec30805acc8a3905", "message": "Add two LinkedHashMap constructors to forbidden-apis and create utility method as replacement for them", "committedDate": "2020-01-17T21:43:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIxMzU5MQ==", "url": "https://github.com/apache/druid/pull/9165#discussion_r368213591", "bodyText": "Nit: should better be private.", "author": "leventov", "createdAt": "2020-01-18T07:59:44Z", "path": "core/src/main/java/org/apache/druid/utils/CollectionUtils.java", "diffHunk": "@@ -39,6 +41,8 @@\n \n public final class CollectionUtils\n {\n+  public static final int MAX_EXPECTED_SIZE = (1 << 30);", "originalCommit": "5b10662517f7087e8677cf15ec30805acc8a3905", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIyNzQxMg==", "url": "https://github.com/apache/druid/pull/9165#discussion_r368227412", "bodyText": "Thanks for catching that", "author": "capistrant", "createdAt": "2020-01-18T13:38:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIxMzU5MQ=="}], "type": "inlineReview"}, {"oid": "de5575928cf2353d8d7684e2fa3541bde936f923", "url": "https://github.com/apache/druid/commit/de5575928cf2353d8d7684e2fa3541bde936f923", "message": "Fix visibility of constant in CollectionUtils.java", "committedDate": "2020-01-18T13:37:46Z", "type": "commit"}, {"oid": "17f445cdc76b76248dc722dcc74c89887bbcbacc", "url": "https://github.com/apache/druid/commit/17f445cdc76b76248dc722dcc74c89887bbcbacc", "message": "Merge remote-tracking branch 'origin/master' into issue-8423", "committedDate": "2020-01-29T19:37:25Z", "type": "commit"}, {"oid": "b54ce15d16d605eacbf50334ec7503d733683f19", "url": "https://github.com/apache/druid/commit/b54ce15d16d605eacbf50334ec7503d733683f19", "message": "Merge remote-tracking branch 'origin/master' into issue-8423", "committedDate": "2020-02-06T14:57:42Z", "type": "commit"}, {"oid": "b0fde11d6d7840c43202940500e1f1e575d84584", "url": "https://github.com/apache/druid/commit/b0fde11d6d7840c43202940500e1f1e575d84584", "message": "Make an exception for an instance of LinkedHashMap#<init>(int) because proper sizing is used", "committedDate": "2020-02-06T16:20:14Z", "type": "commit"}, {"oid": "42f7b2c0c8df85eb737d766efeef88af6cf2d985", "url": "https://github.com/apache/druid/commit/42f7b2c0c8df85eb737d766efeef88af6cf2d985", "message": "revert changes to sql module tests that should be in separate PR", "committedDate": "2020-02-06T16:23:16Z", "type": "commit"}, {"oid": "2c5178dc1913436fe14f8e7e8ba7df7782adffa3", "url": "https://github.com/apache/druid/commit/2c5178dc1913436fe14f8e7e8ba7df7782adffa3", "message": "Finish reverting changes to sql module tests that were flagged in checkstyle during CI", "committedDate": "2020-02-06T21:15:54Z", "type": "commit"}, {"oid": "3f8090fb9bf471edb5b84c13f9ed511ef0c93b1f", "url": "https://github.com/apache/druid/commit/3f8090fb9bf471edb5b84c13f9ed511ef0c93b1f", "message": "Add netty dependency resulting from SupressForbidden", "committedDate": "2020-02-06T22:58:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI1MDk5Nw==", "url": "https://github.com/apache/druid/pull/9165#discussion_r376250997", "bodyText": "I've created https://issues.apache.org/jira/browse/AVRO-2731 and #9331 to track this. FYI @Fokko.\n@capistrant please try to create such issues yourself to close the loops and offload info from the heads of people.", "author": "leventov", "createdAt": "2020-02-07T07:43:50Z", "path": "pom.xml", "diffHunk": "@@ -1341,6 +1341,9 @@\n                         <signaturesFile>${project.parent.basedir}/codestyle/joda-time-forbidden-apis.txt</signaturesFile>\n                         <signaturesFile>${project.parent.basedir}/codestyle/druid-forbidden-apis.txt</signaturesFile>\n                     </signaturesFiles>\n+                    <excludes>\n+                      <exclude>**/SomeAvroDatum.class</exclude>", "originalCommit": "3f8090fb9bf471edb5b84c13f9ed511ef0c93b1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}