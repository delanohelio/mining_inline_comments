{"pr_number": 9647, "pr_title": "document useFilterCNF query context parameter", "pr_createdAt": "2020-04-08T10:16:09Z", "pr_url": "https://github.com/apache/druid/pull/9647", "timeline": [{"oid": "2cbf0a2d516b4d4178f38163bdb4dc6a822ca442", "url": "https://github.com/apache/druid/commit/2cbf0a2d516b4d4178f38163bdb4dc6a822ca442", "message": "document useFilterCNF query context parameter", "committedDate": "2020-04-08T10:06:49Z", "type": "commit"}, {"oid": "5c2c087b4d728ce05883adf483d256da54a561d2", "url": "https://github.com/apache/druid/commit/5c2c087b4d728ce05883adf483d256da54a561d2", "message": "move context key to QueryContexts", "committedDate": "2020-04-08T10:14:53Z", "type": "commit"}, {"oid": "ee9f6e98deaa16ad927583d67b4fea4175efbd24", "url": "https://github.com/apache/druid/commit/ee9f6e98deaa16ad927583d67b4fea4175efbd24", "message": "Update .spelling", "committedDate": "2020-04-09T01:53:46Z", "type": "commit"}, {"oid": "8a920d36429e0cfb218fd0f81c8ee52943248dc9", "url": "https://github.com/apache/druid/commit/8a920d36429e0cfb218fd0f81c8ee52943248dc9", "message": "Merge remote-tracking branch 'upstream/master' into doc-useFilterCNF-context-parameter", "committedDate": "2020-04-09T04:38:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk2OTIwMA==", "url": "https://github.com/apache/druid/pull/9647#discussion_r405969200", "bodyText": "\ud83d\udc4d", "author": "jon-wei", "createdAt": "2020-04-09T05:47:20Z", "path": "processing/src/main/java/org/apache/druid/query/QueryContexts.java", "diffHunk": "@@ -67,7 +68,8 @@\n   public static final boolean DEFAULT_ENABLE_JOIN_FILTER_PUSH_DOWN = true;\n   public static final boolean DEFAULT_ENABLE_JOIN_FILTER_REWRITE = true;\n   public static final boolean DEFAULT_ENABLE_JOIN_FILTER_REWRITE_VALUE_COLUMN_FILTERS = false;\n-  public static final long DEFAULT_ENABLE_JOIN_FILTER_REWRITE_MAX_SIZE_KEY = 10000;", "originalCommit": "8a920d36429e0cfb218fd0f81c8ee52943248dc9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk3MjA2Nw==", "url": "https://github.com/apache/druid/pull/9647#discussion_r405972067", "bodyText": "But this effect only happens for the top level filter, or individual clauses of a top level 'and' filter.\n\nSuggest providing a few examples to clarify:\n\nAn OR filter A || B where A can be resolved using bitmap indexes but B cannot will prevent the whole OR filter from being considered for pre-filtering\nIf it were A && B instead, A would be considered for pre-filtering but B would not.\nIf it were A && (C || D) where C and D can be resolved using bitmap indexes, then the whole filter can be considered for pre-filtering\nIf were A && (B || C) only A will be considered for pre-filtering", "author": "jon-wei", "createdAt": "2020-04-09T05:56:57Z", "path": "docs/querying/query-context.md", "diffHunk": "@@ -45,6 +45,7 @@ The query context is used for various query configuration parameters. The follow\n |parallelMergeParallelism|`druid.processing.merge.pool.parallelism`|Maximum number of parallel threads to use for parallel result merging on the Broker. See [Broker configuration](../configuration/index.html#broker) for more details.|\n |parallelMergeInitialYieldRows|`druid.processing.merge.task.initialYieldNumRows`|Number of rows to yield per ForkJoinPool merge task for parallel result merging on the Broker, before forking off a new task to continue merging sequences. See [Broker configuration](../configuration/index.html#broker) for more details.|\n |parallelMergeSmallBatchRows|`druid.processing.merge.task.smallBatchNumRows`|Size of result batches to operate on in ForkJoinPool merge tasks for parallel result merging on the Broker. See [Broker configuration](../configuration/index.html#broker) for more details.|\n+|useFilterCNF|`false`| If true, Druid will attempt to convert the query filter to Conjunctive Normal Form (CNF). During query processing, columns can be pre-filtered by intersecting the bitmap indexes of all values that match the eligible filters, often greatly reducing the raw number of rows which need to be scanned. But this effect only happens for the top level filter, or individual clauses of a top level 'and' filter. As such, filters in CNF potentially have a higher chance to utilize a large amount of bitmap indexes on string columns during pre-filtering. However, this setting should be used with great caution, as it can sometimes have a negative effect on performance, and in some cases, the act of computing CNF of a filter can be expensive. We recommend hand tuning your filters to produce an optimal form if possible, or at least verifying through experimentation that using this parameter actually improves your query performance with no ill-effects.|", "originalCommit": "8a920d36429e0cfb218fd0f81c8ee52943248dc9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk5OTg0OA==", "url": "https://github.com/apache/druid/pull/9647#discussion_r405999848", "bodyText": "Hmm, I think how filters work with query processing and how mechanically filters are split into pre and post filters should be documented somewhere, but I don't think this setting is quite the correct avenue. Additionally, since which filters can and can't use bitmaps isn't exactly documented anywhere, I'm not sure how much the examples would help.\nIf we added this general description of query processing and how filters are involved could link to this setting, and also could link to documentation we would add for the filterTuning added in #8209, as ways the user can help influence how filter processing behaves. Maybe segments.md would be an appropriate place since it mentions bitmaps and their role in filtering, or segment-optimization.md since it involves how to tune segment sizes? Or perhaps we need an advanced-tuning.md to put this and other stuff that users shouldn't really mess with unless they are prepared to roll up their sleeves and experimentally verify the settings to fine tune to their workload?\nShould this be part of this PR, or done as a follow-up? It sort of blows up the scope a bit of what I was looking to do as part of this PR, but it also seems useful so I'm fine either way.", "author": "clintropolis", "createdAt": "2020-04-09T07:11:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk3MjA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQyMzIxOQ==", "url": "https://github.com/apache/druid/pull/9647#discussion_r406423219", "bodyText": "Should this be part of this PR, or done as a follow-up? It sort of blows up the scope a bit of what I was looking to do as part of this PR, but it also seems useful so I'm fine either way.\n\nI think the filter tuning guide could be done in a follow-up, it sounds like something that would be much larger than this PR, this PR LGTM.\n(There's a merge conflict in the spelling exclusions now)", "author": "jon-wei", "createdAt": "2020-04-09T19:18:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk3MjA2Nw=="}], "type": "inlineReview"}, {"oid": "19cc541bc097034298052179d1b859e9b00682f3", "url": "https://github.com/apache/druid/commit/19cc541bc097034298052179d1b859e9b00682f3", "message": "Merge remote-tracking branch 'upstream/master' into doc-useFilterCNF-context-parameter", "committedDate": "2020-04-16T01:34:40Z", "type": "commit"}]}