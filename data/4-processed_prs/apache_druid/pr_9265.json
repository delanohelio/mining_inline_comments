{"pr_number": 9265, "pr_title": "Improve code quality and unit test coverage of the Azure extension", "pr_createdAt": "2020-01-27T18:14:07Z", "pr_url": "https://github.com/apache/druid/pull/9265", "timeline": [{"oid": "091376885687f874f60676728979be70c0e524df", "url": "https://github.com/apache/druid/commit/091376885687f874f60676728979be70c0e524df", "message": "IMPLY-1946: Improve code quality and unit test coverage of the Azure extension\n\n* Update unit tests to increase test coverage for the extension\n* Clean up any messy code\n* Enfore code coverage as part of tests.", "committedDate": "2020-01-27T02:56:05Z", "type": "commit"}, {"oid": "5b9e4c3b216e37a0292a278072283abdb425030f", "url": "https://github.com/apache/druid/commit/5b9e4c3b216e37a0292a278072283abdb425030f", "message": "Merge remote-tracking branch 'origin/master' into IMPLY-1946", "committedDate": "2020-01-27T19:50:09Z", "type": "commit"}, {"oid": "c845f68a0b4fa5b0e90f527b13bf6525660ed353", "url": "https://github.com/apache/druid/commit/c845f68a0b4fa5b0e90f527b13bf6525660ed353", "message": "* Update azure extension pom to remove unnecessary things\n* update jacoco thresholds", "committedDate": "2020-01-27T21:10:56Z", "type": "commit"}, {"oid": "85aa0a004dd6d544de111c980f1f3507cd7ac429", "url": "https://github.com/apache/druid/commit/85aa0a004dd6d544de111c980f1f3507cd7ac429", "message": "* updgrade version of azure-storage library version uses to\n  most upto-date version", "committedDate": "2020-01-27T22:33:24Z", "type": "commit"}, {"oid": "85293294d93e4bd7f08efa207e873c49de97d135", "url": "https://github.com/apache/druid/commit/85293294d93e4bd7f08efa207e873c49de97d135", "message": "Merge remote-tracking branch 'origin/master' into IMPLY-1946", "committedDate": "2020-01-28T00:08:57Z", "type": "commit"}, {"oid": "c5103fb69db63e058b68edfc52dddc33509101d4", "url": "https://github.com/apache/druid/commit/c5103fb69db63e058b68edfc52dddc33509101d4", "message": "* exclude common libraries that are included from druid core", "committedDate": "2020-01-28T23:36:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAyNzU0Mg==", "url": "https://github.com/apache/druid/pull/9265#discussion_r372027542", "bodyText": "Would you change the log level to debug? it doesn't look worth to be the info level.", "author": "jihoonson", "createdAt": "2020-01-28T20:04:09Z", "path": "extensions-contrib/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentPusher.java", "diffHunk": "@@ -179,4 +151,36 @@ public DataSegment push(final File indexFilesDir, final DataSegment segment, fin\n         uri.toString()\n     );\n   }\n+\n+  @VisibleForTesting\n+  String getAzurePath(final DataSegment segment, final boolean useUniquePath)\n+  {\n+    final String storageDir = this.getStorageDir(segment, useUniquePath);\n+\n+    return StringUtils.format(\"%s/%s\", storageDir, AzureStorageDruidModule.INDEX_ZIP_FILE_NAME);\n+\n+  }\n+\n+  @VisibleForTesting\n+  DataSegment uploadDataSegment(\n+      DataSegment segment,\n+      final int binaryVersion,\n+      final long size,\n+      final File compressedSegmentData,\n+      final String azurePath\n+  )\n+      throws StorageException, IOException, URISyntaxException\n+  {\n+    azureStorage.uploadBlob(compressedSegmentData, config.getContainer(), azurePath);\n+\n+    final DataSegment outSegment = segment\n+        .withSize(size)\n+        .withLoadSpec(this.makeLoadSpec(new URI(azurePath)))\n+        .withBinaryVersion(binaryVersion);\n+\n+    log.info(\"Deleting file [%s]\", compressedSegmentData);", "originalCommit": "85293294d93e4bd7f08efa207e873c49de97d135", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI3NzQ4OA==", "url": "https://github.com/apache/druid/pull/9265#discussion_r373277488", "bodyText": "fixed", "author": "zachjsh", "createdAt": "2020-01-31T01:21:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAyNzU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxNzYzNA==", "url": "https://github.com/apache/druid/pull/9265#discussion_r373217634", "bodyText": "Haha, is this question for the reviewers? I think RuntimeException is enough for now.", "author": "jihoonson", "createdAt": "2020-01-30T22:02:21Z", "path": "extensions-contrib/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureDataSegmentPusher.java", "diffHunk": "@@ -157,6 +128,7 @@ public DataSegment push(final File indexFilesDir, final DataSegment segment, fin\n       );\n     }\n     catch (Exception e) {\n+      // do we want to throw a specfic exception here? Interface only expects IOExceptions to be thrown.", "originalCommit": "c5103fb69db63e058b68edfc52dddc33509101d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI3NzQ1Mg==", "url": "https://github.com/apache/druid/pull/9265#discussion_r373277452", "bodyText": "removed comment", "author": "zachjsh", "createdAt": "2020-01-31T01:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxNzYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxODcwOQ==", "url": "https://github.com/apache/druid/pull/9265#discussion_r373218709", "bodyText": "nit: this method not just returns a container, but can create it if it doesn't exist. Maybe better to rename to something more clear such as getOrCreateCloudBlobContainer().", "author": "jihoonson", "createdAt": "2020-01-30T22:05:02Z", "path": "extensions-contrib/azure-extensions/src/main/java/org/apache/druid/storage/azure/AzureStorage.java", "diffHunk": "@@ -95,13 +87,34 @@ public long getBlobLength(final String containerName, final String blobPath)\n \n   public InputStream getBlobInputStream(final String containerName, final String blobPath)\n       throws URISyntaxException, StorageException\n+  {\n+    return getBlobInputStream(0L, containerName, blobPath);\n+  }\n+\n+  public InputStream getBlobInputStream(long offset, final String containerName, final String blobPath)\n+      throws URISyntaxException, StorageException\n   {\n     CloudBlobContainer container = getCloudBlobContainer(containerName);\n-    return container.getBlockBlobReference(blobPath).openInputStream();\n+    return container.getBlockBlobReference(blobPath).openInputStream(offset, null, null, null, null);\n   }\n \n   public boolean getBlobExists(String container, String blobPath) throws URISyntaxException, StorageException\n   {\n     return getCloudBlobContainer(container).getBlockBlobReference(blobPath).exists();\n   }\n+\n+  @VisibleForTesting\n+  CloudBlobClient getCloudBlobClient()\n+  {\n+    return this.cloudBlobClient;\n+  }\n+\n+  private CloudBlobContainer getCloudBlobContainer(final String containerName)", "originalCommit": "c5103fb69db63e058b68edfc52dddc33509101d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI3NzM5Nw==", "url": "https://github.com/apache/druid/pull/9265#discussion_r373277397", "bodyText": "fixed", "author": "zachjsh", "createdAt": "2020-01-31T01:21:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxODcwOQ=="}], "type": "inlineReview"}, {"oid": "bda1b5f9363b2619006068f3b11262b967850c4a", "url": "https://github.com/apache/druid/commit/bda1b5f9363b2619006068f3b11262b967850c4a", "message": "* address review comments", "committedDate": "2020-01-31T01:19:34Z", "type": "commit"}, {"oid": "432136882c43bd4cb568c510d93bdbf032ca67ec", "url": "https://github.com/apache/druid/commit/432136882c43bd4cb568c510d93bdbf032ca67ec", "message": "Merge remote-tracking branch 'apache/master' into IMPLY-1946", "committedDate": "2020-01-31T01:19:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4MDQwOA==", "url": "https://github.com/apache/druid/pull/9265#discussion_r373280408", "bodyText": "Thanks for adding it. Even though we disabled coveralls in #8382 because of its flakiness, this test seems to be working based on the CI history of this PR. I think it's better than not having it. We can apply to the entire project later someday.", "author": "jihoonson", "createdAt": "2020-01-31T01:33:22Z", "path": "extensions-contrib/azure-extensions/pom.xml", "diffHunk": "@@ -135,4 +142,66 @@\n         </dependency>\n     </dependencies>\n \n+    <build>\n+        <plugins>\n+            <plugin>\n+                <groupId>org.jacoco</groupId>\n+                <artifactId>jacoco-maven-plugin</artifactId>", "originalCommit": "432136882c43bd4cb568c510d93bdbf032ca67ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b38f90f76a83a0e7f18a11a983da92aeeed8b4be", "url": "https://github.com/apache/druid/commit/b38f90f76a83a0e7f18a11a983da92aeeed8b4be", "message": "Merge remote-tracking branch 'apache/master' into IMPLY-1946", "committedDate": "2020-01-31T18:00:47Z", "type": "commit"}]}