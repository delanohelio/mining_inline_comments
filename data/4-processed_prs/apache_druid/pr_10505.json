{"pr_number": 10505, "pr_title": "Avro union support", "pr_createdAt": "2020-10-10T23:45:27Z", "pr_url": "https://github.com/apache/druid/pull/10505", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODgyMjY5MQ==", "url": "https://github.com/apache/druid/pull/10505#discussion_r648822691", "bodyText": "super nit: i think it's -> its", "author": "clintropolis", "createdAt": "2021-06-10T03:27:22Z", "path": "docs/development/extensions-core/avro.md", "diffHunk": "@@ -39,13 +39,24 @@ Make sure to [include](../../development/extensions.md#loading-extensions) `drui\n \n Druid supports most Avro types natively, there are however some exceptions which are detailed here.\n \n-`union` types which aren't of the form `[null, otherType]` aren't supported at this time.\n+#### Unions\n+Druid has two modes for supporting `union` types. The original legacy mode can only support unions of the form `[null, otherType]`.\n+The newer mode can be enabled by setting `extractUnions` on the Avro parser in which case unions will be expanded according to the following rules:\n+* Primitive types and unnamed complex types are keyed their type name. i.e `int`, `string`\n+* Complex named types are keyed by their names, this includes `record`, `fixed` and `enum`.\n+* The Avro null type is elided as it's value can only ever be null", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODgyMjg0OQ==", "url": "https://github.com/apache/druid/pull/10505#discussion_r648822849", "bodyText": "nit: still using explode terminology", "author": "clintropolis", "createdAt": "2021-06-10T03:27:49Z", "path": "extensions-core/avro-extensions/src/main/java/org/apache/druid/data/input/avro/GenericAvroJsonProvider.java", "diffHunk": "@@ -195,4 +210,46 @@ public Object unwrap(final Object o)\n   {\n     return o;\n   }\n+\n+  private boolean isExplodableUnion(final Schema.Field field)", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODgzNjQ2MA==", "url": "https://github.com/apache/druid/pull/10505#discussion_r648836460", "bodyText": "Hmm, I looked a lot closer at this than I did on a previous pass, and I think the old docs were sort of wrong. Using the example someMultiMemberUnion type in this PR, I can still use a flatten spec to extract the values of any type with the existing code, apparently even including for record types, where the extraction path is $.someMultiMemberUnion.subString (instead of $.someMultiMemberUnion.UnionSubRecord.subString as in the mode added in this PR).\nAs such, with my better understanding I think it makes sense to instead call this new property extractUnionsByType or something similar, and clarify that this new mode requires using a flatten spec to extract the values, but with the benefit that you can selectively extract values of only a certain type so that they can be mapped to separate Druid columns or whatever. I also don't think it necessarily makes sense to refer to the other mode as legacy, since I guess it still has a use if the union is composed mainly of primitive types and all are able to be coerced into a common Druid type, or if it is a simple union type of the legacy form, which the new mode does not effect (since the isUnion code checks for more than 1 non-null type).\nSorry I didn't look closer into this previously and for the review churn, my bad.\nAlso because the new mode needs to be link to the flatten spec docs, maybe it makes sense to just move the unions description entirely into the complex types section, which also seems to mirror the Avro specification docs https://avro.apache.org/docs/current/spec.html#schema_complex", "author": "clintropolis", "createdAt": "2021-06-10T04:16:12Z", "path": "docs/development/extensions-core/avro.md", "diffHunk": "@@ -39,13 +39,24 @@ Make sure to [include](../../development/extensions.md#loading-extensions) `drui\n \n Druid supports most Avro types natively, there are however some exceptions which are detailed here.\n \n-`union` types which aren't of the form `[null, otherType]` aren't supported at this time.\n+#### Unions\n+Druid has two modes for supporting `union` types. The original legacy mode can only support unions of the form `[null, otherType]`.\n+The newer mode can be enabled by setting `extractUnions` on the Avro parser in which case unions will be expanded according to the following rules:", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0OTUzNzc3NA==", "url": "https://github.com/apache/druid/pull/10505#discussion_r649537774", "bodyText": "No problem, I think you are right and I will make these changes next week.", "author": "josephglanville", "createdAt": "2021-06-10T21:15:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODgzNjQ2MA=="}], "type": "inlineReview"}, {"oid": "0878f252ae6047ca3d6584317ae6ce7176e28dd7", "url": "https://github.com/apache/druid/commit/0878f252ae6047ca3d6584317ae6ce7176e28dd7", "message": "Avro union support", "committedDate": "2021-06-10T23:07:58Z", "type": "commit"}, {"oid": "b1bbd4a99a42bd3e482c20f7ab1d5ac306adb882", "url": "https://github.com/apache/druid/commit/b1bbd4a99a42bd3e482c20f7ab1d5ac306adb882", "message": "Document new union support", "committedDate": "2021-06-10T23:07:58Z", "type": "commit"}, {"oid": "fe3d3a1ac25fc7332bbb691e06f49bd7b8a4e394", "url": "https://github.com/apache/druid/commit/fe3d3a1ac25fc7332bbb691e06f49bd7b8a4e394", "message": "Add support for AvroStreamInputFormat and fix checkstyle", "committedDate": "2021-06-10T23:07:58Z", "type": "commit"}, {"oid": "5335b8a9f84ee29b92655f81769de5a45966e5c5", "url": "https://github.com/apache/druid/commit/5335b8a9f84ee29b92655f81769de5a45966e5c5", "message": "Extend multi-member union test schema and format", "committedDate": "2021-06-10T23:07:58Z", "type": "commit"}, {"oid": "cde6041505b7701aa2ca7d7a3253f82e46edba9f", "url": "https://github.com/apache/druid/commit/cde6041505b7701aa2ca7d7a3253f82e46edba9f", "message": "Some additional docs and add Enums to spelling", "committedDate": "2021-06-10T23:07:58Z", "type": "commit"}, {"oid": "79c1fbfe0f0882d7e33f680e3d03f96b62a26b6f", "url": "https://github.com/apache/druid/commit/79c1fbfe0f0882d7e33f680e3d03f96b62a26b6f", "message": "Rename explodeUnions -> extractUnions", "committedDate": "2021-06-10T23:07:58Z", "type": "commit"}, {"oid": "438722e42333701ab044e971109aa291f50f5743", "url": "https://github.com/apache/druid/commit/438722e42333701ab044e971109aa291f50f5743", "message": "explode -> extract", "committedDate": "2021-06-10T23:11:16Z", "type": "commit"}, {"oid": "3ebd657d19191c8f55542a797fb5f230b026a22d", "url": "https://github.com/apache/druid/commit/3ebd657d19191c8f55542a797fb5f230b026a22d", "message": "ByType", "committedDate": "2021-06-11T00:41:45Z", "type": "commit"}, {"oid": "3ebd657d19191c8f55542a797fb5f230b026a22d", "url": "https://github.com/apache/druid/commit/3ebd657d19191c8f55542a797fb5f230b026a22d", "message": "ByType", "committedDate": "2021-06-11T00:41:45Z", "type": "forcePushed"}, {"oid": "c17aa1f379c02ee484f8b179f7500c26419bc501", "url": "https://github.com/apache/druid/commit/c17aa1f379c02ee484f8b179f7500c26419bc501", "message": "Correct spelling error", "committedDate": "2021-06-27T07:14:05Z", "type": "commit"}]}