{"pr_number": 10669, "pr_title": "Do Integrate test for Druid base on K8s cluster", "pr_createdAt": "2020-12-11T08:31:32Z", "pr_url": "https://github.com/apache/druid/pull/10669", "timeline": [{"oid": "9b3a2ad3d7cf73bcc98122a7b959e0975ef03fa5", "url": "https://github.com/apache/druid/commit/9b3a2ad3d7cf73bcc98122a7b959e0975ef03fa5", "message": "add a travls job to do integrate test on K8s", "committedDate": "2020-12-11T07:49:34Z", "type": "commit"}, {"oid": "3ca937f5d33be1d9828db4ff2cf4866928109d00", "url": "https://github.com/apache/druid/commit/3ca937f5d33be1d9828db4ff2cf4866928109d00", "message": "revert build_run_cluster.sh", "committedDate": "2020-12-11T07:55:09Z", "type": "commit"}, {"oid": "1183b70c5d0f9a2ade0c106f54092ee3ed2a04b1", "url": "https://github.com/apache/druid/commit/1183b70c5d0f9a2ade0c106f54092ee3ed2a04b1", "message": "revert msic", "committedDate": "2020-12-11T07:56:16Z", "type": "commit"}, {"oid": "f215f79d7b5567a5ae6e6f3b3dee41e589e6274b", "url": "https://github.com/apache/druid/commit/f215f79d7b5567a5ae6e6f3b3dee41e589e6274b", "message": "Merge branch 'master' into intergrate-test-base-on-K8s", "committedDate": "2020-12-11T07:56:51Z", "type": "commit"}, {"oid": "29f1d40d72c93bb0e66af2a885df9f426ccfb026", "url": "https://github.com/apache/druid/commit/29f1d40d72c93bb0e66af2a885df9f426ccfb026", "message": "run IT test", "committedDate": "2020-12-12T18:01:29Z", "type": "commit"}, {"oid": "2aef19ddc5971ead8006d77ac57eb7af36a544e3", "url": "https://github.com/apache/druid/commit/2aef19ddc5971ead8006d77ac57eb7af36a544e3", "message": "ready to test", "committedDate": "2020-12-12T18:44:25Z", "type": "commit"}, {"oid": "34901b27ce6b25c4c0b2f5509f7c4382e68af461", "url": "https://github.com/apache/druid/commit/34901b27ce6b25c4c0b2f5509f7c4382e68af461", "message": "modify before/after script", "committedDate": "2020-12-13T02:33:03Z", "type": "commit"}, {"oid": "3a57cf2331080341302c716f7d31fd51ba0be5de", "url": "https://github.com/apache/druid/commit/3a57cf2331080341302c716f7d31fd51ba0be5de", "message": "done", "committedDate": "2020-12-14T13:34:18Z", "type": "commit"}, {"oid": "dec7c6468a98d87b4cc63d545bc3863906835d58", "url": "https://github.com/apache/druid/commit/dec7c6468a98d87b4cc63d545bc3863906835d58", "message": "Merge branch 'master' into intergrate-test-base-on-K8s", "committedDate": "2020-12-14T13:34:24Z", "type": "commit"}, {"oid": "dec7c6468a98d87b4cc63d545bc3863906835d58", "url": "https://github.com/apache/druid/commit/dec7c6468a98d87b4cc63d545bc3863906835d58", "message": "Merge branch 'master' into intergrate-test-base-on-K8s", "committedDate": "2020-12-14T13:34:24Z", "type": "forcePushed"}, {"oid": "389d8905494bf38a9f076102f470eb884bd05931", "url": "https://github.com/apache/druid/commit/389d8905494bf38a9f076102f470eb884bd05931", "message": "change mod for script", "committedDate": "2020-12-14T23:55:46Z", "type": "commit"}, {"oid": "5d82d886da4036477fd29c36ae1fca2603ca8d0b", "url": "https://github.com/apache/druid/commit/5d82d886da4036477fd29c36ae1fca2603ca8d0b", "message": "Merge branch 'master' into intergrate-test-base-on-K8s", "committedDate": "2020-12-15T04:21:39Z", "type": "commit"}, {"oid": "adf69abdc59cc1bfc433fa8c13cc02c77a9b8a8e", "url": "https://github.com/apache/druid/commit/adf69abdc59cc1bfc433fa8c13cc02c77a9b8a8e", "message": "Merge branch 'master' into intergrate-test-base-on-K8s", "committedDate": "2020-12-15T08:10:52Z", "type": "commit"}, {"oid": "b7443be1f4dfc3ae9335bc87e4b420c0d059e400", "url": "https://github.com/apache/druid/commit/b7443be1f4dfc3ae9335bc87e4b420c0d059e400", "message": "done", "committedDate": "2020-12-15T13:45:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcyNDAyMA==", "url": "https://github.com/apache/druid/pull/10669#discussion_r543724020", "bodyText": "nit: not sure why we need to copy, can't we directly use those two files ?", "author": "himanshug", "createdAt": "2020-12-15T22:11:20Z", "path": "integration-tests/script/build_run_k8s_cluster.sh", "diffHunk": "@@ -0,0 +1,82 @@\n+#!/usr/bin/env bash\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+set -e\n+\n+# setup client keystore\n+cd integration-tests\n+./docker/tls/generate-client-certs-and-keystores.sh\n+rm -rf docker/client_tls\n+cp -r client_tls docker/client_tls\n+cd ..\n+\n+# Build Docker images for pods\n+mvn -B -ff -q dependency:go-offline \\\n+      install \\\n+      -Pdist,bundle-contrib-exts \\\n+      -Pskip-static-checks,skip-tests \\\n+      -Dmaven.javadoc.skip=true\n+\n+docker build -t druid/cluster:v1 -f distribution/docker/DockerfileBuildTarAdvanced .\n+\n+# Set Necessary ENV\n+export CHANGE_MINIKUBE_NONE_USER=true\n+export MINIKUBE_WANTUPDATENOTIFICATION=false\n+export MINIKUBE_WANTREPORTERRORPROMPT=false\n+export MINIKUBE_HOME=$HOME\n+export KUBECONFIG=$HOME/.kube/config\n+sudo apt install -y conntrack\n+\n+# This tmp dir is used for MiddleManager pod and Historical Pod to cache segments.\n+mkdir tmp\n+chmod 777 tmp\n+\n+# Lacunch K8S cluster\n+curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.18.1/bin/linux/amd64/kubectl && chmod +x kubectl && sudo mv kubectl /usr/local/bin/\n+curl -Lo minikube https://storage.googleapis.com/minikube/releases/v1.8.1/minikube-linux-amd64 && chmod +x minikube && sudo mv minikube /usr/local/bin/\n+sudo /usr/local/bin/minikube start --profile=minikube --vm-driver=none --kubernetes-version=v1.18.1\n+sudo /usr/local/bin/minikube update-context\n+\n+# Prepare For Druid-Operator\n+git clone https://github.com/druid-io/druid-operator.git\n+cd druid-operator\n+git checkout -b druid-operator-0.0.3 druid-operator-0.0.3\n+cd ..\n+sed -i 's|REPLACE_IMAGE|druidio/druid-operator:0.0.3|g' druid-operator/deploy/operator.yaml\n+cp integration-tests/tiny-cluster.yaml druid-operator/examples/\n+cp integration-tests/tiny-cluster-zk.yaml druid-operator/examples/", "originalCommit": "b7443be1f4dfc3ae9335bc87e4b420c0d059e400", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg2MzMzMw==", "url": "https://github.com/apache/druid/pull/10669#discussion_r543863333", "bodyText": "There are some changes in integration-tests/tiny-cluster.yaml and integration-tests/tiny-cluster-zk.yaml, such as:\n\nNew NodeType Service.\nConfigs changing.\nAdd MiddleManager configs.\n\nSo the original files in druid-operator can't be used directly here.", "author": "zhangyue19921010", "createdAt": "2020-12-16T02:58:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcyNDAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUyOTQxNA==", "url": "https://github.com/apache/druid/pull/10669#discussion_r544529414", "bodyText": "sorry, I wasn't clear, in this context \"original\" meant files in \"integration-tests/\"  i.e. you have\ncp integration-tests/tiny-cluster.yaml druid-operator/examples/\ncp integration-tests/tiny-cluster-zk.yaml druid-operator/examples/\n...\nsed -i \"s|REPLACE_VOLUMES|`pwd`|g\" druid-operator/examples/tiny-cluster.yaml\n..\nsudo /usr/local/bin/kubectl apply -f druid-operator/examples/tiny-cluster-zk.yaml\nsudo /usr/local/bin/kubectl apply -f druid-operator/examples/tiny-cluster.yaml\n\nas opposed to\n...\nsed -i \"s|REPLACE_VOLUMES|`pwd`|g\" integration-tests/tiny-cluster.yaml\n..\nsudo /usr/local/bin/kubectl apply -f integration-tests/tiny-cluster-zk.yaml\nsudo /usr/local/bin/kubectl apply -f integration-tests/tiny-cluster.yaml\n\nregardless, it is a nit and doesn't really matter much.", "author": "himanshug", "createdAt": "2020-12-16T18:32:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcyNDAyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcyNDYyMg==", "url": "https://github.com/apache/druid/pull/10669#discussion_r543724622", "bodyText": "nit: maybe define DRUID_OPERATOR_VERSION=0.0.3 ?", "author": "himanshug", "createdAt": "2020-12-15T22:12:21Z", "path": "integration-tests/script/build_run_k8s_cluster.sh", "diffHunk": "@@ -0,0 +1,82 @@\n+#!/usr/bin/env bash\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+set -e\n+\n+# setup client keystore\n+cd integration-tests\n+./docker/tls/generate-client-certs-and-keystores.sh\n+rm -rf docker/client_tls\n+cp -r client_tls docker/client_tls\n+cd ..\n+\n+# Build Docker images for pods\n+mvn -B -ff -q dependency:go-offline \\\n+      install \\\n+      -Pdist,bundle-contrib-exts \\\n+      -Pskip-static-checks,skip-tests \\\n+      -Dmaven.javadoc.skip=true\n+\n+docker build -t druid/cluster:v1 -f distribution/docker/DockerfileBuildTarAdvanced .\n+\n+# Set Necessary ENV\n+export CHANGE_MINIKUBE_NONE_USER=true\n+export MINIKUBE_WANTUPDATENOTIFICATION=false\n+export MINIKUBE_WANTREPORTERRORPROMPT=false\n+export MINIKUBE_HOME=$HOME\n+export KUBECONFIG=$HOME/.kube/config\n+sudo apt install -y conntrack\n+\n+# This tmp dir is used for MiddleManager pod and Historical Pod to cache segments.\n+mkdir tmp\n+chmod 777 tmp\n+\n+# Lacunch K8S cluster\n+curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.18.1/bin/linux/amd64/kubectl && chmod +x kubectl && sudo mv kubectl /usr/local/bin/\n+curl -Lo minikube https://storage.googleapis.com/minikube/releases/v1.8.1/minikube-linux-amd64 && chmod +x minikube && sudo mv minikube /usr/local/bin/\n+sudo /usr/local/bin/minikube start --profile=minikube --vm-driver=none --kubernetes-version=v1.18.1\n+sudo /usr/local/bin/minikube update-context\n+\n+# Prepare For Druid-Operator\n+git clone https://github.com/druid-io/druid-operator.git\n+cd druid-operator\n+git checkout -b druid-operator-0.0.3 druid-operator-0.0.3", "originalCommit": "b7443be1f4dfc3ae9335bc87e4b420c0d059e400", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg2NDEwNw==", "url": "https://github.com/apache/druid/pull/10669#discussion_r543864107", "bodyText": "Sure thing. Done!", "author": "zhangyue19921010", "createdAt": "2020-12-16T02:59:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcyNDYyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzczMTkwOQ==", "url": "https://github.com/apache/druid/pull/10669#discussion_r543731909", "bodyText": "nit: this looks mostly a copy of other Dockerfile , it would be nice to reuse same if possible.", "author": "himanshug", "createdAt": "2020-12-15T22:25:42Z", "path": "distribution/docker/DockerfileBuildTarAdvanced", "diffHunk": "@@ -0,0 +1,62 @@\n+#", "originalCommit": "b7443be1f4dfc3ae9335bc87e4b420c0d059e400", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg2Njg5NQ==", "url": "https://github.com/apache/druid/pull/10669#discussion_r543866895", "bodyText": "Also. There are some changes between DockerfileBuildTarAdvanced and original Dockerfile, such as :\n\nPrepare test data.\nMove mvn package out of Dockerfile.\nMkdir necessary for IT.\n\nSo that we can't use the original Dockerfile here.", "author": "zhangyue19921010", "createdAt": "2020-12-16T03:03:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzczMTkwOQ=="}], "type": "inlineReview"}, {"oid": "375c253671c8e9dfacc69d84153e6a3af7422b8c", "url": "https://github.com/apache/druid/commit/375c253671c8e9dfacc69d84153e6a3af7422b8c", "message": "add env DRUID_OPERATOR_VERSION=0.0.3", "committedDate": "2020-12-16T02:52:51Z", "type": "commit"}, {"oid": "1a42794714ad1bce3d80ca612e015c66781235d9", "url": "https://github.com/apache/druid/commit/1a42794714ad1bce3d80ca612e015c66781235d9", "message": "change version", "committedDate": "2020-12-16T06:43:51Z", "type": "commit"}]}