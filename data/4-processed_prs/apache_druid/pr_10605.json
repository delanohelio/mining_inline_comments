{"pr_number": 10605, "pr_title": "bitwise math function expressions", "pr_createdAt": "2020-11-25T10:27:16Z", "pr_url": "https://github.com/apache/druid/pull/10605", "timeline": [{"oid": "b940467023a895529f828f88f5208532bb77ef70", "url": "https://github.com/apache/druid/commit/b940467023a895529f828f88f5208532bb77ef70", "message": "expressions: adding bitwise expressions", "committedDate": "2020-08-01T23:10:28Z", "type": "commit"}, {"oid": "a8e08e0e090b56580a81f35d2179ec3d6a996a6e", "url": "https://github.com/apache/druid/commit/a8e08e0e090b56580a81f35d2179ec3d6a996a6e", "message": "Merge remote-tracking branch 'upstream/master' into bitwise-math-functions", "committedDate": "2020-11-24T08:16:08Z", "type": "commit"}, {"oid": "88529c0b70997eae17089498fbe5326d39d2f924", "url": "https://github.com/apache/druid/commit/88529c0b70997eae17089498fbe5326d39d2f924", "message": "double handling and vectorization", "committedDate": "2020-11-25T09:58:03Z", "type": "commit"}, {"oid": "ecc103ade747d4212f775777efb4c1e3a0e2fc19", "url": "https://github.com/apache/druid/commit/ecc103ade747d4212f775777efb4c1e3a0e2fc19", "message": "move conversion to Evals", "committedDate": "2020-11-25T10:13:06Z", "type": "commit"}, {"oid": "1b5269b3892105463d516855b535dc427adbc8d7", "url": "https://github.com/apache/druid/commit/1b5269b3892105463d516855b535dc427adbc8d7", "message": "revert unintended changes", "committedDate": "2020-11-25T10:24:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc3NTU3MQ==", "url": "https://github.com/apache/druid/pull/10605#discussion_r553775571", "bodyText": "Why add this instead of calling the thing in Double?", "author": "gianm", "createdAt": "2021-01-08T07:04:51Z", "path": "core/src/main/java/org/apache/druid/math/expr/Evals.java", "diffHunk": "@@ -71,4 +71,14 @@ public static boolean asBoolean(@Nullable String x)\n   {\n     return !NullHandling.isNullOrEquivalent(x) && Boolean.parseBoolean(x);\n   }\n+\n+  public static long doubleToLongBits(double x)\n+  {\n+    return Double.doubleToLongBits(x);", "originalCommit": "1b5269b3892105463d516855b535dc427adbc8d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgxMDAwMw==", "url": "https://github.com/apache/druid/pull/10605#discussion_r553810003", "bodyText": "Trying to remember.. I think i was just trying to be consistent with the other value conversion functions and put it here, but it probably could just call it directly as it seems unlike we would change the function", "author": "clintropolis", "createdAt": "2021-01-08T08:40:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc3NTU3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc3Njc1Mg==", "url": "https://github.com/apache/druid/pull/10605#discussion_r553776752", "bodyText": "Why convert doubles to their bit representations instead of casting them to longs? Casting to long would, I think, make more sense since we can think of it as an implicit cast of double-typed arguments to a function that only accepts longs.", "author": "gianm", "createdAt": "2021-01-08T07:08:38Z", "path": "docs/misc/math-expr.md", "diffHunk": "@@ -119,6 +119,13 @@ See javadoc of java.lang.Math for detailed explanation for each function.\n |acos|acos(x) would return the arc cosine of x|\n |asin|asin(x) would return the arc sine of x|\n |atan|atan(x) would return the arc tangent of x|\n+|bitwiseAnd|bitwiseAnd(x,y) would return the result of x & y. Double values will be converted to their bit representation|", "originalCommit": "1b5269b3892105463d516855b535dc427adbc8d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgxMDY3OA==", "url": "https://github.com/apache/druid/pull/10605#discussion_r553810678", "bodyText": "thinking back, I think i originally did this behavior before I added bitwiseConvertDouble, so it was done as a way to do bitwise operations on double values. After I added the explicit function, it isn't really necessary anymore, so will revert to the behavior of casting and assuming long inputs.", "author": "clintropolis", "createdAt": "2021-01-08T08:42:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc3Njc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc3ODE3OA==", "url": "https://github.com/apache/druid/pull/10605#discussion_r553778178", "bodyText": "This function is kind of weird because it doesn't have a fixpoint. I'd think that bitwiseConvertDouble(bitwiseConvertDouble(x)) would be identical to bitwiseConvertDouble(x). The lack of fixpoint makes it hard to reason about what the result of this function is going to be. Is there a specific reason it's designed this way? If not, I'd suggest splitting into two functions for each direction of the conversion.", "author": "gianm", "createdAt": "2021-01-08T07:14:00Z", "path": "docs/misc/math-expr.md", "diffHunk": "@@ -119,6 +119,13 @@ See javadoc of java.lang.Math for detailed explanation for each function.\n |acos|acos(x) would return the arc cosine of x|\n |asin|asin(x) would return the arc sine of x|\n |atan|atan(x) would return the arc tangent of x|\n+|bitwiseAnd|bitwiseAnd(x,y) would return the result of x & y. Double values will be converted to their bit representation|\n+|bitwiseComplement|bitwiseComplement(x) would return the result of ~x. Double values will be converted to their bit representation|\n+|bitwiseConvertDouble|bitwiseConvertDouble(x) would convert the IEEE 754 floating-point \"double\" bits stored in a long into a double value if the input is a long, or the copy bits of a double value into a long if the input is a double.|", "originalCommit": "1b5269b3892105463d516855b535dc427adbc8d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgxMDg1Nw==", "url": "https://github.com/apache/druid/pull/10605#discussion_r553810857", "bodyText": "will split into bitwiseConvertDoubleToLongBits and bitwiseConvertLongBitsToDouble", "author": "clintropolis", "createdAt": "2021-01-08T08:42:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc3ODE3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDIwNjQ3Mw==", "url": "https://github.com/apache/druid/pull/10605#discussion_r554206473", "bodyText": "I'd think that bitwiseConvertDouble(bitwiseConvertDouble(x)) would be identical to bitwiseConvertDouble(x).\n\nhmm, should the conversion just pass through if the type is already the output type or should it implicitly cast similar to the other bitwise functions?", "author": "clintropolis", "createdAt": "2021-01-08T21:44:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc3ODE3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDIyNDE4Mg==", "url": "https://github.com/apache/druid/pull/10605#discussion_r554224182", "bodyText": "It should implicitly cast, I think.\nGenerally I think function behavior is easier to understand if the function implicitly casts its inputs to the type that it expects, vs. changing behavior based on its input type.", "author": "gianm", "createdAt": "2021-01-08T22:18:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc3ODE3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjI2NzM1MQ==", "url": "https://github.com/apache/druid/pull/10605#discussion_r556267351", "bodyText": "btw, testing bitwiseConvertLongBitsToDouble(bitwiseConvertLongBitsToDouble(..)) uncovered an issue with the parser when trying to parse the output of Expr.stringify (because unit tests cover this round trip scenario, and when flatten is true it turns it into a constant), where large doubles with exponents, e.g. 1E10 or whatever, could not be correctly parsed, so I expanded the grammar to allow it roughly according to these rules", "author": "clintropolis", "createdAt": "2021-01-13T05:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc3ODE3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc4MDAzNg==", "url": "https://github.com/apache/druid/pull/10605#discussion_r553780036", "bodyText": "Please include (double, double) and (long, double) in addition to (double, long) args.", "author": "gianm", "createdAt": "2021-01-08T07:20:16Z", "path": "core/src/test/java/org/apache/druid/math/expr/FunctionTest.java", "diffHunk": "@@ -519,6 +519,31 @@ public void testLeast()\n     assertExpr(\"least(1, null, 'A')\", \"1\");\n   }\n \n+  @Test\n+  public void testBitwise()\n+  {\n+    assertExpr(\"bitwiseAnd(3, 1)\", 1L);\n+    assertExpr(\"bitwiseAnd(2, 1)\", 0L);\n+    assertExpr(\"bitwiseOr(3, 1)\", 3L);\n+    assertExpr(\"bitwiseOr(2, 1)\", 3L);\n+    assertExpr(\"bitwiseXor(3, 1)\", 2L);\n+    assertExpr(\"bitwiseXor(2, 1)\", 3L);\n+    assertExpr(\"bitwiseShiftLeft(2, 1)\", 4L);\n+    assertExpr(\"bitwiseShiftRight(2, 1)\", 1L);\n+    assertExpr(\"bitwiseAnd(bitwiseComplement(1), 7)\", 6L);\n+    assertExpr(\"bitwiseAnd('2', '1')\", null);\n+    assertExpr(\"bitwiseAnd(2, '1')\", 0L);\n+\n+    assertExpr(\"bitwiseOr(2.345, 1)\", 4612462889363109315L);", "originalCommit": "1b5269b3892105463d516855b535dc427adbc8d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzgxMTcxNQ==", "url": "https://github.com/apache/druid/pull/10605#discussion_r553811715", "bodyText": "more exhaustive coverage which should include these combinations is done in VectorExprSanityTest, where non-vectorized and vectorized evaluation results are asserted to be equal with a variety of combinations of inputs, but I can add explicit tests here since those don't necessarily confirm correctness, just self consistency between the two evaluation modes.", "author": "clintropolis", "createdAt": "2021-01-08T08:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc4MDAzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDIyNDM2MQ==", "url": "https://github.com/apache/druid/pull/10605#discussion_r554224361", "bodyText": "I see, I missed that test. Sounds good.", "author": "gianm", "createdAt": "2021-01-08T22:18:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzc4MDAzNg=="}], "type": "inlineReview"}, {"oid": "55e0a84318e41ac196a997a112a8255872a4dd0e", "url": "https://github.com/apache/druid/commit/55e0a84318e41ac196a997a112a8255872a4dd0e", "message": "Merge remote-tracking branch 'upstream/master' into bitwise-math-functions", "committedDate": "2021-01-08T12:16:55Z", "type": "commit"}, {"oid": "61d31182d010cd3b73f41703a97eab9f613da92a", "url": "https://github.com/apache/druid/commit/61d31182d010cd3b73f41703a97eab9f613da92a", "message": "Merge remote-tracking branch 'upstream/master' into bitwise-math-functions", "committedDate": "2021-01-08T21:39:49Z", "type": "commit"}, {"oid": "85e30745167b02585a00a378635102c42db49573", "url": "https://github.com/apache/druid/commit/85e30745167b02585a00a378635102c42db49573", "message": "less magic, split convert functions, fix parser for funny exponent doubles", "committedDate": "2021-01-09T02:15:00Z", "type": "commit"}, {"oid": "f16026aa0a89b9fbf9e54c9df15b45df0a537fef", "url": "https://github.com/apache/druid/commit/f16026aa0a89b9fbf9e54c9df15b45df0a537fef", "message": "Merge remote-tracking branch 'upstream/master' into bitwise-math-functions", "committedDate": "2021-01-12T02:12:58Z", "type": "commit"}, {"oid": "d988512555c145cff650a8325e4f7616b273dbae", "url": "https://github.com/apache/druid/commit/d988512555c145cff650a8325e4f7616b273dbae", "message": "fix spelling exceptions list", "committedDate": "2021-01-12T02:14:37Z", "type": "commit"}, {"oid": "72a452a2a1884cd9cfad998a23723040b9eac70e", "url": "https://github.com/apache/druid/commit/72a452a2a1884cd9cfad998a23723040b9eac70e", "message": "more spelling", "committedDate": "2021-01-12T20:36:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODA5ODgwOQ==", "url": "https://github.com/apache/druid/pull/10605#discussion_r558098809", "bodyText": "This used to allow 10. as a double, but now it doesn't. I think we should add that back. (with tests \ud83d\ude42)", "author": "gianm", "createdAt": "2021-01-15T09:13:42Z", "path": "core/src/main/antlr4/org/apache/druid/math/expr/antlr/Expr.g4", "diffHunk": "@@ -51,9 +51,12 @@ numericElement : (LONG | DOUBLE | NULL);\n literalElement : (STRING | LONG | DOUBLE | NULL);\n \n NULL : 'null';\n+LONG : [0-9]+;\n+EXP: [eE] [-]? LONG;\n+// DOUBLE provides partial support for java double format\n+// see: https://docs.oracle.com/javase/8/docs/api/java/lang/Double.html#valueOf-java.lang.String-\n+DOUBLE : 'NaN' | 'Infinity' | (LONG '.' LONG) | (LONG EXP) | (LONG '.' LONG EXP);", "originalCommit": "72a452a2a1884cd9cfad998a23723040b9eac70e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDkzNTEwNA==", "url": "https://github.com/apache/druid/pull/10605#discussion_r560935104", "bodyText": "good catch \ud83d\udc4d\nfixed, and added tests", "author": "clintropolis", "createdAt": "2021-01-20T12:50:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODA5ODgwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODEwNDEwNg==", "url": "https://github.com/apache/druid/pull/10605#discussion_r558104106", "bodyText": "Are these docs for bitwiseConvertDoubleToLongBits correct? It doesn't sound like something that the function should do.", "author": "gianm", "createdAt": "2021-01-15T09:17:26Z", "path": "docs/misc/math-expr.md", "diffHunk": "@@ -119,13 +119,14 @@ See javadoc of java.lang.Math for detailed explanation for each function.\n |acos|acos(x) would return the arc cosine of x|\n |asin|asin(x) would return the arc sine of x|\n |atan|atan(x) would return the arc tangent of x|\n-|bitwiseAnd|bitwiseAnd(x,y) would return the result of x & y. Double values will be converted to their bit representation|\n-|bitwiseComplement|bitwiseComplement(x) would return the result of ~x. Double values will be converted to their bit representation|\n-|bitwiseConvertDouble|bitwiseConvertDouble(x) would convert the IEEE 754 floating-point \"double\" bits stored in a long into a double value if the input is a long, or the copy bits of a double value into a long if the input is a double.|\n-|bitwiseOr|bitwiseOr(x,y) would return the result of x [PIPE] y. Double values will be converted to their bit representation |\n-|bitwiseShiftLeft|bitwiseShiftLeft(x,y) would return the result of x << y. Double values will be converted to their bit representation|\n-|bitwiseShiftRight|bitwiseShiftRight(x,y) would return the result of x >> y. Double values will be converted to their bit representation|\n-|bitwiseXor|bitwiseXor(x,y) would return the result of x ^ y. Double values will be converted to their bit representation|\n+|bitwiseAnd|bitwiseAnd(x,y) would return the result of x & y. Double values will be implicitly cast to longs, use `bitwiseConvertDoubleToLongBits` to perform bitwise operations directly with doubles|\n+|bitwiseComplement|bitwiseComplement(x) would return the result of ~x. Double values will be implicitly cast to longs, use `bitwiseConvertDoubleToLongBits` to perform bitwise operations directly with doubles|\n+|bitwiseConvertDoubleToLongBits|bitwiseConvertDoubleToLongBits(x) would convert the IEEE 754 floating-point \"double\" bits stored in a long into a double value if the input is a long, or implicitly cast the value to a long if the input is a double|", "originalCommit": "72a452a2a1884cd9cfad998a23723040b9eac70e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDkzNDcxMw==", "url": "https://github.com/apache/druid/pull/10605#discussion_r560934713", "bodyText": "heh no, when I split the functions i deleted the wrong half of the description .. and then wrote the one i meant to delete again a different way for the function i split out \ud83d\ude43", "author": "clintropolis", "createdAt": "2021-01-20T12:49:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODEwNDEwNg=="}], "type": "inlineReview"}, {"oid": "58fb61757ca7b24f5e09d61048771dc84545f473", "url": "https://github.com/apache/druid/commit/58fb61757ca7b24f5e09d61048771dc84545f473", "message": "fix grammar, add more test, fix docs", "committedDate": "2021-01-20T12:45:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTE0NzQ0NQ==", "url": "https://github.com/apache/druid/pull/10605#discussion_r561147445", "bodyText": "This still doesn't seem right; surely, if the input is a long, the function will cast the value to a double and then convert those double bits back to a long. The description doesn't make it sound like that's what happens.", "author": "gianm", "createdAt": "2021-01-20T17:32:28Z", "path": "docs/misc/math-expr.md", "diffHunk": "@@ -115,53 +115,53 @@ See javadoc of java.lang.Math for detailed explanation for each function.\n \n |name|description|\n |----|-----------|\n-|abs|abs(x) would return the absolute value of x|\n-|acos|acos(x) would return the arc cosine of x|\n-|asin|asin(x) would return the arc sine of x|\n-|atan|atan(x) would return the arc tangent of x|\n-|bitwiseAnd|bitwiseAnd(x,y) would return the result of x & y. Double values will be implicitly cast to longs, use `bitwiseConvertDoubleToLongBits` to perform bitwise operations directly with doubles|\n-|bitwiseComplement|bitwiseComplement(x) would return the result of ~x. Double values will be implicitly cast to longs, use `bitwiseConvertDoubleToLongBits` to perform bitwise operations directly with doubles|\n-|bitwiseConvertDoubleToLongBits|bitwiseConvertDoubleToLongBits(x) would convert the IEEE 754 floating-point \"double\" bits stored in a long into a double value if the input is a long, or implicitly cast the value to a long if the input is a double|\n-|bitwiseConvertLongBitsToDouble|bitwiseConvertLongBitsToDouble(x) would convert a long to the IEEE 754 floating-point \"double\" specified by the bits stored in the long. A double input will be implicitly cast to a long|\n-|bitwiseOr|bitwiseOr(x,y) would return the result of x [PIPE] y. Double values will be implicitly cast to longs, use `bitwiseConvertDoubleToLongBits` to perform bitwise operations directly with doubles|\n-|bitwiseShiftLeft|bitwiseShiftLeft(x,y) would return the result of x << y. Double values will be implicitly cast to longs, use `bitwiseConvertDoubleToLongBits` to perform bitwise operations directly with doubles|\n-|bitwiseShiftRight|bitwiseShiftRight(x,y) would return the result of x >> y. Double values will be implicitly cast to longs, use `bitwiseConvertDoubleToLongBits` to perform bitwise operations directly with doubles|\n-|bitwiseXor|bitwiseXor(x,y) would return the result of x ^ y. Double values will be implicitly cast to longs, use `bitwiseConvertDoubleToLongBits` to perform bitwise operations directly with doubles|\n-|atan2|atan2(y, x) would return the angle theta from the conversion of rectangular coordinates (x, y) to polar * coordinates (r, theta)|\n-|cbrt|cbrt(x) would return the cube root of x|\n-|ceil|ceil(x) would return the smallest (closest to negative infinity) double value that is greater than or equal to x and is equal to a mathematical integer|\n-|copysign|copysign(x) would return the first floating-point argument with the sign of the second floating-point argument|\n-|cos|cos(x) would return the trigonometric cosine of x|\n-|cosh|cosh(x) would return the hyperbolic cosine of x|\n-|cot|cot(x) would return the trigonometric cotangent of an angle x|\n+|abs|abs(x) returns the absolute value of x|\n+|acos|acos(x) returns the arc cosine of x|\n+|asin|asin(x) returns the arc sine of x|\n+|atan|atan(x) returns the arc tangent of x|\n+|bitwiseAnd|bitwiseAnd(x,y) returns the result of x & y. Double values will be implicitly cast to longs, use `bitwiseConvertDoubleToLongBits` to perform bitwise operations directly with doubles|\n+|bitwiseComplement|bitwiseComplement(x) returns the result of ~x. Double values will be implicitly cast to longs, use `bitwiseConvertDoubleToLongBits` to perform bitwise operations directly with doubles|\n+|bitwiseConvertDoubleToLongBits|bitwiseConvertDoubleToLongBits(x) will convert the IEEE 754 floating-point \"double\" bits of a double value into a long, or implicitly cast the value to a double if the input is a long.|", "originalCommit": "58fb61757ca7b24f5e09d61048771dc84545f473", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "623e0b78ff3779e4a4941886d3a5176bf9ff845d", "url": "https://github.com/apache/druid/commit/623e0b78ff3779e4a4941886d3a5176bf9ff845d", "message": "fix docs", "committedDate": "2021-01-20T21:29:33Z", "type": "commit"}]}