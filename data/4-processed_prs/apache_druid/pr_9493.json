{"pr_number": 9493, "pr_title": "threshold based automatic query prioritization", "pr_createdAt": "2020-03-10T12:07:05Z", "pr_url": "https://github.com/apache/druid/pull/9493", "timeline": [{"oid": "f905379df8745a16aee7b11ad86ea2967a3d7ce0", "url": "https://github.com/apache/druid/commit/f905379df8745a16aee7b11ad86ea2967a3d7ce0", "message": "threshold based automatic query prioritization", "committedDate": "2020-03-10T11:12:02Z", "type": "commit"}, {"oid": "ae7557503c48c3681079ea72d81eae0b070ee9ba", "url": "https://github.com/apache/druid/commit/ae7557503c48c3681079ea72d81eae0b070ee9ba", "message": "fixes", "committedDate": "2020-03-10T12:06:01Z", "type": "commit"}, {"oid": "dd4ef712c86af85fd60dbccd5eda92556436ff31", "url": "https://github.com/apache/druid/commit/dd4ef712c86af85fd60dbccd5eda92556436ff31", "message": "spelling and fixes", "committedDate": "2020-03-11T10:59:43Z", "type": "commit"}, {"oid": "5cb12057ba9a036fb7cd2f2a3ab597af7908cdbd", "url": "https://github.com/apache/druid/commit/5cb12057ba9a036fb7cd2f2a3ab597af7908cdbd", "message": "fix docs", "committedDate": "2020-03-11T11:10:06Z", "type": "commit"}, {"oid": "7731a739d0a49e1a35e7343fff2519ce8391e254", "url": "https://github.com/apache/druid/commit/7731a739d0a49e1a35e7343fff2519ce8391e254", "message": "spelling", "committedDate": "2020-03-11T11:13:13Z", "type": "commit"}, {"oid": "828a0ebdf497d46873b49c82ca65698361609cb4", "url": "https://github.com/apache/druid/commit/828a0ebdf497d46873b49c82ca65698361609cb4", "message": "checkstyle", "committedDate": "2020-03-11T13:04:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM1MTM5MQ==", "url": "https://github.com/apache/druid/pull/9493#discussion_r391351391", "bodyText": "nit: hmm, is 'no auto' = 'manual'? Just wondering what is a better name.", "author": "jihoonson", "createdAt": "2020-03-12T01:02:47Z", "path": "docs/configuration/index.md", "diffHunk": "@@ -1473,22 +1473,41 @@ These Broker configurations can be defined in the `broker/runtime.properties` fi\n \n #### Query configuration\n \n-##### Query prioritization\n+##### Query routing\n \n |Property|Possible Values|Description|Default|\n |--------|---------------|-----------|-------|\n |`druid.broker.balancer.type`|`random`, `connectionCount`|Determines how the broker balances connections to Historical processes. `random` choose randomly, `connectionCount` picks the process with the fewest number of active connections to|`random`|\n |`druid.broker.select.tier`|`highestPriority`, `lowestPriority`, `custom`|If segments are cross-replicated across tiers in a cluster, you can tell the broker to prefer to select segments in a tier with a certain priority.|`highestPriority`|\n |`druid.broker.select.tier.custom.priorities`|`An array of integer priorities.`|Select servers in tiers with a custom priority list.|None|\n \n-##### Query laning\n+##### Query prioritization and laning\n \n *Laning strategies* allow you to control capacity utilization for heterogeneous query workloads. With laning, the broker examines and classifies a query for the purpose of assigning it to a 'lane'. Lanes have capacity limits, enforced by the broker, that can be used to ensure sufficient resources are available for other lanes or for interactive queries (with no lane), or to limit overall throughput for queries within the lane. Requests in excess of the capacity are discarded with an HTTP 429 status code.\n \n |Property|Description|Default|\n |--------|-----------|-------|\n |`druid.query.scheduler.numThreads`|Maximum number of HTTP threads to dedicate to query processing. To save HTTP thread capacity, this should be lower than `druid.server.http.numThreads`.|Unbounded|\n |`druid.query.scheduler.laning.strategy`|Query laning strategy to use to assign queries to a lane in order to control capacities for certain classes of queries.|`none`|\n+|`druid.query.scheduler.prioritization.strategy`|Query prioritization strategy to automatically assign priorities.|`none`|\n+\n+##### Prioritization strategies\n+\n+###### No auto prioritization strategy", "originalCommit": "828a0ebdf497d46873b49c82ca65698361609cb4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc4NTQ0Nw==", "url": "https://github.com/apache/druid/pull/9493#discussion_r391785447", "bodyText": "\"None prioritization strategy\" ?", "author": "himanshug", "createdAt": "2020-03-12T17:39:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM1MTM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkyODA5MA==", "url": "https://github.com/apache/druid/pull/9493#discussion_r391928090", "bodyText": "Hmm, after thinking about it, I think manual maybe makes the most sense, to be symmetrical with the ManualQueryLaningStrategy of #9492 because both rely on the user adding a value to the query context.", "author": "clintropolis", "createdAt": "2020-03-12T21:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM1MTM5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc4NjgxNQ==", "url": "https://github.com/apache/druid/pull/9493#discussion_r391786815", "bodyText": "nit: by rephrasing it to say, \"... strategy lowers priority of queries that...\" , we could make the heading be \"Threshold prioritization strategy\"", "author": "himanshug", "createdAt": "2020-03-12T17:41:34Z", "path": "docs/configuration/index.md", "diffHunk": "@@ -1473,22 +1473,41 @@ These Broker configurations can be defined in the `broker/runtime.properties` fi\n \n #### Query configuration\n \n-##### Query prioritization\n+##### Query routing\n \n |Property|Possible Values|Description|Default|\n |--------|---------------|-----------|-------|\n |`druid.broker.balancer.type`|`random`, `connectionCount`|Determines how the broker balances connections to Historical processes. `random` choose randomly, `connectionCount` picks the process with the fewest number of active connections to|`random`|\n |`druid.broker.select.tier`|`highestPriority`, `lowestPriority`, `custom`|If segments are cross-replicated across tiers in a cluster, you can tell the broker to prefer to select segments in a tier with a certain priority.|`highestPriority`|\n |`druid.broker.select.tier.custom.priorities`|`An array of integer priorities.`|Select servers in tiers with a custom priority list.|None|\n \n-##### Query laning\n+##### Query prioritization and laning\n \n *Laning strategies* allow you to control capacity utilization for heterogeneous query workloads. With laning, the broker examines and classifies a query for the purpose of assigning it to a 'lane'. Lanes have capacity limits, enforced by the broker, that can be used to ensure sufficient resources are available for other lanes or for interactive queries (with no lane), or to limit overall throughput for queries within the lane. Requests in excess of the capacity are discarded with an HTTP 429 status code.\n \n |Property|Description|Default|\n |--------|-----------|-------|\n |`druid.query.scheduler.numThreads`|Maximum number of HTTP threads to dedicate to query processing. To save HTTP thread capacity, this should be lower than `druid.server.http.numThreads`.|Unbounded|\n |`druid.query.scheduler.laning.strategy`|Query laning strategy to use to assign queries to a lane in order to control capacities for certain classes of queries.|`none`|\n+|`druid.query.scheduler.prioritization.strategy`|Query prioritization strategy to automatically assign priorities.|`none`|\n+\n+##### Prioritization strategies\n+\n+###### No auto prioritization strategy\n+With this configuration, queries are never assigned a priority automatically, but will preserve a priority manually set on the [query context](../querying/query-context.md) with the `priority` key. This mode can be explicitly set by setting `druid.query.scheduler.prioritization.strategy` to `none`.\n+\n+###### Threshold deprioritization strategy\n+\n+This prioritization strategy deprioritizes queries that cross any of a configurable set of thresholds, such as how far in the past the data is, how large of an interval a query covers, or the number of segments taking part in a query.", "originalCommit": "828a0ebdf497d46873b49c82ca65698361609cb4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d0a307955ef146f43cbfb4405a1bf71f06298768", "url": "https://github.com/apache/druid/commit/d0a307955ef146f43cbfb4405a1bf71f06298768", "message": "adjustments", "committedDate": "2020-03-12T22:01:38Z", "type": "commit"}, {"oid": "afdbe191413d6fda83bf018717e1158a27117c6f", "url": "https://github.com/apache/druid/commit/afdbe191413d6fda83bf018717e1158a27117c6f", "message": "doc fix", "committedDate": "2020-03-13T07:30:12Z", "type": "commit"}]}