{"pr_number": 10287, "pr_title": "Remove legacy code from LogUsedSegments duty", "pr_createdAt": "2020-08-14T22:43:28Z", "pr_url": "https://github.com/apache/druid/pull/10287", "timeline": [{"oid": "2389128c5deeac438ee3e5e6a49a5e8e463bf2a7", "url": "https://github.com/apache/druid/commit/2389128c5deeac438ee3e5e6a49a5e8e463bf2a7", "message": "allow the LogUsedSegments duty to be skippped", "committedDate": "2020-08-14T22:40:29Z", "type": "commit"}, {"oid": "4b9a54b7aea2d585626649890480e19c0b5636bd", "url": "https://github.com/apache/druid/commit/4b9a54b7aea2d585626649890480e19c0b5636bd", "message": "Fixes for TravisCI coverage checks and documentation spell checking", "committedDate": "2020-08-15T21:56:25Z", "type": "commit"}, {"oid": "e16219b79407b31fb9b33a3d8c5f6784f41953d3", "url": "https://github.com/apache/druid/commit/e16219b79407b31fb9b33a3d8c5f6784f41953d3", "message": "prameterize DruidCoordinatorTest in order to achieve coverage", "committedDate": "2020-08-16T18:11:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc3NTY0MQ==", "url": "https://github.com/apache/druid/pull/10287#discussion_r489775641", "bodyText": "We could make the property description friendlier by describing what LogUsedSegments does instead of just mentioning it. Also it would be helpful to add a line or two about when should a cluster operator think about disabling this property.", "author": "a2l007", "createdAt": "2020-09-16T21:52:58Z", "path": "docs/configuration/index.md", "diffHunk": "@@ -689,6 +689,7 @@ These Coordinator static configurations can be defined in the `coordinator/runti\n |`druid.coordinator.loadqueuepeon.repeatDelay`|The start and repeat delay for the loadqueuepeon, which manages the load and drop of segments.|PT0.050S (50 ms)|\n |`druid.coordinator.asOverlord.enabled`|Boolean value for whether this Coordinator process should act like an Overlord as well. This configuration allows users to simplify a druid cluster by not having to deploy any standalone Overlord processes. If set to true, then Overlord console is available at `http://coordinator-host:port/console.html` and be sure to set `druid.coordinator.asOverlord.overlordService` also. See next.|false|\n |`druid.coordinator.asOverlord.overlordService`| Required, if `druid.coordinator.asOverlord.enabled` is `true`. This must be same value as `druid.service` on standalone Overlord processes and `druid.selectors.indexing.serviceName` on Middle Managers.|NULL|\n+|`druid.coordinator.duties.logUsedSegments.enabled`|Boolean value for whether or not the coordinator should execute the `LogUsedSegments` Duty|true|", "originalCommit": "e16219b79407b31fb9b33a3d8c5f6784f41953d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2MTQ5Mg==", "url": "https://github.com/apache/druid/pull/10287#discussion_r493061492", "bodyText": "+1 to describe more about the behavior of LogUsedSegments duty. Also I prefer to remove the duties from the config item name -  druid.coordinator.logUsedSegments.enabled. duties is a term in the code not in the user facing documentation, and before it was called helpers in the code.", "author": "ArvinZheng", "createdAt": "2020-09-22T22:09:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc3NTY0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgzMzkxMA==", "url": "https://github.com/apache/druid/pull/10287#discussion_r513833910", "bodyText": "@a2l007 @ArvinZheng thanks for the thoughts. I agree that if duty isn't a user facing word, it should be removed. I also did my best to improve the documentation for end users to better understand what they are disabling if they choose to do so.", "author": "capistrant", "createdAt": "2020-10-29T00:08:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc3NTY0MQ=="}], "type": "inlineReview"}, {"oid": "71e7aba5bd8474c0d3f5cc50216aa5d6b17471c9", "url": "https://github.com/apache/druid/commit/71e7aba5bd8474c0d3f5cc50216aa5d6b17471c9", "message": "Merge remote-tracking branch 'upstream/master' into logUsedSegmentsDuty-toggle", "committedDate": "2020-10-28T21:46:37Z", "type": "commit"}, {"oid": "d6cf0ec9ad2db4a62b4b5a6b846b4f5bdf4748c4", "url": "https://github.com/apache/druid/commit/d6cf0ec9ad2db4a62b4b5a6b846b4f5bdf4748c4", "message": "update config name to remove duty ref and improve documentation", "committedDate": "2020-10-29T00:06:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzk1ODQ5MA==", "url": "https://github.com/apache/druid/pull/10287#discussion_r513958490", "bodyText": "typo: it logs then number of > it logs the number of", "author": "ArvinZheng", "createdAt": "2020-10-29T04:31:13Z", "path": "docs/configuration/index.md", "diffHunk": "@@ -698,6 +698,7 @@ These Coordinator static configurations can be defined in the `coordinator/runti\n |`druid.coordinator.loadqueuepeon.repeatDelay`|The start and repeat delay for the loadqueuepeon, which manages the load and drop of segments.|PT0.050S (50 ms)|\n |`druid.coordinator.asOverlord.enabled`|Boolean value for whether this Coordinator process should act like an Overlord as well. This configuration allows users to simplify a druid cluster by not having to deploy any standalone Overlord processes. If set to true, then Overlord console is available at `http://coordinator-host:port/console.html` and be sure to set `druid.coordinator.asOverlord.overlordService` also. See next.|false|\n |`druid.coordinator.asOverlord.overlordService`| Required, if `druid.coordinator.asOverlord.enabled` is `true`. This must be same value as `druid.service` on standalone Overlord processes and `druid.selectors.indexing.serviceName` on Middle Managers.|NULL|\n+|`druid.coordinator.logUsedSegments.enabled`|Boolean value for whether or not the coordinator should execute the `LogUsedSegments` portion of its coordination work. `LogUsedSegments` is an informational job run by the Coordinator every coordination cycle. It gets a snapshot of segments in the cluster and iterates them. While iterating, it will emit an alert if a segment has a size less than 0. If debug logging is enabled, it will also log a string representation of each segment. Lastly, it logs then number of segments in the cluster. An admin can decide that forgoing this work may advantageous if they don't need any of the information provided.|true|", "originalCommit": "d6cf0ec9ad2db4a62b4b5a6b846b4f5bdf4748c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzk1OTA3Ng==", "url": "https://github.com/apache/druid/pull/10287#discussion_r513959076", "bodyText": "not a comment, just wanted to see if the following sounds good?\nBoolean value for whether or not the coordinator should execute the LogUsedSegments portion of its coordination work. LogUsedSegments is an informational job run by the Coordinator every coordination cycle which logs every segment at DEBUG level and the total number of used segments at INFO level, in addition, it emits an alert if a segment has a size less than 0. An admin can decide that forgoing this work may advantageous if they don't need any of the information provided", "author": "ArvinZheng", "createdAt": "2020-10-29T04:32:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzk1ODQ5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI2NDYyNA==", "url": "https://github.com/apache/druid/pull/10287#discussion_r514264624", "bodyText": "I like your wording, Arvin. made the changes.", "author": "capistrant", "createdAt": "2020-10-29T13:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzk1ODQ5MA=="}], "type": "inlineReview"}, {"oid": "60f2067c2b04d75d5e260c4aef0c6009e31a088d", "url": "https://github.com/apache/druid/commit/60f2067c2b04d75d5e260c4aef0c6009e31a088d", "message": "refine documentation for new config with reviewer advice", "committedDate": "2020-10-29T13:27:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTI4MQ==", "url": "https://github.com/apache/druid/pull/10287#discussion_r551675281", "bodyText": "The default value column is missing.", "author": "jihoonson", "createdAt": "2021-01-05T02:05:37Z", "path": "docs/configuration/index.md", "diffHunk": "@@ -698,6 +698,7 @@ These Coordinator static configurations can be defined in the `coordinator/runti\n |`druid.coordinator.loadqueuepeon.repeatDelay`|The start and repeat delay for the loadqueuepeon, which manages the load and drop of segments.|PT0.050S (50 ms)|\n |`druid.coordinator.asOverlord.enabled`|Boolean value for whether this Coordinator process should act like an Overlord as well. This configuration allows users to simplify a druid cluster by not having to deploy any standalone Overlord processes. If set to true, then Overlord console is available at `http://coordinator-host:port/console.html` and be sure to set `druid.coordinator.asOverlord.overlordService` also. See next.|false|\n |`druid.coordinator.asOverlord.overlordService`| Required, if `druid.coordinator.asOverlord.enabled` is `true`. This must be same value as `druid.service` on standalone Overlord processes and `druid.selectors.indexing.serviceName` on Middle Managers.|NULL|\n+|`druid.coordinator.logUsedSegments.enabled`|Boolean value for whether or not the coordinator should execute the `LogUsedSegments` portion of its coordination work. `LogUsedSegments` is an informational job run by the Coordinator every coordination cycle which logs every segment at DEBUG level and the total number of used segments at INFO level. In addition to these logs, it emits an alert if a segment has a size less than 0. An admin can decide that forgoing this work may advantageous if they don't need any of the information provided.|", "originalCommit": "60f2067c2b04d75d5e260c4aef0c6009e31a088d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTM5Mw==", "url": "https://github.com/apache/druid/pull/10287#discussion_r551675393", "bodyText": "Also, did you want to not document it?", "author": "jihoonson", "createdAt": "2021-01-05T02:06:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTI4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjIyODU4NQ==", "url": "https://github.com/apache/druid/pull/10287#discussion_r552228585", "bodyText": "well @himanshug had offered up the idea of not documenting it and setting it to true to phase this duty out all together. I'm receptive to that idea and can implement it but a part of me wants to avoid that since the logging of each segment at debug level could actually be useful to people out in the wild.\nfor now, I fixed this default value. let me know what you think is best for documentation/default value.\nIf I had to vote, I would keep my implementation because it may actually be useful. The only thing I might change now or in the future is to default it to being off since it seems like a bit more of a debug duty.", "author": "capistrant", "createdAt": "2021-01-05T22:09:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTI4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTgyNg==", "url": "https://github.com/apache/druid/pull/10287#discussion_r551675826", "bodyText": "nit: Collections.unmodifiableList(duties)", "author": "jihoonson", "createdAt": "2021-01-05T02:07:39Z", "path": "server/src/main/java/org/apache/druid/server/coordinator/DruidCoordinator.java", "diffHunk": "@@ -669,21 +669,31 @@ private void stopBeingLeader()\n \n   private List<CoordinatorDuty> makeHistoricalManagementDuties()\n   {\n-    return ImmutableList.of(\n-        new LogUsedSegments(),\n+    List<CoordinatorDuty> duties = new ArrayList<>();\n+    if (config.isLogUsedSegmentsDutyEnabled()) {\n+      duties.add(new LogUsedSegments());\n+    }\n+    duties.addAll(ImmutableList.of(\n         new UpdateCoordinatorStateAndPrepareCluster(),\n         new RunRules(DruidCoordinator.this),\n         new UnloadUnusedSegments(),\n         new MarkAsUnusedOvershadowedSegments(DruidCoordinator.this),\n         new BalanceSegments(DruidCoordinator.this),\n         new EmitClusterStatsAndMetrics(DruidCoordinator.this)\n+    ));\n+    log.debug(\n+        \"Done making historical management duties %s\",\n+        duties.stream().map(duty -> duty.getClass().getName()).collect(Collectors.toList())\n     );\n+    return duties;", "originalCommit": "60f2067c2b04d75d5e260c4aef0c6009e31a088d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDExOTcwNg==", "url": "https://github.com/apache/druid/pull/10287#discussion_r554119706", "bodyText": "reverting to the original way of doing this now that LogUsedSegments is always used again", "author": "capistrant", "createdAt": "2021-01-08T18:31:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTgyNg=="}], "type": "inlineReview"}, {"oid": "20bd6e244827ca5523ca0504360ffa2aefad6bb8", "url": "https://github.com/apache/druid/commit/20bd6e244827ca5523ca0504360ffa2aefad6bb8", "message": "add default column to docs for new config", "committedDate": "2021-01-05T22:08:05Z", "type": "commit"}, {"oid": "1bf750d248802432d52590ec6e0672d3ba25f91e", "url": "https://github.com/apache/druid/commit/1bf750d248802432d52590ec6e0672d3ba25f91e", "message": "Merge branch 'master' into logUsedSegmentsDuty-toggle", "committedDate": "2021-01-06T20:36:16Z", "type": "commit"}, {"oid": "e77b3209ec5b068d19d3f04c448489c686986942", "url": "https://github.com/apache/druid/commit/e77b3209ec5b068d19d3f04c448489c686986942", "message": "remove legacy code in LogUsedSegments and remove config to disbale duty", "committedDate": "2021-01-08T18:24:59Z", "type": "commit"}, {"oid": "c6d3ddf59f619079ef89c8a3eb27293bf6b11e12", "url": "https://github.com/apache/druid/commit/c6d3ddf59f619079ef89c8a3eb27293bf6b11e12", "message": "fix makeHistoricalMangementDuties now that the returned list is always the same", "committedDate": "2021-01-08T18:31:03Z", "type": "commit"}]}