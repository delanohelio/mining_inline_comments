{"pr_number": 9501, "pr_title": "Adding s3, gcs, azure integration tests", "pr_createdAt": "2020-03-10T19:32:33Z", "pr_url": "https://github.com/apache/druid/pull/9501", "timeline": [{"oid": "4d5293a2e268df5c0f9eab3ea06527a25783da6d", "url": "https://github.com/apache/druid/commit/4d5293a2e268df5c0f9eab3ea06527a25783da6d", "message": "exclude pulling s3 segments for tests that doesnt need it", "committedDate": "2020-03-10T19:30:32Z", "type": "commit"}, {"oid": "db9d33eecc2308dbf9830761e81ea2989f849311", "url": "https://github.com/apache/druid/commit/db9d33eecc2308dbf9830761e81ea2989f849311", "message": "fix script", "committedDate": "2020-03-10T19:58:55Z", "type": "commit"}, {"oid": "a3319067a869039e744578a76759ff416138e95b", "url": "https://github.com/apache/druid/commit/a3319067a869039e744578a76759ff416138e95b", "message": "fix script", "committedDate": "2020-03-10T21:17:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxODg2Mw==", "url": "https://github.com/apache/druid/pull/9501#discussion_r390618863", "bodyText": "This will work for how our travis CI is setup but if user try running manually locally with...\n\n-DexcludedGroups=not-query\nwithout -Dgroups and without DexcludedGroups\nthen the data won't be setup", "author": "maytasm", "createdAt": "2020-03-10T21:21:17Z", "path": "integration-tests/docker/druid.sh", "diffHunk": "@@ -73,4 +76,20 @@ setupConfig() {\n       var=$(echo \"$evar\" | sed -e 's?^\\([^=]*\\)=.*?\\1?g' -e 's?_?.?g')\n       setKey $DRUID_SERVICE \"$var\" \"$val\"\n   done\n-}\n\\ No newline at end of file\n+}\n+\n+setupData()", "originalCommit": "a3319067a869039e744578a76759ff416138e95b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIyMDU5MA==", "url": "https://github.com/apache/druid/pull/9501#discussion_r393220590", "bodyText": "Added comments indicating the above.", "author": "maytasm", "createdAt": "2020-03-16T18:10:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxODg2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIyNzA0Mw==", "url": "https://github.com/apache/druid/pull/9501#discussion_r393227043", "bodyText": "Ah, one more thing I forgot about, please update the docs in https://github.com/apache/druid/blob/master/integration-tests/README.md to include instructions for how to supply credentials and run these tests", "author": "clintropolis", "createdAt": "2020-03-16T18:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxODg2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMyNjcxNg==", "url": "https://github.com/apache/druid/pull/9501#discussion_r393326716", "bodyText": "Done", "author": "maytasm", "createdAt": "2020-03-16T21:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxODg2Mw=="}], "type": "inlineReview"}, {"oid": "a392bdf49c9041d9e963625017404ddd202ca204", "url": "https://github.com/apache/druid/commit/a392bdf49c9041d9e963625017404ddd202ca204", "message": "fix script", "committedDate": "2020-03-10T22:10:43Z", "type": "commit"}, {"oid": "aa9b866fafba61bf20dd3b41737be08a5b9bad0b", "url": "https://github.com/apache/druid/commit/aa9b866fafba61bf20dd3b41737be08a5b9bad0b", "message": "add s3 test", "committedDate": "2020-03-11T20:35:39Z", "type": "commit"}, {"oid": "aa7002a53c6024a99d3a820580ae5f67981a8f19", "url": "https://github.com/apache/druid/commit/aa7002a53c6024a99d3a820580ae5f67981a8f19", "message": "fix merge conflict", "committedDate": "2020-03-11T20:41:27Z", "type": "commit"}, {"oid": "b86f8fb8b86a39db5af36ccd0b042fd799b64d19", "url": "https://github.com/apache/druid/commit/b86f8fb8b86a39db5af36ccd0b042fd799b64d19", "message": "refactor sample data script", "committedDate": "2020-03-11T20:57:22Z", "type": "commit"}, {"oid": "fb9a447ffe4ee97d63ceb4aaaa2826e722c72ff5", "url": "https://github.com/apache/druid/commit/fb9a447ffe4ee97d63ceb4aaaa2826e722c72ff5", "message": "add tests", "committedDate": "2020-03-13T01:15:57Z", "type": "commit"}, {"oid": "4d023186d5dce33bfa49c95480eead70b0760c4d", "url": "https://github.com/apache/druid/commit/4d023186d5dce33bfa49c95480eead70b0760c4d", "message": "add tests", "committedDate": "2020-03-13T06:44:13Z", "type": "commit"}, {"oid": "c861df545234bc634824f36fbd24151ef51c4ff1", "url": "https://github.com/apache/druid/commit/c861df545234bc634824f36fbd24151ef51c4ff1", "message": "add license header", "committedDate": "2020-03-13T06:48:31Z", "type": "commit"}, {"oid": "ee5427fcf5212849eee89f3e303019ea7e59126e", "url": "https://github.com/apache/druid/commit/ee5427fcf5212849eee89f3e303019ea7e59126e", "message": "fix failing tests", "committedDate": "2020-03-13T20:56:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0ODI2OQ==", "url": "https://github.com/apache/druid/pull/9501#discussion_r392548269", "bodyText": "does this mean you need to edit this code to run the tests? Can this be a config so it can be passed in?", "author": "clintropolis", "createdAt": "2020-03-14T02:20:30Z", "path": "integration-tests/src/test/java/org/apache/druid/tests/indexer/ITAzureParallelIndexTest.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.tests.indexer;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import org.apache.druid.indexer.partitions.DynamicPartitionsSpec;\n+import org.apache.druid.java.util.common.Pair;\n+import org.apache.druid.java.util.common.StringUtils;\n+import org.apache.druid.testing.guice.DruidTestModuleFactory;\n+import org.apache.druid.tests.TestNGGroup;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Guice;\n+import org.testng.annotations.Test;\n+\n+import java.io.Closeable;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.function.Function;\n+\n+/**\n+ * IMPORTANT:\n+ * To run this test, you must:\n+ * 1) Set the variables {@link ITAzureParallelIndexTest#CONTAINER} and {@link ITAzureParallelIndexTest#PATH} for your data\n+ * 2) Copy wikipedia_index_data1.json, wikipedia_index_data2.json, and wikipedia_index_data3.json\n+ *    located in integration-tests/src/test/resources/data/batch_index to your Azure at the location set in step 1.\n+ * 3) Provide -Doverride.config.path=<PATH_TO_FILE> with Azure credentials/configs set. See\n+ *    integration-tests/docker/environment-configs/override-examples/azure for env vars to provide.\n+ */\n+@Test(groups = TestNGGroup.AZURE_DEEP_STORAGE)\n+@Guice(moduleFactory = DruidTestModuleFactory.class)\n+public class ITAzureParallelIndexTest extends AbstractITBatchIndexTest\n+{\n+  // START: Change this with the configs for your Azure data\n+  private static final String CONTAINER = \"my-container\";", "originalCommit": "ee5427fcf5212849eee89f3e303019ea7e59126e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIyMDc2Mg==", "url": "https://github.com/apache/druid/pull/9501#discussion_r393220762", "bodyText": "Change these to configs.", "author": "maytasm", "createdAt": "2020-03-16T18:10:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0ODI2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0ODc2Mg==", "url": "https://github.com/apache/druid/pull/9501#discussion_r392548762", "bodyText": "hmm, this doesn't seem a great way to handle this and doesn't really reflect how this will likely be run in practice, because the extension dependency jars will still all be on the classpath, just the extension jar itself will be in another folder. I think we will probably want to get the druid install similar to how it is in normal packaging to provide a more realistic test environment, which probably precludes using mvn -B dependency:copy-dependencies, or at least the way we are currently using it, so that way all extensions are split out in the separate extensions folder and not on the classpath.\nI guess this could be fine for now though, and we could figure out how to do this in a future PR.", "author": "clintropolis", "createdAt": "2020-03-14T02:28:27Z", "path": "integration-tests/run_cluster.sh", "diffHunk": "@@ -47,12 +47,25 @@\n   # Make directories if they dont exist\n   mkdir -p $SHARED_DIR/logs\n   mkdir -p $SHARED_DIR/tasklogs\n+  mkdir -p $SHARED_DIR/docker/extensions\n+  mkdir -p $SHARED_DIR/docker/credentials\n \n   # install druid jars\n   rm -rf $SHARED_DIR/docker\n   cp -R docker $SHARED_DIR/docker\n   mvn -B dependency:copy-dependencies -DoutputDirectory=$SHARED_DIR/docker/lib\n \n+  # move extensions into a seperate extension folder\n+  # For druid-s3-extensions\n+  mkdir -p $SHARED_DIR/docker/extensions/druid-s3-extensions", "originalCommit": "ee5427fcf5212849eee89f3e303019ea7e59126e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI2NDg5Mw==", "url": "https://github.com/apache/druid/pull/9501#discussion_r393264893", "bodyText": "I agree. It's very hard to separate out the extensions cleanly using mvn -B dependency:copy-dependencies\nMoving away from mvn -B dependency:copy-dependencies to how it is in normal packaging using the distribution is the right way in my opinion but is a much bigger/unrelated change than the purpose of this PR. For the purpose of this PR, as long as we don't load the extension jar which checks for configs/credentials to be set, we are good.", "author": "maytasm", "createdAt": "2020-03-16T19:32:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0ODc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0ODkxOQ==", "url": "https://github.com/apache/druid/pull/9501#discussion_r392548919", "bodyText": "this approach with trying to use overrides seems like it is going to be sort of brittle and hard to maintain. Like, if i want to ingest data from s3 into hdfs deep storage, or any combination of extensions, I'm not sure how well this approach will hold up, I guess we'll need separate override files for each configuration? That said, maybe is fine until we determine a better solution to integration test config management.", "author": "clintropolis", "createdAt": "2020-03-14T02:30:51Z", "path": "integration-tests/docker/environment-configs/override-examples/azure", "diffHunk": "@@ -0,0 +1,28 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#   http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+#\n+\n+#\n+# Example of override config file to provide.\n+# Please replace <OVERRIDE_THIS> with your cloud configs/credentials\n+#\n+druid_storage_type=azure\n+druid_azure_account=<OVERRIDE_THIS>\n+druid_azure_key=<OVERRIDE_THIS>\n+druid_azure_container=<OVERRIDE_THIS>\n+druid_extensions_loadList=[\"druid-azure-extensions\"]", "originalCommit": "ee5427fcf5212849eee89f3e303019ea7e59126e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI2NjMzMQ==", "url": "https://github.com/apache/druid/pull/9501#discussion_r393266331", "bodyText": "The override-examples directory is meant to be a general guideline of what to override. You may override more or less depending on what test you are running/writing. You may combine multiple files from the override-examples directory if you are running combination of extensions (like ingest data from s3 into hdfs deep storage).\nMaybe we can revisit this better for a more user-friendly and easier way", "author": "maytasm", "createdAt": "2020-03-16T19:35:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0ODkxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0OTM4MA==", "url": "https://github.com/apache/druid/pull/9501#discussion_r392549380", "bodyText": "Hmm, this doesn't necessarily need to be changed now, but I think longer term we are going to need a mapping of test groups to configurations, but I'm not sure it should be encoded in a file in the container. This part should maybe be repurposed to allow running of initialization scripts that configurations bring with them to the container, and this stuff be in a script that initializes the legacy integration test environment.", "author": "clintropolis", "createdAt": "2020-03-14T02:38:16Z", "path": "integration-tests/docker/druid.sh", "diffHunk": "@@ -73,4 +75,23 @@ setupConfig() {\n       var=$(echo \"$evar\" | sed -e 's?^\\([^=]*\\)=.*?\\1?g' -e 's?_?.?g')\n       setKey $DRUID_SERVICE \"$var\" \"$val\"\n   done\n-}\n\\ No newline at end of file\n+}\n+\n+setupData()\n+{\n+  # The \"query\" and \"security\" test groups require data to be setup before running the tests.\n+  # In particular, they requires segments to be download from a pre-existing s3 bucket.\n+  # This is done by using the loadSpec put into metadatastore and s3 credientials set below.\n+  if [ \"$DRUID_INTEGRATION_TEST_GROUP\" = \"query\" ] || [ \"$DRUID_INTEGRATION_TEST_GROUP\" = \"security\" ]; then", "originalCommit": "ee5427fcf5212849eee89f3e303019ea7e59126e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI2NzA2Ng==", "url": "https://github.com/apache/druid/pull/9501#discussion_r393267066", "bodyText": "I think that's a good idea. Should definitely revisit this", "author": "maytasm", "createdAt": "2020-03-16T19:37:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0OTM4MA=="}], "type": "inlineReview"}, {"oid": "58e7020138678421ff7c2467aec993861a8ed112", "url": "https://github.com/apache/druid/commit/58e7020138678421ff7c2467aec993861a8ed112", "message": "change bucket and path to config", "committedDate": "2020-03-16T19:28:32Z", "type": "commit"}, {"oid": "b1ac17424acf22820df574b9b1820bb215e04d5d", "url": "https://github.com/apache/druid/commit/b1ac17424acf22820df574b9b1820bb215e04d5d", "message": "update integration test readme", "committedDate": "2020-03-16T21:34:17Z", "type": "commit"}, {"oid": "c799c96ad5dff763b2e4f7c5c835368990b0a19a", "url": "https://github.com/apache/druid/commit/c799c96ad5dff763b2e4f7c5c835368990b0a19a", "message": "resolve conflict", "committedDate": "2020-03-16T21:39:32Z", "type": "commit"}, {"oid": "e220ddcac806cf8f69f92d024afa81a86d36ddb6", "url": "https://github.com/apache/druid/commit/e220ddcac806cf8f69f92d024afa81a86d36ddb6", "message": "fix typo", "committedDate": "2020-03-16T21:49:48Z", "type": "commit"}]}