{"pr_number": 9863, "pr_title": "Enforce code coverage", "pr_createdAt": "2020-05-13T20:27:02Z", "pr_url": "https://github.com/apache/druid/pull/9863", "timeline": [{"oid": "16d70e93168e5aaa89dc2a75c61a7d19c7052b25", "url": "https://github.com/apache/druid/commit/16d70e93168e5aaa89dc2a75c61a7d19c7052b25", "message": "Enforce code coverage\n\nAdd an automated way of checking if new code has adequate unit tests,\nsince merging code coverage reports and check coverage thresholds via\ncoveralls or codecov is unreliable.\n\nThe following minimum unit test code coverage is now enforced:\n- 80% functions\n- 65% branch\n- 65% line\n\nBranch and line coverage thresholds are slightly lower for now as they\nare harder to achieve.\n\nAfter the code coverage check looks reliable, the thresholds can be\nincreased later if needed.", "committedDate": "2020-05-13T20:21:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5MjE1Mw==", "url": "https://github.com/apache/druid/pull/9863#discussion_r424792153", "bodyText": "Can you add comments on what the difference and what each branch is doing", "author": "maytasm", "createdAt": "2020-05-13T23:43:16Z", "path": ".travis.yml", "diffHunk": "@@ -136,20 +135,51 @@ jobs:\n \n     - &test_processing_module\n       name: \"(openjdk8) processing module test\"\n-      env: &processing_env\n+      env:\n       - MAVEN_PROJECTS='processing'\n-      before_script: &setup_java_test\n+      before_script:\n+        - export DRUID_USE_DEFAULT_VALUE_FOR_NULL=true\n+      script:\n         - unset _JAVA_OPTIONS\n-      script: &run_java_test\n         # Set MAVEN_OPTS for Surefire launcher. Skip remoteresources to avoid intermittent connection timeouts when\n         # resolving the SIGAR dependency.\n         - >\n           MAVEN_OPTS='-Xmx800m' ${MVN} test -pl ${MAVEN_PROJECTS}\n-          ${MAVEN_SKIP} -Dremoteresources.skip=true\n+          ${MAVEN_SKIP} -Dremoteresources.skip=true -Ddruid.generic.useDefaultValueForNull=${DRUID_USE_DEFAULT_VALUE_FOR_NULL}\n         - sh -c \"dmesg | egrep -i '(oom|out of memory|kill process|killed).*' -C 1 || exit 0\"\n         - free -m\n-      after_success: &upload_java_unit_test_coverage\n         - ${MVN} -pl ${MAVEN_PROJECTS} jacoco:report\n+        # Add merge target branch to determine diff (see https://github.com/travis-ci/travis-ci/issues/6069)\n+        - echo \"TRAVIS_BRANCH=${TRAVIS_BRANCH}\"  # for debugging\n+        - git remote set-branches --add origin ${TRAVIS_BRANCH} && git fetch\n+        # Determine the modified files that match the maven projects being tested\n+        - all_files=\"$(git diff --name-only origin/${TRAVIS_BRANCH}...HEAD | grep \"\\.java$\" || [[ $? == 1 ]])\"\n+        - for f in ${all_files}; do echo $f; done  # for debugging\n+        - >", "originalCommit": "16d70e93168e5aaa89dc2a75c61a7d19c7052b25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5MzcxMA==", "url": "https://github.com/apache/druid/pull/9863#discussion_r424793710", "bodyText": "Maybe also print a message indicating this is the list of all files, etc.", "author": "maytasm", "createdAt": "2020-05-13T23:48:02Z", "path": ".travis.yml", "diffHunk": "@@ -136,20 +135,51 @@ jobs:\n \n     - &test_processing_module\n       name: \"(openjdk8) processing module test\"\n-      env: &processing_env\n+      env:\n       - MAVEN_PROJECTS='processing'\n-      before_script: &setup_java_test\n+      before_script:\n+        - export DRUID_USE_DEFAULT_VALUE_FOR_NULL=true\n+      script:\n         - unset _JAVA_OPTIONS\n-      script: &run_java_test\n         # Set MAVEN_OPTS for Surefire launcher. Skip remoteresources to avoid intermittent connection timeouts when\n         # resolving the SIGAR dependency.\n         - >\n           MAVEN_OPTS='-Xmx800m' ${MVN} test -pl ${MAVEN_PROJECTS}\n-          ${MAVEN_SKIP} -Dremoteresources.skip=true\n+          ${MAVEN_SKIP} -Dremoteresources.skip=true -Ddruid.generic.useDefaultValueForNull=${DRUID_USE_DEFAULT_VALUE_FOR_NULL}\n         - sh -c \"dmesg | egrep -i '(oom|out of memory|kill process|killed).*' -C 1 || exit 0\"\n         - free -m\n-      after_success: &upload_java_unit_test_coverage\n         - ${MVN} -pl ${MAVEN_PROJECTS} jacoco:report\n+        # Add merge target branch to determine diff (see https://github.com/travis-ci/travis-ci/issues/6069)\n+        - echo \"TRAVIS_BRANCH=${TRAVIS_BRANCH}\"  # for debugging\n+        - git remote set-branches --add origin ${TRAVIS_BRANCH} && git fetch\n+        # Determine the modified files that match the maven projects being tested\n+        - all_files=\"$(git diff --name-only origin/${TRAVIS_BRANCH}...HEAD | grep \"\\.java$\" || [[ $? == 1 ]])\"\n+        - for f in ${all_files}; do echo $f; done  # for debugging", "originalCommit": "16d70e93168e5aaa89dc2a75c61a7d19c7052b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgwMzYxNQ==", "url": "https://github.com/apache/druid/pull/9863#discussion_r424803615", "bodyText": "Travis already echos the command to the log: https://travis-ci.org/github/ccaominh/druid/jobs/686402944#L5731\nDoes that accomplish what you had in mind?", "author": "ccaominh", "createdAt": "2020-05-14T00:22:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5MzcxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5Mzc5Mg==", "url": "https://github.com/apache/druid/pull/9863#discussion_r424793792", "bodyText": "Maybe also print a message indicating this is the list of all project files after filtering, etc.", "author": "maytasm", "createdAt": "2020-05-13T23:48:22Z", "path": ".travis.yml", "diffHunk": "@@ -136,20 +135,51 @@ jobs:\n \n     - &test_processing_module\n       name: \"(openjdk8) processing module test\"\n-      env: &processing_env\n+      env:\n       - MAVEN_PROJECTS='processing'\n-      before_script: &setup_java_test\n+      before_script:\n+        - export DRUID_USE_DEFAULT_VALUE_FOR_NULL=true\n+      script:\n         - unset _JAVA_OPTIONS\n-      script: &run_java_test\n         # Set MAVEN_OPTS for Surefire launcher. Skip remoteresources to avoid intermittent connection timeouts when\n         # resolving the SIGAR dependency.\n         - >\n           MAVEN_OPTS='-Xmx800m' ${MVN} test -pl ${MAVEN_PROJECTS}\n-          ${MAVEN_SKIP} -Dremoteresources.skip=true\n+          ${MAVEN_SKIP} -Dremoteresources.skip=true -Ddruid.generic.useDefaultValueForNull=${DRUID_USE_DEFAULT_VALUE_FOR_NULL}\n         - sh -c \"dmesg | egrep -i '(oom|out of memory|kill process|killed).*' -C 1 || exit 0\"\n         - free -m\n-      after_success: &upload_java_unit_test_coverage\n         - ${MVN} -pl ${MAVEN_PROJECTS} jacoco:report\n+        # Add merge target branch to determine diff (see https://github.com/travis-ci/travis-ci/issues/6069)\n+        - echo \"TRAVIS_BRANCH=${TRAVIS_BRANCH}\"  # for debugging\n+        - git remote set-branches --add origin ${TRAVIS_BRANCH} && git fetch\n+        # Determine the modified files that match the maven projects being tested\n+        - all_files=\"$(git diff --name-only origin/${TRAVIS_BRANCH}...HEAD | grep \"\\.java$\" || [[ $? == 1 ]])\"\n+        - for f in ${all_files}; do echo $f; done  # for debugging\n+        - >\n+          if [[ \"${MAVEN_PROJECTS}\" = \\!* ]]; then\n+          regex=\"${MAVEN_PROJECTS:1}\";\n+          regex=\"^${regex//,\\!/\\\\|^}\";\n+          project_files=\"$(echo \"${all_files}\" | grep -v \"${regex}\" || [[ $? == 1 ]])\";\n+          else\n+          regex=\"^${MAVEN_PROJECTS//,/\\\\|^}\";\n+          project_files=\"$(echo \"${all_files}\" | grep \"${regex}\" || [[ $? == 1 ]])\";\n+          fi\n+        - for f in ${project_files}; do echo $f; done  # for debugging", "originalCommit": "16d70e93168e5aaa89dc2a75c61a7d19c7052b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgwMzQ2OA==", "url": "https://github.com/apache/druid/pull/9863#discussion_r424803468", "bodyText": "Travis already echos the command to the log: https://travis-ci.org/github/ccaominh/druid/jobs/686402944#L5741\nDoes that accomplish what you had in mind?", "author": "ccaominh", "createdAt": "2020-05-14T00:22:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5Mzc5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5NzU5NQ==", "url": "https://github.com/apache/druid/pull/9863#discussion_r424797595", "bodyText": "Maybe making these variables at the top with the other export", "author": "maytasm", "createdAt": "2020-05-14T00:01:00Z", "path": ".travis.yml", "diffHunk": "@@ -136,20 +135,51 @@ jobs:\n \n     - &test_processing_module\n       name: \"(openjdk8) processing module test\"\n-      env: &processing_env\n+      env:\n       - MAVEN_PROJECTS='processing'\n-      before_script: &setup_java_test\n+      before_script:\n+        - export DRUID_USE_DEFAULT_VALUE_FOR_NULL=true\n+      script:\n         - unset _JAVA_OPTIONS\n-      script: &run_java_test\n         # Set MAVEN_OPTS for Surefire launcher. Skip remoteresources to avoid intermittent connection timeouts when\n         # resolving the SIGAR dependency.\n         - >\n           MAVEN_OPTS='-Xmx800m' ${MVN} test -pl ${MAVEN_PROJECTS}\n-          ${MAVEN_SKIP} -Dremoteresources.skip=true\n+          ${MAVEN_SKIP} -Dremoteresources.skip=true -Ddruid.generic.useDefaultValueForNull=${DRUID_USE_DEFAULT_VALUE_FOR_NULL}\n         - sh -c \"dmesg | egrep -i '(oom|out of memory|kill process|killed).*' -C 1 || exit 0\"\n         - free -m\n-      after_success: &upload_java_unit_test_coverage\n         - ${MVN} -pl ${MAVEN_PROJECTS} jacoco:report\n+        # Add merge target branch to determine diff (see https://github.com/travis-ci/travis-ci/issues/6069)\n+        - echo \"TRAVIS_BRANCH=${TRAVIS_BRANCH}\"  # for debugging\n+        - git remote set-branches --add origin ${TRAVIS_BRANCH} && git fetch\n+        # Determine the modified files that match the maven projects being tested\n+        - all_files=\"$(git diff --name-only origin/${TRAVIS_BRANCH}...HEAD | grep \"\\.java$\" || [[ $? == 1 ]])\"\n+        - for f in ${all_files}; do echo $f; done  # for debugging\n+        - >\n+          if [[ \"${MAVEN_PROJECTS}\" = \\!* ]]; then\n+          regex=\"${MAVEN_PROJECTS:1}\";\n+          regex=\"^${regex//,\\!/\\\\|^}\";\n+          project_files=\"$(echo \"${all_files}\" | grep -v \"${regex}\" || [[ $? == 1 ]])\";\n+          else\n+          regex=\"^${MAVEN_PROJECTS//,/\\\\|^}\";\n+          project_files=\"$(echo \"${all_files}\" | grep \"${regex}\" || [[ $? == 1 ]])\";\n+          fi\n+        - for f in ${project_files}; do echo $f; done  # for debugging\n+        # Check diff code coverage for the maven projects being tested (retry install in case of network error)\n+        - >\n+          if [ -n \"${project_files}\" ]; then\n+          travis_retry npm install @connectis/diff-test-coverage@1.5.3\n+          && git diff origin/${TRAVIS_BRANCH}...HEAD -- ${project_files}\n+          | node_modules/.bin/diff-test-coverage\n+          --coverage \"**/target/site/jacoco/jacoco.xml\"\n+          --type jacoco\n+          --line-coverage 65", "originalCommit": "16d70e93168e5aaa89dc2a75c61a7d19c7052b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgwNDM0NA==", "url": "https://github.com/apache/druid/pull/9863#discussion_r424804344", "bodyText": "The before_script section that exports a variable is differs for the various jobs. Keeping the threshold here is nice for having defined in one place.", "author": "ccaominh", "createdAt": "2020-05-14T00:25:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5NzU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5ODIxNQ==", "url": "https://github.com/apache/druid/pull/9863#discussion_r424798215", "bodyText": "Should the integration-tests be skipped too?", "author": "maytasm", "createdAt": "2020-05-14T00:03:08Z", "path": "benchmarks/pom.xml", "diffHunk": "@@ -220,6 +220,13 @@\n           <skip>true</skip>\n         </configuration>\n       </plugin>\n+      <plugin>\n+        <groupId>org.jacoco</groupId>\n+        <artifactId>jacoco-maven-plugin</artifactId>\n+        <configuration>\n+          <skip>true</skip> <!-- ignore non-production code -->", "originalCommit": "16d70e93168e5aaa89dc2a75c61a7d19c7052b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgwNDgzMg==", "url": "https://github.com/apache/druid/pull/9863#discussion_r424804832", "bodyText": "Jacoco coverage isn't collected for the integration tests.", "author": "ccaominh", "createdAt": "2020-05-14T00:27:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc5ODIxNQ=="}], "type": "inlineReview"}, {"oid": "4932f1208b28b49c1c1ef6ce4236b18acf2d3c8f", "url": "https://github.com/apache/druid/commit/4932f1208b28b49c1c1ef6ce4236b18acf2d3c8f", "message": "Add comments", "committedDate": "2020-05-14T00:42:10Z", "type": "commit"}, {"oid": "e012e80e1f40fbc3dfda3703c7f65836388af9c2", "url": "https://github.com/apache/druid/commit/e012e80e1f40fbc3dfda3703c7f65836388af9c2", "message": "Merge remote-tracking branch 'upstream/master' into coverage-check", "committedDate": "2020-05-19T21:56:00Z", "type": "commit"}]}