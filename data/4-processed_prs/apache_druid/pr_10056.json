{"pr_number": 10056, "pr_title": "Add DimFilter.toOptimizedFilter(), ensure that join filter pre-analysis operates on optimized filters", "pr_createdAt": "2020-06-19T04:36:25Z", "pr_url": "https://github.com/apache/druid/pull/10056", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4NjM0NA==", "url": "https://github.com/apache/druid/pull/10056#discussion_r443886344", "bodyText": "The code coverage checker is flagging this change as uncovered (by the druid-processing unit tests):\nhttps://travis-ci.org/github/apache/druid/jobs/699956397#L1415\nNote: The new CalciteQueryTest added in this PR to druid-sql does hit this code path.", "author": "ccaominh", "createdAt": "2020-06-22T23:55:38Z", "path": "processing/src/main/java/org/apache/druid/segment/join/Joinables.java", "diffHunk": "@@ -107,8 +107,17 @@ public static boolean isPrefixedBy(final String columnName, final String prefix)\n             );\n \n             for (Query joinQuery : joinQueryLevels) {\n+              // The pre-analysis needs to apply to the optimized form of filters, as this is what will be\n+              // passed to HashJoinSegmentAdapter.makeCursors().\n+              // The optimize() call here means that the filter optimization will happen twice,\n+              // since the query toolchests will call optimize() later.\n+              // We do this for simplicity as we cannot override what query will get run later from this context.\n+              // A more complicated approach involving wrapping the query runner after the pre-merge decoration\n+              // and moving the pre-analysis might be viable.\n+              // The additional overhead of the simple approach should be low, as the additional optimize() call\n+              // on each filter will only occur once per query.\n               preAnalysisGroup.computeJoinFilterPreAnalysisIfAbsent(\n-                  joinQuery.getFilter() == null ? null : joinQuery.getFilter().toFilter(),\n+                  joinQuery.getFilter() == null ? null : joinQuery.getFilter().optimize().toFilter(),", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5MzMzMQ==", "url": "https://github.com/apache/druid/pull/10056#discussion_r443893331", "bodyText": "I'll look into moving the test into processing", "author": "jon-wei", "createdAt": "2020-06-23T00:20:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4NjM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM3MzE4NQ==", "url": "https://github.com/apache/druid/pull/10056#discussion_r447373185", "bodyText": "I tried to move this test into a new test class in processing, but I found that there's quite a lot of test machinery that has to be created (around making a SegmentWalker). The existing test infrastructure for that all exists outside of the processing module, so it cannot be reused.\nI don't think that's worth doing at this point for a single test with pretty special requirements.", "author": "jon-wei", "createdAt": "2020-06-30T02:38:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4NjM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4ODMyMA==", "url": "https://github.com/apache/druid/pull/10056#discussion_r443888320", "bodyText": "Intellij inspection check is flagging this line since Exception is not thrown by the method body:\nhttps://travis-ci.org/github/apache/druid/jobs/699956394#L11326", "author": "ccaominh", "createdAt": "2020-06-23T00:02:23Z", "path": "sql/src/test/java/org/apache/druid/sql/calcite/CalciteQueryTest.java", "diffHunk": "@@ -11987,6 +11992,83 @@ public void testNestedGroupByOnInlineDataSourceWithFilter(Map<String, Object> qu\n     );\n   }\n \n+  @Test\n+  @Parameters(source = QueryContextForJoinProvider.class)\n+  public void testGroupByJoinAsNativeQueryWithUnoptimizedFilter(Map<String, Object> queryContext) throws Exception", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM3MjQ5MQ==", "url": "https://github.com/apache/druid/pull/10056#discussion_r447372491", "bodyText": "Removed this", "author": "jon-wei", "createdAt": "2020-06-30T02:35:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4ODMyMA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "06ecb1562e53bcd56ec526b2eee8b8ec20c2f1fb", "url": "https://github.com/apache/druid/commit/06ecb1562e53bcd56ec526b2eee8b8ec20c2f1fb", "message": "Ensure that join filter pre-analysis operates on optimized filters, add DimFilter.toOptimizedFilter", "committedDate": "2020-07-01T19:32:20Z", "type": "commit"}, {"oid": "06ecb1562e53bcd56ec526b2eee8b8ec20c2f1fb", "url": "https://github.com/apache/druid/commit/06ecb1562e53bcd56ec526b2eee8b8ec20c2f1fb", "message": "Ensure that join filter pre-analysis operates on optimized filters, add DimFilter.toOptimizedFilter", "committedDate": "2020-07-01T19:32:20Z", "type": "forcePushed"}, {"oid": "83fd145e3fde446d088ed6c0b5ea87c4bd426c8e", "url": "https://github.com/apache/druid/commit/83fd145e3fde446d088ed6c0b5ea87c4bd426c8e", "message": "Remove aggressive equality check that was used for testing", "committedDate": "2020-07-01T19:38:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNjgwOA==", "url": "https://github.com/apache/druid/pull/10056#discussion_r448606808", "bodyText": "I think this is going to be called by different processing threads simultaneously, so it should be thread-safe. Perhaps use Suppliers.memoize.", "author": "gianm", "createdAt": "2020-07-01T20:45:19Z", "path": "processing/src/main/java/org/apache/druid/query/filter/AbstractOptimizableDimFilter.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.druid.query.filter;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+\n+/**\n+ * Base class for DimFilters that support optimization.\n+ */\n+abstract class AbstractOptimizableDimFilter implements DimFilter\n+{\n+  private Filter cachedOptimizedFilter = null;\n+\n+  @JsonIgnore\n+  @Override\n+  public Filter toOptimizedFilter()", "originalCommit": "83fd145e3fde446d088ed6c0b5ea87c4bd426c8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxMTQxNg==", "url": "https://github.com/apache/druid/pull/10056#discussion_r448611416", "bodyText": "Ah, I was originally thinking of just letting the processing threads for non-joins possibly do some redundant computation (for joins, the pre-analysis would call toOptimizedFilter before the processing threads run the query), but I can adjust it.", "author": "jon-wei", "createdAt": "2020-07-01T20:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNjgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxODQ5Nw==", "url": "https://github.com/apache/druid/pull/10056#discussion_r448618497", "bodyText": "I think it'd be good to adjust it; it shouldn't hurt and would save some work.", "author": "gianm", "createdAt": "2020-07-01T21:11:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNjgwOA=="}], "type": "inlineReview"}, {"oid": "8d32bbdad32346c9189dba05495985710dd5b334", "url": "https://github.com/apache/druid/commit/8d32bbdad32346c9189dba05495985710dd5b334", "message": "Use Suppliers.memoize", "committedDate": "2020-07-01T22:21:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcxNTQzNg==", "url": "https://github.com/apache/druid/pull/10056#discussion_r448715436", "bodyText": "CI is flagging these 4 as unused imports", "author": "ccaominh", "createdAt": "2020-07-02T02:36:37Z", "path": "processing/src/main/java/org/apache/druid/query/filter/DimFilter.java", "diffHunk": "@@ -23,7 +23,11 @@\n import com.fasterxml.jackson.annotation.JsonTypeInfo;\n import com.google.common.collect.RangeSet;\n import org.apache.druid.java.util.common.Cacheable;\n+import org.apache.druid.java.util.common.granularity.Granularity;\n+import org.apache.druid.query.QueryMetrics;\n import org.apache.druid.query.extraction.ExtractionFn;\n+import org.apache.druid.segment.VirtualColumns;\n+import org.joda.time.Interval;", "originalCommit": "8d32bbdad32346c9189dba05495985710dd5b334", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b013ac4ca3e92fd3c061299fc48ed8e43e14e729", "url": "https://github.com/apache/druid/commit/b013ac4ca3e92fd3c061299fc48ed8e43e14e729", "message": "Checkstyle", "committedDate": "2020-07-02T02:53:40Z", "type": "commit"}]}