{"pr_number": 4763, "pr_title": "OIDC/OAuth Revocation improvements part 1", "pr_createdAt": "2020-03-14T18:34:34Z", "pr_url": "https://github.com/apereo/cas/pull/4763", "timeline": [{"oid": "9e970f938119f7992da9fbcab5e26b64b6e5e7af", "url": "https://github.com/apereo/cas/commit/9e970f938119f7992da9fbcab5e26b64b6e5e7af", "message": "Add descendantTicket support for OAuth refresh token.", "committedDate": "2020-03-14T18:30:57Z", "type": "commit"}, {"oid": "c7618e99dc81e62f690285f14d0cf8349312f02b", "url": "https://github.com/apereo/cas/commit/c7618e99dc81e62f690285f14d0cf8349312f02b", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-14T20:09:51Z", "type": "commit"}, {"oid": "eb1676a23f1c6aa214ee70509d3d66eca295e0e1", "url": "https://github.com/apereo/cas/commit/eb1676a23f1c6aa214ee70509d3d66eca295e0e1", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-14T21:39:51Z", "type": "commit"}, {"oid": "8894e87092479651f6ce1274960101852379c83c", "url": "https://github.com/apereo/cas/commit/8894e87092479651f6ce1274960101852379c83c", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-14T23:09:51Z", "type": "commit"}, {"oid": "85b979950c0a2ea2aae4c69719f4310ef819680c", "url": "https://github.com/apereo/cas/commit/85b979950c0a2ea2aae4c69719f4310ef819680c", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-15T00:39:51Z", "type": "commit"}, {"oid": "76113de6e0df642f14bb2ab7378e579279892b57", "url": "https://github.com/apereo/cas/commit/76113de6e0df642f14bb2ab7378e579279892b57", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-15T02:09:51Z", "type": "commit"}, {"oid": "cdefc3f9bd1219cf999123c1201b36950106889e", "url": "https://github.com/apereo/cas/commit/cdefc3f9bd1219cf999123c1201b36950106889e", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-15T03:39:51Z", "type": "commit"}, {"oid": "db0cd7024e2605c13dab5dd7ad0b720bd360181e", "url": "https://github.com/apereo/cas/commit/db0cd7024e2605c13dab5dd7ad0b720bd360181e", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-15T05:09:50Z", "type": "commit"}, {"oid": "5afff8101f5379d84c9925d0f42e7defdcd58235", "url": "https://github.com/apereo/cas/commit/5afff8101f5379d84c9925d0f42e7defdcd58235", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-15T06:39:51Z", "type": "commit"}, {"oid": "36966ec9c3aad54c771839639c1457e05c2918d1", "url": "https://github.com/apereo/cas/commit/36966ec9c3aad54c771839639c1457e05c2918d1", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-15T08:29:43Z", "type": "commit"}, {"oid": "02664a4af8e8b9a3eadb7c31fd3ac8b48289d734", "url": "https://github.com/apereo/cas/commit/02664a4af8e8b9a3eadb7c31fd3ac8b48289d734", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-15T09:59:43Z", "type": "commit"}, {"oid": "fafb808070ea5bca0729efefcf689b782a25d354", "url": "https://github.com/apereo/cas/commit/fafb808070ea5bca0729efefcf689b782a25d354", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-15T11:29:43Z", "type": "commit"}, {"oid": "46ecdfee68c0a2fc9714d0116b228322d3ea3960", "url": "https://github.com/apereo/cas/commit/46ecdfee68c0a2fc9714d0116b228322d3ea3960", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-15T12:59:43Z", "type": "commit"}, {"oid": "d37e054fcc2c236624c274014159a81b32882341", "url": "https://github.com/apereo/cas/commit/d37e054fcc2c236624c274014159a81b32882341", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-15T14:29:43Z", "type": "commit"}, {"oid": "5a4225b67b36b6b3f37473d088f4b76f3363f67e", "url": "https://github.com/apereo/cas/commit/5a4225b67b36b6b3f37473d088f4b76f3363f67e", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-15T15:59:43Z", "type": "commit"}, {"oid": "4d937c4d9b142d267300c0cf1d86c32de29a3f97", "url": "https://github.com/apereo/cas/commit/4d937c4d9b142d267300c0cf1d86c32de29a3f97", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-15T17:29:43Z", "type": "commit"}, {"oid": "9d2b3b2a003fd14f7eb1bead75e55361048fc579", "url": "https://github.com/apereo/cas/commit/9d2b3b2a003fd14f7eb1bead75e55361048fc579", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-15T18:59:43Z", "type": "commit"}, {"oid": "2beae53bed10486e3579ab7946b9c11bff0d945a", "url": "https://github.com/apereo/cas/commit/2beae53bed10486e3579ab7946b9c11bff0d945a", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-15T20:29:43Z", "type": "commit"}, {"oid": "f22badf3f4f6028dace76f8e14face74eb772b9e", "url": "https://github.com/apereo/cas/commit/f22badf3f4f6028dace76f8e14face74eb772b9e", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-15T21:59:43Z", "type": "commit"}, {"oid": "cf6058ee259c8233346592b9be718f812e04ca11", "url": "https://github.com/apereo/cas/commit/cf6058ee259c8233346592b9be718f812e04ca11", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-16T00:59:47Z", "type": "commit"}, {"oid": "fadce63577e889abe6e61c5fb3786e6a83aa5459", "url": "https://github.com/apereo/cas/commit/fadce63577e889abe6e61c5fb3786e6a83aa5459", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-16T02:29:46Z", "type": "commit"}, {"oid": "38424e4b55f587835fb71425b07d85c27d8a53be", "url": "https://github.com/apereo/cas/commit/38424e4b55f587835fb71425b07d85c27d8a53be", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-16T03:59:46Z", "type": "commit"}, {"oid": "d3109d8ba5bb0aa0d88d6592bfd67d4bf115a5c3", "url": "https://github.com/apereo/cas/commit/d3109d8ba5bb0aa0d88d6592bfd67d4bf115a5c3", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-16T05:29:46Z", "type": "commit"}, {"oid": "cf004f9497686a25e588eb7ffa4b0ed74d896d54", "url": "https://github.com/apereo/cas/commit/cf004f9497686a25e588eb7ffa4b0ed74d896d54", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-16T06:59:46Z", "type": "commit"}, {"oid": "1f8d1895e852cfc54431f032567502faf0cd6bb4", "url": "https://github.com/apereo/cas/commit/1f8d1895e852cfc54431f032567502faf0cd6bb4", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-16T08:59:27Z", "type": "commit"}, {"oid": "7be2af5242ccd51bc73325272f95b844c79edbb1", "url": "https://github.com/apereo/cas/commit/7be2af5242ccd51bc73325272f95b844c79edbb1", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-16T16:29:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3NjIyNA==", "url": "https://github.com/apereo/cas/pull/4763#discussion_r394976224", "bodyText": "Looks like this might be better served as either String accessToken, or a collection of Collection<String> accessTokens", "author": "mmoayyed", "createdAt": "2020-03-19T12:03:31Z", "path": "support/cas-server-support-oauth-api/src/main/java/org/apereo/cas/ticket/refreshtoken/OAuth20RefreshTokenFactory.java", "diffHunk": "@@ -24,12 +24,14 @@\n      * @param ticketGrantingTicket the ticket granting ticket\n      * @param scopes               the scopes\n      * @param clientId             the client id\n+     * @param descendantTicket     the descendant access tokens\n      * @param requestClaims        the request claims\n      * @return the refresh token\n      */\n     OAuth20RefreshToken create(Service service, Authentication authentication,\n                                TicketGrantingTicket ticketGrantingTicket,\n                                Collection<String> scopes,\n                                String clientId,\n+                               String descendantTicket,", "originalCommit": "7be2af5242ccd51bc73325272f95b844c79edbb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA3NzUxMw==", "url": "https://github.com/apereo/cas/pull/4763#discussion_r396077513", "bodyText": "Done", "author": "julienhuon", "createdAt": "2020-03-22T10:31:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3NjIyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3NzEwMA==", "url": "https://github.com/apereo/cas/pull/4763#discussion_r394977100", "bodyText": "Update the javadoc to include:\n   The revocation of a refresh token may cause the revocation of related\n   tokens and the underlying authorization grant. If a refresh token is\n   revoked, the authorization server SHOULD\n   also invalidate all access tokens based on the same authorization\n   grant. Here, we track the access tokens.", "author": "mmoayyed", "createdAt": "2020-03-19T12:05:21Z", "path": "support/cas-server-support-oauth-api/src/main/java/org/apereo/cas/ticket/refreshtoken/OAuth20RefreshToken.java", "diffHunk": "@@ -15,4 +18,22 @@\n      * The prefix for refresh tokens.\n      */\n     String PREFIX = \"RT\";\n+\n+    /**\n+     * Client id for whom this access token was issued.\n+     *\n+     * @return client id.\n+     * @since 6.2\n+     */\n+    String getClientId();\n+\n+    /**\n+     * Gets descendant OAuth access tokens.", "originalCommit": "7be2af5242ccd51bc73325272f95b844c79edbb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA3NzUzMA==", "url": "https://github.com/apereo/cas/pull/4763#discussion_r396077530", "bodyText": "Done", "author": "julienhuon", "createdAt": "2020-03-22T10:31:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3NzEwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3NzM0NQ==", "url": "https://github.com/apereo/cas/pull/4763#discussion_r394977345", "bodyText": "Since we are only going to track access tokens for a refresh-token, it's best to simply rename this to getAccessTokens().\nAlso please change the return type to a Set.", "author": "mmoayyed", "createdAt": "2020-03-19T12:05:53Z", "path": "support/cas-server-support-oauth-api/src/main/java/org/apereo/cas/ticket/refreshtoken/OAuth20RefreshToken.java", "diffHunk": "@@ -15,4 +18,22 @@\n      * The prefix for refresh tokens.\n      */\n     String PREFIX = \"RT\";\n+\n+    /**\n+     * Client id for whom this access token was issued.\n+     *\n+     * @return client id.\n+     * @since 6.2\n+     */\n+    String getClientId();\n+\n+    /**\n+     * Gets descendant OAuth access tokens.\n+     *\n+     * @return the descendant tickets\n+     * @since 6.2\n+     */\n+    default Collection<String> getDescendantTickets() {", "originalCommit": "7be2af5242ccd51bc73325272f95b844c79edbb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA3Nzc5Ng==", "url": "https://github.com/apereo/cas/pull/4763#discussion_r396077796", "bodyText": "Instead of Collection ? Right ?", "author": "julienhuon", "createdAt": "2020-03-22T10:34:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3NzM0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyMzUxMg==", "url": "https://github.com/apereo/cas/pull/4763#discussion_r396123512", "bodyText": "Done", "author": "julienhuon", "createdAt": "2020-03-22T18:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3NzM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3NzcyMQ==", "url": "https://github.com/apereo/cas/pull/4763#discussion_r394977721", "bodyText": "Pass the access token, and the use the id in the callee.", "author": "mmoayyed", "createdAt": "2020-03-19T12:06:35Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/response/accesstoken/OAuth20DefaultTokenGenerator.java", "diffHunk": "@@ -205,10 +205,10 @@ private OAuth20DeviceToken getDeviceTokenFromTicketRegistry(final String deviceC\n         addTicketToRegistry(accessToken, ticketGrantingTicket);\n         LOGGER.debug(\"Added access token [{}] to registry\", accessToken);\n \n-        updateOAuthCode(holder);\n+        updateOAuthCode(holder, accessToken.getId());\n \n         val refreshToken = FunctionUtils.doIf(holder.isGenerateRefreshToken(),\n-            () -> generateRefreshToken(holder),\n+            () -> generateRefreshToken(holder, accessToken.getId()),", "originalCommit": "7be2af5242ccd51bc73325272f95b844c79edbb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA3NzU0Mg==", "url": "https://github.com/apereo/cas/pull/4763#discussion_r396077542", "bodyText": "Done", "author": "julienhuon", "createdAt": "2020-03-22T10:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3NzcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3Nzc2NA==", "url": "https://github.com/apereo/cas/pull/4763#discussion_r394977764", "bodyText": "Pass the access token, and the use the id in the callee.", "author": "mmoayyed", "createdAt": "2020-03-19T12:06:42Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/response/accesstoken/OAuth20DefaultTokenGenerator.java", "diffHunk": "@@ -205,10 +205,10 @@ private OAuth20DeviceToken getDeviceTokenFromTicketRegistry(final String deviceC\n         addTicketToRegistry(accessToken, ticketGrantingTicket);\n         LOGGER.debug(\"Added access token [{}] to registry\", accessToken);\n \n-        updateOAuthCode(holder);\n+        updateOAuthCode(holder, accessToken.getId());", "originalCommit": "7be2af5242ccd51bc73325272f95b844c79edbb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA3NzU1Nw==", "url": "https://github.com/apereo/cas/pull/4763#discussion_r396077557", "bodyText": "Done", "author": "julienhuon", "createdAt": "2020-03-22T10:32:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3Nzc2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3ODkwNw==", "url": "https://github.com/apereo/cas/pull/4763#discussion_r394978907", "bodyText": "Perhaps we could hide this a bit, by adding a isCodeToken() or isRefreshToken() type of methods to the holder, and move the conditions to the holder itself.", "author": "mmoayyed", "createdAt": "2020-03-19T12:08:55Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/support/oauth/web/response/accesstoken/OAuth20DefaultTokenGenerator.java", "diffHunk": "@@ -221,9 +221,14 @@ private OAuth20DeviceToken getDeviceTokenFromTicketRegistry(final String deviceC\n      * Update OAuth code.\n      *\n      * @param holder the holder\n+     * @param accessToken the accessToken\n      */\n-    protected void updateOAuthCode(final AccessTokenRequestDataHolder holder) {\n-        if (holder.getToken() instanceof OAuth20Code) {\n+    protected void updateOAuthCode(final AccessTokenRequestDataHolder holder, final String accessToken) {\n+        if (holder.getToken() instanceof OAuth20RefreshToken) {", "originalCommit": "7be2af5242ccd51bc73325272f95b844c79edbb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjExNTExMg==", "url": "https://github.com/apereo/cas/pull/4763#discussion_r396115112", "bodyText": "Done", "author": "julienhuon", "createdAt": "2020-03-22T16:46:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3ODkwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3OTE3OQ==", "url": "https://github.com/apereo/cas/pull/4763#discussion_r394979179", "bodyText": "As noted earlier, these are exclusively access tokens. So please rename the column and the field name to indicate this explicitly.", "author": "mmoayyed", "createdAt": "2020-03-19T12:09:33Z", "path": "support/cas-server-support-oauth-core-api/src/main/java/org/apereo/cas/ticket/refreshtoken/OAuth20DefaultRefreshToken.java", "diffHunk": "@@ -21,11 +26,19 @@\n  */\n @Entity\n @DiscriminatorValue(OAuth20RefreshToken.PREFIX)\n+@Getter\n @NoArgsConstructor\n public class OAuth20DefaultRefreshToken extends OAuth20DefaultCode implements OAuth20RefreshToken {\n \n     private static final long serialVersionUID = -3544459978950667758L;\n \n+    /**\n+     * The ticket ids which are tied to this ticket.\n+     */\n+    @Lob\n+    @Column(name = \"DESCENDANT_TICKETS\", length = Integer.MAX_VALUE)\n+    private HashSet<String> descendantTickets = new HashSet<>(0);", "originalCommit": "7be2af5242ccd51bc73325272f95b844c79edbb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA3NzU3Mw==", "url": "https://github.com/apereo/cas/pull/4763#discussion_r396077573", "bodyText": "Done", "author": "julienhuon", "createdAt": "2020-03-22T10:32:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3OTE3OQ=="}], "type": "inlineReview"}, {"oid": "a2271b241a8515c61c5c261f061ad500d032e26f", "url": "https://github.com/apereo/cas/commit/a2271b241a8515c61c5c261f061ad500d032e26f", "message": "Renamed DescendantTickets to AccessTokens.", "committedDate": "2020-03-22T10:28:34Z", "type": "commit"}, {"oid": "4bd812985984350b2a7860328b735185f63e1047", "url": "https://github.com/apereo/cas/commit/4bd812985984350b2a7860328b735185f63e1047", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-22T13:54:18Z", "type": "commit"}, {"oid": "6df72faf347846a5ccab705b25dacae2b76c9e7c", "url": "https://github.com/apereo/cas/commit/6df72faf347846a5ccab705b25dacae2b76c9e7c", "message": "Added isCodeToken() & isRefreshToken inside AccessTokenRequestDataHolder.", "committedDate": "2020-03-22T16:44:38Z", "type": "commit"}, {"oid": "0be6741515d7a89711793175d87a7e3326321a64", "url": "https://github.com/apereo/cas/commit/0be6741515d7a89711793175d87a7e3326321a64", "message": "accessToken instead of descendantTicket", "committedDate": "2020-03-22T17:08:21Z", "type": "commit"}, {"oid": "1c3285ffc9c0a7d5522d6ab6358adecab110b179", "url": "https://github.com/apereo/cas/commit/1c3285ffc9c0a7d5522d6ab6358adecab110b179", "message": "getAccessTokens type is now Set.", "committedDate": "2020-03-22T22:11:55Z", "type": "commit"}, {"oid": "2d7fecc784ca02833a0f6f8fc0d11dbd2267b64f", "url": "https://github.com/apereo/cas/commit/2d7fecc784ca02833a0f6f8fc0d11dbd2267b64f", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-23T00:55:40Z", "type": "commit"}, {"oid": "3723a319ced1b080d8525c72e1324d18ea0805c5", "url": "https://github.com/apereo/cas/commit/3723a319ced1b080d8525c72e1324d18ea0805c5", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-23T03:55:40Z", "type": "commit"}, {"oid": "cc631d629fa55fa9ec35c072431957c02a449d24", "url": "https://github.com/apereo/cas/commit/cc631d629fa55fa9ec35c072431957c02a449d24", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-23T06:55:40Z", "type": "commit"}, {"oid": "2efa3d902fd4f5503c8f844dd53d97d40e1da72d", "url": "https://github.com/apereo/cas/commit/2efa3d902fd4f5503c8f844dd53d97d40e1da72d", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-23T09:55:41Z", "type": "commit"}, {"oid": "b774638474190e448ec6e93d0fb8958cb6979b7c", "url": "https://github.com/apereo/cas/commit/b774638474190e448ec6e93d0fb8958cb6979b7c", "message": "Merge branch 'master' into revokerefresh", "committedDate": "2020-03-23T12:55:42Z", "type": "commit"}]}