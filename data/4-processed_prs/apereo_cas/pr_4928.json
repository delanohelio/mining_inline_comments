{"pr_number": 4928, "pr_title": "Log4j config update", "pr_createdAt": "2020-08-19T02:27:09Z", "pr_url": "https://github.com/apereo/cas/pull/4928", "timeline": [{"oid": "8cbd468c77eabdda5533b4012a5965eddf6ae8da", "url": "https://github.com/apereo/cas/commit/8cbd468c77eabdda5533b4012a5965eddf6ae8da", "message": "move stacktraces to own logfile, make optional\nmake stacktraces optional on console and in regular file, default off\n\nalso make async configurable via system property", "committedDate": "2020-09-20T21:34:14Z", "type": "commit"}, {"oid": "b4d06c3858f07989c3b6db6681ec482da275eeed", "url": "https://github.com/apereo/cas/commit/b4d06c3858f07989c3b6db6681ec482da275eeed", "message": "turn off include location by default b/c bad for performance\nespecially bad for async logging \"30-100 times slower\"\n\nalso config not using location info:\n%C or %class\n%F or %file\n%l or %location\n%L or %line\n%M or %method", "committedDate": "2020-09-20T21:34:15Z", "type": "commit"}, {"oid": "c7a6e5ab28f356c985dab2c5fbea8d21bccf400a", "url": "https://github.com/apereo/cas/commit/c7a6e5ab28f356c985dab2c5fbea8d21bccf400a", "message": "update documentation", "committedDate": "2020-09-20T21:34:15Z", "type": "commit"}, {"oid": "1627fbf3709efffbcd1caf4307a9b426d8ae570a", "url": "https://github.com/apereo/cas/commit/1627fbf3709efffbcd1caf4307a9b426d8ae570a", "message": "Add ExceptionOnlyFilter", "committedDate": "2020-09-21T01:38:27Z", "type": "commit"}, {"oid": "1627fbf3709efffbcd1caf4307a9b426d8ae570a", "url": "https://github.com/apereo/cas/commit/1627fbf3709efffbcd1caf4307a9b426d8ae570a", "message": "Add ExceptionOnlyFilter", "committedDate": "2020-09-21T01:38:27Z", "type": "forcePushed"}, {"oid": "d44365cfcc1aa33eafb75a4e338b6c4efa855a84", "url": "https://github.com/apereo/cas/commit/d44365cfcc1aa33eafb75a4e338b6c4efa855a84", "message": "Merge remote-tracking branch 'origin/master' into stacktraces", "committedDate": "2020-09-26T20:09:49Z", "type": "commit"}, {"oid": "9ec2743128b74e9b7e4dfba354de3ae81fdd453e", "url": "https://github.com/apereo/cas/commit/9ec2743128b74e9b7e4dfba354de3ae81fdd453e", "message": "update logging - make async the default", "committedDate": "2020-09-27T02:06:16Z", "type": "commit"}, {"oid": "16245d8c97cd0e76371aad2ca1ee24d052921550", "url": "https://github.com/apereo/cas/commit/16245d8c97cd0e76371aad2ca1ee24d052921550", "message": "Add test suite to run all tests in logging api", "committedDate": "2020-09-28T02:21:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUyMDQ5NQ==", "url": "https://github.com/apereo/cas/pull/4928#discussion_r497520495", "bodyText": "Seems like this can be removed, given the default impl in the parent does the same thing, and does avoid a hard-coded name.", "author": "mmoayyed", "createdAt": "2020-09-30T13:44:13Z", "path": "core/cas-server-core-logging-api/src/main/java/org/apereo/cas/logging/ExceptionOnlyFilter.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package org.apereo.cas.logging;\n+\n+import org.apache.logging.log4j.Level;\n+import org.apache.logging.log4j.Marker;\n+import org.apache.logging.log4j.core.Filter;\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.apache.logging.log4j.core.Logger;\n+import org.apache.logging.log4j.core.config.Node;\n+import org.apache.logging.log4j.core.config.plugins.Plugin;\n+import org.apache.logging.log4j.core.config.plugins.PluginBuilderFactory;\n+import org.apache.logging.log4j.core.filter.AbstractFilter;\n+import org.apache.logging.log4j.message.Message;\n+\n+/**\n+ * Deny any messages without an exception (for stack trace). Neutral on messages with stack trace to allow other filters.\n+ * @author Hal Deadman\n+ * @since 6.3\n+ */\n+@Plugin(name = \"ExceptionOnlyFilter\", category = Node.CATEGORY, elementType = Filter.ELEMENT_TYPE, printObject = true)\n+public class ExceptionOnlyFilter extends AbstractFilter {\n+\n+    protected ExceptionOnlyFilter() {\n+        super(Result.ACCEPT, Result.DENY);\n+    }\n+\n+    @Override\n+    public Result filter(final LogEvent event) {\n+        if (event.getThrown() != null) {\n+            return getOnMatch();\n+        }\n+        return getOnMismatch();\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final Message msg,\n+                         final Throwable t) {\n+        return t != null ? getOnMatch() : getOnMismatch();\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final Object msg,\n+                         final Throwable t) {\n+        return t != null ? getOnMatch() : getOnMismatch();\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final String msg,\n+                         final Object... params) {\n+        if (params != null && params.length > 0 && params[params.length - 1] instanceof Throwable) {\n+            return getOnMatch();\n+        }\n+        return getOnMismatch();\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final String msg,\n+                         final Object p0) {\n+        return super.filter(logger, level, marker, msg, p0);\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final String msg, final Object p0,\n+                         final Object p1) {\n+        return super.filter(logger, level, marker, msg, p0, p1);\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final String msg, final Object p0,\n+                         final Object p1, final Object p2) {\n+        return super.filter(logger, level, marker, msg, p0, p1, p2);\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final String msg, final Object p0,\n+                         final Object p1, final Object p2, final Object p3) {\n+        return super.filter(logger, level, marker, msg, p0, p1, p2, p3);\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final String msg, final Object p0,\n+                         final Object p1, final Object p2, final Object p3, final Object p4) {\n+        return super.filter(logger, level, marker, msg, p0, p1, p2, p3, p4);\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final String msg, final Object p0,\n+                         final Object p1, final Object p2, final Object p3, final Object p4, final Object p5) {\n+        return super.filter(logger, level, marker, msg, p0, p1, p2, p3, p4, p5);\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final String msg, final Object p0,\n+                         final Object p1, final Object p2, final Object p3, final Object p4, final Object p5,\n+                         final Object p6) {\n+        return super.filter(logger, level, marker, msg, p0, p1, p2, p3, p4, p5, p6);\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final String msg, final Object p0,\n+                         final Object p1, final Object p2, final Object p3, final Object p4, final Object p5,\n+                         final Object p6, final Object p7) {\n+        return filter(logger, level, marker, msg, new Object[] {p0, p1, p2, p3, p4, p5, p6, p7});\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final String msg, final Object p0,\n+                         final Object p1, final Object p2, final Object p3, final Object p4, final Object p5,\n+                         final Object p6, final Object p7, final Object p8) {\n+        return super.filter(logger, level, marker, msg, p0, p1, p2, p3, p4, p5, p6, p7, p8);\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final String msg, final Object p0,\n+                         final Object p1, final Object p2, final Object p3, final Object p4, final Object p5,\n+                         final Object p6, final Object p7, final Object p8, final Object p9) {\n+        return super.filter(logger, level, marker, msg, p0, p1, p2, p3, p4, p5, p6, p7, p8, p9);\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return \"ExceptionOnlyFilter\";\n+    }", "originalCommit": "16245d8c97cd0e76371aad2ca1ee24d052921550", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUyMjA1Mg==", "url": "https://github.com/apereo/cas/pull/4928#discussion_r497522052", "bodyText": "Looks to me like all such methods that do call the super can be removed.\nYou should only override and keep the following, as you do now:\npublic Result filter(LogEvent event) {}\n\npublic Result filter(Logger logger, Level level, Marker marker, Message msg, Throwable t) {  }\n\npublic Result filter(Logger logger, Level level, Marker marker, Object msg, Throwable t) { }\n\npublic Result filter(Logger logger, Level level, Marker marker, String msg, Object... params) { }", "author": "mmoayyed", "createdAt": "2020-09-30T13:46:15Z", "path": "core/cas-server-core-logging-api/src/main/java/org/apereo/cas/logging/ExceptionOnlyFilter.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package org.apereo.cas.logging;\n+\n+import org.apache.logging.log4j.Level;\n+import org.apache.logging.log4j.Marker;\n+import org.apache.logging.log4j.core.Filter;\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.apache.logging.log4j.core.Logger;\n+import org.apache.logging.log4j.core.config.Node;\n+import org.apache.logging.log4j.core.config.plugins.Plugin;\n+import org.apache.logging.log4j.core.config.plugins.PluginBuilderFactory;\n+import org.apache.logging.log4j.core.filter.AbstractFilter;\n+import org.apache.logging.log4j.message.Message;\n+\n+/**\n+ * Deny any messages without an exception (for stack trace). Neutral on messages with stack trace to allow other filters.\n+ * @author Hal Deadman\n+ * @since 6.3\n+ */\n+@Plugin(name = \"ExceptionOnlyFilter\", category = Node.CATEGORY, elementType = Filter.ELEMENT_TYPE, printObject = true)\n+public class ExceptionOnlyFilter extends AbstractFilter {\n+\n+    protected ExceptionOnlyFilter() {\n+        super(Result.ACCEPT, Result.DENY);\n+    }\n+\n+    @Override\n+    public Result filter(final LogEvent event) {\n+        if (event.getThrown() != null) {\n+            return getOnMatch();\n+        }\n+        return getOnMismatch();\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final Message msg,\n+                         final Throwable t) {\n+        return t != null ? getOnMatch() : getOnMismatch();\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final Object msg,\n+                         final Throwable t) {\n+        return t != null ? getOnMatch() : getOnMismatch();\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final String msg,\n+                         final Object... params) {\n+        if (params != null && params.length > 0 && params[params.length - 1] instanceof Throwable) {\n+            return getOnMatch();\n+        }\n+        return getOnMismatch();\n+    }\n+\n+    @Override\n+    public Result filter(final Logger logger, final Level level, final Marker marker, final String msg,", "originalCommit": "16245d8c97cd0e76371aad2ca1ee24d052921550", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUyNDkxOA==", "url": "https://github.com/apereo/cas/pull/4928#discussion_r497524918", "bodyText": "You should also update the default log4j2.xml file that is in the resources module I believe. That would be the file that kicks in, if the overlay does not present its own log4j2 config file in the properties.", "author": "mmoayyed", "createdAt": "2020-09-30T13:49:40Z", "path": "core/cas-server-core-logging-api/src/test/resources/log4j2-test.xml", "diffHunk": "@@ -16,6 +16,23 @@\n             </Policies>\n         </RollingFile>\n \n+        <!-- Required by CasLoggerFactoryTests. Filename is linked to the test. -->\n+        <!-- Setting mmediateFlush so test can check contents -->\n+        <RollingFile name=\"stacktracefile\" fileName=\"build/slf4j-exceptions.log\" append=\"true\"\n+                     filePattern=\"build/slf4j-%d{yyyy-MM-dd-HH}-%i.log.gz\" bufferedIO=\"false\" immediateFlush=\"true\">\n+            <PatternLayout pattern=\"%highlight{%d %p [%c] - %m%n}\" />\n+            <Policies>\n+                <OnStartupTriggeringPolicy />\n+                <SizeBasedTriggeringPolicy size=\"10 MB\"/>\n+                <TimeBasedTriggeringPolicy />\n+            </Policies>\n+        </RollingFile>\n+\n+        <CasAppender name=\"CasStackTraceFile\">\n+            <AppenderRef ref=\"stacktracefile\" />\n+            <ExceptionOnlyFilter/>\n+        </CasAppender>\n+", "originalCommit": "16245d8c97cd0e76371aad2ca1ee24d052921550", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk1MzkxNg==", "url": "https://github.com/apereo/cas/pull/4928#discussion_r497953916", "bodyText": "That log4j2.xml in resources is already updated with stacktracefile appender that has the ExceptionOnlyFilter. I made the other changes as well.", "author": "hdeadman", "createdAt": "2020-10-01T02:44:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUyNDkxOA=="}], "type": "inlineReview"}, {"oid": "5b6cb58d728d6a0fb85a8d4fb842a85db0081592", "url": "https://github.com/apereo/cas/commit/5b6cb58d728d6a0fb85a8d4fb842a85db0081592", "message": "remove unneeded methods", "committedDate": "2020-10-01T02:40:27Z", "type": "commit"}, {"oid": "0a31c730f35cf7c9f7fe7f6bf4d4e1d83eca8f03", "url": "https://github.com/apereo/cas/commit/0a31c730f35cf7c9f7fe7f6bf4d4e1d83eca8f03", "message": "Add to logging.md", "committedDate": "2020-10-02T03:20:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE2MjEyMQ==", "url": "https://github.com/apereo/cas/pull/4928#discussion_r500162121", "bodyText": "Hi, this lonely b seems to be a typo?", "author": "pbodnar", "createdAt": "2020-10-06T10:15:12Z", "path": "webapp/cas-server-webapp-resources/src/main/resources/log4j2.xml", "diffHunk": "@@ -56,69 +88,76 @@\n         <CasAppender name=\"casFile\">\n             <AppenderRef ref=\"file\" />\n         </CasAppender>\n+        <CasAppender name=\"casStackTraceFile\">\n+            <AppenderRef ref=\"stacktracefile\" />\n+            <ExceptionOnlyFilter/>\n+        </CasAppender>\n         <CasAppender name=\"casConsole\">\n             <AppenderRef ref=\"console\" />\n         </CasAppender>\n     </Appenders>\n     <Loggers>\n-        <AsyncLogger name=\"org.apereo.cas\" level=\"${sys:cas.log.level}\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.apereo.cas.services\" level=\"${sys:cas.log.level}\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.apereo.spring\" level=\"${sys:cas.log.level}\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.apereo.services.persondir\" level=\"${sys:cas.log.level}\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.apereo.cas.web.flow\" level=\"${sys:cas.log.level}\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.apereo.cas.web.CasWebApplication\" level=\"${sys:cas.log.level}\" includeLocation=\"true\"/>\n+        <Logger name=\"org.apereo.cas\" level=\"${sys:cas.log.level}\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.apereo.cas.services\" level=\"${sys:cas.log.level}\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.apereo.spring\" level=\"${sys:cas.log.level}\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.apereo.services.persondir\" level=\"${sys:cas.log.level}\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.apereo.cas.web.flow\" level=\"${sys:cas.log.level}\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.apereo.cas.web.CasWebApplication\" level=\"${sys:cas.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n \n-        <AsyncLogger name=\"org.apereo.inspektr.audit.support\" additivity=\"true\" level=\"info\" includeLocation=\"true\">\n+        <Logger name=\"org.apereo.inspektr.audit.support\" additivity=\"false\" level=\"info\" includeLocation=\"${sys:log.include.location}\">\n+            <AppenderRef ref=\"casConsole\"/>\n+            <AppenderRef ref=\"casFile\"/>\n             <AppenderRef ref=\"casAudit\"/>\n-        </AsyncLogger>\n+        </Logger>\n \n-        <AsyncLogger name=\"org.springframework.boot\" level=\"${sys:spring.boot.log.level}\" />\n-        <AsyncLogger name=\"org.springframework.boot.context.embedded\" level=\"info\" />\n-        <AsyncLogger name=\"org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration\" level=\"${sys:spring.security.log.level}\" />\n-        <AsyncLogger name=\"org.springframework.boot.autoconfigure.security\" level=\"${sys:spring.security.log.level}\" />\n-        <AsyncLogger name=\"org.springframework.boot.devtools\" level=\"debug\" />\n+        <Logger name=\"org.springframework.boot\" level=\"${sys:spring.boot.log.level}\" />\n+        <Logger name=\"org.springframework.boot.context.embedded\" level=\"info\" />\n+        <Logger name=\"org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration\" level=\"${sys:spring.security.log.level}\" />\n+        <Logger name=\"org.springframework.boot.autoconfigure.security\" level=\"${sys:spring.security.log.level}\" />\n+        <Logger name=\"org.springframework.boot.devtools\" level=\"debug\" />\n         \n-        <AsyncLogger name=\"org.springframework\" level=\"warn\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.springframework.webflow\" level=\"${sys:spring.webflow.log.level}\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.aop\" level=\"warn\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.springframework.session\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.scheduling\" level=\"info\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.cloud.vault\" level=\"warn\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.springframework.web.client\" level=\"warn\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.springframework.security\" level=\"${sys:spring.security.log.level}\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.cloud\" level=\"${sys:spring.cloud.log.level}\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.amqp\" level=\"error\" />\n-        <AsyncLogger name=\"org.springframework.integration\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.messaging\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.web\" level=\"${sys:spring.web.log.level}\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.orm.jpa\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.scheduling\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.context.annotation\" level=\"off\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.web.socket\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.boot.diagnostics.LoggingFailureAnalysisReporter\" level=\"trace\" includeLocation=\"true\"/>\n-\n-        <AsyncLogger name=\"com.couchbase\" level=\"warn\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.apache\" level=\"error\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"com.netflix\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.quartz\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.thymeleaf\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.pac4j\" level=\"${sys:pac4j.log.level}\" includeLocation=\"true\"/>\n+        <Logger name=\"org.springframework\" level=\"warn\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.springframework.webflow\" level=\"${sys:spring.webflow.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.aop\" level=\"warn\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.springframework.session\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.scheduling\" level=\"info\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.cloud.vault\" level=\"warn\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.springframework.web.client\" level=\"warn\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.springframework.security\" level=\"${sys:spring.security.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.cloud\" level=\"${sys:spring.cloud.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.amqp\" level=\"error\" />\n+        <Logger name=\"org.springframework.integration\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.messaging\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.web\" level=\"${sys:spring.web.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.orm.jpa\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.scheduling\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.context.annotation\" level=\"off\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.web.socket\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.boot.diagnostics.LoggingFailureAnalysisReporter\" level=\"trace\" includeLocation=\"${sys:log.include.location}\"/>\n \n-        <AsyncLogger name=\"org.opensaml\" level=\"${sys:opensaml.log.level}\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"PROTOCOL_MESSAGE\" level=\"${sys:opensaml.log.level}\" includeLocation=\"true\" />\n+        <Logger name=\"com.couchbase\" level=\"warn\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.apache\" level=\"error\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"com.netflix\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.quartz\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.thymeleaf\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.pac4j\" level=\"${sys:pac4j.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n \n-        <AsyncLogger name=\"net.sf.ehcache\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"net.jradius\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.openid4java\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.ldaptive\" level=\"${sys:ldap.log.level}\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"com.hazelcast\" level=\"${sys:hazelcast.log.level}\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.jasig.spring\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.apache.cxf\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.apache.http\" level=\"warn\" includeLocation=\"true\"/>\n+        <Logger name=\"org.opensaml\" level=\"${sys:opensaml.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"PROTOCOL_MESSAGE\" level=\"${sys:opensaml.log.level}\" includeLocation=\"${sys:log.include.location}\" />\n \n-        <AsyncRoot level=\"warn\">\n+        <Logger name=\"net.sf.ehcache\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"net.jradius\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.openid4java\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.ldaptive\" level=\"${sys:ldap.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"com.hazelcast\" level=\"${sys:hazelcast.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.jasig.spring\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.apache.cxf\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.apache.http\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+b", "originalCommit": "0a31c730f35cf7c9f7fe7f6bf4d4e1d83eca8f03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE5MjUxNQ==", "url": "https://github.com/apereo/cas/pull/4928#discussion_r500192515", "bodyText": "Hi, I wonder if you also managed to make location info like line numbers (%L in a pattern) printed when async is activated? Because according to the docs, you need to:\n\nset \"includeLocation=true\" in the configuration of all relevant loggers, including the root logger\"\n\nAnd even the Log4j documentation doesn't seem to be quite correct, because according to my experiments, the includeLocation is inherited from the root to children loggers and trying to override the value doesn't have any effect. So in short, specifying includeLocation at individual loggers doesn't make much sense under these circumstances.", "author": "pbodnar", "createdAt": "2020-10-06T11:12:47Z", "path": "webapp/cas-server-webapp-resources/src/main/resources/log4j2.xml", "diffHunk": "@@ -56,69 +88,76 @@\n         <CasAppender name=\"casFile\">\n             <AppenderRef ref=\"file\" />\n         </CasAppender>\n+        <CasAppender name=\"casStackTraceFile\">\n+            <AppenderRef ref=\"stacktracefile\" />\n+            <ExceptionOnlyFilter/>\n+        </CasAppender>\n         <CasAppender name=\"casConsole\">\n             <AppenderRef ref=\"console\" />\n         </CasAppender>\n     </Appenders>\n     <Loggers>\n-        <AsyncLogger name=\"org.apereo.cas\" level=\"${sys:cas.log.level}\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.apereo.cas.services\" level=\"${sys:cas.log.level}\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.apereo.spring\" level=\"${sys:cas.log.level}\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.apereo.services.persondir\" level=\"${sys:cas.log.level}\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.apereo.cas.web.flow\" level=\"${sys:cas.log.level}\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.apereo.cas.web.CasWebApplication\" level=\"${sys:cas.log.level}\" includeLocation=\"true\"/>\n+        <Logger name=\"org.apereo.cas\" level=\"${sys:cas.log.level}\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.apereo.cas.services\" level=\"${sys:cas.log.level}\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.apereo.spring\" level=\"${sys:cas.log.level}\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.apereo.services.persondir\" level=\"${sys:cas.log.level}\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.apereo.cas.web.flow\" level=\"${sys:cas.log.level}\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.apereo.cas.web.CasWebApplication\" level=\"${sys:cas.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n \n-        <AsyncLogger name=\"org.apereo.inspektr.audit.support\" additivity=\"true\" level=\"info\" includeLocation=\"true\">\n+        <Logger name=\"org.apereo.inspektr.audit.support\" additivity=\"false\" level=\"info\" includeLocation=\"${sys:log.include.location}\">\n+            <AppenderRef ref=\"casConsole\"/>\n+            <AppenderRef ref=\"casFile\"/>\n             <AppenderRef ref=\"casAudit\"/>\n-        </AsyncLogger>\n+        </Logger>\n \n-        <AsyncLogger name=\"org.springframework.boot\" level=\"${sys:spring.boot.log.level}\" />\n-        <AsyncLogger name=\"org.springframework.boot.context.embedded\" level=\"info\" />\n-        <AsyncLogger name=\"org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration\" level=\"${sys:spring.security.log.level}\" />\n-        <AsyncLogger name=\"org.springframework.boot.autoconfigure.security\" level=\"${sys:spring.security.log.level}\" />\n-        <AsyncLogger name=\"org.springframework.boot.devtools\" level=\"debug\" />\n+        <Logger name=\"org.springframework.boot\" level=\"${sys:spring.boot.log.level}\" />\n+        <Logger name=\"org.springframework.boot.context.embedded\" level=\"info\" />\n+        <Logger name=\"org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration\" level=\"${sys:spring.security.log.level}\" />\n+        <Logger name=\"org.springframework.boot.autoconfigure.security\" level=\"${sys:spring.security.log.level}\" />\n+        <Logger name=\"org.springframework.boot.devtools\" level=\"debug\" />\n         \n-        <AsyncLogger name=\"org.springframework\" level=\"warn\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.springframework.webflow\" level=\"${sys:spring.webflow.log.level}\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.aop\" level=\"warn\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.springframework.session\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.scheduling\" level=\"info\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.cloud.vault\" level=\"warn\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.springframework.web.client\" level=\"warn\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.springframework.security\" level=\"${sys:spring.security.log.level}\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.cloud\" level=\"${sys:spring.cloud.log.level}\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.amqp\" level=\"error\" />\n-        <AsyncLogger name=\"org.springframework.integration\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.messaging\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.web\" level=\"${sys:spring.web.log.level}\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.orm.jpa\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.scheduling\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.context.annotation\" level=\"off\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.web.socket\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.springframework.boot.diagnostics.LoggingFailureAnalysisReporter\" level=\"trace\" includeLocation=\"true\"/>\n-\n-        <AsyncLogger name=\"com.couchbase\" level=\"warn\" includeLocation=\"true\" />\n-        <AsyncLogger name=\"org.apache\" level=\"error\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"com.netflix\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.quartz\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.thymeleaf\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.pac4j\" level=\"${sys:pac4j.log.level}\" includeLocation=\"true\"/>\n+        <Logger name=\"org.springframework\" level=\"warn\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.springframework.webflow\" level=\"${sys:spring.webflow.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.aop\" level=\"warn\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.springframework.session\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.scheduling\" level=\"info\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.cloud.vault\" level=\"warn\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.springframework.web.client\" level=\"warn\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.springframework.security\" level=\"${sys:spring.security.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.cloud\" level=\"${sys:spring.cloud.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.amqp\" level=\"error\" />\n+        <Logger name=\"org.springframework.integration\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.messaging\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.web\" level=\"${sys:spring.web.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.orm.jpa\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.scheduling\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.context.annotation\" level=\"off\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.web.socket\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.springframework.boot.diagnostics.LoggingFailureAnalysisReporter\" level=\"trace\" includeLocation=\"${sys:log.include.location}\"/>\n \n-        <AsyncLogger name=\"org.opensaml\" level=\"${sys:opensaml.log.level}\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"PROTOCOL_MESSAGE\" level=\"${sys:opensaml.log.level}\" includeLocation=\"true\" />\n+        <Logger name=\"com.couchbase\" level=\"warn\" includeLocation=\"${sys:log.include.location}\" />\n+        <Logger name=\"org.apache\" level=\"error\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"com.netflix\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.quartz\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.thymeleaf\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.pac4j\" level=\"${sys:pac4j.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n \n-        <AsyncLogger name=\"net.sf.ehcache\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"net.jradius\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.openid4java\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.ldaptive\" level=\"${sys:ldap.log.level}\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"com.hazelcast\" level=\"${sys:hazelcast.log.level}\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.jasig.spring\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.apache.cxf\" level=\"warn\" includeLocation=\"true\"/>\n-        <AsyncLogger name=\"org.apache.http\" level=\"warn\" includeLocation=\"true\"/>\n+        <Logger name=\"org.opensaml\" level=\"${sys:opensaml.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"PROTOCOL_MESSAGE\" level=\"${sys:opensaml.log.level}\" includeLocation=\"${sys:log.include.location}\" />\n \n-        <AsyncRoot level=\"warn\">\n+        <Logger name=\"net.sf.ehcache\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"net.jradius\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.openid4java\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.ldaptive\" level=\"${sys:ldap.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"com.hazelcast\" level=\"${sys:hazelcast.log.level}\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.jasig.spring\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.apache.cxf\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+        <Logger name=\"org.apache.http\" level=\"warn\" includeLocation=\"${sys:log.include.location}\"/>\n+b\n+        <Root level=\"warn\">", "originalCommit": "0a31c730f35cf7c9f7fe7f6bf4d4e1d83eca8f03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}