{"pr_number": 4812, "pr_title": "properly clean up resources at application shutdown", "pr_createdAt": "2020-04-09T02:56:07Z", "pr_url": "https://github.com/apereo/cas/pull/4812", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwMTI2OQ==", "url": "https://github.com/apereo/cas/pull/4812#discussion_r421601269", "bodyText": "Remove all of this. See previous discussions on the topic.", "author": "mmoayyed", "createdAt": "2020-05-07T15:37:55Z", "path": "core/cas-server-core-util/src/main/java/org/apereo/cas/config/CasCoreUtilConfiguration.java", "diffHunk": "@@ -115,6 +116,13 @@ public SmsSender smsSender() {\n         return SmsSender.noOp();\n     }\n \n+    @Bean\n+    public SchedulerFactoryBean schedulerFactoryBean() {\n+        val schedulerFactoryBean = new SchedulerFactoryBean();\n+        schedulerFactoryBean.setWaitForJobsToCompleteOnShutdown(true);\n+        return schedulerFactoryBean;\n+    }", "originalCommit": "0d5d87bba4654a5516c4eaaf1ab90d9b11027635", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwMTcwNw==", "url": "https://github.com/apereo/cas/pull/4812#discussion_r421601707", "bodyText": "Remove all inline comments; Either turn into javadoc or write the code in such a way that \"hidden\" comments would not be required.", "author": "mmoayyed", "createdAt": "2020-05-07T15:38:30Z", "path": "support/cas-server-support-jdbc-drivers/src/main/java/org/apereo/cas/JdbcServletContextListener.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package org.apereo.cas;\n+\n+import lombok.val;\n+\n+import javax.servlet.ServletContextEvent;\n+import javax.servlet.ServletContextListener;\n+import javax.servlet.annotation.WebListener;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.util.logging.Logger;\n+\n+/**\n+ * This is {@link JdbcServletContextListener} that properly\n+ * deregisters JDBC drivers.\n+ *\n+ * @author leeyc0\n+ * @since 6.2.0\n+ */\n+@WebListener\n+public class JdbcServletContextListener implements ServletContextListener {\n+\n+    @Override\n+    public void contextInitialized(final ServletContextEvent sce) {\n+    }\n+\n+    @Override\n+    public final void contextDestroyed(final ServletContextEvent sce) {\n+        /* Slf4j does not work in contextDestroyed */\n+        val logger = Logger.getLogger(\"org.apereo.cas\");\n+        logger.info(\"Unregistering JdbcServletContextListener\");\n+\n+        /* ... First close any background tasks which may be using the DB ...\n+         * ... Then close any DB connection pools ... */\n+\n+        /*  Now deregister JDBC drivers in this context's ClassLoader:\n+         *  Get the webapp's ClassLoader */", "originalCommit": "0d5d87bba4654a5516c4eaaf1ab90d9b11027635", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwMTgzNg==", "url": "https://github.com/apereo/cas/pull/4812#discussion_r421601836", "bodyText": "This should work.", "author": "mmoayyed", "createdAt": "2020-05-07T15:38:40Z", "path": "support/cas-server-support-jdbc-drivers/src/main/java/org/apereo/cas/JdbcServletContextListener.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package org.apereo.cas;\n+\n+import lombok.val;\n+\n+import javax.servlet.ServletContextEvent;\n+import javax.servlet.ServletContextListener;\n+import javax.servlet.annotation.WebListener;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.util.logging.Logger;\n+\n+/**\n+ * This is {@link JdbcServletContextListener} that properly\n+ * deregisters JDBC drivers.\n+ *\n+ * @author leeyc0\n+ * @since 6.2.0\n+ */\n+@WebListener\n+public class JdbcServletContextListener implements ServletContextListener {\n+\n+    @Override\n+    public void contextInitialized(final ServletContextEvent sce) {\n+    }\n+\n+    @Override\n+    public final void contextDestroyed(final ServletContextEvent sce) {\n+        /* Slf4j does not work in contextDestroyed */", "originalCommit": "0d5d87bba4654a5516c4eaaf1ab90d9b11027635", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwOTQ1Mw==", "url": "https://github.com/apereo/cas/pull/4812#discussion_r421609453", "bodyText": "Actually I tried Slf4j first and did not work.", "author": "leeyc0", "createdAt": "2020-05-07T15:49:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwMTgzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxMTI1OQ==", "url": "https://github.com/apereo/cas/pull/4812#discussion_r421611259", "bodyText": "It appears that Slf4j logger already closed before contextDestroyed is called.", "author": "leeyc0", "createdAt": "2020-05-07T15:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwMTgzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYwMjAzOA==", "url": "https://github.com/apereo/cas/pull/4812#discussion_r421602038", "bodyText": "Review all logger statements, and choose levels correctly.", "author": "mmoayyed", "createdAt": "2020-05-07T15:38:55Z", "path": "support/cas-server-support-jdbc-drivers/src/main/java/org/apereo/cas/JdbcServletContextListener.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package org.apereo.cas;\n+\n+import lombok.val;\n+\n+import javax.servlet.ServletContextEvent;\n+import javax.servlet.ServletContextListener;\n+import javax.servlet.annotation.WebListener;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.util.logging.Logger;\n+\n+/**\n+ * This is {@link JdbcServletContextListener} that properly\n+ * deregisters JDBC drivers.\n+ *\n+ * @author leeyc0\n+ * @since 6.2.0\n+ */\n+@WebListener\n+public class JdbcServletContextListener implements ServletContextListener {\n+\n+    @Override\n+    public void contextInitialized(final ServletContextEvent sce) {\n+    }\n+\n+    @Override\n+    public final void contextDestroyed(final ServletContextEvent sce) {\n+        /* Slf4j does not work in contextDestroyed */\n+        val logger = Logger.getLogger(\"org.apereo.cas\");\n+        logger.info(\"Unregistering JdbcServletContextListener\");", "originalCommit": "0d5d87bba4654a5516c4eaaf1ab90d9b11027635", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cdc7e7ca7310575e709041eb9128fa92ba49f5f2", "url": "https://github.com/apereo/cas/commit/cdc7e7ca7310575e709041eb9128fa92ba49f5f2", "message": "properly unregister JDBC driver and wait quartz thread at application shutdown", "committedDate": "2020-05-08T09:36:30Z", "type": "commit"}, {"oid": "ec9e5bf91a93dd1476c1e53aace8e0967606eaf7", "url": "https://github.com/apereo/cas/commit/ec9e5bf91a93dd1476c1e53aace8e0967606eaf7", "message": "add tests", "committedDate": "2020-05-08T09:36:47Z", "type": "commit"}]}