{"pr_number": 4739, "pr_title": "Add support for tomcat cloud clustering member discovery", "pr_createdAt": "2020-02-28T18:00:57Z", "pr_url": "https://github.com/apereo/cas/pull/4739", "timeline": [{"oid": "50d4eff36839d196dbc9950173b83414895980da", "url": "https://github.com/apereo/cas/commit/50d4eff36839d196dbc9950173b83414895980da", "message": "add support for tomcat cloud clustering\n\nalso fix mavenLocal include for person-directory", "committedDate": "2020-02-28T17:10:13Z", "type": "commit"}, {"oid": "bad9a94bc50866fb8100c5ce31e530ab6b6f607b", "url": "https://github.com/apereo/cas/commit/bad9a94bc50866fb8100c5ce31e530ab6b6f607b", "message": "remove whitespace", "committedDate": "2020-02-28T17:13:41Z", "type": "commit"}, {"oid": "842ccb9877ade856549a3e56057632b0cab70972", "url": "https://github.com/apereo/cas/commit/842ccb9877ade856549a3e56057632b0cab70972", "message": "Merged branch master into tomcatclustering", "committedDate": "2020-02-29T08:47:25Z", "type": "commit"}, {"oid": "0b00f3e269c9f899c7d5db6a6aee1f6e45a19f96", "url": "https://github.com/apereo/cas/commit/0b00f3e269c9f899c7d5db6a6aee1f6e45a19f96", "message": "Update Configuration-Properties.md", "committedDate": "2020-02-29T10:32:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxODkxNQ==", "url": "https://github.com/apereo/cas/pull/4739#discussion_r386018915", "bodyText": "Small suggestion:\nI think it would be good to design a few tables (i.e. two) to explain , 1-the clustering types and 2-the different types of membership providers in more detail with links and references copied from Tomcat as much as possible. Certainly you have those in the Javadocs adequately defined where folks can get fetch them via metadata etc but it would also be good to expand on those options a bit since they are seemingly non-trivial to guess just by their name.", "author": "mmoayyed", "createdAt": "2020-02-29T10:34:24Z", "path": "docs/cas-server-documentation/configuration/Configuration-Properties.md", "diffHunk": "@@ -599,12 +599,15 @@ Enabling APR requires the following JVM system property that indicates the locat\n \n #### Session Clustering & Replication\n \n-Enable session replication to replicate web application session deltas.\n+Enable session replication to replicate web application session deltas. \n+\n+Most settings apply to the `DEFAULT` type, which requires membes to be defined. The `cloudMembershipProvider` setting applies to the `CLOUD` type.", "originalCommit": "0b00f3e269c9f899c7d5db6a6aee1f6e45a19f96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA1MDcxOA==", "url": "https://github.com/apereo/cas/pull/4739#discussion_r386050718", "bodyText": "I will add the tables, but by my reading of the documentation, the DEFAULT mechanism should not \"require\" clusterMembers, those are only for extending clusters beyond the reach of multicast (or can be used if multicast discovery is blocked/not working). The CAS code currently requires the clusterMembers for making StaticMembershipInterceptors but it probably shouldn't.", "author": "hdeadman", "createdAt": "2020-02-29T19:39:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxODkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA1MDg3MQ==", "url": "https://github.com/apereo/cas/pull/4739#discussion_r386050871", "bodyText": "Sounds good. Thanks!\nAlso, I realize this might be quick tricky but it would be great to add unit tests for session clustering in general. I have tried and failed to do so in the past but you might be more lucky. If it turns out to be too much pain or unfeasible, we can revisit later.", "author": "mmoayyed", "createdAt": "2020-02-29T19:42:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxODkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA2MjM1MA==", "url": "https://github.com/apereo/cas/pull/4739#discussion_r386062350", "bodyText": "I updated docs and made clusterMembers optional. I won't be able to add a test right now ( have a long list of things I should be doing) but I may give it a try in the coming weeks. I think an integration test might be appropriate, and maybe that could be done in the overlay since it has a docker image that could be used for both types of clusters, in kubernetes and with a regular docker network. According to this https://github.com/lilic/travis-minikube/blob/master/.travis.yml you can run minikube in a travis ci build. Starting up two CAS servers with cluster config wouldn't be too hard, but maybe there would need to be a \"test\" session scoped bean that could be accessed and modified via a session replication testing endpoint? I suppose the non-kubernetes cluster could be tested without docker but it would require an actuator or something to test the replication was working.", "author": "hdeadman", "createdAt": "2020-02-29T23:14:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxODkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjExODMyOQ==", "url": "https://github.com/apereo/cas/pull/4739#discussion_r386118329", "bodyText": "Sounds good to me, sure. Testing the replication should be easy and in fact we have modules in the codebase that do this sort of thing with Spring Boot and back it up with Mongo, Redis, etc. I imagine something from spring-session might give way to this here.\nRegarding tests, I would prefer it if the batch could be included here in the CI config rather than the overlay, specially because we'd want to catch a breaking change or failure as changes are made rather than when they might be deployed or picked up by the overlay.\nAlso, would you prefer to merge the PR now and do tests later or would you prefer to keep it all in one batch?", "author": "mmoayyed", "createdAt": "2020-03-01T15:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxODkxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE3MDE0Mg==", "url": "https://github.com/apereo/cas/pull/4739#discussion_r386170142", "bodyText": "I would prefer merging now and adding the test later in the week, I have some other branches I am working on and it is easier to work with less active branches at once.  I think i have an idea for how to test the standard replication that will work.", "author": "hdeadman", "createdAt": "2020-03-02T02:10:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxODkxNQ=="}], "type": "inlineReview"}, {"oid": "f4c6ac8f323481d09c7416419b0fd9dac26e7680", "url": "https://github.com/apereo/cas/commit/f4c6ac8f323481d09c7416419b0fd9dac26e7680", "message": "Merged branch master into tomcatclustering", "committedDate": "2020-02-29T16:17:25Z", "type": "commit"}, {"oid": "7dfb00c0da21d55660936d12a1870a405b5b7365", "url": "https://github.com/apereo/cas/commit/7dfb00c0da21d55660936d12a1870a405b5b7365", "message": "make clusterMembers not required and enable clustering only based on enabled flag\nadd to cluster related documentation", "committedDate": "2020-02-29T22:52:50Z", "type": "commit"}, {"oid": "516e0d64bbf87c73ebddf01d91bf2b0df396d84d", "url": "https://github.com/apereo/cas/commit/516e0d64bbf87c73ebddf01d91bf2b0df396d84d", "message": "checkstyle", "committedDate": "2020-03-01T03:18:20Z", "type": "commit"}, {"oid": "046b29ea39da80bf88ce8ed9f33e8c045f077d11", "url": "https://github.com/apereo/cas/commit/046b29ea39da80bf88ce8ed9f33e8c045f077d11", "message": "Merged branch master into tomcatclustering", "committedDate": "2020-03-01T05:07:06Z", "type": "commit"}, {"oid": "790911b5aac7fc33a4914267b9c99d94fa2cbd56", "url": "https://github.com/apereo/cas/commit/790911b5aac7fc33a4914267b9c99d94fa2cbd56", "message": "Merged branch master into tomcatclustering", "committedDate": "2020-03-01T17:07:03Z", "type": "commit"}, {"oid": "6fffabd6a290c6fd8b8d6447f9552e0a1d341f49", "url": "https://github.com/apereo/cas/commit/6fffabd6a290c6fd8b8d6447f9552e0a1d341f49", "message": "Merged branch master into tomcatclustering", "committedDate": "2020-03-02T09:13:06Z", "type": "commit"}, {"oid": "e9cf81138fcb195b8779c93c39fd8b1d56f5762a", "url": "https://github.com/apereo/cas/commit/e9cf81138fcb195b8779c93c39fd8b1d56f5762a", "message": "Merged branch master into tomcatclustering", "committedDate": "2020-03-02T16:43:06Z", "type": "commit"}]}