{"pr_number": 5012, "pr_title": "github CI - run tests on Windows and MacOS", "pr_createdAt": "2020-12-14T03:33:06Z", "pr_url": "https://github.com/apereo/cas/pull/5012", "timeline": [{"oid": "2133b0441a8afd49f1e76cb91602718e687e7f7f", "url": "https://github.com/apereo/cas/commit/2133b0441a8afd49f1e76cb91602718e687e7f7f", "message": "try tests on windows", "committedDate": "2020-12-14T03:30:53Z", "type": "commit"}, {"oid": "a30647eab8fe5073dc9f6e456b9d8bc3297cebb1", "url": "https://github.com/apereo/cas/commit/a30647eab8fe5073dc9f6e456b9d8bc3297cebb1", "message": "try tests on windows", "committedDate": "2020-12-14T03:51:05Z", "type": "commit"}, {"oid": "b957fea0a5457ee417ea5deaec5308374538b0e3", "url": "https://github.com/apereo/cas/commit/b957fea0a5457ee417ea5deaec5308374538b0e3", "message": "fix test on windows", "committedDate": "2020-12-15T04:54:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA4MTgzMA==", "url": "https://github.com/apereo/cas/pull/5012#discussion_r543081830", "bodyText": "Note that this cannot pass. You want the same set of tests to run all platforms equally, without any manual work whatsoever. Maintaining a separate list of test categories for windows vs unix vs something else is never going to be maintainable long-term.", "author": "mmoayyed", "createdAt": "2020-12-15T06:33:19Z", "path": ".github/workflows/cas-build.yml", "diffHunk": "@@ -100,6 +100,10 @@ jobs:\n             ${{ runner.os }}-gradle-\n       - name: Build with Gradle\n         run: ./gradlew --build-cache --configure-on-demand --no-daemon build -x test -x javadoc -x check --parallel\n+      - name: Run tests on Windows and Mac\n+        run: ./testcas.sh --category simple,mfa,files,groovy,webflow,webflow-config,webflow-actions,webflow-events,webflow-mfa-actions,attributes,services,expiration-policy", "originalCommit": "b957fea0a5457ee417ea5deaec5308374538b0e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "da4f1f14514c38452fa78340982b5fe30384e1a4", "url": "https://github.com/apereo/cas/commit/da4f1f14514c38452fa78340982b5fe30384e1a4", "message": "fix test on windows and mac", "committedDate": "2020-12-16T03:44:36Z", "type": "commit"}, {"oid": "a0dde69b9b1889efdf4e665e4f40a2a0072b8ddf", "url": "https://github.com/apereo/cas/commit/a0dde69b9b1889efdf4e665e4f40a2a0072b8ddf", "message": "fix test on windows and mac", "committedDate": "2020-12-16T03:48:24Z", "type": "commit"}, {"oid": "0b9120752d51d4c84aeeb537f4f47e7d0ad8ad2e", "url": "https://github.com/apereo/cas/commit/0b9120752d51d4c84aeeb537f4f47e7d0ad8ad2e", "message": "fix test on windows and mac", "committedDate": "2020-12-16T03:56:33Z", "type": "commit"}, {"oid": "717c782b7174ff1f6d1b29ba37f77d5bc5e6a81b", "url": "https://github.com/apereo/cas/commit/717c782b7174ff1f6d1b29ba37f77d5bc5e6a81b", "message": "fix test on windows and mac", "committedDate": "2020-12-16T04:20:36Z", "type": "commit"}, {"oid": "174c0c61fb3fbb2bbe43549f1259b66826dd951e", "url": "https://github.com/apereo/cas/commit/174c0c61fb3fbb2bbe43549f1259b66826dd951e", "message": "fix test on windows and mac", "committedDate": "2020-12-16T05:11:55Z", "type": "commit"}, {"oid": "d6dbb37eac7f9e816f209c530d91ed031187f86a", "url": "https://github.com/apereo/cas/commit/d6dbb37eac7f9e816f209c530d91ed031187f86a", "message": "fix test on windows and mac", "committedDate": "2020-12-16T23:43:15Z", "type": "commit"}, {"oid": "24986850fb2e727ade6324e5b604bcff98efe463", "url": "https://github.com/apereo/cas/commit/24986850fb2e727ade6324e5b604bcff98efe463", "message": "fix test on windows and mac", "committedDate": "2020-12-17T01:17:45Z", "type": "commit"}, {"oid": "33173fc69f874bc947a9eb38532cf346da012aa1", "url": "https://github.com/apereo/cas/commit/33173fc69f874bc947a9eb38532cf346da012aa1", "message": "fix test on windows and mac", "committedDate": "2020-12-17T01:23:26Z", "type": "commit"}, {"oid": "1837dd99d2a6ce0289984d61fbf17269a3f04c69", "url": "https://github.com/apereo/cas/commit/1837dd99d2a6ce0289984d61fbf17269a3f04c69", "message": "fix test on windows and mac", "committedDate": "2020-12-17T02:17:01Z", "type": "commit"}, {"oid": "2b933c694fef8e1a4f3e9f0f717837876dddec38", "url": "https://github.com/apereo/cas/commit/2b933c694fef8e1a4f3e9f0f717837876dddec38", "message": "update url", "committedDate": "2020-12-17T03:25:15Z", "type": "commit"}, {"oid": "a8c9648469c4e696495126e5731b89197657dcff", "url": "https://github.com/apereo/cas/commit/a8c9648469c4e696495126e5731b89197657dcff", "message": "Merge branch 'master' into ci-windows", "committedDate": "2020-12-17T03:37:29Z", "type": "commit"}, {"oid": "3a96ea176ea149adec04a5f8dbc83059de6d4b9d", "url": "https://github.com/apereo/cas/commit/3a96ea176ea149adec04a5f8dbc83059de6d4b9d", "message": "fix test on windows and mac", "committedDate": "2020-12-17T05:46:58Z", "type": "commit"}, {"oid": "b74f0d94e0694bb002577c8e680b36947474edaf", "url": "https://github.com/apereo/cas/commit/b74f0d94e0694bb002577c8e680b36947474edaf", "message": "make sure test categories are type-safe", "committedDate": "2020-12-17T08:54:03Z", "type": "commit"}, {"oid": "27050e0afbf599bb01b6292ef24952bc0481d442", "url": "https://github.com/apereo/cas/commit/27050e0afbf599bb01b6292ef24952bc0481d442", "message": "make sure test categories are type-safe", "committedDate": "2020-12-17T08:57:25Z", "type": "commit"}, {"oid": "325705aae941585e0d5aa43ab31de0d046693f6f", "url": "https://github.com/apereo/cas/commit/325705aae941585e0d5aa43ab31de0d046693f6f", "message": "socket checks should set reuse flag on mac only", "committedDate": "2020-12-17T09:14:25Z", "type": "commit"}, {"oid": "01a7a4cd4db3e0929808ef6eec32c77620db5037", "url": "https://github.com/apereo/cas/commit/01a7a4cd4db3e0929808ef6eec32c77620db5037", "message": "fix test on windows and mac", "committedDate": "2020-12-17T14:01:06Z", "type": "commit"}, {"oid": "5c681e1f49d20490194837c00a28a9731a2e7b7d", "url": "https://github.com/apereo/cas/commit/5c681e1f49d20490194837c00a28a9731a2e7b7d", "message": "fix test on windows and mac", "committedDate": "2020-12-17T14:14:17Z", "type": "commit"}, {"oid": "33e450ac26baa89526289e7ccce2b227952acecd", "url": "https://github.com/apereo/cas/commit/33e450ac26baa89526289e7ccce2b227952acecd", "message": "fix test on windows and mac", "committedDate": "2020-12-17T17:09:51Z", "type": "commit"}, {"oid": "2300c50c74a8d8f4123df2c9e7dbc0267065cd92", "url": "https://github.com/apereo/cas/commit/2300c50c74a8d8f4123df2c9e7dbc0267065cd92", "message": "fix test on windows and mac", "committedDate": "2020-12-17T18:37:07Z", "type": "commit"}, {"oid": "50bbab9f80870e2cf5bc087665178316d552a4ee", "url": "https://github.com/apereo/cas/commit/50bbab9f80870e2cf5bc087665178316d552a4ee", "message": "fix test on windows and mac", "committedDate": "2020-12-17T21:04:13Z", "type": "commit"}, {"oid": "35f6c4b1002505b7947cf77418c0561d19b9cd5d", "url": "https://github.com/apereo/cas/commit/35f6c4b1002505b7947cf77418c0561d19b9cd5d", "message": "fix test on windows and mac", "committedDate": "2020-12-18T00:16:10Z", "type": "commit"}, {"oid": "f994822e896e1393fae9f19134494cd99967bdc7", "url": "https://github.com/apereo/cas/commit/f994822e896e1393fae9f19134494cd99967bdc7", "message": "fix test on windows and mac", "committedDate": "2020-12-18T02:40:24Z", "type": "commit"}, {"oid": "2be6e6e068817e2c438e3ee71ad6cb6ea2653e74", "url": "https://github.com/apereo/cas/commit/2be6e6e068817e2c438e3ee71ad6cb6ea2653e74", "message": "fix tests on windows", "committedDate": "2020-12-18T03:25:25Z", "type": "commit"}, {"oid": "63d421306d3b88b8ab7239207853e02bf712add9", "url": "https://github.com/apereo/cas/commit/63d421306d3b88b8ab7239207853e02bf712add9", "message": "checkstyle", "committedDate": "2020-12-18T13:10:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg3MjkzOA==", "url": "https://github.com/apereo/cas/pull/5012#discussion_r545872938", "bodyText": "This block of code is due to svcFile.getCanonicalPath() throwing an IOException when one of the tests passes in a filename with some characters that windows doesn't like. The lines are showing as not covered but that is only because the coverage is calculated on Ubuntu. I suppose to get coverage we would need a filename that throws IOException on Ubuntu. The getCanonicalPath() method is only called in this method in a debug statement so another alternative would be to change that to getName() or some other method that doesn't throw IOException.\nI think this is the only non-test code changed in this PR.", "author": "hdeadman", "createdAt": "2020-12-18T14:41:48Z", "path": "core/cas-server-core-services-registry/src/main/java/org/apereo/cas/services/resource/AbstractResourceBasedServiceRegistry.java", "diffHunk": "@@ -387,9 +387,13 @@ protected RegisteredService getRegisteredServiceFromFile(final File file) {\n     protected File getRegisteredServiceFileName(final RegisteredService service) {\n         val fileName = resourceNamingStrategy.build(service, getExtensions()[0]);\n         val svcFile = new File(this.serviceRegistryDirectory.toFile(), fileName);\n+        try {\n+            svcFile.getCanonicalPath();\n+        } catch (final IOException e) {\n+            throw new IllegalArgumentException(\"File name is invalid: \" + e.getMessage(), e);\n+        }", "originalCommit": "63d421306d3b88b8ab7239207853e02bf712add9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg5NzMzNg==", "url": "https://github.com/apereo/cas/pull/5012#discussion_r545897336", "bodyText": "This looks odd just by the looks of it, to use a method seemingly to just catch an exception, without using its return value. Could we use getPath or getAbsolutePath ?", "author": "mmoayyed", "createdAt": "2020-12-18T15:09:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg3MjkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI4MzQ5Mw==", "url": "https://github.com/apereo/cas/pull/5012#discussion_r546283493", "bodyText": "Yeah the test passes if the debug uses getAbsolutePath instead of getCanonicalPath so I changed it to that.", "author": "hdeadman", "createdAt": "2020-12-19T21:13:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg3MjkzOA=="}], "type": "inlineReview"}, {"oid": "d2e9b66a4fe865b833c228518d29fd1d7e5bf288", "url": "https://github.com/apereo/cas/commit/d2e9b66a4fe865b833c228518d29fd1d7e5bf288", "message": "avoid running radius tests without radius server", "committedDate": "2020-12-19T01:11:11Z", "type": "commit"}, {"oid": "b94ea8507a5d219a157d0a7cf3b23951bad65cf7", "url": "https://github.com/apereo/cas/commit/b94ea8507a5d219a157d0a7cf3b23951bad65cf7", "message": "run init build on bash", "committedDate": "2020-12-19T06:07:19Z", "type": "commit"}, {"oid": "9837b07c81f8cc66faec9baaf296d5de2ac002a5", "url": "https://github.com/apereo/cas/commit/9837b07c81f8cc66faec9baaf296d5de2ac002a5", "message": "make another radius test conditional on radius server", "committedDate": "2020-12-19T06:20:57Z", "type": "commit"}, {"oid": "963f84537cb6e834febc3556b5bd9c2698bbccc0", "url": "https://github.com/apereo/cas/commit/963f84537cb6e834febc3556b5bd9c2698bbccc0", "message": "don't use sudo on windows bash", "committedDate": "2020-12-19T06:36:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIwNDIyMA==", "url": "https://github.com/apereo/cas/pull/5012#discussion_r546204220", "bodyText": "This makes this script work on Windows git bash (without an error about sudo not existing). Since it is using Windows \"Git Bash\" (rather than msys2 which is also on the github CI windows image), the home directory is the same as it would be in powershell or cmd.exe (so the gradle.properties being created is correct), but when it is making these directories, they are in the Git Bash root folder which is not easily accessible in same path on C or D drive in powershell. The build and tests eventually run in powershell b/c that is default shell on windows, although we could specify that they run in bash. To make folders on C: or D: drives it would need to prefix all the paths with /c or /d but I don't know how to get the current drive letter in Git Bash (doesn't have that concept like powershell does) and its not really important because these folders aren't currently required by the tests (on Windows).", "author": "hdeadman", "createdAt": "2020-12-19T07:13:03Z", "path": "ci/init-build.sh", "diffHunk": "@@ -18,8 +18,15 @@ echo -e \"User: ${USER}\"\n echo -e \"User HOME directory: ${HOME}\"\n echo -e \"************************************\"\n \n+echo -e \"Checking for sudo, not available on Windows bash\"\n+SUDO=\n+type sudo &> /dev/null\n+if [ $? -eq 0 ]; then\n+  SUDO=sudo\n+fi\n+\n echo -e \"Setting build environment...\\n\"\n-sudo mkdir -p /etc/cas/config /etc/cas/saml /etc/cas/services\n+$SUDO mkdir -p /etc/cas/config /etc/cas/saml /etc/cas/services /tmp /temp", "originalCommit": "963f84537cb6e834febc3556b5bd9c2698bbccc0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "27bb91960a1c90e96765976f856968d740d86882", "url": "https://github.com/apereo/cas/commit/27bb91960a1c90e96765976f856968d740d86882", "message": "turn off radius test if radius server not running\n\nset gitattributes so files have linux linefeeds on windows so checkstyle won't complain", "committedDate": "2020-12-19T16:38:05Z", "type": "commit"}, {"oid": "82494941185a4a24a5e521935c8feceded41a6bf", "url": "https://github.com/apereo/cas/commit/82494941185a4a24a5e521935c8feceded41a6bf", "message": "update scripts for windows", "committedDate": "2020-12-19T18:24:00Z", "type": "commit"}, {"oid": "452e6d137bf81d5caa0ea179ea4f3fccb532c4eb", "url": "https://github.com/apereo/cas/commit/452e6d137bf81d5caa0ea179ea4f3fccb532c4eb", "message": "add timeout to rest tests", "committedDate": "2020-12-19T21:59:50Z", "type": "commit"}, {"oid": "89feb7b5052c619dedd65c86e33996ad1942c784", "url": "https://github.com/apereo/cas/commit/89feb7b5052c619dedd65c86e33996ad1942c784", "message": "try changing ports", "committedDate": "2020-12-20T01:19:33Z", "type": "commit"}, {"oid": "eac289fb33ae145f880f4046299370963af6d072", "url": "https://github.com/apereo/cas/commit/eac289fb33ae145f880f4046299370963af6d072", "message": "add test categories dynamically", "committedDate": "2020-12-21T09:45:02Z", "type": "commit"}, {"oid": "692ffdcc317c5b31e672137034f0247742978ef1", "url": "https://github.com/apereo/cas/commit/692ffdcc317c5b31e672137034f0247742978ef1", "message": "add tmate for debug", "committedDate": "2020-12-22T03:02:12Z", "type": "commit"}, {"oid": "3157a12c2ac84bddc8810eaa47069b3a03ee8f10", "url": "https://github.com/apereo/cas/commit/3157a12c2ac84bddc8810eaa47069b3a03ee8f10", "message": "add tmate for debug on windows", "committedDate": "2020-12-22T03:04:20Z", "type": "commit"}, {"oid": "b4b04f1c9a37cf8c6ed078f069db5a293a05b27e", "url": "https://github.com/apereo/cas/commit/b4b04f1c9a37cf8c6ed078f069db5a293a05b27e", "message": "add tmate for debug on windows", "committedDate": "2020-12-22T03:36:51Z", "type": "commit"}, {"oid": "6dad44492206c99ca29016265dac37e924f94999", "url": "https://github.com/apereo/cas/commit/6dad44492206c99ca29016265dac37e924f94999", "message": "add tmate for debug on windows", "committedDate": "2020-12-22T03:38:45Z", "type": "commit"}, {"oid": "e676326455b8f28eb5dad855a48bd97ab3565aab", "url": "https://github.com/apereo/cas/commit/e676326455b8f28eb5dad855a48bd97ab3565aab", "message": "turn on debug in mockwebserver", "committedDate": "2020-12-22T05:12:02Z", "type": "commit"}, {"oid": "23e567eafe456f71226f84f0b8b19a674522f57a", "url": "https://github.com/apereo/cas/commit/23e567eafe456f71226f84f0b8b19a674522f57a", "message": "add debug to mockwebserver", "committedDate": "2020-12-22T13:52:20Z", "type": "commit"}, {"oid": "7fcde8695c3da9db4e4a9fbd6ed8015fbcb122dc", "url": "https://github.com/apereo/cas/commit/7fcde8695c3da9db4e4a9fbd6ed8015fbcb122dc", "message": "remove MockWebServer usage from a test failing on windows", "committedDate": "2020-12-23T13:52:30Z", "type": "commit"}, {"oid": "83a0b37f911f90b1c93b52e0ce1b0a652a54736a", "url": "https://github.com/apereo/cas/commit/83a0b37f911f90b1c93b52e0ce1b0a652a54736a", "message": "remove MockWebServer usage from a test failing on windows", "committedDate": "2020-12-23T14:44:44Z", "type": "commit"}, {"oid": "8d9600daf25c37cdf991c633bc56886aa5cbbdee", "url": "https://github.com/apereo/cas/commit/8d9600daf25c37cdf991c633bc56886aa5cbbdee", "message": "remove deprecation and configure mapper on controller", "committedDate": "2020-12-24T02:17:27Z", "type": "commit"}, {"oid": "2d2c74bee5a42da8bd404bf501583ccb9fe38f38", "url": "https://github.com/apereo/cas/commit/2d2c74bee5a42da8bd404bf501583ccb9fe38f38", "message": "Merge remote-tracking branch 'origin/master' into ci-windows\n\n# Conflicts:\n#\tci/tests/redis/run-redis-server.sh", "committedDate": "2020-12-25T19:43:07Z", "type": "commit"}, {"oid": "434fce8dcd762cc4d864ea54e8a8a5f30b0911c9", "url": "https://github.com/apereo/cas/commit/434fce8dcd762cc4d864ea54e8a8a5f30b0911c9", "message": "Merge branch 'master' into ci-windows", "committedDate": "2020-12-26T07:33:22Z", "type": "commit"}, {"oid": "9839a4c9cd23fdf1a7c02a259835fc06be789b8f", "url": "https://github.com/apereo/cas/commit/9839a4c9cd23fdf1a7c02a259835fc06be789b8f", "message": "fix acme test on windows", "committedDate": "2020-12-26T15:03:10Z", "type": "commit"}]}