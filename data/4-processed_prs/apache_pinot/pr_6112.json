{"pr_number": 6112, "pr_title": "add max length support in schema builder", "pr_createdAt": "2020-10-06T18:13:02Z", "pr_url": "https://github.com/apache/pinot/pull/6112", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MjgwMw==", "url": "https://github.com/apache/pinot/pull/6112#discussion_r500672803", "bodyText": "Please reformat this", "author": "Jackie-Jiang", "createdAt": "2020-10-07T00:40:26Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java", "diffHunk": "@@ -499,6 +499,15 @@ public SchemaBuilder addSingleValueDimension(String dimensionName, DataType data\n       return this;\n     }\n \n+    /**\n+     * Add single value dimensionFieldSpec with maxLength and a defaultNullValue\n+     */\n+    public SchemaBuilder addSingleValueDimension(String dimensionName, DataType dataType, int maxLength,\n+                                                 Object defaultNullValue) {", "originalCommit": "92cca5b9106b0cde81579592a98e30c145e4d706", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyMjU5MA==", "url": "https://github.com/apache/pinot/pull/6112#discussion_r502022590", "bodyText": "Gotcha, thanks @Jackie-Jiang for code review.", "author": "deemoliu", "createdAt": "2020-10-08T21:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MjgwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MjkwNA==", "url": "https://github.com/apache/pinot/pull/6112#discussion_r500672904", "bodyText": "Reformat this", "author": "Jackie-Jiang", "createdAt": "2020-10-07T00:40:44Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java", "diffHunk": "@@ -508,13 +517,22 @@ public SchemaBuilder addMultiValueDimension(String dimensionName, DataType dataT\n     }\n \n     /**\n-     * Add single value dimensionFieldSpec with defaultNullValue\n+     * Add multi value dimensionFieldSpec with defaultNullValue\n      */\n     public SchemaBuilder addMultiValueDimension(String dimensionName, DataType dataType, Object defaultNullValue) {\n       _schema.addField(new DimensionFieldSpec(dimensionName, dataType, false, defaultNullValue));\n       return this;\n     }\n \n+    /**\n+     * Add multi value dimensionFieldSpec with maxLength and a defaultNullValue\n+     */\n+    public SchemaBuilder addMultiValueDimension(String dimensionName, DataType dataType, int maxLength,\n+                                                Object defaultNullValue) {", "originalCommit": "92cca5b9106b0cde81579592a98e30c145e4d706", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyMjU1Mw==", "url": "https://github.com/apache/pinot/pull/6112#discussion_r502022553", "bodyText": "Gotcha, thanks for code review.", "author": "deemoliu", "createdAt": "2020-10-08T21:27:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MjkwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzMDU3NA==", "url": "https://github.com/apache/pinot/pull/6112#discussion_r501130574", "bodyText": "Why do fixed length data types (BOOLEAN/int/float/etc) need maxLength? If not, then we should not allow setting max-length for those and only apply to variable length data types (String/Bytes).", "author": "mayankshriv", "createdAt": "2020-10-07T16:01:45Z", "path": "pinot-common/src/test/java/org/apache/pinot/common/data/FieldSpecTest.java", "diffHunk": "@@ -80,6 +80,18 @@ public void testFieldSpec() {\n     Assert.assertEquals(fieldSpec1.hashCode(), fieldSpec2.hashCode());\n     Assert.assertEquals(fieldSpec1.getDefaultNullValue(), \"false\");\n \n+    // Single-value boolean type dimension field with max length and default null value.\n+    fieldSpec1 = new DimensionFieldSpec();\n+    fieldSpec1.setName(\"svDimension\");\n+    fieldSpec1.setDataType(BOOLEAN);\n+    fieldSpec1.setDefaultNullValue(false);\n+    fieldSpec1.setMaxLength(20000);", "originalCommit": "92cca5b9106b0cde81579592a98e30c145e4d706", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5MjY1Mw==", "url": "https://github.com/apache/pinot/pull/6112#discussion_r501192653", "bodyText": "Good point. The maxLength field only applies to STRING field right now (not even BYTES)", "author": "Jackie-Jiang", "createdAt": "2020-10-07T17:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzMDU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyMjUxMQ==", "url": "https://github.com/apache/pinot/pull/6112#discussion_r502022511", "bodyText": "Thanks @mayankshriv  @Jackie-Jiang for review. I will fix this test. Additional to that, do you suggest me to enforce configurable maxLength on String fields only?\nIs it possible that Pinot will support maxLength on other variable length data types in the future?\nIn our use case, we only allow user to set maxLength on String columns.", "author": "deemoliu", "createdAt": "2020-10-08T21:27:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzMDU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MzU3NQ==", "url": "https://github.com/apache/pinot/pull/6112#discussion_r502043575", "bodyText": "@Jackie-Jiang How about multi-valued fixed length data types? E.g. Does maxLength applied to multi-value long fields?", "author": "deemoliu", "createdAt": "2020-10-08T22:18:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzMDU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0MzE1Mg==", "url": "https://github.com/apache/pinot/pull/6112#discussion_r502743152", "bodyText": "@deemoliu The maxLength should only be applied to String field. The method names in Schema.java should reflect this as well. i.e., the method name should be addStringMetric().", "author": "chenboat", "createdAt": "2020-10-10T04:10:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzMDU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU0MTE3Ng==", "url": "https://github.com/apache/pinot/pull/6112#discussion_r503541176", "bodyText": "@chenboat @Jackie-Jiang thanks for the code review. I added precondition in Schema.java for dimension columns. Regarding metrics column, does METRIC column support String column?\nI think it should be supported according to https://docs.pinot.apache.org/configuration-reference/schema#metricfieldspecs\nHowever in the schema.java it weren't been supported.\nhttps://github.com/apache/incubator-pinot/blob/master/pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java#L447", "author": "deemoliu", "createdAt": "2020-10-12T21:29:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzMDU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU2MzIyMg==", "url": "https://github.com/apache/pinot/pull/6112#discussion_r503563222", "bodyText": "It looks like the doc is not in sync with the code. The code is usually the source of truth. For this PR, I think the update to METRICS column can be skipped.", "author": "chenboat", "createdAt": "2020-10-12T22:21:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzMDU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU2Mzk1Nw==", "url": "https://github.com/apache/pinot/pull/6112#discussion_r503563957", "bodyText": "I see. Then I will remove the code related to \"metrics with max length\" (since maxlength ony applied to String and metrics columns cannot be string type) and only keep \"dimension with max length\".", "author": "deemoliu", "createdAt": "2020-10-12T22:24:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzMDU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0MzI2MA==", "url": "https://github.com/apache/pinot/pull/6112#discussion_r502743260", "bodyText": "the maxLength should be applicable only to String type only as discussed earlier. You can add a Precondition Check here to make sure dataType is String.", "author": "chenboat", "createdAt": "2020-10-10T04:12:09Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java", "diffHunk": "@@ -499,6 +499,15 @@ public SchemaBuilder addSingleValueDimension(String dimensionName, DataType data\n       return this;\n     }\n \n+    /**\n+     * Add single value dimensionFieldSpec with maxLength and a defaultNullValue\n+     */\n+    public SchemaBuilder addSingleValueDimension(String dimensionName, DataType dataType, int maxLength,", "originalCommit": "27f43268f6f3a49b672f1b0131df4f032f5ee79c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU2MjA1Nw==", "url": "https://github.com/apache/pinot/pull/6112#discussion_r503562057", "bodyText": "gotcha, added precondition check. thanks for review.", "author": "deemoliu", "createdAt": "2020-10-12T22:18:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc0MzI2MA=="}], "type": "inlineReview"}, {"oid": "9d38038668a9a0924b2805634f26c61effe226ab", "url": "https://github.com/apache/pinot/commit/9d38038668a9a0924b2805634f26c61effe226ab", "message": "add max length support in schema builder", "committedDate": "2020-10-13T22:26:31Z", "type": "commit"}, {"oid": "f507cdb528131b8d8c2cec20f44feb81df99041a", "url": "https://github.com/apache/pinot/commit/f507cdb528131b8d8c2cec20f44feb81df99041a", "message": "fix the default value of metric fields in unit tests", "committedDate": "2020-10-13T22:26:32Z", "type": "commit"}, {"oid": "581bc6c5dd1869e02bb197b334a140c329c99aa7", "url": "https://github.com/apache/pinot/commit/581bc6c5dd1869e02bb197b334a140c329c99aa7", "message": "fix a unit test to aviod maxlength on boolean fields, reformat", "committedDate": "2020-10-13T22:26:32Z", "type": "commit"}, {"oid": "d441387624a21e3f838ee83ae7df50712f48f22c", "url": "https://github.com/apache/pinot/commit/d441387624a21e3f838ee83ae7df50712f48f22c", "message": "add precondition check for add fields with max length.", "committedDate": "2020-10-13T22:26:33Z", "type": "commit"}, {"oid": "04871017cdeb18776b0f65be63ac3fe6bd87ea98", "url": "https://github.com/apache/pinot/commit/04871017cdeb18776b0f65be63ac3fe6bd87ea98", "message": "remove add string metric with max length", "committedDate": "2020-10-13T22:26:33Z", "type": "commit"}]}