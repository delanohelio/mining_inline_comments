{"pr_number": 6152, "pr_title": "Support using ordinals in GROUP BY and ORDER BY clause", "pr_createdAt": "2020-10-17T21:25:32Z", "pr_url": "https://github.com/apache/pinot/pull/6152", "timeline": [{"oid": "3ba0d7f665d5f626e27d686c9bd92635c53896ee", "url": "https://github.com/apache/pinot/commit/3ba0d7f665d5f626e27d686c9bd92635c53896ee", "message": "Support using ordinals in GROUP BY and ORDER BY clause", "committedDate": "2020-10-17T21:27:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4NjcxNg==", "url": "https://github.com/apache/pinot/pull/6152#discussion_r506986716", "bodyText": "Would it be possible to make it all or nothing? For example, when you go over the group by expression list and to get the long literal for ordinal position, if the first group by expression doesn't happen to be ordinal then we simply break out of this function immediately rather than going over the rest of the expressions.\nIn other words, if the first group by expression is not an ordinal reference, then remaining one's aren't too", "author": "siddharthteotia", "createdAt": "2020-10-17T21:37:28Z", "path": "pinot-common/src/main/java/org/apache/pinot/sql/parsers/CalciteSqlParser.java", "diffHunk": "@@ -364,6 +367,42 @@ private static void queryRewrite(PinotQuery pinotQuery) {\n     validate(aliasMap, pinotQuery);\n   }\n \n+  private static void applyOrdinals(PinotQuery pinotQuery) {\n+    // handle GROUP BY clause\n+    for (int i = 0; i < pinotQuery.getGroupByListSize(); i++) {\n+      final Expression groupByExpr = pinotQuery.getGroupByList().get(i);\n+      if (groupByExpr.isSetLiteral() && groupByExpr.getLiteral().isSetLongValue()) {\n+        final int ordinal = (int) groupByExpr.getLiteral().getLongValue();\n+        pinotQuery.getGroupByList().set(i, getExpressionFromOrdinal(pinotQuery.getSelectList(), ordinal));\n+      }\n+    }\n+\n+    // handle ORDER BY clause\n+    for (int i = 0; i < pinotQuery.getOrderByListSize(); i++) {\n+      final Expression orderByExpr = pinotQuery.getOrderByList().get(i).getFunctionCall().getOperands().get(0);\n+      if (orderByExpr.isSetLiteral() && orderByExpr.getLiteral().isSetLongValue()) {\n+        final int ordinal = (int) orderByExpr.getLiteral().getLongValue();\n+        pinotQuery.getOrderByList().get(i).getFunctionCall()\n+            .setOperands(Arrays.asList(getExpressionFromOrdinal(pinotQuery.getSelectList(), ordinal)));\n+      }\n+    }", "originalCommit": "3ba0d7f665d5f626e27d686c9bd92635c53896ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4Njg0NQ==", "url": "https://github.com/apache/pinot/pull/6152#discussion_r506986845", "bodyText": "I am just trying to see how to fail fast (for some cases) out of these query rewrite methods since most of them are iterating on select, group by or order by expressions", "author": "siddharthteotia", "createdAt": "2020-10-17T21:39:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4NjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4ODA3Nw==", "url": "https://github.com/apache/pinot/pull/6152#discussion_r506988077", "bodyText": "Do you know if sql allows a combination of ordinal and alias or actual expression itself in order/ group by", "author": "kishoreg", "createdAt": "2020-10-17T21:55:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4NjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4OTYzMA==", "url": "https://github.com/apache/pinot/pull/6152#discussion_r506989630", "bodyText": "I thought we should support the case of mixing column name/ordinal/alias.\nE.g.\nselect a, b + 2, func(c) as func_c, count(*) from data group by a, 2, func_c;", "author": "xiangfu0", "createdAt": "2020-10-17T22:16:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4NjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk5MDgyMA==", "url": "https://github.com/apache/pinot/pull/6152#discussion_r506990820", "bodyText": "added a test for this as well.", "author": "xiangfu0", "createdAt": "2020-10-17T22:31:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4NjcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzAwNzMxMQ==", "url": "https://github.com/apache/pinot/pull/6152#discussion_r507007311", "bodyText": "Below is an example of query and results from mysql:", "author": "xiangfu0", "createdAt": "2020-10-18T02:29:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4NjcxNg=="}], "type": "inlineReview"}, {"oid": "b854209022d01a5c8607e404c95963002536e67b", "url": "https://github.com/apache/pinot/commit/b854209022d01a5c8607e404c95963002536e67b", "message": "Support using ordinals in GROUP BY and ORDER BY clause", "committedDate": "2020-10-17T22:28:49Z", "type": "commit"}, {"oid": "b854209022d01a5c8607e404c95963002536e67b", "url": "https://github.com/apache/pinot/commit/b854209022d01a5c8607e404c95963002536e67b", "message": "Support using ordinals in GROUP BY and ORDER BY clause", "committedDate": "2020-10-17T22:28:49Z", "type": "forcePushed"}]}