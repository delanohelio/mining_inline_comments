{"pr_number": 6262, "pr_title": "Enhance forward index reader for better performance", "pr_createdAt": "2020-11-13T21:13:58Z", "pr_url": "https://github.com/apache/pinot/pull/6262", "timeline": [{"oid": "6d2a4bfead2849d0376b108734360ef629fae0c1", "url": "https://github.com/apache/pinot/commit/6d2a4bfead2849d0376b108734360ef629fae0c1", "message": "Enhance forward index reader for better performance", "committedDate": "2020-11-13T21:35:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQxMzQzMQ==", "url": "https://github.com/apache/pinot/pull/6262#discussion_r525413431", "bodyText": "Nit suggestion: Use prime numbers?", "author": "mayankshriv", "createdAt": "2020-11-17T19:04:14Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/segment/index/readers/forward/FixedBitSVForwardIndexReaderV2Test.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.segment.index.readers.forward;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Random;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.pinot.core.io.writer.impl.FixedBitSVForwardIndexWriter;\n+import org.apache.pinot.core.segment.memory.PinotDataBuffer;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static org.testng.Assert.assertEquals;\n+\n+\n+public class FixedBitSVForwardIndexReaderV2Test {\n+  private static final File INDEX_DIR = new File(FileUtils.getTempDirectory(), \"FixedBitIntReaderTest\");\n+  private static final int NUM_VALUES = 99999;\n+  private static final int NUM_DOC_IDS = 10000;", "originalCommit": "6d2a4bfead2849d0376b108734360ef629fae0c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUyNzgyNw==", "url": "https://github.com/apache/pinot/pull/6262#discussion_r525527827", "bodyText": "This is the DocIdSetPlanNode.MAX_DOC_PER_CALL, replaced it with the constant", "author": "Jackie-Jiang", "createdAt": "2020-11-17T21:13:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQxMzQzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQxNTM5MQ==", "url": "https://github.com/apache/pinot/pull/6262#discussion_r525415391", "bodyText": "Would it be better to use explicit values instead of random?\nFor example, we know all the corner cases would be around bits being split across read boundaries. We can then programmatically generate all the splits. Given this is a fundamental change, I'd feel more comfortable with exhaustive testing on all corner cases explicitly tested.", "author": "mayankshriv", "createdAt": "2020-11-17T19:07:21Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/segment/index/readers/forward/FixedBitSVForwardIndexReaderV2Test.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.segment.index.readers.forward;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Random;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.pinot.core.io.writer.impl.FixedBitSVForwardIndexWriter;\n+import org.apache.pinot.core.segment.memory.PinotDataBuffer;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static org.testng.Assert.assertEquals;\n+\n+\n+public class FixedBitSVForwardIndexReaderV2Test {\n+  private static final File INDEX_DIR = new File(FileUtils.getTempDirectory(), \"FixedBitIntReaderTest\");\n+  private static final int NUM_VALUES = 99999;\n+  private static final int NUM_DOC_IDS = 10000;\n+  private static final Random RANDOM = new Random();\n+\n+  private final int[] _sequentialDocIds = new int[NUM_DOC_IDS];\n+  private final int[] _sparseDocIds = new int[NUM_DOC_IDS];\n+  private final int[] _lastSequentialDocIds = new int[NUM_DOC_IDS];\n+  private final int[] _dictIdBuffer = new int[NUM_DOC_IDS];\n+\n+  @BeforeClass\n+  public void setUp()\n+      throws IOException {\n+    FileUtils.forceMkdir(INDEX_DIR);\n+\n+    int sequentialDocId = RANDOM.nextInt(32);", "originalCommit": "6d2a4bfead2849d0376b108734360ef629fae0c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzNTEzMA==", "url": "https://github.com/apache/pinot/pull/6262#discussion_r525535130", "bodyText": "That's why I explicitly tested reading the last doc ids (_lastSequentialDocIds).\nModified the test to test sequentialDocId starting from 0 - 31", "author": "Jackie-Jiang", "createdAt": "2020-11-17T21:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQxNTM5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM0OTYzMQ==", "url": "https://github.com/apache/pinot/pull/6262#discussion_r525349631", "bodyText": "do we need V1 V2?", "author": "kishoreg", "createdAt": "2020-11-17T17:29:48Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/loader/invertedindex/TextIndexHandler.java", "diffHunk": "@@ -51,7 +51,7 @@\n import org.apache.pinot.core.segment.index.readers.ForwardIndexReaderContext;\n import org.apache.pinot.core.segment.index.readers.StringDictionary;\n import org.apache.pinot.core.segment.index.readers.forward.BaseChunkSVForwardIndexReader.ChunkReaderContext;\n-import org.apache.pinot.core.segment.index.readers.forward.FixedBitSVForwardIndexReader;\n+import org.apache.pinot.core.segment.index.readers.forward.FixedBitSVForwardIndexReaderV2;", "originalCommit": "6d2a4bfead2849d0376b108734360ef629fae0c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMzMDI4NQ==", "url": "https://github.com/apache/pinot/pull/6262#discussion_r526330285", "bodyText": "V1 is replaced with V2. Will do the clean up as a separate PR", "author": "Jackie-Jiang", "createdAt": "2020-11-18T18:36:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM0OTYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU4MTg3MQ==", "url": "https://github.com/apache/pinot/pull/6262#discussion_r525581871", "bodyText": "should we use some cached int arrays here?", "author": "kishoreg", "createdAt": "2020-11-17T22:59:15Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/readers/forward/FixedBitSVForwardIndexReaderV2.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.segment.index.readers.forward;\n+\n+import org.apache.pinot.core.io.reader.impl.FixedBitIntReader;\n+import org.apache.pinot.core.segment.index.readers.ForwardIndexReader;\n+import org.apache.pinot.core.segment.index.readers.ForwardIndexReaderContext;\n+import org.apache.pinot.core.segment.memory.PinotDataBuffer;\n+import org.apache.pinot.spi.data.FieldSpec.DataType;\n+\n+\n+/**\n+ * Bit-compressed dictionary-encoded forward index reader for single-value columns. The values returned are dictionary\n+ * ids.\n+ */\n+public final class FixedBitSVForwardIndexReaderV2 implements ForwardIndexReader<ForwardIndexReaderContext> {\n+  private final FixedBitIntReader _reader;\n+  private final int _numDocs;\n+\n+  public FixedBitSVForwardIndexReaderV2(PinotDataBuffer dataBuffer, int numDocs, int numBitsPerValue) {\n+    _reader = FixedBitIntReader.getReader(dataBuffer, numBitsPerValue);\n+    _numDocs = numDocs;\n+  }\n+\n+  @Override\n+  public boolean isDictionaryEncoded() {\n+    return true;\n+  }\n+\n+  @Override\n+  public boolean isSingleValue() {\n+    return true;\n+  }\n+\n+  @Override\n+  public DataType getValueType() {\n+    return DataType.INT;\n+  }\n+\n+  @Override\n+  public int getDictId(int docId, ForwardIndexReaderContext context) {\n+    return _reader.read(docId);\n+  }\n+\n+  @Override\n+  public void readDictIds(int[] docIds, int length, int[] dictIdBuffer, ForwardIndexReaderContext context) {\n+    int firstDocId = docIds[0];\n+    int lastDocId = docIds[length - 1];\n+    int index = 0;\n+\n+    // Use bulk read if the doc ids are sequential\n+    if (lastDocId - firstDocId + 1 == length && length >= 64) {\n+      int[] buffer = new int[32];", "originalCommit": "2553e72eece292795905fa221685bed6bef8ea11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMzMTM3OQ==", "url": "https://github.com/apache/pinot/pull/6262#discussion_r526331379", "bodyText": "This is a very small array and the overhead is negligible. We create the buffer per block (10000 docs) only when bulk read is needed", "author": "Jackie-Jiang", "createdAt": "2020-11-18T18:38:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU4MTg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIyNjIwMw==", "url": "https://github.com/apache/pinot/pull/6262#discussion_r527226203", "bodyText": "How is this covering all the numbits cases for new APIs?", "author": "siddharthteotia", "createdAt": "2020-11-19T21:51:42Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/io/reader/impl/FixedBitIntReaderTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.io.reader.impl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Random;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.pinot.core.io.writer.impl.FixedBitSVForwardIndexWriter;\n+import org.apache.pinot.core.segment.memory.PinotDataBuffer;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static org.testng.Assert.assertEquals;\n+\n+\n+public class FixedBitIntReaderTest {\n+  private static final File INDEX_DIR = new File(FileUtils.getTempDirectory(), \"FixedBitIntReaderTest\");\n+  private static final int NUM_VALUES = 95;\n+  private static final Random RANDOM = new Random();", "originalCommit": "2553e72eece292795905fa221685bed6bef8ea11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIyNjM4Mg==", "url": "https://github.com/apache/pinot/pull/6262#discussion_r527226382", "bodyText": "We should add tests for new APIs for all numbits right?", "author": "siddharthteotia", "createdAt": "2020-11-19T21:52:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIyNjIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMwOTc5MQ==", "url": "https://github.com/apache/pinot/pull/6262#discussion_r527309791", "bodyText": "This is just the random value generator. All the bits are tested. Check the for look on line 55", "author": "Jackie-Jiang", "createdAt": "2020-11-20T00:37:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIyNjIwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIyNjg1OQ==", "url": "https://github.com/apache/pinot/pull/6262#discussion_r527226859", "bodyText": "We should add tests for all numBits and all possible docID ranges to ensure the new APIs are correctly decoding (and there is no possibility of segfault)", "author": "siddharthteotia", "createdAt": "2020-11-19T21:52:56Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/segment/index/readers/forward/FixedBitSVForwardIndexReaderV2Test.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.segment.index.readers.forward;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Random;\n+import org.apache.commons.io.FileUtils;\n+import org.apache.pinot.core.io.writer.impl.FixedBitSVForwardIndexWriter;\n+import org.apache.pinot.core.plan.DocIdSetPlanNode;\n+import org.apache.pinot.core.segment.memory.PinotDataBuffer;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.Test;\n+\n+import static org.testng.Assert.assertEquals;\n+\n+\n+public class FixedBitSVForwardIndexReaderV2Test {\n+  private static final File INDEX_DIR = new File(FileUtils.getTempDirectory(), \"FixedBitIntReaderTest\");\n+  private static final int NUM_VALUES = 99_999;", "originalCommit": "2553e72eece292795905fa221685bed6bef8ea11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMxMTcyNg==", "url": "https://github.com/apache/pinot/pull/6262#discussion_r527311726", "bodyText": "It tests all the bits (for loop on line 77), and sequential reads starting at index 0-31, and also the last 10000 docs. IMO it is quite thorough.", "author": "Jackie-Jiang", "createdAt": "2020-11-20T00:40:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIyNjg1OQ=="}], "type": "inlineReview"}, {"oid": "e15827b95036d7bbded59fdc70f83a272717086c", "url": "https://github.com/apache/pinot/commit/e15827b95036d7bbded59fdc70f83a272717086c", "message": "Enhance forward index reader for better performance", "committedDate": "2020-11-20T21:15:49Z", "type": "commit"}, {"oid": "e15827b95036d7bbded59fdc70f83a272717086c", "url": "https://github.com/apache/pinot/commit/e15827b95036d7bbded59fdc70f83a272717086c", "message": "Enhance forward index reader for better performance", "committedDate": "2020-11-20T21:15:49Z", "type": "forcePushed"}]}