{"pr_number": 5740, "pr_title": "[TE] Added a backfill start date for Anomaly Detection", "pr_createdAt": "2020-07-23T03:44:26Z", "pr_url": "https://github.com/apache/pinot/pull/5740", "timeline": [{"oid": "7605d031307b833f70003076d0affe5cb6f0a3be", "url": "https://github.com/apache/pinot/commit/7605d031307b833f70003076d0affe5cb6f0a3be", "message": "[TE] Added a backfill start date for Anomaly Detection\n\nWhen an alert is created, it automatically triggers a YAML Onboarding Task\nwhich detects all anomalies in the past 30 days. This change makes the\nsetting configurable by providing a backfill start timestamp.\n\nNot providing the value or simply providing a dubious entry would result\nin the system defaulting to the 30 day lookback.\n\nThis change also updates the alert template UI to make it easy for a new\nuser to try this config", "committedDate": "2020-07-23T03:40:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2MTcyOA==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459661728", "bodyText": "I'd prefer keeping the template simple and put all the additional configurations in the user guide. Regular users need not know about these parameters.", "author": "akshayrai", "createdAt": "2020-07-23T18:56:37Z", "path": "thirdeye/thirdeye-frontend/app/utils/yaml-tools.js", "diffHunk": "@@ -29,6 +28,20 @@ rules:\n     type: DATA_SLA              # Alert if data is missing.\n     params:\n       sla: 3_DAYS               # Data is missing for 3 days since last availability\n+\n+# You can mention a cron to allow this detection to be run periodically\n+# For example, the cron below would execute every 5 minutes.\n+# cron: \"0 0/5 * 1/1 * ? *\"\n+\n+# Backfill detections\n+# You can use the backfillStart parameter to denote how far back you want the anomalies\n+# to be detected.\n+# A valid entry is a timestamp value in millis.\n+# \n+# - By default, (if not mentioned), the lookback is 30 days\n+# - A value of 0 (zero) implies complete backfill till the start of data. As shown below.\n+# backfillStart: 0 \n+", "originalCommit": "7605d031307b833f70003076d0affe5cb6f0a3be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY4MDg1MA==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459680850", "bodyText": "Hey @akshayrai\nI understand your point. The problem is that it is very hard for a regular user to get started on ThirdEye. These configurations are buried in the doc somewhere on a FAQ or you have to go through the code. I didn't know that there is a capability to add cron until someone else told me.\nI think a YAML interface may be good for advanced users who can have configurations saved in files/elsewhere. However for a regular user,  it might help to just have a simple UI with text boxes and dropdowns etc which have hints/prepopulated and are easy to use without the need for documentation.\nI added to the template here so that the user doesn't need to go find information elsewhere but is able to see it right within the app. I agree this makes the template more complex and that's the reason why I pushed it down at the bottom. Let me know what you think and I can revert the template changes.", "author": "suvodeep-pyne", "createdAt": "2020-07-23T19:32:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2MTcyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxODI2Ng==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r460318266", "bodyText": "I understand. We too discussed this idea in the past, but the issue with this approach is that - There are several basic alert and subscription parameters which we might want to add to the template and this will simply keep growing over time making the config bigger and harder to read.\nTo help with this problem, the alternative we have taken is,\na. A link is provided in the create alert UI  (at the top) that should point to the documentation on the alert configs. (I can work on OS'ing this wiki if it isn't already)\nb. Eventually, we should have a full form UI through which all the basic features should be surfaced. The yaml config is more for advanced users who can refer to a doc and update the configs as required.\nSo, it would be better to keep the template simple and put the additional settings in the doc.", "author": "akshayrai", "createdAt": "2020-07-24T22:43:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2MTcyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2NTU1NA==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459665554", "bodyText": "Can you shed some light on the need for a custom backfill configuration? Since this is a one time setting, I am not very confident of putting it in the detection config.", "author": "akshayrai", "createdAt": "2020-07-23T19:03:46Z", "path": "thirdeye/thirdeye-frontend/app/utils/yaml-tools.js", "diffHunk": "@@ -29,6 +28,20 @@ rules:\n     type: DATA_SLA              # Alert if data is missing.\n     params:\n       sla: 3_DAYS               # Data is missing for 3 days since last availability\n+\n+# You can mention a cron to allow this detection to be run periodically\n+# For example, the cron below would execute every 5 minutes.\n+# cron: \"0 0/5 * 1/1 * ? *\"\n+\n+# Backfill detections\n+# You can use the backfillStart parameter to denote how far back you want the anomalies\n+# to be detected.\n+# A valid entry is a timestamp value in millis.\n+# \n+# - By default, (if not mentioned), the lookback is 30 days\n+# - A value of 0 (zero) implies complete backfill till the start of data. As shown below.\n+# backfillStart: 0 ", "originalCommit": "7605d031307b833f70003076d0affe5cb6f0a3be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY5MTkwMA==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459691900", "bodyText": "Agreed. But I found this to be the easiest way of having this capability without a larger change.\nSo, here is the use case: I uploaded a new dataset and I want to see the anomalies. I was unable to find a way to do this. Creating an alert would trigger detections for the past month but not before that. It is not configurable. And I couldn't find a way to just fire a detection from the UI.\nThis parameter allows the user to have the ability to use a default or choose a start time at the creation of the alert. I agree with you that creating an alert rule and running detection can be separated. This change sort of addresses the immediate requirement that allows users to upload their datasets and run detections on past data. Let me know what you think.", "author": "suvodeep-pyne", "createdAt": "2020-07-23T19:55:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2NTU1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxODU1Mg==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r460318552", "bodyText": "Couple of issues/suggestions\n\nThere is an api through which you can trigger a replay or backfill. You might want to consider exposing this api to the user. It is better to keep the alert creation independent of backfill. 30 days is hard-coded just to populate some metrics on the UI for users to play around.\nIf you haven't explored yet, there is a preview experience through which users can trigger detection on older data. However, this is adhoc and there is no option of saving the results. You can consider adding the option of persisting the results!", "author": "akshayrai", "createdAt": "2020-07-24T22:44:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2NTU1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2NjM1OQ==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459666359", "bodyText": "The term backfill is a bit overloaded. It could also mean rerunning the detection which is not what is intended.", "author": "akshayrai", "createdAt": "2020-07-23T19:05:13Z", "path": "thirdeye/thirdeye-frontend/app/utils/yaml-tools.js", "diffHunk": "@@ -29,6 +28,20 @@ rules:\n     type: DATA_SLA              # Alert if data is missing.\n     params:\n       sla: 3_DAYS               # Data is missing for 3 days since last availability\n+\n+# You can mention a cron to allow this detection to be run periodically\n+# For example, the cron below would execute every 5 minutes.\n+# cron: \"0 0/5 * 1/1 * ? *\"\n+\n+# Backfill detections", "originalCommit": "7605d031307b833f70003076d0affe5cb6f0a3be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY4NjY4Ng==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459686686", "bodyText": "Yes. That is a side effect but it happens today anyway. Whenever, you create an alert, you run the detection for the past month every time. This parameter just exposes the ability to configure the same.\nBut I totally agree on having separate atomic APIs in the longer term for creating alerts, doing detections and saving them. Currently the preview runs detections but does not save them. Creating an alert also fires detections but doesn't allow configuring the detection. Also, it doesn't seem to be possible to create a new alert without triggering a detectionjob.", "author": "suvodeep-pyne", "createdAt": "2020-07-23T19:44:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2NjM1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxOTEwOA==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r460319108", "bodyText": "There are apis for each one of them. I will consider documenting it.", "author": "akshayrai", "createdAt": "2020-07-24T22:46:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2NjM1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2Nzc3MA==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459667770", "bodyText": "@harleyjj\nCan we customize and configure the default template? At LinkedIn, we are relying on ALGORITHM as the default detection. If we change this, we need to have an alternative to plug a different default setting.", "author": "akshayrai", "createdAt": "2020-07-23T19:07:52Z", "path": "thirdeye/thirdeye-frontend/app/utils/yaml-tools.js", "diffHunk": "@@ -12,12 +12,11 @@ dataset: dataset_to_which_this_metric_belongs\n rules:\n - detection:\n   - name: detection_rule_1\n-    type: ALGORITHM             # Configure the detection type here. See doc for more details.\n+    type: PERCENTAGE_RULE       # Configure the detection type here. See doc for more details.", "originalCommit": "7605d031307b833f70003076d0affe5cb6f0a3be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY4MTUzMQ==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459681531", "bodyText": "Hey @akshayrai\nALGORITHM doesn't seem to work in open source. It says type not found. I changed it so that we can have a default that users can use out of the box.", "author": "suvodeep-pyne", "createdAt": "2020-07-23T19:34:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2Nzc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY4ODg0Mw==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459688843", "bodyText": "I think we can move these templates into the environment.js file here and then different users can configure their own default templates for detection and subscription group yaml configurations.", "author": "harleyjj", "createdAt": "2020-07-23T19:49:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2Nzc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTcwMjczOQ==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459702739", "bodyText": "@harleyjj @akshayrai\nWe could keep the default setting for now if it helps and come up with a plan. I did this now since I thought that have a working default setting would be easier for a user to get started.", "author": "suvodeep-pyne", "createdAt": "2020-07-23T20:16:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2Nzc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMxODc4Ng==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r460318786", "bodyText": "Yes, we should pull this out into a config. @suvodeep-pyne, feel free to update this or we can do it at a later stage.", "author": "akshayrai", "createdAt": "2020-07-24T22:45:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2Nzc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2OTIxOA==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459669218", "bodyText": "I think we already have a utility for this. Can you try MapUtils or ConfigUtils?", "author": "akshayrai", "createdAt": "2020-07-23T19:10:47Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java", "diffHunk": "@@ -189,6 +190,7 @@ private DetectionConfigDTO generateDetectionConfig(Map<String, Object> yamlConfi\n     config.setCron(cron);\n     config.setActive(MapUtils.getBooleanValue(yamlConfigMap, PROP_ACTIVE, true));\n     config.setYaml(yamlConfig);\n+    config.setBackfillStart(parseTimeStampLong(yamlConfigMap.get(PROP_BACKFILL_START)));", "originalCommit": "7605d031307b833f70003076d0affe5cb6f0a3be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY4NDI4Mw==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459684283", "bodyText": "I found org.apache.pinot.thirdeye.detection.ConfigUtils#getLongs(java.util.Collection<java.lang.Number>) but that takes a list and has a slightly different behavior which would require me to have a separate method anyway.\nAre you aware of any other utility? Please do share if you find something.", "author": "suvodeep-pyne", "createdAt": "2020-07-23T19:39:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2OTIxOA=="}], "type": "inlineReview"}, {"oid": "3de9f1a0f435bd8deaf0fe6dcb2b77c8d05b212a", "url": "https://github.com/apache/pinot/commit/3de9f1a0f435bd8deaf0fe6dcb2b77c8d05b212a", "message": "[TE] Added a backfill start date for Anomaly Detection\n\nUpdates. Replaced backfillStart with the already existing lastTimestamp\nThis value is used as a checkpoint and is already being persisted in the db", "committedDate": "2020-07-24T03:38:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MjY1OQ==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r461792659", "bodyText": "Couple of concerns with backfilling all the data:\n\nBackfilling all the data can take quite some time, especially if there are years worth of data and possibly even fail due to timeout and other issues.\nThere isn't much benefit of backfilling older data. Users usually don't care about historical anomalies/issues, at least not older than a month.\nThe goal of the 30 day default backfill is to quickly show some stats and recent anomalies as soon as the alert is created. Otherwise, the alert page will look empty and users have to revisit after some time.\nTypically, users tend to create an alert using the basic settings and update it later on. When they update,  anomalies created using the initial setting will no longer make sense.\n\nWe could increase the default limit from 30 days to say 90 days if that is more reasonable?", "author": "akshayrai", "createdAt": "2020-07-28T18:39:46Z", "path": "thirdeye/thirdeye-frontend/app/utils/yaml-tools.js", "diffHunk": "@@ -29,6 +28,20 @@ rules:\n     type: DATA_SLA              # Alert if data is missing.\n     params:\n       sla: 3_DAYS               # Data is missing for 3 days since last availability\n+\n+# You can mention a cron to allow this detection to be run periodically\n+# For example, the cron below would execute every 5 minutes.\n+# cron: \"0 0/5 * 1/1 * ? *\"\n+\n+# Detections in past data\n+# You can use the lastTimestamp parameter to denote how far back you want the anomalies\n+# to be detected. This value acts like a checkpoint or high watermark. \n+# A valid entry is a non negative timestamp value in millis.\n+# \n+# - By default, (if not mentioned), the lookback is 30 days\n+# - A value of 0 (zero) implies complete backfill till the start of data. As shown below.", "originalCommit": "3de9f1a0f435bd8deaf0fe6dcb2b77c8d05b212a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aab60e7196ec13a3c755f7a35c514beced82ad7b", "url": "https://github.com/apache/pinot/commit/aab60e7196ec13a3c755f7a35c514beced82ad7b", "message": "[TE] Added a backfill start date for Anomaly Detection\n\nUndoing changes in create alert yaml template", "committedDate": "2020-07-28T22:45:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1MzMxOQ==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r461953319", "bodyText": "Since the default value of lastTimestamp will be 0 (when not set), we should probably change this condition here to not trigger detection on the entire dataset.", "author": "akshayrai", "createdAt": "2020-07-28T23:36:34Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/YamlResource.java", "diffHunk": "@@ -236,10 +236,17 @@ private void createYamlOnboardingTask(long configId, long tuningWindowStart, lon\n     info.setTuningWindowStart(tuningWindowStart);\n     info.setTuningWindowEnd(tuningWindowEnd);\n     info.setEnd(System.currentTimeMillis());\n-    info.setStart(info.getEnd() - ONBOARDING_REPLAY_LOOKBACK);\n+\n+    long lastTimestamp = detectionConfig.getLastTimestamp();\n+    // If no value is present, set the default lookback\n+    if (lastTimestamp < 0) {", "originalCommit": "aab60e7196ec13a3c755f7a35c514beced82ad7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMTIwNw==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r462001207", "bodyText": "Hey @akshayrai\nDuring org.apache.pinot.thirdeye.detection.yaml.translator.DetectionConfigTranslator#generateDetectionConfig, the default is always set to -1 in which case, it is set to 30 days before current time. ref: org/apache/pinot/thirdeye/detection/yaml/YamlResource.java:242\nI can simplify that a bit but then the YamlResource default needs to accessed from the translator which I found to be a bit confusing.", "author": "suvodeep-pyne", "createdAt": "2020-07-29T02:30:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1MzMxOQ=="}], "type": "inlineReview"}]}