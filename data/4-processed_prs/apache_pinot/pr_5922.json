{"pr_number": 5922, "pr_title": "Add max qps bucket count", "pr_createdAt": "2020-08-25T22:29:25Z", "pr_url": "https://github.com/apache/pinot/pull/5922", "timeline": [{"oid": "b66b420a686ed7c61a48824ea6148ba9e3e50ea3", "url": "https://github.com/apache/pinot/commit/b66b420a686ed7c61a48824ea6148ba9e3e50ea3", "message": "Add max qps bucket count", "committedDate": "2020-08-25T21:48:34Z", "type": "commit"}, {"oid": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "url": "https://github.com/apache/pinot/commit/0569372a0269c3d9901efe6b63c1b807c8d7f111", "message": "Introduce StatefulHitCounter", "committedDate": "2020-08-27T17:07:02Z", "type": "commit"}, {"oid": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "url": "https://github.com/apache/pinot/commit/0569372a0269c3d9901efe6b63c1b807c8d7f111", "message": "Introduce StatefulHitCounter", "committedDate": "2020-08-27T17:07:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5MTkwNQ==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478591905", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private StatefulHitCounter _hitCounterInMinute;\n          \n          \n            \n              private StatefulHitCounter _maxQpsTracker;", "author": "mcvsubbu", "createdAt": "2020-08-27T17:47:16Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/QueryQuotaEntity.java", "diffHunk": "@@ -24,15 +24,17 @@\n public class QueryQuotaEntity {\n \n   private RateLimiter _rateLimiter;\n-  private HitCounter _hitCounter;\n+  private HitCounter _hitCounterInSecond;\n+  private StatefulHitCounter _hitCounterInMinute;", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5MjEyNg==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478592126", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private HitCounter _hitCounterInSecond;\n          \n          \n            \n              private HitCounter _qpsTracker;", "author": "mcvsubbu", "createdAt": "2020-08-27T17:47:43Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/QueryQuotaEntity.java", "diffHunk": "@@ -24,15 +24,17 @@\n public class QueryQuotaEntity {\n \n   private RateLimiter _rateLimiter;\n-  private HitCounter _hitCounter;\n+  private HitCounter _hitCounterInSecond;", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5NTk3Ng==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478595976", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public StatefulHitCounter(int timeRangeInSeconds, int bucketCount, int defaultQueriedTimeRangeInSeconds) {\n          \n          \n            \n              public StatefulHitCounter(int queriedTimeRangeInSeconds) {\n          \n      \n    \n    \n  \n\nDerive the other two locally. So, the timeRange we maintain could be 2*queriedTimeRangeInSeconds or even 1.5 times . the bucket count is also something that could be decided by the statefulHitCounter.", "author": "mcvsubbu", "createdAt": "2020-08-27T17:54:29Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/StatefulHitCounter.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class StatefulHitCounter extends HitCounter {\n+  private long _maxTimeRangeMs;\n+  private long _defaultQueriedTimeRangeMs;\n+  private long _lastAccessTimestamp;\n+\n+  public StatefulHitCounter(int timeRangeInSeconds, int bucketCount, int defaultQueriedTimeRangeInSeconds) {", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5NjM2Ng==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478596366", "bodyText": "Is StatefulHitCounter the right name? Should we call it maxHitRteTracker, since that is more specific?", "author": "mcvsubbu", "createdAt": "2020-08-27T17:55:11Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/StatefulHitCounter.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class StatefulHitCounter extends HitCounter {\n+  private long _maxTimeRangeMs;\n+  private long _defaultQueriedTimeRangeMs;\n+  private long _lastAccessTimestamp;\n+\n+  public StatefulHitCounter(int timeRangeInSeconds, int bucketCount, int defaultQueriedTimeRangeInSeconds) {", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY4NzIyNQ==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478687225", "bodyText": "It can be used to track the max hit rate but the class itself is stateful. Updated the class name anyway.", "author": "jackjlli", "createdAt": "2020-08-27T20:49:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5NjM2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5NzY3Mw==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478597673", "bodyText": "should be volatile", "author": "mcvsubbu", "createdAt": "2020-08-27T17:57:27Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/StatefulHitCounter.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class StatefulHitCounter extends HitCounter {\n+  private long _maxTimeRangeMs;\n+  private long _defaultQueriedTimeRangeMs;\n+  private long _lastAccessTimestamp;", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5NzcyNw==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478597727", "bodyText": "final", "author": "mcvsubbu", "createdAt": "2020-08-27T17:57:33Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/StatefulHitCounter.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class StatefulHitCounter extends HitCounter {\n+  private long _maxTimeRangeMs;", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5Nzc4MA==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478597780", "bodyText": "final", "author": "mcvsubbu", "createdAt": "2020-08-27T17:57:40Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/StatefulHitCounter.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class StatefulHitCounter extends HitCounter {\n+  private long _maxTimeRangeMs;\n+  private long _defaultQueriedTimeRangeMs;", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5Nzk3NA==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478597974", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              int getMaxCountPerBucket(long timestamp) {\n          \n          \n            \n              int getMaxCountPerBucket(long now) {\n          \n      \n    \n    \n  \n\nMore intuitive name I think", "author": "mcvsubbu", "createdAt": "2020-08-27T17:58:01Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/StatefulHitCounter.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class StatefulHitCounter extends HitCounter {\n+  private long _maxTimeRangeMs;\n+  private long _defaultQueriedTimeRangeMs;\n+  private long _lastAccessTimestamp;\n+\n+  public StatefulHitCounter(int timeRangeInSeconds, int bucketCount, int defaultQueriedTimeRangeInSeconds) {\n+    super(timeRangeInSeconds, bucketCount);\n+    _maxTimeRangeMs = timeRangeInSeconds * 1000L;\n+    _defaultQueriedTimeRangeMs = defaultQueriedTimeRangeInSeconds * 1000L;\n+  }\n+\n+  /**\n+   * Get the maximum count among the buckets\n+   */\n+  public int getMaxCountPerBucket() {\n+    return getMaxCountPerBucket(System.currentTimeMillis());\n+  }\n+\n+  @VisibleForTesting\n+  int getMaxCountPerBucket(long timestamp) {", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5OTc0NA==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478599744", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Since the start index was accessed last time, there is no need to query its bucket this time.\n          \n          \n            \n                // Since the end index was accessed last time, there is no need to query its bucket this time.\n          \n      \n    \n    \n  \n\nWe are skipping the endIndex in the loop below, right?", "author": "mcvsubbu", "createdAt": "2020-08-27T18:01:09Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/StatefulHitCounter.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class StatefulHitCounter extends HitCounter {\n+  private long _maxTimeRangeMs;\n+  private long _defaultQueriedTimeRangeMs;\n+  private long _lastAccessTimestamp;\n+\n+  public StatefulHitCounter(int timeRangeInSeconds, int bucketCount, int defaultQueriedTimeRangeInSeconds) {\n+    super(timeRangeInSeconds, bucketCount);\n+    _maxTimeRangeMs = timeRangeInSeconds * 1000L;\n+    _defaultQueriedTimeRangeMs = defaultQueriedTimeRangeInSeconds * 1000L;\n+  }\n+\n+  /**\n+   * Get the maximum count among the buckets\n+   */\n+  public int getMaxCountPerBucket() {\n+    return getMaxCountPerBucket(System.currentTimeMillis());\n+  }\n+\n+  @VisibleForTesting\n+  int getMaxCountPerBucket(long timestamp) {\n+    // If the hit counter didn't get queried for more than _maxTimeRangeMs\n+    if (timestamp - _lastAccessTimestamp > _maxTimeRangeMs) {\n+      _lastAccessTimestamp = timestamp - _defaultQueriedTimeRangeMs;\n+    }\n+    long startTimeUnits = _lastAccessTimestamp / _timeBucketWidthMs;\n+    int startIndex = (int) (startTimeUnits % _bucketCount);\n+\n+    long numTimeUnits = timestamp / _timeBucketWidthMs;\n+    int endIndex = (int) (numTimeUnits % _bucketCount);\n+\n+    int maxCount = 0;\n+    // Since the start index was accessed last time, there is no need to query its bucket this time.", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY4NzQyNQ==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478687425", "bodyText": "Updated the comments here.", "author": "jackjlli", "createdAt": "2020-08-27T20:49:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5OTc0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYwMTMzNw==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478601337", "bodyText": "MAX_QPS_SINCE_LAST_CALL or better, MAX_BURST_QPS?", "author": "mcvsubbu", "createdAt": "2020-08-27T18:04:04Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/metrics/BrokerGauge.java", "diffHunk": "@@ -27,6 +27,7 @@\n  */\n public enum BrokerGauge implements AbstractMetrics.Gauge {\n   QUERY_QUOTA_CAPACITY_UTILIZATION_RATE(\"tables\", false),\n+  MAX_QPS_IN_ONE_MINUTE(\"tables\", false),", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9f3ada50f96cb68b05501356256092647fd002d2", "url": "https://github.com/apache/pinot/commit/9f3ada50f96cb68b05501356256092647fd002d2", "message": "Address PR comments", "committedDate": "2020-08-27T20:50:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczNTgzNQ==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478735835", "bodyText": "why do we need this constructor?", "author": "mcvsubbu", "createdAt": "2020-08-27T22:44:47Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/MaxHitRateTracker.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class MaxHitRateTracker extends HitCounter {\n+  private static int ONE_SECOND_BUCKET_WIDTH_MS = 1000;\n+  private static int MAX_TIME_RANGE_FACTOR = 2;\n+\n+  private final long _maxTimeRangeMs;\n+  private final long _defaultTimeRangeMs;\n+  private volatile long _lastAccessTimestamp;\n+\n+  public MaxHitRateTracker(int timeRangeInSeconds) {\n+    this(timeRangeInSeconds, timeRangeInSeconds * MAX_TIME_RANGE_FACTOR);\n+  }\n+\n+  public MaxHitRateTracker(int defaultTimeRangeInSeconds, int maxTimeRangeInSeconds) {", "originalCommit": "9f3ada50f96cb68b05501356256092647fd002d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc0Mzc3NA==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478743774", "bodyText": "Basically it's the maxTimeRangeInSeconds that needs to be passed into the parent constructor instead of the default one. While maxTimeRangeInSeconds has to be calculated from the default one. Thus, we'd have to re-calculate the maxTimeRangeInSeconds  multiple times before we assign it to this class. Creating an extra constructor gives us the ability to reduce the duplicate calculation.", "author": "jackjlli", "createdAt": "2020-08-27T23:08:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczNTgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc1NzAyNQ==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478757025", "bodyText": "Can we make that constructor private then?", "author": "mcvsubbu", "createdAt": "2020-08-27T23:53:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczNTgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczNjYzNA==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478736634", "bodyText": "should this method be synchronized?\nI would code the method like this:\n\nGet the value of _lastAccessTimeStamp in the beginning of the method (then = _lastAccessTimeStamp)\nUse then throughout the method\nSet the _lastAccessTimestamp to now at the end of the method\n\nThat will protect us against multiple calls, if any (just in case).\nit will also prevent us from accessing the volatile variable repeatedly.", "author": "mcvsubbu", "createdAt": "2020-08-27T22:47:07Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/MaxHitRateTracker.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class MaxHitRateTracker extends HitCounter {\n+  private static int ONE_SECOND_BUCKET_WIDTH_MS = 1000;\n+  private static int MAX_TIME_RANGE_FACTOR = 2;\n+\n+  private final long _maxTimeRangeMs;\n+  private final long _defaultTimeRangeMs;\n+  private volatile long _lastAccessTimestamp;\n+\n+  public MaxHitRateTracker(int timeRangeInSeconds) {\n+    this(timeRangeInSeconds, timeRangeInSeconds * MAX_TIME_RANGE_FACTOR);\n+  }\n+\n+  public MaxHitRateTracker(int defaultTimeRangeInSeconds, int maxTimeRangeInSeconds) {\n+    super(maxTimeRangeInSeconds, (int) (maxTimeRangeInSeconds * 1000L / ONE_SECOND_BUCKET_WIDTH_MS));\n+    _defaultTimeRangeMs = defaultTimeRangeInSeconds * 1000L;\n+    _maxTimeRangeMs = maxTimeRangeInSeconds * 1000L;\n+  }\n+\n+  /**\n+   * Get the maximum count among the buckets\n+   */\n+  public int getMaxCountPerBucket() {\n+    return getMaxCountPerBucket(System.currentTimeMillis());\n+  }\n+\n+  @VisibleForTesting\n+  int getMaxCountPerBucket(long now) {", "originalCommit": "9f3ada50f96cb68b05501356256092647fd002d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc0NTAyNQ==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478745025", "bodyText": "No, it doesn't need to be synchronized.\nThe callback function will be called by 1 single thread. Thus, _lastAccessTimeStamp will also be modified by the same thread.\nThe bucket belonging to the end index won't be queried, so there is no need to add the block on it. Plus, all the buckets have already been in AtomicIntegerArray. There is no need to add extra protection", "author": "jackjlli", "createdAt": "2020-08-27T23:12:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczNjYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczNzcxMg==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478737712", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (now - _lastAccessTimestamp > _maxTimeRangeMs) {\n          \n          \n            \n                then = _lastAccessTimeStamp;\n          \n          \n            \n                if (now - then > _maxTimeRangeMs) {\n          \n          \n            \n                    then = now - _defaultTimeRangeMs;\n          \n          \n            \n                }\n          \n          \n            \n                long startTimeUnits = then / _timeBucketWidthMs;", "author": "mcvsubbu", "createdAt": "2020-08-27T22:50:21Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/MaxHitRateTracker.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class MaxHitRateTracker extends HitCounter {\n+  private static int ONE_SECOND_BUCKET_WIDTH_MS = 1000;\n+  private static int MAX_TIME_RANGE_FACTOR = 2;\n+\n+  private final long _maxTimeRangeMs;\n+  private final long _defaultTimeRangeMs;\n+  private volatile long _lastAccessTimestamp;\n+\n+  public MaxHitRateTracker(int timeRangeInSeconds) {\n+    this(timeRangeInSeconds, timeRangeInSeconds * MAX_TIME_RANGE_FACTOR);\n+  }\n+\n+  public MaxHitRateTracker(int defaultTimeRangeInSeconds, int maxTimeRangeInSeconds) {\n+    super(maxTimeRangeInSeconds, (int) (maxTimeRangeInSeconds * 1000L / ONE_SECOND_BUCKET_WIDTH_MS));\n+    _defaultTimeRangeMs = defaultTimeRangeInSeconds * 1000L;\n+    _maxTimeRangeMs = maxTimeRangeInSeconds * 1000L;\n+  }\n+\n+  /**\n+   * Get the maximum count among the buckets\n+   */\n+  public int getMaxCountPerBucket() {\n+    return getMaxCountPerBucket(System.currentTimeMillis());\n+  }\n+\n+  @VisibleForTesting\n+  int getMaxCountPerBucket(long now) {\n+    // Update the last access timestamp if the hit counter didn't get queried for more than _maxTimeRangeMs.\n+    if (now - _lastAccessTimestamp > _maxTimeRangeMs) {", "originalCommit": "9f3ada50f96cb68b05501356256092647fd002d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "30103ce52126d3a004aca3cb046d4d9118eeca06", "url": "https://github.com/apache/pinot/commit/30103ce52126d3a004aca3cb046d4d9118eeca06", "message": "Address PR comments", "committedDate": "2020-08-28T00:03:19Z", "type": "commit"}, {"oid": "30103ce52126d3a004aca3cb046d4d9118eeca06", "url": "https://github.com/apache/pinot/commit/30103ce52126d3a004aca3cb046d4d9118eeca06", "message": "Address PR comments", "committedDate": "2020-08-28T00:03:19Z", "type": "forcePushed"}]}