{"pr_number": 5132, "pr_title": "Optimize ExpressionFilterOperator", "pr_createdAt": "2020-03-10T00:35:13Z", "pr_url": "https://github.com/apache/pinot/pull/5132", "timeline": [{"oid": "16e1e55c8cb4d2ac097102daad7f86ac401be99e", "url": "https://github.com/apache/pinot/commit/16e1e55c8cb4d2ac097102daad7f86ac401be99e", "message": "Optimize ExpressionFilterOperator\n\n1. Add BYTES type and multi-value support\n2. Directly consturct DocIdSet to save the overhead of filtering\n3. Remove the redundant isMatch() for all scan based iterators\n\nAlso changed the numEntriesScannedInFilter for MV column to actual values fetched instead of values evaluated and added some TODOs for future filter optimization", "committedDate": "2020-03-10T05:16:43Z", "type": "forcePushed"}, {"oid": "7359aa3658ebe33ba7b9c81fda07723f4d95fd28", "url": "https://github.com/apache/pinot/commit/7359aa3658ebe33ba7b9c81fda07723f4d95fd28", "message": "Optimize ExpressionFilterOperator\n\n1. Add BYTES type and multi-value support\n2. Directly consturct DocIdSet to save the overhead of filtering\n3. Remove the redundant isMatch() for all scan based iterators\n\nAlso changed the numEntriesScannedInFilter for MV column to actual values fetched instead of values evaluated and added some TODOs for future filter optimization", "committedDate": "2020-03-18T22:56:29Z", "type": "forcePushed"}, {"oid": "aaa35faf69d6e14e4506b4d8b7d3ca2249584ce7", "url": "https://github.com/apache/pinot/commit/aaa35faf69d6e14e4506b4d8b7d3ca2249584ce7", "message": "Optimize ExpressionFilterOperator\n\n1. Add BYTES type and multi-value support\n2. Directly consturct DocIdSet to save the overhead of filtering\n3. Remove the redundant isMatch() for all scan based iterators\n\nAlso changed the numEntriesScannedInFilter for MV column to actual values fetched instead of values evaluated and added some TODOs for future filter optimization", "committedDate": "2020-03-30T00:04:41Z", "type": "commit"}, {"oid": "aaa35faf69d6e14e4506b4d8b7d3ca2249584ce7", "url": "https://github.com/apache/pinot/commit/aaa35faf69d6e14e4506b4d8b7d3ca2249584ce7", "message": "Optimize ExpressionFilterOperator\n\n1. Add BYTES type and multi-value support\n2. Directly consturct DocIdSet to save the overhead of filtering\n3. Remove the redundant isMatch() for all scan based iterators\n\nAlso changed the numEntriesScannedInFilter for MV column to actual values fetched instead of values evaluated and added some TODOs for future filter optimization", "committedDate": "2020-03-30T00:04:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMwNzA4Ng==", "url": "https://github.com/apache/pinot/pull/5132#discussion_r403307086", "bodyText": "this was needed rt. @fx19880617", "author": "kishoreg", "createdAt": "2020-04-03T20:25:37Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/DocIdSetOperator.java", "diffHunk": "@@ -36,30 +35,20 @@\n public class DocIdSetOperator extends BaseOperator<DocIdSetBlock> {\n   private static final String OPERATOR_NAME = \"DocIdSetOperator\";\n \n-  private static final ThreadLocal<int[]> THREAD_LOCAL_DOC_IDS = new ThreadLocal<int[]>() {\n-    @Override\n-    protected int[] initialValue() {\n-      return new int[DocIdSetPlanNode.MAX_DOC_PER_CALL];\n-    }\n-  };\n+  private static final ThreadLocal<int[]> THREAD_LOCAL_DOC_IDS =\n+      ThreadLocal.withInitial(() -> new int[DocIdSetPlanNode.MAX_DOC_PER_CALL]);\n \n   private final BaseFilterOperator _filterOperator;\n   private final int _maxSizeOfDocIdSet;\n \n   private FilterBlockDocIdSet _filterBlockDocIdSet;\n   private BlockDocIdIterator _blockDocIdIterator;\n   private int _currentDocId = 0;\n-  private boolean _threadLocal = true;\n-\n-  public DocIdSetOperator(@Nonnull BaseFilterOperator filterOperator, int maxSizeOfDocIdSet) {\n-    this(filterOperator, maxSizeOfDocIdSet, true);\n-  }\n \n-  public DocIdSetOperator(@Nonnull BaseFilterOperator filterOperator, int maxSizeOfDocIdSet, boolean threadLocal) {\n+  public DocIdSetOperator(BaseFilterOperator filterOperator, int maxSizeOfDocIdSet) {", "originalCommit": "aaa35faf69d6e14e4506b4d8b7d3ca2249584ce7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM2NTc2MA==", "url": "https://github.com/apache/pinot/pull/5132#discussion_r403365760", "bodyText": "This is good.\nThe DocIdSet creation logic is moved outside.\nSee https://github.com/apache/incubator-pinot/pull/5132/files#diff-48213157488bdb6aa43c2f6da8d2a940R131", "author": "xiangfu0", "createdAt": "2020-04-03T22:27:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMwNzA4Ng=="}], "type": "inlineReview"}]}