{"pr_number": 5823, "pr_title": "[TE] enchance anomaly api to propagate feedback", "pr_createdAt": "2020-08-06T19:33:12Z", "pr_url": "https://github.com/apache/pinot/pull/5823", "timeline": [{"oid": "86d7271542f9e0d326b0d34867ac9d510b9e5851", "url": "https://github.com/apache/pinot/commit/86d7271542f9e0d326b0d34867ac9d510b9e5851", "message": "[TE] enchance anomaly api to propagate feedback", "committedDate": "2020-08-06T19:26:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjcwNTMzMw==", "url": "https://github.com/apache/pinot/pull/5823#discussion_r466705333", "bodyText": "we may need to consider the potential merging gap between the parent and children anomaly.", "author": "jihaozh", "createdAt": "2020-08-06T21:50:21Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/datalayer/bao/jdbc/MergedAnomalyResultManagerImpl.java", "diffHunk": "@@ -456,6 +456,24 @@ public void updateAnomalyFeedback(MergedAnomalyResultDTO entity) {\n     return this.getAnomaliesForMetricBeanAndTimeRange(mbean, start, end);\n   }\n \n+  @Override\n+  public MergedAnomalyResultDTO findParent(MergedAnomalyResultDTO entity) {\n+    List<MergedAnomalyResultBean> candidates = genericPojoDao.get(Predicate.AND(\n+        Predicate.EQ(\"detectionConfigId\", entity.getDetectionConfigId()),\n+        Predicate.LE(\"startTime\", entity.getStartTime()),", "originalCommit": "86d7271542f9e0d326b0d34867ac9d510b9e5851", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4NDEyNg==", "url": "https://github.com/apache/pinot/pull/5823#discussion_r467184126", "bodyText": "Hi Vincent, is the same API used for both anomalies page, root cause page, application page and potentially alert page? Let's make sure the consistent behavior, if users update the children anomalies' feedback from any page above, it will always propagate the feedbacks to the parent anomaly?", "author": "cecilynie", "createdAt": "2020-08-07T17:49:10Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/dashboard/resources/AnomalyResource.java", "diffHunk": "@@ -156,30 +156,49 @@ public MergedAnomalyResultDTO getMergedAnomalyDetail(\n    *                        eg. payload\n    *                        <p/>\n    *                        { \"feedbackType\": \"NOT_ANOMALY\", \"comment\": \"this is not an anomaly\" }\n+   * @param propagate       : a flag whether it should propagate the same feedback value to the parent of this anomaly\n+   *                        and all its siblings if they exist\n    */\n   @POST\n   @Path(value = \"anomaly-merged-result/feedback/{anomaly_merged_result_id}\")\n   @ApiOperation(\"update anomaly merged result feedback\")\n-  public void updateAnomalyMergedResultFeedback(@PathParam(\"anomaly_merged_result_id\") long anomalyResultId,\n+  public void updateAnomalyMergedResultFeedback(\n+      @PathParam(\"anomaly_merged_result_id\") long anomalyResultId,\n+      @QueryParam(\"propagate\") @DefaultValue(\"true\") boolean propagate,", "originalCommit": "86d7271542f9e0d326b0d34867ac9d510b9e5851", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIyMDkyNg==", "url": "https://github.com/apache/pinot/pull/5823#discussion_r467220926", "bodyText": "I confirm that updating feedbacks in anomaly pages, root cause pages, application pages and alert pages will trigger this API call. I don't think there is any other page where we can update the feedback.", "author": "vincentchenjl", "createdAt": "2020-08-07T19:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4NDEyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIxNjUwNQ==", "url": "https://github.com/apache/pinot/pull/5823#discussion_r467216505", "bodyText": "Hi Vincent, just a quick question, where is the sibling anomaly updated? Thanks!", "author": "jasonyanwenl", "createdAt": "2020-08-07T18:58:47Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/dashboard/resources/AnomalyResource.java", "diffHunk": "@@ -156,30 +156,49 @@ public MergedAnomalyResultDTO getMergedAnomalyDetail(\n    *                        eg. payload\n    *                        <p/>\n    *                        { \"feedbackType\": \"NOT_ANOMALY\", \"comment\": \"this is not an anomaly\" }\n+   * @param propagate       : a flag whether it should propagate the same feedback value to the parent of this anomaly\n+   *                        and all its siblings if they exist\n    */\n   @POST\n   @Path(value = \"anomaly-merged-result/feedback/{anomaly_merged_result_id}\")\n   @ApiOperation(\"update anomaly merged result feedback\")\n-  public void updateAnomalyMergedResultFeedback(@PathParam(\"anomaly_merged_result_id\") long anomalyResultId,\n+  public void updateAnomalyMergedResultFeedback(\n+      @PathParam(\"anomaly_merged_result_id\") long anomalyResultId,\n+      @QueryParam(\"propagate\") @DefaultValue(\"true\") boolean propagate,\n       String payload) {\n     try {\n       MergedAnomalyResultDTO result = anomalyMergedResultDAO.findById(anomalyResultId);\n       if (result == null) {\n         throw new IllegalArgumentException(\"AnomalyResult not found with id \" + anomalyResultId);\n       }\n       AnomalyFeedbackDTO feedbackRequest = OBJECT_MAPPER.readValue(payload, AnomalyFeedbackDTO.class);\n-      AnomalyFeedback feedback = result.getFeedback();\n-      if (feedback == null) {\n-        feedback = new AnomalyFeedbackDTO();\n-        result.setFeedback(feedback);\n-      }\n-      feedback.setComment(feedbackRequest.getComment());\n-      if (feedbackRequest.getFeedbackType() != null){\n-        feedback.setFeedbackType(feedbackRequest.getFeedbackType());\n+      if (propagate && result.isChild()) {\n+        // propagate the feedback to its parent and siblings\n+        MergedAnomalyResultDTO parent = anomalyMergedResultDAO.findParent(result);\n+        if (parent != null) {\n+          updateAnomalyFeedback(parent, feedbackRequest);\n+        } else {\n+          LOG.warn(\"Cannot find parent for anomaly : {}, thus only updating the feedback of it\", result.getId());\n+          updateAnomalyFeedback(result, feedbackRequest);\n+        }\n+      } else {\n+        updateAnomalyFeedback(result, feedbackRequest);\n       }\n-      anomalyMergedResultDAO.updateAnomalyFeedback(result);\n     } catch (IOException e) {\n       throw new IllegalArgumentException(\"Invalid payload \" + payload, e);\n     }\n   }\n+\n+  private void updateAnomalyFeedback(MergedAnomalyResultDTO anomaly, AnomalyFeedbackDTO newFeedback) {", "originalCommit": "86d7271542f9e0d326b0d34867ac9d510b9e5851", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI3MjcyNg==", "url": "https://github.com/apache/pinot/pull/5823#discussion_r467272726", "bodyText": "anomalyMergedResultDAO.updateAnomalyFeedback(anomaly) actually updates the feedback labels of anomaly and all its child anomaly.", "author": "vincentchenjl", "createdAt": "2020-08-07T21:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIxNjUwNQ=="}], "type": "inlineReview"}]}