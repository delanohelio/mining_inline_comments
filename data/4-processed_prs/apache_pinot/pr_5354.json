{"pr_number": 5354, "pr_title": "[TE] Mock event generator for demo purposes", "pr_createdAt": "2020-05-08T20:40:05Z", "pr_url": "https://github.com/apache/pinot/pull/5354", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzMTEwNw==", "url": "https://github.com/apache/pinot/pull/5354#discussion_r423431107", "bodyText": "nit: Add license header", "author": "akshayrai", "createdAt": "2020-05-12T02:49:49Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/MockEventsLoaderConfiguration.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.apache.pinot.thirdeye.anomaly;", "originalCommit": "7ee05d198e248b1c0138aa8e9d7726ec55ef66b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ1NTA0Mw==", "url": "https://github.com/apache/pinot/pull/5354#discussion_r423455043", "bodyText": "fixed", "author": "apucher", "createdAt": "2020-05-12T04:29:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzMTEwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzMTY5Mg==", "url": "https://github.com/apache/pinot/pull/5354#discussion_r423431692", "bodyText": "might want to remove the new imports (here and below) in this class!", "author": "akshayrai", "createdAt": "2020-05-12T02:52:13Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/rootcause/impl/ThirdEyeEventsPipeline.java", "diffHunk": "@@ -19,6 +19,7 @@\n \n package org.apache.pinot.thirdeye.rootcause.impl;\n \n+import org.apache.commons.lang3.StringUtils;", "originalCommit": "7ee05d198e248b1c0138aa8e9d7726ec55ef66b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzMzU3NQ==", "url": "https://github.com/apache/pinot/pull/5354#discussion_r423433575", "bodyText": "Can you include a one-line comment for these fields?", "author": "akshayrai", "createdAt": "2020-05-12T03:00:05Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/MockEventsLoaderConfiguration.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.apache.pinot.thirdeye.anomaly;\n+\n+\n+import org.apache.pinot.thirdeye.anomaly.events.MockEventsLoader;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+public class MockEventsLoaderConfiguration {\n+    public static class EventGeneratorConfig {\n+        String type;\n+        String arrivalType = MockEventsLoader.DIST_TYPE_EXPONENTIAL;\n+        double arrivalMean;\n+        String durationType = MockEventsLoader.DIST_TYPE_FIXED;\n+        double durationMean = 86400000;\n+        int seed = 0;", "originalCommit": "7ee05d198e248b1c0138aa8e9d7726ec55ef66b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzMzcyNA==", "url": "https://github.com/apache/pinot/pull/5354#discussion_r423433724", "bodyText": "nit: license", "author": "akshayrai", "createdAt": "2020-05-12T03:00:40Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/events/MockEventsLoader.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package org.apache.pinot.thirdeye.anomaly.events;", "originalCommit": "7ee05d198e248b1c0138aa8e9d7726ec55ef66b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzNDAwOA==", "url": "https://github.com/apache/pinot/pull/5354#discussion_r423434008", "bodyText": "consider including a javadoc comment about this class", "author": "akshayrai", "createdAt": "2020-05-12T03:01:47Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/events/MockEventsLoader.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package org.apache.pinot.thirdeye.anomaly.events;\n+\n+import org.apache.commons.math3.distribution.*;\n+import org.apache.commons.math3.random.Well19937c;\n+import org.apache.pinot.thirdeye.anomaly.MockEventsLoaderConfiguration;\n+import org.apache.pinot.thirdeye.datalayer.bao.EventManager;\n+import org.apache.pinot.thirdeye.datalayer.dto.EventDTO;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.*;\n+\n+\n+public class MockEventsLoader implements Runnable {", "originalCommit": "7ee05d198e248b1c0138aa8e9d7726ec55ef66b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzNTE5OA==", "url": "https://github.com/apache/pinot/pull/5354#discussion_r423435198", "bodyText": "This is really cool! Can you include a comment about the technique in the code?", "author": "akshayrai", "createdAt": "2020-05-12T03:06:22Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/anomaly/events/MockEventsLoader.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package org.apache.pinot.thirdeye.anomaly.events;\n+\n+import org.apache.commons.math3.distribution.*;\n+import org.apache.commons.math3.random.Well19937c;\n+import org.apache.pinot.thirdeye.anomaly.MockEventsLoaderConfiguration;\n+import org.apache.pinot.thirdeye.datalayer.bao.EventManager;\n+import org.apache.pinot.thirdeye.datalayer.dto.EventDTO;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.*;\n+\n+\n+public class MockEventsLoader implements Runnable {\n+    private static final Logger LOG = LoggerFactory.getLogger(MockEventsLoader.class);\n+\n+    private static Comparator<EventDTO> MOCK_EVENT_COMPARATOR = Comparator\n+            .comparingLong(EventDTO::getStartTime)\n+            .thenComparingLong(EventDTO::getEndTime)\n+            .thenComparing(EventDTO::getEventType)\n+            .thenComparing(EventDTO::getName);\n+\n+    private static final long START_TIMESTAMP = 1546300800000L; // January 1, 2019 12:00:00 AM GMT\n+    private static final long END_OFFSET = 31536000000L; // 365d in ms\n+\n+    public static final String DIST_TYPE_GAUSSIAN = \"gaussian\";\n+    public static final String DIST_TYPE_EXPONENTIAL = \"exponential\";\n+    public static final String DIST_TYPE_LOGNORMAL = \"lognormal\";\n+    public static final String DIST_TYPE_FIXED = \"fixed\";\n+\n+    MockEventsLoaderConfiguration configuration;\n+    EventManager eventDAO;\n+\n+    public MockEventsLoader(MockEventsLoaderConfiguration configuration, EventManager eventDAO) {\n+        this.configuration = configuration;\n+        this.eventDAO = eventDAO;\n+    }\n+\n+    @Override\n+    public void run() {\n+        final long cutoff = System.currentTimeMillis() + END_OFFSET;\n+\n+        for (MockEventsLoaderConfiguration.EventGeneratorConfig conf : this.configuration.getGenerators()) {\n+            LOG.info(\"Generating '{}' events from {} to {}\", conf.getType(), START_TIMESTAMP, cutoff);\n+\n+            List<EventDTO> generated = generateEvents(conf, cutoff);\n+            List<EventDTO> existing = this.eventDAO.findEventsBetweenTimeRange(conf.getType(), START_TIMESTAMP, cutoff);\n+\n+            Set<EventDTO> deduplicated = dedup(generated, existing);\n+            LOG.info(\"Generated '{}' events: {} generated, {} pre-existing, {} saved after deduplication\",\n+                    conf.getType(), generated.size(), existing.size(), deduplicated.size());\n+\n+            deduplicated.forEach(this.eventDAO::save);\n+        }\n+    }\n+\n+    List<EventDTO> generateEvents(MockEventsLoaderConfiguration.EventGeneratorConfig conf, long cutoff) {\n+        List<EventDTO> generated = new ArrayList<>();\n+\n+        AbstractRealDistribution arrivalDist = makeDist(conf.getArrivalType(), conf.getArrivalMean(), conf.getSeed());\n+        AbstractRealDistribution durationDist = makeDist(conf.getDurationType(), conf.getDurationMean(), conf.getSeed());\n+\n+        EventGenerator generator = new EventGenerator(conf.getType(), arrivalDist, durationDist);\n+\n+        EventDTO event;\n+        while ((event = generator.next()).getStartTime() < cutoff) {\n+            generated.add(event);\n+        }\n+\n+        return generated;\n+    }\n+\n+    Set<EventDTO> dedup(Collection<EventDTO> generated, Collection<EventDTO> existing) {\n+        Set<EventDTO> sorted = new TreeSet<>(MOCK_EVENT_COMPARATOR);\n+        sorted.addAll(generated);\n+        existing.forEach(sorted::remove);\n+        return sorted;\n+    }\n+\n+    AbstractRealDistribution makeDist(String type, double param, int seed) {", "originalCommit": "7ee05d198e248b1c0138aa8e9d7726ec55ef66b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dbf0995e6dc89d874327157e8ff62abbc0131bd7", "url": "https://github.com/apache/pinot/commit/dbf0995e6dc89d874327157e8ff62abbc0131bd7", "message": "Mock event generator for demo purposes\n- pseudo-random distribution-based generator similar to mock data source\n- configuration via detector.yml\n- one-time execution at statup in backend with db-persistence and deduplication", "committedDate": "2020-05-12T03:22:42Z", "type": "commit"}, {"oid": "16a958064281d4c0152924b9e869d30415295d75", "url": "https://github.com/apache/pinot/commit/16a958064281d4c0152924b9e869d30415295d75", "message": "review fixes and name generator", "committedDate": "2020-05-12T04:28:17Z", "type": "commit"}, {"oid": "16a958064281d4c0152924b9e869d30415295d75", "url": "https://github.com/apache/pinot/commit/16a958064281d4c0152924b9e869d30415295d75", "message": "review fixes and name generator", "committedDate": "2020-05-12T04:28:17Z", "type": "forcePushed"}]}