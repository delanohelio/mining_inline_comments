{"pr_number": 5579, "pr_title": "[QueryContext] Use QueryContext in all PlanNodes", "pr_createdAt": "2020-06-16T23:52:44Z", "pr_url": "https://github.com/apache/pinot/pull/5579", "timeline": [{"oid": "56b10cef00ca7993eb439b4139d311fca7dc1ad6", "url": "https://github.com/apache/pinot/commit/56b10cef00ca7993eb439b4139d311fca7dc1ad6", "message": "[QueryContext] Use QueryContext in all PlanNodes\n\nReplace BrokerRequest with QueryContext in all PlanNodes\nThis change can save the redundant expression compilation of:\n- Group by expressions\n- Selection expreesions\n- Order by expressions\n\nExpressions in aggregation and filter will be addressed in the following PRs", "committedDate": "2020-06-17T23:04:22Z", "type": "forcePushed"}, {"oid": "abacb268688335adb0efd6dea1da562c8114d740", "url": "https://github.com/apache/pinot/commit/abacb268688335adb0efd6dea1da562c8114d740", "message": "[QueryContext] Use QueryContext in all PlanNodes\n\nReplace BrokerRequest with QueryContext in all PlanNodes\nThis change can save the redundant expression compilation of:\n- Group by expressions\n- Selection expreesions\n- Order by expressions\n\nExpressions in aggregation and filter will be addressed in the following PRs", "committedDate": "2020-06-18T05:37:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ1OTk3Mw==", "url": "https://github.com/apache/pinot/pull/5579#discussion_r442459973", "bodyText": "So, this will go away in future PRs where instead of generating FilterQueryTree per FilterPlanNode (per segment), we will just use the already built FilterContext from QueryContext?", "author": "siddharthteotia", "createdAt": "2020-06-18T19:39:47Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/plan/FilterPlanNode.java", "diffHunk": "@@ -40,22 +39,23 @@\n import org.apache.pinot.core.operator.filter.TextMatchFilterOperator;\n import org.apache.pinot.core.operator.filter.predicate.PredicateEvaluator;\n import org.apache.pinot.core.operator.filter.predicate.PredicateEvaluatorProvider;\n+import org.apache.pinot.core.query.request.context.QueryContext;\n import org.apache.pinot.core.segment.index.readers.NullValueVectorReader;\n \n \n public class FilterPlanNode implements PlanNode {\n-  private final BrokerRequest _brokerRequest;\n-  private final IndexSegment _segment;\n+  private final IndexSegment _indexSegment;\n+  private final QueryContext _queryContext;\n \n-  public FilterPlanNode(IndexSegment segment, BrokerRequest brokerRequest) {\n-    _segment = segment;\n-    _brokerRequest = brokerRequest;\n+  public FilterPlanNode(IndexSegment indexSegment, QueryContext queryContext) {\n+    _indexSegment = indexSegment;\n+    _queryContext = queryContext;\n   }\n \n   @Override\n   public BaseFilterOperator run() {\n-    FilterQueryTree rootFilterNode = RequestUtils.generateFilterQueryTree(_brokerRequest);\n-    return constructPhysicalOperator(rootFilterNode, _segment, _brokerRequest.getDebugOptions());\n+    FilterQueryTree rootFilterNode = RequestUtils.generateFilterQueryTree(_queryContext.getBrokerRequest());", "originalCommit": "abacb268688335adb0efd6dea1da562c8114d740", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU3OTEyNQ==", "url": "https://github.com/apache/pinot/pull/5579#discussion_r442579125", "bodyText": "Yes, this is removed in #5584", "author": "Jackie-Jiang", "createdAt": "2020-06-19T01:08:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ1OTk3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ2MjU4Nw==", "url": "https://github.com/apache/pinot/pull/5579#discussion_r442462587", "bodyText": "Why do we need to convert the expression in QueryContext to TransformExpressionTree? I thought we are planning to get rid of TransformExpressionTree and replace with Expression in QueryContext. Is that part of future PRs?", "author": "siddharthteotia", "createdAt": "2020-06-18T19:44:42Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/plan/AggregationGroupByOrderByPlanNode.java", "diffHunk": "@@ -48,22 +49,23 @@\n   private final TransformPlanNode _transformPlanNode;\n   private final StarTreeTransformPlanNode _starTreeTransformPlanNode;\n \n-  public AggregationGroupByOrderByPlanNode(IndexSegment indexSegment, BrokerRequest brokerRequest,\n+  public AggregationGroupByOrderByPlanNode(IndexSegment indexSegment, QueryContext queryContext,\n       int maxInitialResultHolderCapacity, int numGroupsLimit) {\n     _indexSegment = indexSegment;\n     _maxInitialResultHolderCapacity = maxInitialResultHolderCapacity;\n     _numGroupsLimit = numGroupsLimit;\n-    _aggregationFunctions = AggregationFunctionUtils.getAggregationFunctions(brokerRequest);\n-    List<String> groupByExpressions = brokerRequest.getGroupBy().getExpressions();\n+    _aggregationFunctions = AggregationFunctionUtils.getAggregationFunctions(queryContext.getBrokerRequest());\n+    List<ExpressionContext> groupByExpressions = queryContext.getGroupByExpressions();\n+    assert groupByExpressions != null;\n     int numGroupByExpressions = groupByExpressions.size();\n     _groupByExpressions = new TransformExpressionTree[numGroupByExpressions];\n     for (int i = 0; i < numGroupByExpressions; i++) {\n-      _groupByExpressions[i] = TransformExpressionTree.compileToExpressionTree(groupByExpressions.get(i));\n+      _groupByExpressions[i] = groupByExpressions.get(i).toTransformExpressionTree();", "originalCommit": "abacb268688335adb0efd6dea1da562c8114d740", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU3OTAwOQ==", "url": "https://github.com/apache/pinot/pull/5579#discussion_r442579009", "bodyText": "Yes, that is correct, and will be done in the following PRs when replacing BrokerRequest in the functions (aggregation, transform).", "author": "Jackie-Jiang", "createdAt": "2020-06-19T01:08:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ2MjU4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ2NzUwNg==", "url": "https://github.com/apache/pinot/pull/5579#discussion_r442467506", "bodyText": "I think we should add a TODO in this and related places that eventually (in the end state of this migration), this compilation to TransformExpressionTree per segment's plan node will not be needed.", "author": "siddharthteotia", "createdAt": "2020-06-18T19:54:12Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/plan/SelectionPlanNode.java", "diffHunk": "@@ -32,66 +30,65 @@\n import org.apache.pinot.core.operator.query.SelectionOnlyOperator;\n import org.apache.pinot.core.operator.query.SelectionOrderByOperator;\n import org.apache.pinot.core.operator.transform.TransformOperator;\n-import org.apache.pinot.pql.parsers.pql2.ast.IdentifierAstNode;\n+import org.apache.pinot.core.query.request.context.ExpressionContext;\n+import org.apache.pinot.core.query.request.context.OrderByExpressionContext;\n+import org.apache.pinot.core.query.request.context.QueryContext;\n+import org.apache.pinot.core.query.selection.SelectionOperatorUtils;\n \n \n /**\n  * The <code>SelectionPlanNode</code> class provides the execution plan for selection query on a single segment.\n  */\n public class SelectionPlanNode implements PlanNode {\n   private final IndexSegment _indexSegment;\n-  private final Selection _selection;\n+  private final QueryContext _queryContext;\n   private final TransformPlanNode _transformPlanNode;\n \n-  public SelectionPlanNode(IndexSegment indexSegment, BrokerRequest brokerRequest) {\n+  public SelectionPlanNode(IndexSegment indexSegment, QueryContext queryContext) {\n     _indexSegment = indexSegment;\n-    _selection = brokerRequest.getSelections();\n-    _transformPlanNode =\n-        new TransformPlanNode(_indexSegment, brokerRequest, collectExpressionsToTransform(indexSegment, brokerRequest));\n+    _queryContext = queryContext;\n+    _transformPlanNode = new TransformPlanNode(_indexSegment, queryContext, collectExpressions());\n   }\n \n   @Override\n   public Operator<IntermediateResultsBlock> run() {\n     TransformOperator transformOperator = _transformPlanNode.run();\n-    if (_selection.getSize() > 0) {\n-      if (_selection.getSelectionSortSequence() == null) {\n-        return new SelectionOnlyOperator(_indexSegment, _selection, transformOperator);\n+    Selection selection = _queryContext.getBrokerRequest().getSelections();\n+    if (_queryContext.getLimit() > 0) {\n+      if (_queryContext.getOrderByExpressions() == null) {\n+        return new SelectionOnlyOperator(_indexSegment, selection, transformOperator);\n       } else {\n-        return new SelectionOrderByOperator(_indexSegment, _selection, transformOperator);\n+        return new SelectionOrderByOperator(_indexSegment, selection, transformOperator);\n       }\n     } else {\n-      return new EmptySelectionOperator(_indexSegment, _selection, transformOperator);\n+      return new EmptySelectionOperator(_indexSegment, selection, transformOperator);\n     }\n   }\n \n-  private Set<TransformExpressionTree> collectExpressionsToTransform(IndexSegment indexSegment,\n-      BrokerRequest brokerRequest) {\n-\n-    Set<TransformExpressionTree> expressionTrees = new LinkedHashSet<>();\n-    Selection selection = brokerRequest.getSelections();\n+  private Set<TransformExpressionTree> collectExpressions() {\n+    Set<TransformExpressionTree> expressionTrees = new HashSet<>();", "originalCommit": "abacb268688335adb0efd6dea1da562c8114d740", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU4MDUyMQ==", "url": "https://github.com/apache/pinot/pull/5579#discussion_r442580521", "bodyText": "This will be cleaned up very soon, so I think the TODO is not necessary (or there will be too many TODOs added).\nBTW, the toTransformExpressionTree() does not require any compilation, so the per-segment compilation for selection is already eliminated.", "author": "Jackie-Jiang", "createdAt": "2020-06-19T01:14:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ2NzUwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ2ODQ2MA==", "url": "https://github.com/apache/pinot/pull/5579#discussion_r442468460", "bodyText": "Why do we have to check for limit to extract order by expressions?", "author": "siddharthteotia", "createdAt": "2020-06-18T19:55:58Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/plan/SelectionPlanNode.java", "diffHunk": "@@ -32,66 +30,65 @@\n import org.apache.pinot.core.operator.query.SelectionOnlyOperator;\n import org.apache.pinot.core.operator.query.SelectionOrderByOperator;\n import org.apache.pinot.core.operator.transform.TransformOperator;\n-import org.apache.pinot.pql.parsers.pql2.ast.IdentifierAstNode;\n+import org.apache.pinot.core.query.request.context.ExpressionContext;\n+import org.apache.pinot.core.query.request.context.OrderByExpressionContext;\n+import org.apache.pinot.core.query.request.context.QueryContext;\n+import org.apache.pinot.core.query.selection.SelectionOperatorUtils;\n \n \n /**\n  * The <code>SelectionPlanNode</code> class provides the execution plan for selection query on a single segment.\n  */\n public class SelectionPlanNode implements PlanNode {\n   private final IndexSegment _indexSegment;\n-  private final Selection _selection;\n+  private final QueryContext _queryContext;\n   private final TransformPlanNode _transformPlanNode;\n \n-  public SelectionPlanNode(IndexSegment indexSegment, BrokerRequest brokerRequest) {\n+  public SelectionPlanNode(IndexSegment indexSegment, QueryContext queryContext) {\n     _indexSegment = indexSegment;\n-    _selection = brokerRequest.getSelections();\n-    _transformPlanNode =\n-        new TransformPlanNode(_indexSegment, brokerRequest, collectExpressionsToTransform(indexSegment, brokerRequest));\n+    _queryContext = queryContext;\n+    _transformPlanNode = new TransformPlanNode(_indexSegment, queryContext, collectExpressions());\n   }\n \n   @Override\n   public Operator<IntermediateResultsBlock> run() {\n     TransformOperator transformOperator = _transformPlanNode.run();\n-    if (_selection.getSize() > 0) {\n-      if (_selection.getSelectionSortSequence() == null) {\n-        return new SelectionOnlyOperator(_indexSegment, _selection, transformOperator);\n+    Selection selection = _queryContext.getBrokerRequest().getSelections();\n+    if (_queryContext.getLimit() > 0) {\n+      if (_queryContext.getOrderByExpressions() == null) {\n+        return new SelectionOnlyOperator(_indexSegment, selection, transformOperator);\n       } else {\n-        return new SelectionOrderByOperator(_indexSegment, _selection, transformOperator);\n+        return new SelectionOrderByOperator(_indexSegment, selection, transformOperator);\n       }\n     } else {\n-      return new EmptySelectionOperator(_indexSegment, _selection, transformOperator);\n+      return new EmptySelectionOperator(_indexSegment, selection, transformOperator);\n     }\n   }\n \n-  private Set<TransformExpressionTree> collectExpressionsToTransform(IndexSegment indexSegment,\n-      BrokerRequest brokerRequest) {\n-\n-    Set<TransformExpressionTree> expressionTrees = new LinkedHashSet<>();\n-    Selection selection = brokerRequest.getSelections();\n+  private Set<TransformExpressionTree> collectExpressions() {\n+    Set<TransformExpressionTree> expressionTrees = new HashSet<>();\n \n     // Extract selection expressions\n-    List<String> selectionColumns = selection.getSelectionColumns();\n-    if (selectionColumns.size() == 1 && selectionColumns.get(0).equals(\"*\")) {\n-      for (String column : indexSegment.getPhysicalColumnNames()) {\n-        expressionTrees.add(new TransformExpressionTree(new IdentifierAstNode(column)));\n+    List<ExpressionContext> selectExpressions = _queryContext.getSelectExpressions();\n+    if (selectExpressions.size() == 1 && selectExpressions.get(0).equals(SelectionOperatorUtils.IDENTIFIER_STAR)) {\n+      for (String column : _indexSegment.getPhysicalColumnNames()) {\n+        expressionTrees\n+            .add(new TransformExpressionTree(TransformExpressionTree.ExpressionType.IDENTIFIER, column, null));\n       }\n     } else {\n-      for (String selectionColumn : selectionColumns) {\n-        expressionTrees.add(TransformExpressionTree.compileToExpressionTree(selectionColumn));\n+      for (ExpressionContext selectExpression : selectExpressions) {\n+        expressionTrees.add(selectExpression.toTransformExpressionTree());\n       }\n     }\n \n-    // Extract order-by expressions.\n-    if (selection.getSize() > 0) {\n-      List<SelectionSort> sortSequence = selection.getSelectionSortSequence();\n-      if (sortSequence != null) {\n-        for (SelectionSort selectionSort : sortSequence) {\n-          String orderByColumn = selectionSort.getColumn();\n-          expressionTrees.add(TransformExpressionTree.compileToExpressionTree(orderByColumn));\n-        }\n+    // Extract order-by expressions\n+    List<OrderByExpressionContext> orderByExpressions = _queryContext.getOrderByExpressions();\n+    if (_queryContext.getLimit() > 0 && orderByExpressions != null) {", "originalCommit": "abacb268688335adb0efd6dea1da562c8114d740", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU4MDk2Ng==", "url": "https://github.com/apache/pinot/pull/5579#discussion_r442580966", "bodyText": "LIMIT 0 is solved with EmptySelectionOperator where order-by expressions are not fetched. Added some notes here.", "author": "Jackie-Jiang", "createdAt": "2020-06-19T01:16:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ2ODQ2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ3MDQwNA==", "url": "https://github.com/apache/pinot/pull/5579#discussion_r442470404", "bodyText": "Do we need a unit test for this? Until now we were using a different implementation to convert to TET. Now we have this one. May be there is no need to add since long as all the end to end query execution tests pass, we are good?", "author": "siddharthteotia", "createdAt": "2020-06-18T19:59:46Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/request/context/ExpressionContext.java", "diffHunk": "@@ -85,6 +89,29 @@ public void getColumns(Set<String> columns) {\n     }\n   }\n \n+  /**\n+   * Temporary helper method to help the migration from BrokerRequest to QueryContext.\n+   */\n+  public TransformExpressionTree toTransformExpressionTree() {", "originalCommit": "abacb268688335adb0efd6dea1da562c8114d740", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU4NjMzOQ==", "url": "https://github.com/apache/pinot/pull/5579#discussion_r442586339", "bodyText": "Yes, and this is a temporary helper method which will be removed soon.", "author": "Jackie-Jiang", "createdAt": "2020-06-19T01:39:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ3MDQwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ3NjEyMA==", "url": "https://github.com/apache/pinot/pull/5579#discussion_r442476120", "bodyText": "The limit should be set to the max (1, user specified limit) or default (10) if not specified. This can be done at the parse time", "author": "siddharthteotia", "createdAt": "2020-06-18T20:11:13Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/plan/TransformPlanNode.java", "diffHunk": "@@ -79,16 +77,13 @@ private void extractProjectionColumns(TransformExpressionTree expression, Set<St\n   /**\n    * Helper method to set the max number of docs to return for selection queries\n    */\n-  private void setMaxDocsForSelection(BrokerRequest brokerRequest) {\n-    if (!brokerRequest.isSetAggregationsInfo()) {\n-      Selection selection = brokerRequest.getSelections();\n-\n-      // Update MaxDocPerNextCall\n-      if (selection.getSize() > 0) {\n-        List<SelectionSort> sortSequence = selection.getSelectionSortSequence();\n-        if (sortSequence == null) {\n-          // For selection only queries, select minimum number of documents\n-          _maxDocPerNextCall = Math.min(selection.getSize(), _maxDocPerNextCall);\n+  private void setMaxDocsForSelection(QueryContext queryContext) {\n+    if (!QueryContextUtils.isAggregationQuery(queryContext)) {\n+      // Selection queries\n+      if (queryContext.getLimit() > 0) {", "originalCommit": "abacb268688335adb0efd6dea1da562c8114d740", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU4MTI4Mg==", "url": "https://github.com/apache/pinot/pull/5579#discussion_r442581282", "bodyText": "This is already done on the broker side, and we allow queries with LIMIT 0", "author": "Jackie-Jiang", "createdAt": "2020-06-19T01:17:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ3NjEyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU4NTQ3Ng==", "url": "https://github.com/apache/pinot/pull/5579#discussion_r442585476", "bodyText": "I don't know why we have EmptySelectionOperator. The broker should return an empty response right away with just the schema for LIMIT 0. Anyway, it is not related to this PR.", "author": "siddharthteotia", "createdAt": "2020-06-19T01:35:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ3NjEyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU4NjAwNQ==", "url": "https://github.com/apache/pinot/pull/5579#discussion_r442586005", "bodyText": "The LIMIT 0 query is meant to get the schema of the table. When all table have schema and the schema is cached on broker side, we can directly return on broker side.", "author": "Jackie-Jiang", "createdAt": "2020-06-19T01:37:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ3NjEyMA=="}], "type": "inlineReview"}, {"oid": "e87e9f1bb4e0ca6d4de1bb4479f42c9c79157433", "url": "https://github.com/apache/pinot/commit/e87e9f1bb4e0ca6d4de1bb4479f42c9c79157433", "message": "[QueryContext] Use QueryContext in all PlanNodes\n\nReplace BrokerRequest with QueryContext in all PlanNodes\nThis change can save the redundant expression compilation of:\n- Group by expressions\n- Selection expreesions\n- Order by expressions\n\nExpressions in aggregation and filter will be addressed in the following PRs", "committedDate": "2020-06-19T01:20:00Z", "type": "commit"}, {"oid": "e87e9f1bb4e0ca6d4de1bb4479f42c9c79157433", "url": "https://github.com/apache/pinot/commit/e87e9f1bb4e0ca6d4de1bb4479f42c9c79157433", "message": "[QueryContext] Use QueryContext in all PlanNodes\n\nReplace BrokerRequest with QueryContext in all PlanNodes\nThis change can save the redundant expression compilation of:\n- Group by expressions\n- Selection expreesions\n- Order by expressions\n\nExpressions in aggregation and filter will be addressed in the following PRs", "committedDate": "2020-06-19T01:20:00Z", "type": "forcePushed"}]}