{"pr_number": 5966, "pr_title": "Validate timeColumnName when adding/updating schema/tableConfig", "pr_createdAt": "2020-09-03T02:49:04Z", "pr_url": "https://github.com/apache/pinot/pull/5966", "timeline": [{"oid": "8da9d62ed2132120daff023b3701f9287a1ea1a2", "url": "https://github.com/apache/pinot/commit/8da9d62ed2132120daff023b3701f9287a1ea1a2", "message": "Validate timeColumnName when adding/updating schema/tableConfig", "committedDate": "2020-09-03T00:18:14Z", "type": "commit"}, {"oid": "6607291a6cf0f58cedbc9e275003147cde055b90", "url": "https://github.com/apache/pinot/commit/6607291a6cf0f58cedbc9e275003147cde055b90", "message": "Fix test", "committedDate": "2020-09-03T20:53:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5MjMyMA==", "url": "https://github.com/apache/pinot/pull/5966#discussion_r485792320", "bodyText": "I wonder if this (along with the getTableConfigsForSchema function) can be moved inside validate ? So that the caller doesn't have to do this every single time (and can be done implicitly)", "author": "icefury71", "createdAt": "2020-09-09T17:24:49Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSchemaRestletResource.java", "diffHunk": "@@ -171,7 +173,8 @@ public SuccessResponse addSchema(\n   public String validateSchema(FormDataMultiPart multiPart) {\n     Schema schema = getSchemaFromMultiPart(multiPart);\n     try {\n-      SchemaUtils.validate(schema);\n+      List<TableConfig> tableConfigs = getTableConfigsForSchema(schema.getSchemaName());", "originalCommit": "6607291a6cf0f58cedbc9e275003147cde055b90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4ODk3Mg==", "url": "https://github.com/apache/pinot/pull/5966#discussion_r486488972", "bodyText": "i thought about that. I was just trying to avoid passing pinotHelixResourceManager to the utils methods. I can change it to that if you think that's better. I was going back and forth about it", "author": "npawar", "createdAt": "2020-09-10T16:47:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5MjMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5NzQ3MQ==", "url": "https://github.com/apache/pinot/pull/5966#discussion_r486497471", "bodyText": "Actually, as I tried to do this, I realized that PinotHelixResourceManager is in pinot-controller, and the utils (which are in pinot-core) do not have access to it. We'd have to pass propertyStore, or change the design of SchemaUtils so we can inject and keep state.\nNow I think it's better that the caller fetches what it needs. Practically,  PinotTableRestletResource and PinotSchemaRestletResource should be the only places adding/modifying table/schema.", "author": "npawar", "createdAt": "2020-09-10T17:01:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5MjMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUxMjQyMA==", "url": "https://github.com/apache/pinot/pull/5966#discussion_r486512420", "bodyText": "Understood. Thanks for looking into this.", "author": "icefury71", "createdAt": "2020-09-10T17:26:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5MjMyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5MzIzMw==", "url": "https://github.com/apache/pinot/pull/5966#discussion_r485793233", "bodyText": "Same here", "author": "icefury71", "createdAt": "2020-09-09T17:26:20Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotTableIndexingConfigs.java", "diffHunk": "@@ -58,7 +59,8 @@ public SuccessResponse updateIndexingConfig(\n     TableConfig tableConfig;\n     try {\n       tableConfig = JsonUtils.stringToObject(tableConfigString, TableConfig.class);\n-      TableConfigUtils.validate(tableConfig);\n+      Schema schema = pinotHelixResourceManager.getSchemaForTableConfig(tableConfig);", "originalCommit": "6607291a6cf0f58cedbc9e275003147cde055b90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5NjMyMg==", "url": "https://github.com/apache/pinot/pull/5966#discussion_r485796322", "bodyText": "Curious - how is this related to time column field validation ?", "author": "icefury71", "createdAt": "2020-09-09T17:31:25Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "diffHunk": "@@ -74,19 +80,37 @@ public static void validateTableName(TableConfig tableConfig) {\n     }\n   }\n \n-  private static void validateValidationConfig(TableConfig tableConfig) {\n+  /**\n+   * Validates the following in the validationConfig of the table\n+   * 1. For REALTIME table\n+   * - checks for non-null timeColumnName\n+   * - checks for valid field spec for timeColumnName in schema\n+   *\n+   * 2. For OFFLINE table\n+   * - checks for valid field spec for timeColumnName in schema, if timeColumnName and schema re non-null\n+   *\n+   * 3. Checks peerDownloadSchema\n+   */\n+  private static void validateValidationConfig(TableConfig tableConfig, @Nullable Schema schema) {\n     SegmentsValidationAndRetentionConfig validationConfig = tableConfig.getValidationConfig();\n-    if (validationConfig != null) {\n-      if (tableConfig.getTableType() == TableType.REALTIME && validationConfig.getTimeColumnName() == null) {\n-        throw new IllegalStateException(\"Must provide time column in real-time table config\");\n-      }\n-      String peerSegmentDownloadScheme = validationConfig.getPeerSegmentDownloadScheme();\n-      if (peerSegmentDownloadScheme != null) {\n-        if (!CommonConstants.HTTP_PROTOCOL.equalsIgnoreCase(peerSegmentDownloadScheme)\n-            && !CommonConstants.HTTPS_PROTOCOL.equalsIgnoreCase(peerSegmentDownloadScheme)) {\n-          throw new IllegalStateException(\"Invalid value '\" + peerSegmentDownloadScheme\n-              + \"' for peerSegmentDownloadScheme. Must be one of http nor https\");\n-        }\n+    String timeColumnName = validationConfig.getTimeColumnName();\n+    if (tableConfig.getTableType() == TableType.REALTIME) {\n+      // For REALTIME table, must have a non-null timeColumnName\n+      Preconditions.checkState(timeColumnName != null, \"'timeColumnName' cannot be null in REALTIME table config\");\n+    }\n+    // timeColumnName can be null in OFFLINE table\n+    if (timeColumnName != null && schema != null) {\n+      Preconditions.checkState(schema.getSpecForTimeColumn(timeColumnName) != null,\n+          \"Cannot find valid fieldSpec for timeColumn: %s from the table config, in the schema: %s\", timeColumnName,\n+          schema.getSchemaName());\n+    }\n+\n+    String peerSegmentDownloadScheme = validationConfig.getPeerSegmentDownloadScheme();\n+    if (peerSegmentDownloadScheme != null) {\n+      if (!CommonConstants.HTTP_PROTOCOL.equalsIgnoreCase(peerSegmentDownloadScheme) && !CommonConstants.HTTPS_PROTOCOL", "originalCommit": "6607291a6cf0f58cedbc9e275003147cde055b90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4MDY5Nw==", "url": "https://github.com/apache/pinot/pull/5966#discussion_r486480697", "bodyText": "This part was already present in the validateValidationConfig method (line 84 in the before diff)", "author": "npawar", "createdAt": "2020-09-10T16:34:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5NjMyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5OTg5Mg==", "url": "https://github.com/apache/pinot/pull/5966#discussion_r485799892", "bodyText": "nit: wrap with try-catch for future proofing ?", "author": "icefury71", "createdAt": "2020-09-09T17:38:00Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/util/SchemaUtilsTest.java", "diffHunk": "@@ -35,6 +43,115 @@\n  */\n public class SchemaUtilsTest {\n \n+  private static final String TABLE_NAME = \"testTable\";\n+  private static final String TIME_COLUMN = \"timeColumn\";\n+\n+  @Test\n+  public void testCompatibilityWithTableConfig() {\n+    // empty list\n+    List<TableConfig> tableConfigs = new ArrayList<>();\n+    Schema schema = new Schema.SchemaBuilder().setSchemaName(TABLE_NAME).build();\n+    SchemaUtils.validate(schema, tableConfigs);", "originalCommit": "6607291a6cf0f58cedbc9e275003147cde055b90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4NDM2NQ==", "url": "https://github.com/apache/pinot/pull/5966#discussion_r486484365", "bodyText": "do you mean a case where the schema becomes invalid, but we pass the test anyway because of not having a try-catch?\nJust to be sure, I tried this out. The test fails if there's any exception in the should-pass cases.\nLmk if you were referring to something else.", "author": "npawar", "createdAt": "2020-09-10T16:39:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5OTg5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU4ODAzNQ==", "url": "https://github.com/apache/pinot/pull/5966#discussion_r486588035", "bodyText": "I meant catching exception and explicitly 'fail'ing. It's fine though - just a nit.", "author": "icefury71", "createdAt": "2020-09-10T19:36:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5OTg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgwMDA0NA==", "url": "https://github.com/apache/pinot/pull/5966#discussion_r485800044", "bodyText": "Same here", "author": "icefury71", "createdAt": "2020-09-09T17:38:17Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/util/SchemaUtilsTest.java", "diffHunk": "@@ -35,6 +43,115 @@\n  */\n public class SchemaUtilsTest {\n \n+  private static final String TABLE_NAME = \"testTable\";\n+  private static final String TIME_COLUMN = \"timeColumn\";\n+\n+  @Test\n+  public void testCompatibilityWithTableConfig() {\n+    // empty list\n+    List<TableConfig> tableConfigs = new ArrayList<>();\n+    Schema schema = new Schema.SchemaBuilder().setSchemaName(TABLE_NAME).build();\n+    SchemaUtils.validate(schema, tableConfigs);\n+\n+    // offline table\n+    // null timeColumnName\n+    TableConfig tableConfig = new TableConfigBuilder(TableType.OFFLINE).setTableName(TABLE_NAME).build();\n+    SchemaUtils.validate(schema, Lists.newArrayList(tableConfig));", "originalCommit": "6607291a6cf0f58cedbc9e275003147cde055b90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU2MjEyMQ==", "url": "https://github.com/apache/pinot/pull/5966#discussion_r486562121", "bodyText": "schemaName should never be null", "author": "Jackie-Jiang", "createdAt": "2020-09-10T18:47:18Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSchemaRestletResource.java", "diffHunk": "@@ -318,4 +324,19 @@ private void deleteSchemaInternal(String schemaName) {\n           Response.Status.INTERNAL_SERVER_ERROR);\n     }\n   }\n+\n+  private List<TableConfig> getTableConfigsForSchema(@Nullable String schemaName) {", "originalCommit": "6607291a6cf0f58cedbc9e275003147cde055b90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU2Mzg3NQ==", "url": "https://github.com/apache/pinot/pull/5966#discussion_r486563875", "bodyText": "Wondering if we can move this method into PinotHelixResourceManager?", "author": "Jackie-Jiang", "createdAt": "2020-09-10T18:50:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU2MjEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYwMTQ1MA==", "url": "https://github.com/apache/pinot/pull/5966#discussion_r486601450", "bodyText": "yes, done", "author": "npawar", "createdAt": "2020-09-10T20:03:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU2MjEyMQ=="}], "type": "inlineReview"}, {"oid": "c3ea255b66641f31b2e2f1c642c1fe442c14ee58", "url": "https://github.com/apache/pinot/commit/c3ea255b66641f31b2e2f1c642c1fe442c14ee58", "message": "Move getTableConfigsForSchema into pinotHelixResourceManager", "committedDate": "2020-09-10T20:02:09Z", "type": "commit"}]}