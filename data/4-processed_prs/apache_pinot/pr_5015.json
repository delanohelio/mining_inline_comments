{"pr_number": 5015, "pr_title": "Enhance TableRebalancer to support reassigning COMPLETED segments when instances changed", "pr_createdAt": "2020-01-24T19:15:49Z", "pr_url": "https://github.com/apache/pinot/pull/5015", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM4MjQyMA==", "url": "https://github.com/apache/pinot/pull/5015#discussion_r371382420", "bodyText": "May be add a debug log saying the relocation is NO-OP?", "author": "siddharthteotia", "createdAt": "2020-01-27T17:36:57Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/relocation/RealtimeSegmentRelocator.java", "diffHunk": "@@ -72,40 +69,33 @@ protected void processTable(String tableNameWithType) {\n         .hasHighLevelConsumerType()) {\n       return;\n     }\n+    if (!InstanceAssignmentConfigUtils.shouldRelocateCompletedSegments(tableConfig)) {", "originalCommit": "63151ebd07e7fa694ca82c270f64bcfe33d693f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQxNjQxMw==", "url": "https://github.com/apache/pinot/pull/5015#discussion_r371416413", "bodyText": "Added", "author": "Jackie-Jiang", "createdAt": "2020-01-27T18:47:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM4MjQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM4NTUxNA==", "url": "https://github.com/apache/pinot/pull/5015#discussion_r371385514", "bodyText": "Maybe it is time we switch back to mandating a znode for realtime tables as well? Otherwise the checks for instance partitions being present is sprinkled everywhere?", "author": "mcvsubbu", "createdAt": "2020-01-27T17:43:04Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/config/instance/InstanceAssignmentConfigUtils.java", "diffHunk": "@@ -34,7 +34,21 @@ private InstanceAssignmentConfigUtils() {\n   }\n \n   /**\n-   * Returns whether the instance assignment is allowed for the given table config.\n+   * Returns whether the COMPLETED segments should be relocated (offloaded from CONSUMING instances to COMPLETED\n+   * instances) for a LLC real-time table based on the given table config.\n+   * <p>COMPLETED segments should be relocated iff the COMPLETED instance assignment is configured or (for\n+   * backward-compatibility) COMPLETED server tag is overridden to be different from the CONSUMING server tag.\n+   */\n+  public static boolean shouldRelocateCompletedSegments(TableConfig tableConfig) {\n+    Map<InstancePartitionsType, InstanceAssignmentConfig> instanceAssignmentConfigMap =\n+        tableConfig.getInstanceAssignmentConfigMap();\n+    return (instanceAssignmentConfigMap != null", "originalCommit": "63151ebd07e7fa694ca82c270f64bcfe33d693f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQxMzc3Mg==", "url": "https://github.com/apache/pinot/pull/5015#discussion_r371413772", "bodyText": "Once we migrate to the new instance assignment model, we will have a instance partitions znode for every table. Right now it is for backward-compatibility to check this.", "author": "Jackie-Jiang", "createdAt": "2020-01-27T18:42:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM4NTUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM5MzEzMw==", "url": "https://github.com/apache/pinot/pull/5015#discussion_r371393133", "bodyText": "This statement is a bit confusing. Why should it be that there is only one partition for consuming stance partitions? Can you add some comments here? The InstancePartition class says in comments that a \"partition\" means either field partition for offline or stream partition for realtime.", "author": "mcvsubbu", "createdAt": "2020-01-27T17:58:39Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/RealtimeSegmentAssignment.java", "diffHunk": "@@ -143,62 +156,81 @@ public void init(HelixManager helixManager, TableConfig tableConfig) {\n   @Override\n   public Map<String, Map<String, String>> rebalanceTable(Map<String, Map<String, String>> currentAssignment,\n       Map<InstancePartitionsType, InstancePartitions> instancePartitionsMap, Configuration config) {\n+    InstancePartitions completedInstancePartitions = instancePartitionsMap.get(InstancePartitionsType.COMPLETED);\n+    InstancePartitions consumingInstancePartitions = instancePartitionsMap.get(InstancePartitionsType.CONSUMING);\n+    Preconditions.checkState(consumingInstancePartitions != null,\n+        \"Failed to find COMPLETED or CONSUMING instance partitions for table: %s\", _realtimeTableName);\n+    Preconditions.checkState(consumingInstancePartitions.getNumPartitions() == 1,", "originalCommit": "63151ebd07e7fa694ca82c270f64bcfe33d693f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQzMjY2Mg==", "url": "https://github.com/apache/pinot/pull/5015#discussion_r371432662", "bodyText": "Good point. Added comments in the InstancePartitions", "author": "Jackie-Jiang", "createdAt": "2020-01-27T19:20:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM5MzEzMw=="}], "type": "inlineReview"}, {"oid": "89194cb2394c859db5f852dc4f21995785b4ec6e", "url": "https://github.com/apache/pinot/commit/89194cb2394c859db5f852dc4f21995785b4ec6e", "message": "Enhance TableRebalancer to support reassigning COMPLETED segments when instances changed\n\nMotivation:\nCurrently when we change the instances for a LLC realtime table,\nthere is no way to reassign COMPLETED segments to align with the\npartitions of the CONSUMING segments. This feature is especially\nimportant when partition-aware routing is enabled for the table.\nRight now we manually calculate the assignment and replace it in\nZK, which is both troublesome and risky, and we cannot leverage\nthe no-downtime rebalance.\n\nChange:\nWhen COMPLETED instance partitions are not provided (do not\nrelocate COMPLETED segments), reassign COMPLETED segments the same\nway as CONSUMING segments so that partitions can be aligned.\nEnhance TableRebalancer to support aligning the partitions for\nCOMPLETED segments without downtime.", "committedDate": "2020-01-27T19:49:19Z", "type": "commit"}, {"oid": "89194cb2394c859db5f852dc4f21995785b4ec6e", "url": "https://github.com/apache/pinot/commit/89194cb2394c859db5f852dc4f21995785b4ec6e", "message": "Enhance TableRebalancer to support reassigning COMPLETED segments when instances changed\n\nMotivation:\nCurrently when we change the instances for a LLC realtime table,\nthere is no way to reassign COMPLETED segments to align with the\npartitions of the CONSUMING segments. This feature is especially\nimportant when partition-aware routing is enabled for the table.\nRight now we manually calculate the assignment and replace it in\nZK, which is both troublesome and risky, and we cannot leverage\nthe no-downtime rebalance.\n\nChange:\nWhen COMPLETED instance partitions are not provided (do not\nrelocate COMPLETED segments), reassign COMPLETED segments the same\nway as CONSUMING segments so that partitions can be aligned.\nEnhance TableRebalancer to support aligning the partitions for\nCOMPLETED segments without downtime.", "committedDate": "2020-01-27T19:49:19Z", "type": "forcePushed"}]}