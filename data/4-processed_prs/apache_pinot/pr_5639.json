{"pr_number": 5639, "pr_title": "Refactor how Pinot controller stores segment download url in Zookeeper to deal with peer uri format", "pr_createdAt": "2020-06-30T06:59:44Z", "pr_url": "https://github.com/apache/pinot/pull/5639", "timeline": [{"oid": "90f441826bdcaf40ba6543b2fee7e03ff1540973", "url": "https://github.com/apache/pinot/commit/90f441826bdcaf40ba6543b2fee7e03ff1540973", "message": "Initial commit for controller side change.", "committedDate": "2020-06-27T00:20:38Z", "type": "commit"}, {"oid": "2a45fcd4312578caeeef224e284e2cdd0ea86c3a", "url": "https://github.com/apache/pinot/commit/2a45fcd4312578caeeef224e284e2cdd0ea86c3a", "message": "Revised based on email discussion and add more tests.", "committedDate": "2020-06-30T06:44:56Z", "type": "commit"}, {"oid": "041758b8b39c82bfd3d1618fec1b13418e4fda84", "url": "https://github.com/apache/pinot/commit/041758b8b39c82bfd3d1618fec1b13418e4fda84", "message": "Fix integration tests by adding segment location to descriptor.", "committedDate": "2020-06-30T22:24:44Z", "type": "commit"}, {"oid": "a6366a0087fd68c943d67b8fde2eba01e27b3b75", "url": "https://github.com/apache/pinot/commit/a6366a0087fd68c943d67b8fde2eba01e27b3b75", "message": "Add handling of controller vip based segment download url. Add more tests.", "committedDate": "2020-07-01T06:48:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUzNjc0Mw==", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448536743", "bodyText": "we dont need to check the peer download scheme here, since we check and put the right value while committing metadata in PinotLLCRealtimeSegmentManager. We can always set the segment location. The if condition can be as before", "author": "mcvsubbu", "createdAt": "2020-07-01T18:14:56Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/SegmentCompletionManager.java", "diffHunk": "@@ -1068,16 +1069,28 @@ private int numReplicasToLookFor() {\n       _state = State.COMMITTING;\n       // In case of splitCommit, the segment is uploaded to a unique file name indicated by segmentLocation,\n       // so we need to move the segment file to its permanent location first before committing the metadata.\n-      if (isSplitCommit) {\n+      // The committingSegmentDescriptor is then updated with the permanent segment location to be saved in metadata\n+      // store.\n+      // The exception is when the server uses the Peer segment download scheme, in such case, there is no need to\n+      // move the segment.\n+      if (isSplitCommit && !isPeerSegmentDownloadScheme(committingSegmentDescriptor)) {", "originalCommit": "a6366a0087fd68c943d67b8fde2eba01e27b3b75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwMTA4OA==", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448601088", "bodyText": "got it. thank.  good idea.", "author": "chenboat", "createdAt": "2020-07-01T20:32:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUzNjc0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUzOTUyOQ==", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448539529", "bodyText": "check the descriptor for peer  scheme in this method, and move only if it is not peer scheme. leave the descriptor.location as is if it is peer scheme. If not, update the location with the final location in this method. You can still return void.", "author": "mcvsubbu", "createdAt": "2020-07-01T18:20:42Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java", "diffHunk": "@@ -355,8 +355,9 @@ void setIdealState(String realtimeTableName, IdealState idealState) {\n    * This method moves the segment file from another location to its permanent location.\n    * When splitCommit is enabled, segment file is uploaded to the segmentLocation in the committingSegmentDescriptor,\n    * and we need to move the segment file to its permanent location before committing the segment metadata.\n+   * Return the permanent location of the segment if the commit succeeds.\n    */\n-  public void commitSegmentFile(String realtimeTableName, CommittingSegmentDescriptor committingSegmentDescriptor)\n+  public String commitSegmentFile(String realtimeTableName, CommittingSegmentDescriptor committingSegmentDescriptor)", "originalCommit": "a6366a0087fd68c943d67b8fde2eba01e27b3b75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwMDk0NA==", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448600944", "bodyText": "done. thanks.", "author": "chenboat", "createdAt": "2020-07-01T20:32:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUzOTUyOQ=="}], "type": "inlineReview"}, {"oid": "cad2b84a6ee7e2882f4dca1cf4e7c1ef6617867b", "url": "https://github.com/apache/pinot/commit/cad2b84a6ee7e2882f4dca1cf4e7c1ef6617867b", "message": "Revise based on comments.", "committedDate": "2020-07-01T19:37:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2MDA0OQ==", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448660049", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Updated the segment location to the uri which the segment is moved to.\n          \n          \n            \n               * Modifies the segment location in committingSegmentDescriptor to the uri which the segment is moved to", "author": "mcvsubbu", "createdAt": "2020-07-01T23:04:54Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java", "diffHunk": "@@ -355,10 +355,17 @@ void setIdealState(String realtimeTableName, IdealState idealState) {\n    * This method moves the segment file from another location to its permanent location.\n    * When splitCommit is enabled, segment file is uploaded to the segmentLocation in the committingSegmentDescriptor,\n    * and we need to move the segment file to its permanent location before committing the segment metadata.\n+   * Updated the segment location to the uri which the segment is moved to.", "originalCommit": "cad2b84a6ee7e2882f4dca1cf4e7c1ef6617867b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2MDI2Nw==", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448660267", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Exception: for committingSegmentDescriptor with peer download scheme in its segment location, there is no need for\n          \n          \n            \n               * unless committingSegmentDescriptor has a peer download uri scheme in segment location.", "author": "mcvsubbu", "createdAt": "2020-07-01T23:05:36Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java", "diffHunk": "@@ -355,10 +355,17 @@ void setIdealState(String realtimeTableName, IdealState idealState) {\n    * This method moves the segment file from another location to its permanent location.\n    * When splitCommit is enabled, segment file is uploaded to the segmentLocation in the committingSegmentDescriptor,\n    * and we need to move the segment file to its permanent location before committing the segment metadata.\n+   * Updated the segment location to the uri which the segment is moved to.\n+   * Exception: for committingSegmentDescriptor with peer download scheme in its segment location, there is no need for", "originalCommit": "cad2b84a6ee7e2882f4dca1cf4e7c1ef6617867b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2MDMxOQ==", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448660319", "bodyText": "delete this line", "author": "mcvsubbu", "createdAt": "2020-07-01T23:05:46Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java", "diffHunk": "@@ -355,10 +355,17 @@ void setIdealState(String realtimeTableName, IdealState idealState) {\n    * This method moves the segment file from another location to its permanent location.\n    * When splitCommit is enabled, segment file is uploaded to the segmentLocation in the committingSegmentDescriptor,\n    * and we need to move the segment file to its permanent location before committing the segment metadata.\n+   * Updated the segment location to the uri which the segment is moved to.\n+   * Exception: for committingSegmentDescriptor with peer download scheme in its segment location, there is no need for\n+   * moving.", "originalCommit": "cad2b84a6ee7e2882f4dca1cf4e7c1ef6617867b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODczNjI3NA==", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448736274", "bodyText": "DONE.", "author": "chenboat", "createdAt": "2020-07-02T04:05:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2MDMxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2MTc5Ng==", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448661796", "bodyText": "Can we define \"\"  as public static string METADATA_URI_FOR_PEER_DOWNLOAD in CommonConstants.Segment and reference the same thing in the server as well, to detect peer download? Once we decide it is going to be \"\" all components need to use the same thing, so might as well make a common definition. A change to this will need to be done keeping backward compat in mind, if at all someone wants to change it.\nthanks", "author": "mcvsubbu", "createdAt": "2020-07-01T23:10:52Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java", "diffHunk": "@@ -485,9 +498,10 @@ private LLCRealtimeSegmentZKMetadata updateCommittingSegmentZKMetadata(String re\n     // TODO Issue 5953 remove the long parsing once metadata is set correctly.\n     committingSegmentZKMetadata.setEndOffset(committingSegmentDescriptor.getNextOffset());\n     committingSegmentZKMetadata.setStatus(Status.DONE);\n-    committingSegmentZKMetadata.setDownloadUrl(URIUtils\n-        .constructDownloadUrl(_controllerConf.generateVipUrl(), TableNameBuilder.extractRawTableName(realtimeTableName),\n-            segmentName));\n+    // If the download url set by the server is a peer download url format with peer scheme, put an empty string in zk\n+    // otherwise just use the location in the descriptor.\n+    committingSegmentZKMetadata.setDownloadUrl(isPeerURL(committingSegmentDescriptor.getSegmentLocation()) ? \"\"", "originalCommit": "cad2b84a6ee7e2882f4dca1cf4e7c1ef6617867b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODczODA5Ng==", "url": "https://github.com/apache/pinot/pull/5639#discussion_r448738096", "bodyText": "done. Thanks.", "author": "chenboat", "createdAt": "2020-07-02T04:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2MTc5Ng=="}], "type": "inlineReview"}, {"oid": "83adcc9b1c75e117105ccb805591e12dcb3899e0", "url": "https://github.com/apache/pinot/commit/83adcc9b1c75e117105ccb805591e12dcb3899e0", "message": "Update pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java\n\nCo-authored-by: Subbu Subramaniam <mcvsubbu@users.noreply.github.com>", "committedDate": "2020-07-02T04:01:50Z", "type": "commit"}, {"oid": "ba7e9f9c8ebf78d8e86a9a2daf0cd006f21175b8", "url": "https://github.com/apache/pinot/commit/ba7e9f9c8ebf78d8e86a9a2daf0cd006f21175b8", "message": "Update pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/realtime/PinotLLCRealtimeSegmentManager.java\n\nCo-authored-by: Subbu Subramaniam <mcvsubbu@users.noreply.github.com>", "committedDate": "2020-07-02T04:02:06Z", "type": "commit"}, {"oid": "a5886b42d8b5a27208de227671726c7a54b3ff50", "url": "https://github.com/apache/pinot/commit/a5886b42d8b5a27208de227671726c7a54b3ff50", "message": "Minor revising based on comments.", "committedDate": "2020-07-02T04:12:02Z", "type": "commit"}]}