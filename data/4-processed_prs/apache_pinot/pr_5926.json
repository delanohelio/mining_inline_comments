{"pr_number": 5926, "pr_title": "Introduce IdSet and add IdSetAggregationFunction", "pr_createdAt": "2020-08-26T04:53:47Z", "pr_url": "https://github.com/apache/pinot/pull/5926", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAzNjUwNQ==", "url": "https://github.com/apache/pinot/pull/5926#discussion_r477036505", "bodyText": "Do you think this constructor is the only thing we need? If not, We should make this private and add static builders", "author": "kishoreg", "createdAt": "2020-08-26T05:06:52Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/utils/IdSet.java", "diffHunk": "@@ -0,0 +1,326 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.utils;\n+\n+import com.google.common.base.Preconditions;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.DataInputStream;\n+import java.io.DataOutputStream;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Base64;\n+import java.util.Objects;\n+import javax.annotation.Nullable;\n+import org.apache.pinot.spi.data.FieldSpec.DataType;\n+import org.roaringbitmap.RoaringBitmap;\n+import org.roaringbitmap.longlong.Roaring64NavigableMap;\n+\n+\n+/**\n+ * The {@code IdSet} represents a collection of ids. It can be used to optimize the query with huge IN clause.\n+ */\n+public class IdSet implements Comparable<IdSet> {\n+  public static final IdSet EMPTY_ID_SET = new IdSet(Type.EMPTY, null, null);\n+\n+  // Throw exception when the serialized IdSet is exceeding this threshold (32MB)\n+  private static final int MAX_SIZE_IN_BYTES = 32 * 1024 * 1024;\n+\n+  private enum Type {\n+    // DO NOT change the index of the types as the ser/de relies on them\n+    EMPTY(0), ROARING_BITMAP(1), ROARING_64_NAVIGABLE_MAP(2);\n+\n+    private final int _index;\n+\n+    Type(int index) {\n+      _index = index;\n+    }\n+  }\n+\n+  private final Type _type;\n+  private final RoaringBitmap _bitmap;\n+  private final Roaring64NavigableMap _longBitmap;\n+", "originalCommit": "de6eee3535d9aac026f3cd3f64465c68bac740a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAzNzg0OQ==", "url": "https://github.com/apache/pinot/pull/5926#discussion_r477037849", "bodyText": "Let\u2019s make this an interface with multiple implementations?", "author": "kishoreg", "createdAt": "2020-08-26T05:11:58Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/utils/IdSet.java", "diffHunk": "@@ -0,0 +1,326 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.utils;\n+\n+import com.google.common.base.Preconditions;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.DataInputStream;\n+import java.io.DataOutputStream;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.Base64;\n+import java.util.Objects;\n+import javax.annotation.Nullable;\n+import org.apache.pinot.spi.data.FieldSpec.DataType;\n+import org.roaringbitmap.RoaringBitmap;\n+import org.roaringbitmap.longlong.Roaring64NavigableMap;\n+\n+\n+/**\n+ * The {@code IdSet} represents a collection of ids. It can be used to optimize the query with huge IN clause.\n+ */\n+public class IdSet implements Comparable<IdSet> {", "originalCommit": "de6eee3535d9aac026f3cd3f64465c68bac740a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "456de3419a4d24e73887c47c7a918a42fce3ade5", "url": "https://github.com/apache/pinot/commit/456de3419a4d24e73887c47c7a918a42fce3ade5", "message": "Add IdSet and IdSetAggregationFunction", "committedDate": "2020-08-28T02:32:05Z", "type": "forcePushed"}, {"oid": "fab464fcfa250f92bee4e897c62b69976a5bc0db", "url": "https://github.com/apache/pinot/commit/fab464fcfa250f92bee4e897c62b69976a5bc0db", "message": "Add IdSet and IdSetAggregationFunction", "committedDate": "2020-08-28T02:39:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgzNjkzNw==", "url": "https://github.com/apache/pinot/pull/5926#discussion_r478836937", "bodyText": "add a sample call", "author": "kishoreg", "createdAt": "2020-08-28T05:24:36Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/IdSetAggregationFunction.java", "diffHunk": "@@ -0,0 +1,339 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.aggregation.function;\n+\n+import com.google.common.base.Preconditions;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.pinot.common.function.AggregationFunctionType;\n+import org.apache.pinot.common.utils.DataSchema.ColumnDataType;\n+import org.apache.pinot.core.common.BlockValSet;\n+import org.apache.pinot.core.query.aggregation.AggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.ObjectAggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.GroupByResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.ObjectGroupByResultHolder;\n+import org.apache.pinot.core.query.request.context.ExpressionContext;\n+import org.apache.pinot.core.query.utils.idset.IdSet;\n+import org.apache.pinot.core.query.utils.idset.IdSets;\n+import org.apache.pinot.spi.data.FieldSpec.DataType;\n+\n+\n+/**\n+ * The {@code IdSetAggregationFunction} collects the values for a given single-value expression into an IdSet, which can\n+ * be used in the second query to optimize the query with huge IN clause generated from another query.\n+ */\n+public class IdSetAggregationFunction extends BaseSingleInputAggregationFunction<IdSet, String> {\n+  public static final char PARAMETER_DELIMITER = ';';\n+  public static final char PARAMETER_KEY_VALUE_SEPARATOR = '=';\n+  public static final String SIZE_THRESHOLD_IN_BYTES_KEY = \"SIZETHRESHOLDINBYTES\";\n+  public static final String EXPECTED_INSERTIONS_KEY = \"EXPECTEDINSERTIONS\";\n+  public static final String FPP_KEY = \"FPP\";\n+\n+  private final int _sizeThresholdInBytes;\n+  private final int _expectedInsertions;\n+  private final double _fpp;\n+\n+  /**", "originalCommit": "fab464fcfa250f92bee4e897c62b69976a5bc0db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ1NzI2Ng==", "url": "https://github.com/apache/pinot/pull/5926#discussion_r479457266", "bodyText": "Added", "author": "Jackie-Jiang", "createdAt": "2020-08-28T18:01:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgzNjkzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgzNzMxMg==", "url": "https://github.com/apache/pinot/pull/5926#discussion_r478837312", "bodyText": "what are these? java docs", "author": "kishoreg", "createdAt": "2020-08-28T05:25:59Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/IdSetAggregationFunction.java", "diffHunk": "@@ -0,0 +1,339 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.query.aggregation.function;\n+\n+import com.google.common.base.Preconditions;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.pinot.common.function.AggregationFunctionType;\n+import org.apache.pinot.common.utils.DataSchema.ColumnDataType;\n+import org.apache.pinot.core.common.BlockValSet;\n+import org.apache.pinot.core.query.aggregation.AggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.ObjectAggregationResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.GroupByResultHolder;\n+import org.apache.pinot.core.query.aggregation.groupby.ObjectGroupByResultHolder;\n+import org.apache.pinot.core.query.request.context.ExpressionContext;\n+import org.apache.pinot.core.query.utils.idset.IdSet;\n+import org.apache.pinot.core.query.utils.idset.IdSets;\n+import org.apache.pinot.spi.data.FieldSpec.DataType;\n+\n+\n+/**\n+ * The {@code IdSetAggregationFunction} collects the values for a given single-value expression into an IdSet, which can\n+ * be used in the second query to optimize the query with huge IN clause generated from another query.\n+ */\n+public class IdSetAggregationFunction extends BaseSingleInputAggregationFunction<IdSet, String> {\n+  public static final char PARAMETER_DELIMITER = ';';\n+  public static final char PARAMETER_KEY_VALUE_SEPARATOR = '=';\n+  public static final String SIZE_THRESHOLD_IN_BYTES_KEY = \"SIZETHRESHOLDINBYTES\";", "originalCommit": "fab464fcfa250f92bee4e897c62b69976a5bc0db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ1NzI5MA==", "url": "https://github.com/apache/pinot/pull/5926#discussion_r479457290", "bodyText": "Added", "author": "Jackie-Jiang", "createdAt": "2020-08-28T18:02:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgzNzMxMg=="}], "type": "inlineReview"}, {"oid": "178e4797ef0bbab652eeddaa58f382782aacecf7", "url": "https://github.com/apache/pinot/commit/178e4797ef0bbab652eeddaa58f382782aacecf7", "message": "Add more javadoc", "committedDate": "2020-08-28T18:02:58Z", "type": "forcePushed"}, {"oid": "9aa4070bb86dc79e920f70cdff0eb5ea32e07e53", "url": "https://github.com/apache/pinot/commit/9aa4070bb86dc79e920f70cdff0eb5ea32e07e53", "message": "Add IdSet and IdSetAggregationFunction", "committedDate": "2020-08-28T19:49:10Z", "type": "commit"}, {"oid": "9aa4070bb86dc79e920f70cdff0eb5ea32e07e53", "url": "https://github.com/apache/pinot/commit/9aa4070bb86dc79e920f70cdff0eb5ea32e07e53", "message": "Add IdSet and IdSetAggregationFunction", "committedDate": "2020-08-28T19:49:10Z", "type": "forcePushed"}]}