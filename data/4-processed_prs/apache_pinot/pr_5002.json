{"pr_number": 5002, "pr_title": "Handle sun.nio.ch.DirectBuffer cleaner behavior for jdk 8+", "pr_createdAt": "2020-01-22T02:16:25Z", "pr_url": "https://github.com/apache/pinot/pull/5002", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1Mjg2Nw==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369352867", "bodyText": "Will this throw exception in normal case? We should not swallow exception", "author": "Jackie-Jiang", "createdAt": "2020-01-22T03:14:43Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/memory/PinotByteBuffer.java", "diffHunk": "@@ -327,8 +327,11 @@ public void flush() {\n \n   @Override\n   protected void release() {\n-    if (((DirectBuffer) _buffer).cleaner() != null) {\n-      ((DirectBuffer) _buffer).cleaner().clean();\n+    if (CleanerUtil.UNMAP_SUPPORTED) {\n+      try {\n+        CleanerUtil.getCleaner().freeBuffer(_buffer);\n+      } catch (IOException e) {", "originalCommit": "1e6dd26dd6dd5d95635d869de31038b891040aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM5NDYyNA==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369394624", "bodyText": "will log the error", "author": "xiangfu0", "createdAt": "2020-01-22T06:54:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1Mjg2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0NjYwNw==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369846607", "bodyText": "We should throw the IOException out (the interface expects IOException to be thrown)", "author": "Jackie-Jiang", "createdAt": "2020-01-22T22:44:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1Mjg2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg1ODEyMA==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369858120", "bodyText": "will do", "author": "xiangfu0", "createdAt": "2020-01-22T23:16:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1Mjg2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1Mjk0Mg==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369352942", "bodyText": "If UNMAP is not supported, are we going to leak resources?", "author": "Jackie-Jiang", "createdAt": "2020-01-22T03:15:12Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/memory/PinotByteBuffer.java", "diffHunk": "@@ -327,8 +327,11 @@ public void flush() {\n \n   @Override\n   protected void release() {\n-    if (((DirectBuffer) _buffer).cleaner() != null) {\n-      ((DirectBuffer) _buffer).cleaner().clean();\n+    if (CleanerUtil.UNMAP_SUPPORTED) {", "originalCommit": "1e6dd26dd6dd5d95635d869de31038b891040aa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM5NTg2Mw==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369395863", "bodyText": "Yes, currently we log error message for the reason. Shall we fatal the program instead?", "author": "xiangfu0", "createdAt": "2020-01-22T06:59:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1Mjk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQwMTAzNg==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369401036", "bodyText": "Why would we get to this code block?", "author": "kishoreg", "createdAt": "2020-01-22T07:20:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1Mjk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ3Mjg0OQ==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369472849", "bodyText": "It\u2019s possible that users may not have permission, e.g. security manager not grant reflectPermission", "author": "xiangfu0", "createdAt": "2020-01-22T10:14:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1Mjk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0NzY1NA==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369847654", "bodyText": "I would recommend aborting the program because this will cause severe resource leak (unable to offload any segment)", "author": "Jackie-Jiang", "createdAt": "2020-01-22T22:47:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1Mjk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg0OTE2NA==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369849164", "bodyText": "does this occur in heap and offHeap load mode?", "author": "kishoreg", "createdAt": "2020-01-22T22:51:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1Mjk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg1NDk1OQ==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369854959", "bodyText": "@kishoreg It occurs in both modes\nhttps://stackoverflow.com/questions/36077641/java-when-does-direct-buffer-released\nAfter some research, seems like the direct memory will be freed eventually, but there is no guarantee on how long it takes, and the JVM might run out of direct memory.\nI think it is okay to log an error and keep the program running, but let's make sure in normal case it can free the direct memory properly.", "author": "Jackie-Jiang", "createdAt": "2020-01-22T23:07:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1Mjk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg3NDM2MA==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369874360", "bodyText": "In normal case, this code will just incur different methods to clean DirectBuffer in different java runtime.", "author": "xiangfu0", "createdAt": "2020-01-23T00:13:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1Mjk0Mg=="}], "type": "inlineReview"}, {"oid": "07577fc659a9b6e8bfea8ea087f5dcc0ab5e208f", "url": "https://github.com/apache/pinot/commit/07577fc659a9b6e8bfea8ea087f5dcc0ab5e208f", "message": "Smoothly handle ByteBuffer clean behavior from jdk 8", "committedDate": "2020-01-22T06:51:29Z", "type": "forcePushed"}, {"oid": "06deaba62b5ea6fce9ac37dc193743cbed30ae13", "url": "https://github.com/apache/pinot/commit/06deaba62b5ea6fce9ac37dc193743cbed30ae13", "message": "Smoothly handle ByteBuffer clean behavior from jdk 8", "committedDate": "2020-01-22T07:00:31Z", "type": "commit"}, {"oid": "06deaba62b5ea6fce9ac37dc193743cbed30ae13", "url": "https://github.com/apache/pinot/commit/06deaba62b5ea6fce9ac37dc193743cbed30ae13", "message": "Smoothly handle ByteBuffer clean behavior from jdk 8", "committedDate": "2020-01-22T07:00:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg3MzYzOA==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369873638", "bodyText": "No need for this test as release() is called in close().", "author": "Jackie-Jiang", "createdAt": "2020-01-23T00:10:32Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/segment/memory/PinotDataBufferTest.java", "diffHunk": "@@ -115,6 +115,34 @@ public void testPinotByteBuffer()\n     }\n   }\n \n+  @Test\n+  public void testPinotByteBufferRelease()", "originalCommit": "b79d53e38bd7f86cbe99174561b457916ef1cade", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg3Mzg5Nw==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369873897", "bodyText": "Maybe better to log an warning with the reason when CleanerUtil.UNMAP_SUPPORTED is false", "author": "Jackie-Jiang", "createdAt": "2020-01-23T00:11:30Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/memory/PinotByteBuffer.java", "diffHunk": "@@ -326,9 +329,15 @@ public void flush() {\n   }\n \n   @Override\n-  protected void release() {\n-    if (((DirectBuffer) _buffer).cleaner() != null) {\n-      ((DirectBuffer) _buffer).cleaner().clean();\n+  protected void release()\n+      throws IOException {\n+    if (CleanerUtil.UNMAP_SUPPORTED) {", "originalCommit": "b79d53e38bd7f86cbe99174561b457916ef1cade", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg3NTUxOA==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369875518", "bodyText": "It's logged in CleanerUtil", "author": "xiangfu0", "createdAt": "2020-01-23T00:17:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg3Mzg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg3NDExMA==", "url": "https://github.com/apache/pinot/pull/5002#discussion_r369874110", "bodyText": "No need to try-catch and log the error if we throw the exception out", "author": "Jackie-Jiang", "createdAt": "2020-01-23T00:12:16Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/memory/PinotByteBuffer.java", "diffHunk": "@@ -326,9 +329,15 @@ public void flush() {\n   }\n \n   @Override\n-  protected void release() {\n-    if (((DirectBuffer) _buffer).cleaner() != null) {\n-      ((DirectBuffer) _buffer).cleaner().clean();\n+  protected void release()\n+      throws IOException {\n+    if (CleanerUtil.UNMAP_SUPPORTED) {\n+      try {\n+        CleanerUtil.getCleaner().freeBuffer(_buffer);\n+      } catch (IOException e) {\n+        LOGGER.error(\"Failed to release ByteBuffer: {}\", _buffer, e);", "originalCommit": "b79d53e38bd7f86cbe99174561b457916ef1cade", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8fb56e162f7cfa4fbd1ba10b89c6c4ebce7ac6a3", "url": "https://github.com/apache/pinot/commit/8fb56e162f7cfa4fbd1ba10b89c6c4ebce7ac6a3", "message": "address comments", "committedDate": "2020-01-23T00:19:03Z", "type": "commit"}, {"oid": "8fb56e162f7cfa4fbd1ba10b89c6c4ebce7ac6a3", "url": "https://github.com/apache/pinot/commit/8fb56e162f7cfa4fbd1ba10b89c6c4ebce7ac6a3", "message": "address comments", "committedDate": "2020-01-23T00:19:03Z", "type": "forcePushed"}]}