{"pr_number": 5324, "pr_title": "Timespec to datetimespec conversion utility", "pr_createdAt": "2020-05-01T18:19:27Z", "pr_url": "https://github.com/apache/pinot/pull/5324", "timeline": [{"oid": "48219df0c8819980da754dce8ca18c610c5725ad", "url": "https://github.com/apache/pinot/commit/48219df0c8819980da754dce8ca18c610c5725ad", "message": "Utility for conversion from timeFieldSpec to dateTimeFieldSpec", "committedDate": "2020-04-30T23:57:21Z", "type": "commit"}, {"oid": "12655818f8acd9f24fab1e57012ccba57d5e7414", "url": "https://github.com/apache/pinot/commit/12655818f8acd9f24fab1e57012ccba57d5e7414", "message": "Tests", "committedDate": "2020-05-01T17:53:47Z", "type": "commit"}, {"oid": "fcf8df1ecf2ca0fb77691afd2ac5b874495e4425", "url": "https://github.com/apache/pinot/commit/fcf8df1ecf2ca0fb77691afd2ac5b874495e4425", "message": "Remove unused data provider", "committedDate": "2020-05-01T18:07:21Z", "type": "commit"}, {"oid": "6591331e4f7486deebbedeb97690ff5359a79f89", "url": "https://github.com/apache/pinot/commit/6591331e4f7486deebbedeb97690ff5359a79f89", "message": "Remove unused method", "committedDate": "2020-05-01T18:16:51Z", "type": "commit"}, {"oid": "c0fb8a21d6b8b54e1bbdcabaecf9b7c9a781e077", "url": "https://github.com/apache/pinot/commit/c0fb8a21d6b8b54e1bbdcabaecf9b7c9a781e077", "message": "Fix test", "committedDate": "2020-05-01T19:50:23Z", "type": "commit"}, {"oid": "7a199c1eee51e4b9c57d5d8987404b1d156edb92", "url": "https://github.com/apache/pinot/commit/7a199c1eee51e4b9c57d5d8987404b1d156edb92", "message": "Move conversion utility to Schema", "committedDate": "2020-05-04T17:26:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxMDc5OQ==", "url": "https://github.com/apache/pinot/pull/5324#discussion_r419610799", "bodyText": "The term 'bucket' is not intuitive to me (but that could be just me). You may think of using something like:\ntoEpochHoursRounded(Long millis, String granularity) {\n\nwith the comment that the method converts the milis to hours, and rounds it down to the nearest granularity specified.\nYou can decide, though.", "author": "mcvsubbu", "createdAt": "2020-05-04T17:41:45Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/function/DateTimeFunctions.java", "diffHunk": "@@ -35,9 +63,79 @@ static Long toEpochHours(Long millis) {\n   }\n \n   /**\n-   * Convert epoch millis to epoch minutes, bucketed by given bucket granularity\n+   * Convert epoch millis to epoch hours, bucketed by given bucket granularity\n    */\n-  static Long toEpochMinutes(Long millis, String bucket) {\n-    return TimeUnit.MILLISECONDS.toMinutes(millis) / Integer.parseInt(bucket);\n+  static Long toEpochHoursBucket(Long millis, String bucket) {", "originalCommit": "7a199c1eee51e4b9c57d5d8987404b1d156edb92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYzMTg5Mg==", "url": "https://github.com/apache/pinot/pull/5324#discussion_r419631892", "bodyText": "Agreed, I don't like \"bucket\" here either, but couldn't think of a better one. Rounded does sound better, but i wonder if it'll be confusing.\nFor example, consider millis 1578685189000 (2020/01/10 11:39:49)\ntoEpochSeconds(millis) = 1578685189\nWhat we want is - toEpochSeconds(millis, 10) = 1578685189/10 = 157868518 i.e. divide the seconds to create tenSecondsSinceEpoch\nRounding can be confused with - keep the same format, but find the nearest 10 minutes value.\ntoEpochSecondsRounded(millis, 10) = (1578685189/10) * 10 = 1578685180\nMaybe we should solicit more opinions? Once this function starts being used, it'll be with us forever", "author": "npawar", "createdAt": "2020-05-04T18:15:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxMDc5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcxNzIwMQ==", "url": "https://github.com/apache/pinot/pull/5324#discussion_r419717201", "bodyText": "As per our offline conversation, we now have toEpochXXX, toEpochXXXRounded, toEpochXXXBucket. For example,\n\ntoEpochSeconds(millis) - converts from millis to  epoch seconds\ntoEpochSecondsRounded (millis, 10) - converts from millis to epoch seconds, and rounds to the smaller 10th value i.e. (seconds/10) * 10\ntoEpochSecondsBucket(millis, 10) - converts from millis to epoch seconds and divides by bucket, to get tenSecondsFromEpoch i.e. seconds / 10", "author": "npawar", "createdAt": "2020-05-04T20:45:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxMDc5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxMTUxNQ==", "url": "https://github.com/apache/pinot/pull/5324#discussion_r419611515", "bodyText": "Isnt it better to use Integer.valueOf()? Agreed it returns an object, but these objects are cached (for < 128 values, which is likely to be the case here). Otherwise, we will be parsing a string for every row ingested?", "author": "mcvsubbu", "createdAt": "2020-05-04T17:43:01Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/function/DateTimeFunctions.java", "diffHunk": "@@ -35,9 +63,79 @@ static Long toEpochHours(Long millis) {\n   }\n \n   /**\n-   * Convert epoch millis to epoch minutes, bucketed by given bucket granularity\n+   * Convert epoch millis to epoch hours, bucketed by given bucket granularity\n    */\n-  static Long toEpochMinutes(Long millis, String bucket) {\n-    return TimeUnit.MILLISECONDS.toMinutes(millis) / Integer.parseInt(bucket);\n+  static Long toEpochHoursBucket(Long millis, String bucket) {\n+    return TimeUnit.MILLISECONDS.toHours(millis) / Integer.parseInt(bucket);", "originalCommit": "7a199c1eee51e4b9c57d5d8987404b1d156edb92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYzNDY2MA==", "url": "https://github.com/apache/pinot/pull/5324#discussion_r419634660", "bodyText": "Ah didn't know about the caching done by valueOf. Thanks", "author": "npawar", "createdAt": "2020-05-04T18:20:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxMTUxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxODcyOQ==", "url": "https://github.com/apache/pinot/pull/5324#discussion_r419618729", "bodyText": "another way to do this is to keep it protected and let tests access it. Alternatively, keep it private and use introspection (makes it brittle, but we should discover very soon since the tests will fail).", "author": "mcvsubbu", "createdAt": "2020-05-04T17:54:35Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java", "diffHunk": "@@ -631,4 +632,130 @@ public int hashCode() {\n     result = EqualityUtils.hashCodeOf(result, _dateTimeFieldSpecs);\n     return result;\n   }\n+\n+  /**\n+   * Helper method that converts a {@link TimeFieldSpec} to {@link DateTimeFieldSpec}\n+   * 1) If timeFieldSpec contains only incoming granularity spec, directly convert it to a dateTimeFieldSpec\n+   * 2) If timeFieldSpec contains incoming aas well as outgoing granularity spec, use the outgoing spec to construct the dateTimeFieldSpec,\n+   *    and configure a transform function for the conversion from incoming\n+   */\n+  @VisibleForTesting\n+  static DateTimeFieldSpec convertToDateTimeFieldSpec(TimeFieldSpec timeFieldSpec) {", "originalCommit": "7a199c1eee51e4b9c57d5d8987404b1d156edb92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYzNTcwOA==", "url": "https://github.com/apache/pinot/pull/5324#discussion_r419635708", "bodyText": "My intention was to do the first of your options. I chose the \"default\" access modifier instead of protected, as it's one level more restrictive", "author": "npawar", "createdAt": "2020-05-04T18:22:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYxODcyOQ=="}], "type": "inlineReview"}, {"oid": "935731f6dfdf01dc49063deec3987c68d9f45060", "url": "https://github.com/apache/pinot/commit/935731f6dfdf01dc49063deec3987c68d9f45060", "message": "Change parseInt to valueOf", "committedDate": "2020-05-04T18:23:10Z", "type": "commit"}, {"oid": "53f483b20c6be8e81dcaecbb7ca874af9b899ed9", "url": "https://github.com/apache/pinot/commit/53f483b20c6be8e81dcaecbb7ca874af9b899ed9", "message": "Add epochToXXXRounded function", "committedDate": "2020-05-04T20:41:53Z", "type": "commit"}, {"oid": "71dc5a827c2306dece93066de2502cd3b38d9400", "url": "https://github.com/apache/pinot/commit/71dc5a827c2306dece93066de2502cd3b38d9400", "message": "Test input", "committedDate": "2020-05-04T22:41:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI1MzQzNg==", "url": "https://github.com/apache/pinot/pull/5324#discussion_r420253436", "bodyText": "It will be nice if you also add here\n(1) an example of the use case in time-field-spec that needs bucketing in order to be backward compatible.\n(2) A comment that use of these bucket functions is discouraged unless you know what you are doing (e.g. 5-minutes-since-epoch does not make sense to someone looking at the timestamp, or writing queries. instead, Millis-since-epoch rounded to 5 minutes makes a lot more sense).", "author": "mcvsubbu", "createdAt": "2020-05-05T16:45:03Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/function/DateTimeFunctions.java", "diffHunk": "@@ -35,9 +53,127 @@ static Long toEpochHours(Long millis) {\n   }\n \n   /**\n-   * Convert epoch millis to epoch minutes, bucketed by given bucket granularity\n+   * Convert epoch millis to epoch days\n+   */\n+  static Long toEpochDays(Long millis) {\n+    return TimeUnit.MILLISECONDS.toDays(millis);\n+  }\n+\n+  /**\n+   * Convert epoch millis to epoch seconds, round to nearest rounding bucket\n+   */\n+  static Long toEpochSecondsRounded(Long millis, String roundingValue) {\n+    int roundToNearest = Integer.parseInt(roundingValue);\n+    return (TimeUnit.MILLISECONDS.toSeconds(millis) / roundToNearest) * roundToNearest;\n+  }\n+\n+  /**\n+   * Convert epoch millis to epoch minutes, round to nearest rounding bucket\n+   */\n+  static Long toEpochMinutesRounded(Long millis, String roundingValue) {\n+    int roundToNearest = Integer.parseInt(roundingValue);\n+    return (TimeUnit.MILLISECONDS.toMinutes(millis) / roundToNearest) * roundToNearest;\n+  }\n+\n+  /**\n+   * Convert epoch millis to epoch hours, round to nearest rounding bucket\n+   */\n+  static Long toEpochHoursRounded(Long millis, String roundingValue) {\n+    int roundToNearest = Integer.parseInt(roundingValue);\n+    return (TimeUnit.MILLISECONDS.toHours(millis) / roundToNearest) * roundToNearest;\n+  }\n+\n+  /**\n+   * Convert epoch millis to epoch days, round to nearest rounding bucket\n+   */\n+  static Long toEpochDaysRounded(Long millis, String roundingValue) {\n+    int roundToNearest = Integer.parseInt(roundingValue);\n+    return (TimeUnit.MILLISECONDS.toDays(millis) / roundToNearest) * roundToNearest;\n+  }\n+\n+  // TODO: toEpochXXXBucket methods are only needed to convert from TimeFieldSpec to DateTimeFieldSpec.", "originalCommit": "71dc5a827c2306dece93066de2502cd3b38d9400", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}