{"pr_number": 5961, "pr_title": "[TE] Added helm deployment for ThirdEye", "pr_createdAt": "2020-09-02T07:41:06Z", "pr_url": "https://github.com/apache/pinot/pull/5961", "timeline": [{"oid": "315a95711a94fd7fc0afda1139b8f6823f71ffd1", "url": "https://github.com/apache/pinot/commit/315a95711a94fd7fc0afda1139b8f6823f71ffd1", "message": "[TE] Added helm deployment for ThirdEye\n\nCreating a helm application for ThirdEye to work with pinot quickstart\nright off the box. The current change installs MySQL with the initial\nset of tables. This creates thirdeye frontend and backend pods\n\nCaveats:\n - The initdb.sql needs to be updated regularly which is an overhead\n - Using the create-schema.sql is not possible at the moment since the script has errors with MySQL 5.7. This is to be refactored.", "committedDate": "2020-09-02T07:39:25Z", "type": "commit"}, {"oid": "fd0c7395d2cea2f29fa4815b88618814f0e3b5b3", "url": "https://github.com/apache/pinot/commit/fd0c7395d2cea2f29fa4815b88618814f0e3b5b3", "message": "[TE] Added helm deployment for ThirdEye\n\nRefactored/cleaned up values.yaml", "committedDate": "2020-09-02T17:36:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI1NjgzNA==", "url": "https://github.com/apache/pinot/pull/5961#discussion_r482256834", "bodyText": "We'll need separate \"detector.yml\" files for the scheduler backend and regular worker backends. Scheduler can be a worker too, but there can only be one scheduler active at a time.\nScheduler\nalert: true\nautoload: true\nclassifier: true\nholidayEventsLoader: true\nmonitor: true\nscheduler: true\nworker: true/false (should be configurable)\ndetectionPipeline: true\ndetectionAlert: true\nmockEventsLoader: true/false (should be configurable)\nWorker\nalert: false\nautoload: false\nclassifier: false\nholidayEventsLoader: false\nmonitor: false\nscheduler: false\nworker: true\ndetectionPipeline: false\ndetectionAlert: false\nmockEventsLoader: false", "author": "apucher", "createdAt": "2020-09-02T17:50:55Z", "path": "kubernetes/helm/thirdeye/templates/common/configmap.yaml", "diffHunk": "@@ -0,0 +1,252 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#   http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+#\n+\n+apiVersion: v1\n+kind: ConfigMap\n+metadata:\n+  name: thirdeye-pinot-quickstart-datasource-config\n+data:\n+  persistence.yml: |-\n+    databaseConfiguration:\n+      url: jdbc:mysql://{{ .Release.Name }}-mysql/thirdeye\n+      user: {{ .Values.mysql.mysqlUser }}\n+      password: {{ .Values.mysql.mysqlPassword }}\n+      driver: com.mysql.jdbc.Driver\n+  dashboard.yml: |-\n+    authConfig:\n+      authEnabled: false\n+      authKey: \"\"\n+      ldapUrl: \"\"\n+      domainSuffix: []\n+      cacheTTL: 3600\n+      cookieTTL: 604800\n+    resourceConfig: []\n+    rootCause:\n+      definitionsPath: rca.yml\n+      parallelism: 5\n+      formatters:\n+        - org.apache.pinot.thirdeye.dashboard.resources.v2.rootcause.AnomalyEventFormatter\n+        - org.apache.pinot.thirdeye.dashboard.resources.v2.rootcause.ThirdEyeEventFormatter\n+        - org.apache.pinot.thirdeye.dashboard.resources.v2.rootcause.MetricEntityFormatter\n+        - org.apache.pinot.thirdeye.dashboard.resources.v2.rootcause.DimensionEntityFormatter\n+        - org.apache.pinot.thirdeye.dashboard.resources.v2.rootcause.ServiceEntityFormatter\n+        - org.apache.pinot.thirdeye.dashboard.resources.v2.rootcause.DefaultEventEntityFormatter\n+    dashboardHost: \"http://localhost:1426\"\n+    failureFromAddress: thirdeye@localhost\n+    failureToAddress: user@localhost\n+    alerterConfiguration:\n+      smtpConfiguration:\n+        smtpHost: localhost\n+        smtpPort: 25\n+    logging:\n+      level: INFO\n+      loggers:\n+        org.apache.pinot: INFO\n+\n+    server:\n+      type: default\n+      applicationConnectors:\n+        - type: http\n+          port: 1426\n+      adminConnectors:\n+        - type: http\n+          port: 1427\n+      requestLog:\n+        type: external\n+    whitelistDatasets: []\n+    swagger:\n+      resourcePackage: \"org.apache.pinot.thirdeye.dashboard.resources,org.apache.pinot.thirdeye.dashboard.resources.v2,org.apache.pinot.thirdeye.anomaly.onboard,org.apache.pinot.thirdeye.detection,org.apache.pinot.thirdeye.detection.yaml\"\n+\n+  detector.yml: |-\n+    logging:\n+      level: INFO\n+      loggers:\n+        org.hibernate.engine.internal: WARN\n+    server:\n+      type: default\n+      rootPath: '/api/*'\n+      applicationContextPath: /\n+      adminContextPath: /admin\n+      applicationConnectors:\n+        - type: http\n+          port: 1867\n+      adminConnectors:\n+        - type: http\n+          port: 1868\n+    alert: false\n+    autoload: true\n+    # autoOnboardConfiguration:\n+    #   runFrequency: 10s\n+\n+    classifier: false", "originalCommit": "fd0c7395d2cea2f29fa4815b88618814f0e3b5b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI1NzgyOA==", "url": "https://github.com/apache/pinot/pull/5961#discussion_r482257828", "bodyText": "also, worker CAN omit holidayLoaderConfiguration and SHOULD omit mockEventsLoaderconfiguration", "author": "apucher", "createdAt": "2020-09-02T17:52:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI1NjgzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQwMzk5NA==", "url": "https://github.com/apache/pinot/pull/5961#discussion_r482403994", "bodyText": "I'm creating a composite worker/scheduler pod for now just to keep things simple. I plan to split these up later on since these configurations hasn't been tested.", "author": "suvodeep-pyne", "createdAt": "2020-09-02T20:17:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI1NjgzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI1ODc1MA==", "url": "https://github.com/apache/pinot/pull/5961#discussion_r482258750", "bodyText": "should be configurable", "author": "apucher", "createdAt": "2020-09-02T17:54:20Z", "path": "kubernetes/helm/thirdeye/templates/frontend/service.yaml", "diffHunk": "@@ -0,0 +1,38 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#   http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+#\n+\n+apiVersion: v1\n+kind: Service\n+metadata:\n+  name: {{ include \"thirdeye.frontend.fullname\" . }}\n+  labels:\n+    app: {{ include \"thirdeye.name\" . }}\n+    chart: {{ include \"thirdeye.chart\" . }}\n+    component: {{ .Values.frontend.name }}\n+    release: {{ .Release.Name }}\n+    heritage: {{ .Release.Service }}\n+spec:\n+  type: LoadBalancer", "originalCommit": "fd0c7395d2cea2f29fa4815b88618814f0e3b5b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM1MjI4OQ==", "url": "https://github.com/apache/pinot/pull/5961#discussion_r482352289", "bodyText": "done.", "author": "suvodeep-pyne", "createdAt": "2020-09-02T19:38:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI1ODc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI2MTE0Mg==", "url": "https://github.com/apache/pinot/pull/5961#discussion_r482261142", "bodyText": "this part is pretty ugly. I wonder what's the best practice for retaining the mysql secret over redeploy without exposing this here", "author": "apucher", "createdAt": "2020-09-02T17:58:22Z", "path": "kubernetes/helm/thirdeye/values.yaml", "diffHunk": "@@ -0,0 +1,73 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#   http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+#\n+\n+# Default values for ThirdEye Deployment\n+\n+image:\n+  repository: apachepinot/thirdeye\n+  tag: latest\n+  pullPolicy: IfNotPresent\n+\n+frontend:\n+  enabled: true\n+  name: frontend\n+  replicaCount: 1\n+  port: 1426\n+  adminport: 1427\n+\n+  resources: {}\n+  nodeSelector: {}\n+  tolerations: []\n+  affinity: {}\n+  podAnnotations: {}\n+\n+\n+backend:\n+  enabled: true\n+  name: backend\n+  replicaCount: 1\n+  port: 1867\n+  adminport: 1868\n+\n+  resources: {}\n+  nodeSelector: {}\n+  tolerations: []\n+  affinity: {}\n+  podAnnotations: {}\n+\n+# Persistence layer configuration\n+mysql:\n+  mysqlRootPassword: password", "originalCommit": "fd0c7395d2cea2f29fa4815b88618814f0e3b5b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQzNzcyMQ==", "url": "https://github.com/apache/pinot/pull/5961#discussion_r482437721", "bodyText": "I have kept install.sh extendible to easily override helm parameters. That should give a user some flexibility to feed in secrets. However, this part needs to be resolved in a better way. Since this is a demo setup, I am thinking of starting with this for now as we move to better solutions with k8s secrets, etc.", "author": "suvodeep-pyne", "createdAt": "2020-09-02T20:42:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI2MTE0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ4NTY5MQ==", "url": "https://github.com/apache/pinot/pull/5961#discussion_r482485691", "bodyText": "ok let's do this next iteration then", "author": "apucher", "createdAt": "2020-09-02T21:22:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI2MTE0Mg=="}], "type": "inlineReview"}, {"oid": "2edd2885c3377f6263a483522f8407938bedbed9", "url": "https://github.com/apache/pinot/commit/2edd2885c3377f6263a483522f8407938bedbed9", "message": "[TE] Added helm deployment for ThirdEye\n\nExposing service type in template. +refactor", "committedDate": "2020-09-02T19:38:22Z", "type": "commit"}, {"oid": "b9532203b3a2ecb2d464eee1c53de4eb4ea2baff", "url": "https://github.com/apache/pinot/commit/b9532203b3a2ecb2d464eee1c53de4eb4ea2baff", "message": "[TE] Added helm deployment for ThirdEye\n\nChanges\n- Added README.md.\n- ./install.sh enhanced to send all command line args to helm", "committedDate": "2020-09-02T20:10:49Z", "type": "commit"}, {"oid": "af1445f71413f948c5a3dda9f49e4e57c057a2a3", "url": "https://github.com/apache/pinot/commit/af1445f71413f948c5a3dda9f49e4e57c057a2a3", "message": "[TE] Added helm deployment for ThirdEye\n\nChanges\n- Enabling alert, classifier switches in detector.yaml", "committedDate": "2020-09-02T20:15:25Z", "type": "commit"}]}