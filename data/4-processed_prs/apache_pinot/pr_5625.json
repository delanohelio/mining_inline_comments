{"pr_number": 5625, "pr_title": "Make DataSource independent of query execution (not extend Operator)", "pr_createdAt": "2020-06-26T18:55:49Z", "pr_url": "https://github.com/apache/pinot/pull/5625", "timeline": [{"oid": "bedda3240d3dcfdb8995eba48f54ed20f594d465", "url": "https://github.com/apache/pinot/commit/bedda3240d3dcfdb8995eba48f54ed20f594d465", "message": "Make DataSource independent of query execution (not extend Operator)\n\nMotivation:\nCurrently DataSource is modeled as an Operator, where values are returned\nas a block complying with the Operator interface. This is confusing because\nof the following reasons:\n- The block contains all the documents in the segment, instead of a block\n  of at most 10000 documents as in the Projection layer.\n- The values are always fetched with their document ids, instead of fetched\n  as a block. Currently BlockValSet interface has 2 set of APIs because of\n  this, which is confusing.\n- The BlockValSet returned by the DataSource is not really a value set, but\n  a value reader on top of the forward index.\n- Extra BlockMetadata has to be maintained which can cause unexpected\n  problems (e.g. the issue fixed in #5619)\n\nChanges:\n- Make DataSource standalong without implementing Operator\n- Add interfaces for forward index (ForwardIndexReader, ForwardIndexWriter,\n  ForwardIndexReaderWriter)\n- Add ColumnValueReader class to help read forward index from DataSource\n- Remove the docId based APIs from BlockValSet", "committedDate": "2020-06-26T19:52:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY3NzAyMw==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r446677023", "bodyText": "This should not be a TODO, but fixed in this PR itself? Or are you saying it happens in some corner case? If so, please describe when that might happen.", "author": "mayankshriv", "createdAt": "2020-06-28T17:34:37Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ColumnValueReader.java", "diffHunk": "@@ -0,0 +1,248 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.common;\n+\n+import org.apache.pinot.core.io.reader.ForwardIndexReader;\n+import org.apache.pinot.core.io.reader.ReaderContext;\n+import org.apache.pinot.spi.data.FieldSpec.DataType;\n+\n+\n+/**\n+ * ColumnValueReader is a wrapper class on top of the forward index reader to read values from it.\n+ * <p>Batch value read APIs support the following data type conversions for numeric types:\n+ * <ul>\n+ *   <li>INT -> LONG</li>\n+ *   <li>INT, LONG -> FLOAT</li>\n+ *   <li>INT, LONG, FLOAT -> DOUBLE</li>\n+ * </ul>\n+ */\n+@SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+public final class ColumnValueReader {\n+  private final ForwardIndexReader _forwardIndexReader;\n+  private final DataType _valueType;\n+  private final ReaderContext _readerContext;\n+\n+  public ColumnValueReader(ForwardIndexReader forwardIndexReader) {\n+    _forwardIndexReader = forwardIndexReader;\n+    _valueType = forwardIndexReader.getValueType();\n+    // TODO: Figure out a way to close the reader context. Currently it can cause direct memory leak.", "originalCommit": "bedda3240d3dcfdb8995eba48f54ed20f594d465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI2ODM4OQ==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r447268389", "bodyText": "This is the current behavior. The fix is not very straight forward, so I don't want to mix this fix with the refactor PR. Will try to fix it in the next PR.", "author": "Jackie-Jiang", "createdAt": "2020-06-29T21:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY3NzAyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY3NzU1OQ==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r446677559", "bodyText": "Should this extend forwardIndexReader, as it seems to be pass-through for several api's, and providing additional functionality?", "author": "mayankshriv", "createdAt": "2020-06-28T17:39:14Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ColumnValueReader.java", "diffHunk": "@@ -0,0 +1,248 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.common;\n+\n+import org.apache.pinot.core.io.reader.ForwardIndexReader;\n+import org.apache.pinot.core.io.reader.ReaderContext;\n+import org.apache.pinot.spi.data.FieldSpec.DataType;\n+\n+\n+/**\n+ * ColumnValueReader is a wrapper class on top of the forward index reader to read values from it.\n+ * <p>Batch value read APIs support the following data type conversions for numeric types:\n+ * <ul>\n+ *   <li>INT -> LONG</li>\n+ *   <li>INT, LONG -> FLOAT</li>\n+ *   <li>INT, LONG, FLOAT -> DOUBLE</li>\n+ * </ul>\n+ */\n+@SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+public final class ColumnValueReader {\n+  private final ForwardIndexReader _forwardIndexReader;", "originalCommit": "bedda3240d3dcfdb8995eba48f54ed20f594d465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3MDAwMQ==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r447270001", "bodyText": "This is a wrapper class on top of the forward index to help manage the reader context. It replaces the current SingleValueReader and MultiValueReader. It should not implement ForwardIndexReader but access forward index.", "author": "Jackie-Jiang", "createdAt": "2020-06-29T21:40:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY3NzU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY3Nzc1NA==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r446677754", "bodyText": "Does it make sense to read strings as numbers (of course, assuming that these are numbers stored as strings)? Or that use case does not make sense?", "author": "mayankshriv", "createdAt": "2020-06-28T17:40:57Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ColumnValueReader.java", "diffHunk": "@@ -0,0 +1,248 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.common;\n+\n+import org.apache.pinot.core.io.reader.ForwardIndexReader;\n+import org.apache.pinot.core.io.reader.ReaderContext;\n+import org.apache.pinot.spi.data.FieldSpec.DataType;\n+\n+\n+/**\n+ * ColumnValueReader is a wrapper class on top of the forward index reader to read values from it.\n+ * <p>Batch value read APIs support the following data type conversions for numeric types:\n+ * <ul>\n+ *   <li>INT -> LONG</li>\n+ *   <li>INT, LONG -> FLOAT</li>\n+ *   <li>INT, LONG, FLOAT -> DOUBLE</li>\n+ * </ul>\n+ */\n+@SuppressWarnings({\"rawtypes\", \"unchecked\"})\n+public final class ColumnValueReader {\n+  private final ForwardIndexReader _forwardIndexReader;\n+  private final DataType _valueType;\n+  private final ReaderContext _readerContext;\n+\n+  public ColumnValueReader(ForwardIndexReader forwardIndexReader) {\n+    _forwardIndexReader = forwardIndexReader;\n+    _valueType = forwardIndexReader.getValueType();\n+    // TODO: Figure out a way to close the reader context. Currently it can cause direct memory leak.\n+    _readerContext = forwardIndexReader.createContext();\n+  }\n+\n+  /**\n+   * Returns the data type of the values in the value reader.\n+   * <p>NOTE: Dictionary id is handled as INT type.\n+   */\n+  public DataType getValueType() {\n+    return _valueType;\n+  }\n+\n+  /**\n+   * Returns {@code true} if the value reader is for a single-value column, {@code false} otherwise.\n+   */\n+  public boolean isSingleValue() {\n+    return _forwardIndexReader.isSingleValue();\n+  }\n+\n+  /**\n+   * NOTE: The following single value read APIs do not handle the data type conversion for performance concern. Caller\n+   *       should always call the API that matches the value type.\n+   */\n+\n+  /**\n+   * Returns the INT type single-value at the given document id.\n+   * <p>NOTE: Dictionary id is handled as INT type.\n+   */\n+  public int getIntValue(int docId) {\n+    return _forwardIndexReader.getInt(docId, _readerContext);\n+  }\n+\n+  /**\n+   * Returns the LONG type single-value at the given document id.\n+   */\n+  public long getLongValue(int docId) {\n+    return _forwardIndexReader.getLong(docId, _readerContext);\n+  }\n+\n+  /**\n+   * Returns the FLOAT type single-value at the given document id.\n+   */\n+  public float getFloatValue(int docId) {\n+    return _forwardIndexReader.getFloat(docId, _readerContext);\n+  }\n+\n+  /**\n+   * Returns the DOUBLE type single-value at the given document id.\n+   */\n+  public double getDoubleValue(int docId) {\n+    return _forwardIndexReader.getDouble(docId, _readerContext);\n+  }\n+\n+  /**\n+   * Returns the STRING type single-value at the given document id.\n+   */\n+  public String getStringValue(int docId) {\n+    return _forwardIndexReader.getString(docId, _readerContext);\n+  }\n+\n+  /**\n+   * Returns the BYTES type single-value at the given document id.\n+   */\n+  public byte[] getBytesValue(int docId) {\n+    return _forwardIndexReader.getBytes(docId, _readerContext);\n+  }\n+\n+  /**\n+   * Reads the INT type multi-value at the given document id into the value buffer and returns the number of values in\n+   * the multi-value entry.\n+   * <p>The passed in value buffer should be large enough to hold all the values of a multi-value entry.\n+   * <p>NOTE: Dictionary id is handled as INT type.\n+   */\n+  public int getIntValues(int docId, int[] valueBuffer) {\n+    return _forwardIndexReader.getIntArray(docId, valueBuffer, _readerContext);\n+  }\n+\n+  // TODO: Support raw index for multi-value columns\n+\n+  /**\n+   * NOTE: The following batch value read APIs support data type conversions for numeric types. Caller can call any\n+   *       API regardless of the value type.\n+   * TODO: Consider letting the caller handle the data type conversion because for different use cases, we might need to\n+   *       convert data type differently.\n+   */\n+\n+  /**\n+   * Batch reads the INT type single-values at the given document ids of the given length into the value buffer.\n+   * <p>The passed in value buffer size should be larger than or equal to the length.\n+   * <p>NOTE: Dictionary id is handled as INT type.\n+   */\n+  public void getIntValues(int[] docIds, int length, int[] valueBuffer) {\n+    if (_valueType == DataType.INT) {\n+      _forwardIndexReader.readValues(docIds, length, valueBuffer, _readerContext);\n+    } else {\n+      throw new IllegalStateException(String.format(\"Cannot read %s as INT\", _valueType));\n+    }\n+  }\n+\n+  /**\n+   * Batch reads the LONG type single-values at the given document ids of the given length into the value buffer.\n+   * <p>The passed in value buffer size should be larger than or equal to the length.\n+   */\n+  public void getLongValues(int[] docIds, int length, long[] valueBuffer) {\n+    switch (_valueType) {\n+      case INT:", "originalCommit": "bedda3240d3dcfdb8995eba48f54ed20f594d465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3MjM5Ng==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r447272396", "bodyText": "We can try to cast all types, but could be costly (there is a TODO on line 126).\nAgain, this PR only involves clean up and refactor without any functionality change. We can add that in a separate PR if required.", "author": "Jackie-Jiang", "createdAt": "2020-06-29T21:45:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY3Nzc1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY3ODYzMg==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r446678632", "bodyText": "I am confused by this change:\n\nWhy is this diff showing as move of an unrelated class?\nThe name of the interface is ForwardIndexReaderWriter, but it has no read or write api's?", "author": "mayankshriv", "createdAt": "2020-06-28T17:49:07Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/io/readerwriter/ForwardIndexReaderWriter.java", "diffHunk": "@@ -16,11 +16,29 @@\n  * specific language governing permissions and limitations\n  * under the License.\n  */\n-package org.apache.pinot.core.io.reader.impl;\n+package org.apache.pinot.core.io.readerwriter;\n \n+import org.apache.pinot.core.io.reader.ForwardIndexReader;\n import org.apache.pinot.core.io.reader.ReaderContext;\n+import org.apache.pinot.core.io.writer.ForwardIndexWriter;\n \n \n-public class UnSortedValueReaderContext implements ReaderContext {\n+/**\n+ * Interface for forward index reader-writer.\n+ */\n+public interface ForwardIndexReaderWriter extends ForwardIndexReader<ReaderContext>, ForwardIndexWriter {", "originalCommit": "bedda3240d3dcfdb8995eba48f54ed20f594d465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3NDcxMg==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r447274712", "bodyText": "Somehow git identifies them as a move. It is supposed to replace BaseSingleColumnSingleValueReaderWriter and BaseSingleColumnMultiValueReaderWriter\nIt extends ForwardIndexReader and ForwardIndexWriter which contains all the read and write api's", "author": "Jackie-Jiang", "createdAt": "2020-06-29T21:50:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY3ODYzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY3ODg0OA==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r446678848", "bodyText": "Is the caller still expected to call these api's with incremental docId? If so, perhaps get rid of the docId arg, and write at current cursor position?", "author": "mayankshriv", "createdAt": "2020-06-28T17:50:43Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/io/readerwriter/impl/FixedByteMVForwardIndexReaderWriter.java", "diffHunk": "@@ -221,102 +222,63 @@ private int updateHeader(int row, int numValues) {\n   }\n \n   @Override\n-  public void setCharArray(int row, char[] charArray) {\n-    int newStartIndex = updateHeader(row, charArray.length);\n-    for (int i = 0; i < charArray.length; i++) {\n-      _currentDataWriter.setChar(newStartIndex + i, 0, charArray[i]);\n-    }\n+  public DataType getValueType() {\n+    // NOTE: Dictionary id is handled as INT type.\n+    // TODO: Currently we only support dictionary-encoded forward index on multi-value columns.\n+    return DataType.INT;\n   }\n \n   @Override\n-  public void setShortArray(int row, short[] shortsArray) {\n+  public boolean isSingleValue() {\n+    return false;\n+  }\n \n-    int newStartIndex = updateHeader(row, shortsArray.length);\n-    for (int i = 0; i < shortsArray.length; i++) {\n-      _currentDataWriter.setShort(newStartIndex + i, 0, shortsArray[i]);\n-    }\n+  @Override\n+  public int getLengthOfShortestElement() {\n+    return _columnSizeInBytes;\n+  }\n+\n+  @Override\n+  public int getLengthOfLongestElement() {\n+    return _columnSizeInBytes;\n   }\n \n   @Override\n-  public void setIntArray(int row, int[] intArray) {\n-    int newStartIndex = updateHeader(row, intArray.length);\n+  public void setIntArray(int docId, int[] intArray) {", "originalCommit": "bedda3240d3dcfdb8995eba48f54ed20f594d465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3OTIwMA==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r447279200", "bodyText": "Good point. Didn't realize we have such assumption. Will update the PR.", "author": "Jackie-Jiang", "createdAt": "2020-06-29T22:01:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY3ODg0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAyMTM1MQ==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r448021351", "bodyText": "For ReaderWriter (CONSUMING segment), we still need the DocId because of the aggregate metrics where values are updated in-place.\nFor Writer, we have the assumption that the value has to be indexed one by one.\nUpdated the PR to have separate APIs for ReaderWriter and Writer, and also added a TODO to merge ForwardIndexWriter into ForwardIndexCreator.", "author": "Jackie-Jiang", "createdAt": "2020-06-30T22:48:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY3ODg0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY3ODk4Mg==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r446678982", "bodyText": "If this is a new interface, why provide default here (as opposed to an abstract base class)?", "author": "mayankshriv", "createdAt": "2020-06-28T17:52:17Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/io/writer/ForwardIndexWriter.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.io.writer;\n+\n+import java.io.Closeable;\n+\n+\n+/**\n+ * Interface for forward index writer.\n+ */\n+public interface ForwardIndexWriter extends Closeable {\n+\n+  /**\n+   * SINGLE-VALUE COLUMN APIs\n+   */\n+\n+  /**\n+   * Writes the INT type single-value into the given document id.\n+   * <p>NOTE: Dictionary id is handled as INT type.\n+   *\n+   * @param docId Document id\n+   * @param value Value to write\n+   */\n+  default void setInt(int docId, int value) {", "originalCommit": "bedda3240d3dcfdb8995eba48f54ed20f594d465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MjQ0OA==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r447282448", "bodyText": "The difference between default methods in interface vs an common abstract base class:\n\nA class cannot extend multiple base classes but can implement multiple interfaces\nThe interface extending this (e.g. ForwardIndexReaderWriter) can automatically get the default implementation\nIMO this is more readable than a common base class that all classes extend", "author": "Jackie-Jiang", "createdAt": "2020-06-29T22:08:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY3ODk4Mg=="}], "type": "inlineReview"}, {"oid": "a01595b95b6a0f0fbab05c9f7f50f4297716e279", "url": "https://github.com/apache/pinot/commit/a01595b95b6a0f0fbab05c9f7f50f4297716e279", "message": "Address comment: Remove the docId from the ForwardIndexWriter", "committedDate": "2020-06-30T22:44:43Z", "type": "forcePushed"}, {"oid": "bfb03c71dc933fec2a389452b399b708680078a0", "url": "https://github.com/apache/pinot/commit/bfb03c71dc933fec2a389452b399b708680078a0", "message": "Address comment: Remove the docId from the ForwardIndexWriter", "committedDate": "2020-06-30T23:25:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MDU3NA==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r448680574", "bodyText": "Why do we need this facade over ForwardIndexReader?\nAlso, this is misleading since ColumnValue implies the actual value in the column whereas if it is passing the call to ForwardIndex, then for dictionary encoded columns you are essentially reading the dictionaryIds which will then be used by DataFetcher to fetch actual values from the dictionary.\nDataFetcher takes care of reading the forward index and if there is dictionary, it then reads the dictionary. So DataFetcher takes care of reading the actual column values in both cases. I don't think we need this.\nDataFetcher should directly use ForwardIndexReader and Dictionary (which it already does)\nHaving this class also adds to the unclear semantics -- should ForwardIndexReader be enough or should we wrap it around ColumnValueReader? For example, we are using ColumnValueReader in PinotSegmentColumnReader but directly using ForwardIndexReader in IndexSegmentUtils", "author": "siddharthteotia", "createdAt": "2020-07-02T00:17:46Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ColumnValueReader.java", "diffHunk": "@@ -0,0 +1,248 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.common;\n+\n+import org.apache.pinot.core.io.reader.ForwardIndexReader;\n+import org.apache.pinot.core.io.reader.ReaderContext;\n+import org.apache.pinot.spi.data.FieldSpec.DataType;\n+\n+\n+/**\n+ * ColumnValueReader is a wrapper class on top of the forward index reader to read values from it.", "originalCommit": "bfb03c71dc933fec2a389452b399b708680078a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MDYyNw==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r448680627", "bodyText": "IMO, we should directly use the ForwardIndexReader here", "author": "siddharthteotia", "createdAt": "2020-07-02T00:17:57Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/DataFetcher.java", "diffHunk": "@@ -21,28 +21,24 @@\n import java.util.Arrays;\n import java.util.HashMap;\n import java.util.Map;\n-import org.apache.pinot.core.operator.docvalsets.MultiValueSet;\n-import org.apache.pinot.core.operator.docvalsets.SingleValueSet;\n import org.apache.pinot.core.plan.DocIdSetPlanNode;\n import org.apache.pinot.core.segment.index.readers.Dictionary;\n \n \n /**\n- * DataFetcher is a higher level abstraction for data fetching. Given an index segment, DataFetcher can manage the\n- * DataSource, Dictionary, BlockValSet and BlockValIterator for this segment, preventing redundant construction for\n- * these instances. DataFetcher can be used by both selection, aggregation and group-by data fetching process, reducing\n- * duplicate codes and garbage collection.\n+ * DataFetcher is a higher level abstraction for data fetching. Given the DataSource, DataFetcher can manage the\n+ * ColumnValueReader and Dictionary for the column, preventing redundant construction for these instances. DataFetcher", "originalCommit": "bfb03c71dc933fec2a389452b399b708680078a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MDY3MQ==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r448680671", "bodyText": "Consider changing to - Base implementation for chunk based single-value raw forward index reader.", "author": "siddharthteotia", "createdAt": "2020-07-02T00:18:12Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/io/reader/impl/BaseChunkSVForwardIndexReader.java", "diffHunk": "@@ -16,27 +16,24 @@\n  * specific language governing permissions and limitations\n  * under the License.\n  */\n-package org.apache.pinot.core.io.reader.impl.v1;\n+package org.apache.pinot.core.io.reader.impl;\n \n import java.io.IOException;\n import java.nio.ByteBuffer;\n import org.apache.pinot.core.io.compression.ChunkCompressorFactory;\n import org.apache.pinot.core.io.compression.ChunkDecompressor;\n-import org.apache.pinot.core.io.reader.BaseSingleColumnSingleValueReader;\n-import org.apache.pinot.core.io.reader.impl.ChunkReaderContext;\n-import org.apache.pinot.core.io.writer.impl.v1.BaseChunkSingleValueWriter;\n+import org.apache.pinot.core.io.reader.ForwardIndexReader;\n+import org.apache.pinot.core.io.writer.impl.BaseChunkSVForwardIndexWriter;\n import org.apache.pinot.core.segment.memory.PinotDataBuffer;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n \n /**\n- * Abstract class implementation for {@link BaseSingleColumnSingleValueReader}.\n- * Base class for the fixed and variable byte reader implementations.\n- *\n+ * Base implementation for chunk based single-value forward index reader.", "originalCommit": "bfb03c71dc933fec2a389452b399b708680078a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MDgwNQ==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r448680805", "bodyText": "For completeness, let's also say raw forward index reader in the javadoc", "author": "siddharthteotia", "createdAt": "2020-07-02T00:18:50Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/io/reader/impl/FixedByteChunkSVForwardIndexReader.java", "diffHunk": "@@ -16,123 +16,117 @@\n  * specific language governing permissions and limitations\n  * under the License.\n  */\n-package org.apache.pinot.core.io.reader.impl.v1;\n+package org.apache.pinot.core.io.reader.impl;\n \n import java.io.IOException;\n import java.nio.ByteBuffer;\n-import org.apache.pinot.core.io.reader.impl.ChunkReaderContext;\n-import org.apache.pinot.core.io.writer.impl.v1.FixedByteChunkSingleValueWriter;\n+import org.apache.pinot.core.io.writer.impl.FixedByteChunkSVForwardIndexWriter;\n import org.apache.pinot.core.segment.memory.PinotDataBuffer;\n+import org.apache.pinot.spi.data.FieldSpec.DataType;\n \n \n /**\n- * Reader class for data written out by {@link FixedByteChunkSingleValueWriter}.\n- * For data layout, please refer to the documentation for {@link FixedByteChunkSingleValueReader}\n+ * Reader class for data written out by {@link FixedByteChunkSVForwardIndexWriter}.", "originalCommit": "bfb03c71dc933fec2a389452b399b708680078a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MTA3OA==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r448681078", "bodyText": "This doesn't sound good. Why are we adding it now if we already know it will be deleted in the future?\nOn that note, why do we need ForwardIndexCreator and ForwardIndexWriter? We might as well use the writer directly. The segment generation code instantiates creators -> creators instantiate writer. Can we just use writer or one of them whichever is suitable?", "author": "siddharthteotia", "createdAt": "2020-07-02T00:19:42Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/io/writer/ForwardIndexWriter.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.io.writer;\n+\n+import java.io.Closeable;\n+\n+\n+/**\n+ * Interface for forward index writer.\n+ * <p>TODO: Remove this interface and merge the writer implementations into the ForwardIndexCreator implementations.", "originalCommit": "bfb03c71dc933fec2a389452b399b708680078a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MTEwNQ==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r448681105", "bodyText": "Consider adding \"raw\"  -- Base implementation for chunk based single-value raw forward index writer.", "author": "siddharthteotia", "createdAt": "2020-07-02T00:19:48Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/BaseChunkSVForwardIndexWriter.java", "diffHunk": "@@ -27,21 +27,20 @@\n import java.nio.channels.FileChannel;\n import org.apache.pinot.core.io.compression.ChunkCompressor;\n import org.apache.pinot.core.io.compression.ChunkCompressorFactory;\n-import org.apache.pinot.core.io.writer.SingleColumnSingleValueWriter;\n+import org.apache.pinot.core.io.writer.ForwardIndexWriter;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n \n /**\n- * Abstract implementation for {@link SingleColumnSingleValueWriter}\n- * Base class for fixed and variable byte writer implementations.\n+ * Base implementation for chunk based single-value forward index writer.", "originalCommit": "bfb03c71dc933fec2a389452b399b708680078a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MTEyNQ==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r448681125", "bodyText": "Why not just change the name of existing file FixedBitSingleValueWriter and remove all the unsupported operations. ? You are already doing that for FixedBitMVForwardIndexWriter which was originally FixedBitMultiValueWriter", "author": "siddharthteotia", "createdAt": "2020-07-02T00:19:52Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/FixedBitSVForwardIndexWriter.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.io.writer.impl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.ByteOrder;\n+import org.apache.pinot.core.io.util.FixedBitIntReaderWriter;\n+import org.apache.pinot.core.io.writer.ForwardIndexWriter;\n+import org.apache.pinot.core.segment.memory.PinotDataBuffer;\n+\n+\n+/**\n+ * Bit-compressed dictionary-encoded forward index writer for single-value columns. The values written are dictionary\n+ * ids.\n+ */\n+public class FixedBitSVForwardIndexWriter implements ForwardIndexWriter {", "originalCommit": "bfb03c71dc933fec2a389452b399b708680078a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI0MzQ4Mw==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r449243483", "bodyText": "I don't quite follow. FixedBitSingleValueWriter is already renamed to FixedBitSVForwardIndexWriter", "author": "Jackie-Jiang", "createdAt": "2020-07-02T20:11:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMzMjk1NA==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r450332954", "bodyText": "I was suggesting that instead of deleting FixedBitSingleValueReader and creating FixedBitSVForwardIndexReader, you can just rename the file  (and do the cleanup) since you have followed this process for FixedBitMultiValueReader. You have renamed it instead of deleting and creating a new file. Same is applicable for FixdBitSvForwardIndexWriter.", "author": "siddharthteotia", "createdAt": "2020-07-06T16:16:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM4MDQzOA==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r450380438", "bodyText": "That is what I did actually, but git might identify it as a new file because the percentage of change is high (the class itself is fairly small)", "author": "Jackie-Jiang", "createdAt": "2020-07-06T17:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MTEyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MTE3NQ==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r448681175", "bodyText": "Add a comment stating only dictionary encoded MV columns are supported", "author": "siddharthteotia", "createdAt": "2020-07-02T00:20:03Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/creator/ForwardIndexCreator.java", "diffHunk": "@@ -19,7 +19,105 @@\n package org.apache.pinot.core.segment.creator;\n \n import java.io.Closeable;\n+import org.apache.pinot.spi.data.FieldSpec;\n \n \n+/**\n+ * Interface for forward index creator.\n+ */\n public interface ForwardIndexCreator extends Closeable {\n+\n+  /**\n+   * Returns the data type of the values in the forward index.\n+   * <p>NOTE: Dictionary id is handled as INT type.\n+   */\n+  FieldSpec.DataType getValueType();\n+\n+  /**\n+   * Returns {@code true} if the forward index is for a single-value column, {@code false} otherwise.\n+   */\n+  boolean isSingleValue();\n+\n+  /**\n+   * SINGLE-VALUE COLUMN APIs\n+   */\n+\n+  /**\n+   * Indexes the next INT type single-value into the forward index.\n+   * <p>NOTE: Dictionary id is handled as INT type.\n+   *\n+   * @param value Value to index\n+   */\n+  default void index(int value) {\n+    throw new UnsupportedOperationException();\n+  }\n+\n+  /**\n+   * Indexes the next LONG type single-value into the forward index.\n+   *\n+   * @param value Value to index\n+   */\n+  default void index(long value) {\n+    throw new UnsupportedOperationException();\n+  }\n+\n+  /**\n+   * Indexes the next FLOAT type single-value into the forward index.\n+   *\n+   * @param value Value to index\n+   */\n+  default void index(float value) {\n+    throw new UnsupportedOperationException();\n+  }\n+\n+  /**\n+   * Indexes the next DOUBLE type single-value into the forward index.\n+   *\n+   * @param value Value to index\n+   */\n+  default void index(double value) {\n+    throw new UnsupportedOperationException();\n+  }\n+\n+  /**\n+   * Indexes the next STRING type single-value into the forward index.\n+   *\n+   * @param value Value to index\n+   */\n+  default void index(String value) {\n+    throw new UnsupportedOperationException();\n+  }\n+\n+  /**\n+   * Indexes the next BYTES type single-value into the forward index.\n+   *\n+   * @param value Value to index\n+   */\n+  default void index(byte[] value) {\n+    throw new UnsupportedOperationException();\n+  }\n+\n+  /**\n+   * Indexes the next raw single-value (not dictionary id) into the forward index. The given value should be of the\n+   * forward index value type.\n+   *\n+   * @param value Value to index\n+   */\n+  default void index(Object value) {\n+    throw new UnsupportedOperationException();\n+  }\n+\n+  /**\n+   * MULTI-VALUE COLUMN APIs", "originalCommit": "bfb03c71dc933fec2a389452b399b708680078a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MTIxOA==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r448681218", "bodyText": "Can we add APIs for each raw value type so that this interface can also be used for non dictionary based inverted indexes? With the current change, we can probably still do but the raw value has to be converted to string?", "author": "siddharthteotia", "createdAt": "2020-07-02T00:20:09Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/readers/InvertedIndexReader.java", "diffHunk": "@@ -24,13 +24,14 @@\n public interface InvertedIndexReader<T> extends Closeable {\n \n   /**\n-   * Get the document ids for the given dictionary id.\n-   * @param dictId dictionary ID\n+   * Returns the document ids for the given dictionary id.\n    */\n   T getDocIds(int dictId);\n \n   /**\n-   * Get the document ids for a given value\n+   * Returns the document ids for the given string representation of the value.", "originalCommit": "bfb03c71dc933fec2a389452b399b708680078a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI0NTU1MQ==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r449245551", "bodyText": "The value here is from the query, so we always pass it in as string, and the inverted index implementation can parse the string based on the value type. This is similar to how dictionary handles the lookup of user input value (Dictionary.indexOf(String stringValue)).", "author": "Jackie-Jiang", "createdAt": "2020-07-02T20:16:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MTIxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MTI4Nw==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r448681287", "bodyText": "This test was for fixed length bytes which for some reason FixedByteChunk writer also supported.", "author": "siddharthteotia", "createdAt": "2020-07-02T00:20:20Z", "path": "pinot-core/src/test/java/org/apache/pinot/index/readerwriter/FixedByteChunkSVForwardIndexReaderWriterTest.java", "diffHunk": "@@ -276,56 +257,6 @@ public void testDouble(ChunkCompressorFactory.CompressionType compressionType)\n     FileUtils.deleteQuietly(outFileEightByte);\n   }\n \n-  public void testBytes(ChunkCompressorFactory.CompressionType compressionType)", "originalCommit": "bfb03c71dc933fec2a389452b399b708680078a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI0ODMxNg==", "url": "https://github.com/apache/pinot/pull/5625#discussion_r449248316", "bodyText": "It can be supported, but is never used. STRING and BYTES are always handled as var-bytes (we don't have the metadata to denote whether a column is fixed-bytes or var-bytes).", "author": "Jackie-Jiang", "createdAt": "2020-07-02T20:23:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MTI4Nw=="}], "type": "inlineReview"}, {"oid": "4159c0e2cf9ca8cdf47bbf788e720f8486d2b0fe", "url": "https://github.com/apache/pinot/commit/4159c0e2cf9ca8cdf47bbf788e720f8486d2b0fe", "message": "Address comments:\n- Remove ColumnValueReader\n- Make ForwardIndexReaderContext closeable to release resource\n- Remove ForwardIndexWriter", "committedDate": "2020-07-06T05:48:56Z", "type": "forcePushed"}, {"oid": "835d5b4a9c866c7031e64116648c64921da188f7", "url": "https://github.com/apache/pinot/commit/835d5b4a9c866c7031e64116648c64921da188f7", "message": "Make DataSource independent of query execution (not extend Operator)\n\nMotivation:\nCurrently DataSource is modeled as an Operator, where values are returned\nas a block complying with the Operator interface. This is confusing because\nof the following reasons:\n- The block contains all the documents in the segment, instead of a block\n  of at most 10000 documents as in the Projection layer.\n- The values are always fetched with their document ids, instead of fetched\n  as a block. Currently BlockValSet interface has 2 set of APIs because of\n  this, which is confusing.\n- The BlockValSet returned by the DataSource is not really a value set, but\n  a value reader on top of the forward index.\n- Extra BlockMetadata has to be maintained which can cause unexpected\n  problems (e.g. the issue fixed in #5619)\n\nChanges:\n- Make DataSource standalong without implementing Operator\n- Add interfaces for forward index (ForwardIndexReader, ForwardIndexWriter,\n  ForwardIndexReaderWriter)\n- Add ColumnValueReader class to help read forward index from DataSource\n- Remove the docId based APIs from BlockValSet", "committedDate": "2020-07-06T17:55:34Z", "type": "commit"}, {"oid": "cf30535623fb42abc85830b33d8ca189ffce823e", "url": "https://github.com/apache/pinot/commit/cf30535623fb42abc85830b33d8ca189ffce823e", "message": "Address comment: Remove the docId from the ForwardIndexWriter", "committedDate": "2020-07-06T17:55:39Z", "type": "commit"}, {"oid": "2e397329637a7ffb067f16a2a5075723528ca6d5", "url": "https://github.com/apache/pinot/commit/2e397329637a7ffb067f16a2a5075723528ca6d5", "message": "Address comments:\n- Remove ColumnValueReader\n- Make ForwardIndexReaderContext closeable to release resource\n- Remove ForwardIndexWriter", "committedDate": "2020-07-06T17:56:12Z", "type": "commit"}, {"oid": "2e397329637a7ffb067f16a2a5075723528ca6d5", "url": "https://github.com/apache/pinot/commit/2e397329637a7ffb067f16a2a5075723528ca6d5", "message": "Address comments:\n- Remove ColumnValueReader\n- Make ForwardIndexReaderContext closeable to release resource\n- Remove ForwardIndexWriter", "committedDate": "2020-07-06T17:56:12Z", "type": "forcePushed"}]}