{"pr_number": 6326, "pr_title": "pinot-controller unit test suite.", "pr_createdAt": "2020-12-07T06:25:34Z", "pr_url": "https://github.com/apache/pinot/pull/6326", "timeline": [{"oid": "3ba6943d77a095cd04faf996eb0770786d309dc0", "url": "https://github.com/apache/pinot/commit/3ba6943d77a095cd04faf996eb0770786d309dc0", "message": "create initial test suite.", "committedDate": "2020-11-25T05:56:45Z", "type": "commit"}, {"oid": "7ef4936c9b731f42fbb7b9ff27bb9354bd88be2c", "url": "https://github.com/apache/pinot/commit/7ef4936c9b731f42fbb7b9ff27bb9354bd88be2c", "message": "Move startController() into @BeforeSuite function.", "committedDate": "2020-11-28T01:37:15Z", "type": "commit"}, {"oid": "4645cfeb1ededdfb318dd688c25fdf041b01174c", "url": "https://github.com/apache/pinot/commit/4645cfeb1ededdfb318dd688c25fdf041b01174c", "message": "move addFakeXXXInstanceToAutoJoinHelixCluster calls to suiteSetup.", "committedDate": "2020-11-28T06:55:12Z", "type": "commit"}, {"oid": "134cf5c50d7301835800db2e9d6d0619e0c2655c", "url": "https://github.com/apache/pinot/commit/134cf5c50d7301835800db2e9d6d0619e0c2655c", "message": "Fully working (few test cases disabled + cleanup neeeded)", "committedDate": "2020-11-28T22:37:07Z", "type": "commit"}, {"oid": "785107d559845f67c3dca22ee1236f93e76318f0", "url": "https://github.com/apache/pinot/commit/785107d559845f67c3dca22ee1236f93e76318f0", "message": "All testcases (except two) enabled", "committedDate": "2020-11-29T08:15:50Z", "type": "commit"}, {"oid": "9296872b39c49ab54e5b63bf10cfe05178322974", "url": "https://github.com/apache/pinot/commit/9296872b39c49ab54e5b63bf10cfe05178322974", "message": "cleanup", "committedDate": "2020-11-30T02:43:50Z", "type": "commit"}, {"oid": "982c384ee9d941e40dbfde83f951abffadff784d", "url": "https://github.com/apache/pinot/commit/982c384ee9d941e40dbfde83f951abffadff784d", "message": "cleanup.", "committedDate": "2020-11-30T03:47:04Z", "type": "commit"}, {"oid": "e7fd00d5e2fb6cd14231863ff1e71698b2b23e4f", "url": "https://github.com/apache/pinot/commit/e7fd00d5e2fb6cd14231863ff1e71698b2b23e4f", "message": "cleanup", "committedDate": "2020-11-30T03:48:27Z", "type": "commit"}, {"oid": "3e8e952c1782cea92f9c59426297e407ecd6f82b", "url": "https://github.com/apache/pinot/commit/3e8e952c1782cea92f9c59426297e407ecd6f82b", "message": "cleanup.", "committedDate": "2020-11-30T20:33:00Z", "type": "commit"}, {"oid": "fa6644a2880b7f63b157f83650287abd9b6be84f", "url": "https://github.com/apache/pinot/commit/fa6644a2880b7f63b157f83650287abd9b6be84f", "message": "cleanup", "committedDate": "2020-12-01T02:46:50Z", "type": "commit"}, {"oid": "743068e139e82d94c11bdd95c0f45499427abf5c", "url": "https://github.com/apache/pinot/commit/743068e139e82d94c11bdd95c0f45499427abf5c", "message": "cleanup + allow running single tests + validation and cleanup functions.", "committedDate": "2020-12-01T05:31:05Z", "type": "commit"}, {"oid": "2a86a79b7e33a2b831ff67fcd251a75942d01faa", "url": "https://github.com/apache/pinot/commit/2a86a79b7e33a2b831ff67fcd251a75942d01faa", "message": "fix license header.", "committedDate": "2020-12-01T06:12:00Z", "type": "commit"}, {"oid": "5965fb4aa92cdf63d705e388632d495a62a0bca7", "url": "https://github.com/apache/pinot/commit/5965fb4aa92cdf63d705e388632d495a62a0bca7", "message": "comments for disabled test cases.", "committedDate": "2020-12-01T06:58:27Z", "type": "commit"}, {"oid": "92e640223fa6093ff3c43b457829b5cd44a0fde8", "url": "https://github.com/apache/pinot/commit/92e640223fa6093ff3c43b457829b5cd44a0fde8", "message": "cleanup", "committedDate": "2020-12-01T17:44:06Z", "type": "commit"}, {"oid": "6ead207cf7196e94dd6b419b905cd042bdcc7072", "url": "https://github.com/apache/pinot/commit/6ead207cf7196e94dd6b419b905cd042bdcc7072", "message": "testng.xml configuration file for running test cases as part of a suite.", "committedDate": "2020-12-01T20:10:59Z", "type": "commit"}, {"oid": "b988df124a0348067010f65c6b24d80c59a13896", "url": "https://github.com/apache/pinot/commit/b988df124a0348067010f65c6b24d80c59a13896", "message": "cleanup", "committedDate": "2020-12-01T20:17:50Z", "type": "commit"}, {"oid": "5fc65fb7b8672256e6c309df27653148af43d7d9", "url": "https://github.com/apache/pinot/commit/5fc65fb7b8672256e6c309df27653148af43d7d9", "message": "cleanup", "committedDate": "2020-12-01T20:45:27Z", "type": "commit"}, {"oid": "c8d2daa682947e9d688a567bdfdfac56020dccab", "url": "https://github.com/apache/pinot/commit/c8d2daa682947e9d688a567bdfdfac56020dccab", "message": "cleanup.", "committedDate": "2020-12-01T22:22:34Z", "type": "commit"}, {"oid": "1f80e103d7780728b2bb2a3cbe7c50a17f97352d", "url": "https://github.com/apache/pinot/commit/1f80e103d7780728b2bb2a3cbe7c50a17f97352d", "message": "redo checks.", "committedDate": "2020-12-02T01:34:32Z", "type": "commit"}, {"oid": "04c8e1f69b1a24fcf2e9f287ab1d617b6e06a872", "url": "https://github.com/apache/pinot/commit/04c8e1f69b1a24fcf2e9f287ab1d617b6e06a872", "message": "Merge branch 'master' of https://github.com/apache/incubator-pinot", "committedDate": "2020-12-02T02:14:13Z", "type": "commit"}, {"oid": "eae2a3d99d3ef132e401bf53f96931d969e240f8", "url": "https://github.com/apache/pinot/commit/eae2a3d99d3ef132e401bf53f96931d969e240f8", "message": "update new test case.", "committedDate": "2020-12-02T02:43:12Z", "type": "commit"}, {"oid": "d056e73085f919099b0477c386651a877b6c4641", "url": "https://github.com/apache/pinot/commit/d056e73085f919099b0477c386651a877b6c4641", "message": "redo checks.", "committedDate": "2020-12-02T03:31:07Z", "type": "commit"}, {"oid": "baa2f022e5ba37c950016762b69abc8ad4a5c601", "url": "https://github.com/apache/pinot/commit/baa2f022e5ba37c950016762b69abc8ad4a5c601", "message": "extra messages in ZKOperatorTest + 2 second delay.", "committedDate": "2020-12-02T21:49:17Z", "type": "commit"}, {"oid": "06b01741211fd8ee9c3661293043f30d8c13a877", "url": "https://github.com/apache/pinot/commit/06b01741211fd8ee9c3661293043f30d8c13a877", "message": "set 1 second delay for EXTERNALVIEW to catchup.", "committedDate": "2020-12-02T22:45:56Z", "type": "commit"}, {"oid": "5dfe00c6d87cc58c9ee7801ddb1faa92f3e17e97", "url": "https://github.com/apache/pinot/commit/5dfe00c6d87cc58c9ee7801ddb1faa92f3e17e97", "message": "1 second delay to allow EXTERNALVIEW to get updated.", "committedDate": "2020-12-02T22:50:58Z", "type": "commit"}, {"oid": "ac05fe960b9cb894dd8b1a4f41bf3b0985135a66", "url": "https://github.com/apache/pinot/commit/ac05fe960b9cb894dd8b1a4f41bf3b0985135a66", "message": "1 second delay to allow EXTERNALVIEW to get updated.", "committedDate": "2020-12-02T22:53:00Z", "type": "commit"}, {"oid": "7e83dba89b3084a03f0906c7810873d56800dc0a", "url": "https://github.com/apache/pinot/commit/7e83dba89b3084a03f0906c7810873d56800dc0a", "message": "code formatting.", "committedDate": "2020-12-03T00:12:33Z", "type": "commit"}, {"oid": "abd8b49b3e9f4fac7428282cf9bfe43d57adc931", "url": "https://github.com/apache/pinot/commit/abd8b49b3e9f4fac7428282cf9bfe43d57adc931", "message": "Merge branch 'master' into unit-test-suite", "committedDate": "2020-12-05T20:32:53Z", "type": "commit"}, {"oid": "62030ef8eaf4f1cb4da3c97d8a2a1e8216e69f8c", "url": "https://github.com/apache/pinot/commit/62030ef8eaf4f1cb4da3c97d8a2a1e8216e69f8c", "message": "Fix TODOs and enable all tests.", "committedDate": "2020-12-07T05:49:52Z", "type": "commit"}, {"oid": "180aac1cb730eb5e95507e5739877aa4686bc85a", "url": "https://github.com/apache/pinot/commit/180aac1cb730eb5e95507e5739877aa4686bc85a", "message": "cleanup", "committedDate": "2020-12-07T06:38:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4OTM4Mg==", "url": "https://github.com/apache/pinot/pull/6326#discussion_r541089382", "bodyText": "Nit: s/leadTable/leadControllerTestTable?", "author": "mayankshriv", "createdAt": "2020-12-11T16:57:23Z", "path": "pinot-controller/src/test/java/org/apache/pinot/controller/LeadControllerManagerTest.java", "diffHunk": "@@ -73,7 +73,7 @@ public void setup() {\n   @Test\n   public void testLeadControllerManager() {\n     LeadControllerManager leadControllerManager = new LeadControllerManager(_helixManager, _controllerMetrics);\n-    String tableName = \"testTable\";\n+    String tableName = \"leadTable\";", "originalCommit": "180aac1cb730eb5e95507e5739877aa4686bc85a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjExMzQwOA==", "url": "https://github.com/apache/pinot/pull/6326#discussion_r542113408", "bodyText": "Fixed.", "author": "amrishlal", "createdAt": "2020-12-14T05:02:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA4OTM4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MDA1Mg==", "url": "https://github.com/apache/pinot/pull/6326#discussion_r541090052", "bodyText": "Lets avoid static import, if possible.", "author": "mayankshriv", "createdAt": "2020-12-11T16:58:24Z", "path": "pinot-controller/src/test/java/org/apache/pinot/controller/api/AccessControlTest.java", "diffHunk": "@@ -19,49 +19,40 @@\n package org.apache.pinot.controller.api;\n \n import java.io.IOException;\n-import java.util.Map;\n-\n-import org.apache.pinot.controller.ControllerConf;\n import org.apache.pinot.controller.api.access.AccessControl;\n import org.apache.pinot.controller.api.access.AccessControlFactory;\n-import org.apache.pinot.controller.helix.ControllerTest;\n import org.testng.Assert;\n import org.testng.annotations.AfterClass;\n import org.testng.annotations.BeforeClass;\n import org.testng.annotations.Test;\n \n+import static org.apache.pinot.controller.ControllerTestUtils.*;", "originalCommit": "180aac1cb730eb5e95507e5739877aa4686bc85a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjExMzY4Mg==", "url": "https://github.com/apache/pinot/pull/6326#discussion_r542113682", "bodyText": "Fixed all such cases.", "author": "amrishlal", "createdAt": "2020-12-14T05:03:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MDA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MDM5NQ==", "url": "https://github.com/apache/pinot/pull/6326#discussion_r541090395", "bodyText": "Same here, and other such cases.", "author": "mayankshriv", "createdAt": "2020-12-11T16:58:55Z", "path": "pinot-controller/src/test/java/org/apache/pinot/controller/api/PinotInstanceAssignmentRestletResourceTest.java", "diffHunk": "@@ -23,77 +23,67 @@\n import java.util.Collections;\n import java.util.Map;\n import java.util.TreeMap;\n-import java.util.concurrent.TimeUnit;\n import org.apache.pinot.common.assignment.InstancePartitions;\n import org.apache.pinot.common.utils.config.TagNameUtils;\n-import org.apache.pinot.controller.ControllerConf;\n-import org.apache.pinot.controller.helix.ControllerTest;\n import org.apache.pinot.core.realtime.impl.fakestream.FakeStreamConfigUtils;\n import org.apache.pinot.spi.config.table.TableConfig;\n import org.apache.pinot.spi.config.table.TableType;\n-import org.apache.pinot.spi.config.tenant.Tenant;\n-import org.apache.pinot.spi.config.tenant.TenantRole;\n import org.apache.pinot.spi.config.table.assignment.InstanceAssignmentConfig;\n import org.apache.pinot.spi.config.table.assignment.InstancePartitionsType;\n import org.apache.pinot.spi.config.table.assignment.InstanceReplicaGroupPartitionConfig;\n import org.apache.pinot.spi.config.table.assignment.InstanceTagPoolConfig;\n-import org.apache.pinot.spi.data.FieldSpec;\n+import org.apache.pinot.spi.config.tenant.Tenant;\n+import org.apache.pinot.spi.config.tenant.TenantRole;\n import org.apache.pinot.spi.data.FieldSpec.DataType;\n import org.apache.pinot.spi.data.Schema;\n-import org.apache.pinot.spi.data.TimeGranularitySpec;\n import org.apache.pinot.spi.utils.JsonUtils;\n import org.apache.pinot.spi.utils.builder.TableConfigBuilder;\n import org.apache.pinot.spi.utils.builder.TableNameBuilder;\n import org.testng.annotations.AfterClass;\n import org.testng.annotations.BeforeClass;\n import org.testng.annotations.Test;\n \n-import static org.testng.Assert.assertEquals;\n-import static org.testng.Assert.assertNotNull;\n-import static org.testng.Assert.assertTrue;\n-import static org.testng.Assert.fail;\n+import static org.apache.pinot.controller.ControllerTestUtils.*;", "originalCommit": "180aac1cb730eb5e95507e5739877aa4686bc85a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjExMzcwNw==", "url": "https://github.com/apache/pinot/pull/6326#discussion_r542113707", "bodyText": "Fixed all such cases.", "author": "amrishlal", "createdAt": "2020-12-14T05:04:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MDM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MzY0OA==", "url": "https://github.com/apache/pinot/pull/6326#discussion_r541093648", "bodyText": "This is somewhat confusing to read - why does setup() call something named validate(), instead of setting up the cluster? One has to go to inside validate() to figure out what is going.\nPerhaps it can be named setupClusterAndValidate(), or something more readable?", "author": "mayankshriv", "createdAt": "2020-12-11T17:04:03Z", "path": "pinot-controller/src/test/java/org/apache/pinot/controller/api/AccessControlTest.java", "diffHunk": "@@ -19,49 +19,40 @@\n package org.apache.pinot.controller.api;\n \n import java.io.IOException;\n-import java.util.Map;\n-\n-import org.apache.pinot.controller.ControllerConf;\n import org.apache.pinot.controller.api.access.AccessControl;\n import org.apache.pinot.controller.api.access.AccessControlFactory;\n-import org.apache.pinot.controller.helix.ControllerTest;\n import org.testng.Assert;\n import org.testng.annotations.AfterClass;\n import org.testng.annotations.BeforeClass;\n import org.testng.annotations.Test;\n \n+import static org.apache.pinot.controller.ControllerTestUtils.*;\n \n-public class AccessControlTest extends ControllerTest {\n \n-  @BeforeClass\n-  public void setUp() {\n-    startZk();\n-    \n-    Map<String, Object> properties = getDefaultControllerConfiguration();\n-    properties.put(ControllerConf.ACCESS_CONTROL_FACTORY_CLASS, DenyAllAccessFactory.class.getName());\n+public class AccessControlTest {\n+\n+  private static final String TABLE_NAME = \"accessTestTable\";\n \n-    startController(properties);\n+  @BeforeClass\n+  public void setUp() throws Exception {\n+    validate();", "originalCommit": "180aac1cb730eb5e95507e5739877aa4686bc85a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjExMzc1Mg==", "url": "https://github.com/apache/pinot/pull/6326#discussion_r542113752", "bodyText": "Fixed.", "author": "amrishlal", "createdAt": "2020-12-14T05:04:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5MzY0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5NDYyOQ==", "url": "https://github.com/apache/pinot/pull/6326#discussion_r541094629", "bodyText": "old not a great name :-(. Perhaps name according to what characteristic classifies the test to be in one suite over the other? Same with the name of xml file (testng-old-test.xml).", "author": "mayankshriv", "createdAt": "2020-12-11T17:05:39Z", "path": "pinot-controller/testng-old-tests.xml", "diffHunk": "@@ -0,0 +1,38 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!DOCTYPE suite SYSTEM \"http://testng.org/testng-1.0.dtd\" >\n+<!--\n+\n+    Licensed to the Apache Software Foundation (ASF) under one\n+    or more contributor license agreements.  See the NOTICE file\n+    distributed with this work for additional information\n+    regarding copyright ownership.  The ASF licenses this file\n+    to you under the Apache License, Version 2.0 (the\n+    \"License\"); you may not use this file except in compliance\n+    with the License.  You may obtain a copy of the License at\n+\n+      http://www.apache.org/licenses/LICENSE-2.0\n+\n+    Unless required by applicable law or agreed to in writing,\n+    software distributed under the License is distributed on an\n+    \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+    KIND, either express or implied.  See the License for the\n+    specific language governing permissions and limitations\n+    under the License.\n+\n+-->\n+<suite name=\"testng.suite-controller-old\">", "originalCommit": "180aac1cb730eb5e95507e5739877aa4686bc85a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjExNDI2Nw==", "url": "https://github.com/apache/pinot/pull/6326#discussion_r542114267", "bodyText": "Renamed to:\ntestng-statefull.xml for test cases that use shared state.\ntestng-stateless.xml for testcases that create and destroy their own state.", "author": "amrishlal", "createdAt": "2020-12-14T05:05:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5NDYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5NDgzMQ==", "url": "https://github.com/apache/pinot/pull/6326#discussion_r541094831", "bodyText": "Some comment on why this upgrade was need would be good.", "author": "mayankshriv", "createdAt": "2020-12-11T17:06:02Z", "path": "pom.xml", "diffHunk": "@@ -1095,7 +1095,7 @@\n       <dependency>\n         <groupId>org.apache.maven.surefire</groupId>\n         <artifactId>surefire-testng</artifactId>\n-        <version>2.19</version>\n+        <version>3.0.0-M5</version>", "originalCommit": "180aac1cb730eb5e95507e5739877aa4686bc85a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjExNjE5Nw==", "url": "https://github.com/apache/pinot/pull/6326#discussion_r542116197", "bodyText": "I modified pinot-controller.pom to configure the two test suites under pinot-controller. After this, mvn test would lead to all pinot-controller test cases running twice. Changing configuration settings did not seem to be working, so I tried upgrading to latest version (3.0.0-M5) and that fixed the problem. It seems like the earlier version has a bug that causes testsuites to run twice.", "author": "amrishlal", "createdAt": "2020-12-14T05:12:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5NDgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU0NzU0Mg==", "url": "https://github.com/apache/pinot/pull/6326#discussion_r542547542", "bodyText": "Thanks, please add it in the description of the PR, as well as a short description in the pom file itself (can link to the PR description).", "author": "mayankshriv", "createdAt": "2020-12-14T17:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5NDgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzAzNzYxNA==", "url": "https://github.com/apache/pinot/pull/6326#discussion_r543037614", "bodyText": "Done.", "author": "amrishlal", "createdAt": "2020-12-15T04:29:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5NDgzMQ=="}], "type": "inlineReview"}, {"oid": "5b356e6333fb832e8033dc976a2e856366821f74", "url": "https://github.com/apache/pinot/commit/5b356e6333fb832e8033dc976a2e856366821f74", "message": "codereview changes.", "committedDate": "2020-12-14T05:01:44Z", "type": "commit"}, {"oid": "8e49dda60905ae1127f3b48e44af4c07ffd20c86", "url": "https://github.com/apache/pinot/commit/8e49dda60905ae1127f3b48e44af4c07ffd20c86", "message": "comment on maven-surefire-plugin version number upgrade.", "committedDate": "2020-12-15T04:29:03Z", "type": "commit"}]}