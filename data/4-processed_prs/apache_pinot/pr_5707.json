{"pr_number": 5707, "pr_title": "Allow Pinot to accept query with FROM clause in the format of [database].[table]", "pr_createdAt": "2020-07-15T09:59:26Z", "pr_url": "https://github.com/apache/pinot/pull/5707", "timeline": [{"oid": "d2f709aadd038785cd04f9d5e7d49353fcdbda82", "url": "https://github.com/apache/pinot/commit/d2f709aadd038785cd04f9d5e7d49353fcdbda82", "message": "Allow Pinot to accept query with FROM clause in the format of [database].[table]", "committedDate": "2020-07-15T09:52:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI0NjE2MQ==", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455246161", "bodyText": "Should this be done in PinotQuery2BrokerRequestConverter?", "author": "mayankshriv", "createdAt": "2020-07-15T18:11:32Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,46 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {", "originalCommit": "d2f709aadd038785cd04f9d5e7d49353fcdbda82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI1ODA5Nw==", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455258097", "bodyText": "I wish I could do that!\nHere we don't have any information of existing table names as we are allowing dot in table name.", "author": "xiangfu0", "createdAt": "2020-07-15T18:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI0NjE2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI5MTYwOA==", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455291608", "bodyText": "Also I feel that we should introduce the concept that no dot is allowed in table name/column name.\nI'm not sure if anyone is using dot in table name, but it's definitely some users are using dot in column name.", "author": "xiangfu0", "createdAt": "2020-07-15T19:30:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI0NjE2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM5ODM1NA==", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455398354", "bodyText": "Avoid regex match\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String[] querySourceSplits = tableName.split(\"\\\\.\", 2);\n          \n          \n            \n                String[] tableNameSplits = StringUtils.split(tableName, '.');", "author": "Jackie-Jiang", "createdAt": "2020-07-15T22:20:50Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,46 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {\n+    String tableName = brokerRequest.getQuerySource().getTableName();\n+    // Check if table is in the format of [database_name].[table_name]\n+    String[] querySourceSplits = tableName.split(\"\\\\.\", 2);", "originalCommit": "d2f709aadd038785cd04f9d5e7d49353fcdbda82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM5OTg1MA==", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455399850", "bodyText": "Suggest renaming to containsTable()", "author": "Jackie-Jiang", "createdAt": "2020-07-15T22:24:43Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/helix/TableCache.java", "diffHunk": "@@ -67,6 +67,10 @@ public String getActualTableName(String tableName) {\n     return _tableConfigChangeListener._tableNameMap.getOrDefault(tableName.toLowerCase(), tableName);\n   }\n \n+  public boolean existTableName(String tableName) {", "originalCommit": "d2f709aadd038785cd04f9d5e7d49353fcdbda82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwMTgzMw==", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455401833", "bodyText": "Use 2 if checks to prevent using RoutingManager for case insensitive table\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (_enableCaseInsensitive && _tableCache.existTableName(querySourceSplits[1]) && !_tableCache\n          \n          \n            \n                    .existTableName(tableName)) {\n          \n          \n            \n                  // Use TableCache to check case insensitive table name.\n          \n          \n            \n                  brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n                if (_enableCaseInsensitive) {\n          \n          \n            \n                  // Use TableCache to check case insensitive table name.\n          \n          \n            \n                  if (_tableCache.existTableName(querySourceSplits[1]) && !_tableCache.existTableName(tableName)) {\n          \n          \n            \n                    brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n          \n          \n            \n                  }\n          \n          \n            \n                  return;\n          \n          \n            \n                }", "author": "Jackie-Jiang", "createdAt": "2020-07-15T22:29:35Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,46 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {\n+    String tableName = brokerRequest.getQuerySource().getTableName();\n+    // Check if table is in the format of [database_name].[table_name]\n+    String[] querySourceSplits = tableName.split(\"\\\\.\", 2);\n+    if (querySourceSplits.length != 2) {\n+      return;\n+    }\n+    // Update table name if there is no existing table in the format of [database_name].[table_name] but only [table_name]\n+    if (_enableCaseInsensitive && _tableCache.existTableName(querySourceSplits[1]) && !_tableCache\n+        .existTableName(tableName)) {\n+      // Use TableCache to check case insensitive table name.\n+      brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n+      return;\n+    }", "originalCommit": "d2f709aadd038785cd04f9d5e7d49353fcdbda82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwMjc4NA==", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455402784", "bodyText": "Similarly here\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (tableType != null && _routingManager.routingExists(querySourceSplits[1]) && !_routingManager\n          \n          \n            \n                    .routingExists(tableName)) {\n          \n          \n            \n                  brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n          \n          \n            \n                  return;\n          \n          \n            \n                }\n          \n          \n            \n                if (TableNameBuilder.isTableResource(tableName)) {\n          \n          \n            \n                  if (_routingManager.routingExists(querySourceSplits[1]) && !_routingManager.routingExists(tableName)) {\n          \n          \n            \n                    brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n          \n          \n            \n                  }\n          \n          \n            \n                  return;\n          \n          \n            \n                }", "author": "Jackie-Jiang", "createdAt": "2020-07-15T22:32:16Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,46 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {\n+    String tableName = brokerRequest.getQuerySource().getTableName();\n+    // Check if table is in the format of [database_name].[table_name]\n+    String[] querySourceSplits = tableName.split(\"\\\\.\", 2);\n+    if (querySourceSplits.length != 2) {\n+      return;\n+    }\n+    // Update table name if there is no existing table in the format of [database_name].[table_name] but only [table_name]\n+    if (_enableCaseInsensitive && _tableCache.existTableName(querySourceSplits[1]) && !_tableCache\n+        .existTableName(tableName)) {\n+      // Use TableCache to check case insensitive table name.\n+      brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n+      return;\n+    }\n+    // Use RoutingManager to check case sensitive table name.\n+    TableType tableType = TableNameBuilder.getTableTypeFromTableName(tableName);\n+    if (tableType != null && _routingManager.routingExists(querySourceSplits[1]) && !_routingManager\n+        .routingExists(tableName)) {\n+      brokerRequest.getQuerySource().setTableName(querySourceSplits[1]);\n+      return;\n+    }", "originalCommit": "d2f709aadd038785cd04f9d5e7d49353fcdbda82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "429d27383a9006aeb713150ed21cc0679570f6ea", "url": "https://github.com/apache/pinot/commit/429d27383a9006aeb713150ed21cc0679570f6ea", "message": "address comments", "committedDate": "2020-07-16T00:32:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ2MTY3MA==", "url": "https://github.com/apache/pinot/pull/5707#discussion_r455461670", "bodyText": "Move return outside\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (_routingManager.routingExists(tableNameSplits[1]) && !_routingManager.routingExists(tableName)) {\n          \n          \n            \n                    brokerRequest.getQuerySource().setTableName(tableNameSplits[1]);\n          \n          \n            \n                    return;\n          \n          \n            \n                  }\n          \n          \n            \n                  if (_routingManager.routingExists(tableNameSplits[1]) && !_routingManager.routingExists(tableName)) {\n          \n          \n            \n                    brokerRequest.getQuerySource().setTableName(tableNameSplits[1]);\n          \n          \n            \n                  }\n          \n          \n            \n                  return;", "author": "Jackie-Jiang", "createdAt": "2020-07-16T01:48:47Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -438,6 +439,47 @@ public BrokerResponse handleRequest(JsonNode request, @Nullable RequesterIdentit\n     return brokerResponse;\n   }\n \n+  /**\n+   * Check if table is in the format of [database_name].[table_name].\n+   *\n+   * Only update TableName in QuerySource if there is no existing table in the format of [database_name].[table_name],\n+   * but only [table_name].\n+   *\n+   * @param brokerRequest\n+   */\n+  private void updateQuerySource(BrokerRequest brokerRequest) {\n+    String tableName = brokerRequest.getQuerySource().getTableName();\n+    // Check if table is in the format of [database_name].[table_name]\n+    String[] tableNameSplits = StringUtils.split(tableName, '.');\n+    if (tableNameSplits.length != 2) {\n+      return;\n+    }\n+    // Update table name if there is no existing table in the format of [database_name].[table_name] but only [table_name]\n+    if (_enableCaseInsensitive) {\n+      if (_tableCache.containsTable(tableNameSplits[1]) && !_tableCache.containsTable(tableName)) {\n+        // Use TableCache to check case insensitive table name.\n+        brokerRequest.getQuerySource().setTableName(tableNameSplits[1]);\n+      }\n+      return;\n+    }\n+    // Use RoutingManager to check case sensitive table name.\n+    if (TableNameBuilder.isTableResource(tableName)) {\n+      if (_routingManager.routingExists(tableNameSplits[1]) && !_routingManager.routingExists(tableName)) {\n+        brokerRequest.getQuerySource().setTableName(tableNameSplits[1]);\n+        return;\n+      }", "originalCommit": "429d27383a9006aeb713150ed21cc0679570f6ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d958f989367991bec4d89919127869ba7a851b5f", "url": "https://github.com/apache/pinot/commit/d958f989367991bec4d89919127869ba7a851b5f", "message": "Update pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java\n\nCo-authored-by: Xiaotian (Jackie) Jiang <17555551+Jackie-Jiang@users.noreply.github.com>", "committedDate": "2020-07-16T04:11:42Z", "type": "commit"}]}