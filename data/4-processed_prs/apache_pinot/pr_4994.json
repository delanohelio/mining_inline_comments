{"pr_number": 4994, "pr_title": "Make sql as default query format.", "pr_createdAt": "2020-01-17T12:18:44Z", "pr_url": "https://github.com/apache/pinot/pull/4994", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTMxMw==", "url": "https://github.com/apache/pinot/pull/4994#discussion_r368041313", "bodyText": "Is the goal to invoke the new sql endpoint, or just set these options? If it's the former, we need a new endpoint on the controller \"/sql\", similar to \"pql\" which is in PqlQueryResource. Inside executeQuery method (called on line 83) we need to invoke \"sql\" endpoint accordingly.", "author": "npawar", "createdAt": "2020-01-17T17:04:37Z", "path": "pinot-controller/src/main/resources/static/js/init.js", "diffHunk": "@@ -67,13 +67,13 @@ $(document).ready(function() {\n     // execute query and draw the results\n     var query = EDITOR.getValue().trim();\n     var traceEnabled = document.getElementById('trace-enabled').checked;\n-    var groupByModeSQL = document.getElementById('group-by-mode-sql').checked;\n-    var responseFormatSQL = document.getElementById('response-format-sql').checked;\n+    var groupByModePQL = document.getElementById('group-by-mode-pql').checked;\n+    var responseFormatPQL = document.getElementById('response-format-pql').checked;\n     var queryOptions = undefined;\n-    if (groupByModeSQL === true) {\n+    if (groupByModePQL !== true) {\n       queryOptions = \"groupByMode=sql\";\n     }\n-    if (responseFormatSQL === true) {\n+    if (responseFormatPQL !== true) {\n       if (queryOptions === undefined) {", "originalCommit": "36303e5056fd340772e03940d2dc190a2515f193", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc4NjQwMg==", "url": "https://github.com/apache/pinot/pull/4994#discussion_r368786402", "bodyText": "Provides a /sql endpoint now.", "author": "xiangfu0", "createdAt": "2020-01-21T02:27:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MTMxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MzMyMw==", "url": "https://github.com/apache/pinot/pull/4994#discussion_r368043323", "bodyText": "We need only 1 checkbox now for \"PQL\", which will go to the \"/pql\" endpoint. By default we go to \"sql\" endpoint", "author": "npawar", "createdAt": "2020-01-17T17:09:05Z", "path": "pinot-controller/src/main/resources/static/query/index.html", "diffHunk": "@@ -79,11 +79,11 @@ <h1><a href=\"#/\">Pinot Data Explorer</a></h1>\n           <div class=\"small-2 columns\" title=\"Enables tracing\">\n             <input type=checkbox id=\"trace-enabled\">&nbsp;&nbsp;Tracing</input>\n           </div>\n-          <div class=\"small-3 columns\" title=\"Sets groupByMode=sql in queryOptions (default pql)\">", "originalCommit": "36303e5056fd340772e03940d2dc190a2515f193", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE4NjYzOQ==", "url": "https://github.com/apache/pinot/pull/4994#discussion_r368186639", "bodyText": "changed the ui to only show one check box of pql, which means to use pql syntax if checked.", "author": "xiangfu0", "createdAt": "2020-01-18T00:20:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA0MzMyMw=="}], "type": "inlineReview"}, {"oid": "e9f315ee870faa60da0374ae15b1be56070f3515", "url": "https://github.com/apache/pinot/commit/e9f315ee870faa60da0374ae15b1be56070f3515", "message": "Make sql as default query format.", "committedDate": "2020-01-17T21:57:16Z", "type": "forcePushed"}, {"oid": "f0576e5be97b0df7e28ddc661f32b810a013c763", "url": "https://github.com/apache/pinot/commit/f0576e5be97b0df7e28ddc661f32b810a013c763", "message": "Make sql as default query format.", "committedDate": "2020-01-18T00:15:02Z", "type": "forcePushed"}, {"oid": "7dd4559c03e0bff655a75128a35d54aba8b1d9ee", "url": "https://github.com/apache/pinot/commit/7dd4559c03e0bff655a75128a35d54aba8b1d9ee", "message": "Adding sql endpoint in controller", "committedDate": "2020-01-21T02:04:15Z", "type": "forcePushed"}, {"oid": "0cca514b6e1b639906f6799def8f40807ee3cc2b", "url": "https://github.com/apache/pinot/commit/0cca514b6e1b639906f6799def8f40807ee3cc2b", "message": "Adding sql endpoint in controller", "committedDate": "2020-01-21T02:06:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc4MzY2OQ==", "url": "https://github.com/apache/pinot/pull/4994#discussion_r368783669", "bodyText": "please change all method names to handle<Get|Post><Sql|Pql>", "author": "kishoreg", "createdAt": "2020-01-21T02:12:00Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotQueryResource.java", "diffHunk": "@@ -66,9 +67,10 @@\n   @Inject\n   AccessControlFactory _accessControlFactory;\n \n+  @Deprecated\n   @POST\n   @Path(\"pql\")\n-  public String post(String requestJsonStr, @Context HttpHeaders httpHeaders) {\n+  public String postPql(String requestJsonStr, @Context HttpHeaders httpHeaders) {", "originalCommit": "0cca514b6e1b639906f6799def8f40807ee3cc2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc4NDE3Ng==", "url": "https://github.com/apache/pinot/pull/4994#discussion_r368784176", "bodyText": "can we use a queryType enum instead of true/false for isSqlQuery", "author": "kishoreg", "createdAt": "2020-01-21T02:14:53Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotQueryResource.java", "diffHunk": "@@ -81,37 +83,69 @@ public String post(String requestJsonStr, @Context HttpHeaders httpHeaders) {\n         queryOptions = requestJson.get(\"queryOptions\").asText();\n       }\n       LOGGER.debug(\"Trace: {}, Running query: {}\", traceEnabled, pqlQuery);\n-      return getQueryResponse(pqlQuery, traceEnabled, queryOptions, httpHeaders);\n+      return getQueryResponse(pqlQuery, traceEnabled, queryOptions, httpHeaders, false);\n     } catch (Exception e) {\n       LOGGER.error(\"Caught exception while processing post request\", e);\n       return QueryException.getException(QueryException.INTERNAL_ERROR, e).toString();\n     }\n   }\n \n+  @Deprecated\n   @GET\n   @Path(\"pql\")\n-  public String get(@QueryParam(\"pql\") String pqlQuery, @QueryParam(\"trace\") String traceEnabled,\n+  public String getPql(@QueryParam(\"pql\") String pqlQuery, @QueryParam(\"trace\") String traceEnabled,\n       @QueryParam(\"queryOptions\") String queryOptions,\n       @Context HttpHeaders httpHeaders) {\n     try {\n       LOGGER.debug(\"Trace: {}, Running query: {}\", traceEnabled, pqlQuery);\n-      return getQueryResponse(pqlQuery, traceEnabled, queryOptions, httpHeaders);\n+      return getQueryResponse(pqlQuery, traceEnabled, queryOptions, httpHeaders, false);", "originalCommit": "0cca514b6e1b639906f6799def8f40807ee3cc2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "db98b2af656b69c87da5f0a2949a93308c8889d4", "url": "https://github.com/apache/pinot/commit/db98b2af656b69c87da5f0a2949a93308c8889d4", "message": "Address comments", "committedDate": "2020-01-21T02:23:35Z", "type": "forcePushed"}, {"oid": "e474484a5b5cc4f031006c07ff4c26360797663a", "url": "https://github.com/apache/pinot/commit/e474484a5b5cc4f031006c07ff4c26360797663a", "message": "Address comments", "committedDate": "2020-01-21T02:24:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEyNDk0Nw==", "url": "https://github.com/apache/pinot/pull/4994#discussion_r369124947", "bodyText": "The /query/sql endpoint is full sql - SQL parser, sql execution and sql response format. I thought you are intending to have\n/pql - full pql endpoint\n/sql - sql execution, sql response, but pql parser.\nIn that case, we would need a query option in the /query/sql endpoint to switch between pql/sql parser.\nAnd essentially, we are ending up with 3 modes,\n\nfull pql - /pql endpoint\npartial sql with pql parser - default /sql endpoint\nfull sql - /sql endpoint, with query param", "author": "npawar", "createdAt": "2020-01-21T16:59:28Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotQueryResource.java", "diffHunk": "@@ -143,9 +172,20 @@ public String getQueryResponse(String pqlQuery, String traceEnabled, String quer\n     }\n     String hostNameWithPrefix = instanceConfig.getHostName();\n     String url =\n-        \"http://\" + hostNameWithPrefix.substring(hostNameWithPrefix.indexOf(\"_\") + 1) + \":\" + instanceConfig.getPort()\n-            + \"/query\";\n-    return sendPQLRaw(url, pqlQuery, traceEnabled, queryOptions);\n+        getQueryURL(hostNameWithPrefix.substring(hostNameWithPrefix.indexOf(\"_\") + 1), instanceConfig.getPort(),\n+            querySyntax);\n+    return sendQueryRaw(url, query, traceEnabled);\n+  }\n+\n+  private String getQueryURL(String hostName, String port, String querySyntax) {\n+    switch (querySyntax) {\n+      case CommonConstants.Broker.Request.SQL:\n+        return String.format(\"http://%s:%s/query/sql\", hostName, port);", "originalCommit": "e474484a5b5cc4f031006c07ff4c26360797663a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgzOTgyMw==", "url": "https://github.com/apache/pinot/pull/4994#discussion_r369839823", "bodyText": "Current approach is to route SQL query from ui still to PQL endpoint, but with query options groupByMode=sql;responseFormat=sql.", "author": "xiangfu0", "createdAt": "2020-01-22T22:28:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEyNDk0Nw=="}], "type": "inlineReview"}, {"oid": "672e3b34f0d4a6222ae9216abeb0988ea7c3c497", "url": "https://github.com/apache/pinot/commit/672e3b34f0d4a6222ae9216abeb0988ea7c3c497", "message": "move sql back to pql parser", "committedDate": "2020-01-22T21:06:05Z", "type": "forcePushed"}, {"oid": "160ded7eaaf1857f73fbc80a991a6a969575c92e", "url": "https://github.com/apache/pinot/commit/160ded7eaaf1857f73fbc80a991a6a969575c92e", "message": "move sql back to pql parser", "committedDate": "2020-01-22T21:19:14Z", "type": "forcePushed"}, {"oid": "b2b57798dcdcb27f559eba39f49646222ed9e2e5", "url": "https://github.com/apache/pinot/commit/b2b57798dcdcb27f559eba39f49646222ed9e2e5", "message": "move sql back to pql parser", "committedDate": "2020-01-22T22:48:56Z", "type": "forcePushed"}, {"oid": "26586a1f36686066fb204c5a7f54fa0ade70feab", "url": "https://github.com/apache/pinot/commit/26586a1f36686066fb204c5a7f54fa0ade70feab", "message": "move sql parser to calcite parser again", "committedDate": "2020-01-23T23:50:30Z", "type": "forcePushed"}, {"oid": "3db7c2b48e026c86e0276bef99c655168c572c7c", "url": "https://github.com/apache/pinot/commit/3db7c2b48e026c86e0276bef99c655168c572c7c", "message": "Make sql as default query format.", "committedDate": "2020-01-24T01:48:38Z", "type": "forcePushed"}, {"oid": "be1a84f5dd2810c3f087d763669e911a71b1d160", "url": "https://github.com/apache/pinot/commit/be1a84f5dd2810c3f087d763669e911a71b1d160", "message": "move sql parser to calcite parser again", "committedDate": "2020-01-24T02:23:44Z", "type": "forcePushed"}, {"oid": "047f70fa9814b6dad9911ea6140a17f09451aadb", "url": "https://github.com/apache/pinot/commit/047f70fa9814b6dad9911ea6140a17f09451aadb", "message": "Make sql as default query format.", "committedDate": "2020-01-24T22:40:32Z", "type": "commit"}, {"oid": "de7be8568f661d6048d604413880918d42e9fa59", "url": "https://github.com/apache/pinot/commit/de7be8568f661d6048d604413880918d42e9fa59", "message": "Update TransformExpressionTree.java", "committedDate": "2020-01-24T22:40:32Z", "type": "commit"}, {"oid": "b1fd93a0f931f942c05cf67d0d2a082cc1489829", "url": "https://github.com/apache/pinot/commit/b1fd93a0f931f942c05cf67d0d2a082cc1489829", "message": "Adding sql endpoint in controller", "committedDate": "2020-01-24T22:40:32Z", "type": "commit"}, {"oid": "bdc0cc90ff9fb3727e9b1a6872dc573338567cce", "url": "https://github.com/apache/pinot/commit/bdc0cc90ff9fb3727e9b1a6872dc573338567cce", "message": "Address comments", "committedDate": "2020-01-24T22:40:32Z", "type": "commit"}, {"oid": "e9b2fbe473ed4fcbfb0171c4ef2344abec619a06", "url": "https://github.com/apache/pinot/commit/e9b2fbe473ed4fcbfb0171c4ef2344abec619a06", "message": "move sql back to pql parser", "committedDate": "2020-01-24T22:40:32Z", "type": "commit"}, {"oid": "0b671b70d96c63cdb577019d3d5865d1cfa45c70", "url": "https://github.com/apache/pinot/commit/0b671b70d96c63cdb577019d3d5865d1cfa45c70", "message": "move sql parser to calcite parser again", "committedDate": "2020-01-24T22:40:32Z", "type": "commit"}, {"oid": "0b671b70d96c63cdb577019d3d5865d1cfa45c70", "url": "https://github.com/apache/pinot/commit/0b671b70d96c63cdb577019d3d5865d1cfa45c70", "message": "move sql parser to calcite parser again", "committedDate": "2020-01-24T22:40:32Z", "type": "forcePushed"}]}