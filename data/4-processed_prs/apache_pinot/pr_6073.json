{"pr_number": 6073, "pr_title": "Adding more table config validation", "pr_createdAt": "2020-09-29T22:27:15Z", "pr_url": "https://github.com/apache/pinot/pull/6073", "timeline": [{"oid": "88497572cf9058b2d0e06cbbea87d785ce21f875", "url": "https://github.com/apache/pinot/commit/88497572cf9058b2d0e06cbbea87d785ce21f875", "message": "* Adding more table config validation (retention, pushType and tenant)\n* Fixing bug where retention manager does not work for real-time tables\n  if the pushType is missing.", "committedDate": "2020-09-29T22:20:37Z", "type": "commit"}, {"oid": "c9e354197f5fef57b08884e3de170ef19ddcabe1", "url": "https://github.com/apache/pinot/commit/c9e354197f5fef57b08884e3de170ef19ddcabe1", "message": "Adding newline at end of TableConfigUtilsTest.java", "committedDate": "2020-09-29T22:25:53Z", "type": "commit"}, {"oid": "3fb5149df177977518a21e90e06edd4757b92c47", "url": "https://github.com/apache/pinot/commit/3fb5149df177977518a21e90e06edd4757b92c47", "message": "Allowing null tenant config in the validation", "committedDate": "2020-09-30T02:33:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzIzMTYzOA==", "url": "https://github.com/apache/pinot/pull/6073#discussion_r497231638", "bodyText": "This is the same check as PinotHelixResourceManager.validateTableTenantConfig(TableConfig tableConfig)", "author": "Jackie-Jiang", "createdAt": "2020-09-30T04:08:06Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/util/TableConfigUtils.java", "diffHunk": "@@ -76,10 +79,41 @@ public static void validate(TableConfig tableConfig, @Nullable Schema schema) {\n     validateFieldConfigList(tableConfig.getFieldConfigList(), schema);\n   }\n \n+  /**\n+   * Validates all table config including tenant config. This is specifically invoked\n+   * during table config creation, update or validate API calls.\n+   */\n+  public static void validate(TableConfig tableConfig, @Nullable Schema schema, Set<String> serverTenants,\n+      Set<String> brokerTenants) {\n+    validate(tableConfig, schema);\n+    validateTenants(tableConfig, serverTenants, brokerTenants);\n+  }\n+\n+  /**\n+   * Ensures a valid tenant config is provided in the table config.\n+   * Ensures the broker and server tenant names are valid.\n+   */\n+  private static void validateTenants(TableConfig tableConfig, Set<String> serverTenants, Set<String> brokerTenants) {", "originalCommit": "3fb5149df177977518a21e90e06edd4757b92c47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "48c76e92652facc6e3f4b57cb7730ccfdee4ccbf", "url": "https://github.com/apache/pinot/commit/48c76e92652facc6e3f4b57cb7730ccfdee4ccbf", "message": "Remove tenant validation code as per review comments", "committedDate": "2020-09-30T22:49:40Z", "type": "commit"}, {"oid": "c0307db867bdcac0461ccef02f7b317147d6117d", "url": "https://github.com/apache/pinot/commit/c0307db867bdcac0461ccef02f7b317147d6117d", "message": "Adding server and broker tenant check for multi-tenant clusters", "committedDate": "2020-10-01T19:01:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ1OTk4Mg==", "url": "https://github.com/apache/pinot/pull/6073#discussion_r498459982", "bodyText": "You should put default tenant here if it is single-tenant cluster, similar to addTable()\nYou may extract this part into a helper method", "author": "Jackie-Jiang", "createdAt": "2020-10-01T19:11:42Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java", "diffHunk": "@@ -1374,6 +1378,14 @@ private void assignInstances(TableConfig tableConfig, boolean override) {\n    */\n   public void updateTableConfig(TableConfig tableConfig)\n       throws IOException {\n+    TenantConfig tenantConfig = tableConfig.getTenantConfig();\n+    String brokerTag = tenantConfig.getBroker();\n+    String serverTag = tenantConfig.getServer();\n+    if (brokerTag == null || serverTag == null) {\n+      if (!_isSingleTenantCluster) {\n+        throw new InvalidTableConfigException(\"server and broker tenants must be specified for multi-tenant cluster\");\n+      }\n+    }", "originalCommit": "c0307db867bdcac0461ccef02f7b317147d6117d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2MDQzMQ==", "url": "https://github.com/apache/pinot/pull/6073#discussion_r498460431", "bodyText": "makes sense. lemme do that", "author": "icefury71", "createdAt": "2020-10-01T19:12:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ1OTk4Mg=="}], "type": "inlineReview"}, {"oid": "a882a9da3714bed9e75c7609349e0bb971cdf2bc", "url": "https://github.com/apache/pinot/commit/a882a9da3714bed9e75c7609349e0bb971cdf2bc", "message": "Refactoring tenant validation code", "committedDate": "2020-10-01T19:36:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ3NTU3NQ==", "url": "https://github.com/apache/pinot/pull/6073#discussion_r498475575", "bodyText": "That's also put the table name within the exception message", "author": "Jackie-Jiang", "createdAt": "2020-10-01T19:44:32Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java", "diffHunk": "@@ -1195,12 +1182,26 @@ public void addTable(TableConfig tableConfig)\n   }\n \n   /**\n-   * Validates the tenant config for the table\n+   * Validates the tenant config for the table. In case of a single tenant cluster,\n+   * if the server and broker tenants are not specified in the config, they're\n+   * auto-populated with the default tenant name. In case of a multi-tenant cluster,\n+   * these parameters must be specified in the table config.\n    */\n   @VisibleForTesting\n   void validateTableTenantConfig(TableConfig tableConfig) {\n-    String tableNameWithType = tableConfig.getTableName();\n     TenantConfig tenantConfig = tableConfig.getTenantConfig();\n+    String brokerTag = tenantConfig.getBroker();\n+    String serverTag = tenantConfig.getServer();\n+    if (brokerTag == null || serverTag == null) {\n+      if (!_isSingleTenantCluster) {\n+        throw new InvalidTableConfigException(\"server and broker tenants must be specified for multi-tenant cluster\");", "originalCommit": "a882a9da3714bed9e75c7609349e0bb971cdf2bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2f9e4bf96720400bd9e0887ea5fb499cb3c4e83d", "url": "https://github.com/apache/pinot/commit/2f9e4bf96720400bd9e0887ea5fb499cb3c4e83d", "message": "Enhancing exception message with table name", "committedDate": "2020-10-01T21:16:09Z", "type": "commit"}]}