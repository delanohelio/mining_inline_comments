{"pr_number": 6176, "pr_title": "Merge common APIs for Dictionary", "pr_createdAt": "2020-10-22T19:10:18Z", "pr_url": "https://github.com/apache/pinot/pull/6176", "timeline": [{"oid": "9b1ba0b506277deddc22f6ae31d7ba9b87d30052", "url": "https://github.com/apache/pinot/commit/9b1ba0b506277deddc22f6ae31d7ba9b87d30052", "message": "Merge common APIs for Dictionary", "committedDate": "2020-10-22T18:58:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwNDMwMg==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510404302", "bodyText": "why is this unsupported? since it returns true for isSorted", "author": "yupeng9", "createdAt": "2020-10-22T19:27:33Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/readers/BaseImmutableDictionary.java", "diffHunk": "@@ -81,6 +80,31 @@ public int indexOf(String stringValue) {\n     return (index >= 0) ? index : NULL_VALUE_INDEX;\n   }\n \n+  @Override\n+  public IntSet getDictIdsInRange(String lower, String upper, boolean includeLower, boolean includeUpper) {\n+    throw new UnsupportedOperationException();\n+  }\n+\n+  @Override\n+  public int compare(int dictId1, int dictId2) {\n+    return Integer.compare(dictId1, dictId2);\n+  }\n+\n+  @Override\n+  public Comparable getMinVal() {\n+    return (Comparable) get(0);\n+  }\n+\n+  @Override\n+  public Comparable getMaxVal() {\n+    return (Comparable) get(_length - 1);\n+  }\n+\n+  @Override\n+  public Object getSortedValues() {\n+    throw new UnsupportedOperationException();", "originalCommit": "9b1ba0b506277deddc22f6ae31d7ba9b87d30052", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwNTY3OA==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510405678", "bodyText": "If you want a default impl, then perhaps just remove it, so the subclass must implement it.", "author": "yupeng9", "createdAt": "2020-10-22T19:30:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwNDMwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzODcwNw==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510438707", "bodyText": "Added the note: This method is for the stats collection phase when sealing the consuming segment, so not required for regular immutable dictionary within the immutable segment.", "author": "Jackie-Jiang", "createdAt": "2020-10-22T20:31:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwNDMwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwNDU3Mg==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510404572", "bodyText": "why can this be supported?", "author": "yupeng9", "createdAt": "2020-10-22T19:28:06Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/readers/BaseImmutableDictionary.java", "diffHunk": "@@ -81,6 +80,31 @@ public int indexOf(String stringValue) {\n     return (index >= 0) ? index : NULL_VALUE_INDEX;\n   }\n \n+  @Override\n+  public IntSet getDictIdsInRange(String lower, String upper, boolean includeLower, boolean includeUpper) {\n+    throw new UnsupportedOperationException();", "originalCommit": "9b1ba0b506277deddc22f6ae31d7ba9b87d30052", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MDI3NA==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510440274", "bodyText": "This method is for the unsorted dictionary. Added the note", "author": "Jackie-Jiang", "createdAt": "2020-10-22T20:34:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwNDU3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzOTE0Nw==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510439147", "bodyText": "NIT: dictionary-> dictionaries", "author": "chenboat", "createdAt": "2020-10-22T20:32:19Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/readers/Dictionary.java", "diffHunk": "@@ -40,14 +42,52 @@\n    */\n   DataType getValueType();\n \n+  /**\n+   * Returns the number of values in the dictionary.\n+   */\n   int length();\n \n   /**\n    * Returns the index of the string representation of the value in the dictionary, or {@link #NULL_VALUE_INDEX} (-1) if\n-   * the value does not exist. This API is for cross-type predicate evaluation.\n+   * the value does not exist. This method is for the cross-type predicate evaluation.\n    */\n   int indexOf(String stringValue);\n \n+  /**\n+   * Returns the insertion index of the string representation of the value in the dictionary. This method follows the\n+   * same behavior as in {@link Arrays#binarySearch(Object[], Object)}. All sorted dictionary should support this", "originalCommit": "9b1ba0b506277deddc22f6ae31d7ba9b87d30052", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MDUzNA==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510440534", "bodyText": "Done", "author": "Jackie-Jiang", "createdAt": "2020-10-22T20:34:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzOTE0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzOTkyOA==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510439928", "bodyText": "is it string value comparison?", "author": "chenboat", "createdAt": "2020-10-22T20:33:50Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/readers/Dictionary.java", "diffHunk": "@@ -40,14 +42,52 @@\n    */\n   DataType getValueType();\n \n+  /**\n+   * Returns the number of values in the dictionary.\n+   */\n   int length();\n \n   /**\n    * Returns the index of the string representation of the value in the dictionary, or {@link #NULL_VALUE_INDEX} (-1) if\n-   * the value does not exist. This API is for cross-type predicate evaluation.\n+   * the value does not exist. This method is for the cross-type predicate evaluation.\n    */\n   int indexOf(String stringValue);\n \n+  /**\n+   * Returns the insertion index of the string representation of the value in the dictionary. This method follows the\n+   * same behavior as in {@link Arrays#binarySearch(Object[], Object)}. All sorted dictionary should support this\n+   * method. This method is for the range predicate evaluation.\n+   */\n+  int insertionIndexOf(String stringValue);\n+\n+  /**\n+   * Returns a set of dictIds in the given value range, where lower/upper bound can be \"*\" which indicates unbounded\n+   * range. All unsorted dictionary should support this method. This method is for the range predicate evaluation.\n+   */\n+  IntSet getDictIdsInRange(String lower, String upper, boolean includeLower, boolean includeUpper);\n+\n+  /**\n+   * Returns the comparison result of value for dictId 1 and dictId 2, i.e. {@code value1.compareTo(value2)}.", "originalCommit": "9b1ba0b506277deddc22f6ae31d7ba9b87d30052", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0NDAyNw==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510444027", "bodyText": "No, actual value. Updated the javadoc", "author": "Jackie-Jiang", "createdAt": "2020-10-22T20:41:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQzOTkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MDQ1MA==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510440450", "bodyText": "what happens if the dictionary is empty?", "author": "chenboat", "createdAt": "2020-10-22T20:34:47Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/readers/Dictionary.java", "diffHunk": "@@ -40,14 +42,52 @@\n    */\n   DataType getValueType();\n \n+  /**\n+   * Returns the number of values in the dictionary.\n+   */\n   int length();\n \n   /**\n    * Returns the index of the string representation of the value in the dictionary, or {@link #NULL_VALUE_INDEX} (-1) if\n-   * the value does not exist. This API is for cross-type predicate evaluation.\n+   * the value does not exist. This method is for the cross-type predicate evaluation.\n    */\n   int indexOf(String stringValue);\n \n+  /**\n+   * Returns the insertion index of the string representation of the value in the dictionary. This method follows the\n+   * same behavior as in {@link Arrays#binarySearch(Object[], Object)}. All sorted dictionary should support this\n+   * method. This method is for the range predicate evaluation.\n+   */\n+  int insertionIndexOf(String stringValue);\n+\n+  /**\n+   * Returns a set of dictIds in the given value range, where lower/upper bound can be \"*\" which indicates unbounded\n+   * range. All unsorted dictionary should support this method. This method is for the range predicate evaluation.\n+   */\n+  IntSet getDictIdsInRange(String lower, String upper, boolean includeLower, boolean includeUpper);\n+\n+  /**\n+   * Returns the comparison result of value for dictId 1 and dictId 2, i.e. {@code value1.compareTo(value2)}.\n+   */\n+  int compare(int dictId1, int dictId2);\n+\n+  /**\n+   * Returns the minimum value in the dictionary. Note that for type BYTES, {@code ByteArray} will be returned.", "originalCommit": "9b1ba0b506277deddc22f6ae31d7ba9b87d30052", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0NTkwNg==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510445906", "bodyText": "Good question. It is undefined, and should not be called when the dictionary is empty. Updated the javadoc.", "author": "Jackie-Jiang", "createdAt": "2020-10-22T20:45:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0MDQ1MA=="}], "type": "inlineReview"}, {"oid": "1abcae59c963e3e6da0550febbe83f5b402be1f6", "url": "https://github.com/apache/pinot/commit/1abcae59c963e3e6da0550febbe83f5b402be1f6", "message": "Fix test and address comments", "committedDate": "2020-10-22T20:46:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0NzMzNw==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510447337", "bodyText": "is this change related to this API refactoring? I did not see any change to OfflineDictionaryBasedRangePredicateEvaluator in this PR.", "author": "chenboat", "createdAt": "2020-10-22T20:48:14Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/filter/RangeIndexBasedFilterOperator.java", "diffHunk": "@@ -56,12 +56,12 @@ protected FilterBlock getNextBlock() {\n \n     int firstRangeId;\n     int lastRangeId;\n-    if (_rangePredicateEvaluator instanceof OfflineDictionaryBasedRangePredicateEvaluator) {\n+    if (_rangePredicateEvaluator instanceof SortedDictionaryBasedRangePredicateEvaluator) {", "originalCommit": "9b1ba0b506277deddc22f6ae31d7ba9b87d30052", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0ODEzMw==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510448133", "bodyText": "Yes. We should determine the evaluator by whether the dictionary is sorted, instead of the instance of the dictionary.", "author": "Jackie-Jiang", "createdAt": "2020-10-22T20:49:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0NzMzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ1Mjk5Ng==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510452996", "bodyText": "I mean I did not see any change to OfflineDictionaryBasedRangePredicateEvaluator nor SortedDictionaryBasedRangePredicateEvaluator in this PR. Is this an existing bug for range predicate?", "author": "chenboat", "createdAt": "2020-10-22T20:58:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0NzMzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ3MzI3MA==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510473270", "bodyText": "Oh, that is under the RangeIndexBasedFilterOperator", "author": "Jackie-Jiang", "createdAt": "2020-10-22T21:38:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0NzMzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUzMjAwNg==", "url": "https://github.com/apache/pinot/pull/6176#discussion_r510532006", "bodyText": "Ah. Got it. You made changes in RangePredicateEvaluatorFactory.java.", "author": "chenboat", "createdAt": "2020-10-23T00:28:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ0NzMzNw=="}], "type": "inlineReview"}]}