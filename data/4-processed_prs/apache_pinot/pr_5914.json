{"pr_number": 5914, "pr_title": "[TE] Updated ThirdEye docker launch script to accept MODE as a second arg", "pr_createdAt": "2020-08-24T20:41:52Z", "pr_url": "https://github.com/apache/pinot/pull/5914", "timeline": [{"oid": "0fe8f07e37ef4625e9b909ab8ed0827ae20083ee", "url": "https://github.com/apache/pinot/commit/0fe8f07e37ef4625e9b909ab8ed0827ae20083ee", "message": "[TE] Added Docker Images for a distributed ThirdEye setup\n\nAdded separate docker images for a", "committedDate": "2020-08-24T20:39:04Z", "type": "commit"}, {"oid": "6e7ad258561b43d4017f7519f73cd4cdefe2ccf4", "url": "https://github.com/apache/pinot/commit/6e7ad258561b43d4017f7519f73cd4cdefe2ccf4", "message": "[TE] Added Docker Images for a distributed ThirdEye setup\n\nFixed Dockerfile base image tag", "committedDate": "2020-08-24T20:42:25Z", "type": "commit"}, {"oid": "68791b1305f07da5e33e7033c9462d4b8feb2b42", "url": "https://github.com/apache/pinot/commit/68791b1305f07da5e33e7033c9462d4b8feb2b42", "message": "[TE] Updated docker launch script to accept MODE as a second parameter\n\nThe MODE param decides on whether TE launches the frontend, backend or all services\n\n```\n ./start-thirdeye.sh ${CONFIG_DIR} ${MODE}\n\n - CONFIG_DIR: path to the thirdeye configuration director\n - MODE: Choices: {frontend, backend, * }\n       frontend: Start the frontend server only\n       backend: Start the backend server only\n       For any other value, defaults to starting all services with an h2 db.\n```", "committedDate": "2020-08-24T22:42:31Z", "type": "commit"}, {"oid": "43953c8c1b45abd32bb2bf78c8af93ab5a87169b", "url": "https://github.com/apache/pinot/commit/43953c8c1b45abd32bb2bf78c8af93ab5a87169b", "message": "[TE] Updated docker launch script to accept MODE as a second parameter\n\nThe MODE param decides on whether TE launches the frontend, backend or all services\n\n```\n ./start-thirdeye.sh ${CONFIG_DIR} ${MODE}\n\n - CONFIG_DIR: path to the thirdeye configuration director\n - MODE: Choices: {frontend, backend, * }\n       frontend: Start the frontend server only\n       backend: Start the backend server only\n       For any other value, defaults to starting all services with an h2 db.\n```", "committedDate": "2020-08-24T22:46:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTkzODk2Nw==", "url": "https://github.com/apache/pinot/pull/5914#discussion_r475938967", "bodyText": "maybe add a start_database function for h2 specifically, so it can be started just like front and backend. imo otherwise start_all has an \"unexpected\" side-effect of bringing up a db", "author": "apucher", "createdAt": "2020-08-24T22:56:22Z", "path": "docker/images/pinot-thirdeye/bin/start-thirdeye.sh", "diffHunk": "@@ -18,32 +18,64 @@\n # under the License.\n #\n \n+# Script Usage\n+# ---------------------------------------------\n+# ./start-thirdeye.sh ${CONFIG_DIR} ${MODE}\n+#\n+# - CONFIG_DIR: path to the thirdeye configuration director\n+# - MODE: Choices: {frontend, backend, * }\n+#       frontend: Start the frontend server only\n+#       backend: Start the backend server only\n+#       For any other value, defaults to starting all services with an h2 db.\n+#\n+\n if [[ \"$#\" -gt 0 ]]\n then\n   CONFIG_DIR=\"./config/$1\"\n else\n   CONFIG_DIR=\"./config/default\"\n fi\n \n-echo \"Starting H2 database server\"\n-java -cp \"./bin/thirdeye-pinot.jar\" org.h2.tools.Server -tcp -baseDir \"${CONFIG_DIR}/..\" &\n-sleep 1\n \n-echo \"Creating ThirdEye database schema\"\n-java -cp \"./bin/thirdeye-pinot.jar\" org.h2.tools.RunScript -user \"sa\" -password \"sa\" -url \"jdbc:h2:tcp:localhost/h2db\" -script \"zip:./bin/thirdeye-pinot.jar!/schema/create-schema.sql\"\n+function start_server {\n+  class_ref=$1\n+  config_dir=$2\n+  java -Dlog4j.configurationFile=log4j2.xml -cp \"./bin/thirdeye-pinot.jar\" ${class_ref} \"${config_dir}\"\n+}\n \n-if [ -f \"${CONFIG_DIR}/bootstrap.sql\" ]; then\n-  echo \"Running database bootstrap script ${CONFIG_DIR}/bootstrap.sql\"\n-  java -cp \"./bin/thirdeye-pinot.jar\" org.h2.tools.RunScript -user \"sa\" -password \"sa\" -url \"jdbc:h2:tcp:localhost/h2db\" -script \"${CONFIG_DIR}/bootstrap.sql\"\n-fi\n+function start_frontend {\n+  echo \"Running Thirdeye frontend config: ${CONFIG_DIR}\"\n+  start_server org.apache.pinot.thirdeye.dashboard.ThirdEyeDashboardApplication \"${CONFIG_DIR}\"\n+}\n+\n+function start_backend {\n+  echo \"Running Thirdeye backend config: ${CONFIG_DIR}\"\n+  start_server  org.apache.pinot.thirdeye.anomaly.ThirdEyeAnomalyApplication \"${CONFIG_DIR}\"\n+}\n+\n+function start_all {", "originalCommit": "43953c8c1b45abd32bb2bf78c8af93ab5a87169b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTk1NjQ1Ng==", "url": "https://github.com/apache/pinot/pull/5914#discussion_r475956456", "bodyText": "The h2 launch doesn't seem to be a background job in the first place. I'm not sure whether the current setup launches the db server in a separate process and how it works. Ideally, starting multiple services in a single docker itself has some issues. So, I am not refactoring that part which I'm not able to test. I think launching a MySQL DB instead of H2 should just simplify things a lot.", "author": "suvodeep-pyne", "createdAt": "2020-08-24T23:26:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTkzODk2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTk3Mzg0Nw==", "url": "https://github.com/apache/pinot/pull/5914#discussion_r475973847", "bodyText": "H2 does start in the background on line 58. The other calls on line 62 and 66 create the schema and bootstrap some metadata, respectively.", "author": "apucher", "createdAt": "2020-08-24T23:50:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTkzODk2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTk4MzM5OQ==", "url": "https://github.com/apache/pinot/pull/5914#discussion_r475983399", "bodyText": "I see. My bad. Let me update this.", "author": "suvodeep-pyne", "createdAt": "2020-08-25T00:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTkzODk2Nw=="}], "type": "inlineReview"}, {"oid": "3011714f2e379e09065e2c406c9816dc915fa6e7", "url": "https://github.com/apache/pinot/commit/3011714f2e379e09065e2c406c9816dc915fa6e7", "message": "[TE] Updated docker launch script to accept MODE as a second parameter\n\nThe MODE param decides on whether TE launches the frontend, backend, database or all services\n\n```\n ./start-thirdeye.sh ${CONFIG_DIR} ${MODE}\n\n - CONFIG_DIR: path to the thirdeye configuration director\n - MODE: Choices: {frontend, backend, * }\n       frontend: Start the frontend server only\n       backend: Start the backend server only\n       database: Start the H@ db service. Also initializes the db with the required tables\n       For any other value, defaults to starting all services with an h2 db.\n```", "committedDate": "2020-08-25T00:07:25Z", "type": "commit"}]}