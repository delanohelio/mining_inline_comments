{"pr_number": 4959, "pr_title": "Add schemaFile as option in AddTableCommand", "pr_createdAt": "2020-01-05T08:21:44Z", "pr_url": "https://github.com/apache/pinot/pull/4959", "timeline": [{"oid": "07dfa9d2608ceb21fba02e7d248929afcdd54032", "url": "https://github.com/apache/pinot/commit/07dfa9d2608ceb21fba02e7d248929afcdd54032", "message": "Update AddTableCommand to take schema file in order to creation pinot table in one line", "committedDate": "2020-01-05T08:31:02Z", "type": "commit"}, {"oid": "07dfa9d2608ceb21fba02e7d248929afcdd54032", "url": "https://github.com/apache/pinot/commit/07dfa9d2608ceb21fba02e7d248929afcdd54032", "message": "Update AddTableCommand to take schema file in order to creation pinot table in one line", "committedDate": "2020-01-05T08:31:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEwOTQ2Ng==", "url": "https://github.com/apache/pinot/pull/4959#discussion_r363109466", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return \"Create Pinot table with table config and schema.\";\n          \n          \n            \n                return \"Create a Pinot table\";", "author": "mcvsubbu", "createdAt": "2020-01-05T18:32:42Z", "path": "pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/AddTableCommand.java", "diffHunk": "@@ -66,24 +72,28 @@ public String getName() {\n \n   @Override\n   public String description() {\n-    return \"Add table specified in the json file, to the controller.\";\n+    return \"Create Pinot table with table config and schema.\";", "originalCommit": "07dfa9d2608ceb21fba02e7d248929afcdd54032", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEwOTU1MA==", "url": "https://github.com/apache/pinot/pull/4959#discussion_r363109550", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    throw new FileNotFoundException(\"schema file does not exist: \" + _schemaFile);\n          \n          \n            \n                    throw new FileNotFoundException(\"Schema file does not exist: \" + _schemaFile);", "author": "mcvsubbu", "createdAt": "2020-01-05T18:33:56Z", "path": "pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/AddTableCommand.java", "diffHunk": "@@ -102,33 +112,51 @@ public AddTableCommand setExecute(boolean exec) {\n     return this;\n   }\n \n-  public boolean execute(JsonNode node)\n+  public boolean sendTableCreationRequest(JsonNode node)\n       throws IOException {\n-    if (_controllerHost == null) {\n-      _controllerHost = NetUtil.getHostAddress();\n-    }\n-    _controllerAddress = \"http://\" + _controllerHost + \":\" + _controllerPort;\n+    String res = AbstractBaseAdminCommand\n+        .sendPostRequest(ControllerRequestURLBuilder.baseUrl(_controllerAddress).forTableCreate(), node.toString());\n+    LOGGER.info(res);\n+    return res.contains(\"succesfully added\");\n+  }\n \n+  @Override\n+  public boolean execute()\n+      throws Exception {\n     if (!_exec) {\n       LOGGER.warn(\"Dry Running Command: \" + toString());\n       LOGGER.warn(\"Use the -exec option to actually execute the command.\");\n       return true;\n     }\n \n-    LOGGER.info(\"Executing command: \" + toString());\n-    String res = AbstractBaseAdminCommand\n-        .sendPostRequest(ControllerRequestURLBuilder.baseUrl(_controllerAddress).forTableCreate(), node.toString());\n+    if (_controllerHost == null) {\n+      _controllerHost = NetUtil.getHostAddress();\n+    }\n+    _controllerAddress = \"http://\" + _controllerHost + \":\" + _controllerPort;\n \n-    LOGGER.info(res);\n-    if (res.contains(\"succesfully added\")) {\n-      return true;\n+    LOGGER.info(\"Executing command: \" + toString());\n+    // Backward compatible\n+    if (_schemaFile != null) {\n+      File schemaFile = new File(_schemaFile);\n+      if (!schemaFile.exists()) {\n+        throw new FileNotFoundException(\"schema file does not exist: \" + _schemaFile);", "originalCommit": "07dfa9d2608ceb21fba02e7d248929afcdd54032", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEwOTcwNw==", "url": "https://github.com/apache/pinot/pull/4959#discussion_r363109707", "bodyText": "You may get an exception here if the schema file is illegal or incorrect format. Not sure what the exception looks like, but it may be better to explicitly field any exception from this call and wrap it into an exception that contains the file name, e.g. \"Incorrect schema specification in \". This way, you can also avoid checking if the file existance in line 141, and combine all exceptions here.", "author": "mcvsubbu", "createdAt": "2020-01-05T18:37:11Z", "path": "pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/AddTableCommand.java", "diffHunk": "@@ -102,33 +112,51 @@ public AddTableCommand setExecute(boolean exec) {\n     return this;\n   }\n \n-  public boolean execute(JsonNode node)\n+  public boolean sendTableCreationRequest(JsonNode node)\n       throws IOException {\n-    if (_controllerHost == null) {\n-      _controllerHost = NetUtil.getHostAddress();\n-    }\n-    _controllerAddress = \"http://\" + _controllerHost + \":\" + _controllerPort;\n+    String res = AbstractBaseAdminCommand\n+        .sendPostRequest(ControllerRequestURLBuilder.baseUrl(_controllerAddress).forTableCreate(), node.toString());\n+    LOGGER.info(res);\n+    return res.contains(\"succesfully added\");\n+  }\n \n+  @Override\n+  public boolean execute()\n+      throws Exception {\n     if (!_exec) {\n       LOGGER.warn(\"Dry Running Command: \" + toString());\n       LOGGER.warn(\"Use the -exec option to actually execute the command.\");\n       return true;\n     }\n \n-    LOGGER.info(\"Executing command: \" + toString());\n-    String res = AbstractBaseAdminCommand\n-        .sendPostRequest(ControllerRequestURLBuilder.baseUrl(_controllerAddress).forTableCreate(), node.toString());\n+    if (_controllerHost == null) {\n+      _controllerHost = NetUtil.getHostAddress();\n+    }\n+    _controllerAddress = \"http://\" + _controllerHost + \":\" + _controllerPort;\n \n-    LOGGER.info(res);\n-    if (res.contains(\"succesfully added\")) {\n-      return true;\n+    LOGGER.info(\"Executing command: \" + toString());\n+    // Backward compatible\n+    if (_schemaFile != null) {\n+      File schemaFile = new File(_schemaFile);\n+      if (!schemaFile.exists()) {\n+        throw new FileNotFoundException(\"schema file does not exist: \" + _schemaFile);\n+      }\n+\n+      Schema schema = Schema.fromFile(schemaFile);", "originalCommit": "07dfa9d2608ceb21fba02e7d248929afcdd54032", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEwOTc1Mg==", "url": "https://github.com/apache/pinot/pull/4959#discussion_r363109752", "bodyText": "Maybe same technique can be used here and the file existence check avoided?", "author": "mcvsubbu", "createdAt": "2020-01-05T18:38:18Z", "path": "pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/AddTableCommand.java", "diffHunk": "@@ -102,33 +112,51 @@ public AddTableCommand setExecute(boolean exec) {\n     return this;\n   }\n \n-  public boolean execute(JsonNode node)\n+  public boolean sendTableCreationRequest(JsonNode node)\n       throws IOException {\n-    if (_controllerHost == null) {\n-      _controllerHost = NetUtil.getHostAddress();\n-    }\n-    _controllerAddress = \"http://\" + _controllerHost + \":\" + _controllerPort;\n+    String res = AbstractBaseAdminCommand\n+        .sendPostRequest(ControllerRequestURLBuilder.baseUrl(_controllerAddress).forTableCreate(), node.toString());\n+    LOGGER.info(res);\n+    return res.contains(\"succesfully added\");\n+  }\n \n+  @Override\n+  public boolean execute()\n+      throws Exception {\n     if (!_exec) {\n       LOGGER.warn(\"Dry Running Command: \" + toString());\n       LOGGER.warn(\"Use the -exec option to actually execute the command.\");\n       return true;\n     }\n \n-    LOGGER.info(\"Executing command: \" + toString());\n-    String res = AbstractBaseAdminCommand\n-        .sendPostRequest(ControllerRequestURLBuilder.baseUrl(_controllerAddress).forTableCreate(), node.toString());\n+    if (_controllerHost == null) {\n+      _controllerHost = NetUtil.getHostAddress();\n+    }\n+    _controllerAddress = \"http://\" + _controllerHost + \":\" + _controllerPort;\n \n-    LOGGER.info(res);\n-    if (res.contains(\"succesfully added\")) {\n-      return true;\n+    LOGGER.info(\"Executing command: \" + toString());\n+    // Backward compatible\n+    if (_schemaFile != null) {\n+      File schemaFile = new File(_schemaFile);\n+      if (!schemaFile.exists()) {\n+        throw new FileNotFoundException(\"schema file does not exist: \" + _schemaFile);\n+      }\n+\n+      Schema schema = Schema.fromFile(schemaFile);\n+      try (FileUploadDownloadClient fileUploadDownloadClient = new FileUploadDownloadClient()) {\n+        fileUploadDownloadClient.addSchema(\n+            FileUploadDownloadClient.getUploadSchemaHttpURI(_controllerHost, Integer.parseInt(_controllerPort)),\n+            schema.getSchemaName(), schemaFile);\n+      } catch (Exception e) {\n+        LOGGER.error(\"Got Exception to upload Pinot Schema: \" + schema.getSchemaName(), e);\n+        throw e;\n+      }\n+    }\n+    File tableConfigFile = new File(_tableConfigFile);\n+    if (!tableConfigFile.exists()) {", "originalCommit": "07dfa9d2608ceb21fba02e7d248929afcdd54032", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "017b3f38f82ce4a8c57f4ab2a63cc35e613c07be", "url": "https://github.com/apache/pinot/commit/017b3f38f82ce4a8c57f4ab2a63cc35e613c07be", "message": "Update pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/AddTableCommand.java\n\nCo-Authored-By: Subbu Subramaniam <mcvsubbu@users.noreply.github.com>", "committedDate": "2020-01-05T23:11:46Z", "type": "commit"}, {"oid": "31d059e3d47a2d6820c65d1608bfd04e2d22c1d7", "url": "https://github.com/apache/pinot/commit/31d059e3d47a2d6820c65d1608bfd04e2d22c1d7", "message": "Update pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/AddTableCommand.java\n\nCo-Authored-By: Subbu Subramaniam <mcvsubbu@users.noreply.github.com>", "committedDate": "2020-01-05T23:11:54Z", "type": "commit"}, {"oid": "bcdd16c1a5f8e096a9f08c1ca1777e2f4037c45c", "url": "https://github.com/apache/pinot/commit/bcdd16c1a5f8e096a9f08c1ca1777e2f4037c45c", "message": "Address comments, update docs", "committedDate": "2020-01-05T23:39:30Z", "type": "commit"}, {"oid": "9f9651b3b3dc44423811dc1a62657e2213f717d5", "url": "https://github.com/apache/pinot/commit/9f9651b3b3dc44423811dc1a62657e2213f717d5", "message": "fixing docker image build", "committedDate": "2020-01-06T00:45:34Z", "type": "commit"}, {"oid": "9f9651b3b3dc44423811dc1a62657e2213f717d5", "url": "https://github.com/apache/pinot/commit/9f9651b3b3dc44423811dc1a62657e2213f717d5", "message": "fixing docker image build", "committedDate": "2020-01-06T00:45:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM4MzQwMg==", "url": "https://github.com/apache/pinot/pull/4959#discussion_r363383402", "bodyText": "Do we still want to upload schema if exec is not true?", "author": "mcvsubbu", "createdAt": "2020-01-06T16:56:49Z", "path": "pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/AddTableCommand.java", "diffHunk": "@@ -102,33 +111,55 @@ public AddTableCommand setExecute(boolean exec) {\n     return this;\n   }\n \n-  public boolean execute(JsonNode node)\n-      throws IOException {\n-    if (_controllerHost == null) {\n-      _controllerHost = NetUtil.getHostAddress();\n+  public void uploadSchema()\n+      throws Exception {\n+    File schemaFile;\n+    Schema schema;\n+    try {\n+      schemaFile = new File(_schemaFile);\n+      schema = Schema.fromFile(schemaFile);\n+    } catch (Exception e) {\n+      LOGGER.error(\"Got exception while reading Pinot schema from file: [\" + _schemaFile + \"]\");\n+      throw e;\n     }\n-    _controllerAddress = \"http://\" + _controllerHost + \":\" + _controllerPort;\n-\n-    if (!_exec) {\n-      LOGGER.warn(\"Dry Running Command: \" + toString());\n-      LOGGER.warn(\"Use the -exec option to actually execute the command.\");\n-      return true;\n+    try (FileUploadDownloadClient fileUploadDownloadClient = new FileUploadDownloadClient()) {\n+      fileUploadDownloadClient.addSchema(\n+          FileUploadDownloadClient.getUploadSchemaHttpURI(_controllerHost, Integer.parseInt(_controllerPort)),", "originalCommit": "9f9651b3b3dc44423811dc1a62657e2213f717d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ4ODcwMQ==", "url": "https://github.com/apache/pinot/pull/4959#discussion_r363488701", "bodyText": "Dry run shouldn't upload schema. This check is at line 146.", "author": "xiangfu0", "createdAt": "2020-01-06T21:21:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM4MzQwMg=="}], "type": "inlineReview"}]}