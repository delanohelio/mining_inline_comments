{"pr_number": 326, "pr_title": "Implementation of Similar Items row", "pr_createdAt": "2020-02-09T18:52:13Z", "pr_url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326", "timeline": [{"oid": "d416e7d6b649b55e33689835977ff98e737b2c1d", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/d416e7d6b649b55e33689835977ff98e737b2c1d", "message": "Fix wrong default image used for chapters", "committedDate": "2020-02-09T18:45:53Z", "type": "commit"}, {"oid": "0c715a0d196c526a9db68f48f2dd37ad01fadb48", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/0c715a0d196c526a9db68f48f2dd37ad01fadb48", "message": "Implement similar items row", "committedDate": "2020-02-09T18:47:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzY1MA==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376807650", "bodyText": "I'd hardcode this in the function that uses it", "author": "nielsvanvelzen", "createdAt": "2020-02-09T19:11:57Z", "path": "app/src/main/java/org/jellyfin/androidtv/model/itemtypes/LiftedItems.kt", "diffHunk": "@@ -2,9 +2,12 @@ package org.jellyfin.androidtv.model.itemtypes\n \n import org.jellyfin.apiclient.model.dto.BaseItemDto\n import org.jellyfin.apiclient.model.dto.BaseItemType\n+import org.jellyfin.apiclient.model.querying.ItemFields\n import java.util.*\n import kotlin.properties.Delegates\n \n+val FieldsRequiredForLift = arrayOf(ItemFields.DateCreated, ItemFields.MediaSources, ItemFields.MediaStreams, ItemFields.People)", "originalCommit": "0c715a0d196c526a9db68f48f2dd37ad01fadb48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNjA3Ng==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376816076", "bodyText": "We might need this in multiple places though and it may need to be updated once we implement more item types, which is why I put it locally close to where the classes are defined.", "author": "AndreasGB", "createdAt": "2020-02-09T21:16:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzY1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNjM2NQ==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376816365", "bodyText": "Fair enough, can you change it to use the proper naming convention?", "author": "nielsvanvelzen", "createdAt": "2020-02-09T21:20:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzY1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNjU4OA==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376816588", "bodyText": "Sure, will do", "author": "AndreasGB", "createdAt": "2020-02-09T21:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzc1MA==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376807750", "bodyText": "I'd add the limit as parameter with 10 as default value\nMaybe increase it to 25 or something too", "author": "nielsvanvelzen", "createdAt": "2020-02-09T19:13:51Z", "path": "app/src/main/java/org/jellyfin/androidtv/util/apiclient/ApiClientExtensions.kt", "diffHunk": "@@ -45,10 +48,26 @@ suspend fun ApiClient.markUnplayed(itemId: String, userId: String) : UserItemDat\n \t})\n }\n \n-\n suspend fun ApiClient.updateFavoriteStatus(itemId: String, userId: String, isFavorite: Boolean) : UserItemDataDto? = suspendCoroutine { continuation ->\n \tUpdateFavoriteStatusAsync(itemId, userId, isFavorite, object : Response<UserItemDataDto>() {\n \t\toverride fun onResponse(response: UserItemDataDto?) { continuation.resume(response!!) }\n \t\toverride fun onError(exception: Exception?) { continuation.resume(null) }\n \t})\n }\n+\n+suspend fun ApiClient.getSimilarItems(item: BaseItem): List<BaseItem>? = suspendCoroutine {continuation ->\n+\tval query = SimilarItemsQuery()\n+\tquery.setUserId(TvApp.getApplication().currentUser.id)\n+\tquery.setId(item.id)\n+\tquery.setLimit(10)", "originalCommit": "0c715a0d196c526a9db68f48f2dd37ad01fadb48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNjQ5Nw==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376816497", "bodyText": "Sure, can do that", "author": "AndreasGB", "createdAt": "2020-02-09T21:22:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzc3NA==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376807774", "bodyText": "You can use .apply or .also here", "author": "nielsvanvelzen", "createdAt": "2020-02-09T19:14:19Z", "path": "app/src/main/java/org/jellyfin/androidtv/util/apiclient/ApiClientExtensions.kt", "diffHunk": "@@ -45,10 +48,26 @@ suspend fun ApiClient.markUnplayed(itemId: String, userId: String) : UserItemDat\n \t})\n }\n \n-\n suspend fun ApiClient.updateFavoriteStatus(itemId: String, userId: String, isFavorite: Boolean) : UserItemDataDto? = suspendCoroutine { continuation ->\n \tUpdateFavoriteStatusAsync(itemId, userId, isFavorite, object : Response<UserItemDataDto>() {\n \t\toverride fun onResponse(response: UserItemDataDto?) { continuation.resume(response!!) }\n \t\toverride fun onError(exception: Exception?) { continuation.resume(null) }\n \t})\n }\n+\n+suspend fun ApiClient.getSimilarItems(item: BaseItem): List<BaseItem>? = suspendCoroutine {continuation ->\n+\tval query = SimilarItemsQuery()", "originalCommit": "0c715a0d196c526a9db68f48f2dd37ad01fadb48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNjUwOQ==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376816509", "bodyText": "Will do", "author": "AndreasGB", "createdAt": "2020-02-09T21:22:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzgzMA==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376807830", "bodyText": "Maybe add an expected type to the getSimilarItems so it won't respond with data you don't need", "author": "nielsvanvelzen", "createdAt": "2020-02-09T19:15:38Z", "path": "app/src/main/java/org/jellyfin/androidtv/details/MovieDetailsFragment.kt", "diffHunk": "@@ -66,6 +68,14 @@ class MovieDetailsFragment(item: Movie) : BaseDetailsFragment<Movie>(item) {\n \t\t\titem.cast.forEach(it::add)\n \t\t}\n \n+\t\tval similarItems = TvApp.getApplication().apiClient.getSimilarItems(item)\n+\t\tval similarMovies = similarItems?.filter { it is Movie }", "originalCommit": "0c715a0d196c526a9db68f48f2dd37ad01fadb48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNjM5Nw==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376816397", "bodyText": "Hmm, we could use generics and then integrate the filter into the method, but I'm not sure there how we would allow multiple types to pass.", "author": "AndreasGB", "createdAt": "2020-02-09T21:20:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzgzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNjUxOA==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376816518", "bodyText": "Doesn't the query class support setting a type?", "author": "nielsvanvelzen", "createdAt": "2020-02-09T21:22:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzgzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNjcxOA==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376816718", "bodyText": "I don't think so", "author": "AndreasGB", "createdAt": "2020-02-09T21:24:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzgzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNjcyNQ==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376816725", "bodyText": "Nope it does not support that.", "author": "nielsvanvelzen", "createdAt": "2020-02-09T21:24:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzgzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNjgyMw==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376816823", "bodyText": "In that case just one-line it like this:\nval similarItems = TvApp.getApplication().apiClient.getSimilarItems(item)?.filter { it is Movie }", "author": "nielsvanvelzen", "createdAt": "2020-02-09T21:26:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzgzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzkwMQ==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376807901", "bodyText": "This doesn't do anything...", "author": "nielsvanvelzen", "createdAt": "2020-02-09T19:16:26Z", "path": "app/src/main/java/org/jellyfin/androidtv/details/ItemPosterPresenter.kt", "diffHunk": "@@ -0,0 +1,59 @@\n+package org.jellyfin.androidtv.details\n+\n+import android.content.Context\n+import android.content.Intent\n+import android.graphics.drawable.BitmapDrawable\n+import android.view.ViewGroup\n+import androidx.appcompat.view.ContextThemeWrapper\n+import androidx.leanback.widget.ImageCardView\n+import androidx.leanback.widget.Presenter\n+import kotlinx.coroutines.Dispatchers\n+import kotlinx.coroutines.GlobalScope\n+import kotlinx.coroutines.launch\n+import org.jellyfin.androidtv.R\n+import org.jellyfin.androidtv.TvApp\n+import org.jellyfin.androidtv.base.IItemClickListener\n+import org.jellyfin.androidtv.model.itemtypes.BaseItem\n+\n+private const val LOG_TAG = \"ItemPosterPresenter\"\n+\n+class ItemPosterPresenter(private val context: Context) : Presenter(), IItemClickListener {\n+\n+\toverride suspend fun onItemClicked(item: Any?) {\n+\t\trequireNotNull(item)\n+\t\tval baseItem = item as BaseItem\n+\t\tval intent = Intent(context, DetailsActivity::class.java)\n+\t\tintent.putExtra(\"id\", baseItem.id)\n+\n+\t\tcontext.startActivity(intent)\n+\t}\n+\n+\toverride fun onCreateViewHolder(parent: ViewGroup?): ViewHolder {\n+\t\treturn ViewHolder(ImageCardView(ContextThemeWrapper(parent!!.context, R.style.MarqueeImageCardViewTheme)))\n+\t}\n+\n+\toverride fun onBindViewHolder(viewHolder: ViewHolder, item: Any) {\n+\t\tval baseItem = item as BaseItem\n+\t\tval cardView = viewHolder.view as ImageCardView\n+\n+\t\tcardView.titleText = baseItem.name\n+\t\tcardView.contentText = baseItem.description\n+\t\tcardView.isFocusable = true\n+\t\tcardView.isFocusableInTouchMode = true\n+\t\tcardView.setMainImageDimensions(200, 300)\n+\t\tcardView.mainImage = TvApp.getApplication().getDrawableCompat(R.drawable.tile_port_video)\n+\n+\t\tif (baseItem.images.primary != null) {\n+\t\t\tGlobalScope.launch(Dispatchers.Main) {\n+\t\t\t\tcardView.mainImage = BitmapDrawable(baseItem.images.primary.getBitmap(TvApp.getApplication()))\n+\t\t\t}\n+\t\t}\n+\n+\t}\n+\n+\toverride fun onUnbindViewHolder(viewHolder: ViewHolder?) {", "originalCommit": "0c715a0d196c526a9db68f48f2dd37ad01fadb48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNjQyMw==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376816423", "bodyText": "True", "author": "AndreasGB", "createdAt": "2020-02-09T21:21:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxNzIxMQ==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376817211", "bodyText": "I would btw like to keep it for the TODO it contains", "author": "AndreasGB", "createdAt": "2020-02-09T21:31:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwNzkwMQ=="}], "type": "inlineReview"}, {"oid": "1ce36161d22727246b80103495c85f3672b622ac", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/1ce36161d22727246b80103495c85f3672b622ac", "message": "Refactoring + Add limit to similar items query", "committedDate": "2020-02-09T21:36:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxODAxOA==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376818018", "bodyText": "I think this sets the value of query.limit to query.limit", "author": "nielsvanvelzen", "createdAt": "2020-02-09T21:41:34Z", "path": "app/src/main/java/org/jellyfin/androidtv/util/apiclient/ApiClientExtensions.kt", "diffHunk": "@@ -55,12 +55,14 @@ suspend fun ApiClient.updateFavoriteStatus(itemId: String, userId: String, isFav\n \t})\n }\n \n-suspend fun ApiClient.getSimilarItems(item: BaseItem): List<BaseItem>? = suspendCoroutine {continuation ->\n-\tval query = SimilarItemsQuery()\n-\tquery.setUserId(TvApp.getApplication().currentUser.id)\n-\tquery.setId(item.id)\n-\tquery.setLimit(10)\n-\tquery.fields = FieldsRequiredForLift\n+suspend fun ApiClient.getSimilarItems(item: BaseItem, limit: Int = 25): List<BaseItem>? = suspendCoroutine { continuation ->\n+\tval query = SimilarItemsQuery().apply {\n+\t\tid = item.id\n+\t\tuserId = TvApp.getApplication().currentUser.id\n+\t\tthis.limit = limit", "originalCommit": "1ce36161d22727246b80103495c85f3672b622ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxODIyNw==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376818227", "bodyText": "IntelliJ syntax highlighting highlighted the other limit, I'll check with the debugger, just to be sure", "author": "AndreasGB", "createdAt": "2020-02-09T21:43:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxODAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxODI5Mw==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/326#discussion_r376818293", "bodyText": "Works", "author": "AndreasGB", "createdAt": "2020-02-09T21:45:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgxODAxOA=="}], "type": "inlineReview"}, {"oid": "5b75076e2b663806d9b55029695f3f29a4c8b979", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/5b75076e2b663806d9b55029695f3f29a4c8b979", "message": "Tiny refactor", "committedDate": "2020-02-09T21:48:02Z", "type": "commit"}]}