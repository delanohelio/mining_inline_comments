{"pr_number": 260, "pr_title": "Refactor preferences", "pr_createdAt": "2020-01-09T19:37:57Z", "pr_url": "https://github.com/jellyfin/jellyfin-androidtv/pull/260", "timeline": [{"oid": "2c6b21f98006c01a00bc7712e45fe560a80ebb8a", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/2c6b21f98006c01a00bc7712e45fe560a80ebb8a", "message": "Create abstract SharedPreferenceStore and implement it for system preferences", "committedDate": "2020-01-09T19:36:52Z", "type": "commit"}, {"oid": "c5361af21d6ce55e3540d15d3769d623f1668963", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/c5361af21d6ce55e3540d15d3769d623f1668963", "message": "Replace TvApp.getPrefs()", "committedDate": "2020-01-09T20:21:43Z", "type": "commit"}, {"oid": "3d80458d1473cb3ee01ba804730c4f40c1ca7eda", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/3d80458d1473cb3ee01ba804730c4f40c1ca7eda", "message": "Replace 2 occurrences where SharedPreferences was called directly", "committedDate": "2020-01-09T20:24:41Z", "type": "commit"}, {"oid": "79d7e6ffd184f17a60b9769d7ebed0e6120f765d", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/79d7e6ffd184f17a60b9769d7ebed0e6120f765d", "message": "Add preference migrations", "committedDate": "2020-01-09T21:08:33Z", "type": "commit"}, {"oid": "992737f865eb5368209c48a983c7bb6c83151709", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/992737f865eb5368209c48a983c7bb6c83151709", "message": "Remove deprecated methods for getting preferences", "committedDate": "2020-01-09T21:11:52Z", "type": "commit"}, {"oid": "2cb1939709f0b7090c054d2030804d3aeff15e33", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/2cb1939709f0b7090c054d2030804d3aeff15e33", "message": "Move preferences to preferences namespace", "committedDate": "2020-01-09T21:16:48Z", "type": "commit"}, {"oid": "6f70c387d6ff4dcf2005cfdec0044c8c5e400714", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/6f70c387d6ff4dcf2005cfdec0044c8c5e400714", "message": "Move SettingsActivity and SettingsFragment to preferences.ui namespace", "committedDate": "2020-01-09T21:17:30Z", "type": "commit"}, {"oid": "580636b8eea32b1f454923ba1a9dd067f3663af7", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/580636b8eea32b1f454923ba1a9dd067f3663af7", "message": "Remove sys_pref_config_version", "committedDate": "2020-01-09T21:17:56Z", "type": "commit"}, {"oid": "a97d1990cdfb08e94c6385921e47f3e6842a5fba", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/a97d1990cdfb08e94c6385921e47f3e6842a5fba", "message": "Initial kdoc", "committedDate": "2020-01-09T21:36:26Z", "type": "commit"}, {"oid": "a61dd5cf827af6bb7965506a3dcc39907b40a4c5", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/a61dd5cf827af6bb7965506a3dcc39907b40a4c5", "message": "Add not-null version of stringPreference", "committedDate": "2020-01-09T21:41:09Z", "type": "commit"}, {"oid": "4fa17f5982509b01ecc9962eba0cd25ef3c5b780", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/4fa17f5982509b01ecc9962eba0cd25ef3c5b780", "message": "Remove preferences.md (accidentally commited)", "committedDate": "2020-01-09T21:42:56Z", "type": "commit"}, {"oid": "7298a8e17a635daf49b2204da6676252ab9492af", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/7298a8e17a635daf49b2204da6676252ab9492af", "message": "Convert settings activity and fragment to androidx with kotlin. Further changes should be done in a separate PR", "committedDate": "2020-01-11T13:10:42Z", "type": "commit"}, {"oid": "4287d86498252bafa349d0257b0b05790cdf67ce", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/4287d86498252bafa349d0257b0b05790cdf67ce", "message": "Document UserPreferences", "committedDate": "2020-01-11T13:27:55Z", "type": "commit"}, {"oid": "0d70907197590a5f40c10e20961f4455fb980a62", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/0d70907197590a5f40c10e20961f4455fb980a62", "message": "Convert AudioBehavior to enum", "committedDate": "2020-01-11T13:55:11Z", "type": "commit"}, {"oid": "e37ed85f44edaa5419a4288f67257b30bd61233e", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/e37ed85f44edaa5419a4288f67257b30bd61233e", "message": "Convert LoginBehavior to enum", "committedDate": "2020-01-11T14:02:54Z", "type": "commit"}, {"oid": "fad30d1a9dffecf54abbbe96204bd9baf73fa529", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/fad30d1a9dffecf54abbbe96204bd9baf73fa529", "message": "Convert PreferredVideoPlayer to enum", "committedDate": "2020-01-11T14:07:55Z", "type": "commit"}, {"oid": "8baafea76d6c5acf30540324289f6dbdcebc220b", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/8baafea76d6c5acf30540324289f6dbdcebc220b", "message": "Make enums not-null", "committedDate": "2020-01-11T14:14:43Z", "type": "commit"}, {"oid": "370473a699768f56205897a74a90062388d3d7e0", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/370473a699768f56205897a74a90062388d3d7e0", "message": "Fix CI error", "committedDate": "2020-01-11T16:04:00Z", "type": "commit"}, {"oid": "bc6d8c9f6d6ae917d544c510bc7434af3d580713", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/bc6d8c9f6d6ae917d544c510bc7434af3d580713", "message": "Remove old migration code", "committedDate": "2020-01-11T16:04:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcwODAwNQ==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/260#discussion_r367708005", "bodyText": "Should we be using LeanbackPreferenceFragmentCompat?", "author": "thornbill", "createdAt": "2020-01-16T23:50:19Z", "path": "app/src/main/java/org/jellyfin/androidtv/preferences/ui/UserPreferencesFragment.kt", "diffHunk": "@@ -0,0 +1,145 @@\n+package org.jellyfin.androidtv.preferences.ui\n+\n+import android.app.AlertDialog\n+import android.content.SharedPreferences\n+import android.content.SharedPreferences.OnSharedPreferenceChangeListener\n+import android.os.Bundle\n+import androidx.preference.*\n+import org.jellyfin.androidtv.R\n+import org.jellyfin.androidtv.TvApp\n+import org.jellyfin.androidtv.model.LogonCredentials\n+import org.jellyfin.androidtv.util.DeviceUtils\n+import org.jellyfin.androidtv.util.apiclient.AuthenticationHelper\n+import java.io.IOException\n+\n+class UserPreferencesFragment : PreferenceFragmentCompat(), OnSharedPreferenceChangeListener {", "originalCommit": "bc6d8c9f6d6ae917d544c510bc7434af3d580713", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1ODQ3NA==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/260#discussion_r368058474", "bodyText": "LeanbackPreferenceFragmentCompat unfortunately doesn't work, when I tried it previously it crashed the application. So for now I didn't change the ui much. I might do that in the future though.", "author": "nielsvanvelzen", "createdAt": "2020-01-17T17:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcwODAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2MDgxMg==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/260#discussion_r368260812", "bodyText": "I don\u2019t like that this doesn\u2019t match the app theme. Maybe we should extend the default theme you used to apply the Jellyfin colors as a temporary solution?", "author": "thornbill", "createdAt": "2020-01-19T02:32:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcwODAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4NTY2Mg==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/260#discussion_r368285662", "bodyText": "I managed to get the leanback style preferences working. It now looks like this:", "author": "nielsvanvelzen", "createdAt": "2020-01-19T11:12:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcwODAwNQ=="}], "type": "inlineReview"}, {"oid": "5e0784feec5e8ea79fa046e2d40706eb0c84873d", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/5e0784feec5e8ea79fa046e2d40706eb0c84873d", "message": "Use Jellyfin Appcompat theme", "committedDate": "2020-01-19T09:26:14Z", "type": "commit"}, {"oid": "4a1c09a8d9702ca6885d57b639d54f8e34be69e0", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/4a1c09a8d9702ca6885d57b639d54f8e34be69e0", "message": "Convert to leanback preferences", "committedDate": "2020-01-19T10:56:37Z", "type": "commit"}, {"oid": "fd72b7819c4263602ec12ef51af0faa1cd88bb0a", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/fd72b7819c4263602ec12ef51af0faa1cd88bb0a", "message": "Format preferences xml", "committedDate": "2020-01-19T10:56:51Z", "type": "commit"}, {"oid": "2e0f8431127bf0c32d6189f9e10b96f3d2bcac6f", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/2e0f8431127bf0c32d6189f9e10b96f3d2bcac6f", "message": "Layout changes", "committedDate": "2020-01-19T11:11:34Z", "type": "commit"}, {"oid": "df09859288440f50e46f237bccaf16b2f707ea64", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/df09859288440f50e46f237bccaf16b2f707ea64", "message": "Use transparent background for preferences", "committedDate": "2020-01-19T11:17:58Z", "type": "commit"}, {"oid": "c67afcd4380eb4c84687a4750b3b805083d0f8c9", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/c67afcd4380eb4c84687a4750b3b805083d0f8c9", "message": "Merge branch 'master' into preference-refactor", "committedDate": "2020-02-05T16:48:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2OTk0Mw==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/260#discussion_r376769943", "bodyText": "Might want to move this to the newly created stores", "author": "nielsvanvelzen", "createdAt": "2020-02-09T09:55:15Z", "path": "app/src/main/java/org/jellyfin/androidtv/startup/StartupActivity.java", "diffHunk": "@@ -57,26 +57,6 @@ protected void onCreate(Bundle savedInstanceState) {\n         application = (TvApp) getApplicationContext();\n         logger = application.getLogger();\n \n-        //Migrate prefs\n-        if (Integer.parseInt(application.getConfigVersion()) < 2) {\n-            application.getSystemPrefs().edit().putString(\"sys_pref_config_version\", \"2\").apply();\n-        }\n-        if (Integer.parseInt(application.getConfigVersion()) < 3) {\n-            application.getPrefs().edit().putString(\"pref_max_bitrate\", \"0\").apply();\n-            application.getSystemPrefs().edit().putString(\"sys_pref_config_version\", \"3\").apply();\n-        }\n-        if (Integer.parseInt(application.getConfigVersion()) < 4) {\n-            application.getPrefs().edit().putBoolean(\"pref_enable_premieres\", false).apply();\n-            application.getPrefs().edit().putBoolean(\"pref_enable_info_panel\", false).apply();\n-            application.getSystemPrefs().edit().putString(\"sys_pref_config_version\", \"4\").apply();\n-        }\n-        if (Integer.parseInt(application.getConfigVersion()) < 5) {\n-            boolean useExternal = application.getPrefs().getBoolean(\"pref_video_use_external\", false);\n-\n-            application.getPrefs().edit().putString(\"pref_video_player\", useExternal ? \"external\" : \"auto\").apply();\n-            application.getSystemPrefs().edit().putString(\"sys_pref_config_version\", \"5\").apply();\n-        }\n-\n         //Ensure we have prefs\n         PreferenceManager.setDefaultValues(this, R.xml.preferences, false);", "originalCommit": "c67afcd4380eb4c84687a4750b3b805083d0f8c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d8afabf19f39d4a5cefb22a5ca3fd97f2296120d", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/d8afabf19f39d4a5cefb22a5ca3fd97f2296120d", "message": "Merge branch 'master' into preference-refactor\n\n# Conflicts:\n#\tapp/build.gradle\n#\tapp/src/main/java/org/jellyfin/androidtv/playback/CustomPlaybackOverlayFragment.java\n#\tapp/src/main/java/org/jellyfin/androidtv/playback/ExternalPlayerActivity.java\n#\tapp/src/main/java/org/jellyfin/androidtv/startup/StartupActivity.java\n#\tapp/src/main/res/xml/preferences.xml", "committedDate": "2020-02-10T15:50:25Z", "type": "commit"}, {"oid": "5d4dd86f1e7ea648b3a8dd10461fe8f5984be370", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/5d4dd86f1e7ea648b3a8dd10461fe8f5984be370", "message": "Fix dependency after merge", "committedDate": "2020-02-10T15:51:05Z", "type": "commit"}, {"oid": "07cf1a18c25686449fbf4e6a94614e08e6a9ce0f", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/07cf1a18c25686449fbf4e6a94614e08e6a9ce0f", "message": "Fix misc merge issues", "committedDate": "2020-02-10T15:55:58Z", "type": "commit"}, {"oid": "7d2669f97380856e2c6d5c48abb34ea60b211bef", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/7d2669f97380856e2c6d5c48abb34ea60b211bef", "message": "Use same version for leanback and leanback-preference", "committedDate": "2020-02-10T16:01:11Z", "type": "commit"}, {"oid": "3686914935358980fb35916e0d5bc82bdfb6392f", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/3686914935358980fb35916e0d5bc82bdfb6392f", "message": "Merge branch 'master' into preference-refactor\n\n# Conflicts:\n#\tapp/build.gradle.kts", "committedDate": "2020-02-10T16:39:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIyNjgzNw==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/260#discussion_r377226837", "bodyText": "It seems all boolean preferences are being defaulted to false now. Is this correct?", "author": "thornbill", "createdAt": "2020-02-10T18:05:28Z", "path": "app/src/main/java/org/jellyfin/androidtv/preferences/UserPreferences.kt", "diffHunk": "@@ -0,0 +1,169 @@\n+package org.jellyfin.androidtv.preferences\n+\n+import android.content.Context\n+import android.preference.PreferenceManager\n+import org.jellyfin.androidtv.preferences.enums.AudioBehavior\n+import org.jellyfin.androidtv.preferences.enums.LoginBehavior\n+import org.jellyfin.androidtv.preferences.enums.PreferredVideoPlayer\n+\n+/**\n+ * User preferences are configurable by the user and change behavior of the application.\n+ * When changing preferences migration should be added to the init function.\n+ *\n+ * @param context Context to get the SharedPreferences from\n+ */\n+class UserPreferences(context: Context) : SharedPreferenceStore(PreferenceManager.getDefaultSharedPreferences(context)) {\n+\t/* Authentication */\n+\t/**\n+\t * Behavior for login when starting the app.\n+\t * **note**: Currently settable via user-preferences only due too custom logic\n+\t */\n+\tvar loginBehavior by enumPreference(\"login_behavior\", LoginBehavior.SHOW_LOGIN)\n+\t\tprivate set\n+\n+\t/**\n+\t * Ask for password when starting the app\n+\t */\n+\tvar passwordPromptEnabled by booleanPreference(\"pref_auto_pw_prompt\", false)\n+\n+\t/**\n+\t * Use login using pin (when set)\n+\t */\n+\tvar passwordDPadEnabled by booleanPreference(\"pref_alt_pw_entry\", false)\n+\n+\t/**\n+\t * Sign out automatically after x milliseconds\n+\t */\n+\tvar autoSignOutTimeout by stringPreference(\"pref_auto_logoff_timeout\", \"3600000\")\n+\n+\t/* Display */\n+\t/**\n+\t * Enable background images while browsing\n+\t */\n+\tvar backdropEnabled by booleanPreference(\"pref_show_backdrop\", false)", "originalCommit": "3686914935358980fb35916e0d5bc82bdfb6392f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2NTYzMw==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/260#discussion_r377265633", "bodyText": "I might have forgotten to set the default values for the booleans. I'll check them tomorrow.", "author": "nielsvanvelzen", "createdAt": "2020-02-10T19:21:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIyNjgzNw=="}], "type": "inlineReview"}, {"oid": "84f7677f5470a94562a3ea56d77329e4be8a3beb", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/84f7677f5470a94562a3ea56d77329e4be8a3beb", "message": "Merge branch 'master' into preference-refactor\n\n# Conflicts:\n#\tapp/src/main/AndroidManifest.xml", "committedDate": "2020-02-11T09:02:39Z", "type": "commit"}, {"oid": "849622cd4111a5168e9a6891063d3e6151eaf973", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/849622cd4111a5168e9a6891063d3e6151eaf973", "message": "Fix bad merge", "committedDate": "2020-02-11T09:03:57Z", "type": "commit"}, {"oid": "ccd31da81441d3d677d637fa2446380e277276c1", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/ccd31da81441d3d677d637fa2446380e277276c1", "message": "Fix default values for boolean", "committedDate": "2020-02-11T09:07:10Z", "type": "commit"}, {"oid": "f1fe17aa4ba956a6da2463a1c14db36c8e2f3335", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/f1fe17aa4ba956a6da2463a1c14db36c8e2f3335", "message": "Update migrations", "committedDate": "2020-02-11T09:10:28Z", "type": "commit"}, {"oid": "de21599a3649ddbb3642c92bb861ce6828323366", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/de21599a3649ddbb3642c92bb861ce6828323366", "message": "Use androidx.preference library", "committedDate": "2020-02-11T09:16:16Z", "type": "commit"}, {"oid": "679c40c69207357e90f92bfb326177ce3feb04e9", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/679c40c69207357e90f92bfb326177ce3feb04e9", "message": "Fix some warnings", "committedDate": "2020-02-11T09:19:04Z", "type": "commit"}]}