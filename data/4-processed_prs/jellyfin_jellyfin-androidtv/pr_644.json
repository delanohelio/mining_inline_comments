{"pr_number": 644, "pr_title": "Add initial authentication storage", "pr_createdAt": "2020-11-29T10:24:15Z", "pr_url": "https://github.com/jellyfin/jellyfin-androidtv/pull/644", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4OTkwMg==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/644#discussion_r547089902", "bodyText": "We should suppress these warnings.", "author": "thornbill", "createdAt": "2020-12-22T06:18:05Z", "path": "app/src/main/java/org/jellyfin/androidtv/auth/AuthenticationRepository.kt", "diffHunk": "@@ -0,0 +1,138 @@\n+package org.jellyfin.androidtv.auth\n+\n+import kotlinx.coroutines.ExperimentalCoroutinesApi\n+import kotlinx.coroutines.flow.Flow\n+import kotlinx.coroutines.flow.emitAll\n+import kotlinx.coroutines.flow.flow\n+import org.jellyfin.androidtv.JellyfinApplication\n+import org.jellyfin.androidtv.auth.model.*\n+import org.jellyfin.androidtv.util.apiclient.callApi\n+import org.jellyfin.androidtv.util.toUUID\n+import org.jellyfin.apiclient.Jellyfin\n+import org.jellyfin.apiclient.interaction.ApiClient\n+import org.jellyfin.apiclient.interaction.device.IDevice\n+import org.jellyfin.apiclient.model.apiclient.ServerInfo\n+import org.jellyfin.apiclient.model.dto.UserDto\n+import org.jellyfin.apiclient.model.users.AuthenticationResult\n+import timber.log.Timber\n+import java.util.*\n+\n+class AuthenticationRepository(\n+\tprivate val application: JellyfinApplication,\n+\tprivate val jellyfin: Jellyfin,\n+\tprivate val apiClient: ApiClient,\n+\tprivate val device: IDevice,\n+\tprivate val accountManagerHelper: AccountManagerHelper,\n+\tprivate val authenticationStore: AuthenticationStore,\n+) {\n+\tfun getServers() = authenticationStore.getServers().map { (id, info) ->\n+\t\tServer(id, info.name, info.address, Date(info.lastUsed))\n+\t}\n+\n+\tfun getUsers(server: UUID): List<PrivateUser>? = authenticationStore.getUsers(server)?.mapNotNull { (userId, userInfo) ->\n+\t\taccountManagerHelper.getAccount(userId)?.let { authInfo ->\n+\t\t\tPrivateUser(userId, authInfo.server, userInfo.name, authInfo.accessToken)\n+\t\t}\n+\t}\n+\n+\tfun saveServer(id: UUID, name: String, address: String) {\n+\t\tval current = authenticationStore.getServer(id)\n+\n+\t\tif (current != null)\n+\t\t\tauthenticationStore.putServer(id, current.copy(name = name, address = address))\n+\t\telse\n+\t\t\tauthenticationStore.putServer(id, AuthenticationStoreServer(name, address))\n+\t}\n+\n+\t/**\n+\t * Set the active session to the information in [user] and [server].\n+\t * Connects to the server and requests the info of the currently authenticated user.\n+\t *\n+\t * @return Whether the user information can be retrieved\n+\t */\n+\tprivate suspend fun setActiveSession(user: User, server: Server): Boolean {\n+\t\tapiClient.SetAuthenticationInfo(user.accessToken, user.id.toString())\n+\t\tapiClient.EnableAutomaticNetworking(ServerInfo().apply {\n+\t\t\tid = server.id.toString()\n+\t\t\tname = server.name\n+\t\t\taddress = server.address\n+\t\t\tuserId = user.id.toString()\n+\t\t\taccessToken = user.accessToken\n+\t\t})\n+\n+\t\ttry {\n+\t\t\tval userDto = callApi<UserDto?> { callback -> apiClient.GetUserAsync(user.id.toString(), callback) }\n+\t\t\tif (userDto != null) {\n+\t\t\t\tapplication.currentUser = userDto\n+\t\t\t\treturn true\n+\t\t\t}\n+\t\t} catch (err: Exception) {", "originalCommit": "dc8428b0bf05bfb7370bdf4c7a271b2251a37a45", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "63e599f0683e6043463f6a3ece18dccf11aff86e", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/63e599f0683e6043463f6a3ece18dccf11aff86e", "message": "Implement the Android AccountStore to save users", "committedDate": "2020-12-22T21:33:02Z", "type": "commit"}, {"oid": "89b0dd577fd4a00554ffdf06312d276b07bfbe0d", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/89b0dd577fd4a00554ffdf06312d276b07bfbe0d", "message": "Initial authentication storage code", "committedDate": "2020-12-22T21:33:03Z", "type": "commit"}, {"oid": "5a3dcfc4483842443f88ce56c0ae8f4e98763937", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/5a3dcfc4483842443f88ce56c0ae8f4e98763937", "message": "Integration test", "committedDate": "2020-12-22T21:33:05Z", "type": "commit"}, {"oid": "c72895df5f0ef3f10601ea0c7fe05435d1f0670b", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/c72895df5f0ef3f10601ea0c7fe05435d1f0670b", "message": "extensions -> class", "committedDate": "2020-12-22T21:33:06Z", "type": "commit"}, {"oid": "de661fe4d4022b7448a8c57b3a1dbe261564a901", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/de661fe4d4022b7448a8c57b3a1dbe261564a901", "message": "viewmodel progress", "committedDate": "2020-12-22T21:33:07Z", "type": "commit"}, {"oid": "8bd6bc82d90bfd60fc88684cf905036f3704ef37", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/8bd6bc82d90bfd60fc88684cf905036f3704ef37", "message": "use uuid", "committedDate": "2020-12-22T21:33:09Z", "type": "commit"}, {"oid": "79e5151741f8f16f77591d9bdfe29cf8dbe3291c", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/79e5151741f8f16f77591d9bdfe29cf8dbe3291c", "message": "LiveData mess", "committedDate": "2020-12-22T21:33:10Z", "type": "commit"}, {"oid": "4836b8b27e69660e0707760f19452256749c9544", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/4836b8b27e69660e0707760f19452256749c9544", "message": "Restore saved servers", "committedDate": "2020-12-22T21:33:11Z", "type": "commit"}, {"oid": "27add9f826ca80eb7089c56f54c58c02f0227bc9", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/27add9f826ca80eb7089c56f54c58c02f0227bc9", "message": "Add backups", "committedDate": "2020-12-22T21:33:12Z", "type": "commit"}, {"oid": "a4df38a10e27d4847a7b81984f98b6e4d68a3bad", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/a4df38a10e27d4847a7b81984f98b6e4d68a3bad", "message": "New flow based server and user retrieval", "committedDate": "2020-12-22T21:33:17Z", "type": "commit"}, {"oid": "4c52ae5e9c0ecb2fa5ae295828eef7fbd2ef692a", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/4c52ae5e9c0ecb2fa5ae295828eef7fbd2ef692a", "message": "Add other sources for servers and users and remove duplicates", "committedDate": "2020-12-22T21:33:23Z", "type": "commit"}, {"oid": "07e20b3323c091bd8a12a1ca9a2255bea9568da2", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/07e20b3323c091bd8a12a1ca9a2255bea9568da2", "message": "Fix legacy credential uuid's", "committedDate": "2020-12-22T21:33:28Z", "type": "commit"}, {"oid": "b980aa9bd4c2e56bf8fb269142bcd536b2b45041", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/b980aa9bd4c2e56bf8fb269142bcd536b2b45041", "message": "Save server", "committedDate": "2020-12-22T21:33:31Z", "type": "commit"}, {"oid": "0beb56edc7bd004238a242e072faccbbe3ae7e4a", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/0beb56edc7bd004238a242e072faccbbe3ae7e4a", "message": "Initial signin support", "committedDate": "2020-12-22T21:33:33Z", "type": "commit"}, {"oid": "80e6118bdd113adc706a7cd2d796af447e877411", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/80e6118bdd113adc706a7cd2d796af447e877411", "message": "Store user dto after signing in", "committedDate": "2020-12-22T21:33:34Z", "type": "commit"}, {"oid": "c4dea67647e3f8dcba408111f10b0bdc10b46513", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/c4dea67647e3f8dcba408111f10b0bdc10b46513", "message": "Allow login with server from legacy format", "committedDate": "2020-12-22T21:33:35Z", "type": "commit"}, {"oid": "876d87631d9deb764d1c12a9496b55a839836b4c", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/876d87631d9deb764d1c12a9496b55a839836b4c", "message": "Fix legacy user not showing and duplicates not handled when UUID format was different", "committedDate": "2020-12-22T21:33:36Z", "type": "commit"}, {"oid": "aa32bf3f905922d5f70ab8828c77a2aa3eb03a9c", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/aa32bf3f905922d5f70ab8828c77a2aa3eb03a9c", "message": "Store imagetag instead of url", "committedDate": "2020-12-22T21:33:37Z", "type": "commit"}, {"oid": "5cbc249701ba772f5a8103603450b7fb735654b3", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/5cbc249701ba772f5a8103603450b7fb735654b3", "message": "Re-order manifest", "committedDate": "2020-12-22T21:33:38Z", "type": "commit"}, {"oid": "6e9454fd1a313cddf916c2b9573c3dfd5a4fb0f8", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/6e9454fd1a313cddf916c2b9573c3dfd5a4fb0f8", "message": "Optimize models", "committedDate": "2020-12-22T21:33:39Z", "type": "commit"}, {"oid": "d5baf94fe4f089789e4b92f3a7f8032717f8c044", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/d5baf94fe4f089789e4b92f3a7f8032717f8c044", "message": "Add getUser/getServer functions", "committedDate": "2020-12-22T21:33:40Z", "type": "commit"}, {"oid": "fb7ec6837d7cbc66f474f09808d0ecddec617a50", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/fb7ec6837d7cbc66f474f09808d0ecddec617a50", "message": "More cleaning", "committedDate": "2020-12-22T21:33:41Z", "type": "commit"}, {"oid": "0abaff4b716f82c864ab00a33839942899b0e6a5", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/0abaff4b716f82c864ab00a33839942899b0e6a5", "message": "url -> address", "committedDate": "2020-12-22T21:33:43Z", "type": "commit"}, {"oid": "26d8ceac802380d39ebbe229a7ca0ed201e8ab28", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/26d8ceac802380d39ebbe229a7ca0ed201e8ab28", "message": "Fix few crashes", "committedDate": "2020-12-22T21:33:44Z", "type": "commit"}, {"oid": "7c27daeccc54cd21c77d7978f9a8345104b08103", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/7c27daeccc54cd21c77d7978f9a8345104b08103", "message": "Convert legacy credentials to new format on boot", "committedDate": "2020-12-22T21:33:45Z", "type": "commit"}, {"oid": "8002a6832532ae00b984dda725dda382f46b54ac", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/8002a6832532ae00b984dda725dda382f46b54ac", "message": "Remvoe profile picture (unused, can use id)", "committedDate": "2020-12-22T21:33:47Z", "type": "commit"}, {"oid": "77e2f7800c58f3b29b3a68462c06a091ba66dbd8", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/77e2f7800c58f3b29b3a68462c06a091ba66dbd8", "message": "Refactor User class", "committedDate": "2020-12-22T21:33:48Z", "type": "commit"}, {"oid": "7640ecd7315af5b3d374bae54764e497e550945a", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/7640ecd7315af5b3d374bae54764e497e550945a", "message": "Refactor Server class", "committedDate": "2020-12-22T21:33:49Z", "type": "commit"}, {"oid": "ef729fcf6b0d15c1ec6fbab35598a63c75fe463b", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/ef729fcf6b0d15c1ec6fbab35598a63c75fe463b", "message": "Clean ModelExtensions", "committedDate": "2020-12-22T21:33:52Z", "type": "commit"}, {"oid": "87ca3e3069a62ac7e3ebeb89c0f6a79b5de5096d", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/87ca3e3069a62ac7e3ebeb89c0f6a79b5de5096d", "message": "Refactor packages", "committedDate": "2020-12-22T21:33:54Z", "type": "commit"}, {"oid": "1117987f97d700d17b492b4820c92933d9271fa0", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/1117987f97d700d17b492b4820c92933d9271fa0", "message": "Add more error handling", "committedDate": "2020-12-22T21:33:57Z", "type": "commit"}, {"oid": "371320b75d0e17712d37364b7ca9223437ceb6e6", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/371320b75d0e17712d37364b7ca9223437ceb6e6", "message": "-scratch.md", "committedDate": "2020-12-22T21:33:57Z", "type": "commit"}, {"oid": "cd1ad2e02d01e5ffa4df7c24d748d459759dabdc", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/cd1ad2e02d01e5ffa4df7c24d748d459759dabdc", "message": "Fix compile errors", "committedDate": "2020-12-22T21:33:59Z", "type": "commit"}, {"oid": "021ca1c955f14343968877e3136d7a6f6051cb8d", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/021ca1c955f14343968877e3136d7a6f6051cb8d", "message": "Catch bad token condition", "committedDate": "2020-12-22T21:34:01Z", "type": "commit"}, {"oid": "c6d1f3e8f180573de614a81f59173420a04dd305", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/c6d1f3e8f180573de614a81f59173420a04dd305", "message": "Fix tests", "committedDate": "2020-12-22T21:34:01Z", "type": "commit"}, {"oid": "e9a45fb85f67c3e9b5f29bd0c5da950226bad012", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/e9a45fb85f67c3e9b5f29bd0c5da950226bad012", "message": "Fix discovery crashing the app", "committedDate": "2020-12-22T21:34:04Z", "type": "commit"}, {"oid": "a8788556caf959bfc4d61edaf925a12675cfe49b", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/a8788556caf959bfc4d61edaf925a12675cfe49b", "message": "Fix server info missing in legacy apiclient", "committedDate": "2020-12-22T21:34:05Z", "type": "commit"}, {"oid": "16021d12e7ac65bda52afef2cec469c721d63164", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/16021d12e7ac65bda52afef2cec469c721d63164", "message": "Skip login screen for passwordless public users", "committedDate": "2020-12-22T21:34:06Z", "type": "commit"}, {"oid": "30241d582de41ed9bdaf942df1e9e9d6bf69fa8c", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/30241d582de41ed9bdaf942df1e9e9d6bf69fa8c", "message": "Rewrite server/user retrieval flow part 1/2", "committedDate": "2020-12-22T21:34:08Z", "type": "commit"}, {"oid": "5e4705d297a3c0bb6330e05a156dd97a31fe0ac6", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/5e4705d297a3c0bb6330e05a156dd97a31fe0ac6", "message": "Rewrite server/user retrieval flow part 2/2", "committedDate": "2020-12-22T21:34:09Z", "type": "commit"}, {"oid": "7afe640bd1c4a4477d4a775576713cb026bdab9c", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/7afe640bd1c4a4477d4a775576713cb026bdab9c", "message": "Fix authentication failing for discovered servers", "committedDate": "2020-12-22T21:34:10Z", "type": "commit"}, {"oid": "13e736a300e3d5ec31de000f2fca919241e7017b", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/13e736a300e3d5ec31de000f2fca919241e7017b", "message": "Fix ModelExtensionsTest", "committedDate": "2020-12-22T21:34:10Z", "type": "commit"}, {"oid": "3e9e1105b9150478dbbb523ba06d7509a8f1d7b5", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/3e9e1105b9150478dbbb523ba06d7509a8f1d7b5", "message": "Resolve a bunch of linter warnings", "committedDate": "2020-12-22T21:34:11Z", "type": "forcePushed"}, {"oid": "6733c998c35bebd4fc224dd2a5da1cfb92828cc2", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/6733c998c35bebd4fc224dd2a5da1cfb92828cc2", "message": "Resolve a bunch of linter warnings", "committedDate": "2020-12-24T15:57:26Z", "type": "commit"}, {"oid": "6733c998c35bebd4fc224dd2a5da1cfb92828cc2", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/6733c998c35bebd4fc224dd2a5da1cfb92828cc2", "message": "Resolve a bunch of linter warnings", "committedDate": "2020-12-24T15:57:26Z", "type": "forcePushed"}, {"oid": "b2fa8327cbbc144696cf4ecf76ba87a61cfffd13", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/b2fa8327cbbc144696cf4ecf76ba87a61cfffd13", "message": "Fix login for users without a password prompting for a password\n\nWe now remember if a user has a password (using a boolean) in the offline data set. If a user fails to authenticate because a password was added it will prompt for a password. If it's the other way around the user can just proceed in the password-prompt with an empty password and the boolean will be updated for future logins.", "committedDate": "2020-12-29T18:26:53Z", "type": "commit"}, {"oid": "050fe767c94fb1b0796bec76e1166e9cfd39d094", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/050fe767c94fb1b0796bec76e1166e9cfd39d094", "message": "Merge branch 'master' into accountmanager\n\n# Conflicts:\n#\tapp/src/main/java/org/jellyfin/androidtv/JellyfinApplication.kt\n#\tapp/src/main/java/org/jellyfin/androidtv/TvApp.java\n#\tapp/src/main/java/org/jellyfin/androidtv/di/AppModule.kt\n#\tapp/src/main/java/org/jellyfin/androidtv/ui/home/HomeFragment.java\n#\tapp/src/main/java/org/jellyfin/androidtv/ui/preference/category/authentication.kt", "committedDate": "2020-12-30T21:56:25Z", "type": "commit"}]}