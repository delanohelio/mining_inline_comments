{"pr_number": 285, "pr_title": "Details refactor", "pr_createdAt": "2020-02-03T11:21:54Z", "pr_url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285", "timeline": [{"oid": "04b952abee772c4b6c1c3854afa71fc45e56a283", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/04b952abee772c4b6c1c3854afa71fc45e56a283", "message": "Rewrite BaseDetailsFragment", "committedDate": "2020-02-01T15:51:05Z", "type": "commit"}, {"oid": "3ae6feb39c98131383164bc8080590a2ea4170f7", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/3ae6feb39c98131383164bc8080590a2ea4170f7", "message": "Add actions (Includes #280)", "committedDate": "2020-02-01T16:25:41Z", "type": "commit"}, {"oid": "c7a9a1d07809be87b3282997470480949f275f55", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/c7a9a1d07809be87b3282997470480949f275f55", "message": "Add vector icon for ic_resume", "committedDate": "2020-02-02T11:00:17Z", "type": "commit"}, {"oid": "15213410417e5e90c8dd5f10f4a679b48299a5c0", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/15213410417e5e90c8dd5f10f4a679b48299a5c0", "message": "Add actions with icons", "committedDate": "2020-02-02T11:12:44Z", "type": "commit"}, {"oid": "01d3b7da0a86e04a528133259bc79263c2d5aead", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/01d3b7da0a86e04a528133259bc79263c2d5aead", "message": "Add observer implementation for dynamic updates of the layout", "committedDate": "2020-02-03T09:41:27Z", "type": "commit"}, {"oid": "53ed6a0227a94134e4ea3e69fb0762e9f52c0a91", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/53ed6a0227a94134e4ea3e69fb0762e9f52c0a91", "message": "Misc changes", "committedDate": "2020-02-03T09:42:12Z", "type": "commit"}, {"oid": "493046aeb9abcbe3eef8ae8f9390b0541544176d", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/493046aeb9abcbe3eef8ae8f9390b0541544176d", "message": "Add favorite toggle", "committedDate": "2020-02-03T10:07:17Z", "type": "commit"}, {"oid": "a289e38659caaf1715b78808950becfdb2259b84", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/a289e38659caaf1715b78808950becfdb2259b84", "message": "Add custom actionbar design", "committedDate": "2020-02-03T11:17:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA5NTA2NQ==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285#discussion_r374095065", "bodyText": "I think the playbackPositionTicks > 0 check should be sufficient, since the original.canResume just does a basically equivalent check.\n\tpublic final boolean getCanResume()\n\t{\n\t\treturn getUserData() != null && getUserData().getPlaybackPositionTicks() > 0;\n\t}\nhttps://github.com/jellyfin/jellyfin-apiclient-java/blob/master/library/src/main/java/org/jellyfin/apiclient/model/dto/BaseItemDto.java#L2311", "author": "AndreasGB", "createdAt": "2020-02-03T13:17:03Z", "path": "app/src/main/java/org/jellyfin/androidtv/model/itemtypes/LiftedItems.kt", "diffHunk": "@@ -4,20 +4,23 @@ import org.jellyfin.apiclient.model.dto.BaseItemDto\n import org.jellyfin.apiclient.model.dto.BaseItemType\n import org.jellyfin.apiclient.model.dto.ChapterInfoDto\n import java.util.*\n+import kotlin.properties.Delegates\n \n-sealed class BaseItem(original: BaseItemDto) {\n+sealed class BaseItem(original: BaseItemDto) : ObservableParent() {\n \tval id: String = original.id\n \tval name: String = original.name\n \tval description: String? = original.overview\n \tval images: ImageCollection = ImageCollection(original)\n \tval added: Date = original.dateCreated\n+\tvar favorite: Boolean by Delegates.observable(original.userData.isFavorite, ::observer)\n }\n \n sealed class PlayableItem(original: BaseItemDto) : BaseItem(original) {\n-\tval canResume: Boolean = original.canResume\n \tval playbackPositionTicks: Long = original.userData.playbackPositionTicks\n+\tval canResume: Boolean = original.canResume && playbackPositionTicks > 0", "originalCommit": "a289e38659caaf1715b78808950becfdb2259b84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE3NTE1NA==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285#discussion_r374175154", "bodyText": "I didn't even look at the baseItem. I assumed it was just passed from the server!", "author": "nielsvanvelzen", "createdAt": "2020-02-03T15:41:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA5NTA2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDEwMTM2Ng==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285#discussion_r374101366", "bodyText": "Maybe we should add proper error handling for all these coroutines before we release", "author": "AndreasGB", "createdAt": "2020-02-03T13:30:04Z", "path": "app/src/main/java/org/jellyfin/androidtv/util/apiclient/ApiClientExtensions.kt", "diffHunk": "@@ -29,3 +30,25 @@ suspend fun ApiClient.getItem(id: String): BaseItemDto? = suspendCoroutine { con\n \t\toverride fun onError(exception: Exception?) = continuation.resume(null)\n \t})\n }\n+\n+suspend fun ApiClient.markPlayed(itemId: String, userId: String, datePlayed: Date?) : UserItemDataDto? = suspendCoroutine { continuation ->\n+\tMarkPlayedAsync(itemId, userId, datePlayed, object : Response<UserItemDataDto>() {\n+\t\toverride fun onResponse(response: UserItemDataDto?) { continuation.resume(response!!) }\n+\t\toverride fun onError(exception: Exception?) { continuation.resume(null) }\n+\t})\n+}\n+\n+suspend fun ApiClient.markUnplayed(itemId: String, userId: String) : UserItemDataDto? = suspendCoroutine { continuation ->\n+\tMarkUnplayedAsync(itemId, userId, object : Response<UserItemDataDto>() {\n+\t\toverride fun onResponse(response: UserItemDataDto?) { continuation.resume(response!!) }\n+\t\toverride fun onError(exception: Exception?) { continuation.resume(null) }\n+\t})\n+}\n+\n+\n+suspend fun ApiClient.updateFavoriteStatus(itemId: String, userId: String, isFavorite: Boolean) : UserItemDataDto? = suspendCoroutine { continuation ->\n+\tUpdateFavoriteStatusAsync(itemId, userId, isFavorite, object : Response<UserItemDataDto>() {\n+\t\toverride fun onResponse(response: UserItemDataDto?) { continuation.resume(response!!) }\n+\t\toverride fun onError(exception: Exception?) { continuation.resume(null) }", "originalCommit": "a289e38659caaf1715b78808950becfdb2259b84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE3NTc5MA==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285#discussion_r374175790", "bodyText": "I'll make a note in the issue for that.", "author": "nielsvanvelzen", "createdAt": "2020-02-03T15:42:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDEwMTM2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDEwOTQ5Mw==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/285#discussion_r374109493", "bodyText": "I missed this in my review, we probably should overwrite everything in the item with information that the server sends us in response to marking played / unplayed.", "author": "AndreasGB", "createdAt": "2020-02-03T13:46:32Z", "path": "app/src/main/java/org/jellyfin/androidtv/details/actions/ToggleWatchedAction.kt", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.jellyfin.androidtv.details.actions\n+\n+import android.content.Context\n+import kotlinx.coroutines.Dispatchers\n+import kotlinx.coroutines.GlobalScope\n+import kotlinx.coroutines.launch\n+import org.jellyfin.androidtv.R\n+import org.jellyfin.androidtv.TvApp\n+import org.jellyfin.androidtv.model.itemtypes.PlayableItem\n+import org.jellyfin.androidtv.util.apiclient.markPlayed\n+import org.jellyfin.androidtv.util.apiclient.markUnplayed\n+\n+class ToggleWatchedAction(context: Context, val item: PlayableItem) : ToggleAction(ActionID.TOGGLE_WATCHED.id, context) {\n+\tinit {\n+\t\tactive = item.played\n+\t\tlabel1 = context.getString(R.string.lbl_watched)\n+\t}\n+\n+\toverride fun onClick() {\n+\t\tGlobalScope.launch(Dispatchers.Main) {\n+\t\t\tval apiClient = TvApp.getApplication().apiClient\n+\n+\t\t\tif (item.played) apiClient.markUnplayed(item.id, TvApp.getApplication().currentUser.id)\n+\t\t\telse apiClient.markPlayed(item.id, TvApp.getApplication().currentUser.id, null)\n+\n+\t\t\titem.played = !item.played", "originalCommit": "a289e38659caaf1715b78808950becfdb2259b84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "195a5695e4fe39a7f5a554ffe8ef94f50bcf38aa", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/195a5695e4fe39a7f5a554ffe8ef94f50bcf38aa", "message": "Set item values from api response", "committedDate": "2020-02-03T15:49:59Z", "type": "commit"}]}