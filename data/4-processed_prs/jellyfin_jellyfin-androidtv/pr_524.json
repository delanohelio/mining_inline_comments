{"pr_number": 524, "pr_title": "Fix VLC audio passthrough", "pr_createdAt": "2020-07-22T00:17:19Z", "pr_url": "https://github.com/jellyfin/jellyfin-androidtv/pull/524", "timeline": [{"oid": "ecbb1880628a42dce8031ec18d772c5e351c0202", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/ecbb1880628a42dce8031ec18d772c5e351c0202", "message": "Fix VLC atmos support", "committedDate": "2020-07-22T00:13:37Z", "type": "commit"}, {"oid": "c921fcdc2deb0adbfd9d9c6b3f88e40ab6cd8f93", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/c921fcdc2deb0adbfd9d9c6b3f88e40ab6cd8f93", "message": "remove tabs", "committedDate": "2020-07-22T00:19:22Z", "type": "commit"}, {"oid": "8c6050760ef62839ecaae4f85c5a8982575f4212", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/8c6050760ef62839ecaae4f85c5a8982575f4212", "message": "fix tabs", "committedDate": "2020-07-22T00:20:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg0NTc3Mw==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/524#discussion_r458845773", "bodyText": "It looks like this will returns a boolean indicating if it is successful or not, we should probably do something like:\nif (!Utils.downMixAudio() || !mVlcPlayer.setAudioDigitalOutputEnabled(true)) {\n    mVlcPlayer.setAudioOutput(\"opensles_android\");\n}\nSo it will fallback to downmixing if it fails.", "author": "thornbill", "createdAt": "2020-07-22T14:42:50Z", "path": "app/src/main/java/org/jellyfin/androidtv/playback/MediaManager.java", "diffHunk": "@@ -227,8 +227,12 @@ public void onPlayerError(ExoPlaybackException error) {\n                 mLibVLC = new LibVLC(TvApp.getApplication(), options);\n \n                 mVlcPlayer = new org.videolan.libvlc.MediaPlayer(mLibVLC);\n-                mVlcPlayer.setAudioOutput(Utils.downMixAudio() ? \"opensles_android\" : \"android_audiotrack\");\n-                mVlcPlayer.setAudioOutputDevice(\"hdmi\");\n+                if(!Utils.downMixAudio()) {\n+                    mVlcPlayer.setAudioDigitalOutputEnabled(true);", "originalCommit": "8c6050760ef62839ecaae4f85c5a8982575f4212", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE4NDI5MA==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/524#discussion_r459184290", "bodyText": "Not an expert on VLC, but are we sure in the case that setAudioDigitalOutputEnabled fails, opensles_android is preferrable? FWIW audio was outputting previously WITHOUT setAudioDigitalOutputEnabled being called AND without downmixing, however it was not properly outputting Atmos.\nSeems like if it is not always preferrable, might be less confusing for users to have to manually set this in preferences.", "author": "willtrking", "createdAt": "2020-07-23T02:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg0NTc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDM2MDQzNw==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/524#discussion_r460360437", "bodyText": "Ah I think I follow now. This seems fine.\nShould we be calling \u2018mVlcPlayer.setAudioOutput(\"android_audiotrack\");\u2018 here like you do below?", "author": "thornbill", "createdAt": "2020-07-25T03:54:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg0NTc3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg0NzI0Ng==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/524#discussion_r458847246", "bodyText": "I'm not sure if it's necessary or not, but it seems to be inconsistent on whether mVlcPlayer.setAudioOutputDevice(\"hdmi\"); is called or not. Maybe it should be still be called here?", "author": "thornbill", "createdAt": "2020-07-22T14:44:44Z", "path": "app/src/main/java/org/jellyfin/androidtv/playback/MediaManager.java", "diffHunk": "@@ -227,8 +227,12 @@ public void onPlayerError(ExoPlaybackException error) {\n                 mLibVLC = new LibVLC(TvApp.getApplication(), options);\n \n                 mVlcPlayer = new org.videolan.libvlc.MediaPlayer(mLibVLC);\n-                mVlcPlayer.setAudioOutput(Utils.downMixAudio() ? \"opensles_android\" : \"android_audiotrack\");\n-                mVlcPlayer.setAudioOutputDevice(\"hdmi\");\n+                if(!Utils.downMixAudio()) {\n+                    mVlcPlayer.setAudioDigitalOutputEnabled(true);\n+                } else {\n+                    mVlcPlayer.setAudioOutput(\"opensles_android\");", "originalCommit": "8c6050760ef62839ecaae4f85c5a8982575f4212", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE4MjYxNA==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/524#discussion_r459182614", "bodyText": "Should be addressed", "author": "willtrking", "createdAt": "2020-07-23T02:20:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg0NzI0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg0ODE4Ng==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/524#discussion_r458848186", "bodyText": "Same notes as above apply here.", "author": "thornbill", "createdAt": "2020-07-22T14:45:50Z", "path": "app/src/main/java/org/jellyfin/androidtv/playback/VideoManager.java", "diffHunk": "@@ -442,16 +443,24 @@ public long getAudioDelay() {\n     }\n \n     public void setCompatibleAudio() {\n-         if (!nativeMode) {\n-             mVlcPlayer.setAudioOutput(\"opensles_android\");\n-             mVlcPlayer.setAudioOutputDevice(\"hdmi\");\n-         }\n+        if (!nativeMode) {\n+            mVlcPlayer.setAudioOutput(\"opensles_android\");\n+            mVlcPlayer.setAudioOutputDevice(\"hdmi\");\n+        }\n     }\n \n     public void setAudioMode() {\n         if (!nativeMode) {\n-            mVlcPlayer.setAudioOutput(Utils.downMixAudio() ? \"opensles_android\" : \"android_audiotrack\");\n-            mVlcPlayer.setAudioOutputDevice(\"hdmi\");\n+            setVlcAudioOptions();\n+        }\n+    }\n+\n+    private void setVlcAudioOptions() {\n+\n+        if(!Utils.downMixAudio()) {\n+            mVlcPlayer.setAudioDigitalOutputEnabled(true);\n+        } else {\n+            mVlcPlayer.setAudioOutput(\"opensles_android\");", "originalCommit": "8c6050760ef62839ecaae4f85c5a8982575f4212", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE4NDQ0MQ==", "url": "https://github.com/jellyfin/jellyfin-androidtv/pull/524#discussion_r459184441", "bodyText": "Should be addressed", "author": "willtrking", "createdAt": "2020-07-23T02:30:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg0ODE4Ng=="}], "type": "inlineReview"}, {"oid": "c57454b3661e9557e419601ed37726087c831b32", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/c57454b3661e9557e419601ed37726087c831b32", "message": "address hdmi setting", "committedDate": "2020-07-23T02:20:01Z", "type": "commit"}, {"oid": "66d03cb48a6360d05caf62c44ac974110256bda0", "url": "https://github.com/jellyfin/jellyfin-androidtv/commit/66d03cb48a6360d05caf62c44ac974110256bda0", "message": "Add missing setAudioOutput call", "committedDate": "2020-08-21T18:38:32Z", "type": "commit"}]}