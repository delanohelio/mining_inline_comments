{"pr_number": 3524, "pr_title": "Added btcmarkets streaming code", "pr_createdAt": "2020-05-20T04:36:48Z", "pr_url": "https://github.com/knowm/XChange/pull/3524", "timeline": [{"oid": "e9e396ddb0b22ddbe1f88a6e105e9c8b9aab9798", "url": "https://github.com/knowm/XChange/commit/e9e396ddb0b22ddbe1f88a6e105e9c8b9aab9798", "message": "Initial commit of btcmarkets streaming code", "committedDate": "2020-05-20T05:59:25Z", "type": "forcePushed"}, {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc", "url": "https://github.com/knowm/XChange/commit/d38b11a966c726cd3ab839e69d8bbde86fe490fc", "message": "Initial commit of btcmarkets streaming code", "committedDate": "2020-05-20T06:14:13Z", "type": "commit"}, {"oid": "d38b11a966c726cd3ab839e69d8bbde86fe490fc", "url": "https://github.com/knowm/XChange/commit/d38b11a966c726cd3ab839e69d8bbde86fe490fc", "message": "Initial commit of btcmarkets streaming code", "committedDate": "2020-05-20T06:14:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI2OTg0MQ==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428269841", "bodyText": "XChange uses logback rather than log4j, so this won't do anything.", "author": "badgerwithagun", "createdAt": "2020-05-20T19:52:51Z", "path": "xchange-stream-btcmarkets/src/test/resources/log4j2.xml", "diffHunk": "@@ -0,0 +1,15 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>", "originalCommit": "d38b11a966c726cd3ab839e69d8bbde86fe490fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4MzgyMg==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428383822", "bodyText": "Removed that.", "author": "nielsdraaisma", "createdAt": "2020-05-21T00:37:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI2OTg0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3MjU1OQ==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428272559", "bodyText": "Could you make these List<List<BigDecimal>>?", "author": "badgerwithagun", "createdAt": "2020-05-20T19:57:58Z", "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/dto/BTCMarketsWebSocketOrderbookMessage.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package info.bitrich.xchangestream.btcmarkets.dto;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import java.util.List;\n+\n+public class BTCMarketsWebSocketOrderbookMessage {\n+  public final String marketId;\n+\n+  public final String timestamp;\n+\n+  public final List<List<String>> bids;\n+  public final List<List<String>> asks;\n+\n+  public final String messageType;\n+\n+  public BTCMarketsWebSocketOrderbookMessage(\n+      @JsonProperty(\"marketId\") String marketId,\n+      @JsonProperty(\"timestamp\") String timestamp,\n+      @JsonProperty(\"bids\") List<List<String>> bids,", "originalCommit": "d38b11a966c726cd3ab839e69d8bbde86fe490fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4Mzg3MQ==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428383871", "bodyText": "Done", "author": "nielsdraaisma", "createdAt": "2020-05-21T00:37:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3MjU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3Mjg2Mw==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428272863", "bodyText": "Does this need to be public?", "author": "badgerwithagun", "createdAt": "2020-05-20T19:58:31Z", "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingDigest.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package info.bitrich.xchangestream.btcmarkets.service;\n+\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.util.Base64;\n+import javax.crypto.Mac;\n+import javax.crypto.spec.SecretKeySpec;\n+import org.knowm.xchange.utils.Assert;\n+\n+public class BTCMarketsStreamingDigest {", "originalCommit": "d38b11a966c726cd3ab839e69d8bbde86fe490fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4NTAyMg==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428385022", "bodyText": "I've removed that class entirely, i'll raise a new PR later with working private channels, that's not currently used at all.", "author": "nielsdraaisma", "createdAt": "2020-05-21T00:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3Mjg2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3MzIxOA==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428273218", "bodyText": "Could this be co-located with the services and lowered to default visibility?", "author": "badgerwithagun", "createdAt": "2020-05-20T19:59:16Z", "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/BTCMarketsStreamingAdapters.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package info.bitrich.xchangestream.btcmarkets;\n+\n+import com.fasterxml.jackson.databind.exc.InvalidFormatException;\n+import info.bitrich.xchangestream.btcmarkets.dto.BTCMarketsWebSocketOrderbookMessage;\n+import java.math.BigDecimal;\n+import java.util.List;\n+import java.util.function.BiFunction;\n+import java.util.stream.Collectors;\n+import org.knowm.xchange.currency.CurrencyPair;\n+import org.knowm.xchange.dto.Order;\n+import org.knowm.xchange.dto.marketdata.OrderBook;\n+import org.knowm.xchange.dto.trade.LimitOrder;\n+import org.knowm.xchange.utils.DateUtils;\n+\n+public class BTCMarketsStreamingAdapters {", "originalCommit": "d38b11a966c726cd3ab839e69d8bbde86fe490fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4Mzk1NQ==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428383955", "bodyText": "Done", "author": "nielsdraaisma", "createdAt": "2020-05-21T00:38:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3MzIxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3NDI4Ng==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428274286", "bodyText": "could simplify this to marketId.equals(orderEvent.marketId) and lose the null check", "author": "badgerwithagun", "createdAt": "2020-05-20T20:01:27Z", "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingMarketDataService.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package info.bitrich.xchangestream.btcmarkets.service;\n+\n+import static info.bitrich.xchangestream.btcmarkets.service.BTCMarketsStreamingService.CHANNEL_ORDERBOOK;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.exc.InvalidFormatException;\n+import info.bitrich.xchangestream.btcmarkets.BTCMarketsStreamingAdapters;\n+import info.bitrich.xchangestream.btcmarkets.dto.BTCMarketsWebSocketOrderbookMessage;\n+import info.bitrich.xchangestream.core.StreamingMarketDataService;\n+import info.bitrich.xchangestream.service.netty.StreamingObjectMapperHelper;\n+import io.reactivex.Observable;\n+import org.knowm.xchange.currency.CurrencyPair;\n+import org.knowm.xchange.dto.marketdata.OrderBook;\n+import org.knowm.xchange.dto.marketdata.Ticker;\n+import org.knowm.xchange.dto.marketdata.Trade;\n+import org.knowm.xchange.exceptions.NotAvailableFromExchangeException;\n+\n+public class BTCMarketsStreamingMarketDataService implements StreamingMarketDataService {\n+\n+  private final ObjectMapper mapper = StreamingObjectMapperHelper.getObjectMapper();\n+\n+  private final BTCMarketsStreamingService service;\n+\n+  public BTCMarketsStreamingMarketDataService(BTCMarketsStreamingService service) {\n+    this.service = service;\n+  }\n+\n+  private OrderBook handleOrderbookMessage(BTCMarketsWebSocketOrderbookMessage message)\n+      throws InvalidFormatException {\n+    return BTCMarketsStreamingAdapters.adaptOrderbookMessageToOrderbook(message);\n+  }\n+\n+  @Override\n+  public Observable<OrderBook> getOrderBook(CurrencyPair currencyPair, Object... args) {\n+    String marketId = BTCMarketsStreamingAdapters.adaptCurrencyPairToMarketId(currencyPair);\n+    return service\n+        .subscribeChannel(CHANNEL_ORDERBOOK, marketId)\n+        .map(node -> mapper.treeToValue(node, BTCMarketsWebSocketOrderbookMessage.class))\n+        .filter(orderEvent -> orderEvent.marketId != null && orderEvent.marketId.equals(marketId))", "originalCommit": "d38b11a966c726cd3ab839e69d8bbde86fe490fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4Mzk5Mg==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428383992", "bodyText": "Done", "author": "nielsdraaisma", "createdAt": "2020-05-21T00:38:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3NDI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3NjQ0NQ==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428276445", "bodyText": "Do these need to be public?", "author": "badgerwithagun", "createdAt": "2020-05-20T20:05:23Z", "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingService.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package info.bitrich.xchangestream.btcmarkets.service;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Sets;\n+import info.bitrich.xchangestream.btcmarkets.dto.BTCMarketsWebSocketSubscribeMessage;\n+import info.bitrich.xchangestream.service.netty.JsonNettyStreamingService;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class BTCMarketsStreamingService extends JsonNettyStreamingService {\n+  public static final String CHANNEL_ORDERBOOK = \"orderbook\";", "originalCommit": "d38b11a966c726cd3ab839e69d8bbde86fe490fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NjU5NA==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428396594", "bodyText": "I've moved things out of the packages and removed  public.", "author": "nielsdraaisma", "createdAt": "2020-05-21T01:28:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3NjQ0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3NjU3Nw==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428276577", "bodyText": "Does this class itself need to be public?", "author": "badgerwithagun", "createdAt": "2020-05-20T20:05:38Z", "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingService.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package info.bitrich.xchangestream.btcmarkets.service;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Sets;\n+import info.bitrich.xchangestream.btcmarkets.dto.BTCMarketsWebSocketSubscribeMessage;\n+import info.bitrich.xchangestream.service.netty.JsonNettyStreamingService;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class BTCMarketsStreamingService extends JsonNettyStreamingService {", "originalCommit": "d38b11a966c726cd3ab839e69d8bbde86fe490fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NjYxMg==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428396612", "bodyText": "I've moved things out of the packages and removed  public.", "author": "nielsdraaisma", "createdAt": "2020-05-21T01:28:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3NjU3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3OTY0MQ==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428279641", "bodyText": "Looks like there should be a subscribedOrderbooks.remove() here.\nnit: Setting up subscribedOrderbooks in the get...Message methods seems unsafe, but I can't see an obvious cleaner way. It's not the ideal websocket API, so I'm not too bothered.", "author": "badgerwithagun", "createdAt": "2020-05-20T20:11:15Z", "path": "xchange-stream-btcmarkets/src/main/java/info/bitrich/xchangestream/btcmarkets/service/BTCMarketsStreamingService.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package info.bitrich.xchangestream.btcmarkets.service;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Sets;\n+import info.bitrich.xchangestream.btcmarkets.dto.BTCMarketsWebSocketSubscribeMessage;\n+import info.bitrich.xchangestream.service.netty.JsonNettyStreamingService;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Set;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class BTCMarketsStreamingService extends JsonNettyStreamingService {\n+  public static final String CHANNEL_ORDERBOOK = \"orderbook\";\n+  public static final String CHANNEL_HEARTBEAT = \"heartbeat\";\n+  private static final Logger LOG = LoggerFactory.getLogger(BTCMarketsStreamingService.class);\n+  private final Set<String> subscribedOrderbooks = Sets.newConcurrentHashSet();\n+\n+  public BTCMarketsStreamingService(String apiUrl) {\n+    super(apiUrl);\n+  }\n+\n+  private BTCMarketsWebSocketSubscribeMessage buildSubscribeMessage() {\n+    return new BTCMarketsWebSocketSubscribeMessage(\n+        new ArrayList<>(subscribedOrderbooks),\n+        Lists.newArrayList(CHANNEL_ORDERBOOK, CHANNEL_HEARTBEAT),\n+        null,\n+        null,\n+        null);\n+  }\n+\n+  @Override\n+  protected String getChannelNameFromMessage(JsonNode message) {\n+    final String messageType = message.get(\"messageType\").asText();\n+    if (messageType.startsWith(CHANNEL_ORDERBOOK)) {\n+      return messageType + \":\" + message.get(\"marketId\").asText();\n+    }\n+    return messageType;\n+  }\n+\n+  @Override\n+  public String getSubscribeMessage(String channelName, Object... args) throws IOException {\n+    if (CHANNEL_ORDERBOOK.equals(channelName)) {\n+      subscribedOrderbooks.add(args[0].toString());\n+      LOG.debug(\"Now subscribed to orderbooks {}\", subscribedOrderbooks);\n+      return objectMapper.writeValueAsString(buildSubscribeMessage());\n+    } else {\n+      throw new IllegalArgumentException(\n+          \"Can't create subscribe messsage for channel \" + channelName);\n+    }\n+  }\n+\n+  public String getSubscriptionUniqueId(String channelName, Object... args) {\n+    if (CHANNEL_ORDERBOOK.equals(channelName)) {\n+      return channelName + \":\" + args[0].toString();\n+    }\n+    return channelName;\n+  }\n+\n+  @Override\n+  public String getUnsubscribeMessage(String channelName) throws IOException {\n+    if (channelName.startsWith(CHANNEL_ORDERBOOK)) {\n+      final String[] parts = channelName.split(\":\");", "originalCommit": "d38b11a966c726cd3ab839e69d8bbde86fe490fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM4NDQ2NA==", "url": "https://github.com/knowm/XChange/pull/3524#discussion_r428384464", "bodyText": "Done, there's no clean way of working around that, an unsubscribe is basically subscribing again without that channel.", "author": "nielsdraaisma", "createdAt": "2020-05-21T00:40:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3OTY0MQ=="}], "type": "inlineReview"}, {"oid": "9635863206dd6189cbec8425348d1d0defc6bd62", "url": "https://github.com/knowm/XChange/commit/9635863206dd6189cbec8425348d1d0defc6bd62", "message": "[btcmarkets] Code review fixes", "committedDate": "2020-05-21T00:37:10Z", "type": "commit"}, {"oid": "aeb6ed60f5b51c8b520c4dd1ecbd8e81e549dcdc", "url": "https://github.com/knowm/XChange/commit/aeb6ed60f5b51c8b520c4dd1ecbd8e81e549dcdc", "message": "[btcmarkets] Moved streaming code to single package", "committedDate": "2020-05-21T01:16:21Z", "type": "commit"}]}