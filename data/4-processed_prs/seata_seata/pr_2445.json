{"pr_number": 2445, "pr_title": "optimize: the class registration method of kryo and fst", "pr_createdAt": "2020-03-24T01:39:35Z", "pr_url": "https://github.com/seata/seata/pull/2445", "timeline": [{"oid": "9d2c6386bdbb349b4d6e21818ecbe345729f8bac", "url": "https://github.com/seata/seata/commit/9d2c6386bdbb349b4d6e21818ecbe345729f8bac", "message": "optimize the way classes are registered", "committedDate": "2020-03-24T01:37:17Z", "type": "commit"}, {"oid": "c292fd5232cd9c936b748a39da38907299366bd2", "url": "https://github.com/seata/seata/commit/c292fd5232cd9c936b748a39da38907299366bd2", "message": "fix bug", "committedDate": "2020-03-24T01:38:41Z", "type": "commit"}, {"oid": "ce805de12668f6b2270771b4fd5e2c82b1793d28", "url": "https://github.com/seata/seata/commit/ce805de12668f6b2270771b4fd5e2c82b1793d28", "message": "Merge branch 'develop' into serialize_fst", "committedDate": "2020-03-24T01:39:49Z", "type": "commit"}, {"oid": "199176ed8c1b7aed6f863027132a5a26c0a1638e", "url": "https://github.com/seata/seata/commit/199176ed8c1b7aed6f863027132a5a26c0a1638e", "message": "reformat code", "committedDate": "2020-03-24T02:05:26Z", "type": "commit"}, {"oid": "a49784556a7d5410201881fbdeb6e995956c1efa", "url": "https://github.com/seata/seata/commit/a49784556a7d5410201881fbdeb6e995956c1efa", "message": "reformat code", "committedDate": "2020-03-24T02:06:28Z", "type": "commit"}, {"oid": "d3ec99c270abaf900e817fbb13da17cf49cc4e47", "url": "https://github.com/seata/seata/commit/d3ec99c270abaf900e817fbb13da17cf49cc4e47", "message": "Merge branch 'serialize_fst' of https://github.com/a364176773/seata into serialize_fst", "committedDate": "2020-03-24T02:07:13Z", "type": "commit"}, {"oid": "0d70c65738c6afc8a6666cf1357e0cbb55492647", "url": "https://github.com/seata/seata/commit/0d70c65738c6afc8a6666cf1357e0cbb55492647", "message": "test", "committedDate": "2020-03-24T02:54:35Z", "type": "commit"}, {"oid": "77da0eeb92327ec49bbd41577c052b18b05a3b70", "url": "https://github.com/seata/seata/commit/77da0eeb92327ec49bbd41577c052b18b05a3b70", "message": "optimize code", "committedDate": "2020-03-24T04:36:25Z", "type": "commit"}, {"oid": "11bb905af915d589012a7ad4efc230c54050535d", "url": "https://github.com/seata/seata/commit/11bb905af915d589012a7ad4efc230c54050535d", "message": "Merge branch 'develop' into serialize_fst", "committedDate": "2020-03-24T14:32:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NDAyOA==", "url": "https://github.com/seata/seata/pull/2445#discussion_r397594028", "bodyText": "private", "author": "slievrly", "createdAt": "2020-03-25T03:45:31Z", "path": "serializer/seata-serializer-fst/src/main/java/io.seata.serializer.fst/FstSerializer.java", "diffHunk": "@@ -26,16 +24,16 @@\n @LoadLevel(name = \"FST\")\n public class FstSerializer implements Serializer {\n \n-    private final FSTConfiguration conf = FSTConfiguration.createDefaultConfiguration();\n+    FstSerializerFactory fstFactory = FstSerializerFactory.getDefaultFactory();", "originalCommit": "11bb905af915d589012a7ad4efc230c54050535d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NjA2OA==", "url": "https://github.com/seata/seata/pull/2445#discussion_r397596068", "bodyText": "received, processed,thx", "author": "a364176773", "createdAt": "2020-03-25T03:54:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NDAyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NTExMw==", "url": "https://github.com/seata/seata/pull/2445#discussion_r397595113", "bodyText": "not only for kryo\uff0cwhere  used the  serializer  ?", "author": "slievrly", "createdAt": "2020-03-25T03:50:19Z", "path": "core/src/main/java/io/seata/core/serializer/SerializerClassRegistry.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.serializer;\n+\n+import java.text.SimpleDateFormat;\n+import java.util.ArrayList;\n+import java.util.BitSet;\n+import java.util.Calendar;\n+import java.util.Date;\n+import java.util.GregorianCalendar;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Hashtable;\n+import java.util.LinkedHashMap;\n+import java.util.LinkedList;\n+import java.util.Map;\n+import java.util.TreeSet;\n+import java.util.Vector;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+import io.seata.core.protocol.MergeResultMessage;\n+import io.seata.core.protocol.MergedWarpMessage;\n+import io.seata.core.protocol.RegisterRMRequest;\n+import io.seata.core.protocol.RegisterRMResponse;\n+import io.seata.core.protocol.RegisterTMRequest;\n+import io.seata.core.protocol.RegisterTMResponse;\n+import io.seata.core.protocol.transaction.BranchCommitRequest;\n+import io.seata.core.protocol.transaction.BranchCommitResponse;\n+import io.seata.core.protocol.transaction.BranchRegisterRequest;\n+import io.seata.core.protocol.transaction.BranchRegisterResponse;\n+import io.seata.core.protocol.transaction.BranchReportRequest;\n+import io.seata.core.protocol.transaction.BranchReportResponse;\n+import io.seata.core.protocol.transaction.BranchRollbackRequest;\n+import io.seata.core.protocol.transaction.BranchRollbackResponse;\n+import io.seata.core.protocol.transaction.GlobalBeginRequest;\n+import io.seata.core.protocol.transaction.GlobalBeginResponse;\n+import io.seata.core.protocol.transaction.GlobalCommitRequest;\n+import io.seata.core.protocol.transaction.GlobalCommitResponse;\n+import io.seata.core.protocol.transaction.GlobalLockQueryRequest;\n+import io.seata.core.protocol.transaction.GlobalLockQueryResponse;\n+import io.seata.core.protocol.transaction.GlobalReportRequest;\n+import io.seata.core.protocol.transaction.GlobalReportResponse;\n+import io.seata.core.protocol.transaction.GlobalRollbackRequest;\n+import io.seata.core.protocol.transaction.GlobalRollbackResponse;\n+import io.seata.core.protocol.transaction.GlobalStatusRequest;\n+import io.seata.core.protocol.transaction.GlobalStatusResponse;\n+import io.seata.core.protocol.transaction.UndoLogDeleteRequest;\n+\n+/**\n+ * Provide a unified serialization registry, this class used for {@code seata-serializer-fst}\n+ * and {@code seata-serializer-kryo}, it will register some classes at startup time (for example {@link KryoSerializerFactory#create})\n+ * @author funkye\n+ */\n+public class SerializerClassRegistry {\n+\n+    private static final Map<Class<?>, Object> REGISTRATIONS = new LinkedHashMap<>();\n+\n+    static {\n+\n+        // register commonly class\n+        registerClass(HashMap.class);\n+        registerClass(ArrayList.class);\n+        registerClass(LinkedList.class);\n+        registerClass(HashSet.class);\n+        registerClass(TreeSet.class);\n+        registerClass(Hashtable.class);\n+        registerClass(Date.class);\n+        registerClass(Calendar.class);\n+        registerClass(ConcurrentHashMap.class);\n+        registerClass(SimpleDateFormat.class);\n+        registerClass(GregorianCalendar.class);\n+        registerClass(Vector.class);\n+        registerClass(BitSet.class);\n+        registerClass(StringBuffer.class);\n+        registerClass(StringBuilder.class);\n+        registerClass(Object.class);\n+        registerClass(Object[].class);\n+        registerClass(String[].class);\n+        registerClass(byte[].class);\n+        registerClass(char[].class);\n+        registerClass(int[].class);\n+        registerClass(float[].class);\n+        registerClass(double[].class);\n+\n+        // register seata protocol relation class\n+        registerClass(BranchCommitRequest.class);\n+        registerClass(BranchCommitResponse.class);\n+        registerClass(BranchRegisterRequest.class);\n+        registerClass(BranchRegisterResponse.class);\n+        registerClass(BranchReportRequest.class);\n+        registerClass(BranchReportResponse.class);\n+        registerClass(BranchRollbackRequest.class);\n+        registerClass(BranchRollbackResponse.class);\n+        registerClass(GlobalBeginRequest.class);\n+        registerClass(GlobalBeginResponse.class);\n+        registerClass(GlobalCommitRequest.class);\n+        registerClass(GlobalCommitResponse.class);\n+        registerClass(GlobalLockQueryRequest.class);\n+        registerClass(GlobalLockQueryResponse.class);\n+        registerClass(GlobalRollbackRequest.class);\n+        registerClass(GlobalRollbackResponse.class);\n+        registerClass(GlobalStatusRequest.class);\n+        registerClass(GlobalStatusResponse.class);\n+        registerClass(UndoLogDeleteRequest.class);\n+        registerClass(GlobalReportRequest.class);\n+        registerClass(GlobalReportResponse.class);\n+\n+        registerClass(MergedWarpMessage.class);\n+        registerClass(MergeResultMessage.class);\n+        registerClass(RegisterRMRequest.class);\n+        registerClass(RegisterRMResponse.class);\n+        registerClass(RegisterTMRequest.class);\n+        registerClass(RegisterTMResponse.class);\n+    }\n+    \n+    /**\n+     * only supposed to be called at startup time\n+     *\n+     * @param clazz object type\n+     */\n+    public static void registerClass(Class<?> clazz) {\n+        registerClass(clazz, null);\n+    }\n+\n+    /**\n+     * only supposed to be called at startup time\n+     *\n+     * @param clazz object type\n+     * @param serializer object serializer\n+     */\n+    public static void registerClass(Class<?> clazz, Object serializer) {\n+        if (clazz == null) {\n+            throw new IllegalArgumentException(\"Class registered to kryo cannot be null!\");", "originalCommit": "11bb905af915d589012a7ad4efc230c54050535d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NjA0Nw==", "url": "https://github.com/seata/seata/pull/2445#discussion_r397596047", "bodyText": "received, processed,thx", "author": "a364176773", "createdAt": "2020-03-25T03:54:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NTExMw=="}], "type": "inlineReview"}, {"oid": "cb73d7ff2b59179dfb495d1e02159c04307bc0ee", "url": "https://github.com/seata/seata/commit/cb73d7ff2b59179dfb495d1e02159c04307bc0ee", "message": "optimize code", "committedDate": "2020-03-25T03:53:21Z", "type": "commit"}, {"oid": "83c9c42443a8d4716527bf850716b1b5ec5e7a3b", "url": "https://github.com/seata/seata/commit/83c9c42443a8d4716527bf850716b1b5ec5e7a3b", "message": "Merge branch 'develop' into serialize_fst", "committedDate": "2020-03-26T01:40:50Z", "type": "commit"}]}