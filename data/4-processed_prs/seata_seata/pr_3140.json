{"pr_number": 3140, "pr_title": "bugfix:  fix Propagation.REQUIRES_NEW and add some comments", "pr_createdAt": "2020-09-22T07:35:35Z", "pr_url": "https://github.com/seata/seata/pull/3140", "timeline": [{"oid": "6f0bd05c4ab9c29b9aadd5587e3e49d7026bf70e", "url": "https://github.com/seata/seata/commit/6f0bd05c4ab9c29b9aadd5587e3e49d7026bf70e", "message": "bugfix: fix REQUIRES_NEW not send begin request to TC", "committedDate": "2020-09-03T10:04:43Z", "type": "commit"}, {"oid": "c08bba8fb7eaefcb848a90ac0fc76b5a5768f074", "url": "https://github.com/seata/seata/commit/c08bba8fb7eaefcb848a90ac0fc76b5a5768f074", "message": "Merge remote-tracking branch 'remotes/upstream/develop' into bugfix-tm-propagation-new", "committedDate": "2020-09-22T05:19:48Z", "type": "commit"}, {"oid": "f404a2c89a15aa650fb95a1d5d99120e76c94d5d", "url": "https://github.com/seata/seata/commit/f404a2c89a15aa650fb95a1d5d99120e76c94d5d", "message": "bugfix: 'Propagation.REQUIRES_NEW' is invalid", "committedDate": "2020-09-22T07:32:01Z", "type": "commit"}, {"oid": "5f513ddeae6690a0b91fa9cb4c7a5a804f218a7c", "url": "https://github.com/seata/seata/commit/5f513ddeae6690a0b91fa9cb4c7a5a804f218a7c", "message": "optimize notes", "committedDate": "2020-09-22T07:40:03Z", "type": "commit"}, {"oid": "cccc9fea01f24300a72581b6304c253eca1f94e9", "url": "https://github.com/seata/seata/commit/cccc9fea01f24300a72581b6304c253eca1f94e9", "message": "fix bug", "committedDate": "2020-09-22T07:46:43Z", "type": "commit"}, {"oid": "8a17cd99fa72eb6549782355a93773cf51e7c178", "url": "https://github.com/seata/seata/commit/8a17cd99fa72eb6549782355a93773cf51e7c178", "message": "optimize notes", "committedDate": "2020-09-22T14:41:53Z", "type": "commit"}, {"oid": "92b9e9898bcfb381e781ffdb7f6405c7eed52f5a", "url": "https://github.com/seata/seata/commit/92b9e9898bcfb381e781ffdb7f6405c7eed52f5a", "message": "optimize RootContext.getXID()", "committedDate": "2020-09-22T15:54:10Z", "type": "commit"}, {"oid": "74fdfd337abf9c998ec6659f4a3279ad251757aa", "url": "https://github.com/seata/seata/commit/74fdfd337abf9c998ec6659f4a3279ad251757aa", "message": "optimize TccActionInterceptor", "committedDate": "2020-09-22T15:55:20Z", "type": "commit"}, {"oid": "0be6eb00df617cc2af836a087e45c71c5301aa9c", "url": "https://github.com/seata/seata/commit/0be6eb00df617cc2af836a087e45c71c5301aa9c", "message": "optimize code", "committedDate": "2020-09-22T16:00:15Z", "type": "commit"}, {"oid": "805f066062adfea9b2d6a138fcebdf2fe19fc3fc", "url": "https://github.com/seata/seata/commit/805f066062adfea9b2d6a138fcebdf2fe19fc3fc", "message": "fix style", "committedDate": "2020-09-22T16:07:49Z", "type": "commit"}, {"oid": "5540779855ccb64d16bf5012eea9ccdefd846833", "url": "https://github.com/seata/seata/commit/5540779855ccb64d16bf5012eea9ccdefd846833", "message": "fix style", "committedDate": "2020-09-22T16:20:35Z", "type": "commit"}, {"oid": "8e43fd6a58c28afa80f4c35edc0477f27d34e341", "url": "https://github.com/seata/seata/commit/8e43fd6a58c28afa80f4c35edc0477f27d34e341", "message": "fix bug", "committedDate": "2020-09-23T02:11:07Z", "type": "commit"}, {"oid": "65d46d5ac4b3d1ea3e8d3f34247a685a3b4850d8", "url": "https://github.com/seata/seata/commit/65d46d5ac4b3d1ea3e8d3f34247a685a3b4850d8", "message": "fix MANDATORY BUG.", "committedDate": "2020-09-23T02:18:33Z", "type": "commit"}, {"oid": "ae6d6075326978ac8e81db6f6424997ad6f4004a", "url": "https://github.com/seata/seata/commit/ae6d6075326978ac8e81db6f6424997ad6f4004a", "message": "fix notes", "committedDate": "2020-09-23T02:20:03Z", "type": "commit"}, {"oid": "53fd8ea5dc14d4503474fabcb1bf1485ad152d1f", "url": "https://github.com/seata/seata/commit/53fd8ea5dc14d4503474fabcb1bf1485ad152d1f", "message": "fix notes", "committedDate": "2020-09-23T02:25:29Z", "type": "commit"}, {"oid": "9ff031766000b30d3fe13da128ec135d7743f811", "url": "https://github.com/seata/seata/commit/9ff031766000b30d3fe13da128ec135d7743f811", "message": "fix notes", "committedDate": "2020-09-23T02:28:43Z", "type": "commit"}, {"oid": "0155fc6c50ab354a44651033331f076113087d53", "url": "https://github.com/seata/seata/commit/0155fc6c50ab354a44651033331f076113087d53", "message": "fix code", "committedDate": "2020-09-23T02:54:06Z", "type": "commit"}, {"oid": "190dbe407db31021c4e6e06733ab2c9308a752b2", "url": "https://github.com/seata/seata/commit/190dbe407db31021c4e6e06733ab2c9308a752b2", "message": "optimize code", "committedDate": "2020-09-23T03:04:27Z", "type": "commit"}, {"oid": "5d4c6e8c9868562324beea740df3bff038c17d64", "url": "https://github.com/seata/seata/commit/5d4c6e8c9868562324beea740df3bff038c17d64", "message": "Merge remote-tracking branch 'remotes/upstream/develop' into bugfix-tm-propagation-new\n\n# Conflicts:\n#\tspring/src/main/java/io/seata/spring/tcc/TccActionInterceptor.java", "committedDate": "2020-09-23T06:00:50Z", "type": "commit"}, {"oid": "9b2c71f7cf521e031eace131ca22866a4d69eb1e", "url": "https://github.com/seata/seata/commit/9b2c71f7cf521e031eace131ca22866a4d69eb1e", "message": "\u62c6\u5206\u90e8\u5206\u4ee3\u7801\u5230\u53e6\u4e00\u4e2a\u5206\u652f\u3002", "committedDate": "2020-09-23T06:14:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzM2MjAzNQ==", "url": "https://github.com/seata/seata/pull/3140#discussion_r493362035", "bodyText": "\u8fd9\u6ce8\u91ca\u91cc\u7684\u4f2a\u4ee3\u7801\u65b9\u6cd5\uff0c\u4e0d\u662fseata\u73b0\u6709\u7684api\u3002\u8fd9\u4e2a\u5730\u65b9\uff0c\u662f\u4e0d\u662f\u53ef\u4ee5\u53c2\u8003spring\u4e8b\u52a1\uff0c\u7ed9\u6e05\u6670\u7684\u6ce8\u91ca\u5c31\u597d\u4e86\uff0c\u5c31\u6bd4\u5982\u4f60\u4e0a\u9762\u76842\u53e5\uff0c\u5df2\u7ecf\u8db3\u591f\u6e05\u6670\u4e86\u3002\u52a0\u8fd9\u4e2a\u4ee3\u7801\uff0c\u4f7f\u7528\u8005\u7528\u7684\u65f6\u5019\u5982\u679c\u770b\u4e86\u8fd9\u91cc\uff0c\u4f1a\u4e0d\u4f1a\u6709\u4e2a\u9519\u89c9\uff0c\u4ed6\u7528\u8fd9\u4e2a\u4f20\u64ad\u5c5e\u6027\uff0c\u8fd8\u5f97\u7167\u7740\u8fd9\u4e2a\u6a21\u677f\u7f16\u7801\u3002\u3002\u3002\u3002\u3002\u3002\u4ee3\u7801\u793a\u4f8b\uff0c\u5e94\u8be5\u591a\u662f\u6307\u5bfc\u7528\u6237\u53bb\u7f16\u7801\u7684\uff0c\u8fd9\u4e2a\u4ee3\u7801\u793a\u4f8b\uff0c\u611f\u89c9\u662f\u6307\u5bfc\u5199\u6846\u67b6\u7684\u4eba\u7684\uff0c\u4f46\u662f\u65b9\u6cd5\u53c8\u4e0d\u662fseata\u91cc\u7684\u65b9\u6cd5\u3002\u3002\u3002\uff08\u4e2a\u4eba\u770b\u6cd5\uff0c\u63a2\u8ba8\u4e00\u4e0b\uff09", "author": "lightClouds917", "createdAt": "2020-09-23T09:24:16Z", "path": "tm/src/main/java/io/seata/tm/api/transaction/Propagation.java", "diffHunk": "@@ -19,37 +19,125 @@\n  * Propagation level of global transactions.\n  *\n  * @author haozhibei\n+ * @see io.seata.spring.annotation.GlobalTransactional\n+ * @see io.seata.tm.api.TransactionalTemplate\n  */\n public enum Propagation {\n     /**\n      * The REQUIRED.\n+     * <p>\n+     * If transaction is existing, execute with current transaction,\n+     * else execute with new transaction.\n+     * </p>\n+     * <pre>\n+     *     if (tx == null) {\n+     *         tx = beginNewTransaction(); // begin new transaction, is not existing", "originalCommit": "9b2c71f7cf521e031eace131ca22866a4d69eb1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxMDk5Mw==", "url": "https://github.com/seata/seata/pull/3140#discussion_r493410993", "bodyText": "\u6211\u53c2\u7167\u4e86JDK\u91cc\u7684\u4e00\u4e9b\u4ee3\u7801\u7684\u6ce8\u91ca\u3002\u4e5f\u662f\u5199\u4e86\u4e00\u4e9b\u4f2a\u4ee3\u7801\uff0c\u6765\u8868\u793a\u8fd9\u4e2a\u65b9\u6cd5\u7684\u57fa\u672c\u903b\u8f91\u3002\n\u6211\u89c9\u5f97\u5e94\u8be5\u6ca1\u6709\u4eba\u4f1a\u5f04\u9519\u5427\u3002", "author": "wangliang181230", "createdAt": "2020-09-23T10:14:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzM2MjAzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzM2MzMwOQ==", "url": "https://github.com/seata/seata/pull/3140#discussion_r493363309", "bodyText": "\u4ece\u6e05\u6670\u7684\u8bed\u4e49\u4e0a\u6765\u8bf4\uff0c\u8fd9\u91ccexistingTransaction \u662f\u4e0d\u662f\u6bd4 tx == null \u8fd9\u79cd\u66f4\u6e05\u6670\u4e9b\u3002", "author": "lightClouds917", "createdAt": "2020-09-23T09:25:29Z", "path": "tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java", "diffHunk": "@@ -48,64 +48,82 @@\n      * @throws TransactionalExecutor.ExecutionException the execution exception\n      */\n     public Object execute(TransactionalExecutor business) throws Throwable {\n-        // 1 get transactionInfo\n+        // 1. Get transactionInfo\n         TransactionInfo txInfo = business.getTransactionInfo();\n         if (txInfo == null) {\n             throw new ShouldNeverHappenException(\"transactionInfo does not exist\");\n         }\n-        // 1.1 get or create a transaction\n-        GlobalTransaction tx = GlobalTransactionContext.getCurrentOrCreate();\n+        // 1.1 Get current transaction, if not null, the tx role is 'GlobalTransactionRole.Participant'.\n+        GlobalTransaction tx = GlobalTransactionContext.getCurrent();\n \n-        // 1.2 Handle the Transaction propatation and the branchType\n+        // 1.2 Handle the transaction propagation.\n         Propagation propagation = txInfo.getPropagation();\n         SuspendedResourcesHolder suspendedResourcesHolder = null;\n         try {\n             switch (propagation) {\n                 case NOT_SUPPORTED:\n-                    suspendedResourcesHolder = tx.suspend(true);\n+                    // If transaction is existing, suspend it.\n+                    if (tx != null) {", "originalCommit": "9b2c71f7cf521e031eace131ca22866a4d69eb1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxOTIzMA==", "url": "https://github.com/seata/seata/pull/3140#discussion_r493419230", "bodyText": "done", "author": "wangliang181230", "createdAt": "2020-09-23T10:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzM2MzMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzM2NjIyMw==", "url": "https://github.com/seata/seata/pull/3140#discussion_r493366223", "bodyText": "\u6309\u7167\u4e00\u8d2f\u7684\u98ce\u683c\uff0cjava.*\u7684\u4ee3\u7801\u5e94\u8be5\u5728\u6700\u4e0a\u9762", "author": "lightClouds917", "createdAt": "2020-09-23T09:28:17Z", "path": "tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java", "diffHunk": "@@ -26,7 +24,9 @@\n import io.seata.tm.api.transaction.TransactionHook;\n import io.seata.tm.api.transaction.TransactionHookManager;\n import io.seata.tm.api.transaction.TransactionInfo;\n+\n import java.util.List;\n+", "originalCommit": "9b2c71f7cf521e031eace131ca22866a4d69eb1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQxNDM0OQ==", "url": "https://github.com/seata/seata/pull/3140#discussion_r493414349", "bodyText": "done", "author": "wangliang181230", "createdAt": "2020-09-23T10:18:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzM2NjIyMw=="}], "type": "inlineReview"}, {"oid": "b6bdc64347358857fefb2fae978a99728e41aba3", "url": "https://github.com/seata/seata/commit/b6bdc64347358857fefb2fae978a99728e41aba3", "message": "Merge remote-tracking branch 'remotes/upstream/develop' into bugfix-tm-propagation-new", "committedDate": "2020-09-23T10:13:25Z", "type": "commit"}, {"oid": "0898cfa334a1c2624437fdc8ef113d6492db17e3", "url": "https://github.com/seata/seata/commit/0898cfa334a1c2624437fdc8ef113d6492db17e3", "message": "move import", "committedDate": "2020-09-23T10:18:37Z", "type": "commit"}, {"oid": "1e11b068ee7689b991d1288d32b5395a39d5f44a", "url": "https://github.com/seata/seata/commit/1e11b068ee7689b991d1288d32b5395a39d5f44a", "message": "optimize code", "committedDate": "2020-09-23T10:23:25Z", "type": "commit"}, {"oid": "1cb497dc56f8eea7d6da80789531a2ba00e0ef24", "url": "https://github.com/seata/seata/commit/1cb497dc56f8eea7d6da80789531a2ba00e0ef24", "message": "Merge branch 'develop' into bugfix-tm-propagation-new", "committedDate": "2020-09-23T10:23:57Z", "type": "commit"}, {"oid": "999a3825df4e0b387956fd4507f2dc2d8b15b0f2", "url": "https://github.com/seata/seata/commit/999a3825df4e0b387956fd4507f2dc2d8b15b0f2", "message": "optimize notes", "committedDate": "2020-09-23T10:34:08Z", "type": "commit"}, {"oid": "5762c57de900296cb6b831eab6050636d52972de", "url": "https://github.com/seata/seata/commit/5762c57de900296cb6b831eab6050636d52972de", "message": "optimize notes", "committedDate": "2020-09-24T02:13:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIyMzY2Ng==", "url": "https://github.com/seata/seata/pull/3140#discussion_r494223666", "bodyText": "I think should include the\npublic\n\ncause the code style is different in different people, we should keep it same.", "author": "l81893521", "createdAt": "2020-09-24T11:00:40Z", "path": "tm/src/main/java/io/seata/tm/api/GlobalTransactionContext.java", "diffHunk": "@@ -34,7 +34,7 @@ private GlobalTransactionContext() {\n      *\n      * @return\n      */\n-    private static GlobalTransaction createNew() {\n+    static GlobalTransaction createNew() {", "originalCommit": "5762c57de900296cb6b831eab6050636d52972de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY4Nzc0NA==", "url": "https://github.com/seata/seata/pull/3140#discussion_r494687744", "bodyText": "done", "author": "wangliang181230", "createdAt": "2020-09-25T00:51:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIyMzY2Ng=="}], "type": "inlineReview"}, {"oid": "afe41085e5d0718a5225d6eedc8b3e0665d12e6c", "url": "https://github.com/seata/seata/commit/afe41085e5d0718a5225d6eedc8b3e0665d12e6c", "message": "optimize code", "committedDate": "2020-09-25T00:50:56Z", "type": "commit"}, {"oid": "e9a09d30f3cee4ac0c315b8dbf4af6af1c6344d3", "url": "https://github.com/seata/seata/commit/e9a09d30f3cee4ac0c315b8dbf4af6af1c6344d3", "message": "add more notes", "committedDate": "2020-09-25T01:57:38Z", "type": "commit"}, {"oid": "5b4f1190d8f1491c19a29a33735cb7251d8a2138", "url": "https://github.com/seata/seata/commit/5b4f1190d8f1491c19a29a33735cb7251d8a2138", "message": "Merge branch 'develop' into bugfix-tm-propagation-new", "committedDate": "2020-09-25T01:58:07Z", "type": "commit"}, {"oid": "f4f29b2616dff8a1fa54b27b4d416f0c8eb1b4e5", "url": "https://github.com/seata/seata/commit/f4f29b2616dff8a1fa54b27b4d416f0c8eb1b4e5", "message": "add more @see", "committedDate": "2020-09-25T02:17:02Z", "type": "commit"}, {"oid": "4d59edb3696b66e9db9be04d0353cfe95000fc91", "url": "https://github.com/seata/seata/commit/4d59edb3696b66e9db9be04d0353cfe95000fc91", "message": "Merge remote-tracking branch 'origin/bugfix-tm-propagation-new' into bugfix-tm-propagation-new", "committedDate": "2020-09-25T02:17:11Z", "type": "commit"}, {"oid": "59502f234d705463a8209279a77a15d919868491", "url": "https://github.com/seata/seata/commit/59502f234d705463a8209279a77a15d919868491", "message": "optimize notes", "committedDate": "2020-09-25T03:16:00Z", "type": "commit"}, {"oid": "04b459b16cf38c945f18cf2cd2a09d3b6d2126a0", "url": "https://github.com/seata/seata/commit/04b459b16cf38c945f18cf2cd2a09d3b6d2126a0", "message": "optimize notes", "committedDate": "2020-09-28T02:08:00Z", "type": "commit"}, {"oid": "b2d0f36442ae6cdeb94ee28f5e28a1d60f3ed3f6", "url": "https://github.com/seata/seata/commit/b2d0f36442ae6cdeb94ee28f5e28a1d60f3ed3f6", "message": "optimize notes", "committedDate": "2020-09-28T02:49:57Z", "type": "commit"}, {"oid": "f9983abb175ce253447a58b42860b9965cf2a07e", "url": "https://github.com/seata/seata/commit/f9983abb175ce253447a58b42860b9965cf2a07e", "message": "Merge branch 'develop' into bugfix-tm-propagation-new", "committedDate": "2020-10-02T17:25:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc1NTg0Ng==", "url": "https://github.com/seata/seata/pull/3140#discussion_r502755846", "bodyText": "Why did you make this change?", "author": "slievrly", "createdAt": "2020-10-10T06:52:50Z", "path": "tm/src/main/java/io/seata/tm/api/TransactionalTemplate.java", "diffHunk": "@@ -120,17 +136,20 @@ public Object execute(TransactionalExecutor business) throws Throwable {\n                 cleanUp();\n             }\n         } finally {\n-            tx.resume(suspendedResourcesHolder);\n+            // If the transaction is suspended, resume it.\n+            if (suspendedResourcesHolder != null) {\n+                suspendedResourcesHolder.resume();", "originalCommit": "f9983abb175ce253447a58b42860b9965cf2a07e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc1NzU5OQ==", "url": "https://github.com/seata/seata/pull/3140#discussion_r502757599", "bodyText": "Previously, I thought Holder could contain actions, but now it's back.", "author": "wangliang181230", "createdAt": "2020-10-10T07:13:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc1NTg0Ng=="}], "type": "inlineReview"}, {"oid": "7807aa233ff50dbcf0041485a2e64e53b9380162", "url": "https://github.com/seata/seata/commit/7807aa233ff50dbcf0041485a2e64e53b9380162", "message": "Merge branch 'develop' into bugfix-tm-propagation-new", "committedDate": "2020-10-10T06:54:22Z", "type": "commit"}, {"oid": "a8502f9531fcd7de7fc80f0483e716dd87b36f2c", "url": "https://github.com/seata/seata/commit/a8502f9531fcd7de7fc80f0483e716dd87b36f2c", "message": "optimize code logic", "committedDate": "2020-10-10T07:05:58Z", "type": "commit"}]}