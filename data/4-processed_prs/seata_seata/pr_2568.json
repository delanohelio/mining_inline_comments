{"pr_number": 2568, "pr_title": "feature: support GlobalTransactionInterceptor expression", "pr_createdAt": "2020-04-17T03:05:41Z", "pr_url": "https://github.com/seata/seata/pull/2568", "timeline": [{"oid": "46cb3a0831c3d3b672aa9f2d268b74aa9ca0b6b6", "url": "https://github.com/seata/seata/commit/46cb3a0831c3d3b672aa9f2d268b74aa9ca0b6b6", "message": "support aspect programming", "committedDate": "2020-04-17T03:00:50Z", "type": "commit"}, {"oid": "455ed18f322d7fe2fd71bd8421be783a8c1cabe7", "url": "https://github.com/seata/seata/commit/455ed18f322d7fe2fd71bd8421be783a8c1cabe7", "message": "Merge branch 'develop' into aop_at", "committedDate": "2020-04-17T03:05:55Z", "type": "commit"}, {"oid": "80a2b1c60274fb78dd27838b29b45613b010c06b", "url": "https://github.com/seata/seata/commit/80a2b1c60274fb78dd27838b29b45613b010c06b", "message": "format code", "committedDate": "2020-04-17T05:24:38Z", "type": "commit"}, {"oid": "11e3a649f3461b457f65d47d1afda36107158893", "url": "https://github.com/seata/seata/commit/11e3a649f3461b457f65d47d1afda36107158893", "message": "Merge branch 'aop_at' of https://github.com/a364176773/seata into aop_at", "committedDate": "2020-04-17T05:26:08Z", "type": "commit"}, {"oid": "ec1bbeced266aa0e0461e2c3b18a4d6952267c0e", "url": "https://github.com/seata/seata/commit/ec1bbeced266aa0e0461e2c3b18a4d6952267c0e", "message": "Merge branch 'develop' into aop_at", "committedDate": "2020-04-20T06:27:54Z", "type": "commit"}, {"oid": "c40d202d483df8c32ed6cca42c7d54f7d557a9ff", "url": "https://github.com/seata/seata/commit/c40d202d483df8c32ed6cca42c7d54f7d557a9ff", "message": "Merge branch 'develop' into aop_at", "committedDate": "2020-04-20T07:16:31Z", "type": "commit"}, {"oid": "85f247c7489129445fa4d9e2b344ec0e49caaba9", "url": "https://github.com/seata/seata/commit/85f247c7489129445fa4d9e2b344ec0e49caaba9", "message": "Merge branch 'develop' into aop_at", "committedDate": "2020-04-21T08:29:39Z", "type": "commit"}, {"oid": "9f2ec7775f418d256e448693353ec4140efade27", "url": "https://github.com/seata/seata/commit/9f2ec7775f418d256e448693353ec4140efade27", "message": "Merge remote-tracking branch 'mseata/develop' into aop_at", "committedDate": "2020-04-26T11:55:57Z", "type": "commit"}, {"oid": "f54fbaa45cf68de08d7798eb095c809b7fd952d9", "url": "https://github.com/seata/seata/commit/f54fbaa45cf68de08d7798eb095c809b7fd952d9", "message": "Merge branch 'develop' into aop_at", "committedDate": "2020-05-07T03:11:32Z", "type": "commit"}, {"oid": "efdf6b0b4ae687f872c8926b046fb33274dc7ede", "url": "https://github.com/seata/seata/commit/efdf6b0b4ae687f872c8926b046fb33274dc7ede", "message": "resolve conflicts", "committedDate": "2020-05-08T07:54:31Z", "type": "commit"}, {"oid": "bf0aac6dd26361a68bd01244eb48d130a5b51656", "url": "https://github.com/seata/seata/commit/bf0aac6dd26361a68bd01244eb48d130a5b51656", "message": "resolve conflicts", "committedDate": "2020-05-08T07:55:05Z", "type": "commit"}, {"oid": "82fdfeba9c27d14cae84d868eed2faca34afd5df", "url": "https://github.com/seata/seata/commit/82fdfeba9c27d14cae84d868eed2faca34afd5df", "message": "Merge branch 'develop' into aop_at", "committedDate": "2020-05-09T09:32:07Z", "type": "commit"}, {"oid": "b7deecf338ac33db5b0652f3bccf9438af57e22b", "url": "https://github.com/seata/seata/commit/b7deecf338ac33db5b0652f3bccf9438af57e22b", "message": "merge develop", "committedDate": "2020-05-12T08:19:48Z", "type": "commit"}, {"oid": "48b8a5a23c9a8476af596c39d6fdbde8b4780a3e", "url": "https://github.com/seata/seata/commit/48b8a5a23c9a8476af596c39d6fdbde8b4780a3e", "message": "Merge branch 'develop' of https://github.com/seata/seata into aop_at", "committedDate": "2020-05-20T03:45:55Z", "type": "commit"}, {"oid": "213a5dc7d4ccad651c2758c54142cab0b296038c", "url": "https://github.com/seata/seata/commit/213a5dc7d4ccad651c2758c54142cab0b296038c", "message": "bug fix", "committedDate": "2020-05-20T05:24:22Z", "type": "commit"}, {"oid": "21f427308591529ae54f114e562114a9e3ca9c2a", "url": "https://github.com/seata/seata/commit/21f427308591529ae54f114e562114a9e3ca9c2a", "message": "Merge branch 'develop' into aop_at", "committedDate": "2020-05-24T09:19:44Z", "type": "commit"}, {"oid": "dde6fb8b0c4a75c4dba40fd4b6a7b871349869d5", "url": "https://github.com/seata/seata/commit/dde6fb8b0c4a75c4dba40fd4b6a7b871349869d5", "message": "Merge branch 'develop' into aop_at", "committedDate": "2020-05-26T08:16:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyMDA3OQ==", "url": "https://github.com/seata/seata/pull/2568#discussion_r432220079", "bodyText": "Why change to public?", "author": "l81893521", "createdAt": "2020-05-29T02:15:20Z", "path": "spring/src/main/java/io/seata/spring/util/GlobalTransactionalCheck.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.spring.util;\n+\n+import java.util.concurrent.ScheduledThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+import io.seata.common.thread.NamedThreadFactory;\n+import io.seata.config.ConfigurationChangeEvent;\n+import io.seata.config.ConfigurationChangeListener;\n+import io.seata.config.ConfigurationFactory;\n+import io.seata.core.constants.ConfigurationKeys;\n+import io.seata.tm.TransactionManagerHolder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+import static io.seata.core.constants.DefaultValues.DEFAULT_DISABLE_GLOBAL_TRANSACTION;\n+import static io.seata.core.constants.DefaultValues.DEFAULT_TM_DEGRADE_CHECK;\n+import static io.seata.core.constants.DefaultValues.DEFAULT_TM_DEGRADE_CHECK_ALLOW_TIMES;\n+import static io.seata.core.constants.DefaultValues.DEFAULT_TM_DEGRADE_CHECK_PERIOD;\n+\n+/**\n+ * service dynamic processing center\n+ *\n+ * @author funkye\n+ */\n+public class GlobalTransactionalCheck implements ConfigurationChangeListener {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(GlobalTransactionalCheck.class);\n+    private static int degradeCheckPeriod;\n+    private static volatile boolean degradeCheck;\n+    private static int degradeCheckAllowTimes;\n+    private static volatile Integer degradeNum = 0;\n+    private static volatile Integer reachNum = 0;\n+    private static volatile boolean disable;\n+    private static ScheduledThreadPoolExecutor executor =\n+        new ScheduledThreadPoolExecutor(1, new NamedThreadFactory(\"degradeCheckWorker\", 1, true));\n+\n+    public GlobalTransactionalCheck() {\n+        disable = ConfigurationFactory.getInstance().getBoolean(ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,\n+            DEFAULT_DISABLE_GLOBAL_TRANSACTION);\n+        degradeCheck = ConfigurationFactory.getInstance().getBoolean(ConfigurationKeys.CLIENT_DEGRADE_CHECK,\n+            DEFAULT_TM_DEGRADE_CHECK);\n+        if (degradeCheck) {\n+            degradeCheckPeriod = ConfigurationFactory.getInstance()\n+                .getInt(ConfigurationKeys.CLIENT_DEGRADE_CHECK_PERIOD, DEFAULT_TM_DEGRADE_CHECK_PERIOD);\n+            degradeCheckAllowTimes = ConfigurationFactory.getInstance()\n+                .getInt(ConfigurationKeys.CLIENT_DEGRADE_CHECK_ALLOW_TIMES, DEFAULT_TM_DEGRADE_CHECK_ALLOW_TIMES);\n+            if (degradeCheckPeriod > 0 && degradeCheckAllowTimes > 0) {\n+                startDegradeCheck();\n+            }\n+        }\n+    }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startDegradeCheck() {\n+        executor.scheduleAtFixedRate(() -> {\n+            if (degradeCheck) {\n+                try {\n+                    String xid = TransactionManagerHolder.get().begin(null, null, \"degradeCheck\", 60000);\n+                    TransactionManagerHolder.get().commit(xid);\n+                    onDegradeCheck(true);\n+                } catch (Exception e) {\n+                    onDegradeCheck(false);\n+                }\n+            }\n+        }, degradeCheckPeriod, degradeCheckPeriod, TimeUnit.MILLISECONDS);\n+    }\n+\n+    public static synchronized void onDegradeCheck(boolean succeed) {", "originalCommit": "dde6fb8b0c4a75c4dba40fd4b6a7b871349869d5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyNjY5NQ==", "url": "https://github.com/seata/seata/pull/2568#discussion_r432226695", "bodyText": "I think degradeCheck always true in here.", "author": "l81893521", "createdAt": "2020-05-29T02:44:04Z", "path": "spring/src/main/java/io/seata/spring/util/GlobalTransactionalCheck.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.spring.util;\n+\n+import java.util.concurrent.ScheduledThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+import io.seata.common.thread.NamedThreadFactory;\n+import io.seata.config.ConfigurationChangeEvent;\n+import io.seata.config.ConfigurationChangeListener;\n+import io.seata.config.ConfigurationFactory;\n+import io.seata.core.constants.ConfigurationKeys;\n+import io.seata.tm.TransactionManagerHolder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+import static io.seata.core.constants.DefaultValues.DEFAULT_DISABLE_GLOBAL_TRANSACTION;\n+import static io.seata.core.constants.DefaultValues.DEFAULT_TM_DEGRADE_CHECK;\n+import static io.seata.core.constants.DefaultValues.DEFAULT_TM_DEGRADE_CHECK_ALLOW_TIMES;\n+import static io.seata.core.constants.DefaultValues.DEFAULT_TM_DEGRADE_CHECK_PERIOD;\n+\n+/**\n+ * service dynamic processing center\n+ *\n+ * @author funkye\n+ */\n+public class GlobalTransactionalCheck implements ConfigurationChangeListener {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(GlobalTransactionalCheck.class);\n+    private static int degradeCheckPeriod;\n+    private static volatile boolean degradeCheck;\n+    private static int degradeCheckAllowTimes;\n+    private static volatile Integer degradeNum = 0;\n+    private static volatile Integer reachNum = 0;\n+    private static volatile boolean disable;\n+    private static ScheduledThreadPoolExecutor executor =\n+        new ScheduledThreadPoolExecutor(1, new NamedThreadFactory(\"degradeCheckWorker\", 1, true));\n+\n+    public GlobalTransactionalCheck() {\n+        disable = ConfigurationFactory.getInstance().getBoolean(ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,\n+            DEFAULT_DISABLE_GLOBAL_TRANSACTION);\n+        degradeCheck = ConfigurationFactory.getInstance().getBoolean(ConfigurationKeys.CLIENT_DEGRADE_CHECK,\n+            DEFAULT_TM_DEGRADE_CHECK);\n+        if (degradeCheck) {\n+            degradeCheckPeriod = ConfigurationFactory.getInstance()\n+                .getInt(ConfigurationKeys.CLIENT_DEGRADE_CHECK_PERIOD, DEFAULT_TM_DEGRADE_CHECK_PERIOD);\n+            degradeCheckAllowTimes = ConfigurationFactory.getInstance()\n+                .getInt(ConfigurationKeys.CLIENT_DEGRADE_CHECK_ALLOW_TIMES, DEFAULT_TM_DEGRADE_CHECK_ALLOW_TIMES);\n+            if (degradeCheckPeriod > 0 && degradeCheckAllowTimes > 0) {\n+                startDegradeCheck();\n+            }\n+        }\n+    }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startDegradeCheck() {\n+        executor.scheduleAtFixedRate(() -> {\n+            if (degradeCheck) {\n+                try {\n+                    String xid = TransactionManagerHolder.get().begin(null, null, \"degradeCheck\", 60000);\n+                    TransactionManagerHolder.get().commit(xid);\n+                    onDegradeCheck(true);\n+                } catch (Exception e) {\n+                    onDegradeCheck(false);\n+                }\n+            }\n+        }, degradeCheckPeriod, degradeCheckPeriod, TimeUnit.MILLISECONDS);\n+    }\n+\n+    public static synchronized void onDegradeCheck(boolean succeed) {\n+        if (succeed) {\n+            if (degradeNum >= degradeCheckAllowTimes) {\n+                reachNum++;\n+                if (reachNum >= degradeCheckAllowTimes) {\n+                    reachNum = 0;\n+                    degradeNum = 0;\n+                    if (LOGGER.isInfoEnabled()) {\n+                        LOGGER.info(\"the current global transaction has been restored\");\n+                    }\n+                }\n+            } else if (degradeNum != 0) {\n+                degradeNum = 0;\n+            }\n+        } else {\n+            if (degradeNum < degradeCheckAllowTimes) {\n+                degradeNum++;\n+                if (degradeNum >= degradeCheckAllowTimes) {\n+                    if (LOGGER.isWarnEnabled()) {\n+                        LOGGER.warn(\"the current global transaction has been automatically downgraded\");\n+                    }\n+                }\n+            } else if (reachNum != 0) {\n+                reachNum = 0;\n+            }\n+        }\n+    }\n+\n+    public static boolean getStatus() {\n+        if (!degradeCheck) {\n+            return disable;\n+        }\n+        return disable || (degradeCheck && degradeNum >= degradeCheckAllowTimes);", "originalCommit": "dde6fb8b0c4a75c4dba40fd4b6a7b871349869d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI1OTU0Nw==", "url": "https://github.com/seata/seata/pull/2568#discussion_r432259547", "bodyText": "PTAL", "author": "a364176773", "createdAt": "2020-05-29T05:15:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyNjY5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyNzM1NA==", "url": "https://github.com/seata/seata/pull/2568#discussion_r432227354", "bodyText": "I think maybe change the method name, it will be more readable. like\nlocalDisable()", "author": "l81893521", "createdAt": "2020-05-29T02:46:58Z", "path": "spring/src/main/java/io/seata/spring/util/GlobalTransactionalCheck.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.spring.util;\n+\n+import java.util.concurrent.ScheduledThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+import io.seata.common.thread.NamedThreadFactory;\n+import io.seata.config.ConfigurationChangeEvent;\n+import io.seata.config.ConfigurationChangeListener;\n+import io.seata.config.ConfigurationFactory;\n+import io.seata.core.constants.ConfigurationKeys;\n+import io.seata.tm.TransactionManagerHolder;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+\n+import static io.seata.core.constants.DefaultValues.DEFAULT_DISABLE_GLOBAL_TRANSACTION;\n+import static io.seata.core.constants.DefaultValues.DEFAULT_TM_DEGRADE_CHECK;\n+import static io.seata.core.constants.DefaultValues.DEFAULT_TM_DEGRADE_CHECK_ALLOW_TIMES;\n+import static io.seata.core.constants.DefaultValues.DEFAULT_TM_DEGRADE_CHECK_PERIOD;\n+\n+/**\n+ * service dynamic processing center\n+ *\n+ * @author funkye\n+ */\n+public class GlobalTransactionalCheck implements ConfigurationChangeListener {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(GlobalTransactionalCheck.class);\n+    private static int degradeCheckPeriod;\n+    private static volatile boolean degradeCheck;\n+    private static int degradeCheckAllowTimes;\n+    private static volatile Integer degradeNum = 0;\n+    private static volatile Integer reachNum = 0;\n+    private static volatile boolean disable;\n+    private static ScheduledThreadPoolExecutor executor =\n+        new ScheduledThreadPoolExecutor(1, new NamedThreadFactory(\"degradeCheckWorker\", 1, true));\n+\n+    public GlobalTransactionalCheck() {\n+        disable = ConfigurationFactory.getInstance().getBoolean(ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,\n+            DEFAULT_DISABLE_GLOBAL_TRANSACTION);\n+        degradeCheck = ConfigurationFactory.getInstance().getBoolean(ConfigurationKeys.CLIENT_DEGRADE_CHECK,\n+            DEFAULT_TM_DEGRADE_CHECK);\n+        if (degradeCheck) {\n+            degradeCheckPeriod = ConfigurationFactory.getInstance()\n+                .getInt(ConfigurationKeys.CLIENT_DEGRADE_CHECK_PERIOD, DEFAULT_TM_DEGRADE_CHECK_PERIOD);\n+            degradeCheckAllowTimes = ConfigurationFactory.getInstance()\n+                .getInt(ConfigurationKeys.CLIENT_DEGRADE_CHECK_ALLOW_TIMES, DEFAULT_TM_DEGRADE_CHECK_ALLOW_TIMES);\n+            if (degradeCheckPeriod > 0 && degradeCheckAllowTimes > 0) {\n+                startDegradeCheck();\n+            }\n+        }\n+    }\n+\n+    /**\n+     * auto upgrade service detection\n+     */\n+    private static void startDegradeCheck() {\n+        executor.scheduleAtFixedRate(() -> {\n+            if (degradeCheck) {\n+                try {\n+                    String xid = TransactionManagerHolder.get().begin(null, null, \"degradeCheck\", 60000);\n+                    TransactionManagerHolder.get().commit(xid);\n+                    onDegradeCheck(true);\n+                } catch (Exception e) {\n+                    onDegradeCheck(false);\n+                }\n+            }\n+        }, degradeCheckPeriod, degradeCheckPeriod, TimeUnit.MILLISECONDS);\n+    }\n+\n+    public static synchronized void onDegradeCheck(boolean succeed) {\n+        if (succeed) {\n+            if (degradeNum >= degradeCheckAllowTimes) {\n+                reachNum++;\n+                if (reachNum >= degradeCheckAllowTimes) {\n+                    reachNum = 0;\n+                    degradeNum = 0;\n+                    if (LOGGER.isInfoEnabled()) {\n+                        LOGGER.info(\"the current global transaction has been restored\");\n+                    }\n+                }\n+            } else if (degradeNum != 0) {\n+                degradeNum = 0;\n+            }\n+        } else {\n+            if (degradeNum < degradeCheckAllowTimes) {\n+                degradeNum++;\n+                if (degradeNum >= degradeCheckAllowTimes) {\n+                    if (LOGGER.isWarnEnabled()) {\n+                        LOGGER.warn(\"the current global transaction has been automatically downgraded\");\n+                    }\n+                }\n+            } else if (reachNum != 0) {\n+                reachNum = 0;\n+            }\n+        }\n+    }\n+\n+    public static boolean getStatus() {", "originalCommit": "dde6fb8b0c4a75c4dba40fd4b6a7b871349869d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI1MjMwMA==", "url": "https://github.com/seata/seata/pull/2568#discussion_r432252300", "bodyText": "I think maybe change the method name, it will be more readable. like\nlocalDisable()\n\n\nok", "author": "a364176773", "createdAt": "2020-05-29T04:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIyNzM1NA=="}], "type": "inlineReview"}, {"oid": "a8ac68ce147f0d0463624c85f4878d63b24f7cda", "url": "https://github.com/seata/seata/commit/a8ac68ce147f0d0463624c85f4878d63b24f7cda", "message": "bug fix and optimized code", "committedDate": "2020-05-29T05:05:11Z", "type": "commit"}, {"oid": "c9322c22eaeb1a14eca80bbf7181546774033361", "url": "https://github.com/seata/seata/commit/c9322c22eaeb1a14eca80bbf7181546774033361", "message": "Merge branch 'develop' into aop_at", "committedDate": "2020-05-29T05:15:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI5MTI3NQ==", "url": "https://github.com/seata/seata/pull/2568#discussion_r432291275", "bodyText": "Why remove the degrade check?", "author": "l81893521", "createdAt": "2020-05-29T06:59:26Z", "path": "spring/src/main/java/io/seata/spring/annotation/HandleGlobalTransaction.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.spring.annotation;\n+\n+import java.lang.reflect.Method;\n+import java.util.LinkedHashSet;\n+import java.util.Set;\n+\n+import org.aopalliance.intercept.MethodInvocation;\n+\n+import io.seata.common.exception.ShouldNeverHappenException;\n+import io.seata.common.util.StringUtils;\n+import io.seata.tm.api.FailureHandler;\n+import io.seata.tm.api.TransactionalExecutor;\n+import io.seata.tm.api.TransactionalTemplate;\n+import io.seata.tm.api.transaction.NoRollbackRule;\n+import io.seata.tm.api.transaction.RollbackRule;\n+import io.seata.tm.api.transaction.TransactionInfo;\n+\n+/**\n+ * @author funkye\n+ * @date 2020/4/17\n+ */\n+public class HandleGlobalTransaction {\n+\n+    public Object runTransaction(final MethodInvocation methodInvocation, final Object globalTrxAnno,\n+        final FailureHandler failureHandler, final TransactionalTemplate transactionalTemplate) throws Throwable {\n+        try {\n+            return transactionalTemplate.execute(new TransactionalExecutor() {\n+                @Override\n+                public Object execute() throws Throwable {\n+                    return methodInvocation.proceed();\n+                }\n+\n+                @Override\n+                public TransactionInfo getTransactionInfo() {\n+                    return getInfo(globalTrxAnno, methodInvocation.getMethod());\n+                }\n+\n+            });\n+        } catch (TransactionalExecutor.ExecutionException e) {\n+            throw switchExecutionException(e, failureHandler);\n+        }\n+    }\n+\n+    private TransactionInfo getInfo(Object globalTrxAnno, Method method) {\n+        TransactionInfo transactionInfo = new TransactionInfo();\n+        AtTransactional globalTrx = convertAtTransactional(globalTrxAnno);\n+        transactionInfo.setTimeOut(globalTrx.getTimeoutMills());\n+        String name = globalTrx.getName();\n+        if (StringUtils.isNullOrEmpty(name)) {\n+            name = formatMethod(method);\n+        }\n+        transactionInfo.setName(name);\n+        transactionInfo.setPropagation(globalTrx.getPropagation());\n+        Set<RollbackRule> rollbackRules = new LinkedHashSet<>();\n+        for (Class<?> rbRule : globalTrx.getRollbackFor()) {\n+            rollbackRules.add(new RollbackRule(rbRule));\n+        }\n+        for (String rbRule : globalTrx.getRollbackForClassName()) {\n+            rollbackRules.add(new RollbackRule(rbRule));\n+        }\n+        for (Class<?> rbRule : globalTrx.getNoRollbackFor()) {\n+            rollbackRules.add(new NoRollbackRule(rbRule));\n+        }\n+        for (String rbRule : globalTrx.getNoRollbackForClassName()) {\n+            rollbackRules.add(new NoRollbackRule(rbRule));\n+        }\n+        transactionInfo.setRollbackRules(rollbackRules);\n+        return transactionInfo;\n+    }\n+\n+    private Throwable switchExecutionException(TransactionalExecutor.ExecutionException e,\n+        FailureHandler failureHandler) throws Throwable {\n+        TransactionalExecutor.Code code = e.getCode();\n+        switch (code) {", "originalCommit": "c9322c22eaeb1a14eca80bbf7181546774033361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM3NzQ4Ng==", "url": "https://github.com/seata/seata/pull/2568#discussion_r432377486", "bodyText": "Why remove the degrade check?\n\nPTAL", "author": "a364176773", "createdAt": "2020-05-29T09:49:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI5MTI3NQ=="}], "type": "inlineReview"}, {"oid": "d484d4fe058207e4bd5e511841fd89536dc4d308", "url": "https://github.com/seata/seata/commit/d484d4fe058207e4bd5e511841fd89536dc4d308", "message": "bug fix", "committedDate": "2020-05-29T08:57:03Z", "type": "commit"}, {"oid": "373f1db51a6b9d737aac7e29c14ab67c3014cb2d", "url": "https://github.com/seata/seata/commit/373f1db51a6b9d737aac7e29c14ab67c3014cb2d", "message": "code formatting", "committedDate": "2020-05-29T10:59:30Z", "type": "commit"}, {"oid": "d0a59d53395369d2a4247bed990bc8bbcd9a8a9b", "url": "https://github.com/seata/seata/commit/d0a59d53395369d2a4247bed990bc8bbcd9a8a9b", "message": "optimized code", "committedDate": "2020-05-30T14:18:50Z", "type": "commit"}, {"oid": "f7f5b978242c6408cfce7357f5a8a372a1738f02", "url": "https://github.com/seata/seata/commit/f7f5b978242c6408cfce7357f5a8a372a1738f02", "message": "Merge branch 'develop' into aop_at", "committedDate": "2020-06-02T15:01:18Z", "type": "commit"}, {"oid": "cec06747119a30473718d37cfdeab6eae50f0231", "url": "https://github.com/seata/seata/commit/cec06747119a30473718d37cfdeab6eae50f0231", "message": "Merge branch 'develop' into aop_at", "committedDate": "2020-06-03T03:48:11Z", "type": "commit"}, {"oid": "a1f0ac4caf58cc71dd33b754e66f3765f74bf5c9", "url": "https://github.com/seata/seata/commit/a1f0ac4caf58cc71dd33b754e66f3765f74bf5c9", "message": "Merge branch 'develop' into aop_at", "committedDate": "2020-06-03T05:55:33Z", "type": "commit"}, {"oid": "e817f4912eceebc99692ef19f365610e6151baa8", "url": "https://github.com/seata/seata/commit/e817f4912eceebc99692ef19f365610e6151baa8", "message": "Merge branch 'develop' into aop_at", "committedDate": "2020-06-18T02:59:03Z", "type": "commit"}, {"oid": "e817f4912eceebc99692ef19f365610e6151baa8", "url": "https://github.com/seata/seata/commit/e817f4912eceebc99692ef19f365610e6151baa8", "message": "Merge branch 'develop' into aop_at", "committedDate": "2020-06-18T02:59:03Z", "type": "forcePushed"}, {"oid": "c623e0495982f310efad2a6c745da3dd90ec9c1f", "url": "https://github.com/seata/seata/commit/c623e0495982f310efad2a6c745da3dd90ec9c1f", "message": "merge seata develop", "committedDate": "2020-06-23T13:55:51Z", "type": "commit"}, {"oid": "7b33b0a6bf2f6a3581a3f24f46d800b4d31e75fc", "url": "https://github.com/seata/seata/commit/7b33b0a6bf2f6a3581a3f24f46d800b4d31e75fc", "message": "fix bug", "committedDate": "2020-06-27T09:37:49Z", "type": "commit"}, {"oid": "cf7cf8b2535945bf77669f6dde84e3e72e711620", "url": "https://github.com/seata/seata/commit/cf7cf8b2535945bf77669f6dde84e3e72e711620", "message": "merge develop", "committedDate": "2020-06-27T09:42:51Z", "type": "commit"}, {"oid": "15cdfd9c995ca783d1731602fc8fcd6f9f1a0b72", "url": "https://github.com/seata/seata/commit/15cdfd9c995ca783d1731602fc8fcd6f9f1a0b72", "message": "resolving code conflicts", "committedDate": "2020-07-20T15:03:31Z", "type": "commit"}, {"oid": "be69cdb4a1c3d32922d033621b78d385a23fa569", "url": "https://github.com/seata/seata/commit/be69cdb4a1c3d32922d033621b78d385a23fa569", "message": "Merge branch 'develop' into aop_at", "committedDate": "2020-07-30T09:59:01Z", "type": "commit"}, {"oid": "2fcfd33ed9529a6164d3188d21e285531896d238", "url": "https://github.com/seata/seata/commit/2fcfd33ed9529a6164d3188d21e285531896d238", "message": "optimize code", "committedDate": "2020-07-31T02:06:33Z", "type": "commit"}, {"oid": "cc0501fd632843332ae5fe27f2a5a80884ba6245", "url": "https://github.com/seata/seata/commit/cc0501fd632843332ae5fe27f2a5a80884ba6245", "message": "merge code", "committedDate": "2021-07-17T16:31:01Z", "type": "commit"}, {"oid": "d9ca208d13b269a6d5b5c9410d1eaed1094bf9d0", "url": "https://github.com/seata/seata/commit/d9ca208d13b269a6d5b5c9410d1eaed1094bf9d0", "message": "rollback", "committedDate": "2021-07-17T16:32:59Z", "type": "commit"}, {"oid": "80109ab8d11fe72a8a4dac11fac3470827acfc0d", "url": "https://github.com/seata/seata/commit/80109ab8d11fe72a8a4dac11fac3470827acfc0d", "message": "optimize", "committedDate": "2021-07-17T17:53:50Z", "type": "commit"}, {"oid": "fca090885f75cf3ee09ba5ff471c269fd889c4e5", "url": "https://github.com/seata/seata/commit/fca090885f75cf3ee09ba5ff471c269fd889c4e5", "message": "optimize", "committedDate": "2021-07-18T05:02:01Z", "type": "commit"}, {"oid": "36bbedadee3dfcc575c04aabbaea93630468c8b2", "url": "https://github.com/seata/seata/commit/36bbedadee3dfcc575c04aabbaea93630468c8b2", "message": "registration of pr", "committedDate": "2021-07-18T05:40:59Z", "type": "commit"}]}