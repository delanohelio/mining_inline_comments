{"pr_number": 2629, "pr_title": "bugfix: fix duplicated resource id in PostgreSQL", "pr_createdAt": "2020-04-28T03:09:40Z", "pr_url": "https://github.com/seata/seata/pull/2629", "timeline": [{"oid": "e223c337b9e0ba96698e0c1ad6d99b22934c81ca", "url": "https://github.com/seata/seata/commit/e223c337b9e0ba96698e0c1ad6d99b22934c81ca", "message": "separate table by schema in pg", "committedDate": "2020-04-27T10:49:30Z", "type": "commit"}, {"oid": "f3ab0765b4a5193e724787a41f62626971a66577", "url": "https://github.com/seata/seata/commit/f3ab0765b4a5193e724787a41f62626971a66577", "message": "fix duplicated resource id", "committedDate": "2020-04-28T02:53:46Z", "type": "commit"}, {"oid": "292fc0e78c7cb1b03f36282ddb12cb1f4d07018e", "url": "https://github.com/seata/seata/commit/292fc0e78c7cb1b03f36282ddb12cb1f4d07018e", "message": "fix duplicated resource id", "committedDate": "2020-04-28T03:01:25Z", "type": "commit"}, {"oid": "173aac3dff883a78554ff64b6b29fb493b49c6ba", "url": "https://github.com/seata/seata/commit/173aac3dff883a78554ff64b6b29fb493b49c6ba", "message": "fix duplicated resource id", "committedDate": "2020-04-28T03:05:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjUwOTI0NA==", "url": "https://github.com/seata/seata/pull/2629#discussion_r416509244", "bodyText": "1.currentSchema is magic number\n2.break?", "author": "zjinlei", "createdAt": "2020-04-28T10:36:12Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/DataSourceProxy.java", "diffHunk": "@@ -141,7 +141,32 @@ public String getResourceGroupId() {\n     @Override\n     public String getResourceId() {\n         if (jdbcUrl.contains(\"?\")) {\n-            return jdbcUrl.substring(0, jdbcUrl.indexOf('?'));\n+            StringBuilder jdbcUrlBuilder = new StringBuilder();\n+            jdbcUrlBuilder.append(jdbcUrl.substring(0, jdbcUrl.indexOf('?')));\n+            /*\n+             * prevent pg sql url like\n+             * jdbc:postgresql://127.0.0.1:5432/seata?currentSchema=public\n+             * jdbc:postgresql://127.0.0.1:5432/seata?currentSchema=seata\n+             * cause the duplicated resourceId\n+             * it will cause the problem like\n+             * 1.get file lock fail\n+             * 2.error table meta cache\n+             */\n+            StringBuilder paramsBuilder = new StringBuilder();\n+            String paramUrl = jdbcUrl.substring(jdbcUrl.indexOf('?') + 1, jdbcUrl.length());\n+            String[] urlParams = paramUrl.split(\"&\");\n+            for (String urlParam : urlParams) {\n+                if (urlParam.contains(\"currentSchema\")) {\n+                    paramsBuilder.append(urlParam);\n+                }", "originalCommit": "173aac3dff883a78554ff64b6b29fb493b49c6ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNjYyNQ==", "url": "https://github.com/seata/seata/pull/2629#discussion_r417016625", "bodyText": "ok. Already add break", "author": "l81893521", "createdAt": "2020-04-29T01:16:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjUwOTI0NA=="}], "type": "inlineReview"}, {"oid": "2943b0e49a2be0f99d44c68a1a2e2d34ebf3ab8e", "url": "https://github.com/seata/seata/commit/2943b0e49a2be0f99d44c68a1a2e2d34ebf3ab8e", "message": "add break", "committedDate": "2020-04-29T01:12:41Z", "type": "commit"}, {"oid": "93550eeaf2ec0de41d0c413680b008dce89f9808", "url": "https://github.com/seata/seata/commit/93550eeaf2ec0de41d0c413680b008dce89f9808", "message": "Merge branch 'develop' into seperate_table_by_schema_pg", "committedDate": "2020-04-29T06:20:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5MDI1MA==", "url": "https://github.com/seata/seata/pull/2629#discussion_r417090250", "bodyText": "According to dbType, non-pg remains the same", "author": "zjinlei", "createdAt": "2020-04-29T06:23:18Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/DataSourceProxy.java", "diffHunk": "@@ -141,7 +141,33 @@ public String getResourceGroupId() {\n     @Override\n     public String getResourceId() {\n         if (jdbcUrl.contains(\"?\")) {\n-            return jdbcUrl.substring(0, jdbcUrl.indexOf('?'));\n+            StringBuilder jdbcUrlBuilder = new StringBuilder();", "originalCommit": "93550eeaf2ec0de41d0c413680b008dce89f9808", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE5MjY4OA==", "url": "https://github.com/seata/seata/pull/2629#discussion_r417192688", "bodyText": "fixed", "author": "l81893521", "createdAt": "2020-04-29T09:46:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5MDI1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyODU2Ng==", "url": "https://github.com/seata/seata/pull/2629#discussion_r417128566", "bodyText": "remove else, direct return?", "author": "jsbxyyx", "createdAt": "2020-04-29T07:50:38Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/DataSourceProxy.java", "diffHunk": "@@ -141,7 +141,33 @@ public String getResourceGroupId() {\n     @Override\n     public String getResourceId() {\n         if (jdbcUrl.contains(\"?\")) {\n-            return jdbcUrl.substring(0, jdbcUrl.indexOf('?'));\n+            StringBuilder jdbcUrlBuilder = new StringBuilder();\n+            jdbcUrlBuilder.append(jdbcUrl.substring(0, jdbcUrl.indexOf('?')));\n+            /*\n+             * prevent pg sql url like\n+             * jdbc:postgresql://127.0.0.1:5432/seata?currentSchema=public\n+             * jdbc:postgresql://127.0.0.1:5432/seata?currentSchema=seata\n+             * cause the duplicated resourceId\n+             * it will cause the problem like\n+             * 1.get file lock fail\n+             * 2.error table meta cache\n+             */\n+            StringBuilder paramsBuilder = new StringBuilder();\n+            String paramUrl = jdbcUrl.substring(jdbcUrl.indexOf('?') + 1, jdbcUrl.length());\n+            String[] urlParams = paramUrl.split(\"&\");\n+            for (String urlParam : urlParams) {\n+                if (urlParam.contains(\"currentSchema\")) {\n+                    paramsBuilder.append(urlParam);\n+                    break;\n+                }\n+            }\n+\n+            if (paramsBuilder.length() > 0) {\n+                jdbcUrlBuilder.append(\"?\");\n+                jdbcUrlBuilder.append(paramsBuilder);\n+            }\n+\n+            return jdbcUrlBuilder.toString();\n         } else {", "originalCommit": "93550eeaf2ec0de41d0c413680b008dce89f9808", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE5NDI1Mw==", "url": "https://github.com/seata/seata/pull/2629#discussion_r417194253", "bodyText": "I think\nif() {\n\n} else {\n\n}\n\nis more readable.", "author": "l81893521", "createdAt": "2020-04-29T09:48:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyODU2Ng=="}], "type": "inlineReview"}, {"oid": "010024cff216744d07a02d4768e0cfa30aa0f2d6", "url": "https://github.com/seata/seata/commit/010024cff216744d07a02d4768e0cfa30aa0f2d6", "message": "add db type", "committedDate": "2020-04-29T09:40:12Z", "type": "commit"}, {"oid": "397f940fd0d628809df86d0daaf8aff5498f7b97", "url": "https://github.com/seata/seata/commit/397f940fd0d628809df86d0daaf8aff5498f7b97", "message": "Merge remote-tracking branch 'me/seperate_table_by_schema_pg' into seperate_table_by_schema_pg", "committedDate": "2020-04-29T09:41:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM0NTg0Mw==", "url": "https://github.com/seata/seata/pull/2629#discussion_r417345843", "bodyText": "Keep the original clear, suggest:\nreturn DBType.POSTGRESQL.name().equalsIgnoreCase(getDbType())? getPgResourceId() : jdbcUrl.substring(0,jdbcUrl.indexOf('?'));", "author": "zjinlei", "createdAt": "2020-04-29T14:11:19Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/DataSourceProxy.java", "diffHunk": "@@ -141,7 +142,35 @@ public String getResourceGroupId() {\n     @Override\n     public String getResourceId() {\n         if (jdbcUrl.contains(\"?\")) {\n-            return jdbcUrl.substring(0, jdbcUrl.indexOf('?'));", "originalCommit": "397f940fd0d628809df86d0daaf8aff5498f7b97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcwNDk3Ng==", "url": "https://github.com/seata/seata/pull/2629#discussion_r417704976", "bodyText": "fixed.", "author": "l81893521", "createdAt": "2020-04-30T01:28:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM0NTg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MjY1NQ==", "url": "https://github.com/seata/seata/pull/2629#discussion_r417742655", "bodyText": "Only separate the different parts.\nif (!jdbcUrl.contains(\"?\")) is the same", "author": "zjinlei", "createdAt": "2020-04-30T04:11:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM0NTg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQwMjc4Mw==", "url": "https://github.com/seata/seata/pull/2629#discussion_r418402783", "bodyText": "as you say, the code would be like this\nif (jdbcUrl.contains(\"?\")) {\n    if (DBType.POSTGRESQL.name().equalsIgnoreCase(getDbType())) {\n        getPGResourceId();\n    } else {\n      do something....\n    }\n} else {\n    do something\n}\n\nthe code is less, but the logic is more complicated.", "author": "l81893521", "createdAt": "2020-05-01T03:38:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM0NTg0Mw=="}], "type": "inlineReview"}, {"oid": "33160d1742183a5040a64046fba867b29e6d5f31", "url": "https://github.com/seata/seata/commit/33160d1742183a5040a64046fba867b29e6d5f31", "message": "make it more clear", "committedDate": "2020-04-30T01:27:03Z", "type": "commit"}, {"oid": "1025ce0de9cfeeeb493ed56e884cb9246509131e", "url": "https://github.com/seata/seata/commit/1025ce0de9cfeeeb493ed56e884cb9246509131e", "message": "make it more clear.", "committedDate": "2020-04-30T01:31:42Z", "type": "commit"}, {"oid": "bca658ced7575ad26b81081206b8839757b2a78b", "url": "https://github.com/seata/seata/commit/bca658ced7575ad26b81081206b8839757b2a78b", "message": "Merge branch 'develop' into seperate_table_by_schema_pg", "committedDate": "2020-05-02T16:05:48Z", "type": "commit"}, {"oid": "b99de959867911a081ffbf52ffb91491189f3798", "url": "https://github.com/seata/seata/commit/b99de959867911a081ffbf52ffb91491189f3798", "message": "Merge branch 'develop' into seperate_table_by_schema_pg", "committedDate": "2020-05-03T03:32:59Z", "type": "commit"}, {"oid": "0d8bad2864c3ecfdb79c9736740f221907852438", "url": "https://github.com/seata/seata/commit/0d8bad2864c3ecfdb79c9736740f221907852438", "message": "Merge branch 'develop' into seperate_table_by_schema_pg", "committedDate": "2020-05-06T08:07:54Z", "type": "commit"}, {"oid": "1dd32311e42fae09683227df2f74e064ea915884", "url": "https://github.com/seata/seata/commit/1dd32311e42fae09683227df2f74e064ea915884", "message": "Merge branch 'develop' into seperate_table_by_schema_pg", "committedDate": "2020-05-06T08:46:21Z", "type": "commit"}]}