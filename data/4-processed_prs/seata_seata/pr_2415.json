{"pr_number": 2415, "pr_title": "optimize: distinguish database behavior according to the branch type", "pr_createdAt": "2020-03-17T11:13:53Z", "pr_url": "https://github.com/seata/seata/pull/2415", "timeline": [{"oid": "92a1e4b400b4e5a52530e8965599f7928c8e32d3", "url": "https://github.com/seata/seata/commit/92a1e4b400b4e5a52530e8965599f7928c8e32d3", "message": "optimize: optimize transaction context behavior when transaction mode is switched", "committedDate": "2020-02-26T15:23:14Z", "type": "commit"}, {"oid": "7829ce7022660f47357d2e10aab4b80b2c1a9fff", "url": "https://github.com/seata/seata/commit/7829ce7022660f47357d2e10aab4b80b2c1a9fff", "message": "adjust BranchType switching with Propagation feature", "committedDate": "2020-02-29T03:38:54Z", "type": "commit"}, {"oid": "f4e407885ef5496cc26bca0a3a2df083efc37c12", "url": "https://github.com/seata/seata/commit/f4e407885ef5496cc26bca0a3a2df083efc37c12", "message": "Merge remote-tracking branch 'upstream/develop' into f_tcc", "committedDate": "2020-03-02T02:17:52Z", "type": "commit"}, {"oid": "ef1ea3cb4db95c87aa787f48720bb8cc1c12f5ae", "url": "https://github.com/seata/seata/commit/ef1ea3cb4db95c87aa787f48720bb8cc1c12f5ae", "message": "format code style", "committedDate": "2020-03-02T03:18:06Z", "type": "commit"}, {"oid": "65312ddb69e103cea2552d6ea6ee3893bf31e509", "url": "https://github.com/seata/seata/commit/65312ddb69e103cea2552d6ea6ee3893bf31e509", "message": "Merge branch 'develop' into f_tcc", "committedDate": "2020-03-05T01:46:22Z", "type": "commit"}, {"oid": "d3f14830d070fe5232213ac533e2867fe10f610b", "url": "https://github.com/seata/seata/commit/d3f14830d070fe5232213ac533e2867fe10f610b", "message": "Merge branch 'develop' into f_tcc", "committedDate": "2020-03-06T14:06:47Z", "type": "commit"}, {"oid": "9bbdd1fc0acf440c167338afa4689b27e35df6d0", "url": "https://github.com/seata/seata/commit/9bbdd1fc0acf440c167338afa4689b27e35df6d0", "message": "fix the mistake in sagaBranch and rename defaultBranchType", "committedDate": "2020-03-07T00:42:34Z", "type": "commit"}, {"oid": "8fb6dc213670d1615639c6b3eb4dc41f7e0c62ce", "url": "https://github.com/seata/seata/commit/8fb6dc213670d1615639c6b3eb4dc41f7e0c62ce", "message": "handle required branchType", "committedDate": "2020-03-07T06:02:04Z", "type": "commit"}, {"oid": "059610878760c39482ebd63d6642f34b8d681bff", "url": "https://github.com/seata/seata/commit/059610878760c39482ebd63d6642f34b8d681bff", "message": "Merge branch 'develop' into f_tcc", "committedDate": "2020-03-07T11:02:37Z", "type": "commit"}, {"oid": "52335c8448fcad3e091dcde510731c13e59b30c6", "url": "https://github.com/seata/seata/commit/52335c8448fcad3e091dcde510731c13e59b30c6", "message": "Merge branch 'develop' into f_tcc", "committedDate": "2020-03-10T08:22:06Z", "type": "commit"}, {"oid": "57e7dfd979b2730809421c4f8ce5a629aead0083", "url": "https://github.com/seata/seata/commit/57e7dfd979b2730809421c4f8ce5a629aead0083", "message": "Merge branch 'develop' into f_tcc", "committedDate": "2020-03-11T12:36:26Z", "type": "commit"}, {"oid": "06e79eaff0997739b87f45d2763e16f064bb2a2e", "url": "https://github.com/seata/seata/commit/06e79eaff0997739b87f45d2763e16f064bb2a2e", "message": "use StringUtils", "committedDate": "2020-03-12T05:41:42Z", "type": "commit"}, {"oid": "d0b3128655aecb41e6e87eac55c593647ef43481", "url": "https://github.com/seata/seata/commit/d0b3128655aecb41e6e87eac55c593647ef43481", "message": "Merge remote-tracking branch 'upstream/develop' into f_tcc", "committedDate": "2020-03-17T07:53:56Z", "type": "commit"}, {"oid": "e721fb1be5eb6db499a77cf1cc27530cd34e407f", "url": "https://github.com/seata/seata/commit/e721fb1be5eb6db499a77cf1cc27530cd34e407f", "message": "optimize: optimize interceptorType to branchType", "committedDate": "2020-03-17T09:53:57Z", "type": "commit"}, {"oid": "f6a1cb6f2b0ec42d8566c2148f93ca81714401e2", "url": "https://github.com/seata/seata/commit/f6a1cb6f2b0ec42d8566c2148f93ca81714401e2", "message": "remove unuse", "committedDate": "2020-03-17T11:57:56Z", "type": "commit"}, {"oid": "03d9a959cdaeacf6cc4e247c64e8f71553ce4fbe", "url": "https://github.com/seata/seata/commit/03d9a959cdaeacf6cc4e247c64e8f71553ce4fbe", "message": "optimize rootcontext", "committedDate": "2020-03-18T01:51:24Z", "type": "commit"}, {"oid": "a3837de8313b336e39189cfc47cb806f472ea4b6", "url": "https://github.com/seata/seata/commit/a3837de8313b336e39189cfc47cb806f472ea4b6", "message": "optimize branchType to tccScope", "committedDate": "2020-03-19T03:01:30Z", "type": "commit"}, {"oid": "6030169137643d51fbe264784882dbe026316fae", "url": "https://github.com/seata/seata/commit/6030169137643d51fbe264784882dbe026316fae", "message": "Merge remote-tracking branch 'upstream/develop' into f_tcc", "committedDate": "2020-03-19T03:01:51Z", "type": "commit"}, {"oid": "fd12c625ec82475ebe79d4600fac18aacf7a1a62", "url": "https://github.com/seata/seata/commit/fd12c625ec82475ebe79d4600fac18aacf7a1a62", "message": "optimize branchType and tccScope", "committedDate": "2020-03-19T04:38:01Z", "type": "commit"}, {"oid": "c50587fa89828164fa6b974694797f4cfb978465", "url": "https://github.com/seata/seata/commit/c50587fa89828164fa6b974694797f4cfb978465", "message": "format some incorrect code", "committedDate": "2020-03-19T05:44:01Z", "type": "commit"}, {"oid": "97510c0f233fb92b3fdb893a8eacc6c8f133866d", "url": "https://github.com/seata/seata/commit/97510c0f233fb92b3fdb893a8eacc6c8f133866d", "message": "format code style", "committedDate": "2020-03-19T05:53:06Z", "type": "commit"}, {"oid": "657c45ebd240b2f113666d740e87f229005bc1a2", "url": "https://github.com/seata/seata/commit/657c45ebd240b2f113666d740e87f229005bc1a2", "message": "format code style", "committedDate": "2020-03-19T06:39:20Z", "type": "commit"}, {"oid": "3d9a0324dad02dc889eec55f1c2f244d1410f978", "url": "https://github.com/seata/seata/commit/3d9a0324dad02dc889eec55f1c2f244d1410f978", "message": "Merge branch 'develop' into f_tcc", "committedDate": "2020-03-19T10:15:51Z", "type": "commit"}, {"oid": "5afdfc240e6c4c25c24a912d0c0573af89eed6c0", "url": "https://github.com/seata/seata/commit/5afdfc240e6c4c25c24a912d0c0573af89eed6c0", "message": "Merge branch 'develop' into f_tcc", "committedDate": "2020-03-23T04:29:52Z", "type": "commit"}, {"oid": "d5dd5cde56612a08455118395a2a0fa6d227e774", "url": "https://github.com/seata/seata/commit/d5dd5cde56612a08455118395a2a0fa6d227e774", "message": "Merge remote-tracking branch 'upstream/develop' into f_tcc", "committedDate": "2020-03-25T00:46:01Z", "type": "commit"}, {"oid": "3a0613b9a71a1457d4b9e6e4a521b2ba3c83f9dd", "url": "https://github.com/seata/seata/commit/3a0613b9a71a1457d4b9e6e4a521b2ba3c83f9dd", "message": "merge latest code", "committedDate": "2020-03-25T09:36:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk1OTkyOQ==", "url": "https://github.com/seata/seata/pull/2415#discussion_r411959929", "bodyText": "Add BranchType.SAGA. Bind Saga type will commit at another pr : #2551", "author": "long187", "createdAt": "2020-04-21T07:57:40Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/ExecuteTemplate.java", "diffHunk": "@@ -108,4 +110,17 @@\n         }\n         return rs;\n     }\n+\n+    private static boolean requiresUndoFunction() {\n+\n+        if (!RootContext.inGlobalTransaction() && !RootContext.requireGlobalLock()) {\n+            return false;\n+        }\n+\n+        if (RootContext.inGlobalTransaction() && StringUtils.equals(BranchType.TCC.name(), RootContext.getBranchType())) {", "originalCommit": "3a0613b9a71a1457d4b9e6e4a521b2ba3c83f9dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk5MTg0NQ==", "url": "https://github.com/seata/seata/pull/2415#discussion_r411991845", "bodyText": "OK,thank you for notification, branchType SAGA was now added in my judgement conditions.", "author": "booogu", "createdAt": "2020-04-21T08:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk1OTkyOQ=="}], "type": "inlineReview"}, {"oid": "4785c8693fe209b820009da41f40b45707420a71", "url": "https://github.com/seata/seata/commit/4785c8693fe209b820009da41f40b45707420a71", "message": "add SAGA in requireUndoFunction judgement conditions in", "committedDate": "2020-04-21T08:38:16Z", "type": "commit"}, {"oid": "640477daf7b3f343ac0e245c2c593af69a309935", "url": "https://github.com/seata/seata/commit/640477daf7b3f343ac0e245c2c593af69a309935", "message": "Merge branch 'develop' into f_tcc", "committedDate": "2020-04-21T14:47:39Z", "type": "commit"}, {"oid": "bd8b7ebe0ccf628dd4033ff9a9cea9d5971fa0d4", "url": "https://github.com/seata/seata/commit/bd8b7ebe0ccf628dd4033ff9a9cea9d5971fa0d4", "message": "fix style", "committedDate": "2020-04-21T15:01:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5MTY3Mw==", "url": "https://github.com/seata/seata/pull/2415#discussion_r412291673", "bodyText": "?\nNot the same as ApacheDubboTransactionPropagationFilter.java", "author": "zjinlei", "createdAt": "2020-04-21T15:40:10Z", "path": "integration/dubbo-alibaba/src/main/java/io/seata/integration/dubbo/alibaba/AlibabaDubboTransactionPropagationFilter.java", "diffHunk": "@@ -43,45 +45,49 @@ public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcExcept\n             return invoker.invoke(invocation);\n         }\n         String xid = RootContext.getXID();\n-        String xidInterceptorType = RootContext.getXIDInterceptorType();\n+        String branchType = RootContext.getBranchType();\n \n         String rpcXid = getRpcXid();\n-        String rpcXidInterceptorType = RpcContext.getContext().getAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE);\n+        String rpcInTCCScope = RpcContext.getContext().getAttachment(RootContext.KEY_BRANCH_TYPE);\n         if (LOGGER.isDebugEnabled()) {\n             LOGGER.debug(\"xid in RootContext[{}] xid in RpcContext[{}]\", xid, rpcXid);\n         }\n         boolean bind = false;\n         if (xid != null) {\n             RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);\n-            RpcContext.getContext().setAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE, xidInterceptorType);\n+            RpcContext.getContext().setAttachment(RootContext.KEY_BRANCH_TYPE, branchType);\n         } else {\n             if (rpcXid != null) {\n                 RootContext.bind(rpcXid);\n-                RootContext.bindInterceptorType(rpcXidInterceptorType);\n+                if (StringUtils.equals(rpcInTCCScope, String.valueOf(true))) {", "originalCommit": "bd8b7ebe0ccf628dd4033ff9a9cea9d5971fa0d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyMTM3MQ==", "url": "https://github.com/seata/seata/pull/2415#discussion_r412621371", "bodyText": "Sorry,my fault, the code in apacheDubbo was right , i will make them same.", "author": "booogu", "createdAt": "2020-04-22T02:24:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5MTY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5MzE4MQ==", "url": "https://github.com/seata/seata/pull/2415#discussion_r412293181", "bodyText": "Log output branchType", "author": "zjinlei", "createdAt": "2020-04-21T15:45:48Z", "path": "integration/dubbo/src/main/java/io/seata/integration/dubbo/ApacheDubboTransactionPropagationFilter.java", "diffHunk": "@@ -40,42 +42,49 @@\n     @Override\n     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {\n         String xid = RootContext.getXID();\n-        String xidInterceptorType = RootContext.getXIDInterceptorType();\n+        String branchType = RootContext.getBranchType();\n \n         String rpcXid = getRpcXid();\n-        String rpcXidInterceptorType = RpcContext.getContext().getAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE);\n+        String rpcBranchType = RpcContext.getContext().getAttachment(RootContext.KEY_BRANCH_TYPE);\n         if (LOGGER.isDebugEnabled()) {\n             LOGGER.debug(\"xid in RootContext[{}] xid in RpcContext[{}]\", xid, rpcXid);\n         }\n         boolean bind = false;\n         if (xid != null) {\n             RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);\n-            RpcContext.getContext().setAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE, xidInterceptorType);\n+            RpcContext.getContext().setAttachment(RootContext.KEY_BRANCH_TYPE, branchType);\n         } else {\n             if (rpcXid != null) {\n                 RootContext.bind(rpcXid);\n-                RootContext.bindInterceptorType(rpcXidInterceptorType);\n+                if (StringUtils.equals(BranchType.TCC.name(), rpcBranchType)) {\n+                    RootContext.bindBranchType(BranchType.TCC);\n+                }\n                 bind = true;\n                 if (LOGGER.isDebugEnabled()) {\n-                    LOGGER.debug(\"bind[{}] interceptorType[{}] to RootContext\", rpcXid, rpcXidInterceptorType);\n+                    LOGGER.debug(\"bind[{}] to RootContext\", rpcXid);", "originalCommit": "bd8b7ebe0ccf628dd4033ff9a9cea9d5971fa0d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyMDk1OQ==", "url": "https://github.com/seata/seata/pull/2415#discussion_r412620959", "bodyText": "OK,done.", "author": "booogu", "createdAt": "2020-04-22T02:23:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5MzE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY4MTU3Mg==", "url": "https://github.com/seata/seata/pull/2415#discussion_r412681572", "bodyText": "Combine xid and branchType output without judgment \"if (StringUtils.equals(BranchType.TCC.name()...\"", "author": "zjinlei", "createdAt": "2020-04-22T05:31:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5MzE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU2MTU3Mg==", "url": "https://github.com/seata/seata/pull/2415#discussion_r414561572", "bodyText": "Combine xid and branchType output without judgment \"if (StringUtils.equals(BranchType.TCC.name()...\"\n\nOK, done", "author": "booogu", "createdAt": "2020-04-24T13:07:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI5MzE4MQ=="}], "type": "inlineReview"}, {"oid": "9979b005b423a04db6c5c33e67fa37e8f310b744", "url": "https://github.com/seata/seata/commit/9979b005b423a04db6c5c33e67fa37e8f310b744", "message": "format code and keep code same in integration module", "committedDate": "2020-04-22T02:22:19Z", "type": "commit"}, {"oid": "95ddbe280d1ac8f9c05bd78e3f14707780450862", "url": "https://github.com/seata/seata/commit/95ddbe280d1ac8f9c05bd78e3f14707780450862", "message": "Merge branch 'f_tcc' of https://github.com/CharmingRabbit/seata into f_tcc", "committedDate": "2020-04-22T02:24:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY4MTgwMA==", "url": "https://github.com/seata/seata/pull/2415#discussion_r412681800", "bodyText": "@GlobalLock does not have undo, this function name should be optimized", "author": "zjinlei", "createdAt": "2020-04-22T05:32:37Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/ExecuteTemplate.java", "diffHunk": "@@ -66,7 +68,7 @@\n                                                      StatementCallback<T, S> statementCallback,\n                                                      Object... args) throws SQLException {\n \n-        if (!RootContext.inGlobalTransaction() && !RootContext.requireGlobalLock()) {\n+        if (!requiresUndoFunction()) {", "originalCommit": "95ddbe280d1ac8f9c05bd78e3f14707780450862", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU2ODU2Ng==", "url": "https://github.com/seata/seata/pull/2415#discussion_r413568566", "bodyText": "Saga branch never set ?", "author": "wangliang181230", "createdAt": "2020-04-23T07:14:47Z", "path": "integration/dubbo-alibaba/src/main/java/io/seata/integration/dubbo/alibaba/AlibabaDubboTransactionPropagationFilter.java", "diffHunk": "@@ -43,45 +45,56 @@ public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcExcept\n             return invoker.invoke(invocation);\n         }\n         String xid = RootContext.getXID();\n-        String xidInterceptorType = RootContext.getXIDInterceptorType();\n+        String branchType = RootContext.getBranchType();\n \n         String rpcXid = getRpcXid();\n-        String rpcXidInterceptorType = RpcContext.getContext().getAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE);\n+        String rpcBranchType = RpcContext.getContext().getAttachment(RootContext.KEY_BRANCH_TYPE);\n         if (LOGGER.isDebugEnabled()) {\n             LOGGER.debug(\"xid in RootContext[{}] xid in RpcContext[{}]\", xid, rpcXid);\n         }\n         boolean bind = false;\n         if (xid != null) {\n             RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);\n-            RpcContext.getContext().setAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE, xidInterceptorType);\n+            RpcContext.getContext().setAttachment(RootContext.KEY_BRANCH_TYPE, branchType);\n         } else {\n             if (rpcXid != null) {\n                 RootContext.bind(rpcXid);\n-                RootContext.bindInterceptorType(rpcXidInterceptorType);\n+                if (StringUtils.equals(BranchType.TCC.name(), rpcBranchType)) {\n+                    RootContext.bindBranchType(BranchType.TCC);", "originalCommit": "95ddbe280d1ac8f9c05bd78e3f14707780450862", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY0MzU2MQ==", "url": "https://github.com/seata/seata/pull/2415#discussion_r413643561", "bodyText": "I have discussed with the author of saga. This pr is only responsible for the branchType judgment logic in ExecuteTemplate and the TCC branchType passing in Filter. The specific Saga branchtype assignment and other logic will be provided by the feature saga related pr", "author": "booogu", "createdAt": "2020-04-23T09:04:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU2ODU2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc5MjY5OA==", "url": "https://github.com/seata/seata/pull/2415#discussion_r413792698", "bodyText": "this #2551, autor is wangliang1986", "author": "long187", "createdAt": "2020-04-23T12:56:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU2ODU2Ng=="}], "type": "inlineReview"}, {"oid": "7666bc1f420b2d0db84a053b98c6f3167c4eb946", "url": "https://github.com/seata/seata/commit/7666bc1f420b2d0db84a053b98c6f3167c4eb946", "message": "Merge branch 'develop' into f_tcc", "committedDate": "2020-04-24T13:14:31Z", "type": "commit"}, {"oid": "127b3e8622f098dd9a80242ff264050f5d4ff3b2", "url": "https://github.com/seata/seata/commit/127b3e8622f098dd9a80242ff264050f5d4ff3b2", "message": "optimize log output and func name", "committedDate": "2020-04-24T13:36:12Z", "type": "commit"}, {"oid": "d7d249b62e88bedb73980dd0affc594d24a3a46d", "url": "https://github.com/seata/seata/commit/d7d249b62e88bedb73980dd0affc594d24a3a46d", "message": "Merge branch 'f_tcc' of https://github.com/CharmingRabbit/seata into f_tcc", "committedDate": "2020-04-24T13:36:39Z", "type": "commit"}, {"oid": "69f29b73cd3d6588e328120ce11b4c5d3198c3f9", "url": "https://github.com/seata/seata/commit/69f29b73cd3d6588e328120ce11b4c5d3198c3f9", "message": "restore", "committedDate": "2020-04-24T15:56:24Z", "type": "commit"}, {"oid": "7e86dd32c43b972293c0a6826b4caa9d9bfbfc92", "url": "https://github.com/seata/seata/commit/7e86dd32c43b972293c0a6826b4caa9d9bfbfc92", "message": "Merge branch 'develop' into f_tcc", "committedDate": "2020-04-26T06:37:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI3NDMzMQ==", "url": "https://github.com/seata/seata/pull/2415#discussion_r415274331", "bodyText": "Is it better to separate and judge?", "author": "slievrly", "createdAt": "2020-04-26T10:19:15Z", "path": "integration/dubbo-alibaba/src/main/java/io/seata/integration/dubbo/alibaba/AlibabaDubboTransactionPropagationFilter.java", "diffHunk": "@@ -43,45 +45,51 @@ public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcExcept\n             return invoker.invoke(invocation);\n         }\n         String xid = RootContext.getXID();\n-        String xidInterceptorType = RootContext.getXIDInterceptorType();\n+        String branchType = RootContext.getBranchType();\n \n         String rpcXid = getRpcXid();\n-        String rpcXidInterceptorType = RpcContext.getContext().getAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE);\n+        String rpcBranchType = RpcContext.getContext().getAttachment(RootContext.KEY_BRANCH_TYPE);\n         if (LOGGER.isDebugEnabled()) {\n             LOGGER.debug(\"xid in RootContext[{}] xid in RpcContext[{}]\", xid, rpcXid);\n         }\n         boolean bind = false;\n         if (xid != null) {\n             RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);\n-            RpcContext.getContext().setAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE, xidInterceptorType);\n+            RpcContext.getContext().setAttachment(RootContext.KEY_BRANCH_TYPE, branchType);", "originalCommit": "7e86dd32c43b972293c0a6826b4caa9d9bfbfc92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI4NDA0Nw==", "url": "https://github.com/seata/seata/pull/2415#discussion_r415284047", "bodyText": "It will not be processed this time, and transaction context object encapsulation will be provided later to handle log output uniformly.", "author": "booogu", "createdAt": "2020-04-26T11:11:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI3NDMzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI3NDYzNw==", "url": "https://github.com/seata/seata/pull/2415#discussion_r415274637", "bodyText": "BranchType print null in AT mode is not very elegant.", "author": "slievrly", "createdAt": "2020-04-26T10:20:56Z", "path": "integration/dubbo-alibaba/src/main/java/io/seata/integration/dubbo/alibaba/AlibabaDubboTransactionPropagationFilter.java", "diffHunk": "@@ -43,45 +45,51 @@ public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcExcept\n             return invoker.invoke(invocation);\n         }\n         String xid = RootContext.getXID();\n-        String xidInterceptorType = RootContext.getXIDInterceptorType();\n+        String branchType = RootContext.getBranchType();\n \n         String rpcXid = getRpcXid();\n-        String rpcXidInterceptorType = RpcContext.getContext().getAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE);\n+        String rpcBranchType = RpcContext.getContext().getAttachment(RootContext.KEY_BRANCH_TYPE);\n         if (LOGGER.isDebugEnabled()) {\n             LOGGER.debug(\"xid in RootContext[{}] xid in RpcContext[{}]\", xid, rpcXid);\n         }\n         boolean bind = false;\n         if (xid != null) {\n             RpcContext.getContext().setAttachment(RootContext.KEY_XID, xid);\n-            RpcContext.getContext().setAttachment(RootContext.KEY_XID_INTERCEPTOR_TYPE, xidInterceptorType);\n+            RpcContext.getContext().setAttachment(RootContext.KEY_BRANCH_TYPE, branchType);\n         } else {\n             if (rpcXid != null) {\n                 RootContext.bind(rpcXid);\n-                RootContext.bindInterceptorType(rpcXidInterceptorType);\n+                if (StringUtils.equals(BranchType.TCC.name(), rpcBranchType)) {\n+                    RootContext.bindBranchType(BranchType.TCC);\n+                }\n                 bind = true;\n                 if (LOGGER.isDebugEnabled()) {\n-                    LOGGER.debug(\"bind[{}] interceptorType[{}] to RootContext\", rpcXid, rpcXidInterceptorType);\n+                    LOGGER.debug(\"bind xid [{}] branchType [{}] to RootContext\", rpcXid, rpcBranchType);\n                 }\n             }\n         }\n         try {\n             return invoker.invoke(invocation);\n-\n         } finally {\n             if (bind) {\n-                String unbindInterceptorType = RootContext.unbindInterceptorType();\n                 String unbindXid = RootContext.unbind();\n+                String previousBranchType = RootContext.getBranchType();\n+                if (StringUtils.equals(BranchType.TCC.name(), previousBranchType)) {\n+                    RootContext.unbindBranchType();\n+                }\n                 if (LOGGER.isDebugEnabled()) {\n-                    LOGGER.debug(\"unbind[{}] interceptorType[{}] from RootContext\", unbindXid, unbindInterceptorType);\n+                    LOGGER.debug(\"unbind xid [{}] branchType [{}] from RootContext\", unbindXid, previousBranchType);", "originalCommit": "7e86dd32c43b972293c0a6826b4caa9d9bfbfc92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI4NDQzMg==", "url": "https://github.com/seata/seata/pull/2415#discussion_r415284432", "bodyText": "How about judge in the log output temporarily,and print \"AT\" if it is null", "author": "booogu", "createdAt": "2020-04-26T11:12:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI3NDYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI3NDg3OQ==", "url": "https://github.com/seata/seata/pull/2415#discussion_r415274879", "bodyText": "Other more meaningful method name?", "author": "slievrly", "createdAt": "2020-04-26T10:21:53Z", "path": "rm-datasource/src/main/java/io/seata/rm/datasource/exec/ExecuteTemplate.java", "diffHunk": "@@ -115,4 +117,17 @@\n         }\n         return rs;\n     }\n+\n+    private static boolean requiresLockOrUndoFunction() {", "originalCommit": "7e86dd32c43b972293c0a6826b4caa9d9bfbfc92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI4NDU0MQ==", "url": "https://github.com/seata/seata/pull/2415#discussion_r415284541", "bodyText": "Change it to \"shouldExecuteInATMode\"", "author": "booogu", "createdAt": "2020-04-26T11:13:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI3NDg3OQ=="}], "type": "inlineReview"}, {"oid": "f5c438ef9a0a86081d1af695542232c4f5b0eef4", "url": "https://github.com/seata/seata/commit/f5c438ef9a0a86081d1af695542232c4f5b0eef4", "message": "optimize func name and log output", "committedDate": "2020-04-26T11:07:08Z", "type": "commit"}, {"oid": "7d41df6973fcac9c38b7e3e50022f091ef425b05", "url": "https://github.com/seata/seata/commit/7d41df6973fcac9c38b7e3e50022f091ef425b05", "message": "Merge branch 'f_tcc' of https://github.com/CharmingRabbit/seata into f_tcc", "committedDate": "2020-04-26T11:11:17Z", "type": "commit"}, {"oid": "970e86f4449508095fe86bdcbcc159e7719ff07d", "url": "https://github.com/seata/seata/commit/970e86f4449508095fe86bdcbcc159e7719ff07d", "message": "remove travis -p param", "committedDate": "2020-04-27T00:51:02Z", "type": "commit"}]}