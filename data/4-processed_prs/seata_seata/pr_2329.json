{"pr_number": 2329, "pr_title": "refactor : separate the different storage pattern processing logic", "pr_createdAt": "2020-03-02T08:52:47Z", "pr_url": "https://github.com/seata/seata/pull/2329", "timeline": [{"oid": "36f1aeb3828e2882c04cd7f358095053addd33bf", "url": "https://github.com/seata/seata/commit/36f1aeb3828e2882c04cd7f358095053addd33bf", "message": "separate the different storage pattern processing logic", "committedDate": "2020-03-02T08:50:29Z", "type": "commit"}, {"oid": "8032c57177e770705aca7c22680bc1bd38ee41d1", "url": "https://github.com/seata/seata/commit/8032c57177e770705aca7c22680bc1bd38ee41d1", "message": "Merge branch 'develop' into separate_store_mode", "committedDate": "2020-03-05T01:11:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM2NzYwNQ==", "url": "https://github.com/seata/seata/pull/2329#discussion_r389367605", "bodyText": "Uppercase static constants.", "author": "objcoding", "createdAt": "2020-03-08T13:04:45Z", "path": "server/src/main/java/io/seata/server/lock/LockerManagerFactory.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.server.lock;\n+\n+import io.seata.common.loader.EnhancedServiceLoader;\n+import io.seata.config.ConfigurationFactory;\n+import io.seata.core.constants.ConfigurationKeys;\n+\n+/**\n+ * The type Lock manager factory.\n+ *\n+ * @author sharajava\n+ */\n+public class LockerManagerFactory {\n+\n+    /**\n+     * the lock manager\n+     */\n+    private static LockManager lockManager = EnhancedServiceLoader.load(LockManager.class,", "originalCommit": "8032c57177e770705aca7c22680bc1bd38ee41d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ2MTY5MQ==", "url": "https://github.com/seata/seata/pull/2329#discussion_r389461691", "bodyText": "done", "author": "ph3636", "createdAt": "2020-03-09T04:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM2NzYwNQ=="}], "type": "inlineReview"}, {"oid": "65625df69c1d14ca1e569ed2f2f6f8175a46349a", "url": "https://github.com/seata/seata/commit/65625df69c1d14ca1e569ed2f2f6f8175a46349a", "message": "merge develop", "committedDate": "2020-03-09T04:25:49Z", "type": "commit"}, {"oid": "f1fd6b4df14e97cccb591b44e1de816f2b6786fe", "url": "https://github.com/seata/seata/commit/f1fd6b4df14e97cccb591b44e1de816f2b6786fe", "message": "Uppercase static constants.", "committedDate": "2020-03-09T04:26:09Z", "type": "commit"}, {"oid": "0d4142dda913c2b586949d8a015a8226d15aa9a2", "url": "https://github.com/seata/seata/commit/0d4142dda913c2b586949d8a015a8226d15aa9a2", "message": "Merge branch 'develop' into separate_store_mode", "committedDate": "2020-03-15T16:12:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk3NjAwNA==", "url": "https://github.com/seata/seata/pull/2329#discussion_r394976004", "bodyText": "already ensure  SessionHolder.findGlobalSession(xid, false) are not in the case.", "author": "slievrly", "createdAt": "2020-03-19T12:03:05Z", "path": "server/src/main/java/io/seata/server/storage/db/lock/DataBaseLockManager.java", "diffHunk": "@@ -44,11 +61,19 @@ public boolean releaseLock(BranchSession branchSession) throws TransactionExcept\n \n     @Override\n     public boolean releaseGlobalSessionLock(GlobalSession globalSession) throws TransactionException {\n-        ArrayList<BranchSession> branchSessions = globalSession.getBranchSessions();\n+        List<BranchSession> branchSessions = globalSession.getBranchSessions();\n         if (CollectionUtils.isEmpty(branchSessions)) {\n             return true;\n         }\n-        List<Long> branchIds = branchSessions.stream().map(BranchSession::getBranchId).collect(Collectors.toList());\n+        List<Long> branchIds = new ArrayList<>(branchSessions.size());\n+        boolean notNeedReleaseLock = true;", "originalCommit": "0d4142dda913c2b586949d8a015a8226d15aa9a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk4NTMyMA==", "url": "https://github.com/seata/seata/pull/2329#discussion_r394985320", "bodyText": "why not abstract method\uff1f", "author": "slievrly", "createdAt": "2020-03-19T12:21:44Z", "path": "server/src/main/java/io/seata/server/lock/AbstractLockManager.java", "diffHunk": "@@ -106,7 +111,7 @@ protected Locker getLocker() {\n      * @return the locker\n      */\n     protected Locker getLocker(BranchSession branchSession) {", "originalCommit": "0d4142dda913c2b586949d8a015a8226d15aa9a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1Mzc1MQ==", "url": "https://github.com/seata/seata/pull/2329#discussion_r395453751", "bodyText": "done", "author": "ph3636", "createdAt": "2020-03-20T06:18:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk4NTMyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA0NzE3Mg==", "url": "https://github.com/seata/seata/pull/2329#discussion_r395047172", "bodyText": "unnecessary attribute", "author": "zjinlei", "createdAt": "2020-03-19T14:01:27Z", "path": "server/src/main/java/io/seata/server/storage/db/lock/DataBaseLockManager.java", "diffHunk": "@@ -44,11 +61,19 @@ public boolean releaseLock(BranchSession branchSession) throws TransactionExcept\n \n     @Override\n     public boolean releaseGlobalSessionLock(GlobalSession globalSession) throws TransactionException {\n-        ArrayList<BranchSession> branchSessions = globalSession.getBranchSessions();\n+        List<BranchSession> branchSessions = globalSession.getBranchSessions();\n         if (CollectionUtils.isEmpty(branchSessions)) {\n             return true;\n         }\n-        List<Long> branchIds = branchSessions.stream().map(BranchSession::getBranchId).collect(Collectors.toList());\n+        List<Long> branchIds = new ArrayList<>(branchSessions.size());\n+        boolean notNeedReleaseLock = true;", "originalCommit": "0d4142dda913c2b586949d8a015a8226d15aa9a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA4ODQyOA==", "url": "https://github.com/seata/seata/pull/2329#discussion_r395088428", "bodyText": "lock_key is always blank id db mode", "author": "zjinlei", "createdAt": "2020-03-19T14:55:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA0NzE3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1Mzc4NA==", "url": "https://github.com/seata/seata/pull/2329#discussion_r395453784", "bodyText": "done", "author": "ph3636", "createdAt": "2020-03-20T06:18:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA0NzE3Mg=="}], "type": "inlineReview"}, {"oid": "1f3311a30895f8ec6ff46542fd76759d981a8466", "url": "https://github.com/seata/seata/commit/1f3311a30895f8ec6ff46542fd76759d981a8466", "message": "Merge branch 'develop' into separate_store_mode", "committedDate": "2020-03-20T05:16:09Z", "type": "commit"}, {"oid": "442fa0c57e44b7ccedeb67c510b376452bb7d381", "url": "https://github.com/seata/seata/commit/442fa0c57e44b7ccedeb67c510b376452bb7d381", "message": "getLocker(BranchSession branchSession) change to abstract method and delete unnecessary attribute,because lock_key is always blank id db mode", "committedDate": "2020-03-20T06:07:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUwNzIxMg==", "url": "https://github.com/seata/seata/pull/2329#discussion_r395507212", "bodyText": "Will be initialized 4 times by SessionHolder, it should be static.", "author": "zjinlei", "createdAt": "2020-03-20T09:02:25Z", "path": "server/src/main/java/io/seata/server/storage/db/session/DataBaseSessionManager.java", "diffHunk": "@@ -79,7 +77,7 @@ public DataBaseSessionManager(String name) {\n \n     @Override\n     public void init() {\n-        transactionStoreManager = EnhancedServiceLoader.load(TransactionStoreManager.class, StoreMode.DB.name());\n+        transactionStoreManager = new DataBaseTransactionStoreManager();", "originalCommit": "442fa0c57e44b7ccedeb67c510b376452bb7d381", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU0MDkzMg==", "url": "https://github.com/seata/seata/pull/2329#discussion_r395540932", "bodyText": "done", "author": "ph3636", "createdAt": "2020-03-20T10:11:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUwNzIxMg=="}], "type": "inlineReview"}, {"oid": "8ff3165be0a74110031b3830070f56c357a3245b", "url": "https://github.com/seata/seata/commit/8ff3165be0a74110031b3830070f56c357a3245b", "message": "Merge branch 'develop' into separate_store_mode", "committedDate": "2020-03-20T09:11:47Z", "type": "commit"}, {"oid": "208324700ea1e92832b9dfb8816800bc16c0b25e", "url": "https://github.com/seata/seata/commit/208324700ea1e92832b9dfb8816800bc16c0b25e", "message": "Change DataBaseTransactionStoreManager to a single instance", "committedDate": "2020-03-20T09:43:39Z", "type": "commit"}, {"oid": "56bb9bedd8ca10676b09f64b4d0a2caed8dc3bfa", "url": "https://github.com/seata/seata/commit/56bb9bedd8ca10676b09f64b4d0a2caed8dc3bfa", "message": "Merge remote-tracking branch 'origin/separate_store_mode' into separate_store_mode", "committedDate": "2020-03-20T09:44:15Z", "type": "commit"}, {"oid": "db324ad8fcfaecfe3ef9d217acb4a5de0c1d7396", "url": "https://github.com/seata/seata/commit/db324ad8fcfaecfe3ef9d217acb4a5de0c1d7396", "message": "Change DataBaseTransactionStoreManager to a single instance", "committedDate": "2020-03-20T09:54:36Z", "type": "commit"}, {"oid": "fac3c965607557a212970b22e5e411ff121f9c7c", "url": "https://github.com/seata/seata/commit/fac3c965607557a212970b22e5e411ff121f9c7c", "message": "Merge branch 'develop' into separate_store_mode", "committedDate": "2020-03-20T10:30:53Z", "type": "commit"}]}