{"pr_number": 2369, "pr_title": "refactor: log store sql with spi", "pr_createdAt": "2020-03-06T09:51:06Z", "pr_url": "https://github.com/seata/seata/pull/2369", "timeline": [{"oid": "04704c42db660b68340c4e5109003e54f252a7c8", "url": "https://github.com/seata/seata/commit/04704c42db660b68340c4e5109003e54f252a7c8", "message": "refactor log store sqls with spi", "committedDate": "2020-03-06T09:28:46Z", "type": "commit"}, {"oid": "e3b31a8409f7e3237c452e4459a1f5d15cee3727", "url": "https://github.com/seata/seata/commit/e3b31a8409f7e3237c452e4459a1f5d15cee3727", "message": "remove db type from method", "committedDate": "2020-03-06T09:44:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzOTQ0OA==", "url": "https://github.com/seata/seata/pull/2369#discussion_r389239448", "bodyText": "Why here inherit mysql?,This will lead to a strong correlation between Oceanbase and Mysql.", "author": "objcoding", "createdAt": "2020-03-07T08:51:48Z", "path": "core/src/main/java/io/seata/core/store/db/sql/OceanbaseLogStoreSqls.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.store.db.sql;\n+\n+import io.seata.common.loader.LoadLevel;\n+\n+/**\n+ * Database log store oceanbase sql\n+ * @author will\n+ */\n+@LoadLevel(name = \"oceanbase\")\n+public class OceanbaseLogStoreSqls extends MysqlLogStoreSqls {", "originalCommit": "e3b31a8409f7e3237c452e4459a1f5d15cee3727", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1NTMzOQ==", "url": "https://github.com/seata/seata/pull/2369#discussion_r389255339", "bodyText": "Because I think oceanbase was compatible with mysql", "author": "l81893521", "createdAt": "2020-03-07T13:39:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzOTQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM3NTczMQ==", "url": "https://github.com/seata/seata/pull/2369#discussion_r389375731", "bodyText": "Because I think oceanbase was compatible with mysql\n\nis ok.", "author": "objcoding", "createdAt": "2020-03-08T14:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzOTQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5NjMwNw==", "url": "https://github.com/seata/seata/pull/2369#discussion_r403696307", "bodyText": "Tidb as same as mysql too, please add.", "author": "zjinlei", "createdAt": "2020-04-05T12:38:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzOTQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM2NjYyOA==", "url": "https://github.com/seata/seata/pull/2369#discussion_r389366628", "bodyText": "Should not support multiple database, Can be changed to a single.", "author": "objcoding", "createdAt": "2020-03-08T12:52:58Z", "path": "core/src/main/java/io/seata/core/store/db/sql/LogStoreSqlsFactory.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.store.db.sql;\n+\n+import io.seata.common.loader.EnhancedServiceLoader;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * @author will\n+ */\n+public class LogStoreSqlsFactory {\n+\n+    private static Map<String, LogStoreSqls> LOG_STORE_SQLS_MAP = new ConcurrentHashMap<>();", "originalCommit": "e3b31a8409f7e3237c452e4459a1f5d15cee3727", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "084e1e2df68e233a86e7a20416e450f3a0667332", "url": "https://github.com/seata/seata/commit/084e1e2df68e233a86e7a20416e450f3a0667332", "message": "Merge remote-tracking branch 'origin/develop' into refactor_log_store_sql_with_spi", "committedDate": "2020-03-12T01:12:16Z", "type": "commit"}, {"oid": "dc7f9f9c8f70a3cb689535134d37b2bb62b597f9", "url": "https://github.com/seata/seata/commit/dc7f9f9c8f70a3cb689535134d37b2bb62b597f9", "message": "add log directory", "committedDate": "2020-03-12T01:22:44Z", "type": "commit"}, {"oid": "0ec68d51783434568d08a2cbfbe39bddefc3570c", "url": "https://github.com/seata/seata/commit/0ec68d51783434568d08a2cbfbe39bddefc3570c", "message": "add unit test", "committedDate": "2020-03-12T01:43:28Z", "type": "commit"}, {"oid": "561a9c15d97c3c14acb9a0dd7dab9b9d1ed36eb6", "url": "https://github.com/seata/seata/commit/561a9c15d97c3c14acb9a0dd7dab9b9d1ed36eb6", "message": "Merge branch 'develop' into refactor_log_store_sql_with_spi", "committedDate": "2020-03-16T06:05:36Z", "type": "commit"}, {"oid": "d9c607a9bcc3119eb0875671c625315791f3d214", "url": "https://github.com/seata/seata/commit/d9c607a9bcc3119eb0875671c625315791f3d214", "message": "Merge remote-tracking branch 'origin/develop' into refactor_log_store_sql_with_spi\n\n# Conflicts:\n#\tserver/src/main/java/io/seata/server/storage/db/store/LogStoreSqls.java\n#\tserver/src/test/java/io/seata/server/lock/db/sql/log/LogStoreSqlsFactoryTest.java", "committedDate": "2020-03-21T01:39:55Z", "type": "commit"}, {"oid": "32cc3e7e3efbc2d646647bc6b57f3e8a32bb2351", "url": "https://github.com/seata/seata/commit/32cc3e7e3efbc2d646647bc6b57f3e8a32bb2351", "message": "fix code conflict", "committedDate": "2020-03-21T01:52:08Z", "type": "commit"}, {"oid": "0cca4133c0b4b13e1f7c3116545b91992b6a33da", "url": "https://github.com/seata/seata/commit/0cca4133c0b4b13e1f7c3116545b91992b6a33da", "message": "Merge remote-tracking branch 'me/refactor_log_store_sql_with_spi' into refactor_log_store_sql_with_spi", "committedDate": "2020-03-21T01:52:44Z", "type": "commit"}, {"oid": "0077d4982c7e5be612ee501e66e58371af3db870", "url": "https://github.com/seata/seata/commit/0077d4982c7e5be612ee501e66e58371af3db870", "message": "Merge branch 'develop' into refactor_log_store_sql_with_spi", "committedDate": "2020-03-27T03:42:23Z", "type": "commit"}, {"oid": "a93666d040de2f7b67a0ed8430b8ea08d72cb556", "url": "https://github.com/seata/seata/commit/a93666d040de2f7b67a0ed8430b8ea08d72cb556", "message": "Merge branch 'develop' into refactor_log_store_sql_with_spi", "committedDate": "2020-03-31T08:51:52Z", "type": "commit"}, {"oid": "5984f32336094de66701d30e0799134f9f73cad9", "url": "https://github.com/seata/seata/commit/5984f32336094de66701d30e0799134f9f73cad9", "message": "Merge branch 'develop' into refactor_log_store_sql_with_spi", "committedDate": "2020-04-03T01:06:54Z", "type": "commit"}, {"oid": "3a82b178bea5e0bc22bb2c7cd976a18cdf4f7120", "url": "https://github.com/seata/seata/commit/3a82b178bea5e0bc22bb2c7cd976a18cdf4f7120", "message": "Merge branch 'develop' into refactor_log_store_sql_with_spi", "committedDate": "2020-04-05T12:37:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5NzM1NQ==", "url": "https://github.com/seata/seata/pull/2369#discussion_r403697355", "bodyText": "#2135 has merged,  LogStoreSqlsFactory can be deleted.", "author": "zjinlei", "createdAt": "2020-04-05T12:48:04Z", "path": "core/src/main/java/io/seata/core/store/db/sql/log/LogStoreSqlsFactory.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.store.db.sql.log;\n+\n+import io.seata.common.loader.EnhancedServiceLoader;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+/**\n+ * @author will\n+ */\n+public class LogStoreSqlsFactory {", "originalCommit": "3a82b178bea5e0bc22bb2c7cd976a18cdf4f7120", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5ODc4Nw==", "url": "https://github.com/seata/seata/pull/2369#discussion_r403698787", "bodyText": "Suggest:\nreturn getInsertGlobalTransactionSQL().replace(GLOBAL_TABLE_PLACEHOLD, globalTable);\nabstract String getInsertGlobalTransactionSQL();\nSame for other sql", "author": "zjinlei", "createdAt": "2020-04-05T13:00:03Z", "path": "core/src/main/java/io/seata/core/store/db/sql/log/AbstractLogStoreSqls.java", "diffHunk": "@@ -0,0 +1,208 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.core.store.db.sql.log;\n+\n+import io.seata.common.exception.NotSupportYetException;\n+import io.seata.config.Configuration;\n+import io.seata.config.ConfigurationFactory;\n+import io.seata.core.constants.ConfigurationKeys;\n+import io.seata.core.constants.ServerTableColumnsName;\n+\n+\n+/**\n+ * The type Abstract log store sqls\n+ * @author will\n+ */\n+public abstract class AbstractLogStoreSqls implements LogStoreSqls {\n+\n+    /**\n+     * The constant CONFIG.\n+     */\n+    protected static final Configuration CONFIG = ConfigurationFactory.getInstance();\n+\n+    /**\n+     * The constant GLOBAL_TABLE_PLACEHOLD.\n+     */\n+    public static final String GLOBAL_TABLE_PLACEHOLD = \" #global_table# \";\n+\n+    /**\n+     * The constant BRANCH_TABLE_PLACEHOLD.\n+     */\n+    public static final String BRANCH_TABLE_PLACEHOLD = \" #branch_table# \";\n+\n+    /**\n+     * The constant PRAMETER_PLACEHOLD.\n+     */\n+    public static final String PRAMETER_PLACEHOLD = \" #PRAMETER_PLACEHOLD# \";\n+\n+    /**\n+     * The constant ALL_GLOBAL_COLUMNS.\n+     * xid, transaction_id, status, application_id, transaction_service_group, transaction_name, timeout, begin_time, application_data, gmt_create, gmt_modified\n+     */\n+    public static final String ALL_GLOBAL_COLUMNS\n+            = ServerTableColumnsName.GLOBAL_TABLE_XID + \", \" + ServerTableColumnsName.GLOBAL_TABLE_TRANSACTION_ID + \", \"\n+            + ServerTableColumnsName.GLOBAL_TABLE_STATUS + \", \" + ServerTableColumnsName.GLOBAL_TABLE_APPLICATION_ID + \", \"\n+            + ServerTableColumnsName.GLOBAL_TABLE_TRANSACTION_SERVICE_GROUP + \", \" + ServerTableColumnsName.GLOBAL_TABLE_TRANSACTION_NAME + \", \"\n+            + ServerTableColumnsName.GLOBAL_TABLE_TIMEOUT + \", \" + ServerTableColumnsName.GLOBAL_TABLE_BEGIN_TIME + \", \"\n+            + ServerTableColumnsName.GLOBAL_TABLE_APPLICATION_DATA + \", \" + ServerTableColumnsName.GLOBAL_TABLE_GMT_CREATE + \", \"\n+            + ServerTableColumnsName.GLOBAL_TABLE_GMT_MODIFIED;\n+\n+    /**\n+     * The constant ALL_BRANCH_COLUMNS.\n+     * xid, transaction_id, branch_id, resource_group_id, resource_id, lock_key, branch_type, status, client_id, application_data, gmt_create, gmt_modified\n+     */\n+    protected static final String ALL_BRANCH_COLUMNS\n+            = ServerTableColumnsName.BRANCH_TABLE_XID + \", \" + ServerTableColumnsName.BRANCH_TABLE_TRANSACTION_ID + \", \"\n+            + ServerTableColumnsName.BRANCH_TABLE_BRANCH_ID + \", \" + ServerTableColumnsName.BRANCH_TABLE_RESOURCE_GROUP_ID + \", \"\n+            + ServerTableColumnsName.BRANCH_TABLE_RESOURCE_ID + \", \"\n+            + ServerTableColumnsName.BRANCH_TABLE_BRANCH_TYPE + \", \" + ServerTableColumnsName.BRANCH_TABLE_STATUS + \", \"\n+            + ServerTableColumnsName.BRANCH_TABLE_CLIENT_ID + \", \" + ServerTableColumnsName.BRANCH_TABLE_APPLICATION_DATA + \", \"\n+            + ServerTableColumnsName.BRANCH_TABLE_GMT_CREATE + \", \" + ServerTableColumnsName.BRANCH_TABLE_GMT_MODIFIED;\n+\n+    /**\n+     * The constant DELETE_GLOBAL_TRANSACTION.\n+     */\n+    public static final String DELETE_GLOBAL_TRANSACTION = \"delete from \" + GLOBAL_TABLE_PLACEHOLD + \" where \" + ServerTableColumnsName.GLOBAL_TABLE_XID + \" = ?\";\n+\n+    /**\n+     * The constant QUERY_GLOBAL_TRANSACTION.\n+     */\n+    public static final String QUERY_GLOBAL_TRANSACTION = \"select \" + ALL_GLOBAL_COLUMNS + \" from \"\n+            + GLOBAL_TABLE_PLACEHOLD + \" where \" + ServerTableColumnsName.GLOBAL_TABLE_XID + \" = ?\";\n+\n+    /**\n+     * The constant QUERY_GLOBAL_TRANSACTION_ID.\n+     */\n+    public static final String QUERY_GLOBAL_TRANSACTION_BY_ID = \"select \" + ALL_GLOBAL_COLUMNS + \" from \"\n+            + GLOBAL_TABLE_PLACEHOLD + \" where \" + ServerTableColumnsName.GLOBAL_TABLE_TRANSACTION_ID + \" = ?\";\n+\n+    /**\n+     * The constant DELETE_BRANCH_TRANSACTION_BY_BRANCH_ID.\n+     */\n+    public static final String DELETE_BRANCH_TRANSACTION_BY_BRANCH_ID = \"delete from \" + BRANCH_TABLE_PLACEHOLD\n+            + \" where \" + ServerTableColumnsName.BRANCH_TABLE_XID + \" = ? and \" + ServerTableColumnsName.BRANCH_TABLE_BRANCH_ID\n+            + \" = ?\";\n+\n+    /**\n+     * The constant DELETE_BRANCH_TRANSACTION_BY_XID.\n+     */\n+    public static final String DELETE_BRANCH_TRANSACTION_BY_XID = \"delete from \" + BRANCH_TABLE_PLACEHOLD\n+            + \" where \" + ServerTableColumnsName.BRANCH_TABLE_XID + \" = ?\";\n+\n+\n+    /**\n+     * The constant QUERY_BRANCH_TRANSACTION.\n+     */\n+    public static final String QUERY_BRANCH_TRANSACTION = \"select \" + ALL_BRANCH_COLUMNS + \" from \"\n+            + BRANCH_TABLE_PLACEHOLD + \" where \" + ServerTableColumnsName.BRANCH_TABLE_XID + \" = ? order by \"\n+            + ServerTableColumnsName.BRANCH_TABLE_GMT_CREATE + \" asc\";\n+\n+    /**\n+     * The constant QUERY_BRANCH_TRANSACTION_XIDS.\n+     */\n+    public static final String QUERY_BRANCH_TRANSACTION_XIDS = \"select \" + ALL_BRANCH_COLUMNS + \" from \"\n+            + BRANCH_TABLE_PLACEHOLD + \" where \" + ServerTableColumnsName.BRANCH_TABLE_XID + \" in (\" + PRAMETER_PLACEHOLD + \") order by \"\n+            + ServerTableColumnsName.BRANCH_TABLE_GMT_CREATE + \" asc\";\n+\n+    /**\n+     * The constant CHECK_MAX_TRANS_ID.\n+     */\n+    public static final String QUERY_MAX_TRANS_ID = \"select max(\" + ServerTableColumnsName.GLOBAL_TABLE_TRANSACTION_ID\n+            + \") from \" + GLOBAL_TABLE_PLACEHOLD + \" where \" + ServerTableColumnsName.GLOBAL_TABLE_TRANSACTION_ID\n+            + \" < ? and \" + ServerTableColumnsName.GLOBAL_TABLE_TRANSACTION_ID + \" > ?\";\n+\n+    /**\n+     * The constant CHECK_MAX_BTANCH_ID.\n+     */\n+    public static final String QUERY_MAX_BTANCH_ID = \"select max(\" + ServerTableColumnsName.BRANCH_TABLE_BRANCH_ID\n+            + \") from \" + BRANCH_TABLE_PLACEHOLD + \" where \" + ServerTableColumnsName.BRANCH_TABLE_BRANCH_ID + \" < ? and \"\n+            + ServerTableColumnsName.BRANCH_TABLE_BRANCH_ID + \" > ?\";\n+\n+    @Override\n+    public String getInsertGlobalTransactionSQL(String globalTable) {\n+        throw new NotSupportYetException(\"unknown dbType:\" + CONFIG.getConfig(ConfigurationKeys.STORE_DB_TYPE));", "originalCommit": "3a82b178bea5e0bc22bb2c7cd976a18cdf4f7120", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDczODg5MQ==", "url": "https://github.com/seata/seata/pull/2369#discussion_r404738891", "bodyText": "OK", "author": "l81893521", "createdAt": "2020-04-07T11:33:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5ODc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU3MzUzNw==", "url": "https://github.com/seata/seata/pull/2369#discussion_r405573537", "bodyText": "fixed", "author": "l81893521", "createdAt": "2020-04-08T14:35:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5ODc4Nw=="}], "type": "inlineReview"}, {"oid": "068e9fdfaed5ab8cd41ee64929e0d3154183cf06", "url": "https://github.com/seata/seata/commit/068e9fdfaed5ab8cd41ee64929e0d3154183cf06", "message": "Merge remote-tracking branch 'origin/develop' into refactor_log_store_sql_with_spi", "committedDate": "2020-04-07T11:17:04Z", "type": "commit"}, {"oid": "201a95c84ecf6d1551c8ea30bc8fb095bebd368e", "url": "https://github.com/seata/seata/commit/201a95c84ecf6d1551c8ea30bc8fb095bebd368e", "message": "optimize the code", "committedDate": "2020-04-07T11:27:42Z", "type": "commit"}, {"oid": "bd29a06805cd6fec462dd50bff61ced7cf1f0960", "url": "https://github.com/seata/seata/commit/bd29a06805cd6fec462dd50bff61ced7cf1f0960", "message": "Merge remote-tracking branch 'me/refactor_log_store_sql_with_spi' into refactor_log_store_sql_with_spi", "committedDate": "2020-04-07T11:30:08Z", "type": "commit"}, {"oid": "86a6d7d54bd7eca34b40f1bb84c0575cf59100d5", "url": "https://github.com/seata/seata/commit/86a6d7d54bd7eca34b40f1bb84c0575cf59100d5", "message": "remove unused import", "committedDate": "2020-04-07T11:34:27Z", "type": "commit"}, {"oid": "3332612692dd7efa111b75b627e04bca387f7955", "url": "https://github.com/seata/seata/commit/3332612692dd7efa111b75b627e04bca387f7955", "message": "Merge branch 'develop' into refactor_log_store_sql_with_spi", "committedDate": "2020-04-08T13:34:30Z", "type": "commit"}]}