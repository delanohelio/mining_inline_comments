{"pr_number": 2323, "pr_title": "bugfix:fix wrong proxy of datasource bean", "pr_createdAt": "2020-02-28T11:02:24Z", "pr_url": "https://github.com/seata/seata/pull/2323", "timeline": [{"oid": "9a795a3c45179aeb8effe8e4ad767f684de986ef", "url": "https://github.com/seata/seata/commit/9a795a3c45179aeb8effe8e4ad767f684de986ef", "message": "fix duplicate proxy of bean.", "committedDate": "2020-02-28T11:00:17Z", "type": "commit"}, {"oid": "99e4f386a84c3ac7f6fe1bcf7709bccf2b8b59fe", "url": "https://github.com/seata/seata/commit/99e4f386a84c3ac7f6fe1bcf7709bccf2b8b59fe", "message": "Update SeataDataSourceBeanPostProcessor.java", "committedDate": "2020-02-28T11:14:08Z", "type": "commit"}, {"oid": "7bda41411a8c24b293d36d85cca4ff29db6f12bc", "url": "https://github.com/seata/seata/commit/7bda41411a8c24b293d36d85cca4ff29db6f12bc", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-02-28T23:56:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg2NzYwOA==", "url": "https://github.com/seata/seata/pull/2323#discussion_r386867608", "bodyText": "In JDK Proxy case, what invocationHandler has a field of type DataSourceProxy?", "author": "ggndnn", "createdAt": "2020-03-03T08:41:43Z", "path": "spring/src/main/java/io/seata/spring/annotation/datasource/SeataDataSourceBeanPostProcessor.java", "diffHunk": "@@ -105,4 +113,62 @@ private Object handleMethodProxy(DataSourceProxy dataSourceProxy, Method method,\n             }\n         }\n     }\n+\n+    /**\n+     * is auto proxied by seata\n+     *\n+     * @param bean\n+     * @return true, if this bean has been auto-proxied by seata\n+     */\n+    private boolean isAutoProxiedBySeata(Object bean) throws NoSuchFieldException, IllegalAccessException {\n+        if (bean instanceof DataSourceProxy) {\n+            return true;\n+        }\n+        //handle Spring AOP\n+        Object proxyTargetObject = bean;\n+        if (AopUtils.isAopProxy(proxyTargetObject)) {\n+            try {\n+                proxyTargetObject = SpringProxyUtils.getAdvisedSupport(bean).getTargetSource().getTarget();\n+            } catch (Exception e) {\n+                throw new RuntimeException(e);\n+            }\n+        }\n+        Field field = null;\n+        //handle Normal proxy object\n+        if (ClassUtils.isCglibProxy(proxyTargetObject)) {\n+            //CGLIB Proxy\n+            field = proxyTargetObject.getClass().getDeclaredField(\"CGLIB$CALLBACK_0\");\n+        } else if (Proxy.isProxyClass(proxyTargetObject.getClass())) {\n+            //JDK Proxy\n+            field = proxyTargetObject.getClass().getDeclaredField(\"h\");\n+        }\n+        return doCheckAutoProxy(field, proxyTargetObject);\n+    }\n+\n+    /**\n+     * do check auto proxy\n+     *\n+     * @param field\n+     * @param proxiedObject\n+     * @return\n+     * @throws IllegalAccessException\n+     */\n+    private boolean doCheckAutoProxy(Field field, Object proxiedObject) throws IllegalAccessException {\n+        if (null == field) {\n+            return false;\n+        }\n+        field.setAccessible(true);\n+        Object fieldObject = field.get(proxiedObject);\n+        return Stream.of(fieldObject.getClass().getDeclaredFields()).anyMatch(f -> {\n+            f.setAccessible(true);\n+            Object targetObject;\n+            try {\n+                targetObject = f.get(fieldObject);\n+            } catch (IllegalAccessException e) {\n+                throw new RuntimeException(e);\n+            }\n+            return targetObject instanceof DataSourceProxy;", "originalCommit": "7bda41411a8c24b293d36d85cca4ff29db6f12bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk5NTQyNw==", "url": "https://github.com/seata/seata/pull/2323#discussion_r387995427", "bodyText": "When datasource bean has been proxied once.", "author": "xingfudeshi", "createdAt": "2020-03-04T23:27:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg2NzYwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg2ODAwMg==", "url": "https://github.com/seata/seata/pull/2323#discussion_r386868002", "bodyText": "Need to restore accessible?", "author": "ggndnn", "createdAt": "2020-03-03T08:42:34Z", "path": "spring/src/main/java/io/seata/spring/annotation/datasource/SeataDataSourceBeanPostProcessor.java", "diffHunk": "@@ -105,4 +113,62 @@ private Object handleMethodProxy(DataSourceProxy dataSourceProxy, Method method,\n             }\n         }\n     }\n+\n+    /**\n+     * is auto proxied by seata\n+     *\n+     * @param bean\n+     * @return true, if this bean has been auto-proxied by seata\n+     */\n+    private boolean isAutoProxiedBySeata(Object bean) throws NoSuchFieldException, IllegalAccessException {\n+        if (bean instanceof DataSourceProxy) {\n+            return true;\n+        }\n+        //handle Spring AOP\n+        Object proxyTargetObject = bean;\n+        if (AopUtils.isAopProxy(proxyTargetObject)) {\n+            try {\n+                proxyTargetObject = SpringProxyUtils.getAdvisedSupport(bean).getTargetSource().getTarget();\n+            } catch (Exception e) {\n+                throw new RuntimeException(e);\n+            }\n+        }\n+        Field field = null;\n+        //handle Normal proxy object\n+        if (ClassUtils.isCglibProxy(proxyTargetObject)) {\n+            //CGLIB Proxy\n+            field = proxyTargetObject.getClass().getDeclaredField(\"CGLIB$CALLBACK_0\");\n+        } else if (Proxy.isProxyClass(proxyTargetObject.getClass())) {\n+            //JDK Proxy\n+            field = proxyTargetObject.getClass().getDeclaredField(\"h\");\n+        }\n+        return doCheckAutoProxy(field, proxyTargetObject);\n+    }\n+\n+    /**\n+     * do check auto proxy\n+     *\n+     * @param field\n+     * @param proxiedObject\n+     * @return\n+     * @throws IllegalAccessException\n+     */\n+    private boolean doCheckAutoProxy(Field field, Object proxiedObject) throws IllegalAccessException {\n+        if (null == field) {\n+            return false;\n+        }\n+        field.setAccessible(true);", "originalCommit": "7bda41411a8c24b293d36d85cca4ff29db6f12bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY3NDEwMA==", "url": "https://github.com/seata/seata/pull/2323#discussion_r388674100", "bodyText": "fixed", "author": "xingfudeshi", "createdAt": "2020-03-06T01:52:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg2ODAwMg=="}], "type": "inlineReview"}, {"oid": "881550c68dd4cd1c9cc1762c57a34ab0c2804473", "url": "https://github.com/seata/seata/commit/881550c68dd4cd1c9cc1762c57a34ab0c2804473", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-04T06:16:33Z", "type": "commit"}, {"oid": "75f8b4a9be0cb50ad8d7a9efc8af96a13339a6c0", "url": "https://github.com/seata/seata/commit/75f8b4a9be0cb50ad8d7a9efc8af96a13339a6c0", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-04T23:28:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM2OTgzNw==", "url": "https://github.com/seata/seata/pull/2323#discussion_r388369837", "bodyText": "only for cglib?", "author": "slievrly", "createdAt": "2020-03-05T15:31:08Z", "path": "spring/src/main/java/io/seata/spring/annotation/datasource/SeataDataSourceBeanPostProcessor.java", "diffHunk": "@@ -105,4 +113,62 @@ private Object handleMethodProxy(DataSourceProxy dataSourceProxy, Method method,\n             }\n         }\n     }\n+\n+    /**\n+     * is auto proxied by seata\n+     *\n+     * @param bean\n+     * @return true, if this bean has been auto-proxied by seata\n+     */\n+    private boolean isAutoProxiedBySeata(Object bean) throws NoSuchFieldException, IllegalAccessException {\n+        if (bean instanceof DataSourceProxy) {\n+            return true;\n+        }\n+        //handle Spring AOP\n+        Object proxyTargetObject = bean;\n+        if (AopUtils.isAopProxy(proxyTargetObject)) {\n+            try {\n+                proxyTargetObject = SpringProxyUtils.getAdvisedSupport(bean).getTargetSource().getTarget();", "originalCommit": "75f8b4a9be0cb50ad8d7a9efc8af96a13339a6c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM3OTY1Nw==", "url": "https://github.com/seata/seata/pull/2323#discussion_r388379657", "bodyText": "Both of jdk and cglib.", "author": "xingfudeshi", "createdAt": "2020-03-05T15:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM2OTgzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM5MzcxMA==", "url": "https://github.com/seata/seata/pull/2323#discussion_r388393710", "bodyText": "getClass -> getSuperclass", "author": "slievrly", "createdAt": "2020-03-05T16:04:53Z", "path": "spring/src/main/java/io/seata/spring/annotation/datasource/SeataDataSourceBeanPostProcessor.java", "diffHunk": "@@ -105,4 +113,62 @@ private Object handleMethodProxy(DataSourceProxy dataSourceProxy, Method method,\n             }\n         }\n     }\n+\n+    /**\n+     * is auto proxied by seata\n+     *\n+     * @param bean\n+     * @return true, if this bean has been auto-proxied by seata\n+     */\n+    private boolean isAutoProxiedBySeata(Object bean) throws NoSuchFieldException, IllegalAccessException {\n+        if (bean instanceof DataSourceProxy) {\n+            return true;\n+        }\n+        //handle Spring AOP\n+        Object proxyTargetObject = bean;\n+        if (AopUtils.isAopProxy(proxyTargetObject)) {\n+            try {\n+                proxyTargetObject = SpringProxyUtils.getAdvisedSupport(bean).getTargetSource().getTarget();\n+            } catch (Exception e) {\n+                throw new RuntimeException(e);\n+            }\n+        }\n+        Field field = null;\n+        //handle Normal proxy object\n+        if (ClassUtils.isCglibProxy(proxyTargetObject)) {\n+            //CGLIB Proxy\n+            field = proxyTargetObject.getClass().getDeclaredField(\"CGLIB$CALLBACK_0\");\n+        } else if (Proxy.isProxyClass(proxyTargetObject.getClass())) {\n+            //JDK Proxy\n+            field = proxyTargetObject.getClass().getDeclaredField(\"h\");", "originalCommit": "75f8b4a9be0cb50ad8d7a9efc8af96a13339a6c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY3NDA1MQ==", "url": "https://github.com/seata/seata/pull/2323#discussion_r388674051", "bodyText": "fixed", "author": "xingfudeshi", "createdAt": "2020-03-06T01:52:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM5MzcxMA=="}], "type": "inlineReview"}, {"oid": "e31f5a69237bacd98c0f1928e3286a254e15b3c2", "url": "https://github.com/seata/seata/commit/e31f5a69237bacd98c0f1928e3286a254e15b3c2", "message": "fix review", "committedDate": "2020-03-06T01:46:06Z", "type": "commit"}, {"oid": "31edb8cd6710ba7292afe36cda4f01615a5dff57", "url": "https://github.com/seata/seata/commit/31edb8cd6710ba7292afe36cda4f01615a5dff57", "message": "Merge branch 'fix_duplicate_proxy' of https://github.com/xingfudeshi/seata into fix_duplicate_proxy", "committedDate": "2020-03-06T01:46:49Z", "type": "commit"}, {"oid": "85b270c9095efd942da7f398f563e002417e2074", "url": "https://github.com/seata/seata/commit/85b270c9095efd942da7f398f563e002417e2074", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-06T01:52:40Z", "type": "commit"}, {"oid": "fc28853aa1ac7302256dc3c45d241f0f422f1219", "url": "https://github.com/seata/seata/commit/fc28853aa1ac7302256dc3c45d241f0f422f1219", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-09T12:47:44Z", "type": "commit"}, {"oid": "5fd3fd40006ddb32d04a865071a8d72d119b1680", "url": "https://github.com/seata/seata/commit/5fd3fd40006ddb32d04a865071a8d72d119b1680", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-11T08:09:39Z", "type": "commit"}, {"oid": "823fb41380d7c20bcccbeda4b66ba80259c45e43", "url": "https://github.com/seata/seata/commit/823fb41380d7c20bcccbeda4b66ba80259c45e43", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-13T04:24:56Z", "type": "commit"}, {"oid": "20473c347c34b386bd7a2473bc5f920a59f2a357", "url": "https://github.com/seata/seata/commit/20473c347c34b386bd7a2473bc5f920a59f2a357", "message": "implements PriorityOrdered", "committedDate": "2020-03-13T06:08:43Z", "type": "commit"}, {"oid": "01a16aabedd4c137840b0fa97d1877780865d4c4", "url": "https://github.com/seata/seata/commit/01a16aabedd4c137840b0fa97d1877780865d4c4", "message": "use Ordered instead of PriorityOrdered", "committedDate": "2020-03-13T08:50:20Z", "type": "commit"}, {"oid": "a9a844ee59cec5aec6b687dd599ca7e8d74c2792", "url": "https://github.com/seata/seata/commit/a9a844ee59cec5aec6b687dd599ca7e8d74c2792", "message": "using spring to create automatic proxy", "committedDate": "2020-03-15T04:16:46Z", "type": "commit"}, {"oid": "7ab6b3c6888c86632cab9482a70b75da082c68e5", "url": "https://github.com/seata/seata/commit/7ab6b3c6888c86632cab9482a70b75da082c68e5", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-15T10:33:18Z", "type": "commit"}, {"oid": "ae3d7563c9b8d1598a440782e9fb8fae3bad5c10", "url": "https://github.com/seata/seata/commit/ae3d7563c9b8d1598a440782e9fb8fae3bad5c10", "message": "using spring to create automatic proxy", "committedDate": "2020-03-15T11:04:59Z", "type": "commit"}, {"oid": "9672d295df60d8694c77b77eeb280fdba91cb300", "url": "https://github.com/seata/seata/commit/9672d295df60d8694c77b77eeb280fdba91cb300", "message": "add exclude", "committedDate": "2020-03-15T11:48:49Z", "type": "commit"}, {"oid": "7c20a0721b5cbc55460d780b639b200a5e585266", "url": "https://github.com/seata/seata/commit/7c20a0721b5cbc55460d780b639b200a5e585266", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-15T16:12:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY2MzEwNQ==", "url": "https://github.com/seata/seata/pull/2323#discussion_r393663105", "bodyText": "Do we need a include attribute?", "author": "ggndnn", "createdAt": "2020-03-17T13:05:08Z", "path": "spring/src/main/java/io/seata/spring/annotation/datasource/EnableAutoDataSourceProxy.java", "diffHunk": "@@ -38,4 +38,10 @@\n      * @return useJdkProxy\n      */\n     boolean useJdkProxy() default false;\n+\n+    /**\n+     * Specifies which datasource bean are not eligible for auto-proxying\n+     * @return\n+     */\n+    String[] exclude() default {};", "originalCommit": "7c20a0721b5cbc55460d780b639b200a5e585266", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwMjEwMw==", "url": "https://github.com/seata/seata/pull/2323#discussion_r393802103", "bodyText": "I don't think we need the include attribute, and exclude is only to avoid unnecessary proxy. In fact, even if the proxy, it won't have any impact.", "author": "xingfudeshi", "createdAt": "2020-03-17T16:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY2MzEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA5MDQyMg==", "url": "https://github.com/seata/seata/pull/2323#discussion_r394090422", "bodyText": "It makes sense. But I think include is an effective feature helping users to control auto proxying, avoiding unexpected situations, there is no harm to provide such a function.\nBy the way, should exclude be excludes? Because the attribute is array type.", "author": "ggndnn", "createdAt": "2020-03-18T03:40:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY2MzEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA1NjEyNA==", "url": "https://github.com/seata/seata/pull/2323#discussion_r395056124", "bodyText": "done", "author": "xingfudeshi", "createdAt": "2020-03-19T14:13:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY2MzEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY3NDEzOA==", "url": "https://github.com/seata/seata/pull/2323#discussion_r393674138", "bodyText": "I have an idea, ProxyCreator can be implement like this:\n// define a mark interface\npublic interface SeataProxy {\n}\n\n// implements MethodInterceptor and IntroductionInfo\npublic class SeataAutoDataSourceProxyAdvice implements MethodInterceptor, IntroductionInfo {\n    private final DataSourceProxy dataSourceProxy;\n\n    public SeataAutoDataSourceProxyAdvice(DataSourceProxy dataSourceProxy) {\n        this.dataSourceProxy = dataSourceProxy;\n    }\n    \n    ...\n\n    @Override\n    public Class<?>[] getInterfaces() {\n        return new Class[]{SeataProxy.class};\n    }\n}\n\n// extends AbstractAutoProxyCreator\npublic class SeataAutoDataSourceProxyCreator extends AbstractAutoProxyCreator {\n    protected abstract Object[] getAdvicesAndAdvisorsForBean(Class<?> beanClass, String beanName, TargetSource customTargetSource) throws BeansException {\n        advice = new SeataAutoDataSourceProxyAdvice()\n        // use DefaultIntroductionAdvisor\n        advisor = new DefaultIntroductionAdvisor(advice);\n        return new Object[]{advisor};\n    }\n \n    @Override    \n    protected boolean shouldSkip(Class<?> beanClass, String beanName) {\n        return SeataProxy.class.isAssignableFrom(beanClass) || beanName ....;\n    }\n}", "author": "ggndnn", "createdAt": "2020-03-17T13:22:36Z", "path": "spring/src/main/java/io/seata/spring/annotation/datasource/SeataAutoDataSourceProxyCreator.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.spring.annotation.datasource;\n+\n+import javax.sql.DataSource;\n+import java.util.stream.Stream;\n+\n+import io.seata.rm.datasource.DataSourceProxy;\n+import io.seata.spring.util.SpringProxyUtils;\n+import org.aopalliance.intercept.MethodInterceptor;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.aop.Advisor;\n+import org.springframework.aop.TargetSource;\n+import org.springframework.aop.framework.AdvisedSupport;\n+import org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator;\n+import org.springframework.aop.support.AopUtils;\n+import org.springframework.beans.BeansException;\n+\n+/**\n+ * @author xingfudeshi@gmail.com\n+ */\n+public class SeataAutoDataSourceProxyCreator extends AbstractAutoProxyCreator {", "originalCommit": "7c20a0721b5cbc55460d780b639b200a5e585266", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwMzA0Ng==", "url": "https://github.com/seata/seata/pull/2323#discussion_r393803046", "bodyText": "Good idea!!", "author": "xingfudeshi", "createdAt": "2020-03-17T16:20:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY3NDEzOA=="}], "type": "inlineReview"}, {"oid": "5abe6a851ebda962056837c48182ea0513a7b31b", "url": "https://github.com/seata/seata/commit/5abe6a851ebda962056837c48182ea0513a7b31b", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-17T16:25:42Z", "type": "commit"}, {"oid": "b4c27741b7c7f4f2c4944ba1a0652ab81c1976c9", "url": "https://github.com/seata/seata/commit/b4c27741b7c7f4f2c4944ba1a0652ab81c1976c9", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-19T13:45:25Z", "type": "commit"}, {"oid": "acdbdfce486f64817a8fcd0dc5537d30e9a00c8f", "url": "https://github.com/seata/seata/commit/acdbdfce486f64817a8fcd0dc5537d30e9a00c8f", "message": "use Spring AOP to create auto-proxy", "committedDate": "2020-03-19T14:13:10Z", "type": "commit"}, {"oid": "8f239ad622ae51a0dafbb81b6808cc42c9bcff7e", "url": "https://github.com/seata/seata/commit/8f239ad622ae51a0dafbb81b6808cc42c9bcff7e", "message": "Merge remote-tracking branch 'origin/fix_duplicate_proxy' into fix_duplicate_proxy", "committedDate": "2020-03-19T14:13:24Z", "type": "commit"}, {"oid": "8e915d049e8a666f667e5f0541677b80706177d3", "url": "https://github.com/seata/seata/commit/8e915d049e8a666f667e5f0541677b80706177d3", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-19T16:49:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQzNzMwMw==", "url": "https://github.com/seata/seata/pull/2323#discussion_r395437303", "bodyText": "What I thought is to not override wrapIfNecessary and fully make use of AbstractAutoProxyCreator, something like this:\npublic class SeataAutoDataSourceProxyCreator extends AbstractAutoProxyCreator {\n    private final String[] excludes;\n\n    private final DefaultIntroductionAdvisor advisor = new DefaultIntroductionAdvisor(new SeataAutoDataSourceProxyAdvice());\n\n    public SeataAutoDataSourceProxyCreator(boolean useJdkProxy, String[] excludes) {\n        this.excludes = excludes;\n        setProxyTargetClass(!useJdkProxy);\n    }\n\n    @Override\n    protected Object[] getAdvicesAndAdvisorsForBean(Class<?> beanClass, String beanName, TargetSource customTargetSource) throws BeansException {\n        return new Object[]{advisor};\n    }\n\n    @Override\n    protected boolean shouldSkip(Class<?> beanClass, String beanName) {\n        return SeataProxy.class.isAssignableFrom(beanClass) ||\n                !DataSource.class.isAssignableFrom(beanClass) ||\n                Arrays.asList(excludes).contains(beanClass.getName());\n    }\n}\n\npublic class SeataAutoDataSourceProxyAdvice implements MethodInterceptor, IntroductionInfo {\n    @Override\n    public Object invoke(MethodInvocation invocation) throws Throwable {\n        DataSource dataSource = (DataSource) invocation.getThis();\n        DataSourceProxy dataSourceProxy = DataSourceProxyHolder.get().putDataSource(dataSource);\n        Method method = invocation.getMethod();\n        Object[] args = invocation.getArguments();\n        Method m = BeanUtils.findDeclaredMethod(DataSourceProxy.class, method.getName(), method.getParameterTypes());\n        if (null != m) {\n            return m.invoke(dataSourceProxy, args);\n        } else {\n            return invocation.proceed();\n        }\n    }\n\n    @Override\n    public Class<?>[] getInterfaces() {\n        return new Class[]{SeataProxy.class};\n    }\n\n}", "author": "ggndnn", "createdAt": "2020-03-20T04:44:03Z", "path": "spring/src/main/java/io/seata/spring/annotation/datasource/SeataAutoDataSourceProxyCreator.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.spring.annotation.datasource;\n+\n+import javax.sql.DataSource;\n+import java.util.Arrays;\n+\n+import io.seata.rm.datasource.DataSourceProxy;\n+import io.seata.spring.util.SpringProxyUtils;\n+import org.aopalliance.intercept.MethodInterceptor;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.aop.Advisor;\n+import org.springframework.aop.TargetSource;\n+import org.springframework.aop.framework.AdvisedSupport;\n+import org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator;\n+import org.springframework.aop.support.AopUtils;\n+import org.springframework.aop.support.DefaultIntroductionAdvisor;\n+import org.springframework.beans.BeansException;\n+\n+/**\n+ * @author xingfudeshi@gmail.com\n+ */\n+public class SeataAutoDataSourceProxyCreator extends AbstractAutoProxyCreator {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(SeataAutoDataSourceProxyCreator.class);\n+    private MethodInterceptor advice;\n+    private final String[] excludes;\n+\n+    public SeataAutoDataSourceProxyCreator(boolean useJdkProxy, String[] excludes) {\n+        this.excludes = excludes;\n+        setProxyTargetClass(!useJdkProxy);\n+    }\n+\n+    @Override\n+    protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {", "originalCommit": "8e915d049e8a666f667e5f0541677b80706177d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4MTA1Mw==", "url": "https://github.com/seata/seata/pull/2323#discussion_r395681053", "bodyText": "Fixed.Thanks.", "author": "xingfudeshi", "createdAt": "2020-03-20T14:40:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQzNzMwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQzNzQzMw==", "url": "https://github.com/seata/seata/pull/2323#discussion_r395437433", "bodyText": "excludes?", "author": "ggndnn", "createdAt": "2020-03-20T04:45:05Z", "path": "spring/src/main/java/io/seata/spring/annotation/datasource/AutoDataSourceProxyRegistrar.java", "diffHunk": "@@ -27,16 +27,20 @@\n  */\n public class AutoDataSourceProxyRegistrar implements ImportBeanDefinitionRegistrar {\n     private static final String ATTRIBUTE_KEY_USE_JDK_PROXY = \"useJdkProxy\";\n-    public static final String BEAN_NAME_SEATA_DATA_SOURCE_BEAN_POST_PROCESSOR = \"seataDataSourceBeanPostProcessor\";\n+    private static final String ATTRIBUTE_KEY_EXCLUDE = \"exclude\";", "originalCommit": "8e915d049e8a666f667e5f0541677b80706177d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY4MTIyMQ==", "url": "https://github.com/seata/seata/pull/2323#discussion_r395681221", "bodyText": "Fixed", "author": "xingfudeshi", "createdAt": "2020-03-20T14:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQzNzQzMw=="}], "type": "inlineReview"}, {"oid": "c46c6d62c64a53cfaf1a568b8c00a724c424389b", "url": "https://github.com/seata/seata/commit/c46c6d62c64a53cfaf1a568b8c00a724c424389b", "message": "remove wrapIfNecessary", "committedDate": "2020-03-20T14:39:26Z", "type": "commit"}, {"oid": "798cbb2096114131905b68a1c30347623eb6d549", "url": "https://github.com/seata/seata/commit/798cbb2096114131905b68a1c30347623eb6d549", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-20T14:40:32Z", "type": "commit"}, {"oid": "98be2f07e8d0f68ea93347acde8a66aba1c67037", "url": "https://github.com/seata/seata/commit/98be2f07e8d0f68ea93347acde8a66aba1c67037", "message": "Merge branch 'fix_duplicate_proxy' of https://github.com/xingfudeshi/seata into fix_duplicate_proxy", "committedDate": "2020-03-20T14:42:51Z", "type": "commit"}, {"oid": "5475cbb281a7083f93f5a09983c904343e861b2d", "url": "https://github.com/seata/seata/commit/5475cbb281a7083f93f5a09983c904343e861b2d", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-21T06:50:44Z", "type": "commit"}, {"oid": "2a5f4fb4583f185ce1a5560c0e33cff993a1eae2", "url": "https://github.com/seata/seata/commit/2a5f4fb4583f185ce1a5560c0e33cff993a1eae2", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-23T11:18:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQxMjE2Mg==", "url": "https://github.com/seata/seata/pull/2323#discussion_r396412162", "bodyText": "ing means doing\uff1f", "author": "slievrly", "createdAt": "2020-03-23T12:25:23Z", "path": "seata-spring-boot-starter/src/main/java/io/seata/spring/boot/autoconfigure/properties/SeataProperties.java", "diffHunk": "@@ -101,4 +105,13 @@ public SeataProperties setUseJdkProxy(boolean useJdkProxy) {\n         this.useJdkProxy = useJdkProxy;\n         return this;\n     }\n+\n+    public String[] getExcludesForAutoProxying() {", "originalCommit": "2a5f4fb4583f185ce1a5560c0e33cff993a1eae2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU2MzcxNA==", "url": "https://github.com/seata/seata/pull/2323#discussion_r396563714", "bodyText": "Yes, but sometimes it means gerund.Need to change to proxy?", "author": "xingfudeshi", "createdAt": "2020-03-23T16:01:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQxMjE2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ5MTE1OA==", "url": "https://github.com/seata/seata/pull/2323#discussion_r396491158", "bodyText": "Do we need to throw exception or log warning message when m == null?", "author": "ggndnn", "createdAt": "2020-03-23T14:27:22Z", "path": "spring/src/main/java/io/seata/spring/annotation/datasource/SeataAutoDataSourceProxyAdvice.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.spring.annotation.datasource;\n+\n+import javax.sql.DataSource;\n+import java.lang.reflect.Method;\n+\n+import io.seata.rm.datasource.DataSourceProxy;\n+import org.aopalliance.intercept.MethodInterceptor;\n+import org.aopalliance.intercept.MethodInvocation;\n+import org.springframework.aop.IntroductionInfo;\n+import org.springframework.beans.BeanUtils;\n+\n+/**\n+ * @author xingfudeshi@gmail.com\n+ */\n+public class SeataAutoDataSourceProxyAdvice implements MethodInterceptor, IntroductionInfo {\n+\n+    @Override\n+    public Object invoke(MethodInvocation invocation) throws Throwable {\n+        DataSourceProxy dataSourceProxy = DataSourceProxyHolder.get().putDataSource((DataSource) invocation.getThis());\n+        Method method = invocation.getMethod();\n+        Object[] args = invocation.getArguments();\n+        Method m = BeanUtils.findDeclaredMethod(DataSourceProxy.class, method.getName(), method.getParameterTypes());\n+        if (null != m) {\n+            return m.invoke(dataSourceProxy, args);\n+        } else {\n+            return invocation.proceed();", "originalCommit": "2a5f4fb4583f185ce1a5560c0e33cff993a1eae2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU1NDExMg==", "url": "https://github.com/seata/seata/pull/2323#discussion_r396554112", "bodyText": "When m=null,the method of original bean should be called.", "author": "xingfudeshi", "createdAt": "2020-03-23T15:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ5MTE1OA=="}], "type": "inlineReview"}, {"oid": "8d3b2c4155a0b7c6ba402b28f973cac26b7b97b9", "url": "https://github.com/seata/seata/commit/8d3b2c4155a0b7c6ba402b28f973cac26b7b97b9", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-23T16:02:02Z", "type": "commit"}, {"oid": "a849978a981801e867f6f9e469f4d6a53dcf9042", "url": "https://github.com/seata/seata/commit/a849978a981801e867f6f9e469f4d6a53dcf9042", "message": "Merge branch 'develop' into fix_duplicate_proxy", "committedDate": "2020-03-24T15:55:06Z", "type": "commit"}]}