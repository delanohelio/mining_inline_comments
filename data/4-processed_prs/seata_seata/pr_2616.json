{"pr_number": 2616, "pr_title": "feature: TCC adapter for Dubbo And Sofa reference annotation", "pr_createdAt": "2020-04-26T08:15:12Z", "pr_url": "https://github.com/seata/seata/pull/2616", "timeline": [{"oid": "a75e8dd4a4941b08e8d3d89135e0e662d220779f", "url": "https://github.com/seata/seata/commit/a75e8dd4a4941b08e8d3d89135e0e662d220779f", "message": "A tcc adapter for Dubbo Sofa annotation", "committedDate": "2020-06-01T03:28:01Z", "type": "commit"}, {"oid": "a75e8dd4a4941b08e8d3d89135e0e662d220779f", "url": "https://github.com/seata/seata/commit/a75e8dd4a4941b08e8d3d89135e0e662d220779f", "message": "A tcc adapter for Dubbo Sofa annotation", "committedDate": "2020-06-01T03:28:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwMTk0MQ==", "url": "https://github.com/seata/seata/pull/2616#discussion_r440701941", "bodyText": "if necessary? FieldFilter check the filed contains annotation.", "author": "slievrly", "createdAt": "2020-06-16T09:08:01Z", "path": "spring/src/main/java/io/seata/spring/tcc/TccAnnotationProcessor.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.spring.tcc;\n+\n+import io.seata.rm.tcc.api.TwoPhaseBusinessAction;\n+import io.seata.rm.tcc.remoting.RemotingDesc;\n+import io.seata.spring.util.TCCBeanParserUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.BeansException;\n+import org.springframework.beans.factory.config.BeanPostProcessor;\n+import org.springframework.util.ReflectionUtils;\n+\n+import java.lang.annotation.Annotation;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+/**\n+ * An annotation adapter for TCC\n+ *\n+ * @author ppf\n+ */\n+public class TccAnnotationProcessor implements BeanPostProcessor {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(TccAnnotationProcessor.class);\n+\n+    private static final List<Class<? extends Annotation>> ANNOTATIONS = new ArrayList<>(4);\n+    private static final Set<String> PROXIED_SET = new HashSet<>();\n+\n+    static {\n+        ANNOTATIONS.add(loadAnnotation(\"org.apache.dubbo.config.annotation.Reference\"));\n+        ANNOTATIONS.add(loadAnnotation(\"com.alipay.sofa.runtime.api.annotation.SofaReference\"));\n+    }\n+\n+    private static Class<? extends Annotation> loadAnnotation(String annotation) {\n+        try {\n+            return (Class<? extends Annotation>) Class.forName(annotation);\n+        } catch (ClassNotFoundException e) {\n+            return null;\n+        }\n+    }\n+\n+\n+    /**\n+     * Process annotation\n+     *\n+     * @param bean\n+     * @param beanName\n+     * @param annotation\n+     */\n+    protected void process(Object bean, String beanName, Class<? extends Annotation> annotation) {\n+        if (Objects.isNull(annotation) || PROXIED_SET.contains(beanName)) {\n+            return;\n+        }\n+\n+        ReflectionUtils.doWithFields(bean.getClass(), field -> {\n+            Annotation reference = field.getAnnotation(annotation);", "originalCommit": "a75e8dd4a4941b08e8d3d89135e0e662d220779f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ5MTY0Mw==", "url": "https://github.com/seata/seata/pull/2616#discussion_r446491643", "bodyText": "The code impossible to reuse.", "author": "q294881866", "createdAt": "2020-06-27T06:22:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwMTk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzNjI5Ng==", "url": "https://github.com/seata/seata/pull/2616#discussion_r447036296", "bodyText": "What I mean is that reference can never null\uff0c field.isAnnotationPresent(annotation)", "author": "slievrly", "createdAt": "2020-06-29T14:57:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwMTk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwNjgyMg==", "url": "https://github.com/seata/seata/pull/2616#discussion_r440706822", "bodyText": "why not getInterface()?", "author": "slievrly", "createdAt": "2020-06-16T09:15:49Z", "path": "spring/src/main/java/io/seata/spring/tcc/TccAnnotationProcessor.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ *  Copyright 1999-2019 Seata.io Group.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package io.seata.spring.tcc;\n+\n+import io.seata.rm.tcc.api.TwoPhaseBusinessAction;\n+import io.seata.rm.tcc.remoting.RemotingDesc;\n+import io.seata.spring.util.TCCBeanParserUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.BeansException;\n+import org.springframework.beans.factory.config.BeanPostProcessor;\n+import org.springframework.util.ReflectionUtils;\n+\n+import java.lang.annotation.Annotation;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Modifier;\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+/**\n+ * An annotation adapter for TCC\n+ *\n+ * @author ppf\n+ */\n+public class TccAnnotationProcessor implements BeanPostProcessor {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(TccAnnotationProcessor.class);\n+\n+    private static final List<Class<? extends Annotation>> ANNOTATIONS = new ArrayList<>(4);\n+    private static final Set<String> PROXIED_SET = new HashSet<>();\n+\n+    static {\n+        ANNOTATIONS.add(loadAnnotation(\"org.apache.dubbo.config.annotation.Reference\"));\n+        ANNOTATIONS.add(loadAnnotation(\"com.alipay.sofa.runtime.api.annotation.SofaReference\"));\n+    }\n+\n+    private static Class<? extends Annotation> loadAnnotation(String annotation) {\n+        try {\n+            return (Class<? extends Annotation>) Class.forName(annotation);\n+        } catch (ClassNotFoundException e) {\n+            return null;\n+        }\n+    }\n+\n+\n+    /**\n+     * Process annotation\n+     *\n+     * @param bean\n+     * @param beanName\n+     * @param annotation\n+     */\n+    protected void process(Object bean, String beanName, Class<? extends Annotation> annotation) {\n+        if (Objects.isNull(annotation) || PROXIED_SET.contains(beanName)) {\n+            return;\n+        }\n+\n+        ReflectionUtils.doWithFields(bean.getClass(), field -> {\n+            Annotation reference = field.getAnnotation(annotation);\n+            if (reference == null) {\n+                return;\n+            }\n+\n+            addTccAdvise(bean, beanName, field, field.getType());", "originalCommit": "a75e8dd4a4941b08e8d3d89135e0e662d220779f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ5MDE1NQ==", "url": "https://github.com/seata/seata/pull/2616#discussion_r446490155", "bodyText": "Previously, it was implemented with dubbo and sofa interface, but there were many repetitions. In fact, it's the only one that's different. There's no need to use an interface\n`static {\n    ANNOTATIONS.add(loadAnnotation(\"org.apache.dubbo.config.annotation.Reference\"));\n    ANNOTATIONS.add(loadAnnotation(\"com.alipay.sofa.runtime.api.annotation.SofaReference\"));\n    ANNOTATIONS.add(loadAnnotation( ...\n}`", "author": "q294881866", "createdAt": "2020-06-27T06:04:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwNjgyMg=="}], "type": "inlineReview"}, {"oid": "c71985da24ae6c88eb5416e91807b693e533149f", "url": "https://github.com/seata/seata/commit/c71985da24ae6c88eb5416e91807b693e533149f", "message": "Merge branch 'develop' into feature_tcc_annotation", "committedDate": "2020-06-30T02:25:41Z", "type": "commit"}]}