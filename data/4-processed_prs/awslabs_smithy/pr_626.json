{"pr_number": 626, "pr_title": "Don't conflict URI if an endpoint prefix is present", "pr_createdAt": "2020-11-06T22:18:34Z", "pr_url": "https://github.com/awslabs/smithy/pull/626", "timeline": [{"oid": "4e362e673da917ac0dc071850186ee7ce5a97928", "url": "https://github.com/awslabs/smithy/commit/4e362e673da917ac0dc071850186ee7ce5a97928", "message": "Don't conflict URI if an endpoint prefix is present", "committedDate": "2020-11-06T22:17:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE1MjMxNw==", "url": "https://github.com/awslabs/smithy/pull/626#discussion_r519152317", "bodyText": "?", "author": "mtdowling", "createdAt": "2020-11-07T08:25:27Z", "path": "smithy-model/src/test/resources/software/amazon/smithy/model/errorfiles/validators/http-uri-conflict-validator.json", "diffHunk": "@@ -315,6 +333,120 @@\n                     }\n                 }\n             }\n+        },\n+        \"ns.foo#EndpointPrefixDeconflicts1\": {\n+            \"type\": \"operation\",\n+            \"traits\": {\n+                \"smithy.api#http\": {\n+                    \"uri\": \"/endpoint-prefix\",\n+                    \"method\": \"PUT\"\n+                },\n+                \"smithy.api#endpoint\": {\n+                    \"hostPrefix\": \"prefix.\"\n+                },\n+                \"smithy.api#idempotent\": {}\n+            }\n+        },\n+        \"ns.foo#EndpointPrefixDeconflicts2\": {\n+            \"type\": \"operation\",\n+            \"traits\": {\n+                \"smithy.api#http\": {\n+                    \"uri\": \"/endpoint-prefix\",\n+                    \"method\": \"PUT\"\n+                },\n+                \"smithy.api#idempotent\": {}\n+            }\n+        },\n+        \"ns.foo#PatternDeconflicts1\": {\n+            \"type\": \"operation\",\n+            \"traits\": {\n+                \"smithy.api#http\": {\n+                    \"uri\": \"/endpoint-prefix-pattern-deconflicts\",\n+                    \"method\": \"PUT\"\n+                },\n+                \"smithy.api#endpoint\": {\n+                    \"hostPrefix\": \"label.\"\n+                },\n+                \"smithy.api#idempotent\": {}\n+            }\n+        },\n+        \"ns.foo#PatternDeconflicts2\": {\n+            \"type\": \"operation\",\n+            \"traits\": {\n+                \"smithy.api#http\": {\n+                    \"uri\": \"/endpoint-prefix-pattern-deconflicts\",\n+                    \"method\": \"PUT\"\n+                },\n+                \"smithy.api#endpoint\": {\n+                    \"hostPrefix\": \"{HostLabel}.\"\n+                },\n+                \"smithy.api#idempotent\": {}\n+            },\n+            \"input\": {\n+                \"target\": \"ns.foo#HostLabelInputWithPattern\"\n+            }\n+        },\n+        \"ns.foo#HostLabelInputWithPattern\": {\n+            \"type\": \"structure\",\n+            \"members\": {\n+                \"HostLabel\": {\n+                    \"target\": \"smithy.api#String\",\n+                    \"traits\": {\n+                        \"smithy.api#hostLabel\": {},\n+                        \"smithy.api#pattern\": \"foo\",\n+                        \"smithy.api#required\": {}\n+                    }\n+                }\n+            }\n+        },\n+", "originalCommit": "4e362e673da917ac0dc071850186ee7ce5a97928", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5NjYyNg==", "url": "https://github.com/awslabs/smithy/pull/626#discussion_r520196626", "bodyText": "whoops haha i put in that extra space to make it easier for me to compartmentalize my change but forgot to remove it", "author": "JordonPhillips", "createdAt": "2020-11-09T23:55:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE1MjMxNw=="}], "type": "inlineReview"}, {"oid": "13da6d9d2c11d3f2c8f11dd595e8edba9d97eb36", "url": "https://github.com/awslabs/smithy/commit/13da6d9d2c11d3f2c8f11dd595e8edba9d97eb36", "message": "Remove extraneous whitespace", "committedDate": "2020-11-09T23:58:14Z", "type": "commit"}, {"oid": "14ab195f7dba1f31ba38ae890d4d377ffa4842f8", "url": "https://github.com/awslabs/smithy/commit/14ab195f7dba1f31ba38ae890d4d377ffa4842f8", "message": "Update http spec", "committedDate": "2020-11-10T00:19:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzNjg4Ng==", "url": "https://github.com/awslabs/smithy/pull/626#discussion_r520936886", "bodyText": "Can we just return a map and state that the map maintains order?", "author": "mtdowling", "createdAt": "2020-11-10T23:21:16Z", "path": "smithy-model/src/main/java/software/amazon/smithy/model/pattern/SmithyPattern.java", "diffHunk": "@@ -111,6 +113,43 @@ public boolean equals(Object other) {\n         return other instanceof SmithyPattern && pattern.equals(((SmithyPattern) other).pattern);\n     }\n \n+    /**\n+     * Gets a list of explicitly conflicting label segments between this\n+     * pattern and another.\n+     *\n+     * @param otherPattern SmithyPattern to check against.\n+     * @return A list of Segment Pairs where each pair represents a conflict\n+     *     and where the left side of the Pair is a segment from this pattern.\n+     */\n+    public List<Pair<Segment, Segment>> getConflictingLabelSegments(SmithyPattern otherPattern) {", "originalCommit": "14ab195f7dba1f31ba38ae890d4d377ffa4842f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0NTIzMQ==", "url": "https://github.com/awslabs/smithy/pull/626#discussion_r520945231", "bodyText": "Yes, but this was an exiting method from UriPattern so it's gonna get ugly. Pushed the change in a separate commit, enjoy", "author": "JordonPhillips", "createdAt": "2020-11-10T23:43:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzNjg4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0NDUyMQ==", "url": "https://github.com/awslabs/smithy/pull/626#discussion_r520944521", "bodyText": "Personal nit: I'd replace this with good old-fashioned looking Java. Maybe it's because the indentation implies that the Optional composition doesn't wrap the streaming composition.", "author": "mtdowling", "createdAt": "2020-11-10T23:41:56Z", "path": "smithy-model/src/main/java/software/amazon/smithy/model/validation/validators/HttpUriConflictValidator.java", "diffHunk": "@@ -159,6 +197,16 @@ private boolean isAllowableConflict(Model model, OperationShape operation, Opera\n                 .collect(Collectors.toMap(Pair::getLeft, Pair::getRight));\n     }\n \n+    private Map<String, Pattern> getHostLabelPatterns(Model model, OperationShape operation) {\n+        return OperationIndex.of(model).getInput(operation)", "originalCommit": "14ab195f7dba1f31ba38ae890d4d377ffa4842f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "84ad2c1979a5505cd04483fe46a78aedf457f050", "url": "https://github.com/awslabs/smithy/commit/84ad2c1979a5505cd04483fe46a78aedf457f050", "message": "Return conflicting labels as map", "committedDate": "2020-11-10T23:43:32Z", "type": "commit"}, {"oid": "da87684234bc537f37a9284633d983bbd20eba76", "url": "https://github.com/awslabs/smithy/commit/da87684234bc537f37a9284633d983bbd20eba76", "message": "Pull optional handling apart from input handling", "committedDate": "2020-11-10T23:47:55Z", "type": "commit"}, {"oid": "cb8454e2aa7b4fc1b46c37c17c5c8ae08e7cf3a8", "url": "https://github.com/awslabs/smithy/commit/cb8454e2aa7b4fc1b46c37c17c5c8ae08e7cf3a8", "message": "Rename map-based conflict detection", "committedDate": "2020-11-12T20:09:05Z", "type": "commit"}]}