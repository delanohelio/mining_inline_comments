{"pr_number": 412, "pr_title": "Improve validators through a trait index on model", "pr_createdAt": "2020-05-02T22:10:59Z", "pr_url": "https://github.com/awslabs/smithy/pull/412", "timeline": [{"oid": "bbd0ba3269ab163c65153b5f666655f97b1d6b81", "url": "https://github.com/awslabs/smithy/commit/bbd0ba3269ab163c65153b5f666655f97b1d6b81", "message": "Improve validators through a trait index on model\n\nThis commit is a fairly large update to validators because there's a new\nsuper useful feature on Model where you can now get a Set of shapes that\nhave a specific trait (and the value is cached). This means that a large\nmajority of validators that utilized Trait.flatMapStream can now be much\nmore efficiently written by iterating over the shapes that actually have\nthe trait directly. Lots of validators were updated to take advantage of\nthis and be more efficient (particularly HTTP validators and trait\nconflict validators).\n\nI also noticed that the TraitValueValidator was validating the prelude\nmodel, and that was pretty expensive. I updated this validator to only\nvalidate the prelude when a specific metadata property is set. Then, in\nunit tests, I added a test that ensures that the validator validates the\nprelude so that we can be sure that changes made to the prelude are\nvalid. Because of this change and the trait indexing, JMH shows that the\ntime to load and validate a model was nearly cut in half\n(from about 2ms to 1ms on my old laptop).\n\nI noticed that the UnstableFeatureValidator was still being used on\ndocument shapes even though the spec was updated to remove the\ndisclaimer that document shapes are unstable, so I removed this\nvalidator.", "committedDate": "2020-05-03T01:55:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYwNzc0OQ==", "url": "https://github.com/awslabs/smithy/pull/412#discussion_r419607749", "bodyText": "The public API migrations in this file need a changelog entry: getTraitDefinitions and getTraitShapes.", "author": "kstich", "createdAt": "2020-05-04T17:36:34Z", "path": "smithy-model/src/main/java/software/amazon/smithy/model/Model.java", "diffHunk": "@@ -141,46 +133,66 @@ public static ModelAssembler assembler(ClassLoader classLoader) {\n     }\n \n     /**\n-     * Returns are trait shapes in the model as a map of {@code Shape}\n-     * objects to their {@link TraitDefinition} traits.\n+     * Gets the trait definition of a specific trait shape ID.\n+     *\n+     * @param traitId ID of the shape to get the trait definition of.\n+     * @return Returns the optionally found trait definition.\n+     */\n+    public Optional<TraitDefinition> getTraitDefinition(ToShapeId traitId) {\n+        return getShape(traitId.toShapeId()).flatMap(shape -> shape.getTrait(TraitDefinition.class));\n+    }\n+\n+    /**\n+     * Gets a set of shapes in the model marked with a specific trait.\n      *\n-     * @return Returns all trait definitions in the model.\n+     * @param trait Trait shape ID to look for on shapes.\n+     * @return Returns the immutable set of matching shapes.\n      */\n-    public Map<Shape, TraitDefinition> getTraitDefinitions() {", "originalCommit": "ccbbb6fd2d1230aaf9d43cebe95b49b43ed25106", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2e7418e779d5b416db9163f76b2205b90854bea3", "url": "https://github.com/awslabs/smithy/commit/2e7418e779d5b416db9163f76b2205b90854bea3", "message": "Improve validators through a trait index on model\n\nThis commit is a fairly large update to validators because there's a new\nsuper useful feature on Model where you can now get a Set of shapes that\nhave a specific trait (and the value is cached). This means that a large\nmajority of validators that utilized Trait.flatMapStream can now be much\nmore efficiently written by iterating over the shapes that actually have\nthe trait directly. Lots of validators were updated to take advantage of\nthis and be more efficient (particularly HTTP validators and trait\nconflict validators).\n\nI also noticed that the TraitValueValidator was validating the prelude\nmodel, and that was pretty expensive. I updated this validator to only\nvalidate the prelude when a specific metadata property is set. Then, in\nunit tests, I added a test that ensures that the validator validates the\nprelude so that we can be sure that changes made to the prelude are\nvalid. Because of this change and the trait indexing, JMH shows that the\ntime to load and validate a model was nearly cut in half\n(from about 2ms to 1ms on my old laptop).\n\nI noticed that the UnstableFeatureValidator was still being used on\ndocument shapes even though the spec was updated to remove the\ndisclaimer that document shapes are unstable, so I removed this\nvalidator.", "committedDate": "2020-05-04T18:38:23Z", "type": "commit"}, {"oid": "4b72b40ba0275883c5130efe1e9c101ba75bdcde", "url": "https://github.com/awslabs/smithy/commit/4b72b40ba0275883c5130efe1e9c101ba75bdcde", "message": "Emit node validation events with locations\n\nThis commit rewrites a lot of NodeValidationVisitors to now emit events\nfrom validation plugins and then allow the visitor to associate the\nright context, shape, and severity. This allows the events emitted to\nthe visitor to contain a more specific source location than N/A.", "committedDate": "2020-05-04T18:38:44Z", "type": "commit"}, {"oid": "4b72b40ba0275883c5130efe1e9c101ba75bdcde", "url": "https://github.com/awslabs/smithy/commit/4b72b40ba0275883c5130efe1e9c101ba75bdcde", "message": "Emit node validation events with locations\n\nThis commit rewrites a lot of NodeValidationVisitors to now emit events\nfrom validation plugins and then allow the visitor to associate the\nright context, shape, and severity. This allows the events emitted to\nthe visitor to contain a more specific source location than N/A.", "committedDate": "2020-05-04T18:38:44Z", "type": "forcePushed"}]}