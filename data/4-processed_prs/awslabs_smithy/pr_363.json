{"pr_number": 363, "pr_title": "Update externalDocumentation to a named map", "pr_createdAt": "2020-04-07T22:08:35Z", "pr_url": "https://github.com/awslabs/smithy/pull/363", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY3OTc0MA==", "url": "https://github.com/awslabs/smithy/pull/363#discussion_r405679740", "bodyText": "Should we call this \"Developer Guide\" so that it matches the nomenclature of the referenced docs?", "author": "mtdowling", "createdAt": "2020-04-08T17:07:04Z", "path": "smithy-aws-apigateway-traits/src/main/resources/META-INF/smithy/aws.apigateway.json", "diffHunk": "@@ -8,7 +8,9 @@\n                     \"selector\": \"service\"\n                 },\n                 \"smithy.api#documentation\": \"Specifies the source of the caller identifier that will be used to throttle API methods that require a key.\",\n-                \"smithy.api#externalDocumentation\": \"https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-swagger-extensions-api-key-source.html\",\n+                \"smithy.api#externalDocumentation\": {\n+                    \"User Guide\": \"https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-swagger-extensions-api-key-source.html\"", "originalCommit": "0d78257b61d91b6fba8cbed140e5f61b812cfc64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4MDE0OA==", "url": "https://github.com/awslabs/smithy/pull/363#discussion_r405680148", "bodyText": "I'm going to be renaming these anyways..., but I'd probably just call this openapi.externalDocs.", "author": "mtdowling", "createdAt": "2020-04-08T17:07:45Z", "path": "docs/source/guides/converting-to-openapi.rst", "diffHunk": "@@ -196,6 +196,27 @@ openapi.use.xml (boolean)\n     Enables converting Smithy XML traits to OpenAPI XML properties. (this\n     feature is not yet implemented).\n \n+openapi.use.convertedExternalDocs ([string])", "originalCommit": "0d78257b61d91b6fba8cbed140e5f61b812cfc64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4MTA0Mw==", "url": "https://github.com/awslabs/smithy/pull/363#discussion_r405681043", "bodyText": "Can we add \"Developer Guide\" to this list?\nWhy Api and not API? Since these are arbitrary and meant to be displayed directly, I think we should probably use API.\nIs this list case-insensitive? I think it probably should be. Thoughts?\nShould probably not say \"set of names\", but \"priority ordered list of names\"", "author": "mtdowling", "createdAt": "2020-04-08T17:09:12Z", "path": "docs/source/guides/converting-to-openapi.rst", "diffHunk": "@@ -196,6 +196,27 @@ openapi.use.xml (boolean)\n     Enables converting Smithy XML traits to OpenAPI XML properties. (this\n     feature is not yet implemented).\n \n+openapi.use.convertedExternalDocs ([string])\n+    Limits the source of converted \"externalDocs\" fields to the specified set\n+    of names in an :ref:`externaldocumentation-trait`. By default, this is a\n+    set of the following values: \"Homepage\", \"Api Reference\", \"User Guide\",", "originalCommit": "0d78257b61d91b6fba8cbed140e5f61b812cfc64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4MzAwMA==", "url": "https://github.com/awslabs/smithy/pull/363#discussion_r405683000", "bodyText": "Can this be simplified to: ObjectNode.fromStringMap(urls)", "author": "mtdowling", "createdAt": "2020-04-08T17:12:34Z", "path": "smithy-model/src/main/java/software/amazon/smithy/model/traits/ExternalDocumentationTrait.java", "diffHunk": "@@ -17,37 +17,119 @@\n \n import java.net.MalformedURLException;\n import java.net.URL;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Objects;\n import software.amazon.smithy.model.SourceException;\n import software.amazon.smithy.model.SourceLocation;\n+import software.amazon.smithy.model.node.Node;\n+import software.amazon.smithy.model.node.ObjectNode;\n+import software.amazon.smithy.model.node.StringNode;\n import software.amazon.smithy.model.shapes.ShapeId;\n+import software.amazon.smithy.utils.Pair;\n+import software.amazon.smithy.utils.ToSmithyBuilder;\n \n /**\n- * Provides a link to external documentation of a service or operation.\n+ * Provides named links to external documentation.\n  */\n-public final class ExternalDocumentationTrait extends StringTrait {\n+public final class ExternalDocumentationTrait extends AbstractTrait\n+        implements ToSmithyBuilder<ExternalDocumentationTrait> {\n+\n     public static final ShapeId ID = ShapeId.from(\"smithy.api#externalDocumentation\");\n \n-    public ExternalDocumentationTrait(String value, SourceLocation sourceLocation) {\n-        super(ID, value, sourceLocation);\n-        validateUrl(value, sourceLocation);\n-    }\n+    private final Map<String, String> urls;\n \n-    public ExternalDocumentationTrait(String value) {\n-        this(value, SourceLocation.NONE);\n-    }\n+    public ExternalDocumentationTrait(Builder builder) {\n+        super(ID, builder.sourceLocation);\n+        this.urls = Collections.unmodifiableMap(builder.urls);\n \n-    public static final class Provider extends StringTrait.Provider<ExternalDocumentationTrait> {\n-        public Provider() {\n-            super(ID, ExternalDocumentationTrait::new);\n+        if (urls.isEmpty()) {\n+            throw new SourceException(\"externalDocumentation must have at least one entry\", getSourceLocation());\n         }\n+        urls.forEach((name, url) -> validateUrl(name, url, getSourceLocation()));\n     }\n \n-    private static String validateUrl(String url, SourceLocation location) {\n+    private static String validateUrl(String name, String url, SourceLocation location) {\n         try {\n             new URL(url);\n             return url;\n         } catch (MalformedURLException e) {\n-            throw new SourceException(\"externalDocumentation must be a valid URL. Found \" + url, location);\n+            throw new SourceException(String.format(\"Each externalDocumentation value must be a valid URL. \"\n+                    + \"Found \\\"%s\\\" for name \\\"%s\\\"\", url, name), location);\n+        }\n+    }\n+\n+    /**\n+     * Gets the external documentation names and links.\n+     *\n+     * @return returns the external documentation mapping.\n+     */\n+    public Map<String, String> getUrls() {\n+        return urls;\n+    }\n+\n+    @Override\n+    protected Node createNode() {\n+        return urls.entrySet().stream()", "originalCommit": "0d78257b61d91b6fba8cbed140e5f61b812cfc64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4NDQ0NA==", "url": "https://github.com/awslabs/smithy/pull/363#discussion_r405684444", "bodyText": "I suggest applyinh the @length trait to force it to have > 1 entry", "author": "mtdowling", "createdAt": "2020-04-08T17:14:51Z", "path": "smithy-model/src/main/resources/software/amazon/smithy/model/loader/prelude-traits.smithy", "diffHunk": "@@ -57,7 +57,10 @@ string documentation\n \n /// Provides a link to additional documentation.\n @trait\n-string externalDocumentation\n+map externalDocumentation {", "originalCommit": "0d78257b61d91b6fba8cbed140e5f61b812cfc64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4NDgwNw==", "url": "https://github.com/awslabs/smithy/pull/363#discussion_r405684807", "bodyText": "This validation could be removed and just handled by the model validation process if you add the @length trait to the map in the prelude model.", "author": "mtdowling", "createdAt": "2020-04-08T17:15:23Z", "path": "smithy-model/src/main/java/software/amazon/smithy/model/traits/ExternalDocumentationTrait.java", "diffHunk": "@@ -17,37 +17,119 @@\n \n import java.net.MalformedURLException;\n import java.net.URL;\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Objects;\n import software.amazon.smithy.model.SourceException;\n import software.amazon.smithy.model.SourceLocation;\n+import software.amazon.smithy.model.node.Node;\n+import software.amazon.smithy.model.node.ObjectNode;\n+import software.amazon.smithy.model.node.StringNode;\n import software.amazon.smithy.model.shapes.ShapeId;\n+import software.amazon.smithy.utils.Pair;\n+import software.amazon.smithy.utils.ToSmithyBuilder;\n \n /**\n- * Provides a link to external documentation of a service or operation.\n+ * Provides named links to external documentation.\n  */\n-public final class ExternalDocumentationTrait extends StringTrait {\n+public final class ExternalDocumentationTrait extends AbstractTrait\n+        implements ToSmithyBuilder<ExternalDocumentationTrait> {\n+\n     public static final ShapeId ID = ShapeId.from(\"smithy.api#externalDocumentation\");\n \n-    public ExternalDocumentationTrait(String value, SourceLocation sourceLocation) {\n-        super(ID, value, sourceLocation);\n-        validateUrl(value, sourceLocation);\n-    }\n+    private final Map<String, String> urls;\n \n-    public ExternalDocumentationTrait(String value) {\n-        this(value, SourceLocation.NONE);\n-    }\n+    public ExternalDocumentationTrait(Builder builder) {\n+        super(ID, builder.sourceLocation);\n+        this.urls = Collections.unmodifiableMap(builder.urls);\n \n-    public static final class Provider extends StringTrait.Provider<ExternalDocumentationTrait> {\n-        public Provider() {\n-            super(ID, ExternalDocumentationTrait::new);\n+        if (urls.isEmpty()) {", "originalCommit": "0d78257b61d91b6fba8cbed140e5f61b812cfc64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e0cbe966ae5724fc0cfee1eb7667603509976a44", "url": "https://github.com/awslabs/smithy/commit/e0cbe966ae5724fc0cfee1eb7667603509976a44", "message": "Update externalDocumentation to a named map\n\nThis commit updates the @externalDocumentation trait to be a map of\nnamed urls instead of a single url. This provides more context for\nthe given links and enables the ability to have multiple links per\ntrait application.\n\nAn update to the OpenApi conversion has been made to utilize this\nwhen populating \"externalDocs\" fields. A configurable, priority\nordered list of url names is available through\n`\"openapi.externalDocs\"`; it defaults to \"Homepage\", \"Api\nReference\", \"User Guide\", \"Developer Guide\", \"Reference\", and\n\"Guide\". This list is compared case insensitively. This also\nfixes an issue where \"externalDocs\" fields could be generated as\nstrings instead of the properly formatted external documentation\nobject in the resulting OpenApi document.", "committedDate": "2020-04-08T19:31:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2NjQzNA==", "url": "https://github.com/awslabs/smithy/pull/363#discussion_r405766434", "bodyText": "Need to add \"Developer Guide\" here.", "author": "mtdowling", "createdAt": "2020-04-08T19:37:18Z", "path": "docs/source/guides/converting-to-openapi.rst", "diffHunk": "@@ -196,6 +196,28 @@ openapi.use.xml (boolean)\n     Enables converting Smithy XML traits to OpenAPI XML properties. (this\n     feature is not yet implemented).\n \n+openapi.externalDocs ([string])\n+    Limits the source of converted \"externalDocs\" fields to the specified\n+    priority ordered list of names in an :ref:`externaldocumentation-trait`.\n+    This list is case insensitive. By default, this is a list of the following\n+    values: \"Homepage\", \"API Reference\", \"User Guide\", \"Reference\", and", "originalCommit": "e0cbe966ae5724fc0cfee1eb7667603509976a44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2NzM5Ng==", "url": "https://github.com/awslabs/smithy/pull/363#discussion_r405767396", "bodyText": "\ud83e\udd26\u200d\u2642\ufe0f", "author": "kstich", "createdAt": "2020-04-08T19:39:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2NjQzNA=="}], "type": "inlineReview"}, {"oid": "86bdb975f6190ad1e7dc8442d914ba2a7bc173d0", "url": "https://github.com/awslabs/smithy/commit/86bdb975f6190ad1e7dc8442d914ba2a7bc173d0", "message": "Update externalDocumentation to a named map\n\nThis commit updates the @externalDocumentation trait to be a map of\nnamed urls instead of a single url. This provides more context for\nthe given links and enables the ability to have multiple links per\ntrait application.\n\nAn update to the OpenApi conversion has been made to utilize this\nwhen populating \"externalDocs\" fields. A configurable, priority\nordered list of url names is available through\n`\"openapi.externalDocs\"`; it defaults to \"Homepage\", \"Api\nReference\", \"User Guide\", \"Developer Guide\", \"Reference\", and\n\"Guide\". This list is compared case insensitively. This also\nfixes an issue where \"externalDocs\" fields could be generated as\nstrings instead of the properly formatted external documentation\nobject in the resulting OpenApi document.", "committedDate": "2020-04-08T19:38:14Z", "type": "commit"}, {"oid": "86bdb975f6190ad1e7dc8442d914ba2a7bc173d0", "url": "https://github.com/awslabs/smithy/commit/86bdb975f6190ad1e7dc8442d914ba2a7bc173d0", "message": "Update externalDocumentation to a named map\n\nThis commit updates the @externalDocumentation trait to be a map of\nnamed urls instead of a single url. This provides more context for\nthe given links and enables the ability to have multiple links per\ntrait application.\n\nAn update to the OpenApi conversion has been made to utilize this\nwhen populating \"externalDocs\" fields. A configurable, priority\nordered list of url names is available through\n`\"openapi.externalDocs\"`; it defaults to \"Homepage\", \"Api\nReference\", \"User Guide\", \"Developer Guide\", \"Reference\", and\n\"Guide\". This list is compared case insensitively. This also\nfixes an issue where \"externalDocs\" fields could be generated as\nstrings instead of the properly formatted external documentation\nobject in the resulting OpenApi document.", "committedDate": "2020-04-08T19:38:14Z", "type": "forcePushed"}]}