{"pr_number": 3086, "pr_title": "make suggester popularity tests wait on rebuild", "pr_createdAt": "2020-03-23T15:37:17Z", "pr_url": "https://github.com/oracle/opengrok/pull/3086", "timeline": [{"oid": "c311939381c2ab3089cb0105d488c31d4abd2238", "url": "https://github.com/oracle/opengrok/commit/c311939381c2ab3089cb0105d488c31d4abd2238", "message": "add TestCasePrinterRule and use it in SuggesterControllerTest", "committedDate": "2020-03-30T20:21:44Z", "type": "commit"}, {"oid": "f4c242759f69570144f88240e8646290785a269c", "url": "https://github.com/oracle/opengrok/commit/f4c242759f69570144f88240e8646290785a269c", "message": "re-enable testGetSuggestionsMultipleProjects()", "committedDate": "2020-03-30T20:21:44Z", "type": "commit"}, {"oid": "67e73b199286d16dcdec62d67b3511d2974abc09", "url": "https://github.com/oracle/opengrok/commit/67e73b199286d16dcdec62d67b3511d2974abc09", "message": "make increaseSearchCount() testable", "committedDate": "2020-03-30T20:21:44Z", "type": "commit"}, {"oid": "cbdacc7d9d9d659359af452a91371a3feaf4b8a4", "url": "https://github.com/oracle/opengrok/commit/cbdacc7d9d9d659359af452a91371a3feaf4b8a4", "message": "add increaseSearchCount() definition that can wait on the suggester lock", "committedDate": "2020-03-30T20:21:44Z", "type": "commit"}, {"oid": "80afad3b3c0bea4c47c6f42d79e1a1a14c94ea88", "url": "https://github.com/oracle/opengrok/commit/80afad3b3c0bea4c47c6f42d79e1a1a14c94ea88", "message": "add method to wait for suggester rebuild synchronously", "committedDate": "2020-03-30T20:21:44Z", "type": "commit"}, {"oid": "80afad3b3c0bea4c47c6f42d79e1a1a14c94ea88", "url": "https://github.com/oracle/opengrok/commit/80afad3b3c0bea4c47c6f42d79e1a1a14c94ea88", "message": "add method to wait for suggester rebuild synchronously", "committedDate": "2020-03-30T20:21:44Z", "type": "forcePushed"}, {"oid": "09f890ac8915d29776f1e7924cfd158a859913ba", "url": "https://github.com/oracle/opengrok/commit/09f890ac8915d29776f1e7924cfd158a859913ba", "message": "rename variable to match the use", "committedDate": "2020-03-31T09:55:30Z", "type": "commit"}, {"oid": "c3020c9d7f364dff0c8988517263441ce1bd32fa", "url": "https://github.com/oracle/opengrok/commit/c3020c9d7f364dff0c8988517263441ce1bd32fa", "message": "add method to wait for suggester init", "committedDate": "2020-03-31T09:55:30Z", "type": "commit"}, {"oid": "c98fe320dd1974fc341e89c1cc3142e0463f1c25", "url": "https://github.com/oracle/opengrok/commit/c98fe320dd1974fc341e89c1cc3142e0463f1c25", "message": "fix waitForRebuild() comment", "committedDate": "2020-03-31T09:55:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg4NzExMQ==", "url": "https://github.com/oracle/opengrok/pull/3086#discussion_r400887111", "bodyText": "Is it needed?", "author": "ahornace", "createdAt": "2020-03-31T12:51:20Z", "path": "suggester/src/main/java/org/opengrok/suggest/Suggester.java", "diffHunk": "@@ -234,6 +249,11 @@ public void rebuild(final Collection<NamedIndexDir> indexDirs) {\n             return;\n         }\n \n+        // for testing", "originalCommit": "c98fe320dd1974fc341e89c1cc3142e0463f1c25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5ODUwMw==", "url": "https://github.com/oracle/opengrok/pull/3086#discussion_r400898503", "bodyText": "you mean the comment ?", "author": "vladak", "createdAt": "2020-03-31T13:08:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg4NzExMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzOTkzNA==", "url": "https://github.com/oracle/opengrok/pull/3086#discussion_r401139934", "bodyText": "Yes, it is in the PR at least 3 times. This kind of comment indicates that the code should be removed in production code.", "author": "ahornace", "createdAt": "2020-03-31T18:52:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg4NzExMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0MDIwNg==", "url": "https://github.com/oracle/opengrok/pull/3086#discussion_r401140206", "bodyText": "Missing newline.", "author": "ahornace", "createdAt": "2020-03-31T18:53:25Z", "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/util/TestCasePrinterRule.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+// taken from https://technicaltesting.wordpress.com/2012/10/23/junit-rule-for-printing-test-case-start-and-end-information/\n+\n+package org.opengrok.indexer.util;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.text.DecimalFormat;\n+\n+import org.junit.rules.ExternalResource;\n+import org.junit.rules.TestRule;\n+import org.junit.runner.Description;\n+import org.junit.runners.model.Statement;\n+\n+public class TestCasePrinterRule implements TestRule {\n+\n+    private OutputStream out;\n+    private final TestCasePrinter printer = new TestCasePrinter();\n+\n+    private String beforeContent = null;\n+    private String afterContent = null;\n+    private long timeStart;\n+\n+    public TestCasePrinterRule() {\n+        this(System.out);\n+    }\n+\n+    public TestCasePrinterRule(OutputStream os) {\n+        out = os;\n+    }\n+\n+    private class TestCasePrinter extends ExternalResource {\n+        @Override\n+        protected void before() throws Throwable {\n+            timeStart = System.currentTimeMillis();\n+            out.write(beforeContent.getBytes());\n+        }\n+\n+        @Override\n+        protected void after() {\n+            try {\n+                long timeEnd = System.currentTimeMillis();\n+                double seconds = (timeEnd - timeStart) / 1000.0;\n+                out.write((afterContent + \"Time elapsed: \" + new DecimalFormat(\"0.000\").format(seconds) + \" sec\\n\").\n+                        getBytes());\n+            } catch (IOException ioe) { /* ignore */\n+            }\n+        }\n+    }\n+\n+    private static String getClassBasename(String inputName) {\n+        int idx;\n+        if (((idx = inputName.lastIndexOf('.')) > 0) && (idx < inputName.length())) {\n+            return inputName.substring(idx + 1);\n+        } else {\n+            return inputName;\n+        }\n+    }\n+\n+    public final Statement apply(Statement statement, Description description) {\n+        final String testDescription = getClassBasename(description.getClassName()) + \"#\" +  description.getMethodName();\n+        beforeContent = String.format(\"\\n[TEST START: %s]\\n\", testDescription);\n+        afterContent =  String.format(\"[TEST ENDED: %s] \", testDescription);\n+        return printer.apply(statement, description);\n+    }\n+}", "originalCommit": "c98fe320dd1974fc341e89c1cc3142e0463f1c25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ0NDU4Mw==", "url": "https://github.com/oracle/opengrok/pull/3086#discussion_r401444583", "bodyText": "it will be printed in after().", "author": "vladak", "createdAt": "2020-04-01T08:33:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0MDIwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0MDUzMg==", "url": "https://github.com/oracle/opengrok/pull/3086#discussion_r401140532", "bodyText": "Should be volatile.", "author": "ahornace", "createdAt": "2020-03-31T18:53:54Z", "path": "suggester/src/main/java/org/opengrok/suggest/Suggester.java", "diffHunk": "@@ -87,6 +91,12 @@\n \n     private final int rebuildParallelismLevel;\n \n+    private boolean rebuilding;", "originalCommit": "c98fe320dd1974fc341e89c1cc3142e0463f1c25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ0MzQ4OQ==", "url": "https://github.com/oracle/opengrok/pull/3086#discussion_r401443489", "bodyText": "I assume this is done so that it is not optimized away ?", "author": "vladak", "createdAt": "2020-04-01T08:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0MDUzMg=="}], "type": "inlineReview"}, {"oid": "438884a5e3a8949f5cdd7628dc69baba3fc8a490", "url": "https://github.com/oracle/opengrok/commit/438884a5e3a8949f5cdd7628dc69baba3fc8a490", "message": "fix comments per @ahornace", "committedDate": "2020-04-01T09:17:23Z", "type": "commit"}, {"oid": "d9eba95a9c0cdbbb43a0d86cfb8a620336383f28", "url": "https://github.com/oracle/opengrok/commit/d9eba95a9c0cdbbb43a0d86cfb8a620336383f28", "message": "make the rebuilding boolean volatile", "committedDate": "2020-04-01T09:17:23Z", "type": "commit"}, {"oid": "d9eba95a9c0cdbbb43a0d86cfb8a620336383f28", "url": "https://github.com/oracle/opengrok/commit/d9eba95a9c0cdbbb43a0d86cfb8a620336383f28", "message": "make the rebuilding boolean volatile", "committedDate": "2020-04-01T09:17:23Z", "type": "forcePushed"}]}