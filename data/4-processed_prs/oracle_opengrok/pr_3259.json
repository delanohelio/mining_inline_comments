{"pr_number": 3259, "pr_title": "Fail CommandSequence if RESTful call fails", "pr_createdAt": "2020-10-04T19:33:39Z", "pr_url": "https://github.com/oracle/opengrok/pull/3259", "timeline": [{"oid": "cfca80f42eef9b03f093eafffe5464c399fd04ba", "url": "https://github.com/oracle/opengrok/commit/cfca80f42eef9b03f093eafffe5464c399fd04ba", "message": "fail CommandSequence processing if RESTful call fails\n\nfixes #3026", "committedDate": "2020-10-04T19:36:26Z", "type": "commit"}, {"oid": "cfca80f42eef9b03f093eafffe5464c399fd04ba", "url": "https://github.com/oracle/opengrok/commit/cfca80f42eef9b03f093eafffe5464c399fd04ba", "message": "fail CommandSequence processing if RESTful call fails\n\nfixes #3026", "committedDate": "2020-10-04T19:36:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4MTY0NA==", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499281644", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if self.outputs.get(cmd):\n          \n          \n            \n                        for line in self.outputs[cmd]:\n          \n          \n            \n                            str += '{}{}'.format(indent, line)\n          \n          \n            \n                    for line in self.outputs.get(cmd, []):\n          \n          \n            \n                        str += '{}{}'.format(indent, line)", "author": "eric-saintetienne", "createdAt": "2020-10-04T19:43:39Z", "path": "opengrok-tools/src/main/python/opengrok_tools/utils/commandsequence.py", "diffHunk": "@@ -60,7 +64,7 @@ def __str__(self):\n \n     def get_cmd_output(self, cmd, indent=\"\"):\n         str = \"\"\n-        if self.outputs[cmd]:\n+        if self.outputs.get(cmd):\n             for line in self.outputs[cmd]:\n                 str += '{}{}'.format(indent, line)", "originalCommit": "cfca80f42eef9b03f093eafffe5464c399fd04ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4MTk4Ng==", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499281986", "bodyText": "A lot of repetitions here, wouldn't it make sense to factor the common code into a single function (named, say request) that all verbs would call?", "author": "eric-saintetienne", "createdAt": "2020-10-04T19:47:43Z", "path": "opengrok-tools/src/main/python/opengrok_tools/utils/webutil.py", "diffHunk": "@@ -27,45 +27,23 @@\n \n \n def get(logger, uri, params=None, headers=None):\n-    try:\n-        proxies = get_proxies(uri)\n-        return requests.get(uri, params=params, proxies=proxies)\n-    except Exception:\n-        logger.debug(traceback.format_exc())\n-        return None\n+    proxies = get_proxies(uri)", "originalCommit": "cfca80f42eef9b03f093eafffe5464c399fd04ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5Mjc1OQ==", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499292759", "bodyText": "refactored. I could possibly go as far as making do_api_call() to use requests.__dict__ lookup the function names.", "author": "vladak", "createdAt": "2020-10-04T21:52:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4MTk4Ng=="}], "type": "inlineReview"}, {"oid": "ab4931e74fef78b31dc81d41d85d51ca7f76d002", "url": "https://github.com/oracle/opengrok/commit/ab4931e74fef78b31dc81d41d85d51ca7f76d002", "message": "review comment\n\nCo-authored-by: ericsaintetienne <eric.saintetienne@gmail.com>", "committedDate": "2020-10-04T20:41:58Z", "type": "commit"}, {"oid": "dab18f0c6b3246d9c00215ad77d58cfccc646a8c", "url": "https://github.com/oracle/opengrok/commit/dab18f0c6b3246d9c00215ad77d58cfccc646a8c", "message": "reduce repeated code", "committedDate": "2020-10-04T21:50:33Z", "type": "commit"}, {"oid": "62052fbc3e01944d057174b6c8a285080ac4c86c", "url": "https://github.com/oracle/opengrok/commit/62052fbc3e01944d057174b6c8a285080ac4c86c", "message": "use getattr() to lookup method function name", "committedDate": "2020-10-04T21:58:53Z", "type": "commit"}, {"oid": "76e40a062831d4ba91cd44dce1e31dd81807659f", "url": "https://github.com/oracle/opengrok/commit/76e40a062831d4ba91cd44dce1e31dd81807659f", "message": "shorten line", "committedDate": "2020-10-04T22:02:31Z", "type": "commit"}, {"oid": "77867ea897954bfe53ffd1608c68d3ba8b5c0678", "url": "https://github.com/oracle/opengrok/commit/77867ea897954bfe53ffd1608c68d3ba8b5c0678", "message": "remove blank line", "committedDate": "2020-10-04T22:02:43Z", "type": "commit"}, {"oid": "27369e7af2d2b348c194b13e8a2d0c9a1c3a03d4", "url": "https://github.com/oracle/opengrok/commit/27369e7af2d2b348c194b13e8a2d0c9a1c3a03d4", "message": "shorten lines", "committedDate": "2020-10-04T22:04:08Z", "type": "commit"}, {"oid": "a94d709d54597012aaddbd54ead39b177de5e4ab", "url": "https://github.com/oracle/opengrok/commit/a94d709d54597012aaddbd54ead39b177de5e4ab", "message": "use callable", "committedDate": "2020-10-04T22:08:43Z", "type": "commit"}, {"oid": "98eae593f28b9f76c67e7d87a36bec6483b79ee0", "url": "https://github.com/oracle/opengrok/commit/98eae593f28b9f76c67e7d87a36bec6483b79ee0", "message": "add missing argument", "committedDate": "2020-10-04T22:09:25Z", "type": "commit"}, {"oid": "ae9c08a0e45a638ab10ddec9ca6e733948f546e8", "url": "https://github.com/oracle/opengrok/commit/ae9c08a0e45a638ab10ddec9ca6e733948f546e8", "message": "remove verb check", "committedDate": "2020-10-05T06:44:03Z", "type": "commit"}, {"oid": "1d619ca92928bc9dcc0312025c2d719406db4620", "url": "https://github.com/oracle/opengrok/commit/1d619ca92928bc9dcc0312025c2d719406db4620", "message": "fix result handling, add test", "committedDate": "2020-10-05T12:32:27Z", "type": "commit"}, {"oid": "6b847fa80c5c690ab597184ee47825d38a768d23", "url": "https://github.com/oracle/opengrok/commit/6b847fa80c5c690ab597184ee47825d38a768d23", "message": "propagate check() return code to program exit code", "committedDate": "2020-10-05T12:39:59Z", "type": "commit"}, {"oid": "cf396e409776f8fded2ef041e9a2328d606c50a2", "url": "https://github.com/oracle/opengrok/commit/cf396e409776f8fded2ef041e9a2328d606c50a2", "message": "add blank", "committedDate": "2020-10-05T12:45:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxMDI5Mw==", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499610293", "bodyText": "I believe you can pass the handler directly as do_api_call('http:/...', requests.put, ... ) which could simplify the code around it", "author": "tulinkry", "createdAt": "2020-10-05T13:46:02Z", "path": "opengrok-tools/src/main/python/opengrok_tools/utils/restful.py", "diffHunk": "@@ -18,31 +18,27 @@\n #\n \n #\n-# Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.\n+# Copyright (c) 2017, 2020, Oracle and/or its affiliates. All rights reserved.\n #\n \n import logging\n import json\n+import requests\n \n-from .webutil import put, post, delete\n+from .webutil import get_proxies\n from .patterns import COMMAND_PROPERTY\n \n \n CONTENT_TYPE = 'Content-Type'\n APPLICATION_JSON = 'application/json'   # default\n \n \n-def do_api_call(command, uri, verb, headers, data):\n-    verbs = {\n-        'PUT': put,\n-        'POST': post,\n-        'DELETE': delete\n-    }\n-    handler = verbs.get(verb)\n-    if handler is not None:\n-        logger = logging.getLogger(__name__)\n-        return handler(logger, uri, headers=headers, data=data)\n-    raise Exception('Unknown HTTP verb in command {}'.format(command))\n+def do_api_call(uri, verb, headers=None, data=None):", "originalCommit": "cf396e409776f8fded2ef041e9a2328d606c50a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxMjA5NA==", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499612094", "bodyText": "Also I would switch the order to verb -> uri as that is the usual order", "author": "tulinkry", "createdAt": "2020-10-05T13:48:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxMDI5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0MDgyMg==", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499640822", "bodyText": "Passing the handler directly would be arguably more error prone + would need a dependency in the callers + is longer to type.", "author": "vladak", "createdAt": "2020-10-05T14:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxMDI5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0NzAzNQ==", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499647035", "bodyText": "changed the signature to use verb first.", "author": "vladak", "createdAt": "2020-10-05T14:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxMDI5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxMzUwOA==", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499613508", "bodyText": "here the level is error but for other commands it is info (below)", "author": "tulinkry", "createdAt": "2020-10-05T13:50:25Z", "path": "opengrok-tools/src/main/python/opengrok_tools/utils/commandsequence.py", "diffHunk": "@@ -156,7 +165,11 @@ def run_cleanup(self):\n \n         for cleanup_cmd in self.cleanup:\n             if is_web_uri(cleanup_cmd.get(COMMAND_PROPERTY)[0]):\n-                call_rest_api(cleanup_cmd, PROJECT_SUBST, self.name)\n+                try:\n+                    call_rest_api(cleanup_cmd, PROJECT_SUBST, self.name)\n+                except HTTPError as e:\n+                    self.logger.error(\"RESTful command {} failed: {}\".", "originalCommit": "cf396e409776f8fded2ef041e9a2328d606c50a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYzOTcyMg==", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499639722", "bodyText": "should be fixed.", "author": "vladak", "createdAt": "2020-10-05T14:26:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxMzUwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNTA2OQ==", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499615069", "bodyText": "missing break? the else branch has it", "author": "tulinkry", "createdAt": "2020-10-05T13:52:31Z", "path": "opengrok-tools/src/main/python/opengrok_tools/utils/commandsequence.py", "diffHunk": "@@ -106,12 +109,18 @@ def run(self):\n         argument list of the command.\n \n         Any command entry that is a URI, will be used to submit RESTful API\n-        request. Return codes for these requests are not checked.\n+        request.\n         \"\"\"\n \n         for command in self.commands:\n             if is_web_uri(command.get(COMMAND_PROPERTY)[0]):\n-                call_rest_api(command, PROJECT_SUBST, self.name)\n+                try:\n+                    call_rest_api(command, PROJECT_SUBST, self.name)\n+                except HTTPError as e:\n+                    self.logger.error(\"RESTful command {} failed: {}\".\n+                                      format(command, e))\n+                    self.failed = True\n+                    self.retcodes[str(command)] = FAILURE_EXITVAL", "originalCommit": "cf396e409776f8fded2ef041e9a2328d606c50a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0ODA4Mw==", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499648083", "bodyText": "good catch. The RESTful calls should be equally handled.", "author": "vladak", "createdAt": "2020-10-05T14:38:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNTA2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNTgzMA==", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499615830", "bodyText": "!= SUCCESS_EXITVAL?", "author": "tulinkry", "createdAt": "2020-10-05T13:53:33Z", "path": "opengrok-tools/src/main/python/opengrok_tools/sync.py", "diffHunk": "@@ -109,7 +111,11 @@ def do_sync(args, commands, config, directory, dirs_to_process, ignore_errors,\n                 cmds = CommandSequence(cmds_base)\n                 cmds.fill(cmds_base.retcodes, cmds_base.outputs,\n                           cmds_base.failed)\n-                cmds.check(ignore_errors)\n+                r = cmds.check(ignore_errors)\n+                if r != 0:", "originalCommit": "cf396e409776f8fded2ef041e9a2328d606c50a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYzODIxNg==", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499638216", "bodyText": "yep", "author": "vladak", "createdAt": "2020-10-05T14:24:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNTgzMA=="}], "type": "inlineReview"}, {"oid": "f55cfbf2d1d23c2434ac971605b2c1b539716ad5", "url": "https://github.com/oracle/opengrok/commit/f55cfbf2d1d23c2434ac971605b2c1b539716ad5", "message": "use SUCCESS_EXITVAL", "committedDate": "2020-10-05T14:24:41Z", "type": "commit"}, {"oid": "0a773fd437506d97c8a047c24246335cb0966e9b", "url": "https://github.com/oracle/opengrok/commit/0a773fd437506d97c8a047c24246335cb0966e9b", "message": "use error level consistently", "committedDate": "2020-10-05T14:26:41Z", "type": "commit"}, {"oid": "5496ee5f709f7fce7ff0ffe20a0bcfcc242b8015", "url": "https://github.com/oracle/opengrok/commit/5496ee5f709f7fce7ff0ffe20a0bcfcc242b8015", "message": "change do_api_call() signature to use verb first", "committedDate": "2020-10-05T14:36:26Z", "type": "commit"}, {"oid": "353c0b1f1e2d3d0fefaf3be51ea48c902da4db0e", "url": "https://github.com/oracle/opengrok/commit/353c0b1f1e2d3d0fefaf3be51ea48c902da4db0e", "message": "break the cycle on restful failure", "committedDate": "2020-10-05T14:37:36Z", "type": "commit"}]}