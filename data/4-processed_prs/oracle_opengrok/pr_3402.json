{"pr_number": 3402, "pr_title": "Docker script refactoring and rewrite to Python", "pr_createdAt": "2020-12-14T09:35:49Z", "pr_url": "https://github.com/oracle/opengrok/pull/3402", "timeline": [{"oid": "960d5698c74c45b497b0ef271c02a9b074c68418", "url": "https://github.com/oracle/opengrok/commit/960d5698c74c45b497b0ef271c02a9b074c68418", "message": "refactor to avoid special casing", "committedDate": "2021-02-08T15:27:32Z", "type": "commit"}, {"oid": "fab2dc4592042b66e4e6cd37e8dc598fde02a945", "url": "https://github.com/oracle/opengrok/commit/fab2dc4592042b66e4e6cd37e8dc598fde02a945", "message": "add CDDL", "committedDate": "2021-02-08T15:27:32Z", "type": "commit"}, {"oid": "55336778ed7f9257a9611f2cb65f126404953e1a", "url": "https://github.com/oracle/opengrok/commit/55336778ed7f9257a9611f2cb65f126404953e1a", "message": "add locking", "committedDate": "2021-02-08T15:27:32Z", "type": "commit"}, {"oid": "6a2a24f0694b4d755568bef4f62c836879bb2329", "url": "https://github.com/oracle/opengrok/commit/6a2a24f0694b4d755568bef4f62c836879bb2329", "message": "use opengrok-sync\n\nfixes #3221", "committedDate": "2021-02-08T15:27:33Z", "type": "commit"}, {"oid": "1878fc60334d2e862501969f3a44a7c367fb8fe4", "url": "https://github.com/oracle/opengrok/commit/1878fc60334d2e862501969f3a44a7c367fb8fe4", "message": "cleanup, add TODO/comments", "committedDate": "2021-02-08T15:27:33Z", "type": "commit"}, {"oid": "cd4b901c6983459d40fb564fe7d85e571ceb06a2", "url": "https://github.com/oracle/opengrok/commit/cd4b901c6983459d40fb564fe7d85e571ceb06a2", "message": "replace URIs in sync configuration", "committedDate": "2021-02-08T15:27:33Z", "type": "commit"}, {"oid": "01c3090b582f17e3312bda3a308a78eed098effb", "url": "https://github.com/oracle/opengrok/commit/01c3090b582f17e3312bda3a308a78eed098effb", "message": "fix option append", "committedDate": "2021-02-08T15:27:33Z", "type": "commit"}, {"oid": "a8131058cf8bdf77d458e4503b81cc2004f09384", "url": "https://github.com/oracle/opengrok/commit/a8131058cf8bdf77d458e4503b81cc2004f09384", "message": "make sure URI ends with slash", "committedDate": "2021-02-08T15:27:33Z", "type": "commit"}, {"oid": "2dd2ae10b989936c54b781e99171409ce72bad25", "url": "https://github.com/oracle/opengrok/commit/2dd2ae10b989936c54b781e99171409ce72bad25", "message": "avoid null pointer exception", "committedDate": "2021-02-08T15:27:33Z", "type": "commit"}, {"oid": "a083c180ab80b9f9ea173b2af32aca7253365924", "url": "https://github.com/oracle/opengrok/commit/a083c180ab80b9f9ea173b2af32aca7253365924", "message": "prepare programs executed from Docker to be callable from Python directly", "committedDate": "2021-02-08T15:27:33Z", "type": "commit"}, {"oid": "3d7585749e2f2f03e4ea80386efa503fc0b2f7f6", "url": "https://github.com/oracle/opengrok/commit/3d7585749e2f2f03e4ea80386efa503fc0b2f7f6", "message": "rewrite main Docker script to Python\n\nfixes #3403", "committedDate": "2021-02-08T15:27:33Z", "type": "forcePushed"}, {"oid": "4e363f9c9d28bf78660f28dfefe3e5d34c592557", "url": "https://github.com/oracle/opengrok/commit/4e363f9c9d28bf78660f28dfefe3e5d34c592557", "message": "rewrite main Docker script to Python\n\nfixes #3403", "committedDate": "2021-02-08T15:33:30Z", "type": "commit"}, {"oid": "4e363f9c9d28bf78660f28dfefe3e5d34c592557", "url": "https://github.com/oracle/opengrok/commit/4e363f9c9d28bf78660f28dfefe3e5d34c592557", "message": "rewrite main Docker script to Python\n\nfixes #3403", "committedDate": "2021-02-08T15:33:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjE3NDMzOA==", "url": "https://github.com/oracle/opengrok/pull/3402#discussion_r572174338", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (map.get(project) != null) {\n          \n          \n            \n                            if (map.containsKey(project)) {\n          \n      \n    \n    \n  \n\nI think this is nicer :)", "author": "ahornace", "createdAt": "2021-02-08T16:15:04Z", "path": "opengrok-web/src/main/java/org/opengrok/web/api/v1/controller/ProjectsController.java", "diffHunk": "@@ -118,9 +118,11 @@ public Response addProject(String projectName) {\n                     }\n                 }\n                 // deleted repository\n-                for (RepositoryInfo repo : map.get(project)) {\n-                    if (!repos.contains(repo)) {\n-                        allrepos.remove(repo);\n+                if (map.get(project) != null) {", "originalCommit": "4e363f9c9d28bf78660f28dfefe3e5d34c592557", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cb14dfa1abed3310a5277ca85bee3789a9136327", "url": "https://github.com/oracle/opengrok/commit/cb14dfa1abed3310a5277ca85bee3789a9136327", "message": "use containsKey()\n\nCo-authored-by: Adam Horn\u00e1\u010dek <adam.hornacek@icloud.com>", "committedDate": "2021-02-08T16:20:30Z", "type": "commit"}, {"oid": "9c9736280cb7207d312fa5ac4ca801356e28136b", "url": "https://github.com/oracle/opengrok/commit/9c9736280cb7207d312fa5ac4ca801356e28136b", "message": "fix check()", "committedDate": "2021-02-08T16:26:47Z", "type": "commit"}, {"oid": "127f4eae2bf927a37a3f658096dc431812f4c9df", "url": "https://github.com/oracle/opengrok/commit/127f4eae2bf927a37a3f658096dc431812f4c9df", "message": "restore original driveon behavior", "committedDate": "2021-02-08T16:30:40Z", "type": "commit"}, {"oid": "7bfc1ba9b3ab60d0c82c6429532f3933e29a262c", "url": "https://github.com/oracle/opengrok/commit/7bfc1ba9b3ab60d0c82c6429532f3933e29a262c", "message": "import sys", "committedDate": "2021-02-08T16:32:33Z", "type": "commit"}, {"oid": "55b12fc70940242cf417183d3eb03ff5da82c6f7", "url": "https://github.com/oracle/opengrok/commit/55b12fc70940242cf417183d3eb03ff5da82c6f7", "message": "fix indent", "committedDate": "2021-02-08T16:34:27Z", "type": "commit"}, {"oid": "0b925f3096ea6ef985c3cf8c9ac7ba646e81edde", "url": "https://github.com/oracle/opengrok/commit/0b925f3096ea6ef985c3cf8c9ac7ba646e81edde", "message": "pylint fixes", "committedDate": "2021-02-08T16:41:52Z", "type": "commit"}, {"oid": "5e74a997504c30bbad48a82ecb95db13c1758f9a", "url": "https://github.com/oracle/opengrok/commit/5e74a997504c30bbad48a82ecb95db13c1758f9a", "message": "introduce main()", "committedDate": "2021-02-08T16:55:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODY2NDg3MQ==", "url": "https://github.com/oracle/opengrok/pull/3402#discussion_r578664871", "bodyText": "What about this #TODO?", "author": "ahornace", "createdAt": "2021-02-18T18:47:49Z", "path": "tools/src/main/python/opengrok_tools/reindex_project.py", "diffHunk": "@@ -75,50 +75,68 @@ def get_config_file(logger, uri):\n def main():\n     parser = argparse.ArgumentParser(description='OpenGrok indexer wrapper '\n                                                  'for indexing single project',\n-                                     parents=[get_java_parser()])\n-    parser.add_argument('-t', '--template', required=True,\n+                                     parents=[get_java_parser()],\n+                                     prog=sys.argv[0])\n+    parser.add_argument('-t', '--template',\n                         help='Logging template file')\n-    parser.add_argument('-p', '--pattern', required=True,\n+    parser.add_argument('-p', '--pattern',\n                         help='Pattern to substitute in logging template with'\n                              'project name')\n     parser.add_argument('-P', '--project', required=True,\n                         help='Project name')\n-    parser.add_argument('-d', '--directory', required=True,\n+    parser.add_argument('-d', '--directory',\n                         help='Logging directory')\n     parser.add_argument('-U', '--uri', default='http://localhost:8080/source',\n                         help='URI of the webapp with context path')\n+    parser.add_argument('--printoutput', action='store_true', default=False)\n+\n+    cmd_args = sys.argv[1:]\n+    extra_opts = os.environ.get(\"OPENGROK_INDEXER_OPTIONAL_ARGS\")\n+    if extra_opts:\n+        cmd_args.extend(extra_opts.split())\n \n     try:\n-        args = parser.parse_args()\n+        args = parser.parse_args(cmd_args)\n     except ValueError as e:\n         fatal(e)\n \n     logger = get_console_logger(get_class_basename(), args.loglevel)\n \n+    logger.debug('Command arguments extended with {}'.format(extra_opts))\n+\n     # Make sure the log directory exists.\n-    if not os.path.isdir(args.directory):\n-        os.makedirs(args.directory)\n+    if args.directory:\n+        if not os.path.isdir(args.directory):\n+            os.makedirs(args.directory)\n \n     # Get files needed for per-project reindex.\n     conf_file = get_config_file(logger, args.uri)\n-    logprop_file = get_logprop_file(logger, args.template, args.pattern,\n-                                    args.project)\n+    logprop_file = None\n+    if args.template and args.pattern:\n+        logprop_file = get_logprop_file(logger, args.template, args.pattern,\n+                                        args.project)\n \n     # Reindex with the modified logging.properties file and read-only config.\n     command = ['-R', conf_file]\n     command.extend(args.options)\n     java_opts = []\n     if args.java_opts:\n         java_opts.extend(args.java_opts)\n-    java_opts.append(\"-Djava.util.logging.config.file={}\".\n-                     format(logprop_file))\n+    if logprop_file:\n+        java_opts.append(\"-Djava.util.logging.config.file={}\".\n+                         format(logprop_file))\n     indexer = Indexer(command, logger=logger, jar=args.jar,\n                       java=args.java, java_opts=java_opts,\n                       env_vars=args.environment, doprint=args.doprint)\n     indexer.execute()\n     ret = indexer.getretcode()\n     os.remove(conf_file)\n-    os.remove(logprop_file)\n+    if logprop_file:\n+        os.remove(logprop_file)\n+\n+    # TODO", "originalCommit": "5e74a997504c30bbad48a82ecb95db13c1758f9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTE2MTcyOA==", "url": "https://github.com/oracle/opengrok/pull/3402#discussion_r579161728", "bodyText": "That still needs addressing. Like it is now it would print the output twice on failure.", "author": "vladak", "createdAt": "2021-02-19T12:51:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODY2NDg3MQ=="}], "type": "inlineReview"}, {"oid": "3bcededd7d5a19a339d3c80cccb659bce4c396aa", "url": "https://github.com/oracle/opengrok/commit/3bcededd7d5a19a339d3c80cccb659bce4c396aa", "message": "avoid printing the output twice", "committedDate": "2021-02-19T12:52:29Z", "type": "commit"}]}