{"pr_number": 3025, "pr_title": "fix timeout inheritance in mirror.py", "pr_createdAt": "2020-01-17T10:30:32Z", "pr_url": "https://github.com/oracle/opengrok/pull/3025", "timeline": [{"oid": "423b01cbbe2850a1aee178743e89e8047d526784", "url": "https://github.com/oracle/opengrok/commit/423b01cbbe2850a1aee178743e89e8047d526784", "message": "add basic tests\n\n- per-project timeouts in mirror_project()\n- basic repository factory test", "committedDate": "2020-01-17T10:04:46Z", "type": "commit"}, {"oid": "f54599920307272664369745a1b6f5493b298184", "url": "https://github.com/oracle/opengrok/commit/f54599920307272664369745a1b6f5493b298184", "message": "log a message when terminating the process", "committedDate": "2020-01-17T10:06:37Z", "type": "commit"}, {"oid": "c256f54b71232725e7b7025f1cb560b60b21fb97", "url": "https://github.com/oracle/opengrok/commit/c256f54b71232725e7b7025f1cb560b60b21fb97", "message": "fix year", "committedDate": "2020-01-17T10:07:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkyNDY1OA==", "url": "https://github.com/oracle/opengrok/pull/3025#discussion_r367924658", "bodyText": "I understand you want to avoid modifying kwargs but this fix assumes it's safe to set timeout afterwards. It is fine as of today but it isn't guaranteed in the future. Someone may make Command immutable or change its internal logic for some reason (for example it may cache and/or prevent you from setting timeout).\nIt's cleaner if arguments like timeout are passed once, at object creation, as part of kwargs. For example keeping the original code but using a shallow copy dictionary:\nkwargs = kwargs.copy()\nkwargs['timeout'] = self.timeout\nreturn Command(cmd, **kwargs)\n\nIn case you wonder a shallow copy is lightweight unlike a deep copy.", "author": "eric-saintetienne", "createdAt": "2020-01-17T13:03:11Z", "path": "opengrok-tools/src/main/python/opengrok_tools/scm/repository.py", "diffHunk": "@@ -54,8 +54,9 @@ def __str__(self):\n         return self.path\n \n     def getCommand(self, cmd, **kwargs):\n-        kwargs['timeout'] = self.timeout\n-        return Command(cmd, **kwargs)\n+        cmd = Command(cmd, **kwargs)\n+        cmd.timeout = self.timeout", "originalCommit": "8585961ee1fdf7181f043f2ee49f482c14d32201", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg2MDk5Mw==", "url": "https://github.com/oracle/opengrok/pull/3025#discussion_r371860993", "bodyText": "According to https://stackoverflow.com/a/45883925/11582827 modifying keyword arguments values in a function is safe - as long as they are of a primitive type which the timeout is. So, this change is actually not needed - shallow copy would not do anything here.", "author": "vladak", "createdAt": "2020-01-28T15:09:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkyNDY1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg4MDc3MA==", "url": "https://github.com/oracle/opengrok/pull/3025#discussion_r371880770", "bodyText": "Nice find, I did not know that. I've checked and indeed kwargs is a shallow copy of the original dictionary, interesting. The same applies to *args:\n>>> def func(*args, **kwargs):\n...     print(id(args), id(kwargs))\n... \n>>> args, kwargs = [1,2,3], {'arg1': 1, 'arg2': 2}\n>>> print(id(args), id(kwargs))\n140420202179952 140420201922800\n>>> func(*args, **kwargs)\n140420204302896 140420201850992", "author": null, "createdAt": "2020-01-28T15:40:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkyNDY1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkyOTU5Mw==", "url": "https://github.com/oracle/opengrok/pull/3025#discussion_r367929593", "bodyText": "How about reworking get_repository() to accept a kwargs so you can tailor a dictionary and just pass it as **kwargs? It would be neater and cleaner.", "author": "eric-saintetienne", "createdAt": "2020-01-17T13:16:12Z", "path": "opengrok-tools/src/main/python/opengrok_tools/utils/mirror.py", "diffHunk": "@@ -99,7 +99,7 @@ def get_repos_for_project(project_name, ignored_repos, uri, source_root,\n                                   kwargs[COMMANDS_PROPERTY],\n                                   kwargs[PROXY_PROPERTY],\n                                   None,\n-                                  kwargs['command_timeout'])\n+                                  kwargs[CMD_TIMEOUT_PROPERTY])", "originalCommit": "8585961ee1fdf7181f043f2ee49f482c14d32201", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI2MTIyOA==", "url": "https://github.com/oracle/opengrok/pull/3025#discussion_r371261228", "bodyText": "It occurred to me as well at one point and then I forgot it.", "author": "vladak", "createdAt": "2020-01-27T14:13:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkyOTU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkwMjcyNw==", "url": "https://github.com/oracle/opengrok/pull/3025#discussion_r372902727", "bodyText": "Will do this in separate PR - it is more changes than I anticipated (esp. in testing).", "author": "vladak", "createdAt": "2020-01-30T11:43:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkyOTU5Mw=="}], "type": "inlineReview"}, {"oid": "367704c7738b9aee57e775359698c197c9dab769", "url": "https://github.com/oracle/opengrok/commit/367704c7738b9aee57e775359698c197c9dab769", "message": "add timeout inheritance testing", "committedDate": "2020-01-28T15:11:52Z", "type": "commit"}, {"oid": "7f52cc1382817573faeafb0bc67a84326a4959af", "url": "https://github.com/oracle/opengrok/commit/7f52cc1382817573faeafb0bc67a84326a4959af", "message": "fix timeut inheritance\n\nfixes #3022", "committedDate": "2020-01-28T15:11:52Z", "type": "commit"}, {"oid": "7f52cc1382817573faeafb0bc67a84326a4959af", "url": "https://github.com/oracle/opengrok/commit/7f52cc1382817573faeafb0bc67a84326a4959af", "message": "fix timeut inheritance\n\nfixes #3022", "committedDate": "2020-01-28T15:11:52Z", "type": "forcePushed"}]}