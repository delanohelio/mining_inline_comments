{"pr_number": 3160, "pr_title": "docker: Fix OPENGROK_WEBAPP_CONTEXT behaviour.", "pr_createdAt": "2020-06-02T20:10:55Z", "pr_url": "https://github.com/oracle/opengrok/pull/3160", "timeline": [{"oid": "1cb00743497e7311806ab13b6fe68275c36f27b5", "url": "https://github.com/oracle/opengrok/commit/1cb00743497e7311806ab13b6fe68275c36f27b5", "message": "docker: Document `OPENGROK_WEBAPP_CONTEXT` environment variable", "committedDate": "2020-05-28T15:42:46Z", "type": "commit"}, {"oid": "1f3a09750f54633e0fc68f3f06f440277ac149c5", "url": "https://github.com/oracle/opengrok/commit/1f3a09750f54633e0fc68f3f06f440277ac149c5", "message": "docker: Move deployment to startup and adapt for custom path", "committedDate": "2020-05-28T18:30:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI2Nzk3NA==", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r434267974", "bodyText": "Nit: perhaps quote the variable expansion?", "author": "idodeclare", "createdAt": "2020-06-03T02:02:19Z", "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,29 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [ \"${OPENGROK_WEBAPP_CONTEXT}\" = \"/\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${OPENGROK_WEBAPP_CONTEXT#/}.war\"\n+fi\n+\n+if [ ! -f \"/usr/local/tomcat/webapps/${WAR_NAME}\" ]; then\n+\tdate +\"%F %T Deployment path changed. Redeploying...\"\n+\n+\t# Delete old deployment and (re)deploy\n+\trm -rf /usr/local/tomcat/webapps/*\n+\topengrok-deploy -c /opengrok/etc/configuration.xml \\\n+            /opengrok/lib/source.war /usr/local/tomcat/webapps/${WAR_NAME}", "originalCommit": "1f3a09750f54633e0fc68f3f06f440277ac149c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUwNjcxNA==", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r434506714", "bodyText": "Of course. Not sure how I missed that. I'll fix it with a later patch set.", "author": "timschumi", "createdAt": "2020-06-03T11:47:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI2Nzk3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDA5Nw==", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r434274097", "bodyText": "In Tomcat, one might specify a context path of e.g. /source/opengrok with an archive named source#opengrok.war. Might that be supported with substitution here?", "author": "idodeclare", "createdAt": "2020-06-03T02:29:26Z", "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,29 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [ \"${OPENGROK_WEBAPP_CONTEXT}\" = \"/\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${OPENGROK_WEBAPP_CONTEXT#/}.war\"", "originalCommit": "1f3a09750f54633e0fc68f3f06f440277ac149c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUwNzc1Nw==", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r434507757", "bodyText": "I'm unsure whether there are any advantages to that compared to simply filling in the URL-subfolder as-is (with minor changes to unify the format).\nI'd also prefer the path-based version personally, since it's easier to handle and understand (in my opinion).", "author": "timschumi", "createdAt": "2020-06-03T11:49:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0OTI5OQ==", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r436849299", "bodyText": "My question should have been more general: what will happen if the user specifies /source/opengrok as a context?", "author": "idodeclare", "createdAt": "2020-06-08T16:48:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5MjA1Mg==", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r436892052", "bodyText": "I just noticed that what I intended doesn't actually work. I thought that tomcat resolves the used .war file by the full path (i.e. that a path of /usr/share/tomcat/webapp/source/opengrok.war would result in OpenGrok being accessible at /source/opengrok, although /source is a whole other story), but that apparently only works for ROOT and first-level files.\nI'll do some testing with your suggested substitutions and add a commit if everything seems fine.", "author": "timschumi", "createdAt": "2020-06-08T17:58:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDA5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDUwMQ==", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r434274501", "bodyText": "If OPENGROK_WEBAPP_CONTEXT is empty or contains whitespace, should it be reset earlier to / to benefit this conditional and later usage?", "author": "idodeclare", "createdAt": "2020-06-03T02:31:08Z", "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,29 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [ \"${OPENGROK_WEBAPP_CONTEXT}\" = \"/\" ]; then", "originalCommit": "1f3a09750f54633e0fc68f3f06f440277ac149c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUwODIyMA==", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r434508220", "bodyText": "Sounds good, but we'll have to take a look at format restrictions for the variable later anyways (leading slash, trailing slash, etc.).", "author": "timschumi", "createdAt": "2020-06-03T11:50:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDUwMQ=="}], "type": "inlineReview"}, {"oid": "c9cc2c5e129bbfdf89736cc565060b5e38d76e7d", "url": "https://github.com/oracle/opengrok/commit/c9cc2c5e129bbfdf89736cc565060b5e38d76e7d", "message": "docker: Quote variable expansion in deploy command", "committedDate": "2020-06-08T01:28:13Z", "type": "commit"}, {"oid": "3fac11ae4f51d428bbddadeebec7a7179ed1df94", "url": "https://github.com/oracle/opengrok/commit/3fac11ae4f51d428bbddadeebec7a7179ed1df94", "message": "docker: Deploy to root if path contains whitespace", "committedDate": "2020-06-08T01:47:39Z", "type": "commit"}, {"oid": "c97d2afad7181426acf2609b71a4e1dd1f111d6b", "url": "https://github.com/oracle/opengrok/commit/c97d2afad7181426acf2609b71a4e1dd1f111d6b", "message": "docker: Support sub-subdirectories as WEBAPP_CONTEXT", "committedDate": "2020-06-08T22:03:31Z", "type": "commit"}, {"oid": "ff0eb2e83bc7d179f2679d018aac48e552c0d7e2", "url": "https://github.com/oracle/opengrok/commit/ff0eb2e83bc7d179f2679d018aac48e552c0d7e2", "message": "docker: Rename OPENGROK_WEBAPP_CONTEXT to URL_ROOT\n\nThe original OPENGROK_WEBAPP_CONTEXT variable has been\ndeprecated/not been in use since the deployment scripts have\nbeen rewritten in commit d5cc7b5dcc6133fb9f4a6764e933b4d8b234d461.\n\nRename the variable to URL_ROOT to avoid confusion and to\nkeep the docker command a bit shorter.\n\nWhile we're at it, remove the OPENGROK_TOMCAT_BASE variable,\nwhich has been deprecated at the same time.", "committedDate": "2020-06-09T12:08:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MTc0Mw==", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r488761743", "bodyText": "I guess these commands will print errors when run multiple times (e.g. stop/start/stop/start)\nwould it make sense to make them idempotent?", "author": "tarzanek", "createdAt": "2020-09-15T15:30:50Z", "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,38 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [[ \"${URL_ROOT}\" = *\" \"* ]]; then\n+\tdate +\"%F %T Deployment path contains spaces. Deploying to root...\"\n+\texport URL_ROOT=\"/\"\n+fi\n+\n+# Remove leading and trailing slashes\n+URL_ROOT=\"${URL_ROOT#/}\"\n+URL_ROOT=\"${URL_ROOT%/}\"\n+\n+if [ \"${URL_ROOT}\" = \"\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${URL_ROOT//\\//#}.war\"\n+fi\n+\n+if [ ! -f \"/usr/local/tomcat/webapps/${WAR_NAME}\" ]; then\n+\tdate +\"%F %T Deployment path changed. Redeploying...\"\n+\n+\t# Delete old deployment and (re)deploy\n+\trm -rf /usr/local/tomcat/webapps/*\n+\topengrok-deploy -c /opengrok/etc/configuration.xml \\\n+            /opengrok/lib/source.war \"/usr/local/tomcat/webapps/${WAR_NAME}\"\n+\n+\t# Set up redirect from /source\n+\tmkdir \"/usr/local/tomcat/webapps/source\"", "originalCommit": "ff0eb2e83bc7d179f2679d018aac48e552c0d7e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MjQxNQ==", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r488762415", "bodyText": "(while above was run only once when the docker container was created)", "author": "tarzanek", "createdAt": "2020-09-15T15:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MTc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgwMTA0Ng==", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r488801046", "bodyText": "Like this it's only running those commands if the .war file isn't located at the expected location (i.e. first start or after URL_ROOT has been changed), isn't it? Or am I missing/misunderstanding something?", "author": "timschumi", "createdAt": "2020-09-15T16:26:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MTc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NDQwNw==", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r488864407", "bodyText": "Looks quite okay to me with these nits:\n\nif you restart the container with different URL_ROOT value the old one will probably be still lying around (not a big deal, just a note)\nthe exit codes of the commands are not checked (might as well run the script with set -e)", "author": "vladak", "createdAt": "2020-09-15T18:05:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MTc0Mw=="}], "type": "inlineReview"}]}