{"pr_number": 1247, "pr_title": "SAMZA-2408: Update RemoteApplicationRunner to submit job only", "pr_createdAt": "2020-01-10T18:55:38Z", "pr_url": "https://github.com/apache/samza/pull/1247", "timeline": [{"oid": "16c0d74b9433207b2b59cf53064bd46dea7816bd", "url": "https://github.com/apache/samza/commit/16c0d74b9433207b2b59cf53064bd46dea7816bd", "message": "SAMZA-2408: Update RemoteApplicationRunner to submit job only\n\nDesign:\nhttps://cwiki.apache.org/confluence/display/SAMZA/SEP-23%3A+Simplify+Job+Runner\n\nChanges:\n\n1. Depending on the existence of job.config.loader.factory, RemoteApplicationRunner will alternatively only submit the job, without planning.\n2. Late initialize RemoteJobPlanner only when needed to avoid executing user code in submitting only mode.\n\nAPI Changes:\nN/A. This is part of a series PRs, detailed information will be provided in the last/main PR.\n\nUpgrade Instructions:\nN/A. This is part of a series PRs, detailed information will be provided in the last/main PR.\n\nUsage Instructions:\nN/A. This is part of a series PRs, detailed information will be provided in the last/main PR.\n\nTests:\nN/A", "committedDate": "2020-01-10T18:52:23Z", "type": "commit"}, {"oid": "4105111a81a0921ccccf61598eba3589f7b23d60", "url": "https://github.com/apache/samza/commit/4105111a81a0921ccccf61598eba3589f7b23d60", "message": "Use config instead of this.config", "committedDate": "2020-01-10T18:54:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMTcyNg==", "url": "https://github.com/apache/samza/pull/1247#discussion_r366101726", "bodyText": "Would it be helpful to create a ticket for this cleanup work (for all changes related to the SEP) so we don't lose track of it?", "author": "bkonold", "createdAt": "2020-01-14T00:36:24Z", "path": "samza-core/src/main/java/org/apache/samza/runtime/RemoteApplicationRunner.java", "diffHunk": "@@ -57,13 +55,21 @@\n    * @param config configuration for the application\n    */\n   public RemoteApplicationRunner(SamzaApplication app, Config config) {\n-    this.appDesc = ApplicationDescriptorUtil.getAppDescriptor(app, config);\n-    this.planner = new RemoteJobPlanner(appDesc);\n+    this.app = app;\n+    this.config = config;\n   }\n \n   @Override\n   public void run(ExternalContext externalContext) {\n+    if (new JobConfig(config).getConfigLoaderFactory().isPresent()) {\n+      JobRunner runner = new JobRunner(config);\n+      runner.submit();\n+      return;\n+    }\n+\n+    // TODO: Clean this up once SAMZA-2405 is completed when legacy flow is removed.", "originalCommit": "4105111a81a0921ccccf61598eba3589f7b23d60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMjY3MQ==", "url": "https://github.com/apache/samza/pull/1247#discussion_r366102671", "bodyText": "Good point, I will create a ticket for it.", "author": "kw2542", "createdAt": "2020-01-14T00:40:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMTcyNg=="}], "type": "inlineReview"}, {"oid": "4f864b2f87dc3a364e5344340b6768de942fc9ea", "url": "https://github.com/apache/samza/commit/4f864b2f87dc3a364e5344340b6768de942fc9ea", "message": "Add unit tests and clean up ticket", "committedDate": "2020-01-14T20:42:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNzgzOQ==", "url": "https://github.com/apache/samza/pull/1247#discussion_r366617839", "bodyText": "Hmm. I guess the code as-is isn't very unit test friendly. It would be nice to test the invocation of .submit vs .run on JobRunner depending on the presence of the ConfigLoaderFactory.\nMaybe we could factor out the JobRunner creation into its own method, and use a spy to stub out the return value of that method to be a mock JobRunner that we can verify? Disclaimer though, I'm not sure what the best practices are of using spies...", "author": "bkonold", "createdAt": "2020-01-14T22:59:41Z", "path": "samza-core/src/test/java/org/apache/samza/runtime/TestRemoteApplicationRunner.java", "diffHunk": "@@ -75,9 +75,20 @@ public void testWaitForFinishTimesout() {\n     assertFalse(\"Application finished before the timeout.\", finished);\n   }\n \n+  @Test\n+  public void testRunWithConfigLoaderFactoryPresent() {", "originalCommit": "4f864b2f87dc3a364e5344340b6768de942fc9ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYyNDA4MA==", "url": "https://github.com/apache/samza/pull/1247#discussion_r366624080", "bodyText": "Haha, I figured that too. In general, I prefer not to mess with production code for the sake of unit tests.\nThe current unit actually test the new flow, I passed null SamzaApplication to RemoteApplicationRunner's constructor. In RemoteApplicationRunner#run, if it goes the legacy flow, it will throw exception when constructing RemoteJobPlanner where SamzaApplication is required. Do you think this is enough?", "author": "kw2542", "createdAt": "2020-01-14T23:18:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNzgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY0NjYwMg==", "url": "https://github.com/apache/samza/pull/1247#discussion_r366646602", "bodyText": "There is some precedence elsewhere in samza code; ZkJobCoordinator.readJobModelFromMetadataStore for example uses a similar method structure + spy in unit test.\nYou are correct that the test written now does ensure that the legacy flow isn't triggered, but it does little to verify the behavior of the new flow. I won't block the PR on this though.", "author": "bkonold", "createdAt": "2020-01-15T00:42:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNzgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzNTAyMw==", "url": "https://github.com/apache/samza/pull/1247#discussion_r367135023", "bodyText": "+1 that there is a bit of missing test coverage here. It would be nice if this class was set up better for improved testing, but I also won't block the PR on this.", "author": "cameronlee314", "createdAt": "2020-01-15T22:13:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNzgzOQ=="}], "type": "inlineReview"}, {"oid": "077d4d22063bb6623c3f376a09a28613c3c60fa1", "url": "https://github.com/apache/samza/commit/077d4d22063bb6623c3f376a09a28613c3c60fa1", "message": "Merge branch 'master' of https://github.com/apache/samza into SAMZA-2408", "committedDate": "2020-01-15T00:39:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzMjc0OQ==", "url": "https://github.com/apache/samza/pull/1247#discussion_r367032749", "bodyText": "This is a question for kill, status, and waitForFinish:\nShould you be calling JobPlanner.generateSingleJobConfig even when config loader factory is specified? It seems like you would want to call JobRunner, similar to how you changed it for run.", "author": "cameronlee314", "createdAt": "2020-01-15T18:21:09Z", "path": "samza-core/src/main/java/org/apache/samza/runtime/RemoteApplicationRunner.java", "diffHunk": "@@ -85,7 +91,7 @@ public void kill() {\n     // since currently we only support single actual remote job, we can get its status without\n     // building the execution plan.\n     try {\n-      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(appDesc.getConfig()));\n+      JobConfig jc = new JobConfig(JobPlanner.generateSingleJobConfig(config));", "originalCommit": "077d4d22063bb6623c3f376a09a28613c3c60fa1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA5MjQwNA==", "url": "https://github.com/apache/samza/pull/1247#discussion_r367092404", "bodyText": "JobPlanner.generateSingleJobConfig is a util method which overrides job.name and job.id based on app.name and app.id, which I suppose is safe to keep.\nkill, status and waitForFinish are still using calling JobRunner.", "author": "kw2542", "createdAt": "2020-01-15T20:32:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzMjc0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExMjM1MA==", "url": "https://github.com/apache/samza/pull/1247#discussion_r367112350", "bodyText": "But in run, you don't call JobPlanner.generateSingleJobConfig. For consistency, it seems like you should call generateSingleJobConfig for all cases or for no cases.", "author": "cameronlee314", "createdAt": "2020-01-15T21:19:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzMjc0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzExOTM5Ng==", "url": "https://github.com/apache/samza/pull/1247#discussion_r367119396", "bodyText": "Got you, JobPlanner.generateSingleJobConfig is not being used in run() but it is used in ExecutionPlanner. I will update the code.", "author": "kw2542", "createdAt": "2020-01-15T21:35:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzMjc0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyNDM5Nw==", "url": "https://github.com/apache/samza/pull/1247#discussion_r367124397", "bodyText": "It looks like ExecutionPlanner.createJobGraph (part of planning) uses JobPlanner.generateSingleJobConfig, so it looks like JobPlanner.generateSingleJobConfig is used in run in the legacy path. Can you please check if I am reading the code correctly here?", "author": "cameronlee314", "createdAt": "2020-01-15T21:47:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzMjc0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyNjIxMA==", "url": "https://github.com/apache/samza/pull/1247#discussion_r367126210", "bodyText": "Updated.", "author": "kw2542", "createdAt": "2020-01-15T21:51:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzMjc0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEyNjI5NQ==", "url": "https://github.com/apache/samza/pull/1247#discussion_r367126295", "bodyText": "Thanks for pointing this out!", "author": "kw2542", "createdAt": "2020-01-15T21:51:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzMjc0OQ=="}], "type": "inlineReview"}, {"oid": "ba8ab367649bf94e977f55c4a331e6e7ff07cf8c", "url": "https://github.com/apache/samza/commit/ba8ab367649bf94e977f55c4a331e6e7ff07cf8c", "message": "Use JobPlanner.generateSingleJobConfig to be consistent with kill, status and waitForFinish. This is also used in ExecutionPlanner as well before.", "committedDate": "2020-01-15T21:47:43Z", "type": "commit"}]}