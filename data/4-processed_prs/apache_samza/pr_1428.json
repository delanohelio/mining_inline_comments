{"pr_number": 1428, "pr_title": "SAMZA-2589: Consolidate Beam and High/Low Samza Apps launch workflow", "pr_createdAt": "2020-09-08T21:01:57Z", "pr_url": "https://github.com/apache/samza/pull/1428", "timeline": [{"oid": "42586a0c56984ddba3794ea36ae04d5cb573a482", "url": "https://github.com/apache/samza/commit/42586a0c56984ddba3794ea36ae04d5cb573a482", "message": "SAMZA-2589: Consolidate Beam and High/Low Samza Apps launch workflow\n\nIssues: app.main.class is only set for Beam apps which causes different workflow on AM when launching a job.\nChanges:\n1. Introduce DefaultApplicationMain to capture launch workflow for High/Low level jobs so on AM, all jobs are launched in the same way: ClusterBasedJobCoordinatorRunner#main -> app.main.class -> JobCoordinatorLaunchUtil\n2. Update ApplicationConfig#getAppMainClass to default to DefaultApplicationMain\n\nTests:\n1. Unit Tests\n2. Deployed hello samza job successfully with the change following instructions on http://samza.apache.org/startup/hello-samza/latest/\n\nAPI Changes: None\nUpgrade Instructions: None\nUsage Instructions: None", "committedDate": "2020-09-08T21:00:15Z", "type": "commit"}, {"oid": "6fd6dbff23322c707797aee8b575fddba1ae62d2", "url": "https://github.com/apache/samza/commit/6fd6dbff23322c707797aee8b575fddba1ae62d2", "message": "Remove unused imports", "committedDate": "2020-09-08T22:04:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzMzM5NA==", "url": "https://github.com/apache/samza/pull/1428#discussion_r486433394", "bodyText": "why do we need this?", "author": "mynameborat", "createdAt": "2020-09-10T15:26:13Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/DefaultApplicationMain.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import joptsimple.OptionSet;\n+import org.apache.samza.application.ApplicationUtil;\n+import org.apache.samza.config.Config;\n+import org.apache.samza.runtime.ApplicationRunnerMain;\n+import org.apache.samza.util.ConfigUtil;\n+\n+\n+public class DefaultApplicationMain {\n+\n+  public static void main(String[] args) {\n+    run(args);\n+  }\n+\n+  @VisibleForTesting\n+  static void run(String[] args) {\n+    // This branch is ONLY for Yarn deployments, standalone apps uses offspring\n+    final ApplicationRunnerMain.ApplicationRunnerCommandLine cmdLine = new ApplicationRunnerMain.ApplicationRunnerCommandLine();\n+    cmdLine.parser().allowsUnrecognizedOptions();", "originalCommit": "6fd6dbff23322c707797aee8b575fddba1ae62d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwMjI1MQ==", "url": "https://github.com/apache/samza/pull/1428#discussion_r486502251", "bodyText": "This is needed because submission configs are now passed to this class through arguments, in order for the main class to load full config, we need to parse the arguments. This is similar to Beam application where arguments are being parsed in the main class as well.", "author": "kw2542", "createdAt": "2020-09-10T17:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzMzM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUxODU5OA==", "url": "https://github.com/apache/samza/pull/1428#discussion_r486518598", "bodyText": "Does it it mean you pass options that are dynamic and are not known static list?", "author": "mynameborat", "createdAt": "2020-09-10T17:37:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzMzM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI3ODk4Mw==", "url": "https://github.com/apache/samza/pull/1428#discussion_r487278983", "bodyText": "To answer your original questions, submission configs is a static list of configs predefined as they will impact how AM works, plus any extra config overrides user wants to supply in order to override the configs fetched in the ConfigLoader.\nThe complete workflow will be:\n\n\nsubmission configs are first passed to ClusterBasedJobCoordinatorRunner as System env variable and is retrieved with\nfinal String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG);\n\n\nAfterwards, when ClusterBasedJobCoordinatorRunner invokes app.main.class, the above submission configs will be converted to String[] args as this is the only parameter that main() method takes.\n\n\nInside main() method, including both Beam and High/Low, args will be used to load full job config with ConfigLoaderFactory", "author": "kw2542", "createdAt": "2020-09-11T20:37:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzMzM5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI4NDg2Mw==", "url": "https://github.com/apache/samza/pull/1428#discussion_r487284863", "bodyText": "Thanks for the explanation \ud83d\udc4d", "author": "mynameborat", "createdAt": "2020-09-11T20:51:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzMzM5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzNjc3NA==", "url": "https://github.com/apache/samza/pull/1428#discussion_r486436774", "bodyText": "Looks like this is unused. Do you where this is used/will be used?\nNow that main class is no longer optional, wondering if this should be too?", "author": "mynameborat", "createdAt": "2020-09-10T15:30:40Z", "path": "samza-core/src/main/java/org/apache/samza/config/ApplicationConfig.java", "diffHunk": "@@ -104,8 +105,8 @@ public ApplicationMode getAppMode() {\n     return Optional.ofNullable(get(APP_MAIN_ARGS));", "originalCommit": "6fd6dbff23322c707797aee8b575fddba1ae62d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwMzM3Ng==", "url": "https://github.com/apache/samza/pull/1428#discussion_r486503376", "bodyText": "This particular method is not being used as the current toArgs() method is checking the key name directly. We can remove this method.", "author": "kw2542", "createdAt": "2020-09-10T17:11:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzNjc3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUxODczMQ==", "url": "https://github.com/apache/samza/pull/1428#discussion_r486518731", "bodyText": "sounds good to me. If you can remove it, that will be great.", "author": "mynameborat", "createdAt": "2020-09-10T17:37:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzNjc3NA=="}], "type": "inlineReview"}, {"oid": "c3ae3ac1f972fd6ac875f92da3f98893c0dc52af", "url": "https://github.com/apache/samza/commit/c3ae3ac1f972fd6ac875f92da3f98893c0dc52af", "message": "Remove unused method", "committedDate": "2020-09-11T20:37:48Z", "type": "commit"}]}