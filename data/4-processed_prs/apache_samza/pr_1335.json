{"pr_number": 1335, "pr_title": "SAMZA-2501 : Optimizing startpoint manager to not make successive bootstrapMessage calls to coordinator-store", "pr_createdAt": "2020-03-31T22:25:45Z", "pr_url": "https://github.com/apache/samza/pull/1335", "timeline": [{"oid": "817987b01b50ed5b0748cf2cb7040b891ad9d08d", "url": "https://github.com/apache/samza/commit/817987b01b50ed5b0748cf2cb7040b891ad9d08d", "message": "Optimizing startpoint manager", "committedDate": "2020-03-31T22:18:41Z", "type": "commit"}, {"oid": "fbe8dc71509e2b06aac6508f30149c91e2f6936f", "url": "https://github.com/apache/samza/commit/fbe8dc71509e2b06aac6508f30149c91e2f6936f", "message": "Minor", "committedDate": "2020-03-31T22:40:06Z", "type": "commit"}, {"oid": "d318de7bca18592ac00b5efe614e2b1aaaf21f71", "url": "https://github.com/apache/samza/commit/d318de7bca18592ac00b5efe614e2b1aaaf21f71", "message": "Updating deleteKeys after fanout behavior", "committedDate": "2020-03-31T22:53:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM1NDE5NQ==", "url": "https://github.com/apache/samza/pull/1335#discussion_r401354195", "bodyText": "null as a key and .get(null) looks atypical and not readable on the go. It does require some context for someone to get the background on this.", "author": "mynameborat", "createdAt": "2020-04-01T04:49:20Z", "path": "samza-core/src/main/java/org/apache/samza/startpoint/StartpointManager.java", "diffHunk": "@@ -159,38 +160,63 @@ public void writeStartpoint(SystemStreamPartition ssp, TaskName taskName, Startp\n    *         It is empty if it does not exist or if it is too stale.\n    */\n   public Optional<Startpoint> readStartpoint(SystemStreamPartition ssp) {\n-    return readStartpoint(ssp, null);\n+    return readStartpointMap(Collections.singletonMap(null, Collections.singleton(ssp)), false).get(null)", "originalCommit": "d318de7bca18592ac00b5efe614e2b1aaaf21f71", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9497014fd36d7e02d45f429e146e530d8be9f22f", "url": "https://github.com/apache/samza/commit/9497014fd36d7e02d45f429e146e530d8be9f22f", "message": "Making read once", "committedDate": "2020-04-01T17:31:46Z", "type": "commit"}, {"oid": "e36107973554517d6f58ad3822a0047359ea542f", "url": "https://github.com/apache/samza/commit/e36107973554517d6f58ad3822a0047359ea542f", "message": "Major refactor adding config", "committedDate": "2020-04-01T17:54:23Z", "type": "commit"}, {"oid": "23290222031cd2d9f73f1eef7c4432fda43e02b9", "url": "https://github.com/apache/samza/commit/23290222031cd2d9f73f1eef7c4432fda43e02b9", "message": "Making config as \"enabled\"", "committedDate": "2020-04-01T17:56:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0ODQ3OQ==", "url": "https://github.com/apache/samza/pull/1335#discussion_r401848479", "bodyText": "Revert the change on line line 162 calling readStartpoint(ssp, null); will still do the intended, do not need line 163-165", "author": "Sanil15", "createdAt": "2020-04-01T19:13:33Z", "path": "samza-core/src/main/java/org/apache/samza/startpoint/StartpointManager.java", "diffHunk": "@@ -158,8 +158,25 @@ public void writeStartpoint(SystemStreamPartition ssp, TaskName taskName, Startp\n    * @return {@link Optional} of {@link Startpoint} for the {@link SystemStreamPartition}.\n    *         It is empty if it does not exist or if it is too stale.\n    */\n+  @VisibleForTesting\n   public Optional<Startpoint> readStartpoint(SystemStreamPartition ssp) {\n-    return readStartpoint(ssp, null);", "originalCommit": "23290222031cd2d9f73f1eef7c4432fda43e02b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1MzI5NA==", "url": "https://github.com/apache/samza/pull/1335#discussion_r401853294", "bodyText": "Is used in numerous tests, so need it.", "author": "rmatharu", "createdAt": "2020-04-01T19:22:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0ODQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1NjY4MQ==", "url": "https://github.com/apache/samza/pull/1335#discussion_r401856681", "bodyText": "You are not changing the function signature, so the test should still work when you invoke readStartpoint(ssp, null) from here what am I missing?", "author": "Sanil15", "createdAt": "2020-04-01T19:28:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0ODQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg2MDg0OQ==", "url": "https://github.com/apache/samza/pull/1335#discussion_r401860849", "bodyText": "The fact that null as task-name maps to \"only-ssp\" is an internal of the class, i.e., the unit.\nUnit-tests test the unit not internal nitty gritties of the unit.", "author": "rmatharu", "createdAt": "2020-04-01T19:36:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0ODQ3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0ODk4Nw==", "url": "https://github.com/apache/samza/pull/1335#discussion_r401848987", "bodyText": "Please correct the comment, task-name can be non-null", "author": "Sanil15", "createdAt": "2020-04-01T19:14:20Z", "path": "samza-core/src/main/java/org/apache/samza/startpoint/StartpointManager.java", "diffHunk": "@@ -158,8 +158,25 @@ public void writeStartpoint(SystemStreamPartition ssp, TaskName taskName, Startp\n    * @return {@link Optional} of {@link Startpoint} for the {@link SystemStreamPartition}.\n    *         It is empty if it does not exist or if it is too stale.\n    */\n+  @VisibleForTesting\n   public Optional<Startpoint> readStartpoint(SystemStreamPartition ssp) {\n-    return readStartpoint(ssp, null);\n+    Map<String, byte[]> startpointBytes = readWriteStore.all();\n+    // there is no task-name to use as key for the startpoint in this case (only the ssp), so we use a null task-name\n+    return readStartpoint(startpointBytes, ssp, null);\n+  }\n+\n+  /**\n+   * Returns the last {@link Startpoint} that defines the start position for a {@link SystemStreamPartition} and {@link TaskName}.\n+   * @param ssp The {@link SystemStreamPartition} to fetch the {@link Startpoint} for.\n+   * @param taskName the {@link TaskName} to fetch the {@link Startpoint} for.\n+   * @return {@link Optional} of {@link Startpoint} for the {@link SystemStreamPartition}.\n+   *         It is empty if it does not exist or if it is too stale.\n+   */\n+  @VisibleForTesting\n+  public Optional<Startpoint> readStartpoint(SystemStreamPartition ssp, TaskName taskName) {\n+    Map<String, byte[]> startpointBytes = readWriteStore.all();\n+    // there is no task-name to use as key for the startpoint in this case (only the ssp), so we use a null task-name", "originalCommit": "23290222031cd2d9f73f1eef7c4432fda43e02b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1MTE4OA==", "url": "https://github.com/apache/samza/pull/1335#discussion_r401851188", "bodyText": "If this config is called job.startpoint.fanout.enabled, isn't it better to be a part of JobConfig than ClusterManagerConfig?", "author": "Sanil15", "createdAt": "2020-04-01T19:18:24Z", "path": "samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java", "diffHunk": "@@ -127,6 +127,7 @@\n    */\n   private static final String AM_JMX_ENABLED = \"yarn.am.jmx.enabled\";\n   private static final String CLUSTER_MANAGER_JMX_ENABLED = \"cluster-manager.jobcoordinator.jmx.enabled\";\n+  private static final String CLUSTER_MANAGER_STARTPOINT_FANOUT_ENABLED = \"job.startpoint.fanout.enabled\";", "originalCommit": "23290222031cd2d9f73f1eef7c4432fda43e02b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1NDA5OA==", "url": "https://github.com/apache/samza/pull/1335#discussion_r401854098", "bodyText": "Once you decide where it fits, since this is user-facing, please add docs to doc markdown. Thanks!", "author": "Sanil15", "createdAt": "2020-04-01T19:23:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1MTE4OA=="}], "type": "inlineReview"}, {"oid": "099730963a7f42732e3d3002806c50388733e6bc", "url": "https://github.com/apache/samza/commit/099730963a7f42732e3d3002806c50388733e6bc", "message": "some minor comment changes", "committedDate": "2020-04-01T19:22:38Z", "type": "commit"}, {"oid": "7965d51c2e7879efd54825ced4733d5c4c5b508e", "url": "https://github.com/apache/samza/commit/7965d51c2e7879efd54825ced4733d5c4c5b508e", "message": "Adding jobconfig for startpoints", "committedDate": "2020-04-01T22:57:43Z", "type": "commit"}]}