{"pr_number": 1353, "pr_title": "SAMZA-2517 : Adding handling and relevant exception message for null in oldest offset from system-admin", "pr_createdAt": "2020-04-29T07:09:51Z", "pr_url": "https://github.com/apache/samza/pull/1353", "timeline": [{"oid": "d966aceb8d7d6b00c687fad718931a10c975fe8f", "url": "https://github.com/apache/samza/commit/d966aceb8d7d6b00c687fad718931a10c975fe8f", "message": "Adding handling and relevant exception message for null in oldest offset from system-admin", "committedDate": "2020-04-29T07:07:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyMzE5OQ==", "url": "https://github.com/apache/samza/pull/1353#discussion_r417123199", "bodyText": "This map seems redundant. Why not directly put to oldestOffsets?", "author": "bkonold", "createdAt": "2020-04-29T07:40:38Z", "path": "samza-core/src/main/java/org/apache/samza/storage/TaskSideInputStorageManager.java", "diffHunk": "@@ -363,15 +364,22 @@ File getStoreLocation(String storeName) {\n \n     // Step 3\n     metadata.forEach((systemStream, systemStreamMetadata) -> {\n+\n         // get the partition metadata for each system stream\n         Map<Partition, SystemStreamMetadata.SystemStreamPartitionMetadata> partitionMetadata =\n           systemStreamMetadata.getSystemStreamPartitionMetadata();\n \n         // For SSPs belonging to the system stream, use the partition metadata to get the oldest offset\n-        Map<SystemStreamPartition, String> offsets = systemStreamToSsp.get(systemStream).stream()\n-          .collect(\n-              Collectors.toMap(Function.identity(), ssp -> partitionMetadata.get(ssp.getPartition()).getOldestOffset()));\n-\n+        // if partitionMetadata was not obtained for any SSP, populate oldest-offset as null\n+        // Because of https://bugs.openjdk.java.net/browse/JDK-8148463 using lambda will NPE when getOldestOffset() is null\n+        Map<SystemStreamPartition, String> offsets = new HashMap<>();\n+        for (SystemStreamPartition ssp : systemStreamToSsp.get(systemStream)) {\n+          if (partitionMetadata == null || partitionMetadata.get(ssp.getPartition()) == null) {\n+            offsets.put(ssp, null);\n+          } else {\n+            offsets.put(ssp, partitionMetadata.get(ssp.getPartition()).getOldestOffset());", "originalCommit": "d966aceb8d7d6b00c687fad718931a10c975fe8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU2MzM4Mg==", "url": "https://github.com/apache/samza/pull/1353#discussion_r417563382", "bodyText": "done", "author": "rmatharu", "createdAt": "2020-04-29T19:37:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyMzE5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ4NTQwOQ==", "url": "https://github.com/apache/samza/pull/1353#discussion_r417485409", "bodyText": "SystemStreamMetadata#getSystemStreamPartitionMetadata is also used in CoordinatorStreamStore, ContainerStorageManager and other places, we should also do null handling there right?\nIsn't it better to do at StreamMetadataCache level?", "author": "Sanil15", "createdAt": "2020-04-29T17:25:25Z", "path": "samza-core/src/main/java/org/apache/samza/storage/TaskSideInputStorageManager.java", "diffHunk": "@@ -363,15 +364,22 @@ File getStoreLocation(String storeName) {\n \n     // Step 3\n     metadata.forEach((systemStream, systemStreamMetadata) -> {\n+\n         // get the partition metadata for each system stream\n         Map<Partition, SystemStreamMetadata.SystemStreamPartitionMetadata> partitionMetadata =\n           systemStreamMetadata.getSystemStreamPartitionMetadata();\n \n         // For SSPs belonging to the system stream, use the partition metadata to get the oldest offset\n-        Map<SystemStreamPartition, String> offsets = systemStreamToSsp.get(systemStream).stream()\n-          .collect(\n-              Collectors.toMap(Function.identity(), ssp -> partitionMetadata.get(ssp.getPartition()).getOldestOffset()));\n-\n+        // if partitionMetadata was not obtained for any SSP, populate oldest-offset as null\n+        // Because of https://bugs.openjdk.java.net/browse/JDK-8148463 using lambda will NPE when getOldestOffset() is null\n+        Map<SystemStreamPartition, String> offsets = new HashMap<>();\n+        for (SystemStreamPartition ssp : systemStreamToSsp.get(systemStream)) {\n+          if (partitionMetadata == null || partitionMetadata.get(ssp.getPartition()) == null) {", "originalCommit": "d966aceb8d7d6b00c687fad718931a10c975fe8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU2Mzk0NQ==", "url": "https://github.com/apache/samza/pull/1353#discussion_r417563945", "bodyText": "the null values are on oldestOffset in the returned metadata-object not the returned objectl itself (returned val is by us and is not-null it appears).", "author": "rmatharu", "createdAt": "2020-04-29T19:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ4NTQwOQ=="}], "type": "inlineReview"}, {"oid": "2b8eef38312623ee519afece2f122b2ac4675166", "url": "https://github.com/apache/samza/commit/2b8eef38312623ee519afece2f122b2ac4675166", "message": "Addressing review comments", "committedDate": "2020-04-29T19:33:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYxOTY1OA==", "url": "https://github.com/apache/samza/pull/1353#discussion_r417619658", "bodyText": "What's the purpose for multiple ssps if they are each testing the same condition?", "author": "bkonold", "createdAt": "2020-04-29T21:21:41Z", "path": "samza-core/src/test/java/org/apache/samza/storage/TestTaskSideInputStorageManager.java", "diffHunk": "@@ -182,6 +186,36 @@ public void testGetFileOffsets() {\n       });\n   }\n \n+  /**\n+   * This test is for cases, when calls to systemAdmin (e.g., KafkaSystemAdmin's) get-stream-metadata method return null.\n+   */\n+  @Test\n+  public void testGetStartingOffsetsWhenStreamMetadataIsNull() {\n+    final String storeName = \"test-get-starting-offset-store\";\n+    final String taskName = \"test-get-starting-offset-task\";\n+\n+    Set<SystemStreamPartition> ssps = IntStream.range(1, 6)\n+        .mapToObj(idx -> new SystemStreamPartition(\"test-system\", \"test-stream\", new Partition(idx)))\n+        .collect(Collectors.toSet());\n+    Map<Partition, SystemStreamMetadata.SystemStreamPartitionMetadata> partitionMetadata = ssps.stream()\n+        .collect(Collectors.toMap(SystemStreamPartition::getPartition,\n+            x -> new SystemStreamMetadata.SystemStreamPartitionMetadata(null, \"1\", \"2\")));", "originalCommit": "2b8eef38312623ee519afece2f122b2ac4675166", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQyNTM1NA==", "url": "https://github.com/apache/samza/pull/1353#discussion_r418425354", "bodyText": "the task-sideinputstoragemanager uses maps to index ssps so we should have more than 1, but youre right two are probably enough.", "author": "rmatharu", "createdAt": "2020-05-01T05:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYxOTY1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYyMDkyMw==", "url": "https://github.com/apache/samza/pull/1353#discussion_r417620923", "bodyText": "thanks for adding docs", "author": "bkonold", "createdAt": "2020-04-29T21:24:09Z", "path": "samza-core/src/main/java/org/apache/samza/storage/TaskSideInputStorageManager.java", "diffHunk": "@@ -346,7 +346,8 @@ File getStoreLocation(String storeName) {\n    *   3. Fetches the partition metadata for each system stream and fetch the corresponding partition metadata\n    *      and populates the oldest offset for SSPs belonging to the system stream.\n    *\n-   * @return a {@link Map} of {@link SystemStreamPartition} to their oldest offset.\n+   * @return a {@link Map} of {@link SystemStreamPartition} to their oldest offset. If partitionMetadata could not be\n+   * obtained for any {@link SystemStreamPartition} the offset for it is populated as null.", "originalCommit": "2b8eef38312623ee519afece2f122b2ac4675166", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0c0ee00cccdabc6e55ceef5ab966ffdc503b5316", "url": "https://github.com/apache/samza/commit/0c0ee00cccdabc6e55ceef5ab966ffdc503b5316", "message": "Addressing comment on testtasksideinputstoragemanager", "committedDate": "2020-05-01T05:43:09Z", "type": "commit"}]}