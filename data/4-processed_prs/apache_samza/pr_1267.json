{"pr_number": 1267, "pr_title": "SAMZA-2402: Tie Container placement service and Container placement handler and validate placement requests", "pr_createdAt": "2020-02-06T01:07:39Z", "pr_url": "https://github.com/apache/samza/pull/1267", "timeline": [{"oid": "847005cd8fde6309fc3b1b769c17d891ac970026", "url": "https://github.com/apache/samza/commit/847005cd8fde6309fc3b1b769c17d891ac970026", "message": "SAMZA-2402: Tie Container placement service and Container placement handler and validate placement requests", "committedDate": "2020-02-06T23:18:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE0NzM1OA==", "url": "https://github.com/apache/samza/pull/1267#discussion_r376147358", "bodyText": "Note to reviewers: Metastore does not give any metadata fields related to a message so I have to manually sort to ensure messages are in increasing order of timestamp", "author": "Sanil15", "createdAt": "2020-02-06T23:52:46Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/container/placement/ContainerPlacementMetadataStore.java", "diffHunk": "@@ -259,6 +260,8 @@ static String toContainerPlacementMessageKey(UUID uuid, Class<?> messageType) {\n         throw new SamzaException(e);\n       }\n     }\n+    // Sort the actions in order of timestamp\n+    newActions.sort(Comparator.comparingLong(ContainerPlacementRequestMessage::getTimestamp));", "originalCommit": "847005cd8fde6309fc3b1b769c17d891ac970026", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2786bd695014a5c79ee4f60c170225682473ed98", "url": "https://github.com/apache/samza/commit/2786bd695014a5c79ee4f60c170225682473ed98", "message": "SAMZA-2402: Tie Container placement service and Container placement handler and validate placement requests", "committedDate": "2020-02-07T01:51:11Z", "type": "commit"}, {"oid": "2786bd695014a5c79ee4f60c170225682473ed98", "url": "https://github.com/apache/samza/commit/2786bd695014a5c79ee4f60c170225682473ed98", "message": "SAMZA-2402: Tie Container placement service and Container placement handler and validate placement requests", "committedDate": "2020-02-07T01:51:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU0ODczMA==", "url": "https://github.com/apache/samza/pull/1267#discussion_r376548730", "bodyText": "Note: I have not used any read-write locks here because we do not need this to be thread-safe, this cache is accessed by only one thread, I will add java docs for thread safety here", "author": "Sanil15", "createdAt": "2020-02-07T18:48:32Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/container/placements/DequeuedPlacementActionsCache.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager.container.placements;\n+\n+import java.util.Set;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+/**\n+ * FIFO cache that maintains de-queued container actions. This cache is only accessed by one thread,\n+ * {@link org.apache.samza.clustermanager.container.placement.ContainerPlacementRequestAllocator} thread in ClusterBasedJobCoordinator\n+ *\n+ */\n+public class DequeuedPlacementActionsCache {", "originalCommit": "2786bd695014a5c79ee4f60c170225682473ed98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM2NTIzMQ==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377365231", "bodyText": "Does this constructor call really warrant a new method?", "author": "rmatharu", "createdAt": "2020-02-10T22:51:55Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -452,7 +457,7 @@ StartpointManager createStartpointManager() {\n \n   @VisibleForTesting\n   ContainerProcessManager createContainerProcessManager() {\n-    return new ContainerProcessManager(config, state, metrics);\n+    return new ContainerProcessManager(config, state, metrics, containerPlacementMetadataStore);\n   }", "originalCommit": "2786bd695014a5c79ee4f60c170225682473ed98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMDYwOA==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377400608", "bodyText": "this is there so this method can be mocked it tests", "author": "Sanil15", "createdAt": "2020-02-11T00:45:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM2NTIzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5MjUyMg==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377392522", "bodyText": "This class seems un-neccessary can it be replaced with\nprivate final Set<String> placementActionsInFlight = new HashSet<>(); ?", "author": "rmatharu", "createdAt": "2020-02-11T00:15:56Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -65,15 +70,19 @@\n    * Key is chosen to be processorId since at a time only one placement action can be in progress on a container.\n    */\n   private final ConcurrentHashMap<String, ContainerPlacementMetadata> actions;\n+  private final DequeuedPlacementActionsCache dequeuedActionsCache;", "originalCommit": "2786bd695014a5c79ee4f60c170225682473ed98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMTAyNw==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377401027", "bodyText": "Set has to be finite-size maintaining last N UUIDs so we need some eviction policy (currently FIFO), please see the implementation of DequeuedPlacementActionsCache for details", "author": "Sanil15", "createdAt": "2020-02-11T00:47:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5MjUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQxODk4MA==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377418980", "bodyText": "Refactored it to make generic BoundedFifoQueue", "author": "Sanil15", "createdAt": "2020-02-11T02:08:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5MjUyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5MzY4NA==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377393684", "bodyText": "Can the hasActiveContainerPlacementAction and the getPlacementActionMetadata be merged?\nactive action is any action that is failed or succeeded no?", "author": "rmatharu", "createdAt": "2020-02-11T00:20:14Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -110,12 +119,14 @@ boolean handleContainerLaunch(SamzaResourceRequest request, String preferredHost\n       ContainerPlacementMetadata actionMetaData = getPlacementActionMetadata(processorId).get();", "originalCommit": "2786bd695014a5c79ee4f60c170225682473ed98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMTQ3Ng==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377401476", "bodyText": "Active action is one that is either ACCEPTED or in PROGRESS", "author": "Sanil15", "createdAt": "2020-02-11T00:48:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5MzY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NDY2Ng==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377394666", "bodyText": "What does this method do?\nWhat does it return and in which conditions does it return which output?", "author": "rmatharu", "createdAt": "2020-02-11T00:23:59Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -371,47 +389,54 @@ private boolean hasActiveContainerPlacementAction(String processorId) {\n     return Optional.ofNullable(this.actions.get(processorId));\n   }\n \n+  private void updateContainerPlacementActionStatus(ContainerPlacementMetadata metadata,\n+      ContainerPlacementMessage.StatusCode statusCode, String responseMessage) {\n+    metadata.setActionStatus(statusCode, responseMessage);\n+    writeContainerPlacementResponseMessage(metadata.getRequestMessage(), statusCode, responseMessage);\n+    LOG.info(\"Status updated for ContainerPlacement action: {}\", metadata);\n+  }\n+\n+  private void writeContainerPlacementResponseMessage(ContainerPlacementRequestMessage requestMessage,\n+      ContainerPlacementMessage.StatusCode statusCode, String responseMessage) {\n+    containerPlacementMetadataStore.writeContainerPlacementResponseMessage(\n+        ContainerPlacementResponseMessage.fromContainerPlacementRequestMessage(requestMessage, statusCode,\n+            responseMessage, System.currentTimeMillis()));\n+  }\n+\n   /**\n    * A valid container placement action is only issued for a running processor with a valid processor id which has no\n-   * in flight container requests. Duplicate actions are handled by deduping on uuid\n-   *\n-   * TODO: SAMZA-2402: Disallow pending Container Placement actions in metastore on job restarts\n+   * in flight container requests. Duplicate actions are handled by deduping on uuid. If there is an existing inflight\n+   * request or container is pending a start, the container placement request is queued to be executed in future.\n    */", "originalCommit": "2786bd695014a5c79ee4f60c170225682473ed98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMzQzMg==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377403432", "bodyText": "Will add more java docs", "author": "Sanil15", "createdAt": "2020-02-11T00:56:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NDY2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NDgwNA==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377394804", "bodyText": "Not sure what does \" Action is supposed to be queued\" mean?", "author": "rmatharu", "createdAt": "2020-02-11T00:24:28Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -371,47 +389,54 @@ private boolean hasActiveContainerPlacementAction(String processorId) {\n     return Optional.ofNullable(this.actions.get(processorId));\n   }\n \n+  private void updateContainerPlacementActionStatus(ContainerPlacementMetadata metadata,\n+      ContainerPlacementMessage.StatusCode statusCode, String responseMessage) {\n+    metadata.setActionStatus(statusCode, responseMessage);\n+    writeContainerPlacementResponseMessage(metadata.getRequestMessage(), statusCode, responseMessage);\n+    LOG.info(\"Status updated for ContainerPlacement action: {}\", metadata);\n+  }\n+\n+  private void writeContainerPlacementResponseMessage(ContainerPlacementRequestMessage requestMessage,\n+      ContainerPlacementMessage.StatusCode statusCode, String responseMessage) {\n+    containerPlacementMetadataStore.writeContainerPlacementResponseMessage(\n+        ContainerPlacementResponseMessage.fromContainerPlacementRequestMessage(requestMessage, statusCode,\n+            responseMessage, System.currentTimeMillis()));\n+  }\n+\n   /**\n    * A valid container placement action is only issued for a running processor with a valid processor id which has no\n-   * in flight container requests. Duplicate actions are handled by deduping on uuid\n-   *\n-   * TODO: SAMZA-2402: Disallow pending Container Placement actions in metastore on job restarts\n+   * in flight container requests. Duplicate actions are handled by deduping on uuid. If there is an existing inflight\n+   * request or container is pending a start, the container placement request is queued to be executed in future.\n    */\n-  private Pair<ContainerPlacementMessage.StatusCode, String> checkValidControlAction(String processorId, String destinationHost, UUID uuid) {\n-    String errorMessagePrefix =\n-        String.format(\"ControlAction to move or restart container with processor id %s to host %s is rejected due to\",\n-            processorId, destinationHost);\n+  private Optional<Pair<ContainerPlacementMessage.StatusCode, String>> validatePlacementAction(ContainerPlacementRequestMessage requestMessage) {\n+    String errorMessagePrefix = String.format(\"ContainerPlacement request: %s is rejected due to\", requestMessage);\n     Boolean invalidAction = false;\n     String errorMessage = null;\n     if (standbyContainerManager.isPresent()) {\n       errorMessage = String.format(\"%s not supported for host standby enabled\", errorMessagePrefix);\n       invalidAction = true;\n-    } else if (processorId == null || destinationHost == null) {\n-      errorMessage = String.format(\"%s either processor id or the host argument is null\", errorMessagePrefix);\n+    } else if (hasActiveContainerPlacementAction(requestMessage.getProcessorId())) {\n+      // Action is supposed to be queued", "originalCommit": "2786bd695014a5c79ee4f60c170225682473ed98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NTUwOQ==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377395509", "bodyText": "What if the machine bearing the AM fails at line 311,\nwill the action be silently deleted/dropped?", "author": "rmatharu", "createdAt": "2020-02-11T00:26:57Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -285,34 +297,41 @@ void handleExpiredRequest(String processorId, String preferredHost,\n    * @param containerAllocator to request physical resources\n    */\n   public void registerContainerPlacementAction(ContainerPlacementRequestMessage requestMessage, ContainerAllocator containerAllocator) {\n-    LOG.info(\"Received a ContainerPlacement action request: {}\", requestMessage);\n     String processorId = requestMessage.getProcessorId();\n     String destinationHost = requestMessage.getDestinationHost();\n-    Pair<ContainerPlacementMessage.StatusCode, String> actionStatus =\n-        checkValidControlAction(processorId, destinationHost, requestMessage.getUuid());\n-\n+    Optional<Pair<ContainerPlacementMessage.StatusCode, String>> actionStatus = validatePlacementAction(requestMessage);\n+    if (!actionStatus.isPresent()) {\n+      // Action is supposed to be queued\n+      LOG.info(\"ContainerPlacement request is en-queued metadata: {}\", requestMessage);\n+      return;\n+    }\n+    LOG.info(\"ContainerPlacement action is de-queued metadata: {}\", requestMessage);\n+    // Remove the request message from metastore since this message is already acted upon\n+    containerPlacementMetadataStore.deleteContainerPlacementRequestMessage(requestMessage.getUuid());\n+    // Action is de-queued upon so we record it in the cache", "originalCommit": "2786bd695014a5c79ee4f60c170225682473ed98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMjY0NA==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377402644", "bodyText": "If AM restarts => the job restarts, all the actions from the previous deployment will be cleaned", "author": "Sanil15", "createdAt": "2020-02-11T00:53:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NTUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NTYxOA==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377395618", "bodyText": "Should the cache be updated before deleting from persistent store?", "author": "rmatharu", "createdAt": "2020-02-11T00:27:20Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -285,34 +297,41 @@ void handleExpiredRequest(String processorId, String preferredHost,\n    * @param containerAllocator to request physical resources\n    */\n   public void registerContainerPlacementAction(ContainerPlacementRequestMessage requestMessage, ContainerAllocator containerAllocator) {\n-    LOG.info(\"Received a ContainerPlacement action request: {}\", requestMessage);\n     String processorId = requestMessage.getProcessorId();\n     String destinationHost = requestMessage.getDestinationHost();\n-    Pair<ContainerPlacementMessage.StatusCode, String> actionStatus =\n-        checkValidControlAction(processorId, destinationHost, requestMessage.getUuid());\n-\n+    Optional<Pair<ContainerPlacementMessage.StatusCode, String>> actionStatus = validatePlacementAction(requestMessage);\n+    if (!actionStatus.isPresent()) {\n+      // Action is supposed to be queued\n+      LOG.info(\"ContainerPlacement request is en-queued metadata: {}\", requestMessage);\n+      return;\n+    }\n+    LOG.info(\"ContainerPlacement action is de-queued metadata: {}\", requestMessage);\n+    // Remove the request message from metastore since this message is already acted upon\n+    containerPlacementMetadataStore.deleteContainerPlacementRequestMessage(requestMessage.getUuid());\n+    // Action is de-queued upon so we record it in the cache\n+    dequeuedActionsCache.put(requestMessage.getUuid());", "originalCommit": "2786bd695014a5c79ee4f60c170225682473ed98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMzA1MQ==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377403051", "bodyText": "either will work", "author": "Sanil15", "createdAt": "2020-02-11T00:54:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NTYxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NjAyNw==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377396027", "bodyText": "Is there a specific need for this?\nShoudnt ANY_HOST be the default, while if I want to be able to send a stateless job's container to a specific host, it should rather be allowed.", "author": "rmatharu", "createdAt": "2020-02-11T00:28:47Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -285,34 +297,41 @@ void handleExpiredRequest(String processorId, String preferredHost,\n    * @param containerAllocator to request physical resources\n    */\n   public void registerContainerPlacementAction(ContainerPlacementRequestMessage requestMessage, ContainerAllocator containerAllocator) {\n-    LOG.info(\"Received a ContainerPlacement action request: {}\", requestMessage);\n     String processorId = requestMessage.getProcessorId();\n     String destinationHost = requestMessage.getDestinationHost();\n-    Pair<ContainerPlacementMessage.StatusCode, String> actionStatus =\n-        checkValidControlAction(processorId, destinationHost, requestMessage.getUuid());\n-\n+    Optional<Pair<ContainerPlacementMessage.StatusCode, String>> actionStatus = validatePlacementAction(requestMessage);\n+    if (!actionStatus.isPresent()) {\n+      // Action is supposed to be queued\n+      LOG.info(\"ContainerPlacement request is en-queued metadata: {}\", requestMessage);\n+      return;\n+    }\n+    LOG.info(\"ContainerPlacement action is de-queued metadata: {}\", requestMessage);\n+    // Remove the request message from metastore since this message is already acted upon\n+    containerPlacementMetadataStore.deleteContainerPlacementRequestMessage(requestMessage.getUuid());\n+    // Action is de-queued upon so we record it in the cache\n+    dequeuedActionsCache.put(requestMessage.getUuid());\n     // Request is bad just update the response on message & return\n-    if (actionStatus.getKey() == ContainerPlacementMessage.StatusCode.BAD_REQUEST) {\n+    if (actionStatus.get().getKey() == ContainerPlacementMessage.StatusCode.BAD_REQUEST) {\n+      writeContainerPlacementResponseMessage(requestMessage, actionStatus.get().getKey(), actionStatus.get().getValue());\n       return;\n     }\n \n     SamzaResource currentResource = samzaApplicationState.runningProcessors.get(processorId);\n-    LOG.info(\n-        \"Processor ID: {} matched an active container with deployment ID: {} is running on host: {} for ContainerPlacement action: {}\",\n+    LOG.info(\"Processor ID: {} matched an active container with deployment ID: {} is running on host: {} for ContainerPlacement action: {}\",\n         processorId, currentResource.getContainerId(), currentResource.getHost(), requestMessage);\n \n     if (!hostAffinityEnabled) {\n-      LOG.info(\"Changing the requested host for placement action to {} because host affinity is disabled\",\n-          ResourceRequestState.ANY_HOST);\n+      LOG.info(\"Changing the requested host for placement action to {} because host affinity is disabled\", ResourceRequestState.ANY_HOST);\n       destinationHost = ANY_HOST;\n     }", "originalCommit": "2786bd695014a5c79ee4f60c170225682473ed98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQwMzM3NQ==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377403375", "bodyText": "if your question is about formatting change?", "author": "Sanil15", "createdAt": "2020-02-11T00:55:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NjAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQxOTc2NQ==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377419765", "bodyText": "\"Shoudnt ANY_HOST be the default, while if I want to be able to send a stateless job's container to a specific host, it should rather be allowed.\"\nThat needs some additional work in AM because ResourceRequestStatue and other parts of AM have significant code that just checks for this config and identifies a preferred resource as ANY_HOST, all of that needs to be refactored", "author": "Sanil15", "createdAt": "2020-02-11T02:12:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NjAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1NDUxMg==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377954512", "bodyText": "Sure, then maybe create a JIRA and link it here, to allow this addition (certain jobs have demanded/can use it).", "author": "rmatharu", "createdAt": "2020-02-11T23:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NjAyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NjkwMQ==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377396901", "bodyText": "For a method that is called validatePlacementAction a return value of null/empty means the action is valid?\nseems like weird semantics.", "author": "rmatharu", "createdAt": "2020-02-11T00:31:53Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -371,47 +389,54 @@ private boolean hasActiveContainerPlacementAction(String processorId) {\n     return Optional.ofNullable(this.actions.get(processorId));\n   }\n \n+  private void updateContainerPlacementActionStatus(ContainerPlacementMetadata metadata,\n+      ContainerPlacementMessage.StatusCode statusCode, String responseMessage) {\n+    metadata.setActionStatus(statusCode, responseMessage);\n+    writeContainerPlacementResponseMessage(metadata.getRequestMessage(), statusCode, responseMessage);\n+    LOG.info(\"Status updated for ContainerPlacement action: {}\", metadata);\n+  }\n+\n+  private void writeContainerPlacementResponseMessage(ContainerPlacementRequestMessage requestMessage,\n+      ContainerPlacementMessage.StatusCode statusCode, String responseMessage) {\n+    containerPlacementMetadataStore.writeContainerPlacementResponseMessage(\n+        ContainerPlacementResponseMessage.fromContainerPlacementRequestMessage(requestMessage, statusCode,\n+            responseMessage, System.currentTimeMillis()));\n+  }\n+\n   /**\n    * A valid container placement action is only issued for a running processor with a valid processor id which has no\n-   * in flight container requests. Duplicate actions are handled by deduping on uuid\n-   *\n-   * TODO: SAMZA-2402: Disallow pending Container Placement actions in metastore on job restarts\n+   * in flight container requests. Duplicate actions are handled by deduping on uuid. If there is an existing inflight\n+   * request or container is pending a start, the container placement request is queued to be executed in future.\n    */\n-  private Pair<ContainerPlacementMessage.StatusCode, String> checkValidControlAction(String processorId, String destinationHost, UUID uuid) {\n-    String errorMessagePrefix =\n-        String.format(\"ControlAction to move or restart container with processor id %s to host %s is rejected due to\",\n-            processorId, destinationHost);\n+  private Optional<Pair<ContainerPlacementMessage.StatusCode, String>> validatePlacementAction(ContainerPlacementRequestMessage requestMessage) {\n+    String errorMessagePrefix = String.format(\"ContainerPlacement request: %s is rejected due to\", requestMessage);", "originalCommit": "2786bd695014a5c79ee4f60c170225682473ed98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQyMDk1OQ==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377420959", "bodyText": "forgot to push a commit that refactors this method to two methods: on that dequeues and other that validates, please have a look", "author": "Sanil15", "createdAt": "2020-02-11T02:18:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5NjkwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5Nzc5MQ==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377397791", "bodyText": "This class doesnt seem warranted, delete perhaps?\nOn a side note, if its accessed by a single thread it doesnt need to be a concurrent-queue.", "author": "rmatharu", "createdAt": "2020-02-11T00:35:12Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/container/placements/DequeuedPlacementActionsCache.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager.container.placements;\n+\n+import java.util.Set;\n+import java.util.UUID;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+\n+/**\n+ * FIFO cache that maintains de-queued container actions. This cache is only accessed by one thread,\n+ * {@link org.apache.samza.clustermanager.container.placement.ContainerPlacementRequestAllocator} thread in ClusterBasedJobCoordinator\n+ *\n+ */\n+public class DequeuedPlacementActionsCache {", "originalCommit": "2786bd695014a5c79ee4f60c170225682473ed98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQxOTk4MA==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377419980", "bodyText": "Removed the use of concurrent-queue, added comments about thread safety, made the cache generified", "author": "Sanil15", "createdAt": "2020-02-11T02:13:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5Nzc5MQ=="}], "type": "inlineReview"}, {"oid": "3923e3f61d3c7251d958e5d5053d59fa5b28bb41", "url": "https://github.com/apache/samza/commit/3923e3f61d3c7251d958e5d5053d59fa5b28bb41", "message": "Address comments, making cache generified", "committedDate": "2020-02-11T02:02:48Z", "type": "commit"}, {"oid": "df083f41fcaa1150606ef859dbaa3e1a1679f2eb", "url": "https://github.com/apache/samza/commit/df083f41fcaa1150606ef859dbaa3e1a1679f2eb", "message": "Cleaned up duplicate package name", "committedDate": "2020-02-11T02:15:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNjYzOQ==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377936639", "bodyText": "/**\nHelper function to create a {@link ContainerPlacementResponseMessage} using BLA-BLA params of\n{@link ContainerPlacementRequestMessage} and the given additional parameters.\n*/", "author": "rmatharu", "createdAt": "2020-02-11T22:25:35Z", "path": "samza-api/src/main/java/org/apache/samza/container/placement/ContainerPlacementResponseMessage.java", "diffHunk": "@@ -42,7 +42,7 @@ public ContainerPlacementResponseMessage(UUID uuid, String deploymentId, String\n     this(uuid, deploymentId, processorId, destinationHost, null, statusCode, responseMessage, timestamp);\n   }\n \n-  static ContainerPlacementResponseMessage fromContainerPlacementRequestMessage(\n+  public static ContainerPlacementResponseMessage fromContainerPlacementRequestMessage(", "originalCommit": "df083f41fcaa1150606ef859dbaa3e1a1679f2eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3MzE1Ng==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377973156", "bodyText": "Sure adding docs", "author": "Sanil15", "createdAt": "2020-02-12T00:06:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNjYzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NDIyNw==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377944227", "bodyText": "Could be called placementRequestsCache?\n/**\nIn-memory cache of placement requests UUIDs dequeued from the coordinator-store,\nused to dedup requests with the same request UUID.\nSized using max tolerable memory footprint and max likely duplicate-spacing.\n*/", "author": "rmatharu", "createdAt": "2020-02-11T22:43:31Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -65,15 +73,19 @@\n    * Key is chosen to be processorId since at a time only one placement action can be in progress on a container.\n    */\n   private final ConcurrentHashMap<String, ContainerPlacementMetadata> actions;\n+  private final BoundedFifoCache<UUID> dequeuedActionsCache;", "originalCommit": "df083f41fcaa1150606ef859dbaa3e1a1679f2eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3MzI1Nw==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377973257", "bodyText": "Sure added docs", "author": "Sanil15", "createdAt": "2020-02-12T00:06:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0NDIyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1MTc5Nw==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377951797", "bodyText": "Would info logging be useful here?", "author": "rmatharu", "createdAt": "2020-02-11T23:02:31Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -371,39 +390,60 @@ private boolean hasActiveContainerPlacementAction(String processorId) {\n     return Optional.ofNullable(this.actions.get(processorId));\n   }\n \n+  private void updateContainerPlacementActionStatus(ContainerPlacementMetadata metadata,\n+      ContainerPlacementMessage.StatusCode statusCode, String responseMessage) {\n+    metadata.setActionStatus(statusCode, responseMessage);\n+    writeContainerPlacementResponseMessage(metadata.getRequestMessage(), statusCode, responseMessage);\n+    LOG.info(\"Status updated for ContainerPlacement action: {}\", metadata);\n+  }\n+\n+  private void writeContainerPlacementResponseMessage(ContainerPlacementRequestMessage requestMessage,\n+      ContainerPlacementMessage.StatusCode statusCode, String responseMessage) {\n+    containerPlacementMetadataStore.writeContainerPlacementResponseMessage(\n+        ContainerPlacementResponseMessage.fromContainerPlacementRequestMessage(requestMessage, statusCode,\n+            responseMessage, System.currentTimeMillis()));\n+  }\n+\n   /**\n-   * A valid container placement action is only issued for a running processor with a valid processor id which has no\n-   * in flight container requests. Duplicate actions are handled by deduping on uuid\n+   * If there is an existing inflight request or container is pending a start, the container placement action shall wait\n+   * until this in-flight action is complete\n    *\n-   * TODO: SAMZA-2402: Disallow pending Container Placement actions in metastore on job restarts\n+   * @param requestMessage container placement request message\n+   * @return true if action should be taken right now, false if it needs to wait to be taken in future\n    */\n-  private Pair<ContainerPlacementMessage.StatusCode, String> checkValidControlAction(String processorId, String destinationHost, UUID uuid) {\n-    String errorMessagePrefix =\n-        String.format(\"ControlAction to move or restart container with processor id %s to host %s is rejected due to\",\n-            processorId, destinationHost);\n+  private boolean deQueueAction(ContainerPlacementRequestMessage requestMessage) {\n+    // Do not dequeue action wait for the in-flight action to complete\n+    if (hasActiveContainerPlacementAction(requestMessage.getProcessorId())) {\n+      return false;\n+    }\n+    // Do not dequeue the action wait for the container to come to a running state\n+    if (!samzaApplicationState.runningProcessors.containsKey(requestMessage.getProcessorId())\n+        || samzaApplicationState.pendingProcessors.containsKey(requestMessage.getProcessorId())) {\n+      return false;", "originalCommit": "df083f41fcaa1150606ef859dbaa3e1a1679f2eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3MDIxMw==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377970213", "bodyText": "Yea instead of logging where it is called, I logged here", "author": "Sanil15", "createdAt": "2020-02-11T23:56:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1MTc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1MjM0OA==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377952348", "bodyText": "Does this imply that a previous placement-action exists or container is not yet running?", "author": "rmatharu", "createdAt": "2020-02-11T23:04:00Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -285,34 +300,40 @@ void handleExpiredRequest(String processorId, String preferredHost,\n    * @param containerAllocator to request physical resources\n    */\n   public void registerContainerPlacementAction(ContainerPlacementRequestMessage requestMessage, ContainerAllocator containerAllocator) {\n-    LOG.info(\"Received a ContainerPlacement action request: {}\", requestMessage);\n     String processorId = requestMessage.getProcessorId();\n     String destinationHost = requestMessage.getDestinationHost();\n-    Pair<ContainerPlacementMessage.StatusCode, String> actionStatus =\n-        checkValidControlAction(processorId, destinationHost, requestMessage.getUuid());\n-\n+    // Is the action ready to be de-queued and taken or it needs to wait to be executed in future\n+    if (!deQueueAction(requestMessage)) {\n+      LOG.info(\"ContainerPlacement request is en-queued metadata: {}\", requestMessage);", "originalCommit": "df083f41fcaa1150606ef859dbaa3e1a1679f2eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk3MzYyOA==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377973628", "bodyText": "yes, added that message to logging", "author": "Sanil15", "createdAt": "2020-02-12T00:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1MjM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1NDk0MQ==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377954941", "bodyText": "Perhaps move to org.apache.samza.util", "author": "rmatharu", "createdAt": "2020-02-11T23:11:07Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/utils/BoundedFifoCache.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager.utils;", "originalCommit": "df083f41fcaa1150606ef859dbaa3e1a1679f2eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2OTc2Mw==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377969763", "bodyText": "sure", "author": "Sanil15", "createdAt": "2020-02-11T23:55:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1NDk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2MDgyOQ==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377960829", "bodyText": "Could we use  a simpler \"util\" implementation here like so\npublic class BoundedLinkedHashSet<T> {\n    private final int cacheSize;\n    private final LinkedHashSet<T> actionQueue;\n\n    public BoundedLinkedHashSet(int size) {\n      this.actionQueue = new LinkedHashSet<>();\n      this.cacheSize = size;\n    }\n\n    public boolean containsKey(T element) {\n      return actionQueue.contains(element);\n    }\n\n    public void put(T element) {\n      // check remaining capacity in the bounded linked-hash-set\n      int capacity = cacheSize - actionQueue.size();\n\n      // if there is none, remove some elements\n      if (capacity <= 0) {\n        Iterator iterator = actionQueue.iterator();\n        while (iterator.hasNext() && capacity <= 0) {\n          iterator.remove();\n          capacity++;\n        }\n      }\n      actionQueue.add(element);\n    }\n  }", "author": "rmatharu", "createdAt": "2020-02-11T23:27:49Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/utils/BoundedFifoCache.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager.utils;\n+\n+import java.util.HashSet;\n+import java.util.LinkedList;\n+import java.util.Queue;\n+import java.util.Set;\n+\n+/**\n+ * FIFO cache that maintains de-queued container actions. This cache is only accessed by one thread,\n+ * {@link org.apache.samza.clustermanager.container.placement.ContainerPlacementRequestAllocator} thread in ClusterBasedJobCoordinator\n+ *\n+ * This class is not thread-safe\n+ */\n+public class BoundedFifoCache<T> {\n+\n+  private final int cacheSize;\n+  private final Queue<T> actionQueue;\n+  private final Set<T> actionCache;\n+\n+  public BoundedFifoCache(int size) {\n+    this.actionQueue = new LinkedList<T>();\n+    this.actionCache = new HashSet<T>();\n+    this.cacheSize = size;\n+  }\n+\n+  public boolean containsKey(T element) {\n+    return actionCache.contains(element);\n+  }\n+\n+  public void put(T element) {\n+    if (actionCache.size() > cacheSize) {\n+      T evictedElement = actionQueue.poll();\n+      actionCache.remove(evictedElement);\n+    }\n+    actionCache.add(element);\n+    actionQueue.add(element);\n+  }\n+}", "originalCommit": "df083f41fcaa1150606ef859dbaa3e1a1679f2eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2ODY2OA==", "url": "https://github.com/apache/samza/pull/1267#discussion_r377968668", "bodyText": "Yup we can use it since it is FIFO: get put remove is o(1)", "author": "Sanil15", "createdAt": "2020-02-11T23:53:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2MDgyOQ=="}], "type": "inlineReview"}, {"oid": "215e3f851987a4362c21da8762be916493f5577f", "url": "https://github.com/apache/samza/commit/215e3f851987a4362c21da8762be916493f5577f", "message": "Adding docs improving cache to just use LinkedHashSet", "committedDate": "2020-02-12T00:18:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg0NTUzNQ==", "url": "https://github.com/apache/samza/pull/1267#discussion_r380845535", "bodyText": "This is really a BoundedLinkedHashSet, the fact that we're using it as a fifo cache is irrelevant.\nWe should call it a BoundedLinkedHashSet; which I think will be useful for other purposes, e.g., storing control actions in autosizing.", "author": "rmatharu", "createdAt": "2020-02-18T18:10:00Z", "path": "samza-core/src/main/java/org/apache/samza/util/BoundedFifoCache.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.util;\n+\n+import java.util.Iterator;\n+import java.util.LinkedHashSet;\n+import java.util.Set;\n+\n+/**\n+ * FIFO cache of size cacheSize\n+ *\n+ * This class is not thread-safe\n+ */\n+public class BoundedFifoCache<T> {", "originalCommit": "215e3f851987a4362c21da8762be916493f5577f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg1ODkzNw==", "url": "https://github.com/apache/samza/pull/1267#discussion_r380858937", "bodyText": "I think the name is intuitive enough, it's a BoundedFifoCache, what it's using underneath should be abstracted. But I am ok with using BoundedLinkedHashSet as well", "author": "Sanil15", "createdAt": "2020-02-18T18:36:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg0NTUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MTc4MA==", "url": "https://github.com/apache/samza/pull/1267#discussion_r380861780", "bodyText": "I agree its intuitive for this use-case, but the constituents may not always be \"cached\" elements. They can for example be a time-window of actions that are held/stored in this data structure when its not being used as a cache.\nThis is akin to how a DelayedQueue is called that, even\nthough 99% of the time it'd be used to schedule input to a scheduler.\nThe name of the class is supposed to describe what it does, not how/what it can be used for.", "author": "rmatharu", "createdAt": "2020-02-18T18:41:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg0NTUzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg0NjQ2NQ==", "url": "https://github.com/apache/samza/pull/1267#discussion_r380846465", "bodyText": ".....container placement requests queued for the previous are deleted.....", "author": "rmatharu", "createdAt": "2020-02-18T18:11:41Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -279,40 +298,49 @@ void handleExpiredRequest(String processorId, String preferredHost,\n    * When host affinity is enabled move / restart is allowed on specific or ANY_HOST\n    * TODO: SAMZA-2378: Container Placements for Standby containers enabled jobs\n    *\n+   * Container placement requests are tied to deploymentId which is currently {@link org.apache.samza.config.ApplicationConfig#APP_RUN_ID}\n+   * On job restarts container placement requests queued for the previous deployment are invalidated using this", "originalCommit": "215e3f851987a4362c21da8762be916493f5577f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg0ODU0Nw==", "url": "https://github.com/apache/samza/pull/1267#discussion_r380848547", "bodyText": "Just making a note here: This can be used in the future to allow adding ContainerPlacementRequestMessage that are scheduled to run in the future, e.g., when they are formulated and ordered by a KafkaCruiseControl-like controller-system.", "author": "rmatharu", "createdAt": "2020-02-18T18:15:47Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -371,39 +397,62 @@ private boolean hasActiveContainerPlacementAction(String processorId) {\n     return Optional.ofNullable(this.actions.get(processorId));\n   }\n \n+  private void updateContainerPlacementActionStatus(ContainerPlacementMetadata metadata,\n+      ContainerPlacementMessage.StatusCode statusCode, String responseMessage) {\n+    metadata.setActionStatus(statusCode, responseMessage);\n+    writeContainerPlacementResponseMessage(metadata.getRequestMessage(), statusCode, responseMessage);\n+    LOG.info(\"Status updated for ContainerPlacement action: {}\", metadata);\n+  }\n+\n+  private void writeContainerPlacementResponseMessage(ContainerPlacementRequestMessage requestMessage,\n+      ContainerPlacementMessage.StatusCode statusCode, String responseMessage) {\n+    containerPlacementMetadataStore.writeContainerPlacementResponseMessage(\n+        ContainerPlacementResponseMessage.fromContainerPlacementRequestMessage(requestMessage, statusCode,\n+            responseMessage, System.currentTimeMillis()));\n+  }\n+\n   /**\n-   * A valid container placement action is only issued for a running processor with a valid processor id which has no\n-   * in flight container requests. Duplicate actions are handled by deduping on uuid\n+   * If there is an existing inflight request or container is pending a start, the container placement action shall wait\n+   * until this in-flight action is complete", "originalCommit": "215e3f851987a4362c21da8762be916493f5577f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4e2c7e90a83c263561a6ff4237fbb5f0680f08e1", "url": "https://github.com/apache/samza/commit/4e2c7e90a83c263561a6ff4237fbb5f0680f08e1", "message": "minor improvements", "committedDate": "2020-02-18T18:39:49Z", "type": "commit"}]}