{"pr_number": 1361, "pr_title": "SAMZA-2525:Fix race condition in ClientHelper#isActiveApplication", "pr_createdAt": "2020-05-15T18:47:43Z", "pr_url": "https://github.com/apache/samza/pull/1361", "timeline": [{"oid": "f9454648812908553ccd483fcba4a4fd6e2f19c4", "url": "https://github.com/apache/samza/commit/f9454648812908553ccd483fcba4a4fd6e2f19c4", "message": "SAMZA-2525:Fix race condition in ClientHelper#isActiveApplication\n\nSymptom:Incorrect job status reported, which is previous deployed job status instead of current job.\nCause:ClientHelper#isActiveApplication is invoking toAppStatus twice when comparing status to Running or New. It could happen that 1st time, the status is New which failed Running check, and 2nd invocation returns Running, which failed New check, this will result in the current app to be classified as non active causing ClientHelper to return job status of a previous deployed app.\nChanges: Update ClientHelper#isActiveApplication to invoke toAppStatus once and compare both status against this single result.\nTests: None\nAPI Changes: None\nUpgrade Instructions: None\nUsage Instructions: None", "committedDate": "2020-05-15T18:42:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk5NDU2NQ==", "url": "https://github.com/apache/samza/pull/1361#discussion_r425994565", "bodyText": "but application report does not change.. so how would toAppStatus return different values for the same applicationReport? i thought applicationReport does NOT change within the same invocation of isActiveAppliction.", "author": "lakshmi-manasa-g", "createdAt": "2020-05-15T19:04:08Z", "path": "samza-yarn/src/main/scala/org/apache/samza/job/yarn/ClientHelper.scala", "diffHunk": "@@ -301,8 +301,8 @@ class ClientHelper(conf: Configuration) extends Logging {\n   }\n \n   private def isActiveApplication(applicationReport: ApplicationReport): Boolean = {\n-    (Running.equals(toAppStatus(applicationReport).get)\n-    || New.equals(toAppStatus(applicationReport).get))\n+    val status = toAppStatus(applicationReport).get", "originalCommit": "f9454648812908553ccd483fcba4a4fd6e2f19c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk5NzI0NA==", "url": "https://github.com/apache/samza/pull/1361#discussion_r425997244", "bodyText": "You are right applicationReport does not change, however, there is another check in ClientHelper#allContainersRunning to check metrics against AM on \"needed-containers\"\nif needed-container is non zero, the status will be be NEW\nonly when needed-containers is zero, the status will be returned as RUNNING.\nSee\ndef allContainersRunning(applicationReport: ApplicationReport): Boolean = {\n    val amClient: ApplicationMasterRestClient = createAmClient(applicationReport)\n\n    debug(\"Created client: \" + amClient.toString)\n\n    try {\n      val metrics = amClient.getMetrics\n      debug(\"Got metrics: \" + metrics.toString)\n\n      val neededContainers = Integer.parseInt(\n        metrics.get(classOf[SamzaAppMasterMetrics].getCanonicalName)\n          .get(\"needed-containers\")\n          .toString)\n\n      info(\"Needed containers: \" + neededContainers)\n      if (neededContainers == 0) {\n        true\n      } else {\n        false\n      }\n\nand\nClientHelper#toAppStatus\ncase (YarnApplicationState.RUNNING, _) =>\n        if (allContainersRunning(applicationReport)) {\n          Some(Running)\n        } else {\n          Some(New)\n        }", "author": "kw2542", "createdAt": "2020-05-15T19:10:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk5NDU2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk5ODMyOA==", "url": "https://github.com/apache/samza/pull/1361#discussion_r425998328", "bodyText": "thanks for clarifying. makes sense", "author": "lakshmi-manasa-g", "createdAt": "2020-05-15T19:12:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk5NDU2NQ=="}], "type": "inlineReview"}]}