{"pr_number": 1358, "pr_title": "SAMZA-2522: Add metadata generator for azure storage blob", "pr_createdAt": "2020-05-08T02:47:17Z", "pr_url": "https://github.com/apache/samza/pull/1358", "timeline": [{"oid": "21febc0a7ded13c5c73ea6083d2c04dca4cb62d1", "url": "https://github.com/apache/samza/commit/21febc0a7ded13c5c73ea6083d2c04dca4cb62d1", "message": "SAMZA-2522: Add metadata to azure storage blob", "committedDate": "2020-05-08T02:21:33Z", "type": "commit"}, {"oid": "c340bd00ed9a20d9c992fbf5ba009041ccac22ee", "url": "https://github.com/apache/samza/commit/c340bd00ed9a20d9c992fbf5ba009041ccac22ee", "message": "fix typo", "committedDate": "2020-05-08T02:46:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUwOTk4OQ==", "url": "https://github.com/apache/samza/pull/1358#discussion_r425509989", "bodyText": "Does this need to have an extra . at the end so it gets stripped off in getSystemMetadataGeneratorConfigs?", "author": "cameronlee314", "createdAt": "2020-05-15T01:00:47Z", "path": "samza-azure/src/main/java/org/apache/samza/system/azureblob/AzureBlobConfig.java", "diffHunk": "@@ -94,6 +95,18 @@\n   public static final String SYSTEM_SUFFIX_RANDOM_STRING_TO_BLOB_NAME = SYSTEM_AZUREBLOB_PREFIX + \"suffixRandomStringToBlobName\";\n   private static final boolean SYSTEM_SUFFIX_RANDOM_STRING_TO_BLOB_NAME_DEFAULT = true;\n \n+  // full class name of an implementation of org.apache.samza.system.azureblob.utils.BlobMetadataGeneratorFactory\n+  // this factory should return an implementation of org.apache.samza.system.azureblob.utils.BlobMetadataGenerator\n+  // this generator will be invoked when a blob is committed to add metadata properties to it\n+  public static final String SYSTEM_BLOB_METADATA_PROPERTIES_GENERATOR_FACTORY = SYSTEM_AZUREBLOB_PREFIX + \"metadataPropertiesGeneratorFactory\";\n+  private static final String SYSTEM_BLOB_METADATA_PROPERTIES_GENERATOR_FACTORY_DEFAULT =\n+      \"org.apache.samza.system.azureblob.utils.NullBlobMetadataGeneratorFactory\";\n+\n+  // Additional configs for the metadata generator should be prefixed with this string which is passed to the generator.\n+  // for example, to pass a \"key\":\"value\" pair to the metadata generator, add config like\n+  // systems.<system-name>.azureblob.metadataGeneratorConfig.<key> with value <value>\n+  public static final String SYSTEM_BLOB_METADATA_GENERATOR_CONFIG_PREFIX = SYSTEM_AZUREBLOB_PREFIX + \"metadataGeneratorConfig\";", "originalCommit": "c340bd00ed9a20d9c992fbf5ba009041ccac22ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUxMTgyNA==", "url": "https://github.com/apache/samza/pull/1358#discussion_r425511824", "bodyText": "Minor: For consistency, consider naming these getSystemBlobMetadata...", "author": "cameronlee314", "createdAt": "2020-05-15T01:08:35Z", "path": "samza-azure/src/main/java/org/apache/samza/system/azureblob/AzureBlobConfig.java", "diffHunk": "@@ -185,4 +198,13 @@ public long getMaxBlobSize(String systemName) {\n   public long getMaxMessagesPerBlob(String systemName) {\n     return getLong(String.format(SYSTEM_MAX_MESSAGES_PER_BLOB, systemName), SYSTEM_MAX_MESSAGES_PER_BLOB_DEFAULT);\n   }\n+\n+  public String getSystemMetadataPropertiesGeneratorFactory(String systemName) {\n+    return get(String.format(SYSTEM_BLOB_METADATA_PROPERTIES_GENERATOR_FACTORY, systemName),\n+        SYSTEM_BLOB_METADATA_PROPERTIES_GENERATOR_FACTORY_DEFAULT);\n+  }\n+\n+  public Config getSystemMetadataGeneratorConfigs(String systemName) {\n+    return subset(String.format(SYSTEM_BLOB_METADATA_GENERATOR_CONFIG_PREFIX, systemName));", "originalCommit": "c340bd00ed9a20d9c992fbf5ba009041ccac22ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUxMzkxOQ==", "url": "https://github.com/apache/samza/pull/1358#discussion_r425513919", "bodyText": "If an existing case needs this BLOB_RAW_SIZE_BYTES_METADATA, then will they need to implement their own blob metadata generator?", "author": "cameronlee314", "createdAt": "2020-05-15T01:17:03Z", "path": "samza-azure/src/main/java/org/apache/samza/system/azureblob/avro/AzureBlobOutputStream.java", "diffHunk": "@@ -172,8 +193,8 @@ public synchronized void close() {\n       future.get((long) flushTimeoutMs, TimeUnit.MILLISECONDS);\n       LOG.info(\"For blob: {} committing blockList size:{}\", blobAsyncClient.getBlobUrl().toString(), blockList.size());\n       metrics.updateAzureCommitMetrics();\n-      Map<String, String> blobMetadata = Collections.singletonMap(BLOB_RAW_SIZE_BYTES_METADATA, Long.toString(totalUploadedBlockSize));", "originalCommit": "c340bd00ed9a20d9c992fbf5ba009041ccac22ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUzMDUzNg==", "url": "https://github.com/apache/samza/pull/1358#discussion_r425530536", "bodyText": "ah, yes. they will need to implement their own generator. Updated the PR description to reflect backwards incompatible.  is that ok?", "author": "lakshmi-manasa-g", "createdAt": "2020-05-15T02:23:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUxMzkxOQ=="}], "type": "inlineReview"}, {"oid": "6d0cf1fd64c9654c755c3053c99c6123eadbd919", "url": "https://github.com/apache/samza/commit/6d0cf1fd64c9654c755c3053c99c6123eadbd919", "message": "address comments for configs", "committedDate": "2020-05-15T02:33:51Z", "type": "commit"}, {"oid": "51e8f19fac4ea6065889228b255e66b5bdc02dcf", "url": "https://github.com/apache/samza/commit/51e8f19fac4ea6065889228b255e66b5bdc02dcf", "message": "Trigger build", "committedDate": "2020-05-15T17:20:08Z", "type": "commit"}]}