{"pr_number": 1278, "pr_title": "SAMZA-2458: Update ProcessJobFactory and ThreadJobFactory to load full job config", "pr_createdAt": "2020-02-14T17:57:45Z", "pr_url": "https://github.com/apache/samza/pull/1278", "timeline": [{"oid": "71e2573429a9437884eb7748693af092eb03ad2a", "url": "https://github.com/apache/samza/commit/71e2573429a9437884eb7748693af092eb03ad2a", "message": "SAMZA-2458: Update ProcessJobFactory and ThreadJobFactory to load full job config\n\nDesign:\nhttps://cwiki.apache.org/confluence/display/SAMZA/SEP-23%3A+Simplify+Job+Runner\n\nChanges:\n1. Update ProcessJobFactory to load full job config, execute planning and write full job config back to coordiantor stream, which was done by RemoteApplicationRunner\n2. Update ThreadJobFactory to load full job config, execute planning and write full job config back to coordiantor stream, which was done by RemoteApplicationRunner\n\nAPI Changes:\nNone\n\nUpgrade Instructions:\nNone\n\nUsage Instructions:\nNone\n\nTests\n1. Local deploy a yarn job and verified it is working properly.", "committedDate": "2020-02-14T17:52:51Z", "type": "commit"}, {"oid": "4db667203d2f164bd2eb57ddbb8830f5b36705e3", "url": "https://github.com/apache/samza/commit/4db667203d2f164bd2eb57ddbb8830f5b36705e3", "message": "Update error message", "committedDate": "2020-02-14T17:56:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU3MDk3Nw==", "url": "https://github.com/apache/samza/pull/1278#discussion_r379570977", "bodyText": "Let's just call this jobModelManager", "author": "prateekm", "createdAt": "2020-02-14T18:07:40Z", "path": "samza-core/src/main/scala/org/apache/samza/job/local/ProcessJobFactory.scala", "diffHunk": "@@ -51,15 +70,11 @@ class ProcessJobFactory extends StreamJobFactory with Logging {\n     val coordinatorStreamStore: CoordinatorStreamStore = new CoordinatorStreamStore(config, new MetricsRegistryMap())\n     coordinatorStreamStore.init()\n \n-    val configFromCoordinatorStream: Config = CoordinatorStreamUtil.readConfigFromCoordinatorStream(coordinatorStreamStore)\n-\n     val changelogStreamManager = new ChangelogStreamManager(new NamespaceAwareCoordinatorStreamStore(coordinatorStreamStore, SetChangelogMapping.TYPE))\n-\n-    val coordinator = JobModelManager(configFromCoordinatorStream, changelogStreamManager.readPartitionMapping(),\n-      coordinatorStreamStore, metricsRegistry)\n+    val coordinator = JobModelManager(config, changelogStreamManager.readPartitionMapping(), coordinatorStreamStore, metricsRegistry)", "originalCommit": "4db667203d2f164bd2eb57ddbb8830f5b36705e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU3OTI0OQ==", "url": "https://github.com/apache/samza/pull/1278#discussion_r379579249", "bodyText": "updated, nice catch, not sure why it was named coordinator before.", "author": "kw2542", "createdAt": "2020-02-14T18:27:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU3MDk3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU3MTE0Nw==", "url": "https://github.com/apache/samza/pull/1278#discussion_r379571147", "bodyText": "Minor: Let's remove \"stand alone\"", "author": "prateekm", "createdAt": "2020-02-14T18:08:01Z", "path": "samza-core/src/main/scala/org/apache/samza/job/local/ProcessJobFactory.scala", "diffHunk": "@@ -22,25 +22,44 @@ package org.apache.samza.job.local\n import java.util\n \n import org.apache.samza.SamzaException\n+import org.apache.samza.application.ApplicationUtil\n+import org.apache.samza.application.descriptors.ApplicationDescriptorUtil\n import org.apache.samza.config.{Config, JobConfig, TaskConfig}\n import org.apache.samza.container.TaskName\n import org.apache.samza.coordinator.metadatastore.{CoordinatorStreamStore, NamespaceAwareCoordinatorStreamStore}\n import org.apache.samza.coordinator.stream.messages.SetChangelogMapping\n import org.apache.samza.coordinator.{JobModelManager, MetadataResourceUtil}\n+import org.apache.samza.execution.RemoteJobPlanner\n import org.apache.samza.job.model.JobModelUtil\n import org.apache.samza.job.{CommandBuilder, ShellCommandBuilder, StreamJob, StreamJobFactory}\n import org.apache.samza.metrics.MetricsRegistryMap\n import org.apache.samza.startpoint.StartpointManager\n import org.apache.samza.storage.ChangelogStreamManager\n-import org.apache.samza.util.{CoordinatorStreamUtil, Logging, ReflectionUtil}\n+import org.apache.samza.util.{ConfigUtil, CoordinatorStreamUtil, DiagnosticsUtil, Logging, ReflectionUtil}\n \n import scala.collection.JavaConversions._\n \n /**\n  * Creates a stand alone ProcessJob with the specified config.", "originalCommit": "4db667203d2f164bd2eb57ddbb8830f5b36705e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU3MjA4Mw==", "url": "https://github.com/apache/samza/pull/1278#discussion_r379572083", "bodyText": "It'll be useful to explain in the PR description why this change is necessary (under Changes), and what has changed from a user perspective (in the API changes section).", "author": "prateekm", "createdAt": "2020-02-14T18:10:16Z", "path": "samza-core/src/main/scala/org/apache/samza/job/local/ProcessJobFactory.scala", "diffHunk": "@@ -22,25 +22,44 @@ package org.apache.samza.job.local\n import java.util\n \n import org.apache.samza.SamzaException\n+import org.apache.samza.application.ApplicationUtil\n+import org.apache.samza.application.descriptors.ApplicationDescriptorUtil\n import org.apache.samza.config.{Config, JobConfig, TaskConfig}\n import org.apache.samza.container.TaskName\n import org.apache.samza.coordinator.metadatastore.{CoordinatorStreamStore, NamespaceAwareCoordinatorStreamStore}\n import org.apache.samza.coordinator.stream.messages.SetChangelogMapping\n import org.apache.samza.coordinator.{JobModelManager, MetadataResourceUtil}\n+import org.apache.samza.execution.RemoteJobPlanner\n import org.apache.samza.job.model.JobModelUtil\n import org.apache.samza.job.{CommandBuilder, ShellCommandBuilder, StreamJob, StreamJobFactory}\n import org.apache.samza.metrics.MetricsRegistryMap\n import org.apache.samza.startpoint.StartpointManager\n import org.apache.samza.storage.ChangelogStreamManager\n-import org.apache.samza.util.{CoordinatorStreamUtil, Logging, ReflectionUtil}\n+import org.apache.samza.util.{ConfigUtil, CoordinatorStreamUtil, DiagnosticsUtil, Logging, ReflectionUtil}\n \n import scala.collection.JavaConversions._\n \n /**\n  * Creates a stand alone ProcessJob with the specified config.\n  */\n class ProcessJobFactory extends StreamJobFactory with Logging {\n-  def getJob(config: Config): StreamJob = {\n+  def getJob(submissionConfig: Config): StreamJob = {\n+    val originalConfig = ConfigUtil.loadConfig(submissionConfig)", "originalCommit": "4db667203d2f164bd2eb57ddbb8830f5b36705e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU4MTkxMg==", "url": "https://github.com/apache/samza/pull/1278#discussion_r379581912", "bodyText": "Updated.", "author": "kw2542", "createdAt": "2020-02-14T18:33:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU3MjA4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU3MjU4NQ==", "url": "https://github.com/apache/samza/pull/1278#discussion_r379572585", "bodyText": "\"Only single stage jobs are supported with ProcessJobFactory.\"", "author": "prateekm", "createdAt": "2020-02-14T18:11:26Z", "path": "samza-core/src/main/scala/org/apache/samza/job/local/ProcessJobFactory.scala", "diffHunk": "@@ -22,25 +22,44 @@ package org.apache.samza.job.local\n import java.util\n \n import org.apache.samza.SamzaException\n+import org.apache.samza.application.ApplicationUtil\n+import org.apache.samza.application.descriptors.ApplicationDescriptorUtil\n import org.apache.samza.config.{Config, JobConfig, TaskConfig}\n import org.apache.samza.container.TaskName\n import org.apache.samza.coordinator.metadatastore.{CoordinatorStreamStore, NamespaceAwareCoordinatorStreamStore}\n import org.apache.samza.coordinator.stream.messages.SetChangelogMapping\n import org.apache.samza.coordinator.{JobModelManager, MetadataResourceUtil}\n+import org.apache.samza.execution.RemoteJobPlanner\n import org.apache.samza.job.model.JobModelUtil\n import org.apache.samza.job.{CommandBuilder, ShellCommandBuilder, StreamJob, StreamJobFactory}\n import org.apache.samza.metrics.MetricsRegistryMap\n import org.apache.samza.startpoint.StartpointManager\n import org.apache.samza.storage.ChangelogStreamManager\n-import org.apache.samza.util.{CoordinatorStreamUtil, Logging, ReflectionUtil}\n+import org.apache.samza.util.{ConfigUtil, CoordinatorStreamUtil, DiagnosticsUtil, Logging, ReflectionUtil}\n \n import scala.collection.JavaConversions._\n \n /**\n  * Creates a stand alone ProcessJob with the specified config.\n  */\n class ProcessJobFactory extends StreamJobFactory with Logging {\n-  def getJob(config: Config): StreamJob = {\n+  def getJob(submissionConfig: Config): StreamJob = {\n+    val originalConfig = ConfigUtil.loadConfig(submissionConfig)\n+\n+    // Execute planning\n+    val planner = new RemoteJobPlanner(ApplicationDescriptorUtil.getAppDescriptor(ApplicationUtil.fromConfig(originalConfig), originalConfig))\n+    val jobConfigs = planner.prepareJobs\n+\n+    if (jobConfigs.size != 1) {\n+      throw new SamzaException(\"Only single process job is supported.\")", "originalCommit": "4db667203d2f164bd2eb57ddbb8830f5b36705e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bf4fbc96f6e905ced180b815eb73c2f90388edf0", "url": "https://github.com/apache/samza/commit/bf4fbc96f6e905ced180b815eb73c2f90388edf0", "message": "Address prateekm's feedback", "committedDate": "2020-02-14T18:29:20Z", "type": "commit"}, {"oid": "0ab2aa8fae906918a04ea132dfb7426b15563bd1", "url": "https://github.com/apache/samza/commit/0ab2aa8fae906918a04ea132dfb7426b15563bd1", "message": "Update", "committedDate": "2020-02-14T19:43:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5MzkwNQ==", "url": "https://github.com/apache/samza/pull/1278#discussion_r379693905", "bodyText": "From the naming of RemoteJobPlanner, this seems out of place. I believe RemoteJobPlanner was intended for use in RemoteApplicationRunner, but theoretically, any ApplicationRunner can be used with any StreamJobFactory.\nI guess the layers of abstraction are changing with the simplification of the job runners, but maybe we should rename some classes/interfaces and make sure the logic is in the right place as well.", "author": "cameronlee314", "createdAt": "2020-02-14T23:52:46Z", "path": "samza-core/src/main/scala/org/apache/samza/job/local/ProcessJobFactory.scala", "diffHunk": "@@ -22,25 +22,48 @@ package org.apache.samza.job.local\n import java.util\n \n import org.apache.samza.SamzaException\n+import org.apache.samza.application.ApplicationUtil\n+import org.apache.samza.application.descriptors.ApplicationDescriptorUtil\n import org.apache.samza.config.{Config, JobConfig, TaskConfig}\n import org.apache.samza.container.TaskName\n import org.apache.samza.coordinator.metadatastore.{CoordinatorStreamStore, NamespaceAwareCoordinatorStreamStore}\n import org.apache.samza.coordinator.stream.messages.SetChangelogMapping\n import org.apache.samza.coordinator.{JobModelManager, MetadataResourceUtil}\n+import org.apache.samza.execution.RemoteJobPlanner\n import org.apache.samza.job.model.JobModelUtil\n import org.apache.samza.job.{CommandBuilder, ShellCommandBuilder, StreamJob, StreamJobFactory}\n import org.apache.samza.metrics.MetricsRegistryMap\n import org.apache.samza.startpoint.StartpointManager\n import org.apache.samza.storage.ChangelogStreamManager\n-import org.apache.samza.util.{CoordinatorStreamUtil, Logging, ReflectionUtil}\n+import org.apache.samza.util.{ConfigUtil, CoordinatorStreamUtil, DiagnosticsUtil, Logging, ReflectionUtil}\n \n import scala.collection.JavaConversions._\n \n /**\n- * Creates a stand alone ProcessJob with the specified config.\n+ * Creates a ProcessJob with the specified config.\n  */\n class ProcessJobFactory extends StreamJobFactory with Logging {\n-  def getJob(config: Config): StreamJob = {\n+  def getJob(submissionConfig: Config): StreamJob = {\n+    var config = submissionConfig\n+\n+    if (new JobConfig(submissionConfig).getConfigLoaderFactory.isPresent) {\n+      val originalConfig = ConfigUtil.loadConfig(submissionConfig)\n+\n+      // Execute planning\n+      val planner = new RemoteJobPlanner(ApplicationDescriptorUtil.getAppDescriptor(ApplicationUtil.fromConfig(originalConfig), originalConfig))", "originalCommit": "0ab2aa8fae906918a04ea132dfb7426b15563bd1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NTIwOA==", "url": "https://github.com/apache/samza/pull/1278#discussion_r379695208", "bodyText": "Agree, it is interesting that StreamJobFactory is only used in JobRunner, and JobRunner is only used in RemoteApplicationRunner, i.e. StreamJobFactory is only intended to be used for remote job, so RemoteJobPlanner technically fits here. I agree we have excessive layers in our structure which should be simplified to avoid future confusion.", "author": "kw2542", "createdAt": "2020-02-14T23:59:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5MzkwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NDA4Nw==", "url": "https://github.com/apache/samza/pull/1278#discussion_r379694087", "bodyText": "Similar to above: does this only need to be consistent with RemoteApplicationRunner?", "author": "cameronlee314", "createdAt": "2020-02-14T23:53:48Z", "path": "samza-core/src/main/scala/org/apache/samza/job/local/ProcessJobFactory.scala", "diffHunk": "@@ -22,25 +22,48 @@ package org.apache.samza.job.local\n import java.util\n \n import org.apache.samza.SamzaException\n+import org.apache.samza.application.ApplicationUtil\n+import org.apache.samza.application.descriptors.ApplicationDescriptorUtil\n import org.apache.samza.config.{Config, JobConfig, TaskConfig}\n import org.apache.samza.container.TaskName\n import org.apache.samza.coordinator.metadatastore.{CoordinatorStreamStore, NamespaceAwareCoordinatorStreamStore}\n import org.apache.samza.coordinator.stream.messages.SetChangelogMapping\n import org.apache.samza.coordinator.{JobModelManager, MetadataResourceUtil}\n+import org.apache.samza.execution.RemoteJobPlanner\n import org.apache.samza.job.model.JobModelUtil\n import org.apache.samza.job.{CommandBuilder, ShellCommandBuilder, StreamJob, StreamJobFactory}\n import org.apache.samza.metrics.MetricsRegistryMap\n import org.apache.samza.startpoint.StartpointManager\n import org.apache.samza.storage.ChangelogStreamManager\n-import org.apache.samza.util.{CoordinatorStreamUtil, Logging, ReflectionUtil}\n+import org.apache.samza.util.{ConfigUtil, CoordinatorStreamUtil, DiagnosticsUtil, Logging, ReflectionUtil}\n \n import scala.collection.JavaConversions._\n \n /**\n- * Creates a stand alone ProcessJob with the specified config.\n+ * Creates a ProcessJob with the specified config.\n  */\n class ProcessJobFactory extends StreamJobFactory with Logging {\n-  def getJob(config: Config): StreamJob = {\n+  def getJob(submissionConfig: Config): StreamJob = {\n+    var config = submissionConfig\n+\n+    if (new JobConfig(submissionConfig).getConfigLoaderFactory.isPresent) {\n+      val originalConfig = ConfigUtil.loadConfig(submissionConfig)\n+\n+      // Execute planning\n+      val planner = new RemoteJobPlanner(ApplicationDescriptorUtil.getAppDescriptor(ApplicationUtil.fromConfig(originalConfig), originalConfig))\n+      val jobConfigs = planner.prepareJobs\n+\n+      if (jobConfigs.size != 1) {\n+        throw new SamzaException(\"Only single process job is supported.\")\n+      }\n+\n+      // This is the full job config\n+      config = jobConfigs.get(0)\n+      // This needs to be consistent with RemoteApplicationRunner#run where JobRunner#submit to be called instead of JobRunner#run\n+      CoordinatorStreamUtil.writeConfigToCoordinatorStream(config)\n+      DiagnosticsUtil.createDiagnosticsStream(config)", "originalCommit": "0ab2aa8fae906918a04ea132dfb7426b15563bd1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NTMxOQ==", "url": "https://github.com/apache/samza/pull/1278#discussion_r379695319", "bodyText": "Yes, StreamFactory is only used by JobRunner, which is only used by RemoteApplicationRunner.", "author": "kw2542", "createdAt": "2020-02-15T00:00:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NDA4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NDUxOA==", "url": "https://github.com/apache/samza/pull/1278#discussion_r379694518", "bodyText": "Could you please update this comment? It looks like it was out-of-date before you made your changes, but would be nice to clarify it now.", "author": "cameronlee314", "createdAt": "2020-02-14T23:55:52Z", "path": "samza-core/src/main/scala/org/apache/samza/job/local/ProcessJobFactory.scala", "diffHunk": "@@ -87,13 +106,13 @@ class ProcessJobFactory extends StreamJobFactory with Logging {\n     val commandBuilder = ReflectionUtil.getObj(commandBuilderClass, classOf[CommandBuilder])\n \n     // JobCoordinator is stopped by ProcessJob when it exits", "originalCommit": "0ab2aa8fae906918a04ea132dfb7426b15563bd1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NDU5Nw==", "url": "https://github.com/apache/samza/pull/1278#discussion_r379694597", "bodyText": "Similar to above about RemoteJobPlanner", "author": "cameronlee314", "createdAt": "2020-02-14T23:56:12Z", "path": "samza-core/src/main/scala/org/apache/samza/job/local/ThreadJobFactory.scala", "diffHunk": "@@ -45,20 +47,36 @@ import scala.collection.mutable\n   * Creates a new Thread job with the given config\n   */\n class ThreadJobFactory extends StreamJobFactory with Logging {\n-  def getJob(config: Config): StreamJob = {\n+  def getJob(submissionConfig: Config): StreamJob = {\n     info(\"Creating a ThreadJob, which is only meant for debugging.\")\n+    var config = submissionConfig\n+    if (new JobConfig(submissionConfig).getConfigLoaderFactory.isPresent) {\n+      val originalConfig = ConfigUtil.loadConfig(submissionConfig)\n+\n+      // Execute planning\n+      val planner = new RemoteJobPlanner(ApplicationDescriptorUtil.getAppDescriptor(ApplicationUtil.fromConfig(originalConfig), originalConfig))", "originalCommit": "0ab2aa8fae906918a04ea132dfb7426b15563bd1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NDcwNw==", "url": "https://github.com/apache/samza/pull/1278#discussion_r379694707", "bodyText": "This block seems duplicated with ProcessJobFactory. Any benefit in sharing code?", "author": "cameronlee314", "createdAt": "2020-02-14T23:56:45Z", "path": "samza-core/src/main/scala/org/apache/samza/job/local/ThreadJobFactory.scala", "diffHunk": "@@ -45,20 +47,36 @@ import scala.collection.mutable\n   * Creates a new Thread job with the given config\n   */\n class ThreadJobFactory extends StreamJobFactory with Logging {\n-  def getJob(config: Config): StreamJob = {\n+  def getJob(submissionConfig: Config): StreamJob = {\n     info(\"Creating a ThreadJob, which is only meant for debugging.\")\n+    var config = submissionConfig\n+    if (new JobConfig(submissionConfig).getConfigLoaderFactory.isPresent) {", "originalCommit": "0ab2aa8fae906918a04ea132dfb7426b15563bd1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NTUxOA==", "url": "https://github.com/apache/samza/pull/1278#discussion_r379695518", "bodyText": "I am planning to simplify and refactor all of them after I introduces beam related planning.", "author": "kw2542", "createdAt": "2020-02-15T00:01:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NDcwNw=="}], "type": "inlineReview"}, {"oid": "9bd448c5785ad463fa91d0418adfeb51a0739914", "url": "https://github.com/apache/samza/commit/9bd448c5785ad463fa91d0418adfeb51a0739914", "message": "Fix comment", "committedDate": "2020-02-18T21:49:53Z", "type": "commit"}]}