{"pr_number": 3295, "pr_title": "feat: Java REGAPIC Pagination implementation", "pr_createdAt": "2020-10-13T06:15:04Z", "pr_url": "https://github.com/googleapis/gapic-generator/pull/3295", "timeline": [{"oid": "61036ae3fe06bbddee81b7694c88e0858bfce36b", "url": "https://github.com/googleapis/gapic-generator/commit/61036ae3fe06bbddee81b7694c88e0858bfce36b", "message": "feat: Java REGAPIC Pagination implementation", "committedDate": "2020-10-13T06:12:35Z", "type": "commit"}, {"oid": "660b6a95cf44d0e97526dd8b08077ab32d3c4a28", "url": "https://github.com/googleapis/gapic-generator/commit/660b6a95cf44d0e97526dd8b08077ab32d3c4a28", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-10-13T06:15:57Z", "type": "commit"}, {"oid": "f837a026b96f235e3de71de25e06868ef09fadc8", "url": "https://github.com/googleapis/gapic-generator/commit/f837a026b96f235e3de71de25e06868ef09fadc8", "message": "Merge branch 'master' into master", "committedDate": "2020-10-13T23:46:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyMDc5Mw==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r504320793", "bodyText": "Add a brief motivating comment for startsWith(\"1.\")?", "author": "miraleung", "createdAt": "2020-10-13T23:47:41Z", "path": "src/main/java/com/google/api/codegen/config/GapicProductConfig.java", "diffHunk": "@@ -100,6 +100,12 @@\n   @Nullable\n   public abstract String getConfigSchemaVersion();\n \n+  public boolean isDiscogapic() {\n+    return (getTransportProtocol() == TransportProtocol.HTTP\n+        && getConfigSchemaVersion() != null\n+        && getConfigSchemaVersion().startsWith(\"1.\"));", "originalCommit": "f837a026b96f235e3de71de25e06868ef09fadc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY4OTY1Nw==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r509689657", "bodyText": "Both DIREGAPIC and DISCOGAPIC have TransportProtocol as HTTP, but discogapic is always gapic yaml v1, while DIREGAPIC is always gapic yaml v2 or no gapic yaml at all. This is the most reliable way to distinguish between the two without introducing a new \"transport protocol\". Also discogapic and diregapic share significant portion of logic, that is why I'm reusing TransportProtocol.HTTP in DIREGAPIC..", "author": "vam-google", "createdAt": "2020-10-21T20:55:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyMDc5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyMTM3NA==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r504321374", "bodyText": "Add a brief comment that only the first map or repeated (list) field is used? This may not be obvious to folks who have not read the design doc.", "author": "miraleung", "createdAt": "2020-10-13T23:49:47Z", "path": "src/main/java/com/google/api/codegen/transformer/TestCaseTransformer.java", "diffHunk": "@@ -384,7 +384,11 @@ private InitCodeContext createResponseInitCodeContext(\n       FieldModel field = config.getResourcesField();\n       InitCodeNode initCodeNode;\n       if (field.isRepeated()) {\n-        initCodeNode = InitCodeNode.createSingletonList(config.getResourcesFieldName());\n+        if (field.isMap()) {", "originalCommit": "f837a026b96f235e3de71de25e06868ef09fadc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ4MzcyOA==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r510483728", "bodyText": "+1", "author": "vchudnov-g", "createdAt": "2020-10-22T22:02:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyMTM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk4NDQwMQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r510984401", "bodyText": "(If you look at the PR in conversation view, you may not see [I don't, for sure] that I am +1 Mira's PR comment, where she suggests a code comment. If you go the file view, you'll see the whole comment thread. The GH review system has its issues....)", "author": "vchudnov-g", "createdAt": "2020-10-23T15:59:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyMTM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyMTU2Ng==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r504321566", "bodyText": "Do we need something similar for !type.isMap() && type.isRepeated()?", "author": "miraleung", "createdAt": "2020-10-13T23:50:19Z", "path": "src/main/java/com/google/api/codegen/transformer/java/JavaModelTypeNameConverter.java", "diffHunk": "@@ -146,6 +146,9 @@ private TypeName getTypeNameForElementType(TypeRef type, boolean shouldBoxPrimit\n     }\n     switch (type.getKind()) {\n       case TYPE_MESSAGE:\n+        if (type.isMap() && type.isMessage() && type.isRepeated()) {\n+          return getMapTypeName(type);", "originalCommit": "f837a026b96f235e3de71de25e06868ef09fadc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkwODI4Nw==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r509908287", "bodyText": "Actually if isMap() == true  then isMessage() == true and isRepeated() == true automatically (just checked the implementation of those method in api-compiler). Removed the other 2 conditions from the if statement as they are 100% redundant.", "author": "vam-google", "createdAt": "2020-10-22T06:26:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyMTU2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyMjAxNg==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r504322016", "bodyText": "Nit: Did you mean IsEntrySet? When a reader sees \"as,\" they may expect this method to convert resourcesField into an entry set.\nConsider adding a comment with a sample resourceTypeName value.", "author": "miraleung", "createdAt": "2020-10-13T23:51:49Z", "path": "src/main/java/com/google/api/codegen/viewmodel/PageStreamingDescriptorClassView.java", "diffHunk": "@@ -45,6 +45,10 @@\n \n   public abstract boolean resourcesFieldIsMap();\n \n+  public boolean resourcesFieldAsEntrySet() {\n+    return resourceTypeName() != null && resourceTypeName().contains(\"<\");", "originalCommit": "f837a026b96f235e3de71de25e06868ef09fadc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkwOTI4NQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r509909285", "bodyText": "Agree, no idea why I called that resourceFieldAsEntrySet instead of resourceFieldIsEntrySet. Renamed.", "author": "vam-google", "createdAt": "2020-10-22T06:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyMjAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ4NTQ3NQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r510485475", "bodyText": "This still says As", "author": "vchudnov-g", "createdAt": "2020-10-22T22:06:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyMjAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5MjAzMw==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r510492033", "bodyText": "Opps, forgot to push =) Thanks!", "author": "vam-google", "createdAt": "2020-10-22T22:23:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMyMjAxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg1NTQyNQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r504855425", "bodyText": "Thanks for having this function! It will make understanding the code easier.", "author": "vchudnov-g", "createdAt": "2020-10-14T17:36:57Z", "path": "src/main/java/com/google/api/codegen/config/GapicProductConfig.java", "diffHunk": "@@ -100,6 +100,12 @@\n   @Nullable\n   public abstract String getConfigSchemaVersion();\n \n+  public boolean isDiscogapic() {", "originalCommit": "f837a026b96f235e3de71de25e06868ef09fadc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2NTcyNg==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r504865726", "bodyText": "As per the open discussion in the design doc, let's decide whether we want the generators aware of \"diregapic mode\", which is essentially what you're doing here. The assumption so far has been generators would not be aware of the provenance of the protos, and that's something I still want to keep if possible (though I'm certainly open to counter-arguments).\nIn the meantime, in the interest of being able to generate testing clients soon, please add (just inside the outermost if) something like TODO: Conform to design doc spec, once approved, for using non-standard paging fields,", "author": "vchudnov-g", "createdAt": "2020-10-14T17:54:17Z", "path": "src/main/java/com/google/api/codegen/config/PageStreamingConfig.java", "diffHunk": "@@ -237,10 +240,16 @@ static PageStreamingConfig createPageStreamingConfig(\n \n     // Toggle pagination based on presence of paging params.\n     // See https://cloud.google.com/apis/design/design_patterns for API pagination pattern.\n-    ProtoField tokenField = methodModel.getInputField(ProtoPagingParameters.nameForPageToken());\n-    ProtoField pageSizeField = methodModel.getInputField(ProtoPagingParameters.nameForPageSize());\n+    ProtoPagingParameters pagingParams = new ProtoPagingParameters();\n+    ProtoField tokenField = methodModel.getInputField(pagingParams.getNameForPageToken());\n+    ProtoField pageSizeField = methodModel.getInputField(pagingParams.getNameForPageSize());\n+    if (pageSizeField == null) {\n+      if (language == TargetLanguage.JAVA && transportProtocol == TransportProtocol.HTTP) {", "originalCommit": "f837a026b96f235e3de71de25e06868ef09fadc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxNDMxMw==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r508814313", "bodyText": "The generators cannot not know which client they generated. The number of places where it is needed is limited, but is still present. It is easy for me to remove this check, but I'm afraid of breaking some of the existing clients OnePlatform clients", "author": "vam-google", "createdAt": "2020-10-20T20:22:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2NTcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ4MjUzNw==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r510482537", "bodyText": "(qq: \"where it is needed\" -> what does \"it\" refer to? this check?)\nWe shouldn't have this check in the final product unless it turns out we really need it (eg breaking the current clients---which I don't think we will since the cascading rules you formulated should prevent that). When we remove the check, yes, it makes sense to regenerate existing clients to make sure there are no changes, or, if there are, that they be additive.\nFor now, for this MValpha, I'm fine keeping this check as long as we include a TODO flagging it prominently wherever it appears.", "author": "vchudnov-g", "createdAt": "2020-10-22T21:59:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2NTcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk3OTE0OA==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r510979148", "bodyText": "Thanks for the TODO, but please make it a bit stronger. (I'm concerned about people copying this as a reference implementation when we may decide something else in the design doc).\nHow about TODO: Conform to design doc spec, once approved, for using non-standard paging fields (such as max_results for page_size)?", "author": "vchudnov-g", "createdAt": "2020-10-23T15:50:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2NTcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE0OTg5OQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r511149899", "bodyText": "Added.\nI noticed you almost always ask for reformulating my original comments/todos. I don't have a strong opinion about wording of these things. For those comments which you have strong opinion about please consider providing the exact wording you want it to be in the original review comment, this will let us save some review cycles.", "author": "vam-google", "createdAt": "2020-10-23T20:51:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2NTcyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2NzU1Mw==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r504867553", "bodyText": "Wouldn't we want PARAMETER_MAX_RESULTS in here as well? (I might be miunderstanding how this is used)", "author": "vchudnov-g", "createdAt": "2020-10-14T17:57:15Z", "path": "src/main/java/com/google/api/codegen/configgen/ProtoPagingParameters.java", "diffHunk": "@@ -21,10 +21,11 @@\n public class ProtoPagingParameters implements PagingParameters {\n   private static final String PARAMETER_PAGE_TOKEN = \"page_token\";\n   private static final String PARAMETER_NEXT_PAGE_TOKEN = \"next_page_token\";\n-  private static final String PARAMETER_MAX_RESULTS = \"page_size\";\n+  private static final String PARAMETER_PAGE_SIZE = \"page_size\";\n+  private static final String PARAMETER_MAX_RESULTS = \"max_results\";\n \n   private static final ImmutableList<String> IGNORED_PARAMETERS =\n-      ImmutableList.of(PARAMETER_PAGE_TOKEN, PARAMETER_MAX_RESULTS);\n+      ImmutableList.of(PARAMETER_PAGE_TOKEN, PARAMETER_PAGE_SIZE);", "originalCommit": "f837a026b96f235e3de71de25e06868ef09fadc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxODc4Nw==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r508818787", "bodyText": "This logic is used only in gapic config generation, i.e. in basically dead code not used anywhere now. We can add it there but it will not affect anything (I just did not want to touch dead code if not necessary).", "author": "vam-google", "createdAt": "2020-10-20T20:29:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2NzU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ4MzU2OQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r510483569", "bodyText": "Oh, OK. Right, we're in configgen. But you are changing/adding PARAMETER_PAGE_SIZE and PARAMETER_MAX_RESULTS, so then it's not really dead?", "author": "vchudnov-g", "createdAt": "2020-10-22T22:01:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2NzU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ5MTM1Ng==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r510491356", "bodyText": "This was just a queer coincidence. the java constant for the \"page_size\" string literal was called PARAMETER_MAX_RESULTS. So to add \"max_results\" parameter and that code to keep making sense I had to rename the old constant to PARAMETER_PAGE_SIZE first =)", "author": "vam-google", "createdAt": "2020-10-22T22:21:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2NzU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk4MjU3Mw==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r510982573", "bodyText": "Yeah, that part I saw. But my point is that those PARAMETER_* are being used elsewhere, so they're not dead code. But you're saying IGNORED_PARAMETERS is dead code, yet you changed the parameter name without adding the new parameter. So it seems to me that for consistency, you would add the new parameter here, since it would also be ignored if we were generating a config file. I would either add it or add a comment saying it would be added if it mattered....\nBut this is totally minor and not a blocker.", "author": "vchudnov-g", "createdAt": "2020-10-23T15:56:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2NzU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MDQ1MQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r511150451", "bodyText": "It is dead code but it may be still used in discogapic (i'm not sure if it is, but discogapic depends on gapic yaml generation). I did not want to touch that if not necessary. Discogapic is essentially dead code at this point.", "author": "vam-google", "createdAt": "2020-10-23T20:53:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2NzU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg3NDIzMQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r504874231", "bodyText": "The structure in the previous file led me to conclude that isMap \u21d2 isRepeated. Is that true (making the last condition redundant)?", "author": "vchudnov-g", "createdAt": "2020-10-14T18:08:58Z", "path": "src/main/java/com/google/api/codegen/transformer/java/JavaModelTypeNameConverter.java", "diffHunk": "@@ -146,6 +146,9 @@ private TypeName getTypeNameForElementType(TypeRef type, boolean shouldBoxPrimit\n     }\n     switch (type.getKind()) {\n       case TYPE_MESSAGE:\n+        if (type.isMap() && type.isMessage() && type.isRepeated()) {", "originalCommit": "f837a026b96f235e3de71de25e06868ef09fadc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxOTA3NQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r508819075", "bodyText": "Probably, but I was not sure, so made it as rigorous as possible.", "author": "vam-google", "createdAt": "2020-10-20T20:29:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg3NDIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkxOTcyMQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r509919721", "bodyText": "I confirmed by checking the implementation of the isMessage() and isRepeated() and isMap() method that if isMap() is true than the other two are guaranteed to be true as well. Removed the other method calls since they are redundant.", "author": "vam-google", "createdAt": "2020-10-22T06:53:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg3NDIzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg3NDY3Mg==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r504874672", "bodyText": "Love this! Much clearer ;-)\nYou can remove the comment in the previous line now, because the code is self-explanatory now (and the comment is now confusing).", "author": "vchudnov-g", "createdAt": "2020-10-14T18:09:42Z", "path": "src/main/java/com/google/api/codegen/transformer/java/JavaSurfaceTransformer.java", "diffHunk": "@@ -933,7 +933,7 @@ private void addRpcStubImports(InterfaceContext context) {\n         typeTable.saveNicknameFor(\"com.google.api.pathtemplate.PathTemplate\");\n         String configSchemaVersion = context.getProductConfig().getConfigSchemaVersion();\n         // Discogapic always uses gapic yaml of version 1.0\n-        if (configSchemaVersion != null && configSchemaVersion.startsWith(\"1.\")) {\n+        if (context.getProductConfig().isDiscogapic()) {", "originalCommit": "f837a026b96f235e3de71de25e06868ef09fadc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg4ODM0NA==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r504888344", "bodyText": "For consistency and easy, could you move this message below ListShelvesResponse, so that ListShelves{Request,Response} are adjacent, and AggregatedListShelves{Request,Response} are adjacent?", "author": "vchudnov-g", "createdAt": "2020-10-14T18:32:17Z", "path": "src/test/java/com/google/api/codegen/testsrc/protoannotations/library.proto", "diffHunk": "@@ -669,6 +675,15 @@ message ListShelvesRequest {\n   // not be treated as a paged method unless there is a GAPIC config override.\n }\n \n+// Request message for LibraryService.ListAggregatedShelves.\n+message AggregatedListShelvesRequest {", "originalCommit": "f837a026b96f235e3de71de25e06868ef09fadc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyMDQ0Mw==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r509920443", "bodyText": "This is not as easy, because I'll have to update all the baseline files and it is pain.\n[Edit] It turned out the change of the order affected only ruby and nodejs baselines, so I moved the messages and updated the baselines.", "author": "vam-google", "createdAt": "2020-10-22T06:54:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg4ODM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg4OTA1NQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r504889055", "bodyText": "For consistency with the other message pairs, could your rename this AggregatedListShelvesResponse to match the request?", "author": "vchudnov-g", "createdAt": "2020-10-14T18:33:26Z", "path": "src/test/java/com/google/api/codegen/testsrc/protoannotations/library.proto", "diffHunk": "@@ -682,6 +697,15 @@ message ListShelvesResponse {\n   string next_page_token = 2;\n }\n \n+// Response message for LibraryService.ListAggregatedShelves.\n+message ListShelvesAggregatedResponse {", "originalCommit": "f837a026b96f235e3de71de25e06868ef09fadc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyMTE2MA==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r509921160", "bodyText": "Renamed it to match the other similar method/request/response:\n// existing sample\nrpc ListShelves(ListShelvesRequest) returns (ListShelvesResponse)\n\n// Renamed the aggregated one to\nrpc ListAggregatedShelves(ListAggregatedShelvesRequest) returns (ListAggregatedShelvesResponse)", "author": "vam-google", "createdAt": "2020-10-22T06:56:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg4OTA1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5MDI5NQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r504890295", "bodyText": "I suggest AggregatedListShelves for similarity with GCE. Or better yet, a more descriptive name, like MapPageListShelves (not that I like that particular one).\nWhatever you choose, make sure the request and response names are consistent with this (currently they're not): rpc Foo(FooRequest) returns (FooResponse)", "author": "vchudnov-g", "createdAt": "2020-10-14T18:35:30Z", "path": "src/test/java/com/google/api/codegen/testsrc/protoannotations/library.proto", "diffHunk": "@@ -84,6 +84,12 @@ service LibraryService {\n     option (google.api.method_signature) = \"\";\n   }\n \n+  // Lists shelves.\n+  rpc ListAggregatedShelves(AggregatedListShelvesRequest) returns (ListShelvesAggregatedResponse) {", "originalCommit": "f837a026b96f235e3de71de25e06868ef09fadc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5MDc0Mw==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r504890743", "bodyText": "Could you add a brief comment as to why we have this since we already have ListShelves?", "author": "vchudnov-g", "createdAt": "2020-10-14T18:36:17Z", "path": "src/test/java/com/google/api/codegen/testsrc/protoannotations/library.proto", "diffHunk": "@@ -84,6 +84,12 @@ service LibraryService {\n     option (google.api.method_signature) = \"\";\n   }\n \n+  // Lists shelves.", "originalCommit": "f837a026b96f235e3de71de25e06868ef09fadc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ3MTYyNA==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r510471624", "bodyText": "This is to have a paginated method with map<> resource in it. ListShelves is a regular paginated method with repeated resource in it.", "author": "vam-google", "createdAt": "2020-10-22T21:34:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5MDc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ4NTg4OQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r510485889", "bodyText": "Could you add that to the comment?", "author": "vchudnov-g", "createdAt": "2020-10-22T22:07:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5MDc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUzMTkwMA==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r510531900", "bodyText": "Please lets not do it. All of the comments in the proto become the generated docs in the generated clients.", "author": "vam-google", "createdAt": "2020-10-23T00:28:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5MDc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk4NzM0Ng==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r510987346", "bodyText": "And the problem with that is what? More changes to the baseline files? Anything else?\nHow about if you create the comment separated from the proto by a newline? I'd be happy with that, as it would explain things for someone reading the .proto, and maybe that wouldn't change the baseline files?\n\n// ListAggregatedShelves tests paged calls that return maps of lists paged in parallel.\n\n// Lists shelves.\nrpc ListAggregatedShelves.(...) returns (...) {\n  ...\n}", "author": "vchudnov-g", "createdAt": "2020-10-23T16:04:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5MDc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE0ODc5OQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r511148799", "bodyText": "Added the comment. You are right, if there is a blank line it is not recognized as the method comment.\nOn a side note this is not what is done i the rest of the library.proto. All the documentation/comments ther is API-specific, not gapic-generator specific.", "author": "vam-google", "createdAt": "2020-10-23T20:49:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg5MDc0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkxMDA3Ng==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r504910076", "bodyText": "I'm a bit confused.\n\nThis looks very similar to the comment for  UnaryCallable<ListShelvesRequest, ListShelvesPagedResponse>, which is sensible, but it does not have the  for (Shelf element : future.get().iterateAll()). Why not?\nExpanding on the above: IIUC, the AggregatedListShelvesRequest method tests the non-standard paged response, but we want that to be transparent to the user. So just like ListShelves causes listShelves() and listShelvedPagedCallable() to be generated in the client, I would expect AggregatedListShelves() and AggregatedListShelvesPageable() to be generated. We want the surface to be be what they would have if they were using standard pagination fields.\n\n(I realize GCE does not have a previous GAPIC to compare to, and that AIP-compliant APIs won't have this issue, but  we should still do this, particularly as allowing both patterns is a GAPIC feature.)", "author": "vchudnov-g", "createdAt": "2020-10-14T19:10:05Z", "path": "src/test/java/com/google/api/codegen/protoannotations/testdata/java_library.baseline", "diffHunk": "@@ -8608,6 +8608,62 @@ public class LibraryClient implements BackgroundResource {\n     return stub.testOptionalRequiredFlatteningParamsCallable();\n   }\n \n+  // AUTO-GENERATED DOCUMENTATION AND METHOD\n+  /**\n+   * Lists shelves.\n+   *\n+   * Sample code:\n+   * <pre><code>\n+   * try (LibraryClient libraryClient = LibraryClient.create()) {\n+   *\n+   *   ListShelvesAggregatedResponse response = libraryClient.listAggregatedShelves();\n+   * }\n+   * </code></pre>\n+   * @throws com.google.api.gax.rpc.ApiException if the remote call fails\n+   */\n+  public final ListShelvesAggregatedResponse listAggregatedShelves() {\n+    AggregatedListShelvesRequest request =\n+        AggregatedListShelvesRequest.newBuilder().build();\n+    return listAggregatedShelves(request);\n+  }\n+\n+  // AUTO-GENERATED DOCUMENTATION AND METHOD\n+  /**\n+   * Lists shelves.\n+   *\n+   * Sample code:\n+   * <pre><code>\n+   * try (LibraryClient libraryClient = LibraryClient.create()) {\n+   *   AggregatedListShelvesRequest request = AggregatedListShelvesRequest.newBuilder().build();\n+   *   ListShelvesAggregatedResponse response = libraryClient.listAggregatedShelves(request);\n+   * }\n+   * </code></pre>\n+   *\n+   * @param request The request object containing all of the parameters for the API call.\n+   * @throws com.google.api.gax.rpc.ApiException if the remote call fails\n+   */\n+  public final ListShelvesAggregatedResponse listAggregatedShelves(AggregatedListShelvesRequest request) {\n+    return listAggregatedShelvesCallable().call(request);\n+  }\n+\n+  // AUTO-GENERATED DOCUMENTATION AND METHOD\n+  /**\n+   * Lists shelves.\n+   *\n+   * Sample code:\n+   * <pre><code>\n+   * try (LibraryClient libraryClient = LibraryClient.create()) {\n+   *   AggregatedListShelvesRequest request = AggregatedListShelvesRequest.newBuilder().build();\n+   *   ApiFuture&lt;ListShelvesAggregatedResponse&gt; future = libraryClient.listAggregatedShelvesCallable().futureCall(request);", "originalCommit": "f837a026b96f235e3de71de25e06868ef09fadc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyNDkyNA==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r508824924", "bodyText": "Nothing in this file is expected to have new logic in it. It is gRPC-based GAPIC expected output, which is shielded from the new logic by line 247 in PageStreamingConfig (i.e. the same controversial check). The only reason why this file (and most of the other baseline files except java_library_no_gapic_config_http.baseline) was changed is because new messages were added in the library.proto file used for testing.", "author": "vam-google", "createdAt": "2020-10-20T20:40:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkxMDA3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkxMjg4NQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r504912885", "bodyText": "I would expect that (if we were still using the monolith for Go), this would have a similar structure to func (c *LibClient) ListShelves(...){...}, dealing with NextPageToken, etc. Is that right? Is the only reason that's not the case simply that real Go generation is happening in the \u00b5generator? (That's totally fine; I just want to make sure I'm not missing anything.)", "author": "vchudnov-g", "createdAt": "2020-10-14T19:15:12Z", "path": "src/test/java/com/google/api/codegen/protoannotations/testdata/go_library.baseline", "diffHunk": "@@ -2205,6 +2241,18 @@ func (s *mockLibraryServer) ListShelves(ctx context.Context, req *librarypb.List\n     return s.resps[0].(*librarypb.ListShelvesResponse), nil\n }\n \n+func (s *mockLibraryServer) ListAggregatedShelves(ctx context.Context, req *librarypb.AggregatedListShelvesRequest) (*librarypb.ListShelvesAggregatedResponse, error) {", "originalCommit": "f837a026b96f235e3de71de25e06868ef09fadc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyMjE3NA==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r508822174", "bodyText": "Line 247 in PageStreamingConfig.java explicitly asks to use the new logic for Java only. It is important, because it will start breaking other languages in monolith (most importantly PHP). I.e. only java gax supports ma-typed pagination, that is why only Java gapic generation does it.", "author": "vam-google", "createdAt": "2020-10-20T20:35:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkxMjg4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ4NjU4NQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3295#discussion_r510486585", "bodyText": "Ah, got it. So this is a monolith-only problem. ;-)", "author": "vchudnov-g", "createdAt": "2020-10-22T22:09:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDkxMjg4NQ=="}], "type": "inlineReview"}, {"oid": "88b31b4cf979bc40785ca69033e40457cca36fd2", "url": "https://github.com/googleapis/gapic-generator/commit/88b31b4cf979bc40785ca69033e40457cca36fd2", "message": "Address PR feedback", "committedDate": "2020-10-22T07:24:08Z", "type": "commit"}, {"oid": "c767e724e9857363bacf58032e484ab1728bedec", "url": "https://github.com/googleapis/gapic-generator/commit/c767e724e9857363bacf58032e484ab1728bedec", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-10-22T07:27:54Z", "type": "commit"}, {"oid": "1f3b59a271efdeb45f0f619c5d4d0950bb61d8cb", "url": "https://github.com/googleapis/gapic-generator/commit/1f3b59a271efdeb45f0f619c5d4d0950bb61d8cb", "message": "Merge branch 'master' of github.com:vam-google/gapic-generator", "committedDate": "2020-10-22T07:32:31Z", "type": "commit"}, {"oid": "7ef6c071ec7486d603d20b6b6482432e8ec83259", "url": "https://github.com/googleapis/gapic-generator/commit/7ef6c071ec7486d603d20b6b6482432e8ec83259", "message": "Address PR feedback", "committedDate": "2020-10-23T00:35:29Z", "type": "commit"}, {"oid": "30a563b5be44a0548926c324258a14f15f1c3a08", "url": "https://github.com/googleapis/gapic-generator/commit/30a563b5be44a0548926c324258a14f15f1c3a08", "message": "Address PR feedback", "committedDate": "2020-10-23T20:48:07Z", "type": "commit"}]}