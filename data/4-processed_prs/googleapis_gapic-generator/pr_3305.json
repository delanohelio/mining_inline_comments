{"pr_number": 3305, "pr_title": "feat: add DIREGAPIC support for PHP", "pr_createdAt": "2020-11-10T22:31:11Z", "pr_url": "https://github.com/googleapis/gapic-generator/pull/3305", "timeline": [{"oid": "287a6586b3497af20b0baeb98e429af9eea757a7", "url": "https://github.com/googleapis/gapic-generator/commit/287a6586b3497af20b0baeb98e429af9eea757a7", "message": "add transport to php gapic bazel rules", "committedDate": "2020-11-10T22:29:41Z", "type": "commit"}, {"oid": "ab81e22a2a2042e28b311d45537be53d3736a014", "url": "https://github.com/googleapis/gapic-generator/commit/ab81e22a2a2042e28b311d45537be53d3736a014", "message": "feat: adds support for PHP DIREGAPIC (WIP)", "committedDate": "2020-11-10T22:29:41Z", "type": "commit"}, {"oid": "66e206cf2c70550923732264ad0ff36d14fe489d", "url": "https://github.com/googleapis/gapic-generator/commit/66e206cf2c70550923732264ad0ff36d14fe489d", "message": "adds DIREGAPIC baseline", "committedDate": "2020-11-10T22:29:41Z", "type": "commit"}, {"oid": "0f7e4eebbee015bc190ec66448e14bf4eec101a3", "url": "https://github.com/googleapis/gapic-generator/commit/0f7e4eebbee015bc190ec66448e14bf4eec101a3", "message": "ensures streaming protos cannot be generated for PHP REST-only GAPICs", "committedDate": "2020-11-10T22:29:41Z", "type": "commit"}, {"oid": "3dcab1b2adb4a6480cfa5a14cf5c8e4d2b8cd9b3", "url": "https://github.com/googleapis/gapic-generator/commit/3dcab1b2adb4a6480cfa5a14cf5c8e4d2b8cd9b3", "message": "addresses two review comments", "committedDate": "2020-11-10T22:29:41Z", "type": "commit"}, {"oid": "b783693ddab947cde275479c82c8c5de9c5ca440", "url": "https://github.com/googleapis/gapic-generator/commit/b783693ddab947cde275479c82c8c5de9c5ca440", "message": "simplifies gapic.yaml for v2", "committedDate": "2020-11-10T22:29:41Z", "type": "commit"}, {"oid": "88d5714c74bd2bf2b4ddc1b5232c2056726eae82", "url": "https://github.com/googleapis/gapic-generator/commit/88d5714c74bd2bf2b4ddc1b5232c2056726eae82", "message": "uses supportsGrpcTransport instead of isRestOnlyTransport", "committedDate": "2020-11-10T22:29:41Z", "type": "commit"}, {"oid": "6e59c21f82cfba8a63428626b1c0a2d1e7f0cf0f", "url": "https://github.com/googleapis/gapic-generator/commit/6e59c21f82cfba8a63428626b1c0a2d1e7f0cf0f", "message": "simplify gapic v2 yaml even more", "committedDate": "2020-11-10T22:29:41Z", "type": "commit"}, {"oid": "dc89f181dbfd92e811c1f65ccd5a186ddb235ea4", "url": "https://github.com/googleapis/gapic-generator/commit/dc89f181dbfd92e811c1f65ccd5a186ddb235ea4", "message": "Merge branch 'master' into add-rest-only-transport-option", "committedDate": "2020-11-13T20:55:48Z", "type": "commit"}, {"oid": "9e0fd512c7fd5dc7649ef46360ca742e4f3d60a8", "url": "https://github.com/googleapis/gapic-generator/commit/9e0fd512c7fd5dc7649ef46360ca742e4f3d60a8", "message": "fix baseline test", "committedDate": "2020-11-13T21:12:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU3MTM2MA==", "url": "https://github.com/googleapis/gapic-generator/pull/3305#discussion_r524571360", "bodyText": "I would add a comment before this if block making it explicitly that we're generating GAPICs that support only one transport for now.", "author": "vchudnov-g", "createdAt": "2020-11-16T20:58:35Z", "path": "src/main/java/com/google/api/codegen/transformer/php/PhpGapicSurfaceTransformer.java", "diffHunk": "@@ -191,14 +195,19 @@ private ViewModel buildGapicClientViewModel(GapicInterfaceContext context) {\n     apiImplClass.clientConfigPath(namer.getClientConfigPath(context.getInterfaceConfig()));\n     apiImplClass.clientConfigName(namer.getClientConfigName(context.getInterfaceConfig()));\n     apiImplClass.interfaceKey(context.getInterface().getFullName());\n-    String grpcClientTypeName =\n-        namer.getAndSaveNicknameForGrpcClientTypeName(\n-            context.getImportTypeTable(), context.getInterfaceModel());\n-    apiImplClass.grpcClientTypeName(grpcClientTypeName);\n+    if (supportsGrpcTransport()) {", "originalCommit": "9e0fd512c7fd5dc7649ef46360ca742e4f3d60a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE4NzQ0MQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3305#discussion_r525187441", "bodyText": "For PHP, this block generates a GAPIC that supports both.", "author": "bshaffer", "createdAt": "2020-11-17T14:16:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU3MTM2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE5MDQ5NA==", "url": "https://github.com/googleapis/gapic-generator/pull/3305#discussion_r525190494", "bodyText": "I've added comments to clarify, let me know if this is sufficient!", "author": "bshaffer", "createdAt": "2020-11-17T14:20:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU3MTM2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU3NTQ3Nw==", "url": "https://github.com/googleapis/gapic-generator/pull/3305#discussion_r524575477", "bodyText": "tiny nit: What about: \"Streaming methods only valid for gRPC transport\"", "author": "vchudnov-g", "createdAt": "2020-11-16T21:02:15Z", "path": "src/main/java/com/google/api/codegen/transformer/php/PhpGapicSurfaceTransformer.java", "diffHunk": "@@ -426,6 +435,9 @@ private RestPlaceholderConfigView generateRestPlaceholderConfigView(\n     List<GrpcStreamingDetailView> result = new ArrayList<>();\n \n     for (MethodModel method : context.getGrpcStreamingMethods()) {\n+      if (!supportsGrpcTransport()) {\n+        throw new RuntimeException(\"Streaming methods invalid for REST-only transport\");", "originalCommit": "9e0fd512c7fd5dc7649ef46360ca742e4f3d60a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU3Nzg2MA==", "url": "https://github.com/googleapis/gapic-generator/pull/3305#discussion_r524577860", "bodyText": "tiny nit: Does order matter here? If not, I would move this to be the least one, for readability.", "author": "vchudnov-g", "createdAt": "2020-11-16T21:04:26Z", "path": "src/main/java/com/google/api/codegen/transformer/php/PhpGapicSurfaceTransformer.java", "diffHunk": "@@ -453,7 +465,9 @@ private void addApiImports(GapicInterfaceContext context) {\n     typeTable.saveNicknameFor(\"\\\\Google\\\\ApiCore\\\\CredentialsWrapper\");\n     typeTable.saveNicknameFor(\"\\\\Google\\\\ApiCore\\\\GapicClientTrait\");\n     typeTable.saveNicknameFor(\"\\\\Google\\\\ApiCore\\\\PathTemplate\");\n-    typeTable.saveNicknameFor(\"\\\\Google\\\\ApiCore\\\\RequestParamsHeaderDescriptor\");\n+    if (supportsGrpcTransport()) {", "originalCommit": "9e0fd512c7fd5dc7649ef46360ca742e4f3d60a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE5MDc5Nw==", "url": "https://github.com/googleapis/gapic-generator/pull/3305#discussion_r525190797", "bodyText": "I agree! Order doesn't matter! Moved for readability.", "author": "bshaffer", "createdAt": "2020-11-17T14:21:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU3Nzg2MA=="}], "type": "inlineReview"}, {"oid": "76f6c1423d76931e18022ed65710c6c77c62100c", "url": "https://github.com/googleapis/gapic-generator/commit/76f6c1423d76931e18022ed65710c6c77c62100c", "message": "address review comments", "committedDate": "2020-11-17T14:20:33Z", "type": "commit"}, {"oid": "8daae83eec821dafb993d5793018d484f11b1156", "url": "https://github.com/googleapis/gapic-generator/commit/8daae83eec821dafb993d5793018d484f11b1156", "message": "Merge branch 'master' into add-rest-only-transport-option", "committedDate": "2020-11-17T14:21:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ0MDczNQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3305#discussion_r525440735", "bodyText": "nit: probably Collections.emptyList() is what you need here.", "author": "vam-google", "createdAt": "2020-11-17T19:40:03Z", "path": "src/main/java/com/google/api/codegen/transformer/php/PhpGapicSurfaceTransformer.java", "diffHunk": "@@ -191,15 +195,22 @@ private ViewModel buildGapicClientViewModel(GapicInterfaceContext context) {\n     apiImplClass.clientConfigPath(namer.getClientConfigPath(context.getInterfaceConfig()));\n     apiImplClass.clientConfigName(namer.getClientConfigName(context.getInterfaceConfig()));\n     apiImplClass.interfaceKey(context.getInterface().getFullName());\n-    String grpcClientTypeName =\n-        namer.getAndSaveNicknameForGrpcClientTypeName(\n-            context.getImportTypeTable(), context.getInterfaceModel());\n-    apiImplClass.grpcClientTypeName(grpcClientTypeName);\n+    if (supportsGrpcTransport()) {\n+      // PHP generates a client that supports both gRPC and REST\n+      String grpcClientTypeName =\n+          namer.getAndSaveNicknameForGrpcClientTypeName(\n+              context.getImportTypeTable(), context.getInterfaceModel());\n+      apiImplClass.grpcClientTypeName(grpcClientTypeName);\n+\n+      apiImplClass.stubs(grpcStubTransformer.generateGrpcStubs(context));\n+    } else {\n+      // PHP generates a client that only supports REST\n+      apiImplClass.grpcClientTypeName(\"\");\n+      apiImplClass.stubs(new ArrayList<>());", "originalCommit": "8daae83eec821dafb993d5793018d484f11b1156", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ0NDk5Ng==", "url": "https://github.com/googleapis/gapic-generator/pull/3305#discussion_r525444996", "bodyText": "How will this behave for existing APIs? There are many APIs that PHP generates the multitransport client and those have streaming methods. I believe in that case PHP still creates a client, just the streaming methods are no-op, but the generation itself does not fail and all the non-streaming methods are present in the generated surface. Will make gapic-generator throwing exception for such APIs and failing the whole generation process as a result?\nAlso, please do not use RuntimeException directly. It is an exception designed to be a base for the other specific exceptions. Please pick something more specific (UnsupportedOperation or something like that)", "author": "vam-google", "createdAt": "2020-11-17T19:43:36Z", "path": "src/main/java/com/google/api/codegen/transformer/php/PhpGapicSurfaceTransformer.java", "diffHunk": "@@ -426,6 +437,9 @@ private RestPlaceholderConfigView generateRestPlaceholderConfigView(\n     List<GrpcStreamingDetailView> result = new ArrayList<>();\n \n     for (MethodModel method : context.getGrpcStreamingMethods()) {\n+      if (!supportsGrpcTransport()) {\n+        throw new RuntimeException(\"Streaming methods only valid for gRPC transport\");", "originalCommit": "8daae83eec821dafb993d5793018d484f11b1156", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e9704b5b9bbbf3c9c50db389b94565e0c94dca9c", "url": "https://github.com/googleapis/gapic-generator/commit/e9704b5b9bbbf3c9c50db389b94565e0c94dca9c", "message": "Merge branch 'master' into add-rest-only-transport-option", "committedDate": "2020-12-01T18:43:59Z", "type": "commit"}, {"oid": "38869973f038c94cf7e808ba10ba2518ef78c2d8", "url": "https://github.com/googleapis/gapic-generator/commit/38869973f038c94cf7e808ba10ba2518ef78c2d8", "message": "Merge branch 'master' into add-rest-only-transport-option", "committedDate": "2020-12-08T21:11:37Z", "type": "commit"}]}