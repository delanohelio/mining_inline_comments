{"pr_number": 10282, "pr_title": "[#10212] Refactor search service's searchInstructor method", "pr_createdAt": "2020-07-06T20:43:07Z", "pr_url": "https://github.com/TEAMMATES/teammates/pull/10282", "timeline": [{"oid": "f497d5972f0abfe857d7b068b80a8122eb926ac8", "url": "https://github.com/TEAMMATES/teammates/commit/f497d5972f0abfe857d7b068b80a8122eb926ac8", "message": "refactor search service (before modifying component test)", "committedDate": "2020-07-06T19:12:56Z", "type": "commit"}, {"oid": "d2a3b9ef0298b8e68154393e5988112310877e2f", "url": "https://github.com/TEAMMATES/teammates/commit/d2a3b9ef0298b8e68154393e5988112310877e2f", "message": "modified the component tests", "committedDate": "2020-07-06T20:10:11Z", "type": "commit"}, {"oid": "3601d5cd5f987bfa61ae8258b9e12b003ce0ee46", "url": "https://github.com/TEAMMATES/teammates/commit/3601d5cd5f987bfa61ae8258b9e12b003ce0ee46", "message": "changed naming convention more intuitively", "committedDate": "2020-07-06T20:32:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU5MTc0OA==", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r450591748", "bodyText": "Although the data has changed shape, we should still have a test for sections to ensure that the number of sections matches.", "author": "t-cheepeng", "createdAt": "2020-07-07T03:29:43Z", "path": "src/web/services/search.service.spec.ts", "diffHunk": "@@ -179,37 +179,26 @@ describe('SearchService', () => {\n     );\n   });\n \n-  it('should parse students into courses with sections correctly', () => {\n+  it('should parse students into courses correctly', () => {\n     const { students }: { students: Student[] } = mockStudents;\n \n     // Number of courses should match\n-    expect(coursesWithSections.length).toEqual(\n+    expect(coursesWithStudents.length).toEqual(\n       Array.from(new Set(students.map((s: Student) => s.courseId))).length,\n     );\n \n-    // Number of sections in a course should match\n+    // Number of students in a course should match\n     expect(\n-      coursesWithSections.filter((t: SearchStudentsTable) => t.courseId === students[0].courseId)[0]\n-        .sections.length,\n+      coursesWithStudents.filter((t: SearchStudentsListRowTable) => t.courseId === students[0].courseId)[0]\n+        .students.length,\n     ).toEqual(\n       Array.from(\n         new Set(\n           students\n-            .filter((s: Student) => s.courseId === students[0].courseId)\n-            .map((s: Student) => s.sectionName),\n+            .filter((s: Student) => s.courseId === students[0].courseId),\n         ),", "originalCommit": "3601d5cd5f987bfa61ae8258b9e12b003ce0ee46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDYyNzE4MQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r450627181", "bodyText": "Ok, I will fix it soon! Thanks.", "author": "edwardkang0925", "createdAt": "2020-07-07T05:56:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU5MTc0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU5MTk0NA==", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r450591944", "bodyText": "Same here. Should rewrite the test to check for number of students in a section instead of removing it", "author": "t-cheepeng", "createdAt": "2020-07-07T03:30:18Z", "path": "src/web/services/search.service.spec.ts", "diffHunk": "@@ -179,37 +179,26 @@ describe('SearchService', () => {\n     );\n   });\n \n-  it('should parse students into courses with sections correctly', () => {\n+  it('should parse students into courses correctly', () => {\n     const { students }: { students: Student[] } = mockStudents;\n \n     // Number of courses should match\n-    expect(coursesWithSections.length).toEqual(\n+    expect(coursesWithStudents.length).toEqual(\n       Array.from(new Set(students.map((s: Student) => s.courseId))).length,\n     );\n \n-    // Number of sections in a course should match\n+    // Number of students in a course should match\n     expect(\n-      coursesWithSections.filter((t: SearchStudentsTable) => t.courseId === students[0].courseId)[0]\n-        .sections.length,\n+      coursesWithStudents.filter((t: SearchStudentsListRowTable) => t.courseId === students[0].courseId)[0]\n+        .students.length,\n     ).toEqual(\n       Array.from(\n         new Set(\n           students\n-            .filter((s: Student) => s.courseId === students[0].courseId)\n-            .map((s: Student) => s.sectionName),\n+            .filter((s: Student) => s.courseId === students[0].courseId),\n         ),\n       ).length,\n     );\n-\n-    // Number of students in a section should match\n-    expect(\n-      coursesWithSections\n-        .filter((t: SearchStudentsTable) => t.courseId === students[0].courseId)[0]\n-        .sections.filter((s: StudentListSectionData) => s.sectionName === students[0].sectionName)[0]\n-        .students.length,\n-    ).toEqual(\n-      students.filter((s: Student) => s.sectionName === students[0].sectionName).length,\n-    );", "originalCommit": "3601d5cd5f987bfa61ae8258b9e12b003ce0ee46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2b1d1fb735bb4b16ff97648b0000c87f193eaae3", "url": "https://github.com/TEAMMATES/teammates/commit/2b1d1fb735bb4b16ff97648b0000c87f193eaae3", "message": "fixed the component tests regarding sections", "committedDate": "2020-07-07T05:58:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyMjUzNA==", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r451122534", "bodyText": "It is too expensive to load section for every student. Either you want to group them first to load privilege for one section or use some cache variable to keep the privilege already loaded. Maybe @t-cheepeng can help.", "author": "xpdavid", "createdAt": "2020-07-07T20:25:25Z", "path": "src/web/services/search.service.ts", "diffHunk": "@@ -167,17 +155,17 @@ export class SearchService {\n   }\n \n   getPrivileges(\n-    coursesWithSections: SearchStudentsTable[],\n+    coursesWithStudents: SearchStudentsListRowTable[],\n   ): Observable<InstructorPrivilege[]> {\n-    if (coursesWithSections.length === 0) {\n+    if (coursesWithStudents.length === 0) {\n       return of([]);\n     }\n     return forkJoin(\n-      coursesWithSections.map((course: SearchStudentsTable) => {\n-        return course.sections.map((section: StudentListSectionData) => {\n+      coursesWithStudents.map((course: SearchStudentsListRowTable) => {\n+        return course.students.map((studentModel: StudentListRowModel) => {\n           return this.instructorService.loadInstructorPrivilege({", "originalCommit": "2b1d1fb735bb4b16ff97648b0000c87f193eaae3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1ODU3NQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r451258575", "bodyText": "I think it would be easier to group the students in the same section together then load the privileges.\n@edwardkang0925 Please take note and try to make the changes for this! If you need any help, please don't hesitate to ask", "author": "t-cheepeng", "createdAt": "2020-07-08T03:17:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyMjUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMwNTg5Ng==", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r452305896", "bodyText": "@t-cheepeng I will work on it and ask question if I get stuck. Thank you!", "author": "edwardkang0925", "createdAt": "2020-07-09T15:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyMjUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4MDczMg==", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r452380732", "bodyText": "@t-cheepeng  I tried to group the students with the same section name, but I couldn't come up with an efficient grouping method, so I used double for-loop to process the data. While doing so, I used a cache variable to keep distinct privileges of each course and assign the cached privileges to each student enrolled in the same course with same section. By doing so, I think I prevented loading duplicated privileges from the back-end. However, I am not confident whether this approach slows down the performance without my acknowledgment. Could you review my modification? Thank you", "author": "edwardkang0925", "createdAt": "2020-07-09T17:33:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyMjUzNA=="}], "type": "inlineReview"}, {"oid": "497c5935e4fd346eed7b32722052a987a9f9eedf", "url": "https://github.com/TEAMMATES/teammates/commit/497c5935e4fd346eed7b32722052a987a9f9eedf", "message": "deleted the declaration of SearchStudentsTable and modified getPrivileges for performance improvement", "committedDate": "2020-07-09T17:04:25Z", "type": "commit"}, {"oid": "8807f8805339ce6aee9a776717c378ef93ac3f0d", "url": "https://github.com/TEAMMATES/teammates/commit/8807f8805339ce6aee9a776717c378ef93ac3f0d", "message": "Merge branch 'master' into searchInstructorRefactor", "committedDate": "2020-07-09T18:27:02Z", "type": "commit"}, {"oid": "c12cf274905823a99aec82258bc44e2f0b751af9", "url": "https://github.com/TEAMMATES/teammates/commit/c12cf274905823a99aec82258bc44e2f0b751af9", "message": "Merge branch 'master' into searchInstructorRefactor", "committedDate": "2020-07-10T02:34:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc4MjI2Mw==", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r452782263", "bodyText": "@edwardkang0925 Try not to use any[] as the type. You should explicitly state the variable type where possible", "author": "t-cheepeng", "createdAt": "2020-07-10T11:17:52Z", "path": "src/web/services/search.service.ts", "diffHunk": "@@ -169,47 +157,44 @@ export class SearchService {\n   }\n \n   getPrivileges(\n-    coursesWithSections: SearchStudentsTable[],\n+    coursesWithStudents: SearchStudentsListRowTable[],\n   ): Observable<InstructorPrivilege[]> {\n-    if (coursesWithSections.length === 0) {\n+    if (coursesWithStudents.length === 0) {\n       return of([]);\n     }\n-    return forkJoin(\n-      coursesWithSections.map((course: SearchStudentsTable) => {\n-        return course.sections.map((section: StudentListSectionData) => {\n-          return this.instructorService.loadInstructorPrivilege({\n-            courseId: course.courseId,\n-            sectionName: section.sectionName,\n-          });\n-        });\n-      }).reduce(\n-        (acc: Observable<InstructorPrivilege>[], val: Observable<InstructorPrivilege>[]) =>\n-        acc.concat(val),\n-        [],\n-      ),\n-    );\n+    const privileges: any[] = [];", "originalCommit": "c12cf274905823a99aec82258bc44e2f0b751af9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMzOTQzNg==", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r453339436", "bodyText": "Hi, I have reflected your feedback on my new commit. I also have another version that uses chaining method (forEach) rather than the for-loops. I think using forEach is easier to read, but I would like to ask for your opinion.\nIn case you want to see the new version, here is a screenshot of it.\nIf you think this is better, I will push it. Thank you!", "author": "edwardkang0925", "createdAt": "2020-07-12T16:56:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc4MjI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQxMzA2OQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r453413069", "bodyText": "Yes, this version is easier to read. You can go ahead with this version instead", "author": "t-cheepeng", "createdAt": "2020-07-13T03:14:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc4MjI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc4NTEwNg==", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r452785106", "bodyText": "You can probably use a Record<string, Observable<InstructorPrivilege>> to make things faster. Map from section name to the observable.", "author": "t-cheepeng", "createdAt": "2020-07-10T11:25:02Z", "path": "src/web/services/search.service.ts", "diffHunk": "@@ -169,47 +157,44 @@ export class SearchService {\n   }\n \n   getPrivileges(\n-    coursesWithSections: SearchStudentsTable[],\n+    coursesWithStudents: SearchStudentsListRowTable[],\n   ): Observable<InstructorPrivilege[]> {\n-    if (coursesWithSections.length === 0) {\n+    if (coursesWithStudents.length === 0) {\n       return of([]);\n     }\n-    return forkJoin(\n-      coursesWithSections.map((course: SearchStudentsTable) => {\n-        return course.sections.map((section: StudentListSectionData) => {\n-          return this.instructorService.loadInstructorPrivilege({\n-            courseId: course.courseId,\n-            sectionName: section.sectionName,\n-          });\n-        });\n-      }).reduce(\n-        (acc: Observable<InstructorPrivilege>[], val: Observable<InstructorPrivilege>[]) =>\n-        acc.concat(val),\n-        [],\n-      ),\n-    );\n+    const privileges: any[] = [];\n+    for (const course of coursesWithStudents) {\n+      const distinctSections: string[] = Array.from(\n+        new Set(course.students.map((studentModel: StudentListRowModel) => studentModel.student.sectionName)));\n+      const instructorPrivileges: Observable<InstructorPrivilege>[] = distinctSections.map((section: string) =>\n+        this.instructorService.loadInstructorPrivilege({ courseId: course.courseId, sectionName: section }));\n+      for (const studentModel of course.students) {\n+        privileges.push(instructorPrivileges[distinctSections.indexOf(studentModel.student.sectionName)]);\n+      }", "originalCommit": "c12cf274905823a99aec82258bc44e2f0b751af9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d3488abf2eb5782de782c9ce8aa86bbf272978e0", "url": "https://github.com/TEAMMATES/teammates/commit/d3488abf2eb5782de782c9ce8aa86bbf272978e0", "message": "specified type of privileges and used Record for performance improvement", "committedDate": "2020-07-12T16:11:03Z", "type": "commit"}, {"oid": "ac081a8095791719ea6493e7838beeacd383bf6d", "url": "https://github.com/TEAMMATES/teammates/commit/ac081a8095791719ea6493e7838beeacd383bf6d", "message": "replaced for loops with forEach", "committedDate": "2020-07-13T03:25:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc1ODY0MQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10282#discussion_r454758641", "bodyText": "\ud83d\udc4d", "author": "xpdavid", "createdAt": "2020-07-15T02:50:36Z", "path": "src/web/services/search.service.ts", "diffHunk": "@@ -169,47 +157,48 @@ export class SearchService {\n   }\n \n   getPrivileges(\n-    coursesWithSections: SearchStudentsTable[],\n+    coursesWithStudents: SearchStudentsListRowTable[],\n   ): Observable<InstructorPrivilege[]> {\n-    if (coursesWithSections.length === 0) {\n+    if (coursesWithStudents.length === 0) {\n       return of([]);\n     }\n-    return forkJoin(\n-      coursesWithSections.map((course: SearchStudentsTable) => {\n-        return course.sections.map((section: StudentListSectionData) => {\n-          return this.instructorService.loadInstructorPrivilege({\n-            courseId: course.courseId,\n-            sectionName: section.sectionName,\n-          });\n-        });\n-      }).reduce(\n-        (acc: Observable<InstructorPrivilege>[], val: Observable<InstructorPrivilege>[]) =>\n-        acc.concat(val),\n-        [],\n-      ),\n-    );\n+    const privileges: Observable<InstructorPrivilege>[] = [];\n+    coursesWithStudents.forEach((course: SearchStudentsListRowTable) => {\n+      const sectionToPrivileges: Record<string, Observable<InstructorPrivilege>> = {};\n+      Array.from(\n+        new Set(course.students.map((studentModel: StudentListRowModel) => studentModel.student.sectionName)),", "originalCommit": "ac081a8095791719ea6493e7838beeacd383bf6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f950a355f667028f22a6df428454040c2f914ca4", "url": "https://github.com/TEAMMATES/teammates/commit/f950a355f667028f22a6df428454040c2f914ca4", "message": "Merge branch 'master' into searchInstructorRefactor", "committedDate": "2020-07-15T03:14:04Z", "type": "commit"}]}