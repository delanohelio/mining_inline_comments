{"pr_number": 10196, "pr_title": "[#10176] Fix student tables not responding to changes", "pr_createdAt": "2020-06-16T09:23:15Z", "pr_url": "https://github.com/TEAMMATES/teammates/pull/10196", "timeline": [{"oid": "ebc90ad3f7a49f224701e2d94019078312c980c1", "url": "https://github.com/TEAMMATES/teammates/commit/ebc90ad3f7a49f224701e2d94019078312c980c1", "message": "Add tracking of nested arrays in student list", "committedDate": "2020-06-16T04:33:12Z", "type": "commit"}, {"oid": "234c33913b817aa4b7d3ec011301e07f34f31178", "url": "https://github.com/TEAMMATES/teammates/commit/234c33913b817aa4b7d3ec011301e07f34f31178", "message": "Fix course statistics showing student list", "committedDate": "2020-06-16T04:35:38Z", "type": "commit"}, {"oid": "f17b0c5019b74d41e3cc29c167c06b921968709e", "url": "https://github.com/TEAMMATES/teammates/commit/f17b0c5019b74d41e3cc29c167c06b921968709e", "message": "Update snapshot and fix linting issues", "committedDate": "2020-06-16T04:51:15Z", "type": "commit"}, {"oid": "b65e24ce1e48ede12726aaad2ad60b8e69986c63", "url": "https://github.com/TEAMMATES/teammates/commit/b65e24ce1e48ede12726aaad2ad60b8e69986c63", "message": "Fix enroll student table not updating", "committedDate": "2020-06-16T08:49:34Z", "type": "commit"}, {"oid": "98f07380010a72903836ed3760b04d8e32b39749", "url": "https://github.com/TEAMMATES/teammates/commit/98f07380010a72903836ed3760b04d8e32b39749", "message": "Merge branch 'master' into 10176-update-table-changes", "committedDate": "2020-06-16T08:56:14Z", "type": "commit"}, {"oid": "3b047b11a4203c3dcc9e3c4d42d9db3af5cdbf7c", "url": "https://github.com/TEAMMATES/teammates/commit/3b047b11a4203c3dcc9e3c4d42d9db3af5cdbf7c", "message": "Add check for existing students panel", "committedDate": "2020-06-16T09:14:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3Mjc0MA==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441072740", "bodyText": "I think you somehow want to write a common method for stats calculation because the stats calculation code is duplicated in loadStudents.", "author": "xpdavid", "createdAt": "2020-06-16T18:53:56Z", "path": "src/web/app/pages-instructor/instructor-course-details-page/instructor-course-details-page.component.ts", "diffHunk": "@@ -327,11 +328,19 @@ export class InstructorCourseDetailsPageComponent implements OnInit {\n     this.courseService.removeStudentFromCourse(this.courseDetails.course.courseId, studentEmail).subscribe(() => {\n       this.statusMessageService\n           .showSuccessMessage(`Student is successfully deleted from course \"${this.courseDetails.course.courseId}\"`);\n+      const teams: Set<string> = new Set();", "originalCommit": "3b047b11a4203c3dcc9e3c4d42d9db3af5cdbf7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3MzcyOQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441073729", "bodyText": "\ud83d\udc4d", "author": "xpdavid", "createdAt": "2020-06-16T18:55:50Z", "path": "src/web/app/pages-instructor/instructor-course-enroll-page/instructor-course-enroll-page.component.ts", "diffHunk": "@@ -122,11 +122,16 @@ export class InstructorCourseEnrollPageComponent implements OnInit {\n     }, (resp: ErrorMessageOutput) => {\n       this.statusMessage.pop(); // removes any existing error status message\n       this.statusMessageService.showErrorMessage(resp.error.message);\n+    }, () => {\n+      this.studentService.getStudentsFromCourse({ courseId: this.courseid }).subscribe((resp: Students) => {", "originalCommit": "3b047b11a4203c3dcc9e3c4d42d9db3af5cdbf7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3NDI1NA==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441074254", "bodyText": "Same here. Duplicated code in loadStudents()", "author": "xpdavid", "createdAt": "2020-06-16T18:56:47Z", "path": "src/web/app/pages-instructor/instructor-student-list-page/instructor-student-list-page.component.ts", "diffHunk": "@@ -158,11 +158,19 @@ export class InstructorStudentListPageComponent implements OnInit {\n     this.courseService.removeStudentFromCourse(courseTab.course.courseId, studentEmail).subscribe(() => {\n       this.statusMessageService\n           .showSuccessMessage(`Student is successfully deleted from course \"${courseTab.course.courseId}\"`);\n+      const teams: Set<string> = new Set();\n       courseTab.studentListSectionDataList.forEach(\n           (section: StudentListSectionData) => {\n             section.students = section.students.filter(\n                 (student: StudentListStudentData) => student.email !== studentEmail);\n+            section.students.forEach((student: StudentListStudentData) => teams.add(student.team));\n           });\n+\n+      courseTab.studentListSectionDataList =", "originalCommit": "3b047b11a4203c3dcc9e3c4d42d9db3af5cdbf7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3OTI4NA==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441079284", "bodyText": "Personally, I don't like to touch the low-level change detection in Angular as this is prone to errors. Even this is done before, it is still necessary to have one StudentListSectionData outside and one FlatStudentListData inside?\nIn other word, can we just construct FlatStudentListData (actually we should call it as StudentListRowModel) outside?", "author": "xpdavid", "createdAt": "2020-06-16T19:05:55Z", "path": "src/web/app/pages-instructor/student-list/student-list.component.ts", "diffHunk": "@@ -71,19 +79,46 @@ export class StudentListComponent implements OnInit, DoCheck {\n               private tableComparatorService: TableComparatorService,\n               private ngbModal: NgbModal,\n               private differs: IterableDiffers) {\n-    this._differ = this.differs.find(this.sections).create();\n+    this.sectionDataDiffer = this.differs.find(this.sections).create();", "originalCommit": "3b047b11a4203c3dcc9e3c4d42d9db3af5cdbf7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "265c0a09c42c1e7a44db5153f327fa5652424d25", "url": "https://github.com/TEAMMATES/teammates/commit/265c0a09c42c1e7a44db5153f327fa5652424d25", "message": "Add course statistics calculator service", "committedDate": "2020-06-17T07:13:40Z", "type": "commit"}, {"oid": "0a1beffa53114ec7a453213565ac58e10649fb03", "url": "https://github.com/TEAMMATES/teammates/commit/0a1beffa53114ec7a453213565ac58e10649fb03", "message": "Refactor student list", "committedDate": "2020-06-17T07:51:51Z", "type": "commit"}, {"oid": "7ffe4f3d45c85c14dcc10f5733198d4da9f1aca9", "url": "https://github.com/TEAMMATES/teammates/commit/7ffe4f3d45c85c14dcc10f5733198d4da9f1aca9", "message": "Update snapshots and tests", "committedDate": "2020-06-17T08:01:23Z", "type": "commit"}, {"oid": "3d0a04dbbb995b3c8166d7c326c707a6c314b04c", "url": "https://github.com/TEAMMATES/teammates/commit/3d0a04dbbb995b3c8166d7c326c707a6c314b04c", "message": "Merge branch 'master' into 10176-update-table-changes", "committedDate": "2020-06-17T08:08:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4MzczMw==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441783733", "bodyText": "I think you can put the method into StudentsService or CourseService.", "author": "xpdavid", "createdAt": "2020-06-17T19:29:51Z", "path": "src/web/services/statistics-calculator.service.ts", "diffHunk": "@@ -0,0 +1,39 @@\n+import { Injectable } from '@angular/core';\n+import { StudentListRowModel } from '../app/pages-instructor/student-list/student-list.component';\n+\n+/**\n+ * The statistics of a course\n+ */\n+export interface CourseStatistics {\n+  numOfSections: number;\n+  numOfTeams: number;\n+  numOfStudents: number;\n+}\n+\n+/**\n+ * Handles the calculation of statistics\n+ */\n+@Injectable({\n+  providedIn: 'root',\n+})\n+export class StatisticsCalculatorService {\n+\n+  constructor() { }\n+\n+  /**\n+   * Calculates the statistics for a course from a list of students in the course\n+   */\n+  calculateCourseStatistics(studentList: StudentListRowModel[]): CourseStatistics {", "originalCommit": "3d0a04dbbb995b3c8166d7c326c707a6c314b04c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5Mzk5Mw==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441793993", "bodyText": "In addition, let's not couple the model data and the business logic (services) together. Can we take Student[] as arguments?", "author": "xpdavid", "createdAt": "2020-06-17T19:49:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4MzczMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NDU5OA==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441784598", "bodyText": "Let's take this chance and put the component into src/web/app/components", "author": "xpdavid", "createdAt": "2020-06-17T19:31:30Z", "path": "src/web/app/pages-instructor/student-list/student-list.component.ts", "diffHunk": "@@ -39,21 +38,16 @@ interface FlatStudentListData {\n   templateUrl: './student-list.component.html',\n   styleUrls: ['./student-list.component.scss'],\n })\n-export class StudentListComponent implements OnInit, DoCheck {\n+export class StudentListComponent implements OnInit {", "originalCommit": "3d0a04dbbb995b3c8166d7c326c707a6c314b04c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NTg0Nw==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441785847", "bodyText": "The privilege is loaded per section so you don't want to apply the privilege to all students (i.e., you need to apply the privilege to student in the sectionName).", "author": "xpdavid", "createdAt": "2020-06-17T19:33:46Z", "path": "src/web/app/pages-instructor/instructor-student-list-page/instructor-student-list-page.component.ts", "diffHunk": "@@ -101,51 +97,42 @@ export class InstructorStudentListPageComponent implements OnInit {\n             return acc;\n           }, {});\n \n-          const teams: StudentIndexedData = students.students.reduce((acc: StudentIndexedData, x: Student) => {\n-            const term: string = x.teamName;\n-            (acc[term] = acc[term] || []).push(x);\n-            return acc;\n-          }, {});\n-\n-          courseTab.stats = {\n-            numOfStudents: students.students.length,\n-            numOfSections: Object.keys(sections).length,\n-            numOfTeams: Object.keys(teams).length,\n-          };\n-\n           Object.keys(sections).forEach((key: string) => {\n             const studentsInSection: Student[] = sections[key];\n \n-            const data: StudentListStudentData[] = [];\n+            const studentList: StudentListRowModel[] = [];\n             studentsInSection.forEach((student: Student) => {\n-              const studentData: StudentListStudentData = {\n-                name : student.name,\n-                status : student.joinState,\n-                email : student.email,\n-                team : student.teamName,\n+              const studentData: StudentListRowModel = {\n+                name: student.name,\n+                status: student.joinState,\n+                email: student.email,\n+                team: student.teamName,\n+                sectionName: key,\n+                isAllowedToModifyStudent: false,\n+                isAllowedToViewStudentInSection: false,\n               };\n-              data.push(studentData);\n+              studentList.push(studentData);\n             });\n \n-            this.loadPrivilege(courseTab, key, data);\n+            this.loadPrivilege(courseTab, key, studentList);\n           });\n         }, (resp: ErrorMessageOutput) => { this.statusMessageService.showErrorMessage(resp.error.message); });\n   }\n \n   /**\n    * Loads privilege of an instructor for a specified course and section.\n    */\n-  loadPrivilege(courseTab: CourseTab, sectionName: string, students: StudentListStudentData[]): void {\n+  loadPrivilege(courseTab: CourseTab, sectionName: string, students: StudentListRowModel[]): void {\n     this.instructorService.loadInstructorPrivilege({ sectionName, courseId: courseTab.course.courseId })\n         .subscribe((instructorPrivilege: InstructorPrivilege) => {\n-          const sectionData: StudentListSectionData = {\n-            sectionName,\n-            students,\n-            isAllowedToViewStudentInSection : instructorPrivilege.canViewStudentInSections,\n-            isAllowedToModifyStudent : instructorPrivilege.canModifyStudent,\n-          };\n-\n-          courseTab.studentListSectionDataList.push(sectionData);\n+          students.forEach((student: StudentListRowModel) => {", "originalCommit": "3d0a04dbbb995b3c8166d7c326c707a6c314b04c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4ODE0Nw==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441788147", "bodyText": "Many redundant calculations are going here (though it will provide correct result eventually). I think the correct way to do it is to construct StudentListRowModel when all students are loaded. After that, we can begin to load privilege for each section.", "author": "xpdavid", "createdAt": "2020-06-17T19:38:11Z", "path": "src/web/app/pages-instructor/instructor-student-list-page/instructor-student-list-page.component.ts", "diffHunk": "@@ -101,51 +97,42 @@ export class InstructorStudentListPageComponent implements OnInit {\n             return acc;\n           }, {});\n \n-          const teams: StudentIndexedData = students.students.reduce((acc: StudentIndexedData, x: Student) => {\n-            const term: string = x.teamName;\n-            (acc[term] = acc[term] || []).push(x);\n-            return acc;\n-          }, {});\n-\n-          courseTab.stats = {\n-            numOfStudents: students.students.length,\n-            numOfSections: Object.keys(sections).length,\n-            numOfTeams: Object.keys(teams).length,\n-          };\n-\n           Object.keys(sections).forEach((key: string) => {\n             const studentsInSection: Student[] = sections[key];\n \n-            const data: StudentListStudentData[] = [];\n+            const studentList: StudentListRowModel[] = [];\n             studentsInSection.forEach((student: Student) => {\n-              const studentData: StudentListStudentData = {\n-                name : student.name,\n-                status : student.joinState,\n-                email : student.email,\n-                team : student.teamName,\n+              const studentData: StudentListRowModel = {\n+                name: student.name,\n+                status: student.joinState,\n+                email: student.email,\n+                team: student.teamName,\n+                sectionName: key,\n+                isAllowedToModifyStudent: false,\n+                isAllowedToViewStudentInSection: false,\n               };\n-              data.push(studentData);\n+              studentList.push(studentData);\n             });\n \n-            this.loadPrivilege(courseTab, key, data);\n+            this.loadPrivilege(courseTab, key, studentList);\n           });\n         }, (resp: ErrorMessageOutput) => { this.statusMessageService.showErrorMessage(resp.error.message); });\n   }\n \n   /**\n    * Loads privilege of an instructor for a specified course and section.\n    */\n-  loadPrivilege(courseTab: CourseTab, sectionName: string, students: StudentListStudentData[]): void {\n+  loadPrivilege(courseTab: CourseTab, sectionName: string, students: StudentListRowModel[]): void {\n     this.instructorService.loadInstructorPrivilege({ sectionName, courseId: courseTab.course.courseId })\n         .subscribe((instructorPrivilege: InstructorPrivilege) => {\n-          const sectionData: StudentListSectionData = {\n-            sectionName,\n-            students,\n-            isAllowedToViewStudentInSection : instructorPrivilege.canViewStudentInSections,\n-            isAllowedToModifyStudent : instructorPrivilege.canModifyStudent,\n-          };\n-\n-          courseTab.studentListSectionDataList.push(sectionData);\n+          students.forEach((student: StudentListRowModel) => {\n+            student.isAllowedToViewStudentInSection = instructorPrivilege.canViewStudentInSections;\n+            student.isAllowedToModifyStudent = instructorPrivilege.canModifyStudent;\n+          });\n+\n+          courseTab.studentList.push(...students);\n+          courseTab.stats =", "originalCommit": "3d0a04dbbb995b3c8166d7c326c707a6c314b04c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MTI3MQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441791271", "bodyText": "It looks like we should also change the search service also. Let's leave it to another PR. Please raise an issue afterward or continue do it afterward :P.", "author": "xpdavid", "createdAt": "2020-06-17T19:44:24Z", "path": "src/web/app/pages-instructor/instructor-search-page/instructor-search-page.component.ts", "diffHunk": "@@ -70,18 +64,47 @@ export class InstructorSearchPageComponent implements OnInit {\n         .pipe(finalize(() => this.loadingBarService.hideLoadingBar()))\n         .subscribe((resp: [InstructorSearchResult, InstructorSearchResult]) => {\n           this.commentTables = resp[0].searchCommentsTables;\n-          this.studentTables = resp[1].searchStudentsTables;\n+          const searchStudentsTable: SearchStudentsTable[] = resp[1].searchStudentsTables;", "originalCommit": "3d0a04dbbb995b3c8166d7c326c707a6c314b04c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzODk3MA==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441938970", "bodyText": "Okay! Will raise and issue and work on it after this PR", "author": "t-cheepeng", "createdAt": "2020-06-18T02:51:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MTI3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MTgyNA==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441791824", "bodyText": "The section name should be 'Tutorial Group 1' for all?", "author": "xpdavid", "createdAt": "2020-06-17T19:45:31Z", "path": "src/web/app/pages-instructor/instructor-search-page/instructor-search-page.component.spec.ts", "diffHunk": "@@ -44,44 +44,48 @@ describe('InstructorSearchPageComponent', () => {\n   });\n \n   it('should snap with a student table', () => {\n-    component.studentTables = [\n+    component.studentsListRowTables = [\n       {\n-        courseId: 'test.tes-demo',\n-        sections: [\n+        courseId: 'test-exa.demo',\n+        students: [\n           {\n-            sectionName: 'Tutorial Group 1',\n+            name: 'tester',\n+            team: '1',\n+            email: 'tester@tester.com',\n+            status: JoinState.JOINED,\n+            sectionName: '1',", "originalCommit": "3d0a04dbbb995b3c8166d7c326c707a6c314b04c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MjM5Ng==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441792396", "bodyText": "Same here. The privilege is not loaded correctly for each section.", "author": "xpdavid", "createdAt": "2020-06-17T19:46:38Z", "path": "src/web/app/pages-instructor/instructor-course-details-page/instructor-course-details-page.component.ts", "diffHunk": "@@ -157,19 +148,18 @@ export class InstructorCourseDetailsPageComponent implements OnInit {\n   /**\n    * Loads privilege of an instructor for a specified course and section.\n    */\n-  private loadPrivilege(courseid: string, sectionName: string, students: StudentListStudentData[]): void {\n+  private loadPrivilege(courseid: string, sectionName: string, students: StudentListRowModel[]): void {\n     this.instructorService.loadInstructorPrivilege({\n       sectionName,\n       courseId: courseid,\n     }).subscribe((instructorPrivilege: InstructorPrivilege) => {\n-      const sectionData: StudentListSectionData = {\n-        sectionName,\n-        students,\n-        isAllowedToViewStudentInSection : instructorPrivilege.canViewStudentInSections,\n-        isAllowedToModifyStudent : instructorPrivilege.canModifyStudent,\n-      };\n-\n-      this.sections.push(sectionData);\n+      students.forEach((student: StudentListRowModel) => {", "originalCommit": "3d0a04dbbb995b3c8166d7c326c707a6c314b04c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MjU0OA==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441792548", "bodyText": "Same here. The stats calculation should be not here.", "author": "xpdavid", "createdAt": "2020-06-17T19:46:58Z", "path": "src/web/app/pages-instructor/instructor-course-details-page/instructor-course-details-page.component.ts", "diffHunk": "@@ -157,19 +148,18 @@ export class InstructorCourseDetailsPageComponent implements OnInit {\n   /**\n    * Loads privilege of an instructor for a specified course and section.\n    */\n-  private loadPrivilege(courseid: string, sectionName: string, students: StudentListStudentData[]): void {\n+  private loadPrivilege(courseid: string, sectionName: string, students: StudentListRowModel[]): void {\n     this.instructorService.loadInstructorPrivilege({\n       sectionName,\n       courseId: courseid,\n     }).subscribe((instructorPrivilege: InstructorPrivilege) => {\n-      const sectionData: StudentListSectionData = {\n-        sectionName,\n-        students,\n-        isAllowedToViewStudentInSection : instructorPrivilege.canViewStudentInSections,\n-        isAllowedToModifyStudent : instructorPrivilege.canModifyStudent,\n-      };\n-\n-      this.sections.push(sectionData);\n+      students.forEach((student: StudentListRowModel) => {\n+        student.isAllowedToViewStudentInSection = instructorPrivilege.canViewStudentInSections;\n+        student.isAllowedToModifyStudent = instructorPrivilege.canModifyStudent;\n+      });\n+\n+      this.students.push(...students);\n+      this.courseDetails.stats = this.statisticsCalculatorService.calculateCourseStatistics(this.students);", "originalCommit": "3d0a04dbbb995b3c8166d7c326c707a6c314b04c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7a24a6e143cafe1fd8ba185f7f5793173fb5cdd8", "url": "https://github.com/TEAMMATES/teammates/commit/7a24a6e143cafe1fd8ba185f7f5793173fb5cdd8", "message": "Move stats calculation and student list component", "committedDate": "2020-06-18T02:55:17Z", "type": "commit"}, {"oid": "36cc231e332e073cefe637757e453f07bbc6e1ec", "url": "https://github.com/TEAMMATES/teammates/commit/36cc231e332e073cefe637757e453f07bbc6e1ec", "message": "Fix instructor privileges and stats calculation", "committedDate": "2020-06-18T03:58:32Z", "type": "commit"}, {"oid": "0b920716f2c41ba20e05aa6e07e82f26f2cd345e", "url": "https://github.com/TEAMMATES/teammates/commit/0b920716f2c41ba20e05aa6e07e82f26f2cd345e", "message": "Fix test data names and update snapshots", "committedDate": "2020-06-18T04:22:56Z", "type": "commit"}, {"oid": "441d94e59be7ee1be9eb306e20c919a63b7fc337", "url": "https://github.com/TEAMMATES/teammates/commit/441d94e59be7ee1be9eb306e20c919a63b7fc337", "message": "Merge branch 'master' into 10176-update-table-changes", "committedDate": "2020-06-18T04:24:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk4MjAyMw==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441982023", "bodyText": "Why we discard the old method? loadStudents again will cause another unnecessary API request.", "author": "xpdavid", "createdAt": "2020-06-18T05:48:54Z", "path": "src/web/app/pages-instructor/instructor-student-list-page/instructor-student-list-page.component.ts", "diffHunk": "@@ -158,11 +148,7 @@ export class InstructorStudentListPageComponent implements OnInit {\n     this.courseService.removeStudentFromCourse(courseTab.course.courseId, studentEmail).subscribe(() => {\n       this.statusMessageService\n           .showSuccessMessage(`Student is successfully deleted from course \"${courseTab.course.courseId}\"`);\n-      courseTab.studentListSectionDataList.forEach(\n-          (section: StudentListSectionData) => {\n-            section.students = section.students.filter(\n-                (student: StudentListStudentData) => student.email !== studentEmail);\n-          });\n+      this.loadStudents(courseTab);", "originalCommit": "441d94e59be7ee1be9eb306e20c919a63b7fc337", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAxMjAyNw==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r442012027", "bodyText": "Now we changed calculateCourseStatistics to accept Student[]. But the components only store the model. So we store an additional Student[] variable in these components? or would constructing the Student[] from the StudentListRowModel[] each time a delete event happens be a better choice?", "author": "t-cheepeng", "createdAt": "2020-06-18T07:07:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk4MjAyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk4MzAwNA==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441983004", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      courseTab.stats = this.courseService.calculateCourseStatistics(studentsInCourse);\n          \n          \n            \n                      courseTab.stats = this.courseService.calculateCourseStatistics(students.students);\n          \n      \n    \n    \n  \n\nThere is no need to create another studentsInCourse.", "author": "xpdavid", "createdAt": "2020-06-18T05:51:59Z", "path": "src/web/app/pages-instructor/instructor-student-list-page/instructor-student-list-page.component.ts", "diffHunk": "@@ -95,57 +89,53 @@ export class InstructorStudentListPageComponent implements OnInit {\n   loadStudents(courseTab: CourseTab): void {\n     this.studentService.getStudentsFromCourse({ courseId: courseTab.course.courseId })\n         .subscribe((students: Students) => {\n+          courseTab.studentList = [];\n           const sections: StudentIndexedData = students.students.reduce((acc: StudentIndexedData, x: Student) => {\n             const term: string = x.sectionName;\n             (acc[term] = acc[term] || []).push(x);\n             return acc;\n           }, {});\n \n-          const teams: StudentIndexedData = students.students.reduce((acc: StudentIndexedData, x: Student) => {\n-            const term: string = x.teamName;\n-            (acc[term] = acc[term] || []).push(x);\n-            return acc;\n-          }, {});\n-\n-          courseTab.stats = {\n-            numOfStudents: students.students.length,\n-            numOfSections: Object.keys(sections).length,\n-            numOfTeams: Object.keys(teams).length,\n-          };\n-\n+          const studentsInCourse: Student[] = [];\n           Object.keys(sections).forEach((key: string) => {\n             const studentsInSection: Student[] = sections[key];\n+            studentsInCourse.push(...studentsInSection);\n \n-            const data: StudentListStudentData[] = [];\n+            const studentList: StudentListRowModel[] = [];\n             studentsInSection.forEach((student: Student) => {\n-              const studentData: StudentListStudentData = {\n-                name : student.name,\n-                status : student.joinState,\n-                email : student.email,\n-                team : student.teamName,\n+              const studentData: StudentListRowModel = {\n+                name: student.name,\n+                status: student.joinState,\n+                email: student.email,\n+                team: student.teamName,\n+                sectionName: key,\n+                isAllowedToModifyStudent: false,\n+                isAllowedToViewStudentInSection: false,\n               };\n-              data.push(studentData);\n+              studentList.push(studentData);\n             });\n \n-            this.loadPrivilege(courseTab, key, data);\n+            this.loadPrivilege(courseTab, key, studentList);\n           });\n+\n+          courseTab.stats = this.courseService.calculateCourseStatistics(studentsInCourse);", "originalCommit": "441d94e59be7ee1be9eb306e20c919a63b7fc337", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk4OTY2Mg==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441989662", "bodyText": "There is a cleaner way of writing this by using map.", "author": "xpdavid", "createdAt": "2020-06-18T06:12:25Z", "path": "src/web/app/pages-instructor/instructor-student-list-page/instructor-student-list-page.component.ts", "diffHunk": "@@ -95,57 +89,53 @@ export class InstructorStudentListPageComponent implements OnInit {\n   loadStudents(courseTab: CourseTab): void {\n     this.studentService.getStudentsFromCourse({ courseId: courseTab.course.courseId })\n         .subscribe((students: Students) => {\n+          courseTab.studentList = [];\n           const sections: StudentIndexedData = students.students.reduce((acc: StudentIndexedData, x: Student) => {\n             const term: string = x.sectionName;\n             (acc[term] = acc[term] || []).push(x);\n             return acc;\n           }, {});\n \n-          const teams: StudentIndexedData = students.students.reduce((acc: StudentIndexedData, x: Student) => {\n-            const term: string = x.teamName;\n-            (acc[term] = acc[term] || []).push(x);\n-            return acc;\n-          }, {});\n-\n-          courseTab.stats = {\n-            numOfStudents: students.students.length,\n-            numOfSections: Object.keys(sections).length,\n-            numOfTeams: Object.keys(teams).length,\n-          };\n-\n+          const studentsInCourse: Student[] = [];\n           Object.keys(sections).forEach((key: string) => {\n             const studentsInSection: Student[] = sections[key];\n+            studentsInCourse.push(...studentsInSection);\n \n-            const data: StudentListStudentData[] = [];\n+            const studentList: StudentListRowModel[] = [];", "originalCommit": "441d94e59be7ee1be9eb306e20c919a63b7fc337", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk5MDQ5MQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441990491", "bodyText": "Same here", "author": "xpdavid", "createdAt": "2020-06-18T06:14:53Z", "path": "src/web/app/pages-instructor/instructor-course-details-page/instructor-course-details-page.component.ts", "diffHunk": "@@ -327,11 +319,7 @@ export class InstructorCourseDetailsPageComponent implements OnInit {\n     this.courseService.removeStudentFromCourse(this.courseDetails.course.courseId, studentEmail).subscribe(() => {\n       this.statusMessageService\n           .showSuccessMessage(`Student is successfully deleted from course \"${this.courseDetails.course.courseId}\"`);\n-      this.sections.forEach(\n-        (section: StudentListSectionData) => {\n-          section.students = section.students.filter(\n-            (student: StudentListStudentData) => student.email !== studentEmail);\n-        });\n+      this.loadStudents(this.courseDetails.course.courseId);", "originalCommit": "441d94e59be7ee1be9eb306e20c919a63b7fc337", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk5MDg1Nw==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441990857", "bodyText": "If we delete all student, we can actually just clear the list (by setting to [])", "author": "xpdavid", "createdAt": "2020-06-18T06:15:53Z", "path": "src/web/app/pages-instructor/instructor-course-details-page/instructor-course-details-page.component.ts", "diffHunk": "@@ -195,7 +187,7 @@ export class InstructorCourseDetailsPageComponent implements OnInit {\n   deleteAllStudentsFromCourse(courseId: string): void {\n     this.studentService.deleteAllStudentsFromCourse({ courseId })\n       .subscribe((resp: MessageOutput) => {\n-        this.loadCourseDetails(courseId);\n+        this.loadStudents(this.courseDetails.course.courseId);", "originalCommit": "441d94e59be7ee1be9eb306e20c919a63b7fc337", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk5MTYxOQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r441991619", "bodyText": "Let's make sure that StudentListSectionData is only used in the search service.", "author": "xpdavid", "createdAt": "2020-06-18T06:18:04Z", "path": "src/web/app/pages-instructor/instructor-search-page/student-result-table/student-result-table.component.ts", "diffHunk": "@@ -1,5 +1,22 @@\n import { Component, Input, OnInit } from '@angular/core';\n-import { SearchStudentsTable } from '../instructor-search-page.component';\n+import { StudentListSectionData } from '../../../components/student-list/student-list-section-data';\n+import { StudentListRowModel } from '../../../components/student-list/student-list.component';\n+\n+/**\n+ * Search result for a list of sections containing students of a course\n+ */\n+export interface SearchStudentsTable {\n+  courseId: string;\n+  sections: StudentListSectionData[];", "originalCommit": "441d94e59be7ee1be9eb306e20c919a63b7fc337", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAwMjcwNw==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r442002707", "bodyText": "It is used once in InstructorSearchPageComponent because the search service currently returns StudentListSectionData and it is flattened in the component. Is that okay?", "author": "t-cheepeng", "createdAt": "2020-06-18T06:46:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk5MTYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU0MjU5NA==", "url": "https://github.com/TEAMMATES/teammates/pull/10196#discussion_r442542594", "bodyText": "For your question:\nI think you can actually define a new field: student: Student here (and delete other student related fields). Store the model in the corresponding page. When stats is calculated, use the student field to construct a list of student.", "author": "xpdavid", "createdAt": "2020-06-18T22:50:39Z", "path": "src/web/app/components/student-list/student-list.component.ts", "diffHunk": "@@ -11,16 +15,11 @@ import { JoinState, MessageOutput } from '../../../types/api-output';\n import { SortBy, SortOrder } from '../../../types/sort-properties';\n import { ErrorMessageOutput } from '../../error-message-output';\n import { JoinStatePipe } from './join-state.pipe';\n-import {\n-  StudentListSectionData,\n-  StudentListStudentData,\n-} from './student-list-section-data';\n \n /**\n- * Flattened data which contains details about a student and their section.\n- * The data is flattened to allow sorting of the table.\n+ * Model of row of student data containing details about a student and their section.\n  */\n-interface FlatStudentListData {\n+export interface StudentListRowModel {", "originalCommit": "441d94e59be7ee1be9eb306e20c919a63b7fc337", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "df6092f8a9f230beec69d642cae4d924448beda2", "url": "https://github.com/TEAMMATES/teammates/commit/df6092f8a9f230beec69d642cae4d924448beda2", "message": "Merge branch 'master' into 10176-update-table-changes", "committedDate": "2020-06-19T03:03:45Z", "type": "commit"}, {"oid": "94cc8378e1ba6812646d59423968bca55f675343", "url": "https://github.com/TEAMMATES/teammates/commit/94cc8378e1ba6812646d59423968bca55f675343", "message": "Add Student to StudentListRowModel", "committedDate": "2020-06-19T03:50:26Z", "type": "commit"}, {"oid": "5d2d5650335282a8e9e408eb07eca054c21f52e1", "url": "https://github.com/TEAMMATES/teammates/commit/5d2d5650335282a8e9e408eb07eca054c21f52e1", "message": "Update snapshots and tests", "committedDate": "2020-06-19T04:11:54Z", "type": "commit"}]}