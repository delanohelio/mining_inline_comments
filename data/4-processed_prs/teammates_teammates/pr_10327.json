{"pr_number": 10327, "pr_title": "[#10325] Google blocking E2E login on production server ", "pr_createdAt": "2020-07-17T12:27:53Z", "pr_url": "https://github.com/TEAMMATES/teammates/pull/10327", "timeline": [{"oid": "220d2c59e5bf96c387585b2f35c8fba363254894", "url": "https://github.com/TEAMMATES/teammates/commit/220d2c59e5bf96c387585b2f35c8fba363254894", "message": "Add user data to webdriver to enable manual log in", "committedDate": "2020-07-17T12:21:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgzMzg0OA==", "url": "https://github.com/TEAMMATES/teammates/pull/10327#discussion_r456833848", "bodyText": "Will this result in NPE?", "author": "xpdavid", "createdAt": "2020-07-18T22:25:10Z", "path": "src/e2e/java/teammates/e2e/cases/e2e/BaseE2ETestCase.java", "diffHunk": "@@ -82,6 +82,12 @@ protected static Url createLocalUrl(String testFileName) throws IOException {\n      * Logs in a page using admin credentials (i.e. in masquerade mode).\n      */\n     protected <T extends AppPage> T loginAdminToPage(AppUrl url, Class<T> typeOfPage) {\n+        // When not using dev server, Google blocks log in by automation.\n+        // To log in, log in manually to teammates in your browser before running e2e tests.\n+        // Refer to teammates.e2e.pageobjects.Browser for more information.\n+        if (!TestProperties.isDevServer()) {\n+            return null;", "originalCommit": "220d2c59e5bf96c387585b2f35c8fba363254894", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg4NTAyNQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10327#discussion_r456885025", "bodyText": "I have changed it to return the AppPage of the url it should navigate to instead.", "author": "jtankw3", "createdAt": "2020-07-19T09:28:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgzMzg0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgzMzkwMQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10327#discussion_r456833901", "bodyText": "We should also delete code for google login?", "author": "xpdavid", "createdAt": "2020-07-18T22:25:53Z", "path": "src/e2e/java/teammates/e2e/cases/e2e/BaseE2ETestCase.java", "diffHunk": "@@ -82,6 +82,12 @@ protected static Url createLocalUrl(String testFileName) throws IOException {\n      * Logs in a page using admin credentials (i.e. in masquerade mode).\n      */\n     protected <T extends AppPage> T loginAdminToPage(AppUrl url, Class<T> typeOfPage) {", "originalCommit": "220d2c59e5bf96c387585b2f35c8fba363254894", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgzMzkyOQ==", "url": "https://github.com/TEAMMATES/teammates/pull/10327#discussion_r456833929", "bodyText": "I think we should do check the existing of the profile here. It's more user friendly.", "author": "xpdavid", "createdAt": "2020-07-18T22:26:23Z", "path": "src/e2e/java/teammates/e2e/pageobjects/Browser.java", "diffHunk": "@@ -126,10 +127,19 @@ private WebDriver createWebDriver() {\n             }\n             System.setProperty(\"webdriver.gecko.driver\", TestProperties.GECKODRIVER_PATH);\n \n+            FirefoxProfile profile;\n+            if (TestProperties.isDevServer()) {\n+                profile = new FirefoxProfile();\n+            } else {\n+                // Get user data from browser to bypass google blocking automated log in.\n+                // Log in manually to teammates to use that log in data for e2e tests.\n+                ProfilesIni profileIni = new ProfilesIni();\n+                profile = profileIni.getProfile(TestProperties.FIREFOX_PROFILE_NAME);", "originalCommit": "220d2c59e5bf96c387585b2f35c8fba363254894", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgzMzk0Mw==", "url": "https://github.com/TEAMMATES/teammates/pull/10327#discussion_r456833943", "bodyText": "Same here.", "author": "xpdavid", "createdAt": "2020-07-18T22:26:31Z", "path": "src/e2e/java/teammates/e2e/pageobjects/Browser.java", "diffHunk": "@@ -146,6 +156,12 @@ private WebDriver createWebDriver() {\n \n             ChromeOptions options = new ChromeOptions();\n             options.addArguments(\"--allow-file-access-from-files\");\n+            if (!TestProperties.isDevServer()) {\n+                // Get user data from browser to bypass google blocking automated log in.\n+                // Log in manually to teammates to use that log in data for e2e tests.\n+                options.addArguments(\"user-data-dir=\" + TestProperties.CHROME_USER_DATA_PATH);", "originalCommit": "220d2c59e5bf96c387585b2f35c8fba363254894", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgzNDAyNg==", "url": "https://github.com/TEAMMATES/teammates/pull/10327#discussion_r456834026", "bodyText": "I think it is more appropriate to throw exception with this message (and result in test fail). It is more explicit than a random NPE error where we need to trace down it to this line.", "author": "xpdavid", "createdAt": "2020-07-18T22:27:44Z", "path": "src/e2e/java/teammates/e2e/cases/e2e/BaseE2ETestCase.java", "diffHunk": "@@ -82,6 +82,12 @@ protected static Url createLocalUrl(String testFileName) throws IOException {\n      * Logs in a page using admin credentials (i.e. in masquerade mode).\n      */\n     protected <T extends AppPage> T loginAdminToPage(AppUrl url, Class<T> typeOfPage) {\n+        // When not using dev server, Google blocks log in by automation.\n+        // To log in, log in manually to teammates in your browser before running e2e tests.\n+        // Refer to teammates.e2e.pageobjects.Browser for more information.", "originalCommit": "220d2c59e5bf96c387585b2f35c8fba363254894", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg4NTI2MA==", "url": "https://github.com/TEAMMATES/teammates/pull/10327#discussion_r456885260", "bodyText": "I was actually intending to skip the login process when the production server is used and not to cause failure.", "author": "jtankw3", "createdAt": "2020-07-19T09:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgzNDAyNg=="}], "type": "inlineReview"}, {"oid": "b99167c4ec6d23ea7c9834772d89b80df8b8f49e", "url": "https://github.com/TEAMMATES/teammates/commit/b99167c4ec6d23ea7c9834772d89b80df8b8f49e", "message": "Fix redirection after loginAdminToPage", "committedDate": "2020-07-19T08:01:21Z", "type": "commit"}, {"oid": "1771668aa12518768b5d34ddd496afd702e2ef6f", "url": "https://github.com/TEAMMATES/teammates/commit/1771668aa12518768b5d34ddd496afd702e2ef6f", "message": "Remove code for google log in", "committedDate": "2020-07-19T08:17:32Z", "type": "commit"}, {"oid": "6edf8b8b2c060b728aa8d254541ff38296636d9c", "url": "https://github.com/TEAMMATES/teammates/commit/6edf8b8b2c060b728aa8d254541ff38296636d9c", "message": "Add check for profile existence", "committedDate": "2020-07-19T08:55:54Z", "type": "commit"}, {"oid": "86e404e808154654ed32702baad269d9d2a30a29", "url": "https://github.com/TEAMMATES/teammates/commit/86e404e808154654ed32702baad269d9d2a30a29", "message": "Fix lint", "committedDate": "2020-07-19T08:56:03Z", "type": "commit"}, {"oid": "596b46044196bfb20ebf149a06535727fdbba1cb", "url": "https://github.com/TEAMMATES/teammates/commit/596b46044196bfb20ebf149a06535727fdbba1cb", "message": "Merge branch 'master' into production-server-e2e", "committedDate": "2020-07-19T08:56:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgwMjQ2Nw==", "url": "https://github.com/TEAMMATES/teammates/pull/10327#discussion_r457802467", "bodyText": "Actually this entire page can be deleted", "author": "xpdavid", "createdAt": "2020-07-21T02:41:45Z", "path": "src/e2e/java/teammates/e2e/pageobjects/GoogleLoginPage.java", "diffHunk": "@@ -1,38 +1,15 @@\n package teammates.e2e.pageobjects;\n \n-import org.openqa.selenium.By;\n-import org.openqa.selenium.NoSuchElementException;\n-import org.openqa.selenium.WebElement;\n-import org.openqa.selenium.support.FindBy;\n-import org.openqa.selenium.support.ui.ExpectedConditions;\n-\n-import com.google.common.base.Preconditions;\n-\n-import teammates.e2e.util.TestProperties;\n-\n /**\n  * Page Object Model for the official Google Accounts login page.\n  */\n public class GoogleLoginPage extends LoginPage {", "originalCommit": "596b46044196bfb20ebf149a06535727fdbba1cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAwNjQyNA==", "url": "https://github.com/TEAMMATES/teammates/pull/10327#discussion_r458006424", "bodyText": "Let's keep it for now. I have a feeling we might be using this again some time; if I'm wrong we can always delete it later.", "author": "wkurniawan07", "createdAt": "2020-07-21T10:48:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgwMjQ2Nw=="}], "type": "inlineReview"}, {"oid": "4af97dddffcc14db3efda6b97d862eb19ae9546d", "url": "https://github.com/TEAMMATES/teammates/commit/4af97dddffcc14db3efda6b97d862eb19ae9546d", "message": "Merge branch 'master' into production-server-e2e", "committedDate": "2020-07-21T12:30:54Z", "type": "commit"}]}