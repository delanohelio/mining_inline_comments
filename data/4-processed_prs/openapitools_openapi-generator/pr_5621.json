{"pr_number": 5621, "pr_title": "[python/asyncio] explicitly close client session and asynchronous context manager", "pr_createdAt": "2020-03-18T01:11:34Z", "pr_url": "https://github.com/OpenAPITools/openapi-generator/pull/5621", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTk4OA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#discussion_r394055988", "bodyText": "I only see this being used in this one file. Why did you move it to the util file?\nIf it is used in more than one file it makes sense to put it there as a common utility tool, but if it is only needed here can you keep it here?", "author": "spacether", "createdAt": "2020-03-18T01:16:27Z", "path": "samples/client/petstore/python-asyncio/tests/test_pet_api.py", "diffHunk": "@@ -27,15 +27,6 @@\n HOST = 'http://localhost:80/v2'\n \n \n-def async_test(f):\n-    def wrapper(*args, **kwargs):\n-        coro = asyncio.coroutine(f)\n-        future = coro(*args, **kwargs)\n-        loop = asyncio.get_event_loop()\n-        loop.run_until_complete(future)\n-    return wrapper", "originalCommit": "4914ce8f46b461de882c9dc9ac534a9882f25819", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NzM3Ng==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#discussion_r394057376", "bodyText": "Yeah, my mistake... I've just added new file.", "author": "tomplus", "createdAt": "2020-03-18T01:22:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTk4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1ODExNQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#discussion_r394058115", "bodyText": "Looks good as-is", "author": "spacether", "createdAt": "2020-03-18T01:25:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NjkyOQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#discussion_r394056929", "bodyText": "Can you add a test that checks the pool manager and ensures that it is closed like we did here:\nsamples/client/petstore/python-experimental/tests/test_api_client.py?", "author": "spacether", "createdAt": "2020-03-18T01:20:27Z", "path": "samples/client/petstore/python-asyncio/petstore_api/rest.py", "diffHunk": "@@ -85,8 +85,9 @@ def __init__(self, configuration, pools_size=4, maxsize=None):\n                 connector=connector\n             )\n \n-    def __del__(self):\n-        asyncio.ensure_future(self.pool_manager.close())\n+    def close(self):\n+        if not self.pool_manager.closed:\n+            asyncio.ensure_future(self.pool_manager.close())", "originalCommit": "4914ce8f46b461de882c9dc9ac534a9882f25819", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1ODAyMw==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#discussion_r394058023", "bodyText": "There is such test. Sorry, I forgot to commit it before.", "author": "tomplus", "createdAt": "2020-03-18T01:25:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NjkyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1ODQ2Ng==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#discussion_r394058466", "bodyText": "Test is below", "author": "spacether", "createdAt": "2020-03-18T01:27:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NjkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1ODQwMg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#discussion_r394058402", "bodyText": "Can you delete HOST, I don't think we use it here", "author": "spacether", "createdAt": "2020-03-18T01:26:51Z", "path": "samples/client/petstore/python-asyncio/tests/test_api_client.py", "diffHunk": "@@ -0,0 +1,31 @@\n+# coding: utf-8\n+\n+# flake8: noqa\n+\n+import os\n+import unittest\n+import asyncio\n+import weakref\n+\n+from tests.util import async_test\n+import petstore_api\n+\n+HOST = 'http://localhost:80/v2'", "originalCommit": "4c31ab94af0d593d528228361eab32cced07e972", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1OTg5Mw==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#discussion_r394059893", "bodyText": "Sure, removed.", "author": "tomplus", "createdAt": "2020-03-18T01:33:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1ODQwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDExOTc0Mw==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#discussion_r394119743", "bodyText": "When do we check that the pool_manager is closed?\nWhy is rest_pool_ref.closed not True?", "author": "spacether", "createdAt": "2020-03-18T05:53:34Z", "path": "samples/client/petstore/python-asyncio/tests/test_api_client.py", "diffHunk": "@@ -0,0 +1,27 @@\n+# coding: utf-8\n+\n+# flake8: noqa\n+\n+import unittest\n+import weakref\n+\n+from tests.util import async_test\n+import petstore_api\n+\n+\n+class TestApiClient(unittest.TestCase):\n+\n+    @async_test\n+    def test_context_manager_closes_client(self):\n+\n+        with petstore_api.ApiClient() as client:\n+            # thread pool\n+            self.assertIsNotNone(client.pool)\n+            pool_ref = weakref.ref(client._pool)\n+            self.assertIsNotNone(pool_ref())\n+            # pool_manager\n+            self.assertFalse(client.rest_client.pool_manager.closed)\n+            rest_pool_ref = client.rest_client.pool_manager\n+\n+        self.assertIsNone(pool_ref())\n+        self.assertFalse(rest_pool_ref.closed)", "originalCommit": "4b2e910c823f7bb5ccaab098dd660449ea849046", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDI4MzI5Mg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5621#discussion_r394283292", "bodyText": "Thanks for spotting this. I had to switch to the asynchronous context generator to make it works. Please take a look again.", "author": "tomplus", "createdAt": "2020-03-18T11:39:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDExOTc0Mw=="}], "type": "inlineReview"}, {"oid": "1fb1a25320df76022451760f9008e41f4f9e0623", "url": "https://github.com/OpenAPITools/openapi-generator/commit/1fb1a25320df76022451760f9008e41f4f9e0623", "message": "[python/asyncio] explicitly close client session via async context manager", "committedDate": "2020-03-18T11:33:34Z", "type": "forcePushed"}, {"oid": "884d0e8a195afe9d537f207a6e99d50da5c52de1", "url": "https://github.com/OpenAPITools/openapi-generator/commit/884d0e8a195afe9d537f207a6e99d50da5c52de1", "message": "[python/asyncio] explicitly close client session via async context manager", "committedDate": "2020-03-18T19:22:30Z", "type": "commit"}, {"oid": "884d0e8a195afe9d537f207a6e99d50da5c52de1", "url": "https://github.com/OpenAPITools/openapi-generator/commit/884d0e8a195afe9d537f207a6e99d50da5c52de1", "message": "[python/asyncio] explicitly close client session via async context manager", "committedDate": "2020-03-18T19:22:30Z", "type": "forcePushed"}]}