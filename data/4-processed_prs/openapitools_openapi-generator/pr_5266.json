{"pr_number": 5266, "pr_title": "[typescript] Don't hardcode the date type if user has mapped it", "pr_createdAt": "2020-02-10T18:45:44Z", "pr_url": "https://github.com/OpenAPITools/openapi-generator/pull/5266", "timeline": [{"oid": "be8e05db2dcc1458eaf7814641166e7190b78fa2", "url": "https://github.com/OpenAPITools/openapi-generator/commit/be8e05db2dcc1458eaf7814641166e7190b78fa2", "message": "[typescript] Don't hardcode the date type if user has mapped it\n\nIf the user has set --type-mappings Date=foo, respect this setting\ninstead of hardcoding the date type.", "committedDate": "2020-02-10T18:40:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMxNTAyMg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5266#discussion_r377315022", "bodyText": "is this variable used?", "author": "amakhrov", "createdAt": "2020-02-10T21:03:50Z", "path": "modules/openapi-generator/src/main/java/org/openapitools/codegen/languages/TypeScriptFetchClientCodegen.java", "diffHunk": "@@ -134,14 +134,15 @@ public void processOpts() {\n \n     @Override\n     public String getTypeDeclaration(Schema p) {\n+        String oasType = getSchemaType(p);", "originalCommit": "be8e05db2dcc1458eaf7814641166e7190b78fa2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMxODU0NA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5266#discussion_r377318544", "bodyText": "I don't think there is a need to have custom type mapping for datetime here at all - because AbstractTsClient already includes it into its typeMappings map. That's why it's not a problem for the TsAngularClient, which doesn't define any specific mapping for DateTime at all, and it still works.\nSo we could just remove it from the child TS generators and rely on the abstract one\nAny thoughts?", "author": "amakhrov", "createdAt": "2020-02-10T21:11:21Z", "path": "modules/openapi-generator/src/main/java/org/openapitools/codegen/languages/TypeScriptFetchClientCodegen.java", "diffHunk": "@@ -134,14 +134,15 @@ public void processOpts() {\n \n     @Override\n     public String getTypeDeclaration(Schema p) {\n+        String oasType = getSchemaType(p);\n         if (ModelUtils.isFileSchema(p)) {\n             return \"Blob\";\n         } else if (ModelUtils.isBinarySchema(p)) {\n             return \"Blob\";\n         } else if (ModelUtils.isDateSchema(p)) {\n-            return \"Date\";\n+            return typeMapping.containsKey(\"Date\") ? typeMapping.get(\"Date\") : \"Date\";\n         } else if (ModelUtils.isDateTimeSchema(p)) {\n-            return \"Date\";\n+            return typeMapping.containsKey(\"Date\") ? typeMapping.get(\"Date\") : \"Date\";\n         }", "originalCommit": "be8e05db2dcc1458eaf7814641166e7190b78fa2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMzODgyNg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5266#discussion_r377338826", "bodyText": "The custom mapping was apparently introduced in 1e023f3 to fix a bug where someone expected the default type for date to be Date.\nI agree that it seems a bit weird and that changing the defaults is exactly what type-mappings is for. Is it reasonable to change the (now) default behavior for date back to string?", "author": "asmundg", "createdAt": "2020-02-10T21:53:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMxODU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM1NzI3Ng==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5266#discussion_r377357276", "bodyText": "There are a few things going on here:\n\nAbstract TS client has default mapping for date and DateTime (latter maps to typescript Date object - by mistake)\nTsFetch client doesn't define its own mappings, but redefines getTypeDeclaration in a way that it's always Date.\nTsFetch client also defines some runtime logic in the generated TS code to actually instantiate Date objects from the strings. So does TsReduxQuery.\nTsRxjs client doesn't generate any mapping code, so Date type in the interfaces is simply incorrect there again.\n\nBased on the above, TsFetch's usage of Date object is legit - because the generated code indeed converts raw http data to and from Date. (the same also true for TsReduxQuery).\nThe only reason for a user to change this default behavior is if they have custom templates (proivided via --template-dir), which do not do any Date serialization, in contrast to built-in templates.\nI can imagine the following solution:\n\nAll child TS clients rely on AbstractTs's protected typeMappings. Furthermore, we want to make sure it maps DateTime to string, as it already does for date.\nSome child TS clients (fetch, redux-query) should override those typeMappings - not via custom Java code, but via the same protected typeMappings.\nIf a user has special needs (because they use custom mustache templates), they provide custom mappings typeMappings via --type-mappings option, which takes precedence over values populated in the codegen constructor.", "author": "amakhrov", "createdAt": "2020-02-10T22:33:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMxODU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ4NzM4NA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5266#discussion_r377487384", "bodyText": "Right, that sounds sensible.", "author": "asmundg", "createdAt": "2020-02-11T08:11:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMxODU0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMxOTg4OQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5266#discussion_r377319889", "bodyText": "not sure this is correct.\nAccording to DefaultCodegen#getPrimitiveType() implementation, \"Date\" is not a valid primitive type. Instead, \"date\" is (more precisely, SchemaTypeUtil.DATE_FORMAT).\nAgain, the AbstractTsClient already includes a reasonable mapping for it (maps to \"string\": typeMapping.put(\"date\", \"string\");). So having it in the child TS codegens seems redundant", "author": "amakhrov", "createdAt": "2020-02-10T21:14:12Z", "path": "modules/openapi-generator/src/main/java/org/openapitools/codegen/languages/TypeScriptFetchClientCodegen.java", "diffHunk": "@@ -134,14 +134,15 @@ public void processOpts() {\n \n     @Override\n     public String getTypeDeclaration(Schema p) {\n+        String oasType = getSchemaType(p);\n         if (ModelUtils.isFileSchema(p)) {\n             return \"Blob\";\n         } else if (ModelUtils.isBinarySchema(p)) {\n             return \"Blob\";\n         } else if (ModelUtils.isDateSchema(p)) {\n-            return \"Date\";\n+            return typeMapping.containsKey(\"Date\") ? typeMapping.get(\"Date\") : \"Date\";", "originalCommit": "be8e05db2dcc1458eaf7814641166e7190b78fa2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2f446eec0ab2b75a12eae1f77aa0c956f20404ad", "url": "https://github.com/OpenAPITools/openapi-generator/commit/2f446eec0ab2b75a12eae1f77aa0c956f20404ad", "message": "Use default type mappings for date/date-time", "committedDate": "2020-02-10T22:11:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ5OTMxMA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5266#discussion_r377499310", "bodyText": "this should be Date, since typescript-fetch implements date deserialization:\nhttps://github.com/OpenAPITools/openapi-generator/blob/master/modules/openapi-generator/src/main/resources/typescript-fetch/modelGeneric.mustache#L66", "author": "macjohnny", "createdAt": "2020-02-11T08:43:34Z", "path": "modules/openapi-generator/src/test/java/org/openapitools/codegen/typescript/fetch/TypeScriptFetchModelTest.java", "diffHunk": "@@ -95,7 +95,7 @@ public void simpleModelTest() {\n         final CodegenProperty property4 = cm.vars.get(3);\n         Assert.assertEquals(property4.baseName, \"birthDate\");\n         Assert.assertEquals(property4.complexType, null);\n-        Assert.assertEquals(property4.dataType, \"Date\");\n+        Assert.assertEquals(property4.dataType, \"string\");", "originalCommit": "2f446eec0ab2b75a12eae1f77aa0c956f20404ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fa6d77ca01e11f21b0e42249a2bc1f749b3d520b", "url": "https://github.com/OpenAPITools/openapi-generator/commit/fa6d77ca01e11f21b0e42249a2bc1f749b3d520b", "message": "Use typeMapping mechanism correctly", "committedDate": "2020-02-11T08:54:45Z", "type": "commit"}, {"oid": "317a3a49492215053212cc643b2b8db2cafb9364", "url": "https://github.com/OpenAPITools/openapi-generator/commit/317a3a49492215053212cc643b2b8db2cafb9364", "message": "Add default mapping for angular and node to preserve behavior", "committedDate": "2020-02-11T13:07:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyNjE0MQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5266#discussion_r377626141", "bodyText": "I think it would be good to remove this, i.e. to change the mapping from Date to string for format: date-time, since the typescript-angular generator does not support serialization for the models.\nNote: this would pose a problem, since serialization for query params is implemented, see e.g. #5225", "author": "macjohnny", "createdAt": "2020-02-11T13:15:58Z", "path": "modules/openapi-generator/src/main/java/org/openapitools/codegen/languages/TypeScriptAngularClientCodegen.java", "diffHunk": "@@ -86,6 +86,8 @@ public TypeScriptAngularClientCodegen() {\n         apiPackage = \"api\";\n         modelPackage = \"model\";\n \n+        typeMapping.put(\"DateTime\", \"Date\");", "originalCommit": "317a3a49492215053212cc643b2b8db2cafb9364", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY2OTIxMg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5266#discussion_r377669212", "bodyText": "Right, it was unclear to me whether de-serialization was supported for angular. And it would require changing the unit tests.\nI'm tempted to just keep the current behavior and punt on \"fixing\" it for angular.", "author": "asmundg", "createdAt": "2020-02-11T14:31:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyNjE0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc1OTYyMQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5266#discussion_r377759621", "bodyText": "@macjohnny we can remove it separately (for angular and other generators except fetch/reduxquery), since it might break existing behavior for current users", "author": "amakhrov", "createdAt": "2020-02-11T16:46:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyNjE0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODExNzg2Mw==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5266#discussion_r378117863", "bodyText": "Ok, I updated the rest of the generators to keep the output consistent.", "author": "asmundg", "createdAt": "2020-02-12T09:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyNjE0MQ=="}], "type": "inlineReview"}, {"oid": "976d7b27330e0d503e8768a4add511cbff3bc7e8", "url": "https://github.com/OpenAPITools/openapi-generator/commit/976d7b27330e0d503e8768a4add511cbff3bc7e8", "message": "One more change to keep current behavior", "committedDate": "2020-02-11T14:33:01Z", "type": "commit"}, {"oid": "515850cb4a9cbae631c0801dbb7694c68d8a6007", "url": "https://github.com/OpenAPITools/openapi-generator/commit/515850cb4a9cbae631c0801dbb7694c68d8a6007", "message": "Add default type mappings to the other TS generators", "committedDate": "2020-02-12T09:04:53Z", "type": "commit"}]}