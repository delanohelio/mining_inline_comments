{"pr_number": 6047, "pr_title": "dart-dio improvements ", "pr_createdAt": "2020-04-24T18:48:56Z", "pr_url": "https://github.com/OpenAPITools/openapi-generator/pull/6047", "timeline": [{"oid": "8b5e991d6c4db0939514d66516f6285cd32c8311", "url": "https://github.com/OpenAPITools/openapi-generator/commit/8b5e991d6c4db0939514d66516f6285cd32c8311", "message": "fix runtime deserialisation", "committedDate": "2020-04-24T16:47:33Z", "type": "commit"}, {"oid": "25ca4e7a32f886020adcb9883d57285e8b4b619a", "url": "https://github.com/OpenAPITools/openapi-generator/commit/25ca4e7a32f886020adcb9883d57285e8b4b619a", "message": "add security support for dart dio", "committedDate": "2020-04-24T18:43:39Z", "type": "commit"}, {"oid": "d9da928246b561bd2ad80f80b678452b7f6cd2cb", "url": "https://github.com/OpenAPITools/openapi-generator/commit/d9da928246b561bd2ad80f80b678452b7f6cd2cb", "message": "regenerate dart dio sample", "committedDate": "2020-04-24T18:47:48Z", "type": "commit"}, {"oid": "564dbc01c7d3c357eff8d547b6eefc47e1847efe", "url": "https://github.com/OpenAPITools/openapi-generator/commit/564dbc01c7d3c357eff8d547b6eefc47e1847efe", "message": "update dio pubspec.mustache deps", "committedDate": "2020-04-24T19:41:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzMTA0OA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6047#discussion_r414831048", "bodyText": "What was the issue here? I've been using clients generated from this template without any deserialization issues.", "author": "josh-burton", "createdAt": "2020-04-24T20:03:59Z", "path": "modules/openapi-generator/src/main/resources/dart-dio/api.mustache", "diffHunk": "@@ -78,19 +78,22 @@ class {{classname}} {\n             options: Options(\n             method: '{{httpMethod}}'.toUpperCase(),\n             headers: headerParams,\n+            extra: {\n+                'secure': [{{#authMethods}} {\"type\": \"{{type}}\", \"name\": \"{{name}}\"{{#isApiKey}}, \"keyName\": \"{{keyParamName}}\", \"where\": \"{{#isKeyInQuery}}query{{/isKeyInQuery}}{{#isKeyInHeader}}header{{/isKeyInHeader}}\"{{/isApiKey}} }{{#hasMore}}, {{/hasMore}}{{/authMethods}}],\n+            },\n             contentType: contentTypes.isNotEmpty ? contentTypes[0] : \"application/json\",\n             ),\n             cancelToken: cancelToken,\n             ){{#returnType}}.then((response) {\n \n         {{#isListContainer}}\n                 final FullType type = const FullType(BuiltList, const [const FullType({{returnBaseType}})]);\n-                BuiltList<{{returnBaseType}}> dataList = _serializers.deserialize(response.data, specifiedType: type);\n+                BuiltList<{{returnBaseType}}> dataList = _serializers.deserialize(jsonDecode(response.data), specifiedType: type);\n                 var data = dataList.toList();\n         {{/isListContainer}}\n         {{^isListContainer}}\n         var serializer = _serializers.serializerForType({{{returnType}}});\n-        var data = _serializers.deserializeWith<{{{returnType}}}>(serializer, response.data);\n+        var data = _serializers.deserializeWith<{{{returnType}}}>(serializer, jsonDecode(response.data));", "originalCommit": "564dbc01c7d3c357eff8d547b6eefc47e1847efe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzNTEyNA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6047#discussion_r414835124", "bodyText": "The issue was that out of the box nothing was working for me serializer was expecting a map and it wasn't happy with the string check #6026 for details. maybe I've done something wrong...", "author": "jaumard", "createdAt": "2020-04-24T20:11:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzMTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzNzQ5OQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6047#discussion_r414837499", "bodyText": "Ah, I think I know why now. I use a Dio Transformer in all my clients: https://github.com/flutterchina/dio_flutter_transformer\nI think a better approach would be to create default transformer for the generated client that parses the json. Then it can be overidden by a custom transformer.\nWe probably need to check what type the response is before deserializing and throw an error if its not a map.", "author": "josh-burton", "createdAt": "2020-04-24T20:16:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzMTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg0MTE0Mw==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6047#discussion_r414841143", "bodyText": "I'm super new to dio and don't know transformer ^^ but from what I read yes that's why you don't have any issue, I'll change my code to use a transformer then :)", "author": "jaumard", "createdAt": "2020-04-24T20:23:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzMTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg0NDU1Ng==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6047#discussion_r414844556", "bodyText": "but from the look of the doc transformers are not always used :/\n/// [transformer] allows changes to the request/response data before it is sent/received to/from the server\n  /// This is only applicable for request methods 'PUT', 'POST', and 'PATCH'.\n  Transformer transformer;", "author": "jaumard", "createdAt": "2020-04-24T20:29:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzMTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg0NDg1Mw==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6047#discussion_r414844853", "bodyText": "why not check if response is string to use jsonDecode on it ?", "author": "jaumard", "createdAt": "2020-04-24T20:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzMTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg0NjU3NQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6047#discussion_r414846575", "bodyText": "I think those docs are wrong because my GET requests are being transformed.\nChecking the response type is an ok approach as well.", "author": "josh-burton", "createdAt": "2020-04-24T20:33:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzMTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg1NzY4Mg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6047#discussion_r414857682", "bodyText": "done", "author": "jaumard", "createdAt": "2020-04-24T20:55:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzMTA0OA=="}], "type": "inlineReview"}, {"oid": "b0d69b8bc68998497ed641298399f0e0bd903525", "url": "https://github.com/OpenAPITools/openapi-generator/commit/b0d69b8bc68998497ed641298399f0e0bd903525", "message": "check response type before parsing", "committedDate": "2020-04-24T20:55:26Z", "type": "commit"}, {"oid": "80674418dbd9d2e739d9ffbfd3717f366cfa522e", "url": "https://github.com/OpenAPITools/openapi-generator/commit/80674418dbd9d2e739d9ffbfd3717f366cfa522e", "message": "add default dateTime serializer", "committedDate": "2020-04-26T10:35:55Z", "type": "commit"}, {"oid": "a6cef977644ef8a301f8bc64382a273d17bfa2e1", "url": "https://github.com/OpenAPITools/openapi-generator/commit/a6cef977644ef8a301f8bc64382a273d17bfa2e1", "message": "regenerate sample", "committedDate": "2020-04-26T10:40:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI4NzgxNA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6047#discussion_r422287814", "bodyText": "After this change, you cannot have a 'text/plain' response, as it tries to apply jsonDecode on it.\n:(", "author": "haritonstefan", "createdAt": "2020-05-08T18:02:57Z", "path": "modules/openapi-generator/src/main/resources/dart-dio/api.mustache", "diffHunk": "@@ -88,12 +88,12 @@ class {{classname}} {\n \n         {{#isListContainer}}\n                 final FullType type = const FullType(BuiltList, const [const FullType({{returnBaseType}})]);\n-                BuiltList<{{returnBaseType}}> dataList = _serializers.deserialize(jsonDecode(response.data), specifiedType: type);\n+                BuiltList<{{returnBaseType}}> dataList = _serializers.deserialize(response.data is String ? jsonDecode(response.data) : response.data, specifiedType: type);", "originalCommit": "b0d69b8bc68998497ed641298399f0e0bd903525", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI4OTc4Ng==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6047#discussion_r422289786", "bodyText": "With  'text/plain'  response you shouldn't arrived here as you don't need to deserialize at all", "author": "jaumard", "createdAt": "2020-05-08T18:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI4NzgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MzEwMA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6047#discussion_r422453100", "bodyText": "Indeed, but it was trying to deserialize a text/plain response.", "author": "haritonstefan", "createdAt": "2020-05-09T04:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI4NzgxNA=="}], "type": "inlineReview"}]}