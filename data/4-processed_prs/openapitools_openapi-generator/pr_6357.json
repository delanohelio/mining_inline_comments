{"pr_number": 6357, "pr_title": "[core] Refactor templating management", "pr_createdAt": "2020-05-18T21:31:12Z", "pr_url": "https://github.com/OpenAPITools/openapi-generator/pull/6357", "timeline": [{"oid": "636c4dd2d6681d67a11c5c374814034257ef7771", "url": "https://github.com/OpenAPITools/openapi-generator/commit/636c4dd2d6681d67a11c5c374814034257ef7771", "message": "[core] Refactor templating management\n\nThis refactors template management to get logic out of DefaultGenerator\nand to provide a cleaner API to template search and read/compile.\n\nDeprecates MockDefaultGenerator, which is not a mock and causes\nin-memory retention of file contents. Maintainers should prefer\nexecuting a \"dryRun\" with new DefaultGenerator(true) or do true\nmock/spies if evaluating template intermediaries is truly necessary.\nTests may read written files with lower overhead than the in-process\nretention of those bytes.\n\nThis attempts to maintain some compatibility with existing templating\nadapter interfaces. Any breaking change here would be unintentional but\nminimal effort to retarget the new interface.", "committedDate": "2020-05-22T18:31:05Z", "type": "commit"}, {"oid": "d67d3d4e41adcb7a2588c11c06a9248b768d46a5", "url": "https://github.com/OpenAPITools/openapi-generator/commit/d67d3d4e41adcb7a2588c11c06a9248b768d46a5", "message": "Fix javadoc errs", "committedDate": "2020-05-22T18:31:21Z", "type": "commit"}, {"oid": "66f49b6187bb5b6ca8baa2aaee6c613f60c3b18a", "url": "https://github.com/OpenAPITools/openapi-generator/commit/66f49b6187bb5b6ca8baa2aaee6c613f60c3b18a", "message": "Tests for dry run file outputs", "committedDate": "2020-05-22T18:31:21Z", "type": "commit"}, {"oid": "6a745de4df54390a55ed3cd1aadad611e64cb774", "url": "https://github.com/OpenAPITools/openapi-generator/commit/6a745de4df54390a55ed3cd1aadad611e64cb774", "message": "Update API usage in Meta, test TemplateManager", "committedDate": "2020-05-22T18:31:55Z", "type": "commit"}, {"oid": "a1b23d99ffb614ebba92b6f264ca756b1fc79adf", "url": "https://github.com/OpenAPITools/openapi-generator/commit/a1b23d99ffb614ebba92b6f264ca756b1fc79adf", "message": "Fix temp file in overwrite test.", "committedDate": "2020-05-22T18:32:04Z", "type": "commit"}, {"oid": "f3ccf3c8a456ff7d0a8ae8bbfb0129ca977ac4dc", "url": "https://github.com/OpenAPITools/openapi-generator/commit/f3ccf3c8a456ff7d0a8ae8bbfb0129ca977ac4dc", "message": "Wait on lastModified, lookup by filename in SpringCodegenTest", "committedDate": "2020-05-22T18:32:04Z", "type": "commit"}, {"oid": "4c3c28ea4326490578546a0cb1f82bd987e00694", "url": "https://github.com/OpenAPITools/openapi-generator/commit/4c3c28ea4326490578546a0cb1f82bd987e00694", "message": "Remove minimal update test from DefaultGenerator (dupe with TemplateManagerTest)", "committedDate": "2020-05-22T18:32:04Z", "type": "commit"}, {"oid": "bb804a4eba37bbb15e164d91475e5a6d6ae4a337", "url": "https://github.com/OpenAPITools/openapi-generator/commit/bb804a4eba37bbb15e164d91475e5a6d6ae4a337", "message": "Test DefaultGenerator + ignore file", "committedDate": "2020-05-22T18:32:05Z", "type": "commit"}, {"oid": "ecb985ecfb00bfe97695d81dcba68d5b4d3474ae", "url": "https://github.com/OpenAPITools/openapi-generator/commit/ecb985ecfb00bfe97695d81dcba68d5b4d3474ae", "message": "Move config.processOpenAPI in DefaultGenerator", "committedDate": "2020-05-22T18:32:05Z", "type": "commit"}, {"oid": "f970e7cccff2c5e2cc71ddd567ed02b91fcb6ad6", "url": "https://github.com/OpenAPITools/openapi-generator/commit/f970e7cccff2c5e2cc71ddd567ed02b91fcb6ad6", "message": "Clarify comment in GeneratorTemplateContentLocator", "committedDate": "2020-05-22T18:32:05Z", "type": "commit"}, {"oid": "8062b77829472f5ff3acd78f68d6f4609beba698", "url": "https://github.com/OpenAPITools/openapi-generator/commit/8062b77829472f5ff3acd78f68d6f4609beba698", "message": "Do not overwrite existing test files", "committedDate": "2020-05-22T18:32:06Z", "type": "commit"}, {"oid": "048cc6efa2b134a8cda0d541f9ed09ee2200ee30", "url": "https://github.com/OpenAPITools/openapi-generator/commit/048cc6efa2b134a8cda0d541f9ed09ee2200ee30", "message": "Fix wrong use of libraries templateDirector (java)\n\nThe samples scripts for Java incorrectly referenced the libraries\ndirectories directly rather than the upper-level Java directory. This\nwas incorrect usage of template directories, because the generator\nexpects to be given the \"language\" directory and perform a lookup for\nmissing templates in the order:\n\n* user defined libraries directory\n* user defined language root\n* embedded libraries directory\n* embedded language root\n* _common directory\n\nThis is incorrect in our samples scripts because a user or maintainer\nhas the expectation that any template change to files at the Java/ root\nshould also be honored on generation if the script specifies a custom\ntemplate directory.", "committedDate": "2020-05-22T19:01:43Z", "type": "commit"}, {"oid": "d5307f3184db13284f85ea1aab40213147a1b130", "url": "https://github.com/OpenAPITools/openapi-generator/commit/d5307f3184db13284f85ea1aab40213147a1b130", "message": "[samples] Regenerate", "committedDate": "2020-05-22T19:05:51Z", "type": "commit"}, {"oid": "d5307f3184db13284f85ea1aab40213147a1b130", "url": "https://github.com/OpenAPITools/openapi-generator/commit/d5307f3184db13284f85ea1aab40213147a1b130", "message": "[samples] Regenerate", "committedDate": "2020-05-22T19:05:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxMzMzNw==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6357#discussion_r429413337", "bodyText": "FYI breaking change, but we should really try sticking to interfaces and move away from abstract base types.", "author": "jimschubert", "createdAt": "2020-05-22T19:09:55Z", "path": "modules/openapi-generator/src/main/java/org/openapitools/codegen/AbstractGenerator.java", "diffHunk": "@@ -1,213 +0,0 @@\n-/*\n- * Copyright 2018 OpenAPI-Generator Contributors (https://openapi-generator.tech)\n- * Copyright 2018 SmartBear Software\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     https://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package org.openapitools.codegen;\n-\n-import java.nio.charset.StandardCharsets;\n-import java.nio.file.Files;\n-import java.nio.file.StandardCopyOption;\n-import java.util.Arrays;\n-import org.apache.commons.lang3.StringUtils;\n-import org.openapitools.codegen.api.TemplatingGenerator;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-import java.io.*;\n-import java.nio.file.Paths;\n-import java.util.HashMap;\n-import java.util.Map;\n-import java.util.Scanner;\n-import java.util.regex.Pattern;\n-\n-public abstract class AbstractGenerator implements TemplatingGenerator {", "originalCommit": "d5307f3184db13284f85ea1aab40213147a1b130", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxMzY0OA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6357#discussion_r429413648", "bodyText": "this is now handled by template loading functionality, as that is not the responsibility of DefaultCodegen.", "author": "jimschubert", "createdAt": "2020-05-22T19:10:42Z", "path": "modules/openapi-generator/src/main/java/org/openapitools/codegen/DefaultCodegen.java", "diffHunk": "@@ -163,7 +163,6 @@ apiTemplateFiles are for API outputs only (controllers/handlers).\n     protected Map<String, String> reservedWordsMappings = new HashMap<String, String>();\n     protected String templateDir;\n     protected String embeddedTemplateDir;\n-    protected String commonTemplateDir = \"_common\";", "originalCommit": "d5307f3184db13284f85ea1aab40213147a1b130", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxNTMwNw==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6357#discussion_r429415307", "bodyText": "MockDefaultGenerator duplicates all written bytes. getTemplateBasedFile is used to \"inspect\" data passed to templates, but this should be tested differently in the future.", "author": "jimschubert", "createdAt": "2020-05-22T19:15:05Z", "path": "modules/openapi-generator/src/test/java/org/openapitools/codegen/TestUtils.java", "diffHunk": "@@ -83,31 +88,32 @@ public static OpenAPI createOpenAPIWithOneSchema(String name, Schema schema) {\n         return openAPI;\n     }\n \n+    /**\n+     * Extract file from {@link MockDefaultGenerator}\n+     *\n+     * @param generator Generator\n+     * @param root root path\n+     * @param filename filename under root\n+     *\n+     * @return a {@link WrittenTemplateBasedFile}\n+     * @deprecated Since 5.0. Please avoid this method and usage of {@link MockDefaultGenerator}, prefer {@link DefaultGenerator#DefaultGenerator(Boolean)} with dryRun=true.", "originalCommit": "d5307f3184db13284f85ea1aab40213147a1b130", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e2671599651e455f56e662e7f91c5cee443edbbf", "url": "https://github.com/OpenAPITools/openapi-generator/commit/e2671599651e455f56e662e7f91c5cee443edbbf", "message": "Merge branch 'master' into cleanup-template-management\n\n* master:\n  [samples] Regenerate python-experimental\n  [core][general] Add metadata file tracking to aid in \"Golden Tests\" regeneration (#6325)\n  [python-experimental] Add support for pep 3134, attach cause of exception (#6388)\n  [Java-jersey2] Add new ApiClient constructor with auth objects (#6393)", "committedDate": "2020-05-22T21:24:47Z", "type": "commit"}, {"oid": "edaa59288c6741bca754f9be791a94e5474f7407", "url": "https://github.com/OpenAPITools/openapi-generator/commit/edaa59288c6741bca754f9be791a94e5474f7407", "message": "Fix handlebars extension usage, clean up Meta tasks\n\nHandlebarseEngineAdapter previously didn't handle files without\nextensions in the same was as the MustacheEngineAdapter. This now allows\nfor files without extension (or dotfiles) to lookup in the same\nlocation.\n\nMeta tasks are cleaned up to use template manager only, rather than\nattempting to create an \"empty\" generator to use the previous templating\nspecific methods.", "committedDate": "2020-05-23T10:00:47Z", "type": "commit"}, {"oid": "ccbcf6f69a8cb2220d5895c996e36c125af14d79", "url": "https://github.com/OpenAPITools/openapi-generator/commit/ccbcf6f69a8cb2220d5895c996e36c125af14d79", "message": "Merge branch 'master' into cleanup-template-management\n\n* master:\n  update java jersey2 samples\n  [Java] Fix mustache tag in pom template for HTTP signature (#6404)\n  [Python-experimental] Rename from_server variable to json_variable_naming (#6390)\n  Add a link to medium blog post (#6403)\n  Clean up debug in test (#6398)\n  readding bin/swift5-petstore-readonlyProperties.json\n  remove ./bin/swift5-petstore-readonlyProperties.json", "committedDate": "2020-05-23T11:00:41Z", "type": "commit"}, {"oid": "ef4e8359b707d07ca57dab4795d9045374ef51ca", "url": "https://github.com/OpenAPITools/openapi-generator/commit/ef4e8359b707d07ca57dab4795d9045374ef51ca", "message": "Merge branch 'master' into cleanup-template-management\n\n* master:\n  decomission nodejs server generator (#6406)\n  [Java] Generate valid code if no Authentication implementations present (#5788)", "committedDate": "2020-05-23T13:44:25Z", "type": "commit"}, {"oid": "00ebf203a32ce41bde07f71a584631e64d5179bd", "url": "https://github.com/OpenAPITools/openapi-generator/commit/00ebf203a32ce41bde07f71a584631e64d5179bd", "message": "Merge branch 'master' into cleanup-template-management\n\n* master:\n  [java-jersey2] Conditionally include http signature mustache template (#6413)\n  [bug] Fix path provider bug on CI (#6409)", "committedDate": "2020-05-23T21:37:36Z", "type": "commit"}, {"oid": "5f6368cf9f01dc979040e0f7f71258743f8b0fa7", "url": "https://github.com/OpenAPITools/openapi-generator/commit/5f6368cf9f01dc979040e0f7f71258743f8b0fa7", "message": "Move FILES/VERSION metadata gen to private methods", "committedDate": "2020-05-23T22:04:45Z", "type": "commit"}, {"oid": "9b046c2c0eca4c8b69143b8a6d706a33135882f9", "url": "https://github.com/OpenAPITools/openapi-generator/commit/9b046c2c0eca4c8b69143b8a6d706a33135882f9", "message": "Update kotlin-multiplatform gradle wrapper", "committedDate": "2020-05-24T02:07:16Z", "type": "commit"}, {"oid": "8943146f5844d51cfce4995c61aaebeaa6fe3f5a", "url": "https://github.com/OpenAPITools/openapi-generator/commit/8943146f5844d51cfce4995c61aaebeaa6fe3f5a", "message": "Rename GraphQL .gitignore template\n\nThe .gitignore file is unable to load via classpath resource from the\ngraphql node server resource directory (for unknown reasons). Before\nthis change, the missing template would fail silently.\n\nA .gitignore file may exist in other directories and load as expected.\nAdded a default .gitignore to _common as a fallback so as not to break\nany custom generators which may also be failing silently.", "committedDate": "2020-05-24T12:54:42Z", "type": "commit"}, {"oid": "d256cecf1a1388935ad78f224793ff6019203ac4", "url": "https://github.com/OpenAPITools/openapi-generator/commit/d256cecf1a1388935ad78f224793ff6019203ac4", "message": "Log entire stacktrace in go sdk built by gradle in AppVeyor", "committedDate": "2020-05-24T12:57:35Z", "type": "commit"}, {"oid": "33f89fd4126b99dd644dd6d083699beedde32eb3", "url": "https://github.com/OpenAPITools/openapi-generator/commit/33f89fd4126b99dd644dd6d083699beedde32eb3", "message": "Rename PHP .gitignore to gitignore\n\nJava resources may not load .gitignore, this follows suit with other\ngenerators and uses \"gitignore\" (some use \"gitignore.mustache\").", "committedDate": "2020-05-24T14:12:04Z", "type": "commit"}, {"oid": "3ea74693f038ab62471db5b5f950856058241400", "url": "https://github.com/OpenAPITools/openapi-generator/commit/3ea74693f038ab62471db5b5f950856058241400", "message": "[samples] Regenerate", "committedDate": "2020-05-24T15:46:39Z", "type": "commit"}, {"oid": "bc86eea56af4263a704d52d3f3251b63ff5cc931", "url": "https://github.com/OpenAPITools/openapi-generator/commit/bc86eea56af4263a704d52d3f3251b63ff5cc931", "message": "[php] Rename .gitignore templates to gitignore", "committedDate": "2020-05-24T16:19:14Z", "type": "commit"}, {"oid": "e934beca61b2ee293b8f142e12f382cb88cf0a55", "url": "https://github.com/OpenAPITools/openapi-generator/commit/e934beca61b2ee293b8f142e12f382cb88cf0a55", "message": "Use same classpath lookup in common locator", "committedDate": "2020-05-25T02:46:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyMDgzNg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6357#discussion_r429920836", "bodyText": "Note these removals of libraries/<library name> in the Java sample configs and scripts.\nWhile this syntax works if the entirety of the library code is in the named folder, this would cause fallbacks to fail if anyone were to remove something like model.mustache intending to fallback to resources/Java/model.mustache. We should avoid this possible confusion especially when these subdirectories are structured to follow our library lookup logic:\n\nUser customized library path (e.g. custom_template/libraries/feign/model.mustache)\nUser customized generator top-level path (e.g. custom_template/model.mustache)\nEmbedded library path (e.g. resources/Java/libraries/feign/model.mustache)\nEmbedded top-level path (e.g. resources/Java/model.mustache)\nCommon embedded path (e.g. resources/_common/model.mustache)\nthrow TemplateNotFoundException", "author": "jimschubert", "createdAt": "2020-05-25T12:57:02Z", "path": "bin/ci/java-feign.json", "diffHunk": "@@ -3,7 +3,7 @@\n   \"generatorName\": \"java\",\n   \"inputSpec\": \"modules/openapi-generator/src/test/resources/2_0/petstore-with-fake-endpoints-models-for-testing.yaml\",\n   \"outputDir\": \"samples/client/petstore/java/feign\",\n-  \"templateDir\": \"modules/openapi-generator/src/main/resources/Java/libraries/feign\",", "originalCommit": "e934beca61b2ee293b8f142e12f382cb88cf0a55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyMTMyMg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6357#discussion_r429921322", "bodyText": "I'd like to leave --stacktrace here rather than --info. It was taking ~2 hours to get the feedback from AppVeyor after commit and I was unable to repro the issue in Windows locally.", "author": "jimschubert", "createdAt": "2020-05-25T12:58:08Z", "path": "appveyor.yml", "diffHunk": "@@ -50,7 +50,7 @@ build_script:\n   # install openapi-generator locally\n   - mvn clean install --quiet -Dorg.slf4j.simpleLogger.defaultLogLevel=error\n   # run the locally installed openapi-generator-gradle-plugin\n-  - gradle -b modules\\openapi-generator-gradle-plugin\\samples\\local-spec\\build.gradle buildGoSdk --info\n+  - gradle -b modules\\openapi-generator-gradle-plugin\\samples\\local-spec\\build.gradle buildGoSdk --stacktrace", "originalCommit": "e934beca61b2ee293b8f142e12f382cb88cf0a55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyMzM5OQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6357#discussion_r429923399", "bodyText": "Notice regarding the design\u2026\u00a0template processor no longer requires that we pass that logic through a DefaultGenerator instance, which holds logic for OpenAPI input generation to templated output.\nWe can now generate without tight coupling to OpenAPI documents. This is work directed toward #841 and somewhat related to #843.", "author": "jimschubert", "createdAt": "2020-05-25T13:02:52Z", "path": "modules/openapi-generator-cli/src/main/java/org/openapitools/codegen/cmd/Meta.java", "diffHunk": "@@ -136,52 +141,38 @@ public void execute() {\n      */\n     private static Converter<SupportingFile, File> processFiles(final File targetDir,\n             final Map<String, Object> data) {\n-        return new Converter<SupportingFile, File>() {\n-            private DefaultGenerator generator = new DefaultGenerator();\n-\n-            @Override\n-            public File convert(SupportingFile support) {\n-                try {\n-                    File destinationFolder =\n-                            new File(new File(targetDir.getAbsolutePath()), support.folder);\n-                    File outputFile = new File(destinationFolder, support.destinationFilename);\n-\n-                    String template =\n-                            generator.readTemplate(new File(TEMPLATE_DIR_CLASSPATH,\n-                                    support.templateFile).getPath());\n-                    String formatted = template;\n-\n-                    if (support.templateFile.endsWith(MUSTACHE_EXTENSION)) {\n-                        LOGGER.info(\"writing file to {}\", outputFile.getAbsolutePath());\n-                        formatted =\n-                                Mustache.compiler().withLoader(loader(generator)).defaultValue(\"\")\n-                                        .compile(template).execute(data);\n-                    } else {\n-                        LOGGER.info(\"copying file to {}\", outputFile.getAbsolutePath());\n-                    }\n-\n-                    FileUtils.writeStringToFile(outputFile, formatted, StandardCharsets.UTF_8);\n-                    return outputFile;\n-\n-                } catch (IOException e) {\n-                    throw new RuntimeException(\"Can't generate project\", e);\n+        return support -> {\n+            try {\n+                File destinationFolder =\n+                        new File(new File(targetDir.getAbsolutePath()), support.folder);\n+                File outputFile = new File(destinationFolder, support.destinationFilename);\n+\n+                TemplateManager templateProcessor = new TemplateManager(\n+                        new TemplateManagerOptions(false, false),\n+                        new MustacheEngineAdapter(),\n+                        new TemplatePathLocator[]{ new CommonTemplateContentLocator(\"codegen\") }\n+                );\n+\n+                String template = templateProcessor.readTemplate(new File(TEMPLATE_DIR_CLASSPATH, support.templateFile).getPath());\n+\n+                String formatted = template;\n+\n+                Mustache.TemplateLoader loader = name -> templateProcessor.getTemplateReader(name.concat(MUSTACHE_EXTENSION));", "originalCommit": "e934beca61b2ee293b8f142e12f382cb88cf0a55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyNTc4Mg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6357#discussion_r429925782", "bodyText": "I found that .gitignore files sometimes don't load via this.getClass().getClassLoader().getResource(path).\nFor example, this works: this.getClass().getClassLoader().getResource(\"_common/.openapi-generator-ignore\") while this did not: this.getClass().getClassLoader().getResource(\"graphql-nodejs-express-server/.gitignore\"). This only seems to affect PHP and the GraphQL Express servers as everything else is either gitignore or gitignore.mustache (the formats documented as acceptable on Java documentation).", "author": "jimschubert", "createdAt": "2020-05-25T13:08:22Z", "path": "modules/openapi-generator/src/main/java/org/openapitools/codegen/languages/AbstractPhpCodegen.java", "diffHunk": "@@ -218,7 +218,7 @@ public void processOpts() {\n         // supportingFiles.add(new SupportingFile(\"LICENSE\", \"\", \"LICENSE\"));\n \n         // all PHP codegens requires Composer, it means that we need to exclude from SVN at least vendor folder\n-        supportingFiles.add(new SupportingFile(\".gitignore\", \"\", \".gitignore\"));", "originalCommit": "e934beca61b2ee293b8f142e12f382cb88cf0a55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyODMzOQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6357#discussion_r429928339", "bodyText": "This is required because filenames without extensions would become .hbs or .handlebars in the above loop. A file which isn't intended to be handled like REAMDE.md would become README.hbs or README.handlebars and would result in template not found without this as-is attempt.", "author": "jimschubert", "createdAt": "2020-05-25T13:13:57Z", "path": "modules/openapi-generator/src/main/java/org/openapitools/codegen/templating/HandlebarsEngineAdapter.java", "diffHunk": "@@ -83,14 +82,22 @@ public TemplateSource sourceAt(String location) {\n         return tmpl.apply(context);\n     }\n \n-    public TemplateSource findTemplate(TemplatingGenerator generator, String templateFile) {\n-        for (String file : getModifiedFileLocation(templateFile)) {\n+    public TemplateSource findTemplate(TemplatingExecutor generator, String templateFile) {\n+        String[] possibilities = getModifiedFileLocation(templateFile);\n+        for (String file : possibilities) {\n             try {\n                 return new StringTemplateSource(file, generator.getFullTemplateContents(file));\n             } catch (Exception ignored) {\n             }\n         }\n-        throw new TemplateNotFoundException(templateFile);\n+\n+        // allow lookup of files without extension modification (such as .openapi-generator-ignore, README.md, etc)\n+        try {", "originalCommit": "e934beca61b2ee293b8f142e12f382cb88cf0a55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyOTgyNg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6357#discussion_r429929826", "bodyText": "I had issues executing this test locally with Bash 5.0. Had to update gradle in the example so the bash sourcing would succeed. I've only updated the generated output rather than the embedded files so we're not forcing users to update to a potentially invalid Gradle version as they regenerate the kotlin multiplatform generate.", "author": "jimschubert", "createdAt": "2020-05-25T13:17:13Z", "path": "samples/client/petstore/kotlin-multiplatform/.openapi-generator-ignore", "diffHunk": "@@ -1,23 +1,5 @@\n # OpenAPI Generator Ignore\n-# Generated by openapi-generator https://github.com/openapitools/openapi-generator\n-\n-# Use this file to prevent files from being overwritten by the generator.\n-# The patterns follow closely to .gitignore or .dockerignore.\n-\n-# As an example, the C# client generator defines ApiClient.cs.\n-# You can make changes and tell OpenAPI Generator to ignore just this file by uncommenting the following line:\n-#ApiClient.cs\n-\n-# You can match any string of characters against a directory, file or extension with a single asterisk (*):\n-#foo/*/qux\n-# The above matches foo/bar/qux and foo/baz/qux, but not foo/bar/baz/qux\n-\n-# You can recursively match patterns against a directory, file or extension with a double asterisk (**):\n-#foo/**/qux\n-# This matches foo/bar/qux, foo/baz/qux, and foo/bar/baz/qux\n-\n-# You can also negate patterns with an exclamation (!).\n-# For example, you can ignore all files in a docs folder with the file extension .md:\n-#docs/*.md\n-# Then explicitly reverse the ignore rule for a single file:\n-#!docs/README.md\n+gradle/wrapper/gradle-wrapper.jar", "originalCommit": "e934beca61b2ee293b8f142e12f382cb88cf0a55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "062b4d276a3a676756ae788a331fae24077152bb", "url": "https://github.com/OpenAPITools/openapi-generator/commit/062b4d276a3a676756ae788a331fae24077152bb", "message": "Merge branch 'master' into cleanup-template-management\n\n* master:\n  [kotlin][client] add support for coroutines with OkHttp (#6362)\n  update package-json.lock (#6430)\n  fix hardcoded match type (#6431)\n  java jersey2 enhance anyOf (#6420)\n  [Java][jersey2] minor improvement to jersey2 tests (#6418)\n  ps minor style change (#6424)\n  [JS] mark ES5 as deprecated (#6408)\n  [ci] Execute maven and verify with no-snapshot-updates (#6415)\n  add new file in ts axios samples\n  Migrate all scala generators to use OAS3 (#6407)\n  migrate ruby samples to oas3 (#6414)\n  [PS] check if JSON properties is defined (#6419)\n  Add C++ UE4  client generator (#6399)\n  Add a link to the article in dev.to (#6421)\n  typescript-axios anytype is not defined (#6335)\n  [Java][jersey2] Make (de)serialization work for oneOf models, add convenience and comparison methods (#6323)\n  Migrate OCaml petstore to use OAS v3 spec (#6348)\n  [Python-experimental] Fix type error if oneof/anyof child schema is null type (#6387)\n  [Python-server] Fix blueplanet 'file not found' error  (#6411)\n  [nodejs] Fix deprecation notice when running sample nodejs script (#6412)", "committedDate": "2020-05-27T00:58:28Z", "type": "commit"}, {"oid": "8faa77626cfbc0af673b2f39693ff2556207119a", "url": "https://github.com/OpenAPITools/openapi-generator/commit/8faa77626cfbc0af673b2f39693ff2556207119a", "message": "[samples] Regenerate", "committedDate": "2020-05-27T01:24:34Z", "type": "commit"}, {"oid": "e3dcb2fd6d90c878b388b06f2c7c8a235dad615e", "url": "https://github.com/OpenAPITools/openapi-generator/commit/e3dcb2fd6d90c878b388b06f2c7c8a235dad615e", "message": "Merge branch 'master' into cleanup-template-management\n\n* master:\n  Fix ruby deprecation error (#6450)\n  [Java][Feign] decommission 9.x support (#6445)\n  fix struct export in rust reqwest (#6453)\n  [Rust][reqwest] add tests to CI (#6454)\n  set pester version (#6448)\n  update datadog logo\n  update groovy petstore samples\n  add datadog as sponsor (#6444)\n  Migrate Groovy samples to oas3 (#6435)\n  [samples] Renerate Kotlin coroutines", "committedDate": "2020-05-28T02:36:14Z", "type": "commit"}, {"oid": "ff91eec174e8de60ba7bd8515be3bee2e8a65453", "url": "https://github.com/OpenAPITools/openapi-generator/commit/ff91eec174e8de60ba7bd8515be3bee2e8a65453", "message": "Regenerate rust samples", "committedDate": "2020-05-28T02:46:03Z", "type": "commit"}, {"oid": "9a982d4ba6d98256440a4ba6ba67d99220560597", "url": "https://github.com/OpenAPITools/openapi-generator/commit/9a982d4ba6d98256440a4ba6ba67d99220560597", "message": "[rust] Properly escape empty triple-braces", "committedDate": "2020-05-28T13:54:08Z", "type": "commit"}, {"oid": "5166440a46d785b5a1d114870320b9baced07046", "url": "https://github.com/OpenAPITools/openapi-generator/commit/5166440a46d785b5a1d114870320b9baced07046", "message": "Merge branch 'master' into cleanup-template-management\n\n* master:\n  [PS] Refactor the http signing auth with ecdsa support (#6397)\n  [Rust Server] Hyper 0.13 + Async/Await support (#6244)\n  [Rust] set supportAsync to true as the default (#6480)\n  [php-symfony] Set required PHP version ^7.1.3 (#6181)\n  update doc\n  [csharp] Rename netstandard to netstandard1.3 (#6460)\n  feat: support deprecated parameters for typescript-axios generator (#6475)\n  [REQ][typescript-axios] useSingleRequestParameter should mark parameter optional if all properties are optional (#6477)\n  better struct alias in rust (#6470)\n  Migrate Go server samples to OAS 3 only (#6471)\n  [Rust][reqwest] add async support (#6464)\n  [codegen][python-experimental] Composed schema with additionalProperties  (#6290)\n  [Java] Decommission Retrofit 1.x support (#6447)\n  remove scala oas3 samples (#6446)\n  [Java][jersey2] Fix RuntimeException when HTTP signature parameters are not configured (#6457)\n  [Java][jersey2] Improve http signature code comments (#6463)\n  [typescript-angular] drop support of angular below 6.0.0 (#6360)\n  [cli] new 'author template' command (#6441)\n  python-experimental updates ancestor + adds descendant discriminator tests (#6417)", "committedDate": "2020-05-30T00:52:28Z", "type": "commit"}, {"oid": "2033a90ac82a8956facf8b4df6c22a13b2aee4f1", "url": "https://github.com/OpenAPITools/openapi-generator/commit/2033a90ac82a8956facf8b4df6c22a13b2aee4f1", "message": "[samples] Regenerate", "committedDate": "2020-05-30T02:05:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1MTA1NQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6357#discussion_r449851055", "bodyText": "JAR classpath resource path requires '/' as file separator always, must not be OS dependent, e.g. '\\' under Windows won't work!\nSuggestion: use TemplateManager.getCPResourcePath(libTemplateFile), may extract to similar method like embeddedTemplateExists(String)", "author": "DenisKnoepfle", "createdAt": "2020-07-05T08:37:22Z", "path": "modules/openapi-generator/src/main/java/org/openapitools/codegen/templating/GeneratorTemplateContentLocator.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package org.openapitools.codegen.templating;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.openapitools.codegen.CodegenConfig;\n+import org.openapitools.codegen.TemplateManager;\n+import org.openapitools.codegen.api.TemplatePathLocator;\n+\n+import java.io.File;\n+\n+/**\n+ * Locates templates according to {@link CodegenConfig} settings.\n+ */\n+public class GeneratorTemplateContentLocator implements TemplatePathLocator {\n+    private final CodegenConfig codegenConfig;\n+\n+    /**\n+     * Constructs a new instance of {@link GeneratorTemplateContentLocator} for the provided {@link CodegenConfig}\n+     *\n+     * @param codegenConfig A generator's configuration used for determining template file location.\n+     */\n+    public GeneratorTemplateContentLocator(CodegenConfig codegenConfig) {\n+        this.codegenConfig = codegenConfig;\n+    }\n+\n+    private String buildLibraryFilePath(String dir, String library, String file) {\n+        return dir + File.separator + \"libraries\" + File.separator + library + File.separator + file;\n+    }\n+\n+    /**\n+     * Determines whether an embedded file with the specified name exists.\n+     *\n+     * @param name The name of the file (i.e. relative to resource root)\n+     *\n+     * @return true if file is an embedded resource, false if it does not exist\n+     */\n+    public boolean embeddedTemplateExists(String name) {\n+        return this.getClass().getClassLoader().getResource(TemplateManager.getCPResourcePath(name)) != null;\n+    }\n+\n+    /**\n+     * Get the template file path with template dir prepended, and use the library template if exists.\n+     *\n+     * Precedence:\n+     * 1) (template dir)/libraries/(library)\n+     * 2) (template dir)\n+     * 3) (embedded template dir)/libraries/(library)\n+     * 4) (embedded template dir)\n+     *\n+     * Where \"template dir\" may be user defined and \"embedded template dir\" are the built-in templates for the given generator.\n+     *\n+     * @param relativeTemplateFile Template file\n+     * @return String Full template file path\n+     */\n+    @Override\n+    public String getFullTemplatePath(String relativeTemplateFile) {\n+        CodegenConfig config = this.codegenConfig;\n+\n+        //check the supplied template library folder for the file\n+        final String library = config.getLibrary();\n+        if (StringUtils.isNotEmpty(library)) {\n+            //look for the file in the library subfolder of the supplied template\n+            final String libTemplateFile = buildLibraryFilePath(config.templateDir(), library, relativeTemplateFile);\n+            if (new File(libTemplateFile).exists() || this.getClass().getClassLoader().getResource(libTemplateFile) != null) {", "originalCommit": "636c4dd2d6681d67a11c5c374814034257ef7771", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU3NTAzNQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6357#discussion_r450575035", "bodyText": "@DenisKnoepfle are you suggesting this based on code quality or based on an error you've experienced?\nThis method falls back to embedded templates in the last two conditions, which allows for Windows paths evaluation using exactly what you've mentioned above.\nThe methods as written here allow us to check for the embedded file in operating systems without windows style paths without incurring the performance overhead of doing that adjustment.\nMaybe this method's comment would be better to document it as this to avoid confusion?\n     * 1) (template dir)/libraries/(library) [Windows + *nix]\n     * 2) (embedded template dir)/libraries/(library) [*nix]\n     * 2) (template dir) [Windows + *nix]\n     * 3) (embedded template dir) [*nix]\n     * 4) (embedded template dir)/libraries/(library) [Windows only]\n     * 4) (embedded template dir) [Windows only]\n\nAnd since we use File.separator in buildLibraryFilePath, the file check works for both Windows and non-Windows separators consistently throughout.\nThe alternative that you suggest would require transforming via the regular expression in TemplateManager.getCPResourcePath for all operating systems, and we really shouldn't have to pay that price on non-Windows.", "author": "jimschubert", "createdAt": "2020-07-07T02:19:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1MTA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1OTEzMw==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6357#discussion_r481159133", "bodyText": "Sorry for the late response, I had been on holidays.\n@jimschubert I'm suggesting this based on an error I've experienced under Windows using the template path feature (resolve from classpath).\n\nAnd since we use File.separator in buildLibraryFilePath, the file check works for both Windows and non-Windows separators consistently throughout.\n\nThis is what's breaking it. You must not use backslashes ('\\') in a java classpath-path, it won't work, not even under Windows. Thus it must always be a forward slash ('/') when forming a classpath-path.\nIs it clear now how I meant it? Did you test it under Windows trying to find a resource on a classpath that was not in the root of a jar, e.g. some.jar/some/deep/folder/JavaSpring/pojo.mustache? In my case it always resorted to the embedded dir instead of using my custom mustache template.", "author": "DenisKnoepfle", "createdAt": "2020-09-01T13:59:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1MTA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE3NzI4Mg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6357#discussion_r499177282", "bodyText": "@DenisKnoepfle thanks for the detailed response. The issue was indeed that I was testing  only with a directory structure which mirrors the resources directory in our project. However, I was also testing under Git Bash which I assume is not using the same file separators. I've never done Java development under windows, so I'm not entirely sure how to attach a remote debugger to find out.\nIf you don't mind, I'd like to tag you in the PR I'll open if you're able to test.", "author": "jimschubert", "createdAt": "2020-10-03T19:57:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1MTA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODE4Njk3Mg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6357#discussion_r528186972", "bodyText": "Sorry, I couldn't test it sooner, but I confirmed that it's working properly now for me under Windows (v5.0.0-beta3). Thank you!", "author": "DenisKnoepfle", "createdAt": "2020-11-21T11:48:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1MTA1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1MTE1OA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6357#discussion_r449851158", "bodyText": "Same issue with '\\' in resource path under windows, see line 63.", "author": "DenisKnoepfle", "createdAt": "2020-07-05T08:38:57Z", "path": "modules/openapi-generator/src/main/java/org/openapitools/codegen/templating/GeneratorTemplateContentLocator.java", "diffHunk": "@@ -0,0 +1,91 @@\n+package org.openapitools.codegen.templating;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.openapitools.codegen.CodegenConfig;\n+import org.openapitools.codegen.TemplateManager;\n+import org.openapitools.codegen.api.TemplatePathLocator;\n+\n+import java.io.File;\n+\n+/**\n+ * Locates templates according to {@link CodegenConfig} settings.\n+ */\n+public class GeneratorTemplateContentLocator implements TemplatePathLocator {\n+    private final CodegenConfig codegenConfig;\n+\n+    /**\n+     * Constructs a new instance of {@link GeneratorTemplateContentLocator} for the provided {@link CodegenConfig}\n+     *\n+     * @param codegenConfig A generator's configuration used for determining template file location.\n+     */\n+    public GeneratorTemplateContentLocator(CodegenConfig codegenConfig) {\n+        this.codegenConfig = codegenConfig;\n+    }\n+\n+    private String buildLibraryFilePath(String dir, String library, String file) {\n+        return dir + File.separator + \"libraries\" + File.separator + library + File.separator + file;\n+    }\n+\n+    /**\n+     * Determines whether an embedded file with the specified name exists.\n+     *\n+     * @param name The name of the file (i.e. relative to resource root)\n+     *\n+     * @return true if file is an embedded resource, false if it does not exist\n+     */\n+    public boolean embeddedTemplateExists(String name) {\n+        return this.getClass().getClassLoader().getResource(TemplateManager.getCPResourcePath(name)) != null;\n+    }\n+\n+    /**\n+     * Get the template file path with template dir prepended, and use the library template if exists.\n+     *\n+     * Precedence:\n+     * 1) (template dir)/libraries/(library)\n+     * 2) (template dir)\n+     * 3) (embedded template dir)/libraries/(library)\n+     * 4) (embedded template dir)\n+     *\n+     * Where \"template dir\" may be user defined and \"embedded template dir\" are the built-in templates for the given generator.\n+     *\n+     * @param relativeTemplateFile Template file\n+     * @return String Full template file path\n+     */\n+    @Override\n+    public String getFullTemplatePath(String relativeTemplateFile) {\n+        CodegenConfig config = this.codegenConfig;\n+\n+        //check the supplied template library folder for the file\n+        final String library = config.getLibrary();\n+        if (StringUtils.isNotEmpty(library)) {\n+            //look for the file in the library subfolder of the supplied template\n+            final String libTemplateFile = buildLibraryFilePath(config.templateDir(), library, relativeTemplateFile);\n+            if (new File(libTemplateFile).exists() || this.getClass().getClassLoader().getResource(libTemplateFile) != null) {\n+                return libTemplateFile;\n+            }\n+        }\n+\n+        //check the supplied template main folder for the file\n+        final String template = config.templateDir() + File.separator + relativeTemplateFile;\n+        if (new File(template).exists() || this.getClass().getClassLoader().getResource(template) != null) {", "originalCommit": "636c4dd2d6681d67a11c5c374814034257ef7771", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}