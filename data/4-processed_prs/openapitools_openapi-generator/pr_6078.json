{"pr_number": 6078, "pr_title": "[php-symfony] Fix problem with clients, that put charset in content type header.", "pr_createdAt": "2020-04-27T15:12:53Z", "pr_url": "https://github.com/OpenAPITools/openapi-generator/pull/6078", "timeline": [{"oid": "fddfbbcf1dd37d572be8291c2a93942dcdc27712", "url": "https://github.com/OpenAPITools/openapi-generator/commit/fddfbbcf1dd37d572be8291c2a93942dcdc27712", "message": "Fix problem with clients, that put charset in content type header.\n\nWith this fix header \"Content-Type: application/json; charset=utf-8\" working same as \"Content-Type: application/json\" for parse input data", "committedDate": "2020-04-27T15:10:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2NDEwOA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6078#discussion_r416264108", "bodyText": "Please fix coding style at least in your changes(line 65 and 494).\n$  ./vendor/bin/phpcs --standard=PSR2 -n -s ./Controller/PetController.php\n\nFILE: ...store/php-symfony/SymfonyBundle-php/Controller/PetController.php\n----------------------------------------------------------------------\nFOUND 3 ERRORS AFFECTING 3 LINES\n----------------------------------------------------------------------\n  19 | ERROR | [x] Whitespace found at end of line\n     |       |     (Squiz.WhiteSpace.SuperfluousWhitespace.EndLine)\n  65 | ERROR | [x] No space found after comma in function call\n     |       |     (Generic.Functions.FunctionCallArgumentSpacing.NoSpaceAfterComma)\n 494 | ERROR | [x] No space found after comma in function call\n     |       |     (Generic.Functions.FunctionCallArgumentSpacing.NoSpaceAfterComma)\n----------------------------------------------------------------------\nPHPCBF CAN FIX THE 3 MARKED SNIFF VIOLATIONS AUTOMATICALLY\n----------------------------------------------------------------------", "author": "ybelenko", "createdAt": "2020-04-28T01:37:34Z", "path": "samples/server/petstore/php-symfony/SymfonyBundle-php/Controller/PetController.php", "diffHunk": "@@ -62,7 +62,7 @@ public function addPetAction(Request $request)\n     {\n         // Make sure that the client is providing something that we can consume\n         $consumes = ['application/json', 'application/xml'];\n-        $inputFormat = $request->headers->has('Content-Type')?$request->headers->get('Content-Type'):$consumes[0];\n+        $inputFormat = $request->headers->has('Content-Type')?explode(\";\",$request->headers->get('Content-Type'))[0]:$consumes[0];", "originalCommit": "fddfbbcf1dd37d572be8291c2a93942dcdc27712", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ1MDA4Mw==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6078#discussion_r416450083", "bodyText": "Fix code style, add spaces, as PSR recommends. I`m write previous version of code in style, that already used in this file, think that was more appreciated :)", "author": "reznikartem", "createdAt": "2020-04-28T09:01:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2NDEwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2NTAwOA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6078#discussion_r416265008", "bodyText": "$  ./vendor/bin/phpcs --standard=PSR2 -n -s ./Controller/StoreController.php\n\nFILE: ...ore/php-symfony/SymfonyBundle-php/Controller/StoreController.php\n----------------------------------------------------------------------\nFOUND 2 ERRORS AFFECTING 2 LINES\n----------------------------------------------------------------------\n  19 | ERROR | [x] Whitespace found at end of line\n     |       |     (Squiz.WhiteSpace.SuperfluousWhitespace.EndLine)\n 287 | ERROR | [x] No space found after comma in function call\n     |       |     (Generic.Functions.FunctionCallArgumentSpacing.NoSpaceAfterComma)\n----------------------------------------------------------------------\nPHPCBF CAN FIX THE 2 MARKED SNIFF VIOLATIONS AUTOMATICALLY\n----------------------------------------------------------------------", "author": "ybelenko", "createdAt": "2020-04-28T01:40:31Z", "path": "samples/server/petstore/php-symfony/SymfonyBundle-php/Controller/StoreController.php", "diffHunk": "@@ -284,7 +284,7 @@ public function placeOrderAction(Request $request)\n     {\n         // Make sure that the client is providing something that we can consume\n         $consumes = [];\n-        $inputFormat = $request->headers->has('Content-Type')?$request->headers->get('Content-Type'):$consumes[0];\n+        $inputFormat = $request->headers->has('Content-Type')?explode(\";\",$request->headers->get('Content-Type'))[0]:$consumes[0];", "originalCommit": "fddfbbcf1dd37d572be8291c2a93942dcdc27712", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2NTM1OA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6078#discussion_r416265358", "bodyText": "$consumes = [];\n$inputFormat = $request->headers->has('Content-Type')?$request->headers->get('Content-Type'):$consumes[0];\n// request without Content-Type returns $consumes[0] which doesn't exist\n// so I think it throws unexpected index error\nBut it was there before you, so you don't have to fix it. Just an observation.\nAnd PHPCodeSniffer errors:\n$  ./vendor/bin/phpcs --standard=PSR2 -n -s ./Controller/UserController.php\n\nFILE: ...tore/php-symfony/SymfonyBundle-php/Controller/UserController.php\n----------------------------------------------------------------------\nFOUND 5 ERRORS AFFECTING 5 LINES\n----------------------------------------------------------------------\n  19 | ERROR | [x] Whitespace found at end of line\n     |       |     (Squiz.WhiteSpace.SuperfluousWhitespace.EndLine)\n  64 | ERROR | [x] No space found after comma in function call\n     |       |     (Generic.Functions.FunctionCallArgumentSpacing.NoSpaceAfterComma)\n 141 | ERROR | [x] No space found after comma in function call\n     |       |     (Generic.Functions.FunctionCallArgumentSpacing.NoSpaceAfterComma)\n 220 | ERROR | [x] No space found after comma in function call\n     |       |     (Generic.Functions.FunctionCallArgumentSpacing.NoSpaceAfterComma)\n 595 | ERROR | [x] No space found after comma in function call\n     |       |     (Generic.Functions.FunctionCallArgumentSpacing.NoSpaceAfterComma)\n----------------------------------------------------------------------\nPHPCBF CAN FIX THE 5 MARKED SNIFF VIOLATIONS AUTOMATICALLY\n----------------------------------------------------------------------", "author": "ybelenko", "createdAt": "2020-04-28T01:41:26Z", "path": "samples/server/petstore/php-symfony/SymfonyBundle-php/Controller/UserController.php", "diffHunk": "@@ -61,7 +61,7 @@ public function createUserAction(Request $request)\n     {\n         // Make sure that the client is providing something that we can consume\n         $consumes = [];\n-        $inputFormat = $request->headers->has('Content-Type')?$request->headers->get('Content-Type'):$consumes[0];\n+        $inputFormat = $request->headers->has('Content-Type')?explode(\";\",$request->headers->get('Content-Type'))[0]:$consumes[0];", "originalCommit": "fddfbbcf1dd37d572be8291c2a93942dcdc27712", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ1MDcwMg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6078#discussion_r416450702", "bodyText": "I`m add check for $consumes length", "author": "reznikartem", "createdAt": "2020-04-28T09:02:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2NTM1OA=="}], "type": "inlineReview"}, {"oid": "58c4d251f2b228d62cc0ab919ec68bbdfd54b09d", "url": "https://github.com/OpenAPITools/openapi-generator/commit/58c4d251f2b228d62cc0ab919ec68bbdfd54b09d", "message": "Fix code style, add $consumes length check.", "committedDate": "2020-04-28T08:59:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgzOTYwNg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6078#discussion_r416839606", "bodyText": "Well, PR is ready to be merged now. But I would suggest to put your changes into base Controller/Controller.php class method and cover it with unit tests to avoid this bug in future. Public method(maybe static) like:\npublic static function isContentTypeAllowed(Request $request, array $consumes = []): bool;\nOf course you can stay with your changes, it's just a suggestion.", "author": "ybelenko", "createdAt": "2020-04-28T18:40:53Z", "path": "modules/openapi-generator/src/main/resources/php-symfony/api_controller.mustache", "diffHunk": "@@ -60,10 +60,16 @@ class {{controllerName}} extends Controller\n         {{#bodyParams}}\n         // Make sure that the client is providing something that we can consume\n         $consumes = [{{#consumes}}'{{{mediaType}}}'{{#hasMore}}, {{/hasMore}}{{/consumes}}];\n-        $inputFormat = $request->headers->has('Content-Type')?$request->headers->get('Content-Type'):$consumes[0];\n-        if (!in_array($inputFormat, $consumes)) {\n-            // We can't consume the content that the client is sending us\n-            return new Response('', 415);\n+        if (sizeof($consumes) > 0) {", "originalCommit": "58c4d251f2b228d62cc0ab919ec68bbdfd54b09d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg5MTIwMg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/6078#discussion_r416891202", "bodyText": "This is a shame, but I'm not sure that I can correctly cover the code with a unit test :( There is no experience with this yet.", "author": "reznikartem", "createdAt": "2020-04-28T20:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgzOTYwNg=="}], "type": "inlineReview"}, {"oid": "fa582b3aae799307259d429fd939336bd97f1c3d", "url": "https://github.com/OpenAPITools/openapi-generator/commit/fa582b3aae799307259d429fd939336bd97f1c3d", "message": "Add isContentTypeAllowed static method and tests", "committedDate": "2020-04-29T15:21:40Z", "type": "commit"}, {"oid": "11a192c075057a3d895e9d570766862bc796df9c", "url": "https://github.com/OpenAPITools/openapi-generator/commit/11a192c075057a3d895e9d570766862bc796df9c", "message": "Fix old tests\n\nRight now serializer doesn't support anything beside json and xml.\nCall tests with application/json instead of form data.", "committedDate": "2020-04-29T15:23:43Z", "type": "commit"}, {"oid": "f17162101ff5626e2ea373247f1f3e27c7535186", "url": "https://github.com/OpenAPITools/openapi-generator/commit/f17162101ff5626e2ea373247f1f3e27c7535186", "message": "Refresh samples", "committedDate": "2020-04-29T15:24:43Z", "type": "commit"}]}