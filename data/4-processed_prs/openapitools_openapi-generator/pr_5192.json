{"pr_number": 5192, "pr_title": "[core] Normalizing vendor extension naming", "pr_createdAt": "2020-02-02T20:05:25Z", "pr_url": "https://github.com/OpenAPITools/openapi-generator/pull/5192", "timeline": [{"oid": "7355379f16ba955f5db9444917994964105f1a1e", "url": "https://github.com/OpenAPITools/openapi-generator/commit/7355379f16ba955f5db9444917994964105f1a1e", "message": "[core] Normalizing vendor extension naming\n\nAccording to [OAS 2.0][1] and [OAS 3.0][2] Specifications:\n\n> Allows extensions to the OpenAPI Schema. The field name MUST begin with x-,\n>  for example, x-internal-id. The value can be null, a primitive, an array or an object.\n>  Can have any valid JSON format value.\n\nThis commit attempts to define a [clear identifier design format][3] of\nmaintaining lower-kebab casing and following the x- prefix defined by\nOAI Specification.\n\nFollowing a convention that matches that used by others (see [autorest][4]), we will remove\nany confusion about naming strategies for template authors and\ncustomizers. Following the lower-kebab convention will allow us to\nconvert from camelCase and missing prefixes to the desired format. For\nexample, these conversions are simple to make for template consistency:\n\n* customValue => x-custom-value\n* x-customValue => x-custom-value\n* x-custom-value => x-custom-value\n\nThis convention also allows us to define a single standard for use\nacross all generators. This means no occurrence of x-operationId in one\ngenerator and x-operation-id in another.\n\n[1]: https://github.com/OAI/OpenAPI-Specification/blob/master/versions/2.0.md#patterned-objects\n[2]: https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.2.md#specificationExtensions\n[3]: https://tools.ietf.org/html/draft-wilde-registries-01#section-3.4\n[4]: https://github.com/Azure/autorest/tree/master/docs/extensions", "committedDate": "2020-02-02T19:22:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg3MzkyMg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5192#discussion_r373873922", "bodyText": "maybe a single operation if you want to avoid races?\nmessageCountCache.asMap().merge(msg, 1, count -> count + 1)\nor an atomic counter if you want to avoid locking except on the initial mapping?", "author": "ben-manes", "createdAt": "2020-02-02T20:49:07Z", "path": "modules/openapi-generator/src/main/java/org/openapitools/codegen/utils/OnceLogger.java", "diffHunk": "@@ -0,0 +1,162 @@\n+package org.openapitools.codegen.utils;\n+\n+import com.github.benmanes.caffeine.cache.Cache;\n+import com.github.benmanes.caffeine.cache.Caffeine;\n+import org.openapitools.codegen.config.GlobalSettings;\n+import org.slf4j.Logger;\n+import org.slf4j.Marker;\n+import org.slf4j.MarkerFactory;\n+import org.slf4j.ext.LoggerWrapper;\n+\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Provides calling code a way to log important messages only once, regardless of how many times the invocation has occurred.\n+ * This can be used, for instance, to log a warning like \"One or more schemas aren't declared\" without logging that message\n+ * for every time the schema is mentioned in a document.\n+ *\n+ * This implementation currently only supports single-argument string literal log methods (e.g. {@link Logger#debug(String)}).\n+ */\n+@SuppressWarnings(\"FieldCanBeLocal\")\n+public class OnceLogger extends LoggerWrapper {\n+    /**\n+     * Allow advanced users to modify cache size of the OnceLogger (more for performance tuning in hosted environments)\n+     */\n+    private static final String CACHE_SIZE_PROPERTY = \"org.openapitools.codegen.utils.oncelogger.cachesize\";\n+\n+    /**\n+     * Allow advanced users to disable the OnceLogger (more for performance tuning in hosted environments).\n+     * This is really only useful or necessary if this implementation causes issues.\n+     */\n+    private static final String ENABLE_ONCE_LOGGER_PROPERTY = \"org.openapitools.codegen.utils.oncelogger.enabled\";\n+\n+    /**\n+     * Allow advanced users to modify cache expiration of the OnceLogger (more for performance tuning in hosted environments)\n+     */\n+    private static final String EXPIRY_PROPERTY = \"org.openapitools.codegen.utils.oncelogger.expiry\";\n+\n+    /**\n+     * The fully qualified class name of the <b>logger instance</b>,\n+     * typically the logger class, logger bridge or a logger wrapper.\n+     */\n+    private static final String FQCN = OnceLogger.class.getName();\n+\n+    /**\n+     * Gets the marker instance. This can be used by supported log implementations to filter/manage logs coming from\n+     * this implementation differently than others (i.e. make them stand out since they're to be logged once).\n+     */\n+    private static final Marker MARKER = MarkerFactory.getMarker(\"ONCE\");\n+\n+    /**\n+     * The allowed size of the cache.\n+     */\n+    private static int maxCacheSize = Integer.parseInt(GlobalSettings.getProperty(CACHE_SIZE_PROPERTY, \"200\"));\n+\n+    /**\n+     * The millis to expire a cached log message.\n+     */\n+    private static int expireMillis = Integer.parseInt(GlobalSettings.getProperty(EXPIRY_PROPERTY, \"2000\"));\n+\n+    /**\n+     * The number of allowed repetitions.\n+     */\n+    private static int maxRepetitions = 1;\n+\n+    /**\n+     * Internal message cache for logger decorated with the onceler.\n+     */\n+    private static Cache<String, Integer> messageCountCache;\n+\n+    OnceLogger(Logger logger) {\n+        this(logger, FQCN);\n+    }\n+\n+    OnceLogger(Logger logger, String fqcn) {\n+        super(logger, fqcn);\n+    }\n+\n+    static {\n+        messageCountCache = Caffeine.newBuilder()\n+                .maximumSize(maxCacheSize)\n+                .expireAfterWrite(expireMillis, TimeUnit.MILLISECONDS)\n+                .build();\n+    }\n+\n+    public static Logger once(Logger logger) {\n+        try {\n+            if (Boolean.parseBoolean(GlobalSettings.getProperty(ENABLE_ONCE_LOGGER_PROPERTY, \"true\"))) {\n+                return new OnceLogger(logger);\n+            }\n+        } catch (Exception ex) {\n+            logger.warn(\"Unable to wrap logger instance in OnceLogger. Falling back to non-decorated implementation, which may be noisy.\");\n+        }\n+        return logger;\n+    }\n+\n+    /**\n+     * Delegate to the appropriate method of the underlying logger.\n+     *\n+     * @param msg\n+     */\n+    @Override\n+    public void trace(String msg) {\n+        if (!isTraceEnabled() || !isTraceEnabled(MARKER)) return;\n+\n+        if (shouldLog(msg)) super.trace(MARKER, msg);\n+    }\n+\n+    private boolean shouldLog(final String msg) {", "originalCommit": "7355379f16ba955f5db9444917994964105f1a1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkwNTczNg==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5192#discussion_r373905736", "bodyText": "Thanks for the quick and helpful review, Ben! I decided to go the AtomicInteger route because it's not critical functionality for this method and doesn't need repeated locking, I'm just trying to remove noise for users.", "author": "jimschubert", "createdAt": "2020-02-03T02:58:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg3MzkyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkxNTQ1MQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5192#discussion_r373915451", "bodyText": "I think that's best choice, too!\nHowever, it no longer writes into the map on every shouldLog call, causing the expireAfterWrite to evict based on the entry's creation time (as no updates). The old behavior was to reset the expiration each time the method was called, so it requires no occurrences for the expiration duration in order to evict. That could be done now using expireAfterAccess to reset on every read or write, which is fine as this is the sole usage.\nI suspect you don't want to suppress an ongoing error for good once the threshold is reached, as that makes it appear to be over, and simply want to debounce over a time interval. This new expiration behavior might be more correct, but I'm unsure. You probably want to think a bit about exactly what expiration behavior you want and maybe write a quick test to verify that.", "author": "ben-manes", "createdAt": "2020-02-03T04:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg3MzkyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3Njk0OQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5192#discussion_r374276949", "bodyText": "You're correct that my intent was to debounce over a time internal. I think I mistakenly took expireAfterWrite to mean initial writes only, but looking at it after your comment I see that understanding wouldn't have made sense if I'd looked at the method a little more closely.\nI'll definitely need to add a comment about intention on the cache member, and write a handful of tests. I'll have to think about usage for errors and other levels a little more. The way I wrote this, it'll require that someone explicitly decorates a Logger instance and I may just throw an error if it's used to log error messages, or just skip the cache evaluation for that method.", "author": "jimschubert", "createdAt": "2020-02-03T18:51:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg3MzkyMg=="}], "type": "inlineReview"}, {"oid": "b2b9866ff338b6e6e0261ba9874ee26c6d5033fa", "url": "https://github.com/OpenAPITools/openapi-generator/commit/b2b9866ff338b6e6e0261ba9874ee26c6d5033fa", "message": "Incorporate feedback to avoid race/blocking in OnceLogger", "committedDate": "2020-02-03T02:30:55Z", "type": "commit"}, {"oid": "6ebfe9459faac15a3014f1ea28e5818b81101681", "url": "https://github.com/OpenAPITools/openapi-generator/commit/6ebfe9459faac15a3014f1ea28e5818b81101681", "message": "Merge branch 'master' into normalizing-vendor-extensions\n\n* master:\n  [cli] Optional colorized outputs (#5193)\n  [bug] fix null pointer exception while evaluating recommend\u2026 (#5191)\n  [csharp-netcore] Improved `Multimap` and `ClientUtils` implementation (#5122)", "committedDate": "2020-02-03T02:31:11Z", "type": "commit"}, {"oid": "ee2208559ad5f8f6c4933de862182ad138fb7539", "url": "https://github.com/OpenAPITools/openapi-generator/commit/ee2208559ad5f8f6c4933de862182ad138fb7539", "message": "Remove unnecessary additional log config", "committedDate": "2020-02-03T02:51:48Z", "type": "commit"}, {"oid": "0343106b15f57731681f166a0c0fa2e8a4c3b0d1", "url": "https://github.com/OpenAPITools/openapi-generator/commit/0343106b15f57731681f166a0c0fa2e8a4c3b0d1", "message": "Add tests,comments for OnceLogger", "committedDate": "2020-02-04T02:27:03Z", "type": "commit"}, {"oid": "cecbb832109179da87905673233908c6b3435952", "url": "https://github.com/OpenAPITools/openapi-generator/commit/cecbb832109179da87905673233908c6b3435952", "message": "Test caffeine cache with FakeTicker", "committedDate": "2020-02-05T02:22:10Z", "type": "commit"}]}