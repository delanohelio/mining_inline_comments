{"pr_number": 5290, "pr_title": "[codegen][validation] Add support for 'null' type", "pr_createdAt": "2020-02-11T16:46:55Z", "pr_url": "https://github.com/OpenAPITools/openapi-generator/pull/5290", "timeline": [{"oid": "eb3114488223420a1c1c23271142485e6dee3ec0", "url": "https://github.com/OpenAPITools/openapi-generator/commit/eb3114488223420a1c1c23271142485e6dee3ec0", "message": "initial commit for null type", "committedDate": "2020-02-01T16:07:25Z", "type": "commit"}, {"oid": "56da6220fd72b6717a776ab8ad7f7b7712d4e798", "url": "https://github.com/OpenAPITools/openapi-generator/commit/56da6220fd72b6717a776ab8ad7f7b7712d4e798", "message": "handle scenario when one element in composed schema is 'null' type", "committedDate": "2020-02-01T22:12:04Z", "type": "commit"}, {"oid": "00718d4606d808a47f96aa649a3a0bd919ba68b9", "url": "https://github.com/OpenAPITools/openapi-generator/commit/00718d4606d808a47f96aa649a3a0bd919ba68b9", "message": "support 'null' type", "committedDate": "2020-02-01T22:36:14Z", "type": "commit"}, {"oid": "8ff92365fba385337193f07816632ce66fddfdc1", "url": "https://github.com/OpenAPITools/openapi-generator/commit/8ff92365fba385337193f07816632ce66fddfdc1", "message": "fix null pointer exception while evaluating recommendations", "committedDate": "2020-02-02T17:19:05Z", "type": "commit"}, {"oid": "7cbcba0af0874fb84cdb95f5dd5b75b74db53536", "url": "https://github.com/OpenAPITools/openapi-generator/commit/7cbcba0af0874fb84cdb95f5dd5b75b74db53536", "message": "Merge branch 'parameter-npe' into null-type", "committedDate": "2020-02-02T17:27:45Z", "type": "commit"}, {"oid": "30111a53bb74a0e3953730482b882280a8d417ca", "url": "https://github.com/OpenAPITools/openapi-generator/commit/30111a53bb74a0e3953730482b882280a8d417ca", "message": "add validation for null type and type array", "committedDate": "2020-02-02T18:14:35Z", "type": "commit"}, {"oid": "68bbe2d7ebcea8143de683ce75ca8c8a0118e61a", "url": "https://github.com/OpenAPITools/openapi-generator/commit/68bbe2d7ebcea8143de683ce75ca8c8a0118e61a", "message": "add validation for null type and type array", "committedDate": "2020-02-02T18:15:07Z", "type": "commit"}, {"oid": "ed143755f7358fffdb50767694ed65d705f2ffb0", "url": "https://github.com/OpenAPITools/openapi-generator/commit/ed143755f7358fffdb50767694ed65d705f2ffb0", "message": "Merge remote-tracking branch 'origin' into null-type", "committedDate": "2020-02-04T16:15:26Z", "type": "commit"}, {"oid": "20590358b70f8501abcffe50a799d965ec724aa8", "url": "https://github.com/OpenAPITools/openapi-generator/commit/20590358b70f8501abcffe50a799d965ec724aa8", "message": "Add openAPI attribute to validation and recommendation", "committedDate": "2020-02-05T17:56:28Z", "type": "commit"}, {"oid": "ca257f4d6d71f6b6a3efbe85d1c1a5e93541bc97", "url": "https://github.com/OpenAPITools/openapi-generator/commit/ca257f4d6d71f6b6a3efbe85d1c1a5e93541bc97", "message": "add OpenAPI attribute to validation", "committedDate": "2020-02-05T18:03:20Z", "type": "commit"}, {"oid": "bb911043b38772a5938a809412a82ac79411a64f", "url": "https://github.com/OpenAPITools/openapi-generator/commit/bb911043b38772a5938a809412a82ac79411a64f", "message": "add validation for nullable and null", "committedDate": "2020-02-05T18:33:06Z", "type": "commit"}, {"oid": "57f4a0e89e8b0a1b8b9c9eb28c4095708cc3d3a2", "url": "https://github.com/OpenAPITools/openapi-generator/commit/57f4a0e89e8b0a1b8b9c9eb28c4095708cc3d3a2", "message": "add validation for nullable and null", "committedDate": "2020-02-05T18:38:54Z", "type": "commit"}, {"oid": "36b8d629ac042d3c398a8ea44d4dc6f58ec82863", "url": "https://github.com/OpenAPITools/openapi-generator/commit/36b8d629ac042d3c398a8ea44d4dc6f58ec82863", "message": "revert log statement modification", "committedDate": "2020-02-05T18:52:48Z", "type": "commit"}, {"oid": "71363d58d1a4f4f95b88e8684afa983df41ffc0a", "url": "https://github.com/OpenAPITools/openapi-generator/commit/71363d58d1a4f4f95b88e8684afa983df41ffc0a", "message": "support null type", "committedDate": "2020-02-06T06:04:19Z", "type": "commit"}, {"oid": "660e4dc2b58176be60709b781c500e24416c4875", "url": "https://github.com/OpenAPITools/openapi-generator/commit/660e4dc2b58176be60709b781c500e24416c4875", "message": "support null type", "committedDate": "2020-02-06T06:06:25Z", "type": "commit"}, {"oid": "0f140cc70fed19ab5285aed4bbd39a62b10f3e82", "url": "https://github.com/OpenAPITools/openapi-generator/commit/0f140cc70fed19ab5285aed4bbd39a62b10f3e82", "message": "improve code comments", "committedDate": "2020-02-06T06:27:42Z", "type": "commit"}, {"oid": "8ba134de6710757805514fa0154cbd3f5953469f", "url": "https://github.com/OpenAPITools/openapi-generator/commit/8ba134de6710757805514fa0154cbd3f5953469f", "message": "improve code comments. the warning used to notify the users to use  instead of defining the schema inline, but now the InlineModelResolver has been enhanced", "committedDate": "2020-02-06T15:27:57Z", "type": "commit"}, {"oid": "23c8bccdab102cfdb4ba5b76390ffde2b9702b37", "url": "https://github.com/OpenAPITools/openapi-generator/commit/23c8bccdab102cfdb4ba5b76390ffde2b9702b37", "message": "add code comments", "committedDate": "2020-02-06T15:45:14Z", "type": "commit"}, {"oid": "ae76186133ff4023bf23980e9c7eea6c6778d47f", "url": "https://github.com/OpenAPITools/openapi-generator/commit/ae76186133ff4023bf23980e9c7eea6c6778d47f", "message": "code formatting", "committedDate": "2020-02-06T15:46:26Z", "type": "commit"}, {"oid": "3e52b6f9fef2a82143188e39283cecc97f2ec679", "url": "https://github.com/OpenAPITools/openapi-generator/commit/3e52b6f9fef2a82143188e39283cecc97f2ec679", "message": "add code comments, refactor method", "committedDate": "2020-02-06T17:50:50Z", "type": "commit"}, {"oid": "e18ddc3f95c1b07e1cf40dd567ca7e3436387b8c", "url": "https://github.com/OpenAPITools/openapi-generator/commit/e18ddc3f95c1b07e1cf40dd567ca7e3436387b8c", "message": "Merge remote-tracking branch 'origin' into null-type", "committedDate": "2020-02-06T17:54:51Z", "type": "commit"}, {"oid": "3b61fb94e123b5530f000434e8f1c5c484f78b60", "url": "https://github.com/OpenAPITools/openapi-generator/commit/3b61fb94e123b5530f000434e8f1c5c484f78b60", "message": "fix call to isNullable to handle  and 'null' type", "committedDate": "2020-02-07T16:01:16Z", "type": "commit"}, {"oid": "68ad45de926ada493a4d4d1077bb191cbd99c6c5", "url": "https://github.com/OpenAPITools/openapi-generator/commit/68ad45de926ada493a4d4d1077bb191cbd99c6c5", "message": "add OAS document for test purpose", "committedDate": "2020-02-09T16:58:26Z", "type": "commit"}, {"oid": "4d6e09d6a021361eeefb567ea4cd3e5a188f0278", "url": "https://github.com/OpenAPITools/openapi-generator/commit/4d6e09d6a021361eeefb567ea4cd3e5a188f0278", "message": "add unit tests for null type", "committedDate": "2020-02-10T05:13:29Z", "type": "commit"}, {"oid": "364d3552aa8b7dab6f9f497f902b1a422db643c7", "url": "https://github.com/OpenAPITools/openapi-generator/commit/364d3552aa8b7dab6f9f497f902b1a422db643c7", "message": "add 'null' type validation", "committedDate": "2020-02-11T16:27:27Z", "type": "commit"}, {"oid": "a9d212d97897697b977a310a002809fa3ceb01ed", "url": "https://github.com/OpenAPITools/openapi-generator/commit/a9d212d97897697b977a310a002809fa3ceb01ed", "message": "sync from master", "committedDate": "2020-02-11T16:45:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc2MTAwOQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5290#discussion_r377761009", "bodyText": "Note to reviewer: this was discussed with @wing328:\nIf I remember correctly, that refers to InlineModelResolver (https://github.com/OpenAPITools/openapi-generator/blob/master/modules/openapi-generator/src/main/java/org/openapitools/codegen/InlineModelResolver.java) not supporting allOf  so the warning notifies the users to use $ref instead of defining the schema inline in allOf . We should have improved the InlineModelResolver to better handle inline schema allOf so I think it's ok to remove the warning.", "author": "sebastien-rosset", "createdAt": "2020-02-11T16:48:21Z", "path": "modules/openapi-generator/src/main/java/org/openapitools/codegen/DefaultCodegen.java", "diffHunk": "@@ -1758,8 +1758,7 @@ public String toAllOfName(List<String> names, ComposedSchema composedSchema) {\n         } else if (names.size() == 1) {\n             return names.get(0);\n         } else {\n-            LOGGER.warn(\"allOf with multiple schemas defined. Using only the first one: {}. \" +\n-                \"To fully utilize allOf, please use $ref instead of inline schema definition\", names.get(0));\n+            LOGGER.warn(\"allOf with multiple schemas defined. Using only the first one: {}\", names.get(0));", "originalCommit": "a9d212d97897697b977a310a002809fa3ceb01ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA0MTMzMA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5290#discussion_r378041330", "bodyText": "I'm not aware of the discussion, but I don't know if it's related to InlineModelResolver. This method is only called from here: \n  \n    \n      openapi-generator/modules/openapi-generator/src/main/java/org/openapitools/codegen/DefaultCodegen.java\n    \n    \n         Line 1725\n      in\n      0693a83\n    \n    \n    \n    \n\n        \n          \n           return toAllOfName(names, cs); \n        \n    \n  \n\n\ngetSchemaType will call ModelUtils.getInterfaces on a composed schema, then iterate all the schemas and get the first defined schema as the \"type\" of the composed schema. I don't think that behavior is correct because it assumes or suggests that composed schemas have some concept of \"interfaces\".\nInlineModelResolver has other issues, in that it tries to do a best-guess of models defined inline and resolve them to Schemas defined at the top of the document. This goes against requirements in the spec which claim that inline models should not be considered for composed schemas. At a certain point, we have no information whether our model was initially inline.", "author": "jimschubert", "createdAt": "2020-02-12T04:59:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc2MTAwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM2MjMyNQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5290#discussion_r378362325", "bodyText": "There is also a non-obvious point: the 'allOf' name is constructed from the first element in the \"allOf\" list. If two separate authors want to model class inheritance, one OAS author may think it's better to put the \"parent\" class first, and another author may think it's better to put the \"parent\" last.", "author": "sebastien-rosset", "createdAt": "2020-02-12T16:24:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc2MTAwOQ=="}], "type": "inlineReview"}, {"oid": "e825bbce86fefc962995549c4ccf7941aedccb3b", "url": "https://github.com/OpenAPITools/openapi-generator/commit/e825bbce86fefc962995549c4ccf7941aedccb3b", "message": "fix javadoc issues", "committedDate": "2020-02-11T17:47:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAzNjc3NQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5290#discussion_r378036775", "bodyText": "Just a heads up that I don't think this is intended to always indicate polymorphism in the specification. An allOf ref with discriminator is always supposed to indicate polymporphism, but the opposite isn't clear. The case that you've defined here, and that I'm assuming was intended to match the refedWithoutDiscriminator.size() == 1 condition below is a \"legacy\" implementation from when we'd began implementing allOf support but it wasn't fully supported by the generator.\nDetails:\n\ndiscriminator document starts with \"Adds support for polymorphism.\"\nComposition and Inheritance (Polymorphism) states: \"To support polymorphism, the OpenAPI Specification adds the discriminator field. When used, the discriminator will be the name of the property that decides which schema definition validates the structure of the model.\"\n\nIt doesn't explain this well enough, but from these two it seems like they're defining subtype polymorphism since other types of polymorphism are either irrelevant or don't make much sense in this usage.\nMore discussion (we could turn it into an issue as well):\nThere are additional details of OpenAPI Spec which aren't explained very well with allOf. For example, the discriminator for allOf can be in the $ref schema and not in the schema containing the allOf definition. In this case, the discriminator will use the schema name of the schema with the allOf and $ref. Example:\nPet:\n  \u2026\n  discriminator:\n    propertyName: type\n  properties:\n    name: type\n    type: String\nCat:\n  allOf:\n    - $ref: #/components/schemas/Pet\n\nEven without the discriminator, I don't think the LOGGER.warn message is totally accurate. For example, the json-schema combining doc shows this example:\n{\n  \"definitions\": {\n    \"address\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"street_address\": { \"type\": \"string\" },\n        \"city\":           { \"type\": \"string\" },\n        \"state\":          { \"type\": \"string\" }\n      },\n      \"required\": [\"street_address\", \"city\", \"state\"]\n    }\n  },\n\n  \"allOf\": [\n    { \"$ref\": \"#/definitions/address\" },\n    { \"properties\": {\n        \"type\": { \"enum\": [ \"residential\", \"business\" ] }\n      }\n    }\n  ]\n}\n\nUnfortunately, this doesn't define whether a codegen should model:\nAddress:\n  + StreetAddress: String\n  + City: String\n  + State: String\n\nTypedAddress <Address>:\n    Enum: [ Residential, Business ]\n\nor:\nAddress:\n  + StreetAddress: String\n  + City: String\n  + State: String\n    Enum: [ Residential, Business ]\n\nIn this issue, there's no clarification: OAI/OpenAPI-Specification#1467\nIn fact, if you consider from a REST input modeling perspective, it might make sense that all allOf without discriminator are unique types with properties of the $ref.\nI wonder if it may make sense for us to support a vendor extension as a hint whether the user wants to use composition or inheritance for these one-off allOf without a discriminator. Something like:\n\nx-codegen-prefer-polymorphism: true. When no discriminator is defined, we'll try to create a parent and child relationship if the target language/generator supports it\nx-codegen-prefer-polymorphism: false. When no discriminator is defined, we'll merge all properties into one \"super\" class.\n\nThe latter might be challenging to support the spec requirement that these are validated independently like in the case where two refs have the same property with different validation characteristics. This isn't a case we handle now.", "author": "jimschubert", "createdAt": "2020-02-12T04:35:27Z", "path": "modules/openapi-generator/src/main/java/org/openapitools/codegen/utils/ModelUtils.java", "diffHunk": "@@ -988,19 +1029,34 @@ public static String getParentName(ComposedSchema composedSchema, Map<String, Sc\n                         return parentName;\n                     } else {\n                         // not a parent since discriminator.propertyName is not set\n+                        hasAmbiguousParents = true;\n                         refedWithoutDiscriminator.add(parentName);\n                     }\n                 } else {\n-                    // not a ref, doing nothing\n+                    // not a ref, doing nothing, except counting the number of times the 'null' type\n+                    // is listed as composed element.\n+                    if (ModelUtils.isNullType(schema)) {\n+                        // If there are two interfaces, and one of them is the 'null' type,\n+                        // then the parent is obvious and there is no need to warn about specifying\n+                        // a determinator.\n+                        nullSchemaChildrenCount++;\n+                    }\n                 }\n             }\n+            if (refedWithoutDiscriminator.size() == 1 && nullSchemaChildrenCount == 1) {", "originalCommit": "e825bbce86fefc962995549c4ccf7941aedccb3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA0NzQyOA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5290#discussion_r378047428", "bodyText": "Thank you for the quick feedback. Let me digest this and get back to you tomorrow.", "author": "sebastien-rosset", "createdAt": "2020-02-12T05:31:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAzNjc3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM2NzUyOQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5290#discussion_r378367529", "bodyText": "Unfortunately, this doesn't define whether a codegen should model:\nAddress:\n  + StreetAddress: String\n  + City: String\n  + State: String\n\nTypedAddress <Address>:\n    Enum: [ Residential, Business ]\n\nor:\nAddress:\n  + StreetAddress: String\n  + City: String\n  + State: String\n    Enum: [ Residential, Business ]\n\n\nAbove did you mean? 1) the generated code; 2) the serialization format of the JSON document; or 3) both? If (1), I agree it's not defined in the OAS spec, but OAS does not mandate how code generators should be implemented. If (2), isn't https://tools.ietf.org/html/draft-handrews-json-schema-02  section 9.2.1.1 mandating that it must be the second case?", "author": "sebastien-rosset", "createdAt": "2020-02-12T16:32:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAzNjc3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM3NDA2MA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5290#discussion_r378374060", "bodyText": "x-codegen-prefer-polymorphism: true. When no discriminator is defined, we'll try to create a parent and child relationship if the target language/generator supports it\nx-codegen-prefer-polymorphism: false. When no discriminator is defined, we'll merge all properties into one \"super\" class.\n\nThe latter might be challenging to support the spec requirement that these are validated independently like in the case where two refs have the same property with different validation characteristics. This isn't a case we handle now.\n\nI see there are related discussions about defined \"subclassOf\", but it does not seem to make much progress.\nI agree with all your points, they will have to be addressed in separate PRs. For example, I had an issue with inlined schema exactly as you mentioned, and I ended up doing a workaround by using a $ref.", "author": "sebastien-rosset", "createdAt": "2020-02-12T16:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAzNjc3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU3NTQwNA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5290#discussion_r378575404", "bodyText": "Oh. I wasn't suggesting any additional changes here. I just wanted to comment on the allOf change because of the ambiguity, and hoped it'd generate discussion. There's a lot to be done for allOf support, and I'm hoping we'll make great progress in the 5.0 release.\nRegarding your comment:\n\nIf (2), isn't https://tools.ietf.org/html/draft-handrews-json-schema-02 section 9.2.1.1 mandating that it must be the second case?\n\nThe issue is that JSON Schema focuses on validation only and not on structure. This is further complicated because OpenAPI Specification disassociates it's allOf from JSON Schema:\n\nallOf - Inline or referenced schema MUST be of a Schema Object and not a standard JSON Schema.\n\nI think the only sane way to support it cleanly is by having good defaults and vendor extensions to modify each model's behavior. We may also want to consider a configuration option at generation to define a \"global\" default.", "author": "jimschubert", "createdAt": "2020-02-12T23:38:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAzNjc3NQ=="}], "type": "inlineReview"}, {"oid": "023cd47d9ad7e0b460c34be46e2a5990264a80c9", "url": "https://github.com/OpenAPITools/openapi-generator/commit/023cd47d9ad7e0b460c34be46e2a5990264a80c9", "message": "Add validation rule for the supported values of the 'type' attribute", "committedDate": "2020-02-12T16:10:54Z", "type": "commit"}]}