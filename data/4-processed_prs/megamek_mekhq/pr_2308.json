{"pr_number": 2308, "pr_title": "Add EquipmentPart unit tests", "pr_createdAt": "2020-12-22T10:40:32Z", "pr_url": "https://github.com/MegaMek/mekhq/pull/2308", "timeline": [{"oid": "9f85cfbb13271bd37356b4e16394d66b179c320d", "url": "https://github.com/MegaMek/mekhq/commit/9f85cfbb13271bd37356b4e16394d66b179c320d", "message": "Cleanup checkWeaponBay and add it back to remove", "committedDate": "2020-12-22T10:41:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA0MTI1Ng==", "url": "https://github.com/MegaMek/mekhq/pull/2308#discussion_r548041256", "bodyText": "Not even going to ask why we're passing around string location names.", "author": "NickAragua", "createdAt": "2020-12-23T16:30:01Z", "path": "MekHQ/src/mekhq/campaign/parts/equipment/EquipmentPart.java", "diffHunk": "@@ -633,46 +633,24 @@ public boolean isOmniPoddable() {\n \n     @Override\n     public String getLocationName() {\n-        if (null != unit) {\n-            Mounted mounted = unit.getEntity().getEquipment(equipmentNum);\n-            if (null != mounted && mounted.getLocation() != -1) {\n-                return unit.getEntity().getLocationName(mounted.getLocation());\n-            }\n+        final Mounted mounted = getMounted();\n+        if ((mounted != null) && (mounted.getLocation() != Entity.LOC_NONE)) {\n+            return getUnit().getEntity().getLocationName(mounted.getLocation());\n         }\n+\n         return null;\n     }\n \n     @Override\n     public boolean isInLocation(String loc) {", "originalCommit": "a22d75bcad9e385ffde189c6c46769a06048f245", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA1ODIwNg==", "url": "https://github.com/MegaMek/mekhq/pull/2308#discussion_r548058206", "bodyText": "I tried my absolute damnedest to touch the least external code possible.\nMy last attempts at comprehensive tests seemed to have missed corner cases here and there. This time I have a much higher confidence level because I left the smelly code smelly.", "author": "sixlettervariables", "createdAt": "2020-12-23T17:09:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA0MTI1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA1NjA4MQ==", "url": "https://github.com/MegaMek/mekhq/pull/2308#discussion_r548056081", "bodyText": "Do we want to un-set the unit afterwards?", "author": "NickAragua", "createdAt": "2020-12-23T17:04:41Z", "path": "MekHQ/src/mekhq/campaign/parts/equipment/MissingEquipmentPart.java", "diffHunk": "@@ -178,149 +188,118 @@ public boolean isAcceptableReplacement(Part part, boolean refit) {\n         //they are not acceptable substitutes, so we need to check for that as\n         //well\n         //http://bg.battletech.com/forums/strategic-operations/(answered)-can-a-lance-for-a-35-ton-mech-be-used-on-a-40-ton-mech-and-so-on/\n-        Part newPart = getNewPart();\n-        newPart.setUnit(unit);\n-        if(part instanceof EquipmentPart) {\n-            EquipmentPart eqpart = (EquipmentPart)part;\n-            EquipmentType et = eqpart.getType();\n-            return (type.equals(et) && getTonnage() == part.getTonnage())\n-                    && (size == eqpart.getSize())\n-                    && part.getStickerPrice().equals(newPart.getStickerPrice());\n+        EquipmentPart newPart = getNewPart();\n+        newPart.setEquipmentNum(getEquipmentNum());\n+        newPart.setUnit(unit); // CAW: find a way to do this without setting a unit", "originalCommit": "a22d75bcad9e385ffde189c6c46769a06048f245", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA1NzQ4OA==", "url": "https://github.com/MegaMek/mekhq/pull/2308#discussion_r548057488", "bodyText": "It gets garbage collected after this call. Now that I have a good test I'll probably move the variable cost calculator to a shared class and use that here instead of this tomfoolery.", "author": "sixlettervariables", "createdAt": "2020-12-23T17:08:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA1NjA4MQ=="}], "type": "inlineReview"}, {"oid": "7cf1746e45c57975925f50945f86e6bf3c80961c", "url": "https://github.com/MegaMek/mekhq/commit/7cf1746e45c57975925f50945f86e6bf3c80961c", "message": "Fix bug with variable equipment sizing not saving\n\nUse more derived class for getMissingPart\n\nUse LOC_NONE instead of -1 for equipment numbers\n\nAdd basic EquipmentPart tests\n\nAdd EquipmentPart::getMounted helper\n\nAdd Part::setHits to help testing repair actions\n\nAdd needsFixing and fix tests\n\nAdd isPartForEquipment and omnipoddable tests\n\nAdd getLocationName test\n\nAdd busted/destroyed location tests\n\nAdd checkFixable test and revise other tests\n\nCleanup EquipmentPart mounted location code\n\nCleanup checkWeaponBay and add it back to remove\n\nUse Mounted::isSplit to check for a secondary location\n\nAdd update condition tests\n\n...and fix LGTM nits.\n\nAdd isInLocation test\n\nAdd getBaseTime test\n\n- Fix bug where LAM bomb bays reported 60 minutes even when fixed\n\nAdd isSamePartType test\n\nUpdate MissingEquipmentPart to match EquipmentPart\n\nAdd MissingPart tests\n\n- Fix MissingPart::isAcceptableReplacement to take into account variable costs\n\nDon't log if there is supposed to be no equipment\n\nAdd checkWeaponBay tests", "committedDate": "2020-12-24T14:24:24Z", "type": "commit"}, {"oid": "7cf1746e45c57975925f50945f86e6bf3c80961c", "url": "https://github.com/MegaMek/mekhq/commit/7cf1746e45c57975925f50945f86e6bf3c80961c", "message": "Fix bug with variable equipment sizing not saving\n\nUse more derived class for getMissingPart\n\nUse LOC_NONE instead of -1 for equipment numbers\n\nAdd basic EquipmentPart tests\n\nAdd EquipmentPart::getMounted helper\n\nAdd Part::setHits to help testing repair actions\n\nAdd needsFixing and fix tests\n\nAdd isPartForEquipment and omnipoddable tests\n\nAdd getLocationName test\n\nAdd busted/destroyed location tests\n\nAdd checkFixable test and revise other tests\n\nCleanup EquipmentPart mounted location code\n\nCleanup checkWeaponBay and add it back to remove\n\nUse Mounted::isSplit to check for a secondary location\n\nAdd update condition tests\n\n...and fix LGTM nits.\n\nAdd isInLocation test\n\nAdd getBaseTime test\n\n- Fix bug where LAM bomb bays reported 60 minutes even when fixed\n\nAdd isSamePartType test\n\nUpdate MissingEquipmentPart to match EquipmentPart\n\nAdd MissingPart tests\n\n- Fix MissingPart::isAcceptableReplacement to take into account variable costs\n\nDon't log if there is supposed to be no equipment\n\nAdd checkWeaponBay tests", "committedDate": "2020-12-24T14:24:24Z", "type": "forcePushed"}]}