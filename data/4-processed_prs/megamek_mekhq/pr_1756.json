{"pr_number": 1756, "pr_title": "fix sandblaster issues", "pr_createdAt": "2020-05-19T04:43:52Z", "pr_url": "https://github.com/MegaMek/mekhq/pull/1756", "timeline": [{"oid": "0fdee679305faf54d7ae757432a077d022d9cff1", "url": "https://github.com/MegaMek/mekhq/commit/0fdee679305faf54d7ae757432a077d022d9cff1", "message": "fix sandblaster issues", "committedDate": "2020-05-19T04:40:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMzNTkwOA==", "url": "https://github.com/MegaMek/mekhq/pull/1756#discussion_r427335908", "bodyText": "After building a list of all eligible weapons, you're still picking randomly from all weapons.", "author": "neoancient", "createdAt": "2020-05-19T14:15:42Z", "path": "MekHQ/src/mekhq/campaign/mission/CrewSkillUpgrader.java", "diffHunk": "@@ -216,7 +221,16 @@ private boolean extraEligibilityCheck(SpecialAbility spa, Entity entity) {\n      * @param entity The entity being manipulated\n      * @return Weapon name\n      */\n-    private String pickRandomWeapon(Entity entity) {\n+    private String pickRandomWeapon(Entity entity, boolean clusterOnly) {\n+        List<Mounted> weapons = entity.getIndividualWeaponList();\n+        List<Mounted> eligibleWeapons = new ArrayList<>();\n+        \n+        for(Mounted weapon : weapons) {\n+            if(SpecialAbility.isWeaponEligibleForSPA(weapon.getType(), Person.T_NONE, clusterOnly)) {\n+                eligibleWeapons.add(weapon);\n+            }\n+        }\n+        \n         int weaponIndex = Compute.randomInt(entity.getIndividualWeaponList().size());\n         return entity.getIndividualWeaponList().get(weaponIndex).getName();", "originalCommit": "0fdee679305faf54d7ae757432a077d022d9cff1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "91581dd492d8322912c3f470cf317432d3502a95", "url": "https://github.com/MegaMek/mekhq/commit/91581dd492d8322912c3f470cf317432d3502a95", "message": "Update CrewSkillUpgrader.java", "committedDate": "2020-05-19T14:29:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MDk3OQ==", "url": "https://github.com/MegaMek/mekhq/pull/1756#discussion_r427550979", "bodyText": "What happens if the entity doesn't have any eligible weapons?", "author": "neoancient", "createdAt": "2020-05-19T19:34:56Z", "path": "MekHQ/src/mekhq/campaign/mission/CrewSkillUpgrader.java", "diffHunk": "@@ -216,9 +221,18 @@ private boolean extraEligibilityCheck(SpecialAbility spa, Entity entity) {\n      * @param entity The entity being manipulated\n      * @return Weapon name\n      */\n-    private String pickRandomWeapon(Entity entity) {\n-        int weaponIndex = Compute.randomInt(entity.getIndividualWeaponList().size());\n-        return entity.getIndividualWeaponList().get(weaponIndex).getName();\n+    private String pickRandomWeapon(Entity entity, boolean clusterOnly) {\n+        List<Mounted> weapons = entity.getIndividualWeaponList();\n+        List<Mounted> eligibleWeapons = new ArrayList<>();\n+        \n+        for(Mounted weapon : weapons) {\n+            if(SpecialAbility.isWeaponEligibleForSPA(weapon.getType(), Person.T_NONE, clusterOnly)) {\n+                eligibleWeapons.add(weapon);\n+            }\n+        }\n+        \n+        int weaponIndex = Compute.randomInt(eligibleWeapons.size());\n+        return eligibleWeapons.get(weaponIndex).getName();", "originalCommit": "91581dd492d8322912c3f470cf317432d3502a95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MTYyMQ==", "url": "https://github.com/MegaMek/mekhq/pull/1756#discussion_r427551621", "bodyText": "Array out of bounds exception, probably. I'll add some more defensive coding when I get back to it tonight.", "author": "NickAragua", "createdAt": "2020-05-19T19:36:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MDk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3MDg4OA==", "url": "https://github.com/MegaMek/mekhq/pull/1756#discussion_r427670888", "bodyText": "Fixed. I suppose I could have it re-roll in that case, but it's a lot more work and I don't think anybody's going to complain about bot unit crews having a tiny amount less SPAs.", "author": "NickAragua", "createdAt": "2020-05-20T00:13:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MDk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI2NDUwNQ==", "url": "https://github.com/MegaMek/mekhq/pull/1756#discussion_r428264505", "bodyText": "Does this have the effect of giving the crew the SPA, but making it ineffective because it doesn't match any weapon?", "author": "neoancient", "createdAt": "2020-05-20T19:42:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MDk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI2Nzg3MQ==", "url": "https://github.com/MegaMek/mekhq/pull/1756#discussion_r428267871", "bodyText": "Basically. I suppose a better solution would be to have the calling function check whether this method returned anything and avoid adding the SPA in that case.", "author": "NickAragua", "createdAt": "2020-05-20T19:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MDk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMwMDQwOQ==", "url": "https://github.com/MegaMek/mekhq/pull/1756#discussion_r428300409", "bodyText": "It's functional as is, but probably clearer without the non-functional SPA.", "author": "neoancient", "createdAt": "2020-05-20T20:52:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MDk3OQ=="}], "type": "inlineReview"}, {"oid": "5e0957d6d39116235e97568210b1ffe64d40c2fa", "url": "https://github.com/MegaMek/mekhq/commit/5e0957d6d39116235e97568210b1ffe64d40c2fa", "message": "bullet-proofing", "committedDate": "2020-05-20T00:11:49Z", "type": "commit"}, {"oid": "d26141fc40085d2d14e96f4cbe4a2a973ac88148", "url": "https://github.com/MegaMek/mekhq/commit/d26141fc40085d2d14e96f4cbe4a2a973ac88148", "message": "more code review changes", "committedDate": "2020-05-20T21:13:16Z", "type": "commit"}]}