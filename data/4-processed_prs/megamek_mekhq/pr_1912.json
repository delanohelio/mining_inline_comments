{"pr_number": 1912, "pr_title": "Parts availability indicator", "pr_createdAt": "2020-08-09T02:38:33Z", "pr_url": "https://github.com/MegaMek/mekhq/pull/1912", "timeline": [{"oid": "1b3b3e80ec9890d0d0f681afaf503b8a9c90ddd8", "url": "https://github.com/MegaMek/mekhq/commit/1b3b3e80ec9890d0d0f681afaf503b8a9c90ddd8", "message": "parts availability indicator", "committedDate": "2020-08-09T02:34:19Z", "type": "commit"}, {"oid": "78dbd3fb0d0c898f11240784decde68d6192ce48", "url": "https://github.com/MegaMek/mekhq/commit/78dbd3fb0d0c898f11240784decde68d6192ce48", "message": "merge from upstream", "committedDate": "2020-08-09T02:34:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MDU2Ng==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467660566", "bodyText": "Why not just chain appends?", "author": "Windchild292", "createdAt": "2020-08-10T02:07:43Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5663,12 +5663,17 @@ public TargetRoll getTargetForAcquisition(IAcquisitionWork acquisition,\n                 et = ((MissingEquipmentPart) acquisition).getType();\n             }\n \n+            StringBuilder partAvailabilityLog = new StringBuilder();\n+            partAvailabilityLog.append(\"Part Rating Level: \" + partAvailability);\n+            partAvailabilityLog.append(\"(\" + EquipmentType.ratingNames[partAvailability] + \")\");", "originalCommit": "78dbd3fb0d0c898f11240784decde68d6192ce48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY3OTcxMw==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467679713", "bodyText": "I found it easier to read the code that way, but I can probably just put the append on the next line as well.", "author": "NickAragua", "createdAt": "2020-08-10T04:10:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MDU2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4MDU0OQ==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467680549", "bodyText": "I'd recommend the next line append, as it is somewhat cleaner in file.", "author": "Windchild292", "createdAt": "2020-08-10T04:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MDU2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MDY0Mg==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467660642", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (((megamek.common.AmmoType) et).getMunitionType() == megamek.common.AmmoType.M_STANDARD) {                        \n          \n          \n            \n                                if (((megamek.common.AmmoType) et).getMunitionType() == megamek.common.AmmoType.M_STANDARD) {", "author": "Windchild292", "createdAt": "2020-08-10T02:08:21Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5682,27 +5687,33 @@ public TargetRoll getTargetForAcquisition(IAcquisitionWork acquisition,\n                         && !(et instanceof megamek.common.weapons.flamers.FlamerWeapon)\n                         && partAvailability < EquipmentType.RATING_C) {\n                     partAvailability = EquipmentType.RATING_C;\n+                    partAvailabilityLog.append(\";(non-flamer lasers)\");\n                 }\n                 if (et instanceof megamek.common.weapons.autocannons.ACWeapon) {\n                     partAvailability -= 2;\n+                    partAvailabilityLog.append(\";(autocannon): -2\");\n                 }\n                 if (et instanceof megamek.common.weapons.gaussrifles.GaussWeapon\n                         || et instanceof megamek.common.weapons.flamers.FlamerWeapon) {\n                     partAvailability--;\n+                    partAvailabilityLog.append(\";(gauss rifle or flamer): -1\");\n                 }\n                 if (et instanceof megamek.common.AmmoType) {\n                     switch (((megamek.common.AmmoType) et).getAmmoType()) {\n                         case megamek.common.AmmoType.T_AC:\n                             partAvailability -= 2;\n+                            partAvailabilityLog.append(\";(autocannon ammo): -2\");\n                             break;\n                         case megamek.common.AmmoType.T_GAUSS:\n                             partAvailability -= 1;\n+                            partAvailabilityLog.append(\";(gauss ammo): -1\");\n+                            break;\n                     }\n-                    if (((megamek.common.AmmoType) et).getMunitionType() == megamek.common.AmmoType.M_STANDARD) {\n+                    if (((megamek.common.AmmoType) et).getMunitionType() == megamek.common.AmmoType.M_STANDARD) {                        ", "originalCommit": "78dbd3fb0d0c898f11240784decde68d6192ce48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MDgzNA==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467660834", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    AtBContract contract = acquisition != null ? getAttachedAtBContract(acquisition.getUnit()) : null;\n          \n          \n            \n                    AtBContract contract = (acquisition != null) ? getAttachedAtBContract(acquisition.getUnit()) : null;", "author": "Windchild292", "createdAt": "2020-08-10T02:09:53Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5746,28 +5759,44 @@ public int totalBonusParts() {\n         return retVal;\n     }\n \n-    private int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition) {\n-        AtBContract contract = getAttachedAtBContract(acquisition.getUnit());\n+    public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n+        AtBContract contract = acquisition != null ? getAttachedAtBContract(acquisition.getUnit()) : null;", "originalCommit": "78dbd3fb0d0c898f11240784decde68d6192ce48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MDkwNg==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467660906", "bodyText": "Very much just a suggestion, but one I find makes it easier to parse later.", "author": "Windchild292", "createdAt": "2020-08-10T02:10:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MDgzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTUwNQ==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467661505", "bodyText": "This could be simplified and its performance can be boosted by swapping to an if statement checking hasActiveContract() followed by using getActiveContracts()", "author": "Windchild292", "createdAt": "2020-08-10T02:14:41Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5746,28 +5759,44 @@ public int totalBonusParts() {\n         return retVal;\n     }\n \n-    private int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition) {\n-        AtBContract contract = getAttachedAtBContract(acquisition.getUnit());\n+    public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n+        AtBContract contract = acquisition != null ? getAttachedAtBContract(acquisition.getUnit()) : null;\n         /*\n          * If the unit is not assigned to a contract, use the least restrictive active\n-         * contract\n+         * contract. Don't restrict parts availability by contract if it has not started.\n          */\n         for (Mission m : getMissions()) {\n-            if (m.isActive() && m instanceof AtBContract) {\n+            if (m.isActive() && m instanceof AtBContract && ((AtBContract) m).getStartDate().isBefore(currentDay)) {", "originalCommit": "78dbd3fb0d0c898f11240784decde68d6192ce48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTYyMA==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467661620", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (null != contract && contract.getStartDate().isBefore(currentDay)) {\n          \n          \n            \n                    if ((null != contract) && contract.getStartDate().isBefore(currentDay)) {", "author": "Windchild292", "createdAt": "2020-08-10T02:15:13Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5746,28 +5759,44 @@ public int totalBonusParts() {\n         return retVal;\n     }\n \n-    private int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition) {\n-        AtBContract contract = getAttachedAtBContract(acquisition.getUnit());\n+    public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n+        AtBContract contract = acquisition != null ? getAttachedAtBContract(acquisition.getUnit()) : null;\n         /*\n          * If the unit is not assigned to a contract, use the least restrictive active\n-         * contract\n+         * contract. Don't restrict parts availability by contract if it has not started.\n          */\n         for (Mission m : getMissions()) {\n-            if (m.isActive() && m instanceof AtBContract) {\n+            if (m.isActive() && m instanceof AtBContract && ((AtBContract) m).getStartDate().isBefore(currentDay)) {\n                 if (null == contract\n                         || ((AtBContract) m).getPartsAvailabilityLevel() > contract.getPartsAvailabilityLevel()) {\n                     contract = (AtBContract) m;\n                 }\n             }\n         }\n-        if (null != contract) {\n+        \n+        // if we have a contract and it has started\n+        if (null != contract && contract.getStartDate().isBefore(currentDay)) {", "originalCommit": "78dbd3fb0d0c898f11240784decde68d6192ce48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTY4Mw==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467661683", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if(adminLog != null) {\n          \n          \n            \n                        if (adminLog != null) {", "author": "Windchild292", "createdAt": "2020-08-10T02:15:31Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5746,28 +5759,44 @@ public int totalBonusParts() {\n         return retVal;\n     }\n \n-    private int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition) {\n-        AtBContract contract = getAttachedAtBContract(acquisition.getUnit());\n+    public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n+        AtBContract contract = acquisition != null ? getAttachedAtBContract(acquisition.getUnit()) : null;\n         /*\n          * If the unit is not assigned to a contract, use the least restrictive active\n-         * contract\n+         * contract. Don't restrict parts availability by contract if it has not started.\n          */\n         for (Mission m : getMissions()) {\n-            if (m.isActive() && m instanceof AtBContract) {\n+            if (m.isActive() && m instanceof AtBContract && ((AtBContract) m).getStartDate().isBefore(currentDay)) {\n                 if (null == contract\n                         || ((AtBContract) m).getPartsAvailabilityLevel() > contract.getPartsAvailabilityLevel()) {\n                     contract = (AtBContract) m;\n                 }\n             }\n         }\n-        if (null != contract) {\n+        \n+        // if we have a contract and it has started\n+        if (null != contract && contract.getStartDate().isBefore(currentDay)) {\n+            if (reportBuilder != null) {\n+                reportBuilder.append(contract.getPartsAvailabilityLevel() + \" (\" + contract.getType() +\")\");\n+            }\n             return contract.getPartsAvailabilityLevel();\n         }\n         /* If contract is still null, the unit is not in a contract. */\n         Person adminLog = findBestInRole(Person.T_ADMIN_LOG, SkillType.S_ADMIN);\n         int adminLogExp = (adminLog == null) ? SkillType.EXP_ULTRA_GREEN\n                 : adminLog.getSkill(SkillType.S_ADMIN).getExperienceLevel();\n-        return getUnitRatingMod() + adminLogExp - SkillType.EXP_REGULAR;\n+        int adminMod = adminLogExp - SkillType.EXP_REGULAR;\n+        \n+        if (reportBuilder != null) {\n+            reportBuilder.append(getUnitRatingMod() + \"(unit rating)\");\n+            if(adminLog != null) {", "originalCommit": "78dbd3fb0d0c898f11240784decde68d6192ce48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTkyMg==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467661922", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(!getCampaign().getCampaignOptions().getUseAtB()) {\n          \n          \n            \n                    if (!getCampaign().getCampaignOptions().getUseAtB()) {", "author": "Windchild292", "createdAt": "2020-08-10T02:17:22Z", "path": "MekHQ/src/mekhq/gui/CampaignGUI.java", "diffHunk": "@@ -2586,6 +2590,16 @@ private void refreshTempMedics() {\n         String text = \"<html><b>Temp Medics:</b> \" + getCampaign().getMedicPool() + \"</html>\";\n         lblTempMedics.setText(text);\n     }\n+    \n+    private void refreshPartsAvailability() {\n+        if(!getCampaign().getCampaignOptions().getUseAtB()) {", "originalCommit": "78dbd3fb0d0c898f11240784decde68d6192ce48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTk1MA==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467661950", "bodyText": "Suggested change", "author": "Windchild292", "createdAt": "2020-08-10T02:17:35Z", "path": "MekHQ/src/mekhq/gui/CampaignGUI.java", "diffHunk": "@@ -2662,7 +2680,18 @@ public void handle(MedicPoolChangedEvent ev) {\n     public void handleLocationChanged(LocationChangedEvent ev) {\n         refreshLocation();\n     }\n-\n+    \n+    @Subscribe\n+    public void handleMissionChanged(MissionEvent ev) {\n+        refreshPartsAvailability();\n+    }\n+    \n+    @Subscribe\n+    public void handleMissionChanged(PersonChangedEvent ev) {\n+        refreshPartsAvailability();\n+    }\n+    \n+    ", "originalCommit": "78dbd3fb0d0c898f11240784decde68d6192ce48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MjA4MA==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467662080", "bodyText": "This name doesn't make sense, did you mean to name it handlePersonChanged?\nAlso, why are we refreshing parts whenever any person is changed?", "author": "Windchild292", "createdAt": "2020-08-10T02:18:26Z", "path": "MekHQ/src/mekhq/gui/CampaignGUI.java", "diffHunk": "@@ -2662,7 +2680,18 @@ public void handle(MedicPoolChangedEvent ev) {\n     public void handleLocationChanged(LocationChangedEvent ev) {\n         refreshLocation();\n     }\n-\n+    \n+    @Subscribe\n+    public void handleMissionChanged(MissionEvent ev) {\n+        refreshPartsAvailability();\n+    }\n+    \n+    @Subscribe\n+    public void handleMissionChanged(PersonChangedEvent ev) {", "originalCommit": "78dbd3fb0d0c898f11240784decde68d6192ce48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4MDExMQ==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467680111", "bodyText": "Parts availability depends, in part on the highest-skilled logistics admin. I could probably limit it to refreshing only when the logistics skill changed, but I'm not sure if that's possible. I'll take a look.", "author": "NickAragua", "createdAt": "2020-08-10T04:12:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MjA4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4MDY1Ng==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467680656", "bodyText": "I'm pretty sure it isn't currently, annoyingly.", "author": "Windchild292", "createdAt": "2020-08-10T04:15:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MjA4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4MzQxMQ==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467683411", "bodyText": "Looks like I can at least check that the person who was changed has a logistics admin role.", "author": "NickAragua", "createdAt": "2020-08-10T04:31:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MjA4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4MzYzMg==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467683632", "bodyText": "That will almost certainly be better performing, so can that be implemented?", "author": "Windchild292", "createdAt": "2020-08-10T04:33:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MjA4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4MzY4Nw==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467683687", "bodyText": "Yep. Checking now.", "author": "NickAragua", "createdAt": "2020-08-10T04:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MjA4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4Nzg3OQ==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467687879", "bodyText": "Done.", "author": "NickAragua", "createdAt": "2020-08-10T04:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MjA4MA=="}], "type": "inlineReview"}, {"oid": "b13bd1d7a7f655d67b16c09b89bfe6dd3a2dfdda", "url": "https://github.com/MegaMek/mekhq/commit/b13bd1d7a7f655d67b16c09b89bfe6dd3a2dfdda", "message": "Update MekHQ/src/mekhq/gui/CampaignGUI.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>", "committedDate": "2020-08-10T04:11:17Z", "type": "commit"}, {"oid": "3c21dd8fc551092849fca7a3cc1d07f6f2a391ce", "url": "https://github.com/MegaMek/mekhq/commit/3c21dd8fc551092849fca7a3cc1d07f6f2a391ce", "message": "Update MekHQ/src/mekhq/gui/CampaignGUI.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>", "committedDate": "2020-08-10T04:12:52Z", "type": "commit"}, {"oid": "ca51b0d21435ed8ab0fefbd767a1670053b1309f", "url": "https://github.com/MegaMek/mekhq/commit/ca51b0d21435ed8ab0fefbd767a1670053b1309f", "message": "Update MekHQ/src/mekhq/campaign/Campaign.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>", "committedDate": "2020-08-10T04:12:59Z", "type": "commit"}, {"oid": "6feb6efe80404fb7ac2e5da175200daef2293c84", "url": "https://github.com/MegaMek/mekhq/commit/6feb6efe80404fb7ac2e5da175200daef2293c84", "message": "Update MekHQ/src/mekhq/campaign/Campaign.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>", "committedDate": "2020-08-10T04:13:07Z", "type": "commit"}, {"oid": "c25bbbbdb29f5bc836032d8d9b5ae5d0989fe61e", "url": "https://github.com/MegaMek/mekhq/commit/c25bbbbdb29f5bc836032d8d9b5ae5d0989fe61e", "message": "Update MekHQ/src/mekhq/campaign/Campaign.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>", "committedDate": "2020-08-10T04:13:16Z", "type": "commit"}, {"oid": "4c63151ed2f60fcff32effd5e62bbd666aeb7455", "url": "https://github.com/MegaMek/mekhq/commit/4c63151ed2f60fcff32effd5e62bbd666aeb7455", "message": "Update MekHQ/src/mekhq/campaign/Campaign.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>", "committedDate": "2020-08-10T04:13:24Z", "type": "commit"}, {"oid": "495c75be6592aac424b20447e423d95468796252", "url": "https://github.com/MegaMek/mekhq/commit/495c75be6592aac424b20447e423d95468796252", "message": "performance improvements", "committedDate": "2020-08-10T04:41:27Z", "type": "commit"}, {"oid": "c2d55d9939e019ec8c0edbd22d39d539c80ff677", "url": "https://github.com/MegaMek/mekhq/commit/c2d55d9939e019ec8c0edbd22d39d539c80ff677", "message": "fix npe", "committedDate": "2020-08-10T04:48:15Z", "type": "commit"}, {"oid": "35411c63ff4ccc5a6b754fe459fa18e80a2c0f8a", "url": "https://github.com/MegaMek/mekhq/commit/35411c63ff4ccc5a6b754fe459fa18e80a2c0f8a", "message": "update parts availability on contract start", "committedDate": "2020-08-10T04:56:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4Nzc2Ng==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467687766", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (c instanceof AtBContract && \n          \n          \n            \n                            if ((c instanceof AtBContract) &&", "author": "Windchild292", "createdAt": "2020-08-10T04:56:37Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5761,15 +5762,18 @@ public int totalBonusParts() {\n \n     public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n         AtBContract contract = (acquisition != null) ? getAttachedAtBContract(acquisition.getUnit()) : null;\n+        \n         /*\n          * If the unit is not assigned to a contract, use the least restrictive active\n          * contract. Don't restrict parts availability by contract if it has not started.\n          */\n-        for (Mission m : getMissions()) {\n-            if (m.isActive() && m instanceof AtBContract && ((AtBContract) m).getStartDate().isBefore(currentDay)) {\n-                if (null == contract\n-                        || ((AtBContract) m).getPartsAvailabilityLevel() > contract.getPartsAvailabilityLevel()) {\n-                    contract = (AtBContract) m;\n+        if (hasActiveContract() && (contract == null)) {\n+            for (Contract c : getActiveContracts()) {\n+                if (c instanceof AtBContract && ", "originalCommit": "c2d55d9939e019ec8c0edbd22d39d539c80ff677", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4NzgwNA==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467687804", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    (contract == null || \n          \n          \n            \n                                    ((contract == null) ||", "author": "Windchild292", "createdAt": "2020-08-10T04:56:48Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5761,15 +5762,18 @@ public int totalBonusParts() {\n \n     public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n         AtBContract contract = (acquisition != null) ? getAttachedAtBContract(acquisition.getUnit()) : null;\n+        \n         /*\n          * If the unit is not assigned to a contract, use the least restrictive active\n          * contract. Don't restrict parts availability by contract if it has not started.\n          */\n-        for (Mission m : getMissions()) {\n-            if (m.isActive() && m instanceof AtBContract && ((AtBContract) m).getStartDate().isBefore(currentDay)) {\n-                if (null == contract\n-                        || ((AtBContract) m).getPartsAvailabilityLevel() > contract.getPartsAvailabilityLevel()) {\n-                    contract = (AtBContract) m;\n+        if (hasActiveContract() && (contract == null)) {\n+            for (Contract c : getActiveContracts()) {\n+                if (c instanceof AtBContract && \n+                        c.getStartDate().isBefore(currentDay) && \n+                        (contract == null || ", "originalCommit": "c2d55d9939e019ec8c0edbd22d39d539c80ff677", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4Nzg2MA==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467687860", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(ev.getPerson().hasRole(Person.T_ADMIN_LOG)) {\n          \n          \n            \n                    if (ev.getPerson().hasRole(Person.T_ADMIN_LOG)) {", "author": "Windchild292", "createdAt": "2020-08-10T04:57:04Z", "path": "MekHQ/src/mekhq/gui/CampaignGUI.java", "diffHunk": "@@ -2687,8 +2687,12 @@ public void handleMissionChanged(MissionEvent ev) {\n     }\n     \n     @Subscribe\n-    public void handleMissionChanged(PersonChangedEvent ev) {\n-        refreshPartsAvailability();\n+    public void handlePersonUpdate(PersonEvent ev) {\n+        // only bother recalculating AtB parts availability if a logistics admin has been changed\n+        // refreshPartsAvailability cuts out early with a \"use AtB\" check so it's not necessary here\n+        if(ev.getPerson().hasRole(Person.T_ADMIN_LOG)) {", "originalCommit": "c2d55d9939e019ec8c0edbd22d39d539c80ff677", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4ODIwMw==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467688203", "bodyText": "Isn't there an option to determine which type of personnel does this?", "author": "Windchild292", "createdAt": "2020-08-10T04:59:06Z", "path": "MekHQ/src/mekhq/gui/CampaignGUI.java", "diffHunk": "@@ -2687,8 +2687,12 @@ public void handleMissionChanged(MissionEvent ev) {\n     }\n     \n     @Subscribe\n-    public void handleMissionChanged(PersonChangedEvent ev) {\n-        refreshPartsAvailability();\n+    public void handlePersonUpdate(PersonEvent ev) {\n+        // only bother recalculating AtB parts availability if a logistics admin has been changed\n+        // refreshPartsAvailability cuts out early with a \"use AtB\" check so it's not necessary here\n+        if(ev.getPerson().hasRole(Person.T_ADMIN_LOG)) {\n+            refreshPartsAvailability();\n+        }", "originalCommit": "35411c63ff4ccc5a6b754fe459fa18e80a2c0f8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk0MjMyMg==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467942322", "bodyText": "For AtB, it always uses the logistics admin.", "author": "NickAragua", "createdAt": "2020-08-10T14:27:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4ODIwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4ODM5NQ==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r467688395", "bodyText": "contact == null should be impossible for hasActiveContact, otherwise it is a bug in hasActiveContact.", "author": "Windchild292", "createdAt": "2020-08-10T05:00:04Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5761,26 +5762,30 @@ public int totalBonusParts() {\n \n     public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n         AtBContract contract = (acquisition != null) ? getAttachedAtBContract(acquisition.getUnit()) : null;\n+        \n         /*\n          * If the unit is not assigned to a contract, use the least restrictive active\n          * contract. Don't restrict parts availability by contract if it has not started.\n          */\n-        for (Mission m : getMissions()) {\n-            if (m.isActive() && m instanceof AtBContract && ((AtBContract) m).getStartDate().isBefore(currentDay)) {\n-                if (null == contract\n-                        || ((AtBContract) m).getPartsAvailabilityLevel() > contract.getPartsAvailabilityLevel()) {\n-                    contract = (AtBContract) m;\n+        if (hasActiveContract() && (contract == null)) {", "originalCommit": "35411c63ff4ccc5a6b754fe459fa18e80a2c0f8a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b822780f2db06e4dd62d6fdfd78f263e66f18a76", "url": "https://github.com/MegaMek/mekhq/commit/b822780f2db06e4dd62d6fdfd78f263e66f18a76", "message": "code review changes", "committedDate": "2020-08-10T14:43:40Z", "type": "commit"}, {"oid": "34e3fbf36f5c2327a8b4d880660157d483c41a9c", "url": "https://github.com/MegaMek/mekhq/commit/34e3fbf36f5c2327a8b4d880660157d483c41a9c", "message": "merge from upstream", "committedDate": "2020-08-10T14:44:03Z", "type": "commit"}, {"oid": "0660141d6b7cd3266767b4479a126f75326e7536", "url": "https://github.com/MegaMek/mekhq/commit/0660141d6b7cd3266767b4479a126f75326e7536", "message": "Update MekHQ/src/mekhq/gui/CampaignGUI.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>", "committedDate": "2020-08-11T01:10:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3MDI5Ng==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r468270296", "bodyText": "These three are all cancelled out by the getActiveContracts, which only returns those whose date is active.", "author": "Windchild292", "createdAt": "2020-08-11T01:13:36Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5734,19 +5734,19 @@ public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBui\n          * If the unit is not assigned to a contract, use the least restrictive active\n          * contract. Don't restrict parts availability by contract if it has not started.\n          */\n-        if (hasActiveContract() && (contract == null)) {\n+        if (hasActiveContract()) {\n             for (Contract c : getActiveContracts()) {\n-                if (c instanceof AtBContract && \n-                        c.getStartDate().isBefore(currentDay) && \n-                        (contract == null || \n+                if ((c instanceof AtBContract) && \n+                        (c.getStartDate().isBefore(currentDay) || c.getStartDate().equals(currentDay)) && \n+                        ((contract == null) || ", "originalCommit": "0660141d6b7cd3266767b4479a126f75326e7536", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3MTA3OA==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r468271078", "bodyText": "The getStartDate stuff is not required because of the use of getActiveContracts. Additionally, currentDay should never be directly used outside of the increase day.", "author": "Windchild292", "createdAt": "2020-08-11T01:16:28Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5734,19 +5734,19 @@ public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBui\n          * If the unit is not assigned to a contract, use the least restrictive active\n          * contract. Don't restrict parts availability by contract if it has not started.\n          */\n-        if (hasActiveContract() && (contract == null)) {\n+        if (hasActiveContract()) {\n             for (Contract c : getActiveContracts()) {\n-                if (c instanceof AtBContract && \n-                        c.getStartDate().isBefore(currentDay) && \n-                        (contract == null || \n+                if ((c instanceof AtBContract) && \n+                        (c.getStartDate().isBefore(currentDay) || c.getStartDate().equals(currentDay)) && \n+                        ((contract == null) || \n                         (((AtBContract) c).getPartsAvailabilityLevel() > contract.getPartsAvailabilityLevel()))) {\n                     contract = (AtBContract) c;\n                 }\n             }\n         }\n         \n         // if we have a contract and it has started\n-        if ((null != contract) && contract.getStartDate().isBefore(currentDay)) {\n+        if ((null != contract) && (contract.getStartDate().isBefore(currentDay) || contract.getStartDate().equals(currentDay))) {", "originalCommit": "0660141d6b7cd3266767b4479a126f75326e7536", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3MTU0MQ==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r468271541", "bodyText": "I'm not sure about that getStartDate thing, because the contract may not come from the \"activeContracts\" loop.", "author": "NickAragua", "createdAt": "2020-08-11T01:17:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3MTA3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3MjQxMw==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r468272413", "bodyText": "Missed that part, you are correct. Still the latter currentDay bit holds, plus you can just do a !getLocalDate().isBefore(contract.getStartDate()) to test if it is either before or equal to the current day", "author": "Windchild292", "createdAt": "2020-08-11T01:20:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3MTA3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3Mzc4NA==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r468273784", "bodyText": "Yeah, that's a lot cleaner.", "author": "NickAragua", "createdAt": "2020-08-11T01:25:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3MTA3OA=="}], "type": "inlineReview"}, {"oid": "9ce59b5cbe34bda87a84c1e877861e913826eeb1", "url": "https://github.com/MegaMek/mekhq/commit/9ce59b5cbe34bda87a84c1e877861e913826eeb1", "message": "replaced field usage with property", "committedDate": "2020-08-11T01:21:51Z", "type": "commit"}, {"oid": "d31adf60d8b843be61c2672d13529d4936f6dd5c", "url": "https://github.com/MegaMek/mekhq/commit/d31adf60d8b843be61c2672d13529d4936f6dd5c", "message": "merge", "committedDate": "2020-08-11T01:22:21Z", "type": "commit"}, {"oid": "27a8099ef1f3d747d09a1ae503fac20d61b89b36", "url": "https://github.com/MegaMek/mekhq/commit/27a8099ef1f3d747d09a1ae503fac20d61b89b36", "message": "simplify date comparisons", "committedDate": "2020-08-11T01:25:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI3NTMwOQ==", "url": "https://github.com/MegaMek/mekhq/pull/1912#discussion_r468275309", "bodyText": "This is still superfluous.", "author": "Windchild292", "createdAt": "2020-08-11T01:30:57Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -5713,28 +5727,48 @@ public int totalBonusParts() {\n         return retVal;\n     }\n \n-    private int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition) {\n-        AtBContract contract = getAttachedAtBContract(acquisition.getUnit());\n+    public int findAtBPartsAvailabilityLevel(IAcquisitionWork acquisition, StringBuilder reportBuilder) {\n+        AtBContract contract = (acquisition != null) ? getAttachedAtBContract(acquisition.getUnit()) : null;\n+        \n         /*\n          * If the unit is not assigned to a contract, use the least restrictive active\n-         * contract\n+         * contract. Don't restrict parts availability by contract if it has not started.\n          */\n-        for (Mission m : getMissions()) {\n-            if (m.isActive() && m instanceof AtBContract) {\n-                if (null == contract\n-                        || ((AtBContract) m).getPartsAvailabilityLevel() > contract.getPartsAvailabilityLevel()) {\n-                    contract = (AtBContract) m;\n+        if (hasActiveContract()) {\n+            for (Contract c : getActiveContracts()) {\n+                if ((c instanceof AtBContract) && \n+                        getLocalDate().isBefore(c.getStartDate()) && ", "originalCommit": "27a8099ef1f3d747d09a1ae503fac20d61b89b36", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "484fa063cd856bce9bef7f9de2227b09f9f2158b", "url": "https://github.com/MegaMek/mekhq/commit/484fa063cd856bce9bef7f9de2227b09f9f2158b", "message": "simplify date comparisons 2", "committedDate": "2020-08-11T01:31:33Z", "type": "commit"}]}