{"pr_number": 1496, "pr_title": "Scenario template various improvements", "pr_createdAt": "2020-02-18T05:01:26Z", "pr_url": "https://github.com/MegaMek/mekhq/pull/1496", "timeline": [{"oid": "289a7f34136b2c71360f000382ed36be3351f7e1", "url": "https://github.com/MegaMek/mekhq/commit/289a7f34136b2c71360f000382ed36be3351f7e1", "message": "implement min weight", "committedDate": "2020-02-15T03:34:05Z", "type": "commit"}, {"oid": "6834d4dd493b68fba951f72bf14f19a4880ccc30", "url": "https://github.com/MegaMek/mekhq/commit/6834d4dd493b68fba951f72bf14f19a4880ccc30", "message": "better button messaging", "committedDate": "2020-02-15T03:38:22Z", "type": "commit"}, {"oid": "fa3ed96896ba6ac90a856a3a15322ea22f9d3445", "url": "https://github.com/MegaMek/mekhq/commit/fa3ed96896ba6ac90a856a3a15322ea22f9d3445", "message": "can now generate battle armor to be transported", "committedDate": "2020-02-18T03:13:01Z", "type": "commit"}, {"oid": "f362ee731419087c0e3dd3b89ae1c7048cd67946", "url": "https://github.com/MegaMek/mekhq/commit/f362ee731419087c0e3dd3b89ae1c7048cd67946", "message": "elementals for clan novas", "committedDate": "2020-02-18T04:14:54Z", "type": "commit"}, {"oid": "947b638f527e04ccad89dfbcb8f1d09d151b90a4", "url": "https://github.com/MegaMek/mekhq/commit/947b638f527e04ccad89dfbcb8f1d09d151b90a4", "message": "clan opfor generation updates", "committedDate": "2020-02-18T04:58:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0NjI2MQ==", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380646261", "bodyText": "What was this used for?", "author": "sixlettervariables", "createdAt": "2020-02-18T12:39:42Z", "path": "MekHQ/src/mekhq/campaign/mission/AtBDynamicScenarioFactory.java", "diffHunk": "@@ -30,6 +30,7 @@\n import java.util.UUID;\n import java.util.stream.Collectors;\n \n+import org.apache.xalan.xsltc.compiler.Pattern;", "originalCommit": "289a7f34136b2c71360f000382ed36be3351f7e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc2ODQwMg==", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380768402", "bodyText": "No idea, but it was unused.", "author": "apokrovski", "createdAt": "2020-02-18T16:01:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0NjI2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0Njk4NA==", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380646984", "bodyText": "Is transportedUnit guaranteed to be non-null here?", "author": "sixlettervariables", "createdAt": "2020-02-18T12:41:13Z", "path": "MekHQ/src/mekhq/campaign/mission/AtBDynamicScenarioFactory.java", "diffHunk": "@@ -977,48 +982,96 @@ public static Entity getInfantryEntity(UnitGeneratorParameters params, int skill\n \n                 UnitGeneratorParameters newParams = params.clone();\n                 newParams.clearMovementModes();\n-                newParams.setUnitType(UnitType.INFANTRY);\n                 newParams.setWeightClass(AtBDynamicScenarioFactory.UNIT_WEIGHT_UNSPECIFIED);\n-\n-                // to save ourselves having to re-generate a bunch of infantry for smaller bays (3 tons and lower)\n-                // we will limit ourselves to generating low-weight foot platoons\n-                if(bayCapacity <= IUnitGenerator.FOOT_PLATOON_INFANTRY_WEIGHT) {\n-                    newParams.getMovementModes().add(EntityMovementMode.INF_LEG);\n-                    newParams.setFilter(inf -> inf.getTons() <= IUnitGenerator.FOOT_PLATOON_INFANTRY_WEIGHT);\n-                } else {\n-                    newParams.getMovementModes().addAll(IUnitGenerator.ALL_INFANTRY_MODES);\n-                    newParams.setFilter(inf -> inf.getTons() <= bayCapacity);\n+                \n+                Entity transportedUnit = null;\n+                \n+                // for now, we'll assign BA units with greater likelyhood to units with higher-rated equipment\n+                int baRoll = Compute.d6(2);                \n+                if(baRoll >= infantryToBAUpgradeTNs[params.getQuality()]) {\n+                    transportedUnit = generateTransportedBAUnit(newParams, bayCapacity, skill, campaign);\n+                }\n+                \n+                if(transportedUnit == null) {\n+                    transportedUnit = generateTransportedInfantryUnit(newParams, bayCapacity, skill, campaign);\n                 }\n \n-                MechSummary ms = campaign.getUnitGenerator().generate(newParams);\n+                // sometimes something crazy will happen and we will not be able to load the unit into the transport\n+                // so let's at least have it deploy at the same time as the transport\n+                transportedUnit.setDeployRound(transport.getDeployRound());", "originalCommit": "fa3ed96896ba6ac90a856a3a15322ea22f9d3445", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc2ODc4MQ==", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380768781", "bodyText": "Probably not. I'll bullet-proof it.", "author": "apokrovski", "createdAt": "2020-02-18T16:02:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0Njk4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0ODQ0MQ==", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380648441", "bodyText": "Clan Blood Spirit I'd imagine.", "author": "sixlettervariables", "createdAt": "2020-02-18T12:44:20Z", "path": "MekHQ/src/mekhq/campaign/mission/AtBDynamicScenarioFactory.java", "diffHunk": "@@ -1099,6 +1108,64 @@ private static Entity generateTransportedBAUnit(UnitGeneratorParameters params,\n \n         return transportedUnits;\n     }\n+    \n+    /**\n+     * Worker function that generates a battle armor unit to attach to a unit of clan mechs\n+     */\n+    public static List<Entity> generateBAForNova(AtBScenario scenario, List<Entity> starUnits, String factionCode, int skill, int quality, Campaign campaign) {\n+        List<Entity> transportedUnits = new ArrayList<>();\n+        \n+        // determine if this should be a nova\n+        // if yes, then pick the fastest mech and load it up, adding the generated BA to the transport relationships.\n+        \n+        // non-clan forces and units that aren't stars don't become novas\n+        if(!Faction.getFaction(factionCode).isClan() && (starUnits.size() != 5)) {\n+            return transportedUnits;\n+        }\n+        \n+        // logic copied from AtBScenario.addStar() to randomly determine if the given unit is actually going to be a nova\n+        // adjusted from 11/8 to 8/6 (distribution of novas in newest AtB doc is a lot higher) so that players actually encounter novas\n+        // whatever CBS is still gets no novas, so there", "originalCommit": "f362ee731419087c0e3dd3b89ae1c7048cd67946", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc3NDM2MA==", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380774360", "bodyText": "Yeah, that's their tag", "author": "Windchild292", "createdAt": "2020-02-18T16:10:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0ODQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY1MDEzNQ==", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380650135", "bodyText": "We're picking the slowest one assuming its the heaviest?", "author": "sixlettervariables", "createdAt": "2020-02-18T12:47:51Z", "path": "MekHQ/src/mekhq/campaign/mission/AtBDynamicScenarioFactory.java", "diffHunk": "@@ -1099,6 +1108,64 @@ private static Entity generateTransportedBAUnit(UnitGeneratorParameters params,\n \n         return transportedUnits;\n     }\n+    \n+    /**\n+     * Worker function that generates a battle armor unit to attach to a unit of clan mechs\n+     */\n+    public static List<Entity> generateBAForNova(AtBScenario scenario, List<Entity> starUnits, String factionCode, int skill, int quality, Campaign campaign) {\n+        List<Entity> transportedUnits = new ArrayList<>();\n+        \n+        // determine if this should be a nova\n+        // if yes, then pick the fastest mech and load it up, adding the generated BA to the transport relationships.\n+        \n+        // non-clan forces and units that aren't stars don't become novas\n+        if(!Faction.getFaction(factionCode).isClan() && (starUnits.size() != 5)) {\n+            return transportedUnits;\n+        }\n+        \n+        // logic copied from AtBScenario.addStar() to randomly determine if the given unit is actually going to be a nova\n+        // adjusted from 11/8 to 8/6 (distribution of novas in newest AtB doc is a lot higher) so that players actually encounter novas\n+        // whatever CBS is still gets no novas, so there\n+        int roll = Compute.d6(2);\n+        int novaTarget = 8;\n+        if (factionCode.equals(\"CHH\") || factionCode.equals(\"CSL\")) {\n+            novaTarget = 6;\n+        } else if (factionCode.equals(\"CBS\")) {\n+            novaTarget = 13;\n+        }\n+        \n+        if(roll < novaTarget) {\n+            return transportedUnits;\n+        }\n+        \n+        Entity actualTransport = null;\n+        for(Entity transport : starUnits) {", "originalCommit": "f362ee731419087c0e3dd3b89ae1c7048cd67946", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc2OTI0Mg==", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380769242", "bodyText": "Whoops, I wanted to put them on the fastest one.", "author": "apokrovski", "createdAt": "2020-02-18T16:02:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY1MDEzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAyNjAyOA==", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r381026028", "bodyText": "Looking at it again, actual transport is the \"current fastest\". If actualtransport.getMP is less than the currently evaluated transport.getMP, then the currently evaluated transport becomes the actual transport by virtue of being faster.", "author": "NickAragua", "createdAt": "2020-02-19T01:10:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY1MDEzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY1MDI4MQ==", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380650281", "bodyText": "Are we guaranteed transportedUnit is non-null?", "author": "sixlettervariables", "createdAt": "2020-02-18T12:48:10Z", "path": "MekHQ/src/mekhq/campaign/mission/AtBDynamicScenarioFactory.java", "diffHunk": "@@ -1099,6 +1108,64 @@ private static Entity generateTransportedBAUnit(UnitGeneratorParameters params,\n \n         return transportedUnits;\n     }\n+    \n+    /**\n+     * Worker function that generates a battle armor unit to attach to a unit of clan mechs\n+     */\n+    public static List<Entity> generateBAForNova(AtBScenario scenario, List<Entity> starUnits, String factionCode, int skill, int quality, Campaign campaign) {\n+        List<Entity> transportedUnits = new ArrayList<>();\n+        \n+        // determine if this should be a nova\n+        // if yes, then pick the fastest mech and load it up, adding the generated BA to the transport relationships.\n+        \n+        // non-clan forces and units that aren't stars don't become novas\n+        if(!Faction.getFaction(factionCode).isClan() && (starUnits.size() != 5)) {\n+            return transportedUnits;\n+        }\n+        \n+        // logic copied from AtBScenario.addStar() to randomly determine if the given unit is actually going to be a nova\n+        // adjusted from 11/8 to 8/6 (distribution of novas in newest AtB doc is a lot higher) so that players actually encounter novas\n+        // whatever CBS is still gets no novas, so there\n+        int roll = Compute.d6(2);\n+        int novaTarget = 8;\n+        if (factionCode.equals(\"CHH\") || factionCode.equals(\"CSL\")) {\n+            novaTarget = 6;\n+        } else if (factionCode.equals(\"CBS\")) {\n+            novaTarget = 13;\n+        }\n+        \n+        if(roll < novaTarget) {\n+            return transportedUnits;\n+        }\n+        \n+        Entity actualTransport = null;\n+        for(Entity transport : starUnits) {\n+            if(transport instanceof Mech && transport.isOmni()) {\n+                if((actualTransport == null) || (actualTransport.getWalkMP() < transport.getWalkMP())) {\n+                    actualTransport = transport;\n+                }\n+            }\n+        }\n+        \n+        if(actualTransport == null) {\n+            return transportedUnits;\n+        }\n+        \n+        // if we're generating a riding BA, do so now, then associate it with the designated transport\n+        UnitGeneratorParameters params = new UnitGeneratorParameters();\n+        params.setFaction(factionCode);\n+        params.setQuality(quality);\n+        params.setYear(campaign.getGameYear());\n+        params.addMissionRole(MissionRole.MECHANIZED_BA);\n+        params.setWeightClass(UNIT_WEIGHT_UNSPECIFIED);\n+\n+        Entity transportedUnit = generateTransportedBAUnit(params, IUnitGenerator.NO_WEIGHT_LIMIT, skill, campaign);\n+        transportedUnit.setDeployRound(actualTransport.getDeployRound());", "originalCommit": "f362ee731419087c0e3dd3b89ae1c7048cd67946", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc2OTQ1OA==", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380769458", "bodyText": "Probably not.", "author": "apokrovski", "createdAt": "2020-02-18T16:03:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY1MDI4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc4MTUwMA==", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380781500", "bodyText": "I'm pretty sure the logic or description here is flawed. A base target of 6 on 2d6 is 27.8% (just below 2/6) whereas a base target of 4 would be 16.7% (1/6) on 2d6.", "author": "Windchild292", "createdAt": "2020-02-18T16:20:48Z", "path": "MekHQ/src/mekhq/campaign/mission/AtBDynamicScenarioFactory.java", "diffHunk": "@@ -1310,6 +1463,36 @@ private static String adjustWeightsForFaction(String weights, String faction) {\n \n         return unitTypes;\n     }\n+    \n+    /**\n+     * Specialized logic for generating clan units\n+     * @return\n+     */\n+    private static List<Integer> generateClanUnitTypes(int unitCount, int forceQuality, String factionCode, Campaign campaign) {        \n+        // per AtB, we have a 1/6 odds of encountering a vehicle star\n+        // for fluff reasons, hell's horses + pals use more vehicles\n+        // higher-rated clan units become increasingly unlikely to use vehicles\n+        int vehicleTarget = 6;\n+        if(factionCode.equals(\"CHH\") || factionCode.equals(\"CSL\") || factionCode.equals(\"CBS\")) {\n+            vehicleTarget = 8;\n+        } else {\n+            vehicleTarget -= forceQuality;\n+        }\n+        \n+        // we randomly determine tank or mek\n+        int roll = Compute.d6(2); ", "originalCommit": "947b638f527e04ccad89dfbcb8f1d09d151b90a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc5Mjc2Nw==", "url": "https://github.com/MegaMek/mekhq/pull/1496#discussion_r380792767", "bodyText": "Unit quality theoretically ranges from 0 (F) to 5 (A*). For clans, that translates into \"backwater Solamha\" to \"front line elite\". The idea being that front line elites are too good for tanks (6 - 5 = 1 which is never on a 2d6) while dusty old warriors in the backwoods take what they can get (6 - 0 = 6+ which is sometimes). It's kind of a spitball thing. If it winds up not looking right, I'll adjust the odds going forward.\nAnyway, I'll update the description.", "author": "NickAragua", "createdAt": "2020-02-18T16:38:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc4MTUwMA=="}], "type": "inlineReview"}, {"oid": "4d0ee45f409490142c057b7600542d4ac804a588", "url": "https://github.com/MegaMek/mekhq/commit/4d0ee45f409490142c057b7600542d4ac804a588", "message": "code review fixes", "committedDate": "2020-02-19T01:16:33Z", "type": "commit"}, {"oid": "9967567c8cb4c2bd4a5aeeeeb4ccd682690deef0", "url": "https://github.com/MegaMek/mekhq/commit/9967567c8cb4c2bd4a5aeeeeb4ccd682690deef0", "message": "merge from upstream", "committedDate": "2020-02-19T01:22:42Z", "type": "commit"}]}