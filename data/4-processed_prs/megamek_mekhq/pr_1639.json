{"pr_number": 1639, "pr_title": "1218: Personnel Total Earnings", "pr_createdAt": "2020-04-07T15:46:19Z", "pr_url": "https://github.com/MegaMek/mekhq/pull/1639", "timeline": [{"oid": "b625cb0481b8f5ece0760d9cb17ccf18c08788fb", "url": "https://github.com/MegaMek/mekhq/commit/b625cb0481b8f5ece0760d9cb17ccf18c08788fb", "message": "Initial few lines of total earnings code", "committedDate": "2020-04-06T03:10:01Z", "type": "commit"}, {"oid": "e537c79e4d5cc839b2c5f00ca563386f4914661a", "url": "https://github.com/MegaMek/mekhq/commit/e537c79e4d5cc839b2c5f00ca563386f4914661a", "message": "Adding option to enable the tracking, and adding missing methods for Person", "committedDate": "2020-04-07T04:34:16Z", "type": "commit"}, {"oid": "3026dcfdc944f6f9423d8b65eaab2906a6faf632", "url": "https://github.com/MegaMek/mekhq/commit/3026dcfdc944f6f9423d8b65eaab2906a6faf632", "message": "Cleaning up financial methods while determining how to implement the payment tracking", "committedDate": "2020-04-07T13:52:28Z", "type": "commit"}, {"oid": "d122306d12de8a1293915388d5b92dd428da89df", "url": "https://github.com/MegaMek/mekhq/commit/d122306d12de8a1293915388d5b92dd428da89df", "message": "Cleaning up personnel shares while figuring out the implementation", "committedDate": "2020-04-07T14:06:41Z", "type": "commit"}, {"oid": "c4c966ed1c9f3a98675045e50c76d72232f380e9", "url": "https://github.com/MegaMek/mekhq/commit/c4c966ed1c9f3a98675045e50c76d72232f380e9", "message": "Adding functionality to payout the value of a share", "committedDate": "2020-04-07T14:25:42Z", "type": "commit"}, {"oid": "78becf98fb674954cf33dfceef4b6e1351d74285", "url": "https://github.com/MegaMek/mekhq/commit/78becf98fb674954cf33dfceef4b6e1351d74285", "message": "Adding salary payments to total earnings", "committedDate": "2020-04-07T14:43:58Z", "type": "commit"}, {"oid": "42643abf3d5452047adf4e829e6bb54973d4e853", "url": "https://github.com/MegaMek/mekhq/commit/42643abf3d5452047adf4e829e6bb54973d4e853", "message": "Merge remote-tracking branch 'upstream/master' into dev_Windchild_1218", "committedDate": "2020-04-07T15:27:43Z", "type": "commit"}, {"oid": "d4550990d3f41e4df0f1014c787c14cd36b99e20", "url": "https://github.com/MegaMek/mekhq/commit/d4550990d3f41e4df0f1014c787c14cd36b99e20", "message": "Fixing shares payment", "committedDate": "2020-04-07T15:29:29Z", "type": "commit"}, {"oid": "5c55ad76dc19bd63db911de1ab9fa72641c736d6", "url": "https://github.com/MegaMek/mekhq/commit/5c55ad76dc19bd63db911de1ab9fa72641c736d6", "message": "Fixing salary payment issues", "committedDate": "2020-04-07T15:43:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxNjAyMg==", "url": "https://github.com/MegaMek/mekhq/pull/1639#discussion_r404916022", "bodyText": "This is the new addition to track shares.", "author": "Windchild292", "createdAt": "2020-04-07T15:47:43Z", "path": "MekHQ/src/mekhq/campaign/finances/Finances.java", "diffHunk": "@@ -407,6 +391,43 @@ public void newDay(Campaign campaign) {\n         loans = newLoans;\n     }\n \n+\n+    private void payoutShares(Campaign campaign, Contract contract, GregorianCalendar calendar) {\n+        if (campaign.getCampaignOptions().getUseAtB() && campaign.getCampaignOptions().getUseShareSystem()\n+                && (contract instanceof AtBContract)) {\n+            Money shares = contract.getMonthlyPayOut().multipliedBy(((AtBContract) contract).getSharesPct())\n+                    .dividedBy(100);\n+            if (debit(shares, Transaction.C_SALARY,\n+                    String.format(resourceMap.getString(\"ContractSharePayment.text\"), contract.getName()),\n+                    calendar.getTime())) {\n+                campaign.addReport(String.format(resourceMap.getString(\"DistributedShares.text\"),\n+                        shares.toAmountAndSymbolString()));\n+\n+                if (campaign.getCampaignOptions().trackTotalEarnings()) {\n+                    int numberOfShares = 0;\n+                    boolean sharesForAll = campaign.getCampaignOptions().getSharesForAll();\n+                    for (Person person : campaign.getActivePersonnel()) {\n+                        numberOfShares += person.getNumShares(sharesForAll);\n+                    }\n+\n+                    Money singleShare = shares.dividedBy(numberOfShares);\n+                    for (Person person : campaign.getActivePersonnel()) {\n+                        person.payPersonShares(singleShare, sharesForAll);\n+                    }\n+                }", "originalCommit": "5c55ad76dc19bd63db911de1ab9fa72641c736d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4b20a2762738e92ae671fa88711574482f583902", "url": "https://github.com/MegaMek/mekhq/commit/4b20a2762738e92ae671fa88711574482f583902", "message": "Adding display for total earnings, and fixing the display order for ease of future changes", "committedDate": "2020-04-07T17:15:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5NTc1NA==", "url": "https://github.com/MegaMek/mekhq/pull/1639#discussion_r405195754", "bodyText": "This one seems like an \"if it ain't broke don't fix it\" scenario.", "author": "NickAragua", "createdAt": "2020-04-08T00:47:49Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -3755,24 +3755,18 @@ public Money getPayRoll() {\n     }\n \n     public Money getPayRoll(boolean noInfantry) {\n-        if(!campaignOptions.payForSalaries()) {\n+        if (getCampaignOptions().payForSalaries()) {", "originalCommit": "4b20a2762738e92ae671fa88711574482f583902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwODQ5MA==", "url": "https://github.com/MegaMek/mekhq/pull/1639#discussion_r405208490", "bodyText": "See the next one for my reasoning on the change.", "author": "Windchild292", "createdAt": "2020-04-08T01:35:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5NTc1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5NjA1Ng==", "url": "https://github.com/MegaMek/mekhq/pull/1639#discussion_r405196056", "bodyText": "Same here, not really sure of the point of rearranging the if block.", "author": "NickAragua", "createdAt": "2020-04-08T00:48:53Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -3806,11 +3800,11 @@ public Money getWeeklyMaintenanceCosts() {\n     }\n \n     public Money getOverheadExpenses() {\n-        if(!campaignOptions.payForOverhead()) {\n+        if (getCampaignOptions().payForOverhead()) {", "originalCommit": "4b20a2762738e92ae671fa88711574482f583902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwODIxMA==", "url": "https://github.com/MegaMek/mekhq/pull/1639#discussion_r405208210", "bodyText": "This is to prevent potential issues from the statement being false first and true second (I don't really care, but I've seen this result in bugs from lazy devs who didnt check for a false statement first more often than you'd expect)", "author": "Windchild292", "createdAt": "2020-04-08T01:34:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5NjA1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5NzkyMA==", "url": "https://github.com/MegaMek/mekhq/pull/1639#discussion_r405197920", "bodyText": "I think this method is going to require an explanation of the sharesForAll parameter. Also, I'm wondering if it'll be a little more efficient if we cache the results of all this logic. No need to store it permanently, just invalidate it when something happens to change the number of shares.", "author": "NickAragua", "createdAt": "2020-04-08T00:55:34Z", "path": "MekHQ/src/mekhq/campaign/personnel/Person.java", "diffHunk": "@@ -4309,37 +4362,33 @@ public void setOriginalUnit(Unit unit) {\n     }\n \n     public int getNumShares(boolean sharesForAll) {", "originalCommit": "4b20a2762738e92ae671fa88711574482f583902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxMjU1OA==", "url": "https://github.com/MegaMek/mekhq/pull/1639#discussion_r405212558", "bodyText": "Oh, it will be... but that's for a future PR (trying to keep features separate, and that is definitely a new internal feature). As for the comment, that has been added.", "author": "Windchild292", "createdAt": "2020-04-08T01:51:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5NzkyMA=="}], "type": "inlineReview"}, {"oid": "a8150fcee74cd8b0419261ae3c2a0a65f9979341", "url": "https://github.com/MegaMek/mekhq/commit/a8150fcee74cd8b0419261ae3c2a0a65f9979341", "message": "Fixing merge conflicts", "committedDate": "2020-04-08T01:47:08Z", "type": "commit"}, {"oid": "b3108bfc2e0be0493c39782a07fb4157d9c0398c", "url": "https://github.com/MegaMek/mekhq/commit/b3108bfc2e0be0493c39782a07fb4157d9c0398c", "message": "Adding comment describing sharesForAll", "committedDate": "2020-04-08T01:50:45Z", "type": "commit"}]}