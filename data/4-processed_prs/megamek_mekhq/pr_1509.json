{"pr_number": 1509, "pr_title": "Adding Monthly and Yearly Autosave Options", "pr_createdAt": "2020-02-21T19:59:50Z", "pr_url": "https://github.com/MegaMek/mekhq/pull/1509", "timeline": [{"oid": "56424fb0410cb5f230ca63dcb6d7bd024d207271", "url": "https://github.com/MegaMek/mekhq/commit/56424fb0410cb5f230ca63dcb6d7bd024d207271", "message": "Adding Monthly and Yearly autosave options", "committedDate": "2020-02-21T19:35:34Z", "type": "commit"}, {"oid": "a67ad05c522a8d45c274e767099bcf30cbb87cab", "url": "https://github.com/MegaMek/mekhq/commit/a67ad05c522a8d45c274e767099bcf30cbb87cab", "message": "Changing the base autosave index to 1 so that it makes more sense to non-programmers", "committedDate": "2020-02-21T19:50:17Z", "type": "commit"}, {"oid": "287b082c5fe655c6be953f7ea106301d506769d6", "url": "https://github.com/MegaMek/mekhq/commit/287b082c5fe655c6be953f7ea106301d506769d6", "message": "Adding a check to ensure the autosave file is deleted successfully and otherwise write it as an error to the logs", "committedDate": "2020-02-21T19:53:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc4MTg5OA==", "url": "https://github.com/MegaMek/mekhq/pull/1509#discussion_r382781898", "bodyText": "nit: whiteline", "author": "VicenteCartas", "createdAt": "2020-02-21T20:07:11Z", "path": "MekHQ/src/mekhq/service/AutosaveService.java", "diffHunk": "@@ -73,20 +82,33 @@ private boolean isWeeklyAutosaveEnabled() {\n         return this.userPreferences.getBoolean(MekHqConstants.SAVE_WEEKLY_KEY, false);\n     }\n \n+    private boolean isMonthlyAutosaveEnabled() {\n+        return this.userPreferences.getBoolean(MekHqConstants.SAVE_MONTHLY_KEY, false);\n+    }\n+\n+    private boolean isYearlyAutosaveEnabled() {\n+        return this.userPreferences.getBoolean(MekHqConstants.SAVE_YEARLY_KEY, false);\n+    }\n+\n     private boolean isMissionAutosaveEnabled() {\n         return this.userPreferences.getBoolean(MekHqConstants.SAVE_BEFORE_MISSIONS_KEY, false);\n     }\n \n     private void performAutosave(Campaign campaign) {\n         try {\n             String fileName = this.getAutosaveFilename(campaign);\n-\n-            try (FileOutputStream fos = new FileOutputStream(fileName);\n-                 GZIPOutputStream output = new GZIPOutputStream(fos)) {\n-                PrintWriter writer = new PrintWriter(new OutputStreamWriter(output, \"UTF-8\"));\n-                campaign.writeToXml(writer);\n-                writer.flush();\n-                writer.close();\n+            if (!StringUtil.isNullOrEmpty(fileName)) {\n+", "originalCommit": "287b082c5fe655c6be953f7ea106301d506769d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc4NTI5Mg==", "url": "https://github.com/MegaMek/mekhq/pull/1509#discussion_r382785292", "bodyText": "Whoops, fixed", "author": "Windchild292", "createdAt": "2020-02-21T20:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc4MTg5OA=="}], "type": "inlineReview"}, {"oid": "22e5df395c560692739a4daa7c79e5dc789f8a8d", "url": "https://github.com/MegaMek/mekhq/commit/22e5df395c560692739a4daa7c79e5dc789f8a8d", "message": "Removing accidental whitespace", "committedDate": "2020-02-21T20:15:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MTYyOQ==", "url": "https://github.com/MegaMek/mekhq/pull/1509#discussion_r382871629", "bodyText": "Seems like if you turned autosaveFiles into a map, you could get an O(1) run time here, rather than O(#files)", "author": "NickAragua", "createdAt": "2020-02-22T01:18:10Z", "path": "MekHQ/src/mekhq/service/AutosaveService.java", "diffHunk": "@@ -98,39 +119,51 @@ private String getAutosaveFilename(Campaign campaign) {\n         // Get all autosave files in ascending order of date creation\n         String savesDirectoryPath = MekHQ.getCampaignsDirectory().getValue();\n         File folder = new File(savesDirectoryPath);\n-        List<File> autosaveFiles = Arrays.stream(folder.listFiles())\n-                .filter(f -> f.getName().startsWith(\"Autosave-\"))\n-                .sorted(Comparator.comparing(f -> f.lastModified()))\n-                .collect(Collectors.toList());\n-\n-        // Delete older autosave files if needed\n-        int maxNumberAutosaves = this.userPreferences.getInt(MekHqConstants.MAXIMUM_NUMBER_SAVES_KEY, MekHqConstants.DEFAULT_NUMBER_SAVES);\n-        while (autosaveFiles.size() >= maxNumberAutosaves && autosaveFiles.size() > 0) {\n-            autosaveFiles.get(0).delete();\n-            autosaveFiles.remove(0);\n-        }\n+        File[] files = folder.listFiles();\n+        if (files != null) {\n+            List<File> autosaveFiles = Arrays.stream(files)\n+                    .filter(f -> f.getName().startsWith(\"Autosave-\"))\n+                    .sorted(Comparator.comparing(File::lastModified))\n+                    .collect(Collectors.toList());\n+\n+            // Delete older autosave files if needed\n+            int maxNumberAutosaves = this.userPreferences.getInt(MekHqConstants.MAXIMUM_NUMBER_SAVES_KEY,\n+                    MekHqConstants.DEFAULT_NUMBER_SAVES);\n+\n+            int index = 0;\n+            while (autosaveFiles.size() >= maxNumberAutosaves && autosaveFiles.size() > index) {\n+                if (autosaveFiles.get(index).delete()) {\n+                    autosaveFiles.remove(index);\n+                } else {\n+                    this.logger.error(this.getClass(), \"getAutosaveFilename\",\n+                            \"Unable to delete file \" + autosaveFiles.get(index).getName());\n+                    index++;\n+                }\n+            }\n \n-        // Find a unique name for this autosave\n-        String fileName = null;\n-\n-        boolean repeatedName = true;\n-        int index = 0;\n-        while (repeatedName) {\n-            fileName = String.format(\n-                    \"Autosave-%d-%s-%s.cpnx.gz\",\n-                    index++,\n-                    campaign.getName(),\n-                    campaign.getShortDateAsString());\n-\n-            repeatedName = false;\n-            for (File file : autosaveFiles) {\n-                if (file.getName().compareToIgnoreCase(fileName) == 0) {\n-                    repeatedName = true;\n-                    break;\n+            // Find a unique name for this autosave\n+            String fileName = null;\n+\n+            boolean repeatedName = true;\n+            index = 1;\n+            while (repeatedName) {\n+                fileName = String.format(\n+                        \"Autosave-%d-%s-%s.cpnx.gz\",\n+                        index++,\n+                        campaign.getName(),\n+                        campaign.getShortDateAsString());\n+\n+                repeatedName = false;\n+                for (File file : autosaveFiles) {", "originalCommit": "22e5df395c560692739a4daa7c79e5dc789f8a8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3Njg3OQ==", "url": "https://github.com/MegaMek/mekhq/pull/1509#discussion_r382876879", "bodyText": "Given an expected n of 5, I would expect it would actually be a performance drop to switch it out", "author": "Windchild292", "createdAt": "2020-02-22T02:10:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MTYyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5ODM3OQ==", "url": "https://github.com/MegaMek/mekhq/pull/1509#discussion_r383498379", "bodyText": "@NickAragua\nThoughts on the above?", "author": "Windchild292", "createdAt": "2020-02-24T20:32:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MTYyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwMjExMQ==", "url": "https://github.com/MegaMek/mekhq/pull/1509#discussion_r383502111", "bodyText": "I suppose it's unlikely that you'll encounter too many name overlaps like this. May as well leave it.", "author": "NickAragua", "createdAt": "2020-02-24T20:41:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MTYyOQ=="}], "type": "inlineReview"}]}