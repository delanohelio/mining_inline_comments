{"pr_number": 3298, "pr_title": "[DROOLS-5875] phreak groupby node", "pr_createdAt": "2020-12-22T11:53:34Z", "pr_url": "https://github.com/kiegroup/drools/pull/3298", "timeline": [{"oid": "d947f2d6e3eb531d6bec8e450778de7bf7adc93a", "url": "https://github.com/kiegroup/drools/commit/d947f2d6e3eb531d6bec8e450778de7bf7adc93a", "message": "[DROOLS-5875] phreak groupby node", "committedDate": "2020-12-23T16:45:15Z", "type": "commit"}, {"oid": "eb205d26425f1b14db72175332e358ee0a961124", "url": "https://github.com/kiegroup/drools/commit/eb205d26425f1b14db72175332e358ee0a961124", "message": "wip", "committedDate": "2020-12-23T16:45:15Z", "type": "commit"}, {"oid": "8164a93406590e410478b7417026549641cd87a5", "url": "https://github.com/kiegroup/drools/commit/8164a93406590e410478b7417026549641cd87a5", "message": "wip", "committedDate": "2020-12-23T16:45:15Z", "type": "commit"}, {"oid": "1eb47481847e388b683f84cb00dffd1883c4136e", "url": "https://github.com/kiegroup/drools/commit/1eb47481847e388b683f84cb00dffd1883c4136e", "message": "wip", "committedDate": "2020-12-23T16:45:15Z", "type": "commit"}, {"oid": "fe796b3e0209a4a946e715e0203791011ae44de6", "url": "https://github.com/kiegroup/drools/commit/fe796b3e0209a4a946e715e0203791011ae44de6", "message": "add support for multi function groupBy", "committedDate": "2020-12-23T16:45:16Z", "type": "commit"}, {"oid": "ad39eb61763fed2dc332835b5b17702d2e733161", "url": "https://github.com/kiegroup/drools/commit/ad39eb61763fed2dc332835b5b17702d2e733161", "message": "wip", "committedDate": "2020-12-23T16:45:16Z", "type": "commit"}, {"oid": "9ba1eaa74dba321fef1b99c0acc93e9e6ada83e3", "url": "https://github.com/kiegroup/drools/commit/9ba1eaa74dba321fef1b99c0acc93e9e6ada83e3", "message": "wip", "committedDate": "2020-12-23T16:45:16Z", "type": "commit"}, {"oid": "7470aec6152e58a5ac7af21f0b316bea321a75ed", "url": "https://github.com/kiegroup/drools/commit/7470aec6152e58a5ac7af21f0b316bea321a75ed", "message": "wip", "committedDate": "2020-12-23T16:45:16Z", "type": "commit"}, {"oid": "e8880b63a7d244f500e6244b67ccdd3fde12ec0a", "url": "https://github.com/kiegroup/drools/commit/e8880b63a7d244f500e6244b67ccdd3fde12ec0a", "message": "wip", "committedDate": "2020-12-23T16:45:16Z", "type": "commit"}, {"oid": "aa41ef509536ad92b0c6ad638a06c150bd357aa7", "url": "https://github.com/kiegroup/drools/commit/aa41ef509536ad92b0c6ad638a06c150bd357aa7", "message": "wip", "committedDate": "2020-12-23T16:45:16Z", "type": "commit"}, {"oid": "353e8136509e1490cf367d863d89bb9b1dda3895", "url": "https://github.com/kiegroup/drools/commit/353e8136509e1490cf367d863d89bb9b1dda3895", "message": "wip", "committedDate": "2020-12-23T16:45:16Z", "type": "commit"}, {"oid": "51e733a1201d078ddf91b734476f8d90fe9320d3", "url": "https://github.com/kiegroup/drools/commit/51e733a1201d078ddf91b734476f8d90fe9320d3", "message": "2 groupbys failing test case", "committedDate": "2020-12-23T16:45:16Z", "type": "commit"}, {"oid": "58ac4f0b370c98b3a63605c3dcc7bff1895c744b", "url": "https://github.com/kiegroup/drools/commit/58ac4f0b370c98b3a63605c3dcc7bff1895c744b", "message": "wip", "committedDate": "2020-12-23T16:45:16Z", "type": "commit"}, {"oid": "c372587e1c97062bda592fa2f1f156068cf4e1e4", "url": "https://github.com/kiegroup/drools/commit/c372587e1c97062bda592fa2f1f156068cf4e1e4", "message": "-Accumulate no longer needs a reverse map.", "committedDate": "2020-12-23T16:45:16Z", "type": "commit"}, {"oid": "93713b9c50be48122a46a6603b72f5d9c483e6b3", "url": "https://github.com/kiegroup/drools/commit/93713b9c50be48122a46a6603b72f5d9c483e6b3", "message": "-GroupbyTest works except for for the test with two group bys", "committedDate": "2020-12-23T16:45:16Z", "type": "commit"}, {"oid": "bba1d55b20c6d1ff631d9012d9309410e2bfa5c3", "url": "https://github.com/kiegroup/drools/commit/bba1d55b20c6d1ff631d9012d9309410e2bfa5c3", "message": "wip", "committedDate": "2020-12-23T16:45:16Z", "type": "commit"}, {"oid": "3f7f49e9b990e682a122f25088a8af43cba97c9f", "url": "https://github.com/kiegroup/drools/commit/3f7f49e9b990e682a122f25088a8af43cba97c9f", "message": "wip", "committedDate": "2020-12-23T16:45:16Z", "type": "commit"}, {"oid": "4f5921653f93e7ce81dc8f777a65fdf8923bc41c", "url": "https://github.com/kiegroup/drools/commit/4f5921653f93e7ce81dc8f777a65fdf8923bc41c", "message": "wip", "committedDate": "2020-12-23T16:58:27Z", "type": "commit"}, {"oid": "4f5921653f93e7ce81dc8f777a65fdf8923bc41c", "url": "https://github.com/kiegroup/drools/commit/4f5921653f93e7ce81dc8f777a65fdf8923bc41c", "message": "wip", "committedDate": "2020-12-23T16:58:27Z", "type": "forcePushed"}, {"oid": "1f3ebaba648c733c1d4825f68413d3ee89b98909", "url": "https://github.com/kiegroup/drools/commit/1f3ebaba648c733c1d4825f68413d3ee89b98909", "message": "fix nested groupby", "committedDate": "2020-12-24T10:26:23Z", "type": "commit"}, {"oid": "ac95c7fee48fa9aa563bfcfa789addca97199406", "url": "https://github.com/kiegroup/drools/commit/ac95c7fee48fa9aa563bfcfa789addca97199406", "message": "wip", "committedDate": "2020-12-29T09:25:14Z", "type": "commit"}, {"oid": "a8a04f37cb5565124f7799837bab8862ee9726c8", "url": "https://github.com/kiegroup/drools/commit/a8a04f37cb5565124f7799837bab8862ee9726c8", "message": "remove 3-rules based implementation for GroupBy", "committedDate": "2020-12-29T16:01:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4ODQ2Mw==", "url": "https://github.com/kiegroup/drools/pull/3298#discussion_r549788463", "bodyText": "Want to leave this here?", "author": "triceo", "createdAt": "2020-12-29T17:33:05Z", "path": "drools-core/src/main/java/org/drools/core/common/LeftTupleIterator.java", "diffHunk": "@@ -76,7 +76,7 @@ public void setFirstLeftTupleForNode() {\n     public LeftTuple getFirstLeftTuple(LeftTupleSource source,\n                                        LeftTupleSink sink,\n                                        InternalWorkingMemory wm) {\n-        if ( source instanceof AccumulateNode ) {\n+        if ( source instanceof AccumulateNode ) { // TODO WHAT ABOUTGROUPBY ? (mdp)", "originalCommit": "a8a04f37cb5565124f7799837bab8862ee9726c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA4NjE5MA==", "url": "https://github.com/kiegroup/drools/pull/3298#discussion_r550086190", "bodyText": "This is used only for session serialization and at the moment groupby doesn't fully support it. I believe that since the GroupByNode extends the Accumulate one and not much is changed on this regard this should work as it is, but I'd need to write some test to prove this.", "author": "mariofusco", "createdAt": "2020-12-30T09:40:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4ODQ2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4OTMxMg==", "url": "https://github.com/kiegroup/drools/pull/3298#discussion_r549789312", "bodyText": "Want to leave this here?", "author": "triceo", "createdAt": "2020-12-29T17:35:57Z", "path": "drools-core/src/main/java/org/drools/core/phreak/PhreakAccumulateNode.java", "diffHunk": "@@ -577,14 +576,14 @@ public void doRightDeletes(AccumulateNode accNode,\n                         LeftTuple nextLeft = match.getRightParentNext();\n \n                         LeftTuple leftTuple = match.getLeftParent();\n-                        final AccumulateContext accctx = (AccumulateContext) leftTuple.getContextObject();\n+                        final BaseAccumulation accctx = (BaseAccumulation) leftTuple.getContextObject();\n+                        // FIXME This will be really slow, if it re-accumulates on the same LeftTuple (MDP)", "originalCommit": "a8a04f37cb5565124f7799837bab8862ee9726c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA4NzIyMg==", "url": "https://github.com/kiegroup/drools/pull/3298#discussion_r550087222", "bodyText": "This is an inefficiency that was preexisting to the introduction of the GroupByNode. I'm discussing with Mark how to improve this, but there's nothing that prevents the merging of this PR.", "author": "mariofusco", "createdAt": "2020-12-30T09:42:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4OTMxMg=="}], "type": "inlineReview"}, {"oid": "4007d604f95c2b7d2a782b47bda1a07017070b66", "url": "https://github.com/kiegroup/drools/commit/4007d604f95c2b7d2a782b47bda1a07017070b66", "message": "restore getObjectsDeep functionality", "committedDate": "2021-01-04T10:24:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgxNjg2NQ==", "url": "https://github.com/kiegroup/drools/pull/3298#discussion_r551816865", "bodyText": "I'm not sure I understood this comment", "author": "lucamolteni", "createdAt": "2021-01-05T09:35:56Z", "path": "drools-model/drools-model-compiler/src/test/java/org/drools/modelcompiler/GroupByTest.java", "diffHunk": "@@ -171,16 +175,22 @@ public void testGroupPersonsInitial() throws Exception {\n \n         Variable<String> var_$key = D.declarationOf(String.class);\n         Variable<Person> var_$p = D.declarationOf(Person.class);\n+        Variable<List> var_$list = D.declarationOf(List.class);\n \n         Rule rule1 = D.rule(\"R1\").build(\n                 D.groupBy(\n                         // Patterns\n                         D.pattern(var_$p),\n                         // Grouping Function\n-                        var_$p, var_$key, person -> person.getName().substring(0, 1)),\n+                        var_$p, var_$key, person -> person.getName().substring(0, 1)//,\n+                        //D.accFunction(org.drools.core.base.accumulators.CollectListAccumulateFunction::new, var_$p).as(var_$list)", "originalCommit": "4007d604f95c2b7d2a782b47bda1a07017070b66", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "55a7effbbd856a1250b8d3a1dcfc4e4f67808ecf", "url": "https://github.com/kiegroup/drools/commit/55a7effbbd856a1250b8d3a1dcfc4e4f67808ecf", "message": "remove misleading comment", "committedDate": "2021-01-05T10:55:13Z", "type": "commit"}]}