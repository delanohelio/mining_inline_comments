{"pr_number": 3263, "pr_title": "DROOLS-5848 : CallMethod with ActionFieldFunctions does not compile", "pr_createdAt": "2020-11-24T15:23:35Z", "pr_url": "https://github.com/kiegroup/drools/pull/3263", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM0NTQxNA==", "url": "https://github.com/kiegroup/drools/pull/3263#discussion_r534345414", "bodyText": "Shouldn't we use DataType.TYPE_VOID? Or isn't this the return type of the method add ?", "author": "jomarko", "createdAt": "2020-12-02T17:22:14Z", "path": "drools-workbench-models/drools-workbench-models-guided-dtable/src/test/java/org/drools/workbench/models/guided/dtable/backend/BRLRuleModelTest.java", "diffHunk": "@@ -1227,6 +1228,52 @@ public void testActionCallIsNotIgnored() {\n                                      drl);\n     }\n \n+    @Test\n+    public void testActionCallMethodWithActionFieldFunction() {\n+        final GuidedDecisionTable52 dt = new GuidedDecisionTable52();\n+\n+        final Pattern52 p1 = new Pattern52();\n+        p1.setBoundName(\"x\");\n+        p1.setFactType(\"Context\");\n+\n+        final ConditionCol52 c = new ConditionCol52();\n+        c.setConstraintValueType(BaseSingleFieldConstraint.TYPE_LITERAL);\n+        p1.getChildColumns().add(c);\n+        dt.getConditions().add(p1);\n+\n+        final BRLActionColumn brlAction1 = new BRLActionColumn();\n+        final ActionCallMethod actionCallMethod = new ActionCallMethod(\"x\");\n+        actionCallMethod.setState(ActionCallMethod.TYPE_DEFINED);\n+        actionCallMethod.setMethodName(\"add\");\n+        actionCallMethod.addFieldValue(new ActionFieldFunction(\"name\",\n+                                                               \"Toni\",\n+                                                               DataType.TYPE_STRING));\n+\n+        brlAction1.getDefinition().add(actionCallMethod);\n+        brlAction1.getChildColumns().add(new BRLActionVariableColumn(\"\",\n+                                                                     DataType.TYPE_BOOLEAN,", "originalCommit": "59eee42bdef14a1177d5e1eaf03896703ba0e495", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "049ede75d7a2f05fb99d146f2795e8b246f23a55", "url": "https://github.com/kiegroup/drools/commit/049ede75d7a2f05fb99d146f2795e8b246f23a55", "message": "DROOLS-5848 : CallMethod with ActionFieldFunctions does not compile", "committedDate": "2020-12-04T09:06:03Z", "type": "commit"}, {"oid": "049ede75d7a2f05fb99d146f2795e8b246f23a55", "url": "https://github.com/kiegroup/drools/commit/049ede75d7a2f05fb99d146f2795e8b246f23a55", "message": "DROOLS-5848 : CallMethod with ActionFieldFunctions does not compile", "committedDate": "2020-12-04T09:06:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk0NTIxMA==", "url": "https://github.com/kiegroup/drools/pull/3263#discussion_r535945210", "bodyText": "@jomarko The problem with the old fix was that this line was never added to the DRL.\nThe problem appears when there is ActionCallMethod in a BRL before Set or Update column that is not BRL. The two columns use the same fact variable, so when searching by name the ActionCallMethod is found and we try to append the set/update to that. We should just ignore the call.", "author": "Rikkola", "createdAt": "2020-12-04T09:09:27Z", "path": "drools-workbench-models/drools-workbench-models-guided-dtable/src/test/java/org/drools/workbench/models/guided/dtable/backend/BRLRuleModelTest.java", "diffHunk": "@@ -1227,6 +1228,58 @@ public void testActionCallIsNotIgnored() {\n                                      drl);\n     }\n \n+    @Test\n+    public void testActionCallMethodWithActionFieldFunction() {\n+        final GuidedDecisionTable52 dt = new GuidedDecisionTable52();\n+\n+        final Pattern52 p1 = new Pattern52();\n+        p1.setBoundName(\"x\");\n+        p1.setFactType(\"Context\");\n+\n+        final ConditionCol52 c = new ConditionCol52();\n+        c.setConstraintValueType(BaseSingleFieldConstraint.TYPE_LITERAL);\n+        p1.getChildColumns().add(c);\n+        dt.getConditions().add(p1);\n+\n+        final BRLActionColumn brlAction1 = new BRLActionColumn();\n+        final ActionCallMethod actionCallMethod = new ActionCallMethod(\"x\");\n+        actionCallMethod.setState(ActionCallMethod.TYPE_DEFINED);\n+        actionCallMethod.setMethodName(\"add\");\n+        actionCallMethod.addFieldValue(new ActionFieldFunction(\"name\",\n+                                                               \"Toni\",\n+                                                               DataType.TYPE_STRING));\n+\n+        brlAction1.getDefinition().add(actionCallMethod);\n+        brlAction1.getChildColumns().add(new BRLActionVariableColumn(\"\",\n+                                                                     DataType.TYPE_BOOLEAN,\n+                                                                     null,\n+                                                                     null));\n+        dt.getActionCols().add(brlAction1);\n+        ActionSetFieldCol52 set = new ActionSetFieldCol52();\n+        set.setBoundName(\"x\");\n+        set.setFactField(\"name\");\n+\n+        dt.getActionCols().add(set);\n+\n+        dt.setData(DataUtilities.makeDataLists(new Object[][]{\n+                new Object[]{\"1\", \"\", \"desc\", \"x\", true, \"ToniR\"}\n+        }));\n+        final String drl = GuidedDTDRLPersistence.getInstance().marshal(dt);\n+        final String expected = \"//from row number: 1\\n\" +\n+                \"//desc\\n\" +\n+                \"rule \\\"Row 1 null\\\"\\n\" +\n+                \"dialect \\\"mvel\\\"\\n\" +\n+                \"when\\n\" +\n+                \"  x : Context( )\\n\" +\n+                \"then\\n\" +\n+                \"  x.add( \\\"Toni\\\" );\\n\" +\n+                \"  x.setName( \\\"ToniR\\\" );\\n\" +", "originalCommit": "049ede75d7a2f05fb99d146f2795e8b246f23a55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7bd862a906ecd6bacb18224971c0c5669dc71535", "url": "https://github.com/kiegroup/drools/commit/7bd862a906ecd6bacb18224971c0c5669dc71535", "message": "DROOLS-5848: Extend coverage", "committedDate": "2020-12-07T09:52:12Z", "type": "commit"}]}