{"pr_number": 3117, "pr_title": "[DROOLS-5367] Avoid needs of kmodule.xml during kiepmmlmodel generation/instantiation", "pr_createdAt": "2020-09-21T14:53:53Z", "pr_url": "https://github.com/kiegroup/drools/pull/3117", "timeline": [{"oid": "4123c30626b8cc1de1f95856501bb8b1902b3153", "url": "https://github.com/kiegroup/drools/commit/4123c30626b8cc1de1f95856501bb8b1902b3153", "message": "[DROOLS-5367] Updating tests", "committedDate": "2020-09-21T08:28:23Z", "type": "commit"}, {"oid": "314ab9c45618dbe75ead1e5ac08c58b14863887a", "url": "https://github.com/kiegroup/drools/commit/314ab9c45618dbe75ead1e5ac08c58b14863887a", "message": "Merge remote-tracking branch 'origin/master' into DROOLS-5367", "committedDate": "2020-09-21T08:28:51Z", "type": "commit"}, {"oid": "4a78478bccd0e36821c4ca4356b8f692a0c3d63c", "url": "https://github.com/kiegroup/drools/commit/4a78478bccd0e36821c4ca4356b8f692a0c3d63c", "message": "[DROOLS-5367] Implemented PMMLRuntimeFactory", "committedDate": "2020-09-21T14:07:38Z", "type": "commit"}, {"oid": "a8e7064a7abf62bbc1746774fa239b8f68547694", "url": "https://github.com/kiegroup/drools/commit/a8e7064a7abf62bbc1746774fa239b8f68547694", "message": "[DROOLS-5367] Implemented common AbstractPMMLTest to be extended by all PMML integration tests. Refactored PMML integration tests. Removed all kmodule.xml", "committedDate": "2020-09-21T14:48:41Z", "type": "commit"}, {"oid": "1dfcb74568f1062f7495785a63e2448f4cbe47db", "url": "https://github.com/kiegroup/drools/commit/1dfcb74568f1062f7495785a63e2448f4cbe47db", "message": "[DROOLS-5367] Cleanup", "committedDate": "2020-09-21T15:32:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU2MzYyNQ==", "url": "https://github.com/kiegroup/drools/pull/3117#discussion_r492563625", "bodyText": "One question. It seems that \"kie-pmml-models-tests\" is an util module for all other tests. Does it make sense to put its abstract classes to \"test\" folder? I think it would be much easier to put these utils into main folder. We can avoid of usage of classifiers etc. I expect there will be no functionality for users in this module.", "author": "jiripetrlik", "createdAt": "2020-09-22T08:35:18Z", "path": "kie-pmml-trusty/kie-pmml-models/kie-pmml-models-regression/kie-pmml-models-regression-tests/pom.xml", "diffHunk": "@@ -30,6 +30,13 @@\n       <groupId>commons-io</groupId>\n       <artifactId>commons-io</artifactId>\n     </dependency>\n+    <!-- TEST -->\n+    <dependency>\n+      <groupId>org.kie</groupId>\n+      <artifactId>kie-pmml-models-tests</artifactId>\n+      <classifier>tests</classifier>", "originalCommit": "1dfcb74568f1062f7495785a63e2448f4cbe47db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYxMzk4OA==", "url": "https://github.com/kiegroup/drools/pull/3117#discussion_r492613988", "bodyText": "@jiripetrlik\nFine for me, going to refactor", "author": "gitgabrio", "createdAt": "2020-09-22T09:58:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU2MzYyNQ=="}], "type": "inlineReview"}, {"oid": "d2d837d056bd527da771c0cdeb5ed6f4fd28a22b", "url": "https://github.com/kiegroup/drools/commit/d2d837d056bd527da771c0cdeb5ed6f4fd28a22b", "message": "[DROOLS-5367] Moved AbstractPMMLTest to java directory. Refactored PMMLRuntimeFactory to accept a File as parameter", "committedDate": "2020-09-22T10:21:31Z", "type": "commit"}, {"oid": "6462f9b582136565cd563d2654ce0f84d6e8c9a7", "url": "https://github.com/kiegroup/drools/commit/6462f9b582136565cd563d2654ce0f84d6e8c9a7", "message": "[DROOLS-5367] Defined HasRule interface", "committedDate": "2020-09-23T11:15:24Z", "type": "commit"}, {"oid": "653714f0d8deeb6ed1a0e3a26583d775c1a7c42e", "url": "https://github.com/kiegroup/drools/commit/653714f0d8deeb6ed1a0e3a26583d775c1a7c42e", "message": "[DROOLS-5367] Implemented predictable PKGUUID. Moved common methods to org.drools.core.util.StringUtils", "committedDate": "2020-09-23T11:17:46Z", "type": "commit"}, {"oid": "769c590fcb4d65e9169289e454083c4678a91005", "url": "https://github.com/kiegroup/drools/commit/769c590fcb4d65e9169289e454083c4678a91005", "message": "[DROOLS-5367] Add ReleaseId public getter to KnowledgeBuilderImpl", "committedDate": "2020-09-23T11:18:30Z", "type": "commit"}, {"oid": "e15b8a7e22a6e673e185ef924b558322cc11b510", "url": "https://github.com/kiegroup/drools/commit/e15b8a7e22a6e673e185ef924b558322cc11b510", "message": "[DROOLS-5367] Manage missing packageName inside JavaParserUtils", "committedDate": "2020-09-23T11:18:58Z", "type": "commit"}, {"oid": "2e48ab0e052714d87d1601b01c8d4ab5c146c4bc", "url": "https://github.com/kiegroup/drools/commit/2e48ab0e052714d87d1601b01c8d4ab5c146c4bc", "message": "[DROOLS-5367] Defined assSourceMap method inside HasSourcesMap", "committedDate": "2020-09-23T11:19:59Z", "type": "commit"}, {"oid": "25efe855791182e6b5f5b5f0fc717ffbc92db2cc", "url": "https://github.com/kiegroup/drools/commit/25efe855791182e6b5f5b5f0fc717ffbc92db2cc", "message": "[DROOLS-5367] Defined PMMLRuleMapper/PMMLRuleMappers with codegen factories, templates and tests", "committedDate": "2020-09-23T11:21:24Z", "type": "commit"}, {"oid": "dff20b46cc2f587bce526ee416a473acd9c30f6e", "url": "https://github.com/kiegroup/drools/commit/dff20b46cc2f587bce526ee416a473acd9c30f6e", "message": "[DROOLS-5367] Overloaded PMMLRuntimeFactory.getPMMLRuntime to accept ReleaseId", "committedDate": "2020-09-23T11:22:37Z", "type": "commit"}, {"oid": "996b4b03a04ea3439661c4d71344c1ae77dcccd1", "url": "https://github.com/kiegroup/drools/commit/996b4b03a04ea3439661c4d71344c1ae77dcccd1", "message": "[DROOLS-5367] Add needed dependency on drools-canonical-model", "committedDate": "2020-09-23T11:23:09Z", "type": "commit"}, {"oid": "1871bf27ba094a3af135178ec195197c9005edb6", "url": "https://github.com/kiegroup/drools/commit/1871bf27ba094a3af135178ec195197c9005edb6", "message": "[DROOLS-5367] Creating/populating PMMLRuleMappers inside PMMLCompilerService", "committedDate": "2020-09-23T11:24:13Z", "type": "commit"}, {"oid": "c02939550bae66b06c4966ec2be0fe371601e7a6", "url": "https://github.com/kiegroup/drools/commit/c02939550bae66b06c4966ec2be0fe371601e7a6", "message": "[DROOLS-5367] Populating KnowledgeBuilderImpl with \"Model\" at load time", "committedDate": "2020-09-23T14:09:14Z", "type": "commit"}, {"oid": "81db00d3d04c0ecf543c46d8d9b8d2b957bf066b", "url": "https://github.com/kiegroup/drools/commit/81db00d3d04c0ecf543c46d8d9b8d2b957bf066b", "message": "[DROOLS-5367] Cleanup", "committedDate": "2020-09-23T14:10:22Z", "type": "commit"}, {"oid": "f787e7d5f2b968afe09082d39f552aa906c83747", "url": "https://github.com/kiegroup/drools/commit/f787e7d5f2b968afe09082d39f552aa906c83747", "message": "[DROOLS-5367] Implemented optional use of pre-generated PkgUUID", "committedDate": "2020-09-24T10:50:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI1MzU0NQ==", "url": "https://github.com/kiegroup/drools/pull/3117#discussion_r494253545", "bodyText": "Make the new field serializable adding it to readExternal/writeExternal methods.", "author": "mariofusco", "createdAt": "2020-09-24T11:53:58Z", "path": "drools-compiler/src/main/java/org/drools/compiler/lang/descr/PackageDescr.java", "diffHunk": "@@ -52,6 +53,7 @@\n     private Set<EntryPointDeclarationDescr> entryPointDeclarations = Collections.emptySet();\n     private Set<WindowDeclarationDescr>     windowDeclarations     = Collections.emptySet();\n     private List<EnumDeclarationDescr>      enumDeclarations       = Collections.emptyList();\n+    private String preferredPkgUUID;", "originalCommit": "f787e7d5f2b968afe09082d39f552aa906c83747", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aaf32b6e801de5682ca4835d615ac2dffa4dd2b8", "url": "https://github.com/kiegroup/drools/commit/aaf32b6e801de5682ca4835d615ac2dffa4dd2b8", "message": "[DROOLS-5367] Add tests", "committedDate": "2020-09-24T16:56:50Z", "type": "commit"}, {"oid": "e76609c97e116dac8ab25594a8d778ee69d54084", "url": "https://github.com/kiegroup/drools/commit/e76609c97e116dac8ab25594a8d778ee69d54084", "message": "[DROOLS-5367] Minor fixes for Kogito integration. Add tests", "committedDate": "2020-09-25T10:29:58Z", "type": "commit"}, {"oid": "76c9d4a3fe0ba60cc025d2f0466cce97935978e1", "url": "https://github.com/kiegroup/drools/commit/76c9d4a3fe0ba60cc025d2f0466cce97935978e1", "message": "Merge remote-tracking branch 'origin/master' into DROOLS-5367\n\n# Conflicts:\n#\tkie-pmml-trusty/kie-pmml-models/kie-pmml-models-mining/kie-pmml-models-mining-tests/src/test/java/org/kie/pmml/mining/tests/SegmentationMajorityVoteMiningTest.java", "committedDate": "2020-09-30T12:35:56Z", "type": "commit"}, {"oid": "d1088e84b0e85db98b2fa44f99b18d9868dbdacb", "url": "https://github.com/kiegroup/drools/commit/d1088e84b0e85db98b2fa44f99b18d9868dbdacb", "message": "[DROOLS-5367] Merge with master", "committedDate": "2020-10-01T10:38:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg1MzI2Mw==", "url": "https://github.com/kiegroup/drools/pull/3117#discussion_r496853263", "bodyText": "Can you please add an assertion?", "author": "danielezonca", "createdAt": "2020-09-29T16:04:46Z", "path": "drools-compiler/src/test/java/org/drools/compiler/lang/descr/CompositePackageDescrTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.drools.compiler.lang.descr;\n+\n+import org.drools.core.io.impl.ByteArrayResource;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import static org.drools.core.util.StringUtils.generateUUID;\n+\n+public class CompositePackageDescrTest {\n+\n+    private static final String NAMESPACE = \"namespace\";\n+    private  CompositePackageDescr compositePackageDescr;\n+\n+    @Before\n+    public void setup() {\n+        compositePackageDescr = new CompositePackageDescr(new ByteArrayResource(), new PackageDescr(NAMESPACE));\n+    }\n+\n+    @Test\n+    public void addPackageDescrSamePkgUUID() {\n+        String pkgUUID = generateUUID();\n+        PackageDescr toAdd = new PackageDescr(NAMESPACE);\n+        toAdd.setPreferredPkgUUID(pkgUUID);\n+        compositePackageDescr.addPackageDescr(new ByteArrayResource(), toAdd);\n+        toAdd = new PackageDescr(NAMESPACE);\n+        toAdd.setPreferredPkgUUID(pkgUUID);\n+        compositePackageDescr.addPackageDescr(new ByteArrayResource(), toAdd);", "originalCommit": "e76609c97e116dac8ab25594a8d778ee69d54084", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY5MzY2Mg==", "url": "https://github.com/kiegroup/drools/pull/3117#discussion_r498693662", "bodyText": "@danielezonca\ndone", "author": "gitgabrio", "createdAt": "2020-10-02T08:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg1MzI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg4ODcyNA==", "url": "https://github.com/kiegroup/drools/pull/3117#discussion_r496888724", "bodyText": "There are 2 <!-- EXTERNAL --> and btw what about add scope test to all the dependencies of this module?", "author": "danielezonca", "createdAt": "2020-09-29T16:46:21Z", "path": "kie-pmml-trusty/kie-pmml-models/kie-pmml-models-drools/kie-pmml-models-drools-tree/kie-pmml-models-drools-tree-tests/pom.xml", "diffHunk": "@@ -66,6 +71,10 @@\n       <scope>test</scope>\n     </dependency>\n     <!-- EXTERNAL -->\n+    <dependency>\n+      <groupId>org.slf4j</groupId>\n+      <artifactId>slf4j-simple</artifactId>", "originalCommit": "e76609c97e116dac8ab25594a8d778ee69d54084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE5NDQyMw==", "url": "https://github.com/kiegroup/drools/pull/3117#discussion_r498194423", "bodyText": "What about a private static class instead of this method? Just to avoid to create an anonymous inner class for every test", "author": "danielezonca", "createdAt": "2020-10-01T12:10:29Z", "path": "drools-core/src/test/java/org/drools/core/util/StringUtilsTest.java", "diffHunk": "@@ -247,4 +251,71 @@ public void test_indexOfOutOfQuotes() {\n         assertEquals(8, indexOfOutOfQuotes(\"bla\\\"bla\\\"bla\", \"bla\", 1));\n         assertEquals(-1, indexOfOutOfQuotes(\"bla\\\"bla\\\"bla\", \"bla\", 9));\n     }\n+\n+    @Test\n+    public void getPkgUUIDFromReleaseIdNotNullNotSnapshot() {\n+        ReleaseId releaseId = getReleaseId(false);\n+        String packageName = \"apackage\";\n+        String retrieved = getPkgUUID(releaseId, packageName);\n+        String expected = md5Hash(releaseId.toString()+packageName);\n+        assertEquals(expected, retrieved);\n+    }\n+\n+    @Test\n+    public void getPkgUUIDFromReleaseIdNotNullSnapshot() {\n+        ReleaseId releaseId = getReleaseId(true);\n+        String packageName = \"apackage\";\n+        String retrieved = getPkgUUID(releaseId, packageName);\n+        String unexpected = md5Hash(releaseId.toString()+packageName);\n+        assertNotEquals(unexpected, retrieved);\n+    }\n+\n+    @Test\n+    public void getPkgUUIDFromReleaseIdNull() {\n+        ReleaseId releaseId = null;\n+        String packageName = \"apackage\";\n+        String retrieved = getPkgUUID(releaseId, packageName);\n+        assertNotNull(retrieved);\n+    }\n+\n+    @Test\n+    public void getPkgUUIDFromGAV() {\n+        String gav = \"group:artifact:version\";\n+        String packageName = \"apackage\";\n+        String retrieved = getPkgUUID(gav, packageName);\n+        String expected = md5Hash(gav+packageName);\n+        assertEquals(expected, retrieved);\n+    }\n+\n+\n+    private ReleaseId getReleaseId(boolean isSnapshot) {\n+        return new ReleaseId() {\n+            final boolean snapshot = isSnapshot;\n+\n+            @Override\n+            public String getGroupId() {\n+                return \"group\";\n+            }\n+\n+            @Override\n+            public String getArtifactId() {\n+                return \"artifact\";\n+            }\n+\n+            @Override\n+            public String getVersion() {\n+                return \"version\";\n+            }\n+\n+            @Override\n+            public String toExternalForm() {\n+                return \"externalForm\";\n+            }\n+\n+            @Override\n+            public boolean isSnapshot() {\n+                return snapshot;\n+            }\n+        };\n+    }", "originalCommit": "d1088e84b0e85db98b2fa44f99b18d9868dbdacb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY5NTA5Ng==", "url": "https://github.com/kiegroup/drools/pull/3117#discussion_r498695096", "bodyText": "@danielezonca\ndone", "author": "gitgabrio", "createdAt": "2020-10-02T08:49:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE5NDQyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIyNDI1OA==", "url": "https://github.com/kiegroup/drools/pull/3117#discussion_r498224258", "bodyText": "This class should be moved to a more \"public\" module like some -api module. Wdyt?", "author": "danielezonca", "createdAt": "2020-10-01T12:59:24Z", "path": "kie-pmml-trusty/kie-pmml-evaluator/kie-pmml-evaluator-assembler/src/main/java/org/kie/pmml/evaluator/assembler/factories/PMMLRuntimeFactory.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.pmml.evaluator.assembler.factories;\n+\n+import java.io.File;\n+\n+import org.drools.compiler.builder.impl.KnowledgeBuilderImpl;\n+import org.drools.core.RuleBaseConfiguration;\n+import org.drools.core.impl.InternalKnowledgeBase;\n+import org.drools.core.impl.KnowledgeBaseFactory;\n+import org.drools.core.io.impl.FileSystemResource;\n+import org.kie.api.KieBase;\n+import org.kie.api.builder.ReleaseId;\n+import org.kie.api.io.ResourceType;\n+import org.kie.api.runtime.KieRuntimeFactory;\n+import org.kie.internal.builder.KnowledgeBuilderFactory;\n+import org.kie.pmml.evaluator.api.executor.PMMLRuntime;\n+import org.kie.pmml.evaluator.assembler.service.PMMLAssemblerService;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * <b>Factory</b> class to hide implementation details to end user\n+ */\n+public class PMMLRuntimeFactory {", "originalCommit": "d1088e84b0e85db98b2fa44f99b18d9868dbdacb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY5MzQ1MQ==", "url": "https://github.com/kiegroup/drools/pull/3117#discussion_r498693451", "bodyText": "@danielezonca\nThis would require moving other classes to API. I agree, but I would prefer to do that in the \"clean up api\" ticket https://issues.redhat.com/browse/DROOLS-5688", "author": "gitgabrio", "createdAt": "2020-10-02T08:46:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIyNDI1OA=="}], "type": "inlineReview"}, {"oid": "13559757bd0901573bc442c087bb71296c3d40d1", "url": "https://github.com/kiegroup/drools/commit/13559757bd0901573bc442c087bb71296c3d40d1", "message": "Merge remote-tracking branch 'origin/master' into DROOLS-5367\n\n# Conflicts:\n#\tdrools-mvel/src/test/java/org/drools/mvel/compiler/lang/descr/PackageDescrTest.java", "committedDate": "2020-10-02T08:25:33Z", "type": "commit"}, {"oid": "72d4415a05e3a76f2c777aedc6137a7a9c5c48c6", "url": "https://github.com/kiegroup/drools/commit/72d4415a05e3a76f2c777aedc6137a7a9c5c48c6", "message": "[DROOLS-5367] Fixed as per PR suggestion", "committedDate": "2020-10-02T10:22:13Z", "type": "commit"}, {"oid": "c96ad1e3336ded604682293bab2a4754636e106c", "url": "https://github.com/kiegroup/drools/commit/c96ad1e3336ded604682293bab2a4754636e106c", "message": "[DROOLS-5367] Add PMML type to GeneratedFile", "committedDate": "2020-10-02T16:04:08Z", "type": "commit"}]}