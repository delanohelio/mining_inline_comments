{"pr_number": 866, "pr_title": "issue #833 - add db2 migration test and fix issues", "pr_createdAt": "2020-03-30T16:51:58Z", "pr_url": "https://github.com/IBM/FHIR/pull/866", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0NDIwOA==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400344208", "bodyText": "wasn't sure whether to use the same build.yml or introduce new one for this", "author": "lmsurpre", "createdAt": "2020-03-30T16:52:53Z", "path": ".github/workflows/build.yml", "diffHunk": "@@ -266,3 +266,57 @@ jobs:\n       with:\n         name: integration-test-results-db2-${{ matrix.java }}\n         path: integration-test-results\n+db2-migration:", "originalCommit": "39f864b54e2ee4af55559ddecb04d81f804110f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0NTE0MQ==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400345141", "bodyText": "this script is much like pre-integration-test-docker.sh except it calls a modified copy-dependencies script that downloads a previous schema cli jar instead of taking the newly built one from fhir-persistence-schema/target", "author": "lmsurpre", "createdAt": "2020-03-30T16:54:12Z", "path": "build/pre-migration-test-docker.sh", "diffHunk": "@@ -0,0 +1,103 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+###############################################################################\n+set -ex\n+\n+echo \"Preparing environment for fhir-server integration tests...\"\n+if [[ -z \"${WORKSPACE}\" ]]; then\n+    echo \"ERROR: WORKSPACE environment variable not set!\"\n+    exit 2\n+fi\n+\n+# Set up installers and config files where docker processing can see them\n+cd ${WORKSPACE}/fhir-install/docker\n+./copy-dependencies-db2-migration.sh", "originalCommit": "39f864b54e2ee4af55559ddecb04d81f804110f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0NTk2NA==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400345964", "bodyText": "this will overwrite the \"previous version\" of the schema cli jar with the newly built one", "author": "lmsurpre", "createdAt": "2020-03-30T16:55:26Z", "path": "build/pre-migration-test-docker.sh", "diffHunk": "@@ -0,0 +1,103 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+###############################################################################\n+set -ex\n+\n+echo \"Preparing environment for fhir-server integration tests...\"\n+if [[ -z \"${WORKSPACE}\" ]]; then\n+    echo \"ERROR: WORKSPACE environment variable not set!\"\n+    exit 2\n+fi\n+\n+# Set up installers and config files where docker processing can see them\n+cd ${WORKSPACE}/fhir-install/docker\n+./copy-dependencies-db2-migration.sh\n+./copy-test-operations.sh\n+\n+# Stand up a docker container running the fhir server configured for integration tests\n+echo \"Bringing down any fhir server containers that might already be running as a precaution\"\n+docker-compose kill\n+docker-compose rm -f\n+\n+echo \"Bringing up db2... be patient, this will take a minute\"\n+docker-compose build --pull db2\n+docker-compose up -d db2\n+echo \">>> Current time: \" $(date)\n+\n+# TODO wait for it to be healthy instead of just Sleeping\n+(docker-compose logs --timestamps --follow db2 & P=$! && sleep 100 && kill $P)\n+\n+\n+echo \"Deploying the Db2 schema...\"\n+./deploySchemaAndTenant.sh\n+\n+echo \"Migrating the schema to the latest version...\"\n+./copy-dependencies-db2.sh", "originalCommit": "39f864b54e2ee4af55559ddecb04d81f804110f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e8e849065b496af41907f306298abbde2a1833da", "url": "https://github.com/IBM/FHIR/commit/e8e849065b496af41907f306298abbde2a1833da", "message": "issue #833 - add db2 migration test and fix issues\n\nIntroduced variant of e2e-db2 test for testing migration which:\n1. creates a db2 instance and deploys the previous version of the schema\n2. runs migration\n3. executes the e2e tests\n\nThis uncovered a couple different issues with our existing migrations:\n1. `DB2 SQL Error: SQLCODE=-2310, SQLSTATE=     , SQLERRMC=-668`\n    while executing runstats after dropping a column\n2. `DB2 SQL Error: SQLCODE=-108, SQLSTATE=42601,\nSQLERRMC=FK_OBSERVATION_COMPOSITES_DATE`\n    while executing DropForeignKeyConstraint\n3. `DB2 SQL Error: SQLCODE=-204, SQLSTATE=42704,\nSQLERRMC=FK_OBSERVATION_COMPOSITES_DATE`\n    while executing DropForeignKeyConstraint\n\nFor number 1, the fix was to avoid executing RUNSTATS until after the\ntable with the dropped column has been REORGed.\n\nFor number 2, the fix was to stop qualifying the constraintName with the\nschema name.\n\nFor number 3, the fix was to avoid hard-coding Observation in the FK\nnames being dropped.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-30T16:57:21Z", "type": "commit"}, {"oid": "e8e849065b496af41907f306298abbde2a1833da", "url": "https://github.com/IBM/FHIR/commit/e8e849065b496af41907f306298abbde2a1833da", "message": "issue #833 - add db2 migration test and fix issues\n\nIntroduced variant of e2e-db2 test for testing migration which:\n1. creates a db2 instance and deploys the previous version of the schema\n2. runs migration\n3. executes the e2e tests\n\nThis uncovered a couple different issues with our existing migrations:\n1. `DB2 SQL Error: SQLCODE=-2310, SQLSTATE=     , SQLERRMC=-668`\n    while executing runstats after dropping a column\n2. `DB2 SQL Error: SQLCODE=-108, SQLSTATE=42601,\nSQLERRMC=FK_OBSERVATION_COMPOSITES_DATE`\n    while executing DropForeignKeyConstraint\n3. `DB2 SQL Error: SQLCODE=-204, SQLSTATE=42704,\nSQLERRMC=FK_OBSERVATION_COMPOSITES_DATE`\n    while executing DropForeignKeyConstraint\n\nFor number 1, the fix was to avoid executing RUNSTATS until after the\ntable with the dropped column has been REORGed.\n\nFor number 2, the fix was to stop qualifying the constraintName with the\nschema name.\n\nFor number 3, the fix was to avoid hard-coding Observation in the FK\nnames being dropped.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-30T16:57:21Z", "type": "forcePushed"}, {"oid": "268f41b7af57b00dc9c327aad16ad8196ac9c836", "url": "https://github.com/IBM/FHIR/commit/268f41b7af57b00dc9c327aad16ad8196ac9c836", "message": "Move \"copy-test-operations\" later in pre-test scripts\n\nIn the migration one, we were removing everything in the \"volumes\"\nfolder which wiped out this dir.\n\nAlso fixed formatting error in .github/workflows/build.yml\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-30T18:43:56Z", "type": "forcePushed"}, {"oid": "b44502e9b636086e35ed7fc7660f194920e5248a", "url": "https://github.com/IBM/FHIR/commit/b44502e9b636086e35ed7fc7660f194920e5248a", "message": "Move \"copy-test-operations\" later in pre-test scripts\n\nIn the migration one, we were removing everything in the \"volumes\"\nfolder which wiped out this dir.\n\nAlso fixed formatting error in .github/workflows/build.yml\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-30T19:21:09Z", "type": "forcePushed"}, {"oid": "d17578614003258e00c531bf3b9aa86552d5451b", "url": "https://github.com/IBM/FHIR/commit/d17578614003258e00c531bf3b9aa86552d5451b", "message": "Move \"copy-test-operations\" later in pre-test scripts\n\nIn the migration one, we were removing everything in the \"volumes\"\nfolder which wiped out this dir.\n\nAlso fixed formatting error in .github/workflows/build.yml\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-30T19:29:04Z", "type": "forcePushed"}, {"oid": "932c8360c57147dcb6680fc9ed7ba2b48cdeecab", "url": "https://github.com/IBM/FHIR/commit/932c8360c57147dcb6680fc9ed7ba2b48cdeecab", "message": "Move \"copy-test-operations\" later in pre-test scripts\n\nIn the migration one, we were removing everything in the \"volumes\"\nfolder which wiped out this dir.\n\nAlso fixed formatting error in .github/workflows/build.yml, switched to\njdk8 to improve speed, and renamed the logs to avoid conflict with\n`e2e-db2` results\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-30T20:04:17Z", "type": "commit"}, {"oid": "932c8360c57147dcb6680fc9ed7ba2b48cdeecab", "url": "https://github.com/IBM/FHIR/commit/932c8360c57147dcb6680fc9ed7ba2b48cdeecab", "message": "Move \"copy-test-operations\" later in pre-test scripts\n\nIn the migration one, we were removing everything in the \"volumes\"\nfolder which wiped out this dir.\n\nAlso fixed formatting error in .github/workflows/build.yml, switched to\njdk8 to improve speed, and renamed the logs to avoid conflict with\n`e2e-db2` results\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-30T20:04:17Z", "type": "forcePushed"}, {"oid": "03bb893fc4acedeb3b1d89ccb469133de9a0261b", "url": "https://github.com/IBM/FHIR/commit/03bb893fc4acedeb3b1d89ccb469133de9a0261b", "message": "Set reduced poolsize from deploySchemaAndTenant.sh\n\nIn PR #841 we reduced the default to 1 in order to avoid issue #845\nbut the db2-migration-test is pulling down an older version with a\npool-size of 80 and so we were hitting intermittent deadlocks.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-30T20:34:53Z", "type": "commit"}, {"oid": "03bb893fc4acedeb3b1d89ccb469133de9a0261b", "url": "https://github.com/IBM/FHIR/commit/03bb893fc4acedeb3b1d89ccb469133de9a0261b", "message": "Set reduced poolsize from deploySchemaAndTenant.sh\n\nIn PR #841 we reduced the default to 1 in order to avoid issue #845\nbut the db2-migration-test is pulling down an older version with a\npool-size of 80 and so we were hitting intermittent deadlocks.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-30T20:34:53Z", "type": "forcePushed"}, {"oid": "66cd850024d41b3aa39549f2251a9399f93af902", "url": "https://github.com/IBM/FHIR/commit/66cd850024d41b3aa39549f2251a9399f93af902", "message": "Update permission after updating tables\n\nWithout this, db2 was failing on updates and deletes with errors like:\n> DB2 SQL Error: SQLCODE=-5188, SQLSTATE=560D0,\n> SQLERRMC=FHIRDATA.MEDICATION_NUMBER_VALUES_TENANT;PERMISSION`\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-30T22:23:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NDczOQ==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400574739", "bodyText": "Is the purpose of this change to make it possible to run grant access multiple times for the same tenant?", "author": "albertwang-ibm", "createdAt": "2020-03-31T00:34:36Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/api/IDatabaseAdapter.java", "diffHunk": "@@ -185,7 +185,7 @@ public void createIndex(String schemaName, String tableName, String indexName, S\n      * @param tableName\n      * @param predicate\n      */\n-    public void createPermission(String schemaName, String permissionName, String tableName, String predicate);\n+    public void createOrReplacePermission(String schemaName, String permissionName, String tableName, String predicate);", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYxMzQyMw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400613423", "bodyText": "no, its so that we can call it after updating the table (e.g. adding or removing columns).\ni found that without calling createOrReplacePermission after adjusting the table, then db2 would complain about the permission.", "author": "lmsurpre", "createdAt": "2020-03-31T02:57:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NDczOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg4OTMyMw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400889323", "bodyText": "ha, this is really interesting finding! I don't know this before, I thought we don't use column access control, so should not have to ...", "author": "albertwang-ibm", "createdAt": "2020-03-31T12:54:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NDczOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NjAwMw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400576003", "bodyText": "are you going to make db2 migration test part of the pipeline? seems it's only needed if there is any new db schema version available ...  and are you going to cover the migration path from all the previous versions to the current version ...", "author": "albertwang-ibm", "createdAt": "2020-03-31T00:39:10Z", "path": ".github/workflows/build.yml", "diffHunk": "@@ -266,3 +266,56 @@ jobs:\n       with:\n         name: integration-test-results-db2-${{ matrix.java }}\n         path: integration-test-results\n+  db2-migration:\n+    runs-on: ubuntu-latest\n+    strategy:\n+      matrix:\n+        java: [ 'openjdk8' ]\n+      fail-fast: false\n+    steps:\n+    - uses: actions/checkout@v2\n+    - name: Set up OpenJDK\n+      uses: joschi/setup-jdk@v1\n+      with:\n+        java-version: ${{ matrix.java }}\n+    - name: Build samples\n+      run: mvn -B install --file fhir-examples --no-transfer-progress\n+    - name: Build parent without tests\n+      run: |\n+        mvn -B install --file fhir-parent -DskipTests -P integration --no-transfer-progress\n+    - name: Server Integration Tests\n+      env:\n+        # debian-based linux uses C.UTF-8 by default and Derby doesn't like that\n+        LC_ALL: en_US.UTF-8\n+      run: |\n+        export WORKSPACE=${GITHUB_WORKSPACE}\n+        build/db2-migration-test-docker.sh\n+        mvn -B test -DskipTests=false -f fhir-server-test -DskipWebSocketTest=true --no-transfer-progress\n+        build/post-integration-test-docker.sh\n+    - name: Gather error logs\n+      if: failure()\n+      run: |\n+        it_results=integration-test-results\n+        rm -fr ${it_results} 2>/dev/null\n+        mkdir -p ${it_results}/server-logs\n+        mkdir -p ${it_results}/fhir-server-test\n+        containerId=$(docker ps -a | grep fhir | cut -d ' ' -f 1)\n+        if [[ -z \"${containerId}\" ]]; then\n+            echo \"Warning: Could not find fhir container!!!\"\n+        else\n+            echo \"fhir container id: $containerId\"\n+\n+            # Grab the container's console log\n+            docker logs $containerId  >& ${it_results}/docker-console.txt\n+\n+            echo \"Gathering post-test server logs from docker container: $containerId\"\n+            docker cp -L $containerId:/logs ${it_results}/server-logs\n+        fi\n+        echo \"Gathering integration test output\"\n+        cp -pr ${GITHUB_WORKSPACE}/fhir-server-test/target/surefire-reports/* ${it_results}/fhir-server-test\n+    - name: Upload logs\n+      if: always()\n+      uses: actions/upload-artifact@master\n+      with:\n+        name: db2-migration-test-results-${{ matrix.java }}\n+        path: integration-test-results", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYxMzcxMQ==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400613711", "bodyText": "for now, I just wanted to get db2 migration tests into the pipeline...we can add smarts about selectively running it in the future", "author": "lmsurpre", "createdAt": "2020-03-31T02:58:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NjAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYxMzg1Mw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400613853", "bodyText": "without this, then there is no way to know if the migrations you wrote actually work with db2", "author": "lmsurpre", "createdAt": "2020-03-31T02:59:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NjAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxMDUzMA==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400810530", "bodyText": "at a minimum the code would have to run with any downstream dependency changes (database-utils/model)", "author": "prb112", "createdAt": "2020-03-31T10:35:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NjAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NzM5NQ==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400577395", "bodyText": "which version of the schema is used here? version 1?", "author": "albertwang-ibm", "createdAt": "2020-03-31T00:44:00Z", "path": "build/db2-migration-test-docker.sh", "diffHunk": "@@ -0,0 +1,102 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+###############################################################################\n+set -ex\n+\n+echo \"Preparing environment for fhir-server integration tests...\"\n+if [[ -z \"${WORKSPACE}\" ]]; then\n+    echo \"ERROR: WORKSPACE environment variable not set!\"\n+    exit 2\n+fi\n+\n+# Set up installers and config files where docker processing can see them\n+cd ${WORKSPACE}/fhir-install/docker\n+./copy-dependencies-db2-migration.sh\n+\n+# Stand up a docker container running the fhir server configured for integration tests\n+echo \"Bringing down any fhir server containers that might already be running as a precaution\"\n+docker-compose kill\n+docker-compose rm -f\n+\n+echo \"Bringing up db2... be patient, this will take a minute\"\n+docker-compose build --pull db2\n+docker-compose up -d db2\n+echo \">>> Current time: \" $(date)\n+\n+# TODO wait for it to be healthy instead of just Sleeping\n+(docker-compose logs --timestamps --follow db2 & P=$! && sleep 100 && kill $P)\n+\n+echo \"Deploying the Db2 schema...\"\n+./deploySchemaAndTenant.sh\n+", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYxNDM1NQ==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400614355", "bodyText": "the deploySchemaAndTenant script will actually work with any version of the cli jar; in this case its running with the version added there by copy-dependencies-db2-migration.sh which happens to be SCHEMA_VERSION=\"4.0.1\"", "author": "lmsurpre", "createdAt": "2020-03-31T03:00:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NzM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3Nzc2Ng==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400577766", "bodyText": "can this script can always (and only) upgrade version 1 to the latest version?", "author": "albertwang-ibm", "createdAt": "2020-03-31T00:45:15Z", "path": "build/db2-migration-test-docker.sh", "diffHunk": "@@ -0,0 +1,102 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+###############################################################################\n+set -ex\n+\n+echo \"Preparing environment for fhir-server integration tests...\"\n+if [[ -z \"${WORKSPACE}\" ]]; then\n+    echo \"ERROR: WORKSPACE environment variable not set!\"\n+    exit 2\n+fi\n+\n+# Set up installers and config files where docker processing can see them\n+cd ${WORKSPACE}/fhir-install/docker\n+./copy-dependencies-db2-migration.sh\n+\n+# Stand up a docker container running the fhir server configured for integration tests\n+echo \"Bringing down any fhir server containers that might already be running as a precaution\"\n+docker-compose kill\n+docker-compose rm -f\n+\n+echo \"Bringing up db2... be patient, this will take a minute\"\n+docker-compose build --pull db2\n+docker-compose up -d db2\n+echo \">>> Current time: \" $(date)\n+\n+# TODO wait for it to be healthy instead of just Sleeping\n+(docker-compose logs --timestamps --follow db2 & P=$! && sleep 100 && kill $P)\n+\n+echo \"Deploying the Db2 schema...\"\n+./deploySchemaAndTenant.sh\n+\n+\n+echo \"Bringing up the FHIR server... be patient, this will take a minute\"\n+./copy-test-operations.sh\n+docker-compose build --pull fhir\n+docker-compose up -d fhir\n+echo \">>> Current time: \" $(date)\n+\n+echo \"Migrating the schema to the latest version...\"\n+./copy-dependencies-db2.sh\n+./updateSchema.sh", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYxNjcyNQ==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400616725", "bodyText": "the updateSchema script is just invoking the fhir-persistence-schema-*-cli.jar --update-schema action with whatever version of that jar happens to be in the ${SCHEMA} dir.\nso, first we execute copy-dependencies-db2.sh to put the just built version there, then we run the script...the effect is that it will run update-schema with the \"latest version\" and invoke any migration steps from the code in the process.", "author": "lmsurpre", "createdAt": "2020-03-31T03:09:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3Nzc2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU4OTA2Nw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400589067", "bodyText": "great catch! seems we have never noticed this before!!", "author": "albertwang-ibm", "createdAt": "2020-03-31T01:26:09Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/control/FhirResourceTableGroup.java", "diffHunk": "@@ -679,12 +679,12 @@ public void addComposites(List<IDatabaseObject> group, String prefix) {\n                 }\n \n                 statements.add(new DropForeignKeyConstraint(schemaName, tableName,\n-                        \"FK_OBSERVATION_COMPOSITES_DATE\",\n-                        \"FK_OBSERVATION_COMPOSITES_LATLNG\",\n-                        \"FK_OBSERVATION_COMPOSITES_NUMBER\",\n-                        \"FK_OBSERVATION_COMPOSITES_QUANTITY\",\n-                        \"FK_OBSERVATION_COMPOSITES_STR\",\n-                        \"FK_OBSERVATION_COMPOSITES_TOKEN\"));\n+                        FK + tableName + _STR,\n+                        FK + tableName + _NUMBER,\n+                        FK + tableName + _DATE,\n+                        FK + tableName + _TOKEN,\n+                        FK + tableName + _QUANTITY,\n+                        FK + tableName + _LATLNG));", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5NDQzMw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400594433", "bodyText": "and it could be nicer if we can keep the order for the FKs - still from _D to _T", "author": "albertwang-ibm", "createdAt": "2020-03-31T01:45:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU4OTA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYxNDg2OA==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400614868", "bodyText": "i didn't quite follow the order comment; i reordered these so that the order matches the order in the statements above it (in the same method)...did you want something different?", "author": "lmsurpre", "createdAt": "2020-03-31T03:02:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU4OTA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5MTcxNw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400891717", "bodyText": "I mean in the original codes, they are alphabet ordered.", "author": "albertwang-ibm", "createdAt": "2020-03-31T12:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU4OTA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5MDcxMw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400590713", "bodyText": "make a lot sense, as I remember, most of the alter table operations requires reorg before the table is really usable ... otherwise it will always show reorg pending error for sql ...", "author": "albertwang-ibm", "createdAt": "2020-03-31T01:31:26Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/db2/Db2Adapter.java", "diffHunk": "@@ -456,12 +456,10 @@ public void runStatement(IDatabaseStatement stmt) {\n \n             String qname = ((DropColumn) stmt).getSchemaName() + \".\" + ((DropColumn) stmt).getTableName();\n \n-            Db2AdminCommand runstats = new Db2AdminCommand(\"RUNSTATS ON TABLE \" + qname + \" WITH DISTRIBUTION AND DETAILED INDEXES ALL\");\n-            super.runStatement(runstats);\n-\n             String reorgCommand = \"REORG TABLE \" + qname;\n             super.runStatement(new Db2AdminCommand(reorgCommand));\n \n+            Db2AdminCommand runstats = new Db2AdminCommand(\"RUNSTATS ON TABLE \" + qname + \" WITH DISTRIBUTION AND DETAILED INDEXES ALL\");", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5MTc0OA==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400591748", "bodyText": "this does remember me of one question, should we force all db connections to drop first before we run reorg during migration?", "author": "albertwang-ibm", "createdAt": "2020-03-31T01:34:51Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/db2/Db2Reorg.java", "diffHunk": "@@ -16,6 +16,10 @@\n \n /**\n  * Reorg the schema.table\n+ *\n+ * Be sure to complete all database operations and release all locks before you invoke REORG.\n+ * @see <a href=\"https://www.ibm.com/support/knowledgecenter/SSEPGG_11.5.0/com.ibm.db2.luw.admin.cmd.doc/doc/r0001966.html\">\n+ *      https://www.ibm.com/support/knowledgecenter/SSEPGG_11.5.0/com.ibm.db2.luw.admin.cmd.doc/doc/r0001966.html</a>", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYxNTM1Nw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400615357", "bodyText": "this is an excellent question.  the migration seems to work now without that.  my biggest concern is that calling the reorg command is actually committing the migrations under the covers because that would break our \"do all the migrations within a single transaction\" model.\nstill, i'd prefer to punt on that one for now so we can get this in for 4.1.0...maybe open it as a separate issue?", "author": "lmsurpre", "createdAt": "2020-03-31T03:04:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5MTc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMDkyMw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400820923", "bodyText": "I think we should probably add to the documentation stating that.", "author": "prb112", "createdAt": "2020-03-31T10:55:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5MTc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5NTYwNw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400895607", "bodyText": "which documentation.  i did add it here in the javadoc but not in the readme", "author": "lmsurpre", "createdAt": "2020-03-31T13:04:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5MTc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkzOTE2NQ==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400939165", "bodyText": "I was thinking to the design considerations in Db2MultitenantSchema... Essentially what we discussed is 'offline' updates.", "author": "prb112", "createdAt": "2020-03-31T14:03:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5MTc0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE2ODczNA==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r401168734", "bodyText": "I updated the doc", "author": "lmsurpre", "createdAt": "2020-03-31T19:42:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5MTc0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxMDg2Nw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400810867", "bodyText": "I wonder if this is necessary in Db2. No fix necessary... just an outloud discussion.", "author": "prb112", "createdAt": "2020-03-31T10:36:35Z", "path": ".github/workflows/build.yml", "diffHunk": "@@ -266,3 +266,56 @@ jobs:\n       with:\n         name: integration-test-results-db2-${{ matrix.java }}\n         path: integration-test-results\n+  db2-migration:\n+    runs-on: ubuntu-latest\n+    strategy:\n+      matrix:\n+        java: [ 'openjdk8' ]\n+      fail-fast: false\n+    steps:\n+    - uses: actions/checkout@v2\n+    - name: Set up OpenJDK\n+      uses: joschi/setup-jdk@v1\n+      with:\n+        java-version: ${{ matrix.java }}\n+    - name: Build samples\n+      run: mvn -B install --file fhir-examples --no-transfer-progress\n+    - name: Build parent without tests\n+      run: |\n+        mvn -B install --file fhir-parent -DskipTests -P integration --no-transfer-progress\n+    - name: Server Integration Tests\n+      env:\n+        # debian-based linux uses C.UTF-8 by default and Derby doesn't like that\n+        LC_ALL: en_US.UTF-8", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkzNjY5NQ==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400936695", "bodyText": "probably not....will remove and find out :-)", "author": "lmsurpre", "createdAt": "2020-03-31T14:00:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxMDg2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk1MzQ3NQ==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400953475", "bodyText": "done", "author": "lmsurpre", "createdAt": "2020-03-31T14:21:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxMDg2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxMTc4Mg==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400811782", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # (C) Copyright IBM Corp. 2016, 2020\n          \n          \n            \n            # (C) Copyright IBM Corp. 2020\n          \n      \n    \n    \n  \n\nisn't this just 2020", "author": "prb112", "createdAt": "2020-03-31T10:38:07Z", "path": "build/db2-migration-test-docker.sh", "diffHunk": "@@ -0,0 +1,102 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxMjI3NA==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400812274", "bodyText": "you could probably map this in env to be consistent with the prior step", "author": "prb112", "createdAt": "2020-03-31T10:39:03Z", "path": ".github/workflows/build.yml", "diffHunk": "@@ -266,3 +266,56 @@ jobs:\n       with:\n         name: integration-test-results-db2-${{ matrix.java }}\n         path: integration-test-results\n+  db2-migration:\n+    runs-on: ubuntu-latest\n+    strategy:\n+      matrix:\n+        java: [ 'openjdk8' ]\n+      fail-fast: false\n+    steps:\n+    - uses: actions/checkout@v2\n+    - name: Set up OpenJDK\n+      uses: joschi/setup-jdk@v1\n+      with:\n+        java-version: ${{ matrix.java }}\n+    - name: Build samples\n+      run: mvn -B install --file fhir-examples --no-transfer-progress\n+    - name: Build parent without tests\n+      run: |\n+        mvn -B install --file fhir-parent -DskipTests -P integration --no-transfer-progress\n+    - name: Server Integration Tests\n+      env:\n+        # debian-based linux uses C.UTF-8 by default and Derby doesn't like that\n+        LC_ALL: en_US.UTF-8\n+      run: |\n+        export WORKSPACE=${GITHUB_WORKSPACE}", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkzNzkwOQ==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400937909", "bodyText": "its set this way in all the jobs in this build.yml\nI think I had some issue setting it from the env section, but I really don't remember...will leave as-is unless you want it changed", "author": "lmsurpre", "createdAt": "2020-03-31T14:01:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxMjI3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxMzg4NA==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400813884", "bodyText": "these lines are duplicate of other scripts. perhaps refactoring into an imported script is best?", "author": "prb112", "createdAt": "2020-03-31T10:42:15Z", "path": "build/db2-migration-test-docker.sh", "diffHunk": "@@ -0,0 +1,102 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+###############################################################################\n+set -ex\n+\n+echo \"Preparing environment for fhir-server integration tests...\"\n+if [[ -z \"${WORKSPACE}\" ]]; then\n+    echo \"ERROR: WORKSPACE environment variable not set!\"\n+    exit 2\n+fi\n+\n+# Set up installers and config files where docker processing can see them\n+cd ${WORKSPACE}/fhir-install/docker\n+./copy-dependencies-db2-migration.sh\n+\n+# Stand up a docker container running the fhir server configured for integration tests\n+echo \"Bringing down any fhir server containers that might already be running as a precaution\"\n+docker-compose kill\n+docker-compose rm -f\n+\n+echo \"Bringing up db2... be patient, this will take a minute\"\n+docker-compose build --pull db2\n+docker-compose up -d db2\n+echo \">>> Current time: \" $(date)\n+\n+# TODO wait for it to be healthy instead of just Sleeping\n+(docker-compose logs --timestamps --follow db2 & P=$! && sleep 100 && kill $P)\n+\n+echo \"Deploying the Db2 schema...\"\n+./deploySchemaAndTenant.sh\n+\n+\n+echo \"Bringing up the FHIR server... be patient, this will take a minute\"\n+./copy-test-operations.sh\n+docker-compose build --pull fhir\n+docker-compose up -d fhir\n+echo \">>> Current time: \" $(date)\n+\n+echo \"Migrating the schema to the latest version...\"\n+./copy-dependencies-db2.sh\n+./updateSchema.sh\n+\n+# TODO wait for it to be healthy instead of just Sleeping\n+(docker-compose logs --timestamps --follow fhir & P=$! && sleep 60 && kill $P)\n+\n+# Gather up all the server logs so we can trouble-shoot any problems during startup\n+cd -\n+pre_it_logs=${WORKSPACE}/pre-it-logs\n+zip_file=${WORKSPACE}/pre-it-logs.zip\n+rm -fr ${pre_it_logs} 2>/dev/null\n+mkdir -p ${pre_it_logs}\n+rm -f ${zip_file}\n+\n+echo \"\n+Docker container status:\"\n+docker ps -a\n+\n+containerId=$(docker ps -a | grep fhir | cut -d ' ' -f 1)\n+if [[ -z \"${containerId}\" ]]; then\n+    echo \"Warning: Could not find the fhir container!!!\"\n+else\n+    echo \"fhir container id: $containerId\"\n+\n+    # Grab the container's console log\n+    docker logs $containerId  >& ${pre_it_logs}/docker-console.txt\n+\n+    echo \"Gathering pre-test server logs from docker container: $containerId\"\n+    docker cp -L $containerId:/opt/ol/wlp/usr/servers/fhir-server/logs ${pre_it_logs}\n+\n+    echo \"Zipping up pre-test server logs\"\n+    zip -r ${zip_file} ${pre_it_logs}\n+fi\n+\n+# Wait until the fhir server is up and running...\n+echo \"Waiting for fhir-server to complete initialization...\"\n+healthcheck_url='https://localhost:9443/fhir-server/api/v4/$healthcheck'\n+tries=0\n+status=0\n+while [ $status -ne 200 -a $tries -lt 3 ]; do\n+    tries=$((tries + 1))\n+    cmd=\"curl -k -o ${WORKSPACE}/health.json -I -w \"%{http_code}\" -u fhiruser:change-password $healthcheck_url\"\n+    echo \"Executing[$tries]: $cmd\"\n+    status=$($cmd)\n+    echo \"Status code: $status\"\n+    if [ $status -ne 200 ]\n+    then\n+       echo \"Sleeping 10 secs...\"\n+       sleep 10\n+    fi\n+done\n+\n+if [ $status -ne 200 ]\n+then\n+    echo \"Could not establish a connection to the fhir-server within $tries REST API invocations!\"\n+    exit 1\n+fi\n+\n+echo \"The fhir-server appears to be running...\"", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNTA1NA==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400815054", "bodyText": "2020", "author": "prb112", "createdAt": "2020-03-31T10:44:33Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/db2/Db2Adapter.java", "diffHunk": "@@ -105,15 +105,15 @@ public void createIntVariable(String schemaName, String variableName) {\n     }\n \n     @Override\n-    public void createPermission(String schemaName, String permissionName, String tableName, String predicate) {\n+    public void createOrReplacePermission(String schemaName, String permissionName, String tableName, String predicate) {", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkzNTY3NA==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400935674", "bodyText": "done", "author": "lmsurpre", "createdAt": "2020-03-31T13:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNTA1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNjE0Nw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400816147", "bodyText": "Interesting... it's left aligned in the output.\nCREATE PERMISSION FHIRAPP.STR_VALUES_TENANT                      ON FHIRAPP.STR_VALUES          FOR ROWS WHERE FHIRAPP.STR_VALUES.MT_ID = FHIR_ADMIN.SV_TENANT_ID ENFORCED FOR ALL ACCESS ENABLE ;", "author": "prb112", "createdAt": "2020-03-31T10:46:41Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/db2/Db2Adapter.java", "diffHunk": "@@ -105,15 +105,15 @@ public void createIntVariable(String schemaName, String variableName) {\n     }\n \n     @Override\n-    public void createPermission(String schemaName, String permissionName, String tableName, String predicate) {\n+    public void createOrReplacePermission(String schemaName, String permissionName, String tableName, String predicate) {\n         final String qualifiedPermissionName = DataDefinitionUtil.getQualifiedName(schemaName, permissionName);\n         final String qualifiedTableName = DataDefinitionUtil.getQualifiedName(schemaName, tableName);\n         DataDefinitionUtil.assertSecure(predicate);\n \n         final String ddl = \"\"\n-                + \"       CREATE PERMISSION \" + qualifiedPermissionName\n-                + \"                      ON \" + qualifiedTableName\n-                + \"          FOR ROWS WHERE \" + predicate\n+                + \"CREATE OR REPLACE PERMISSION \" + qualifiedPermissionName", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5MTk5Mw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400891993", "bodyText": "i think this format is wonky...i just tried preservign what was there", "author": "lmsurpre", "createdAt": "2020-03-31T12:58:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNjE0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5NTExMg==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400895112", "bodyText": "actually, now i can't seem to find where i inhereted this from...will change", "author": "lmsurpre", "createdAt": "2020-03-31T13:03:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNjE0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkwNDUwNg==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400904506", "bodyText": "so sorry it was an observation - not intended to change.", "author": "prb112", "createdAt": "2020-03-31T13:16:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNjE0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkzNTUzNQ==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400935535", "bodyText": "updated", "author": "lmsurpre", "createdAt": "2020-03-31T13:58:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNjE0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNzcyMQ==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400817721", "bodyText": "I think the prior line 45 was good defensive programming\nit asserts if the passed schemaName and constraintName are valid", "author": "prb112", "createdAt": "2020-03-31T10:49:44Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/common/DropForeignKeyConstraint.java", "diffHunk": "@@ -42,8 +42,7 @@ public void run(IDatabaseTranslator translator, Connection c) {\n \n         for (String constraintName : constraintNames) {\n             StringBuilder ddl = new StringBuilder(\"ALTER TABLE \" + qTableName);\n-            String qConstraintName = DataDefinitionUtil.getQualifiedName(schemaName, constraintName);\n-            ddl.append(\"\\n\\t\" + \"DROP FOREIGN KEY \" + qConstraintName);\n+            ddl.append(\"\\n\\t\" + \"DROP FOREIGN KEY \" + constraintName);", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg4OTI5Mw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400889293", "bodyText": "It was computing the qualified name which we don't want.  I will add DataDefinitionUtil.assertValidName(constraintName) in a loop in the constructor for the input validation.", "author": "lmsurpre", "createdAt": "2020-03-31T12:54:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNzcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkzNTc5NA==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400935794", "bodyText": "done", "author": "lmsurpre", "createdAt": "2020-03-31T13:58:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNzcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMTMzNQ==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400821335", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # (C) Copyright IBM Corp. 2016, 2020\n          \n          \n            \n            # (C) Copyright IBM Corp. 2020\n          \n      \n    \n    \n  \n\n2020", "author": "prb112", "createdAt": "2020-03-31T10:56:33Z", "path": "fhir-install/docker/copy-dependencies-db2-migration.sh", "diffHunk": "@@ -0,0 +1,33 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5NjM5MA==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400896390", "bodyText": "its based on a script that was written in 2016, so i left the copyright from that", "author": "lmsurpre", "createdAt": "2020-03-31T13:05:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMTMzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkwNTE1MA==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400905150", "bodyText": "I'm OK marking as resolved.", "author": "prb112", "createdAt": "2020-03-31T13:17:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMTMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMTU0Mg==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400821542", "bodyText": "We should document this needs to be updated in DB2SchemaMigration.md", "author": "prb112", "createdAt": "2020-03-31T10:56:52Z", "path": "fhir-install/docker/copy-dependencies-db2-migration.sh", "diffHunk": "@@ -0,0 +1,33 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+###############################################################################\n+set -ex\n+\n+SCHEMA_VERSION=\"4.0.1\"", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkzNDU3Mg==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400934572", "bodyText": "I added it to a new \"Testing migrations\" section in that document", "author": "lmsurpre", "createdAt": "2020-03-31T13:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMTU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMjE5OA==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400822198", "bodyText": "Any specific reasons other than whitespace for this update?", "author": "prb112", "createdAt": "2020-03-31T10:58:04Z", "path": "fhir-notification-kafka/src/main/java/com/ibm/fhir/notifications/kafka/impl/FHIRNotificationKafkaPublisher.java", "diffHunk": "@@ -1,5 +1,5 @@\n /*\n- * (C) Copyright IBM Corp. 2016,2019\n+ * (C) Copyright IBM Corp. 2016, 2020", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkxNDU0Nw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400914547", "bodyText": "nope.  i had the edits sitting around and thought i might as well include them.  happy to remove if you prefer.", "author": "lmsurpre", "createdAt": "2020-03-31T13:30:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMjE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkzNDk3MQ==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400934971", "bodyText": "I didn't want to miss anything :) or the commit to.  This is A-OK!", "author": "prb112", "createdAt": "2020-03-31T13:57:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMjE5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMjQ1NQ==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400822455", "bodyText": "Whitespace?", "author": "prb112", "createdAt": "2020-03-31T10:58:23Z", "path": "fhir-persistence-jdbc/src/test/java/com/ibm/fhir/persistence/jdbc/search/test/JDBCSearchCompositeTest.java", "diffHunk": "@@ -1,5 +1,5 @@\n /*\n- * (C) Copyright IBM Corp. 2018,2019\n+ * (C) Copyright IBM Corp. 2018, 2020", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkxNDk0NA==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400914944", "bodyText": "yeah, i had the edits sitting around and thought i might as well include them. happy to remove if you prefer.", "author": "lmsurpre", "createdAt": "2020-03-31T13:30:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMjQ1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMzU0Nw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400823547", "bodyText": "let's document this file in Db2SchemaMigrations.md", "author": "prb112", "createdAt": "2020-03-31T11:00:21Z", "path": "fhir-persistence-schema/deployPriorVersions.sh", "diffHunk": "@@ -9,8 +9,9 @@ set -e\n \n # Version 4.0.1 of the fhir-persistence-schema cli doesn't support derby, but starting with 4.1.0 we should do something like this:", "originalCommit": "66cd850024d41b3aa39549f2251a9399f93af902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkzMzc3Nw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400933777", "bodyText": "added it to a new Testing migrations section", "author": "lmsurpre", "createdAt": "2020-03-31T13:56:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMzU0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkzNDYwNw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r400934607", "bodyText": "awesome!", "author": "prb112", "createdAt": "2020-03-31T13:57:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyMzU0Nw=="}], "type": "inlineReview"}, {"oid": "fb4258c42c95411c8250e6ce41b9720c645d16c7", "url": "https://github.com/IBM/FHIR/commit/fb4258c42c95411c8250e6ce41b9720c645d16c7", "message": "Updates per PR feedback\n\nAdded \"Testing migrations\" section to DB2SchemaMigration.md\n\nModified ddl formatting, removed unnecessary env var in ci jobs, and\nfixed more copyrights\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-31T14:20:56Z", "type": "commit"}, {"oid": "fb4258c42c95411c8250e6ce41b9720c645d16c7", "url": "https://github.com/IBM/FHIR/commit/fb4258c42c95411c8250e6ce41b9720c645d16c7", "message": "Updates per PR feedback\n\nAdded \"Testing migrations\" section to DB2SchemaMigration.md\n\nModified ddl formatting, removed unnecessary env var in ci jobs, and\nfixed more copyrights\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-31T14:20:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA0ODkwNw==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r401048907", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            When the schema is applied for the first time, it creates the table (and related constructs) as according to the definition.\n          \n          \n            \n            When the schema is applied to an existing database, the framework will check the `FHIR_ADMIN.VERSION_HISTORY` table and, \n          \n          \n            \n            if the version in the table is less than the version being applied, the framework will invoke the Migrations *instead*\n          \n          \n            \n            of calling CREATE with the table definition. Care should be taken to ensure that the migrated schema will match a freshly applied schema.\n          \n          \n            \n            See [Testing migrations](#testing-migrations) for information on verifying the fidelity of the schema migrations.\n          \n          \n            \n            \n          \n          \n            \n            NOTE: In Db2, certain alter table statements require a table REORG before the table becomes usable again. Additionally, the REORG\n          \n          \n            \n            may commit the current \"unit of work\" which can prevent the \"all or nothing\" semantics of the migration. For these reasons, its recommended\n          \n          \n            \n            to backup the database before invoking a migration and performing the migration off-line.\n          \n          \n            \n            \n          \n          \n            \n            In this way, if a new resource is added to the specification, the schema utility will automatically provision the corresponding table on the next execution of the fhir-persistence-schema `--update-schema` action. \n          \n          \n            \n            When the schema is applied for the first time, it creates the table (and related constructs) as according to the definition.\n          \n          \n            \n            When the schema is applied to an existing database, the framework checks the `FHIR_ADMIN.VERSION_HISTORY` table and, \n          \n          \n            \n            if the version in the table is less than the version being applied, the framework invokes the Migrations *instead*\n          \n          \n            \n            of calling CREATE with the table definition. **Care** should be taken to ensure that the migrated schema matches a freshly applied schema.\n          \n          \n            \n            See [Testing migrations](#testing-migrations) for information on verifying the fidelity of the schema migrations.\n          \n          \n            \n            \n          \n          \n            \n            NOTE: In Db2, certain alter table statements require a table REORG before the table becomes usable again. Additionally, the REORG\n          \n          \n            \n            may commit the current \"unit of work\" which can prevent the \"all or nothing\" semantics of the migration. For these reasons, its recommended\n          \n          \n            \n            to backup the database before invoking a migration and performing the migration offline.\n          \n          \n            \n            \n          \n          \n            \n            In this way, if a new resource is added to the specification, the schema utility automatically provisions the corresponding table on the next execution of the fhir-persistence-schema `--update-schema` action.", "author": "prb112", "createdAt": "2020-03-31T16:27:03Z", "path": "fhir-persistence-schema/docs/DB2SchemaMigration.md", "diffHunk": "@@ -218,10 +226,27 @@ Table tbl = Table.builder(schemaName, tableName)\n     .setTablespace(fhirTablespace)\n     .addPrivileges(resourceTablePrivileges)\n     .enableAccessControl(this.sessionVariable)\n+    .addMigration(priorVersion -> {\n+            List<IDatabaseStatement> statements = new ArrayList<>();\n+                if (priorVersion == 1) {\n+                    // Add statements here\n+                }\n+                return statements;\n+            })\n     .build(model);\n ```\n \n-If a new resource is added to the specification, the schema utility automatically provisions it on the next execution of the update schema actions. \n+When the schema is applied for the first time, it creates the table (and related constructs) as according to the definition.\n+When the schema is applied to an existing database, the framework will check the `FHIR_ADMIN.VERSION_HISTORY` table and, \n+if the version in the table is less than the version being applied, the framework will invoke the Migrations *instead*\n+of calling CREATE with the table definition. Care should be taken to ensure that the migrated schema will match a freshly applied schema.\n+See [Testing migrations](#testing-migrations) for information on verifying the fidelity of the schema migrations.\n+\n+NOTE: In Db2, certain alter table statements require a table REORG before the table becomes usable again. Additionally, the REORG\n+may commit the current \"unit of work\" which can prevent the \"all or nothing\" semantics of the migration. For these reasons, its recommended\n+to backup the database before invoking a migration and performing the migration off-line.\n+\n+In this way, if a new resource is added to the specification, the schema utility will automatically provision the corresponding table on the next execution of the fhir-persistence-schema `--update-schema` action. ", "originalCommit": "ab45099b35d8175d0a367bfc089f9b8b00a56fec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA1MzU3Mg==", "url": "https://github.com/IBM/FHIR/pull/866#discussion_r401053572", "bodyText": "applied manually due to some other minor edits i had locally", "author": "lmsurpre", "createdAt": "2020-03-31T16:34:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA0ODkwNw=="}], "type": "inlineReview"}, {"oid": "26a373ed9a021e677644c5837a0d5c46847a17af", "url": "https://github.com/IBM/FHIR/commit/26a373ed9a021e677644c5837a0d5c46847a17af", "message": "Added migration details to Managing TABLE section\n\nAdded info on setting up automated migrations and recommendations to:\n1. avoid destructive changes like dropping columns;\n2. backup the database before invoking a migration; and\n3. perform the migration off-line\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-31T16:27:41Z", "type": "forcePushed"}, {"oid": "dfc74dde879fb35716ee502401be720f1888dfb9", "url": "https://github.com/IBM/FHIR/commit/dfc74dde879fb35716ee502401be720f1888dfb9", "message": "Added migration details to Managing TABLE section\n\nAdded info on setting up automated migrations and recommendations to:\n1. avoid destructive changes like dropping columns;\n2. backup the database before invoking a migration; and\n3. perform the migration off-line\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-31T16:33:44Z", "type": "commit"}, {"oid": "dfc74dde879fb35716ee502401be720f1888dfb9", "url": "https://github.com/IBM/FHIR/commit/dfc74dde879fb35716ee502401be720f1888dfb9", "message": "Added migration details to Managing TABLE section\n\nAdded info on setting up automated migrations and recommendations to:\n1. avoid destructive changes like dropping columns;\n2. backup the database before invoking a migration; and\n3. perform the migration off-line\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-03-31T16:33:44Z", "type": "forcePushed"}]}