{"pr_number": 1600, "pr_title": "issue #1351 - Check _include and _revinclude values are supported", "pr_createdAt": "2020-10-19T22:16:52Z", "pr_url": "https://github.com/IBM/FHIR/pull/1600", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MDY5MQ==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r508140691", "bodyText": "We probably don't want to recompute this every time, is there a look aside map or structure we could use?\nOr should we cache this for the whole system on startup?", "author": "prb112", "createdAt": "2020-10-20T00:39:18Z", "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -1623,6 +1644,96 @@ private static void parseInclusionParameter(Class<?> resourceType, FHIRSearchCon\n         }\n     }\n \n+    /**\n+     * Retrieves the search include restrictions.\n+     *\n+     * @param resourceType\n+     *            the resource type\n+     * @return list of allowed search _include values, or null if no restrictions\n+     * @throws Exception\n+     *             an exception\n+     */\n+    private static List<String> getSearchIncludeRestrictions(String resourceType) throws Exception {\n+\n+        // Retrieve the \"resources\" config property group.\n+        PropertyGroup rsrcsGroup = FHIRConfigHelper.getPropertyGroup(FHIRConfiguration.PROPERTY_RESOURCES);", "originalCommit": "63e78559f16727905e6a82acdd42cf80a5f808e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc5MjExMQ==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r508792111", "bodyText": "I based this on SearchUtil.getFilterRules, which calls FHIRConfigHelper.getPropertyGroup each time. Since the config file contents are cached, I thought it would be ok to follow that as an example.", "author": "tbieste", "createdAt": "2020-10-20T19:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MDY5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgyMjI2MQ==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r508822261", "bodyText": "Or should we cache this for the whole system on startup?\n\nhaha, I actually had this same thought while editing SearchUtil.getFilterRules today.   I was deciding how much trouble it would be to try caching this and only refresh it when the config file changes.  I ended up deciding to leave that optimatization for a future change, although in this case its new code so may be worth figuring out the caching thing.  I wish we had an easy way to measure performance of the search component as I don't like to optimize prematurely.", "author": "lmsurpre", "createdAt": "2020-10-20T20:35:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MDY5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4MTY0OQ==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511981649", "bodyText": "OK - let's take a backlog item on this.  Anyone up for creating an issue for it?\nMore as an investigation task?", "author": "prb112", "createdAt": "2020-10-26T14:00:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MDY5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5NDA4OA==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511994088", "bodyText": "I opened #1625 for the potential improvement.", "author": "lmsurpre", "createdAt": "2020-10-26T14:17:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MDY5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5ODg4MA==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511998880", "bodyText": "Lee opened #1625", "author": "prb112", "createdAt": "2020-10-26T14:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MDY5MQ=="}], "type": "inlineReview"}, {"oid": "eb4e6820320a83911999acfc18897850bbdd7acd", "url": "https://github.com/IBM/FHIR/commit/eb4e6820320a83911999acfc18897850bbdd7acd", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>", "committedDate": "2020-10-20T16:57:03Z", "type": "forcePushed"}, {"oid": "0e4843cf6b21039562b3e605ba8588f62efa920b", "url": "https://github.com/IBM/FHIR/commit/0e4843cf6b21039562b3e605ba8588f62efa920b", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>", "committedDate": "2020-10-20T17:40:08Z", "type": "forcePushed"}, {"oid": "f874f1a9e0c166673b9cd9b65a1869ba155af713", "url": "https://github.com/IBM/FHIR/commit/f874f1a9e0c166673b9cd9b65a1869ba155af713", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>", "committedDate": "2020-10-20T17:59:54Z", "type": "forcePushed"}, {"oid": "6b73eb36016dcb19a8b3c2c113d5790fb7f4c029", "url": "https://github.com/IBM/FHIR/commit/6b73eb36016dcb19a8b3c2c113d5790fb7f4c029", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>", "committedDate": "2020-10-20T18:59:37Z", "type": "forcePushed"}, {"oid": "ef5bbbf16b26b831bf750f560a311ea9a5bd92d0", "url": "https://github.com/IBM/FHIR/commit/ef5bbbf16b26b831bf750f560a311ea9a5bd92d0", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>", "committedDate": "2020-10-20T19:26:44Z", "type": "forcePushed"}, {"oid": "77a0bfdde26fd87edc7a434c8d792f24862741e2", "url": "https://github.com/IBM/FHIR/commit/77a0bfdde26fd87edc7a434c8d792f24862741e2", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>", "committedDate": "2020-10-20T19:38:00Z", "type": "forcePushed"}, {"oid": "d88baae89897ed6d2009019236960b69d92f2702", "url": "https://github.com/IBM/FHIR/commit/d88baae89897ed6d2009019236960b69d92f2702", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>", "committedDate": "2020-10-20T20:27:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NjQ4MA==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511986480", "bodyText": "What do the \\ do or reference?", "author": "prb112", "createdAt": "2020-10-26T14:07:31Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1604,9 +1610,15 @@ This section contains reference information about each of the configuration prop\n |`fhirServer/resources/open`|true|\n |`fhirServer/resources/Resource/interactions`|null (all interactions supported)|\n |`fhirServer/resources/Resource/searchParameters`|null (all global search parameters supported)|\n+|`fhirServer/resources/Resource/searchIncludes`|null (all \\_include values supported)|\n+|`fhirServer/resources/Resource/searchRevIncludes`|null (all \\_revinclude values supported)|", "originalCommit": "d88baae89897ed6d2009019236960b69d92f2702", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5NTA1OQ==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511995059", "bodyText": "I assume it just escapes the _ char (so its not interpretted as formatting...e.g. underline).  not sure if its needed or not, but it looks fine at https://github.com/IBM/FHIR/blob/tbieste-issue-1351/docs/src/pages/guides/FHIRServerUsersGuide.md", "author": "lmsurpre", "createdAt": "2020-10-26T14:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NjQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5NjMwOQ==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511996309", "bodyText": "They are used to escape the underscore '_' character in markdown in cases where you want to display the literal.", "author": "tbieste", "createdAt": "2020-10-26T14:20:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NjQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwNDA1NA==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r512004054", "bodyText": "oh snazy - I hadn't even thought about the implication on formatting.  good catch.", "author": "prb112", "createdAt": "2020-10-26T14:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NjQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NjcwMw==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511986703", "bodyText": "same question as 1613,1614", "author": "prb112", "createdAt": "2020-10-26T14:07:50Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1520,9 +1520,15 @@ This section contains reference information about each of the configuration prop\n |`fhirServer/resources/Resource/interactions`|string list|A list of strings that represent the RESTful interactions (create, read, vread, update, patch, delete, history, and/or search) supported for resource types. Omitting this property is equivalent to supporting all FHIR interactions for the supported resources. An empty list, `[]`, can be used to indicate that no REST methods are supported. This property can be overridden for specific resource types via the `fhirServer/resources/<resourceType>/interactions` property.|\n |`fhirServer/resources/Resource/searchParameters`|object|The set of search parameters to support for all supported resource types. Omitting this property is equivalent to supporting all search parameters in the server's registry that apply to resource type \"Resource\" (all resources). An empty object, `{}`, can be used to indicate that no global search parameters are supported.|\n |`fhirServer/resources/Resource/searchParameters/<code>`|string|The URL of the search parameter definition to use for the search parameter `<code>`. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchParameters/<code>`|\n+|`fhirServer/resources/Resource/searchIncludes`|string list|A comma-separated list of \\_include values supported for all resource types. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchIncludes`. Omitting this property is equivalent to supporting all \\_include values for the supported resources. An empty list, `[]`, can be used to indicate that no \\_include values are supported.|\n+|`fhirServer/resources/Resource/searchRevIncludes`|string list|A comma-separated list of \\_revinclude values supported for all resource types. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchRevIncludes`. Omitting this property is equivalent to supporting all \\_revinclude values for the supported resources. An empty list, `[]`, can be used to indicate that no \\_revinclude values are supported.|\n+|`fhirServer/resources/Resource/searchParameterCombinations`|string list|A comma-separated list of search parameter combinations supported for all resource types. Each search parameter combination is a string, where a plus sign, `+`, separates the search parameters that can be used in combination. To indicate that searching without any search parameters is allowed, an empty string must be included in the list. Including an asterisk, `*`, in the list indicates support of any search parameter combination. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchParameterCombinations`. Omitting this property is equivalent to supporting any search parameter combination.|\n |`fhirServer/resources/<resourceType>/interactions`|string list|A list of strings that represent the RESTful interactions (create, read, vread, update, patch, delete, history, and/or search) to support for this resource type. For resources without the property, the value of `fhirServer/resources/Resource/interactions` is used.|\n |`fhirServer/resources/<resourceType>/searchParameters`|object|The set of search parameters to support for this resource type. Global search parameters defined on the `Resource` resource can be overridden on a per-resourceType basis.|\n |`fhirServer/resources/<resourceType>/searchParameters/<code>`|string|The URL of the search parameter definition to use for the search parameter `<code>` on resources of type `<resourceType>`.|\n+|`fhirServer/resources/<resourceType>/searchIncludes`|string list|A comma-separated list of \\_include values supported for this resource type. An empty list, `[]`, can be used to indicate that no \\_include values are supported. For resources without the property, the value of `fhirServer/resources/Resource/searchIncludes` is used.|\n+|`fhirServer/resources/<resourceType>/searchRevIncludes`|string list|A comma-separated list of \\_revinclude values supported for this resource type. An empty list, `[]`, can be used to indicate that no \\_revinclude values are supported. For resources without the property, the value of `fhirServer/resources/Resource/searchRevIncludes` is used.|", "originalCommit": "d88baae89897ed6d2009019236960b69d92f2702", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5NjYyMQ==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511996621", "bodyText": "Same answer. :)", "author": "tbieste", "createdAt": "2020-10-26T14:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NjcwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NzEyMw==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511987123", "bodyText": "Same question as 1613,1614", "author": "prb112", "createdAt": "2020-10-26T14:08:25Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1520,9 +1520,15 @@ This section contains reference information about each of the configuration prop\n |`fhirServer/resources/Resource/interactions`|string list|A list of strings that represent the RESTful interactions (create, read, vread, update, patch, delete, history, and/or search) supported for resource types. Omitting this property is equivalent to supporting all FHIR interactions for the supported resources. An empty list, `[]`, can be used to indicate that no REST methods are supported. This property can be overridden for specific resource types via the `fhirServer/resources/<resourceType>/interactions` property.|\n |`fhirServer/resources/Resource/searchParameters`|object|The set of search parameters to support for all supported resource types. Omitting this property is equivalent to supporting all search parameters in the server's registry that apply to resource type \"Resource\" (all resources). An empty object, `{}`, can be used to indicate that no global search parameters are supported.|\n |`fhirServer/resources/Resource/searchParameters/<code>`|string|The URL of the search parameter definition to use for the search parameter `<code>`. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchParameters/<code>`|\n+|`fhirServer/resources/Resource/searchIncludes`|string list|A comma-separated list of \\_include values supported for all resource types. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchIncludes`. Omitting this property is equivalent to supporting all \\_include values for the supported resources. An empty list, `[]`, can be used to indicate that no \\_include values are supported.|\n+|`fhirServer/resources/Resource/searchRevIncludes`|string list|A comma-separated list of \\_revinclude values supported for all resource types. Individual resource types may override this value via `fhirServer/resources/<resourceType>/searchRevIncludes`. Omitting this property is equivalent to supporting all \\_revinclude values for the supported resources. An empty list, `[]`, can be used to indicate that no \\_revinclude values are supported.|", "originalCommit": "d88baae89897ed6d2009019236960b69d92f2702", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5NjcwOA==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511996708", "bodyText": "Same answer. :)", "author": "tbieste", "createdAt": "2020-10-26T14:21:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NzEyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NzY2MQ==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511987661", "bodyText": "Please update the copywrite year.", "author": "prb112", "createdAt": "2020-10-26T14:09:07Z", "path": "fhir-search/src/main/java/com/ibm/fhir/search/exception/SearchExceptionUtil.java", "diffHunk": "@@ -18,16 +18,17 @@\n     private static final String ILLEGAL_EXCEPTION = \"SearchParameter filter property values must be an array of String.\";\n     private static final String ILLEGAL_ARGUMENT_EXCEPTION = \"No constant with value '%s' found.\";\n     private static final String PARSE_PARAMETER_EXCEPTION = \"An error occurred while parsing parameter '%s'.\";\n+    private static final String PARSE_PARAMETERS_EXCEPTION = \"An error occurred while parsing parameters.\";", "originalCommit": "d88baae89897ed6d2009019236960b69d92f2702", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MzI0Mg==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r512093242", "bodyText": "Updated.", "author": "tbieste", "createdAt": "2020-10-26T16:24:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4NzY2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4ODI5OA==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511988298", "bodyText": "Can we pack in some additional detail in the exception?  e.g. what's the invalid combo?", "author": "prb112", "createdAt": "2020-10-26T14:09:56Z", "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -816,6 +820,16 @@ public static FHIRSearchContext parseQueryParameters(Class<?> resourceType,\n             }\n         } // end for\n \n+        try {\n+            // Check for valid search parameter combinations\n+            checkSearchParameterCombinations(resourceType, parameters);\n+\n+        } catch (FHIRSearchException se) {\n+            throw se;\n+        } catch (Exception e) {\n+            throw SearchExceptionUtil.buildNewParseParametersException(e);", "originalCommit": "d88baae89897ed6d2009019236960b69d92f2702", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5NjcxOA==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511996718", "bodyText": "actually in this branch it's only going to be config related exceptions.", "author": "prb112", "createdAt": "2020-10-26T14:21:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4ODI5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5Mjc2NQ==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r512092765", "bodyText": "Correct.", "author": "tbieste", "createdAt": "2020-10-26T16:23:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk4ODI5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5Mzc0Mw==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511993743", "bodyText": "Line 20,21 are almost identical, I'd consider pumping in more information in this OperationOutcome so that it's more specific to the failing reason.", "author": "prb112", "createdAt": "2020-10-26T14:17:19Z", "path": "fhir-search/src/main/java/com/ibm/fhir/search/exception/SearchExceptionUtil.java", "diffHunk": "@@ -49,9 +50,22 @@ public static FHIRSearchException buildNewParseParameterException(final String n\n         return new FHIRSearchException(msg, e).withIssue(ooi);\n     }\n \n+    /**\n+     * creates a new parse parameters exception\n+     *\n+     * @param name\n+     * @param e\n+     * @return\n+     */\n+    public static FHIRSearchException buildNewParseParametersException(Exception e) {\n+        String msg = String.format(PARSE_PARAMETERS_EXCEPTION);\n+        OperationOutcome.Issue ooi = FHIRUtil.buildOperationOutcomeIssue(msg, IssueType.INVALID);\n+        return new FHIRSearchException(msg, e).withIssue(ooi);", "originalCommit": "d88baae89897ed6d2009019236960b69d92f2702", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwMDYxNg==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r512100616", "bodyText": "For this exception, it's only going to be due to config-related exceptions, which will be in the \"cause\" exception. That seemed consistent with the existing behavior of buildNewParseParameterException.", "author": "tbieste", "createdAt": "2020-10-26T16:34:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5Mzc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwMjU3Ng==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r512102576", "bodyText": "Sounds good", "author": "prb112", "createdAt": "2020-10-26T16:37:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5Mzc0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5ODMyOQ==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r511998329", "bodyText": "I think we should be proactive here, and only accept the trimmed codes/combinations.", "author": "prb112", "createdAt": "2020-10-26T14:23:25Z", "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -902,6 +916,109 @@ private static void checkSearchParameterRestrictions(String parameterCode, Searc\n         }\n     }\n \n+    /**\n+     * Checks that the combination of search parameters is valid.\n+     *\n+     * @param resourceType\n+     *            the resource type\n+     * @param parameters\n+     *            the query parameters to check\n+     * @throws Exception\n+     *             an exception\n+     */\n+    private static void checkSearchParameterCombinations(Class<?> resourceType, List<QueryParameter> parameters)\n+        throws Exception {\n+\n+        List<Set<String>> validCombinations = getSearchParameterCombinations(resourceType.getSimpleName());\n+        if (validCombinations != null) {\n+            Set<String> searchParameterCodes = parameters.stream().map(qp -> qp.getCode()).collect(Collectors.toSet());\n+\n+            // Check that search parameter codes are a valid combinations\n+            if (!validCombinations.contains(searchParameterCodes)) {\n+                String msg;\n+                if (searchParameterCodes.isEmpty()) {\n+                    msg = \"A valid search parameter combination is required\";\n+                } else {\n+                    msg = \"Search parameter combination is not valid\";\n+                }\n+                throw SearchExceptionUtil.buildNewInvalidSearchException(msg);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Retrieves the search parameter combinations.\n+     *\n+     * @param resourceType\n+     *            the resource type\n+     * @return list of allowed search parameter combinations, or null if any search parameter combination is allowed\n+     * @throws Exception\n+     *             an exception\n+     */\n+    private static List<Set<String>> getSearchParameterCombinations(String resourceType) throws Exception {\n+\n+        List<Set<String>> spCombinations = null;\n+\n+        // Retrieve the \"resources\" config property group.\n+        PropertyGroup rsrcsGroup = FHIRConfigHelper.getPropertyGroup(FHIRConfiguration.PROPERTY_RESOURCES);\n+        if (rsrcsGroup != null) {\n+            List<PropertyEntry> rsrcsEntries = rsrcsGroup.getProperties();\n+            if (rsrcsEntries != null && !rsrcsEntries.isEmpty()) {\n+                List<String> combinations = null;\n+\n+                // Try to find search parameter combinations property for matching resource type\n+                for (PropertyEntry rsrcsEntry : rsrcsEntries) {\n+                    if (resourceType.equals(rsrcsEntry.getName())) {\n+                        PropertyGroup resourceTypeGroup = (PropertyGroup) rsrcsEntry.getValue();\n+                        if (resourceTypeGroup != null) {\n+                            combinations = resourceTypeGroup.getStringListProperty(FHIRConfiguration.PROPERTY_FIELD_RESOURCES_SEARCH_PARAMETER_COMBINATIONS);\n+                            break;\n+                        }\n+                    }\n+                }\n+\n+                // Otherwise, try to find search parameter combinations property for \"Resource\" resource type\n+                if (combinations == null) {\n+                    for (PropertyEntry rsrcsEntry : rsrcsEntries) {\n+\n+                        // Check if matching resource type\n+                        if (SearchConstants.RESOURCE_RESOURCE.equals(rsrcsEntry.getName())) {\n+                            PropertyGroup resourceTypeGroup = (PropertyGroup) rsrcsEntry.getValue();\n+                            if (resourceTypeGroup != null) {\n+                                combinations =\n+                                        resourceTypeGroup.getStringListProperty(FHIRConfiguration.PROPERTY_FIELD_RESOURCES_SEARCH_PARAMETER_COMBINATIONS);\n+                                break;\n+                            }\n+                        }\n+                    }\n+                }\n+\n+                // Convert the delimited combinations to a list of sets\n+                if (combinations != null) {\n+                    spCombinations = new ArrayList<>();\n+                    for (String combination : combinations) {\n+                        Set<String> combinationSet = new HashSet<>();\n+                        if (!combination.isEmpty()) {\n+                            // If any search parameter combination is allowed, return null\n+                            if (SEARCH_PARAM_COMBINATION_ANY.equals(combination)) {\n+                                return null;\n+                            }\n+                            for (String spString : combination.split(SEARCH_PARAM_COMBINATION_DELIMITER)) {\n+                                if (spString.trim().isEmpty()) {\n+                                    throw SearchExceptionUtil.buildNewIllegalStateException();\n+                                }\n+                                combinationSet.add(spString);", "originalCommit": "d88baae89897ed6d2009019236960b69d92f2702", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5NTM3OA==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r512095378", "bodyText": "Updated.", "author": "tbieste", "createdAt": "2020-10-26T16:27:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5ODMyOQ=="}], "type": "inlineReview"}, {"oid": "493e9b810b7cf49e12ed87c63a4c3fe6d4191f17", "url": "https://github.com/IBM/FHIR/commit/493e9b810b7cf49e12ed87c63a4c3fe6d4191f17", "message": "issue #1351 - Check _include and _revinclude values are supported\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>", "committedDate": "2020-10-26T14:26:37Z", "type": "commit"}, {"oid": "1feaa611ff458a258d6f8bd66fea3b90bc526c80", "url": "https://github.com/IBM/FHIR/commit/1feaa611ff458a258d6f8bd66fea3b90bc526c80", "message": "issue #1351 - Check search parameter combinations\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>", "committedDate": "2020-10-26T14:26:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwMTY5MQ==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r512001691", "bodyText": "Please refactor this method and the prior into one processing logic method, and a new signature, resourceType, String propertyType, and leave the existing methods only pointing to the one logic method.", "author": "prb112", "createdAt": "2020-10-26T14:27:34Z", "path": "fhir-search/src/main/java/com/ibm/fhir/search/util/SearchUtil.java", "diffHunk": "@@ -1612,6 +1750,95 @@ private static void parseInclusionParameter(Class<?> resourceType, FHIRSearchCon\n         }\n     }\n \n+    /**\n+     * Retrieves the search include restrictions.\n+     *\n+     * @param resourceType\n+     *            the resource type\n+     * @return list of allowed search _include values, or null if no restrictions\n+     * @throws Exception\n+     *             an exception\n+     */\n+    private static List<String> getSearchIncludeRestrictions(String resourceType) throws Exception {\n+\n+        // Retrieve the \"resources\" config property group.\n+        PropertyGroup rsrcsGroup = FHIRConfigHelper.getPropertyGroup(FHIRConfiguration.PROPERTY_RESOURCES);\n+        if (rsrcsGroup != null) {\n+            List<PropertyEntry> rsrcsEntries = rsrcsGroup.getProperties();\n+            if (rsrcsEntries != null && !rsrcsEntries.isEmpty()) {\n+\n+                // Try to find search includes property for matching resource type\n+                for (PropertyEntry rsrcsEntry : rsrcsEntries) {\n+                    if (resourceType.equals(rsrcsEntry.getName())) {\n+                        PropertyGroup resourceTypeGroup = (PropertyGroup) rsrcsEntry.getValue();\n+                        if (resourceTypeGroup != null) {\n+                            return resourceTypeGroup.getStringListProperty(FHIRConfiguration.PROPERTY_FIELD_RESOURCES_SEARCH_INCLUDES);\n+                        }\n+                    }\n+                }\n+\n+                // Otherwise, try to find search includes property for \"Resource\" resource type\n+                for (PropertyEntry rsrcsEntry : rsrcsEntries) {\n+\n+                    // Check if matching resource type\n+                    if (SearchConstants.RESOURCE_RESOURCE.equals(rsrcsEntry.getName())) {\n+                        PropertyGroup resourceTypeGroup = (PropertyGroup) rsrcsEntry.getValue();\n+                        if (resourceTypeGroup != null) {\n+                            return resourceTypeGroup.getStringListProperty(FHIRConfiguration.PROPERTY_FIELD_RESOURCES_SEARCH_INCLUDES);\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+\n+        return null;\n+    }\n+\n+    /**\n+     * Retrieves the search revinclude restrictions.\n+     *\n+     * @param resourceType\n+     *            the resource type\n+     * @return list of allowed search _revinclude values, or null if no restrictions\n+     * @throws Exception\n+     *             an exception\n+     */\n+    private static List<String> getSearchRevIncludeRestrictions(String resourceType) throws Exception {", "originalCommit": "d88baae89897ed6d2009019236960b69d92f2702", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwOTA5MA==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r512109090", "bodyText": "Updated.", "author": "tbieste", "createdAt": "2020-10-26T16:46:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwMTY5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwMjM5Mw==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r512002393", "bodyText": "Change the copyright year to 2020 only", "author": "prb112", "createdAt": "2020-10-26T14:28:30Z", "path": "fhir-search/src/test/java/com/ibm/fhir/search/parameters/SearchParameterRestrictionTest.java", "diffHunk": "@@ -17,7 +17,14 @@\n \n import com.ibm.fhir.config.FHIRConfiguration;\n import com.ibm.fhir.config.FHIRRequestContext;\n+import com.ibm.fhir.model.resource.CarePlan;", "originalCommit": "d88baae89897ed6d2009019236960b69d92f2702", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MTMzMQ==", "url": "https://github.com/IBM/FHIR/pull/1600#discussion_r512091331", "bodyText": "Updated.", "author": "tbieste", "createdAt": "2020-10-26T16:21:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwMjM5Mw=="}], "type": "inlineReview"}, {"oid": "c7d91922ad38010b186f25222580fd3cbf39e11a", "url": "https://github.com/IBM/FHIR/commit/c7d91922ad38010b186f25222580fd3cbf39e11a", "message": "issue #1351 - Updates after code review\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>", "committedDate": "2020-10-26T16:49:56Z", "type": "commit"}, {"oid": "c7d91922ad38010b186f25222580fd3cbf39e11a", "url": "https://github.com/IBM/FHIR/commit/c7d91922ad38010b186f25222580fd3cbf39e11a", "message": "issue #1351 - Updates after code review\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>", "committedDate": "2020-10-26T16:49:56Z", "type": "forcePushed"}, {"oid": "6d005cfdac608192393f8368861de2c7a47e977d", "url": "https://github.com/IBM/FHIR/commit/6d005cfdac608192393f8368861de2c7a47e977d", "message": "issue #1351 - Add searchInclude and searchRevInclude to capabilities\n\nSigned-off-by: Troy Biesterfeld <tbieste@us.ibm.com>", "committedDate": "2020-10-26T19:37:27Z", "type": "commit"}]}