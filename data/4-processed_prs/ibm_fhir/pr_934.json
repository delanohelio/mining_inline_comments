{"pr_number": 934, "pr_title": "Issue #933 - add profile reference validation to FHIRValidator", "pr_createdAt": "2020-04-15T20:35:09Z", "pr_url": "https://github.com/IBM/FHIR/pull/934", "timeline": [{"oid": "89d62d71f3f32b645b0cd7345c9676715644f0ae", "url": "https://github.com/IBM/FHIR/commit/89d62d71f3f32b645b0cd7345c9676715644f0ae", "message": "Issue #933 - add profile reference validation to FHIRValidator\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-15T20:34:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEyNDU2Mw==", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409124563", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * <p>Resource-asserted profile references that are unknown, generate an issue with severity WARNING. Profile references\n          \n          \n            \n                 * passed in as arguments to this method, generate an issue with severity ERROR.\n          \n          \n            \n                 * <p>Resource-asserted profile references that are not available in the FHIRRegistry result in issues with severity WARNING.\n          \n          \n            \n                 * <p>Unknown profile references passed as arguments to this method result in issues with severity ERROR.", "author": "lmsurpre", "createdAt": "2020-04-15T20:48:35Z", "path": "fhir-validation/src/main/java/com/ibm/fhir/validation/FHIRValidator.java", "diffHunk": "@@ -37,21 +40,19 @@\n import com.ibm.fhir.validation.exception.FHIRValidationException;\n \n public class FHIRValidator {\n-    public static boolean DEBUG = false;\n-\n-    private ValidatingNodeVisitor visitor = new ValidatingNodeVisitor();\n+    private static final Logger log = Logger.getLogger(FHIRValidator.class.getName());\n \n     private FHIRValidator() { }\n \n     /**\n      * Validate a {@link Resource} against constraints in the base specification and\n      * resource-asserted profile references or specific profile references but not both.\n      *\n-     * <p>Resource-asserted profiles which are unknown to the server will be ignored. Conversely,\n-     * unknown profiles passed explicitly as arguments will result in a FHIRValidationException.\n+     * <p>Resource-asserted profile references that are unknown, generate an issue with severity WARNING. Profile references\n+     * passed in as arguments to this method, generate an issue with severity ERROR.", "originalCommit": "89d62d71f3f32b645b0cd7345c9676715644f0ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEyNzI0MA==", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409127240", "bodyText": "and the same change in each of the other variants", "author": "lmsurpre", "createdAt": "2020-04-15T20:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEyNDU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEyOTM5OA==", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409129398", "bodyText": "Updated Javadoc to reflect this language", "author": "JohnTimm", "createdAt": "2020-04-15T20:57:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEyNDU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEyNjI1OA==", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409126258", "bodyText": "why remove this paragraph?\nthat seems like useful information and the question has come up before wrt contained resources", "author": "lmsurpre", "createdAt": "2020-04-15T20:51:20Z", "path": "fhir-validation/src/main/java/com/ibm/fhir/validation/FHIRValidator.java", "diffHunk": "@@ -37,21 +40,19 @@\n import com.ibm.fhir.validation.exception.FHIRValidationException;\n \n public class FHIRValidator {\n-    public static boolean DEBUG = false;\n-\n-    private ValidatingNodeVisitor visitor = new ValidatingNodeVisitor();\n+    private static final Logger log = Logger.getLogger(FHIRValidator.class.getName());\n \n     private FHIRValidator() { }\n \n     /**\n      * Validate a {@link Resource} against constraints in the base specification and\n      * resource-asserted profile references or specific profile references but not both.\n      *\n-     * <p>Resource-asserted profiles which are unknown to the server will be ignored. Conversely,\n-     * unknown profiles passed explicitly as arguments will result in a FHIRValidationException.\n+     * <p>Resource-asserted profile references that are unknown, generate an issue with severity WARNING. Profile references\n+     * passed in as arguments to this method, generate an issue with severity ERROR.\n      *\n-     * <p>Profile references that are passed into this method are only applicable to the outermost\n-     * resource (not contained resources).", "originalCommit": "89d62d71f3f32b645b0cd7345c9676715644f0ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEyOTU3NA==", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409129574", "bodyText": "Added this comment back. It was removed inadvertently.", "author": "JohnTimm", "createdAt": "2020-04-15T20:57:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEyNjI1OA=="}], "type": "inlineReview"}, {"oid": "a78761318b0a57fb7658027bd9c4910084a45629", "url": "https://github.com/IBM/FHIR/commit/a78761318b0a57fb7658027bd9c4910084a45629", "message": "Issue #933 - updates per PR feedback\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-15T21:01:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzMjIwMA==", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409132200", "bodyText": "pretty minor, but i like to put the variable in ' just so whitespace stands out\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    .text(string(\"Profile: \" + url + \" is not applicable to resource type: \" + resourceType.getSimpleName()))\n          \n          \n            \n                                    .text(string(\"Profile '\" + url + \"' is not applicable to resource type: \" + resourceType.getSimpleName()))", "author": "lmsurpre", "createdAt": "2020-04-15T21:03:05Z", "path": "fhir-validation/src/main/java/com/ibm/fhir/validation/FHIRValidator.java", "diffHunk": "@@ -156,26 +165,71 @@ public static FHIRValidator validator() {\n         return new FHIRValidator();\n     }\n \n-    private static class ValidatingNodeVisitor extends FHIRPathDefaultNodeVisitor {\n-        private FHIRPathEvaluator evaluator = FHIRPathEvaluator.evaluator();\n-        private EvaluationContext evaluationContext;\n-        private boolean includeResourceAssertedProfiles;\n-        private List<String> profiles;\n-        private List<Issue> issues = new ArrayList<>();\n+    /**\n+     * Validate a list of profile references to ensure they are supported (known by the FHIR registry) and applicable\n+     * (the type constrained by the profile is compatible with the resource being validated).\n+     *\n+     * <p>Resource-asserted profile references that are unknown, generate an issue with severity WARNING. Profile references\n+     * passed in as arguments to the {@link FHIRValidator#validate(EvaluationContext, boolean, String...)} method, generate an\n+     * issue with severity ERROR.\n+     *\n+     * <p>If a specific profile is known but incompatible with the resource being validated, then an issue with severity\n+     * ERROR is generated.\n+     *\n+     * @param resourceNode\n+     *     the resource node being validated by a FHIRValidator instance\n+     * @param profileReferences\n+     *     the list of profile references to validate\n+     * @param resourceAsserted\n+     *     indicates whether the profile references came from the resource or were explicitly passed in as arguments\n+     * @param issues\n+     *     the list of issues to add to\n+     */\n+    private static void validateProfileReferences(\n+            FHIRPathResourceNode resourceNode,\n+            List<String> profileReferences,\n+            boolean resourceAsserted,\n+            List<Issue> issues) {\n+        Class<?> resourceType = resourceNode.resource().getClass();\n+        for (String url : profileReferences) {\n+            StructureDefinition profile = ProfileSupport.getProfile(url);\n+            if (profile == null) {\n+                issues.add(Issue.builder()\n+                    .severity(resourceAsserted ? IssueSeverity.WARNING : IssueSeverity.ERROR)\n+                    .code(IssueType.NOT_SUPPORTED)\n+                    .details(CodeableConcept.builder()\n+                        .text(string(\"Profile: \" + url + \" is not supported\"))\n+                        .build())\n+                    .expression(string(resourceNode.path()))\n+                    .build());\n+            } else if (!ProfileSupport.isApplicable(profile, resourceType)) {\n+                issues.add(Issue.builder()\n+                    .severity(IssueSeverity.ERROR)\n+                    .code(IssueType.INVALID)\n+                    .details(CodeableConcept.builder()\n+                        .text(string(\"Profile: \" + url + \" is not applicable to resource type: \" + resourceType.getSimpleName()))", "originalCommit": "89d62d71f3f32b645b0cd7345c9676715644f0ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzMjQ1MQ==", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409132451", "bodyText": "I guess its just a style difference though", "author": "lmsurpre", "createdAt": "2020-04-15T21:03:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzMjIwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzMjk1OA==", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409132958", "bodyText": "why no more reset?  I guess it was never used and its on private class so seems fine...but I would have thought it was there to allow a validator to re-use a single visitor multiple times", "author": "lmsurpre", "createdAt": "2020-04-15T21:04:28Z", "path": "fhir-validation/src/main/java/com/ibm/fhir/validation/FHIRValidator.java", "diffHunk": "@@ -156,26 +165,71 @@ public static FHIRValidator validator() {\n         return new FHIRValidator();\n     }\n \n-    private static class ValidatingNodeVisitor extends FHIRPathDefaultNodeVisitor {\n-        private FHIRPathEvaluator evaluator = FHIRPathEvaluator.evaluator();\n-        private EvaluationContext evaluationContext;\n-        private boolean includeResourceAssertedProfiles;\n-        private List<String> profiles;\n-        private List<Issue> issues = new ArrayList<>();\n+    /**\n+     * Validate a list of profile references to ensure they are supported (known by the FHIR registry) and applicable\n+     * (the type constrained by the profile is compatible with the resource being validated).\n+     *\n+     * <p>Resource-asserted profile references that are unknown, generate an issue with severity WARNING. Profile references\n+     * passed in as arguments to the {@link FHIRValidator#validate(EvaluationContext, boolean, String...)} method, generate an\n+     * issue with severity ERROR.\n+     *\n+     * <p>If a specific profile is known but incompatible with the resource being validated, then an issue with severity\n+     * ERROR is generated.\n+     *\n+     * @param resourceNode\n+     *     the resource node being validated by a FHIRValidator instance\n+     * @param profileReferences\n+     *     the list of profile references to validate\n+     * @param resourceAsserted\n+     *     indicates whether the profile references came from the resource or were explicitly passed in as arguments\n+     * @param issues\n+     *     the list of issues to add to\n+     */\n+    private static void validateProfileReferences(\n+            FHIRPathResourceNode resourceNode,\n+            List<String> profileReferences,\n+            boolean resourceAsserted,\n+            List<Issue> issues) {\n+        Class<?> resourceType = resourceNode.resource().getClass();\n+        for (String url : profileReferences) {\n+            StructureDefinition profile = ProfileSupport.getProfile(url);\n+            if (profile == null) {\n+                issues.add(Issue.builder()\n+                    .severity(resourceAsserted ? IssueSeverity.WARNING : IssueSeverity.ERROR)\n+                    .code(IssueType.NOT_SUPPORTED)\n+                    .details(CodeableConcept.builder()\n+                        .text(string(\"Profile: \" + url + \" is not supported\"))\n+                        .build())\n+                    .expression(string(resourceNode.path()))\n+                    .build());\n+            } else if (!ProfileSupport.isApplicable(profile, resourceType)) {\n+                issues.add(Issue.builder()\n+                    .severity(IssueSeverity.ERROR)\n+                    .code(IssueType.INVALID)\n+                    .details(CodeableConcept.builder()\n+                        .text(string(\"Profile: \" + url + \" is not applicable to resource type: \" + resourceType.getSimpleName()))\n+                        .build())\n+                    .expression(string(resourceNode.path()))\n+                    .build());\n+            }\n+        }\n+    }\n \n-        private ValidatingNodeVisitor() { }\n+    private static class ValidatingNodeVisitor extends FHIRPathDefaultNodeVisitor {\n+        private final FHIRPathEvaluator evaluator = FHIRPathEvaluator.evaluator();\n+        private final EvaluationContext evaluationContext;\n+        private final boolean includeResourceAssertedProfiles;\n+        private final List<String> profiles;\n+        private final List<Issue> issues = new ArrayList<>();\n \n-        private List<Issue> validate(EvaluationContext evaluationContext, boolean includeResourceAssertedProfiles, String... profiles) {\n-            reset();\n+        private ValidatingNodeVisitor(EvaluationContext evaluationContext, boolean includeResourceAssertedProfiles, List<String> profiles) {\n             this.evaluationContext = evaluationContext;\n             this.includeResourceAssertedProfiles = includeResourceAssertedProfiles;\n-            this.profiles = Arrays.asList(profiles);\n-            this.evaluationContext.getTree().getRoot().accept(this);\n-            return Collections.unmodifiableList(issues);\n+            this.profiles = profiles;\n         }\n \n-        private void reset() {\n-            issues.clear();", "originalCommit": "89d62d71f3f32b645b0cd7345c9676715644f0ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzMzE3NQ==", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409133175", "bodyText": "We create a visitor each call to FHIRValidator.validate. No need to reset anything.", "author": "JohnTimm", "createdAt": "2020-04-15T21:04:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzMjk1OA=="}], "type": "inlineReview"}, {"oid": "e0296dad810834fd951a5d40b9c444160e415499", "url": "https://github.com/IBM/FHIR/commit/e0296dad810834fd951a5d40b9c444160e415499", "message": "Update fhir-validation/src/main/java/com/ibm/fhir/validation/FHIRValidator.java\r\n\r\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>\n\nCo-Authored-By: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-15T21:04:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzNjE0Mg==", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409136142", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * <p>Profiles that are incompatible with the resource being validated result in issues with severity ERROR.\n          \n          \n            \n                 * <p>Profiles that are incompatible with the resource type being validated result in issues with severity ERROR.", "author": "lmsurpre", "createdAt": "2020-04-15T21:11:01Z", "path": "fhir-validation/src/main/java/com/ibm/fhir/validation/FHIRValidator.java", "diffHunk": "@@ -120,8 +130,11 @@ private FHIRValidator() { }\n      * Validate a resource, using an {@link EvaluationContext}, against constraints in the base specification and\n      * resource-asserted profile references and/or specific profile references.\n      *\n-     * <p>Resource-asserted profiles which are unknown to the server will be ignored. Conversely,\n-     * unknown profiles passed explicitly as arguments will result in a FHIRValidationException.\n+     * <p>Resource-asserted profile references that are not available in the FHIRRegistry result in issues with severity WARNING.\n+     *\n+     * <p>Unknown profile references passed as arguments to this method result in issues with severity ERROR.\n+     *\n+     * <p>Profiles that are incompatible with the resource being validated result in issues with severity ERROR.", "originalCommit": "e0296dad810834fd951a5d40b9c444160e415499", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzNjYyMA==", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409136620", "bodyText": "and the same change on all the other variants", "author": "lmsurpre", "createdAt": "2020-04-15T21:12:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzNjE0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzODc5Mg==", "url": "https://github.com/IBM/FHIR/pull/934#discussion_r409138792", "bodyText": "Updated Javadoc", "author": "JohnTimm", "createdAt": "2020-04-15T21:16:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEzNjE0Mg=="}], "type": "inlineReview"}, {"oid": "5d7535d237bd3cca399a70cc708a94766c3ab4ac", "url": "https://github.com/IBM/FHIR/commit/5d7535d237bd3cca399a70cc708a94766c3ab4ac", "message": "Issue #933 - added \"type\" into Javadoc to clarify statement\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-15T21:15:47Z", "type": "commit"}, {"oid": "e3c3bac19d50cf3c2d42119c1b3341cba2d05053", "url": "https://github.com/IBM/FHIR/commit/e3c3bac19d50cf3c2d42119c1b3341cba2d05053", "message": "Issue #933 - added single quotes to issue details\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-15T21:18:47Z", "type": "commit"}, {"oid": "d9308d4d61ffbfdbebe0fb6f539f349565e148cc", "url": "https://github.com/IBM/FHIR/commit/d9308d4d61ffbfdbebe0fb6f539f349565e148cc", "message": "Issue #933 - missed removal of colon in issue details\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-15T21:20:28Z", "type": "commit"}]}