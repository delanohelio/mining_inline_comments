{"pr_number": 1730, "pr_title": "Update the search configuration to reflect new config and reindex", "pr_createdAt": "2020-11-19T10:14:20Z", "pr_url": "https://github.com/IBM/FHIR/pull/1730", "timeline": [{"oid": "fe81a1d52e7a5068d0162881bc566b99c9cec392", "url": "https://github.com/IBM/FHIR/commit/fe81a1d52e7a5068d0162881bc566b99c9cec392", "message": "Update the search configuration to reflect new config and reindex\n\nUpdate the docs to reflect that `fhirServer/searchParameterFilter` has been replaced with `fhirServer/resources/<resourceType>/searchParameters`.\r\n\r\nWe should probably add more documentation to explain `fhirServer/resources/<resourceType>/searchIncludes`, `fhirServer/resources/<resourceType>/searchRevIncludes`, and `fhirServer/resources/<resourceType>/searchParameterCombinations`,\r\nbut for now I just wanted to make sure the stale content was cleaned up.\r\n\r\nI also added a section on using the new `$reindex` operation.\r\n\r\nNote that, rather than update them, I removed some examples and the description of the algorithm to reduce the burden of maintenance.\r\n\r\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-19T10:13:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc0MzkzNA==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r526743934", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The IBM FHIR Server allows deployers to define search parameters on a tenant-specific basis. This allows each tenant to share an instance of the FHIR server while maintaining the ability to have their own set of search parameters. Additionally, specificatin-defined search parameters can be filtered out in order to avoid the cost of extracting and storing the corresponding indices.\n          \n          \n            \n            The IBM FHIR Server allows deployers to define search parameters on a tenant-specific basis. This allows each tenant to share an instance of the FHIR server while maintaining the ability to have their own set of search parameters. Additionally, specification-defined search parameters can be filtered out in order to avoid the cost of extracting and storing the corresponding indices.", "author": "lmsurpre", "createdAt": "2020-11-19T10:15:17Z", "path": "docs/src/pages/guides/FHIRSearchConfiguration.md", "diffHunk": "@@ -7,46 +7,43 @@ markdown: kramdown\n ---\n \n # IBM FHIR Server - Search Configuration Overview\n-The [FHIR Specification](https://www.hl7.org/fhir/r4/search.html) defines a set of searchable fields for each resource type, and corresponding RESTful API.  The IBM FHIR Server supports searching using the specification defined search parameters and using tenant-specific search parameters (extensions).\n+The [FHIR Specification](https://www.hl7.org/fhir/r4/search.html) defines a set of searchable fields for each resource type. The IBM FHIR Server supports searching via both specification-defined search parameters and tenant-specific search parameters.\n \n Specifically, the IBM FHIR Server supports searching on additional fields, including:\n-* fields that are defined in the base specification, which are not configured for search;  \n-* extension elements that a tenant may add to a standard FHIR resource type; and  \n-* attributes that you define as part of a custom resource type  \n+* fields that are defined in the base specification, which are not configured for search; and\n+* extension elements that a tenant may add to a standard FHIR resource type\n \n-The IBM FHIR Server allows deployers to define search parameters on a tenant-specific basis. This allows each tenant to share an instance of the FHIR server while maintaining the ability to have their own set of search parameters.\n+The IBM FHIR Server allows deployers to define search parameters on a tenant-specific basis. This allows each tenant to share an instance of the FHIR server while maintaining the ability to have their own set of search parameters. Additionally, specificatin-defined search parameters can be filtered out in order to avoid the cost of extracting and storing the corresponding indices.", "originalCommit": "fe81a1d52e7a5068d0162881bc566b99c9cec392", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "357cdcfc00f6614b1addc3ab32146b71e0202dbd", "url": "https://github.com/IBM/FHIR/commit/357cdcfc00f6614b1addc3ab32146b71e0202dbd", "message": "fix typo\r\n\r\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-19T10:15:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg3MzU1OQ==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r526873559", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Tenant search parameters are defined via a [Bundle](https://www.hl7.org/fhir/r4/bundle.html) of [SearchParameter](https://www.hl7.org/fhir/r4/searchparameter.html) resources that define the additional search parameters which describe the searchable field and define the FHIRPath expression for extraction.  \\For example, a tenant that extends the `Patient` resource type with the `favorite-color` extension, enables search on `favorite-color` by defining a SearchParameter as part of this bundle.\n          \n          \n            \n            Tenant search parameters are defined via a [Bundle](https://www.hl7.org/fhir/r4/bundle.html) of [SearchParameter](https://www.hl7.org/fhir/r4/searchparameter.html) resources that define the additional search parameters which describe the searchable field and define the FHIRPath expression for extraction.  For example, a tenant that extends the `Patient` resource type with the `favorite-color` extension, enables search on `favorite-color` by defining a SearchParameter as part of this bundle.", "author": "prb112", "createdAt": "2020-11-19T13:19:27Z", "path": "docs/src/pages/guides/FHIRSearchConfiguration.md", "diffHunk": "@@ -7,46 +7,43 @@ markdown: kramdown\n ---\n \n # IBM FHIR Server - Search Configuration Overview\n-The [FHIR Specification](https://www.hl7.org/fhir/r4/search.html) defines a set of searchable fields for each resource type, and corresponding RESTful API.  The IBM FHIR Server supports searching using the specification defined search parameters and using tenant-specific search parameters (extensions).\n+The [FHIR Specification](https://www.hl7.org/fhir/r4/search.html) defines a set of searchable fields for each resource type. The IBM FHIR Server supports searching via both specification-defined search parameters and tenant-specific search parameters.\n \n Specifically, the IBM FHIR Server supports searching on additional fields, including:\n-* fields that are defined in the base specification, which are not configured for search;  \n-* extension elements that a tenant may add to a standard FHIR resource type; and  \n-* attributes that you define as part of a custom resource type  \n+* fields that are defined in the base specification, which are not configured for search; and\n+* extension elements that a tenant may add to a standard FHIR resource type\n \n-The IBM FHIR Server allows deployers to define search parameters on a tenant-specific basis. This allows each tenant to share an instance of the FHIR server while maintaining the ability to have their own set of search parameters.\n+The IBM FHIR Server allows deployers to define search parameters on a tenant-specific basis. This allows each tenant to share an instance of the FHIR server while maintaining the ability to have their own set of search parameters. Additionally, specification-defined search parameters can be filtered out in order to avoid the cost of extracting and storing the corresponding indices.\n \n-A tenant must provide a [Bundle](https://www.hl7.org/fhir/r4/bundle.html) of [SearchParameter](https://www.hl7.org/fhir/r4/searchparameter.html) resources that define the additional search parameters which describe the searchable field and define the FHIRPath expression for extraction.  For example, a tenant that extends the `Patient` resource type with the `favorite-color` extension, enables search on `favorite-color` by defining a SearchParameter as part of this bundle.\n-\n-Note, the [composite](https://www.hl7.org/fhir/r4/codesystem-search-param-type.html#search-param-type-composite) and [special](https://www.hl7.org/fhir/r4/codesystem-search-param-type.html#search-param-type-special) SearchParameter types are not supported.\n+Tenant search parameters are defined via a [Bundle](https://www.hl7.org/fhir/r4/bundle.html) of [SearchParameter](https://www.hl7.org/fhir/r4/searchparameter.html) resources that define the additional search parameters which describe the searchable field and define the FHIRPath expression for extraction.  \\For example, a tenant that extends the `Patient` resource type with the `favorite-color` extension, enables search on `favorite-color` by defining a SearchParameter as part of this bundle.", "originalCommit": "357cdcfc00f6614b1addc3ab32146b71e0202dbd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg3Mzg1OQ==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r526873859", "bodyText": "interesting...", "author": "prb112", "createdAt": "2020-11-19T13:19:51Z", "path": "docs/src/pages/guides/FHIRSearchConfiguration.md", "diffHunk": "@@ -7,46 +7,43 @@ markdown: kramdown\n ---\n \n # IBM FHIR Server - Search Configuration Overview\n-The [FHIR Specification](https://www.hl7.org/fhir/r4/search.html) defines a set of searchable fields for each resource type, and corresponding RESTful API.  The IBM FHIR Server supports searching using the specification defined search parameters and using tenant-specific search parameters (extensions).\n+The [FHIR Specification](https://www.hl7.org/fhir/r4/search.html) defines a set of searchable fields for each resource type. The IBM FHIR Server supports searching via both specification-defined search parameters and tenant-specific search parameters.\n \n Specifically, the IBM FHIR Server supports searching on additional fields, including:\n-* fields that are defined in the base specification, which are not configured for search;  \n-* extension elements that a tenant may add to a standard FHIR resource type; and  \n-* attributes that you define as part of a custom resource type  \n+* fields that are defined in the base specification, which are not configured for search; and\n+* extension elements that a tenant may add to a standard FHIR resource type\n \n-The IBM FHIR Server allows deployers to define search parameters on a tenant-specific basis. This allows each tenant to share an instance of the FHIR server while maintaining the ability to have their own set of search parameters.\n+The IBM FHIR Server allows deployers to define search parameters on a tenant-specific basis. This allows each tenant to share an instance of the FHIR server while maintaining the ability to have their own set of search parameters. Additionally, specification-defined search parameters can be filtered out in order to avoid the cost of extracting and storing the corresponding indices.\n \n-A tenant must provide a [Bundle](https://www.hl7.org/fhir/r4/bundle.html) of [SearchParameter](https://www.hl7.org/fhir/r4/searchparameter.html) resources that define the additional search parameters which describe the searchable field and define the FHIRPath expression for extraction.  For example, a tenant that extends the `Patient` resource type with the `favorite-color` extension, enables search on `favorite-color` by defining a SearchParameter as part of this bundle.\n-\n-Note, the [composite](https://www.hl7.org/fhir/r4/codesystem-search-param-type.html#search-param-type-composite) and [special](https://www.hl7.org/fhir/r4/codesystem-search-param-type.html#search-param-type-special) SearchParameter types are not supported.", "originalCommit": "357cdcfc00f6614b1addc3ab32146b71e0202dbd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg3NDM5Mg==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r526874392", "bodyText": "this is not included as we are deprecating it?", "author": "prb112", "createdAt": "2020-11-19T13:20:41Z", "path": "docs/src/pages/guides/FHIRSearchConfiguration.md", "diffHunk": "@@ -7,46 +7,43 @@ markdown: kramdown\n ---\n \n # IBM FHIR Server - Search Configuration Overview\n-The [FHIR Specification](https://www.hl7.org/fhir/r4/search.html) defines a set of searchable fields for each resource type, and corresponding RESTful API.  The IBM FHIR Server supports searching using the specification defined search parameters and using tenant-specific search parameters (extensions).\n+The [FHIR Specification](https://www.hl7.org/fhir/r4/search.html) defines a set of searchable fields for each resource type. The IBM FHIR Server supports searching via both specification-defined search parameters and tenant-specific search parameters.\n \n Specifically, the IBM FHIR Server supports searching on additional fields, including:\n-* fields that are defined in the base specification, which are not configured for search;  \n-* extension elements that a tenant may add to a standard FHIR resource type; and  \n-* attributes that you define as part of a custom resource type  \n+* fields that are defined in the base specification, which are not configured for search; and\n+* extension elements that a tenant may add to a standard FHIR resource type\n \n-The IBM FHIR Server allows deployers to define search parameters on a tenant-specific basis. This allows each tenant to share an instance of the FHIR server while maintaining the ability to have their own set of search parameters.\n+The IBM FHIR Server allows deployers to define search parameters on a tenant-specific basis. This allows each tenant to share an instance of the FHIR server while maintaining the ability to have their own set of search parameters. Additionally, specification-defined search parameters can be filtered out in order to avoid the cost of extracting and storing the corresponding indices.\n \n-A tenant must provide a [Bundle](https://www.hl7.org/fhir/r4/bundle.html) of [SearchParameter](https://www.hl7.org/fhir/r4/searchparameter.html) resources that define the additional search parameters which describe the searchable field and define the FHIRPath expression for extraction.  For example, a tenant that extends the `Patient` resource type with the `favorite-color` extension, enables search on `favorite-color` by defining a SearchParameter as part of this bundle.\n-\n-Note, the [composite](https://www.hl7.org/fhir/r4/codesystem-search-param-type.html#search-param-type-composite) and [special](https://www.hl7.org/fhir/r4/codesystem-search-param-type.html#search-param-type-special) SearchParameter types are not supported.\n+Tenant search parameters are defined via a [Bundle](https://www.hl7.org/fhir/r4/bundle.html) of [SearchParameter](https://www.hl7.org/fhir/r4/searchparameter.html) resources that define the additional search parameters which describe the searchable field and define the FHIRPath expression for extraction.  \\For example, a tenant that extends the `Patient` resource type with the `favorite-color` extension, enables search on `favorite-color` by defining a SearchParameter as part of this bundle.\n \n ## 1 Configuration\n There are three layers of search parameter configuration.  \n-- specification defined\n-- default\n-- tenant-specific\n-\n-The specification defined SearchParameters are embedded as [a JSON file](https://github.com/IBM/FHIR/blob/master/fhir-search/src/main/resources/search-parameters.json) in the `fhir-search` module.", "originalCommit": "357cdcfc00f6614b1addc3ab32146b71e0202dbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg3NDk1OA==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r526874958", "bodyText": "or include in 1.1.1?", "author": "prb112", "createdAt": "2020-11-19T13:21:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg3NDM5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkxMjA0MA==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r526912040", "bodyText": "this file is deleted and gone from the repo already.  we get the search parameters from the registry now.", "author": "lmsurpre", "createdAt": "2020-11-19T14:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg3NDM5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg3NzEzOA==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r526877138", "bodyText": "is tenant-name actually used with postgres?", "author": "prb112", "createdAt": "2020-11-19T13:25:04Z", "path": "docs/src/pages/guides/FHIRSearchConfiguration.md", "diffHunk": "@@ -166,81 +192,44 @@ For reference, the following is the list of codes in this category:\n \n Note: `_content` and `_query` are not yet supported by the IBM FHIR Server.\n \n-The filter `\"*\": [\"*\"]` is not necessary to include these Resource-level parameters.\n-The following sections presents several examples.\n-\n-#### 1.2.1 Example 1\n-In the following example, a single inclusion rule uses wildcards to instruct the FHIR server to include any search parameter for any resource type. This is also the default behavior of the server when the `fhirServer/searchParameterFilter` configuration property is not set:\n-\n-```\n-{\n-    \"fhirServer\": {\n-        \"__comment\": \"include all search parameters for all resource types (default)\",\n-        \"searchParameterFilter\": {\n-            \"*\": [ \"*\" ]\n-        }\n-    }\n-}\n-```\n-\n-#### 1.2.2 Example 2\n-In the following example, inclusion rules are specified for a few specific resource types, and then wildcards are used to include search parameters for the remaining resource types:\n+The filter `\"*\": \"*\"` is not necessary to include these Resource-level parameters.\n \n-```\n-{\n-    \"__comment\": \"FHIR server configuration\",\n-    \"fhirServer\": {\n-        \"searchParameterFilter\": {\n-            \"Device\": [ patient\", \"organization\" ],\n-            \"Observation\": [ \"code\" ],\n-            \"Patient\": [\n-                    \"active\",\n-                    \"address\",\n-                    \"birthdate\",\n-                    \"name\"\n-            ],\n-            \"Resource\": [\"_id\", \"_lastUpdated\"],\n-            \"*\": [ \"*\" ]\n-        }\n-    }\n-}\n-```\n-\n-For Device resources, only the `patient` and `organization` search parameters are included, while for `Observation` resources, only the `code` search parameter is included. For `Patient` resources, you can see that the `active`, `address`, `birthdate` and `name` search parameters are included. Finally, for any other resource types, all of their built-in search parameters are included in the server's view when storing resources or performing search operations.\n-\n-Note that if this example did not include the last inclusion rule, then no other resource type's built-in search parameters would be included.\n-\n-##### 1.2.3 Summary of the inclusion rules and filtering algorithm\n-Here are some rules about the rules:\n-1.   Each rule specifies a resource type name and a JSON array of search parameter codes.\n-2.   A resource type should appear in at most one rule. In other words, you cannot specify two or more inclusion rules with the same resource types.\n-3.   At most one rule can specify the wildcard (`*`) for the resource type, and it should appear as the last rule in the map.\n-\n-This is how the filtering algorithm works:\n-1.   When retrieving the built-in search parameters for a particular resource type, the FHIR server will retrieve the rule associated with that resource type, if one exists. If one doesn't exist, then the rule for the wildcard resource type (`\"*\"`) is retrieved if it exists.\n-2.   If no inclusion rule was found in Step 1 (that is, the resource type in question has no rule and there's no rule containing a wildcard for the resource type), then no built-in search parameters for this resource type will be included in the FHIR server's view of search parameters while storing a resource of performing a search operation.\n-3.   Using the search parameter codes associated with the rule retrieved in Step 1, the FHIR server will apply the rule to each built-in search parameter defined for that resource type.If the search parameter's code is found within the inclusion rule's list of search parameter codes or the inclusion rule's list of codes includes the wildcard (`\"*\"`), then the search parameter will be included in the FHIR server's view of search parameters for that resource type.\n-\n-#### 1.2.4 Handling unexpected search parameters\n+#### 1.2.1 Handling unexpected search parameters\n The IBM FHIR Server supports configurable handling of unknown or unsupported search parameters as defined at https://ibm.github.io/FHIR/Conformance#http-headers.\n Filtered search parameters are handled exactly the same as undefined search parameters, meaning that searches which include these parameters will fail in `strict` mode.\n \n-#### 1.2.5 fhir-server-config.json properties\n-The following properties are available to configure searchParameterFilter:\n+##  2 Re-index\n+Reindexing is implemented as a custom operation that tells the server to read a set of resources and replace the existing search parameters with those newly extracted from the resource body.\n+\n+The `$reindex` operation can be invoked via an HTTP(s) POST to `[base]/$reindex`. By default, the operation will select 10 resources and re-extract their search parameters values based on the current configuration of the server. The operation supports the following parameters to control the behavior:\n+|name|type|description|\n+|----|----|-----------|\n+|`_tstamp`|string|Reindex any resource not previously reindexed before this timestamp. Format as a date YYYY-MM-DD or time YYYY-MM-DDTHH:MM:DDZ.|\n+|`_resourceCount`|integer|The maximum number of resources to reindex in this call. If this number is too large, the processing time might exceed the transaction timeout and fail.|\n \n-##### 1.2.5.1 Default property values\n-| Property Name                 | Default value   |\n-|-------------------------------| ----------------|\n-|`fhirServer/searchParameterFilter`|`\"*\": [\"*\"]`|\n+To aid the re-indexing process, the IBM FHIR Server team has introduced some new features into the fhir-bucket resource-loading tool for driving the reindex. The fhir-bucket tool uses a thread-pool to make concurrent POST requests to the IBM FHIR Server `$reindex` custom operation.\n \n-##### 1.2.5.2 Property attributes\n-| Property Name                 | Tenant-specific? | Dynamic? |\n-|-------------------------------|------------------|----------|\n-|`fhirServer/searchParameterFilter`|Y|Y|\n+To run the reindex step, see this example (using PostgreSQL):\n \n-In general, the configuration properties for a particular tenant are stored in the `<WLP_HOME>/wlp/usr/servers/fhir-server/config/<tenant-id>/fhir-server-config.json` file, where `<tenant-id>` refers to the tenant's \"short name\" or tenant id. The global configuration is considered to be associated with a tenant named `default`, so those properties are stored in the `<WLP_HOME>/wlp/usr/servers/fhir-server/config/default/fhir-server-config.json` file. Similarly, tenant-specific search parameters are found at `<WLP_HOME>/wlp/usr/servers/fhir-server/config/<tenant-id>/extension-search-parameters.json` whereas the global/default extension search parameters are at `<WLP_HOME>/wlp/usr/servers/fhir-server/config/default/extension-search-parameters.json`. Search parameters are handled like a single configuration property; providing a tenant-specific file will override the global/default extension search parameters.\n+```\n+JAR=\"/path/to/fhir-bucket-4.5.0-cli.jar\"\n+\n+java \\\n+  -Djava.util.logging.config.file=logging.properties \\\n+  -jar \"${JAR}\" \\\n+  --db-type postgresql \\\n+  --fhir-properties fhir.properties \\\n+  --tenant-name \"YOUR-TENANT-NAME\" \\", "originalCommit": "357cdcfc00f6614b1addc3ab32146b71e0202dbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkxMzM4OA==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r526913388", "bodyText": "I don't think it is, but I copied these argument right from what @punktilious put in our 4.5.0 release notes.  I know we have #1640 for cleaning up the arguments needed by this utility, so hopefully we can clean up this doc as part of that.", "author": "lmsurpre", "createdAt": "2020-11-19T14:07:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg3NzEzOA=="}], "type": "inlineReview"}, {"oid": "98aca21a55c5a1a0b716655f631b0696f53f20e7", "url": "https://github.com/IBM/FHIR/commit/98aca21a55c5a1a0b716655f631b0696f53f20e7", "message": "fix typo\r\n\r\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>\n\nCo-authored-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-11-19T14:08:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk0NjcwOA==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r526946708", "bodyText": "The markdown shows a backslash in the text here, not sure why:\n...expression for extraction. \\For example, a tenant that extends...", "author": "tbieste", "createdAt": "2020-11-19T14:51:15Z", "path": "docs/src/pages/guides/FHIRSearchConfiguration.md", "diffHunk": "@@ -7,46 +7,43 @@ markdown: kramdown\n ---\n \n # IBM FHIR Server - Search Configuration Overview\n-The [FHIR Specification](https://www.hl7.org/fhir/r4/search.html) defines a set of searchable fields for each resource type, and corresponding RESTful API.  The IBM FHIR Server supports searching using the specification defined search parameters and using tenant-specific search parameters (extensions).\n+The [FHIR Specification](https://www.hl7.org/fhir/r4/search.html) defines a set of searchable fields for each resource type. The IBM FHIR Server supports searching via both specification-defined search parameters and tenant-specific search parameters.\n \n Specifically, the IBM FHIR Server supports searching on additional fields, including:\n-* fields that are defined in the base specification, which are not configured for search;  \n-* extension elements that a tenant may add to a standard FHIR resource type; and  \n-* attributes that you define as part of a custom resource type  \n+* fields that are defined in the base specification, which are not configured for search; and\n+* extension elements that a tenant may add to a standard FHIR resource type\n \n-The IBM FHIR Server allows deployers to define search parameters on a tenant-specific basis. This allows each tenant to share an instance of the FHIR server while maintaining the ability to have their own set of search parameters.\n+The IBM FHIR Server allows deployers to define search parameters on a tenant-specific basis. This allows each tenant to share an instance of the FHIR server while maintaining the ability to have their own set of search parameters. Additionally, specification-defined search parameters can be filtered out in order to avoid the cost of extracting and storing the corresponding indices.\n \n-A tenant must provide a [Bundle](https://www.hl7.org/fhir/r4/bundle.html) of [SearchParameter](https://www.hl7.org/fhir/r4/searchparameter.html) resources that define the additional search parameters which describe the searchable field and define the FHIRPath expression for extraction.  For example, a tenant that extends the `Patient` resource type with the `favorite-color` extension, enables search on `favorite-color` by defining a SearchParameter as part of this bundle.\n-\n-Note, the [composite](https://www.hl7.org/fhir/r4/codesystem-search-param-type.html#search-param-type-composite) and [special](https://www.hl7.org/fhir/r4/codesystem-search-param-type.html#search-param-type-special) SearchParameter types are not supported.\n+Tenant search parameters are defined via a [Bundle](https://www.hl7.org/fhir/r4/bundle.html) of [SearchParameter](https://www.hl7.org/fhir/r4/searchparameter.html) resources that define the additional search parameters which describe the searchable field and define the FHIRPath expression for extraction.  For example, a tenant that extends the `Patient` resource type with the `favorite-color` extension, enables search on `favorite-color` by defining a SearchParameter as part of this bundle.", "originalCommit": "98aca21a55c5a1a0b716655f631b0696f53f20e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODM5OTA2NA==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r528399064", "bodyText": "I think I fixed this one previously", "author": "lmsurpre", "createdAt": "2020-11-22T20:21:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk0NjcwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk0OTY2Mw==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r526949663", "bodyText": "Suggest back-tick quote \"extension-search-parameters.json\" for acme, so be consistent with qpharma.", "author": "tbieste", "createdAt": "2020-11-19T14:54:54Z", "path": "docs/src/pages/guides/FHIRSearchConfiguration.md", "diffHunk": "@@ -7,46 +7,43 @@ markdown: kramdown\n ---\n \n # IBM FHIR Server - Search Configuration Overview\n-The [FHIR Specification](https://www.hl7.org/fhir/r4/search.html) defines a set of searchable fields for each resource type, and corresponding RESTful API.  The IBM FHIR Server supports searching using the specification defined search parameters and using tenant-specific search parameters (extensions).\n+The [FHIR Specification](https://www.hl7.org/fhir/r4/search.html) defines a set of searchable fields for each resource type. The IBM FHIR Server supports searching via both specification-defined search parameters and tenant-specific search parameters.\n \n Specifically, the IBM FHIR Server supports searching on additional fields, including:\n-* fields that are defined in the base specification, which are not configured for search;  \n-* extension elements that a tenant may add to a standard FHIR resource type; and  \n-* attributes that you define as part of a custom resource type  \n+* fields that are defined in the base specification, which are not configured for search; and\n+* extension elements that a tenant may add to a standard FHIR resource type\n \n-The IBM FHIR Server allows deployers to define search parameters on a tenant-specific basis. This allows each tenant to share an instance of the FHIR server while maintaining the ability to have their own set of search parameters.\n+The IBM FHIR Server allows deployers to define search parameters on a tenant-specific basis. This allows each tenant to share an instance of the FHIR server while maintaining the ability to have their own set of search parameters. Additionally, specification-defined search parameters can be filtered out in order to avoid the cost of extracting and storing the corresponding indices.\n \n-A tenant must provide a [Bundle](https://www.hl7.org/fhir/r4/bundle.html) of [SearchParameter](https://www.hl7.org/fhir/r4/searchparameter.html) resources that define the additional search parameters which describe the searchable field and define the FHIRPath expression for extraction.  For example, a tenant that extends the `Patient` resource type with the `favorite-color` extension, enables search on `favorite-color` by defining a SearchParameter as part of this bundle.\n-\n-Note, the [composite](https://www.hl7.org/fhir/r4/codesystem-search-param-type.html#search-param-type-composite) and [special](https://www.hl7.org/fhir/r4/codesystem-search-param-type.html#search-param-type-special) SearchParameter types are not supported.\n+Tenant search parameters are defined via a [Bundle](https://www.hl7.org/fhir/r4/bundle.html) of [SearchParameter](https://www.hl7.org/fhir/r4/searchparameter.html) resources that define the additional search parameters which describe the searchable field and define the FHIRPath expression for extraction.  For example, a tenant that extends the `Patient` resource type with the `favorite-color` extension, enables search on `favorite-color` by defining a SearchParameter as part of this bundle.\n \n ## 1 Configuration\n There are three layers of search parameter configuration.  \n-- specification defined\n-- default\n-- tenant-specific\n-\n-The specification defined SearchParameters are embedded as [a JSON file](https://github.com/IBM/FHIR/blob/master/fhir-search/src/main/resources/search-parameters.json) in the `fhir-search` module.\n+- built-in parameters from the core specification and packaged implementation guides\n+- default tenant parameters\n+- tenant-specific parameters\n \n-Note, the search-parameters.json and search-parameters.xml in the `fhir-search` module match the latest definition resource from the [FHIR download site](http://hl7.org/fhir/r4/downloads.html).\n+The built-in SearchParameters are loaded from the `fhir-registry` in the `fhir-search` module during server startup.\n \n The default and tenant level configurations are put in the `default` and tenant-specific (e.g. `tenant1`) config folders respectively. These folders are populated with `extension-search-parameters.json`.\n \n The IBM FHIR Server configuration prefers the JSON formatted configuration documents, and implements caching via [TenantSpecificSearchParameterCache.java](https://github.com/IBM/FHIR/blob/master/fhir-search/src/main/java/com/ibm/fhir/search/parameters/cache/TenantSpecificSearchParameterCache.java).\n \n-The IBM FHIR Server supports compartment searches based on the CompartmentDefinition resources found at [fhir-search/src/main/resources/compartments.json](https://github.com/IBM/FHIR/blob/master/fhir-search/src/main/resources/compartments.json).  These definitions come directly from the specification and the server provides no corresponding default or tenant-level configuration.\n+The IBM FHIR Server supports compartment searches based on the CompartmentDefinition resources found at [fhir-search/src/main/resources/compartments.json](https://github.com/IBM/FHIR/blob/master/fhir-search/src/main/resources/compartments.json). These definitions come directly from the specification and the server provides no corresponding default or tenant-level configuration.\n \n-### 1.1 Configuration per Tenant\n+### 1.1 Tenant-specific parameters\n To configure tenant-specific search parameters, create a file called `extension-search-parameters.json`, placing it in the `${server.config.dir}/config/<tenant-id>` directory. For example, the `${server.config.dir}/config/acme/extension-search-parameters.json` file would contain the search parameters for the `acme` tenant, while `${server.config.dir}/config/qpharma/extension-search-parameters.json` would contain search parameters used by the `qpharma` tenant.\n \n-When the FHIR server processes a request associated with the `acme` tenant, the server is only aware of the set of built-in search parameters (defined by the HL7 FHIR specification) plus the user-defined search parameters defined in the `acme` tenant's extension-search-parameters.json file. Likewise, when processing a request associated with the `qpharma` tenant, the server is only aware of the built-in search parameters plus the user-defined search parameters defined in the `qpharma` tenant's `extension-search-parameters.json` file.\n+When the FHIR server processes a request associated with the `acme` tenant, the server is uses the built-in search parameters and the user-defined search parameters defined in the `acme` tenant's extension-search-parameters.json file. Likewise, when processing a request associated with the `qpharma` tenant, the server uses the built-in search parameters and the user-defined search parameters defined in the `qpharma` tenant's `extension-search-parameters.json` file.", "originalCommit": "98aca21a55c5a1a0b716655f631b0696f53f20e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODM5NzYzOQ==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r528397639", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            When the FHIR server processes a request associated with the `acme` tenant, the server is uses the built-in search parameters and the user-defined search parameters defined in the `acme` tenant's extension-search-parameters.json file. Likewise, when processing a request associated with the `qpharma` tenant, the server uses the built-in search parameters and the user-defined search parameters defined in the `qpharma` tenant's `extension-search-parameters.json` file.\n          \n          \n            \n            When the FHIR server processes a request associated with the `acme` tenant, the server is uses the built-in search parameters and the user-defined search parameters defined in the `acme` tenant's `extension-search-parameters.json` file. Likewise, when processing a request associated with the `qpharma` tenant, the server uses the built-in search parameters and the user-defined search parameters defined in the `qpharma` tenant's `extension-search-parameters.json` file.", "author": "lmsurpre", "createdAt": "2020-11-22T20:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk0OTY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk1MzA2Ng==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r526953066", "bodyText": "Suggest back-tick \"Basic.extension.where(url='http://example.org/decimal').value.as(Decimal)\" so the hyperlink highlighting isn't weird.", "author": "tbieste", "createdAt": "2020-11-19T14:58:57Z", "path": "docs/src/pages/guides/FHIRSearchConfiguration.md", "diffHunk": "@@ -103,52 +100,81 @@ A few things to note are:\n \n In the preceding example, extension elements (on a Patient resource) with a url of `http://ibm.com/fhir/extension/Patient/favorite-color` are indexed by the `favorite-color` search parameter. To search for Patients with a favorite color of \"pink\", users could send an HTTP GET request to a URL like `[base]/api/v1/Patient?favorite-color:exact=pink`.\n \n-For more information on search parameters, see the HL7 FHIR specification.\n+For more information on search parameters, see the [HL7 FHIR specification](https://www.hl7.org/fhir/R4/searchparameter.html).\n \n #### 1.1.2 Recommendations\n-When creating the SearchParameter FHIRPath expression, one should test the FHIRPath expression and test the search parameter.\n+When creating the SearchParameter FHIRPath expression, be sure to test both the FHIRPath expression and the search parameter.\n \n If a search parameter expression extracts an element with a data type that is incompatible with the declared search parameter type, the server skips the value and logs a message. For choice elements, like Extension.value, its recommended to restrict the expression to values of the desired type by using the `as` function. For example, to select only Decimal values from the http://example.org/demical extension, use an expressions like Basic.extension.where(url='http://example.org/decimal').value.as(Decimal).", "originalCommit": "98aca21a55c5a1a0b716655f631b0696f53f20e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODM5NzkwOA==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r528397908", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If a search parameter expression extracts an element with a data type that is incompatible with the declared search parameter type, the server skips the value and logs a message. For choice elements, like Extension.value, its recommended to restrict the expression to values of the desired type by using the `as` function. For example, to select only Decimal values from the http://example.org/demical extension, use an expressions like Basic.extension.where(url='http://example.org/decimal').value.as(Decimal).\n          \n          \n            \n            If a search parameter expression extracts an element with a data type that is incompatible with the declared search parameter type, the server skips the value and logs a message. For choice elements, like Extension.value, its recommended to restrict the expression to values of the desired type by using the `as` function. For example, to select only Decimal values from the http://example.org/demical extension, use an expressions like `Basic.extension.where(url='http://example.org/decimal').value.as(Decimal)`.", "author": "lmsurpre", "createdAt": "2020-11-22T20:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk1MzA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk2MDIyNQ==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r526960225", "bodyText": "Suggest having on of these resource types have \"*\": \"*\" for example.", "author": "tbieste", "createdAt": "2020-11-19T15:07:56Z", "path": "docs/src/pages/guides/FHIRSearchConfiguration.md", "diffHunk": "@@ -103,52 +100,81 @@ A few things to note are:\n \n In the preceding example, extension elements (on a Patient resource) with a url of `http://ibm.com/fhir/extension/Patient/favorite-color` are indexed by the `favorite-color` search parameter. To search for Patients with a favorite color of \"pink\", users could send an HTTP GET request to a URL like `[base]/api/v1/Patient?favorite-color:exact=pink`.\n \n-For more information on search parameters, see the HL7 FHIR specification.\n+For more information on search parameters, see the [HL7 FHIR specification](https://www.hl7.org/fhir/R4/searchparameter.html).\n \n #### 1.1.2 Recommendations\n-When creating the SearchParameter FHIRPath expression, one should test the FHIRPath expression and test the search parameter.\n+When creating the SearchParameter FHIRPath expression, be sure to test both the FHIRPath expression and the search parameter.\n \n If a search parameter expression extracts an element with a data type that is incompatible with the declared search parameter type, the server skips the value and logs a message. For choice elements, like Extension.value, its recommended to restrict the expression to values of the desired type by using the `as` function. For example, to select only Decimal values from the http://example.org/demical extension, use an expressions like Basic.extension.where(url='http://example.org/decimal').value.as(Decimal).\n \n-### 1.2 Configuration: Filtering of search parameters\n-The FHIR server supports the filtering of built-in search parameters (that is, search parameters defined by the HL7 FHIR specification for each resource type). The default behavior of the FHIR server is to consider all built-in search parameters when storing resources or processing search requests, but you can configure inclusion filters to restrict the FHIR server's view to specific search parameters on a given resource type. This filtering feature does not apply to user-defined search parameters in the extension-search-parameters.json file. User-defined search parameters are always included in the FHIR server's view regardless of the configured inclusion filters.\n+### 1.2 Filtering\n+The FHIR server supports the filtering of built-in search parameters. The default behavior of the FHIR server is to consider all built-in search parameters when storing resources or processing search requests, but you can configure inclusion filters to restrict the FHIR server's view to specific search parameters on a given resource type. This filtering feature does not apply to user-defined search parameters in the extension-search-parameters.json file. User-defined search parameters are always included in the FHIR server's view regardless of the configured inclusion filters.\n \n Why would you want to filter built-in search parameters? The answer lies in how search parameters are used by the FHIR server. When the FHIR server processes a _create_ or _update_ operation, it stores the resource contents in the datastore, along with search index information that is used by the FHIR server when performing search operations. The search index information stored for a particular resource instance is driven by the search parameters defined for that resource type. Therefore if you are storing a resource whose type has a lot of built-in search parameters defined for it (e.g. `Patient`), then you could potentially be storing a lot of search index information for each resource.\n \n-For performance and scalability reasons, it might be desirable to limit the number of search parameters considered during a _create_ or _update_ operation for particular resource types, if those search parameters will never be used in search operations. After all, if there will be no need to use the search index information, there's no need to store it. For example, if you know that due to the way in which a particular tenant's applications use the FHIR REST API that those applications will never need to search Patients by birthdate, then there would be no need to store search index information for the `birthdate` attribute in `Patient` resources. And consequently, you could filter out the `birthdate` search parameter for the `Patient` resource type and not lose any needed functionality, but yet save a little bit of storage capacity in your datastore.\n+For performance and scalability reasons, it might be desirable to limit the number of search parameters considered during a _create_ or _update_ operation for particular resource types, if those search parameters will never be used in search operations. After all, if there will be no need to use the search index information, there's no need to store it. For example, if you know that due to the way in which a particular tenant's applications use the FHIR REST API that those applications will never need to search Patients by birthdate, then there would be no need to store search index information for the `birthdate` attribute in `Patient` resources. Consequently, you could filter out the `birthdate` search parameter for the `Patient` resource type and not lose any needed functionality, but yet save a little bit of storage capacity in your datastore.\n \n-The search parameter filtering feature is supported through a set of inclusion rules specified via the `fhirServer/searchParameterFilter` configuration property. The search parameter inclusion rules allow you to define a set of search parameters per resource type that should be included in the FHIR server's view of search parameters when storing resources and performing search operations. The rules also allow you to specify a wildcard for resource types and also for search parameter. The following example shows the general form for specifying inclusion rules:\n+The search parameter filtering feature is supported through a set of inclusion rules specified via the `fhirServer/resources` property group in `fhir-server-config.json`. The search parameter inclusion rules allow you to define a set of search parameters per resource type that should be included in the FHIR server's view of search parameters when storing resources and performing search operations. The following snippet shows the general form for specifying inclusion rules:\n \n ```\n-{\n-    \"fhirServer\": {\n-        \"searchParameterFilter\": {\n-            \"&lt;resource type1&gt;\": [\n-                \"sp-name1\",\n-                \"sp-name2\",\n-                ...,\n-                \"sp-namen\"\n-            ],\n-            \"&lt;resource type2&gt;\": [\n-                \"sp-name1\",\n-                \"sp-name2\",\n-                ...,\n-                \"sp-namen\"\n-            ],\n-            \"&lt;resource type3&gt;\": [ \"*\" ],\n-            \"*\": [ \"*\" ]\n+\"resources\": {\n+    \"open\": false,\n+    \"CarePlan\": {\n+        \"searchParameters\": {}\n+    },\n+    \"ExplanationOfBenefit\": {\n+        \"searchParameters\": {\n+            \"_id\": \"http://hl7.org/fhir/SearchParameter/Resource-id\",\n+            \"_lastUpdated\": \"http://hl7.org/fhir/SearchParameter/Resource-lastUpdated\",\n+            \"patient\": \"http://hl7.org/fhir/us/carin-bb/SearchParameter/explanationofbenefit-patient\",\n+            \"type\": \"http://hl7.org/fhir/us/carin-bb/SearchParameter/explanationofbenefit-type\",\n+            \"identifier\": \"http://hl7.org/fhir/us/carin-bb/SearchParameter/explanationofbenefit-identifier\",\n+            \"service-date\": \"http://hl7.org/fhir/us/carin-bb/SearchParameter/explanationofbenefit-service-date\"\n         }\n+    },\n+    \"Patient\": {", "originalCommit": "98aca21a55c5a1a0b716655f631b0696f53f20e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODM5ODY1OQ==", "url": "https://github.com/IBM/FHIR/pull/1730#discussion_r528398659", "bodyText": "Since leaving out searchParameters entirely is equivalent to having a single entry with \"*\": \"*\", I don't think it should be common to need \"*\": \"*\".\nI do cover the scenario where \"*\": \"*\" is useful below (line 147).", "author": "lmsurpre", "createdAt": "2020-11-22T20:18:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk2MDIyNQ=="}], "type": "inlineReview"}, {"oid": "228a0862cf399045a705df07268f83e84d57a12a", "url": "https://github.com/IBM/FHIR/commit/228a0862cf399045a705df07268f83e84d57a12a", "message": "Apply suggestions from code review\r\n\r\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-11-22T20:19:32Z", "type": "commit"}]}