{"pr_number": 1234, "pr_title": "Issue 876 - Postgres SQL Automation", "pr_createdAt": "2020-06-16T18:44:02Z", "pr_url": "https://github.com/IBM/FHIR/pull/1234", "timeline": [{"oid": "aca9d5ed0eb2d3b8cc6fdcbbbded0cbf63500b17", "url": "https://github.com/IBM/FHIR/commit/aca9d5ed0eb2d3b8cc6fdcbbbded0cbf63500b17", "message": "Merge pull request #16 from IBM/master\n\nSync up", "committedDate": "2020-06-15T13:54:23Z", "type": "commit"}, {"oid": "71225ccfc46d64ecebc31409c48c1997f8ef833d", "url": "https://github.com/IBM/FHIR/commit/71225ccfc46d64ecebc31409c48c1997f8ef833d", "message": "Merge pull request #17 from IBM/master\n\nMerge", "committedDate": "2020-06-16T17:46:29Z", "type": "commit"}, {"oid": "1286af4c03262cbf500701f6c8fbdba8e0c77fa6", "url": "https://github.com/IBM/FHIR/commit/1286af4c03262cbf500701f6c8fbdba8e0c77fa6", "message": "Issue 876b (#19)\n\n* Introduce Persistence Layer Automation Framework #876\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Postgres SQL Automation\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fix Files\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fix Files\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fix Files\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fix\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fix\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Update\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Update\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Update\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* fix\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fix\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fix\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fix\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fix\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fix\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fix\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fixup\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fixup\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fixup\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fixup\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fix\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Postgres Fix\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Postgres Fix\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Update postgres\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Update postgres\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fix for Postgres Build\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\n* Fix for multistore\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-06-16T18:45:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA5ODA1OA==", "url": "https://github.com/IBM/FHIR/pull/1234#discussion_r441098058", "bodyText": "no?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |bin/gather-logs.sh|Gathers the logs for the build, no|\n          \n          \n            \n            |bin/gather-logs.sh|Gathers the logs from the build|", "author": "lmsurpre", "createdAt": "2020-06-16T19:41:33Z", "path": "build/persistence/README.md", "diffHunk": "@@ -0,0 +1,51 @@\n+# End-to-End Automation Framework for Pesistence Layer Integration Tests\n+\n+This document outlines the end-to-end persistence automation framework. \n+\n+The automation runs with these steps: \n+\n+- **Checkout source code** - Checks out the git code and populates the `github` environment variables.\n+- **Set up java** - Downloads and setup java based on the matrix values `matrix.java`.\n+- **Setup prerequisites** - This step builds the required artifacts necessary to test the build with the persistence layer. \n+- **Server Integration Tests - Additional Persistence Layers** - The step executes the pre-integration-docker, then integration-test-docker and runs the post-integration-docker scripts.\n+- **Gather error logs** - This step only runs upon an error condition. \n+- **Upload logs** - The step uploads the results of the integration tests and the error condition logs are posted to the job. \n+\n+The GitHub Action is parameterized with a matrix for each new persistence layer added. Each additional entry in the array ends up greating a multiple of the automation steps which must complete successfully for the workflow. For instance, postgres is parameterized and executes a job for each persistence layer value in the matrix (one java x one persistence = 1 workflow job). \n+\n+``` yaml\n+    strategy:\n+    matrix:\n+        java: [ 'openjdk11' ]\n+        persistence: [ 'postgres' ]\n+    fail-fast: false\n+```\n+\n+Each persistence layer that is tested as part of the framework uses the default build files and the files that match the persistence name added to the `persistence.yml`.\n+\n+|Filename|Purpose|\n+|----------|----------------|\n+|bin/gather-logs.sh|Gathers the logs for the build, no|", "originalCommit": "1286af4c03262cbf500701f6c8fbdba8e0c77fa6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNTg5Nw==", "url": "https://github.com/IBM/FHIR/pull/1234#discussion_r441105897", "bodyText": "as per albert's comment, this doesn't seem to match the user created in build/persistence/postgres/resources/db.sql ...how does it work?", "author": "lmsurpre", "createdAt": "2020-06-16T19:56:20Z", "path": "fhir-server/liberty-config/config/default/fhir-server-config-postgresql.json", "diffHunk": "@@ -30,10 +30,10 @@\n                 \"default\": {\n                     \"type\": \"postgresql\",\n                     \"connectionProperties\": {\n-                        \"serverName\": \"localhost\",\n+                        \"serverName\": \"postgres_postgres_1\",\n                         \"portNumber\": 5432,\n-                        \"databaseName\": \"fhirdata\",\n-                        \"user\": \"fhirserver\",\n+                        \"databaseName\": \"fhirdb\",\n+                        \"user\": \"fhiradmin\",", "originalCommit": "1286af4c03262cbf500701f6c8fbdba8e0c77fa6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwOTY5Ng==", "url": "https://github.com/IBM/FHIR/pull/1234#discussion_r441109696", "bodyText": "now I see that it:\n\ncreates this system user in the dockerfile; and\ncreates this fhiradmin db user as the FHIRDB owner in the entry-point https://github.com/IBM/FHIR/pull/1234/files#diff-6d0acfaa35776bfcbc9f9cec15f60f6dR40\n\ndo the users created in db.sql still work?", "author": "lmsurpre", "createdAt": "2020-06-16T20:03:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNTg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExOTEwMw==", "url": "https://github.com/IBM/FHIR/pull/1234#discussion_r441119103", "bodyText": "yeah - they still work.  I'll clear this up later on, but great points, I only meant FHIRADMIN to deploy the schema, and fhirserver was meant to test/run it", "author": "prb112", "createdAt": "2020-06-16T20:22:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNTg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgwNjQ2OA==", "url": "https://github.com/IBM/FHIR/pull/1234#discussion_r441806468", "bodyText": "I'm trying this out.  I had meant to keep fhirserver.  I'm going to check/test this, and update the Dockerfile to reflect it.", "author": "prb112", "createdAt": "2020-06-17T20:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNTg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk3Mzg0OQ==", "url": "https://github.com/IBM/FHIR/pull/1234#discussion_r442973849", "bodyText": "Cleaned this up so we create the users as much as possible in the dockerfile.", "author": "prb112", "createdAt": "2020-06-19T17:53:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwNTg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwODM0Mw==", "url": "https://github.com/IBM/FHIR/pull/1234#discussion_r441108343", "bodyText": "does this set a password?", "author": "lmsurpre", "createdAt": "2020-06-16T20:00:53Z", "path": "build/persistence/postgres/Dockerfile", "diffHunk": "@@ -0,0 +1,32 @@\n+###############################################################################\n+# (C) Copyright IBM Corp. 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+###############################################################################\n+\n+FROM postgres:12.3-alpine\n+\n+# Hard Coded environment values\n+ENV POSTGRES_DB fhirdb\n+ENV POSTGRES_USER postgres\n+ENV PGDATA /db/data\n+ENV LANG en_US.utf8\n+\n+# Create a working data directory\n+RUN mkdir -p /db/data && chown -R postgres:postgres /db\n+VOLUME /db/data\n+WORKDIR /db\n+\n+# Open up the port\n+EXPOSE 5432\n+\n+# Load Build Information\n+COPY --chown=postgres:postgres resources/db.sql /docker-entrypoint-initdb.d/db.sql\n+COPY --chown=postgres:postgres resources/docker-entrypoint.sh /docker-entrypoint.sh\n+RUN chmod 755 /docker-entrypoint.sh\n+\n+# Add the fhiradmin user\n+RUN addgroup -S fhir && adduser -S fhiradmin -G fhir\n+RUN echo \"fhiradmin:fhir\" | chpasswd", "originalCommit": "1286af4c03262cbf500701f6c8fbdba8e0c77fa6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTExOTMwMg==", "url": "https://github.com/IBM/FHIR/pull/1234#discussion_r441119302", "bodyText": "yeah - to fhir, I'll fix this", "author": "prb112", "createdAt": "2020-06-16T20:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwODM0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgwNDU5Mg==", "url": "https://github.com/IBM/FHIR/pull/1234#discussion_r441804592", "bodyText": "So it uses chpasswd that's available in alpine examples...\nhttps://linoxide.com/linux-command/change-passwords-batch-mode-chpasswd/", "author": "prb112", "createdAt": "2020-06-17T20:10:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwODM0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgwNTQyMQ==", "url": "https://github.com/IBM/FHIR/pull/1234#discussion_r441805421", "bodyText": "I actually removed this.", "author": "prb112", "createdAt": "2020-06-17T20:11:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwODM0Mw=="}], "type": "inlineReview"}, {"oid": "03e91c2b9c956446d021d871f99d90592b5692f6", "url": "https://github.com/IBM/FHIR/commit/03e91c2b9c956446d021d871f99d90592b5692f6", "message": "Apply suggestions from code review\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\nCo-authored-by: Lee Surprenant <lmsurpre@us.ibm.com>\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-06-17T20:07:06Z", "type": "commit"}, {"oid": "1c11c5377120054b343559e3f9ab476e5e57b1c6", "url": "https://github.com/IBM/FHIR/commit/1c11c5377120054b343559e3f9ab476e5e57b1c6", "message": "Fix up per code-review\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-06-17T20:12:57Z", "type": "commit"}, {"oid": "57dc8ff6d0d37c8384887e2461dbec1c978c35c5", "url": "https://github.com/IBM/FHIR/commit/57dc8ff6d0d37c8384887e2461dbec1c978c35c5", "message": "Fix up per code-review\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-06-17T20:24:46Z", "type": "commit"}, {"oid": "9e16a6d59c805b08a160f8d4c91ec883a0850470", "url": "https://github.com/IBM/FHIR/commit/9e16a6d59c805b08a160f8d4c91ec883a0850470", "message": "Fix up per code-review\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-06-17T23:37:40Z", "type": "commit"}, {"oid": "fc3412605df060ae990e24d60b6163775cd4502d", "url": "https://github.com/IBM/FHIR/commit/fc3412605df060ae990e24d60b6163775cd4502d", "message": "Fix up per code-review\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-06-18T00:09:41Z", "type": "commit"}, {"oid": "e9ccdac2d1a546a82ec3a55ec60352c773a604fe", "url": "https://github.com/IBM/FHIR/commit/e9ccdac2d1a546a82ec3a55ec60352c773a604fe", "message": "Fix up per code-review\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-06-18T00:55:11Z", "type": "commit"}, {"oid": "aba7a71f77404ea77beb3db649f87e8eec7e201e", "url": "https://github.com/IBM/FHIR/commit/aba7a71f77404ea77beb3db649f87e8eec7e201e", "message": "Fix per code review\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-06-19T17:51:03Z", "type": "commit"}, {"oid": "cac1fdfce5ffcf0e6c1a863cc4ce9f4f25a6f85d", "url": "https://github.com/IBM/FHIR/commit/cac1fdfce5ffcf0e6c1a863cc4ce9f4f25a6f85d", "message": "Fix\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-06-19T18:59:56Z", "type": "commit"}, {"oid": "a189c7d5ef954c707e04d2e33f302fc505478c59", "url": "https://github.com/IBM/FHIR/commit/a189c7d5ef954c707e04d2e33f302fc505478c59", "message": "Fix\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-06-20T00:20:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5MzM0OQ==", "url": "https://github.com/IBM/FHIR/pull/1234#discussion_r443093349", "bodyText": "should \"persistence\" be \"<persistence>\" (or similar) to indicate that its a placeholder for a specific persistence impl (postgres in this case)?", "author": "lmsurpre", "createdAt": "2020-06-20T02:24:05Z", "path": "build/persistence/README.md", "diffHunk": "@@ -0,0 +1,51 @@\n+# End-to-End Automation Framework for Pesistence Layer Integration Tests\n+\n+This document outlines the end-to-end persistence automation framework. \n+\n+The automation runs with these steps: \n+\n+- **Checkout source code** - Checks out the git code and populates the `github` environment variables.\n+- **Set up java** - Downloads and setup java based on the matrix values `matrix.java`.\n+- **Setup prerequisites** - This step builds the required artifacts necessary to test the build with the persistence layer. \n+- **Server Integration Tests - Additional Persistence Layers** - The step executes the pre-integration-docker, then integration-test-docker and runs the post-integration-docker scripts.\n+- **Gather error logs** - This step only runs upon an error condition. \n+- **Upload logs** - The step uploads the results of the integration tests and the error condition logs are posted to the job. \n+\n+The GitHub Action is parameterized with a matrix for each new persistence layer added. Each additional entry in the array ends up greating a multiple of the automation steps which must complete successfully for the workflow. For instance, postgres is parameterized and executes a job for each persistence layer value in the matrix (one java x one persistence = 1 workflow job). \n+\n+``` yaml\n+    strategy:\n+    matrix:\n+        java: [ 'openjdk11' ]\n+        persistence: [ 'postgres' ]\n+    fail-fast: false\n+```\n+\n+Each persistence layer that is tested as part of the framework uses the default build files and the files that match the persistence name added to the `persistence.yml`.\n+\n+|Filename|Purpose|\n+|----------|----------------|\n+|bin/gather-logs.sh|Gathers the logs from the build|\n+|bin/integration-test.sh|Run after the tests complete to release resources and package tests results|\n+|persistence/integration-test.sh|Overrides bin/integration-test.sh, replacing the prior test behavior.|\n+|bin/pre-integration-test.sh|Call the pre-integration-test step for `persistence`|\n+|persistence/pre-integration-test.sh|Run before integration-test.sh to startup image and services for the integration testing|\n+|bin/post-integration-test.sh|Call the post-integration-test step for `persistence`|\n+|persistence/post-integration-test.sh|Run after integration-test.sh to stop image and services from the integration testing|\n+|persistence/Dockerfile|The Docker file used in development and end-to-end tests|\n+|persistence/docker-compose.yml|The Docker Compose file used with the end-to-end tests|\n+|persistence/resources| Stores files used to support the end-to-end tests. |\n+|persistence/README.md|Describes the relevant details for this persistence layer.|\n+|persistence/.gitignore|Ignores files related to the persistence layer's tests|\n+|`README.md`|This file describing the framework|", "originalCommit": "a189c7d5ef954c707e04d2e33f302fc505478c59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYyMzM4OA==", "url": "https://github.com/IBM/FHIR/pull/1234#discussion_r443623388", "bodyText": "Fixed - and yes, you are a 100% right", "author": "prb112", "createdAt": "2020-06-22T14:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5MzM0OQ=="}], "type": "inlineReview"}, {"oid": "3a5749f86c0b3a2f658b3bf3ec0ad58b86fb2840", "url": "https://github.com/IBM/FHIR/commit/3a5749f86c0b3a2f658b3bf3ec0ad58b86fb2840", "message": "Fix per review\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-06-22T14:59:16Z", "type": "commit"}, {"oid": "28a30a319894b36f232d3380d53110779a34dc10", "url": "https://github.com/IBM/FHIR/commit/28a30a319894b36f232d3380d53110779a34dc10", "message": "Add Ci-Skip Flag\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-06-23T13:38:33Z", "type": "commit"}, {"oid": "e376c0a1f56c82765e0030122804eed14f944af5", "url": "https://github.com/IBM/FHIR/commit/e376c0a1f56c82765e0030122804eed14f944af5", "message": "Fix Readme.md\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-06-23T13:45:45Z", "type": "commit"}]}