{"pr_number": 1704, "pr_title": "IBM FHIR Schema Tool - Docker Container and Brief Documentation", "pr_createdAt": "2020-11-12T13:40:17Z", "pr_url": "https://github.com/IBM/FHIR/pull/1704", "timeline": [{"oid": "228207d8b837061209e2cd297709181057480fe9", "url": "https://github.com/IBM/FHIR/commit/228207d8b837061209e2cd297709181057480fe9", "message": "feat: a new docker image for ibm-fhir-schematool #1650\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-11-12T13:18:52Z", "type": "commit"}, {"oid": "b9425ecbf9c8d8d7e73fa7b260d0c46a71beb1dd", "url": "https://github.com/IBM/FHIR/commit/b9425ecbf9c8d8d7e73fa7b260d0c46a71beb1dd", "message": "doc: add documentation for development of the ibm-fhir-schematool\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-11-12T13:21:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE1NjAzOQ==", "url": "https://github.com/IBM/FHIR/pull/1704#discussion_r522156039", "bodyText": "is it worth explicitly listing the postgresql properties?\n  --prop \"sslmode=verify-full\"\n  --prop \"sslrootcert=./postgres.cert\"", "author": "lmsurpre", "createdAt": "2020-11-12T14:40:39Z", "path": "fhir-install/src/main/docker/ibm-fhir-schematool/README.md", "diffHunk": "@@ -0,0 +1,182 @@\n+---\n+layout: default\n+title:  IBM FHIR Server - Schema Tool\n+date:   2020-11-11\n+permalink: /ibm-fhir-server-schema-tool/\n+---\n+\n+# IBM FHIR Server - Schema Tool\n+\n+The IBM FHIR Server Schema Tool is designed to create and update the IBM FHIR Server's schema idempotently.\n+\n+The tool supports the following flows in one image: \n+\n+* Onboarding - create SQL schemas, populate the SQL objects, grant permissions to the database user. For db2, the tool sets up a single tenant and tenant key. \n+* Offboarding - removes the schema, on Db2, if no other tenants, it deallocates the tenants\n+* Custom - executes a single fhir-persistence-schema cli action\n+* Debug - outputs debug information\n+\n+# **Use**\n+\n+The solution should set the variables as Environment Variables or mounted into the workarea folder as a volume which contains the persistence.json file.\n+\n+## **Environment Variables**\n+The following environment variables:\n+\n+| Name           | Purpose  |\n+|----------------|----------|\n+| ENV_SKIP       | Stop the container from making any changes, and passes through with a successful state change: `[empty|true|false]`|\n+| ENV_TOOL_INPUT | Encoded String, base64, of the json|\n+| ENV_TOOL_DEBUG | Flags the debug |\n+\n+## Configuration Commandline\n+The following is read from the properties file:\n+\n+| Name       | Purpose  |\n+|------------|----------|\n+| tool.behavior | Switches from the Onboarding BEHAVIOR to Offboarding BEHAVIOR flow: `[onboard|offboard|debug|custom]`. |\n+| db.type | The database type - `[postgres|db2]` |\n+| db.host | The database server hostname|\n+| db.port | The database server port|\n+| db.database | The name of the database|\n+| user | A username with connect and admin permissions on the target database|\n+| password | The user password for connecting to the database|\n+| sslConnection | true or anything else, true triggers JDBC to use ssl, an example --prop sslConnection=true (db2) |\n+| ssl | true or anything else, true triggers JDBC to use ssl, an example --prop ssl=true (postgres) |\n+| tenant.key | the tenant key is a generated key, or used to set a specific value |\n+| tenant.name | the tenant name is typically default |\n+| schema.name.oauth | uses the default or custom |\n+| schema.name.fhir | defaults to fhirdata |\n+| schema.name.batch | uses the default or custom |\n+| grant.to | grants access to a specific user (which is going to run the application) |\n+\n+Further, any property supported by the [fhir-persistence-schema](https://github.com/IBM/FHIR/blob/master/fhir-persistence-schema/README.md) module is put into the file and mounted to the system.", "originalCommit": "b9425ecbf9c8d8d7e73fa7b260d0c46a71beb1dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjIxNDUwNQ==", "url": "https://github.com/IBM/FHIR/pull/1704#discussion_r522214505", "bodyText": "you bet, I'll add it.", "author": "prb112", "createdAt": "2020-11-12T15:55:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE1NjAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjk1OTg2OQ==", "url": "https://github.com/IBM/FHIR/pull/1704#discussion_r522959869", "bodyText": "fixed, I'll push some fixes shortly.", "author": "prb112", "createdAt": "2020-11-13T13:47:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE1NjAzOQ=="}], "type": "inlineReview"}, {"oid": "3a1979cbadb3a13415814ef440c94aa6cf3b3d68", "url": "https://github.com/IBM/FHIR/commit/3a1979cbadb3a13415814ef440c94aa6cf3b3d68", "message": "feat: add support for ssl certificate for postgres\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-11-13T13:48:32Z", "type": "commit"}, {"oid": "f554c120c6c8ca278a9931469a769072273de371", "url": "https://github.com/IBM/FHIR/commit/f554c120c6c8ca278a9931469a769072273de371", "message": "feat: add support for environment variable\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-11-13T14:12:18Z", "type": "commit"}, {"oid": "5347e7f3373fb073df770c13cf19b85b3f639d90", "url": "https://github.com/IBM/FHIR/commit/5347e7f3373fb073df770c13cf19b85b3f639d90", "message": "fix: remove bad spacking\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-11-13T15:42:39Z", "type": "commit"}, {"oid": "c5b3af8060d24d9968d0b2e9bbf3d2f5e6520d2b", "url": "https://github.com/IBM/FHIR/commit/c5b3af8060d24d9968d0b2e9bbf3d2f5e6520d2b", "message": "fix: per code review and testing with ibm cloud and ssl certificates, also implement base64 encoded or plain-text encoded\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-11-13T21:11:10Z", "type": "commit"}, {"oid": "271a0b8a35edc891e7f2166e1b8edf969c1a8a4c", "url": "https://github.com/IBM/FHIR/commit/271a0b8a35edc891e7f2166e1b8edf969c1a8a4c", "message": "feat: add run-as user\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-11-16T19:45:47Z", "type": "commit"}, {"oid": "c90468f2349cb62e56a5692d86f20f53c6214c53", "url": "https://github.com/IBM/FHIR/commit/c90468f2349cb62e56a5692d86f20f53c6214c53", "message": "doc: changes to readability\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-11-16T19:52:04Z", "type": "commit"}, {"oid": "6b5e5b462e2404df8df2fe215f63af5f23279c57", "url": "https://github.com/IBM/FHIR/commit/6b5e5b462e2404df8df2fe215f63af5f23279c57", "message": "build.sh updates\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-11-16T19:52:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY5Mjg1Mg==", "url": "https://github.com/IBM/FHIR/pull/1704#discussion_r524692852", "bodyText": "Is this file picked up and used some place?   I might have expected this type of info in our wiki rather than with the docker artifacts.", "author": "lmsurpre", "createdAt": "2020-11-16T22:39:55Z", "path": "fhir-install/src/main/docker/ibm-fhir-schematool/DEVELOPMENT.md", "diffHunk": "@@ -0,0 +1,80 @@\n+---\n+layout: default\n+title:  IBM FHIR Server - Schema Tool - Development\n+date:   2020-11-11\n+permalink: /ibm-fhir-server-schema-tool-development/\n+---\n+\n+# Development", "originalCommit": "6b5e5b462e2404df8df2fe215f63af5f23279c57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgyODk4MA==", "url": "https://github.com/IBM/FHIR/pull/1704#discussion_r524828980", "bodyText": "It's development only - no wiki, just trying to keep these notes inline. I thought it might end up as a guide at some point.", "author": "prb112", "createdAt": "2020-11-17T01:38:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY5Mjg1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY5NTY5Mw==", "url": "https://github.com/IBM/FHIR/pull/1704#discussion_r524695693", "bodyText": "it can be any path to a valid cert, right?", "author": "lmsurpre", "createdAt": "2020-11-16T22:42:37Z", "path": "fhir-install/src/main/docker/ibm-fhir-schematool/README.md", "diffHunk": "@@ -0,0 +1,182 @@\n+# IBM FHIR Server - Schema Tool\n+\n+The IBM FHIR Server Schema Tool is designed to create and update the IBM FHIR Server's schema idempotently.\n+\n+The tool supports the following flows in one image: \n+\n+* Onboarding - create SQL schemas, populate the SQL objects, grant permissions to the database user. For db2, the tool sets up a single tenant and tenant key. \n+* Offboarding - removes the schema, on Db2, if no other tenants, it deallocates the tenants\n+* Custom - executes a single fhir-persistence-schema cli action\n+* Debug - outputs debug information\n+\n+# **Use**\n+\n+The solution should set the variables as Environment Variables or mounted into the workarea folder as a volume which contains the persistence.json file.\n+\n+## **Environment Variables**\n+The following environment variables:\n+\n+| Name           | Purpose  |\n+|----------------|----------|\n+| ENV_SKIP       | Stop the container from making any changes, and passes through with a successful state change: `[empty\\|true\\|false]`|\n+| ENV_TOOL_INPUT | Encoded String, in most circumstances base64 encoded or well escaped text, of the json|\n+| ENV_TOOL_DEBUG | Flags the debug |\n+\n+## Configuration Commandline\n+The following is read from the properties file:\n+\n+| Name       | Purpose  |\n+|------------|----------|\n+| tool.behavior | Switches from the Onboarding BEHAVIOR to Offboarding BEHAVIOR flow: `[onboard\\|offboard\\|debug\\|custom]`. |\n+| db.type | The database type - `[postgresql\\|db2]` |\n+| db.host | The database server hostname|\n+| db.port | The database server port|\n+| db.database | The name of the database|\n+| user | A username with connect and admin permissions on the target database|\n+| password | The user password for connecting to the database|\n+| sslConnection | true or anything else, true triggers JDBC to use ssl, an example --prop sslConnection=true (db2) |\n+| ssl | true or anything else, true triggers JDBC to use ssl, an example --prop ssl=true (postgres) |\n+| tenant.key | the tenant key is a generated key, or used to set a specific value |\n+| tenant.name | the tenant name is typically default |\n+| schema.name.oauth | uses the default or custom |\n+| schema.name.fhir | defaults to fhirdata |\n+| schema.name.batch | uses the default or custom |\n+| grant.to | grants access to a specific user (which is going to run the application) |\n+| sslmode | For Postgres, you can set verify-full |\n+| sslrootcert | For Postgres, you must set as /opt/schematool/workarea/db.cert |", "originalCommit": "6b5e5b462e2404df8df2fe215f63af5f23279c57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgyOTAzOQ==", "url": "https://github.com/IBM/FHIR/pull/1704#discussion_r524829039", "bodyText": "No - has to be db.cert.", "author": "prb112", "createdAt": "2020-11-17T01:38:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY5NTY5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY5NjcyNg==", "url": "https://github.com/IBM/FHIR/pull/1704#discussion_r524696726", "bodyText": "I never set this one when interacting with the IBM Cloud Databases for Postgresql.  I think you can choose either this one or sslrootcert...does that sound right?", "author": "lmsurpre", "createdAt": "2020-11-16T22:43:38Z", "path": "fhir-install/src/main/docker/ibm-fhir-schematool/README.md", "diffHunk": "@@ -0,0 +1,182 @@\n+# IBM FHIR Server - Schema Tool\n+\n+The IBM FHIR Server Schema Tool is designed to create and update the IBM FHIR Server's schema idempotently.\n+\n+The tool supports the following flows in one image: \n+\n+* Onboarding - create SQL schemas, populate the SQL objects, grant permissions to the database user. For db2, the tool sets up a single tenant and tenant key. \n+* Offboarding - removes the schema, on Db2, if no other tenants, it deallocates the tenants\n+* Custom - executes a single fhir-persistence-schema cli action\n+* Debug - outputs debug information\n+\n+# **Use**\n+\n+The solution should set the variables as Environment Variables or mounted into the workarea folder as a volume which contains the persistence.json file.\n+\n+## **Environment Variables**\n+The following environment variables:\n+\n+| Name           | Purpose  |\n+|----------------|----------|\n+| ENV_SKIP       | Stop the container from making any changes, and passes through with a successful state change: `[empty\\|true\\|false]`|\n+| ENV_TOOL_INPUT | Encoded String, in most circumstances base64 encoded or well escaped text, of the json|\n+| ENV_TOOL_DEBUG | Flags the debug |\n+\n+## Configuration Commandline\n+The following is read from the properties file:\n+\n+| Name       | Purpose  |\n+|------------|----------|\n+| tool.behavior | Switches from the Onboarding BEHAVIOR to Offboarding BEHAVIOR flow: `[onboard\\|offboard\\|debug\\|custom]`. |\n+| db.type | The database type - `[postgresql\\|db2]` |\n+| db.host | The database server hostname|\n+| db.port | The database server port|\n+| db.database | The name of the database|\n+| user | A username with connect and admin permissions on the target database|\n+| password | The user password for connecting to the database|\n+| sslConnection | true or anything else, true triggers JDBC to use ssl, an example --prop sslConnection=true (db2) |\n+| ssl | true or anything else, true triggers JDBC to use ssl, an example --prop ssl=true (postgres) |\n+| tenant.key | the tenant key is a generated key, or used to set a specific value |\n+| tenant.name | the tenant name is typically default |\n+| schema.name.oauth | uses the default or custom |\n+| schema.name.fhir | defaults to fhirdata |\n+| schema.name.batch | uses the default or custom |\n+| grant.to | grants access to a specific user (which is going to run the application) |\n+| sslmode | For Postgres, you can set verify-full |\n+| sslrootcert | For Postgres, you must set as /opt/schematool/workarea/db.cert |\n+| db.cert | For Postgres, you must set as a base64 encoding of the certificate |", "originalCommit": "6b5e5b462e2404df8df2fe215f63af5f23279c57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgyOTMzOA==", "url": "https://github.com/IBM/FHIR/pull/1704#discussion_r524829338", "bodyText": "db.cert is my entry as the sslrootcert is a path, and the db.cert is actually  the encoded value  which gets serialized to the db.cert file", "author": "prb112", "createdAt": "2020-11-17T01:39:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY5NjcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEyODE2NQ==", "url": "https://github.com/IBM/FHIR/pull/1704#discussion_r525128165", "bodyText": "will it work if you omit db.cert and just mount a cert at /opt/schematool/workarea/db.cert?\nthats close to what I do in our cloud deploy today, although I could probably change that to set a db.cert in a properties file instead if needed.", "author": "lmsurpre", "createdAt": "2020-11-17T12:48:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY5NjcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEzMzQwMw==", "url": "https://github.com/IBM/FHIR/pull/1704#discussion_r525133403", "bodyText": "Yes - it'll work that way too.", "author": "prb112", "createdAt": "2020-11-17T12:57:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY5NjcyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY5NzU1NA==", "url": "https://github.com/IBM/FHIR/pull/1704#discussion_r524697554", "bodyText": "we'll need to remember to keep the version references in this script up-to-date.  maybe use your curl trick to get the latest version from the github api?", "author": "lmsurpre", "createdAt": "2020-11-16T22:44:25Z", "path": "fhir-install/src/main/docker/ibm-fhir-schematool/build.sh", "diffHunk": "@@ -0,0 +1,22 @@\n+#!/usr/bin/env bash\n+\n+# ----------------------------------------------------------------------------\n+# (C) Copyright IBM Corp. 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+# ----------------------------------------------------------------------------\n+\n+set -e -o pipefail\n+\n+##############################################################################\n+\n+docker build --build-arg FHIR_VERSION=4.5.0 -t ibm-fhir-schematool:latest .", "originalCommit": "6b5e5b462e2404df8df2fe215f63af5f23279c57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgyOTQyMg==", "url": "https://github.com/IBM/FHIR/pull/1704#discussion_r524829422", "bodyText": "I've just added automation to it.", "author": "prb112", "createdAt": "2020-11-17T01:39:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY5NzU1NA=="}], "type": "inlineReview"}, {"oid": "1ef5e54da7dd417d2773cd006f6896e81c5bd1a5", "url": "https://github.com/IBM/FHIR/commit/1ef5e54da7dd417d2773cd006f6896e81c5bd1a5", "message": "ci: add automation hooks and build\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-11-17T01:27:26Z", "type": "commit"}]}