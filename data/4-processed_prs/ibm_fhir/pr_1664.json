{"pr_number": 1664, "pr_title": "issue #916 static datasource option and make it the default", "pr_createdAt": "2020-11-02T21:11:45Z", "pr_url": "https://github.com/IBM/FHIR/pull/1664", "timeline": [{"oid": "a5b40e535517a45cc540b0ed2d13743a1243cda9", "url": "https://github.com/IBM/FHIR/commit/a5b40e535517a45cc540b0ed2d13743a1243cda9", "message": "issue #916 static datasource option and make it the default\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-02T20:46:01Z", "type": "commit"}, {"oid": "35bad477418a4a689f682f7dd662091dfec36d7d", "url": "https://github.com/IBM/FHIR/commit/35bad477418a4a689f682f7dd662091dfec36d7d", "message": "Merge remote-tracking branch 'origin/master' into robin-proto", "committedDate": "2020-11-02T20:47:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI3NDI0Ng==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r516274246", "bodyText": "How does the multiple db work? Is there a doc update?", "author": "prb112", "createdAt": "2020-11-02T21:48:54Z", "path": "fhir-server/liberty-config/configDropins/overrides/datasource-postgresql.xml", "diffHunk": "@@ -0,0 +1,18 @@\n+<server>\n+    <!-- ============================================================== -->\n+    <!-- TENANT: default; DSID: default; TYPE: read-write               -->\n+    <!-- ============================================================== -->\n+    <dataSource id=\"fhirDatasourceDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.postgresql.xa.PGXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.postgresql\n+                 serverName=\"localhost\"\n+                 portNumber=\"5432\"\n+                 databaseName=\"fhirdb\"\n+                 user=\"fhirserver\"\n+                 password=\"change-password\"\n+                 currentSchema=\"fhirdata\"\n+             />\n+        />", "originalCommit": "35bad477418a4a689f682f7dd662091dfec36d7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5ODA3MQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r516998071", "bodyText": "Multiple databases can be defined (see the configDropins/overrides in the fhir-server liberty-config dir. Now that this is passing SIT, I'm going to work on updating the documentation.", "author": "punktilious", "createdAt": "2020-11-03T22:41:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI3NDI0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5ODg2OA==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r516998868", "bodyText": "As discussed with the team this morning, the legacy behavior is default. You have to actively switch off the proxy datasource in fhir-server-config in order to get the new behavior.", "author": "punktilious", "createdAt": "2020-11-03T22:43:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI3NDI0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA5ODk0Mw==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517098943", "bodyText": "Draft update to FHIRServerUsersGuide.md just added to this PR.", "author": "punktilious", "createdAt": "2020-11-04T05:03:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI3NDI0Ng=="}], "type": "inlineReview"}, {"oid": "d343e20a0af25d2dcf00d70b247bc87a602350e2", "url": "https://github.com/IBM/FHIR/commit/d343e20a0af25d2dcf00d70b247bc87a602350e2", "message": "issue #916 make proxy datasource the default config and fix jndi naming for bootstrap derby databases\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-03T19:29:37Z", "type": "commit"}, {"oid": "e3509cf04510b7d86be108bc4b64b5b1c8353e64", "url": "https://github.com/IBM/FHIR/commit/e3509cf04510b7d86be108bc4b64b5b1c8353e64", "message": "issue #916 datasource-derby.xml was renamed to datasource-bootstrap.xml\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-03T20:01:16Z", "type": "commit"}, {"oid": "e9e6b5c0f786331ce1091362222360819e9f89b2", "url": "https://github.com/IBM/FHIR/commit/e9e6b5c0f786331ce1091362222360819e9f89b2", "message": "issue #916 updated db2 and postgres test config to match docker-composed environment\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-03T21:28:24Z", "type": "commit"}, {"oid": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "url": "https://github.com/IBM/FHIR/commit/ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "message": "issue updated FHIRServerUsersGuide.md with new datasource configuration info\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-04T04:50:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4ODAxMw==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517388013", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Since release 4.5.0, the FHIR server supports standard JDBC datasources defined in the server '.xml' files. Datasource elements can be defined in the 'server.xml' file but can also be defined in the 'configDropins/overrides' directory to simplify configuration, especially where automation may need to add multiple datasources.\n          \n          \n            \n            Since release 4.5.0, the IBM FHIR Server supports standard JDBC datasources defined in the server '.xml' files. Datasource elements can be defined in the 'server.xml' file but can also be defined in the 'configDropins/overrides' directory to simplify configuration, especially where automation may need to add multiple datasources.\n          \n      \n    \n    \n  \n\nA few points...\n1 - So when you update this guide it goes live right away, we should probably use 4.4.1 as a reference rather than the non-existent 4.5.0\n2 - I don't think we should tell folks to update the server.xml directly, perhaps invert the recommendation and use the but to updates to the server.xml.", "author": "prb112", "createdAt": "2020-11-04T14:35:04Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -307,10 +307,14 @@ Since release 4.3.2 you can use the `search.reopt` query optimizer hint (shown a\n \n ### 3.4.2 Properties-based datastore configuration\n \n-Normally, a Liberty application that uses one or more Derby or Db2 datastores will require a datasource to be defined within the Liberty server.xml file for each database. One drawback to this approach is that each of the datasources are statically defined in the 'server.xml' file, which means that any updates (modifications, additions, etc.) will require a server re-start.\n+Normally, a Liberty application that uses one or more JDBC datastores will require a datasource to be defined within the Liberty server.xml file for each database. One drawback to this approach is that each of the datasources are statically defined in the 'server.xml' file, which means that any updates (modifications, additions, etc.) will require a server re-start.\n \n As part of it's multi-tenant support, the FHIR server provides an alternate mechanism which consists of a single \u201cproxy datasource\u201d along with a set of properties configured in the `fhir-server-config.json` file. This proxy datasource can be used by the JDBC persistence layer implementation to establish connections to either Derby or Db2 databases. This approach allows for new datastores to be configured without the need to restart the FHIR server.\n \n+Since release 4.5.0, the FHIR server supports standard JDBC datasources defined in the server '.xml' files. Datasource elements can be defined in the 'server.xml' file but can also be defined in the 'configDropins/overrides' directory to simplify configuration, especially where automation may need to add multiple datasources.", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgxNDI2Ng==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518814266", "bodyText": "The problem here is describing functionality present in a release that's not out yet, but the code is in master. I think it's preferable to say when this function is available, so people don't expect it to be behavior of a current release.", "author": "punktilious", "createdAt": "2020-11-06T15:12:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4ODAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4ODE5OA==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r519188198", "bodyText": "I've reworded so we don't suggest adding the datasource to server.xml", "author": "punktilious", "createdAt": "2020-11-07T15:25:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4ODAxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4ODM3Ng==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517388376", "bodyText": "You should check and update the table-of-contents.", "author": "prb112", "createdAt": "2020-11-04T14:35:35Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -325,16 +329,134 @@ When the proxy datasource is obtained via a JNDI lookup by the JDBC persistence\n \n The proxy datasource relies on the presence of the tenant-id and datastore-id information within the thread-local `FHIRRequestContext` information. In a simple configuration of the FHIR server that involves the use of the JDBC persistence layer implementation, the `FHIRRequestContext` information is obtained via request headers from the incoming REST API request. The tenant-id is obtained from the `X-FHIR-TENANT-ID` request header and the datastore-id is obtained from the `X-FHIR-DSID` request header<sup id=\"a3\">[3](#f3)</sup>.\n \n-#### 3.4.2.2 Datastore configuration examples\n+#### 3.4.2.2 Standard JDBC Datasources", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ4NjkwNg==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517486906", "bodyText": "Yes, I plan to revise the TOC once we settle on the main changes.", "author": "punktilious", "createdAt": "2020-11-04T16:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4ODM3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgzNDEwNA==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518834104", "bodyText": "TOC is only 2 levels, so isn't changed.", "author": "punktilious", "createdAt": "2020-11-06T15:41:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4ODM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4OTA5Ng==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517389096", "bodyText": "Verify the TOC please", "author": "prb112", "createdAt": "2020-11-04T14:36:35Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -397,7 +522,80 @@ Furthermore, the REST API consumers associated with Acme applications will be co\n }\n ```\n \n-#### 3.4.2.3 Datastore configuration reference\n+##### 3.4.2.3.3 Example 3\n+\n+Example 3 implements the same configuration as Example 2 using standard Liberty datasource definitions.\n+\n+```\n+{\n+    \"__comment\":\"Acme's FHIR server configuration\",\n+    \"fhirServer\":{\n+        \u2026\n+        \"persistence\":{\n+            \"factoryClassname\":\"com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory\",\n+            \"jdbc\": {\n+                \"enableProxyDatasource\": false\n+            },\n+            \u2026\n+            \"datasources\": {\n+                \"study1\": {\n+                    \"tenantKey\": \"<the-base64-tenant-key>\",\n+                    \"type\": \"db2\"\n+                },\n+                \"study2\": {\n+                    \"tenantKey\": \"<the-base64-tenant-key>\",\n+                    \"type\": \"db2\"\n+                }\n+            }\n+            \u2026\n+        }\n+    }\n+}\n+```\n+\n+Note that because this example is using the default FHIR server naming scheme for datasource JNDI names, there is no need to include the 'jndiName' property, although you can specify it should you wish to make the mapping clear. The \"type\" must match the actual database type referenced by the datasource definition. If the type does not match, the behavior is undefined.\n+\n+The datasource definitions for the 'acme' tenant are defined as a drop-in configuration in '{serverHome}/configDropins/datasources-acme.xml':\n+\n+```\n+<server>\n+    <dataSource id=\"fhirDatasourceAcmeStudy1\" jndiName=\"jdbc/fhir_acme_study1\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.db2.jcc\n+                 serverName=\"dbserver1\"\n+                 portNumber=\"50000\"\n+                 user=\"db2inst1\"\n+                 password=\"change-password\"\n+                 databaseName=\"ACMESTUDY1\"\n+                 currentSchema=\"DB2INST1\"\n+                 driverType=\"4\"\n+             />\n+        />\n+        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n+    </dataSource>\n+\n+    <dataSource id=\"fhirDatasourceAcmeStudy2\" jndiName=\"jdbc/fhir_acme_study2\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.db2.jcc\n+                 serverName=\"dbserver1\"\n+                 portNumber=\"50000\"\n+                 user=\"db2inst1\"\n+                 password=\"change-password\"\n+                 databaseName=\"ACMESTUDY2\"\n+                 currentSchema=\"DB2INST1\"\n+                 driverType=\"4\"\n+             />\n+        />\n+        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n+    </dataSource>\n+\n+</server>\n+```\n+\n+In the above configuration, each datasource gets its own connection pool with properties defined by the 'connectionManager' element.\n+\n+\n+#### 3.4.2.4 Datastore configuration reference", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgzMzU1OA==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518833558", "bodyText": "TOC is only 2 levels, so isn't changed.", "author": "punktilious", "createdAt": "2020-11-06T15:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4OTA5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4OTMzNg==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517389336", "bodyText": "Verify the TOC please", "author": "prb112", "createdAt": "2020-11-04T14:36:52Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -325,16 +329,134 @@ When the proxy datasource is obtained via a JNDI lookup by the JDBC persistence\n \n The proxy datasource relies on the presence of the tenant-id and datastore-id information within the thread-local `FHIRRequestContext` information. In a simple configuration of the FHIR server that involves the use of the JDBC persistence layer implementation, the `FHIRRequestContext` information is obtained via request headers from the incoming REST API request. The tenant-id is obtained from the `X-FHIR-TENANT-ID` request header and the datastore-id is obtained from the `X-FHIR-DSID` request header<sup id=\"a3\">[3](#f3)</sup>.\n \n-#### 3.4.2.2 Datastore configuration examples\n+#### 3.4.2.2 Standard JDBC Datasources\n+\n+To use standard JDBC datasources, disable the proxy datasource behavior by setting the 'enableProxyDatasource' flag to false (default is true):\n+\n+```\n+    {\n+        \"fhirServer\": {\n+            \u2026\n+            \"persistence\": {\n+                \u2026\n+                \"jdbc\": {\n+                    \u2026\n+                    \"enableProxyDatasource\": false\n+                }\n+                \u2026\n+            }\n+    }\n+```\n+\n+The 'dataSourceJndiName' property can be removed as it is only used when 'enableProxyDatasource' is true. The 'connectionProperties' element can also be removed (these properties are defined in the Liberty JDBC datasource definition). By default, the JNDI name of the datasource is 'jdbc/fhir_<tenantId>_<dsId>' where '<tenantId>' and '<dsId>' represent the tenant and datastore ids respectively. The JNDI address of the datasource can also be provided explicitly using the 'jndiName' property as shown in the following example:\n+\n+    ```\n+    {\n+        \"fhirServer\":{\n+            \u2026\n+            \"persistence\":{\n+                \"datasources\": {\n+                    \"default\": {\n+                        \"tenantKey\": \"<the-base64-tenant-key>\",\n+                        \"jndiName\": \"jdbc/fhir_default_default\",\n+                        \"type\": \"db2\",\n+                        \"hints\" : {\n+                            \"search.reopt\": \"ONCE\"\n+                        }\n+                    }\n+                }\n+            \u2026\n+            }\n+        }\n+    }\n+    ```\n+When configured explicitly, the jndiName does not have to follow the standard naming convention, although this is not recommended.\n+\n+Continuing the above example, configure a drop-in server configuration file 'configDropins/overrides/datastore-default.xml' as follows:\n+\n+```\n+<server>\n+    <dataSource id=\"fhirDatasourceDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.db2.jcc\n+                 serverName=\"db2\"\n+                 portNumber=\"*****\"\n+                 user=\"*****\"\n+                 password=\"*****\"\n+                 databaseName=\"*****\"\n+                 currentSchema=\"*****\"\n+                 driverType=\"4\"\n+             />\n+        />\n+        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n+    </dataSource>\n+</server>\n+```\n+\n+This file is picked up when the server starts as indicated by the following AUDIT message:\n+\n+```\n+[AUDIT   ] CWWKG0093A: Processing configuration drop-ins resource: /fhir/wlp/usr/servers/fhir-server/configDropins/overrides/datasource-default.xml\n+```\n+\n+A special case exists for configuring the Derby 'bootstrapped' datasources. To avoid naming conflicts, these datasources must use custom JNDI names, not the default naming pattern. For example, a Derby datasource defined in configDropins/overrides/datasource-bootstrap.xml' might look like this:\n+\n+```\n+<server>\n+    <dataSource id=\"fhirDatasourceBootstrapDefaultDefault\" jndiName=\"jdbc/bootstrap_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/fhirDB\"/>\n+        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n+    </dataSource>\n+</server>\n+```\n+\n+Note the use of 'jdbc/bootstrap'. How this is used is described below. The corresponding definition in 'fhir-server-config.json' must be configured like this:\n+\n+```\n+    {\n+        \"fhirServer\":{\n+\n+            \"persistence\": {\n+                ...\n+                \"jdbc\": {\n+                    \"bootstrapDb\": true,\n+                    \"enableProxyDatasource\": false,\n+                    \"bootstrapDataSourceBase\": \"jdbc/bootstrap\"\n+                    ...\n+                },\n+                \"datasources\": {\n+                    \"default\": {\n+                        \"jndiName\": \"jdbc/bootstrap_default_default\",\n+                        \"type\": \"derby\",\n+                        \"currentSchema\": \"APP\"\n+                    },\n+                    ...\n+                }\n+            }\n+        }\n+    }\n+```\n+\n+Note 1. The introduction of the new property 'bootstrapDataSourceBase'. This value is required to correctly identify the datasources to use when bootstrapping the Derby databases. The value 'jdbc/bootstrap' is the prefix which should be common to all the Derby datasource JNDI names referencing bootstrapped Derby databases (currently 'default', 'profile', 'reference', 'study1').\n+\n+Note 2. The 'default' bootstrapped Derby database is called fhirDB. By default these databases are located in the '{serverHome}/derby/' directory.\n+\n+\n+#### 3.4.2.3 Datastore configuration examples", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgzNDc0Mg==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518834742", "bodyText": "TOC is only 2 levels, so isn't changed.", "author": "punktilious", "createdAt": "2020-11-06T15:42:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4OTMzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MDE1Mg==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517390152", "bodyText": "please shift the Markdown code block left. avoiding gatsby compilation issues.", "author": "prb112", "createdAt": "2020-11-04T14:38:03Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -325,16 +329,134 @@ When the proxy datasource is obtained via a JNDI lookup by the JDBC persistence\n \n The proxy datasource relies on the presence of the tenant-id and datastore-id information within the thread-local `FHIRRequestContext` information. In a simple configuration of the FHIR server that involves the use of the JDBC persistence layer implementation, the `FHIRRequestContext` information is obtained via request headers from the incoming REST API request. The tenant-id is obtained from the `X-FHIR-TENANT-ID` request header and the datastore-id is obtained from the `X-FHIR-DSID` request header<sup id=\"a3\">[3](#f3)</sup>.\n \n-#### 3.4.2.2 Datastore configuration examples\n+#### 3.4.2.2 Standard JDBC Datasources\n+\n+To use standard JDBC datasources, disable the proxy datasource behavior by setting the 'enableProxyDatasource' flag to false (default is true):\n+\n+```\n+    {\n+        \"fhirServer\": {\n+            \u2026\n+            \"persistence\": {\n+                \u2026\n+                \"jdbc\": {\n+                    \u2026\n+                    \"enableProxyDatasource\": false\n+                }\n+                \u2026\n+            }\n+    }\n+```\n+\n+The 'dataSourceJndiName' property can be removed as it is only used when 'enableProxyDatasource' is true. The 'connectionProperties' element can also be removed (these properties are defined in the Liberty JDBC datasource definition). By default, the JNDI name of the datasource is 'jdbc/fhir_<tenantId>_<dsId>' where '<tenantId>' and '<dsId>' represent the tenant and datastore ids respectively. The JNDI address of the datasource can also be provided explicitly using the 'jndiName' property as shown in the following example:\n+\n+    ```\n+    {\n+        \"fhirServer\":{\n+            \u2026\n+            \"persistence\":{\n+                \"datasources\": {\n+                    \"default\": {\n+                        \"tenantKey\": \"<the-base64-tenant-key>\",\n+                        \"jndiName\": \"jdbc/fhir_default_default\",\n+                        \"type\": \"db2\",\n+                        \"hints\" : {\n+                            \"search.reopt\": \"ONCE\"\n+                        }\n+                    }\n+                }\n+            \u2026\n+            }\n+        }\n+    }\n+    ```", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgyMTQ3NQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518821475", "bodyText": "done", "author": "punktilious", "createdAt": "2020-11-06T15:22:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MDE1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MjIyMw==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517392223", "bodyText": "Curious as to why boostrapDataSourceBase? what does it mean?\nIf it's just a lookup name, maybe be a bit more direct\nbootstrapDataSourceBase maybe simplify to bootstrapName ...", "author": "prb112", "createdAt": "2020-11-04T14:40:47Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -325,16 +329,134 @@ When the proxy datasource is obtained via a JNDI lookup by the JDBC persistence\n \n The proxy datasource relies on the presence of the tenant-id and datastore-id information within the thread-local `FHIRRequestContext` information. In a simple configuration of the FHIR server that involves the use of the JDBC persistence layer implementation, the `FHIRRequestContext` information is obtained via request headers from the incoming REST API request. The tenant-id is obtained from the `X-FHIR-TENANT-ID` request header and the datastore-id is obtained from the `X-FHIR-DSID` request header<sup id=\"a3\">[3](#f3)</sup>.\n \n-#### 3.4.2.2 Datastore configuration examples\n+#### 3.4.2.2 Standard JDBC Datasources\n+\n+To use standard JDBC datasources, disable the proxy datasource behavior by setting the 'enableProxyDatasource' flag to false (default is true):\n+\n+```\n+    {\n+        \"fhirServer\": {\n+            \u2026\n+            \"persistence\": {\n+                \u2026\n+                \"jdbc\": {\n+                    \u2026\n+                    \"enableProxyDatasource\": false\n+                }\n+                \u2026\n+            }\n+    }\n+```\n+\n+The 'dataSourceJndiName' property can be removed as it is only used when 'enableProxyDatasource' is true. The 'connectionProperties' element can also be removed (these properties are defined in the Liberty JDBC datasource definition). By default, the JNDI name of the datasource is 'jdbc/fhir_<tenantId>_<dsId>' where '<tenantId>' and '<dsId>' represent the tenant and datastore ids respectively. The JNDI address of the datasource can also be provided explicitly using the 'jndiName' property as shown in the following example:\n+\n+    ```\n+    {\n+        \"fhirServer\":{\n+            \u2026\n+            \"persistence\":{\n+                \"datasources\": {\n+                    \"default\": {\n+                        \"tenantKey\": \"<the-base64-tenant-key>\",\n+                        \"jndiName\": \"jdbc/fhir_default_default\",\n+                        \"type\": \"db2\",\n+                        \"hints\" : {\n+                            \"search.reopt\": \"ONCE\"\n+                        }\n+                    }\n+                }\n+            \u2026\n+            }\n+        }\n+    }\n+    ```\n+When configured explicitly, the jndiName does not have to follow the standard naming convention, although this is not recommended.\n+\n+Continuing the above example, configure a drop-in server configuration file 'configDropins/overrides/datastore-default.xml' as follows:\n+\n+```\n+<server>\n+    <dataSource id=\"fhirDatasourceDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.db2.jcc\n+                 serverName=\"db2\"\n+                 portNumber=\"*****\"\n+                 user=\"*****\"\n+                 password=\"*****\"\n+                 databaseName=\"*****\"\n+                 currentSchema=\"*****\"\n+                 driverType=\"4\"\n+             />\n+        />\n+        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n+    </dataSource>\n+</server>\n+```\n+\n+This file is picked up when the server starts as indicated by the following AUDIT message:\n+\n+```\n+[AUDIT   ] CWWKG0093A: Processing configuration drop-ins resource: /fhir/wlp/usr/servers/fhir-server/configDropins/overrides/datasource-default.xml\n+```\n+\n+A special case exists for configuring the Derby 'bootstrapped' datasources. To avoid naming conflicts, these datasources must use custom JNDI names, not the default naming pattern. For example, a Derby datasource defined in configDropins/overrides/datasource-bootstrap.xml' might look like this:\n+\n+```\n+<server>\n+    <dataSource id=\"fhirDatasourceBootstrapDefaultDefault\" jndiName=\"jdbc/bootstrap_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/fhirDB\"/>\n+        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n+    </dataSource>\n+</server>\n+```\n+\n+Note the use of 'jdbc/bootstrap'. How this is used is described below. The corresponding definition in 'fhir-server-config.json' must be configured like this:\n+\n+```\n+    {\n+        \"fhirServer\":{\n+\n+            \"persistence\": {\n+                ...\n+                \"jdbc\": {\n+                    \"bootstrapDb\": true,\n+                    \"enableProxyDatasource\": false,\n+                    \"bootstrapDataSourceBase\": \"jdbc/bootstrap\"\n+                    ...\n+                },\n+                \"datasources\": {\n+                    \"default\": {\n+                        \"jndiName\": \"jdbc/bootstrap_default_default\",\n+                        \"type\": \"derby\",\n+                        \"currentSchema\": \"APP\"\n+                    },\n+                    ...\n+                }\n+            }\n+        }\n+    }\n+```\n+\n+Note 1. The introduction of the new property 'bootstrapDataSourceBase'. This value is required to correctly identify the datasources to use when bootstrapping the Derby databases. The value 'jdbc/bootstrap' is the prefix which should be common to all the Derby datasource JNDI names referencing bootstrapped Derby databases (currently 'default', 'profile', 'reference', 'study1').", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MzExOQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517393119", "bodyText": "or make it look like dataSourceJndiName in one of the examples", "author": "prb112", "createdAt": "2020-11-04T14:41:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MjIyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ4OTM3Ng==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517489376", "bodyText": "It's a prefix string acting as the base name for a number of actual JNDI names. It's a quirk related to how the current bootstrap code works (which ideally should be refactored, but won't be doing that here - already covered in another issue not planned for this sprint).", "author": "punktilious", "createdAt": "2020-11-04T16:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MjIyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MjU3Ng==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517392576", "bodyText": "Also please update the configuration section of the users guide indicating defaults and tenancy.", "author": "prb112", "createdAt": "2020-11-04T14:41:14Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -325,16 +329,134 @@ When the proxy datasource is obtained via a JNDI lookup by the JDBC persistence\n \n The proxy datasource relies on the presence of the tenant-id and datastore-id information within the thread-local `FHIRRequestContext` information. In a simple configuration of the FHIR server that involves the use of the JDBC persistence layer implementation, the `FHIRRequestContext` information is obtained via request headers from the incoming REST API request. The tenant-id is obtained from the `X-FHIR-TENANT-ID` request header and the datastore-id is obtained from the `X-FHIR-DSID` request header<sup id=\"a3\">[3](#f3)</sup>.\n \n-#### 3.4.2.2 Datastore configuration examples\n+#### 3.4.2.2 Standard JDBC Datasources\n+\n+To use standard JDBC datasources, disable the proxy datasource behavior by setting the 'enableProxyDatasource' flag to false (default is true):\n+\n+```\n+    {\n+        \"fhirServer\": {\n+            \u2026\n+            \"persistence\": {\n+                \u2026\n+                \"jdbc\": {\n+                    \u2026\n+                    \"enableProxyDatasource\": false\n+                }\n+                \u2026\n+            }\n+    }\n+```\n+\n+The 'dataSourceJndiName' property can be removed as it is only used when 'enableProxyDatasource' is true. The 'connectionProperties' element can also be removed (these properties are defined in the Liberty JDBC datasource definition). By default, the JNDI name of the datasource is 'jdbc/fhir_<tenantId>_<dsId>' where '<tenantId>' and '<dsId>' represent the tenant and datastore ids respectively. The JNDI address of the datasource can also be provided explicitly using the 'jndiName' property as shown in the following example:\n+\n+    ```\n+    {\n+        \"fhirServer\":{\n+            \u2026\n+            \"persistence\":{\n+                \"datasources\": {\n+                    \"default\": {\n+                        \"tenantKey\": \"<the-base64-tenant-key>\",\n+                        \"jndiName\": \"jdbc/fhir_default_default\",\n+                        \"type\": \"db2\",\n+                        \"hints\" : {\n+                            \"search.reopt\": \"ONCE\"\n+                        }\n+                    }\n+                }\n+            \u2026\n+            }\n+        }\n+    }\n+    ```\n+When configured explicitly, the jndiName does not have to follow the standard naming convention, although this is not recommended.\n+\n+Continuing the above example, configure a drop-in server configuration file 'configDropins/overrides/datastore-default.xml' as follows:\n+\n+```\n+<server>\n+    <dataSource id=\"fhirDatasourceDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.db2.jcc\n+                 serverName=\"db2\"\n+                 portNumber=\"*****\"\n+                 user=\"*****\"\n+                 password=\"*****\"\n+                 databaseName=\"*****\"\n+                 currentSchema=\"*****\"\n+                 driverType=\"4\"\n+             />\n+        />\n+        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n+    </dataSource>\n+</server>\n+```\n+\n+This file is picked up when the server starts as indicated by the following AUDIT message:\n+\n+```\n+[AUDIT   ] CWWKG0093A: Processing configuration drop-ins resource: /fhir/wlp/usr/servers/fhir-server/configDropins/overrides/datasource-default.xml\n+```\n+\n+A special case exists for configuring the Derby 'bootstrapped' datasources. To avoid naming conflicts, these datasources must use custom JNDI names, not the default naming pattern. For example, a Derby datasource defined in configDropins/overrides/datasource-bootstrap.xml' might look like this:\n+\n+```\n+<server>\n+    <dataSource id=\"fhirDatasourceBootstrapDefaultDefault\" jndiName=\"jdbc/bootstrap_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/fhirDB\"/>\n+        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n+    </dataSource>\n+</server>\n+```\n+\n+Note the use of 'jdbc/bootstrap'. How this is used is described below. The corresponding definition in 'fhir-server-config.json' must be configured like this:\n+\n+```\n+    {\n+        \"fhirServer\":{\n+\n+            \"persistence\": {\n+                ...\n+                \"jdbc\": {\n+                    \"bootstrapDb\": true,\n+                    \"enableProxyDatasource\": false,\n+                    \"bootstrapDataSourceBase\": \"jdbc/bootstrap\"\n+                    ...\n+                },\n+                \"datasources\": {\n+                    \"default\": {\n+                        \"jndiName\": \"jdbc/bootstrap_default_default\",\n+                        \"type\": \"derby\",\n+                        \"currentSchema\": \"APP\"\n+                    },\n+                    ...\n+                }\n+            }\n+        }\n+    }\n+```\n+\n+Note 1. The introduction of the new property 'bootstrapDataSourceBase'. This value is required to correctly identify the datasources to use when bootstrapping the Derby databases. The value 'jdbc/bootstrap' is the prefix which should be common to all the Derby datasource JNDI names referencing bootstrapped Derby databases (currently 'default', 'profile', 'reference', 'study1').\n+\n+Note 2. The 'default' bootstrapped Derby database is called fhirDB. By default these databases are located in the '{serverHome}/derby/' directory.", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5Mzk0MQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517393941", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Note that because this example is using the default FHIR server naming scheme for datasource JNDI names, there is no need to include the 'jndiName' property, although you can specify it should you wish to make the mapping clear. The \"type\" must match the actual database type referenced by the datasource definition. If the type does not match, the behavior is undefined.\n          \n          \n            \n            Note that because this example is using the default IBM \n          \n          \n            \n            FHIR Server naming scheme for datasource JNDI names, there is no need to include the 'jndiName' property, although you can specify it should you wish to make the mapping clear. The \"type\" must match the actual database type referenced by the datasource definition. If the type does not match, the behavior is undefined.", "author": "prb112", "createdAt": "2020-11-04T14:43:07Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -397,7 +522,80 @@ Furthermore, the REST API consumers associated with Acme applications will be co\n }\n ```\n \n-#### 3.4.2.3 Datastore configuration reference\n+##### 3.4.2.3.3 Example 3\n+\n+Example 3 implements the same configuration as Example 2 using standard Liberty datasource definitions.\n+\n+```\n+{\n+    \"__comment\":\"Acme's FHIR server configuration\",\n+    \"fhirServer\":{\n+        \u2026\n+        \"persistence\":{\n+            \"factoryClassname\":\"com.ibm.fhir.persistence.jdbc.FHIRPersistenceJDBCFactory\",\n+            \"jdbc\": {\n+                \"enableProxyDatasource\": false\n+            },\n+            \u2026\n+            \"datasources\": {\n+                \"study1\": {\n+                    \"tenantKey\": \"<the-base64-tenant-key>\",\n+                    \"type\": \"db2\"\n+                },\n+                \"study2\": {\n+                    \"tenantKey\": \"<the-base64-tenant-key>\",\n+                    \"type\": \"db2\"\n+                }\n+            }\n+            \u2026\n+        }\n+    }\n+}\n+```\n+\n+Note that because this example is using the default FHIR server naming scheme for datasource JNDI names, there is no need to include the 'jndiName' property, although you can specify it should you wish to make the mapping clear. The \"type\" must match the actual database type referenced by the datasource definition. If the type does not match, the behavior is undefined.", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgzNDkzNg==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518834936", "bodyText": "ok", "author": "punktilious", "createdAt": "2020-11-06T15:43:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5Mzk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NDM0OQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517394349", "bodyText": "name is kind of wonkey", "author": "prb112", "createdAt": "2020-11-04T14:43:39Z", "path": "fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java", "diffHunk": "@@ -92,6 +92,9 @@\n     public static final String PROPERTY_DATASOURCES = \"fhirServer/persistence/datasources\";\n     public static final String PROPERTY_JDBC_BOOTSTRAP_DB = \"fhirServer/persistence/jdbc/bootstrapDb\";\n     public static final String PROPERTY_JDBC_DATASOURCE_JNDINAME = \"fhirServer/persistence/jdbc/dataSourceJndiName\";\n+    public static final String PROPERTY_JDBC_BOOTSTRAP_DATASOURCE_BASE = \"fhirServer/persistence/jdbc/bootstrapDataSourceBase\";", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgzNjY1MA==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518836650", "bodyText": "No, it aligns with the existing PROPERTY_JDBC_BOOTSTRAP_DB. Intentional. I have moved it up one line to make this clear.", "author": "punktilious", "createdAt": "2020-11-06T15:45:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NDM0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NTE3Ng==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517395176", "bodyText": "Correct me if I'm wrong, in our next release we can get rid of this.\nAnd start packing in fhir-core, fhir-config in the war.\nif so, I think we should release 4.5.0 soon, and get to 4.5.X soon after", "author": "prb112", "createdAt": "2020-11-04T14:44:44Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/connection/FHIRDbProxyDatasourceConnectionStrategy.java", "diffHunk": "@@ -24,28 +24,29 @@\n \n /**\n  * Hides the logic behind obtaining a JDBC {@link Connection} from the DAO code.\n- * \n- * This strategy is used for configurations using the FHIR proxy datasource, \n+ *\n+ * This strategy is used for configurations using the FHIR proxy datasource,\n  * which supports dynamic configurations of datasources without requiring\n  * the application server to restart.\n- * \n+ *\n  * @implNote Refactored from {@link FHIRDbDAOImpl}. Improves separation of\n  *           concerns by removing connection management code from the DAO\n  *           and injecting it as a strategy instead. This not only simplifies\n  *           things, but also makes it easier to implement new strategies,\n  *           such as using a JEE datasource directly instead of the FHIR\n  *           proxy datasource used here.\n  */\n+@Deprecated\n public class FHIRDbProxyDatasourceConnectionStrategy extends FHIRDbConnectionStrategyBase {", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ5MzU2Ng==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517493566", "bodyText": "As we discussed, this strategy is currently the default (so we're not currently forcing users to make a config change). When we get rid of this in a future release, users will be required to change their config if they haven't already. In that future release, yes we can get rid of the shared lib jars, and package everything cleanly inside the WAR.", "author": "punktilious", "createdAt": "2020-11-04T17:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NTE3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NjQ5MQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517396491", "bodyText": "I saw something in the documentation that we make a recommendation on the JNDI name but not required.  I think based on this it's required? correct?", "author": "prb112", "createdAt": "2020-11-04T14:46:33Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/connection/FHIRDbTenantDatasourceConnectionStrategy.java", "diffHunk": "@@ -54,40 +52,45 @@\n \n     // number of nanoseconds in a millisecond\n     private static final long NANOMS = 1000000;\n-    \n-    // JNDI address of the (proxy) datasource\n-    private final String datasourceBaseName = \"jdbc/fhir_\";\n+\n+    // JNDI prefix  of the (proxy) datasource\n+    private static final String DATASOURCE_BASE_NAME = \"jdbc/fhir\";\n \n     // Cache of datasources we've found\n     private final Map<String, DataSource> datasourceMap = new ConcurrentHashMap<>();\n-    \n+\n     // the flavor of the database we are configured to represent\n     private final FHIRDbFlavor flavor;\n \n+    // Should we use read-only datasources for isReadOnly() requests?\n+    private final boolean enableReadOnlyReplicas;\n+\n     /**\n      * Public constructor. The proxy datasource must be present (registered in JNDI)\n      * at server startup.\n      * @throws FHIRPersistenceDBConnectException if the proxy datasource is not configured\n      */\n-    public FHIRDbTenantDatasourceConnectionStrategy(TransactionSynchronizationRegistry trxSyncRegistry, Action newConnectionAction) throws FHIRException {\n+    public FHIRDbTenantDatasourceConnectionStrategy(TransactionSynchronizationRegistry trxSyncRegistry, Action newConnectionAction, boolean enableReadOnlyReplicas) throws FHIRException {\n         super(trxSyncRegistry, newConnectionAction);\n+        this.flavor = createFlavor();\n+        this.enableReadOnlyReplicas = enableReadOnlyReplicas;\n+    }\n \n-        // Find the base JNDI name of the datasource we want to use\n-        try {\n-//            this.datasourceBaseName =\n-//                    FHIRConfiguration.getInstance().loadConfiguration().getStringProperty(\n-//                        FHIRConfiguration.PROPERTY_JDBC_DATASOURCE_JNDINAME, FHIRDbDAO.FHIRDB_JNDI_NAME_DEFAULT);\n-            \n-            if (log.isLoggable(Level.FINE)) {\n-                log.fine(\"Using datasource JNDI name: \" + datasourceBaseName);\n-            }\n-        } catch (Throwable e) {\n-            FHIRException fx = new FHIRPersistenceDBConnectException(\"Failure acquiring datasource\");\n-            log.log(Level.SEVERE, fx.addProbeId(\"Failure to find proxy datasource in FHIR server configuration\"), e);\n-            throw fx;\n+    public static String makeTenantDatasourceJNDIName(String jndiBase, String tenantId, String dsId, boolean readOnly) {\n+        final StringBuilder builder = new StringBuilder();\n+\n+        builder.append(jndiBase);\n+        builder.append(\"_\");\n+        builder.append(tenantId);\n+        builder.append(\"_\");\n+        builder.append(dsId);\n+\n+        if (readOnly) {\n+            // Allow the query to hit read-only replicas if we're supporting that\n+            builder.append(\"_ro\");\n         }\n-        \n-        this.flavor = createFlavor();\n+\n+        return builder.toString();\n     }", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NjkyNA==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517396924", "bodyText": "Ignore comment - line 130 answered.", "author": "prb112", "createdAt": "2020-11-04T14:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NjQ5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NzE1MQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517397151", "bodyText": "makes sense now", "author": "prb112", "createdAt": "2020-11-04T14:47:25Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/connection/FHIRDbTenantDatasourceConnectionStrategy.java", "diffHunk": "@@ -98,43 +101,63 @@ public Connection getConnection() throws FHIRPersistenceDBConnectException {\n         if (log.isLoggable(Level.FINEST)) {\n             log.entering(CLASSNAME, METHODNAME);\n         }\n-        \n+\n         // the dsId/tenantId specific datasource we need to locate\n         DataSource datasource;\n-        \n+\n         // Resources can be routed to different databases using the dsId currently\n         // set on the context.\n         String tenantId = FHIRRequestContext.get().getTenantId();\n         String dsId = FHIRRequestContext.get().getDataStoreId();\n-        \n-        // this is the important bit...how we name our actual datasources\n-        final String datasourceName = datasourceBaseName + tenantId + \"_\" + dsId;\n-        \n+        boolean readOnly = this.enableReadOnlyReplicas && FHIRRequestContext.get().isReadOnly();\n+\n+        // The jndiName may be given explicitly in the fhir-server-config\n+        String jndiName;\n+\n+        final String jndiNameProperty = FHIRConfiguration.PROPERTY_DATASOURCES + \"/\" + dsId + \"/jndiName\";\n+        try {\n+            PropertyGroup fhirConfig = FHIRConfiguration.getInstance().loadConfigurationForTenant(tenantId);\n+            jndiName = fhirConfig.getStringProperty(jndiNameProperty, null);\n+\n+            if (readOnly) {\n+                jndiName = jndiName + \"_ro\";\n+            }\n+        } catch (Exception x) {\n+            log.log(Level.SEVERE, \"Error getting value for tenant/datasource jndiName property: \" + jndiNameProperty, x);\n+            throw new FHIRPersistenceDBConnectException(\"FHIR server configuration error. See server log for details\");\n+        }\n+\n+        if (jndiName == null) {\n+            // Name wasn't provided, so build the name using a standard pattern: jdbc/fhir_<tenantId>_<dsId>[_ro]\n+            jndiName = makeTenantDatasourceJNDIName(DATASOURCE_BASE_NAME, tenantId, dsId, readOnly);\n+        }", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgzNzQzMA==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518837430", "bodyText": "ok", "author": "punktilious", "createdAt": "2020-11-06T15:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5NzE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5OTkxMg==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517399912", "bodyText": "so interesting to see how many places this clause is used.", "author": "prb112", "createdAt": "2020-11-04T14:51:13Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/QuerySegmentAggregator.java", "diffHunk": "@@ -61,7 +61,7 @@\n     protected static final String SELECT_COUNT_ROOT = \"SELECT COUNT(DISTINCT R.RESOURCE_ID) \";\n     protected static final String SYSTEM_LEVEL_SELECT_COUNT_ROOT = \"SELECT SUM(CNT) \";\n     protected static final String SYSTEM_LEVEL_SUBSELECT_COUNT_ROOT = \" SELECT COUNT(DISTINCT LR.LOGICAL_RESOURCE_ID) AS CNT \";\n-    protected static final String WHERE_CLAUSE_ROOT = \"WHERE R.IS_DELETED <> 'Y'\";\n+    protected static final String WHERE_CLAUSE_ROOT = \"WHERE R.IS_DELETED = 'N'\";", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ5NjMxNQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517496315", "bodyText": "Yeah, and ideally this flag should also be at the logical_resource level so that we can know the current status without having the extra join to the _resources table.", "author": "punktilious", "createdAt": "2020-11-04T17:04:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5OTkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNDQ1Mg==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517404452", "bodyText": "Are you pushing this into a default? it seems like this should remain for one version or be moved completely to a configDropin default.", "author": "prb112", "createdAt": "2020-11-04T14:57:15Z", "path": "fhir-server/liberty-config/server.xml", "diffHunk": "@@ -93,10 +93,12 @@\n         <fileset dir=\"${shared.resource.dir}/lib/fhir\" includes=\"*.jar\"/>\n     </library>\n \n+    <!-- Since 4.5.0: Enable the fhirProxyDataSource only if you need the legacy datasource behavior\n     <dataSource id=\"fhirProxyDataSource\" jndiName=\"jdbc/fhirProxyDataSource\" type=\"javax.sql.XADataSource\" validationTimeout=\"30s\">\n         <jdbcDriver javax.sql.XADataSource=\"com.ibm.fhir.persistence.proxy.FHIRProxyXADataSource\" libraryRef=\"fhirSharedLib\"/>\n         <connectionManager/>\n     </dataSource>\n+    -->", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ5NzYwNg==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517497606", "bodyText": "Right, currently all the SITs are using the new mechanism, but I'm planning to revert the Db2 test to use the old mechanism to maintain coverage, and this will be uncommented to support that.", "author": "punktilious", "createdAt": "2020-11-04T17:06:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNDQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg0NjY5MQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518846691", "bodyText": "Db2 configuration has been reverted to ensure we have continued coverage of the old-style configuration in SITs.", "author": "punktilious", "createdAt": "2020-11-06T16:01:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNDQ1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNTQ1NA==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517405454", "bodyText": "Shouldn't these ids be unique across all overrides?\nI think this should go in the disabled directory and note the overrides.", "author": "prb112", "createdAt": "2020-11-04T14:58:30Z", "path": "fhir-server/liberty-config/configDropins/overrides/datasource-postgresql.xml", "diffHunk": "@@ -0,0 +1,18 @@\n+<server>\n+    <!-- ============================================================== -->\n+    <!-- TENANT: default; DSID: default; TYPE: read-write               -->\n+    <!-- ============================================================== -->\n+    <dataSource id=\"fhirDatasourceDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUwMTMzOA==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517501338", "bodyText": "This datasource gets used for Postgres tests where the tenant/dsid is default/default. The test automation script copies the correct fhir-server-config file to the target volume, and now also copies the relevant datasource overrides. I agree if we want to support tests with multiple tenants/dsids active at the same time that the id and jndiName values need to be unique. Although I provided a default implementation for calculating the JNDI names based on tenant/datasource, in some circumstances it's probably better (for readability) to include the jndiName property in the fhir-server-config so that the reference is clear. I made a similar comment in the doc.", "author": "punktilious", "createdAt": "2020-11-04T17:12:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNTQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNTY1OQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517405659", "bodyText": "Put my comment in the postgres.xml", "author": "prb112", "createdAt": "2020-11-04T14:58:44Z", "path": "fhir-server/liberty-config/configDropins/overrides/datasource-db2.xml", "diffHunk": "@@ -0,0 +1,19 @@\n+<server>\n+    <!-- ============================================================== -->\n+    <!-- TENANT: default; DSID: default; TYPE: read-write               -->\n+    <!-- ============================================================== -->\n+    <dataSource id=\"fhirDatasourceDefaultDefault\" jndiName=\"jdbc/fhir_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"com.ibm.db2.jcc.DB2XADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.db2.jcc\n+                 serverName=\"db2\"\n+                 portNumber=\"50000\"\n+                 user=\"fhirserver\"\n+                 password=\"change-password\"\n+                 databaseName=\"FHIRDB\"\n+                 currentSchema=\"FHIRDATA\"\n+                 driverType=\"4\"\n+             />\n+        />\n+        <connectionManager maxPoolSize=\"200\" minPoolSize=\"40\"/>\n+    </dataSource>", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNTg5NA==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517405894", "bodyText": "Put my comment in the postgres.xml, however I think this one should be in default.", "author": "prb112", "createdAt": "2020-11-04T14:59:06Z", "path": "fhir-server/liberty-config/configDropins/overrides/datasource-bootstrap.xml", "diffHunk": "@@ -0,0 +1,44 @@\n+<server>\n+    <!-- ============================================================== -->\n+    <!-- These datasources are used by the FHIR server Derby bootstrap  -->\n+    <!-- process. We have to name them differently so they do not       -->\n+    <!-- clash with other datasources which may be assigned JNDI names  -->\n+    <!-- like \"jdbc/fhir_default_default\"                               -->\n+    <!-- ============================================================== -->\n+\n+    <!-- ============================================================== -->\n+    <!-- TENANT: default; DSID: default; TYPE: read-write               -->\n+    <!-- ============================================================== -->\n+    <dataSource id=\"fhirDatasourceBootstrapDefaultDefault\" jndiName=\"jdbc/bootstrap_default_default\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/fhirDB\"/>\n+        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n+    </dataSource>\n+\n+    <!-- ============================================================== -->\n+    <!-- TENANT: tenant1; DSID: profile; TYPE: read-write               -->\n+    <!-- ============================================================== -->\n+    <dataSource id=\"fhirDatasourceBootstrapTenant1Profile\" jndiName=\"jdbc/bootstrap_tenant1_profile\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/profile\"/>\n+        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n+    </dataSource>\n+\n+    <!-- ============================================================== -->\n+    <!-- TENANT: tenant1; DSID: reference; TYPE: read-write             -->\n+    <!-- ============================================================== -->\n+    <dataSource id=\"fhirDatasourceBootstrapTenant1Reference\" jndiName=\"jdbc/bootstrap_tenant1_reference\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/reference\"/>\n+        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n+    </dataSource>\n+\n+    <!-- ============================================================== -->\n+    <!-- TENANT: tenant1; DSID: study1; TYPE: read-write                -->\n+    <!-- ============================================================== -->\n+    <dataSource id=\"fhirDatasourceBootstrapTenant1Study1\" jndiName=\"jdbc/bootstrap_tenant1_study1\" type=\"javax.sql.XADataSource\" statementCacheSize=\"200\" syncQueryTimeoutWithTransactionTimeout=\"true\">\n+        <jdbcDriver javax.sql.XADataSource=\"org.apache.derby.jdbc.EmbeddedXADataSource\" libraryRef=\"fhirSharedLib\"/>\n+            <properties.derby.embedded createDatabase=\"create\" databaseName=\"derby/study1\"/>\n+        <connectionManager maxPoolSize=\"50\" minPoolSize=\"10\"/>\n+    </dataSource>", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg0NTY4Mg==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518845682", "bodyText": "Please clarify this comment", "author": "punktilious", "createdAt": "2020-11-06T16:00:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNTg5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNzEwOQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517407109", "bodyText": "Doesn't feel so much like deprecating, rather this is a breaking change.", "author": "prb112", "createdAt": "2020-11-04T15:00:32Z", "path": "fhir-server/liberty-config/config/default/fhir-server-config-postgresql.json", "diffHunk": "@@ -49,22 +49,16 @@\n             \"jdbc\": {\n                 \"__comment\": \"Configuration properties for the JDBC persistence implementation\",\n                 \"bootstrapDb\": true,\n-                \"dataSourceJndiName\": \"jdbc/fhirProxyDataSource\",\n+                \"enableProxyDatasource\": false,\n+                \"bootstrapDataSourceBase\": \"jdbc/bootstrap\",\n                 \"enableCodeSystemsCache\": true,\n                 \"enableParameterNamesCache\": true,\n                 \"enableResourceTypesCache\": true\n             },\n             \"datasources\": {\n                 \"default\": {\n                     \"type\": \"postgresql\",\n-                    \"connectionProperties\": {\n-                        \"serverName\": \"postgres_postgres_1\",\n-                        \"portNumber\": 5432,\n-                        \"databaseName\": \"fhirdb\",\n-                        \"user\": \"fhirserver\",\n-                        \"password\": \"change-password\",\n-                        \"currentSchema\": \"fhirdata\"\n-                    }\n+                    \"currentSchema\": \"fhirdata\"", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUwMjkwNg==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517502906", "bodyText": "This is following the new pattern, which requires a configuration change.", "author": "punktilious", "createdAt": "2020-11-04T17:14:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNzEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg0MjYyNA==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518842624", "bodyText": "Old configuration will continue to work.", "author": "punktilious", "createdAt": "2020-11-06T15:55:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNzEwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNzIzOQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517407239", "bodyText": "Doesn't feel so much like deprecating, rather this is a breaking change.", "author": "prb112", "createdAt": "2020-11-04T15:00:43Z", "path": "fhir-server/liberty-config/config/default/fhir-server-config-db2.json", "diffHunk": "@@ -100,25 +100,18 @@\n             \"jdbc\": {\n                 \"__comment\": \"Configuration properties for the JDBC persistence implementation\",\n                 \"bootstrapDb\": true,\n-                \"dataSourceJndiName\": \"jdbc/fhirProxyDataSource\",\n+                \"enableProxyDatasource\": false,\n+                \"bootstrapDataSourceBase\": \"jdbc/bootstrap\",\n                 \"enableCodeSystemsCache\": true,\n                 \"enableParameterNamesCache\": true,\n                 \"enableResourceTypesCache\": true\n             },\n             \"datasources\": {\n                 \"default\": {\n                     \"type\": \"db2\",\n+                    \"currentSchema\": \"fhirdata\",\n                     \"hints\" : {\n                       \"search.reopt\": \"ONCE\"", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg0MTkxNw==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518841917", "bodyText": "If you decide to use the new configuration, yes. The existing configuration will work the same as it does today without change - it will just be using a deprecated class under the covers.", "author": "punktilious", "createdAt": "2020-11-06T15:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNzIzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg0MjMxMg==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518842312", "bodyText": "Note, I've reverted the Db2 example to use the old style configuration so that we can continue to exercise this code as part of SIT.", "author": "punktilious", "createdAt": "2020-11-06T15:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNzIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwNzY5MQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517407691", "bodyText": "I think with derby this is a-ok", "author": "prb112", "createdAt": "2020-11-04T15:01:19Z", "path": "fhir-server/liberty-config-tenants/config/tenant1/fhir-server-config.json", "diffHunk": "@@ -21,28 +21,19 @@\n         \"persistence\": {\n             \"datasources\": {\n                 \"profile\": {\n+                    \"jndiName\": \"jdbc/bootstrap_tenant1_profile\",\n                     \"type\": \"derby\",\n-                    \"currentSchema\": \"APP\",\n-                    \"connectionProperties\": {\n-                        \"databaseName\": \"derby/profile\",\n-                        \"createDatabase\": \"create\"\n-                    }\n+                    \"currentSchema\": \"APP\"\n                 },\n                 \"reference\": {\n+                    \"jndiName\": \"jdbc/bootstrap_tenant1_reference\",\n                     \"type\": \"derby\",\n-                    \"currentSchema\": \"APP\",\n-                    \"connectionProperties\": {\n-                        \"databaseName\": \"derby/reference\",\n-                        \"createDatabase\": \"create\"\n-                    }\n+                    \"currentSchema\": \"APP\"\n                 },\n                 \"study1\": {\n+                    \"jndiName\": \"jdbc/bootstrap_tenant1_study1\",\n                     \"type\": \"derby\",\n-                    \"currentSchema\": \"APP\",\n-                    \"connectionProperties\": {\n-                        \"databaseName\": \"derby/study1\",\n-                        \"createDatabase\": \"create\"\n-                    }\n+                    \"currentSchema\": \"APP\"\n                 }\n             }\n         }", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwODI0Nw==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517408247", "bodyText": "@michaelwschroeder FYI - the <> change, I think you might have already adopted this", "author": "prb112", "createdAt": "2020-11-04T15:02:06Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/util/JDBCQueryBuilder.java", "diffHunk": "@@ -823,13 +823,13 @@ private void appendInnerSelect(StringBuilder whereClauseSegment, QueryParameter\n \n         whereClauseSegment.append(\" WHERE \");\n \n-        // CR1.RESOURCE_ID = CLR1.CURRENT_RESOURCE_ID AND CR1.IS_DELETED <> 'Y' AND\n+        // CR1.RESOURCE_ID = CLR1.CURRENT_RESOURCE_ID AND CR1.IS_DELETED = 'N' AND\n         // CP1.LOGICAL_RESOURCE_ID = CLR1.LOGICAL_RESOURCE_ID AND\n         whereClauseSegment.append(chainedResourceTableAlias).append(\"RESOURCE_ID = \")\n                 .append(chainedLogicalResourceTableAlias).append(\"CURRENT_RESOURCE_ID\")\n                 .append(AND)\n                 .append(chainedResourceTableAlias)\n-                .append(\"IS_DELETED\").append(\" <> 'Y'\")\n+                .append(\"IS_DELETED\").append(\" = 'N'\")", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE4NzgwNw==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r519187807", "bodyText": "I've seen Mike has made this change when reviewing his PR.", "author": "punktilious", "createdAt": "2020-11-07T15:21:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwODI0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwOTE4Mg==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r517409182", "bodyText": "I think we should reference the issue since 4.5.0 doesn't yet exist.", "author": "prb112", "createdAt": "2020-11-04T15:03:21Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -224,8 +224,18 @@ public FHIRPersistenceJDBCImpl(FHIRPersistenceJDBCCache cache) throws Exception\n         // are processed the first time a connection is established to a particular tenant/datasource.\n         this.configProvider = new DefaultFHIRConfigProvider(); // before buildActionChain()\n         this.schemaNameSupplier = new SchemaNameImpl(this);\n-        this.connectionStrategy = new FHIRDbProxyDatasourceConnectionStrategy(trxSynchRegistry, buildActionChain());\n-        this.transactionAdapter = new FHIRUserTransactionAdapter(userTransaction, trxSynchRegistry, cache, TXN_DATA_KEY);        \n+\n+        // Release 4.5.0: Still default to the old proxy datasource configuration so we don't break existing", "originalCommit": "ff5b2cd6b28ff8adbde83a721fe1c1b1115ac18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgzODQ5NQ==", "url": "https://github.com/IBM/FHIR/pull/1664#discussion_r518838495", "bodyText": "ok", "author": "punktilious", "createdAt": "2020-11-06T15:48:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQwOTE4Mg=="}], "type": "inlineReview"}, {"oid": "3a7e9993f8658fdf570af65cd8aac5c4bf65d85a", "url": "https://github.com/IBM/FHIR/commit/3a7e9993f8658fdf570af65cd8aac5c4bf65d85a", "message": "issue #916 addressed review comments, use legacy proxy datasource config for Db2 SITs\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-06T16:24:49Z", "type": "commit"}, {"oid": "2abacfbd47c952bcb3359f7de20fa4bd89469689", "url": "https://github.com/IBM/FHIR/commit/2abacfbd47c952bcb3359f7de20fa4bd89469689", "message": "Merge remote-tracking branch 'origin/master' into robin-proto", "committedDate": "2020-11-06T16:25:43Z", "type": "commit"}, {"oid": "02151f9577ab0fa5e3bcec0d8e21fd582b6940f9", "url": "https://github.com/IBM/FHIR/commit/02151f9577ab0fa5e3bcec0d8e21fd582b6940f9", "message": "issue #916 fixed comment referencing future release\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-06T16:53:11Z", "type": "commit"}, {"oid": "9e91293c46a16dd46e78c189bc52dcb71c47dff1", "url": "https://github.com/IBM/FHIR/commit/9e91293c46a16dd46e78c189bc52dcb71c47dff1", "message": "issue #916 derby bootstrap must default using proxy datasource config\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-06T19:12:55Z", "type": "commit"}, {"oid": "7ed643b4aa0ccff36acd1aee02866156af8f814d", "url": "https://github.com/IBM/FHIR/commit/7ed643b4aa0ccff36acd1aee02866156af8f814d", "message": "issue #916 must keep fhirProxyDataSource defined in server.xml\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-06T19:59:45Z", "type": "commit"}, {"oid": "ec7bab525ba9fd3f218b77ce4cc332f1f36e11e3", "url": "https://github.com/IBM/FHIR/commit/ec7bab525ba9fd3f218b77ce4cc332f1f36e11e3", "message": "issue #916 db2 tests require legacy Derby datasource config for tenant1\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-06T21:06:15Z", "type": "commit"}, {"oid": "642ff7258659f03eab8bfa0f57a7f312a285e43b", "url": "https://github.com/IBM/FHIR/commit/642ff7258659f03eab8bfa0f57a7f312a285e43b", "message": "issue #916 updated FHIRServerUsersGuide per review comments\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-10T05:03:32Z", "type": "commit"}, {"oid": "545c3e0d58b60bde8313e76e09d29c9f19900d8d", "url": "https://github.com/IBM/FHIR/commit/545c3e0d58b60bde8313e76e09d29c9f19900d8d", "message": "issue #916 merged with master\n\nSigned-off-by: Robin Arnold <robin.arnold23@ibm.com>", "committedDate": "2020-11-10T05:23:29Z", "type": "commit"}]}