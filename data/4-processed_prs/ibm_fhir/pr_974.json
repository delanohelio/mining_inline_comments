{"pr_number": 974, "pr_title": "issue #930 - ensure status is never null from delete AND return 200 OK on success", "pr_createdAt": "2020-04-22T21:05:08Z", "pr_url": "https://github.com/IBM/FHIR/pull/974", "timeline": [{"oid": "1b545e37f3f05f48da6f7314ac94d5e4a0be2d61", "url": "https://github.com/IBM/FHIR/commit/1b545e37f3f05f48da6f7314ac94d5e4a0be2d61", "message": "issue #930 - ensure status is never null from delete\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-22T21:04:48Z", "type": "commit"}, {"oid": "fa3d36e9d967180c9c90db03907284982564bc33", "url": "https://github.com/IBM/FHIR/commit/fa3d36e9d967180c9c90db03907284982564bc33", "message": "issue #930 - normalize delete and conditionalDelete\n\nI found that these two delete options were handled subtely different.\nNow the response status is set properly in FHIRRestHelper.doDelete() and\nthese two variants share a common buildResponse helper.\n\nDeleting a non-existent or previously deleted resource will always\nresult in a 200 with an OperationOutcome that has a WARNING.\n\nDeleting a resource will continue to result in HTTP 204 (No Content).\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-23T19:40:46Z", "type": "commit"}, {"oid": "fa3d36e9d967180c9c90db03907284982564bc33", "url": "https://github.com/IBM/FHIR/commit/fa3d36e9d967180c9c90db03907284982564bc33", "message": "issue #930 - normalize delete and conditionalDelete\n\nI found that these two delete options were handled subtely different.\nNow the response status is set properly in FHIRRestHelper.doDelete() and\nthese two variants share a common buildResponse helper.\n\nDeleting a non-existent or previously deleted resource will always\nresult in a 200 with an OperationOutcome that has a WARNING.\n\nDeleting a resource will continue to result in HTTP 204 (No Content).\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-23T19:40:46Z", "type": "forcePushed"}, {"oid": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9", "url": "https://github.com/IBM/FHIR/commit/02eeff5c120a98d7072f10f06a417ad3f1dcc7a9", "message": "issue #930 - added informational message for all successful deletes\n\nNow all successful delete operations will always result in an HTTP 200\n(OK).  Conditional deletes will return the number of resources deleted\n(and their logical ids) in the OperationOutcome response.\n\nAlso fixed a subtle bug in SearchNearTest.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-23T20:23:44Z", "type": "commit"}, {"oid": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9", "url": "https://github.com/IBM/FHIR/commit/02eeff5c120a98d7072f10f06a417ad3f1dcc7a9", "message": "issue #930 - added informational message for all successful deletes\n\nNow all successful delete operations will always result in an HTTP 200\n(OK).  Conditional deletes will return the number of resources deleted\n(and their logical ids) in the OperationOutcome response.\n\nAlso fixed a subtle bug in SearchNearTest.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-23T20:23:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwNzExMQ==", "url": "https://github.com/IBM/FHIR/pull/974#discussion_r414107111", "bodyText": "the changes here are mostly just for style:  by moving the exception cases to the top, i reduced the main code block by two levels of indentation", "author": "lmsurpre", "createdAt": "2020-04-23T20:37:50Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -567,75 +567,77 @@ private ResourceDAO getResourceDao() {\n         try {\n             existingResourceDTO = this.getResourceDao().read(logicalId, resourceType.getSimpleName());\n \n-            if (existingResourceDTO != null) {\n-                if (existingResourceDTO.isDeleted()) {\n-                    existingResource = this.convertResourceDTO(existingResourceDTO, resourceType, null);\n-                    resourceBuilder = existingResource.toBuilder();\n-\n-                    SingleResourceResult<T> result = new SingleResourceResult.Builder<T>()\n-                            .success(true)\n-                            .resource(existingResource)\n-                            .build();\n+            if (existingResourceDTO == null) {\n+                throw new FHIRPersistenceResourceNotFoundException(\"resource does not exist: \" + \n+                        resourceType.getSimpleName() + \":\" + logicalId);\n+            }", "originalCommit": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUyNTg1Nw==", "url": "https://github.com/IBM/FHIR/pull/974#discussion_r414525857", "bodyText": "2 \":\" seems a little bit strange, can we change to\nresourceType.getSimpleName() + \":\" + logicalId\" + \"does not exist.\"\nor use the same style as the other warning info of the following codes.", "author": "albertwang-ibm", "createdAt": "2020-04-24T12:09:24Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -567,75 +567,77 @@ private ResourceDAO getResourceDao() {\n         try {\n             existingResourceDTO = this.getResourceDao().read(logicalId, resourceType.getSimpleName());\n \n-            if (existingResourceDTO != null) {\n-                if (existingResourceDTO.isDeleted()) {\n-                    existingResource = this.convertResourceDTO(existingResourceDTO, resourceType, null);\n-                    resourceBuilder = existingResource.toBuilder();\n-\n-                    SingleResourceResult<T> result = new SingleResourceResult.Builder<T>()\n-                            .success(true)\n-                            .resource(existingResource)\n-                            .build();\n+            if (existingResourceDTO == null) {\n+                throw new FHIRPersistenceResourceNotFoundException(\"resource does not exist: \" + \n+                        resourceType.getSimpleName() + \":\" + logicalId);", "originalCommit": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUzMDgzNw==", "url": "https://github.com/IBM/FHIR/pull/974#discussion_r414530837", "bodyText": "Adding to Albert's comments... we should bracket the values in the message.", "author": "prb112", "createdAt": "2020-04-24T12:17:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUyNTg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3MTEzNA==", "url": "https://github.com/IBM/FHIR/pull/974#discussion_r414571134", "bodyText": "My PR didn't actually change the error message from before, but I agree with these comments and will address now.", "author": "lmsurpre", "createdAt": "2020-04-24T13:21:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUyNTg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3MjY3Mw==", "url": "https://github.com/IBM/FHIR/pull/974#discussion_r414572673", "bodyText": "I think I'll just change it to \"resource does not exist: \" + resourceType.getSimpleName() + \"/\" + logicalId)\nI usually like to bracket the values in ' but in this case the values can't contain spaces", "author": "lmsurpre", "createdAt": "2020-04-24T13:24:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUyNTg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUzNjE3OA==", "url": "https://github.com/IBM/FHIR/pull/974#discussion_r414536178", "bodyText": "wrong method name", "author": "prb112", "createdAt": "2020-04-24T12:26:32Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -893,8 +902,7 @@ private ResourceDAO getResourceDao() {\n      * @throws IOException\n      */\n     protected List<Resource> buildSortedFhirResources(FHIRPersistenceContext context, Class<? extends Resource> resourceType, List<Long> sortedIdList,\n-                                                      List<String> elements)\n-                            throws FHIRException, FHIRPersistenceException, IOException {\n+            List<String> elements) throws FHIRException, FHIRPersistenceException, IOException {\n         final String METHOD_NAME = \"buildFhirResource\";", "originalCommit": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3MzcyNA==", "url": "https://github.com/IBM/FHIR/pull/974#discussion_r414573724", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final String METHOD_NAME = \"buildFhirResource\";\n          \n          \n            \n                    final String METHOD_NAME = \"buildSortedFhirResources\";", "author": "lmsurpre", "createdAt": "2020-04-24T13:25:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUzNjE3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3MzE1OQ==", "url": "https://github.com/IBM/FHIR/pull/974#discussion_r414573159", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    resourceType.getSimpleName() + \":\" + logicalId);\n          \n          \n            \n                                    resourceType.getSimpleName() + \"/\" + logicalId);", "author": "lmsurpre", "createdAt": "2020-04-24T13:24:42Z", "path": "fhir-persistence-jdbc/src/main/java/com/ibm/fhir/persistence/jdbc/impl/FHIRPersistenceJDBCImpl.java", "diffHunk": "@@ -567,75 +567,77 @@ private ResourceDAO getResourceDao() {\n         try {\n             existingResourceDTO = this.getResourceDao().read(logicalId, resourceType.getSimpleName());\n \n-            if (existingResourceDTO != null) {\n-                if (existingResourceDTO.isDeleted()) {\n-                    existingResource = this.convertResourceDTO(existingResourceDTO, resourceType, null);\n-                    resourceBuilder = existingResource.toBuilder();\n-\n-                    SingleResourceResult<T> result = new SingleResourceResult.Builder<T>()\n-                            .success(true)\n-                            .resource(existingResource)\n-                            .build();\n+            if (existingResourceDTO == null) {\n+                throw new FHIRPersistenceResourceNotFoundException(\"resource does not exist: \" + \n+                        resourceType.getSimpleName() + \":\" + logicalId);", "originalCommit": "02eeff5c120a98d7072f10f06a417ad3f1dcc7a9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c54c599f401e55fe552f1b360842a4456d4c48c8", "url": "https://github.com/IBM/FHIR/commit/c54c599f401e55fe552f1b360842a4456d4c48c8", "message": "Apply suggestions from code review\r\n\r\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-24T13:28:32Z", "type": "commit"}]}