{"pr_number": 904, "pr_title": "Issue 837 and 649 - double-down on the UBI-based OpenLiberty image", "pr_createdAt": "2020-04-07T21:31:55Z", "pr_url": "https://github.com/IBM/FHIR/pull/904", "timeline": [{"oid": "9e09acc18f8fd5320acf3d1a4a4d85093d36e999", "url": "https://github.com/IBM/FHIR/commit/9e09acc18f8fd5320acf3d1a4a4d85093d36e999", "message": "Update Dockerfile to align with openliberty #814\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-07T18:50:07Z", "type": "commit"}, {"oid": "68928ed58c3925c386853bb1a04a4abebcfe6b17", "url": "https://github.com/IBM/FHIR/commit/68928ed58c3925c386853bb1a04a4abebcfe6b17", "message": "issue #837 - moved docker-compose env and all related scripts to build\n\nPreviously, the CI pipeline used a strange mix of scripts from `build`\nand `fhir-install`.\nNow there is a single Dockerfile in fhir-install and the variants used\nby our CI pipeline are nicely contained under the build directory.\n\nI performed a lot of cleanup / script normalization in the process.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-07T21:35:43Z", "type": "forcePushed"}, {"oid": "b92d3ceb96144a52fa8471e454b639c3d2e54f62", "url": "https://github.com/IBM/FHIR/commit/b92d3ceb96144a52fa8471e454b639c3d2e54f62", "message": "issue #837 - moved docker-compose env and all related scripts to build\n\nPreviously, the CI pipeline used a strange mix of scripts from `build`\nand `fhir-install`.\nNow there is a single Dockerfile in fhir-install and the variants used\nby our CI pipeline are nicely contained under the build directory.\n\nI performed a lot of cleanup / script normalization in the process.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-07T21:52:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3OTY5Mw==", "url": "https://github.com/IBM/FHIR/pull/904#discussion_r405179693", "bodyText": "logs was added for release.sh - please add back", "author": "prb112", "createdAt": "2020-04-07T23:52:13Z", "path": "build/.gitignore", "diffHunk": "@@ -1 +1,6 @@\n-logs/", "originalCommit": "b92d3ceb96144a52fa8471e454b639c3d2e54f62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxMDgzMA==", "url": "https://github.com/IBM/FHIR/pull/904#discussion_r405210830", "bodyText": "done", "author": "lmsurpre", "createdAt": "2020-04-08T01:44:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3OTY5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MDE0Nw==", "url": "https://github.com/IBM/FHIR/pull/904#discussion_r405180147", "bodyText": "I think what I built for persistence-automation for postgres, could play well here, and we should probably reconcile early as I think you have a pattern that I've just generalized.", "author": "prb112", "createdAt": "2020-04-07T23:53:46Z", "path": "build/db2-migration-test-docker.sh", "diffHunk": "@@ -7,13 +7,13 @@\n set -ex\n \n echo \"Preparing environment for fhir-server integration tests...\"\n-if [[ -z \"${WORKSPACE}\" ]]; then\n-    echo \"ERROR: WORKSPACE environment variable not set!\"\n-    exit 2\n-fi\n+\n+# The full path to the directory of this script, no matter where its called from", "originalCommit": "b92d3ceb96144a52fa8471e454b639c3d2e54f62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxMTY2NQ==", "url": "https://github.com/IBM/FHIR/pull/904#discussion_r405211665", "bodyText": "I find that having this run the same no matter where its invoked from simplifies the script, so I settled on this pattern based on https://stackoverflow.com/a/246128/161022\nPreviously, these scripts required us to set a WORKSPACE env variable, but this got me very confused when I cloned a second copy of our repo and tried running the scripts and couldn't understand why it wasn't using the right stuff.  Better to have it know its in a build dir under the project root and always execute relative to that.", "author": "lmsurpre", "createdAt": "2020-04-08T01:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MDE0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MDU5OQ==", "url": "https://github.com/IBM/FHIR/pull/904#discussion_r405180599", "bodyText": "There has to be at least one link / reference to this file in an md", "author": "prb112", "createdAt": "2020-04-07T23:55:01Z", "path": "build/docker/db2/Dockerfile", "diffHunk": "@@ -6,8 +6,7 @@\n \n FROM ibmcom/db2\n \n-# Create a non-admin user for the FHIR server\n-# This non-admin user will be used by fhir server to access db2\n+# Create a non-admin user for the FHIR server to use to access db2", "originalCommit": "b92d3ceb96144a52fa8471e454b639c3d2e54f62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxMTkyOA==", "url": "https://github.com/IBM/FHIR/pull/904#discussion_r405211928", "bodyText": "Not sure I follow this comment...", "author": "lmsurpre", "createdAt": "2020-04-08T01:48:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MDU5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2MDI3NQ==", "url": "https://github.com/IBM/FHIR/pull/904#discussion_r405660275", "bodyText": "sorry - I did a quick search in the docs, and we should probably make sure (since we move this file) that there are no documents that need updating", "author": "prb112", "createdAt": "2020-04-08T16:37:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MDU5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2NDQyNA==", "url": "https://github.com/IBM/FHIR/pull/904#discussion_r405664424", "bodyText": "good call.  i just found one:\nfhir-install/README-DB2.md:docker build -t fhirserverdb2 . -f Dockerfile-db2 --squash\n\nwill fix", "author": "lmsurpre", "createdAt": "2020-04-08T16:43:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MDU5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNDU5OA==", "url": "https://github.com/IBM/FHIR/pull/904#discussion_r405704598", "bodyText": "ok, i basically ended up re-writing this readme and moved it to the build dir", "author": "lmsurpre", "createdAt": "2020-04-08T17:48:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MDU5OQ=="}], "type": "inlineReview"}, {"oid": "19fcdb289afe182d913f04679552735dbda90740", "url": "https://github.com/IBM/FHIR/commit/19fcdb289afe182d913f04679552735dbda90740", "message": "issue #837 - moved docker-compose env and all related scripts to build\n\nPreviously, the CI pipeline used a strange mix of scripts from `build`\nand `fhir-install`.\nNow there is a single Dockerfile in fhir-install and the variants used\nby our CI pipeline are nicely contained under the build directory.\n\nI performed a lot of cleanup / script normalization in the process.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-08T01:44:24Z", "type": "forcePushed"}, {"oid": "6a982c88ba111c5827b117c67322b666e3d42c0a", "url": "https://github.com/IBM/FHIR/commit/6a982c88ba111c5827b117c67322b666e3d42c0a", "message": "issue #837 - moved docker-compose env and all related scripts to build\n\nPreviously, the CI pipeline used a strange mix of scripts from `build`\nand `fhir-install`.\nNow there is a single Dockerfile in fhir-install and the variants used\nby our CI pipeline are nicely contained under the build directory.\n\nI performed a lot of cleanup / script normalization in the process.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-08T03:02:10Z", "type": "forcePushed"}, {"oid": "d5c9811c2dc33b4741df6c9475500f8b0f6f6a36", "url": "https://github.com/IBM/FHIR/commit/d5c9811c2dc33b4741df6c9475500f8b0f6f6a36", "message": "issue #837 - moved docker-compose env and all related scripts to build\n\nPreviously, the CI pipeline used a strange mix of scripts from `build`\nand `fhir-install`.\nNow there is a single Dockerfile in fhir-install and the variants used\nby our CI pipeline are nicely contained under the build directory.\n\nI performed a lot of cleanup / script normalization in the process.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-08T03:05:04Z", "type": "forcePushed"}, {"oid": "e1eba4ad4790419d79762906439ccb99fd381a41", "url": "https://github.com/IBM/FHIR/commit/e1eba4ad4790419d79762906439ccb99fd381a41", "message": "issue #837 - moved docker-compose env and all related scripts to build\n\nPreviously, the CI pipeline used a strange mix of scripts from `build`\nand `fhir-install`.\nNow there is a single Dockerfile in fhir-install and the variants used\nby our CI pipeline are nicely contained under the build directory.\n\nI performed a lot of cleanup / script normalization in the process.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-08T04:07:12Z", "type": "commit"}, {"oid": "e1eba4ad4790419d79762906439ccb99fd381a41", "url": "https://github.com/IBM/FHIR/commit/e1eba4ad4790419d79762906439ccb99fd381a41", "message": "issue #837 - moved docker-compose env and all related scripts to build\n\nPreviously, the CI pipeline used a strange mix of scripts from `build`\nand `fhir-install`.\nNow there is a single Dockerfile in fhir-install and the variants used\nby our CI pipeline are nicely contained under the build directory.\n\nI performed a lot of cleanup / script normalization in the process.\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-08T04:07:12Z", "type": "forcePushed"}, {"oid": "435dca98d89bce7486cc177654f66549116f7e3c", "url": "https://github.com/IBM/FHIR/commit/435dca98d89bce7486cc177654f66549116f7e3c", "message": "issue #837 - consolidate down to a single fhir-server docker image\n\n1. Added dockerfile-maven-plugin to fhir-install; now it builds the\n`ibmcom/ibm-fhir-server` docker image as part of the \"install\" phase and\npushes it to a registry as part of the \"deploy\" phase (config pending)\n\n2. Removed build/docker/liberty/Dockerfile; renamed the `liberty` dir to\n`fhir-server`, moved the config and userlib dirs under a child directory\nnamed \"volumes\", and bind mounted those volumes from the fhir-server\nservice defined in docker-compose.yml\n\n3. Removed copy-dependencies.sh; now `pre-integration-test.sh` just\ncopies the dependencies directly to the target ($SIT) directory, so that\nonly the dockerized integration scripts actually use the build/docker\ndirectory\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-08T13:15:58Z", "type": "commit"}, {"oid": "d9a1dcbccba3546f479aec1f0ce639d3e3a8ff5a", "url": "https://github.com/IBM/FHIR/commit/d9a1dcbccba3546f479aec1f0ce639d3e3a8ff5a", "message": "Merge pull request #907 from IBM/issue-649\n\nissue #837 - consolidate to a single fhir-server docker image", "committedDate": "2020-04-08T13:44:42Z", "type": "commit"}, {"oid": "db0e5d6fbfc6abeb801b0acaf85070e812a3e3aa", "url": "https://github.com/IBM/FHIR/commit/db0e5d6fbfc6abeb801b0acaf85070e812a3e3aa", "message": "issue #649 - docker push release automation\n\n1. Added docker-push.sh to the release workflow; this uses a username\nand password that come from github secrets (currently my username and a\ncorresponding apikey)\n\n2. Delete some old/outdated scripts from the build directory\n\n3. Moved the dockerfile-maven-plugin version back into parent\ndependencyManagement\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-08T15:59:19Z", "type": "commit"}, {"oid": "a62c3bede27f4e373da124462b78ea9d46036cfc", "url": "https://github.com/IBM/FHIR/commit/a62c3bede27f4e373da124462b78ea9d46036cfc", "message": "Merge pull request #909 from IBM/issue-649\n\nissue #649 - docker push release automation", "committedDate": "2020-04-08T16:03:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1OTQ0Nw==", "url": "https://github.com/IBM/FHIR/pull/904#discussion_r405659447", "bodyText": "interesting.. this is considered a reserved exit code\nhttp://www.tldp.org/LDP/abs/html/exitcodes.html\njust something to think about next time we're in the code", "author": "prb112", "createdAt": "2020-04-08T16:35:46Z", "path": "build/docker/copy-schema-jar.sh", "diffHunk": "@@ -0,0 +1,22 @@\n+#!/usr/bin/env bash\n+###############################################################################\n+# (C) Copyright IBM Corp. 2016, 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+###############################################################################\n+set -e\n+\n+if [[ -z \"${WORKSPACE}\" ]]; then\n+    echo \"ERROR: WORKSPACE environment variable not set!\"\n+    exit 2", "originalCommit": "a62c3bede27f4e373da124462b78ea9d46036cfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2MDU2Mg==", "url": "https://github.com/IBM/FHIR/pull/904#discussion_r405660562", "bodyText": "i was wondering why it exits with a code of 2!\nlets just change to 1 and be done?", "author": "lmsurpre", "createdAt": "2020-04-08T16:37:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1OTQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2MzU2Nw==", "url": "https://github.com/IBM/FHIR/pull/904#discussion_r405663567", "bodyText": "done", "author": "lmsurpre", "createdAt": "2020-04-08T16:42:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1OTQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2MjM3Nw==", "url": "https://github.com/IBM/FHIR/pull/904#discussion_r405662377", "bodyText": "good fix", "author": "prb112", "createdAt": "2020-04-08T16:40:26Z", "path": "build/gen-code.sh", "diffHunk": "@@ -5,12 +5,16 @@\n #\n # SPDX-License-Identifier: Apache-2.0\n ###############################################################################\n+set -ex\n \n-# installs the fhir-tools\n-mvn clean package install -f ../fhir-tools/pom.xml\n+# The full path to the directory of this script, no matter where its called from\n+DIR=\"$( cd \"$( dirname \"${BASH_SOURCE[0]}\" )\" >/dev/null 2>&1 && pwd )\"\n+WORKSPACE=\"$( dirname \"${DIR}\" )\"\n+\n+# Install the latest fhir-tools\n+mvn clean install -f ${WORKSPACE}/fhir-tools/pom.xml\n \n if [[ $? -eq 0 ]]\n-then \n-    mvn com.ibm.fhir:fhir-tools:generate-model -f ../fhir-model/pom.xml\n+then\n+    mvn com.ibm.fhir:fhir-tools:generate-model -f ${WORKSPACE}/fhir-model/pom.xml", "originalCommit": "a62c3bede27f4e373da124462b78ea9d46036cfc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4d474fd13fd77b10aa8849265f483c7e2510898e", "url": "https://github.com/IBM/FHIR/commit/4d474fd13fd77b10aa8849265f483c7e2510898e", "message": "Update README and avoid reserved exit code in scripts\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-08T16:41:55Z", "type": "commit"}, {"oid": "c1b25ff439eda7a4319ea08393a179d2c67ecd01", "url": "https://github.com/IBM/FHIR/commit/c1b25ff439eda7a4319ea08393a179d2c67ecd01", "message": "update README-DB2 and move into build dir\n\nSigned-off-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-08T17:47:50Z", "type": "commit"}]}