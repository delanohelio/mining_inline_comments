{"pr_number": 1010, "pr_title": "Issue 1004", "pr_createdAt": "2020-05-01T15:33:13Z", "pr_url": "https://github.com/IBM/FHIR/pull/1010", "timeline": [{"oid": "929c8b97266fac13c2d75b0a8deaef3923a4a2c8", "url": "https://github.com/IBM/FHIR/commit/929c8b97266fac13c2d75b0a8deaef3923a4a2c8", "message": "Prepopulate Resource Types and Specification Parameters Name Table #1004\n\n- Raise start of sequences to 20000 to support a range of custom\nparameter names/codes stored in the db.\n- Refactor PopulateResourceTypes to work with multi-tenant or single\ntenant stores\n- Refactor Main to support both Resource Types and Parameter Names cache\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-04-30T19:42:38Z", "type": "commit"}, {"oid": "a4cf8c634be0f89045c9ef514106a4a45a96532a", "url": "https://github.com/IBM/FHIR/commit/a4cf8c634be0f89045c9ef514106a4a45a96532a", "message": "Prepopulate Resource Types and Specification Parameters Name Table #1004\n\n- Update to support prepopulation with specific values\n- Fixed issues in execute/add batch in the Prepopuation\n- Prepopulate ParameterNames and ResourceTypes\n- Refactor Main to remove random AddStatic values\n- Update to Support Derby and DerbyFhirDatabase and DerbyBootstrapper\n\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>", "committedDate": "2020-05-01T14:17:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYzMTMyOA==", "url": "https://github.com/IBM/FHIR/pull/1010#discussion_r418631328", "bodyText": "why 20000 and not 10000?", "author": "lmsurpre", "createdAt": "2020-05-01T16:55:57Z", "path": "fhir-database-utils/src/main/java/com/ibm/fhir/database/utils/common/CommonDatabaseAdapter.java", "diffHunk": "@@ -424,14 +424,14 @@ public void runStatement(IDatabaseStatement stmt) {\n     public void createSequence(String schemaName, String sequenceName, int cache) {\n         /*\n          * <CODE>CREATE SEQUENCE fhir_sequence\n-             AS BIGINT\n-     START WITH 1000\n-          CACHE 1000\n-       NO CYCLE;</CODE>\n-    */\n+         * AS BIGINT\n+         * START WITH 20000", "originalCommit": "a4cf8c634be0f89045c9ef514106a4a45a96532a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY2Mjk3Mw==", "url": "https://github.com/IBM/FHIR/pull/1010#discussion_r418662973", "bodyText": "plenty of space then, for any expansions we need based on sequences", "author": "prb112", "createdAt": "2020-05-01T18:04:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYzMTMyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY2NTI4Nw==", "url": "https://github.com/IBM/FHIR/pull/1010#discussion_r418665287", "bodyText": "ok, was just curious", "author": "lmsurpre", "createdAt": "2020-05-01T18:09:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYzMTMyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY1NDAyMw==", "url": "https://github.com/IBM/FHIR/pull/1010#discussion_r418654023", "bodyText": "I guess this wasn't so important, after all?", "author": "lmsurpre", "createdAt": "2020-05-01T17:45:00Z", "path": "fhir-persistence-schema/src/main/java/com/ibm/fhir/schema/app/Main.java", "diffHunk": "@@ -1045,21 +1035,30 @@ protected void allocateTenant() {\n     }\n \n     /**\n-     * Populate all the static tables we need\n-     *\n-     * @param gen\n-     * @param tenantKey\n+     * populates for the given tenantId the RESOURCE_TYPE table.\n+     * \n+     * @implNote if you update this method, be sure to update\n+     *           DerbyBootstrapper.populateResourceTypeAndParameterNameTableEntries\n+     *           and DerbyFhirDatabase.populateResourceTypeAndParameterNameTableEntries\n+     *           The reason is there are three different ways of managing the transaction.\n+     * @param tenantId the mt_id that is used to setup the partition.\n+     *                 passing in null signals not multi-tenant.\n      */\n-    protected void populateStaticTables(FhirSchemaGenerator gen, String tenantKey) {\n-        IDatabaseAdapter adapter = getDbAdapter(connectionPool);\n+    protected void populateResourceTypeAndParameterNameTableEntries(Integer tenantId) {\n         try (ITransaction tx = TransactionFactory.openTransaction(connectionPool)) {\n-            try {\n-                // Very important. Establish the value of the session variable so that we\n-                // pass the row permission predicate\n-                Db2SetTenantVariable cmd = new Db2SetTenantVariable(adminSchemaName, tenantName, tenantKey);\n-                adapter.runStatement(cmd);", "originalCommit": "a4cf8c634be0f89045c9ef514106a4a45a96532a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY2MzQ2OA==", "url": "https://github.com/IBM/FHIR/pull/1010#discussion_r418663468", "bodyText": "Yes, since I removed the method", "author": "prb112", "createdAt": "2020-05-01T18:05:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY1NDAyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY2MzM5Nw==", "url": "https://github.com/IBM/FHIR/pull/1010#discussion_r418663397", "bodyText": "yikes, this old description was awful", "author": "lmsurpre", "createdAt": "2020-05-01T18:04:54Z", "path": "fhir-persistence-schema/src/main/resources/add_parameter_name.sql", "diffHunk": "@@ -5,11 +5,7 @@\n -------------------------------------------------------------------------------\n \n -- ----------------------------------------------------------------------------\n--- Procedure to add a resource version and its associated parameters. These\n--- parameters only ever point to the latest version of a resource, never to\n--- previous versions, which are kept to support history queries.\n--- Parameters must be loaded into the parameters_gtt global temporary table\n--- prior to this procedure being called", "originalCommit": "a4cf8c634be0f89045c9ef514106a4a45a96532a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY2MzUyMQ==", "url": "https://github.com/IBM/FHIR/pull/1010#discussion_r418663521", "bodyText": "very inaccurate", "author": "prb112", "createdAt": "2020-05-01T18:05:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY2MzM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODY2MzgwNg==", "url": "https://github.com/IBM/FHIR/pull/1010#discussion_r418663806", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # This class maintains a version agnostic mapping and ordering of resources to LOGICAL_IDs. \n          \n          \n            \n            # This file maintains a version agnostic mapping and ordering of parameter names (codes)\n          \n          \n            \n            # to identifiers for pre-populating the PARAMETER_NAMES table.", "author": "lmsurpre", "createdAt": "2020-05-01T18:05:54Z", "path": "fhir-persistence-schema/src/main/resources/parameter_names.properties", "diffHunk": "@@ -0,0 +1,453 @@\n+# This class maintains a version agnostic mapping and ordering of resources to LOGICAL_IDs. ", "originalCommit": "a4cf8c634be0f89045c9ef514106a4a45a96532a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f2a454a05d1b421ac21cda713ebbb79293b212b2", "url": "https://github.com/IBM/FHIR/commit/f2a454a05d1b421ac21cda713ebbb79293b212b2", "message": "Update fhir-persistence-schema/src/main/resources/parameter_names.properties\r\n\r\nSigned-off-by: Paul Bastide <pbastide@us.ibm.com>\n\nCo-authored-by: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-05-01T18:07:37Z", "type": "commit"}]}