{"pr_number": 1116, "pr_title": "issue #779 #1150 partitionize bulkexport JavaBatch Job & fix CWWKY0041W warnings", "pr_createdAt": "2020-05-18T20:01:00Z", "pr_url": "https://github.com/IBM/FHIR/pull/1116", "timeline": [{"oid": "1164de36597f809db74358970683dab3d1e3afa5", "url": "https://github.com/IBM/FHIR/commit/1164de36597f809db74358970683dab3d1e3afa5", "message": "Merge pull request #1075 from IBM/issue-#953\n\nIssue #953", "committedDate": "2020-05-12T14:46:05Z", "type": "commit"}, {"oid": "e94da7b85f47cbffa0a47e3497e2e876a45c6c71", "url": "https://github.com/IBM/FHIR/commit/e94da7b85f47cbffa0a47e3497e2e876a45c6c71", "message": "Merge pull request #1114 from IBM/issue-779\n\nIssue 779 - sync with master before PR bulkexport partition updates", "committedDate": "2020-05-18T15:55:15Z", "type": "commit"}, {"oid": "0694a550adac3efff2277ddeda6c51bb1c0014fd", "url": "https://github.com/IBM/FHIR/commit/0694a550adac3efff2277ddeda6c51bb1c0014fd", "message": "issue #779 partitionize bulkexport javabatch job\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-05-18T19:59:40Z", "type": "commit"}, {"oid": "17dab0f293a6af33394834dc60cc5e0e27ecedb2", "url": "https://github.com/IBM/FHIR/commit/17dab0f293a6af33394834dc60cc5e0e27ecedb2", "message": "issue #779 bulkexport results in job exit status and simple metrics\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-05-21T12:41:01Z", "type": "commit"}, {"oid": "4cfcdfa1cb9508e8df9acecf6085c6cc832fa57d", "url": "https://github.com/IBM/FHIR/commit/4cfcdfa1cb9508e8df9acecf6085c6cc832fa57d", "message": "issue #779 checkpoint algorithm updates\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-05-21T18:16:19Z", "type": "commit"}, {"oid": "c4a64643681f778b9ae7e49f5fa97a5b99edc598", "url": "https://github.com/IBM/FHIR/commit/c4a64643681f778b9ae7e49f5fa97a5b99edc598", "message": "issue #779 #1150 further refactor and fix CWWKY0041W warnings\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-05-26T12:57:06Z", "type": "commit"}, {"oid": "066c797643da029380943400aae495f9296c15da", "url": "https://github.com/IBM/FHIR/commit/066c797643da029380943400aae495f9296c15da", "message": "issue #1150 add cdi-api for fixing CWWKY0041\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-05-26T13:18:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxMzM5Mw==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430413393", "bodyText": "Please use\n<dependency>\n    <groupId>jakarta.enterprise</groupId>\n    <artifactId>jakarta.enterprise.cdi-api</artifactId>\n    <version>2.0.2</version>\n    <scope>provided</scope>\n</dependency>", "author": "prb112", "createdAt": "2020-05-26T13:30:54Z", "path": "fhir-parent/pom.xml", "diffHunk": "@@ -297,6 +297,12 @@\n                 <artifactId>jakarta.inject-api</artifactId>\n                 <version>1.0</version>\n             </dependency>\n+            <dependency>\n+                <groupId>javax.enterprise</groupId>\n+                <artifactId>cdi-api</artifactId>\n+                <version>2.0.SP1</version>\n+                <scope>provided</scope>", "originalCommit": "066c797643da029380943400aae495f9296c15da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQzMDY2MQ==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430430661", "bodyText": "good point, will change", "author": "albertwang-ibm", "createdAt": "2020-05-26T13:54:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxMzM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NjYwOA==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430446608", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:16:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxMzM5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNDA3Nw==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430414077", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |`fhirServer/bulkdata/cosFileMaxResources`|int|Max FHIR resources per COS file, \"-1\" means no limit |\n          \n          \n            \n            |`fhirServer/bulkdata/cosFileMaxResources`|int|The maximum number of FHIR resources per COS file, \"-1\" means no limit |", "author": "prb112", "createdAt": "2020-05-26T13:31:52Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1486,6 +1486,8 @@ This section contains reference information about each of the configuration prop\n |`fhirServer/bulkdata/validBaseUrls`|string|The list of supported urls which are approved for the fhir server to access|\n |`fhirServer/bulkdata/validBaseUrlsDisabled`|boolean|Disables the URL checking feature|\n |`fhirServer/bulkdata/maxInputPerRequest`|integer|The maximum inputs per bulk import|\n+|`fhirServer/bulkdata/cosFileMaxResources`|int|Max FHIR resources per COS file, \"-1\" means no limit |", "originalCommit": "066c797643da029380943400aae495f9296c15da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NzkzMQ==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430447931", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:18:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNDA3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNDI3MQ==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430414271", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |`fhirServer/bulkdata/cosFileMaxSize`|int|Max COS file size in bytes, \"-1\" means no limit |\n          \n          \n            \n            |`fhirServer/bulkdata/cosFileMaxSize`|int|The maximum COS file size in bytes, \"-1\" means no limit |", "author": "prb112", "createdAt": "2020-05-26T13:32:09Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1486,6 +1486,8 @@ This section contains reference information about each of the configuration prop\n |`fhirServer/bulkdata/validBaseUrls`|string|The list of supported urls which are approved for the fhir server to access|\n |`fhirServer/bulkdata/validBaseUrlsDisabled`|boolean|Disables the URL checking feature|\n |`fhirServer/bulkdata/maxInputPerRequest`|integer|The maximum inputs per bulk import|\n+|`fhirServer/bulkdata/cosFileMaxResources`|int|Max FHIR resources per COS file, \"-1\" means no limit |\n+|`fhirServer/bulkdata/cosFileMaxSize`|int|Max COS file size in bytes, \"-1\" means no limit |", "originalCommit": "066c797643da029380943400aae495f9296c15da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NjcxNg==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430446716", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:16:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNDI3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNDY3MA==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430414670", "bodyText": "What does this equate to? 2G?", "author": "prb112", "createdAt": "2020-05-26T13:32:43Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1532,6 +1534,8 @@ This section contains reference information about each of the configuration prop\n |`fhirServer/audit/serviceProperties/geoCounty`|US|\n |`fhirServer/bulkdata/isExportPublic`|true|\n |`fhirServer/bulkdata/validBaseUrlsDisabled`|false|\n+|`fhirServer/bulkdata/cosFileMaxResources`|500000|\n+|`fhirServer/bulkdata/cosFileMaxSize`|209715200|", "originalCommit": "066c797643da029380943400aae495f9296c15da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQzMjA2MQ==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430432061", "bodyText": "200M", "author": "albertwang-ibm", "createdAt": "2020-05-26T13:56:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNDY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQzOTA4Mg==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430439082", "bodyText": "I think it should be added to the documentation (not necessarily in this row), that it equates to 200M", "author": "prb112", "createdAt": "2020-05-26T14:06:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNDY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0MjQzMA==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430442430", "bodyText": "let me add to the comment for this config. after -1.", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:10:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNDY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NjgyNg==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430446826", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:16:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNDY3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNTAyNA==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430415024", "bodyText": "should this be server wide?", "author": "prb112", "createdAt": "2020-05-26T13:33:16Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1596,6 +1600,8 @@ must restart the server for that change to take effect.\n |`fhirServer/bulkdata/validBaseUrls`|Y|Y|\n |`fhirServer/bulkdata/maxInputPerRequest`|Y|Y|\n |`fhirServer/bulkdata/validBaseUrlsDisabled`|Y|Y|\n+|`fhirServer/bulkdata/cosFileMaxResources`|N|Y|\n+|`fhirServer/bulkdata/cosFileMaxSize`|N|Y|", "originalCommit": "066c797643da029380943400aae495f9296c15da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQzMjc2OA==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430432768", "bodyText": "this is server wide at present.", "author": "albertwang-ibm", "createdAt": "2020-05-26T13:57:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNTAyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQzODY4Mg==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430438682", "bodyText": "Right, is this something that should be configured by the tenant", "author": "prb112", "createdAt": "2020-05-26T14:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNTAyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0Mzg3OA==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430443878", "bodyText": "this is the same as isExportPublic config, they are all server wide at present. we have another issue to make them per tenant.", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:12:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNTAyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ1Mjc2Ng==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430452766", "bodyText": "issue #943", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:24:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNTAyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNTE3MA==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430415170", "bodyText": "<dependency>\n    <groupId>jakarta.enterprise</groupId>\n    <artifactId>jakarta.enterprise.cdi-api</artifactId>\n    <version>2.0.2</version>\n    <scope>provided</scope>\n</dependency>", "author": "prb112", "createdAt": "2020-05-26T13:33:29Z", "path": "fhir-bulkimportexport-webapp/pom.xml", "diffHunk": "@@ -33,6 +33,10 @@\n             <groupId>org.glassfish</groupId>\n             <artifactId>jakarta.json</artifactId>\n         </dependency>\n+        <dependency>\n+            <groupId>javax.enterprise</groupId>\n+            <artifactId>cdi-api</artifactId>\n+        </dependency>", "originalCommit": "066c797643da029380943400aae495f9296c15da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NzExOQ==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430447119", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:17:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNTE3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNTY4Mw==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430415683", "bodyText": "Why the change from the fhir. prefix?", "author": "prb112", "createdAt": "2020-05-26T13:34:14Z", "path": "fhir-bulkimportexport-webapp/src/main/java/META-INF/batch-jobs/FhirBulkExportGroupChunkJob.xml", "diffHunk": "@@ -1,20 +1,23 @@\n <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <job xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"http://xmlns.jcp.org/xml/ns/javaee\" xsi:schemaLocation=\"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/jobXML_1_0.xsd\" id=\"bulkgroupexportchunkjob\" restartable=\"true\" version=\"1.0\">\n+    <listeners>\n+        <listener ref=\"com.ibm.fhir.bulkexport.system.ExportJobListener\"/>\n+    </listeners>\n     <step id=\"step1\">\n-        <chunk checkpoint-policy=\"item\" item-count=\"1\">\n+        <chunk checkpoint-policy=\"custom\">\n             <reader ref=\"com.ibm.fhir.bulkexport.group.ChunkReader\">\n                 <properties >\n                     <property name=\"fhir.tenant\" value=\"#{jobParameters['fhir.tenant']}\"/>\n                     <property name=\"fhir.datastoreid\" value=\"#{jobParameters['fhir.datastoreid']}\"/>                   \n-                    <property name=\"fhir.resourcetype\" value=\"#{jobParameters['fhir.resourcetype']}\"/>\n+                    <property name=\"partition.resourcetype\" value=\"#{partitionPlan['partition.resourcetype']}\"/>", "originalCommit": "066c797643da029380943400aae495f9296c15da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQzNDY3MA==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430434670", "bodyText": "this is for the resourcetype processed by the partition(passed by the partition mapper to the chunk codes), this is different from the job parameter.", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNTY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNTg3Mw==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430415873", "bodyText": "Why the change from the fhir. prefix?", "author": "prb112", "createdAt": "2020-05-26T13:34:31Z", "path": "fhir-bulkimportexport-webapp/src/main/java/META-INF/batch-jobs/FhirBulkExportGroupChunkJob.xml", "diffHunk": "@@ -23,9 +26,24 @@\n                     <property name=\"cos.credential.ibm\" value=\"#{jobParameters['cos.credential.ibm']}\"/>\n                     <property name=\"cos.bucket.name\" value=\"#{jobParameters['cos.bucket.name']}\"/>\n                     <property name=\"cos.bucket.pathprefix\" value=\"#{jobParameters['cos.bucket.pathprefix']}\"/>\n-                    <property name=\"fhir.resourcetype\" value=\"#{jobParameters['fhir.resourcetype']}\"/>\n+                    <property name=\"partition.resourcetype\" value=\"#{partitionPlan['partition.resourcetype']}\"/>", "originalCommit": "066c797643da029380943400aae495f9296c15da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQzNTA0NQ==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430435045", "bodyText": "answer as above.", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNTg3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNjg3OQ==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430416879", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @BatchProperty(name = Constants.COS_BUCKET_FILE_MAX_SZIE)\n          \n          \n            \n                @BatchProperty(name = Constants.COS_BUCKET_FILE_MAX_SIZE)", "author": "prb112", "createdAt": "2020-05-26T13:35:57Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/common/CheckPointAlgorithm.java", "diffHunk": "@@ -6,38 +6,45 @@\n \n package com.ibm.fhir.bulkexport.common;\n \n+import java.util.logging.Level;\n import java.util.logging.Logger;\n \n import javax.batch.api.BatchProperty;\n import javax.batch.api.chunk.CheckpointAlgorithm;\n-import javax.batch.runtime.context.JobContext;\n+import javax.batch.runtime.context.StepContext;\n+import javax.enterprise.context.Dependent;\n import javax.inject.Inject;\n \n import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.config.FHIRConfigHelper;\n+import com.ibm.fhir.config.FHIRConfiguration;\n \n /**\n  * Bulk export Chunk implementation - custom checkpoint algorithm.\n  *\n  */\n-\n+@Dependent\n public class CheckPointAlgorithm implements CheckpointAlgorithm {\n     private final static Logger logger = Logger.getLogger(CheckPointAlgorithm.class.getName());\n+    private int cosFileMaxResources = FHIRConfigHelper.getIntProperty(FHIRConfiguration.PROPERTY_BULKDATA_BATCHJOB_COSFILEMAXRESOURCES, Constants.DEFAULT_COSFILE_MAX_RESOURCESNUMBER);\n+    private int cosFileMaxSize = FHIRConfigHelper.getIntProperty(FHIRConfiguration.PROPERTY_BULKDATA_BATCHJOB_COSFILEMAXSIZE  , Constants.DEFAULT_COSFILE_MAX_SIZE);\n+\n     @Inject\n-    JobContext jobContext;\n+    StepContext stepCtx;\n \n     /**\n-     * The cos.pagesperobject.\n+     * The file resources number limit when exporting to multiple COS files.\n      */\n     @Inject\n-    @BatchProperty(name = \"cos.pagesperobject\")\n-    String pagesPerCosObject;\n+    @BatchProperty(name = Constants.COS_BUCKET_FILE_MAX_RESOURCES)\n+    String cosBucketFileMaxResources;\n \n     /**\n      * The file size limit when exporting to multiple COS files.\n      */\n     @Inject\n-    @BatchProperty(name = \"cos.bucket.maxfilesize\")\n-    String cosBucketMaxFileSize;\n+    @BatchProperty(name = Constants.COS_BUCKET_FILE_MAX_SZIE)", "originalCommit": "066c797643da029380943400aae495f9296c15da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQzNjY3NQ==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430436675", "bodyText": "ugly typo error, let me fix. :)", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:03:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNjg3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NzMzNw==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430447337", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:17:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNjg3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNzA3Ng==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430417076", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String COS_BUCKET_FILE_MAX_SZIE = \"cos.bucket.filemaxsize\";\n          \n          \n            \n                public static final String COS_BUCKET_FILE_MAX_SIZE = \"cos.bucket.filemaxsize\";", "author": "prb112", "createdAt": "2020-05-26T13:36:14Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkcommon/Constants.java", "diffHunk": "@@ -40,17 +40,26 @@\n     public static final String COS_LOCATION = \"cos.location\";\n     public static final String COS_BUCKET_NAME = \"cos.bucket.name\";\n     public static final String COS_IS_IBM_CREDENTIAL = \"cos.credential.ibm\";\n+    public static final String COS_BUCKET_FILE_MAX_SZIE = \"cos.bucket.filemaxsize\";", "originalCommit": "066c797643da029380943400aae495f9296c15da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQzNzUzMg==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430437532", "bodyText": "good catch", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:04:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNzA3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ0NzQyNg==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430447426", "bodyText": "done", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:17:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxNzA3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxODU0MA==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430418540", "bodyText": "protected?\nthis change from List is because each resourceType is split into separate executions?", "author": "prb112", "createdAt": "2020-05-26T13:38:24Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/patient/ChunkReader.java", "diffHunk": "@@ -41,23 +42,22 @@\n import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n import com.ibm.fhir.persistence.helper.FHIRPersistenceHelper;\n import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n-import com.ibm.fhir.search.compartment.CompartmentUtil;\n import com.ibm.fhir.search.context.FHIRSearchContext;\n import com.ibm.fhir.search.util.SearchUtil;\n \n /**\n  * Bulk patient export Chunk implementation - the Reader.\n  *\n  */\n+@Dependent\n public class ChunkReader extends AbstractItemReader {\n     private final static Logger logger = Logger.getLogger(ChunkReader.class.getName());\n     protected int pageNum = 1;\n-    protected int indexOfCurrentResourceType = 0;\n     // Control the number of records to read in each \"item\".\n     protected int pageSize = Constants.DEFAULT_SEARCH_PAGE_SIZE;\n \n     protected FHIRPersistence fhirPersistence;\n-    protected List<String> resourceTypes;\n+    Class<? extends Resource> resourceType;", "originalCommit": "066c797643da029380943400aae495f9296c15da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQzODM2OA==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430438368", "bodyText": "yes, now each partition/chuck codes only need to process its own resouretype - one and only one resource type.", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:05:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQxODU0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQyMTUyMQ==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430421521", "bodyText": "this seems like a good thing to have a log.fine", "author": "prb112", "createdAt": "2020-05-26T13:42:44Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/bulkexport/system/ExportJobListener.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.bulkexport.system;\n+\n+import java.text.DecimalFormat;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import java.util.logging.Logger;\n+\n+import javax.batch.api.BatchProperty;\n+import javax.batch.api.listener.JobListener;\n+import javax.batch.operations.JobOperator;\n+import javax.batch.runtime.BatchRuntime;\n+import javax.batch.runtime.JobExecution;\n+import javax.batch.runtime.context.JobContext;\n+import javax.enterprise.context.Dependent;\n+import javax.inject.Inject;\n+\n+import com.ibm.fhir.bulkcommon.Constants;\n+import com.ibm.fhir.bulkexport.common.CheckPointUserData;\n+\n+@Dependent\n+public class ExportJobListener implements JobListener {\n+    private static final Logger logger = Logger.getLogger(ExportJobListener.class.getName());\n+\n+    long currentExecutionStartTimeInMS;\n+\n+    @Inject\n+    JobContext jobContext;\n+\n+    @Inject\n+    @BatchProperty(name = Constants.IMPORT_FHIR_DATASOURCES)\n+    String dataSourcesInfo;\n+\n+    public ExportJobListener() {\n+        // do nothing\n+    }\n+\n+\n+    @Override\n+    public void afterJob() {\n+        long currentExecutionEndTimeInMS = TimeUnit.NANOSECONDS.toMillis(System.nanoTime());\n+\n+        // Used for generating response for all the import data resources.\n+        @SuppressWarnings(\"unchecked\")\n+        List<CheckPointUserData> partitionSummaries = (List<CheckPointUserData>)jobContext.getTransientUserData();\n+\n+        JobOperator jobOperator = BatchRuntime.getJobOperator();\n+        long totalJobExecutionMilliSeconds = 0;\n+        // The job can be started, stopped and then started again, so we need to add them all to get the whole job execution duration.\n+        for ( JobExecution jobExecution: jobOperator.getJobExecutions(jobOperator.getJobInstance(jobContext.getExecutionId()))) {\n+            // For current execution, jobExecution.getEndTime() is either null or with wrong value because the current execution is not\n+            // finished yet, so always use system time for both job execution start time and end time.\n+            if (jobExecution.getExecutionId()  == jobContext.getExecutionId()) {\n+                totalJobExecutionMilliSeconds += (currentExecutionEndTimeInMS - currentExecutionStartTimeInMS);\n+            } else {\n+                totalJobExecutionMilliSeconds += (jobExecution.getEndTime().getTime() - jobExecution.getStartTime().getTime());\n+            }\n+        }\n+\n+        // If the job is stopped before any partition is finished, then nothing to show.\n+        if (partitionSummaries == null) {\n+            return;\n+        }\n+\n+        double jobProcessingSeconds = totalJobExecutionMilliSeconds / 1000.0;\n+        jobProcessingSeconds = jobProcessingSeconds < 1 ? 1.0 : jobProcessingSeconds;\n+\n+        // log the simple metrics.\n+        logger.info(\" ---- Fhir resources exported in \" + jobProcessingSeconds + \"seconds ----\");\n+        logger.info(\"ResourceType \\t| Exported\");\n+        int totalExportedFhirResources = 0;\n+        List<String> resourceTypeSummaries = new ArrayList<>();\n+        for (CheckPointUserData partitionSummary : partitionSummaries) {\n+            logger.info(partitionSummary.getResourceTypeSummary() + \"\\t|\"\n+                  + partitionSummary.getTotalResourcesNum());\n+            resourceTypeSummaries.add(partitionSummary.getResourceTypeSummary());\n+            totalExportedFhirResources += partitionSummary.getTotalResourcesNum();\n+        }\n+\n+        logger.info(\" ---- Total: \" + totalExportedFhirResources", "originalCommit": "066c797643da029380943400aae495f9296c15da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQzOTI3Mg==", "url": "https://github.com/IBM/FHIR/pull/1116#discussion_r430439272", "bodyText": "this is the summary of the whole export job, so I used info instead of fine.", "author": "albertwang-ibm", "createdAt": "2020-05-26T14:06:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQyMTUyMQ=="}], "type": "inlineReview"}, {"oid": "356ab6a372fe748746c03937f97d61a93a9a5bba", "url": "https://github.com/IBM/FHIR/commit/356ab6a372fe748746c03937f97d61a93a9a5bba", "message": "issue #779 adding fhir-server-config.json and updates per review\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-05-26T14:15:56Z", "type": "commit"}]}