{"pr_number": 1274, "pr_title": "issue #1242 add minio to pipeline", "pr_createdAt": "2020-06-23T16:59:41Z", "pr_url": "https://github.com/IBM/FHIR/pull/1274", "timeline": [{"oid": "a454e8c127645e65011d6eb1e462339312bf6b90", "url": "https://github.com/IBM/FHIR/commit/a454e8c127645e65011d6eb1e462339312bf6b90", "message": "issue #1242 initial code drop\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-23T16:58:24Z", "type": "commit"}, {"oid": "c0043213e272598b6a010833b48daa37eaa2fcb2", "url": "https://github.com/IBM/FHIR/commit/c0043213e272598b6a010833b48daa37eaa2fcb2", "message": "issue #1242 add cert directory with -p\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-23T17:31:50Z", "type": "commit"}, {"oid": "dfac8e2251d2ea69b46e13964876e74562087e5b", "url": "https://github.com/IBM/FHIR/commit/dfac8e2251d2ea69b46e13964876e74562087e5b", "message": "issue #1242 enable minio export test\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-23T18:07:28Z", "type": "commit"}, {"oid": "9a6f76ebbc57a558600c814191610a4d0de75dc0", "url": "https://github.com/IBM/FHIR/commit/9a6f76ebbc57a558600c814191610a4d0de75dc0", "message": "issue #1242 update fhirtruststore to include minio cert\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-23T19:05:07Z", "type": "commit"}, {"oid": "427f503994023cffafe211398a89eeee8fe80149", "url": "https://github.com/IBM/FHIR/commit/427f503994023cffafe211398a89eeee8fe80149", "message": "issue #1242 update minio docker composer\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-24T00:35:48Z", "type": "commit"}, {"oid": "345c6ff8ca9ac56bf2b087d459fdde5bf6dbb448", "url": "https://github.com/IBM/FHIR/commit/345c6ff8ca9ac56bf2b087d459fdde5bf6dbb448", "message": "issue #1242 enable minio bulkdata export tests for db2 only\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-24T02:27:24Z", "type": "commit"}, {"oid": "4eeab7ce8347b296783b1e22b01f2d66ea0ae29d", "url": "https://github.com/IBM/FHIR/commit/4eeab7ce8347b296783b1e22b01f2d66ea0ae29d", "message": "issue #1242 disable bulkdata export tests by default\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-24T02:28:25Z", "type": "commit"}, {"oid": "8f7439aaaf3897d8bb4429afc3a6498503a7a9cd", "url": "https://github.com/IBM/FHIR/commit/8f7439aaaf3897d8bb4429afc3a6498503a7a9cd", "message": "issue #1242 use fhirserver key/cert for minio\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-24T18:22:34Z", "type": "commit"}, {"oid": "bdc6f4a5874bacced9a0bdb3181838871eb86f35", "url": "https://github.com/IBM/FHIR/commit/bdc6f4a5874bacced9a0bdb3181838871eb86f35", "message": "issue #1242 per tenant truststore config and bulkdata tests enhancement\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-25T00:28:04Z", "type": "commit"}, {"oid": "0c621581f7de03e14f9451f5c759fdd693e14256", "url": "https://github.com/IBM/FHIR/commit/0c621581f7de03e14f9451f5c759fdd693e14256", "message": "issue #1242 fix test minio bucket dir\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-25T01:19:44Z", "type": "commit"}, {"oid": "df04fbdbbc5a9cf23df00f7a40398d6efc3c7517", "url": "https://github.com/IBM/FHIR/commit/df04fbdbbc5a9cf23df00f7a40398d6efc3c7517", "message": "issue #1242 minor updates\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-25T02:10:45Z", "type": "commit"}, {"oid": "c5eef0f533745cd4d53b81c9846c5ce56772159a", "url": "https://github.com/IBM/FHIR/commit/c5eef0f533745cd4d53b81c9846c5ce56772159a", "message": "issue #1242 update compose dependency\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-25T02:54:54Z", "type": "commit"}, {"oid": "459bd2519734a9b9adaae9e790f379cf06fdb886", "url": "https://github.com/IBM/FHIR/commit/459bd2519734a9b9adaae9e790f379cf06fdb886", "message": "issue #1242 change minio hostname in test server config\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-25T03:06:42Z", "type": "commit"}, {"oid": "932109348dc32785f5d0d822ee9cd8ee31057d2b", "url": "https://github.com/IBM/FHIR/commit/932109348dc32785f5d0d822ee9cd8ee31057d2b", "message": "issue #1242 change ports of minio\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-25T10:50:19Z", "type": "commit"}, {"oid": "148c6356f58e425858b17a102c14bc7d69cff4d6", "url": "https://github.com/IBM/FHIR/commit/148c6356f58e425858b17a102c14bc7d69cff4d6", "message": "issue #1242 update minio port in server config\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-25T11:25:33Z", "type": "commit"}, {"oid": "dc229b2cb9da978a7a7491549be3f2ee42917a7f", "url": "https://github.com/IBM/FHIR/commit/dc229b2cb9da978a7a7491549be3f2ee42917a7f", "message": "issue #1242 new key/cert for ibmfhirminio\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-25T13:19:16Z", "type": "commit"}, {"oid": "77c66aac3315503d3ed52e6c13e5ea5df9d11bc2", "url": "https://github.com/IBM/FHIR/commit/77c66aac3315503d3ed52e6c13e5ea5df9d11bc2", "message": "issue #1242 rename minio service to ibmfhirminio\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-25T13:41:11Z", "type": "commit"}, {"oid": "877060acda9ad3f446ef3ec397a0ae9f56fab2c4", "url": "https://github.com/IBM/FHIR/commit/877060acda9ad3f446ef3ec397a0ae9f56fab2c4", "message": "issue #1242 change minio pull service name to ibmfhirminio\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-25T13:59:04Z", "type": "commit"}, {"oid": "3856577e83d74df68a162ed69de56ddc3b7fe978", "url": "https://github.com/IBM/FHIR/commit/3856577e83d74df68a162ed69de56ddc3b7fe978", "message": "issue #1242 change minio data dir\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-25T15:55:56Z", "type": "commit"}, {"oid": "018dbeb22e0902db36fade5c82bdd80e16b79dd6", "url": "https://github.com/IBM/FHIR/commit/018dbeb22e0902db36fade5c82bdd80e16b79dd6", "message": "issue #1242 change minio data dir to under minio\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-25T17:34:13Z", "type": "commit"}, {"oid": "ac0de8af16008c186abcab64ec6d13da7d9ed56b", "url": "https://github.com/IBM/FHIR/commit/ac0de8af16008c186abcab64ec6d13da7d9ed56b", "message": "Merge pull request #1285 from IBM/master\n\nsync with master", "committedDate": "2020-06-25T18:03:03Z", "type": "commit"}, {"oid": "757a2de3ba524c8e82685c2195977cf57d10f9cd", "url": "https://github.com/IBM/FHIR/commit/757a2de3ba524c8e82685c2195977cf57d10f9cd", "message": "issue #1242 update integration tests with download link check\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-25T19:31:16Z", "type": "commit"}, {"oid": "104ad3248053cc86526a31427e677f2b55055034", "url": "https://github.com/IBM/FHIR/commit/104ad3248053cc86526a31427e677f2b55055034", "message": "issue #1242 fix service dependency\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-25T23:26:09Z", "type": "commit"}, {"oid": "d0e02a910f4978da40ef2e52f5d36a3014ccb871", "url": "https://github.com/IBM/FHIR/commit/d0e02a910f4978da40ef2e52f5d36a3014ccb871", "message": "issue #1242 replace tab with space and reorg import\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-26T11:45:24Z", "type": "commit"}, {"oid": "98a381f9d4ca4c443b660b5cdcbac0739445e3b9", "url": "https://github.com/IBM/FHIR/commit/98a381f9d4ca4c443b660b5cdcbac0739445e3b9", "message": "issue #1242 update IBMCOS SDK to 2.6.2\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-26T11:56:15Z", "type": "commit"}, {"oid": "a2088bc8b6bb3d5527406d5eb5b52e3dd513da7c", "url": "https://github.com/IBM/FHIR/commit/a2088bc8b6bb3d5527406d5eb5b52e3dd513da7c", "message": "issue #1242 map miniohostname to localhost to allow build machine access\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-26T13:32:36Z", "type": "commit"}, {"oid": "01cd70bac22b23d63e1e1c0534c6fab547411593", "url": "https://github.com/IBM/FHIR/commit/01cd70bac22b23d63e1e1c0534c6fab547411593", "message": "issue #1242 update user guide for the new COS truststore config\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-26T14:14:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1MTYwMA==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446251600", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # Indicate that we expect to connect to the minio service on port 8443\n          \n          \n            \n            # Indicate that we expect to connect to the minio service on port 9000", "author": "prb112", "createdAt": "2020-06-26T15:24:56Z", "path": "build/docker/minio/Dockerfile", "diffHunk": "@@ -0,0 +1,15 @@\n+# ----------------------------------------------------------------------------\n+# (C) Copyright IBM Corp. 2019, 2020\n+#\n+# SPDX-License-Identifier: Apache-2.0\n+# ----------------------------------------------------------------------------\n+\n+FROM minio/minio\n+\n+# Indicate that we expect to connect to the minio service on port 8443", "originalCommit": "01cd70bac22b23d63e1e1c0534c6fab547411593", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1NzQzNQ==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446257435", "bodyText": "good catch, forgot to change this accordingly", "author": "albertwang-ibm", "createdAt": "2020-06-26T15:34:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1MTYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1NDc3MA==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446254770", "bodyText": "Shouldn't we remove the test data in /fhir-server-test/src/test/resources/testdata/import-operation/test-import.ndjson ? or copy from there to here.  Then there will be one place to update.", "author": "prb112", "createdAt": "2020-06-26T15:30:19Z", "path": "build/docker/minio/test-import.ndjson", "diffHunk": "@@ -0,0 +1,3 @@\n+{\"resourceType\":\"Patient\",\"id\":\"72b0d93c-93d0-43d9-94a8-d5154ce07152\",\"meta\":{\"versionId\":\"1\",\"lastUpdated\":\"2020-04-17T00:09:36.910431Z\"},\"name\":[{\"family\":\"Doe\",\"given\":[\"import-1\"]}],\"telecom\":[{\"system\":\"phone\",\"value\":\"555-1122\",\"use\":\"home\"}],\"birthDate\":\"1970-01-01\"}\n+{\"resourceType\":\"Patient\",\"id\":\"72b0d93c-93d0-43d9-94a8-d5154ce07153\",\"meta\":{\"versionId\":\"1\",\"lastUpdated\":\"2020-04-17T00:09:36.910431Z\"},\"name\":[{\"family\":\"Doe\",\"given\":[\"import-2\"]}],\"telecom\":[{\"system\":\"phone\",\"value\":\"555-1122\",\"use\":\"home\"}],\"birthDate\":\"1970-01-01\"}\n+{\"resourceType\":\"Patient\",\"id\":\"72b0d93c-93d0-43d9-94a8-d5154ce07154\",\"meta\":{\"versionId\":\"1\",\"lastUpdated\":\"2020-04-17T00:09:36.910431Z\"},\"name\":[{\"family\":\"Doe\",\"given\":[\"import-3\"]}],\"telecom\":[{\"system\":\"phone\",\"value\":\"555-1122\",\"use\":\"home\"}],\"birthDate\":\"1970-01-01\"}", "originalCommit": "01cd70bac22b23d63e1e1c0534c6fab547411593", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1NzIyMg==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446257222", "bodyText": "ha, good point. I can reuse it!", "author": "albertwang-ibm", "createdAt": "2020-06-26T15:34:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1NDc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1ODM0OA==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446258348", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |`fhirServer/bulkdata/isCosClientUseFhirServerTrustStore`|boolean| If use fhir server TrustStore to access S3/IBMCOS service |\n          \n          \n            \n            |`fhirServer/bulkdata/isCosClientUseFhirServerTrustStore`|boolean| If the COS Client should use the IBM FHIR Server's TrustStore to access S3/IBMCOS service |\n          \n      \n    \n    \n  \n\nSeparately, this property is pretty long, it might be best to summarize it to a short property and easier to understand.\nisCosClientUseFhirServerTrustStore\n->\nuseDefaultTrustStore", "author": "prb112", "createdAt": "2020-06-26T15:36:34Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1489,6 +1489,7 @@ This section contains reference information about each of the configuration prop\n |`fhirServer/bulkdata/cosFileMaxResources`|int|The maximum number of FHIR resources per COS file, \"-1\" means no limit, the default value is 500000 |\n |`fhirServer/bulkdata/cosFileMaxSize`|int|The maximum COS file size in bytes, \"-1\" means no limit, the default value is 209715200 (200M) |\n |`fhirServer/bulkdata/patientExportPageSize`|int| The search page size for patient/group export, the default value is 200 |\n+|`fhirServer/bulkdata/isCosClientUseFhirServerTrustStore`|boolean| If use fhir server TrustStore to access S3/IBMCOS service |", "originalCommit": "01cd70bac22b23d63e1e1c0534c6fab547411593", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1OTgxNw==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446259817", "bodyText": "make sense, let  me change it together with the doc.", "author": "albertwang-ibm", "createdAt": "2020-06-26T15:39:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1ODM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1ODQ1OA==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446258458", "bodyText": "Different name? useDefaultTrustStore", "author": "prb112", "createdAt": "2020-06-26T15:36:44Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1538,6 +1539,7 @@ This section contains reference information about each of the configuration prop\n |`fhirServer/bulkdata/cosFileMaxResources`|500000|\n |`fhirServer/bulkdata/cosFileMaxSize`|209715200|\n |`fhirServer/bulkdata/patientExportPageSize`|200|\n+|`fhirServer/bulkdata/isCosClientUseFhirServerTrustStore`|false|", "originalCommit": "01cd70bac22b23d63e1e1c0534c6fab547411593", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1ODQ5Ng==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446258496", "bodyText": "Different name? useDefaultTrustStore", "author": "prb112", "createdAt": "2020-06-26T15:36:49Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1605,6 +1607,7 @@ must restart the server for that change to take effect.\n |`fhirServer/bulkdata/cosFileMaxResources`|Y|Y|\n |`fhirServer/bulkdata/cosFileMaxSize`|Y|Y|\n |`fhirServer/bulkdata/patientExportPageSize`|Y|Y|\n+|`fhirServer/bulkdata/isCosClientUseFhirServerTrustStore`|Y|Y|", "originalCommit": "01cd70bac22b23d63e1e1c0534c6fab547411593", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1OTMzNQ==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446259335", "bodyText": "maybe pull directly from ${WORKSPACE}/fhir-server-test/src/test/resources/testdata/import-operation/test-import.ndjson", "author": "prb112", "createdAt": "2020-06-26T15:38:26Z", "path": "build/pre-integration-test-docker.sh", "diffHunk": "@@ -36,6 +42,14 @@ echo \"Deploying the Db2 schema...\"\n # Note: this adds the tenant key to the server config file so make sure thats set up first\n ./deploySchemaAndTenant.sh\n \n+mkdir -p minio/miniodata/fhirbulkdata\n+cp ./minio/test-import.ndjson ./minio/miniodata/fhirbulkdata", "originalCommit": "01cd70bac22b23d63e1e1c0534c6fab547411593", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2MDA0NA==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446260044", "bodyText": "isUse is hard to read\nI suggest just using use\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        String cosEndpointUrl, String cosLocation, boolean isUseFhirServerTrustStore) {\n          \n          \n            \n                        String cosEndpointUrl, String cosLocation, boolean useFhirServerTrustStore) {", "author": "prb112", "createdAt": "2020-06-26T15:39:42Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/jbatch/bulkdata/common/BulkDataUtils.java", "diffHunk": "@@ -107,7 +110,7 @@ public static String startPartUpload(AmazonS3 cosClient, String bucketName, Stri\n     }\n \n     public static AmazonS3 getCosClient(String cosCredentialIbm, String cosApiKeyProperty, String cosSrvinstId,\n-            String cosEndpointUrl, String cosLocation) {\n+            String cosEndpointUrl, String cosLocation, boolean isUseFhirServerTrustStore) {", "originalCommit": "01cd70bac22b23d63e1e1c0534c6fab547411593", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2MDI0NA==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446260244", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (isUseFhirServerTrustStore) {\n          \n          \n            \n                    if (useFhirServerTrustStore) {", "author": "prb112", "createdAt": "2020-06-26T15:40:02Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/jbatch/bulkdata/common/BulkDataUtils.java", "diffHunk": "@@ -121,6 +124,14 @@ public static AmazonS3 getCosClient(String cosCredentialIbm, String cosApiKeyPro\n                 .withTcpKeepAlive(true)\n                 .withSocketTimeout(Constants.COS_SOCKET_TIMEOUT);\n \n+        if (isUseFhirServerTrustStore) {", "originalCommit": "01cd70bac22b23d63e1e1c0534c6fab547411593", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2MDg1NA==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446260854", "bodyText": "this variable is hard to read.\nuseFhirServerTrustStore and update the FHIRConfiguration", "author": "prb112", "createdAt": "2020-06-26T15:41:09Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/jbatch/bulkdata/export/system/ChunkWriter.java", "diffHunk": "@@ -209,6 +199,17 @@ public void writeItems(List<java.lang.Object> arg0) throws Exception {\n     @Override\n     public void open(Serializable checkpoint) throws Exception  {\n         isExportPublic = FHIRConfigHelper.getBooleanProperty(FHIRConfiguration.PROPERTY_BULKDATA_BATCHJOB_ISEXPORTPUBLIC, true);\n-\n+        boolean isCosClientUseFhirServerTrustStore = FHIRConfigHelper\n+            .getBooleanProperty(FHIRConfiguration.PROPERTY_BULKDATA_BATCHJOB_ISCOSCLIENTUSEFHIRSERVERTRUSTSTORE, false);", "originalCommit": "01cd70bac22b23d63e1e1c0534c6fab547411593", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2MTk1NQ==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446261955", "bodyText": "consistent with my other comment, it's hard to read", "author": "prb112", "createdAt": "2020-06-26T15:43:03Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/jbatch/bulkdata/load/ChunkReader.java", "diffHunk": "@@ -156,7 +173,23 @@ public Object readItem() throws Exception {\n     public void open(Serializable checkpoint) throws Exception {\n         if (BulkImportDataSourceStorageType.from(dataSourceStorageType).equals(BulkImportDataSourceStorageType.AWSS3)\n                 || BulkImportDataSourceStorageType.from(dataSourceStorageType).equals(BulkImportDataSourceStorageType.IBMCOS)) {\n-            cosClient = BulkDataUtils.getCosClient(cosCredentialIbm, cosApiKeyProperty, cosSrvinstId, cosEndpointUrl, cosLocation);\n+\n+            if (fhirTenant == null) {\n+                fhirTenant = \"default\";\n+                logger.info(\"open: Set tenant to default!\");\n+            }\n+            if (fhirDatastoreId == null) {\n+                fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+                logger.info(\"open: Set DatastoreId to default!\");\n+            }\n+\n+            FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+            boolean isCosClientUseFhirServerTrustStore = FHIRConfigHelper\n+                .getBooleanProperty(FHIRConfiguration.PROPERTY_BULKDATA_BATCHJOB_ISCOSCLIENTUSEFHIRSERVERTRUSTSTORE, false);", "originalCommit": "01cd70bac22b23d63e1e1c0534c6fab547411593", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2MjYyNQ==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446262625", "bodyText": "this is fixed, or configurable?", "author": "prb112", "createdAt": "2020-06-26T15:44:21Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/jbatch/bulkdata/load/ChunkWriter.java", "diffHunk": "@@ -286,4 +263,33 @@ private void pushImportOperationOutcomes2COS(ImportTransientUserData chunkData)\n             chunkData.getBufferStreamForImportError().reset();\n         }\n     }\n+    \n+    @Override\n+    public void open(Serializable checkpoint) throws Exception {\n+        if (fhirValidation != null) {\n+            isValidationOn = fhirValidation.equalsIgnoreCase(\"Y\");", "originalCommit": "01cd70bac22b23d63e1e1c0534c6fab547411593", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2NTkyNQ==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446265925", "bodyText": "this is configurable through job parameter, if without setting in job parameter, then the default value false is used at present.\nI don't think we need to add it to the job parameter of the job operation, I think we can simply change the default value to true directly if need instead of adding a new config.", "author": "albertwang-ibm", "createdAt": "2020-06-26T15:50:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2MjYyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2NTUzOA==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446265538", "bodyText": "hard to consume the constant name.   use/is - select one\nisCosClientUseFhirServerTrustStore should be simplified", "author": "prb112", "createdAt": "2020-06-26T15:49:32Z", "path": "fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java", "diffHunk": "@@ -96,6 +96,8 @@\n     public static final String PROPERTY_BULKDATA_BATCHJOB_BATCHTRUSTSTORE = \"fhirServer/bulkdata/batch-truststore\";\n     public static final String PROPERTY_BULKDATA_BATCHJOB_BATCHTRUSTSTOREPWD = \"fhirServer/bulkdata/batch-truststore-password\";\n     public static final String PROPERTY_BULKDATA_BATCHJOB_ISEXPORTPUBLIC = \"fhirServer/bulkdata/isExportPublic\";\n+    public static final String PROPERTY_BULKDATA_BATCHJOB_ISCOSCLIENTUSEFHIRSERVERTRUSTSTORE = \"fhirServer/bulkdata/isCosClientUseFhirServerTrustStore\";", "originalCommit": "01cd70bac22b23d63e1e1c0534c6fab547411593", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2NjI2Mg==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446266262", "bodyText": "will change them all to useFhirServerTrustStore :)", "author": "albertwang-ibm", "createdAt": "2020-06-26T15:50:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2NTUzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2NzkxMw==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446267913", "bodyText": "Why do you have to specify the tenantName/DatastoreId?", "author": "prb112", "createdAt": "2020-06-26T15:53:47Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/bulkdata/ExportOperationTest.java", "diffHunk": "@@ -55,19 +56,29 @@\n     public static final String BASE_VALID_URL = \"/$export\";\n     public static final String BASE_VALID_STATUS_URL = \"/$bulkdata-status\";\n     public static final String FORMAT = \"application/fhir+ndjson\";\n+    private final String tenantName = \"default\";\n+    private final String dataStoreId = \"default\";", "originalCommit": "01cd70bac22b23d63e1e1c0534c6fab547411593", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI3MTQ0Ng==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446271446", "bodyText": "this is used for my local tests to make sure the per tenant configures for bulkdata working correctly.  example, I used \"default\" + \"default\", \"postgresql\" + \"default\" etc in my tests.", "author": "albertwang-ibm", "createdAt": "2020-06-26T15:59:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2NzkxMw=="}], "type": "inlineReview"}, {"oid": "6d346a86c8195acb50533c17172916071d97b9cc", "url": "https://github.com/IBM/FHIR/commit/6d346a86c8195acb50533c17172916071d97b9cc", "message": "issue #1242 updates per review comments\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-26T16:07:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyMTI3NQ==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446321275", "bodyText": "I think I'd rather see this default to true.  I think its much simpler to have a single trustStore used by the whole server.  Then we should make sure our sample configs don't have trustStore settings sprinkled all over.", "author": "lmsurpre", "createdAt": "2020-06-26T17:38:57Z", "path": "docs/src/pages/guides/FHIRServerUsersGuide.md", "diffHunk": "@@ -1538,6 +1539,7 @@ This section contains reference information about each of the configuration prop\n |`fhirServer/bulkdata/cosFileMaxResources`|500000|\n |`fhirServer/bulkdata/cosFileMaxSize`|209715200|\n |`fhirServer/bulkdata/patientExportPageSize`|200|\n+|`fhirServer/bulkdata/useFhirServerTrustStore`|false|", "originalCommit": "6d346a86c8195acb50533c17172916071d97b9cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MDU3OA==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446580578", "bodyText": "we can not, set to true will fail S3/IBM COS. because there is no public CAs in our truststore.", "author": "albertwang-ibm", "createdAt": "2020-06-27T23:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyMTI3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyMTg3Mw==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446321873", "bodyText": "how were we passing these before?  does adding them here fix an issue we had?", "author": "lmsurpre", "createdAt": "2020-06-26T17:40:10Z", "path": "fhir-bulkimportexport-webapp/src/main/java/META-INF/batch-jobs/FhirBulkImportChunkJob.xml", "diffHunk": "@@ -14,6 +14,8 @@\n         <chunk checkpoint-policy=\"item\" item-count=\"#{jobProperties['fhir.cosreadsperdbbatch']}\">\n             <reader ref=\"com.ibm.fhir.jbatch.bulkdata.load.ChunkReader\">\n                 <properties>\n+                    <property name=\"fhir.tenant\" value=\"#{jobParameters['fhir.tenant']}\"/>\n+                    <property name=\"fhir.datastoreid\" value=\"#{jobParameters['fhir.datastoreid']}\"/>", "originalCommit": "6d346a86c8195acb50533c17172916071d97b9cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MDY1MQ==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446580651", "bodyText": "this is for supporting the new per tenant config, not needed before.", "author": "albertwang-ibm", "createdAt": "2020-06-27T23:58:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyMTg3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyMjMxNA==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446322314", "bodyText": "I'd prefer to make the default true", "author": "lmsurpre", "createdAt": "2020-06-26T17:41:11Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/jbatch/bulkdata/export/system/ChunkWriter.java", "diffHunk": "@@ -209,6 +199,17 @@ public void writeItems(List<java.lang.Object> arg0) throws Exception {\n     @Override\n     public void open(Serializable checkpoint) throws Exception  {\n         isExportPublic = FHIRConfigHelper.getBooleanProperty(FHIRConfiguration.PROPERTY_BULKDATA_BATCHJOB_ISEXPORTPUBLIC, true);\n-\n+        boolean isCosClientUseFhirServerTrustStore = FHIRConfigHelper\n+            .getBooleanProperty(FHIRConfiguration.PROPERTY_BULKDATA_BATCHJOB_USEFHIRSERVERTRUSTSTORE, false);", "originalCommit": "6d346a86c8195acb50533c17172916071d97b9cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MDY2OQ==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446580669", "bodyText": "as mentioned above, we can not.", "author": "albertwang-ibm", "createdAt": "2020-06-27T23:58:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyMjMxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyMjcyNw==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446322727", "bodyText": "I'd prefer to make the default true", "author": "lmsurpre", "createdAt": "2020-06-26T17:41:53Z", "path": "fhir-bulkimportexport-webapp/src/main/java/com/ibm/fhir/jbatch/bulkdata/load/ChunkWriter.java", "diffHunk": "@@ -286,4 +263,33 @@ private void pushImportOperationOutcomes2COS(ImportTransientUserData chunkData)\n             chunkData.getBufferStreamForImportError().reset();\n         }\n     }\n+    \n+    @Override\n+    public void open(Serializable checkpoint) throws Exception {\n+        if (fhirValidation != null) {\n+            isValidationOn = fhirValidation.equalsIgnoreCase(\"Y\");\n+        }\n+        if (fhirTenant == null) {\n+            fhirTenant = \"default\";\n+            logger.info(\"open: Set tenant to default!\");\n+        }\n+        if (fhirDatastoreId == null) {\n+            fhirDatastoreId = Constants.DEFAULT_FHIR_TENANT;\n+            logger.info(\"open: Set DatastoreId to default!\");\n+        }\n+\n+        FHIRRequestContext.set(new FHIRRequestContext(fhirTenant, fhirDatastoreId));\n+        boolean isCosClientUseFhirServerTrustStore = FHIRConfigHelper\n+            .getBooleanProperty(FHIRConfiguration.PROPERTY_BULKDATA_BATCHJOB_USEFHIRSERVERTRUSTSTORE, false);", "originalCommit": "6d346a86c8195acb50533c17172916071d97b9cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MDczOQ==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446580739", "bodyText": "as mentioned above, this will break S3 and IBM COS services which use public CAs instead of self signed certs.", "author": "albertwang-ibm", "createdAt": "2020-06-27T23:59:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyMjcyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyMzk5MA==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446323990", "bodyText": "I think I'd prefer to make the default true.", "author": "lmsurpre", "createdAt": "2020-06-26T17:44:32Z", "path": "fhir-server/liberty-config/config/default/fhir-server-config.json", "diffHunk": "@@ -145,7 +145,8 @@\n             \"isExportPublic\": true,\n             \"cosFileMaxResources\": 500000,\n             \"cosFileMaxSize\": 209715200,\n-            \"validBaseUrls\": []\n+            \"validBaseUrls\": [],\n+            \"useFhirServerTrustStore\": false", "originalCommit": "6d346a86c8195acb50533c17172916071d97b9cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MDc0NA==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446580744", "bodyText": "same", "author": "albertwang-ibm", "createdAt": "2020-06-27T23:59:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyMzk5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyNjY4NQ==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446326685", "bodyText": "why client2 ?", "author": "lmsurpre", "createdAt": "2020-06-26T17:50:15Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/bulkdata/ExportOperationTest.java", "diffHunk": "@@ -153,7 +167,53 @@ public WebTarget addQueryParameter(WebTarget target, String header, String val)\n     public Response doGet(String path, String mimeType) {\n         WebTarget target = getWebTarget();\n         target = target.path(path);\n-        return target.request(mimeType).get(Response.class);\n+        return target.request(mimeType)\n+                .header(\"X-FHIR-TENANT-ID\", tenantName)\n+                .header(\"X-FHIR-DSID\", dataStoreId)\n+                .get(Response.class);\n+    }\n+    \n+    private void verifyDownloadUrl(String downloadUrl) {\n+        // Minio doesn't support file level ACL using which we make can make the published file public, so we have to \n+        // get the token first, and then use the token to download the file. \n+        if (isUseMinio) {\n+            downloadUrl = downloadUrl.substring(8);\n+            String minioHost = downloadUrl.substring(0, downloadUrl.indexOf(\"/\"));\n+            String minioFilePath = downloadUrl.substring(minioHost.length());\n+            \n+            // If using minio in build pipeline, then we have to change the host name to \"localhost\" to all the\n+            // build machine to access the minio server via it.\n+            if (isUseMinioInBuildPipeline) {\n+                String[] minioHostArray = minioHost.split(\":\");\n+                minioHostArray[0] = \"localhost\";\n+                minioHost = String.join(\":\", minioHostArray);\n+            }\n+            \n+            String minioAuthUrl = \"https://\" + minioHost + \"/minio/webrpc\";\n+            String minioAuthRequestBody = \"{\\\"id\\\":1,\\\"jsonrpc\\\":\\\"2.0\\\",\\\"params\\\":{\\\"username\\\":\\\"\" \n+                + minioUserName  + \"\\\",\\\"password\\\":\\\"\" + minioPassword + \"\\\"},\\\"method\\\":\\\"Web.Login\\\"}\";\n+            \n+            WebTarget client2 = ClientBuilder.newBuilder().trustStore(client.getTrustStore()).build().target(minioAuthUrl);", "originalCommit": "6d346a86c8195acb50533c17172916071d97b9cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MDgwNQ==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446580805", "bodyText": "the default test client", "author": "albertwang-ibm", "createdAt": "2020-06-28T00:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyNjY4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyNzYwMg==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446327602", "bodyText": "this would be a good limitation for us to document if we ever advertise our support for Minio", "author": "lmsurpre", "createdAt": "2020-06-26T17:52:15Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/bulkdata/ExportOperationTest.java", "diffHunk": "@@ -153,7 +167,53 @@ public WebTarget addQueryParameter(WebTarget target, String header, String val)\n     public Response doGet(String path, String mimeType) {\n         WebTarget target = getWebTarget();\n         target = target.path(path);\n-        return target.request(mimeType).get(Response.class);\n+        return target.request(mimeType)\n+                .header(\"X-FHIR-TENANT-ID\", tenantName)\n+                .header(\"X-FHIR-DSID\", dataStoreId)\n+                .get(Response.class);\n+    }\n+    \n+    private void verifyDownloadUrl(String downloadUrl) {\n+        // Minio doesn't support file level ACL using which we make can make the published file public, so we have to \n+        // get the token first, and then use the token to download the file. ", "originalCommit": "6d346a86c8195acb50533c17172916071d97b9cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4MTcxMw==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446581713", "bodyText": "updated user guide.", "author": "albertwang-ibm", "createdAt": "2020-06-28T00:10:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyNzYwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMyOTQ2OQ==", "url": "https://github.com/IBM/FHIR/pull/1274#discussion_r446329469", "bodyText": "I'm still not sure how I feel about expanding our use of test.properties.  That properties file was originally just the client properties (used to instantiate FHIRClient).  I guess its OK though.", "author": "lmsurpre", "createdAt": "2020-06-26T17:56:08Z", "path": "fhir-server-test/src/test/java/com/ibm/fhir/server/test/bulkdata/ExportOperationTest.java", "diffHunk": "@@ -55,19 +56,29 @@\n     public static final String BASE_VALID_URL = \"/$export\";\n     public static final String BASE_VALID_STATUS_URL = \"/$bulkdata-status\";\n     public static final String FORMAT = \"application/fhir+ndjson\";\n+    private final String tenantName = \"default\";\n+    private final String dataStoreId = \"default\";\n \n     // Disabled by default\n     private static boolean ON = false;\n+    private static boolean isUseMinio = false;\n+    private static boolean isUseMinioInBuildPipeline = false;\n \n     public static final boolean DEBUG = false;\n     private String exportStatusUrl;\n     private String savedPatientId, savedPatientId2;\n     private String savedGroupId, savedGroupId2;\n-\n+    private String minioUserName;\n+    private String minioPassword;\n+  \n     @BeforeClass\n     public void setup() throws Exception {\n         Properties testProperties = TestUtil.readTestProperties(\"test.properties\");\n         ON = Boolean.parseBoolean(testProperties.getProperty(\"test.bulkdata.export.enabled\", \"false\"));\n+        isUseMinio = Boolean.parseBoolean(testProperties.getProperty(\"test.bulkdata.useminio\", \"false\"));", "originalCommit": "6d346a86c8195acb50533c17172916071d97b9cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ab5908940fca2a94127a956531f4546459ceea75", "url": "https://github.com/IBM/FHIR/commit/ab5908940fca2a94127a956531f4546459ceea75", "message": "issue #1242 update user guide about minio support\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-28T00:07:44Z", "type": "commit"}, {"oid": "e60e82c8ea284aa9feec866b40ea2c37067e83f5", "url": "https://github.com/IBM/FHIR/commit/e60e82c8ea284aa9feec866b40ea2c37067e83f5", "message": "issue #1242 user guide minor updates\n\nSigned-off-by: Albert Wang <xuwang@us.ibm.com>", "committedDate": "2020-06-28T00:10:37Z", "type": "commit"}]}