{"pr_number": 7859, "pr_title": "Fix bug in data access token download.", "pr_createdAt": "2020-09-02T20:26:32Z", "pr_url": "https://github.com/cBioPortal/cbioportal/pull/7859", "timeline": [{"oid": "d5d625259d0093cc9414f3ad404625ca49cf223f", "url": "https://github.com/cBioPortal/cbioportal/commit/d5d625259d0093cc9414f3ad404625ca49cf223f", "message": "Fix bug in data access token download.\n\nArgument for 'allowRemovalOfExistingTokens' has been disconnected or\nremoved in some way.\n\nWhen a user attempts to download a token from the\nlogin dropdown menu, if the option to revoke existing tokens was\nenabled then the user would be presented with an error if they had an\nexisting token instead of being issued a brand new one.\n\nWe have decided to simply remove this functionality and always issue a\nnew token on request.\n\nSigned-off-by: Angelica Ochoa <15623749+ao508@users.noreply.github.com>", "committedDate": "2020-09-02T18:50:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgwMjc5Ng==", "url": "https://github.com/cBioPortal/cbioportal/pull/7859#discussion_r482802796", "bodyText": "Now that the oldest token will automatically be deleted to make room for a new token to be issued, this test case no longer will generate the expected MaxNumberTokensExceededException. The next test has the test for the expected behavior (that the oldest token (OLDEST_TOKEN_UUID) gets deleted from the database. From now on, that will always happen when the user is at their quota limit, so this test can be dropped.", "author": "sheridancbio", "createdAt": "2020-09-03T08:31:06Z", "path": "service/src/test/java/org/cbioportal/service/impl/UuidDataAccessTokenServiceImplTest.java", "diffHunk": "@@ -101,7 +100,7 @@\n      */\n     @Test(expected = MaxNumberTokensExceededException.class)\n     public void testNonAutoExpireCreateTokenWhenLimitReached() {\n-        DataAccessToken newDataAccessToken = uuidDataAccessTokenServiceImpl.createDataAccessToken(UuidDataAccessTokenServiceImplTestConfiguration.MOCK_USERNAME_WITH_ONE_TOKEN, false);\n+        DataAccessToken newDataAccessToken = uuidDataAccessTokenServiceImpl.createDataAccessToken(UuidDataAccessTokenServiceImplTestConfiguration.MOCK_USERNAME_WITH_ONE_TOKEN);", "originalCommit": "d5d625259d0093cc9414f3ad404625ca49cf223f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgwNDE4Mg==", "url": "https://github.com/cBioPortal/cbioportal/pull/7859#discussion_r482804182", "bodyText": "same as prior comment. This test is no longer needed because MaxNumberTokensExceededException can no longer be generated. The user will always successfully receive a token .. even if it means that a previously issued and still valid token needs to be deleted to accomplish it.", "author": "sheridancbio", "createdAt": "2020-09-03T08:33:30Z", "path": "service/src/test/java/org/cbioportal/service/impl/UuidDataAccessTokenServiceImplTestFiveTokenLimit.java", "diffHunk": "@@ -101,7 +100,7 @@\n      */\n     @Test(expected = MaxNumberTokensExceededException.class)\n     public void testNonAutoExpireCreateTokenWhenLimitReached() {\n-        DataAccessToken newDataAccessToken = uuidDataAccessTokenServiceImpl.createDataAccessToken(UuidDataAccessTokenServiceImplTestConfiguration.MOCK_USERNAME_WITH_FIVE_TOKENS, false);\n+        DataAccessToken newDataAccessToken = uuidDataAccessTokenServiceImpl.createDataAccessToken(UuidDataAccessTokenServiceImplTestConfiguration.MOCK_USERNAME_WITH_FIVE_TOKENS);", "originalCommit": "d5d625259d0093cc9414f3ad404625ca49cf223f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgyNTc2NQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/7859#discussion_r482825765", "bodyText": "This function no longer serves any purpose. I suggest we drop this function and replace calls to it with a call to tokenService.createDataAccessToken(userName) instead.", "author": "sheridancbio", "createdAt": "2020-09-03T09:08:00Z", "path": "web/src/main/java/org/cbioportal/web/DataAccessTokenController.java", "diffHunk": "@@ -129,13 +125,8 @@ private String getAuthenticatedUser(Authentication authentication) {\n         return username;\n     }\n \n-    private DataAccessToken createDataAccessToken(String userName, Boolean myAllowRevocationOfOtherTokens) {\n-        DataAccessToken token;\n-        if (myAllowRevocationOfOtherTokens != null) {\n-            token = tokenService.createDataAccessToken(userName, myAllowRevocationOfOtherTokens);\n-        }  else {\n-            token = tokenService.createDataAccessToken(userName);\n-        }\n+    private DataAccessToken createDataAccessToken(String userName) {", "originalCommit": "d5d625259d0093cc9414f3ad404625ca49cf223f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d44d4cc76bec9475f12cf02a1942cdd5399951ff", "url": "https://github.com/cBioPortal/cbioportal/commit/d44d4cc76bec9475f12cf02a1942cdd5399951ff", "message": "Removed unused Max Token exeption and test cases no longer needed\n\nSigned-off-by: Angelica Ochoa <15623749+ao508@users.noreply.github.com>", "committedDate": "2020-09-03T15:50:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE0NzY1OA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7859#discussion_r483147658", "bodyText": "great .. thanks for adding this change", "author": "sheridancbio", "createdAt": "2020-09-03T17:39:02Z", "path": "src/main/resources/portal.properties.EXAMPLE", "diffHunk": "@@ -141,7 +141,6 @@ dat.unauth_users=\n dat.method=none\n dat.ttl_seconds=2592000\n dat.uuid.max_number_per_user=1\n-dat.uuid.revoke_other_tokens=true", "originalCommit": "d44d4cc76bec9475f12cf02a1942cdd5399951ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE0ODIzMA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7859#discussion_r483148230", "bodyText": "nice cleaning this up too", "author": "sheridancbio", "createdAt": "2020-09-03T17:40:04Z", "path": "web/src/main/java/org/cbioportal/web/error/GlobalExceptionHandler.java", "diffHunk": "@@ -151,12 +151,6 @@\n         return new ResponseEntity<>(response, HttpStatus.UNAUTHORIZED);\n     }\n \n-    @ExceptionHandler(MaxNumberTokensExceededException.class)", "originalCommit": "d44d4cc76bec9475f12cf02a1942cdd5399951ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}