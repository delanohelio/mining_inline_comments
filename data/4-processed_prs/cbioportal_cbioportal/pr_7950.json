{"pr_number": 7950, "pr_title": "add integration test to load study_es_0", "pr_createdAt": "2020-10-09T15:57:06Z", "pr_url": "https://github.com/cBioPortal/cbioportal/pull/7950", "timeline": [{"oid": "6c2d5e7f97c17de328c1c4fabb14f172c44f2e79", "url": "https://github.com/cBioPortal/cbioportal/commit/6c2d5e7f97c17de328c1c4fabb14f172c44f2e79", "message": "add integration test to load study_es_0", "committedDate": "2020-10-09T15:58:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY4NjI0Ng==", "url": "https://github.com/cBioPortal/cbioportal/pull/7950#discussion_r503686246", "bodyText": "Should we not replace this with a proper wait cycle that checks ready-state?", "author": "pvannierop", "createdAt": "2020-10-13T06:03:00Z", "path": ".travis.yml", "diffHunk": "@@ -96,4 +97,21 @@ script:\n       # spot visual regression by comparing screenshots in the repo with\n       # screenshots of this portal loaded with the data from the amazon db\n       bash test/end-to-end/test_make_screenshots.sh test/end-to-end/screenshots.yml\n+      docker-compose down\n+  fi\n+- |\n+  if [[ \"${TEST}\" == integration-test-load-study ]]\n+  then\n+      # test for loading study_es_0 on a complete working instance\n+      # download compose and init\n+      git clone https://github.com/cBioPortal/cbioportal-docker-compose.git && \\\n+      cd cbioportal-docker-compose && bash init.sh\n+\n+      # creates cbioportal container with local maven build\n+      docker-compose -f docker-compose.yml -f ../test/integration/docker-compose-localbuild.yml up -d\n+\n+      sleep 60s ", "originalCommit": "66a44da1e7c8b19b53e2eca264edbe8d60aec2c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY4NjQ5MA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7950#discussion_r503686490", "bodyText": "Do relative paths work. At least in v2.4 this gives problems. Or am I mistaken?", "author": "pvannierop", "createdAt": "2020-10-13T06:03:45Z", "path": "test/integration/docker-compose-localbuild.yml", "diffHunk": "@@ -0,0 +1,9 @@\n+version: '3'\n+\n+services:\n+  cbioportal:\n+    command: /bin/sh -c \"java -Xms2g -Xmx4g -Dauthenticate=noauthsessionservice -Dsession.service.url=http://cbioportal_session:5000/api/sessions/my_portal/ -jar webapp-runner.jar -AmaxHttpHeaderSize=16384 -AconnectionTimeout=20000 --enable-compression /app.war\"\n+    volumes:\n+     - ./portalinfo/:/portalinfo/\n+     - ../:/cbioportal\n+     - ../portal/target/cbioportal.war:/app.war", "originalCommit": "66a44da1e7c8b19b53e2eca264edbe8d60aec2c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY4NzcwMw==", "url": "https://github.com/cBioPortal/cbioportal/pull/7950#discussion_r503687703", "bodyText": "I think it would be a good idea to put a remark here on what this extension does. Pointing out that this mounts the current backend in order to test it would for sure help others that come across this code.", "author": "pvannierop", "createdAt": "2020-10-13T06:07:13Z", "path": "test/integration/docker-compose-localbuild.yml", "diffHunk": "@@ -0,0 +1,9 @@\n+version: '3'\n+\n+services:", "originalCommit": "66a44da1e7c8b19b53e2eca264edbe8d60aec2c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY4ODY4Mw==", "url": "https://github.com/cBioPortal/cbioportal/pull/7950#discussion_r503688683", "bodyText": "Now, you only test the route via portaldump, isn't it? I think it is a good idea to also add the study load option that uses the server url (-u option) so that validation is against a live portal, not the dump of the portal. Or is such a test redundant?", "author": "pvannierop", "createdAt": "2020-10-13T06:10:02Z", "path": "test/integration/test_load_study.sh", "diffHunk": "@@ -0,0 +1,26 @@\n+#!/bin/bash\n+\n+# exit when any of these fails\n+set -e\n+\n+run_in_service() {\n+    service=$1\n+    shift\n+    docker-compose -f docker-compose.yml -f ../test/integration/docker-compose-localbuild.yml \\\n+        run --rm \\\n+        \"$service\" bash -c \"$@\"\n+}\n+\n+# load panels\n+run_in_service cbioportal \"cd /cbioportal/core/src/main/scripts/ && perl importGenePanel.pl --data \\\n+                          /cbioportal/core/src/test/scripts/test_data/study_es_0/data_gene_panel_testpanel1.txt\"\n+run_in_service cbioportal \"cd /cbioportal/core/src/main/scripts/ && perl importGenePanel.pl --data \\\n+                          /cbioportal/core/src/test/scripts/test_data/study_es_0/data_gene_panel_testpanel2.txt\"\n+\n+# dump portal info", "originalCommit": "66a44da1e7c8b19b53e2eca264edbe8d60aec2c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bfaa94e2e33f5f3d81924f9a8bc9037b498aea6e", "url": "https://github.com/cBioPortal/cbioportal/commit/bfaa94e2e33f5f3d81924f9a8bc9037b498aea6e", "message": "add integration test to load study_es_0", "committedDate": "2020-10-14T11:23:06Z", "type": "forcePushed"}, {"oid": "40b3d5f94a4fd38def1a2d0283e95bac82fe3679", "url": "https://github.com/cBioPortal/cbioportal/commit/40b3d5f94a4fd38def1a2d0283e95bac82fe3679", "message": "add integration test to load study_es_0", "committedDate": "2020-10-15T15:55:48Z", "type": "commit"}, {"oid": "40b3d5f94a4fd38def1a2d0283e95bac82fe3679", "url": "https://github.com/cBioPortal/cbioportal/commit/40b3d5f94a4fd38def1a2d0283e95bac82fe3679", "message": "add integration test to load study_es_0", "committedDate": "2020-10-15T15:55:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcxMDUwNA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7950#discussion_r506710504", "bodyText": "is there a way to not override the command? Or does one always need to override the entire service?", "author": "inodb", "createdAt": "2020-10-16T20:40:04Z", "path": "test/integration/docker-compose-localbuild.yml", "diffHunk": "@@ -0,0 +1,12 @@\n+# this YAML file overrides settings in the cbioportal-docker-compose YAML\n+# and maps a local maven build to appropriate locations in the container (which is retrieved by image).\n+\n+version: '3'\n+\n+services:\n+  cbioportal:\n+    command: /bin/sh -c \"java -Xms2g -Xmx4g -Dauthenticate=noauthsessionservice -Dsession.service.url=http://cbioportal_session:5000/api/sessions/my_portal/ -jar webapp-runner.jar -AmaxHttpHeaderSize=16384 -AconnectionTimeout=20000 --enable-compression /app.war\"", "originalCommit": "40b3d5f94a4fd38def1a2d0283e95bac82fe3679", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU5MTA2Ng==", "url": "https://github.com/cBioPortal/cbioportal/pull/7950#discussion_r507591066", "bodyText": "Well, the command is overridden since we run the WAR file itself, not the decompressed version. It removes the need for unzipping. The command does not have to be overridden for technical reasons, but I think that running the WAR directly is cleaner since it removes the need for a unzip in the travis.yml file. It is not necessary and may confuse people in the future. Remember that the only reason for running a unzipped version is that this allows to mount custom icons in an instance.", "author": "pvannierop", "createdAt": "2020-10-19T09:09:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcxMDUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU5ODk3Ng==", "url": "https://github.com/cBioPortal/cbioportal/pull/7950#discussion_r507598976", "bodyText": "we run the WAR file to override running the files in the cbioportal image", "author": "SRodenburg", "createdAt": "2020-10-19T09:22:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcxMDUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI3MDQ0NA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7950#discussion_r509270444", "bodyText": "I see makes sense", "author": "inodb", "createdAt": "2020-10-21T13:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcxMDUwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2NzkzOQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/7950#discussion_r509267939", "bodyText": "this looks good to me, but would be nice to reorganize the test files a bit at some point. We have two copies of  study_es_0 I believe (one in frontend, one in here). There's also duplication of commands to load this data, since they exist in frontend localdb e2e tests as well. I guess we could use this script in the localdb e2e tests?", "author": "inodb", "createdAt": "2020-10-21T13:15:40Z", "path": "test/integration/test_load_study.sh", "diffHunk": "@@ -0,0 +1,33 @@\n+#!/bin/bash", "originalCommit": "d82d233da9783f21ecda67acf9df7a9b4497a8b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0Njk2MQ==", "url": "https://github.com/cBioPortal/cbioportal/pull/7950#discussion_r511746961", "bodyText": "@inodb there is no duplication of study_es_0 that I am aware of. E2e-tests of frontend operate on study_es_0 of the backend.\n\nThere's also duplication of commands to load this data, since they exist in frontend localdb e2e tests as well. I guess we could use this script in the localdb e2e tests\n\nIndeed, is one of the things to improve. I save this for when The Hyve has less projects for customers. Feel free to pick up this task if you want to.", "author": "pvannierop", "createdAt": "2020-10-26T06:50:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI2NzkzOQ=="}], "type": "inlineReview"}, {"oid": "40b3d5f94a4fd38def1a2d0283e95bac82fe3679", "url": "https://github.com/cBioPortal/cbioportal/commit/40b3d5f94a4fd38def1a2d0283e95bac82fe3679", "message": "add integration test to load study_es_0", "committedDate": "2020-10-15T15:55:48Z", "type": "forcePushed"}, {"oid": "d53692b6f4e29f8b7d4b30f4e7e44197049d8203", "url": "https://github.com/cBioPortal/cbioportal/commit/d53692b6f4e29f8b7d4b30f4e7e44197049d8203", "message": "Merge branch 'study_validate_integration_test' of https://github.com/TheHyve/cbioportal into study_validate_integration_test", "committedDate": "2020-11-05T11:50:11Z", "type": "commit"}]}