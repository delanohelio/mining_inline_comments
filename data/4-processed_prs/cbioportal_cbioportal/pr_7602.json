{"pr_number": 7602, "pr_title": "Fix error while querying for structural variants", "pr_createdAt": "2020-06-10T13:15:29Z", "pr_url": "https://github.com/cBioPortal/cbioportal/pull/7602", "timeline": [{"oid": "bc84a96a20f18da1864283f5d2b8acca1ba24e32", "url": "https://github.com/cBioPortal/cbioportal/commit/bc84a96a20f18da1864283f5d2b8acca1ba24e32", "message": "Fix error while querying for structural variants", "committedDate": "2020-06-10T14:34:45Z", "type": "commit"}, {"oid": "bc84a96a20f18da1864283f5d2b8acca1ba24e32", "url": "https://github.com/cBioPortal/cbioportal/commit/bc84a96a20f18da1864283f5d2b8acca1ba24e32", "message": "Fix error while querying for structural variants", "committedDate": "2020-06-10T14:34:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc5MTcxNA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7602#discussion_r440791714", "bodyText": "I noticed that UniqueKeyBase implements Serializable, probably don't have to reimplement here.", "author": "n1zea144", "createdAt": "2020-06-16T11:53:36Z", "path": "model/src/main/java/org/cbioportal/model/StructuralVariant.java", "diffHunk": "@@ -29,8 +29,6 @@\n public class StructuralVariant extends UniqueKeyBase implements Serializable{", "originalCommit": "9aa17592475617f2255f8c17ab49168c81dbdf8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc5MjMyNg==", "url": "https://github.com/cBioPortal/cbioportal/pull/7602#discussion_r440792326", "bodyText": "Check for valid entrezGeneIds before reference (should this be done upstream?).", "author": "n1zea144", "createdAt": "2020-06-16T11:54:38Z", "path": "persistence/persistence-mybatis/src/main/resources/org/cbioportal/persistence/mybatis/StructuralVariantMapper.xml", "diffHunk": "@@ -112,15 +110,17 @@\n             <foreach item=\"item\" collection=\"molecularProfileIds\" open=\"(\" separator=\",\" close=\")\">\n                 #{item}\n             </foreach>\n-            AND (structural_variant.SITE1_ENTREZ_GENE_ID in \n-            <foreach item=\"item\" collection=\"entrezGeneIds\" open=\"(\" separator=\",\" close=\")\">\n-                #{item}\n-            </foreach>\n-            OR structural_variant.SITE2_ENTREZ_GENE_ID IN\n-            <foreach item=\"item\" collection=\"entrezGeneIds\" open=\"(\" separator=\",\" close=\")\">\n-                #{item}\n-            </foreach>\n-            )\n+            <if test=\"entrezGeneIds != null and !entrezGeneIds.isEmpty()\">", "originalCommit": "9aa17592475617f2255f8c17ab49168c81dbdf8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyNDE1Mg==", "url": "https://github.com/cBioPortal/cbioportal/pull/7602#discussion_r440824152", "bodyText": "When entrezGeneIds is null it returns for all variants. We need this for patient page where we show all of them", "author": "kalletlak", "createdAt": "2020-06-16T12:51:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc5MjMyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwNTU2Nw==", "url": "https://github.com/cBioPortal/cbioportal/pull/7602#discussion_r440805567", "bodyText": "When a fusion is carried within a mutation record, the protein change contains the SV event.", "author": "n1zea144", "createdAt": "2020-06-16T12:19:22Z", "path": "service/src/main/java/org/cbioportal/service/util/MutationMapperUtils.java", "diffHunk": "@@ -31,7 +47,60 @@\n             structuralVariant.setSite1Position(fusion.getStartPosition().intValue());\n             structuralVariant.setComments(fusion.getKeyword());\n             structuralVariant.setNcbiBuild(fusion.getNcbiBuild());\n+            structuralVariant.setVariantClass(fusion.getMutationType());\n+            structuralVariant.setEventInfo(fusion.getProteinChange());\n+            if (fusion.getProteinChange() != null) {\n+                String proteinChange = fusion.getProteinChange();\n+                // only parse proteinChange when its not Fusion or SV\n+                if (!(proteinChange.equalsIgnoreCase(\"Fusion\") || proteinChange.equalsIgnoreCase(\"SV\"))) {", "originalCommit": "9aa17592475617f2255f8c17ab49168c81dbdf8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg0NzUwNg==", "url": "https://github.com/cBioPortal/cbioportal/pull/7602#discussion_r440847506", "bodyText": "Not sure if it's a SV event but the protein change is SV. Here is an example https://www.cbioportal.org/patient?studyId=nbl_broad_2013&caseId=TARGET-30-PANRRW", "author": "kalletlak", "createdAt": "2020-06-16T13:26:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwNTU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg1OTE0Nw==", "url": "https://github.com/cBioPortal/cbioportal/pull/7602#discussion_r440859147", "bodyText": "I checked, its over here ImportFusionData", "author": "n1zea144", "createdAt": "2020-06-16T13:42:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwNTU2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgxNzU3MA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7602#discussion_r440817570", "bodyText": "Is this when a gene symbol is not found?  Should we note that site2 is not being set here?", "author": "n1zea144", "createdAt": "2020-06-16T12:40:40Z", "path": "service/src/main/java/org/cbioportal/service/util/MutationMapperUtils.java", "diffHunk": "@@ -31,7 +47,60 @@\n             structuralVariant.setSite1Position(fusion.getStartPosition().intValue());\n             structuralVariant.setComments(fusion.getKeyword());\n             structuralVariant.setNcbiBuild(fusion.getNcbiBuild());\n+            structuralVariant.setVariantClass(fusion.getMutationType());\n+            structuralVariant.setEventInfo(fusion.getProteinChange());\n+            if (fusion.getProteinChange() != null) {\n+                String proteinChange = fusion.getProteinChange();\n+                // only parse proteinChange when its not Fusion or SV\n+                if (!(proteinChange.equalsIgnoreCase(\"Fusion\") || proteinChange.equalsIgnoreCase(\"SV\"))) {\n+\n+                    Matcher matcher = r.matcher(proteinChange);\n+                    String site1GeneSymbol = null;\n+                    String site2GeneSymbol = null;\n+                    VariantType variantType = null;\n+\n+                    if (matcher.find()) {\n+                        if (EnumUtils.isValidEnum(VariantType.class, matcher.group(1).toUpperCase())) {\n+                            // if protein change contains only variant type. ex: INTRAGENIC\n+                            variantType = EnumUtils.getEnum(VariantType.class, matcher.group(1).toUpperCase());\n+\n+                        } else if (EnumUtils.isValidEnum(VariantType.class, matcher.group(2).toUpperCase())) {\n+                            // this is in format of <gene>-<variant-type>. ex: TUFT1-intragenic\n+                            site1GeneSymbol = matcher.group(1);\n+                            variantType = EnumUtils.getEnum(VariantType.class, matcher.group(2).toUpperCase());\n+                        } else {\n+                            // this is in format of <gene1>-<gene2>-<optional variant-type>. ex.\n+                            // ZSWIM4-SLC1A6 or ZNF595-TERT fusion\n+                            site1GeneSymbol = matcher.group(1);\n+                            site2GeneSymbol = matcher.group(2);\n+                            if (EnumUtils.isValidEnum(VariantType.class, matcher.group(3).toUpperCase())) {\n+                                variantType = EnumUtils.getEnum(VariantType.class, matcher.group(3).toUpperCase());\n+                            }\n+                        }\n+\n+                        // only set site2Gene if its not null\n+                        if (site2GeneSymbol != null) {\n+                            if (site1GeneSymbol != null && site1GeneSymbol.equalsIgnoreCase(site2GeneSymbol)) {\n+                                structuralVariant.setSite2EntrezGeneId(fusion.getEntrezGeneId());\n+                                structuralVariant.setSite2HugoSymbol(fusion.getGene().getHugoGeneSymbol());\n+                            } else {\n+                                try {\n+                                    Gene site2Gene = geneService.getGene(site2GeneSymbol);\n+                                    if (site2Gene != null) {\n+                                        structuralVariant.setSite2EntrezGeneId(site2Gene.getGeneticEntityId());\n+                                        structuralVariant.setSite2HugoSymbol(site2Gene.getHugoGeneSymbol());\n+                                    }\n+                                } catch (Exception e) {", "originalCommit": "9aa17592475617f2255f8c17ab49168c81dbdf8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg0ODQzMw==", "url": "https://github.com/cBioPortal/cbioportal/pull/7602#discussion_r440848433", "bodyText": "Yes. I'll add a comment here", "author": "kalletlak", "createdAt": "2020-06-16T13:27:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgxNzU3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg3OTUyMA==", "url": "https://github.com/cBioPortal/cbioportal/pull/7602#discussion_r440879520", "bodyText": "This will go away once we move to a more structured SV format.", "author": "n1zea144", "createdAt": "2020-06-16T14:07:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgxNzU3MA=="}], "type": "inlineReview"}, {"oid": "aa185ad0ac946910b5a185f2f67121ee1f6ebc4d", "url": "https://github.com/cBioPortal/cbioportal/commit/aa185ad0ac946910b5a185f2f67121ee1f6ebc4d", "message": "Add logic to parse fusion protein change", "committedDate": "2020-06-16T13:33:39Z", "type": "commit"}, {"oid": "aa185ad0ac946910b5a185f2f67121ee1f6ebc4d", "url": "https://github.com/cBioPortal/cbioportal/commit/aa185ad0ac946910b5a185f2f67121ee1f6ebc4d", "message": "Add logic to parse fusion protein change", "committedDate": "2020-06-16T13:33:39Z", "type": "forcePushed"}]}