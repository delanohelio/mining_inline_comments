{"pr_number": 761, "pr_title": "CAM-11689: Add filter and sort by deployment time options to ProcessDefinitionQuery", "pr_createdAt": "2020-03-27T09:19:04Z", "pr_url": "https://github.com/camunda/camunda-bpm-platform/pull/761", "timeline": [{"oid": "011dd71aaa663bb3ddf2587960eb87b826265c08", "url": "https://github.com/camunda/camunda-bpm-platform/commit/011dd71aaa663bb3ddf2587960eb87b826265c08", "message": "feat(engine): add filter/sort by deployment time to ProcessDefinition\n\nRelated to CAM-11325, CAM-11689", "committedDate": "2020-03-30T06:16:15Z", "type": "forcePushed"}, {"oid": "f65006a3b2a1b2eefc1bbf8a720919192bf80004", "url": "https://github.com/camunda/camunda-bpm-platform/commit/f65006a3b2a1b2eefc1bbf8a720919192bf80004", "message": "feat(engine): add filter/sort by deployment time to ProcessDefinition\n\nRelated to CAM-11325, CAM-11689", "committedDate": "2020-03-30T11:25:56Z", "type": "forcePushed"}, {"oid": "39c8d1675b690060ec79d73a0072848bd20bdf70", "url": "https://github.com/camunda/camunda-bpm-platform/commit/39c8d1675b690060ec79d73a0072848bd20bdf70", "message": "feat(engine): add filter/sort by deployment time to ProcessDefinition\n\nRelated to CAM-11325, CAM-11689", "committedDate": "2020-03-30T13:49:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIwODEzOQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/761#discussion_r400208139", "bodyText": "It's probably a better test if we test with a time that is not 00:00:00. This would catch more bugs in my opinion.", "author": "ThorbenLindhauer", "createdAt": "2020-03-30T13:52:01Z", "path": "engine-rest/engine-rest/src/test/java/org/camunda/bpm/engine/rest/ProcessDefinitionRestServiceQueryTest.java", "diffHunk": "@@ -611,4 +619,29 @@ public void testQueryCount() {\n     verify(mockedQuery).count();\n   }\n \n+  @Test\n+  public void testQueryByDeployTimeAfter() {\n+    String deployTime = withTimezone(\"2020-03-27T00:00:00\");", "originalCommit": "39c8d1675b690060ec79d73a0072848bd20bdf70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxNDgwMw==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/761#discussion_r400214803", "bodyText": "The > probably needs to be URL encoded to be valid XML?! We use &gt; in other places.", "author": "ThorbenLindhauer", "createdAt": "2020-03-30T14:00:30Z", "path": "engine/src/main/resources/org/camunda/bpm/engine/impl/mapping/entity/ProcessDefinition.xml", "diffHunk": "@@ -295,6 +301,12 @@\n       <if test=\"deploymentId != null\">\n         and RES.DEPLOYMENT_ID_ = #{deploymentId}\n       </if>\n+      <if test=\"deployedAfter != null\">\n+        and DEP.DEPLOY_TIME_ > #{deployedAfter}", "originalCommit": "39c8d1675b690060ec79d73a0072848bd20bdf70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxNzYyOQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/761#discussion_r400217629", "bodyText": "In all other APIs, XXAfter means that it is inclusive. This new option is exclusive. I suggest calling the method deployedAfterExclusive then, to make clear that this deviates from the convention.", "author": "ThorbenLindhauer", "createdAt": "2020-03-30T14:04:28Z", "path": "engine/src/main/java/org/camunda/bpm/engine/repository/ProcessDefinitionQuery.java", "diffHunk": "@@ -60,6 +62,16 @@\n    */\n   ProcessDefinitionQuery deploymentId(String deploymentId);\n \n+  /**\n+   * Only select process definitions that were deployed after the given Date (exclusive).\n+   */\n+  ProcessDefinitionQuery deployedAfter(Date deployedAfter);", "originalCommit": "39c8d1675b690060ec79d73a0072848bd20bdf70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3MTkxOQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/761#discussion_r400671919", "bodyText": "I found a lot of examples where XXAfter is used for exclusive filtering.\n\nExternalTask.lockExpirationAfter\nDeployment.deploymentAfter\nJob.createdAfter\nTask.dueAfter\n\nFrom a users and semantic perspective, I think this makes sense as X is not after Y if X = Y.", "author": "mboskamp", "createdAt": "2020-03-31T06:30:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxNzYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIyNTU5NA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/761#discussion_r400225594", "bodyText": "This test is not robust. It assumes that time elapses between the deployments, but that is not enforced. Furthermore, it does not test that the number of returned definitions is in any way correct, e.g. if the process definition query returned no or too little results, the test would still succeed.", "author": "ThorbenLindhauer", "createdAt": "2020-03-30T14:14:57Z", "path": "engine/src/test/java/org/camunda/bpm/engine/test/api/repository/ProcessDefinitionQueryTest.java", "diffHunk": "@@ -108,6 +111,36 @@ public void testQueryByInvalidDeploymentId() {\n     repositoryService.createProcessDefinitionQuery().deploymentId(null);\n   }\n \n+  @Test\n+  public void testQueryByDeploymentTimeAfter() {", "originalCommit": "39c8d1675b690060ec79d73a0072848bd20bdf70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIyNzYwMQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/761#discussion_r400227601", "bodyText": "Same here, this test is only works if time elapses between deployments. Please also verify that the returned definitions are actually the ones you expect and not just that the count is correct.", "author": "ThorbenLindhauer", "createdAt": "2020-03-30T14:17:32Z", "path": "engine/src/test/java/org/camunda/bpm/engine/test/api/repository/ProcessDefinitionQueryTest.java", "diffHunk": "@@ -108,6 +111,36 @@ public void testQueryByInvalidDeploymentId() {\n     repositoryService.createProcessDefinitionQuery().deploymentId(null);\n   }\n \n+  @Test\n+  public void testQueryByDeploymentTimeAfter() {\n+    List<Deployment> deployments = repositoryService.createDeploymentQuery().list();\n+\n+    for (Deployment deployment : deployments) {\n+      List<ProcessDefinition> processDefinitions = repositoryService.createProcessDefinitionQuery().deployedAfter(deployment.getDeploymentTime()).list();\n+      for (ProcessDefinition processDefinition : processDefinitions) {\n+        Deployment singleDeployment = repositoryService.createDeploymentQuery().deploymentId(processDefinition.getDeploymentId()).singleResult();\n+        // all results should have a later deployment time than the one used in the query\n+        assertThat(singleDeployment.getDeploymentTime()).isAfter(deployment.getDeploymentTime());\n+      }\n+    }\n+  }\n+\n+  @Test\n+  public void testQueryByDeploymentTimeAt() {", "originalCommit": "39c8d1675b690060ec79d73a0072848bd20bdf70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIyOTkyNg==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/761#discussion_r400229926", "bodyText": "I suggest to explictly assert the order in which process definitions are supposed to be returned. By these kind of dynamic assertions you always run into the risk of loops being skipped entirely or partially, if the results of the APIs change unintendedly (e.g. the test is green if no definitions are returned at all). Check for example ExecutionQueryTest#testQuerySorting for a more robust test.", "author": "ThorbenLindhauer", "createdAt": "2020-03-30T14:20:37Z", "path": "engine/src/test/java/org/camunda/bpm/engine/test/api/repository/ProcessDefinitionQueryTest.java", "diffHunk": "@@ -697,6 +730,22 @@ public void testQueryByNoVersionTag() {\n       .count()).isEqualTo(4);\n   }\n \n+  @Test\n+  public void testQueryOrderByDeployTime() {", "originalCommit": "39c8d1675b690060ec79d73a0072848bd20bdf70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "79ab3cd84ca1eb181d2dee2de424508c6fc3e735", "url": "https://github.com/camunda/camunda-bpm-platform/commit/79ab3cd84ca1eb181d2dee2de424508c6fc3e735", "message": "chore(engine): Improve tests\n\nRelated to CAM-11325, CAM-11689", "committedDate": "2020-04-01T11:27:17Z", "type": "forcePushed"}, {"oid": "89680649ab69d53d07b680094b4ac2bb620fba32", "url": "https://github.com/camunda/camunda-bpm-platform/commit/89680649ab69d53d07b680094b4ac2bb620fba32", "message": "feat(engine): add filter/sort by deployment time to ProcessDefinition\n\n* Convert DefinitionQueryTest to JUnit4\n* Remove redundant query mapping for MySQL\n\nRelated to CAM-11325, CAM-11689", "committedDate": "2020-04-06T06:08:42Z", "type": "commit"}, {"oid": "89680649ab69d53d07b680094b4ac2bb620fba32", "url": "https://github.com/camunda/camunda-bpm-platform/commit/89680649ab69d53d07b680094b4ac2bb620fba32", "message": "feat(engine): add filter/sort by deployment time to ProcessDefinition\n\n* Convert DefinitionQueryTest to JUnit4\n* Remove redundant query mapping for MySQL\n\nRelated to CAM-11325, CAM-11689", "committedDate": "2020-04-06T06:08:42Z", "type": "forcePushed"}]}