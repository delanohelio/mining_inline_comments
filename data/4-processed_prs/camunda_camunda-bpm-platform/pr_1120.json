{"pr_number": 1120, "pr_title": "chore(userTasksTable): migrate to React", "pr_createdAt": "2020-11-11T14:38:34Z", "pr_url": "https://github.com/camunda/camunda-bpm-platform/pull/1120", "timeline": [{"oid": "8dbb80b9eca30cb288df5c27873f4e5ecc860eda", "url": "https://github.com/camunda/camunda-bpm-platform/commit/8dbb80b9eca30cb288df5c27873f4e5ecc860eda", "message": "chore(userTasksTable): migrate to React\n\nrelated to CAM-12659", "committedDate": "2020-11-11T14:28:09Z", "type": "commit"}, {"oid": "891f6196a2c46d61eda4a7c524eba3ee16429f60", "url": "https://github.com/camunda/camunda-bpm-platform/commit/891f6196a2c46d61eda4a7c524eba3ee16429f60", "message": "add Clipboard widget", "committedDate": "2020-11-11T14:28:08Z", "type": "commit"}, {"oid": "2cce5242050eee9e895889880304c7c1663b1edb", "url": "https://github.com/camunda/camunda-bpm-platform/commit/2cce5242050eee9e895889880304c7c1663b1edb", "message": "Follow review hints", "committedDate": "2020-11-11T14:29:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQwMzUyOA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1120#discussion_r521403528", "bodyText": "So happy we dropped IE support :D", "author": "marstamm", "createdAt": "2020-11-11T14:39:37Z", "path": "webapps/ui/cockpit/src/modules/components/Clipboard/Clipboard.js", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH\n+ * under one or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information regarding copyright\n+ * ownership. Camunda licenses this file to you under the Apache License,\n+ * Version 2.0; you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+import React, { useEffect, useRef, useState } from \"react\";\n+import { Button, Glyphicon, OverlayTrigger, Tooltip } from \"react-bootstrap\";\n+import classNames from \"classnames\";\n+import translate from \"utils/translation\";\n+\n+import \"./Clipboard.scss\";\n+\n+export default function({ children, text }) {\n+  const [icon, setIcon] = useState(\"copy\");\n+  const [needsResize, setNeedsResize] = useState(false);\n+\n+  const parentRef = useRef();\n+  const contentRef = useRef();\n+\n+  useEffect(() => {\n+    // This makes sure we only truncate the value when necessary\n+    const calculateSize = () => {\n+      const content = contentRef.current;\n+      const parent = parentRef.current;\n+      const icon = parent.querySelector(\".btn\"); // Can't use ref as it is a react-bootstrap element\n+      const elementStyle = window.getComputedStyle(parent);\n+\n+      let contentWidth = 1;\n+      let containerWidth = 0;\n+      if (content && icon) {\n+        contentWidth = content.offsetWidth + icon.offsetWidth;\n+        containerWidth =\n+          parseInt(elementStyle.width) -\n+          parseInt(elementStyle.paddingRight) -\n+          parseInt(elementStyle.paddingLeft);\n+      }\n+      if (contentWidth - containerWidth > 0) {\n+        setNeedsResize(true);\n+      } else {\n+        setNeedsResize(false);\n+      }\n+    };\n+    calculateSize();\n+\n+    window.addEventListener(\"resize\", calculateSize);\n+    return () => window.removeEventListener(\"resize\", calculateSize);\n+  }, []);\n+\n+  async function copyToClipboard() {\n+    try {\n+      await navigator.clipboard.writeText(text);", "originalCommit": "2cce5242050eee9e895889880304c7c1663b1edb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAxOTIzMQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1120#discussion_r522019231", "bodyText": "Let's make the import order consistent.", "author": "tasso94", "createdAt": "2020-11-12T11:00:05Z", "path": "webapps/ui/cockpit/src/plugins/cockpit.processInstance.runtime.tab/userTasks/UserTasks.js", "diffHunk": "@@ -0,0 +1,242 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH\n+ * under one or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information regarding copyright\n+ * ownership. Camunda licenses this file to you under the Apache License,\n+ * Version 2.0; you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+import React, { useState, useEffect } from \"react\";\n+import withFilter from \"../../../components/ProcessInstance/HOC/withFilter\";\n+import withActivityInstanceMap from \"../../../components/ProcessInstance/HOC/withActivityInstanceMap\";\n+import { paginateComponent } from \"components/Pagination\";\n+\n+import { getEngine } from \"utils/config\";\n+import { formatDate } from \"utils/formatting\";\n+import { getItem, setItem } from \"utils/localstorage\";\n+import { post } from \"utils/request\";\n+\n+import {\n+  Clipboard,\n+  LinkButton,\n+  LoadingIndicator,\n+  Pagination,\n+  Table\n+} from \"components\";\n+import AssigneeEdit from \"./AssigneeEdit\";\n+import { UserAction, GroupAction } from \"./Actions\";\n+\n+import \"./UserTasks.scss\";\n+import { OverlayTrigger, Tooltip } from \"react-bootstrap\";\n+import translate from \"utils/translation\";", "originalCommit": "2cce5242050eee9e895889880304c7c1663b1edb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA3MDY0Nw==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1120#discussion_r522070647", "bodyText": "\ud83d\udc4d", "author": "marstamm", "createdAt": "2020-11-12T12:30:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAxOTIzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA2MTIzMw==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1120#discussion_r522061233", "bodyText": "\ud83d\udc9a\nI wasn't aware that the ?. operator made it to JavaScript. I already knew it from Groovy.", "author": "tasso94", "createdAt": "2020-11-12T12:13:58Z", "path": "webapps/ui/cockpit/src/plugins/cockpit.processInstance.runtime.tab/userTasks/UserTasks.js", "diffHunk": "@@ -0,0 +1,242 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH\n+ * under one or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information regarding copyright\n+ * ownership. Camunda licenses this file to you under the Apache License,\n+ * Version 2.0; you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+import React, { useState, useEffect } from \"react\";\n+import withFilter from \"../../../components/ProcessInstance/HOC/withFilter\";\n+import withActivityInstanceMap from \"../../../components/ProcessInstance/HOC/withActivityInstanceMap\";\n+import { paginateComponent } from \"components/Pagination\";\n+\n+import { getEngine } from \"utils/config\";\n+import { formatDate } from \"utils/formatting\";\n+import { getItem, setItem } from \"utils/localstorage\";\n+import { post } from \"utils/request\";\n+\n+import {\n+  Clipboard,\n+  LinkButton,\n+  LoadingIndicator,\n+  Pagination,\n+  Table\n+} from \"components\";\n+import AssigneeEdit from \"./AssigneeEdit\";\n+import { UserAction, GroupAction } from \"./Actions\";\n+\n+import \"./UserTasks.scss\";\n+import { OverlayTrigger, Tooltip } from \"react-bootstrap\";\n+import translate from \"utils/translation\";\n+import withBpmn from \"../../../components/ProcessInstance/HOC/withBpmn\";\n+\n+function UserTasks({\n+  processInstanceId,\n+  filter,\n+  setFilter,\n+  activityIdToInstancesMap,\n+  bpmnElements,\n+  startingPage = 1\n+}) {\n+  const [userTasks, setUserTasks] = useState(null);\n+  const [userTasksCount, setUserTasksCount] = useState();\n+  const [sortOrder, setSortOrder] = useState(\n+    getItem(\"sortPIUserTaskTab\", {\n+      sortBy: \"created\",\n+      sortOrder: \"desc\"\n+    })\n+  );\n+  const [queryObject, setQueryObject] = useState({\n+    activityInstanceIdIn: filter.activityInstanceIds || [],\n+    processInstanceId: processInstanceId,\n+    sorting: [sortOrder]\n+  });\n+  const [loadingState, setLoadingState] = useState(\"LOADING\");\n+  const [page, setPage] = useState(startingPage);\n+\n+  // Generate new Query Object on filter or sort change\n+  useEffect(() => {\n+    let newQueryObject = {\n+      activityInstanceIdIn: filter.activityInstanceIds,\n+      processInstanceId: processInstanceId,\n+      sorting: [sortOrder]\n+    };\n+\n+    if (\n+      JSON.stringify(queryObject.activityInstanceIds || []) !==\n+      JSON.stringify(filter.activityInstanceIds || [])\n+    ) {\n+      setPage(1);\n+    }\n+\n+    if (!newQueryObject.activityInstanceIdIn) {\n+      delete newQueryObject.activityInstanceIdIn;\n+    }\n+\n+    // Filter changes often, only update the Query object if we need to update it\n+    if (JSON.stringify(newQueryObject) !== JSON.stringify(queryObject)) {\n+      setQueryObject(newQueryObject);\n+    }\n+  }, [\n+    filter,\n+    processInstanceId,\n+    queryObject,\n+    queryObject.activityInstanceIds,\n+    sortOrder\n+  ]);\n+\n+  // Fetch everything\n+  useEffect(() => {\n+    setLoadingState(\"LOADING\");\n+    post(\n+      `%ENGINE_API%/task?maxResults=50&firstResult=${(page - 1) * 50}`,\n+      queryObject\n+    )\n+      .then(res => res.json())\n+      .then(setUserTasks)\n+      .then(() => setLoadingState(\"DONE\"));\n+  }, [page, queryObject]);\n+\n+  // Fetch new Task count\n+  useEffect(() => {\n+    post(\"%ENGINE_API%/task/count\", queryObject)\n+      .then(res => res.json())\n+      .then(json => setUserTasksCount(json.count));\n+  }, [queryObject]);\n+\n+  if (loadingState === \"LOADING\") {\n+    return <LoadingIndicator />;\n+  }\n+\n+  if (!userTasks.length) {\n+    return <span>No user tasks</span>;\n+  }\n+\n+  const handleSortChange = property => {\n+    const sortObj = {\n+      sortBy: property,\n+      sortOrder:\n+        sortOrder.sortBy === property\n+          ? sortOrder.sortOrder === \"desc\"\n+            ? \"asc\"\n+            : \"desc\"\n+          : \"asc\"\n+    };\n+    setItem(\"sortPIUserTaskTab\", sortObj);\n+    setSortOrder(sortObj);\n+  };\n+\n+  const handleSearch = activity => {\n+    setFilter({\n+      ...filter,\n+      activityIds: [activity],\n+      activityInstanceIds: [\n+        activityIdToInstancesMap[activity.taskDefinitionKey].filter(execution =>\n+          execution.executionIds.includes(activity.executionId)\n+        )[0].id\n+      ]\n+    });\n+  };\n+\n+  const rows = [\n+    { searchQuery: \"nameCaseInsensitive\", label: \"Activity\" },\n+    { searchQuery: \"assignee\", label: \"Assignee\" },\n+    { label: \"Owner\" },\n+    { searchQuery: \"created\", label: \"Creation Date\" },\n+    { searchQuery: \"dueDate\", label: \"Due Date\" },\n+    { searchQuery: \"followUpDate\", label: \"Follow Up Date\" },\n+    { searchQuery: \"priority\", label: \"Priority\" },\n+    { label: \"Delegation State\" },\n+    { searchQuery: \"id\", label: \"Task ID\" },\n+    { label: \"Action\" }\n+  ];\n+\n+  return (\n+    <>\n+      <Table\n+        className=\"UserTasks\"\n+        head={rows.map((heading, idx) => {\n+          return (\n+            <Table.Head\n+              key={idx}\n+              onSort={\n+                heading.searchQuery\n+                  ? () => handleSortChange(heading.searchQuery)\n+                  : null\n+              }\n+              sortOrder={\n+                sortOrder.sortBy === heading.searchQuery\n+                  ? sortOrder.sortOrder\n+                  : null\n+              }\n+            >\n+              {heading.label}\n+            </Table.Head>\n+          );\n+        })}\n+      >\n+        {userTasks.map((row, idx) => {\n+          return (\n+            <Table.Row key={idx}>\n+              <Table.Cell>\n+                <LinkButton onClick={() => handleSearch(row)}>\n+                  {bpmnElements[row.taskDefinitionKey]?.name ||", "originalCommit": "2cce5242050eee9e895889880304c7c1663b1edb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA3MzQ4OQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1120#discussion_r522073489", "bodyText": "Yeah, but our linter does not fully support it for functions yet. So element.function?.() does not work", "author": "marstamm", "createdAt": "2020-11-12T12:36:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA2MTIzMw=="}], "type": "inlineReview"}, {"oid": "e772e17605b184ac80ab2cc37a4853c794c4dc33", "url": "https://github.com/camunda/camunda-bpm-platform/commit/e772e17605b184ac80ab2cc37a4853c794c4dc33", "message": "change import order", "committedDate": "2020-11-12T12:40:22Z", "type": "commit"}]}