{"pr_number": 872, "pr_title": "CAM-12025: integrate telemetry reporter with engine", "pr_createdAt": "2020-06-26T12:51:12Z", "pr_url": "https://github.com/camunda/camunda-bpm-platform/pull/872", "timeline": [{"oid": "4d4f7db894c162d2963eec2a33c1e4af08b545db", "url": "https://github.com/camunda/camunda-bpm-platform/commit/4d4f7db894c162d2963eec2a33c1e4af08b545db", "message": "wip", "committedDate": "2020-06-29T12:23:53Z", "type": "forcePushed"}, {"oid": "1634d28393fe91797ebbf7b61cae56abea429626", "url": "https://github.com/camunda/camunda-bpm-platform/commit/1634d28393fe91797ebbf7b61cae56abea429626", "message": "feat(engine): schedule telemetry reporter in the engine\n\n* a telemetry reporter is created on each engine start\n* the reporter is scheduled on engine start if telemetry is enabled\n* the reporter is scheduled whenever the telemetry is enabled via API\n* the reporter is stopped whenever the telemetry is disbled via API\n* a sending task is recreated if the reporter has been stopped before\nso the timer task can be executed again\n* telemetry reporter is scheduled to run every 24 hours and on engine\nstop\n* telemetry data that is sent:\n-- engine version and edition\n-- engine installation id\n-- database vendor and version\n* the telemetry data is considered as static and its collected on engine\nstart\n\nRelated to CAM-12025", "committedDate": "2020-06-29T15:20:18Z", "type": "forcePushed"}, {"oid": "35e9bacf016ef863c921708f10d5664e8007d2b7", "url": "https://github.com/camunda/camunda-bpm-platform/commit/35e9bacf016ef863c921708f10d5664e8007d2b7", "message": "feat(engine): schedule telemetry reporter in the engine\n\n* a telemetry reporter is created on each engine start\n* the reporter is scheduled on engine start if telemetry is enabled\n* the reporter is scheduled whenever the telemetry is enabled via API\n* the reporter is stopped whenever the telemetry is disbled via API\n* a sending task is recreated if the reporter has been stopped before\nso the timer task can be executed again\n* telemetry reporter is scheduled to run every 24 hours and on engine\nstop\n* telemetry data that is sent:\n-- engine version and edition\n-- engine installation id\n-- database vendor and version\n* the telemetry data is considered as static and its collected on engine\nstart\n\nRelated to CAM-12025", "committedDate": "2020-06-29T15:26:06Z", "type": "commit"}, {"oid": "35e9bacf016ef863c921708f10d5664e8007d2b7", "url": "https://github.com/camunda/camunda-bpm-platform/commit/35e9bacf016ef863c921708f10d5664e8007d2b7", "message": "feat(engine): schedule telemetry reporter in the engine\n\n* a telemetry reporter is created on each engine start\n* the reporter is scheduled on engine start if telemetry is enabled\n* the reporter is scheduled whenever the telemetry is enabled via API\n* the reporter is stopped whenever the telemetry is disbled via API\n* a sending task is recreated if the reporter has been stopped before\nso the timer task can be executed again\n* telemetry reporter is scheduled to run every 24 hours and on engine\nstop\n* telemetry data that is sent:\n-- engine version and edition\n-- engine installation id\n-- database vendor and version\n* the telemetry data is considered as static and its collected on engine\nstart\n\nRelated to CAM-12025", "committedDate": "2020-06-29T15:26:06Z", "type": "forcePushed"}, {"oid": "0ccd9e603e70a0366fb71107e9fc6d07f55f6f50", "url": "https://github.com/camunda/camunda-bpm-platform/commit/0ccd9e603e70a0366fb71107e9fc6d07f55f6f50", "message": "remove test", "committedDate": "2020-06-30T05:38:45Z", "type": "commit"}, {"oid": "82309b0ae2f8d51ff469bb01b4632690c0b56196", "url": "https://github.com/camunda/camunda-bpm-platform/commit/82309b0ae2f8d51ff469bb01b4632690c0b56196", "message": "SQUASH ME!", "committedDate": "2020-06-30T08:14:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ5NzMxNg==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/872#discussion_r447497316", "bodyText": "Anonymous new Command() can be replaced with lambda.", "author": "tasso94", "createdAt": "2020-06-30T08:15:27Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/telemetry/reporter/TelemetrySendingTask.java", "diffHunk": "@@ -68,21 +68,26 @@ protected void sendData() {\n     commandExecutor.execute(new Command<Void>() {", "originalCommit": "82309b0ae2f8d51ff469bb01b4632690c0b56196", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ5ODE4OA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/872#discussion_r447498188", "bodyText": "Gson is an expensive object. Can we extend the JsonUtil and use it from there?", "author": "tasso94", "createdAt": "2020-06-30T08:16:49Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/telemetry/reporter/TelemetrySendingTask.java", "diffHunk": "@@ -68,21 +68,26 @@ protected void sendData() {\n     commandExecutor.execute(new Command<Void>() {\n       @Override\n       public Void execute(CommandContext commandContext) {\n-        try {\n-          HttpPost request = new HttpPost(telemetryEndpoint);\n-          String telemetryData = new Gson().toJson(data);\n-          StringEntity requestBody = new StringEntity(telemetryData, StandardCharsets.UTF_8);\n-          request.setHeader(\"content-type\", MediaType.APPLICATION_JSON);\n-          request.setEntity(requestBody);\n-          HttpResponse response = httpClient.execute(request);\n+        // send data only if telemetry is enabled\n+        if (commandContext.getProcessEngineConfiguration().getManagementService().isTelemetryEnabled()) {\n+          try {\n+            HttpPost request = new HttpPost(telemetryEndpoint);\n+            String telemetryData = new Gson().toJson(data);", "originalCommit": "82309b0ae2f8d51ff469bb01b4632690c0b56196", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ5ODc1MQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/872#discussion_r447498751", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                timer = new Timer(\"Camunda Telemetry Reporter\", true);\n          \n          \n            \n                timer = new Timer(\"Camunda BPM Runtime Telemetry Reporter\", true);", "author": "tasso94", "createdAt": "2020-06-30T08:17:42Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/telemetry/reporter/TelemetryReporter.java", "diffHunk": "@@ -54,22 +56,25 @@ protected void initTelemetrySendingTask() {\n   }\n \n   public void start() {\n+    if (stopped) {\n+      // if the reporter was already stopped another task should be scheduled\n+      initTelemetrySendingTask();\n+    }\n     timer = new Timer(\"Camunda Telemetry Reporter\", true);", "originalCommit": "82309b0ae2f8d51ff469bb01b4632690c0b56196", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwMjg1OA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/872#discussion_r447502858", "bodyText": "Right now, this method can be called multiple times via ManagementService#toggleTelemetry(true). This leads to multiple timers running in parallel. The timers which are not referenced anymore are still active in the background and continue to execute the telemetry sending task. They cannot be canceled and will eventually be force killed when the JVM is shutdown.", "author": "tasso94", "createdAt": "2020-06-30T08:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ5ODc1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwNDQwMA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/872#discussion_r447504400", "bodyText": "System properties are not taken into account. When a user wants to proxy the telemetry endpoint, an HTTP client needs to be instantiated manually, which is tricky (engine plugin needed). Let's #useSystemProperties by default.", "author": "tasso94", "createdAt": "2020-06-30T08:26:18Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/cfg/ProcessEngineConfigurationImpl.java", "diffHunk": "@@ -2557,6 +2575,37 @@ protected void initAdminGroups() {\n     }\n   }\n \n+  protected void initTelemetry() {\n+    if (telemetryData == null) {\n+      initTelemetryData();\n+    }\n+    if (telemetryHttpClient == null) {\n+      telemetryHttpClient = HttpClientBuilder.create().build();", "originalCommit": "82309b0ae2f8d51ff469bb01b4632690c0b56196", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwNTgxMw==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/872#discussion_r447505813", "bodyText": "Throws IllegalStateException if the task...\n\n... was already scheduled or canceled\n... the timer was canceled\n... the timer thread terminated", "author": "tasso94", "createdAt": "2020-06-30T08:28:22Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/telemetry/reporter/TelemetryReporter.java", "diffHunk": "@@ -54,22 +56,25 @@ protected void initTelemetrySendingTask() {\n   }\n \n   public void start() {\n+    if (stopped) {\n+      // if the reporter was already stopped another task should be scheduled\n+      initTelemetrySendingTask();\n+    }\n     timer = new Timer(\"Camunda Telemetry Reporter\", true);\n     long reportingIntervalInMillis =  reportingIntervalInSeconds * 1000;\n \n     timer.scheduleAtFixedRate(telemetrySendingTask, reportingIntervalInMillis, reportingIntervalInMillis);", "originalCommit": "82309b0ae2f8d51ff469bb01b4632690c0b56196", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwNjA3Ng==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/872#discussion_r447506076", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              protected static final String PRODUCT_NAME = \"Camunda BPM\";\n          \n          \n            \n              protected static final String PRODUCT_NAME = \"Camunda BPM Runtime\";", "author": "tasso94", "createdAt": "2020-06-30T08:28:45Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/cfg/ProcessEngineConfigurationImpl.java", "diffHunk": "@@ -387,6 +395,10 @@\n \n   public static final int DEFAULT_INVOCATIONS_PER_BATCH_JOB = 1;\n \n+  protected static final String EDITION_ENTERPRISE = \"enterprise\";\n+  protected static final String EDITION_COMMUNITY = \"community\";\n+  protected static final String PRODUCT_NAME = \"Camunda BPM\";", "originalCommit": "82309b0ae2f8d51ff469bb01b4632690c0b56196", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d30161c208263d512bfda205f20bb68c5d3a5b71", "url": "https://github.com/camunda/camunda-bpm-platform/commit/d30161c208263d512bfda205f20bb68c5d3a5b71", "message": "override telemetryEndpoint config in camunda.cfg.xml for tests to\nprevent", "committedDate": "2020-06-30T12:26:08Z", "type": "commit"}, {"oid": "63550f6336ce91b7d6100dc45ca6d8f9c3e095de", "url": "https://github.com/camunda/camunda-bpm-platform/commit/63550f6336ce91b7d6100dc45ca6d8f9c3e095de", "message": "chore(engine): adjust telemetry\n\n* set installation id in bootstrap engine command\n* start reporter in engine command\n* rename product name to Camunda BPM Runtime, the reporter name as well\n* use lambda instead of anonymous new command\n* extend JsonUtil and gsonMapper for converting object to json\n* use useSystemProperties for http client", "committedDate": "2020-06-30T12:27:00Z", "type": "commit"}, {"oid": "9cf188aeeb80ce49d6f7e08a92a7e1e5034c42bd", "url": "https://github.com/camunda/camunda-bpm-platform/commit/9cf188aeeb80ce49d6f7e08a92a7e1e5034c42bd", "message": "chore(engine): use HttpHeaders content type constant", "committedDate": "2020-06-30T12:46:58Z", "type": "commit"}, {"oid": "ed4b0dec19e1e7fa3506c4f8c62615d4162d65eb", "url": "https://github.com/camunda/camunda-bpm-platform/commit/ed4b0dec19e1e7fa3506c4f8c62615d4162d65eb", "message": "revert(engine): override telemetryEndpoint config in camunda.cfg.xml for tests to\n\nThis reverts commit d30161c208263d512bfda205f20bb68c5d3a5b71.", "committedDate": "2020-06-30T15:39:29Z", "type": "commit"}, {"oid": "b8316bb5087209b2a98a5a90bf2a4873fd2dbc71", "url": "https://github.com/camunda/camunda-bpm-platform/commit/b8316bb5087209b2a98a5a90bf2a4873fd2dbc71", "message": "Avoid race conditions when telemetry reporter is started/stopped", "committedDate": "2020-07-01T07:15:09Z", "type": "commit"}]}