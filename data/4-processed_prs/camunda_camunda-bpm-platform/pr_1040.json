{"pr_number": 1040, "pr_title": "CAM-12557: fix(telemetry): skip sending initial report during engine close", "pr_createdAt": "2020-10-02T12:14:57Z", "pr_url": "https://github.com/camunda/camunda-bpm-platform/pull/1040", "timeline": [{"oid": "85882c496778568a24daffaa687dd6f2ab4b7da8", "url": "https://github.com/camunda/camunda-bpm-platform/commit/85882c496778568a24daffaa687dd6f2ab4b7da8", "message": "fix(telemetry): skip sending initial report during engine close\n\nRelated to CAM-12557", "committedDate": "2020-10-02T12:13:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwNzYwMA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1040#discussion_r498807600", "bodyText": "Do we need new test cases for this or should we simply integrate this into the other test cases directly above (in the end, they simply make it more specific that initial data should only be sent once)?", "author": "tmetzke", "createdAt": "2020-10-02T13:04:10Z", "path": "engine/src/test/java/org/camunda/bpm/engine/test/api/mgmt/telemetry/TelemetryReporterTest.java", "diffHunk": "@@ -315,6 +357,76 @@ public void shouldReportInitialDataWhenReporterActivatedAndInitTelemetryEnabled(\n               .withHeader(\"Content-Type\",  equalTo(\"application/json\")));\n   }\n \n+  @Test\n+  public void shouldReportInitialDataOnceInitTelemetryUndefined() {\n+    // given\n+    ProcessEngineConfigurationImpl processEngineConfiguration = createEngineWithInitMessage(null);\n+    stubFor(post(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+            .willReturn(aResponse()\n+                        .withStatus(HttpURLConnection.HTTP_ACCEPTED)));\n+\n+    Data expectedData = createInitialDataToSend(processEngineConfiguration.getTelemetryData(), null);\n+    String requestBody = new Gson().toJson(expectedData);\n+\n+    // when\n+    processEngineConfiguration.getTelemetryReporter().reportNow();\n+    standaloneProcessEngine.close();\n+    standaloneProcessEngine = null;\n+\n+    // then\n+    verify(1, postRequestedFor(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+              .withRequestBody(equalToJson(requestBody, JSONCompareMode.LENIENT))\n+              .withHeader(\"Content-Type\",  equalTo(\"application/json\")));\n+  }\n+\n+\n+  @Test\n+  public void shouldReportInitialDataOnceInitTelemetryDisabled() {\n+    // given\n+    ProcessEngineConfigurationImpl processEngineConfiguration = createEngineWithInitMessage(false);\n+    stubFor(post(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+            .willReturn(aResponse()\n+                        .withStatus(HttpURLConnection.HTTP_ACCEPTED)));\n+\n+    Data expectedData = createInitialDataToSend(processEngineConfiguration.getTelemetryData(), false);\n+    String requestBody = new Gson().toJson(expectedData);\n+\n+    // when\n+    processEngineConfiguration.getTelemetryReporter().reportNow();\n+    standaloneProcessEngine.close();\n+    standaloneProcessEngine = null;\n+\n+    // then\n+    verify(1, postRequestedFor(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+              .withRequestBody(equalToJson(requestBody, JSONCompareMode.LENIENT))\n+              .withHeader(\"Content-Type\",  equalTo(\"application/json\")));\n+  }\n+\n+  @Test\n+  @WatchLogger(loggerNames = {\"org.camunda.bpm.engine.telemetry\"}, level = \"DEBUG\")\n+  public void shouldReportInitialDataOnceInitTelemetryEnabled() {\n+    // given\n+    ProcessEngineConfigurationImpl processEngineConfiguration = createEngineWithInitMessage(true);\n+    stubFor(post(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+            .willReturn(aResponse()\n+                        .withStatus(HttpURLConnection.HTTP_ACCEPTED)));\n+\n+    Data expectedData = createInitialDataToSend(processEngineConfiguration.getTelemetryData(), true);\n+    String requestBody = new Gson().toJson(expectedData);\n+\n+    // when\n+    processEngineConfiguration.getTelemetryReporter().reportNow();\n+    standaloneProcessEngine.close();\n+    standaloneProcessEngine = null;\n+\n+    // then\n+    verify(3, postRequestedFor(urlEqualTo(TELEMETRY_ENDPOINT_PATH))\n+              .withRequestBody(equalToJson(requestBody, JSONCompareMode.LENIENT))\n+              .withHeader(\"Content-Type\",  equalTo(\"application/json\")));\n+    assertThat(loggingRule.getFilteredLog(\"Sending initial telemetry data\").size()).isOne();\n+    assertThat(loggingRule.getFilteredLog(\"Initial telemetry request was successful.\").size()).isOne();\n+  }", "originalCommit": "85882c496778568a24daffaa687dd6f2ab4b7da8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgyMTMxOA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1040#discussion_r498821318", "bodyText": "Now I spotted the difference! Cool, let's keep them \ud83d\udc4d", "author": "tmetzke", "createdAt": "2020-10-02T13:28:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwNzYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwNzc0Nw==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1040#discussion_r498807747", "bodyText": "Why don't we need this anymore?", "author": "tmetzke", "createdAt": "2020-10-02T13:04:30Z", "path": "engine/src/test/java/org/camunda/bpm/engine/test/api/mgmt/telemetry/TelemetryReporterTest.java", "diffHunk": "@@ -182,7 +181,6 @@ public void tearDown() {\n         standaloneProcessEngine.getManagementService().toggleTelemetry(false);\n       }\n       standaloneProcessEngine.close();\n-      ProcessEngines.unregister(standaloneProcessEngine);", "originalCommit": "85882c496778568a24daffaa687dd6f2ab4b7da8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwOTU4Mg==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1040#discussion_r498809582", "bodyText": "ahm, processEngine#close() does that already, I just saw it today", "author": "yanavasileva", "createdAt": "2020-10-02T13:07:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwNzc0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgxMDUzMA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/1040#discussion_r498810530", "bodyText": "OK nice, good catch \ud83d\udc4d", "author": "tmetzke", "createdAt": "2020-10-02T13:09:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwNzc0Nw=="}], "type": "inlineReview"}, {"oid": "3e3e3c72045eab21826f658a8ef175755ccd9dd3", "url": "https://github.com/camunda/camunda-bpm-platform/commit/3e3e3c72045eab21826f658a8ef175755ccd9dd3", "message": "squash me", "committedDate": "2020-10-02T14:03:27Z", "type": "commit"}]}