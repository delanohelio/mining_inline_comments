{"pr_number": 859, "pr_title": "feat(engine): introduce telemetry configuration", "pr_createdAt": "2020-06-15T15:27:49Z", "pr_url": "https://github.com/camunda/camunda-bpm-platform/pull/859", "timeline": [{"oid": "0412cc36517db284465b2eb46f675e12f46d4125", "url": "https://github.com/camunda/camunda-bpm-platform/commit/0412cc36517db284465b2eb46f675e12f46d4125", "message": "feat(engine): introduce telemetry configuration\n\n* disabled by default", "committedDate": "2020-06-16T12:03:29Z", "type": "forcePushed"}, {"oid": "9fda8ea6ae8f689322a9c4186348040d67612a7f", "url": "https://github.com/camunda/camunda-bpm-platform/commit/9fda8ea6ae8f689322a9c4186348040d67612a7f", "message": "feat(engine): introduce telemetry configuration\n\n- disabled by default\n- store telemetry property in the database (it can be enabled/disabled\nlater)\n-- add telemetry.lock in create and update scripts\n- test the new configuration (+ concurrency test)\n\nRelated to CAM-12023", "committedDate": "2020-06-16T13:59:01Z", "type": "commit"}, {"oid": "9fda8ea6ae8f689322a9c4186348040d67612a7f", "url": "https://github.com/camunda/camunda-bpm-platform/commit/9fda8ea6ae8f689322a9c4186348040d67612a7f", "message": "feat(engine): introduce telemetry configuration\n\n- disabled by default\n- store telemetry property in the database (it can be enabled/disabled\nlater)\n-- add telemetry.lock in create and update scripts\n- test the new configuration (+ concurrency test)\n\nRelated to CAM-12023", "committedDate": "2020-06-16T13:59:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAyMjM2Mw==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/859#discussion_r442022363", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \"Error fetcing telemetry property in database: {}\", exception.getMessage());\n          \n          \n            \n                    \"Error while fetching the telemetry property from the database: {}\", exception.getMessage());", "author": "tasso94", "createdAt": "2020-06-18T07:28:02Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/db/EnginePersistenceLogger.java", "diffHunk": "@@ -739,4 +739,26 @@ public ProcessEngineException disabledHistoricInstancePermissionsException() {\n     ));\n   }\n \n+  public void noTelemetryLockPropertyFound() {\n+    logDebug(\n+        \"091\", \"No telemetry lock property found in database\");\n+  }\n+\n+  public void noTelemetryPropertyFound() {\n+    logDebug(\n+        \"092\", \"No telemetry property found in database\");\n+  }\n+\n+  public void creatingTelemetryPropertyInDatabase(Boolean telemetryEnabled) {\n+    logDebug(\n+        \"093\",\n+        \"Creating telemetry property in database with value: {}\", telemetryEnabled);\n+  }\n+\n+  public void errorFetchingTelemetryPropertyInDatabase(Exception exception) {\n+    logDebug(\n+        \"094\",\n+        \"Error fetcing telemetry property in database: {}\", exception.getMessage());", "originalCommit": "9fda8ea6ae8f689322a9c4186348040d67612a7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAyMjkzNw==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/859#discussion_r442022937", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \"091\", \"No telemetry lock property found in database\");\n          \n          \n            \n                    \"091\", \"No telemetry lock property found in the database\");", "author": "tasso94", "createdAt": "2020-06-18T07:29:09Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/db/EnginePersistenceLogger.java", "diffHunk": "@@ -739,4 +739,26 @@ public ProcessEngineException disabledHistoricInstancePermissionsException() {\n     ));\n   }\n \n+  public void noTelemetryLockPropertyFound() {\n+    logDebug(\n+        \"091\", \"No telemetry lock property found in database\");", "originalCommit": "9fda8ea6ae8f689322a9c4186348040d67612a7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAyMzA0Nw==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/859#discussion_r442023047", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \"092\", \"No telemetry property found in database\");\n          \n          \n            \n                    \"092\", \"No telemetry property found in the database\");", "author": "tasso94", "createdAt": "2020-06-18T07:29:23Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/db/EnginePersistenceLogger.java", "diffHunk": "@@ -739,4 +739,26 @@ public ProcessEngineException disabledHistoricInstancePermissionsException() {\n     ));\n   }\n \n+  public void noTelemetryLockPropertyFound() {\n+    logDebug(\n+        \"091\", \"No telemetry lock property found in database\");\n+  }\n+\n+  public void noTelemetryPropertyFound() {\n+    logDebug(\n+        \"092\", \"No telemetry property found in database\");", "originalCommit": "9fda8ea6ae8f689322a9c4186348040d67612a7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAyMzIxNA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/859#discussion_r442023214", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \"Creating telemetry property in database with value: {}\", telemetryEnabled);\n          \n          \n            \n                    \"Creating the telemetry property in database with the value: {}\", telemetryEnabled);", "author": "tasso94", "createdAt": "2020-06-18T07:29:43Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/db/EnginePersistenceLogger.java", "diffHunk": "@@ -739,4 +739,26 @@ public ProcessEngineException disabledHistoricInstancePermissionsException() {\n     ));\n   }\n \n+  public void noTelemetryLockPropertyFound() {\n+    logDebug(\n+        \"091\", \"No telemetry lock property found in database\");\n+  }\n+\n+  public void noTelemetryPropertyFound() {\n+    logDebug(\n+        \"092\", \"No telemetry property found in database\");\n+  }\n+\n+  public void creatingTelemetryPropertyInDatabase(Boolean telemetryEnabled) {\n+    logDebug(\n+        \"093\",\n+        \"Creating telemetry property in database with value: {}\", telemetryEnabled);", "originalCommit": "9fda8ea6ae8f689322a9c4186348040d67612a7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAyNzI0NA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/859#discussion_r442027244", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  PropertyEntity telemetryPropetry =  fetchTelemetryProperty(commandContext);\n          \n          \n            \n                  PropertyEntity telemetryProperty = fetchTelemetryProperty(commandContext);", "author": "tasso94", "createdAt": "2020-06-18T07:37:19Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/cmd/TelemetrySetupCommand.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH\n+ * under one or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information regarding copyright\n+ * ownership. Camunda licenses this file to you under the Apache License,\n+ * Version 2.0; you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.camunda.bpm.engine.impl.cmd;\n+\n+import org.camunda.bpm.engine.impl.ProcessEngineLogger;\n+import org.camunda.bpm.engine.impl.db.EnginePersistenceLogger;\n+import org.camunda.bpm.engine.impl.db.entitymanager.DbEntityManager;\n+import org.camunda.bpm.engine.impl.interceptor.Command;\n+import org.camunda.bpm.engine.impl.interceptor.CommandContext;\n+import org.camunda.bpm.engine.impl.persistence.entity.PropertyEntity;\n+\n+public class TelemetrySetupCommand implements Command<Void> {\n+\n+  private final static EnginePersistenceLogger LOG = ProcessEngineLogger.PERSISTENCE_LOGGER;\n+\n+  protected boolean telemetryEnabled;\n+\n+  public TelemetrySetupCommand() {\n+  }\n+  \n+  public TelemetrySetupCommand(boolean enabled) {\n+    this.telemetryEnabled = enabled;\n+  }\n+\n+  public Void execute(CommandContext commandContext) {\n+\n+    checkTelemetryLockExists(commandContext);\n+\n+    Boolean databaseTelemetryProperty = databaseTelemetryConfiguration(commandContext);\n+\n+    if (databaseTelemetryProperty == null) {\n+\n+      commandContext.getPropertyManager().acquireExclusiveLockForTelemetry();\n+      databaseTelemetryProperty = databaseTelemetryConfiguration(commandContext);\n+\n+      if(databaseTelemetryProperty == null) {\n+        LOG.noTelemetryPropertyFound();\n+        createTelemetryProperty(commandContext);\n+      }\n+    } else if (databaseTelemetryProperty != null) {\n+\n+      commandContext.getPropertyManager().acquireExclusiveLockForTelemetry();\n+      databaseTelemetryProperty = databaseTelemetryConfiguration(commandContext);\n+\n+      if(databaseTelemetryProperty != null) {\n+        PropertyEntity telemetryProperty = fetchTelemetryProperty(commandContext);\n+        telemetryProperty.setValue(Boolean.toString(telemetryEnabled));\n+      } else {\n+        LOG.noTelemetryPropertyFound();\n+        createTelemetryProperty(commandContext);\n+      }\n+    }\n+\n+    return null;\n+  }\n+\n+  protected void checkTelemetryLockExists(CommandContext commandContext) {\n+    PropertyEntity telemetryLockProperty = commandContext.getPropertyManager().findPropertyById(\"telemetry.lock\");\n+    if (telemetryLockProperty == null) {\n+      LOG.noTelemetryLockPropertyFound();\n+    }\n+  }\n+\n+  private PropertyEntity fetchTelemetryProperty(CommandContext commandContext) {\n+    return commandContext.getPropertyManager().findPropertyById(\"camunda.telemetry.enabled\");\n+  }\n+\n+  protected Boolean databaseTelemetryConfiguration(CommandContext commandContext) {\n+    try {\n+      PropertyEntity telemetryPropetry =  fetchTelemetryProperty(commandContext);", "originalCommit": "9fda8ea6ae8f689322a9c4186348040d67612a7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAyOTA1OA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/859#discussion_r442029058", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                }", "author": "tasso94", "createdAt": "2020-06-18T07:40:38Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/cmd/TelemetrySetupCommand.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH\n+ * under one or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information regarding copyright\n+ * ownership. Camunda licenses this file to you under the Apache License,\n+ * Version 2.0; you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.camunda.bpm.engine.impl.cmd;\n+\n+import org.camunda.bpm.engine.impl.ProcessEngineLogger;\n+import org.camunda.bpm.engine.impl.db.EnginePersistenceLogger;\n+import org.camunda.bpm.engine.impl.db.entitymanager.DbEntityManager;\n+import org.camunda.bpm.engine.impl.interceptor.Command;\n+import org.camunda.bpm.engine.impl.interceptor.CommandContext;\n+import org.camunda.bpm.engine.impl.persistence.entity.PropertyEntity;\n+\n+public class TelemetrySetupCommand implements Command<Void> {\n+\n+  private final static EnginePersistenceLogger LOG = ProcessEngineLogger.PERSISTENCE_LOGGER;\n+\n+  protected boolean telemetryEnabled;\n+\n+  public TelemetrySetupCommand() {\n+  }\n+  \n+  public TelemetrySetupCommand(boolean enabled) {\n+    this.telemetryEnabled = enabled;\n+  }\n+\n+  public Void execute(CommandContext commandContext) {\n+\n+    checkTelemetryLockExists(commandContext);\n+\n+    Boolean databaseTelemetryProperty = databaseTelemetryConfiguration(commandContext);\n+\n+    if (databaseTelemetryProperty == null) {\n+\n+      commandContext.getPropertyManager().acquireExclusiveLockForTelemetry();\n+      databaseTelemetryProperty = databaseTelemetryConfiguration(commandContext);\n+\n+      if(databaseTelemetryProperty == null) {\n+        LOG.noTelemetryPropertyFound();\n+        createTelemetryProperty(commandContext);\n+      }\n+    } else if (databaseTelemetryProperty != null) {\n+\n+      commandContext.getPropertyManager().acquireExclusiveLockForTelemetry();\n+      databaseTelemetryProperty = databaseTelemetryConfiguration(commandContext);\n+\n+      if(databaseTelemetryProperty != null) {\n+        PropertyEntity telemetryProperty = fetchTelemetryProperty(commandContext);\n+        telemetryProperty.setValue(Boolean.toString(telemetryEnabled));\n+      } else {\n+        LOG.noTelemetryPropertyFound();\n+        createTelemetryProperty(commandContext);\n+      }\n+    }\n+\n+    return null;\n+  }\n+\n+  protected void checkTelemetryLockExists(CommandContext commandContext) {\n+    PropertyEntity telemetryLockProperty = commandContext.getPropertyManager().findPropertyById(\"telemetry.lock\");\n+    if (telemetryLockProperty == null) {\n+      LOG.noTelemetryLockPropertyFound();\n+    }\n+  }\n+\n+  private PropertyEntity fetchTelemetryProperty(CommandContext commandContext) {\n+    return commandContext.getPropertyManager().findPropertyById(\"camunda.telemetry.enabled\");\n+  }\n+\n+  protected Boolean databaseTelemetryConfiguration(CommandContext commandContext) {\n+    try {\n+      PropertyEntity telemetryPropetry =  fetchTelemetryProperty(commandContext);\n+      return telemetryPropetry != null ? Boolean.parseBoolean(telemetryPropetry.getValue()) : null;\n+    }", "originalCommit": "9fda8ea6ae8f689322a9c4186348040d67612a7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAyOTA5Mw==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/859#discussion_r442029093", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                catch (Exception e) {\n          \n          \n            \n                } catch (Exception e) {", "author": "tasso94", "createdAt": "2020-06-18T07:40:42Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/cmd/TelemetrySetupCommand.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH\n+ * under one or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information regarding copyright\n+ * ownership. Camunda licenses this file to you under the Apache License,\n+ * Version 2.0; you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.camunda.bpm.engine.impl.cmd;\n+\n+import org.camunda.bpm.engine.impl.ProcessEngineLogger;\n+import org.camunda.bpm.engine.impl.db.EnginePersistenceLogger;\n+import org.camunda.bpm.engine.impl.db.entitymanager.DbEntityManager;\n+import org.camunda.bpm.engine.impl.interceptor.Command;\n+import org.camunda.bpm.engine.impl.interceptor.CommandContext;\n+import org.camunda.bpm.engine.impl.persistence.entity.PropertyEntity;\n+\n+public class TelemetrySetupCommand implements Command<Void> {\n+\n+  private final static EnginePersistenceLogger LOG = ProcessEngineLogger.PERSISTENCE_LOGGER;\n+\n+  protected boolean telemetryEnabled;\n+\n+  public TelemetrySetupCommand() {\n+  }\n+  \n+  public TelemetrySetupCommand(boolean enabled) {\n+    this.telemetryEnabled = enabled;\n+  }\n+\n+  public Void execute(CommandContext commandContext) {\n+\n+    checkTelemetryLockExists(commandContext);\n+\n+    Boolean databaseTelemetryProperty = databaseTelemetryConfiguration(commandContext);\n+\n+    if (databaseTelemetryProperty == null) {\n+\n+      commandContext.getPropertyManager().acquireExclusiveLockForTelemetry();\n+      databaseTelemetryProperty = databaseTelemetryConfiguration(commandContext);\n+\n+      if(databaseTelemetryProperty == null) {\n+        LOG.noTelemetryPropertyFound();\n+        createTelemetryProperty(commandContext);\n+      }\n+    } else if (databaseTelemetryProperty != null) {\n+\n+      commandContext.getPropertyManager().acquireExclusiveLockForTelemetry();\n+      databaseTelemetryProperty = databaseTelemetryConfiguration(commandContext);\n+\n+      if(databaseTelemetryProperty != null) {\n+        PropertyEntity telemetryProperty = fetchTelemetryProperty(commandContext);\n+        telemetryProperty.setValue(Boolean.toString(telemetryEnabled));\n+      } else {\n+        LOG.noTelemetryPropertyFound();\n+        createTelemetryProperty(commandContext);\n+      }\n+    }\n+\n+    return null;\n+  }\n+\n+  protected void checkTelemetryLockExists(CommandContext commandContext) {\n+    PropertyEntity telemetryLockProperty = commandContext.getPropertyManager().findPropertyById(\"telemetry.lock\");\n+    if (telemetryLockProperty == null) {\n+      LOG.noTelemetryLockPropertyFound();\n+    }\n+  }\n+\n+  private PropertyEntity fetchTelemetryProperty(CommandContext commandContext) {\n+    return commandContext.getPropertyManager().findPropertyById(\"camunda.telemetry.enabled\");\n+  }\n+\n+  protected Boolean databaseTelemetryConfiguration(CommandContext commandContext) {\n+    try {\n+      PropertyEntity telemetryPropetry =  fetchTelemetryProperty(commandContext);\n+      return telemetryPropetry != null ? Boolean.parseBoolean(telemetryPropetry.getValue()) : null;\n+    }\n+    catch (Exception e) {", "originalCommit": "9fda8ea6ae8f689322a9c4186348040d67612a7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEwNzU1OQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/859#discussion_r442107559", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private final static EnginePersistenceLogger LOG = ProcessEngineLogger.PERSISTENCE_LOGGER;\n          \n          \n            \n              protected static final EnginePersistenceLogger LOG = ProcessEngineLogger.PERSISTENCE_LOGGER;", "author": "tasso94", "createdAt": "2020-06-18T09:52:00Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/cmd/TelemetrySetupCommand.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH\n+ * under one or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information regarding copyright\n+ * ownership. Camunda licenses this file to you under the Apache License,\n+ * Version 2.0; you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.camunda.bpm.engine.impl.cmd;\n+\n+import org.camunda.bpm.engine.impl.ProcessEngineLogger;\n+import org.camunda.bpm.engine.impl.db.EnginePersistenceLogger;\n+import org.camunda.bpm.engine.impl.db.entitymanager.DbEntityManager;\n+import org.camunda.bpm.engine.impl.interceptor.Command;\n+import org.camunda.bpm.engine.impl.interceptor.CommandContext;\n+import org.camunda.bpm.engine.impl.persistence.entity.PropertyEntity;\n+\n+public class TelemetrySetupCommand implements Command<Void> {\n+\n+  private final static EnginePersistenceLogger LOG = ProcessEngineLogger.PERSISTENCE_LOGGER;", "originalCommit": "9fda8ea6ae8f689322a9c4186348040d67612a7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEwNzcyNA==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/859#discussion_r442107724", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private PropertyEntity fetchTelemetryProperty(CommandContext commandContext) {\n          \n          \n            \n              protected PropertyEntity fetchTelemetryProperty(CommandContext commandContext) {", "author": "tasso94", "createdAt": "2020-06-18T09:52:17Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/cmd/TelemetrySetupCommand.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH\n+ * under one or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information regarding copyright\n+ * ownership. Camunda licenses this file to you under the Apache License,\n+ * Version 2.0; you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.camunda.bpm.engine.impl.cmd;\n+\n+import org.camunda.bpm.engine.impl.ProcessEngineLogger;\n+import org.camunda.bpm.engine.impl.db.EnginePersistenceLogger;\n+import org.camunda.bpm.engine.impl.db.entitymanager.DbEntityManager;\n+import org.camunda.bpm.engine.impl.interceptor.Command;\n+import org.camunda.bpm.engine.impl.interceptor.CommandContext;\n+import org.camunda.bpm.engine.impl.persistence.entity.PropertyEntity;\n+\n+public class TelemetrySetupCommand implements Command<Void> {\n+\n+  private final static EnginePersistenceLogger LOG = ProcessEngineLogger.PERSISTENCE_LOGGER;\n+\n+  protected boolean telemetryEnabled;\n+\n+  public TelemetrySetupCommand() {\n+  }\n+  \n+  public TelemetrySetupCommand(boolean enabled) {\n+    this.telemetryEnabled = enabled;\n+  }\n+\n+  public Void execute(CommandContext commandContext) {\n+\n+    checkTelemetryLockExists(commandContext);\n+\n+    Boolean databaseTelemetryProperty = databaseTelemetryConfiguration(commandContext);\n+\n+    if (databaseTelemetryProperty == null) {\n+\n+      commandContext.getPropertyManager().acquireExclusiveLockForTelemetry();\n+      databaseTelemetryProperty = databaseTelemetryConfiguration(commandContext);\n+\n+      if(databaseTelemetryProperty == null) {\n+        LOG.noTelemetryPropertyFound();\n+        createTelemetryProperty(commandContext);\n+      }\n+    } else if (databaseTelemetryProperty != null) {\n+\n+      commandContext.getPropertyManager().acquireExclusiveLockForTelemetry();\n+      databaseTelemetryProperty = databaseTelemetryConfiguration(commandContext);\n+\n+      if(databaseTelemetryProperty != null) {\n+        PropertyEntity telemetryProperty = fetchTelemetryProperty(commandContext);\n+        telemetryProperty.setValue(Boolean.toString(telemetryEnabled));\n+      } else {\n+        LOG.noTelemetryPropertyFound();\n+        createTelemetryProperty(commandContext);\n+      }\n+    }\n+\n+    return null;\n+  }\n+\n+  protected void checkTelemetryLockExists(CommandContext commandContext) {\n+    PropertyEntity telemetryLockProperty = commandContext.getPropertyManager().findPropertyById(\"telemetry.lock\");\n+    if (telemetryLockProperty == null) {\n+      LOG.noTelemetryLockPropertyFound();\n+    }\n+  }\n+\n+  private PropertyEntity fetchTelemetryProperty(CommandContext commandContext) {", "originalCommit": "9fda8ea6ae8f689322a9c4186348040d67612a7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEwODUzMQ==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/859#discussion_r442108531", "bodyText": "Let's remove this check and always insert the telemetry enabled property on engine startup. We probably also don't need to pass the flag to the command since we can access the engine config inside the command.", "author": "tasso94", "createdAt": "2020-06-18T09:53:39Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/ProcessEngineImpl.java", "diffHunk": "@@ -144,6 +145,10 @@ public ProcessEngineImpl(ProcessEngineConfigurationImpl processEngineConfigurati\n   protected void executeSchemaOperations() {\n     commandExecutorSchemaOperations.execute(processEngineConfiguration.getSchemaOperationsCommand());\n     commandExecutorSchemaOperations.execute(processEngineConfiguration.getHistoryLevelCommand());\n+    \n+    if (processEngineConfiguration.isTelemetryEnabled()) {", "originalCommit": "9fda8ea6ae8f689322a9c4186348040d67612a7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1eac762aa3733536e938a1a6886c5f5604c591f4", "url": "https://github.com/camunda/camunda-bpm-platform/commit/1eac762aa3733536e938a1a6886c5f5604c591f4", "message": "chore(engine): init/update telemetry property in bootstrap command", "committedDate": "2020-06-19T09:36:12Z", "type": "commit"}, {"oid": "fcfce8f515a6fe75cbdda943ec79bb60fd5b48ca", "url": "https://github.com/camunda/camunda-bpm-platform/commit/fcfce8f515a6fe75cbdda943ec79bb60fd5b48ca", "message": "chore(upgrade-scripts): remove TODO comment", "committedDate": "2020-06-19T09:40:58Z", "type": "commit"}, {"oid": "fbebac66a678a64806758a769ada849ef72fde94", "url": "https://github.com/camunda/camunda-bpm-platform/commit/fbebac66a678a64806758a769ada849ef72fde94", "message": "chore(engine): remove TODO comment in telemetry helper", "committedDate": "2020-06-19T09:46:47Z", "type": "commit"}, {"oid": "8fdeb4a66c26ddcddc70fc6daae4ea9760ecdcb2", "url": "https://github.com/camunda/camunda-bpm-platform/commit/8fdeb4a66c26ddcddc70fc6daae4ea9760ecdcb2", "message": "chore(engine): expose insert entity in the property manager", "committedDate": "2020-06-19T09:57:06Z", "type": "commit"}, {"oid": "fd5bba65a95375531ed53b73ce779ecc34506fba", "url": "https://github.com/camunda/camunda-bpm-platform/commit/fd5bba65a95375531ed53b73ce779ecc34506fba", "message": "fix(test): adjust test according to the default behaviour", "committedDate": "2020-06-19T11:41:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgyMDU0Mw==", "url": "https://github.com/camunda/camunda-bpm-platform/pull/859#discussion_r442820543", "bodyText": "Nice dirty check! :)", "author": "tasso94", "createdAt": "2020-06-19T12:48:42Z", "path": "engine/src/main/java/org/camunda/bpm/engine/impl/BootstrapEngineCommand.java", "diffHunk": "@@ -85,4 +89,50 @@ protected boolean isHistoryCleanupEnabled(CommandContext commandContext) {\n         .isHistoryCleanupEnabled();\n   }\n \n+  public void configureTelemetryProperty(CommandContext commandContext) {\n+    try {\n+\n+      checkTelemetryLockExists(commandContext);\n+\n+      commandContext.getPropertyManager().acquireExclusiveLockForTelemetry();\n+      PropertyEntity databaseTelemetryProperty = databaseTelemetryConfiguration(commandContext);\n+\n+      if (databaseTelemetryProperty == null) {\n+        LOG.noTelemetryPropertyFound();\n+        createTelemetryProperty(commandContext);\n+      } else {\n+        boolean oldValue = Boolean.parseBoolean(databaseTelemetryProperty.getValue());\n+        boolean currentValue = Context.getProcessEngineConfiguration().isTelemetryEnabled();\n+        if(currentValue != oldValue) {", "originalCommit": "fd5bba65a95375531ed53b73ce779ecc34506fba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}