{"pr_number": 389, "pr_title": "Players now stick to their originally picked teams", "pr_createdAt": "2020-03-30T21:44:03Z", "pr_url": "https://github.com/PGMDev/PGM/pull/389", "timeline": [{"oid": "8a18b2c1f90c6680a9429bab08cf48bc5bdfd4f3", "url": "https://github.com/PGMDev/PGM/commit/8a18b2c1f90c6680a9429bab08cf48bc5bdfd4f3", "message": "Freeze world after match finish\n\nSigned-off-by: Eric Zeiberg <ejzeiberg@gmail.com>", "committedDate": "2020-03-29T23:33:08Z", "type": "commit"}, {"oid": "635fbf0f6bbcf826d1d43a9b0ad70da24e0e1f0e", "url": "https://github.com/PGMDev/PGM/commit/635fbf0f6bbcf826d1d43a9b0ad70da24e0e1f0e", "message": "Implement previous team tracking\n\nSigned-off-by: Eric Zeiberg <ejzeiberg@gmail.com>", "committedDate": "2020-03-30T21:25:57Z", "type": "commit"}, {"oid": "61dfe6637b19bec33026628c22b718e25213a5af", "url": "https://github.com/PGMDev/PGM/commit/61dfe6637b19bec33026628c22b718e25213a5af", "message": "Cleanup code\n\nSigned-off-by: Eric Zeiberg <ejzeiberg@gmail.com>", "committedDate": "2020-03-30T21:39:37Z", "type": "commit"}, {"oid": "5dcba9947ace7722189408ba6fd6cc3f33c105f8", "url": "https://github.com/PGMDev/PGM/commit/5dcba9947ace7722189408ba6fd6cc3f33c105f8", "message": "Replace wildcard imports\n\nSigned-off-by: Eric Zeiberg <ejzeiberg@gmail.com>", "committedDate": "2020-03-30T21:49:08Z", "type": "commit"}, {"oid": "6241f452023ab46db8a607518c62062b4f77289c", "url": "https://github.com/PGMDev/PGM/commit/6241f452023ab46db8a607518c62062b4f77289c", "message": "No need to touch this file\n\nSigned-off-by: Eric Zeiberg <ejzeiberg@gmail.com>", "committedDate": "2020-03-30T21:50:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUzMTcxNw==", "url": "https://github.com/PGMDev/PGM/pull/389#discussion_r400531717", "bodyText": "Should be MatchModule and not Module", "author": "KingOfSquares", "createdAt": "2020-03-30T22:26:30Z", "path": "core/src/main/java/tc/oc/pgm/api/Modules.java", "diffHunk": "@@ -159,6 +160,7 @@ static void registerAll() {\n     register(ObserverToolsMatchModule.class, new ObserverToolsMatchModule.Factory());\n     register(FireworkMatchModule.class, FireworkMatchModule::new);\n     register(StatsMatchModule.class, StatsMatchModule::new);\n+    register(TeamRestrictModule.class, TeamRestrictModule::new);", "originalCommit": "6241f452023ab46db8a607518c62062b4f77289c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c0eaa6500e838cd9c3185aacd19e837b517280fe", "url": "https://github.com/PGMDev/PGM/commit/c0eaa6500e838cd9c3185aacd19e837b517280fe", "message": "Rename module\n\nSigned-off-by: Eric Zeiberg <ejzeiberg@gmail.com>", "committedDate": "2020-03-31T00:47:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczOTI4NA==", "url": "https://github.com/PGMDev/PGM/pull/389#discussion_r400739284", "bodyText": "If you won't return the party unless it's a team, why don't you just store teams to start with?", "author": "Pablete1234", "createdAt": "2020-03-31T08:39:52Z", "path": "core/src/main/java/tc/oc/pgm/modules/TeamRestrictMatchModule.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package tc.oc.pgm.modules;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.UUID;\n+import org.bukkit.event.EventHandler;\n+import org.bukkit.event.EventPriority;\n+import org.bukkit.event.Listener;\n+import tc.oc.pgm.api.match.Match;\n+import tc.oc.pgm.api.match.MatchModule;\n+import tc.oc.pgm.api.match.MatchScope;\n+import tc.oc.pgm.api.party.Party;\n+import tc.oc.pgm.events.ListenerScope;\n+import tc.oc.pgm.events.PlayerJoinPartyEvent;\n+import tc.oc.pgm.teams.Team;\n+\n+@ListenerScope(MatchScope.LOADED)\n+public class TeamRestrictMatchModule implements MatchModule, Listener {\n+\n+  private final Match match;\n+  private final Map<UUID, Party> playerTeamMap = new HashMap<>();\n+\n+  public TeamRestrictMatchModule(Match match) {\n+    this.match = match;\n+  }\n+\n+  @EventHandler(priority = EventPriority.MONITOR)\n+  public void addPlayerToMatch(PlayerJoinPartyEvent event) {\n+    UUID playerID = event.getPlayer().getId();\n+    if (playerTeamMap.containsKey(playerID)\n+        && !event\n+            .getNewParty()\n+            .isObserving()) { // If player was previously on team but joins obs, keep previous team\n+      playerTeamMap.replace(playerID, event.getNewParty());\n+\n+    } else if (!playerTeamMap.containsKey(playerID)) {\n+      playerTeamMap.put(playerID, event.getNewParty());\n+    }\n+  }\n+\n+  public Map<UUID, Party> getPlayerTeamMap() {\n+    return playerTeamMap;\n+  }\n+\n+  public Team getLastTeam(UUID id) {\n+    Party lastParty = playerTeamMap.get(id);\n+    if (lastParty instanceof Team) {\n+      return (Team) lastParty;\n+    } else {\n+      return null;\n+    }", "originalCommit": "c0eaa6500e838cd9c3185aacd19e837b517280fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg2MzI3Nw==", "url": "https://github.com/PGMDev/PGM/pull/389#discussion_r400863277", "bodyText": "PlayerJoinPartyEvent returns a specific party, plus for FFA matches, you don't want to restrict someone joining. This way, only if its a team based match, will someone be restricted.", "author": "EricZeiberg", "createdAt": "2020-03-31T12:13:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczOTI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTUyMjA1OA==", "url": "https://github.com/PGMDev/PGM/pull/389#discussion_r401522058", "bodyText": "That wasn't my point. The idea is, instead of storing a Map<UUID, Party>, you should just store teams in a Map<UUID, Team> and ignore all of the adding logic if it isn't a team. Instead of testing for the type of party afterwards, test for it beforehand.", "author": "Pablete1234", "createdAt": "2020-04-01T10:43:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczOTI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4NjcxNw==", "url": "https://github.com/PGMDev/PGM/pull/389#discussion_r403386717", "bodyText": "Fixed, thanks.", "author": "EricZeiberg", "createdAt": "2020-04-03T23:46:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczOTI4NA=="}], "type": "inlineReview"}, {"oid": "353b03d106518e92b2da720e676108abeda32ec2", "url": "https://github.com/PGMDev/PGM/commit/353b03d106518e92b2da720e676108abeda32ec2", "message": "Merge branch 'master' into team-restrict", "committedDate": "2020-03-31T16:32:03Z", "type": "commit"}, {"oid": "966b45eb84dc19a6d9d95ab3f25e858479f3fd52", "url": "https://github.com/PGMDev/PGM/commit/966b45eb84dc19a6d9d95ab3f25e858479f3fd52", "message": "Rework restrict code into TeamMatchModule\n\nSigned-off-by: Eric Zeiberg <ejzeiberg@gmail.com>", "committedDate": "2020-03-31T16:50:34Z", "type": "commit"}, {"oid": "b3da1327fb827a7127dad3c77795eaafb8cb304d", "url": "https://github.com/PGMDev/PGM/commit/b3da1327fb827a7127dad3c77795eaafb8cb304d", "message": "Merge branch 'freeze-world' into team-restrict", "committedDate": "2020-03-31T17:12:42Z", "type": "commit"}, {"oid": "37d41a927c40b2828373a957591197e16391fadb", "url": "https://github.com/PGMDev/PGM/commit/37d41a927c40b2828373a957591197e16391fadb", "message": "Rework map to store teams instead of parties\n\nSigned-off-by: Eric Zeiberg <ejzeiberg@gmail.com>", "committedDate": "2020-04-03T23:45:12Z", "type": "commit"}]}