{"pr_number": 245, "pr_title": "Add soft dependency on ViaVersion", "pr_createdAt": "2020-01-18T20:42:21Z", "pr_url": "https://github.com/PGMDev/PGM/pull/245", "timeline": [{"oid": "71b46f5f911e3d2be1dfff93725b341a3b60c7ff", "url": "https://github.com/PGMDev/PGM/commit/71b46f5f911e3d2be1dfff93725b341a3b60c7ff", "message": "Add a field in MatchPlayer for the client's protocol version\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>", "committedDate": "2020-01-18T20:33:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI0OTgzMA==", "url": "https://github.com/PGMDev/PGM/pull/245#discussion_r368249830", "bodyText": "Put this in nmshacks", "author": "Pablete1234", "createdAt": "2020-01-18T21:35:40Z", "path": "src/main/java/tc/oc/pgm/match/MatchPlayerImpl.java", "diffHunk": "@@ -75,6 +78,9 @@ public MatchPlayerImpl(Match match, Player player) {\n     this.frozen = new AtomicBoolean(false);\n     this.dead = new AtomicBoolean(false);\n     this.visible = new AtomicBoolean(false);\n+    this.protocolVersion =\n+        new AtomicInteger(\n+            ((CraftPlayer) player).getHandle().playerConnection.networkManager.protocolVersion);", "originalCommit": "71b46f5f911e3d2be1dfff93725b341a3b60c7ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ca620b278d9399266f2dccd5199003eb2ecdc11d", "url": "https://github.com/PGMDev/PGM/commit/ca620b278d9399266f2dccd5199003eb2ecdc11d", "message": "Add NMSHacks#getProtocolVersion(Player)\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>", "committedDate": "2020-01-18T21:39:11Z", "type": "commit"}, {"oid": "1144a2cb3c42cdc5fde6e002448318f7d8e78bcc", "url": "https://github.com/PGMDev/PGM/commit/1144a2cb3c42cdc5fde6e002448318f7d8e78bcc", "message": "Add soft dependency on ViaVersion\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>", "committedDate": "2020-01-18T23:19:43Z", "type": "commit"}, {"oid": "8443f7412933d8161fa7a67979950d1ea3020399", "url": "https://github.com/PGMDev/PGM/commit/8443f7412933d8161fa7a67979950d1ea3020399", "message": "Refactor ViaUtils to use reflection\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>", "committedDate": "2020-01-19T03:32:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI4MzY5OA==", "url": "https://github.com/PGMDev/PGM/pull/245#discussion_r368283698", "bodyText": "This should use a logger.", "author": "TheMolkaPL", "createdAt": "2020-01-19T10:38:12Z", "path": "src/main/java/tc/oc/util/ViaUtils.java", "diffHunk": "@@ -1,16 +1,48 @@\n package tc.oc.util;\n \n-import org.bukkit.Bukkit;\n+import java.lang.reflect.Method;\n import org.bukkit.entity.Player;\n+import tc.oc.pgm.api.PGM;\n import tc.oc.world.NMSHacks;\n-import us.myles.ViaVersion.api.Via;\n \n public class ViaUtils {\n+  private static boolean enabled;\n+  private static Object viaAPI;\n+  private static Method getPlayerVersion;\n+\n+  static {\n+    try {\n+      viaAPI = Class.forName(\"us.myles.ViaVersion.api.Via\").getMethod(\"getAPI\").invoke(null);\n+      getPlayerVersion =\n+          Class.forName(\"us.myles.ViaVersion.api.ViaAPI\")\n+              .getMethod(\"getPlayerVersion\", Object.class);\n+      enabled = true;\n+    } catch (Exception e) {\n+      PGM.get().getLogger().warning(\"ViaVersion is not installed\");\n+      e.printStackTrace();\n+      enabled = false;\n+    }\n+  }\n+\n   public static boolean enabled() {\n-    return Bukkit.getServer().getPluginManager().getPlugin(\"ViaVersion\") != null;\n+    return enabled;\n   }\n \n+  /**\n+   * @see <a\n+   *     href=\"https://wiki.vg/Protocol_version_numbers\">https://wiki.vg/Protocol_version_numbers</a>\n+   */\n   public static int getProtocolVersion(Player player) {\n-    return enabled() ? Via.getAPI().getPlayerVersion(player) : NMSHacks.getProtocolVersion(player);\n+    int version = NMSHacks.getProtocolVersion(player);\n+    if (enabled()) {\n+      try {\n+        return (int) getPlayerVersion.invoke(viaAPI, player);\n+      } catch (Exception e) {\n+        e.printStackTrace();", "originalCommit": "8443f7412933d8161fa7a67979950d1ea3020399", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4823cea77dd1419be8b563111495766ef740c43a", "url": "https://github.com/PGMDev/PGM/commit/4823cea77dd1419be8b563111495766ef740c43a", "message": "Revert changes to pom.xml\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>", "committedDate": "2020-01-19T16:20:26Z", "type": "commit"}, {"oid": "a0005da1a81acfc5da49a592c6b1dd55f63a2aab", "url": "https://github.com/PGMDev/PGM/commit/a0005da1a81acfc5da49a592c6b1dd55f63a2aab", "message": "Refactor ViaUtils to not use reflection\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>", "committedDate": "2020-01-19T19:03:24Z", "type": "commit"}, {"oid": "fe490dd9d3242f11af54da6a7b4db07e01835001", "url": "https://github.com/PGMDev/PGM/commit/fe490dd9d3242f11af54da6a7b4db07e01835001", "message": "Minor change to ViaUtils and remove debug println\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>", "committedDate": "2020-01-19T19:39:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMyODQ4MQ==", "url": "https://github.com/PGMDev/PGM/pull/245#discussion_r368328481", "bodyText": "Can you leave the * import?", "author": "TheMolkaPL", "createdAt": "2020-01-19T22:33:50Z", "path": "src/main/java/tc/oc/pgm/listeners/PGMListener.java", "diffHunk": "@@ -1,6 +1,6 @@\n package tc.oc.pgm.listeners;\n \n-import static com.google.common.base.Preconditions.*;\n+import static com.google.common.base.Preconditions.checkNotNull;", "originalCommit": "fe490dd9d3242f11af54da6a7b4db07e01835001", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "787b537e577ac9847675ddc9976e4a98b2582385", "url": "https://github.com/PGMDev/PGM/commit/787b537e577ac9847675ddc9976e4a98b2582385", "message": "Undo change made by IDE\n\nSigned-off-by: Meeples10 <8867705+Meeples10@users.noreply.github.com>", "committedDate": "2020-01-19T22:35:27Z", "type": "commit"}, {"oid": "ed70f55c744b0bda245012df6179fbe470669df2", "url": "https://github.com/PGMDev/PGM/commit/ed70f55c744b0bda245012df6179fbe470669df2", "message": "Merge branch 'master' into add-player-protocols", "committedDate": "2020-01-21T03:51:40Z", "type": "commit"}, {"oid": "082a0e0f2e2dcb7ffc425b4f2c90547565e45535", "url": "https://github.com/PGMDev/PGM/commit/082a0e0f2e2dcb7ffc425b4f2c90547565e45535", "message": "Merge branch 'master' into add-player-protocols", "committedDate": "2020-01-27T02:35:36Z", "type": "commit"}]}