{"pr_number": 2150, "pr_title": "Switch to using an explicit executor for async runner", "pr_createdAt": "2020-06-15T04:27:49Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2150", "timeline": [{"oid": "3602855209ae4ab9abd43bf2bc6102562dec73ea", "url": "https://github.com/ConsenSys/teku/commit/3602855209ae4ab9abd43bf2bc6102562dec73ea", "message": "Switch to using an explicit executor for async runner and track metrics around queue sizes.\nAlso catches exceptions thrown by the supplier and reports them back via the returned future.", "committedDate": "2020-06-15T04:24:01Z", "type": "commit"}, {"oid": "5bfc4ef5a11f6813408761dcb14730a7ad86970e", "url": "https://github.com/ConsenSys/teku/commit/5bfc4ef5a11f6813408761dcb14730a7ad86970e", "message": "Spotless.", "committedDate": "2020-06-15T04:30:51Z", "type": "commit"}, {"oid": "458b4b4f6089559b73793beb205a28b9bdd50581", "url": "https://github.com/ConsenSys/teku/commit/458b4b4f6089559b73793beb205a28b9bdd50581", "message": "Suppress warning.", "committedDate": "2020-06-15T04:37:09Z", "type": "commit"}, {"oid": "4b9f72ae42e941224db86ac73ff7a6debca77a51", "url": "https://github.com/ConsenSys/teku/commit/4b9f72ae42e941224db86ac73ff7a6debca77a51", "message": "Use a single threaded ScheduledExecutorService to schedule tasks but an expandable pool of worker threads to actually execute them.\nScheduledThreadPoolExecutor always uses a fixed number of threads which is not suitable for our use case.", "committedDate": "2020-06-15T06:53:49Z", "type": "commit"}, {"oid": "63177a121a8ddd07c754c4805f3c3049ab6d2e78", "url": "https://github.com/ConsenSys/teku/commit/63177a121a8ddd07c754c4805f3c3049ab6d2e78", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into executor-metrics", "committedDate": "2020-06-17T23:52:59Z", "type": "commit"}, {"oid": "926d10e0b5d462d63aac000eff17b7d9036b8f3e", "url": "https://github.com/ConsenSys/teku/commit/926d10e0b5d462d63aac000eff17b7d9036b8f3e", "message": "Add a limit to all thread pools to avoid excessive thread creation.\nExplicitly shutdown thread pools.", "committedDate": "2020-06-18T01:13:35Z", "type": "commit"}, {"oid": "c94be9d13ff4145913dee83507008f1f9f8fc1aa", "url": "https://github.com/ConsenSys/teku/commit/c94be9d13ff4145913dee83507008f1f9f8fc1aa", "message": "Order shutdown to avoid errors because resources are released while events are still firing.", "committedDate": "2020-06-18T01:29:03Z", "type": "commit"}, {"oid": "fd3135bb72d3b0d77af54dc9fa44e321a11b65d2", "url": "https://github.com/ConsenSys/teku/commit/fd3135bb72d3b0d77af54dc9fa44e321a11b65d2", "message": "Add tests.  Undo temp name change.", "committedDate": "2020-06-18T03:41:05Z", "type": "commit"}, {"oid": "f9fcd92f5d2c722cbda8f88892f19fbb72467038", "url": "https://github.com/ConsenSys/teku/commit/f9fcd92f5d2c722cbda8f88892f19fbb72467038", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into executor-metrics", "committedDate": "2020-06-18T03:41:19Z", "type": "commit"}, {"oid": "dcb48cd51f6ce2a1352180b814152f4a6f55c5c2", "url": "https://github.com/ConsenSys/teku/commit/dcb48cd51f6ce2a1352180b814152f4a6f55c5c2", "message": "Spotless", "committedDate": "2020-06-18T03:46:49Z", "type": "commit"}, {"oid": "1212649f42d4f8df66e19d65d91d243945199047", "url": "https://github.com/ConsenSys/teku/commit/1212649f42d4f8df66e19d65d91d243945199047", "message": "Log when we ignore tasks due to shutdown.", "committedDate": "2020-06-18T03:47:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI5OTcwNw==", "url": "https://github.com/ConsenSys/teku/pull/2150#discussion_r442299707", "bodyText": "Should we not be returning a failed future here?", "author": "cemozerr", "createdAt": "2020-06-18T15:08:46Z", "path": "services/serviceutils/src/main/java/tech/pegasys/teku/service/serviceutils/ScheduledExecutorAsyncRunner.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.service.serviceutils;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.SynchronousQueue;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n+import tech.pegasys.teku.metrics.TekuMetricCategory;\n+import tech.pegasys.teku.util.async.AsyncRunner;\n+import tech.pegasys.teku.util.async.SafeFuture;\n+\n+class ScheduledExecutorAsyncRunner implements AsyncRunner {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final AtomicBoolean shutdown = new AtomicBoolean(false);\n+  private final ScheduledExecutorService scheduler;\n+  private final ExecutorService workerPool;\n+\n+  ScheduledExecutorAsyncRunner(\n+      final ScheduledExecutorService scheduler, final ExecutorService workerPool) {\n+    this.scheduler = scheduler;\n+    this.workerPool = workerPool;\n+  }\n+\n+  static AsyncRunner create(\n+      final String name, final int maxThreads, final MetricsSystem metricsSystem) {\n+    final ScheduledExecutorService scheduler =\n+        Executors.newSingleThreadScheduledExecutor(\n+            new ThreadFactoryBuilder()\n+                .setNameFormat(name + \"-async-scheduler-%d\")\n+                .setDaemon(true)\n+                .build());\n+    final ThreadPoolExecutor workerPool =\n+        new ThreadPoolExecutor(\n+            1,\n+            maxThreads,\n+            60,\n+            TimeUnit.SECONDS,\n+            new SynchronousQueue<>(),\n+            new ThreadFactoryBuilder().setNameFormat(name + \"-async-%d\").setDaemon(true).build());\n+\n+    metricsSystem.createIntegerGauge(\n+        TekuMetricCategory.EXECUTOR,\n+        name + \"_queue_size\",\n+        \"Current size of the executor task queue\",\n+        () -> workerPool.getQueue().size());\n+    metricsSystem.createIntegerGauge(\n+        TekuMetricCategory.EXECUTOR,\n+        name + \"_thread_pool_size\",\n+        \"Current number of threads in the executor thread pool\",\n+        workerPool::getPoolSize);\n+    metricsSystem.createIntegerGauge(\n+        TekuMetricCategory.EXECUTOR,\n+        name + \"_thread_active_count\",\n+        \"Current number of threads executing tasks for this executor\",\n+        workerPool::getActiveCount);\n+\n+    return new ScheduledExecutorAsyncRunner(scheduler, workerPool);\n+  }\n+\n+  @Override\n+  public <U> SafeFuture<U> runAsync(final Supplier<SafeFuture<U>> action) {\n+    return runTask(action, workerPool::execute);\n+  }\n+\n+  @Override\n+  @SuppressWarnings(\"FutureReturnValueIgnored\")\n+  public <U> SafeFuture<U> runAfterDelay(\n+      final Supplier<SafeFuture<U>> action, final long delayAmount, final TimeUnit delayUnit) {\n+    return runTask(\n+        action, task -> scheduler.schedule(() -> workerPool.execute(task), delayAmount, delayUnit));\n+  }\n+\n+  @Override\n+  public void shutdown() {\n+    // All threads are daemon threads so don't wait for them to actually stop\n+    shutdown.set(true);\n+    scheduler.shutdownNow();\n+    workerPool.shutdownNow();\n+  }\n+\n+  private <U> SafeFuture<U> runTask(\n+      final Supplier<SafeFuture<U>> action, final Consumer<Runnable> scheduler) {\n+    if (shutdown.get()) {\n+      LOG.debug(\"Ignoring async task because shutdown is in progress\");\n+      return new SafeFuture<>();", "originalCommit": "1212649f42d4f8df66e19d65d91d243945199047", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ5NzU1Mw==", "url": "https://github.com/ConsenSys/teku/pull/2150#discussion_r442497553", "bodyText": "No we're deliberately just not executing the task.  This is the same as if the task had been submitted before shutdown but hadn't yet been executed - we'd shutdown without ever completing the future.  Otherwise we have to go round the code base ignoring RejectedExecutionException everywhere.", "author": "ajsutton", "createdAt": "2020-06-18T20:56:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI5OTcwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMxMjk4OA==", "url": "https://github.com/ConsenSys/teku/pull/2150#discussion_r442312988", "bodyText": "nit: The argument name scheduler here is a bit confusing since we have a ScheduledExecutorService object used in this class with the variable name scheduler. Can we rename this to something similar to runner?", "author": "cemozerr", "createdAt": "2020-06-18T15:27:56Z", "path": "services/serviceutils/src/main/java/tech/pegasys/teku/service/serviceutils/ScheduledExecutorAsyncRunner.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.service.serviceutils;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.SynchronousQueue;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n+import tech.pegasys.teku.metrics.TekuMetricCategory;\n+import tech.pegasys.teku.util.async.AsyncRunner;\n+import tech.pegasys.teku.util.async.SafeFuture;\n+\n+class ScheduledExecutorAsyncRunner implements AsyncRunner {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private final AtomicBoolean shutdown = new AtomicBoolean(false);\n+  private final ScheduledExecutorService scheduler;\n+  private final ExecutorService workerPool;\n+\n+  ScheduledExecutorAsyncRunner(\n+      final ScheduledExecutorService scheduler, final ExecutorService workerPool) {\n+    this.scheduler = scheduler;\n+    this.workerPool = workerPool;\n+  }\n+\n+  static AsyncRunner create(\n+      final String name, final int maxThreads, final MetricsSystem metricsSystem) {\n+    final ScheduledExecutorService scheduler =\n+        Executors.newSingleThreadScheduledExecutor(\n+            new ThreadFactoryBuilder()\n+                .setNameFormat(name + \"-async-scheduler-%d\")\n+                .setDaemon(true)\n+                .build());\n+    final ThreadPoolExecutor workerPool =\n+        new ThreadPoolExecutor(\n+            1,\n+            maxThreads,\n+            60,\n+            TimeUnit.SECONDS,\n+            new SynchronousQueue<>(),\n+            new ThreadFactoryBuilder().setNameFormat(name + \"-async-%d\").setDaemon(true).build());\n+\n+    metricsSystem.createIntegerGauge(\n+        TekuMetricCategory.EXECUTOR,\n+        name + \"_queue_size\",\n+        \"Current size of the executor task queue\",\n+        () -> workerPool.getQueue().size());\n+    metricsSystem.createIntegerGauge(\n+        TekuMetricCategory.EXECUTOR,\n+        name + \"_thread_pool_size\",\n+        \"Current number of threads in the executor thread pool\",\n+        workerPool::getPoolSize);\n+    metricsSystem.createIntegerGauge(\n+        TekuMetricCategory.EXECUTOR,\n+        name + \"_thread_active_count\",\n+        \"Current number of threads executing tasks for this executor\",\n+        workerPool::getActiveCount);\n+\n+    return new ScheduledExecutorAsyncRunner(scheduler, workerPool);\n+  }\n+\n+  @Override\n+  public <U> SafeFuture<U> runAsync(final Supplier<SafeFuture<U>> action) {\n+    return runTask(action, workerPool::execute);\n+  }\n+\n+  @Override\n+  @SuppressWarnings(\"FutureReturnValueIgnored\")\n+  public <U> SafeFuture<U> runAfterDelay(\n+      final Supplier<SafeFuture<U>> action, final long delayAmount, final TimeUnit delayUnit) {\n+    return runTask(\n+        action, task -> scheduler.schedule(() -> workerPool.execute(task), delayAmount, delayUnit));\n+  }\n+\n+  @Override\n+  public void shutdown() {\n+    // All threads are daemon threads so don't wait for them to actually stop\n+    shutdown.set(true);\n+    scheduler.shutdownNow();\n+    workerPool.shutdownNow();\n+  }\n+\n+  private <U> SafeFuture<U> runTask(\n+      final Supplier<SafeFuture<U>> action, final Consumer<Runnable> scheduler) {", "originalCommit": "1212649f42d4f8df66e19d65d91d243945199047", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM1MjczNQ==", "url": "https://github.com/ConsenSys/teku/pull/2150#discussion_r442352735", "bodyText": "Nice.", "author": "cemozerr", "createdAt": "2020-06-18T16:27:46Z", "path": "sync/src/main/java/tech/pegasys/teku/sync/SyncManager.java", "diffHunk": "@@ -193,7 +194,12 @@ public SyncingStatus getSyncStatus() {\n             })\n         .exceptionally(\n             error -> {\n-              LOG.error(\"Error during sync to peer \" + syncPeer, error);\n+              if (Throwables.getRootCause(error) instanceof PeerDisconnectedException) {", "originalCommit": "1212649f42d4f8df66e19d65d91d243945199047", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "34876b172154bea2f79cf38817937328084bcb0c", "url": "https://github.com/ConsenSys/teku/commit/34876b172154bea2f79cf38817937328084bcb0c", "message": "Rename.", "committedDate": "2020-06-18T20:58:25Z", "type": "commit"}, {"oid": "b35272c27687d00cbbfd1377cfd27f37d9f144c5", "url": "https://github.com/ConsenSys/teku/commit/b35272c27687d00cbbfd1377cfd27f37d9f144c5", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into executor-metrics", "committedDate": "2020-06-18T20:58:32Z", "type": "commit"}]}