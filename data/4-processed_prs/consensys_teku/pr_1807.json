{"pr_number": 1807, "pr_title": "[BC-415] Rework getBlockInEffectAtSlot", "pr_createdAt": "2020-05-18T19:56:25Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1807", "timeline": [{"oid": "5e053d5b93e956ba216a1a392a024f020eb11e0f", "url": "https://github.com/ConsenSys/teku/commit/5e053d5b93e956ba216a1a392a024f020eb11e0f", "message": "Add ability to contrain blockRootBySlot query by head root", "committedDate": "2020-05-18T15:59:53Z", "type": "commit"}, {"oid": "a3c0a1a6512a32f66d286907b4672e3686993f7a", "url": "https://github.com/ConsenSys/teku/commit/a3c0a1a6512a32f66d286907b4672e3686993f7a", "message": "Rework CombinedChainDataClient query block by slot methods", "committedDate": "2020-05-18T15:59:53Z", "type": "commit"}, {"oid": "0f6103e79640003c176f0061d3b63f6c42e20f43", "url": "https://github.com/ConsenSys/teku/commit/0f6103e79640003c176f0061d3b63f6c42e20f43", "message": "Add ability to \"restart\" InMemoryStorageSystem", "committedDate": "2020-05-18T19:38:35Z", "type": "commit"}, {"oid": "a109b95760397e65e5de4954982386fa233084d9", "url": "https://github.com/ConsenSys/teku/commit/a109b95760397e65e5de4954982386fa233084d9", "message": "Add / fix / migrate tests", "committedDate": "2020-05-18T19:38:46Z", "type": "commit"}, {"oid": "b9a9b7f3131d373d9ee2a4e1561cf88cb9c0487a", "url": "https://github.com/ConsenSys/teku/commit/b9a9b7f3131d373d9ee2a4e1561cf88cb9c0487a", "message": "Fix typo", "committedDate": "2020-05-19T15:18:50Z", "type": "commit"}, {"oid": "c9bf9315168493ba309c6543eaf46a9214b1a8c3", "url": "https://github.com/ConsenSys/teku/commit/c9bf9315168493ba309c6543eaf46a9214b1a8c3", "message": "Fix getBlockBySlot query", "committedDate": "2020-05-19T17:16:52Z", "type": "commit"}, {"oid": "3e3510d2ab79b161eb8cf000c37cb2086c3174cb", "url": "https://github.com/ConsenSys/teku/commit/3e3510d2ab79b161eb8cf000c37cb2086c3174cb", "message": "Fix / rework REST API integration tests", "committedDate": "2020-05-19T17:39:22Z", "type": "commit"}, {"oid": "cd95f83f980446198cc3be0e7b35aa4cbb771834", "url": "https://github.com/ConsenSys/teku/commit/cd95f83f980446198cc3be0e7b35aa4cbb771834", "message": "Merge branch 'master' into bc-415/rework-get-block-in-effect-at-slot", "committedDate": "2020-05-19T17:41:00Z", "type": "commit"}, {"oid": "cd95f83f980446198cc3be0e7b35aa4cbb771834", "url": "https://github.com/ConsenSys/teku/commit/cd95f83f980446198cc3be0e7b35aa4cbb771834", "message": "Merge branch 'master' into bc-415/rework-get-block-in-effect-at-slot", "committedDate": "2020-05-19T17:41:00Z", "type": "forcePushed"}, {"oid": "ff7e64f118df27dd7517917d4f35bd021bf20cd0", "url": "https://github.com/ConsenSys/teku/commit/ff7e64f118df27dd7517917d4f35bd021bf20cd0", "message": "Clean up comments", "committedDate": "2020-05-19T18:03:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzcwMTQyNA==", "url": "https://github.com/ConsenSys/teku/pull/1807#discussion_r427701424", "bodyText": "nit: Probably don't need the empty comment.", "author": "ajsutton", "createdAt": "2020-05-20T02:08:26Z", "path": "storage/src/test/java/tech/pegasys/teku/storage/client/RecentChainDataTest.java", "diffHunk": "@@ -631,6 +631,55 @@ public void getBlockRootBySlot_queryEntireChain() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void getBlockRootBySlotWithHeadRoot_forSlotAfterHeadRoot() throws Exception {\n+    final SignedBlockAndState targetBlock = advanceBestBlock(storageClient);\n+    final SignedBlockAndState bestBlock = advanceBestBlock(storageClient);\n+\n+    assertThat(storageClient.getBlockRootBySlot(bestBlock.getSlot(), targetBlock.getRoot()))\n+        .contains(targetBlock.getRoot());\n+  }\n+\n+  @Test\n+  public void getBlockRootBySlotWithHeadRoot_forUnknownHeadRoot() throws Exception {\n+    final Bytes32 headRoot = dataStructureUtil.randomBytes32();\n+    final SignedBlockAndState bestBlock = advanceBestBlock(storageClient);\n+\n+    assertThat(storageClient.getBlockRootBySlot(bestBlock.getSlot(), headRoot)).isEmpty();\n+  }\n+\n+  @Test\n+  public void getBlockRootBySlotWithHeadRoot_withForkRoot() throws Exception {\n+    // Build small chain\n+    for (int i = 0; i < 5; i++) {\n+      advanceChain(storageClient);\n+    }\n+\n+    // Split the chain\n+    final ChainBuilder fork = chainBuilder.fork();\n+    final UnsignedLong chainSplitSlot = chainBuilder.getLatestSlot();\n+    for (int i = 0; i < 5; i++) {\n+      final UnsignedLong canonicalBlockSlot = chainSplitSlot.plus(UnsignedLong.valueOf(i * 2 + 2));\n+      final UnsignedLong forkSlot = chainSplitSlot.plus(UnsignedLong.valueOf(i * 2 + 1));\n+      updateBestBlock(storageClient, chainBuilder.generateBlockAtSlot(canonicalBlockSlot));\n+      saveBlock(storageClient, fork.generateBlockAtSlot(forkSlot));\n+    }\n+\n+    final Bytes32 headRoot = fork.getLatestBlockAndState().getRoot();\n+    for (int i = 0; i < fork.getLatestSlot().intValue(); i++) {\n+      //", "originalCommit": "ff7e64f118df27dd7517917d4f35bd021bf20cd0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "473fa918d44ed0d128f28d1eea36c8758765ee30", "url": "https://github.com/ConsenSys/teku/commit/473fa918d44ed0d128f28d1eea36c8758765ee30", "message": "Merge branch 'master' into bc-415/rework-get-block-in-effect-at-slot", "committedDate": "2020-05-20T15:50:28Z", "type": "commit"}, {"oid": "c55491dc9cd2c706a18c3617a10fb238b1673fe9", "url": "https://github.com/ConsenSys/teku/commit/c55491dc9cd2c706a18c3617a10fb238b1673fe9", "message": "Cut empty comment", "committedDate": "2020-05-20T15:51:41Z", "type": "commit"}]}