{"pr_number": 2419, "pr_title": "[Issue 2291] Rework fork choice initialization", "pr_createdAt": "2020-07-21T22:33:19Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2419", "timeline": [{"oid": "80f0ee05adebade8a78dc21dd03d25e1558fcb81", "url": "https://github.com/ConsenSys/teku/commit/80f0ee05adebade8a78dc21dd03d25e1558fcb81", "message": "Add method for streaming HashTree nodes in breadth-first order", "committedDate": "2020-07-21T22:20:32Z", "type": "commit"}, {"oid": "addcb26894ee36e6faa303e333a021abc6b629df", "url": "https://github.com/ConsenSys/teku/commit/addcb26894ee36e6faa303e333a021abc6b629df", "message": "Add Store.getOrderedBlockRoots()", "committedDate": "2020-07-21T22:20:32Z", "type": "commit"}, {"oid": "188399e0b42aa6b645138029b1b51c82ee1a05f0", "url": "https://github.com/ConsenSys/teku/commit/188399e0b42aa6b645138029b1b51c82ee1a05f0", "message": "Update TestStoreFactory to return MutablePrunableStore", "committedDate": "2020-07-21T22:20:32Z", "type": "commit"}, {"oid": "249192eb936ac2396e3c60e3f58fa8624df28655", "url": "https://github.com/ConsenSys/teku/commit/249192eb936ac2396e3c60e3f58fa8624df28655", "message": "Fix Store.Transaction.getOrderedBlockRoots()", "committedDate": "2020-07-21T22:20:32Z", "type": "commit"}, {"oid": "cb3a1c1e0e427bca513a765571a60b0262db2984", "url": "https://github.com/ConsenSys/teku/commit/cb3a1c1e0e427bca513a765571a60b0262db2984", "message": "Use async block retrieval methods to init ProtoArray", "committedDate": "2020-07-21T22:20:33Z", "type": "commit"}, {"oid": "5490d93cf8fcc4a40b1a3136c8d4a7fa8b188ebf", "url": "https://github.com/ConsenSys/teku/commit/5490d93cf8fcc4a40b1a3136c8d4a7fa8b188ebf", "message": "Clarify comment", "committedDate": "2020-07-21T22:20:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ4MzM4MA==", "url": "https://github.com/ConsenSys/teku/pull/2419#discussion_r458483380", "bodyText": "If the blocks are immediately available, do we have a risk of a stack overflow exception here because of the number of chained futures?  I think at worst we'd have 10 epochs worth of blocks held in memory so 320 blocks.\nProbably worth having a test for it, or just deliberately use a thenAcceptAsync variant. Not sure if using the default fork choice pool is sensible here or if we should ensure it goes onto one of the threads own by an AsyncRunner or not (which would require a new method in SafeFuture to support).", "author": "ajsutton", "createdAt": "2020-07-22T01:39:05Z", "path": "protoarray/src/main/java/tech/pegasys/teku/protoarray/ProtoArrayForkChoiceStrategy.java", "diffHunk": "@@ -144,27 +145,38 @@ public void maybePrune(Bytes32 finalizedRoot) {\n   }\n \n   // Internal\n-  private static void processBlocksInStoreAtStartup(ReadOnlyStore store, ProtoArray protoArray) {\n+  private static SafeFuture<Void> processBlocksInStoreAtStartup(\n+      PrunableStore store, ProtoArray protoArray) {\n     List<Bytes32> alreadyIncludedBlockRoots =\n         protoArray.getNodes().stream().map(ProtoNode::getBlockRoot).collect(Collectors.toList());\n \n-    store.getBlockRoots().stream()\n-        .filter(root -> !alreadyIncludedBlockRoots.contains(root))\n-        .map(store::getBlock)\n-        .sorted(Comparator.comparing(BeaconBlock::getSlot))\n-        .forEach(block -> processBlockAtStartup(store, protoArray, block));\n+    SafeFuture<Void> future = SafeFuture.completedFuture(null);\n+    for (Bytes32 blockRoot : store.getOrderedBlockRoots()) {\n+      if (alreadyIncludedBlockRoots.contains(blockRoot)) {\n+        continue;\n+      }\n+      future =\n+          future.thenCompose(\n+              __ ->\n+                  store\n+                      .retrieveBlockAndState(blockRoot)\n+                      .thenAccept(\n+                          blockAndState ->\n+                              blockAndState.ifPresent(b -> processBlockAtStartup(protoArray, b))));\n+    }\n+    return future;", "originalCommit": "5490d93cf8fcc4a40b1a3136c8d4a7fa8b188ebf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwOTc0OQ==", "url": "https://github.com/ConsenSys/teku/pull/2419#discussion_r459009749", "bodyText": "Also, if the blockAndState is not in Store, should we throw an error?", "author": "cemozerr", "createdAt": "2020-07-22T18:49:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ4MzM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxMjg0NA==", "url": "https://github.com/ConsenSys/teku/pull/2419#discussion_r459012844", "bodyText": "I don't think there's any risk of stack overflow because we're just constructing this chain of futures in a for loop without invoking any methods recursively.  Added a test that processes a few thousand blocks to confirm - ran it locally with 10k blocks and it worked fine.", "author": "mbaxter", "createdAt": "2020-07-22T18:54:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ4MzM4MA=="}], "type": "inlineReview"}, {"oid": "47aed893d1b75c671d2a5bc11cd917895dcb2562", "url": "https://github.com/ConsenSys/teku/commit/47aed893d1b75c671d2a5bc11cd917895dcb2562", "message": "Remove redundant dependency", "committedDate": "2020-07-22T14:47:52Z", "type": "commit"}, {"oid": "f4400b9a5c18c6822c071dc1d757ca9814188f18", "url": "https://github.com/ConsenSys/teku/commit/f4400b9a5c18c6822c071dc1d757ca9814188f18", "message": "Move static helper method to a separate class", "committedDate": "2020-07-22T15:35:41Z", "type": "commit"}, {"oid": "6d0645e9f2d39ac5665be8b104bd4f7aa0f622ee", "url": "https://github.com/ConsenSys/teku/commit/6d0645e9f2d39ac5665be8b104bd4f7aa0f622ee", "message": "Merge branch 'master' into issue-2291/rework-fork-choice-init", "committedDate": "2020-07-22T15:54:26Z", "type": "commit"}, {"oid": "d38e719d12e6e3bd93bcf75ef07239dc61979cf7", "url": "https://github.com/ConsenSys/teku/commit/d38e719d12e6e3bd93bcf75ef07239dc61979cf7", "message": "Add test initializing forkChoice with a large number of blocks", "committedDate": "2020-07-22T18:45:21Z", "type": "commit"}, {"oid": "c85eef9138a094aea407b65b5fec85679d7d7ee1", "url": "https://github.com/ConsenSys/teku/commit/c85eef9138a094aea407b65b5fec85679d7d7ee1", "message": "Cut unused logger", "committedDate": "2020-07-22T18:45:42Z", "type": "commit"}, {"oid": "8381695270b6ed9631f2d94581a707741e084d26", "url": "https://github.com/ConsenSys/teku/commit/8381695270b6ed9631f2d94581a707741e084d26", "message": "Throw if Store is missing blocks at startup", "committedDate": "2020-07-22T19:02:29Z", "type": "commit"}]}