{"pr_number": 3106, "pr_title": "Move all object validation to state transition package", "pr_createdAt": "2020-10-28T18:51:28Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3106", "timeline": [{"oid": "a74f2ed88f958aeedb2575eb75657dd8f3a2dc62", "url": "https://github.com/ConsenSys/teku/commit/a74f2ed88f958aeedb2575eb75657dd8f3a2dc62", "message": "Move validation to state transition package level", "committedDate": "2020-10-28T18:54:10Z", "type": "commit"}, {"oid": "237623451e6a0ba36ca3b28a36c45037d158b3d2", "url": "https://github.com/ConsenSys/teku/commit/237623451e6a0ba36ca3b28a36c45037d158b3d2", "message": "Remove individual topic handler classes and fix tests", "committedDate": "2020-10-28T18:54:16Z", "type": "commit"}, {"oid": "580461385e65c7e1f47ab5c5b134c288b5941fdf", "url": "https://github.com/ConsenSys/teku/commit/580461385e65c7e1f47ab5c5b134c288b5941fdf", "message": "Run spotless", "committedDate": "2020-10-28T18:54:16Z", "type": "commit"}, {"oid": "580461385e65c7e1f47ab5c5b134c288b5941fdf", "url": "https://github.com/ConsenSys/teku/commit/580461385e65c7e1f47ab5c5b134c288b5941fdf", "message": "Run spotless", "committedDate": "2020-10-28T18:54:16Z", "type": "forcePushed"}, {"oid": "dcb11097c1786bd94be63eb830b3323c679084f5", "url": "https://github.com/ConsenSys/teku/commit/dcb11097c1786bd94be63eb830b3323c679084f5", "message": "Fix warning", "committedDate": "2020-10-28T19:52:47Z", "type": "commit"}, {"oid": "b1379d76f6aaeb0b4888c3db6d41bb1ee3335722", "url": "https://github.com/ConsenSys/teku/commit/b1379d76f6aaeb0b4888c3db6d41bb1ee3335722", "message": "Run spotless", "committedDate": "2020-10-28T19:55:25Z", "type": "commit"}, {"oid": "c39c1c6a87a10d01ad63931aa92353a9b2be00c5", "url": "https://github.com/ConsenSys/teku/commit/c39c1c6a87a10d01ad63931aa92353a9b2be00c5", "message": "Fix warning again", "committedDate": "2020-10-28T19:58:48Z", "type": "commit"}, {"oid": "86bc37cce035b5072f2f7e7d38168eb39420c729", "url": "https://github.com/ConsenSys/teku/commit/86bc37cce035b5072f2f7e7d38168eb39420c729", "message": "Fix warning again", "committedDate": "2020-10-28T20:01:56Z", "type": "commit"}, {"oid": "b54ecebf9f306802cefe11fda11b426bb2052a12", "url": "https://github.com/ConsenSys/teku/commit/b54ecebf9f306802cefe11fda11b426bb2052a12", "message": "Fix warning again", "committedDate": "2020-10-28T20:07:49Z", "type": "commit"}, {"oid": "57b7e86b24de08ab13fa6c769b9a788a7a9261cf", "url": "https://github.com/ConsenSys/teku/commit/57b7e86b24de08ab13fa6c769b9a788a7a9261cf", "message": "Fix warning again", "committedDate": "2020-10-28T20:10:45Z", "type": "commit"}, {"oid": "a81d3159efd30659bc393880845433e92faa9457", "url": "https://github.com/ConsenSys/teku/commit/a81d3159efd30659bc393880845433e92faa9457", "message": "Fix test bug and only run ssz_snappy tests not ssz", "committedDate": "2020-10-28T21:18:56Z", "type": "commit"}, {"oid": "c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf", "url": "https://github.com/ConsenSys/teku/commit/c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf", "message": "Run spotless", "committedDate": "2020-10-28T21:22:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0MTI0NA==", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r513841244", "bodyText": "If we already know the attestation should be saved for future, do we need to run it through the attestation processor or can it just be added to the pending pool immediately?", "author": "ajsutton", "createdAt": "2020-10-29T00:34:24Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/attestation/AttestationManager.java", "diffHunk": "@@ -49,38 +52,80 @@\n   private final Subscribers<ProcessedAttestationListener> processedAttestationSubscriber =\n       Subscribers.create(true);\n \n+  private final AttestationValidator attestationValidator;\n+  private final AggregateAttestationValidator aggregateValidator;\n+\n   AttestationManager(\n       final EventBus eventBus,\n       final ForkChoice attestationProcessor,\n       final PendingPool<ValidateableAttestation> pendingAttestations,\n       final FutureItems<ValidateableAttestation> futureAttestations,\n-      final AggregatingAttestationPool aggregatingAttestationPool) {\n+      final AggregatingAttestationPool aggregatingAttestationPool,\n+      final AttestationValidator attestationValidator,\n+      final AggregateAttestationValidator aggregateValidator) {\n     this.eventBus = eventBus;\n     this.attestationProcessor = attestationProcessor;\n     this.pendingAttestations = pendingAttestations;\n     this.futureAttestations = futureAttestations;\n     this.aggregatingAttestationPool = aggregatingAttestationPool;\n+    this.attestationValidator = attestationValidator;\n+    this.aggregateValidator = aggregateValidator;\n   }\n \n   public static AttestationManager create(\n       final EventBus eventBus,\n       final PendingPool<ValidateableAttestation> pendingAttestations,\n       final FutureItems<ValidateableAttestation> futureAttestations,\n       final ForkChoice attestationProcessor,\n-      final AggregatingAttestationPool aggregatingAttestationPool) {\n+      final AggregatingAttestationPool aggregatingAttestationPool,\n+      final AttestationValidator attestationValidator,\n+      final AggregateAttestationValidator aggregateValidator) {\n     return new AttestationManager(\n         eventBus,\n         attestationProcessor,\n         pendingAttestations,\n         futureAttestations,\n-        aggregatingAttestationPool);\n+        aggregatingAttestationPool,\n+        attestationValidator,\n+        aggregateValidator);\n   }\n \n   public void subscribeToProcessedAttestations(\n       ProcessedAttestationListener processedAttestationListener) {\n     processedAttestationSubscriber.subscribe(processedAttestationListener);\n   }\n \n+  public SafeFuture<InternalValidationResult> addAttestation(ValidateableAttestation attestation) {\n+    SafeFuture<InternalValidationResult> validationResult =\n+        attestationValidator.validate(attestation);\n+    processInternallyValidatedAttestation(validationResult, attestation);\n+    return validationResult;\n+  }\n+\n+  public SafeFuture<InternalValidationResult> addAggregate(ValidateableAttestation attestation) {\n+    SafeFuture<InternalValidationResult> validationResult =\n+        aggregateValidator.validate(attestation);\n+    processInternallyValidatedAttestation(validationResult, attestation);\n+    return validationResult;\n+  }\n+\n+  @SuppressWarnings(\"FutureReturnValueIgnored\")\n+  private void processInternallyValidatedAttestation(\n+      SafeFuture<InternalValidationResult> validationResult, ValidateableAttestation attestation) {\n+    validationResult.thenAccept(\n+        internalValidationResult -> {\n+          if (internalValidationResult.equals(InternalValidationResult.ACCEPT)\n+              || internalValidationResult.equals(InternalValidationResult.SAVE_FOR_FUTURE)) {", "originalCommit": "c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5MjQ5MA==", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r515292490", "bodyText": "Made an issue here to solve later on: #3114", "author": "cemozerr", "createdAt": "2020-10-30T18:13:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0MTI0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0MTQ4MA==", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r513841480", "bodyText": "Same as for attestations - if it's save for future should we just add it to the pending pool without further processing?", "author": "ajsutton", "createdAt": "2020-10-29T00:35:12Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/block/BlockManager.java", "diffHunk": "@@ -91,6 +98,20 @@ public static BlockManager create(\n     return doImportBlock(block);\n   }\n \n+  @SuppressWarnings(\"FutureReturnValueIgnored\")\n+  public SafeFuture<InternalValidationResult> validateAndImportBlock(\n+      final SignedBeaconBlock block) {\n+    SafeFuture<InternalValidationResult> validationResult = validator.validate(block);\n+    validationResult.thenAccept(\n+        result -> {\n+          if (result.equals(InternalValidationResult.ACCEPT)\n+              || result.equals(InternalValidationResult.SAVE_FOR_FUTURE)) {\n+            importBlock(block).finish(err -> LOG.error(\"Failed to process received block.\", err));", "originalCommit": "c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5MjUyNA==", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r515292524", "bodyText": "Made an issue here to solve later on: #3114", "author": "cemozerr", "createdAt": "2020-10-30T18:13:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0MTQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0MTgxMA==", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r513841810", "bodyText": "Why did we switch from OptionalInt to Optional<Integer>?  OptionalInt is probably better if it's possible to stick with it.", "author": "ajsutton", "createdAt": "2020-10-29T00:36:30Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/validation/AttestationValidator.java", "diffHunk": "@@ -113,7 +112,8 @@ private InternalValidationResult singleAttestationChecks(final Attestation attes\n   }\n \n   SafeFuture<InternalValidationResult> singleOrAggregateAttestationChecks(\n-      final ValidateableAttestation validateableAttestation, final OptionalInt receivedOnSubnetId) {\n+      final ValidateableAttestation validateableAttestation,\n+      final Optional<Integer> receivedOnSubnetId) {", "originalCommit": "c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0NDQ0Mw==", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r514444443", "bodyText": "Reversed.", "author": "cemozerr", "createdAt": "2020-10-29T17:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0MTgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0MzI1MQ==", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r513843251", "bodyText": "Probably shouldn't make this change as part of this PR.", "author": "ajsutton", "createdAt": "2020-10-29T00:41:38Z", "path": "networking/eth2/src/integration-test/java/tech/pegasys/teku/networking/eth2/GossipMessageHandlerIntegrationTest.java", "diffHunk": "@@ -341,7 +368,7 @@ private NodeManager createNodeManager(final Consumer<Eth2P2PNetworkBuilder> netw\n   }\n \n   public static Stream<Arguments> getEncodings() {\n-    final List<GossipEncoding> encodings = List.of(GossipEncoding.SSZ, GossipEncoding.SSZ_SNAPPY);\n+    final List<GossipEncoding> encodings = List.of(GossipEncoding.SSZ_SNAPPY);", "originalCommit": "c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0NDg0Ng==", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r514444846", "bodyText": "Reversed.", "author": "cemozerr", "createdAt": "2020-10-29T17:37:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0MzI1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0NDExOQ==", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r513844119", "bodyText": "I don't think we can afford to leave this TODO undone as we'd wind up validating more aggregates than we need to.", "author": "ajsutton", "createdAt": "2020-10-29T00:44:49Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/AggregateGossipManager.java", "diffHunk": "@@ -53,7 +51,8 @@ public void onNewAggregate(final ValidateableAttestation validateableAttestation\n     if (!validateableAttestation.isAggregate() || !validateableAttestation.markGossiped()) {\n       return;\n     }\n-    validator.addSeenAggregate(validateableAttestation);\n+    // TODO: implement adding the on new aggregate to the validator\n+    //    validator.addSeenAggregate(validateableAttestation);", "originalCommit": "c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ3NDIyMQ==", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r514474221", "bodyText": "I believe we had put this here in order to make sure we don\u2019t process aggregates that we\u2019ve created ourselves when they do come back at us. Thinking out loud, there should probably be a check for this at a lower level. I\u2019m guessing jvm-libp2p does not deliver messages that we\u2019ve created back to us.\nNevertheless, in case it doesn\u2019t, I added the functionality again. This time, after we process attestations at the AttestationManager, for in-house produced attestations, we call attestation and aggregate validators methods to mark them as seen. I saw no reason for calling .addSeen for aggregates and not for single attestations so I added that as well.", "author": "cemozerr", "createdAt": "2020-10-29T18:22:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0NDExOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0NDcxMg==", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r513844712", "bodyText": "Probably should be an IllegalArgumentException.", "author": "ajsutton", "createdAt": "2020-10-29T00:46:58Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/gossip/topics/GossipSubValidationUtil.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.networking.eth2.gossip.topics;\n+\n+import io.libp2p.core.pubsub.ValidationResult;\n+import tech.pegasys.teku.statetransition.validation.InternalValidationResult;\n+\n+public class GossipSubValidationUtil {\n+\n+  public static ValidationResult fromInternalValidationResult(InternalValidationResult result) {\n+    switch (result) {\n+      case ACCEPT:\n+        return ValidationResult.Valid;\n+      case SAVE_FOR_FUTURE:\n+      case IGNORE:\n+        return ValidationResult.Ignore;\n+      case REJECT:\n+        return ValidationResult.Invalid;\n+      default:\n+        throw new UnsupportedOperationException(\"Unexpected validation result: \" + result);", "originalCommit": "c8b3c3e45f4460e8a01c2c28bb8a3aee6684edcf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0NTEwMw==", "url": "https://github.com/ConsenSys/teku/pull/3106#discussion_r514445103", "bodyText": "Donne.", "author": "cemozerr", "createdAt": "2020-10-29T17:37:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg0NDcxMg=="}], "type": "inlineReview"}, {"oid": "40310479629c88204bfc194aebc78812748d27b8", "url": "https://github.com/ConsenSys/teku/commit/40310479629c88204bfc194aebc78812748d27b8", "message": "Reverse test encodings and optionalInt changes", "committedDate": "2020-10-29T17:39:07Z", "type": "commit"}, {"oid": "7b56606fb1592146d53b9d9257f34d19ca372964", "url": "https://github.com/ConsenSys/teku/commit/7b56606fb1592146d53b9d9257f34d19ca372964", "message": "Fix optional int change", "committedDate": "2020-10-29T17:40:43Z", "type": "commit"}, {"oid": "e0fd252913f13bf1abd355ef39156891b9119c2d", "url": "https://github.com/ConsenSys/teku/commit/e0fd252913f13bf1abd355ef39156891b9119c2d", "message": "Don't process locally produced attetations twice", "committedDate": "2020-10-29T18:23:55Z", "type": "commit"}, {"oid": "c6e0200d3ce42076584b5dbe2d7528bf8812e979", "url": "https://github.com/ConsenSys/teku/commit/c6e0200d3ce42076584b5dbe2d7528bf8812e979", "message": "Merge branch 'master' into moveAllObjectValidationToStateTransitionPackage", "committedDate": "2020-10-29T19:18:10Z", "type": "commit"}, {"oid": "9b2a8779d06c8c7589ece22d735f41a3a17ddb1e", "url": "https://github.com/ConsenSys/teku/commit/9b2a8779d06c8c7589ece22d735f41a3a17ddb1e", "message": "Send validator attestations as quickly as possible and only gossip network attestations once", "committedDate": "2020-10-29T19:56:14Z", "type": "commit"}, {"oid": "7ace641ef6a2d3584b88b8245ebc5fab0b2f34f5", "url": "https://github.com/ConsenSys/teku/commit/7ace641ef6a2d3584b88b8245ebc5fab0b2f34f5", "message": "Revert \"Send validator attestations as quickly as possible and only gossip network attestations once\"\n\nThis reverts commit 9b2a8779d06c8c7589ece22d735f41a3a17ddb1e.", "committedDate": "2020-10-29T20:09:01Z", "type": "commit"}, {"oid": "e6509a801a51a5c815e3b887111f82f07e4f6928", "url": "https://github.com/ConsenSys/teku/commit/e6509a801a51a5c815e3b887111f82f07e4f6928", "message": "Only gossip network attestations once", "committedDate": "2020-10-29T20:51:52Z", "type": "commit"}, {"oid": "4146beabe012d633969c81dac4cd9c610ee007ef", "url": "https://github.com/ConsenSys/teku/commit/4146beabe012d633969c81dac4cd9c610ee007ef", "message": "Run spotless", "committedDate": "2020-10-29T21:15:29Z", "type": "commit"}, {"oid": "6aa2265478c6be8efecefaad2e1f5f0376f8bfc8", "url": "https://github.com/ConsenSys/teku/commit/6aa2265478c6be8efecefaad2e1f5f0376f8bfc8", "message": "Add missing break", "committedDate": "2020-10-29T21:23:35Z", "type": "commit"}, {"oid": "1f4063b296d6b601ab0a3416ec3852a1757f1429", "url": "https://github.com/ConsenSys/teku/commit/1f4063b296d6b601ab0a3416ec3852a1757f1429", "message": "Merge remote-tracking branch 'remotes/origin/master' into moveAllObjectValidationToStateTransitionPackage\n\n# Conflicts:\n#\tnetworking/eth2/src/testFixtures/java/tech/pegasys/teku/networking/eth2/Eth2NetworkFactory.java", "committedDate": "2020-10-30T17:57:20Z", "type": "commit"}]}