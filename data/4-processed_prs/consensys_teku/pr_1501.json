{"pr_number": 1501, "pr_title": "Introduce Signer as a richer API for signing domain objects", "pr_createdAt": "2020-03-30T03:48:47Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1501", "timeline": [{"oid": "103fd99ec4a3c328339c0be64523182ca9649af7", "url": "https://github.com/ConsenSys/teku/commit/103fd99ec4a3c328339c0be64523182ca9649af7", "message": "Load validators into ValidatorClientService.", "committedDate": "2020-03-30T02:41:52Z", "type": "commit"}, {"oid": "a53a42ef4978f842d4219b65a7a65bfeaa857890", "url": "https://github.com/ConsenSys/teku/commit/a53a42ef4978f842d4219b65a7a65bfeaa857890", "message": "Move test resources.", "committedDate": "2020-03-30T02:41:54Z", "type": "commit"}, {"oid": "28aa2a0af8394ca8ce32e209ef23b78f8e7c748f", "url": "https://github.com/ConsenSys/teku/commit/28aa2a0af8394ca8ce32e209ef23b78f8e7c748f", "message": "Move all production signing root calculation and signing to Signer.", "committedDate": "2020-03-30T03:37:12Z", "type": "commit"}, {"oid": "e97e0eaeed6f27e96604c1a31ed20c29c46ac530", "url": "https://github.com/ConsenSys/teku/commit/e97e0eaeed6f27e96604c1a31ed20c29c46ac530", "message": "Move test signing to Signer.", "committedDate": "2020-03-30T03:45:35Z", "type": "commit"}, {"oid": "3bb32a55ca31d259d813102bc453dcc6460e0f36", "url": "https://github.com/ConsenSys/teku/commit/3bb32a55ca31d259d813102bc453dcc6460e0f36", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into introducer-signer", "committedDate": "2020-03-30T03:48:56Z", "type": "commit"}, {"oid": "4a722547aa7fe5cba14b733d77ccecfc28ee54f9", "url": "https://github.com/ConsenSys/teku/commit/4a722547aa7fe5cba14b733d77ccecfc28ee54f9", "message": "Add an integration test.", "committedDate": "2020-03-30T03:50:17Z", "type": "commit"}, {"oid": "bc1a30f6571046af70ce5f7ca4fa512ec250d2ea", "url": "https://github.com/ConsenSys/teku/commit/bc1a30f6571046af70ce5f7ca4fa512ec250d2ea", "message": "Spotless.", "committedDate": "2020-03-30T03:54:23Z", "type": "commit"}, {"oid": "18024ab10ed399c1fe26f9807a06b73ed22aef2b", "url": "https://github.com/ConsenSys/teku/commit/18024ab10ed399c1fe26f9807a06b73ed22aef2b", "message": "Go back to loading a map of validators.", "committedDate": "2020-03-30T04:06:04Z", "type": "commit"}, {"oid": "4d4552a3be9f2d090aa55a7cef9376d8775dbb53", "url": "https://github.com/ConsenSys/teku/commit/4d4552a3be9f2d090aa55a7cef9376d8775dbb53", "message": "Move signing classes to a signer package.", "committedDate": "2020-03-30T04:22:33Z", "type": "commit"}, {"oid": "d04258139ebdc8d2c2c5258dafa5cef053c1aefe", "url": "https://github.com/ConsenSys/teku/commit/d04258139ebdc8d2c2c5258dafa5cef053c1aefe", "message": "Spotless.", "committedDate": "2020-03-30T04:25:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0NTU0OQ==", "url": "https://github.com/ConsenSys/teku/pull/1501#discussion_r400345549", "bodyText": "Really nice and clean that all the signing is now contained in one object.", "author": "cemozerr", "createdAt": "2020-03-30T16:54:47Z", "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/signer/Signer.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.client.signer;\n+\n+import static tech.pegasys.artemis.datastructures.util.BeaconStateUtil.compute_epoch_at_slot;\n+import static tech.pegasys.artemis.datastructures.util.BeaconStateUtil.compute_signing_root;\n+import static tech.pegasys.artemis.datastructures.util.BeaconStateUtil.get_domain;\n+import static tech.pegasys.artemis.util.config.Constants.DOMAIN_BEACON_ATTESTER;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import org.apache.tuweni.bytes.Bytes;\n+import tech.pegasys.artemis.datastructures.blocks.BeaconBlock;\n+import tech.pegasys.artemis.datastructures.operations.AttestationData;\n+import tech.pegasys.artemis.datastructures.state.Fork;\n+import tech.pegasys.artemis.datastructures.validator.MessageSignerService;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+import tech.pegasys.artemis.util.bls.BLSSignature;\n+import tech.pegasys.artemis.util.config.Constants;\n+\n+public class Signer {", "originalCommit": "d04258139ebdc8d2c2c5258dafa5cef053c1aefe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM1MDcwOQ==", "url": "https://github.com/ConsenSys/teku/pull/1501#discussion_r400350709", "bodyText": "I don't have a suggestion, however, it took me a good amount of time to infer (still not sure) that passing the epoch number 7 and the given fork value results in the expectedSigningRoot that you declare above. I wish there was a more clear way of showing that.", "author": "cemozerr", "createdAt": "2020-03-30T17:02:48Z", "path": "validator/client/src/test/java/tech/pegasys/artemis/validator/client/signer/SignerTest.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.client.signer;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.artemis.datastructures.blocks.BeaconBlock;\n+import tech.pegasys.artemis.datastructures.operations.AttestationData;\n+import tech.pegasys.artemis.datastructures.state.Fork;\n+import tech.pegasys.artemis.datastructures.util.DataStructureUtil;\n+import tech.pegasys.artemis.datastructures.validator.MessageSignerService;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+import tech.pegasys.artemis.util.bls.BLSSignature;\n+\n+class SignerTest {\n+\n+  private final MessageSignerService signerService = mock(MessageSignerService.class);\n+  private final DataStructureUtil dataStructureUtil = new DataStructureUtil();\n+  private final Fork fork = dataStructureUtil.randomFork();\n+\n+  private final Signer signer = new Signer(signerService);\n+\n+  @Test\n+  public void shouldCreateRandaoReveal() {\n+    final BLSSignature signature = dataStructureUtil.randomSignature();\n+    final Bytes expectedSigningRoot =\n+        Bytes.fromHexString(\"0x84c8825ccb169a0d1109ff2b96185ea2bd6f66ed198f2e322473773fff3ed91b\");\n+    when(signerService.signRandaoReveal(expectedSigningRoot))\n+        .thenReturn(SafeFuture.completedFuture(signature));\n+    final SafeFuture<BLSSignature> reveal =\n+        signer.createRandaoReveal(UnsignedLong.valueOf(7), fork);", "originalCommit": "d04258139ebdc8d2c2c5258dafa5cef053c1aefe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUwMjAyNw==", "url": "https://github.com/ConsenSys/teku/pull/1501#discussion_r400502027", "bodyText": "Yeah, ultimately those tests are really checking that the signing root was calculated correctly and that it was delegated to the right method on the MessageSignerService. I can't actually see a way to simplify them either.  We could have a separate object responsible for calculating the signing root and test that separately but it just makes the production code more complex and I don't think it's worth it.", "author": "ajsutton", "createdAt": "2020-03-30T21:22:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM1MDcwOQ=="}], "type": "inlineReview"}, {"oid": "420e55b1620abb1a031e2a47198e7acaafcb7986", "url": "https://github.com/ConsenSys/teku/commit/420e55b1620abb1a031e2a47198e7acaafcb7986", "message": "Merge branch 'master' into introducer-signer", "committedDate": "2020-03-30T21:18:40Z", "type": "commit"}]}