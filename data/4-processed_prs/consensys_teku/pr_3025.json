{"pr_number": 3025, "pr_title": "Replace batches from old chains with no remaining peers", "pr_createdAt": "2020-10-20T03:57:51Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3025", "timeline": [{"oid": "447d960b4a24d29d92e25aed9937322f0457271b", "url": "https://github.com/ConsenSys/teku/commit/447d960b4a24d29d92e25aed9937322f0457271b", "message": "Replace batches from old chains with no remaining peers with batches from the new chain", "committedDate": "2020-10-20T03:45:41Z", "type": "commit"}, {"oid": "18e8d906373ebc19e6a92ee3966d0b00c85f22ab", "url": "https://github.com/ConsenSys/teku/commit/18e8d906373ebc19e6a92ee3966d0b00c85f22ab", "message": "Don't replace complete batches.", "committedDate": "2020-10-20T03:53:02Z", "type": "commit"}, {"oid": "a44936f89b029168edad9a6b908c526172818f18", "url": "https://github.com/ConsenSys/teku/commit/a44936f89b029168edad9a6b908c526172818f18", "message": "Add another test.", "committedDate": "2020-10-20T03:57:28Z", "type": "commit"}, {"oid": "b9f17f94359b53d4f8d56235d5597ae25408a0f4", "url": "https://github.com/ConsenSys/teku/commit/b9f17f94359b53d4f8d56235d5597ae25408a0f4", "message": "Spotless.", "committedDate": "2020-10-20T04:01:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3ODgyNg==", "url": "https://github.com/ConsenSys/teku/pull/3025#discussion_r508578826", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      // request data from. Remove all batch from that one to where the new chain starts and\n          \n          \n            \n                      // request data from. Remove all batches from that one to where the new chain starts and", "author": "mbaxter", "createdAt": "2020-10-20T14:53:20Z", "path": "sync/src/main/java/tech/pegasys/teku/sync/multipeer/BatchDataRequester.java", "diffHunk": "@@ -78,6 +84,42 @@ public void fillRetrievingQueue(\n     }\n   }\n \n+  /**\n+   * All the sync sources on a given target chain may have moved to a new chain or disconnected. To\n+   * avoid getting stuck attempting and failing to request data when there are no sync sources, find\n+   * the first batch from an old chain with no sources, and replace all batches after it that are\n+   * from old chains with batches from our new chain.\n+   */\n+  private void replaceBatchesFromOldChainsWithNoSources(final TargetChain targetChain) {\n+    final Optional<Batch> firstStrandedBatch =\n+        activeBatches.stream()\n+            .filter(batch -> incompleteBatchFromOldChainWithNoPeers(targetChain, batch))\n+            .findFirst();\n+    firstStrandedBatch.ifPresent(\n+        strandedBatch -> {\n+          // We have at least one batch from an old chain which no longer has any target peers to\n+          // request data from. Remove all batch from that one to where the new chain starts and", "originalCommit": "b9f17f94359b53d4f8d56235d5597ae25408a0f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8a43c7d91346bd4b9fba2c957ee569f7698c0345", "url": "https://github.com/ConsenSys/teku/commit/8a43c7d91346bd4b9fba2c957ee569f7698c0345", "message": "Fix comment.", "committedDate": "2020-10-20T20:01:10Z", "type": "commit"}, {"oid": "c22c7fbb2dfd3d7e933dfb661418a3ad768e61a8", "url": "https://github.com/ConsenSys/teku/commit/c22c7fbb2dfd3d7e933dfb661418a3ad768e61a8", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into replace-old-batches", "committedDate": "2020-10-20T20:01:15Z", "type": "commit"}]}