{"pr_number": 1461, "pr_title": "Sign using external signing service", "pr_createdAt": "2020-03-24T03:44:57Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1461", "timeline": [{"oid": "f36908424c4fe5bfc2b4563859b102ecadc0f63c", "url": "https://github.com/ConsenSys/teku/commit/f36908424c4fe5bfc2b4563859b102ecadc0f63c", "message": "create separate signing methods to represent how the API is used", "committedDate": "2020-03-18T21:58:27Z", "type": "commit"}, {"oid": "7370f5eeeea8f904627cef03e58d60f48ed3e154", "url": "https://github.com/ConsenSys/teku/commit/7370f5eeeea8f904627cef03e58d60f48ed3e154", "message": "sign messages using Eth2Signer", "committedDate": "2020-03-22T23:35:22Z", "type": "commit"}, {"oid": "477b33e73a7efde6b74adc2353f0295a6b423252", "url": "https://github.com/ConsenSys/teku/commit/477b33e73a7efde6b74adc2353f0295a6b423252", "message": "ValidatorLoader ut", "committedDate": "2020-03-23T05:56:33Z", "type": "commit"}, {"oid": "db4f392d7c4e5c7bea98abe1f2a5e472c4ec59a9", "url": "https://github.com/ConsenSys/teku/commit/db4f392d7c4e5c7bea98abe1f2a5e472c4ec59a9", "message": "rename signing_root -> signingRoot", "committedDate": "2020-03-23T05:57:14Z", "type": "commit"}, {"oid": "aeb2ebad26e96d2d9eda2c57dca30b01de3da6df", "url": "https://github.com/ConsenSys/teku/commit/aeb2ebad26e96d2d9eda2c57dca30b01de3da6df", "message": "fix ut", "committedDate": "2020-03-23T05:58:52Z", "type": "commit"}, {"oid": "3d12979065a43e95008e0c5af93c51ab5d5504cf", "url": "https://github.com/ConsenSys/teku/commit/3d12979065a43e95008e0c5af93c51ab5d5504cf", "message": "introduce custom exception", "committedDate": "2020-03-23T05:59:06Z", "type": "commit"}, {"oid": "3d6a36c0a8de3d5431f5b7f8c4b70ebf9f95519e", "url": "https://github.com/ConsenSys/teku/commit/3d6a36c0a8de3d5431f5b7f8c4b70ebf9f95519e", "message": "ExternalMessageSignerService integration test", "committedDate": "2020-03-24T02:04:59Z", "type": "commit"}, {"oid": "985354535a2587f18848269794909133623233c4", "url": "https://github.com/ConsenSys/teku/commit/985354535a2587f18848269794909133623233c4", "message": "ExternalMessageSignerService integration test - verify requests", "committedDate": "2020-03-24T02:18:47Z", "type": "commit"}, {"oid": "3b1c5d8bcdaef253853df9f06faccf554bf9aa2e", "url": "https://github.com/ConsenSys/teku/commit/3b1c5d8bcdaef253853df9f06faccf554bf9aa2e", "message": "ArtemisConfiguration ut", "committedDate": "2020-03-24T03:18:05Z", "type": "commit"}, {"oid": "d757ee80da2e005c823e311dfc261000c0bb54d7", "url": "https://github.com/ConsenSys/teku/commit/d757ee80da2e005c823e311dfc261000c0bb54d7", "message": "Merge branch 'master' into external_signing", "committedDate": "2020-03-24T03:40:34Z", "type": "commit"}, {"oid": "e86b2dcad3f983be6ad4b858a646aa2164e98ca5", "url": "https://github.com/ConsenSys/teku/commit/e86b2dcad3f983be6ad4b858a646aa2164e98ca5", "message": "small refactoring", "committedDate": "2020-03-24T03:47:40Z", "type": "commit"}, {"oid": "17a5f594650c064dd7b87c10caca281325534c8f", "url": "https://github.com/ConsenSys/teku/commit/17a5f594650c064dd7b87c10caca281325534c8f", "message": "fix integration test", "committedDate": "2020-03-24T03:49:37Z", "type": "commit"}, {"oid": "19d721782815e6e65bc70333d078bca2b2129298", "url": "https://github.com/ConsenSys/teku/commit/19d721782815e6e65bc70333d078bca2b2129298", "message": "Merge branch 'master' into external_signing", "committedDate": "2020-03-24T04:02:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNDg0Mw==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r396904843", "bodyText": "nit: final in catch block", "author": "usmansaleem", "createdAt": "2020-03-24T05:08:12Z", "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/ExternalMessageSignerService.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.client;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.net.URL;\n+import java.net.http.HttpClient;\n+import java.net.http.HttpRequest;\n+import java.net.http.HttpRequest.BodyPublishers;\n+import java.net.http.HttpResponse;\n+import java.net.http.HttpResponse.BodyHandlers;\n+import java.time.Duration;\n+import org.apache.tuweni.bytes.Bytes;\n+import tech.pegasys.artemis.datastructures.validator.MessageSignerService;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+import tech.pegasys.artemis.util.bls.BLSPublicKey;\n+import tech.pegasys.artemis.util.bls.BLSSignature;\n+\n+public class ExternalMessageSignerService implements MessageSignerService {\n+  private static final ObjectMapper MAPPER = new ObjectMapper();\n+  private URL signingServiceUrl;\n+  private BLSPublicKey blsPublicKey;\n+  private int timeoutMs;\n+\n+  public ExternalMessageSignerService(\n+      final URL signingServiceUrl, final BLSPublicKey blsPublicKey, final int timeoutMs) {\n+    this.signingServiceUrl = signingServiceUrl;\n+    this.blsPublicKey = blsPublicKey;\n+    this.timeoutMs = timeoutMs;\n+  }\n+\n+  @Override\n+  public SafeFuture<BLSSignature> signBlock(final Bytes signingRoot) {\n+    return sign(signingRoot, \"/signer/block\");\n+  }\n+\n+  @Override\n+  public SafeFuture<BLSSignature> signAttestation(final Bytes signingRoot) {\n+    return sign(signingRoot, \"/signer/attestation\");\n+  }\n+\n+  @Override\n+  public SafeFuture<BLSSignature> signRandaoReveal(final Bytes signingRoot) {\n+    return sign(signingRoot, \"/signer/randao_reveal\");\n+  }\n+\n+  private SafeFuture<BLSSignature> sign(final Bytes signingRoot, final String path) {\n+    try {\n+      final String requestBody = createSigningRequest(signingRoot);\n+      final HttpRequest request =\n+          HttpRequest.newBuilder()\n+              .uri(signingServiceUrl.toURI().resolve(path))\n+              .timeout(Duration.ofMillis(timeoutMs))\n+              .POST(BodyPublishers.ofString(requestBody))\n+              .build();\n+      return SafeFuture.of(\n+          HttpClient.newHttpClient()\n+              .sendAsync(request, BodyHandlers.ofString())\n+              .handleAsync(this::getBlsSignature));\n+    } catch (ExternalSignerException e) {", "originalCommit": "19d721782815e6e65bc70333d078bca2b2129298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNjMxMA==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r396906310", "bodyText": "done", "author": "jframe", "createdAt": "2020-03-24T05:14:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNDg0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNTkyOQ==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r396905929", "bodyText": "we only support one external signer?", "author": "usmansaleem", "createdAt": "2020-03-24T05:13:01Z", "path": "validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/ValidatorLoader.java", "diffHunk": "@@ -49,6 +51,29 @@\n     return validators;\n   }\n \n+  private static Map<BLSPublicKey, ValidatorInfo> createLocalSignerValidatorInfo(\n+      final ArtemisConfiguration config) {\n+    return loadValidatorKeys(config).stream()\n+        .collect(\n+            Collectors.toMap(\n+                BLSKeyPair::getPublicKey,\n+                blsKeyPair -> new ValidatorInfo(new LocalMessageSignerService(blsKeyPair))));\n+  }\n+\n+  private static Map<BLSPublicKey, ValidatorInfo> createExternalSignerValidatorInfo(\n+      final ArtemisConfiguration config) {\n+    return config.getValidatorExternalSigningPublicKeys().stream()\n+        .collect(\n+            Collectors.toMap(\n+                identity(),\n+                publicKey ->\n+                    new ValidatorInfo(\n+                        new ExternalMessageSignerService(\n+                            config.getValidatorExternalSigningUrl(),", "originalCommit": "19d721782815e6e65bc70333d078bca2b2129298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNjc0MQ==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r396906741", "bodyText": "Yes at the moment. It wouldn't be too difficult to add support for multiple external signers though. The config would be become little more complex though. Do you think we should support multiple external signers?", "author": "jframe", "createdAt": "2020-03-24T05:16:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNTkyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwOTc4MA==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r396909780", "bodyText": "Thinking about this more, I don't think we need to support multiple external signers at the moment. And more than likely we will probably share the same external signer for several Teku instances. Certainly can quite easily add this in the future if it becomes apparent we do need this.", "author": "jframe", "createdAt": "2020-03-24T05:29:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkwNTkyOQ=="}], "type": "inlineReview"}, {"oid": "9dac44880000e5f8b2702561b3231ca59e76a1b0", "url": "https://github.com/ConsenSys/teku/commit/9dac44880000e5f8b2702561b3231ca59e76a1b0", "message": "finals", "committedDate": "2020-03-24T05:14:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4MTk4Ng==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397481986", "bodyText": "Do we need to manage the 48 vs 32 byte keys here?", "author": "ajsutton", "createdAt": "2020-03-24T21:48:01Z", "path": "util/src/main/java/tech/pegasys/artemis/util/config/ArtemisConfiguration.java", "diffHunk": "@@ -335,6 +348,32 @@ public String getValidatorsKeyFile() {\n     return list;\n   }\n \n+  public List<BLSPublicKey> getValidatorExternalSigningPublicKeys() {\n+    final List<String> publicKeys = config.getListOfString(\"validator.externalSignerPublicKeys\");\n+    if (publicKeys == null) {\n+      return Collections.emptyList();\n+    }\n+    try {\n+      return publicKeys.stream()\n+          .map(key -> BLSPublicKey.fromBytes(Bytes.fromHexString(key)))", "originalCommit": "19d721782815e6e65bc70333d078bca2b2129298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NzI4OA==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397597288", "bodyText": "nope, public keys are 48 bytes", "author": "jframe", "createdAt": "2020-03-25T03:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4MTk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MDQyOQ==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397490429", "bodyText": "These don't look like valid BLS keys - at 48 bytes long the start should be all 0's.  Note that BLSPublicKey doesn't actually parse the key until it's required (there are times the deposit contract can give us invalid keys). #1466 is dealing with the same issue so would be good to ensure we have a reusable BLSPublicKey.isValid method.", "author": "ajsutton", "createdAt": "2020-03-24T22:06:04Z", "path": "util/src/test/java/tech/pegasys/artemis/util/config/ArtemisConfigurationTest.java", "diffHunk": "@@ -258,4 +262,60 @@ void loggingFileNamePatternShouldDefault() {\n     final ArtemisConfiguration config = ArtemisConfiguration.fromString(\"\");\n     assertThat(config.getLoggingFileNamePattern()).isEqualTo(\"teku_%d{yyyy-MM-dd}.log\");\n   }\n+\n+  @Test\n+  void validatorExternalSignerPublicKeysCanBeSet() {\n+    final String publicKey1 =\n+        \"0xa99a76ed7796f7be22d5b7e85deeb7c5677e88e511e0b337618f8c4eb61349b4bf2d153f649f7b53359fe8b94a38e44c\";", "originalCommit": "19d721782815e6e65bc70333d078bca2b2129298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NzM4MA==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397597380", "bodyText": "Public keys are 48 bytes so this doesn't need changing", "author": "jframe", "createdAt": "2020-03-25T04:00:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MDQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MTAxNg==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397491016", "bodyText": "nit: Probably worth just taking the timeout as a duration in the constructor rather than converting on every call here. Makes it a more flexible API as well.", "author": "ajsutton", "createdAt": "2020-03-24T22:07:26Z", "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/ExternalMessageSignerService.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.client;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.net.URL;\n+import java.net.http.HttpClient;\n+import java.net.http.HttpRequest;\n+import java.net.http.HttpRequest.BodyPublishers;\n+import java.net.http.HttpResponse;\n+import java.net.http.HttpResponse.BodyHandlers;\n+import java.time.Duration;\n+import org.apache.tuweni.bytes.Bytes;\n+import tech.pegasys.artemis.datastructures.validator.MessageSignerService;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+import tech.pegasys.artemis.util.bls.BLSPublicKey;\n+import tech.pegasys.artemis.util.bls.BLSSignature;\n+\n+public class ExternalMessageSignerService implements MessageSignerService {\n+  private static final ObjectMapper MAPPER = new ObjectMapper();\n+  private URL signingServiceUrl;\n+  private BLSPublicKey blsPublicKey;\n+  private int timeoutMs;\n+\n+  public ExternalMessageSignerService(\n+      final URL signingServiceUrl, final BLSPublicKey blsPublicKey, final int timeoutMs) {\n+    this.signingServiceUrl = signingServiceUrl;\n+    this.blsPublicKey = blsPublicKey;\n+    this.timeoutMs = timeoutMs;\n+  }\n+\n+  @Override\n+  public SafeFuture<BLSSignature> signBlock(final Bytes signingRoot) {\n+    return sign(signingRoot, \"/signer/block\");\n+  }\n+\n+  @Override\n+  public SafeFuture<BLSSignature> signAttestation(final Bytes signingRoot) {\n+    return sign(signingRoot, \"/signer/attestation\");\n+  }\n+\n+  @Override\n+  public SafeFuture<BLSSignature> signRandaoReveal(final Bytes signingRoot) {\n+    return sign(signingRoot, \"/signer/randao_reveal\");\n+  }\n+\n+  private SafeFuture<BLSSignature> sign(final Bytes signingRoot, final String path) {\n+    try {\n+      final String requestBody = createSigningRequest(signingRoot);\n+      final HttpRequest request =\n+          HttpRequest.newBuilder()\n+              .uri(signingServiceUrl.toURI().resolve(path))\n+              .timeout(Duration.ofMillis(timeoutMs))", "originalCommit": "19d721782815e6e65bc70333d078bca2b2129298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNzAwMg==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397507002", "bodyText": "done", "author": "jframe", "createdAt": "2020-03-24T22:45:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MTAxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MTYyNA==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397491624", "bodyText": "This will miss any Throwable instances that don't extend Exception.  Rather than a try/catch, it's probably better to use SafeFuture.of(Supplier<CompletionStage>).", "author": "ajsutton", "createdAt": "2020-03-24T22:08:49Z", "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/ExternalMessageSignerService.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.client;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.net.URL;\n+import java.net.http.HttpClient;\n+import java.net.http.HttpRequest;\n+import java.net.http.HttpRequest.BodyPublishers;\n+import java.net.http.HttpResponse;\n+import java.net.http.HttpResponse.BodyHandlers;\n+import java.time.Duration;\n+import org.apache.tuweni.bytes.Bytes;\n+import tech.pegasys.artemis.datastructures.validator.MessageSignerService;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+import tech.pegasys.artemis.util.bls.BLSPublicKey;\n+import tech.pegasys.artemis.util.bls.BLSSignature;\n+\n+public class ExternalMessageSignerService implements MessageSignerService {\n+  private static final ObjectMapper MAPPER = new ObjectMapper();\n+  private URL signingServiceUrl;\n+  private BLSPublicKey blsPublicKey;\n+  private int timeoutMs;\n+\n+  public ExternalMessageSignerService(\n+      final URL signingServiceUrl, final BLSPublicKey blsPublicKey, final int timeoutMs) {\n+    this.signingServiceUrl = signingServiceUrl;\n+    this.blsPublicKey = blsPublicKey;\n+    this.timeoutMs = timeoutMs;\n+  }\n+\n+  @Override\n+  public SafeFuture<BLSSignature> signBlock(final Bytes signingRoot) {\n+    return sign(signingRoot, \"/signer/block\");\n+  }\n+\n+  @Override\n+  public SafeFuture<BLSSignature> signAttestation(final Bytes signingRoot) {\n+    return sign(signingRoot, \"/signer/attestation\");\n+  }\n+\n+  @Override\n+  public SafeFuture<BLSSignature> signRandaoReveal(final Bytes signingRoot) {\n+    return sign(signingRoot, \"/signer/randao_reveal\");\n+  }\n+\n+  private SafeFuture<BLSSignature> sign(final Bytes signingRoot, final String path) {\n+    try {\n+      final String requestBody = createSigningRequest(signingRoot);\n+      final HttpRequest request =\n+          HttpRequest.newBuilder()\n+              .uri(signingServiceUrl.toURI().resolve(path))\n+              .timeout(Duration.ofMillis(timeoutMs))\n+              .POST(BodyPublishers.ofString(requestBody))\n+              .build();\n+      return SafeFuture.of(\n+          HttpClient.newHttpClient()\n+              .sendAsync(request, BodyHandlers.ofString())\n+              .handleAsync(this::getBlsSignature));\n+    } catch (ExternalSignerException e) {\n+      return SafeFuture.failedFuture(e);\n+    } catch (Exception e) {\n+      return SafeFuture.failedFuture(\n+          new ExternalSignerException(\"External signer failed to sign\", e));\n+    }", "originalCommit": "19d721782815e6e65bc70333d078bca2b2129298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5ODI3Mg==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397598272", "bodyText": "Added a SafeFuture ofComposed(final ExceptionThrowingSupplier<CompletionStage> futureSupplier) and have used that to get rid of the try/catch", "author": "jframe", "createdAt": "2020-03-25T04:04:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MTYyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MjgwMg==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397492802", "bodyText": "It seems potentially confusing that we toggle between the two modes. We could just load both local and external validator info and merge the two which would be more predictable.  Not likely to be a real need of users, just removes one potential gotcha.  I'd prefer the external signer over the local one should a public key appear in both (the external may have extra slashing protection).", "author": "ajsutton", "createdAt": "2020-03-24T22:11:33Z", "path": "validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/ValidatorLoader.java", "diffHunk": "@@ -33,12 +36,11 @@\n   static Map<BLSPublicKey, ValidatorInfo> initializeValidators(ArtemisConfiguration config) {\n     // Get validator connection info and create a new ValidatorInfo object and put it into the\n     // Validators map\n+\n     final Map<BLSPublicKey, ValidatorInfo> validators =\n-        loadValidatorKeys(config).stream()\n-            .collect(\n-                Collectors.toMap(\n-                    BLSKeyPair::getPublicKey,\n-                    blsKeyPair -> new ValidatorInfo(new LocalMessageSignerService(blsKeyPair))));\n+        config.getValidatorExternalSigningPublicKeys().isEmpty()\n+            ? createLocalSignerValidatorInfo(config)\n+            : createExternalSignerValidatorInfo(config);", "originalCommit": "19d721782815e6e65bc70333d078bca2b2129298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NzY1OQ==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397597659", "bodyText": "done", "author": "jframe", "createdAt": "2020-03-25T04:01:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MjgwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5NTgyMQ==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397495821", "bodyText": "It would be really useful if the signing API put the public key in the URL, not in the post data.  Load balancers can then easily split the signing load across multiple signers etc - they are dramatically more flexible with URLs than with POST data.", "author": "ajsutton", "createdAt": "2020-03-24T22:18:25Z", "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/ExternalMessageSignerService.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.client;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.net.URL;\n+import java.net.http.HttpClient;\n+import java.net.http.HttpRequest;\n+import java.net.http.HttpRequest.BodyPublishers;\n+import java.net.http.HttpResponse;\n+import java.net.http.HttpResponse.BodyHandlers;\n+import java.time.Duration;\n+import org.apache.tuweni.bytes.Bytes;\n+import tech.pegasys.artemis.datastructures.validator.MessageSignerService;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+import tech.pegasys.artemis.util.bls.BLSPublicKey;\n+import tech.pegasys.artemis.util.bls.BLSSignature;\n+\n+public class ExternalMessageSignerService implements MessageSignerService {\n+  private static final ObjectMapper MAPPER = new ObjectMapper();\n+  private URL signingServiceUrl;\n+  private BLSPublicKey blsPublicKey;\n+  private int timeoutMs;\n+\n+  public ExternalMessageSignerService(\n+      final URL signingServiceUrl, final BLSPublicKey blsPublicKey, final int timeoutMs) {\n+    this.signingServiceUrl = signingServiceUrl;\n+    this.blsPublicKey = blsPublicKey;\n+    this.timeoutMs = timeoutMs;\n+  }\n+\n+  @Override\n+  public SafeFuture<BLSSignature> signBlock(final Bytes signingRoot) {\n+    return sign(signingRoot, \"/signer/block\");\n+  }\n+\n+  @Override\n+  public SafeFuture<BLSSignature> signAttestation(final Bytes signingRoot) {\n+    return sign(signingRoot, \"/signer/attestation\");\n+  }\n+\n+  @Override\n+  public SafeFuture<BLSSignature> signRandaoReveal(final Bytes signingRoot) {\n+    return sign(signingRoot, \"/signer/randao_reveal\");\n+  }\n+\n+  private SafeFuture<BLSSignature> sign(final Bytes signingRoot, final String path) {\n+    try {\n+      final String requestBody = createSigningRequest(signingRoot);\n+      final HttpRequest request =\n+          HttpRequest.newBuilder()\n+              .uri(signingServiceUrl.toURI().resolve(path))", "originalCommit": "19d721782815e6e65bc70333d078bca2b2129298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU5NzU1Mg==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397597552", "bodyText": "This will be done in another PR, see issue ConsenSys/web3signer#49", "author": "jframe", "createdAt": "2020-03-25T04:01:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5NTgyMQ=="}], "type": "inlineReview"}, {"oid": "bf219e65abc58dc4ca7f8e19593b9100764e7ccd", "url": "https://github.com/ConsenSys/teku/commit/bf219e65abc58dc4ca7f8e19593b9100764e7ccd", "message": "Merge branch 'external_signing' of github.com:jframe/artemis into external_signing", "committedDate": "2020-03-24T22:31:54Z", "type": "commit"}, {"oid": "021b671fc501a465c1806c066d1a3a94d1f973eb", "url": "https://github.com/ConsenSys/teku/commit/021b671fc501a465c1806c066d1a3a94d1f973eb", "message": "take duration as param in constructor", "committedDate": "2020-03-24T22:44:17Z", "type": "commit"}, {"oid": "ea865ee91d193dd82b214032d77126d597c32e95", "url": "https://github.com/ConsenSys/teku/commit/ea865ee91d193dd82b214032d77126d597c32e95", "message": "use public keys from both local and external key config", "committedDate": "2020-03-24T23:13:20Z", "type": "commit"}, {"oid": "6f8bfcfc6380c84fb187ea4c1afe3d775d73e150", "url": "https://github.com/ConsenSys/teku/commit/6f8bfcfc6380c84fb187ea4c1afe3d775d73e150", "message": "Merge branch 'master' into external_signing", "committedDate": "2020-03-25T01:52:07Z", "type": "commit"}, {"oid": "93af815322fe43e3a3892e25ab3105dac1bb0aed", "url": "https://github.com/ConsenSys/teku/commit/93af815322fe43e3a3892e25ab3105dac1bb0aed", "message": "remove try/catch and instead use SafeFuture.ofComposed", "committedDate": "2020-03-25T03:59:28Z", "type": "commit"}, {"oid": "13ea126ef4a31f0b852d495db28d8aa124835209", "url": "https://github.com/ConsenSys/teku/commit/13ea126ef4a31f0b852d495db28d8aa124835209", "message": "Merge branch 'master' into external_signing", "committedDate": "2020-03-25T04:05:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYwMzc0NQ==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397603745", "bodyText": "nit: final", "author": "usmansaleem", "createdAt": "2020-03-25T04:29:38Z", "path": "util/src/main/java/tech/pegasys/artemis/util/async/SafeFuture.java", "diffHunk": "@@ -67,15 +67,24 @@ public static void reportExceptions(final CompletionStage<?> future) {\n   public static <U> SafeFuture<U> of(final Supplier<CompletionStage<U>> futureSupplier) {\n     try {\n       return SafeFuture.of(futureSupplier.get());\n-    } catch (Exception e) {\n+    } catch (Throwable e) {\n       return SafeFuture.failedFuture(e);\n     }\n   }\n \n   public static <U> SafeFuture<U> of(final ExceptionThrowingSupplier<U> supplier) {\n     try {\n       return SafeFuture.completedFuture(supplier.get());\n-    } catch (final Exception e) {\n+    } catch (final Throwable e) {\n+      return SafeFuture.failedFuture(e);\n+    }\n+  }\n+\n+  public static <U> SafeFuture<U> ofComposed(\n+      final ExceptionThrowingSupplier<CompletionStage<U>> futureSupplier) {\n+    try {\n+      return SafeFuture.of(futureSupplier.get());\n+    } catch (Throwable e) {", "originalCommit": "13ea126ef4a31f0b852d495db28d8aa124835209", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYwNDg2Nw==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397604867", "bodyText": "done", "author": "jframe", "createdAt": "2020-03-25T04:35:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYwMzc0NQ=="}], "type": "inlineReview"}, {"oid": "c7805bcea867a1c7a1c156794869c6bb79373eae", "url": "https://github.com/ConsenSys/teku/commit/c7805bcea867a1c7a1c156794869c6bb79373eae", "message": "add final", "committedDate": "2020-03-25T04:35:04Z", "type": "commit"}, {"oid": "9e34b086faa314b882fe33a2861bc4bdd49537b1", "url": "https://github.com/ConsenSys/teku/commit/9e34b086faa314b882fe33a2861bc4bdd49537b1", "message": "Merge branch 'external_signing' of github.com:jframe/artemis into external_signing", "committedDate": "2020-03-25T04:36:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYwNDkxNg==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397604916", "bodyText": "nit: I think we can get rid of this one and just have the ExceptionThrowingSupplier versions.", "author": "ajsutton", "createdAt": "2020-03-25T04:35:25Z", "path": "util/src/main/java/tech/pegasys/artemis/util/async/SafeFuture.java", "diffHunk": "@@ -67,15 +67,24 @@ public static void reportExceptions(final CompletionStage<?> future) {\n   public static <U> SafeFuture<U> of(final Supplier<CompletionStage<U>> futureSupplier) {", "originalCommit": "13ea126ef4a31f0b852d495db28d8aa124835209", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYwNTIwOQ==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397605209", "bodyText": "nit: I think you can remove this SafeFuture.of now because you can return any type of CompletionStage.", "author": "ajsutton", "createdAt": "2020-03-25T04:36:49Z", "path": "validator/client/src/main/java/tech/pegasys/artemis/validator/client/ExternalMessageSignerService.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.validator.client;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.net.URL;\n+import java.net.http.HttpClient;\n+import java.net.http.HttpRequest;\n+import java.net.http.HttpRequest.BodyPublishers;\n+import java.net.http.HttpResponse;\n+import java.net.http.HttpResponse.BodyHandlers;\n+import java.time.Duration;\n+import org.apache.tuweni.bytes.Bytes;\n+import tech.pegasys.artemis.datastructures.validator.MessageSignerService;\n+import tech.pegasys.artemis.util.async.SafeFuture;\n+import tech.pegasys.artemis.util.bls.BLSPublicKey;\n+import tech.pegasys.artemis.util.bls.BLSSignature;\n+\n+public class ExternalMessageSignerService implements MessageSignerService {\n+  private static final ObjectMapper MAPPER = new ObjectMapper();\n+  private final URL signingServiceUrl;\n+  private final BLSPublicKey blsPublicKey;\n+  private final Duration timeout;\n+\n+  public ExternalMessageSignerService(\n+      final URL signingServiceUrl, final BLSPublicKey blsPublicKey, final Duration timeout) {\n+    this.signingServiceUrl = signingServiceUrl;\n+    this.blsPublicKey = blsPublicKey;\n+    this.timeout = timeout;\n+  }\n+\n+  @Override\n+  public SafeFuture<BLSSignature> signBlock(final Bytes signingRoot) {\n+    return sign(signingRoot, \"/signer/block\");\n+  }\n+\n+  @Override\n+  public SafeFuture<BLSSignature> signAttestation(final Bytes signingRoot) {\n+    return sign(signingRoot, \"/signer/attestation\");\n+  }\n+\n+  @Override\n+  public SafeFuture<BLSSignature> signRandaoReveal(final Bytes signingRoot) {\n+    return sign(signingRoot, \"/signer/randao_reveal\");\n+  }\n+\n+  private SafeFuture<BLSSignature> sign(final Bytes signingRoot, final String path) {\n+    return SafeFuture.ofComposed(\n+        () -> {\n+          final String requestBody = createSigningRequest(signingRoot);\n+          final HttpRequest request =\n+              HttpRequest.newBuilder()\n+                  .uri(signingServiceUrl.toURI().resolve(path))\n+                  .timeout(timeout)\n+                  .POST(BodyPublishers.ofString(requestBody))\n+                  .build();\n+          return SafeFuture.of(", "originalCommit": "13ea126ef4a31f0b852d495db28d8aa124835209", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY0NDAzNw==", "url": "https://github.com/ConsenSys/teku/pull/1461#discussion_r397644037", "bodyText": "done", "author": "jframe", "createdAt": "2020-03-25T07:07:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYwNTIwOQ=="}], "type": "inlineReview"}, {"oid": "a59237e5dd2bb816c43a34f07d3a87c4b551306d", "url": "https://github.com/ConsenSys/teku/commit/a59237e5dd2bb816c43a34f07d3a87c4b551306d", "message": "remove unnecessary extra SafeFuture.of call as it's already caught in the SafeFuture.ofComposed", "committedDate": "2020-03-25T06:55:49Z", "type": "commit"}]}