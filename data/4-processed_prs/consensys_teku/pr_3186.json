{"pr_number": 3186, "pr_title": "Add acceptance test for partial deposits", "pr_createdAt": "2020-11-09T20:26:03Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3186", "timeline": [{"oid": "9b80571ebc503e5e1079368eeac8e132d321c888", "url": "https://github.com/ConsenSys/teku/commit/9b80571ebc503e5e1079368eeac8e132d321c888", "message": "Add acceptance test for partial deposits", "committedDate": "2020-11-09T20:19:59Z", "type": "commit"}, {"oid": "2b7b83b6ae36ed326efb66f9d5cabf5729b4f619", "url": "https://github.com/ConsenSys/teku/commit/2b7b83b6ae36ed326efb66f9d5cabf5729b4f619", "message": "Clean up", "committedDate": "2020-11-09T20:28:36Z", "type": "commit"}, {"oid": "b78963be30c483cf09526bc51a4214c4fe8461b4", "url": "https://github.com/ConsenSys/teku/commit/b78963be30c483cf09526bc51a4214c4fe8461b4", "message": "Merge branch 'master' into acceptanceTestForPartialDeposits", "committedDate": "2020-11-09T20:28:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMzA0Ng==", "url": "https://github.com/ConsenSys/teku/pull/3186#discussion_r521733046", "bodyText": "Why would we get genesis if we only sent partial deposits? Shouldn't it send a second batch of deposits to reach the required amount?", "author": "ajsutton", "createdAt": "2020-11-12T00:31:06Z", "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/GenesisStateAcceptanceTest.java", "diffHunk": "@@ -39,4 +39,18 @@ public void shouldCreateTheSameGenesisState() throws Exception {\n     // state because they processed the same deposits from the same ETH1 chain.\n     lateJoinTeku.waitUntilInSyncWith(firstTeku);\n   }\n+\n+  @Test\n+  public void shouldCreateGenesisFromPartialDeposits() throws Exception {\n+    final BesuNode eth1Node = createBesuNode();\n+    eth1Node.start();\n+\n+    createTekuDepositSender().partiallySendValidatorDeposits(eth1Node, 4);\n+\n+    final TekuNode firstTeku = createTekuNode(config -> config.withDepositsFrom(eth1Node));\n+    firstTeku.start();\n+    firstTeku.waitForGenesis();", "originalCommit": "b78963be30c483cf09526bc51a4214c4fe8461b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMzc2NA==", "url": "https://github.com/ConsenSys/teku/pull/3186#discussion_r521733764", "bodyText": "Oh I see, we bundled it all into one method.  It would make the test a lot easier to understand if there were actually two calls to the deposit sender here in the test.  We want the AT to read like a script showing each step that's being taken.", "author": "ajsutton", "createdAt": "2020-11-12T00:32:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMzA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMyOTY1Nw==", "url": "https://github.com/ConsenSys/teku/pull/3186#discussion_r522329657", "bodyText": "Hopefully its more readable now.", "author": "cemozerr", "createdAt": "2020-11-12T18:37:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMzA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQzMDIxMQ==", "url": "https://github.com/ConsenSys/teku/pull/3186#discussion_r522430211", "bodyText": "I noticed that with the changes after your comment, assemble fails because we don't have access to any object in the acceptance-test package other than all the object declared in the textFixtures package. That forces the acceptance tests to do almost all the work in a testFixtures object. Not sure how to make this acceptance test more readable in this scenario. Maybe I can make a TekuPartialDepositSender object, yet it feels a bit unnecessary.", "author": "cemozerr", "createdAt": "2020-11-12T21:14:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMzA0Ng=="}], "type": "inlineReview"}, {"oid": "321f267cd46235e1d085dc5a88c5bb98bcf0c5f4", "url": "https://github.com/ConsenSys/teku/commit/321f267cd46235e1d085dc5a88c5bb98bcf0c5f4", "message": "Make acceptance test more readable", "committedDate": "2020-11-12T18:37:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYyNTI0OA==", "url": "https://github.com/ConsenSys/teku/pull/3186#discussion_r522625248", "bodyText": "Yeah as you've commented this isn't the right approach.  We want the AT to be simple and clear, but still show what steps its actually taking.  So we want the AT to come out something like:\n@Test\n  public void shouldCreateGenesisFromPartialDeposits() throws Exception {\n    final BesuNode eth1Node = createBesuNode();\n    eth1Node.start();\n    int numberOfValidators = 4;\n\n    final TekuDepositSender depositSender = createTekuDepositSender();\n    final List<ValidatorKeyGenerator.ValidatorKeys> validatorKeys =\n        depositSender.generateValidatorKeys(numberOfValidators);\n    depositSender.sendValidatorDeposits(eth1Node, validatorKeys, MIN_DEPOSIT_AMOUNT);\n    depositSender.sendValidatorDeposits(\n        eth1Node, validatorKeys, MAX_EFFECTIVE_BALANCE - MIN_DEPOSIT_AMOUNT);\n\n    final TekuNode teku = createTekuNode(config -> config.withDepositsFrom(eth1Node));\n    teku.start();\n    teku.waitForGenesis();\n\n    teku.waitForValidators(numberOfValidators);\n  }", "author": "ajsutton", "createdAt": "2020-11-13T04:41:30Z", "path": "acceptance-tests/src/acceptance-test/java/tech/pegasys/teku/test/acceptance/GenesisStateAcceptanceTest.java", "diffHunk": "@@ -39,4 +45,36 @@ public void shouldCreateTheSameGenesisState() throws Exception {\n     // state because they processed the same deposits from the same ETH1 chain.\n     lateJoinTeku.waitUntilInSyncWith(firstTeku);\n   }\n+\n+  @Test\n+  public void shouldCreateGenesisFromPartialDeposits() throws Exception {\n+    final BesuNode eth1Node = createBesuNode();\n+    eth1Node.start();\n+    int numberOfValidators = 4;\n+\n+    final Eth1Address eth1Address = Eth1Address.fromHexString(eth1Node.getDepositContractAddress());\n+    final Credentials eth1Credentials = Credentials.create(eth1Node.getRichBenefactorKey());\n+    DepositGenerator depositGenerator =\n+        new DepositGenerator(\n+            eth1Node.getExternalJsonRpcUrl(),\n+            eth1Address,\n+            eth1Credentials,\n+            numberOfValidators,\n+            UInt64.valueOf(MAX_EFFECTIVE_BALANCE / 2));\n+\n+    depositGenerator\n+        .generateKeysStream()\n+        .forEach(\n+            key -> {\n+              // For each key send deposit twice, since these are partial deposits\n+              depositGenerator.sendDeposit(key).join();\n+              depositGenerator.sendDeposit(key).join();\n+            });\n+\n+    final TekuNode teku = createTekuNode(config -> config.withDepositsFrom(eth1Node));\n+    teku.start();\n+    teku.waitForGenesis();", "originalCommit": "321f267cd46235e1d085dc5a88c5bb98bcf0c5f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE1Mzk5NQ==", "url": "https://github.com/ConsenSys/teku/pull/3186#discussion_r523153995", "bodyText": "Done.", "author": "cemozerr", "createdAt": "2020-11-13T18:42:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYyNTI0OA=="}], "type": "inlineReview"}, {"oid": "e428db0f0bfc2560b5be747e320b943480d74cb3", "url": "https://github.com/ConsenSys/teku/commit/e428db0f0bfc2560b5be747e320b943480d74cb3", "message": "Make AT simple and clear", "committedDate": "2020-11-13T18:30:14Z", "type": "commit"}, {"oid": "608acdb6f9a4ab7289296980af134bf118aaec25", "url": "https://github.com/ConsenSys/teku/commit/608acdb6f9a4ab7289296980af134bf118aaec25", "message": "Add acceptance test build requirements", "committedDate": "2020-11-13T18:38:21Z", "type": "commit"}, {"oid": "e5ece029028f554e7699a8a4eeec04ab87196dc4", "url": "https://github.com/ConsenSys/teku/commit/e5ece029028f554e7699a8a4eeec04ab87196dc4", "message": "Merge branch 'master' into acceptanceTestForPartialDeposits", "committedDate": "2020-11-16T17:36:42Z", "type": "commit"}]}