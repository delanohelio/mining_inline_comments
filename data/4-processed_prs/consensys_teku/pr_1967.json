{"pr_number": 1967, "pr_title": "added rest-api-host-whitelist", "pr_createdAt": "2020-05-26T05:56:18Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1967", "timeline": [{"oid": "88c8e204221791c2a19019046dc5d8aab6b896f0", "url": "https://github.com/ConsenSys/teku/commit/88c8e204221791c2a19019046dc5d8aab6b896f0", "message": "added rest-api-host-whitelist\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-05-26T05:17:37Z", "type": "commit"}, {"oid": "8272a0fcf9d885e23303bc9829d50ba117d1a234", "url": "https://github.com/ConsenSys/teku/commit/8272a0fcf9d885e23303bc9829d50ba117d1a234", "message": "removed debug\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-05-26T05:57:24Z", "type": "commit"}, {"oid": "6bd540e8f4d4b72ff55168ddd38dfaade7fbd12b", "url": "https://github.com/ConsenSys/teku/commit/6bd540e8f4d4b72ff55168ddd38dfaade7fbd12b", "message": "integration test setup\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-05-26T06:21:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxNTEyNw==", "url": "https://github.com/ConsenSys/teku/pull/1967#discussion_r430715127", "bodyText": "whitelisting is more of a 'business as usual', i'd leave the log statement as debug.\nAlso, i can't see any test cases exercising any of this logic...\n\ndoes substring get me around the logic (my.host allowing my.)\ndoes it actually block me if i'm not in the list\ndoes star let me in\ndoes my ip / hostname let me in\n\nThis may have to be slightly restructured to allow testing to happen cleanly... but it shouldn't be huge, just let me know if you need a hand.", "author": "rolfyone", "createdAt": "2020-05-26T21:21:49Z", "path": "data/beaconrestapi/src/main/java/tech/pegasys/teku/beaconrestapi/BeaconRestApi.java", "diffHunk": "@@ -82,6 +89,38 @@ private void initialize(final DataProvider dataProvider, final TekuConfiguration\n     addCustomErrorPages(configuration);\n   }\n \n+  private void addHostWhitelistHandler(final TekuConfiguration configuration) {\n+    app.before(\n+        (ctx) -> {\n+          String header = ctx.header(\"host\");\n+          Optional<String> optionalHost = getAndValidateHostHeader(header);\n+          if (!configuration.getRestApiHostWhitelist().contains(\"*\")\n+              && (!optionalHost.isPresent()\n+                  || !hostIsInWhitelist(configuration, optionalHost.get()))) {\n+            ctx.status(SC_FORBIDDEN);\n+            LOG.info(\"Host not authorized \" + optionalHost);\n+          }\n+        });\n+  }", "originalCommit": "6bd540e8f4d4b72ff55168ddd38dfaade7fbd12b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxNTY2NA==", "url": "https://github.com/ConsenSys/teku/pull/1967#discussion_r430715664", "bodyText": "these should be defaults, did the tests not work without it? that would be a concern...", "author": "rolfyone", "createdAt": "2020-05-26T21:22:55Z", "path": "teku/src/test/java/tech/pegasys/teku/cli/BeaconNodeCommandTest.java", "diffHunk": "@@ -306,7 +306,8 @@ private TekuConfigurationBuilder expectedConfigurationBuilder() {\n         .setRestApiPort(5051)\n         .setRestApiDocsEnabled(false)\n         .setRestApiEnabled(false)\n-        .setRestApiInterface(\"127.0.0.1\");\n+        .setRestApiInterface(\"127.0.0.1\")\n+        .setRestApiHostWhitelist(List.of(\"127.0.0.1\", \"localhost\"));", "originalCommit": "6bd540e8f4d4b72ff55168ddd38dfaade7fbd12b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2MTI0Ng==", "url": "https://github.com/ConsenSys/teku/pull/1967#discussion_r430761246", "bodyText": "this is building the \"expected\" config to compare the real one with", "author": "macfarla", "createdAt": "2020-05-26T23:26:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxNTY2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcyMjM4Mw==", "url": "https://github.com/ConsenSys/teku/pull/1967#discussion_r430722383", "bodyText": "we could actually have another test alongside these that creates a config with different elements int he whitelist to show it working for real if we wanted to...", "author": "rolfyone", "createdAt": "2020-05-26T21:37:59Z", "path": "data/beaconrestapi/src/integration-test/java/tech/pegasys/teku/beaconrestapi/AbstractBeaconRestAPIIntegrationTest.java", "diffHunk": "@@ -46,7 +47,11 @@\n public abstract class AbstractBeaconRestAPIIntegrationTest {\n   static final okhttp3.MediaType JSON = okhttp3.MediaType.parse(\"application/json; charset=utf-8\");\n   static final TekuConfiguration config =\n-      TekuConfiguration.builder().setRestApiPort(0).setRestApiDocsEnabled(false).build();\n+      TekuConfiguration.builder()\n+          .setRestApiPort(0)\n+          .setRestApiDocsEnabled(false)\n+          .setRestApiHostWhitelist(List.of(\"127.0.0.1\", \"localhost\"))\n+          .build();", "originalCommit": "6bd540e8f4d4b72ff55168ddd38dfaade7fbd12b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "33503c9dfdc9f6bbdab57ad4f86353076af9c82b", "url": "https://github.com/ConsenSys/teku/commit/33503c9dfdc9f6bbdab57ad4f86353076af9c82b", "message": "logging\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-05-26T23:19:49Z", "type": "commit"}, {"oid": "97e42177b895118d5a05088796488018286fdba4", "url": "https://github.com/ConsenSys/teku/commit/97e42177b895118d5a05088796488018286fdba4", "message": "refactoring and tests\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-05-27T01:24:40Z", "type": "commit"}, {"oid": "e3398983e984a8bb791843bd65f91ce6e06cf7a7", "url": "https://github.com/ConsenSys/teku/commit/e3398983e984a8bb791843bd65f91ce6e06cf7a7", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into rest-api-host-whitelist", "committedDate": "2020-05-27T01:24:51Z", "type": "commit"}, {"oid": "d74ef2c7af6551c80e29f3fa7d29c4fc49cf9075", "url": "https://github.com/ConsenSys/teku/commit/d74ef2c7af6551c80e29f3fa7d29c4fc49cf9075", "message": "Merge branch 'master' into rest-api-host-whitelist", "committedDate": "2020-05-27T05:23:20Z", "type": "commit"}, {"oid": "a97b4a247dfeeadff453502b4836ddc921974f65", "url": "https://github.com/ConsenSys/teku/commit/a97b4a247dfeeadff453502b4836ddc921974f65", "message": "Merge branch 'master' into rest-api-host-whitelist", "committedDate": "2020-05-27T19:16:45Z", "type": "commit"}]}