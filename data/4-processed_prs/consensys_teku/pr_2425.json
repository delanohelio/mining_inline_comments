{"pr_number": 2425, "pr_title": "[Issue 2291] Remove synchronous Store state retrieval methods", "pr_createdAt": "2020-07-22T22:26:19Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2425", "timeline": [{"oid": "b2e903bc11b5a8017461a09751b85c62d342159b", "url": "https://github.com/ConsenSys/teku/commit/b2e903bc11b5a8017461a09751b85c62d342159b", "message": "Fix getLatestFinalizedBlockAndState", "committedDate": "2020-07-23T15:32:46Z", "type": "forcePushed"}, {"oid": "1d9ec27679b3f9e755029281e86d7b58ddf385d8", "url": "https://github.com/ConsenSys/teku/commit/1d9ec27679b3f9e755029281e86d7b58ddf385d8", "message": "Remove Store.getBlockAndState()", "committedDate": "2020-07-23T16:11:54Z", "type": "commit"}, {"oid": "117edc868884ac2263cc786008d22749ae7f10b0", "url": "https://github.com/ConsenSys/teku/commit/117edc868884ac2263cc786008d22749ae7f10b0", "message": "Remove Store.getState", "committedDate": "2020-07-23T16:12:39Z", "type": "commit"}, {"oid": "b4756e2c92ca530b50d6ef345e26faf1f5bf7916", "url": "https://github.com/ConsenSys/teku/commit/b4756e2c92ca530b50d6ef345e26faf1f5bf7916", "message": "Fix getLatestFinalizedBlockAndState", "committedDate": "2020-07-23T16:12:43Z", "type": "commit"}, {"oid": "b4756e2c92ca530b50d6ef345e26faf1f5bf7916", "url": "https://github.com/ConsenSys/teku/commit/b4756e2c92ca530b50d6ef345e26faf1f5bf7916", "message": "Fix getLatestFinalizedBlockAndState", "committedDate": "2020-07-23T16:12:43Z", "type": "forcePushed"}, {"oid": "49fe07b071271d01fe6af69fb32761468160682d", "url": "https://github.com/ConsenSys/teku/commit/49fe07b071271d01fe6af69fb32761468160682d", "message": "Make factory thread-safe", "committedDate": "2020-07-23T16:33:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU2Njg5Ng==", "url": "https://github.com/ConsenSys/teku/pull/2425#discussion_r459566896", "bodyText": "Not sure I'm getting what is this filter for? Why not just join?", "author": "Nashatyrev", "createdAt": "2020-07-23T16:13:20Z", "path": "storage/src/test/java/tech/pegasys/teku/storage/server/AbstractDatabaseTest.java", "diffHunk": "@@ -712,8 +718,10 @@ protected void assertHotBlocksAndStates(\n \n       final List<BeaconState> hotStates =\n           currentStore.getBlockRoots().stream()\n-              .map(currentStore::getBlockState)\n-              .filter(Objects::nonNull)\n+              .map(currentStore::retrieveBlockState)\n+              .filter(SafeFuture::isDone)", "originalCommit": "b8970bca6a492d0d7a100a25562c53451aa39cbd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU5MjUxNg==", "url": "https://github.com/ConsenSys/teku/pull/2425#discussion_r459592516", "bodyText": "I was thinking that we could avoid blocking in this way, and if some futures were skipped because they haven't resolved the assertions below should fail.  But on second thought, I think that's a bad assumption - will rework.", "author": "mbaxter", "createdAt": "2020-07-23T16:55:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU2Njg5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYxMzEyOA==", "url": "https://github.com/ConsenSys/teku/pull/2425#discussion_r459613128", "bodyText": "May be just set the test timeout?", "author": "Nashatyrev", "createdAt": "2020-07-23T17:30:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU2Njg5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYyNjIyMQ==", "url": "https://github.com/ConsenSys/teku/pull/2425#discussion_r459626221", "bodyText": "Ended up just adding an assert inside of the map function", "author": "mbaxter", "createdAt": "2020-07-23T17:53:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU2Njg5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MTM2Mg==", "url": "https://github.com/ConsenSys/teku/pull/2425#discussion_r459581362", "bodyText": "Don't you think that Factory is a bit misleading here? May be a Builder would be more appropriate?", "author": "Nashatyrev", "createdAt": "2020-07-23T16:36:43Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/store/StoreTransactionUpdatesFactory.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.storage.store;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.datastructures.blocks.SlotAndBlockRoot;\n+import tech.pegasys.teku.datastructures.hashtree.HashTree;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n+import tech.pegasys.teku.datastructures.state.CheckpointAndBlock;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.storage.events.FinalizedChainData;\n+import tech.pegasys.teku.storage.store.Store.Transaction;\n+\n+public class StoreTransactionUpdatesFactory {", "originalCommit": "b4756e2c92ca530b50d6ef345e26faf1f5bf7916", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4NzY3Ng==", "url": "https://github.com/ConsenSys/teku/pull/2425#discussion_r459587676", "bodyText": "Yeah - I was unsure of the naming as well.  But I think \"builder\" implies that you can set various properties when externally it just looks like a factory:  StoreTransactionUpdatesFactory.create(...)", "author": "mbaxter", "createdAt": "2020-07-23T16:47:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MTM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU5NDM1OQ==", "url": "https://github.com/ConsenSys/teku/pull/2425#discussion_r459594359", "bodyText": "Yeah I just used to the Factory pattern is when it's create() method is an instance method so you could supply another factory implementation. Anyway since it's now package private there wouldn't be much confusion I think", "author": "Nashatyrev", "createdAt": "2020-07-23T16:58:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MTM2Mg=="}], "type": "inlineReview"}, {"oid": "4894136f9e36c71869ceeb0153f52ee1be179bf9", "url": "https://github.com/ConsenSys/teku/commit/4894136f9e36c71869ceeb0153f52ee1be179bf9", "message": "Make factory package-private", "committedDate": "2020-07-23T16:51:36Z", "type": "commit"}, {"oid": "44ce990d79bd97be99f38e596f6a99a74964a369", "url": "https://github.com/ConsenSys/teku/commit/44ce990d79bd97be99f38e596f6a99a74964a369", "message": "Don't filter out incomplete futures", "committedDate": "2020-07-23T17:50:57Z", "type": "commit"}]}