{"pr_number": 3244, "pr_title": "[Issue 3216] Clean up async processing", "pr_createdAt": "2020-11-17T19:13:48Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3244", "timeline": [{"oid": "77b82760f78b7b014145983a9de1c60735c7b35f", "url": "https://github.com/ConsenSys/teku/commit/77b82760f78b7b014145983a9de1c60735c7b35f", "message": "Add asyncDoWhile() utility and use it to clean up HistoricalBlockFetcher", "committedDate": "2020-11-16T21:21:24Z", "type": "commit"}, {"oid": "f72581b5120b741a518db6954b560ec09e675ce8", "url": "https://github.com/ConsenSys/teku/commit/f72581b5120b741a518db6954b560ec09e675ce8", "message": "Update HistoricalBlockSyncService to use async looping util", "committedDate": "2020-11-17T19:05:18Z", "type": "commit"}, {"oid": "f04780b934675c1bb0e3983f8b5dd16be0e1d569", "url": "https://github.com/ConsenSys/teku/commit/f04780b934675c1bb0e3983f8b5dd16be0e1d569", "message": "Consolidate asyncDoWhile helpers", "committedDate": "2020-11-17T19:11:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwNjI2Ng==", "url": "https://github.com/ConsenSys/teku/pull/3244#discussion_r525606266", "bodyText": "This works well with the current use cases but at some point we probably should update it to avoid recursion if the returned future is already complete - otherwise we risk getting StackOverflowException.  Will be quite nice to hide that complexity in here.", "author": "ajsutton", "createdAt": "2020-11-18T00:03:19Z", "path": "infrastructure/async/src/main/java/tech/pegasys/teku/infrastructure/async/SafeFuture.java", "diffHunk": "@@ -122,6 +122,17 @@ public static Interruptor createInterruptor(\n     return new Interruptor(interruptFuture, exceptionSupplier);\n   }\n \n+  /**\n+   * Repeatedly run the loop until it returns false or completes exceptionally\n+   *\n+   * @param loopBody A supplier for generating futures to be run in succession\n+   * @return A future that will complete when looping terminates\n+   */\n+  public static SafeFuture<Void> asyncDoWhile(ExceptionThrowingFutureSupplier<Boolean> loopBody) {\n+    return SafeFuture.of(loopBody::get)\n+        .thenCompose(res -> res ? asyncDoWhile(loopBody) : SafeFuture.COMPLETE);", "originalCommit": "f04780b934675c1bb0e3983f8b5dd16be0e1d569", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMzNjgwNw==", "url": "https://github.com/ConsenSys/teku/pull/3244#discussion_r526336807", "bodyText": "good call - will follow up on this", "author": "mbaxter", "createdAt": "2020-11-18T18:46:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwNjI2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM4OTcxMg==", "url": "https://github.com/ConsenSys/teku/pull/3244#discussion_r526389712", "bodyText": "Fixed here: #3253", "author": "mbaxter", "createdAt": "2020-11-18T20:14:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwNjI2Ng=="}], "type": "inlineReview"}, {"oid": "4af2a7636b8853daba4d5afd91e649e51f718687", "url": "https://github.com/ConsenSys/teku/commit/4af2a7636b8853daba4d5afd91e649e51f718687", "message": "Merge branch 'master' into issue-3216/clean-up-async-processing", "committedDate": "2020-11-18T18:32:43Z", "type": "commit"}]}