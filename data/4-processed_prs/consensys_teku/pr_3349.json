{"pr_number": 3349, "pr_title": "[Issue 3337] Be more tolerant of missing eth1 blocks", "pr_createdAt": "2020-12-02T21:20:52Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3349", "timeline": [{"oid": "5cfba90f068a0eafa6d9d8cb1ffd2089f123a103", "url": "https://github.com/ConsenSys/teku/commit/5cfba90f068a0eafa6d9d8cb1ffd2089f123a103", "message": "Start updating Eth1Provider block API's to return Optional's", "committedDate": "2020-12-02T21:14:30Z", "type": "commit"}, {"oid": "26a956cf929a8b79d2520227e89e1b2287ffc65a", "url": "https://github.com/ConsenSys/teku/commit/26a956cf929a8b79d2520227e89e1b2287ffc65a", "message": "Add retry utility for retrying futures", "committedDate": "2020-12-02T21:14:30Z", "type": "commit"}, {"oid": "d19eb8aba6ddfeea3772460cfdb2e0925e8f4e85", "url": "https://github.com/ConsenSys/teku/commit/d19eb8aba6ddfeea3772460cfdb2e0925e8f4e85", "message": "Make MinimumGenesisTimeBlockFinder more tolerant of missing blocks", "committedDate": "2020-12-02T21:14:30Z", "type": "commit"}, {"oid": "ca6d63d5d68ee64779b86beb9f29f6e354a3f938", "url": "https://github.com/ConsenSys/teku/commit/ca6d63d5d68ee64779b86beb9f29f6e354a3f938", "message": "Simplify minimal block check", "committedDate": "2020-12-02T22:21:38Z", "type": "commit"}, {"oid": "33207f34ad05c2472d46b35184afa40c11cbf7a2", "url": "https://github.com/ConsenSys/teku/commit/33207f34ad05c2472d46b35184afa40c11cbf7a2", "message": "Add logging", "committedDate": "2020-12-02T22:37:29Z", "type": "commit"}, {"oid": "a6f30d92fdbb586abd6786b99ba27a8174ed9248", "url": "https://github.com/ConsenSys/teku/commit/a6f30d92fdbb586abd6786b99ba27a8174ed9248", "message": "Clean up comments, logs", "committedDate": "2020-12-02T23:01:47Z", "type": "commit"}, {"oid": "f375b72eee8da34ce3a3b174cf6bcb1cb194938e", "url": "https://github.com/ConsenSys/teku/commit/f375b72eee8da34ce3a3b174cf6bcb1cb194938e", "message": "Clean up tests", "committedDate": "2020-12-02T23:01:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU0Mjk3NQ==", "url": "https://github.com/ConsenSys/teku/pull/3349#discussion_r534542975", "bodyText": "This is the approach we talked about using - but I'm not sure it actually makes a lot of sense to search one by one through the ancestors.  I suppose it's possible that some historical blocks were filled in as the binary search runs, but it's also possible we spend a lot of time walking back through ancestors and don't find our target block.\nThoughts?", "author": "mbaxter", "createdAt": "2020-12-02T23:07:00Z", "path": "pow/src/main/java/tech/pegasys/teku/pow/MinimumGenesisTimeBlockFinder.java", "diffHunk": "@@ -52,7 +60,93 @@ public MinimumGenesisTimeBlockFinder(\n   public SafeFuture<EthBlock.Block> findMinGenesisTimeBlockInHistory(\n       final BigInteger headBlockNumber) {\n     return binarySearchLoop(\n-        new SearchContext(eth1DepositContractDeployBlock.orElse(ZERO), headBlockNumber));\n+            new SearchContext(eth1DepositContractDeployBlock.orElse(ZERO), headBlockNumber))\n+        .thenCompose(this::confirmOrFindMinGenesisBlock);\n+  }\n+\n+  /**\n+   * The binary search may return a block that is too new (if historical blocks are unavailable\n+   * during the search), so walk back though chain to confirm or else pull the correct min genesis\n+   * block.\n+   *\n+   * @param candidateMinGenesisBlock A candidate block that may be the min genesis block\n+   * @return The confirmed min genesis block\n+   */\n+  @VisibleForTesting\n+  SafeFuture<EthBlock.Block> confirmOrFindMinGenesisBlock(\n+      final EthBlock.Block candidateMinGenesisBlock) {\n+    assertBlockIsAtOrAfterMinGenesis(candidateMinGenesisBlock);\n+    if (blockIsAtMinimalMinGenesisPosition(candidateMinGenesisBlock)) {\n+      // We've found min genesis\n+      traceWithBlock(\n+          \"Confirmed minimum genesis block at minimal position: \", candidateMinGenesisBlock);\n+      return SafeFuture.completedFuture(candidateMinGenesisBlock);\n+    }\n+\n+    traceWithBlock(\n+        \"Confirm minimum genesis block retrieved via binary search: \", candidateMinGenesisBlock);\n+    final SafeFuture<EthBlock.Block> minGenesisFuture = new SafeFuture<>();\n+\n+    final AtomicReference<EthBlock.Block> currentMinGenesisCandidate =\n+        new AtomicReference<>(candidateMinGenesisBlock);\n+    final AtomicInteger examinedAncestorsCount = new AtomicInteger(0);\n+    SafeFuture.asyncDoWhile(\n+            () ->\n+                eth1Provider\n+                    .getEth1BlockWithRetry(\n+                        currentMinGenesisCandidate.get().getParentHash(), Duration.ofSeconds(5), 3)\n+                    .thenApply(\n+                        parent -> {\n+                          examinedAncestorsCount.incrementAndGet();\n+                          if (blockIsPriorToMinGenesis(parent)) {\n+                            // We've confirmed the current candidate is at the boundary\n+                            traceWithBlock(\n+                                \"Confirmed min genesis block: \", currentMinGenesisCandidate.get());\n+                            minGenesisFuture.complete(currentMinGenesisCandidate.get());\n+                            return false;\n+                          } else if (blockIsAtMinGenesis(parent)) {\n+                            // We've found the min genesis block\n+                            traceWithBlock(\n+                                \"Confirmed min genesis block at exact genesis time: \", parent);\n+                            minGenesisFuture.complete(parent);\n+                            return false;\n+                          } else {\n+                            // The parent block is after min genesis\n+                            // Keep searching through ancestors up to our limit", "originalCommit": "f375b72eee8da34ce3a3b174cf6bcb1cb194938e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU0OTQ3NQ==", "url": "https://github.com/ConsenSys/teku/pull/3349#discussion_r534549475", "bodyText": "Yeah it is an awful lot of extra code for a very small corner case.  It only matters if we don't already have the genesis state baked in and the eth1 node doesn't have enough history to get back to the min genesis block but then it wouldn't have the deposit events anyway and we'd crash because of the deposit event ordering checks.\nI think its probably worth just dropping this - keep the assumption that if we can't get a block then min genesis time must be after that but don't bother walking back to verify it was right.", "author": "ajsutton", "createdAt": "2020-12-02T23:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU0Mjk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ5MzI5Mg==", "url": "https://github.com/ConsenSys/teku/pull/3349#discussion_r535493292", "bodyText": "I kept a single check to look up the parent block, but dropped the ancestor search which cut out a good chunk of code.", "author": "mbaxter", "createdAt": "2020-12-03T18:49:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU0Mjk3NQ=="}], "type": "inlineReview"}, {"oid": "763d65a35db4f77048fa2799aab2df247a2cbd6b", "url": "https://github.com/ConsenSys/teku/commit/763d65a35db4f77048fa2799aab2df247a2cbd6b", "message": "Return an Optional from getEth1BlockWithRetry\n\nThere's probably no point retrying if the block isn't available.", "committedDate": "2020-12-03T16:27:19Z", "type": "commit"}, {"oid": "db4cf8dd0dd6b4c3cbf7fde9aa13f9baa4957c1e", "url": "https://github.com/ConsenSys/teku/commit/db4cf8dd0dd6b4c3cbf7fde9aa13f9baa4957c1e", "message": "Simplify min genesis block confirmation", "committedDate": "2020-12-03T17:13:05Z", "type": "commit"}, {"oid": "5578adffad318d27bb4b325329ff3d77cf51fa4a", "url": "https://github.com/ConsenSys/teku/commit/5578adffad318d27bb4b325329ff3d77cf51fa4a", "message": "Add retries to remaining MinGenesisTimeBlockFinder requests", "committedDate": "2020-12-03T17:50:05Z", "type": "commit"}, {"oid": "50bcf533d1940fd70e284a585566ddd8b84a484c", "url": "https://github.com/ConsenSys/teku/commit/50bcf533d1940fd70e284a585566ddd8b84a484c", "message": "Tweak error, add test", "committedDate": "2020-12-03T18:03:52Z", "type": "commit"}, {"oid": "c17da2a561c5cdee9c49c27c6a12fec82fd3f3d0", "url": "https://github.com/ConsenSys/teku/commit/c17da2a561c5cdee9c49c27c6a12fec82fd3f3d0", "message": "Update stale comment", "committedDate": "2020-12-03T18:47:03Z", "type": "commit"}, {"oid": "9b0dec8051dbe9e3a329968ddaf4fabf34a770b8", "url": "https://github.com/ConsenSys/teku/commit/9b0dec8051dbe9e3a329968ddaf4fabf34a770b8", "message": "Merge branch 'master' into issue-3337/be-more-tolerant-of-missing-eth1-blocks", "committedDate": "2020-12-03T22:57:17Z", "type": "commit"}]}