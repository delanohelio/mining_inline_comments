{"pr_number": 2083, "pr_title": "Automate API doc with CI", "pr_createdAt": "2020-06-08T19:51:11Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2083", "timeline": [{"oid": "1ee8bc756bab512c6142c8c725e91d2baf5a3eaf", "url": "https://github.com/ConsenSys/teku/commit/1ee8bc756bab512c6142c8c725e91d2baf5a3eaf", "message": "update scripts and readme", "committedDate": "2020-06-08T16:10:21Z", "type": "commit"}, {"oid": "bcf563a3c839c315146c8746bebf033edfcbc622", "url": "https://github.com/ConsenSys/teku/commit/bcf563a3c839c315146c8746bebf033edfcbc622", "message": "remove version file that will be in gh-pages", "committedDate": "2020-06-08T16:42:27Z", "type": "commit"}, {"oid": "89570400da02e22d2f2ac51ff98166523eb9342c", "url": "https://github.com/ConsenSys/teku/commit/89570400da02e22d2f2ac51ff98166523eb9342c", "message": "update CI", "committedDate": "2020-06-08T17:16:08Z", "type": "commit"}, {"oid": "103e533d269bee1399190d2f306fd1c189cfd49a", "url": "https://github.com/ConsenSys/teku/commit/103e533d269bee1399190d2f306fd1c189cfd49a", "message": "testing CI filter", "committedDate": "2020-06-08T17:21:43Z", "type": "commit"}, {"oid": "cfac8d3a65baa65d68da2a1db79c14aa51edd412", "url": "https://github.com/ConsenSys/teku/commit/cfac8d3a65baa65d68da2a1db79c14aa51edd412", "message": "fix artifact path", "committedDate": "2020-06-08T17:27:51Z", "type": "commit"}, {"oid": "363ecf8b036753b5420c6809598fa4885b387057", "url": "https://github.com/ConsenSys/teku/commit/363ecf8b036753b5420c6809598fa4885b387057", "message": "fix cache and js script", "committedDate": "2020-06-08T18:57:42Z", "type": "commit"}, {"oid": "7b856aaa70ae778ed24682f3257c90abeab2abb5", "url": "https://github.com/ConsenSys/teku/commit/7b856aaa70ae778ed24682f3257c90abeab2abb5", "message": "fix wrong dir", "committedDate": "2020-06-08T19:44:34Z", "type": "commit"}, {"oid": "3073785aa6f6b04c037607b7e8b17ad62c527dee", "url": "https://github.com/ConsenSys/teku/commit/3073785aa6f6b04c037607b7e8b17ad62c527dee", "message": "Merge branch 'master' into 1826-api-doc-on-CI", "committedDate": "2020-06-08T19:59:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3OTU0NQ==", "url": "https://github.com/ConsenSys/teku/pull/2083#discussion_r437079545", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        # retrieve branch to publish to from CIrcle CI env vars and fallback on test-gh-pages\n          \n          \n            \n                        # retrieve branch to publish to from Circle CI env vars and fallback on test-gh-pages", "author": "ajsutton", "createdAt": "2020-06-09T00:59:09Z", "path": ".circleci/config.yml", "diffHunk": "@@ -307,53 +307,88 @@ jobs:\n             kill $TEKU_PID\n             exit $EXIT_CODE\n       - store_artifacts:\n-          path: openapi.json\n+          path: ./docs/openapi.json\n       - store_artifacts:\n           path: teku_output.log\n       - persist_to_workspace:\n           root: ~/project\n           paths:\n-            - ./\n+            - ./docs/openapi.json\n \n   publishAPIDoc:\n     executor: node_executor\n     steps:\n+      # This job requires that we checkout current branch first to have all the repos.\n+      # it will not be used directly as we have the saved workspace\n+      # but will enable to checkout gh-pages branch.\n       - checkout\n       - attach_workspace:\n-          at: ~/project\n-      - add_ssh_keys:\n-          fingerprints:\n-            - '45:36:58:67:43:15:c6:5f:2c:58:ec:7f:71:e2:e6:ef'\n+          at: /tmp/workspace\n       - run:\n-          name: Set Git user params\n+          name: checkout gh pages branch and copy files from workspace\n           command: |\n-            git config --global user.name $CIRCLE_USERNAME\n-            git config --global user.email \"${CIRCLE_USERNAME}@users.noreply.github.com\"\n+            # publishing happens by pushing files to gh-pages branch\n+            # retrieve branch to publish to from CIrcle CI env vars and fallback on test-gh-pages", "originalCommit": "3073785aa6f6b04c037607b7e8b17ad62c527dee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3OTkwMg==", "url": "https://github.com/ConsenSys/teku/pull/2083#discussion_r437079902", "bodyText": "I'd suggest we should fall back to gh-pages so that the code says what it will do in the normal case.  Removing the BRANCH_OVERRIDE is probably ideal if we can so that you don't have to go digging through CircleCI to find out what this will actually do.", "author": "ajsutton", "createdAt": "2020-06-09T01:00:27Z", "path": ".circleci/config.yml", "diffHunk": "@@ -307,53 +307,88 @@ jobs:\n             kill $TEKU_PID\n             exit $EXIT_CODE\n       - store_artifacts:\n-          path: openapi.json\n+          path: ./docs/openapi.json\n       - store_artifacts:\n           path: teku_output.log\n       - persist_to_workspace:\n           root: ~/project\n           paths:\n-            - ./\n+            - ./docs/openapi.json\n \n   publishAPIDoc:\n     executor: node_executor\n     steps:\n+      # This job requires that we checkout current branch first to have all the repos.\n+      # it will not be used directly as we have the saved workspace\n+      # but will enable to checkout gh-pages branch.\n       - checkout\n       - attach_workspace:\n-          at: ~/project\n-      - add_ssh_keys:\n-          fingerprints:\n-            - '45:36:58:67:43:15:c6:5f:2c:58:ec:7f:71:e2:e6:ef'\n+          at: /tmp/workspace\n       - run:\n-          name: Set Git user params\n+          name: checkout gh pages branch and copy files from workspace\n           command: |\n-            git config --global user.name $CIRCLE_USERNAME\n-            git config --global user.email \"${CIRCLE_USERNAME}@users.noreply.github.com\"\n+            # publishing happens by pushing files to gh-pages branch\n+            # retrieve branch to publish to from CIrcle CI env vars and fallback on test-gh-pages\n+            # if no var defined\n+            [ -n \"$BRANCH_OVERRIDE\" ] && readonly BRANCH=\"$BRANCH_OVERRIDE\" || readonly BRANCH='test-gh-pages'", "originalCommit": "3073785aa6f6b04c037607b7e8b17ad62c527dee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ5NDMyNg==", "url": "https://github.com/ConsenSys/teku/pull/2083#discussion_r437494326", "bodyText": "This code was suggested by @benjamincburns so I would like his opinion on that.", "author": "NicolasMassart", "createdAt": "2020-06-09T15:03:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3OTkwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYxNTk3MQ==", "url": "https://github.com/ConsenSys/teku/pull/2083#discussion_r437615971", "bodyText": "I agree with @ajsutton - his approach is better than the one I suggested.", "author": "benjamincburns", "createdAt": "2020-06-09T17:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3OTkwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA4MDA5OQ==", "url": "https://github.com/ConsenSys/teku/pull/2083#discussion_r437080099", "bodyText": "Should we delete the existing content first?  Otherwise if a file is moved both versions will stay around forever with one being stale.", "author": "ajsutton", "createdAt": "2020-06-09T01:01:12Z", "path": ".circleci/config.yml", "diffHunk": "@@ -307,53 +307,88 @@ jobs:\n             kill $TEKU_PID\n             exit $EXIT_CODE\n       - store_artifacts:\n-          path: openapi.json\n+          path: ./docs/openapi.json\n       - store_artifacts:\n           path: teku_output.log\n       - persist_to_workspace:\n           root: ~/project\n           paths:\n-            - ./\n+            - ./docs/openapi.json\n \n   publishAPIDoc:\n     executor: node_executor\n     steps:\n+      # This job requires that we checkout current branch first to have all the repos.\n+      # it will not be used directly as we have the saved workspace\n+      # but will enable to checkout gh-pages branch.\n       - checkout\n       - attach_workspace:\n-          at: ~/project\n-      - add_ssh_keys:\n-          fingerprints:\n-            - '45:36:58:67:43:15:c6:5f:2c:58:ec:7f:71:e2:e6:ef'\n+          at: /tmp/workspace\n       - run:\n-          name: Set Git user params\n+          name: checkout gh pages branch and copy files from workspace\n           command: |\n-            git config --global user.name $CIRCLE_USERNAME\n-            git config --global user.email \"${CIRCLE_USERNAME}@users.noreply.github.com\"\n+            # publishing happens by pushing files to gh-pages branch\n+            # retrieve branch to publish to from CIrcle CI env vars and fallback on test-gh-pages\n+            # if no var defined\n+            [ -n \"$BRANCH_OVERRIDE\" ] && readonly BRANCH=\"$BRANCH_OVERRIDE\" || readonly BRANCH='test-gh-pages'\n+\n+            # switch to the publishing branch\n+            git checkout \"$BRANCH\"\n+\n+            # copy the content of the docs folder built on the previous job and attached\n+            # using workspace on temp location\n+            # cp with T option to override existing content, specially usefull for latest\n+            cp -aT /tmp/workspace/docs/. .", "originalCommit": "3073785aa6f6b04c037607b7e8b17ad62c527dee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ5MzY2Nw==", "url": "https://github.com/ConsenSys/teku/pull/2083#discussion_r437493667", "bodyText": "We want to keep the content to preserve all the specs from previous versions. If any changes are made that require to delete some files from gh-pages branch, it would be done by someone knowing the system and who will be able to update the gh-pages branch manually. It should not be a process that will be used often, so I prefer not to build a complex thing and potential bugs for that.", "author": "NicolasMassart", "createdAt": "2020-06-09T15:02:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA4MDA5OQ=="}], "type": "inlineReview"}, {"oid": "3dc31add4d383f74d497d02a5da39b7444a18ce8", "url": "https://github.com/ConsenSys/teku/commit/3dc31add4d383f74d497d02a5da39b7444a18ce8", "message": "typo", "committedDate": "2020-06-09T15:04:43Z", "type": "commit"}, {"oid": "fa5c6b3f9c37389a29944975b666be788e1d069c", "url": "https://github.com/ConsenSys/teku/commit/fa5c6b3f9c37389a29944975b666be788e1d069c", "message": "updated branch name override per review comment\n\nand added a more explicit name as otherwise we don't know what branch\noverride it is about.", "committedDate": "2020-06-10T08:57:52Z", "type": "commit"}, {"oid": "c7b865d9f0fecc8365c8247a5ea0359363158b01", "url": "https://github.com/ConsenSys/teku/commit/c7b865d9f0fecc8365c8247a5ea0359363158b01", "message": "Merge branch 'master' into 1826-api-doc-on-CI", "committedDate": "2020-06-11T07:08:57Z", "type": "commit"}, {"oid": "1c94fefab4ba803e0e33a4170d0455627de18d26", "url": "https://github.com/ConsenSys/teku/commit/1c94fefab4ba803e0e33a4170d0455627de18d26", "message": "remove test publishing", "committedDate": "2020-06-11T07:43:35Z", "type": "commit"}]}