{"pr_number": 1632, "pr_title": "Optimize: batch BLS verification ", "pr_createdAt": "2020-04-21T18:15:07Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1632", "timeline": [{"oid": "c338993a058e450573aa896107c72b1f161490b9", "url": "https://github.com/ConsenSys/teku/commit/c338993a058e450573aa896107c72b1f161490b9", "message": "Make some bls mikuli members accessible", "committedDate": "2020-04-10T08:10:48Z", "type": "commit"}, {"oid": "cd30c918a6a7ad645222c575b244141fb286b114", "url": "https://github.com/ConsenSys/teku/commit/cd30c918a6a7ad645222c575b244141fb286b114", "message": "Add batch BLS bench and test", "committedDate": "2020-04-10T08:11:06Z", "type": "commit"}, {"oid": "c2635de483e9a06e3adc6625020a2fca244e1f7c", "url": "https://github.com/ConsenSys/teku/commit/c2635de483e9a06e3adc6625020a2fca244e1f7c", "message": "Fix batch BLS verification", "committedDate": "2020-04-16T12:20:06Z", "type": "commit"}, {"oid": "6acc934c7212111c7845ce31e7a20362ee6bdd8c", "url": "https://github.com/ConsenSys/teku/commit/6acc934c7212111c7845ce31e7a20362ee6bdd8c", "message": "Merge branch 'master' into optimize-batch-bls", "committedDate": "2020-04-17T17:24:50Z", "type": "commit"}, {"oid": "18747abb472a527527aa7f378e800d5360df479d", "url": "https://github.com/ConsenSys/teku/commit/18747abb472a527527aa7f378e800d5360df479d", "message": "Separate block processing and validation", "committedDate": "2020-04-17T17:56:13Z", "type": "commit"}, {"oid": "67c093f4f18998a4ea4a417dfcad96c03cff1b2b", "url": "https://github.com/ConsenSys/teku/commit/67c093f4f18998a4ea4a417dfcad96c03cff1b2b", "message": "Add batch verify methods to BLS", "committedDate": "2020-04-20T10:17:57Z", "type": "commit"}, {"oid": "92d4ef6b9fd96e57cf857cbccfac28209d264668", "url": "https://github.com/ConsenSys/teku/commit/92d4ef6b9fd96e57cf857cbccfac28209d264668", "message": "Fix BIG constant initialization", "committedDate": "2020-04-20T11:39:55Z", "type": "commit"}, {"oid": "3726c6a50faa472f911d17233a4012686e465624", "url": "https://github.com/ConsenSys/teku/commit/3726c6a50faa472f911d17233a4012686e465624", "message": "Support aggregated signature verification in batching verification methods", "committedDate": "2020-04-20T11:40:58Z", "type": "commit"}, {"oid": "fca708f75fe29087e3726de96bd512b0b78b6edd", "url": "https://github.com/ConsenSys/teku/commit/fca708f75fe29087e3726de96bd512b0b78b6edd", "message": "Add BLSSignatureVerifier interface and pass it to spec methods for BLS validation. Add BatchBlockValidator", "committedDate": "2020-04-20T11:44:09Z", "type": "commit"}, {"oid": "08ac117fe847c000d35ac16ed08d2f15bd34d327", "url": "https://github.com/ConsenSys/teku/commit/08ac117fe847c000d35ac16ed08d2f15bd34d327", "message": "Use BatchBlockValidator in StateTransition by default", "committedDate": "2020-04-20T11:45:07Z", "type": "commit"}, {"oid": "8d785829464029c7aab1e13db819104346841af0", "url": "https://github.com/ConsenSys/teku/commit/8d785829464029c7aab1e13db819104346841af0", "message": "Adjust BLSBenchmark to use public files. Remove obsolete test", "committedDate": "2020-04-20T11:45:45Z", "type": "commit"}, {"oid": "a19797e00e329c888628e673382665fdf5884543", "url": "https://github.com/ConsenSys/teku/commit/a19797e00e329c888628e673382665fdf5884543", "message": "Get rid of obsolete final exp in BLS batch verify", "committedDate": "2020-04-21T12:13:11Z", "type": "commit"}, {"oid": "0a070058dd7cf732652fcc85dec9f2ddfe87820c", "url": "https://github.com/ConsenSys/teku/commit/0a070058dd7cf732652fcc85dec9f2ddfe87820c", "message": "Update Block dumps to spec v0.11", "committedDate": "2020-04-21T12:14:02Z", "type": "commit"}, {"oid": "84880471b996959f85a9d996ba45d7928d06da6d", "url": "https://github.com/ConsenSys/teku/commit/84880471b996959f85a9d996ba45d7928d06da6d", "message": "Make it possible to validate a block with postState: get slot from block", "committedDate": "2020-04-21T13:10:04Z", "type": "commit"}, {"oid": "a605af4561d25b024e3ca8c5c6e53438f7a23e64", "url": "https://github.com/ConsenSys/teku/commit/a605af4561d25b024e3ca8c5c6e53438f7a23e64", "message": "Use SecureRandomProvider insead of Milagro RAND which has issues", "committedDate": "2020-04-21T13:20:53Z", "type": "commit"}, {"oid": "ba949f5696d69c7a3f94e94326ec8854a6de9eee", "url": "https://github.com/ConsenSys/teku/commit/ba949f5696d69c7a3f94e94326ec8854a6de9eee", "message": "Add BLS primitives benchmarks", "committedDate": "2020-04-21T13:22:05Z", "type": "commit"}, {"oid": "0b8860d0967a16cfed78308b87947c544c57d8e7", "url": "https://github.com/ConsenSys/teku/commit/0b8860d0967a16cfed78308b87947c544c57d8e7", "message": "Update BLSBenchmark", "committedDate": "2020-04-21T13:25:46Z", "type": "commit"}, {"oid": "420423c8e8382d475d168db7fb07e1bfdbe68b5d", "url": "https://github.com/ConsenSys/teku/commit/420423c8e8382d475d168db7fb07e1bfdbe68b5d", "message": "Remove circle modules dependency", "committedDate": "2020-04-21T17:28:34Z", "type": "commit"}, {"oid": "bc19834ff5667007e5fe59440855a844e5e8c335", "url": "https://github.com/ConsenSys/teku/commit/bc19834ff5667007e5fe59440855a844e5e8c335", "message": "Add different batch BLS benchmarks", "committedDate": "2020-04-21T17:29:31Z", "type": "commit"}, {"oid": "da62b32f3ea97c7ada978d6bc09b27f8e0f41815", "url": "https://github.com/ConsenSys/teku/commit/da62b32f3ea97c7ada978d6bc09b27f8e0f41815", "message": "Add a variant of batch BLS verification which uses optimized ate2 pairing. BLS.batchVerify() chooses the fastest option", "committedDate": "2020-04-21T17:38:43Z", "type": "commit"}, {"oid": "dd53a1de30a60e26fffe07b187b4a92ee867a0dd", "url": "https://github.com/ConsenSys/teku/commit/dd53a1de30a60e26fffe07b187b4a92ee867a0dd", "message": "Fix BLSPrimitivesBenchmark for more stable results", "committedDate": "2020-04-21T17:53:42Z", "type": "commit"}, {"oid": "db31a9df33b7c69a296e3b5d9cfd2e3d5dad6ed4", "url": "https://github.com/ConsenSys/teku/commit/db31a9df33b7c69a296e3b5d9cfd2e3d5dad6ed4", "message": "Apply Spotless", "committedDate": "2020-04-21T18:13:10Z", "type": "commit"}, {"oid": "f5df28dd65747f666a8111c1e984730eb687dc92", "url": "https://github.com/ConsenSys/teku/commit/f5df28dd65747f666a8111c1e984730eb687dc92", "message": "Temp suppress warning", "committedDate": "2020-04-21T18:23:22Z", "type": "commit"}, {"oid": "fe7af17762e972acbad13718359dc9ff91dc0f1c", "url": "https://github.com/ConsenSys/teku/commit/fe7af17762e972acbad13718359dc9ff91dc0f1c", "message": "Add a couple of clarification comments", "committedDate": "2020-04-22T10:51:21Z", "type": "commit"}, {"oid": "89cfb29d63730ef169af2efbf7982c1a751ee132", "url": "https://github.com/ConsenSys/teku/commit/89cfb29d63730ef169af2efbf7982c1a751ee132", "message": "Minor updates", "committedDate": "2020-04-22T17:23:29Z", "type": "commit"}, {"oid": "0fd56f9089f63f8bfa4b9c5bd1df6355570f9663", "url": "https://github.com/ConsenSys/teku/commit/0fd56f9089f63f8bfa4b9c5bd1df6355570f9663", "message": "Fix the state a block should be validated against", "committedDate": "2020-04-22T17:54:15Z", "type": "commit"}, {"oid": "0117b888b2ed23ef7aaafc3631b0b642b6e5fe03", "url": "https://github.com/ConsenSys/teku/commit/0117b888b2ed23ef7aaafc3631b0b642b6e5fe03", "message": "Make strict spec block processing methods naming: those which just validate, those which process but not validate, defaults methods which do both", "committedDate": "2020-04-22T19:48:13Z", "type": "commit"}, {"oid": "4bf903c61f5a4dc48a58001c446c994e4213860c", "url": "https://github.com/ConsenSys/teku/commit/4bf903c61f5a4dc48a58001c446c994e4213860c", "message": "Make the right order of processing and BLS verification for ref tests", "committedDate": "2020-04-22T20:05:47Z", "type": "commit"}, {"oid": "961d401c564026905e47a4a4ffd10642cf5b2c00", "url": "https://github.com/ConsenSys/teku/commit/961d401c564026905e47a4a4ffd10642cf5b2c00", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-batch-bls", "committedDate": "2020-04-23T09:24:01Z", "type": "commit"}, {"oid": "20f26c1966520ec50ec60d58e852af6e2536d418", "url": "https://github.com/ConsenSys/teku/commit/20f26c1966520ec50ec60d58e852af6e2536d418", "message": "Add blocks dump for 64K validators", "committedDate": "2020-04-23T09:25:44Z", "type": "commit"}, {"oid": "faf20516166e1a8b0096d6901c48c567dbc23a73", "url": "https://github.com/ConsenSys/teku/commit/faf20516166e1a8b0096d6901c48c567dbc23a73", "message": "Add some javadoc", "committedDate": "2020-04-23T14:29:50Z", "type": "commit"}, {"oid": "f1b60418d5366471a9789756912fae6dbfc6f073", "url": "https://github.com/ConsenSys/teku/commit/f1b60418d5366471a9789756912fae6dbfc6f073", "message": "Add more javadocs", "committedDate": "2020-04-23T16:33:21Z", "type": "commit"}, {"oid": "e5dea1867d6549fb945ca9747f7e7dab7a35455e", "url": "https://github.com/ConsenSys/teku/commit/e5dea1867d6549fb945ca9747f7e7dab7a35455e", "message": "Create random properly", "committedDate": "2020-04-23T16:42:07Z", "type": "commit"}, {"oid": "9a529199c77d788614f9f65439cdc7b6718fa0f1", "url": "https://github.com/ConsenSys/teku/commit/9a529199c77d788614f9f65439cdc7b6718fa0f1", "message": "Remove optimization TODO: GT mul is pretty cheap and the gain would be minimal", "committedDate": "2020-04-23T16:58:38Z", "type": "commit"}, {"oid": "8f598c2fa48e6e7e17fd44940daec20c97867085", "url": "https://github.com/ConsenSys/teku/commit/8f598c2fa48e6e7e17fd44940daec20c97867085", "message": "Add batch BLS verify related unit tests", "committedDate": "2020-04-23T18:03:08Z", "type": "commit"}, {"oid": "852361f8e1bc64ce4f956cc4b54a46ddca04fa8a", "url": "https://github.com/ConsenSys/teku/commit/852361f8e1bc64ce4f956cc4b54a46ddca04fa8a", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-batch-bls", "committedDate": "2020-04-23T18:13:00Z", "type": "commit"}, {"oid": "6ed1f4eb62f85f6d4a535ece5e7e77bbbdba305b", "url": "https://github.com/ConsenSys/teku/commit/6ed1f4eb62f85f6d4a535ece5e7e77bbbdba305b", "message": "Fix errorprone warn", "committedDate": "2020-04-23T18:25:35Z", "type": "commit"}, {"oid": "c0548099adb8427faca5a37042e98050a75e62e0", "url": "https://github.com/ConsenSys/teku/commit/c0548099adb8427faca5a37042e98050a75e62e0", "message": "Move equals/hashCode for all AbstractImmutableContainer implementations to superclass", "committedDate": "2020-04-24T08:47:54Z", "type": "commit"}, {"oid": "c3e8c2e34c5af675364f3f771f868209543d5d01", "url": "https://github.com/ConsenSys/teku/commit/c3e8c2e34c5af675364f3f771f868209543d5d01", "message": "Revert accidentally committed change", "committedDate": "2020-04-24T11:51:11Z", "type": "commit"}, {"oid": "d0ce2119608b60b06f78ec9d273153d6b04d3083", "url": "https://github.com/ConsenSys/teku/commit/d0ce2119608b60b06f78ec9d273153d6b04d3083", "message": "Use non-secure Random since hitting Linux secure random issue.", "committedDate": "2020-04-25T11:41:13Z", "type": "commit"}, {"oid": "cce5e0a766a0eab6c149dd8650f3efef80c39c9f", "url": "https://github.com/ConsenSys/teku/commit/cce5e0a766a0eab6c149dd8650f3efef80c39c9f", "message": "Apply spotless", "committedDate": "2020-04-25T11:47:31Z", "type": "commit"}, {"oid": "157e81dac33be0532bfdfcd9ac06b970215e61a1", "url": "https://github.com/ConsenSys/teku/commit/157e81dac33be0532bfdfcd9ac06b970215e61a1", "message": "Split large test to smaller cases", "committedDate": "2020-04-25T14:47:47Z", "type": "commit"}, {"oid": "4d82f33da27060ac3eaa9e02216c2d4cbdc5d368", "url": "https://github.com/ConsenSys/teku/commit/4d82f33da27060ac3eaa9e02216c2d4cbdc5d368", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-batch-bls", "committedDate": "2020-04-25T14:47:55Z", "type": "commit"}, {"oid": "cc733e16da63818508a64fd58a823f2b8c4e8f46", "url": "https://github.com/ConsenSys/teku/commit/cc733e16da63818508a64fd58a823f2b8c4e8f46", "message": "Apply spotless", "committedDate": "2020-04-25T14:53:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUwMDYyNA==", "url": "https://github.com/ConsenSys/teku/pull/1632#discussion_r415500624", "bodyText": "That linux bug was fixed in JDK 7 which we don't support anymore.  Java SecureRandom now uses /dev/urandom.", "author": "ajsutton", "createdAt": "2020-04-27T04:26:00Z", "path": "bls/src/main/java/tech/pegasys/artemis/bls/mikuli/BLS12381.java", "diffHunk": "@@ -42,6 +45,43 @@\n  */\n public final class BLS12381 {\n \n+  private static final long MAX_BATCH_VERIFY_RANDOM_MULTIPLIER = Long.MAX_VALUE;\n+\n+  private static Random getRND() {\n+    // Milagro RAND has some issues with generating 'small' random numbers\n+    // and is not thread safe\n+    // Using non-secure random due to the JDK Linux secure random issue:\n+    // https://bugs.java.com/bugdatabase/view_bug.do?bug_id=6521844\n+    // A potential attack here has a very limited application and is not feasible\n+    // Thus using non-secure random doesn't significantly mitigate the security\n+    return ThreadLocalRandom.current();", "originalCommit": "cc733e16da63818508a64fd58a823f2b8c4e8f46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY4OTM0MA==", "url": "https://github.com/ConsenSys/teku/pull/1632#discussion_r415689340", "bodyText": "Yeah, mixed up Updated and Resolved dates. Thought it just was recently fixed.\nHowever while running the test with SecureRandom on Linux (I reproduced on Ubuntu 18, the same behavior was on the Travis) it stuck for 30 mins with this stack trace:\n    java.lang.Thread.State: RUNNABLE\n        at java.io.FileInputStream.readBytes(java.base@11.0.7/Native Method)\n        at java.io.FileInputStream.read(java.base@11.0.7/FileInputStream.java:279)\n        at java.io.FilterInputStream.read(java.base@11.0.7/FilterInputStream.java:133)\n        at sun.security.provider.NativePRNG$RandomIO.readFully(java.base@11.0.7/NativePRNG.java:424)\n        at sun.security.provider.NativePRNG$RandomIO.ensureBufferValid(java.base@11.0.7/NativePRNG.java:526)\n        at sun.security.provider.NativePRNG$RandomIO.implNextBytes(java.base@11.0.7/NativePRNG.java:545)\n        - locked <0x00000007004ac3c0> (a java.lang.Object)\n        at sun.security.provider.NativePRNG$Blocking.engineNextBytes(java.base@11.0.7/NativePRNG.java:268)\n        at java.security.SecureRandom.nextBytes(java.base@11.0.7/SecureRandom.java:742)\n        at java.security.SecureRandom.next(java.base@11.0.7/SecureRandom.java:799)\n        at java.util.Random.nextLong(java.base@11.0.7/Random.java:424)\n        at tech.pegasys.artemis.bls.mikuli.BLS12381.nextBatchRandomMultiplier(BLS12381.java:325)\n        at tech.pegasys.artemis.bls.mikuli.BLS12381.prepareBatchVerify(BLS12381.java:240)\n        at tech.pegasys.artemis.bls.mikuli.BLS12381Test.lambda$batchVerifyTest$4(BLS12381Test.java:178)\n        at tech.pegasys.artemis.bls.mikuli.BLS12381Test$$Lambda$464/0x00000008401ec040.apply(Unknown Source)\n\nHere are opened files:\nubuntu@ip-172-31-30-114:~/jvm-libp2p$ lsof -p 16745 | grep random\njava    16745 ubuntu   96r      CHR                1,8       0t0     10 /dev/random\njava    16745 ubuntu   97r      CHR                1,9       0t0     11 /dev/urandom\n\nAlso found another related JDK bug (which was also fixed) : https://bugs.java.com/bugdatabase/view_bug.do?bug_id=JDK-8098581\nAs we discussed with @benjaminion this place is not critical for using secure random, but there is SecureRandomProvider which may potentially hit the same issue. Added Jira issue: BC-396", "author": "Nashatyrev", "createdAt": "2020-04-27T10:17:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUwMDYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY5MTc5NQ==", "url": "https://github.com/ConsenSys/teku/pull/1632#discussion_r415691795", "bodyText": "Here is the java version:\nopenjdk version \"11.0.7\" 2020-04-14\nOpenJDK Runtime Environment (build 11.0.7+10-post-Ubuntu-2ubuntu218.04)\nOpenJDK 64-Bit Server VM (build 11.0.7+10-post-Ubuntu-2ubuntu218.04, mixed mode, sharing)\n\nHere is the commit on which the issue is reproduced: c3e8c2e", "author": "Nashatyrev", "createdAt": "2020-04-27T10:21:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUwMDYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjE1NjYyMQ==", "url": "https://github.com/ConsenSys/teku/pull/1632#discussion_r416156621", "bodyText": "hmm, we went through this in a lot of detail as part of Pantheon's security audit and confirmed Java would use /dev/urandom.  Originally Pantheon had overridden it to use /dev/random because that's \"more secure\" (the auditors disagreed, arguments ensued, /dev/urandom eventually won because it made the auditors happy and actually worked).\nIt looks a bit more complex than I remember it and is now trying to look up egdSource via security properties - specifically the securerandom.source security property. Interestingly AdoptOpenJDK 11 on Mac sets that to file:/dev/random so potentially Java has changed again.  I'm a little surprised Besu hasn't run into this as it uses a lot of entropy (mostly from discovery messages IIRC).\nI'm personally not too concerned about using plain Random here though I suspect we'll get dinged for it in the audit.  And we're going to have to ensure people at least know how to select /dev/urandom as the source instead of /dev/random and possibly find a way to set it as the default.", "author": "ajsutton", "createdAt": "2020-04-27T21:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUwMDYyNA=="}], "type": "inlineReview"}]}