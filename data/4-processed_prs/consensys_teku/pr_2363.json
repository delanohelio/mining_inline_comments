{"pr_number": 2363, "pr_title": "Add ability to disable BLS verification for fuzzing ", "pr_createdAt": "2020-07-16T16:13:28Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2363", "timeline": [{"oid": "bb6f4b732bf8c47a08f6e35a9a7c31ba3d390b1b", "url": "https://github.com/ConsenSys/teku/commit/bb6f4b732bf8c47a08f6e35a9a7c31ba3d390b1b", "message": "Implement fuzzing block validator", "committedDate": "2020-07-16T15:49:41Z", "type": "commit"}, {"oid": "a42f411b2392b52ad95095941410f9089cf4e451", "url": "https://github.com/ConsenSys/teku/commit/a42f411b2392b52ad95095941410f9089cf4e451", "message": "Disable BLS verification & run spotless", "committedDate": "2020-07-16T15:50:16Z", "type": "commit"}, {"oid": "b0a6db4654db2c61613be6fb96133e78f7c047e2", "url": "https://github.com/ConsenSys/teku/commit/b0a6db4654db2c61613be6fb96133e78f7c047e2", "message": "Remove fuzzing package", "committedDate": "2020-07-16T16:01:12Z", "type": "commit"}, {"oid": "4e0faa5ebe8aaa54de123069d6ff75aec00b43f1", "url": "https://github.com/ConsenSys/teku/commit/4e0faa5ebe8aaa54de123069d6ff75aec00b43f1", "message": "Add test", "committedDate": "2020-07-16T16:11:42Z", "type": "commit"}, {"oid": "0f7a07bdca097b14ca79a500756a1ecd284d365c", "url": "https://github.com/ConsenSys/teku/commit/0f7a07bdca097b14ca79a500756a1ecd284d365c", "message": "Merge branch 'master' into implementBLSdisabling", "committedDate": "2020-07-16T16:13:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyMDU2NQ==", "url": "https://github.com/ConsenSys/teku/pull/2363#discussion_r455920565", "bodyText": "Seems to be a duplicate line", "author": "benjaminion", "createdAt": "2020-07-16T16:36:24Z", "path": "bls/build.gradle", "diffHunk": "@@ -3,6 +3,7 @@ dependencies {\n \n   api 'org.bouncycastle:bcprov-jdk15on'\n \n+  implementation 'org.apache.tuweni:tuweni-bytes'", "originalCommit": "0f7a07bdca097b14ca79a500756a1ecd284d365c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk4NjAwMA==", "url": "https://github.com/ConsenSys/teku/pull/2363#discussion_r455986000", "bodyText": "Removed.", "author": "cemozerr", "createdAt": "2020-07-16T18:24:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyMDU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyMjk1NA==", "url": "https://github.com/ConsenSys/teku/pull/2363#discussion_r455922954", "bodyText": "I would localize this flag usage inside BLS module only.\nYou may alter  BLS.prepareBatchVerify and BLS.completeBatchVerify behavior based on this flag", "author": "Nashatyrev", "createdAt": "2020-07-16T16:40:15Z", "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/blockvalidator/BatchSignatureVerifier.java", "diffHunk": "@@ -68,6 +74,10 @@ public synchronized boolean verify(\n    * instance methods would fail with exception\n    */\n   public synchronized boolean batchVerify() {\n+    if (!BLSConstants.VERIFICATION_ENABLED) {\n+      LOG.warn(\"Skipping bls verification.\");\n+      return true;\n+    }", "originalCommit": "0f7a07bdca097b14ca79a500756a1ecd284d365c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxMzgwNw==", "url": "https://github.com/ConsenSys/teku/pull/2363#discussion_r456013807", "bodyText": "Decided to skip on this as discussed offline.", "author": "cemozerr", "createdAt": "2020-07-16T19:14:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyMjk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxODIzNw==", "url": "https://github.com/ConsenSys/teku/pull/2363#discussion_r456018237", "bodyText": "I've localized the flag but kept the BLS.prepareBatchVerify functionality the same.", "author": "cemozerr", "createdAt": "2020-07-16T19:22:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyMjk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyMzg5OQ==", "url": "https://github.com/ConsenSys/teku/pull/2363#discussion_r455923899", "bodyText": "This may be too pernickety, but I'd much rather see the constant named VERIFICATION_DISABLED. This for a couple of reasons:\n\nIt's easy to lose/forget the ! at the start. It's an extra cognitive step (got to work out \"not false\"), and I've seen really stupid errors arise as a result of simple things like this.\nThe normal case is \"enabled\", flagging DISABLED in big letters shows more clearly that this is an exceptional path.", "author": "benjaminion", "createdAt": "2020-07-16T16:41:46Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/BLS.java", "diffHunk": "@@ -65,6 +69,10 @@ public static BLSSignature sign(BLSSecretKey secretKey, Bytes message) {\n    * @return True if the verification is successful, false otherwise.\n    */\n   public static boolean verify(BLSPublicKey publicKey, Bytes message, BLSSignature signature) {\n+    if (!BLSConstants.VERIFICATION_ENABLED) {", "originalCommit": "0f7a07bdca097b14ca79a500756a1ecd284d365c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxNTk3OA==", "url": "https://github.com/ConsenSys/teku/pull/2363#discussion_r456015978", "bodyText": "I think it makes a lot of sense.", "author": "cemozerr", "createdAt": "2020-07-16T19:18:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyMzg5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxNjAyNg==", "url": "https://github.com/ConsenSys/teku/pull/2363#discussion_r456016026", "bodyText": "Done.", "author": "cemozerr", "createdAt": "2020-07-16T19:18:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyMzg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk0ODYzNg==", "url": "https://github.com/ConsenSys/teku/pull/2363#discussion_r455948636", "bodyText": "BTW wouldn't there be a flood of WARN logs when fuzz testing?", "author": "Nashatyrev", "createdAt": "2020-07-16T17:22:23Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/BLS.java", "diffHunk": "@@ -130,6 +138,10 @@ public static boolean aggregateVerify(\n    */\n   public static boolean fastAggregateVerify(\n       List<BLSPublicKey> publicKeys, Bytes message, BLSSignature signature) {\n+    if (!BLSConstants.VERIFICATION_ENABLED) {\n+      LOG.warn(\"Skipping bls verification.\");", "originalCommit": "0f7a07bdca097b14ca79a500756a1ecd284d365c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk1MDYzNg==", "url": "https://github.com/ConsenSys/teku/pull/2363#discussion_r455950636", "bodyText": "I think that's ok. We want to avoid a worst-case scenario in which somebody accidently runs without signature verification in production. Making it very noisy should help with this. I expect that fuzzers should ignore log lines, at least below ERROR level.", "author": "benjaminion", "createdAt": "2020-07-16T17:25:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk0ODYzNg=="}], "type": "inlineReview"}, {"oid": "6449a38cfc727dde375e844f7c5c373156c32256", "url": "https://github.com/ConsenSys/teku/commit/6449a38cfc727dde375e844f7c5c373156c32256", "message": "Add more checks", "committedDate": "2020-07-16T19:13:32Z", "type": "commit"}, {"oid": "058f9468eec56bdbb0ac1baf094fba3230be2e15", "url": "https://github.com/ConsenSys/teku/commit/058f9468eec56bdbb0ac1baf094fba3230be2e15", "message": "Switch from ENABLED to DISABLED", "committedDate": "2020-07-16T19:17:50Z", "type": "commit"}, {"oid": "5f63459cae7738f3ad0463e9c64909b2d4c28b10", "url": "https://github.com/ConsenSys/teku/commit/5f63459cae7738f3ad0463e9c64909b2d4c28b10", "message": "Localize flag checking", "committedDate": "2020-07-16T19:21:10Z", "type": "commit"}, {"oid": "78bfeb4cd890992c00e70f961c7c26ed37515160", "url": "https://github.com/ConsenSys/teku/commit/78bfeb4cd890992c00e70f961c7c26ed37515160", "message": "Run spotless", "committedDate": "2020-07-16T19:29:01Z", "type": "commit"}]}