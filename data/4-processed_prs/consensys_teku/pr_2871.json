{"pr_number": 2871, "pr_title": "[Issue-2273] Add option to bypass ws checks", "pr_createdAt": "2020-09-30T21:49:49Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2871", "timeline": [{"oid": "52031bad612ac5ffe9788f44a82c4c1b38bf875c", "url": "https://github.com/ConsenSys/teku/commit/52031bad612ac5ffe9788f44a82c4c1b38bf875c", "message": "Add hidden CLI option for suppressing ws errors", "committedDate": "2020-09-30T14:36:35Z", "type": "commit"}, {"oid": "3c5ba2d2920eedfb19c658e4b69ad449334bd4f6", "url": "https://github.com/ConsenSys/teku/commit/3c5ba2d2920eedfb19c658e4b69ad449334bd4f6", "message": "Store config directly in WeakSubjectivityValidator", "committedDate": "2020-09-30T15:27:38Z", "type": "commit"}, {"oid": "77f1540ed493eda814777892405c9cc4d8a01979", "url": "https://github.com/ConsenSys/teku/commit/77f1540ed493eda814777892405c9cc4d8a01979", "message": "Add logic to suppress weak subjectivity period errors", "committedDate": "2020-09-30T18:54:31Z", "type": "commit"}, {"oid": "6f98f5cd74a85496b9dea66fdaa1e26e88093708", "url": "https://github.com/ConsenSys/teku/commit/6f98f5cd74a85496b9dea66fdaa1e26e88093708", "message": "Fix logic to handle supplied and stored ws config", "committedDate": "2020-09-30T21:40:31Z", "type": "commit"}, {"oid": "b57893440dc770eca79f61a567540ef69122d055", "url": "https://github.com/ConsenSys/teku/commit/b57893440dc770eca79f61a567540ef69122d055", "message": "Fix periodic warning", "committedDate": "2020-09-30T21:47:05Z", "type": "commit"}, {"oid": "9e909384db31c9bd7b96fb0653e86d8d7f4d5acf", "url": "https://github.com/ConsenSys/teku/commit/9e909384db31c9bd7b96fb0653e86d8d7f4d5acf", "message": "Clean up", "committedDate": "2020-10-01T15:09:05Z", "type": "commit"}, {"oid": "6c70953f734a53e93829f7cdb96bb796ebac3310", "url": "https://github.com/ConsenSys/teku/commit/6c70953f734a53e93829f7cdb96bb796ebac3310", "message": "Remove comment", "committedDate": "2020-10-01T15:41:02Z", "type": "commit"}, {"oid": "e4a11c20071d7653cdadac6f3845d93ebf10f438", "url": "https://github.com/ConsenSys/teku/commit/e4a11c20071d7653cdadac6f3845d93ebf10f438", "message": "Merge branch 'master' into issue-2273/add-option-to-bypass-ws-checks", "committedDate": "2020-10-02T14:51:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY3MzIyNw==", "url": "https://github.com/ConsenSys/teku/pull/2871#discussion_r499673227", "bodyText": "I'm not quite sure if this warn would be visible in console? If not may be it makes sense to print to console as well?", "author": "Nashatyrev", "createdAt": "2020-10-05T15:11:52Z", "path": "ethereum/weaksubjectivity/src/main/java/tech/pegasys/teku/weaksubjectivity/WeakSubjectivityValidator.java", "diffHunk": "@@ -122,35 +125,41 @@ public void validateLatestFinalizedCheckpoint(\n       LOG.debug(\n           \"Latest finalized checkpoint at epoch {} is prior to weak subjectivity checkpoint at epoch {}. Defer validation.\",\n           latestFinalizedCheckpoint.getEpoch(),\n-          maybeWsCheckpoint.orElseThrow().getEpoch());\n+          config.getWeakSubjectivityCheckpoint().orElseThrow().getEpoch());\n       return;\n     }\n \n-    // Determine validity\n-    boolean isValid = true;\n-    if (isAtWSCheckpoint(latestFinalizedCheckpoint)) {\n-      // Roots must match\n-      isValid = isWSCheckpointRoot(latestFinalizedCheckpoint.getRoot());\n+    // Validate against ws checkpoint\n+    if (isAtWSCheckpoint(latestFinalizedCheckpoint)\n+        && !isWSCheckpointRoot(latestFinalizedCheckpoint.getRoot())) {\n+      // Finalized root is inconsistent with ws checkpoint\n+      handleInconsistentWsCheckpoint(latestFinalizedCheckpoint.getBlock());\n     }\n-    isValid = isValid && isWithinWSPeriod(latestFinalizedCheckpoint, currentSlot);\n-\n-    // Handle invalid checkpoint\n-    if (!isValid) {\n-      final int activeValidators =\n-          calculator.getActiveValidators(latestFinalizedCheckpoint.getState());\n-      for (WeakSubjectivityViolationPolicy policy : violationPolicies) {\n-        policy.onFinalizedCheckpointOutsideOfWeakSubjectivityPeriod(\n-            latestFinalizedCheckpoint, activeValidators, currentSlot);\n-      }\n+\n+    // Determine whether we should suppress ws period errors\n+    UInt64 currentEpoch = compute_epoch_at_slot(currentSlot);\n+    final Optional<UInt64> suppressionEpoch = getSuppressWSPeriodChecksUntilEpoch(currentSlot);\n+    final boolean shouldSuppressErrors =\n+        suppressionEpoch.map(e -> e.isGreaterThan(currentEpoch)).orElse(false);\n+\n+    // Validate against ws period\n+    final boolean withinWSPeriod = isWithinWSPeriod(latestFinalizedCheckpoint, currentSlot);\n+    if (!withinWSPeriod && !shouldSuppressErrors) {\n+      handleFinalizedCheckpointOutsideWSPeriod(latestFinalizedCheckpoint, currentSlot);\n+    } else if (!withinWSPeriod\n+        && currentSlot.mod(SUPPRESSION_WARNING_PERIOD_IN_SLOTS).equals(UInt64.ZERO)\n+        && getAndSetLastLoggedSlot(currentSlot).isLessThan(currentSlot)) {\n+      LOG.warn(\n+          \"Suppressing weak subjectivity errors until epoch {}\", suppressionEpoch.orElseThrow());", "originalCommit": "e4a11c20071d7653cdadac6f3845d93ebf10f438", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2NDUzNw==", "url": "https://github.com/ConsenSys/teku/pull/2871#discussion_r499764537", "bodyText": "hmm - good point", "author": "mbaxter", "createdAt": "2020-10-05T17:39:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY3MzIyNw=="}], "type": "inlineReview"}, {"oid": "48a91f563f19a29e9a2a3260f712463c9734275a", "url": "https://github.com/ConsenSys/teku/commit/48a91f563f19a29e9a2a3260f712463c9734275a", "message": "Send ws error suppression log to console", "committedDate": "2020-10-05T17:58:49Z", "type": "commit"}, {"oid": "c20167a35614eb83a90f21fb82bc8b2c5c9a4b55", "url": "https://github.com/ConsenSys/teku/commit/c20167a35614eb83a90f21fb82bc8b2c5c9a4b55", "message": "Merge branch 'master' into issue-2273/add-option-to-bypass-ws-checks", "committedDate": "2020-10-05T17:59:10Z", "type": "commit"}]}