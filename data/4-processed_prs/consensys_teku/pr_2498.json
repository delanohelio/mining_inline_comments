{"pr_number": 2498, "pr_title": "Add built-in slashing protection", "pr_createdAt": "2020-08-04T02:27:00Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2498", "timeline": [{"oid": "ffd70a1f6688f2ccd4e6c47d1ade31287dfa79af", "url": "https://github.com/ConsenSys/teku/commit/ffd70a1f6688f2ccd4e6c47d1ade31287dfa79af", "message": "Introduce slashing protection.", "committedDate": "2020-08-04T02:14:21Z", "type": "commit"}, {"oid": "db6774a6c78af7948f8225b825b479a28bfc8faa", "url": "https://github.com/ConsenSys/teku/commit/db6774a6c78af7948f8225b825b479a28bfc8faa", "message": "Add slashing protection.", "committedDate": "2020-08-04T02:24:54Z", "type": "commit"}, {"oid": "12be85e85388b6854297b7aca0edda740ce02fa6", "url": "https://github.com/ConsenSys/teku/commit/12be85e85388b6854297b7aca0edda740ce02fa6", "message": "Make errorprone happy.", "committedDate": "2020-08-04T03:33:27Z", "type": "commit"}, {"oid": "452e62302c9c88620ca5e64714590d9c77085356", "url": "https://github.com/ConsenSys/teku/commit/452e62302c9c88620ca5e64714590d9c77085356", "message": "Remove link since we didn't wind up basing off of that info.", "committedDate": "2020-08-04T03:48:23Z", "type": "commit"}, {"oid": "e7088e2b8c64ee8dfad57d97c8f7029760b7906b", "url": "https://github.com/ConsenSys/teku/commit/e7088e2b8c64ee8dfad57d97c8f7029760b7906b", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into slashing-protection", "committedDate": "2020-08-04T03:48:33Z", "type": "commit"}, {"oid": "ed17796049e9c699313276b0395a74d0df551172", "url": "https://github.com/ConsenSys/teku/commit/ed17796049e9c699313276b0395a74d0df551172", "message": "Add flat file slashing protection record.", "committedDate": "2020-08-04T05:58:53Z", "type": "commit"}, {"oid": "c0dec9332d820803a17aa1dba17cba38521c5b3e", "url": "https://github.com/ConsenSys/teku/commit/c0dec9332d820803a17aa1dba17cba38521c5b3e", "message": "Switch to a flat file based storage.", "committedDate": "2020-08-04T06:21:52Z", "type": "commit"}, {"oid": "eb485a91620cee93280689e9061c5f4350a38dcf", "url": "https://github.com/ConsenSys/teku/commit/eb485a91620cee93280689e9061c5f4350a38dcf", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into slashing-protection", "committedDate": "2020-08-04T06:22:18Z", "type": "commit"}, {"oid": "bb37e01e23988cde197f345d3dd739ad4829f298", "url": "https://github.com/ConsenSys/teku/commit/bb37e01e23988cde197f345d3dd739ad4829f298", "message": "Use a single flat file for block and attestation signing records.", "committedDate": "2020-08-04T09:10:40Z", "type": "commit"}, {"oid": "5760501d7b4a53cbbd6dd0ffecf7e0b22be8b209", "url": "https://github.com/ConsenSys/teku/commit/5760501d7b4a53cbbd6dd0ffecf7e0b22be8b209", "message": "Tidy up.", "committedDate": "2020-08-04T09:27:04Z", "type": "commit"}, {"oid": "f6000f4456bd650fb4fe3e7485f13dd925c77df8", "url": "https://github.com/ConsenSys/teku/commit/f6000f4456bd650fb4fe3e7485f13dd925c77df8", "message": "Remove redundant interface.", "committedDate": "2020-08-04T09:30:21Z", "type": "commit"}, {"oid": "bd042cd025a6974d718f1e1d4f70bf3011db480d", "url": "https://github.com/ConsenSys/teku/commit/bd042cd025a6974d718f1e1d4f70bf3011db480d", "message": "Serialize to YAML instead of SSZ.", "committedDate": "2020-08-05T00:18:19Z", "type": "commit"}, {"oid": "7569c2b70ad02a5600090d37d637f22175addea7", "url": "https://github.com/ConsenSys/teku/commit/7569c2b70ad02a5600090d37d637f22175addea7", "message": "Update expected filename.", "committedDate": "2020-08-05T00:39:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ1NDMyNA==", "url": "https://github.com/ConsenSys/teku/pull/2498#discussion_r465454324", "bodyText": "potentially if the ValidatorSigningRecord declaration is pulled out so this can collapse to one line, then it'd be a lot more readable.\nspotless wrapping it in this way really makes it difficult to read.", "author": "rolfyone", "createdAt": "2020-08-05T03:45:12Z", "path": "ethereum/core/src/test/java/tech/pegasys/teku/core/signatures/ValidatorSigningRecordTest.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.core.signatures;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.List;\n+import java.util.Optional;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import tech.pegasys.teku.core.signatures.record.ValidatorSigningRecord;\n+\n+class ValidatorSigningRecordTest {\n+\n+  @Test\n+  void shouldRoundTripDefaultValuesToBytes() {\n+    final ValidatorSigningRecord record = new ValidatorSigningRecord();\n+    final Bytes bytes = record.toBytes();\n+    final ValidatorSigningRecord result = ValidatorSigningRecord.fromBytes(bytes);\n+    assertThat(result).isEqualToComparingFieldByField(record);\n+  }\n+\n+  @Test\n+  void shouldRoundTripToBytes() {\n+    final ValidatorSigningRecord record =\n+        new ValidatorSigningRecord(\n+            UnsignedLong.valueOf(10), UnsignedLong.valueOf(20), UnsignedLong.valueOf(30));\n+    final Bytes bytes = record.toBytes();\n+    final ValidatorSigningRecord result = ValidatorSigningRecord.fromBytes(bytes);\n+    assertThat(result).isEqualToComparingFieldByField(record);\n+  }\n+\n+  @ParameterizedTest(name = \"signBlock({0})\")\n+  @MethodSource(\"blockCases\")\n+  void signBlock(\n+      @SuppressWarnings(\"unused\") final String name,\n+      final ValidatorSigningRecord input,\n+      final UnsignedLong slot,\n+      final Optional<ValidatorSigningRecord> expectedResult) {\n+    assertThat(input.maySignBlock(slot)).isEqualTo(expectedResult);\n+  }\n+\n+  static List<Arguments> blockCases() {\n+    final ValidatorSigningRecord startingRecord =\n+        new ValidatorSigningRecord(\n+            UnsignedLong.valueOf(3), UnsignedLong.valueOf(6), UnsignedLong.valueOf(7));\n+    return List.of(\n+        Arguments.of(\n+            \"noExistingRecord\",\n+            new ValidatorSigningRecord(),\n+            UnsignedLong.ONE,\n+            Optional.of(\n+                new ValidatorSigningRecord(\n+                    UnsignedLong.ONE,\n+                    ValidatorSigningRecord.NEVER_SIGNED,\n+                    ValidatorSigningRecord.NEVER_SIGNED))),\n+        Arguments.of(\"=\", startingRecord, UnsignedLong.valueOf(3), Optional.empty()),\n+        Arguments.of(\"<\", startingRecord, UnsignedLong.valueOf(2), Optional.empty()),\n+        Arguments.of(\n+            \">\",\n+            startingRecord,\n+            UnsignedLong.valueOf(4),\n+            Optional.of(\n+                new ValidatorSigningRecord(\n+                    UnsignedLong.valueOf(4), UnsignedLong.valueOf(6), UnsignedLong.valueOf(7)))));\n+  }\n+\n+  @ParameterizedTest(name = \"maySignAttestation({0})\")\n+  @MethodSource(\"attestationCases\")\n+  void maySignAttestation(\n+      @SuppressWarnings(\"unused\") final String name,\n+      final ValidatorSigningRecord input,\n+      final UnsignedLong sourceEpoch,\n+      final UnsignedLong targetEpoch,\n+      final Optional<ValidatorSigningRecord> expectedResult) {\n+    assertThat(input.maySignAttestation(sourceEpoch, targetEpoch)).isEqualTo(expectedResult);\n+  }\n+\n+  static List<Arguments> attestationCases() {\n+    final ValidatorSigningRecord startingRecord =\n+        new ValidatorSigningRecord(\n+            UnsignedLong.ONE, UnsignedLong.valueOf(4), UnsignedLong.valueOf(6));\n+    return List.of(\n+        // No record\n+        attestationArguments(\n+            \"NEVER_SIGNED\",\n+            \"NEVER_SIGNED\",\n+            new ValidatorSigningRecord(),\n+            1,\n+            2,\n+            Optional.of(\n+                new ValidatorSigningRecord(\n+                    UnsignedLong.ZERO, UnsignedLong.valueOf(1), UnsignedLong.valueOf(2)))),\n+        attestationArguments(\"=\", \"=\", startingRecord, 4, 6, Optional.empty()),\n+        attestationArguments(\"=\", \"<\", startingRecord, 4, 5, Optional.empty()),\n+        attestationArguments(\n+            \"=\",\n+            \">\",\n+            startingRecord,\n+            4,\n+            7,\n+            Optional.of(\n+                new ValidatorSigningRecord(\n+                    UnsignedLong.ONE, UnsignedLong.valueOf(4), UnsignedLong.valueOf(7)))),", "originalCommit": "7569c2b70ad02a5600090d37d637f22175addea7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ1NzAxMg==", "url": "https://github.com/ConsenSys/teku/pull/2498#discussion_r465457012", "bodyText": "Found some utility methods I could extract to make it work better with spotless.", "author": "ajsutton", "createdAt": "2020-08-05T03:56:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ1NDMyNA=="}], "type": "inlineReview"}, {"oid": "21a5726d74fbc1c07853ce96558f26fdb3e384aa", "url": "https://github.com/ConsenSys/teku/commit/21a5726d74fbc1c07853ce96558f26fdb3e384aa", "message": "Use helper methods to get lines to fit better.", "committedDate": "2020-08-05T03:55:43Z", "type": "commit"}, {"oid": "6f4d2419e989de6c28c101fcf6b78f4b2384661d", "url": "https://github.com/ConsenSys/teku/commit/6f4d2419e989de6c28c101fcf6b78f4b2384661d", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into slashing-protection", "committedDate": "2020-08-05T03:55:50Z", "type": "commit"}, {"oid": "3fdd623600801ae00e033387dbae298922430c47", "url": "https://github.com/ConsenSys/teku/commit/3fdd623600801ae00e033387dbae298922430c47", "message": "Use a subdir of validators in case we need the validator service to store more stuff.", "committedDate": "2020-08-05T04:04:37Z", "type": "commit"}, {"oid": "6a80aa6bbf75c52f4d90015ae9ba30a5bf631e90", "url": "https://github.com/ConsenSys/teku/commit/6a80aa6bbf75c52f4d90015ae9ba30a5bf631e90", "message": "Merge branch 'master' into slashing-protection", "committedDate": "2020-08-05T04:11:19Z", "type": "commit"}]}