{"pr_number": 3233, "pr_title": "update API doc publishing CI", "pr_createdAt": "2020-11-16T17:41:56Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3233", "timeline": [{"oid": "9d809b8faf48592babccf8b6e937edb322d504c6", "url": "https://github.com/ConsenSys/teku/commit/9d809b8faf48592babccf8b6e937edb322d504c6", "message": "update API doc CI\n\nSee ConsenSys/protocol-misc#203 and #3232", "committedDate": "2020-11-16T17:36:48Z", "type": "commit"}, {"oid": "a4535c31fab08339fbb881668d41ee59db341c2e", "url": "https://github.com/ConsenSys/teku/commit/a4535c31fab08339fbb881668d41ee59db341c2e", "message": "typo fix", "committedDate": "2020-11-16T17:44:58Z", "type": "commit"}, {"oid": "7540d7888c7eb9f148f3ded1653281e0bf9487d9", "url": "https://github.com/ConsenSys/teku/commit/7540d7888c7eb9f148f3ded1653281e0bf9487d9", "message": "double typo!", "committedDate": "2020-11-16T17:47:32Z", "type": "commit"}, {"oid": "b6e9a5351da3b04da1020dee2508bf14f7194a36", "url": "https://github.com/ConsenSys/teku/commit/b6e9a5351da3b04da1020dee2508bf14f7194a36", "message": "Merge branch 'master' into 203-api-doc-ci", "committedDate": "2020-11-16T18:09:25Z", "type": "commit"}, {"oid": "64e586279835e7604590b939716db648b27ae1b1", "url": "https://github.com/ConsenSys/teku/commit/64e586279835e7604590b939716db648b27ae1b1", "message": "change job names back", "committedDate": "2020-11-16T20:16:48Z", "type": "commit"}, {"oid": "5ed8809994e385d73f93354cc03e9a613bc2774f", "url": "https://github.com/ConsenSys/teku/commit/5ed8809994e385d73f93354cc03e9a613bc2774f", "message": "Merge branch 'master' into 203-api-doc-ci", "committedDate": "2020-11-16T20:17:20Z", "type": "commit"}, {"oid": "a8709b7dc5cb9d6633f0327ebcc89abf082466cd", "url": "https://github.com/ConsenSys/teku/commit/a8709b7dc5cb9d6633f0327ebcc89abf082466cd", "message": "dev version spotting using plus sign", "committedDate": "2020-11-16T20:27:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU1NjU0Mw==", "url": "https://github.com/ConsenSys/teku/pull/3233#discussion_r524556543", "bodyText": "This doesn't seem right.  We should be extracting the API spec on PRs, just not publishing them. Otherwise if the extract is broken we don't find out until after it merges.", "author": "ajsutton", "createdAt": "2020-11-16T20:36:36Z", "path": ".circleci/config.yml", "diffHunk": "@@ -461,11 +414,15 @@ workflows:\n             tags:\n               <<: *filters-release-tags\n           context:\n-            - dockerhub-quorumengineering-ro             \n+            - dockerhub-quorumengineering-ro\n       - extractAPISpec:\n           requires:\n             - assemble\n           filters:\n+            branches:\n+              only:\n+                - master\n+                - /^release-.*/", "originalCommit": "a8709b7dc5cb9d6633f0327ebcc89abf082466cd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU2MDQwMQ==", "url": "https://github.com/ConsenSys/teku/pull/3233#discussion_r524560401", "bodyText": "nit: comment is out of date.", "author": "ajsutton", "createdAt": "2020-11-16T20:44:02Z", "path": ".openapidoc/config.js", "diffHunk": "@@ -0,0 +1,96 @@\n+const fs = require(\"fs\");\n+const path = require(\"path\");\n+const yaml = require(\"js-yaml\");\n+const GitUrlParse = require(\"git-url-parse\");\n+\n+const distDir = process.env.OA_DIST_DIR || \"./dist\";\n+const specDir =\n+  process.env.OA_SPEC_DIR || \"./spec\";\n+const gitUrl =\n+  process.env.OA_GIT_URL || \"git@github.com:Consensys/teku.git\";\n+const gitUserName = process.env.OA_GIT_USERNAME || \"CircleCI Build\";\n+const gitEmail = process.env.OA_GIT_EMAIL || \"ci-build@consensys.net\";\n+const branch = process.env.OA_GH_PAGES_BRANCH || \"gh-pages\";\n+const versionsFileName = process.env.OA_VERSIONS_FILE_NAME || \"versions.json\";\n+\n+module.exports = {\n+  getConfig,\n+};\n+\n+function getConfig() {\n+  const repo = GitUrlParse(gitUrl);\n+  const specs = calculateSpecs();\n+  if (specs.length == 0) {\n+    throw new Error(\"Unable to parse specs in dist\" + distDir);\n+  }\n+\n+  return {\n+    specs: specs,\n+    distDir: distDir,\n+    versions: calculateVersionDetails(repo, branch),\n+    ghPagesConfig: {\n+      add: true, // allows gh-pages module to keep remote files\n+      branch: branch,\n+      repo: repo.href,\n+      user: {\n+        name: gitUserName,\n+        email: gitEmail,\n+      },\n+      message: `[skip ci] OpenAPI Publish [${specs[0].version}]`,\n+    },\n+  };\n+}\n+\n+function calculateSpecs() {\n+  const extension = \".json\";\n+  const specFiles = fs.readdirSync(specDir);\n+  var specArr = [];\n+  specFiles.forEach((file) => {\n+    if (path.extname(file).toLowerCase() === extension) {\n+      specArr.push(calculateSpecDetails(path.join(specDir, file)));\n+    }\n+  });\n+\n+  return specArr;\n+}\n+\n+function calculateSpecDetails(specFile) {\n+  const specVersion = calculateSpecVersion(specFile);\n+  const release = isReleaseVersion(specVersion);\n+  const latestDist = destinationPath(true, specFile, \"latest\");\n+  const latestDistCompat = destinationPath(false, specFile, \"latest\");\n+  const releaseDist = destinationPath(true, specFile, specVersion);\n+\n+  return {\n+    path: specFile,\n+    version: specVersion,\n+    isReleaseVersion: release,\n+    latestDist: latestDist,\n+    latestDistCompat: latestDistCompat,\n+    releaseDist: releaseDist,\n+  };\n+}\n+\n+function calculateSpecVersion(specFile) {\n+  return yaml.safeLoad(fs.readFileSync(specFile, \"utf8\")).info.version;\n+}\n+\n+function isReleaseVersion(specVersion) {\n+  // our main project's gradle's build calculateVersion puts -dev- for snapshot version", "originalCommit": "a8709b7dc5cb9d6633f0327ebcc89abf082466cd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e4d7ad16a63a81ca258e73e9a49ce7752bd88b66", "url": "https://github.com/ConsenSys/teku/commit/e4d7ad16a63a81ca258e73e9a49ce7752bd88b66", "message": "trying without branch filter", "committedDate": "2020-11-16T21:11:13Z", "type": "commit"}, {"oid": "83f8b57565f0c8099dcb2fd99e8018ce43f026c7", "url": "https://github.com/ConsenSys/teku/commit/83f8b57565f0c8099dcb2fd99e8018ce43f026c7", "message": "fix comment", "committedDate": "2020-11-16T21:21:53Z", "type": "commit"}]}