{"pr_number": 1219, "pr_title": "Add ability to get syncing slot info", "pr_createdAt": "2020-02-24T02:20:46Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1219", "timeline": [{"oid": "3179c239b172e1434a624dfdbf5957b838585009", "url": "https://github.com/ConsenSys/teku/commit/3179c239b172e1434a624dfdbf5957b838585009", "message": "1162 add openapi documentation for /beacon/state\n\nfixes\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>\n#1162", "committedDate": "2020-02-20T21:22:35Z", "type": "commit"}, {"oid": "dcbafd86535ef2922773129d374f7daafd240ad6", "url": "https://github.com/ConsenSys/teku/commit/dcbafd86535ef2922773129d374f7daafd240ad6", "message": "Merge remote-tracking branch 'upstream/master' into 1162-beacon-state-endpoint", "committedDate": "2020-02-20T21:38:46Z", "type": "commit"}, {"oid": "78fe18117d2273bd80839da0d4790b4e6a35ded2", "url": "https://github.com/ConsenSys/teku/commit/78fe18117d2273bd80839da0d4790b4e6a35ded2", "message": "Update data/provider/src/test/java/tech/pegasys/artemis/provider/JsonProviderTest.java\n\nCo-Authored-By: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-20T23:18:56Z", "type": "commit"}, {"oid": "7c9993c89dfaf51817257d39d826f0df7921e026", "url": "https://github.com/ConsenSys/teku/commit/7c9993c89dfaf51817257d39d826f0df7921e026", "message": "Update data/provider/src/test/java/tech/pegasys/artemis/provider/JsonProviderTest.java\n\nCo-Authored-By: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-20T23:19:09Z", "type": "commit"}, {"oid": "6976a4cb586ae3a63fbb7f12d6bc7150fd159bd4", "url": "https://github.com/ConsenSys/teku/commit/6976a4cb586ae3a63fbb7f12d6bc7150fd159bd4", "message": "Update data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconStateHandler.java\n\nCo-Authored-By: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-21T00:04:40Z", "type": "commit"}, {"oid": "3ff1866ccb2fc804217dfc74b75fe91bb83bfe67", "url": "https://github.com/ConsenSys/teku/commit/3ff1866ccb2fc804217dfc74b75fe91bb83bfe67", "message": "changes per review comments.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-02-21T00:58:18Z", "type": "commit"}, {"oid": "14a63c721cdd76f135a55160dcf70293d4194c98", "url": "https://github.com/ConsenSys/teku/commit/14a63c721cdd76f135a55160dcf70293d4194c98", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis", "committedDate": "2020-02-21T04:00:15Z", "type": "commit"}, {"oid": "8d94ce8c5afc48963b965f552ae86e3751565e8d", "url": "https://github.com/ConsenSys/teku/commit/8d94ce8c5afc48963b965f552ae86e3751565e8d", "message": "Merge branch 'master' of github.com:macfarla/artemis", "committedDate": "2020-02-21T04:00:36Z", "type": "commit"}, {"oid": "9d44076869eb8ca6ca31603ba27687451cc4d53b", "url": "https://github.com/ConsenSys/teku/commit/9d44076869eb8ca6ca31603ba27687451cc4d53b", "message": "merge\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-23T22:54:56Z", "type": "commit"}, {"oid": "ad1fc0989a31d92a2a59915080fbedc8dead4888", "url": "https://github.com/ConsenSys/teku/commit/ad1fc0989a31d92a2a59915080fbedc8dead4888", "message": "added syncStatus\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-24T02:08:21Z", "type": "commit"}, {"oid": "1f94f5b0bd3adafd36f119e6e01baf0d1c30be7e", "url": "https://github.com/ConsenSys/teku/commit/1f94f5b0bd3adafd36f119e6e01baf0d1c30be7e", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into 1180-syncing-slots", "committedDate": "2020-02-24T02:21:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA3MDM0Ng==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r383070346", "bodyText": "public final...", "author": "rolfyone", "createdAt": "2020-02-24T02:54:34Z", "path": "sync/src/main/java/tech/pegasys/artemis/sync/SyncStatus.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.sync;\n+\n+import com.google.common.primitives.UnsignedLong;\n+\n+public class SyncStatus {\n+\n+  public UnsignedLong starting_slot;", "originalCommit": "1f94f5b0bd3adafd36f119e6e01baf0d1c30be7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA3MDQ0OQ==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r383070449", "bodyText": "nit: Could use UnsignedLong.ZERO", "author": "rolfyone", "createdAt": "2020-02-24T02:55:29Z", "path": "sync/src/test/java/tech/pegasys/artemis/sync/PeerSyncTest.java", "diffHunk": "@@ -375,6 +377,11 @@ void sync_handleEmptyResponse() {\n     // Check that the sync is done and the peer was not disconnected.\n     assertThat(syncFuture).isCompleted();\n     verify(peer, never()).sendGoodbye(any());\n+\n+    // check syncStatus\n+    UnsignedLong slot = peerSync.getSyncStatus().current_slot;\n+    assertThat(slot).isGreaterThanOrEqualTo(peerSync.getSyncStatus().highest_slot);\n+    assertThat(peerSync.getSyncStatus().highest_slot).isGreaterThan(UnsignedLong.valueOf(0));", "originalCommit": "1f94f5b0bd3adafd36f119e6e01baf0d1c30be7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4MjcxNA==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r383082714", "bodyText": "This needs to be in a synchronised block.  Both the read and write sides have to be synchronised for it to have any effect.", "author": "ajsutton", "createdAt": "2020-02-24T04:31:33Z", "path": "sync/src/main/java/tech/pegasys/artemis/sync/PeerSync.java", "diffHunk": "@@ -63,6 +67,10 @@ public PeerSync(\n     final UnsignedLong latestFinalizedSlot = compute_start_slot_at_epoch(finalizedEpoch);\n     final UnsignedLong firstNonFinalSlot = latestFinalizedSlot.plus(UnsignedLong.ONE);\n \n+    this.startingSlot = firstNonFinalSlot;\n+    this.currentSlot = startingSlot;\n+    this.highestSlot = peer.getStatus().getHeadSlot();", "originalCommit": "1f94f5b0bd3adafd36f119e6e01baf0d1c30be7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4MzQwMQ==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r383083401", "bodyText": "The currentSlot is already available from ChainStorageClient.getBestSlot() and that will correctly show the last imported block, not just the last downloaded block.\nhighestSlot probably should be calculated from SyncManager as well since it's the highest slot of any peer, not just the slot of the peer we're syncing to at the moment.\nAnd then at that point you'd only have a single variable being updated here, so it could be volatile and remove all the synchronized.", "author": "ajsutton", "createdAt": "2020-02-24T04:36:32Z", "path": "sync/src/main/java/tech/pegasys/artemis/sync/PeerSync.java", "diffHunk": "@@ -113,6 +121,7 @@ public void stop() {\n                   startSlot,\n                   peer.getId());\n               final UnsignedLong nextSlot = startSlot.plus(count);\n+              currentSlot = nextSlot; // might end up at highest + 1 but by then syncing is finished", "originalCommit": "1f94f5b0bd3adafd36f119e6e01baf0d1c30be7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMwODYwMw==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r384308603", "bodyText": "fixed", "author": "macfarla", "createdAt": "2020-02-26T07:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4MzQwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA4Mzc2OA==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r383083768", "bodyText": "We should be able to assert the exact highest slot as it should be the slot of the remote peer we set up.", "author": "ajsutton", "createdAt": "2020-02-24T04:39:46Z", "path": "sync/src/test/java/tech/pegasys/artemis/sync/PeerSyncTest.java", "diffHunk": "@@ -161,6 +161,8 @@ void sync_stoppedBeforeBlockImport() {\n     when(peer.requestBlocksByRange(any(), any(), any(), any(), any())).thenReturn(requestFuture);\n \n     final SafeFuture<PeerSyncResult> syncFuture = peerSync.sync(peer);\n+    SyncStatus syncStatus = peerSync.getSyncStatus();\n+    assertThat(syncStatus.highest_slot).isGreaterThan(UnsignedLong.valueOf(0));", "originalCommit": "1f94f5b0bd3adafd36f119e6e01baf0d1c30be7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2ec58079fd41e23410170a2832463234bc208a0e", "url": "https://github.com/ConsenSys/teku/commit/2ec58079fd41e23410170a2832463234bc208a0e", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into 1180-syncing-slots", "committedDate": "2020-02-24T23:54:35Z", "type": "commit"}, {"oid": "18e85e83beed17ce5af5e912c64bb2c946e34b60", "url": "https://github.com/ConsenSys/teku/commit/18e85e83beed17ce5af5e912c64bb2c946e34b60", "message": "get current slot from storageClient and highest slot from SyncManager\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-25T01:39:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyMzIwOA==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r383623208", "bodyText": "nit: UnsignedLong.ZERO", "author": "rolfyone", "createdAt": "2020-02-25T02:15:48Z", "path": "sync/src/main/java/tech/pegasys/artemis/sync/PeerSync.java", "diffHunk": "@@ -47,6 +47,8 @@\n \n   private final AsyncRunner asyncRunner;\n \n+  private UnsignedLong startingSlot = UnsignedLong.valueOf(0);", "originalCommit": "18e85e83beed17ce5af5e912c64bb2c946e34b60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY0NzcxMA==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r383647710", "bodyText": "Starting slot should be volatile since it's accessed from multiple threads.", "author": "ajsutton", "createdAt": "2020-02-25T04:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyMzIwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMwODY3Ng==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r384308676", "bodyText": "fixed", "author": "macfarla", "createdAt": "2020-02-26T07:15:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyMzIwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyNDYzMQ==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r383624631", "bodyText": "Nit: UnsignedLong.ZERO - or even better if we can compare against the sync start slot as you suggested in chat...", "author": "rolfyone", "createdAt": "2020-02-25T02:21:34Z", "path": "sync/src/test/java/tech/pegasys/artemis/sync/PeerSyncTest.java", "diffHunk": "@@ -193,6 +193,11 @@ void sync_stoppedBeforeBlockImport() {\n     assertThat(syncFuture).isCompleted();\n     PeerSyncResult result = syncFuture.join();\n     assertThat(result).isEqualByComparingTo(PeerSyncResult.CANCELLED);\n+\n+    // check startingSlot\n+    UnsignedLong startingSlot = peerSync.getStartingSlot();\n+    assertThat(startingSlot).isGreaterThan(UnsignedLong.valueOf(0));", "originalCommit": "18e85e83beed17ce5af5e912c64bb2c946e34b60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY0ODg3NQ==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r383648875", "bodyText": "Shouldn't we know the exact starting slot?  We setup the remote peer state and control when it responds with data, so it should be completely deterministic from what I can see (but there's a good chance I'm missing something)", "author": "ajsutton", "createdAt": "2020-02-25T04:08:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyNDYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY0ODA3OQ==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r383648079", "bodyText": "I wouldn't have expected us to store this.  Just findBestSyncPeer in getSyncStatus so we ensure we have an up to date value regardless of which peer we are currently syncing to.", "author": "ajsutton", "createdAt": "2020-02-25T04:04:13Z", "path": "sync/src/main/java/tech/pegasys/artemis/sync/SyncManager.java", "diffHunk": "@@ -51,6 +51,8 @@\n   private final AsyncRunner asyncRunner;\n   private final Set<NodeId> peersWithSyncErrors = new HashSet<>();\n \n+  private UnsignedLong highestSlot = UnsignedLong.ZERO;", "originalCommit": "18e85e83beed17ce5af5e912c64bb2c946e34b60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMwODkwMA==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r384308900", "bodyText": "fixed", "author": "macfarla", "createdAt": "2020-02-26T07:16:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY0ODA3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY0ODI1MQ==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r383648251", "bodyText": "I don't think this needs to be synchronized.  Especially once we're not storing highestSlot but as it stands the write isn't synchronized so it's not thread safe anyway.", "author": "ajsutton", "createdAt": "2020-02-25T04:05:15Z", "path": "sync/src/main/java/tech/pegasys/artemis/sync/SyncManager.java", "diffHunk": "@@ -128,9 +130,16 @@ synchronized boolean isSyncQueued() {\n     return syncQueued;\n   }\n \n+  synchronized SyncStatus getSyncStatus() {", "originalCommit": "18e85e83beed17ce5af5e912c64bb2c946e34b60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY0ODMzOQ==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r383648339", "bodyText": "This should be private with accessors to follow standard java idiom.", "author": "ajsutton", "createdAt": "2020-02-25T04:05:40Z", "path": "sync/src/main/java/tech/pegasys/artemis/sync/SyncStatus.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.sync;\n+\n+import com.google.common.primitives.UnsignedLong;\n+\n+public class SyncStatus {\n+\n+  public final UnsignedLong starting_slot;\n+  public final UnsignedLong current_slot;\n+  public final UnsignedLong highest_slot;", "originalCommit": "18e85e83beed17ce5af5e912c64bb2c946e34b60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMwODk0NA==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r384308944", "bodyText": "fixed", "author": "macfarla", "createdAt": "2020-02-26T07:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY0ODMzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY0OTA5Mw==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r383649093", "bodyText": "I'd have expected we could expect specific values here as well.", "author": "ajsutton", "createdAt": "2020-02-25T04:09:10Z", "path": "sync/src/test/java/tech/pegasys/artemis/sync/PeerSyncTest.java", "diffHunk": "@@ -375,6 +380,11 @@ void sync_handleEmptyResponse() {\n     // Check that the sync is done and the peer was not disconnected.\n     assertThat(syncFuture).isCompleted();\n     verify(peer, never()).sendGoodbye(any());\n+\n+    // check startingSlot\n+    UnsignedLong startingSlot = peerSync.getStartingSlot();\n+    assertThat(startingSlot).isGreaterThan(UnsignedLong.valueOf(0));\n+    assertThat(startingSlot).isLessThan(PEER_HEAD_SLOT);", "originalCommit": "18e85e83beed17ce5af5e912c64bb2c946e34b60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMyNjM3Mg==", "url": "https://github.com/ConsenSys/teku/pull/1219#discussion_r384326372", "bodyText": "done", "author": "macfarla", "createdAt": "2020-02-26T08:06:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY0OTA5Mw=="}], "type": "inlineReview"}, {"oid": "1bc8ab3c8e73d6c819243f19eda57f6249a9278a", "url": "https://github.com/ConsenSys/teku/commit/1bc8ab3c8e73d6c819243f19eda57f6249a9278a", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into 1180-syncing-slots", "committedDate": "2020-02-25T23:26:57Z", "type": "commit"}, {"oid": "fc72e271a36cf9e16faca52f5d2802645affde61", "url": "https://github.com/ConsenSys/teku/commit/fc72e271a36cf9e16faca52f5d2802645affde61", "message": "review comments\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-26T07:14:44Z", "type": "commit"}, {"oid": "549a202ed46de7e34276724ef2c76b182b63f086", "url": "https://github.com/ConsenSys/teku/commit/549a202ed46de7e34276724ef2c76b182b63f086", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into 1180-syncing-slots", "committedDate": "2020-02-26T07:16:46Z", "type": "commit"}, {"oid": "7711747e7a2ab4ca0f4998afa4aaf68b411c8499", "url": "https://github.com/ConsenSys/teku/commit/7711747e7a2ab4ca0f4998afa4aaf68b411c8499", "message": "added test for second sync, verifying second starting slot\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-26T08:05:03Z", "type": "commit"}, {"oid": "92158de07b91ef10a335b7b1a4c28815f716192e", "url": "https://github.com/ConsenSys/teku/commit/92158de07b91ef10a335b7b1a4c28815f716192e", "message": "remove less than checks\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-26T08:07:07Z", "type": "commit"}, {"oid": "013f88059df5c18d0c120f1ba018e924ffcba68a", "url": "https://github.com/ConsenSys/teku/commit/013f88059df5c18d0c120f1ba018e924ffcba68a", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into 1180-syncing-slots", "committedDate": "2020-02-26T21:58:12Z", "type": "commit"}]}