{"pr_number": 3065, "pr_title": "[Issue 3063] Accept weak-subjectivity state and block", "pr_createdAt": "2020-10-23T20:02:32Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3065", "timeline": [{"oid": "eeb25448ddfb2c83ef11919cd488095abd4e7c46", "url": "https://github.com/ConsenSys/teku/commit/eeb25448ddfb2c83ef11919cd488095abd4e7c46", "message": "Rename --initial-state option to --genesis-state\n\nKeep --initial-state as a valid option for backwards-compatibility", "committedDate": "2020-10-23T19:15:48Z", "type": "commit"}, {"oid": "cd97c182cd3671371b1def6701e622ea0c6a9dbd", "url": "https://github.com/ConsenSys/teku/commit/cd97c182cd3671371b1def6701e622ea0c6a9dbd", "message": "Add new option to supply weak subjectivity state", "committedDate": "2020-10-23T19:15:48Z", "type": "commit"}, {"oid": "89deb1a55a6fb52e7ecdbf9d88f3f1866d0ec7d6", "url": "https://github.com/ConsenSys/teku/commit/89deb1a55a6fb52e7ecdbf9d88f3f1866d0ec7d6", "message": "Rename StartupUtil to StateLoader", "committedDate": "2020-10-23T19:15:48Z", "type": "commit"}, {"oid": "a9e318338b52becfd3a7a7a50e775cc0c99dca38", "url": "https://github.com/ConsenSys/teku/commit/a9e318338b52becfd3a7a7a50e775cc0c99dca38", "message": "For now, accept initial block with weak subjectivity state", "committedDate": "2020-10-23T19:15:48Z", "type": "commit"}, {"oid": "0286d9f6c52018c553c928a2322d56ecf68aa378", "url": "https://github.com/ConsenSys/teku/commit/0286d9f6c52018c553c928a2322d56ecf68aa378", "message": "Use ws state and block to initialize storage", "committedDate": "2020-10-23T19:15:48Z", "type": "commit"}, {"oid": "947f0a85f6cc9819ef9b31565ede9240ca0503a2", "url": "https://github.com/ConsenSys/teku/commit/947f0a85f6cc9819ef9b31565ede9240ca0503a2", "message": "Store anchorPoint data to enable proper protoArray initialization", "committedDate": "2020-10-23T19:15:49Z", "type": "commit"}, {"oid": "1237299d4fa49ebc1ece1733b0bd62ab886e5b7e", "url": "https://github.com/ConsenSys/teku/commit/1237299d4fa49ebc1ece1733b0bd62ab886e5b7e", "message": "Fix StatusLogger dependencies after rebase", "committedDate": "2020-10-23T19:41:25Z", "type": "commit"}, {"oid": "d8452adf01a1939efbcbb3061f1566bff088ccd2", "url": "https://github.com/ConsenSys/teku/commit/d8452adf01a1939efbcbb3061f1566bff088ccd2", "message": "Update peer validator to be tolerant of missing historical blocks", "committedDate": "2020-10-23T19:54:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY4MDczNg==", "url": "https://github.com/ConsenSys/teku/pull/3065#discussion_r511680736", "bodyText": "Would it make sense to have this return genesis if no anchor was specified?", "author": "ajsutton", "createdAt": "2020-10-26T01:32:32Z", "path": "ethereum/datastructures/src/main/java/tech/pegasys/teku/datastructures/forkchoice/ReadOnlyStore.java", "diffHunk": "@@ -32,6 +32,14 @@\n \n   UInt64 getGenesisTime();\n \n+  /**\n+   * Returns the anchor checkpoint from which the chain was started, if such an anchor exists. If\n+   * the anchor is missing, the node was started up from genesis.\n+   *\n+   * @return The anchor if it exists.\n+   */\n+  Optional<Checkpoint> getAnchor();", "originalCommit": "d8452adf01a1939efbcbb3061f1566bff088ccd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5OTYyNQ==", "url": "https://github.com/ConsenSys/teku/pull/3065#discussion_r512199625", "bodyText": "Going forward, this will return genesis if you started up from genesis.  But not sure its worth extra lookups to the cold db to always set a value for older databases.", "author": "mbaxter", "createdAt": "2020-10-26T19:01:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY4MDczNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3NDE2OQ==", "url": "https://github.com/ConsenSys/teku/pull/3065#discussion_r512274169", "bodyText": "ah I see, that makes sense.", "author": "ajsutton", "createdAt": "2020-10-26T21:17:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY4MDczNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY5NDY1Mg==", "url": "https://github.com/ConsenSys/teku/pull/3065#discussion_r511694652", "bodyText": "nit: stray semicolon", "author": "ajsutton", "createdAt": "2020-10-26T02:46:43Z", "path": "ethereum/datastructures/src/testFixtures/java/tech/pegasys/teku/datastructures/util/BeaconStateBuilder.java", "diffHunk": "@@ -0,0 +1,311 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.datastructures.util;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+import static tech.pegasys.teku.datastructures.util.BeaconStateUtil.compute_start_slot_at_epoch;\n+import static tech.pegasys.teku.util.config.Constants.EPOCHS_PER_ETH1_VOTING_PERIOD;\n+import static tech.pegasys.teku.util.config.Constants.SLOTS_PER_EPOCH;\n+\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.datastructures.blocks.BeaconBlockHeader;\n+import tech.pegasys.teku.datastructures.blocks.Eth1Data;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n+import tech.pegasys.teku.datastructures.state.Checkpoint;\n+import tech.pegasys.teku.datastructures.state.Fork;\n+import tech.pegasys.teku.datastructures.state.PendingAttestation;\n+import tech.pegasys.teku.datastructures.state.Validator;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.ssz.SSZTypes.Bitvector;\n+import tech.pegasys.teku.ssz.SSZTypes.SSZList;\n+import tech.pegasys.teku.ssz.SSZTypes.SSZVector;\n+import tech.pegasys.teku.util.config.Constants;\n+\n+public class BeaconStateBuilder {\n+  private final DataStructureUtil dataStructureUtil;\n+  private final int defaultValidatorCount;\n+  private final int defaultItemsInSSZLists;\n+\n+  private UInt64 genesisTime;\n+  private Bytes32 genesisValidatorsRoot;\n+  private UInt64 slot;\n+  private Fork fork;\n+  private BeaconBlockHeader latestBlockHeader;\n+  private SSZVector<Bytes32> blockRoots;\n+  private SSZVector<Bytes32> stateRoots;\n+  private SSZList<Bytes32> historicalRoots;\n+  private Eth1Data eth1Data;\n+  private SSZList<Eth1Data> eth1DataVotes;\n+  private UInt64 eth1DepositIndex;\n+  private SSZList<? extends Validator> validators;\n+  private SSZList<UInt64> balances;\n+  private SSZVector<Bytes32> randaoMixes;\n+  private SSZVector<UInt64> slashings;\n+  private SSZList<PendingAttestation> previousEpochAttestations;\n+  private SSZList<PendingAttestation> currentEpochAttestations;\n+  private Bitvector justificationBits;\n+  private Checkpoint previousJustifiedCheckpoint;\n+  private Checkpoint currentJustifiedCheckpoint;\n+  private Checkpoint finalizedCheckpoint;\n+\n+  private BeaconStateBuilder(\n+      final DataStructureUtil dataStructureUtil,\n+      final int defaultValidatorCount,\n+      final int defaultItemsInSSZLists) {\n+    this.dataStructureUtil = dataStructureUtil;\n+    this.defaultValidatorCount = defaultValidatorCount;\n+    this.defaultItemsInSSZLists = defaultItemsInSSZLists;\n+    initDefaults();\n+  }\n+\n+  public static BeaconStateBuilder create(\n+      final DataStructureUtil dataStructureUtil,\n+      final int defaultValidatorCount,\n+      final int defaultItemsInSSZLists) {\n+    return new BeaconStateBuilder(dataStructureUtil, defaultValidatorCount, defaultItemsInSSZLists);\n+  }\n+\n+  public BeaconState build() {\n+    return BeaconState.create(\n+        genesisTime,\n+        genesisValidatorsRoot,\n+        slot,\n+        fork,\n+        latestBlockHeader,\n+        blockRoots,\n+        stateRoots,\n+        historicalRoots,\n+        eth1Data,\n+        eth1DataVotes,\n+        eth1DepositIndex,\n+        validators,\n+        balances,\n+        randaoMixes,\n+        slashings,\n+        previousEpochAttestations,\n+        currentEpochAttestations,\n+        justificationBits,\n+        previousJustifiedCheckpoint,\n+        currentJustifiedCheckpoint,\n+        finalizedCheckpoint);\n+  }\n+\n+  private void initDefaults() {\n+    genesisTime = dataStructureUtil.randomUInt64();\n+    genesisValidatorsRoot = dataStructureUtil.randomBytes32();\n+    slot = dataStructureUtil.randomUInt64();\n+    fork = dataStructureUtil.randomFork();\n+    latestBlockHeader = dataStructureUtil.randomBeaconBlockHeader();\n+    blockRoots =\n+        dataStructureUtil.randomSSZVector(\n+            Bytes32.ZERO, Constants.SLOTS_PER_HISTORICAL_ROOT, dataStructureUtil::randomBytes32);\n+    stateRoots =\n+        dataStructureUtil.randomSSZVector(\n+            Bytes32.ZERO, Constants.SLOTS_PER_HISTORICAL_ROOT, dataStructureUtil::randomBytes32);\n+    ;", "originalCommit": "d8452adf01a1939efbcbb3061f1566bff088ccd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5MjIxMw==", "url": "https://github.com/ConsenSys/teku/pull/3065#discussion_r512192213", "bodyText": "For some reason I always seem to get these \ud83e\udd2a", "author": "mbaxter", "createdAt": "2020-10-26T18:48:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY5NDY1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY5ODY2Ng==", "url": "https://github.com/ConsenSys/teku/pull/3065#discussion_r511698666", "bodyText": "I wonder if we should leave this as --initial-state because ultimately we want to be able to sync just from a state and so would wind up being able to just specify that state here.\nEven now if the slot of the initial state was 0 we can generate the block and if it's not, we require the block to be passed in via the extra arg.\nHowever it winds up, I think I'd avoid making changes to the stable CLI options before we know exactly where it's going to land.", "author": "ajsutton", "createdAt": "2020-10-26T03:06:37Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/options/NetworkOptions.java", "diffHunk": "@@ -25,11 +25,11 @@\n   private String network = \"medalla\";\n \n   @Option(\n-      names = {\"--initial-state\"},\n+      names = {\"--genesis-state\", \"--initial-state\"},", "originalCommit": "d8452adf01a1939efbcbb3061f1566bff088ccd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5NzI0OQ==", "url": "https://github.com/ConsenSys/teku/pull/3065#discussion_r512197249", "bodyText": "Yeah, I was initially thinking they would merge, but then it just seemed simpler to keep them separate.  But it probably is premature to rename right now.  Reverted this.", "author": "mbaxter", "createdAt": "2020-10-26T18:57:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY5ODY2Ng=="}], "type": "inlineReview"}, {"oid": "33ae85d653ea337900fa8f4d736505712fa54b39", "url": "https://github.com/ConsenSys/teku/commit/33ae85d653ea337900fa8f4d736505712fa54b39", "message": "Revert \"Rename --initial-state option to --genesis-state\"\n\nThis reverts commit eeb25448ddfb2c83ef11919cd488095abd4e7c46.", "committedDate": "2020-10-26T18:33:32Z", "type": "commit"}, {"oid": "d1c0ddee9f9c8a204d2e9f5a4c73f9f6698686ba", "url": "https://github.com/ConsenSys/teku/commit/d1c0ddee9f9c8a204d2e9f5a4c73f9f6698686ba", "message": "Fix genesis handler setup", "committedDate": "2020-10-26T18:47:07Z", "type": "commit"}, {"oid": "cce1f08599df2aee2aa4cbadb0afc70e16b34a42", "url": "https://github.com/ConsenSys/teku/commit/cce1f08599df2aee2aa4cbadb0afc70e16b34a42", "message": "Cut stray semicolon", "committedDate": "2020-10-26T19:04:00Z", "type": "commit"}, {"oid": "5e19f3245d7578cf949f94563ece5312482e2f02", "url": "https://github.com/ConsenSys/teku/commit/5e19f3245d7578cf949f94563ece5312482e2f02", "message": "Merge branch 'master' into issue-3063/accept-ws-state-and-block", "committedDate": "2020-10-26T19:04:34Z", "type": "commit"}, {"oid": "450921ab227d29d8787fdf52b4d67d72558ef603", "url": "https://github.com/ConsenSys/teku/commit/450921ab227d29d8787fdf52b4d67d72558ef603", "message": "Update test names", "committedDate": "2020-10-26T20:45:12Z", "type": "commit"}, {"oid": "b3072f47f5c4f613de0f580ad1d1ce6e87bb3be5", "url": "https://github.com/ConsenSys/teku/commit/b3072f47f5c4f613de0f580ad1d1ce6e87bb3be5", "message": "Merge branch 'master' into issue-3063/accept-ws-state-and-block", "committedDate": "2020-10-27T14:41:17Z", "type": "commit"}, {"oid": "07ecc35027debc14ad28fff7146bcbc38e50e0f5", "url": "https://github.com/ConsenSys/teku/commit/07ecc35027debc14ad28fff7146bcbc38e50e0f5", "message": "Fix merge conflict", "committedDate": "2020-10-27T15:12:45Z", "type": "commit"}]}