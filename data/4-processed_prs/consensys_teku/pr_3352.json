{"pr_number": 3352, "pr_title": "Precompute validator status", "pr_createdAt": "2020-12-03T09:46:17Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3352", "timeline": [{"oid": "937ba8d99bb2130c6f55e1d6a10fe01e0d84d522", "url": "https://github.com/ConsenSys/teku/commit/937ba8d99bb2130c6f55e1d6a10fe01e0d84d522", "message": "Add validator status data structures.", "committedDate": "2020-12-03T01:35:50Z", "type": "commit"}, {"oid": "cf8a01cfe6d6bca11d65630a4e9770f9d2ec10c9", "url": "https://github.com/ConsenSys/teku/commit/cf8a01cfe6d6bca11d65630a4e9770f9d2ec10c9", "message": "Add tests for data structures.", "committedDate": "2020-12-03T04:24:50Z", "type": "commit"}, {"oid": "fb83bb11fc1bc8a164be2e3825844b3512f50608", "url": "https://github.com/ConsenSys/teku/commit/fb83bb11fc1bc8a164be2e3825844b3512f50608", "message": "Use ValidatorStatus info in epoch processing.", "committedDate": "2020-12-03T09:44:39Z", "type": "commit"}, {"oid": "b20d58a17e47e3c12f2b13225d9029ec97597889", "url": "https://github.com/ConsenSys/teku/commit/b20d58a17e47e3c12f2b13225d9029ec97597889", "message": "Errrorprone.", "committedDate": "2020-12-03T10:13:28Z", "type": "commit"}, {"oid": "95bef408b63fed8f9c091913de40da668edcb72b", "url": "https://github.com/ConsenSys/teku/commit/95bef408b63fed8f9c091913de40da668edcb72b", "message": "Update tests for min balance.", "committedDate": "2020-12-03T21:01:10Z", "type": "commit"}, {"oid": "52ff89791d0a52f1c704188b40ed64677c602c9c", "url": "https://github.com/ConsenSys/teku/commit/52ff89791d0a52f1c704188b40ed64677c602c9c", "message": "Merge branch 'master' into single-pass-epoch", "committedDate": "2020-12-03T23:00:12Z", "type": "commit"}, {"oid": "66afa36703fc03f86c047692986e4297120314de", "url": "https://github.com/ConsenSys/teku/commit/66afa36703fc03f86c047692986e4297120314de", "message": "Merge branch 'master' into single-pass-epoch", "committedDate": "2020-12-03T23:19:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgyMjU4OA==", "url": "https://github.com/ConsenSys/teku/pull/3352#discussion_r535822588", "bodyText": "is the double call here intentional?", "author": "rolfyone", "createdAt": "2020-12-04T04:11:55Z", "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/epoch/status/ValidatorStatuses.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.core.epoch.status;\n+\n+import static tech.pegasys.teku.datastructures.util.BeaconStateUtil.get_block_root_at_slot;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.datastructures.operations.AttestationData;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n+import tech.pegasys.teku.datastructures.state.Checkpoint;\n+import tech.pegasys.teku.datastructures.state.Validator;\n+import tech.pegasys.teku.datastructures.util.AttestationUtil;\n+import tech.pegasys.teku.datastructures.util.BeaconStateUtil;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.ssz.SSZTypes.SSZList;\n+\n+public class ValidatorStatuses {\n+  private final List<ValidatorStatus> statuses;\n+  private final TotalBalances totalBalances;\n+\n+  private ValidatorStatuses(\n+      final List<ValidatorStatus> statuses, final TotalBalances totalBalances) {\n+    this.statuses = statuses;\n+    this.totalBalances = totalBalances;\n+  }\n+\n+  public static ValidatorStatuses create(final BeaconState state) {\n+    final SSZList<Validator> validators = state.getValidators();\n+\n+    final UInt64 currentEpoch = BeaconStateUtil.get_current_epoch(state);\n+    final UInt64 previousEpoch = BeaconStateUtil.get_previous_epoch(state);\n+\n+    final List<ValidatorStatus> statuses =\n+        validators.stream()\n+            .map(validator -> ValidatorStatus.create(validator, previousEpoch, currentEpoch))\n+            .collect(Collectors.toCollection(() -> new ArrayList<>(validators.size())));\n+\n+    processAttestations(statuses, state, previousEpoch, currentEpoch);\n+\n+    final TotalBalances totalBalances = TotalBalances.create(statuses);\n+\n+    return new ValidatorStatuses(statuses, totalBalances);\n+  }\n+\n+  private static void processAttestations(\n+      final List<ValidatorStatus> statuses,\n+      final BeaconState state,\n+      final UInt64 previousEpoch,\n+      final UInt64 currentEpoch) {\n+    Stream.concat(\n+            state.getPrevious_epoch_attestations().stream(),\n+            state.getCurrent_epoch_attestations().stream())\n+        .forEach(\n+            attestation -> {\n+              final AttestationData data = attestation.getData();\n+\n+              final AttestationUpdates updates = new AttestationUpdates();\n+              final Checkpoint target = data.getTarget();\n+              if (target.getEpoch().equals(currentEpoch)) {\n+                updates.currentEpochAttester = true;\n+                updates.currentEpochTargetAttester =\n+                    matchesEpochStartBlock(state, currentEpoch, target.getRoot());\n+              } else if (target.getEpoch().equals(previousEpoch)) {\n+                updates.previousEpochAttester = true;\n+\n+                updates.inclusionInfo =\n+                    Optional.of(\n+                        new InclusionInfo(\n+                            attestation.getInclusion_delay(), attestation.getProposer_index()));\n+\n+                if (matchesEpochStartBlock(state, previousEpoch, target.getRoot())) {\n+                  updates.previousEpochTargetAttester = true;\n+\n+                  updates.previousEpochHeadAttester =\n+                      get_block_root_at_slot(state, data.getSlot())\n+                          .equals(data.getBeacon_block_root());\n+                }\n+              }\n+\n+              // Apply flags to attestingIndices\n+              AttestationUtil.stream_attesting_indices(\n+                      state, data, attestation.getAggregation_bits())\n+                  .mapToObj(statuses::get)\n+                  .forEach(updates::apply);\n+            });\n+  }\n+\n+  private static boolean matchesEpochStartBlock(\n+      final BeaconState state, final UInt64 currentEpoch, final Bytes32 root) {\n+    return BeaconStateUtil.get_block_root(state, currentEpoch).equals(root);\n+  }\n+\n+  public TotalBalances getTotalBalances() {\n+    return totalBalances;\n+  }\n+\n+  public List<ValidatorStatus> getStatuses() {\n+    return statuses;\n+  }\n+\n+  public int getValidatorCount() {\n+    return statuses.size();\n+  }\n+\n+  private static class AttestationUpdates {\n+    private boolean currentEpochAttester = false;\n+    private boolean currentEpochTargetAttester = false;\n+    private boolean previousEpochAttester = false;\n+    private boolean previousEpochTargetAttester = false;\n+    private boolean previousEpochHeadAttester = false;\n+    private Optional<InclusionInfo> inclusionInfo = Optional.empty();\n+\n+    public void apply(final ValidatorStatus status) {\n+      status.updateCurrentEpochAttester(currentEpochAttester);\n+      status.updateCurrentEpochAttester(currentEpochAttester);", "originalCommit": "66afa36703fc03f86c047692986e4297120314de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzExMzU1NQ==", "url": "https://github.com/ConsenSys/teku/pull/3352#discussion_r537113555", "bodyText": "No, that would explain how I originally managed to miss calling updatePreviousEpochAttester though...", "author": "ajsutton", "createdAt": "2020-12-06T20:08:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgyMjU4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgyNDI0NQ==", "url": "https://github.com/ConsenSys/teku/pull/3352#discussion_r535824245", "bodyText": "this might be just a java oddity, but why not just Collectors.toList()?", "author": "rolfyone", "createdAt": "2020-12-04T04:17:29Z", "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/epoch/status/ValidatorStatuses.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.core.epoch.status;\n+\n+import static tech.pegasys.teku.datastructures.util.BeaconStateUtil.get_block_root_at_slot;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.datastructures.operations.AttestationData;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n+import tech.pegasys.teku.datastructures.state.Checkpoint;\n+import tech.pegasys.teku.datastructures.state.Validator;\n+import tech.pegasys.teku.datastructures.util.AttestationUtil;\n+import tech.pegasys.teku.datastructures.util.BeaconStateUtil;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.ssz.SSZTypes.SSZList;\n+\n+public class ValidatorStatuses {\n+  private final List<ValidatorStatus> statuses;\n+  private final TotalBalances totalBalances;\n+\n+  private ValidatorStatuses(\n+      final List<ValidatorStatus> statuses, final TotalBalances totalBalances) {\n+    this.statuses = statuses;\n+    this.totalBalances = totalBalances;\n+  }\n+\n+  public static ValidatorStatuses create(final BeaconState state) {\n+    final SSZList<Validator> validators = state.getValidators();\n+\n+    final UInt64 currentEpoch = BeaconStateUtil.get_current_epoch(state);\n+    final UInt64 previousEpoch = BeaconStateUtil.get_previous_epoch(state);\n+\n+    final List<ValidatorStatus> statuses =\n+        validators.stream()\n+            .map(validator -> ValidatorStatus.create(validator, previousEpoch, currentEpoch))\n+            .collect(Collectors.toCollection(() -> new ArrayList<>(validators.size())));", "originalCommit": "66afa36703fc03f86c047692986e4297120314de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIwOTIyNA==", "url": "https://github.com/ConsenSys/teku/pull/3352#discussion_r537209224", "bodyText": "If we just used toList() it would create a default sized backing array and then when the number of validators outgrows it have to copy them all to a new, bigger list.  It will wind up repeating that process at least a few times before it is actually big enough to hold the validators, and that final array may actually wind up being much bigger than we needed, wasting memory.\nSince we know the final list size we'll need and it's a really big number that we want to avoid having to copy, creating the array this way winds up more efficient in CPU and memory usage.", "author": "ajsutton", "createdAt": "2020-12-07T03:38:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgyNDI0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgyNDk1MQ==", "url": "https://github.com/ConsenSys/teku/pull/3352#discussion_r535824951", "bodyText": "if it's not current or previous, should it be an IllegalState? theres if, else if, no else...", "author": "rolfyone", "createdAt": "2020-12-04T04:19:57Z", "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/epoch/status/ValidatorStatuses.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.core.epoch.status;\n+\n+import static tech.pegasys.teku.datastructures.util.BeaconStateUtil.get_block_root_at_slot;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.datastructures.operations.AttestationData;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n+import tech.pegasys.teku.datastructures.state.Checkpoint;\n+import tech.pegasys.teku.datastructures.state.Validator;\n+import tech.pegasys.teku.datastructures.util.AttestationUtil;\n+import tech.pegasys.teku.datastructures.util.BeaconStateUtil;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.ssz.SSZTypes.SSZList;\n+\n+public class ValidatorStatuses {\n+  private final List<ValidatorStatus> statuses;\n+  private final TotalBalances totalBalances;\n+\n+  private ValidatorStatuses(\n+      final List<ValidatorStatus> statuses, final TotalBalances totalBalances) {\n+    this.statuses = statuses;\n+    this.totalBalances = totalBalances;\n+  }\n+\n+  public static ValidatorStatuses create(final BeaconState state) {\n+    final SSZList<Validator> validators = state.getValidators();\n+\n+    final UInt64 currentEpoch = BeaconStateUtil.get_current_epoch(state);\n+    final UInt64 previousEpoch = BeaconStateUtil.get_previous_epoch(state);\n+\n+    final List<ValidatorStatus> statuses =\n+        validators.stream()\n+            .map(validator -> ValidatorStatus.create(validator, previousEpoch, currentEpoch))\n+            .collect(Collectors.toCollection(() -> new ArrayList<>(validators.size())));\n+\n+    processAttestations(statuses, state, previousEpoch, currentEpoch);\n+\n+    final TotalBalances totalBalances = TotalBalances.create(statuses);\n+\n+    return new ValidatorStatuses(statuses, totalBalances);\n+  }\n+\n+  private static void processAttestations(\n+      final List<ValidatorStatus> statuses,\n+      final BeaconState state,\n+      final UInt64 previousEpoch,\n+      final UInt64 currentEpoch) {\n+    Stream.concat(\n+            state.getPrevious_epoch_attestations().stream(),\n+            state.getCurrent_epoch_attestations().stream())\n+        .forEach(\n+            attestation -> {\n+              final AttestationData data = attestation.getData();\n+\n+              final AttestationUpdates updates = new AttestationUpdates();\n+              final Checkpoint target = data.getTarget();\n+              if (target.getEpoch().equals(currentEpoch)) {\n+                updates.currentEpochAttester = true;\n+                updates.currentEpochTargetAttester =\n+                    matchesEpochStartBlock(state, currentEpoch, target.getRoot());\n+              } else if (target.getEpoch().equals(previousEpoch)) {", "originalCommit": "66afa36703fc03f86c047692986e4297120314de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIyODE3OA==", "url": "https://github.com/ConsenSys/teku/pull/3352#discussion_r537228178", "bodyText": "I'm in two minds about this.  If it's not either, there's no rewards and we can just ignore the attestation so the current code isn't wrong.  It shouldn't ever happen because the attestations in a state only come from blocks and the block validation prevents attestations that aren't from current or previous epoch from appearing.  If that ever changed we wouldn't necessarily want this to throw an exception.\nGiven that we're iterating over the combination of getPrevious_epoch_attestations and getCurrent_epoch_attestations I'm going to lean towards not having the else unless there are particularly strong objections.", "author": "ajsutton", "createdAt": "2020-12-07T04:46:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgyNDk1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIzNDUyMw==", "url": "https://github.com/ConsenSys/teku/pull/3352#discussion_r537234523", "bodyText": "I was just curious of the reasoning because its a little uncommon so I figured I'd ask the question - happy with the answer.", "author": "rolfyone", "createdAt": "2020-12-07T05:08:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgyNDk1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzIzNTk3Mw==", "url": "https://github.com/ConsenSys/teku/pull/3352#discussion_r537235973", "bodyText": "It was an excellent question. :)", "author": "ajsutton", "createdAt": "2020-12-07T05:13:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgyNDk1MQ=="}], "type": "inlineReview"}, {"oid": "4258a74bc8d22f590e8c1d52ad9dc9a5f547d79c", "url": "https://github.com/ConsenSys/teku/commit/4258a74bc8d22f590e8c1d52ad9dc9a5f547d79c", "message": "Remove duplicate call.", "committedDate": "2020-12-06T20:08:29Z", "type": "commit"}, {"oid": "4c5570411e558e530f0e6acac9ac9aafa6d6513e", "url": "https://github.com/ConsenSys/teku/commit/4c5570411e558e530f0e6acac9ac9aafa6d6513e", "message": "Merge branch 'master' of github.com:ConsenSys/teku into single-pass-epoch", "committedDate": "2020-12-06T20:13:18Z", "type": "commit"}, {"oid": "fab936abe5b5d5f5ae9ad7c30036d66eff62cd5e", "url": "https://github.com/ConsenSys/teku/commit/fab936abe5b5d5f5ae9ad7c30036d66eff62cd5e", "message": "Precompute total active balance square root.", "committedDate": "2020-12-06T23:31:28Z", "type": "commit"}, {"oid": "4a64b16c1fe99a0b9e6a2578803797321df2fbb7", "url": "https://github.com/ConsenSys/teku/commit/4a64b16c1fe99a0b9e6a2578803797321df2fbb7", "message": "Apply rewards and penalties in one step to avoid duplicate state access.", "committedDate": "2020-12-07T00:01:46Z", "type": "commit"}, {"oid": "889e92c8b2d17ae63bec163671979dd8cb8ef12c", "url": "https://github.com/ConsenSys/teku/commit/889e92c8b2d17ae63bec163671979dd8cb8ef12c", "message": "Spotless.", "committedDate": "2020-12-07T00:19:10Z", "type": "commit"}, {"oid": "1693caa6023cf9ac6efd665419c54f60a20c1192", "url": "https://github.com/ConsenSys/teku/commit/1693caa6023cf9ac6efd665419c54f60a20c1192", "message": "Merge branch 'master' of github.com:ConsenSys/teku into single-pass-epoch", "committedDate": "2020-12-07T00:19:17Z", "type": "commit"}, {"oid": "e54b6b5244446c65a71933d3ee83ac5d6bfb683a", "url": "https://github.com/ConsenSys/teku/commit/e54b6b5244446c65a71933d3ee83ac5d6bfb683a", "message": "Minimise state access in process_registry_updates", "committedDate": "2020-12-07T01:24:12Z", "type": "commit"}, {"oid": "ebec808e2c0c6223910d7b4639b3cd951c80bca6", "url": "https://github.com/ConsenSys/teku/commit/ebec808e2c0c6223910d7b4639b3cd951c80bca6", "message": "Merge branch 'master' of github.com:ConsenSys/teku into single-pass-epoch", "committedDate": "2020-12-07T01:28:35Z", "type": "commit"}, {"oid": "666854dc903e24befe37d40c1a37041a5b778e53", "url": "https://github.com/ConsenSys/teku/commit/666854dc903e24befe37d40c1a37041a5b778e53", "message": "Avoid recalculating total_active_balance in process_justification_and_finalization.", "committedDate": "2020-12-07T01:37:47Z", "type": "commit"}, {"oid": "af39e6dcf9bd3c68b0ad2c289b4b94f391bd9e91", "url": "https://github.com/ConsenSys/teku/commit/af39e6dcf9bd3c68b0ad2c289b4b94f391bd9e91", "message": "Merge branch 'master' of github.com:ConsenSys/teku into single-pass-epoch", "committedDate": "2020-12-07T02:11:55Z", "type": "commit"}, {"oid": "fb22783e5c2832f7c6566e242cf42681f18456e0", "url": "https://github.com/ConsenSys/teku/commit/fb22783e5c2832f7c6566e242cf42681f18456e0", "message": "Merge branch 'master' into single-pass-epoch", "committedDate": "2020-12-07T21:54:51Z", "type": "commit"}]}