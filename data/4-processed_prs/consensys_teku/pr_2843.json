{"pr_number": 2843, "pr_title": "[Issue 2273] Validate peers against weakSubjectivity checkpoint", "pr_createdAt": "2020-09-24T20:17:08Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2843", "timeline": [{"oid": "a69cfe37756b6270e411c672d8e08b95f04db710", "url": "https://github.com/ConsenSys/teku/commit/a69cfe37756b6270e411c672d8e08b95f04db710", "message": "Pass ws checkpoint through to PeerChainValidator", "committedDate": "2020-09-24T20:02:10Z", "type": "commit"}, {"oid": "f6f062e8e5b639f5a10680e39f7c666daa83b337", "url": "https://github.com/ConsenSys/teku/commit/f6f062e8e5b639f5a10680e39f7c666daa83b337", "message": "Update test factory", "committedDate": "2020-09-24T20:02:10Z", "type": "commit"}, {"oid": "786056b0b3279f2a6b301a9c92029316768ddca0", "url": "https://github.com/ConsenSys/teku/commit/786056b0b3279f2a6b301a9c92029316768ddca0", "message": "Add required checkpoint validation logic to PeerChainValidator", "committedDate": "2020-09-24T20:02:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA0NjE1OQ==", "url": "https://github.com/ConsenSys/teku/pull/2843#discussion_r495046159", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private boolean validateFork(final Eth2Peer peer, final PeerStatus status) {\n          \n          \n            \n              private boolean isForkValid(final Eth2Peer peer, final PeerStatus status) {", "author": "cemozerr", "createdAt": "2020-09-25T14:57:48Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/peers/PeerChainValidator.java", "diffHunk": "@@ -87,24 +96,85 @@ public static PeerChainValidator create(\n             });\n   }\n \n-  private SafeFuture<Boolean> checkRemoteChain(final Eth2Peer peer, final PeerStatus status) {\n-    // Check fork compatibility\n+  private SafeFuture<Boolean> isRemoteChainValid(final Eth2Peer peer, final PeerStatus status) {\n+    if (!validateFork(peer, status)) {\n+      return SafeFuture.completedFuture(false);\n+    }\n+\n+    // Skip remaining checks if only genesis is finalized\n+    if (status.getFinalizedEpoch().equals(UInt64.ZERO)) {\n+      return SafeFuture.completedFuture(true);\n+    }\n+\n+    return validateRequiredCheckpoint(peer, status)\n+        .thenCompose(\n+            isValid -> {\n+              if (!isValid) {\n+                // Short-circuit if we know the chain is invalid\n+                LOG.trace(\n+                    \"Failed to validate peer against required checkpoint {}\", requiredCheckpoint);\n+                return SafeFuture.completedFuture(isValid);\n+              }\n+\n+              return validateFinalizedCheckpoint(peer, status);\n+            });\n+  }\n+\n+  private boolean validateFork(final Eth2Peer peer, final PeerStatus status) {", "originalCommit": "786056b0b3279f2a6b301a9c92029316768ddca0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "309cf02c1d5de5a1dd988949e51c346780692fc3", "url": "https://github.com/ConsenSys/teku/commit/309cf02c1d5de5a1dd988949e51c346780692fc3", "message": "Merge branch 'master' into issue-2273/validate-peers-against-ws-checkpoint", "committedDate": "2020-09-25T15:22:15Z", "type": "commit"}, {"oid": "caade081834b82dc72aa19a0dcddf0a381bbe5c0", "url": "https://github.com/ConsenSys/teku/commit/caade081834b82dc72aa19a0dcddf0a381bbe5c0", "message": "Rework method names", "committedDate": "2020-09-25T15:30:21Z", "type": "commit"}, {"oid": "1d334c2cf601e77b94ffca20f26512ca3f840d03", "url": "https://github.com/ConsenSys/teku/commit/1d334c2cf601e77b94ffca20f26512ca3f840d03", "message": "Add more logging", "committedDate": "2020-09-25T16:04:43Z", "type": "commit"}]}