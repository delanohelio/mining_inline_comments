{"pr_number": 1133, "pr_title": "Remerkable", "pr_createdAt": "2020-02-04T16:59:54Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1133", "timeline": [{"oid": "94cac9a5f0587686159a2700dba3f4cb95392031", "url": "https://github.com/ConsenSys/teku/commit/94cac9a5f0587686159a2700dba3f4cb95392031", "message": "GenesisGenerator should return a brand new copy with cleared caches (actual for tests mostly)", "committedDate": "2020-02-20T16:41:57Z", "type": "commit"}, {"oid": "0254981dc6edd58968041861f44e81039adef6cf", "url": "https://github.com/ConsenSys/teku/commit/0254981dc6edd58968041861f44e81039adef6cf", "message": "Fix GenesisGenerator bug: should create a copy after finalizeState()", "committedDate": "2020-02-20T17:24:03Z", "type": "commit"}, {"oid": "0c9d6879311826dea02a143a35def90dc41c5ac0", "url": "https://github.com/ConsenSys/teku/commit/0c9d6879311826dea02a143a35def90dc41c5ac0", "message": "Merge branch 'backing-state-structs-refactor' into optimize-backing-tree-concept", "committedDate": "2020-02-20T17:24:42Z", "type": "commit"}, {"oid": "a4506cbd330da9c68503ec1d50071a153196feaf", "url": "https://github.com/ConsenSys/teku/commit/a4506cbd330da9c68503ec1d50071a153196feaf", "message": "Fix MapDB database using BeaconStateImpl for now", "committedDate": "2020-02-21T09:06:35Z", "type": "commit"}, {"oid": "4c9851d129c02acdf4b32b4d7c79fb1f99e22860", "url": "https://github.com/ConsenSys/teku/commit/4c9851d129c02acdf4b32b4d7c79fb1f99e22860", "message": "Spotless apply", "committedDate": "2020-02-21T10:56:16Z", "type": "commit"}, {"oid": "cb81a092ceec47132d27a408f8f0a5a33cf6e6db", "url": "https://github.com/ConsenSys/teku/commit/cb81a092ceec47132d27a408f8f0a5a33cf6e6db", "message": "Fix MapDB database using BeaconStateImpl for now", "committedDate": "2020-02-21T10:56:57Z", "type": "commit"}, {"oid": "81caeb75fb1bc68c796f941cce86d36a7253aec3", "url": "https://github.com/ConsenSys/teku/commit/81caeb75fb1bc68c796f941cce86d36a7253aec3", "message": "Spotless apply", "committedDate": "2020-02-21T10:57:06Z", "type": "commit"}, {"oid": "2800d3b16c5e82faf517e698fd8e17937ecbf380", "url": "https://github.com/ConsenSys/teku/commit/2800d3b16c5e82faf517e698fd8e17937ecbf380", "message": "Merge branch 'backing-state-structs-refactor' into optimize-backing-tree-concept", "committedDate": "2020-02-21T11:04:32Z", "type": "commit"}, {"oid": "840eada6dcbef91d733ed56792cb91d2a5d5c033", "url": "https://github.com/ConsenSys/teku/commit/840eada6dcbef91d733ed56792cb91d2a5d5c033", "message": "Fix Array backed SSZList to throw exception when out of bounds", "committedDate": "2020-02-21T11:34:46Z", "type": "commit"}, {"oid": "fca4215b13dbe65e23dbcc925caa555eb035c16d", "url": "https://github.com/ConsenSys/teku/commit/fca4215b13dbe65e23dbcc925caa555eb035c16d", "message": "Fix SSZList overflow", "committedDate": "2020-02-21T13:08:29Z", "type": "commit"}, {"oid": "328583a2698a6e629453a3deeda6e2bbc834c9d3", "url": "https://github.com/ConsenSys/teku/commit/328583a2698a6e629453a3deeda6e2bbc834c9d3", "message": "Fix SSZList.concat()", "committedDate": "2020-02-21T13:09:08Z", "type": "commit"}, {"oid": "ed1547a31bf966d7615040f444893c625a5a71b7", "url": "https://github.com/ConsenSys/teku/commit/ed1547a31bf966d7615040f444893c625a5a71b7", "message": "Add ability to create a 'builder' MutableBeaconState instance which doesn't cache but creates instances with cache enabled", "committedDate": "2020-02-21T13:17:26Z", "type": "commit"}, {"oid": "1750f981732c17b6b7a8ccd216d655daef62418d", "url": "https://github.com/ConsenSys/teku/commit/1750f981732c17b6b7a8ccd216d655daef62418d", "message": "Fix failing test: looks like `recursiveComparison` doesn't fit SSZList structure", "committedDate": "2020-02-21T13:33:32Z", "type": "commit"}, {"oid": "d9c42005a264113a25236d99ff9713a8f5c57474", "url": "https://github.com/ConsenSys/teku/commit/d9c42005a264113a25236d99ff9713a8f5c57474", "message": "Spotless apply", "committedDate": "2020-02-21T14:15:50Z", "type": "commit"}, {"oid": "d00fc71304e85b8e28547992f88bb9709cdba736", "url": "https://github.com/ConsenSys/teku/commit/d00fc71304e85b8e28547992f88bb9709cdba736", "message": "JSON provider is broken. Temporarily disable test", "committedDate": "2020-02-21T14:18:37Z", "type": "commit"}, {"oid": "fafad1d92d30fdba5603e30b42251dfce9d687ab", "url": "https://github.com/ConsenSys/teku/commit/fafad1d92d30fdba5603e30b42251dfce9d687ab", "message": "Minor merge fix", "committedDate": "2020-02-21T14:33:08Z", "type": "commit"}, {"oid": "684fa8a139c2653778d77ef834304d883eb81ec1", "url": "https://github.com/ConsenSys/teku/commit/684fa8a139c2653778d77ef834304d883eb81ec1", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-backing-tree-concept\n\n# Conflicts:\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/state/BeaconState.java\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/state/BeaconStateWithCache.java\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/state/Validator.java\n#\tutil/src/main/java/tech/pegasys/artemis/util/SSZTypes/SSZList.java\n#\tutil/src/main/java/tech/pegasys/artemis/util/SSZTypes/SSZVector.java", "committedDate": "2020-02-21T14:36:59Z", "type": "commit"}, {"oid": "9a4e01847be5aa0f483292d64367c49da0bc9d0c", "url": "https://github.com/ConsenSys/teku/commit/9a4e01847be5aa0f483292d64367c49da0bc9d0c", "message": "Resolve merge conflict", "committedDate": "2020-02-21T14:38:49Z", "type": "commit"}, {"oid": "fad23597c002adc5eab6c9693558d384c4092428", "url": "https://github.com/ConsenSys/teku/commit/fad23597c002adc5eab6c9693558d384c4092428", "message": "Merge branch 'backing-state-structs-refactor' into optimize-backing-tree-concept\n\n# Conflicts:\n#\tdata/provider/src/test/java/tech/pegasys/artemis/provider/JsonProviderTest.java", "committedDate": "2020-02-21T14:39:31Z", "type": "commit"}, {"oid": "f968e7c4ec93dc647652a25404c9904515d72eea", "url": "https://github.com/ConsenSys/teku/commit/f968e7c4ec93dc647652a25404c9904515d72eea", "message": "JSON provider is broken. Temporarily disable tests", "committedDate": "2020-02-21T14:41:04Z", "type": "commit"}, {"oid": "436110f264a354c57d44a36f7cc9275565bc8fee", "url": "https://github.com/ConsenSys/teku/commit/436110f264a354c57d44a36f7cc9275565bc8fee", "message": "Fix errorprone warn", "committedDate": "2020-02-21T14:51:10Z", "type": "commit"}, {"oid": "ff245c21e0cfa5fa580421708eb5e179d1fd22d8", "url": "https://github.com/ConsenSys/teku/commit/ff245c21e0cfa5fa580421708eb5e179d1fd22d8", "message": "Specify JSON properties explicitly for structures. Fix SSZList/Vector serialization", "committedDate": "2020-02-21T16:02:47Z", "type": "commit"}, {"oid": "d88b7b8c5696693aa49af99ed7e4b6448317ccc2", "url": "https://github.com/ConsenSys/teku/commit/d88b7b8c5696693aa49af99ed7e4b6448317ccc2", "message": "Add dependency", "committedDate": "2020-02-21T16:20:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY2NDY3NQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r382664675", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              void setIvalidator(Consumer<ViewWrite> listener);\n          \n          \n            \n              void setInvalidator(Consumer<ViewWrite> listener);", "author": "mbaxter", "createdAt": "2020-02-21T16:02:59Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/CompositeViewWrite.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing;\n+\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+\n+public interface CompositeViewWrite<R> extends ViewWrite, CompositeViewRead<R> {\n+\n+  void setIvalidator(Consumer<ViewWrite> listener);", "originalCommit": "436110f264a354c57d44a36f7cc9275565bc8fee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzcxMzg3NQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r383713875", "bodyText": "Thanks!", "author": "Nashatyrev", "createdAt": "2020-02-25T08:09:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY2NDY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY2NzA3OA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r382667078", "bodyText": "looks like most of these reference test methods should be able to use the BeaconState interface types (MutableBeaconState)", "author": "mbaxter", "createdAt": "2020-02-21T16:07:18Z", "path": "eth-reference-tests/src/referenceTest/java/tech/pegasys/artemis/reference/phase0/epoch_processing/final_updates.java", "diffHunk": "@@ -24,22 +24,22 @@\n import org.junit.jupiter.params.ParameterizedTest;\n import org.junit.jupiter.params.provider.Arguments;\n import org.junit.jupiter.params.provider.MethodSource;\n-import tech.pegasys.artemis.datastructures.state.BeaconState;\n+import tech.pegasys.artemis.datastructures.state.BeaconStateImpl;\n import tech.pegasys.artemis.ethtests.TestSuite;\n import tech.pegasys.artemis.statetransition.util.EpochProcessorUtil;\n \n @ExtendWith(BouncyCastleExtension.class)\n public class final_updates extends TestSuite {\n   @ParameterizedTest(name = \"{index}. process final updates pre={0} -> post={1}\")\n   @MethodSource(\"mainnetFinalUpdatesSetup\")\n-  void mainnetProcessFinalUpdates(BeaconState pre, BeaconState post) throws Exception {\n+  void mainnetProcessFinalUpdates(BeaconStateImpl pre, BeaconStateImpl post) throws Exception {", "originalCommit": "ff245c21e0cfa5fa580421708eb5e179d1fd22d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzcxNDE2Ng==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r383714166", "bodyText": "Yes, ref tests are still on the way", "author": "Nashatyrev", "createdAt": "2020-02-25T08:10:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY2NzA3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY2OTczOQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r382669739", "bodyText": "Is it possible to break up the interfaces in a more granular way so we don't end up needing these UnsupportedOperationException's ?", "author": "mbaxter", "createdAt": "2020-02-21T16:12:07Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/view/AbstractBasicView.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing.view;\n+\n+import tech.pegasys.artemis.util.backing.BasicView;\n+import tech.pegasys.artemis.util.backing.ViewWrite;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode;\n+import tech.pegasys.artemis.util.backing.type.BasicViewType;\n+\n+public abstract class AbstractBasicView<C, V extends AbstractBasicView<C, V>>\n+    implements BasicView<C> {\n+  private final BasicViewType<V> type;\n+  private final C value;\n+\n+  public AbstractBasicView(C value, BasicViewType<V> type) {\n+    this.type = type;\n+    this.value = value;\n+  }\n+\n+  @Override\n+  public C get() {\n+    return value;\n+  }\n+\n+  @Override\n+  public BasicViewType<V> getType() {\n+    return type;\n+  }\n+\n+  @Override\n+  public TreeNode getBackingNode() {\n+    return getType().createTreeNode(getThis());\n+  }\n+\n+  @SuppressWarnings(\"unchecked\")\n+  protected V getThis() {\n+    return (V) this;\n+  }\n+\n+  @Override\n+  public ViewWrite createWritableCopy() {\n+    throw new UnsupportedOperationException(\"Basic view instances are immutable\");", "originalCommit": "ff245c21e0cfa5fa580421708eb5e179d1fd22d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk0NjEyMQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r383946121", "bodyText": "Very good question! :)\nI honestly tried to do this, but didn't succeeded. The reason is that mutable 'views' extends immutable, like this:\ninterface ImmutableA {\n    int getInt();\n}\ninterface MutableA extends ImmutableA {\n    void setInt(int i);\n}\n\ninterface ImmutableB {\n    ImmutableA getA();\n}\ninterface MutableB {\n    // here we can narrow return type to mutable\n    MutableA getA();\n}\nThis way you get the whole data hierarchy either immutable or mutable.\nSeparating immutable and mutable class hierarchies is possible though eliminates flexibility.\nE.g. beacon state transition functions requires MutableBeaconState but they use functions which need just readonly BeaconState. In the current design you just pass MutableBeaconState instance (which it subclass of BeaconState). If hierarchies are separated it would become less graceful.\nOh, just realized that I was explaining similar issue which is a bit different from your concern: my wish to prohibit the following methods for ViewWrite:\n\ncreateWriteableCopy\nhashTreeRoot\n\nAll my efforts to achieve finer interface granularity and generic type safety had resulted in a pretty complex and large interfaces set, so I just gave up finally\nAny ideas on improvements which don't lead to number of interfaces explosure are very welcome!", "author": "Nashatyrev", "createdAt": "2020-02-25T15:20:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY2OTczOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3MzM0Nw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r382673347", "bodyText": "looks like all these unused fields can go away?", "author": "mbaxter", "createdAt": "2020-02-21T16:18:44Z", "path": "ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/state/BeaconStateImpl.java", "diffHunk": "@@ -0,0 +1,719 @@\n+/*\n+ * Copyright 2019 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.datastructures.state;\n+\n+import com.google.common.base.MoreObjects;\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+import jdk.jfr.Label;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.apache.tuweni.ssz.SSZ;\n+import tech.pegasys.artemis.datastructures.blocks.BeaconBlockHeader;\n+import tech.pegasys.artemis.datastructures.blocks.Eth1Data;\n+import tech.pegasys.artemis.datastructures.util.SimpleOffsetSerializer;\n+import tech.pegasys.artemis.util.SSZTypes.Bitvector;\n+import tech.pegasys.artemis.util.SSZTypes.SSZBackingList;\n+import tech.pegasys.artemis.util.SSZTypes.SSZBackingListRef;\n+import tech.pegasys.artemis.util.SSZTypes.SSZBackingVector;\n+import tech.pegasys.artemis.util.SSZTypes.SSZList;\n+import tech.pegasys.artemis.util.SSZTypes.SSZMutableList;\n+import tech.pegasys.artemis.util.SSZTypes.SSZMutableRefList;\n+import tech.pegasys.artemis.util.SSZTypes.SSZMutableVector;\n+import tech.pegasys.artemis.util.SSZTypes.SSZVector;\n+import tech.pegasys.artemis.util.backing.ContainerViewWrite;\n+import tech.pegasys.artemis.util.backing.ListViewWrite;\n+import tech.pegasys.artemis.util.backing.ListViewWriteRef;\n+import tech.pegasys.artemis.util.backing.VectorViewRead;\n+import tech.pegasys.artemis.util.backing.VectorViewWrite;\n+import tech.pegasys.artemis.util.backing.ViewRead;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode;\n+import tech.pegasys.artemis.util.backing.type.BasicViewTypes;\n+import tech.pegasys.artemis.util.backing.type.ContainerViewType;\n+import tech.pegasys.artemis.util.backing.type.ListViewType;\n+import tech.pegasys.artemis.util.backing.type.VectorViewType;\n+import tech.pegasys.artemis.util.backing.view.AbstractBasicView;\n+import tech.pegasys.artemis.util.backing.view.BasicViews.BitView;\n+import tech.pegasys.artemis.util.backing.view.BasicViews.Bytes32View;\n+import tech.pegasys.artemis.util.backing.view.BasicViews.UInt64View;\n+import tech.pegasys.artemis.util.backing.view.ContainerViewImpl;\n+import tech.pegasys.artemis.util.backing.view.ViewUtils;\n+import tech.pegasys.artemis.util.config.Constants;\n+\n+public class BeaconStateImpl extends ContainerViewImpl<BeaconStateImpl>\n+    implements MutableBeaconState, BeaconStateCache {\n+\n+  // The number of SimpleSerialize basic types in this SSZ Container/POJO.\n+  public static final int SSZ_FIELD_COUNT = 14;\n+\n+  public static final ContainerViewType<BeaconStateImpl> TYPE =\n+      new ContainerViewType<>(\n+          List.of(\n+              BasicViewTypes.UINT64_TYPE,\n+              BasicViewTypes.UINT64_TYPE,\n+              Fork.TYPE,\n+              BeaconBlockHeader.TYPE,\n+              new VectorViewType<>(\n+                  BasicViewTypes.BYTES32_TYPE, Constants.SLOTS_PER_HISTORICAL_ROOT),\n+              new VectorViewType<>(\n+                  BasicViewTypes.BYTES32_TYPE, Constants.SLOTS_PER_HISTORICAL_ROOT),\n+              new ListViewType<>(BasicViewTypes.BYTES32_TYPE, Constants.HISTORICAL_ROOTS_LIMIT),\n+              Eth1Data.TYPE,\n+              new ListViewType<>(Eth1Data.TYPE, Constants.SLOTS_PER_ETH1_VOTING_PERIOD),\n+              BasicViewTypes.UINT64_TYPE,\n+              new ListViewType<>(ValidatorImpl.TYPE, Constants.VALIDATOR_REGISTRY_LIMIT),\n+              new ListViewType<>(BasicViewTypes.UINT64_TYPE, Constants.VALIDATOR_REGISTRY_LIMIT),\n+              new VectorViewType<>(\n+                  BasicViewTypes.BYTES32_TYPE, Constants.EPOCHS_PER_HISTORICAL_VECTOR),\n+              new VectorViewType<>(\n+                  BasicViewTypes.UINT64_TYPE, Constants.EPOCHS_PER_SLASHINGS_VECTOR),\n+              new ListViewType<>(\n+                  PendingAttestation.TYPE, Constants.MAX_ATTESTATIONS * Constants.SLOTS_PER_EPOCH),\n+              new ListViewType<>(\n+                  PendingAttestation.TYPE, Constants.MAX_ATTESTATIONS * Constants.SLOTS_PER_EPOCH),\n+              new VectorViewType<>(BasicViewTypes.BIT_TYPE, Constants.JUSTIFICATION_BITS_LENGTH),\n+              Checkpoint.TYPE,\n+              Checkpoint.TYPE,\n+              Checkpoint.TYPE),\n+          BeaconStateImpl::new);\n+\n+  @Label(\"sos-ignore\")\n+  private final TransitionCaches transitionCaches;\n+\n+  @Label(\"sos-ignore\")\n+  private final boolean builder;\n+\n+  // Versioning\n+  @SuppressWarnings(\"unused\")", "originalCommit": "ff245c21e0cfa5fa580421708eb5e179d1fd22d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzcxNTE3OA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r383715178", "bodyText": "Absolutely, but later, since SSZ SoS relies on fields via reflection for now", "author": "Nashatyrev", "createdAt": "2020-02-25T08:12:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3MzM0Nw=="}], "type": "inlineReview"}, {"oid": "00be63a05a51b6ed0f7aec2fba30d0df4c9f8250", "url": "https://github.com/ConsenSys/teku/commit/00be63a05a51b6ed0f7aec2fba30d0df4c9f8250", "message": "Fix method name typo", "committedDate": "2020-02-25T08:09:14Z", "type": "commit"}, {"oid": "205f9be9a02c058cfaf2bacc58934fdc1de9d1bf", "url": "https://github.com/ConsenSys/teku/commit/205f9be9a02c058cfaf2bacc58934fdc1de9d1bf", "message": "Fix Path -> URL transformation: works fine on Win now", "committedDate": "2020-02-25T10:37:07Z", "type": "commit"}, {"oid": "8d7d0c6d8b328d6992b9c46502d5299ffbbb27df", "url": "https://github.com/ConsenSys/teku/commit/8d7d0c6d8b328d6992b9c46502d5299ffbbb27df", "message": "Reset BeaconState static constants due to different test configs", "committedDate": "2020-02-25T12:19:12Z", "type": "commit"}, {"oid": "b9a8a34632acf032e5f505691670755e2a0d2e20", "url": "https://github.com/ConsenSys/teku/commit/b9a8a34632acf032e5f505691670755e2a0d2e20", "message": "Adjust block reference tests for new BeaconState interface", "committedDate": "2020-02-25T12:20:05Z", "type": "commit"}, {"oid": "01ce7d6d8a2140ec40c52eb727c7fd5127231d5e", "url": "https://github.com/ConsenSys/teku/commit/01ce7d6d8a2140ec40c52eb727c7fd5127231d5e", "message": "Get rid of BeaconStateImpl refs from reference tests where possible", "committedDate": "2020-02-25T13:07:47Z", "type": "commit"}, {"oid": "27526b8800f9d557a26d483264875b04cc2f15cc", "url": "https://github.com/ConsenSys/teku/commit/27526b8800f9d557a26d483264875b04cc2f15cc", "message": "Fix reference test", "committedDate": "2020-02-25T13:11:53Z", "type": "commit"}, {"oid": "46d85845de94d4a45f001b63cb437129ef68742e", "url": "https://github.com/ConsenSys/teku/commit/46d85845de94d4a45f001b63cb437129ef68742e", "message": "Reduce auto test name: IDEA often becomes irresponsive with such long names", "committedDate": "2020-02-25T13:14:53Z", "type": "commit"}, {"oid": "d153b3cc7895ac89a389598822a832d76538aa77", "url": "https://github.com/ConsenSys/teku/commit/d153b3cc7895ac89a389598822a832d76538aa77", "message": "Apply spotless", "committedDate": "2020-02-25T13:21:09Z", "type": "commit"}, {"oid": "0d6321849ffa37b5d9f36442601bfa11a0ade5cc", "url": "https://github.com/ConsenSys/teku/commit/0d6321849ffa37b5d9f36442601bfa11a0ade5cc", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-backing-tree-concept", "committedDate": "2020-02-25T14:32:29Z", "type": "commit"}, {"oid": "546616c5e906bf249707cc7c3ec83a5a40026fbc", "url": "https://github.com/ConsenSys/teku/commit/546616c5e906bf249707cc7c3ec83a5a40026fbc", "message": "Backing tree classes: add javadoc, minor refactoring", "committedDate": "2020-02-26T12:36:17Z", "type": "commit"}, {"oid": "46de6a33a141ef71a20b036ae04e15f6b02384e3", "url": "https://github.com/ConsenSys/teku/commit/46de6a33a141ef71a20b036ae04e15f6b02384e3", "message": "Add some more javadoc", "committedDate": "2020-02-26T19:18:17Z", "type": "commit"}, {"oid": "8eefc6f8f636d8fdaad91412b9aafba73cb59ab1", "url": "https://github.com/ConsenSys/teku/commit/8eefc6f8f636d8fdaad91412b9aafba73cb59ab1", "message": "Remove obsolete type parameters for ContainerView* classes", "committedDate": "2020-02-27T11:00:52Z", "type": "commit"}, {"oid": "1041a4cb4cbd3f1615ce56a973a00b02a2241dce", "url": "https://github.com/ConsenSys/teku/commit/1041a4cb4cbd3f1615ce56a973a00b02a2241dce", "message": "Add some more javadoc", "committedDate": "2020-02-27T11:01:16Z", "type": "commit"}, {"oid": "5f72604cc5d275bec7133811d3f40530bbd14bd6", "url": "https://github.com/ConsenSys/teku/commit/5f72604cc5d275bec7133811d3f40530bbd14bd6", "message": "Throw IndexOutOfBounds on invalid index", "committedDate": "2020-02-27T12:09:00Z", "type": "commit"}, {"oid": "bce1f8c4a75a59845d23dae27057ed52fa8617be", "url": "https://github.com/ConsenSys/teku/commit/bce1f8c4a75a59845d23dae27057ed52fa8617be", "message": "Add some more javadoc", "committedDate": "2020-02-27T12:09:16Z", "type": "commit"}, {"oid": "b8a03eff2fdd015af7677762697a0a3e3ea0aaae", "url": "https://github.com/ConsenSys/teku/commit/b8a03eff2fdd015af7677762697a0a3e3ea0aaae", "message": "Add some more javadoc", "committedDate": "2020-02-27T14:16:14Z", "type": "commit"}, {"oid": "e3214ef24bd43cab8085714d73deb6de7a7838f6", "url": "https://github.com/ConsenSys/teku/commit/e3214ef24bd43cab8085714d73deb6de7a7838f6", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-backing-tree-concept\n\n# Conflicts:\n#\tstorage/src/test/java/tech/pegasys/artemis/storage/MapDbDatabaseTest.java", "committedDate": "2020-02-27T14:18:15Z", "type": "commit"}, {"oid": "78e36297a7716e1bd80bc92dd7c453f1a51f74e7", "url": "https://github.com/ConsenSys/teku/commit/78e36297a7716e1bd80bc92dd7c453f1a51f74e7", "message": "Resolve merge conflicts", "committedDate": "2020-02-27T14:33:26Z", "type": "commit"}, {"oid": "f419e756cc83f43d90ac97b0a6eb65da06dbf30b", "url": "https://github.com/ConsenSys/teku/commit/f419e756cc83f43d90ac97b0a6eb65da06dbf30b", "message": "Fix list/vector index checking", "committedDate": "2020-02-27T14:34:38Z", "type": "commit"}, {"oid": "85ccb05f20ba7b587c53c4a2d5007b969a49613b", "url": "https://github.com/ConsenSys/teku/commit/85ccb05f20ba7b587c53c4a2d5007b969a49613b", "message": "Fix list boundary checking and thrown exception class in tests", "committedDate": "2020-02-27T15:39:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI2NTA5MQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385265091", "bodyText": "I too feel like that about the BeaconState sometimes \ud83d\ude09", "author": "protolambda", "createdAt": "2020-02-27T17:37:56Z", "path": "eth-benchmark-tests/src/jmh/java/tech/pegasys/artemis/benchmarks/ProfilingRun.java", "diffHunk": "@@ -81,4 +92,89 @@ public void importBlocks() throws Exception {\n       }\n     }\n   }\n+\n+  void compareHashes(BeaconState s1) {\n+    for (int i = 0; i < s1.size(); i++) {\n+      Bytes32 hash = s1.get(i).hashTreeRoot();\n+      System.out.println(i + \": \" + hash);\n+    }\n+    System.out.println(\"BS: \" + s1.hash_tree_root());\n+    System.out.println(\"BS: \" + old_hash_tree_root(s1));", "originalCommit": "85ccb05f20ba7b587c53c4a2d5007b969a49613b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI2ODY0Nw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385268647", "bodyText": "Maybe just pass a mutable beaconstate as pre, since you always have to mutate pre to get post?", "author": "protolambda", "createdAt": "2020-02-27T17:44:41Z", "path": "eth-reference-tests/src/referenceTest/java/tech/pegasys/artemis/reference/phase0/epoch_processing/justification_and_finalization.java", "diffHunk": "@@ -25,25 +25,28 @@\n import org.junit.jupiter.params.provider.Arguments;\n import org.junit.jupiter.params.provider.MethodSource;\n import tech.pegasys.artemis.datastructures.state.BeaconState;\n+import tech.pegasys.artemis.datastructures.state.MutableBeaconState;\n import tech.pegasys.artemis.ethtests.TestSuite;\n import tech.pegasys.artemis.statetransition.util.EpochProcessorUtil;\n \n @ExtendWith(BouncyCastleExtension.class)\n public class justification_and_finalization extends TestSuite {\n-  @ParameterizedTest(name = \"{index}. process justification and finalization pre={0} -> post={1}\")\n+  @ParameterizedTest(name = \"{index}.{2} process justification and finalization\")\n   @MethodSource(\"mainnetProcessJusticationAndFinalizationSetup\")\n-  void mainnetProcessJusticationAndFinalization(BeaconState pre, BeaconState post)\n+  void mainnetProcessJusticationAndFinalization(BeaconState pre, BeaconState post, String testName)\n       throws Exception {\n-    EpochProcessorUtil.process_justification_and_finalization(pre);\n-    assertEquals(pre, post);\n+    MutableBeaconState wState = pre.createWritableCopy();", "originalCommit": "85ccb05f20ba7b587c53c4a2d5007b969a49613b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU1NTg4OA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385555888", "bodyText": "I'd prefer to pass immutable structs whenever possible and mutate them in a limited scope only. Thanks to backing tree design - creating a copy costs almost nothing\nI'm planning to go further and replace createWritableCopy() with\ninterface BeaconState {\n    [ ... ]\n    BeaconState update(Consumer<MutableBeaconState> mutator);\n}\nThis is to explicitly limit mutating scope and restrict accidentally leaking of mutable instances", "author": "Nashatyrev", "createdAt": "2020-02-28T08:06:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI2ODY0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3MDQ4Mw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385270483", "bodyText": "Nitpick: surprised by the mixed casing, although it makes sense in some weird way. Hmm", "author": "protolambda", "createdAt": "2020-02-27T17:48:16Z", "path": "ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/blocks/Eth1Data.java", "diffHunk": "@@ -114,49 +134,33 @@ public boolean equals(Object obj) {\n   }\n \n   /** @return the deposit_root */\n+  @JsonProperty\n   public Bytes32 getDeposit_root() {", "originalCommit": "85ccb05f20ba7b587c53c4a2d5007b969a49613b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU1NzA3Mw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385557073", "bodyText": "This is a new java-pyspec casing \ud83d\ude04", "author": "Nashatyrev", "createdAt": "2020-02-28T08:10:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3MDQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3Mzc2NQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385273765", "bodyText": "I'm sorry it gets so verbose with getters/setters, I had the same problem in Go, but moved half-way to see completion of Python + JS trees first. I'll complete the ZRNT transition to tree structures eventually though.", "author": "protolambda", "createdAt": "2020-02-27T17:54:17Z", "path": "ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/state/BeaconStateImpl.java", "diffHunk": "@@ -0,0 +1,729 @@\n+/*\n+ * Copyright 2019 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.datastructures.state;\n+\n+import com.google.common.base.MoreObjects;\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+import jdk.jfr.Label;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.apache.tuweni.ssz.SSZ;\n+import tech.pegasys.artemis.datastructures.blocks.BeaconBlockHeader;\n+import tech.pegasys.artemis.datastructures.blocks.Eth1Data;\n+import tech.pegasys.artemis.datastructures.util.SimpleOffsetSerializer;\n+import tech.pegasys.artemis.util.SSZTypes.Bitvector;\n+import tech.pegasys.artemis.util.SSZTypes.SSZBackingList;\n+import tech.pegasys.artemis.util.SSZTypes.SSZBackingListRef;\n+import tech.pegasys.artemis.util.SSZTypes.SSZBackingVector;\n+import tech.pegasys.artemis.util.SSZTypes.SSZList;\n+import tech.pegasys.artemis.util.SSZTypes.SSZMutableList;\n+import tech.pegasys.artemis.util.SSZTypes.SSZMutableRefList;\n+import tech.pegasys.artemis.util.SSZTypes.SSZMutableVector;\n+import tech.pegasys.artemis.util.SSZTypes.SSZVector;\n+import tech.pegasys.artemis.util.backing.ContainerViewWrite;\n+import tech.pegasys.artemis.util.backing.ListViewWrite;\n+import tech.pegasys.artemis.util.backing.ListViewWriteRef;\n+import tech.pegasys.artemis.util.backing.VectorViewRead;\n+import tech.pegasys.artemis.util.backing.VectorViewWrite;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode;\n+import tech.pegasys.artemis.util.backing.type.BasicViewTypes;\n+import tech.pegasys.artemis.util.backing.type.ContainerViewType;\n+import tech.pegasys.artemis.util.backing.type.ListViewType;\n+import tech.pegasys.artemis.util.backing.type.VectorViewType;\n+import tech.pegasys.artemis.util.backing.view.AbstractBasicView;\n+import tech.pegasys.artemis.util.backing.view.BasicViews.BitView;\n+import tech.pegasys.artemis.util.backing.view.BasicViews.Bytes32View;\n+import tech.pegasys.artemis.util.backing.view.BasicViews.UInt64View;\n+import tech.pegasys.artemis.util.backing.view.ContainerViewImpl;\n+import tech.pegasys.artemis.util.backing.view.ViewUtils;\n+import tech.pegasys.artemis.util.config.Constants;\n+\n+public class BeaconStateImpl extends ContainerViewImpl<BeaconStateImpl>\n+    implements MutableBeaconState, BeaconStateCache {\n+\n+  // The number of SimpleSerialize basic types in this SSZ Container/POJO.\n+  public static final int SSZ_FIELD_COUNT = 14;\n+\n+  private static volatile ContainerViewType<BeaconStateImpl> TYPE = null;\n+\n+  private static ContainerViewType<BeaconStateImpl> createSSZType() {\n+    return new ContainerViewType<>(\n+        List.of(\n+            BasicViewTypes.UINT64_TYPE,\n+            BasicViewTypes.UINT64_TYPE,\n+            Fork.TYPE,\n+            BeaconBlockHeader.TYPE,\n+            new VectorViewType<>(BasicViewTypes.BYTES32_TYPE, Constants.SLOTS_PER_HISTORICAL_ROOT),\n+            new VectorViewType<>(BasicViewTypes.BYTES32_TYPE, Constants.SLOTS_PER_HISTORICAL_ROOT),\n+            new ListViewType<>(BasicViewTypes.BYTES32_TYPE, Constants.HISTORICAL_ROOTS_LIMIT),\n+            Eth1Data.TYPE,\n+            new ListViewType<>(Eth1Data.TYPE, Constants.SLOTS_PER_ETH1_VOTING_PERIOD),\n+            BasicViewTypes.UINT64_TYPE,\n+            new ListViewType<>(ValidatorImpl.TYPE, Constants.VALIDATOR_REGISTRY_LIMIT),\n+            new ListViewType<>(BasicViewTypes.UINT64_TYPE, Constants.VALIDATOR_REGISTRY_LIMIT),\n+            new VectorViewType<>(\n+                BasicViewTypes.BYTES32_TYPE, Constants.EPOCHS_PER_HISTORICAL_VECTOR),\n+            new VectorViewType<>(BasicViewTypes.UINT64_TYPE, Constants.EPOCHS_PER_SLASHINGS_VECTOR),\n+            new ListViewType<>(\n+                PendingAttestation.TYPE, Constants.MAX_ATTESTATIONS * Constants.SLOTS_PER_EPOCH),\n+            new ListViewType<>(\n+                PendingAttestation.TYPE, Constants.MAX_ATTESTATIONS * Constants.SLOTS_PER_EPOCH),\n+            new VectorViewType<>(BasicViewTypes.BIT_TYPE, Constants.JUSTIFICATION_BITS_LENGTH),\n+            Checkpoint.TYPE,\n+            Checkpoint.TYPE,\n+            Checkpoint.TYPE),\n+        BeaconStateImpl::new);\n+  }\n+\n+  public static ContainerViewType<BeaconStateImpl> getSSZType() {\n+    if (TYPE == null) {\n+      TYPE = createSSZType();\n+    }\n+    return TYPE;\n+  }\n+\n+  public static void resetSSZType() {\n+    TYPE = null;\n+  }\n+\n+  @Label(\"sos-ignore\")\n+  private final TransitionCaches transitionCaches;\n+\n+  @Label(\"sos-ignore\")\n+  private final boolean builder;\n+\n+  // Versioning\n+  @SuppressWarnings(\"unused\")\n+  private final UnsignedLong genesis_time = null;\n+\n+  @SuppressWarnings(\"unused\")\n+  private final UnsignedLong slot = null;\n+\n+  @SuppressWarnings(\"unused\")\n+  private final Fork fork = null; // For versioning hard forks\n+\n+  // History\n+  @SuppressWarnings(\"unused\")\n+  private final BeaconBlockHeader latest_block_header = null;\n+\n+  @SuppressWarnings(\"unused\")\n+  private final SSZVector<Bytes32> block_roots =\n+      SSZVector.create(\n+          Bytes32.class,\n+          Constants.SLOTS_PER_HISTORICAL_ROOT); // Vector of length SLOTS_PER_HISTORICAL_ROOT\n+\n+  @SuppressWarnings(\"unused\")\n+  private final SSZVector<Bytes32> state_roots =\n+      SSZVector.create(\n+          Bytes32.class,\n+          Constants.SLOTS_PER_HISTORICAL_ROOT); // Vector of length SLOTS_PER_HISTORICAL_ROOT\n+\n+  @SuppressWarnings(\"unused\")\n+  private final SSZList<Bytes32> historical_roots =\n+      SSZList.create(\n+          Bytes32.class, Constants.HISTORICAL_ROOTS_LIMIT); // Bounded by HISTORICAL_ROOTS_LIMIT\n+\n+  // Ethereum 1.0 chain data\n+  @SuppressWarnings(\"unused\")\n+  private final Eth1Data eth1_data = null;\n+\n+  @SuppressWarnings(\"unused\")\n+  private final SSZList<Eth1Data> eth1_data_votes =\n+      SSZList.create(\n+          Eth1Data.class,\n+          Constants.SLOTS_PER_ETH1_VOTING_PERIOD); // List Bounded by SLOTS_PER_ETH1_VOTING_PERIOD\n+\n+  @SuppressWarnings(\"unused\")\n+  private final UnsignedLong eth1_deposit_index = null;\n+\n+  // Validator registry\n+  @SuppressWarnings(\"unused\")\n+  private final SSZList<ValidatorImpl> validators =\n+      SSZList.create(\n+          ValidatorImpl.class,\n+          Constants.VALIDATOR_REGISTRY_LIMIT); // List Bounded by VALIDATOR_REGISTRY_LIMIT\n+\n+  @SuppressWarnings(\"unused\")\n+  private final SSZList<UnsignedLong> balances =\n+      SSZList.create(\n+          UnsignedLong.class,\n+          Constants.VALIDATOR_REGISTRY_LIMIT); // List Bounded by VALIDATOR_REGISTRY_LIMIT\n+\n+  @SuppressWarnings(\"unused\")\n+  private final SSZVector<Bytes32> randao_mixes =\n+      SSZVector.create(\n+          Bytes32.class,\n+          Constants.EPOCHS_PER_HISTORICAL_VECTOR); // Vector of length EPOCHS_PER_HISTORICAL_VECTOR\n+\n+  // Slashings\n+  @SuppressWarnings(\"unused\")\n+  private final SSZVector<UnsignedLong> slashings =\n+      SSZVector.create(\n+          UnsignedLong.class,\n+          Constants.EPOCHS_PER_SLASHINGS_VECTOR); // Vector of length EPOCHS_PER_SLASHINGS_VECTOR\n+\n+  // Attestations\n+  @SuppressWarnings(\"unused\")\n+  private final SSZList<PendingAttestation> previous_epoch_attestations =\n+      SSZList.create(\n+          PendingAttestation.class,\n+          Constants.MAX_ATTESTATIONS\n+              * Constants.SLOTS_PER_EPOCH); // List bounded by MAX_ATTESTATIONS * SLOTS_PER_EPOCH\n+\n+  @SuppressWarnings(\"unused\")\n+  private final SSZList<PendingAttestation> current_epoch_attestations =\n+      SSZList.create(\n+          PendingAttestation.class,\n+          Constants.MAX_ATTESTATIONS\n+              * Constants.SLOTS_PER_EPOCH); // List bounded by MAX_ATTESTATIONS * SLOTS_PER_EPOCH\n+\n+  // Finality\n+  @SuppressWarnings(\"unused\")\n+  private final Bitvector justification_bits =\n+      new Bitvector(\n+          Constants.JUSTIFICATION_BITS_LENGTH); // Bitvector bounded by JUSTIFICATION_BITS_LENGTH\n+\n+  @SuppressWarnings(\"unused\")\n+  private final Checkpoint previous_justified_checkpoint = null;\n+\n+  @SuppressWarnings(\"unused\")\n+  private final Checkpoint current_justified_checkpoint = null;\n+\n+  @SuppressWarnings(\"unused\")\n+  private final Checkpoint finalized_checkpoint = null;\n+\n+  private BeaconStateImpl(\n+      ContainerViewType<? extends ContainerViewWrite> type, TreeNode backingNode) {\n+    super(type, backingNode);\n+    transitionCaches = TransitionCaches.createNewEmpty();\n+    builder = false;\n+  }\n+\n+  public BeaconStateImpl(\n+      // Versioning\n+      UnsignedLong genesis_time,\n+      UnsignedLong slot,\n+      Fork fork,\n+\n+      // History\n+      BeaconBlockHeader latest_block_header,\n+      SSZVector<Bytes32> block_roots,\n+      SSZVector<Bytes32> state_roots,\n+      SSZList<Bytes32> historical_roots,\n+\n+      // Eth1\n+      Eth1Data eth1_data,\n+      SSZList<Eth1Data> eth1_data_votes,\n+      UnsignedLong eth1_deposit_index,\n+\n+      // Registry\n+      SSZList<? extends Validator> validators,\n+      SSZList<UnsignedLong> balances,\n+\n+      // Randomness\n+      SSZVector<Bytes32> randao_mixes,\n+\n+      // Slashings\n+      SSZVector<UnsignedLong> slashings,\n+\n+      // Attestations\n+      SSZList<PendingAttestation> previous_epoch_attestations,\n+      SSZList<PendingAttestation> current_epoch_attestations,\n+\n+      // Finality\n+      Bitvector justification_bits,\n+      Checkpoint previous_justified_checkpoint,\n+      Checkpoint current_justified_checkpoint,\n+      Checkpoint finalized_checkpoint) {\n+    super(getSSZType());\n+    setGenesis_time(genesis_time);\n+    setSlot(slot);\n+    setFork(fork);\n+    setLatest_block_header(latest_block_header);\n+    getBlock_roots().setAll(block_roots);\n+    getState_roots().setAll(state_roots);\n+    getHistorical_roots().setAll(historical_roots);\n+    setEth1_data(eth1_data);\n+    getEth1_data_votes().setAll(eth1_data_votes);\n+    setEth1_deposit_index(eth1_deposit_index);\n+    getValidators().setAll(validators);\n+    getBalances().setAll(balances);\n+    getRandao_mixes().setAll(randao_mixes);\n+    getSlashings().setAll(slashings);\n+    getPrevious_epoch_attestations().setAll(previous_epoch_attestations);\n+    getCurrent_epoch_attestations().setAll(current_epoch_attestations);\n+    setJustification_bits(justification_bits);\n+    setPrevious_justified_checkpoint(previous_justified_checkpoint);\n+    setCurrent_justified_checkpoint(current_justified_checkpoint);\n+    setFinalized_checkpoint(finalized_checkpoint);\n+    this.transitionCaches = TransitionCaches.createNewEmpty();\n+    this.builder = false;\n+  }\n+\n+  public BeaconStateImpl() {\n+    this(false);\n+  }\n+\n+  public BeaconStateImpl(boolean builder) {\n+    super(getSSZType());\n+    this.builder = builder;\n+    transitionCaches = builder ? TransitionCaches.getNoOp() : TransitionCaches.createNewEmpty();\n+  }\n+\n+  BeaconStateImpl(BeaconState state) {\n+    super(getSSZType(), state.getBackingNode());\n+    this.builder = false;\n+    if (state instanceof BeaconStateImpl && ((BeaconStateImpl) state).builder) {\n+      transitionCaches = TransitionCaches.createNewEmpty();\n+    } else if (state instanceof BeaconStateCache) {\n+      transitionCaches = ((BeaconStateCache) state).getTransitionCaches().copy();\n+    } else {\n+      transitionCaches = TransitionCaches.createNewEmpty();\n+    }\n+  }\n+\n+  @Override\n+  public int getSSZFieldCount() {\n+    return SSZ_FIELD_COUNT\n+        + getFork().getSSZFieldCount()\n+        + getLatest_block_header().getSSZFieldCount()\n+        + getEth1_data().getSSZFieldCount()\n+        + getPrevious_justified_checkpoint().getSSZFieldCount()\n+        + getCurrent_justified_checkpoint().getSSZFieldCount()\n+        + getFinalized_checkpoint().getSSZFieldCount();\n+  }\n+\n+  @Override\n+  public List<Bytes> get_fixed_parts() {\n+    List<Bytes> fixedPartsList = new ArrayList<>();\n+    fixedPartsList.addAll(\n+        List.of(\n+            SSZ.encodeUInt64(getGenesis_time().longValue()),\n+            SSZ.encodeUInt64(getSlot().longValue()),\n+            SimpleOffsetSerializer.serialize(getFork()),\n+            SimpleOffsetSerializer.serialize(getLatest_block_header()),\n+            SSZ.encode(writer -> writer.writeFixedBytesVector(getBlock_roots().asList())),\n+            SSZ.encode(writer -> writer.writeFixedBytesVector(getState_roots().asList())),\n+            Bytes.EMPTY,\n+            SimpleOffsetSerializer.serialize(getEth1_data()),\n+            Bytes.EMPTY,\n+            SSZ.encodeUInt64(getEth1_deposit_index().longValue()),\n+            Bytes.EMPTY,\n+            Bytes.EMPTY,\n+            SSZ.encode(writer -> writer.writeFixedBytesVector(getRandao_mixes().asList())),\n+            SSZ.encode(\n+                writer ->\n+                    writer.writeFixedBytesVector(\n+                        getSlashings().stream()\n+                            .map(slashing -> SSZ.encodeUInt64(slashing.longValue()))\n+                            .collect(Collectors.toList()))),\n+            Bytes.EMPTY,\n+            Bytes.EMPTY,\n+            getJustification_bits().serialize(),\n+            SimpleOffsetSerializer.serialize(getPrevious_justified_checkpoint()),\n+            SimpleOffsetSerializer.serialize(getCurrent_justified_checkpoint()),\n+            SimpleOffsetSerializer.serialize(getFinalized_checkpoint())));\n+    return fixedPartsList;\n+  }\n+\n+  @Override\n+  public List<Bytes> get_variable_parts() {\n+    List<Bytes> variablePartsList = new ArrayList<>();\n+    variablePartsList.addAll(\n+        List.of(Bytes.EMPTY, Bytes.EMPTY, Bytes.EMPTY, Bytes.EMPTY, Bytes.EMPTY, Bytes.EMPTY));\n+    variablePartsList.add(\n+        SSZ.encode(writer -> writer.writeFixedBytesVector(getHistorical_roots().asList())));\n+    variablePartsList.add(Bytes.EMPTY);\n+    variablePartsList.add(SimpleOffsetSerializer.serializeFixedCompositeList(getEth1_data_votes()));\n+    variablePartsList.add(Bytes.EMPTY);\n+    variablePartsList.add(SimpleOffsetSerializer.serializeFixedCompositeList(getValidators()));\n+    // TODO The below lines are a hack while Tuweni SSZ/SOS is being upgraded.\n+    variablePartsList.add(\n+        Bytes.fromHexString(\n+            getBalances().stream()\n+                .map(value -> SSZ.encodeUInt64(value.longValue()).toHexString().substring(2))\n+                .collect(Collectors.joining())));\n+    variablePartsList.addAll(List.of(Bytes.EMPTY, Bytes.EMPTY));\n+    variablePartsList.add(\n+        SimpleOffsetSerializer.serializeVariableCompositeList(getPrevious_epoch_attestations()));\n+    variablePartsList.add(\n+        SimpleOffsetSerializer.serializeVariableCompositeList(getCurrent_epoch_attestations()));\n+    variablePartsList.addAll(List.of(Bytes.EMPTY, Bytes.EMPTY, Bytes.EMPTY));\n+    variablePartsList.addAll(\n+        Collections.nCopies(getPrevious_justified_checkpoint().getSSZFieldCount(), Bytes.EMPTY));\n+    variablePartsList.addAll(\n+        Collections.nCopies(getCurrent_justified_checkpoint().getSSZFieldCount(), Bytes.EMPTY));\n+    variablePartsList.addAll(\n+        Collections.nCopies(getFinalized_checkpoint().getSSZFieldCount(), Bytes.EMPTY));\n+    return variablePartsList;\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    return Objects.hash(\n+        // Versioning\n+        getGenesis_time(),\n+        getSlot(),\n+        getFork(),\n+\n+        // History\n+        getLatest_block_header(),\n+        getBlock_roots(),\n+        getState_roots(),\n+        getHistorical_roots(),\n+\n+        // Eth1\n+        getEth1_data(),\n+        getEth1_data_votes(),\n+        getEth1_deposit_index(),\n+\n+        // Registry\n+        getValidators(),\n+        getBalances(),\n+\n+        // Randomness\n+        getRandao_mixes(),\n+\n+        // Slashings\n+        getSlashings(),\n+\n+        // Attestations\n+        getPrevious_epoch_attestations(),\n+        getCurrent_epoch_attestations(),\n+\n+        // Finality\n+        getJustification_bits(),\n+        getPrevious_justified_checkpoint(),\n+        getCurrent_justified_checkpoint(),\n+        getFinalized_checkpoint());\n+  }\n+\n+  @Override\n+  public boolean equals(Object obj) {\n+    if (Objects.isNull(obj)) {\n+      return false;\n+    }\n+\n+    if (this == obj) {\n+      return true;\n+    }\n+\n+    if (!(obj instanceof BeaconStateImpl)) {\n+      return false;\n+    }\n+\n+    BeaconStateImpl other = (BeaconStateImpl) obj;\n+    return Objects.equals(this.getGenesis_time(), other.getGenesis_time())\n+        && Objects.equals(getSlot(), other.getSlot())\n+        && Objects.equals(this.getFork(), other.getFork())\n+        && Objects.equals(this.getLatest_block_header(), other.getLatest_block_header())\n+        && Objects.equals(this.getBlock_roots(), other.getBlock_roots())\n+        && Objects.equals(this.getState_roots(), other.getState_roots())\n+        && Objects.equals(this.getHistorical_roots(), other.getHistorical_roots())\n+        && Objects.equals(this.getEth1_data(), other.getEth1_data())\n+        && Objects.equals(this.getEth1_data_votes(), other.getEth1_data_votes())\n+        && Objects.equals(this.getEth1_deposit_index(), other.getEth1_deposit_index())\n+        && Objects.equals(this.getValidators(), other.getValidators())\n+        && Objects.equals(this.getBalances(), other.getBalances())\n+        && Objects.equals(this.getRandao_mixes(), other.getRandao_mixes())\n+        && Objects.equals(this.getSlashings(), other.getSlashings())\n+        && Objects.equals(\n+            this.getPrevious_epoch_attestations(), other.getPrevious_epoch_attestations())\n+        && Objects.equals(\n+            this.getCurrent_epoch_attestations(), other.getCurrent_epoch_attestations())\n+        && Objects.equals(this.getJustification_bits(), other.getJustification_bits())\n+        && Objects.equals(\n+            this.getPrevious_justified_checkpoint(), other.getPrevious_justified_checkpoint())\n+        && Objects.equals(\n+            this.getCurrent_justified_checkpoint(), other.getCurrent_justified_checkpoint())\n+        && Objects.equals(this.getFinalized_checkpoint(), other.getFinalized_checkpoint());\n+  }\n+\n+  /** ****************** * GETTERS & SETTERS * * ******************* */", "originalCommit": "85ccb05f20ba7b587c53c4a2d5007b969a49613b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU1ODY3NQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385558675", "bodyText": "I'm planning to refactor hashCode()/equals() for hash_tree_root() usage. Should be short and fast", "author": "Nashatyrev", "createdAt": "2020-02-28T08:14:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3Mzc2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NTM4Nw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385275387", "bodyText": "Is copy just a new reference to the same backing tree? Can be much faster now this way. Doesn't happen too often though.", "author": "protolambda", "createdAt": "2020-02-27T17:57:15Z", "path": "ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/state/HistoricalBatch.java", "diffHunk": "@@ -43,19 +43,13 @@ public HistoricalBatch(SSZVector<Bytes32> block_roots, SSZVector<Bytes32> state_\n   }\n \n   public HistoricalBatch() {\n-    this.block_roots = new SSZVector<>(Constants.SLOTS_PER_HISTORICAL_ROOT, Bytes32.ZERO);\n-    this.state_roots = new SSZVector<>(Constants.SLOTS_PER_HISTORICAL_ROOT, Bytes32.ZERO);\n+    this.block_roots = SSZVector.create(Constants.SLOTS_PER_HISTORICAL_ROOT, Bytes32.ZERO);\n+    this.state_roots = SSZVector.create(Constants.SLOTS_PER_HISTORICAL_ROOT, Bytes32.ZERO);\n   }\n \n-  public HistoricalBatch(HistoricalBatch historicalBatch) {\n-    this.block_roots =\n-        copyBytesList(\n-            historicalBatch.getBlockRoots(),\n-            new SSZVector<>(Constants.SLOTS_PER_HISTORICAL_ROOT, Bytes32.ZERO));\n-    this.state_roots =\n-        copyBytesList(\n-            historicalBatch.getStateRoots(),\n-            new SSZVector<>(Constants.SLOTS_PER_HISTORICAL_ROOT, Bytes32.ZERO));\n+  private HistoricalBatch(HistoricalBatch historicalBatch) {\n+    this.block_roots = SSZVector.copy(historicalBatch.getBlockRoots());", "originalCommit": "85ccb05f20ba7b587c53c4a2d5007b969a49613b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU1OTg3Mg==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385559872", "bodyText": "Keep calm, this is still on TODO list :)", "author": "Nashatyrev", "createdAt": "2020-02-28T08:17:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NTM4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3OTg2Nw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385279867", "bodyText": "Similar to a copy by referencing the same immutable value, setting a field can also just reference the immutable subtree; no need to set all values.", "author": "protolambda", "createdAt": "2020-02-27T18:05:50Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/util/EpochProcessorUtil.java", "diffHunk": "@@ -620,8 +618,9 @@ public static void process_final_updates(BeaconState state) {\n     }\n \n     // Rotate current/previous epoch attestations\n-    state.setPrevious_epoch_attestations(state.getCurrent_epoch_attestations());\n-    state.setCurrent_epoch_attestations(\n-        new SSZList<>(PendingAttestation.class, MAX_ATTESTATIONS * SLOTS_PER_EPOCH));\n+    state.getPrevious_epoch_attestations().setAll(state.getCurrent_epoch_attestations());", "originalCommit": "85ccb05f20ba7b587c53c4a2d5007b969a49613b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4MjQwNw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385282407", "bodyText": "Nice to have, but check cases where you're overwriting every element, and the collection type is the same. In that case, you can just replace the complete backing, instead of setting every single element.", "author": "protolambda", "createdAt": "2020-02-27T18:10:58Z", "path": "util/src/main/java/tech/pegasys/artemis/util/SSZTypes/SSZMutableCollection.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.SSZTypes;\n+\n+public interface SSZMutableCollection<E> extends SSZImmutableCollection<E> {\n+\n+  /**\n+   * Removes all of the elements from this collection (optional operation). The collection will be\n+   * empty after this method returns.\n+   *\n+   * @throws UnsupportedOperationException if the {@code clear} operation is not supported by this\n+   *     collection\n+   */\n+  void clear();\n+\n+  /**\n+   * Replaces the element at the specified position in this list with the specified element\n+   * (optional operation).\n+   *\n+   * @param index index of the element to replace\n+   * @param element element to be stored at the specified position\n+   */\n+  void set(int index, E element);\n+\n+  default void setAll(SSZImmutableCollection<? extends E> other) {", "originalCommit": "85ccb05f20ba7b587c53c4a2d5007b969a49613b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU2MTQ0NA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385561444", "bodyText": "Also in my TODO list. Those classes now is a kind of temporary bridge between old and new design. I'm planning to finally get rid of all of them.", "author": "Nashatyrev", "createdAt": "2020-02-28T08:22:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4MjQwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4Mjk3OA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385282978", "bodyText": "copy by referencing same backing should be much cheaper", "author": "protolambda", "createdAt": "2020-02-27T18:12:06Z", "path": "util/src/main/java/tech/pegasys/artemis/util/SSZTypes/SSZVector.java", "diffHunk": "@@ -13,63 +13,23 @@\n \n package tech.pegasys.artemis.util.SSZTypes;\n \n-import com.fasterxml.jackson.annotation.JsonCreator;\n-import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n-import java.util.ArrayList;\n-import java.util.Collections;\n import java.util.List;\n \n-@JsonSerialize(as = ArrayList.class)\n-public class SSZVector<T> extends ArrayList<T> {\n+public interface SSZVector<T> extends SSZImmutableCollection<T> {\n \n-  private int maxSize;\n-  private Class<T> classInfo;\n-\n-  public SSZVector() throws UnsupportedOperationException {\n-    throw new UnsupportedOperationException(\"SSZVector must have specified size\");\n-  }\n-\n-  @SuppressWarnings(\"unchecked\")\n-  public SSZVector(int size, T object) {\n-    super(Collections.nCopies(size, object));\n-    this.maxSize = size;\n-    classInfo = (Class<T>) object.getClass();\n-  }\n-\n-  public SSZVector(List<T> list, Class<T> classInfo) {\n-    super(list);\n-    maxSize = list.size();\n-    this.classInfo = classInfo;\n-  }\n-\n-  @JsonCreator\n-  @SuppressWarnings(\"unchecked\")\n-  public SSZVector(List<T> list) {\n-    super(list);\n-    maxSize = list.size();\n-    if (maxSize < 1) {\n-      throw new UnsupportedOperationException(\n-          \"SSZVector must have at least 1 element in the list used to initialize\");\n-    }\n-    this.classInfo = (Class<T>) list.get(0).getClass();\n-  }\n-\n-  public SSZVector(SSZVector<T> list) {\n-    super(list);\n-    maxSize = list.size();\n-    this.classInfo = list.getElementType();\n+  static <T> SSZMutableVector<T> create(int size, T object) {\n+    return new SSZArrayCollection<T>(size, object, true);\n   }\n \n-  public int getSize() {\n-    return maxSize;\n+  static <T> SSZMutableVector<T> create(Class<T> classInfo, int size) {\n+    return new SSZArrayCollection<T>(classInfo, size, true);\n   }\n \n-  @Override\n-  public boolean add(T object) {\n-    throw new UnsupportedOperationException(\"SSZVector does not support add, only set\");\n+  static <T> SSZMutableVector<T> create(List<T> list, Class<T> classInfo) {\n+    return new SSZArrayCollection<>(list, list.size(), classInfo, true);\n   }\n \n-  public Class<T> getElementType() {\n-    return classInfo;\n+  static <T> SSZVector<T> copy(SSZVector<T> vector) {\n+    return new SSZArrayCollection<T>(vector.asList(), vector.size(), vector.getElementType(), true);", "originalCommit": "85ccb05f20ba7b587c53c4a2d5007b969a49613b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU2MTYyMw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385561623", "bodyText": "Also in my TODO list", "author": "Nashatyrev", "createdAt": "2020-02-28T08:22:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4Mjk3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4NjMyMw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385286323", "bodyText": "Why trim leading zeroes at all? Can we not just print the 32 bytes in hex?", "author": "protolambda", "createdAt": "2020-02-27T18:18:36Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/tree/TreeNodeImpl.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing.tree;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.jetbrains.annotations.NotNull;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode.Commit;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode.Root;\n+\n+class TreeNodeImpl {\n+\n+  static class RootImpl implements Root {\n+    private final Bytes32 root;\n+\n+    public RootImpl(Bytes32 root) {\n+      this.root = root;\n+    }\n+\n+    @Override\n+    public Bytes32 getRoot() {\n+      return root;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      Bytes trimmed = root.trimLeadingZeros();", "originalCommit": "85ccb05f20ba7b587c53c4a2d5007b969a49613b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU2MjgzNQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385562835", "bodyText": "Yep, this is debugging artifact. Fixed.", "author": "Nashatyrev", "createdAt": "2020-02-28T08:25:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4NjMyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4OTQ2Nw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385289467", "bodyText": "Is the allocation of a list for each level cheaper than a simple recursive implementation? Recursive implementations can make the padding more elegant, by not allocating unnecessary tree nodes for that (just the nodes that contain a higher order zero hash)", "author": "protolambda", "createdAt": "2020-02-27T18:24:24Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/tree/TreeUtil.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing.tree;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+import java.util.stream.Stream;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.artemis.util.backing.Utils;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode.Commit;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode.Root;\n+import tech.pegasys.artemis.util.backing.tree.TreeNodeImpl.CommitImpl;\n+import tech.pegasys.artemis.util.backing.tree.TreeNodeImpl.RootImpl;\n+\n+/** Misc Backing binary tree utils */\n+public class TreeUtil {\n+\n+  private static final TreeNode ZERO_LEAF = new RootImpl(Bytes32.ZERO);\n+  private static final TreeNode[] ZERO_TREES;\n+\n+  static {\n+    ZERO_TREES = new TreeNode[64];\n+    ZERO_TREES[0] = ZERO_LEAF;\n+    for (int i = 1; i < ZERO_TREES.length; i++) {\n+      ZERO_TREES[i] = new CommitImpl(ZERO_TREES[i - 1], ZERO_TREES[i - 1]);\n+      ZERO_TREES[i].hashTreeRoot(); // pre-cache\n+    }\n+  }\n+\n+  /**\n+   * Creates a binary tree with `nextPowerOf2(maxLength)` width and following leaf nodes <code>\n+   * [zeroElement] * maxLength + [ZERO_LEAF] * (nextPowerOf2(maxLength) - maxLength)\n+   * </code>\n+   *\n+   * @param maxLength max number of leaf nodes\n+   * @param zeroElement default leaf element. For complex vectors it could be default vector element\n+   *     struct subtree\n+   */\n+  public static TreeNode createDefaultTree(int maxLength, TreeNode zeroElement) {\n+    List<TreeNode> nodes =\n+        Stream.concat(\n+                IntStream.range(0, maxLength).mapToObj(i -> zeroElement),\n+                IntStream.range(maxLength, (int) Utils.nextPowerOf2(maxLength))\n+                    .mapToObj(i -> ZERO_LEAF))\n+            .collect(Collectors.toList());\n+    while (nodes.size() > 1) {\n+      List<TreeNode> parentNodes = new ArrayList<>(nodes.size() / 2);\n+      for (int i = 0; i < nodes.size(); i += 2) {\n+        parentNodes.add(new CommitImpl(nodes.get(i), nodes.get(i + 1)));\n+      }\n+      nodes = parentNodes;\n+    }\n+    return nodes.get(0);\n+  }\n+\n+  /** Creates a binary tree with `nextPowerOf2(maxLength)` width and ZERO leaf nodes. */\n+  public static TreeNode createZeroTree(long maxLength) {\n+    return ZERO_TREES[treeDepth(maxLength)];\n+  }\n+\n+  /** Creates a binary tree of width `nextPowerOf2(leafNodes.size())` with specific leaf nodes */\n+  public static TreeNode createTree(List<TreeNode> leafNodes) {\n+    int treeWidth = (int) Utils.nextPowerOf2(leafNodes.size());", "originalCommit": "85ccb05f20ba7b587c53c4a2d5007b969a49613b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY5MTY5MA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385691690", "bodyText": "Just made this method the first way that came to my mind. Was trying to avoid premature optimization. But you've inspired me to refactor that part :)", "author": "Nashatyrev", "createdAt": "2020-02-28T13:22:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4OTQ2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5NDU0Mw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385294543", "bodyText": "If all nodes are the same, and immutable, a recursive implementation can construct a list/vector very elegantly, yet efficiently: v[0] = default node, v[1] = commit(v[0], v[0]), v[2] = commit(v[1], v[1]), v[2] = commit(v[1], v[1]), etc... Same as is done with zero-hashes, except that you only really need the last v as the anchor node of the subtree.", "author": "protolambda", "createdAt": "2020-02-27T18:33:52Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/type/ListViewType.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing.type;\n+\n+import tech.pegasys.artemis.util.backing.ListViewRead;\n+import tech.pegasys.artemis.util.backing.ViewRead;\n+import tech.pegasys.artemis.util.backing.ViewType;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode;\n+import tech.pegasys.artemis.util.backing.view.ListViewImpl;\n+\n+public class ListViewType<C extends ViewRead> extends CollectionViewType {\n+\n+  public ListViewType(VectorViewType<C> vectorType) {\n+    this(vectorType.getElementType(), vectorType.getMaxLength());\n+  }\n+\n+  public ListViewType(ViewType elementType, long maxLength) {\n+    super(maxLength, elementType);\n+  }\n+\n+  @Override\n+  public TreeNode createDefaultTree() {\n+    return createDefault().getBackingNode();", "originalCommit": "85ccb05f20ba7b587c53c4a2d5007b969a49613b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY5MjQyNQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385692425", "bodyText": "Default TreeNode is cached now", "author": "Nashatyrev", "createdAt": "2020-02-28T13:23:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5NDU0Mw=="}], "type": "inlineReview"}, {"oid": "cd2cd420499a8da15ed4e945496d5318861f9f62", "url": "https://github.com/ConsenSys/teku/commit/cd2cd420499a8da15ed4e945496d5318861f9f62", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-backing-tree-concept", "committedDate": "2020-02-28T07:35:08Z", "type": "commit"}, {"oid": "1f2cb38929c873467184f7c29ac06b5290f4dc07", "url": "https://github.com/ConsenSys/teku/commit/1f2cb38929c873467184f7c29ac06b5290f4dc07", "message": "Resolve merge conflicts", "committedDate": "2020-02-28T07:45:50Z", "type": "commit"}, {"oid": "854c19049859d27f81ac6c69f4529217445d8c63", "url": "https://github.com/ConsenSys/teku/commit/854c19049859d27f81ac6c69f4529217445d8c63", "message": "TreeNode.toString(), shorten just Bytes32.ZERO case", "committedDate": "2020-02-28T08:25:31Z", "type": "commit"}, {"oid": "db66f890e2875e508a1a40b8efaf60102c5d6cb5", "url": "https://github.com/ConsenSys/teku/commit/db66f890e2875e508a1a40b8efaf60102c5d6cb5", "message": "Rename createDefault() to getDefault(), cache default tree in types, refactor TreeUtil.createTree methods", "committedDate": "2020-02-28T13:18:04Z", "type": "commit"}, {"oid": "28df870dbea764038dc36738cb90bb2447fe9fe0", "url": "https://github.com/ConsenSys/teku/commit/28df870dbea764038dc36738cb90bb2447fe9fe0", "message": "Fix potential int overflow", "committedDate": "2020-02-28T13:21:55Z", "type": "commit"}, {"oid": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "url": "https://github.com/ConsenSys/teku/commit/d4fc41d2f455ad3019095470229fa3cd5922d9c6", "message": "Use const instead of creating new instance", "committedDate": "2020-02-28T14:25:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwMzIzNA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385903234", "bodyText": "(nit) Looks like most of the methods elsewhere use \"backing node\" over \"tree node\" nomenclature,  suggest using one naming style consistently:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              default ViewRead createFromTreeNode(TreeNode node, int internalIndex) {\n          \n          \n            \n              default ViewRead createFromBackingNode(TreeNode node, int internalIndex) {", "author": "mbaxter", "createdAt": "2020-02-28T20:17:52Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/ViewType.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing;\n+\n+import tech.pegasys.artemis.util.backing.tree.TreeNode;\n+\n+/**\n+ * Base class for any SSZ type like Vector, List, Container, basic types\n+ * (https://github.com/ethereum/eth2.0-specs/blob/dev/ssz/simple-serialize.md#typing)\n+ */\n+public interface ViewType {\n+\n+  /**\n+   * Creates a default backing binary tree for this type E.g. if the type is basic then normally\n+   * just a single leaf node is created E.g. if the type is a complex structure with multi-level\n+   * nested vectors and containers then the complete tree including all descendant members subtrees\n+   * is created\n+   */\n+  TreeNode getDefaultTree();\n+\n+  /**\n+   * Creates immutable View over the tree which should correspond to this type If the tree structure\n+   * doesn't correspond this type that fact could only be detected later during access to View\n+   * members\n+   */\n+  ViewRead createFromTreeNode(TreeNode node);\n+\n+  /** Creates a default immutable View */\n+  default ViewRead getDefault() {\n+    return createFromTreeNode(getDefaultTree());\n+  }\n+\n+  /**\n+   * Returns the number of bits the element of this type occupies in a tree node More correct\n+   * definition is: how many elements of this type one tree node may contain All complex types\n+   * occupies the whole tree node and their bitsize assumed to be 256 Normally the bitsize < 256 is\n+   * for basic types that can be packed into a single leaf node\n+   */\n+  default int getBitsSize() {\n+    return 256;\n+  }\n+\n+  /**\n+   * For packed basic values. Extracts a packed value from the tree node by its 'internal index'.\n+   * For example in `Bitvector(512)` the bit value at index `300` is stored at the second leaf node\n+   * and it's 'internal index' in this node would be `45`\n+   */\n+  default ViewRead createFromTreeNode(TreeNode node, int internalIndex) {", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk2MTYwMQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386961601", "bodyText": "Totally makes sense \ud83d\udc4d Thanks\ne7e4d18", "author": "Nashatyrev", "createdAt": "2020-03-03T11:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwMzIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyNjczNw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385926737", "bodyText": "Should this class be in the tech.pegasys.artemis.util.backing.type package?", "author": "mbaxter", "createdAt": "2020-02-28T21:18:52Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/ViewType.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing;\n+\n+import tech.pegasys.artemis.util.backing.tree.TreeNode;\n+\n+/**\n+ * Base class for any SSZ type like Vector, List, Container, basic types\n+ * (https://github.com/ethereum/eth2.0-specs/blob/dev/ssz/simple-serialize.md#typing)\n+ */\n+public interface ViewType {", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk2MjY2Nw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386962667", "bodyText": "Moved it a couple of times forth and back :) Let it be in type", "author": "Nashatyrev", "createdAt": "2020-03-03T11:36:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyNjczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk0ODA1Nw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385948057", "bodyText": "I think rather than adding jackson annotations to these core types, we'd be better off adding custom methods to JsonProvider that know how to serialize these various types.  We can log a follow-up ticket to clean this up though.", "author": "mbaxter", "createdAt": "2020-02-28T22:17:30Z", "path": "ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/operations/AttestationData.java", "diffHunk": "@@ -13,74 +13,103 @@\n \n package tech.pegasys.artemis.datastructures.operations;\n \n+import com.fasterxml.jackson.annotation.JsonAutoDetect;\n+import com.fasterxml.jackson.annotation.JsonAutoDetect.Visibility;\n import com.fasterxml.jackson.annotation.JsonIgnore;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n import com.google.common.primitives.UnsignedLong;\n import java.util.ArrayList;\n-import java.util.Arrays;\n import java.util.List;\n import java.util.Objects;\n import org.apache.tuweni.bytes.Bytes;\n import org.apache.tuweni.bytes.Bytes32;\n import org.apache.tuweni.ssz.SSZ;\n import tech.pegasys.artemis.datastructures.state.Checkpoint;\n import tech.pegasys.artemis.util.SSZTypes.SSZContainer;\n-import tech.pegasys.artemis.util.hashtree.HashTreeUtil;\n-import tech.pegasys.artemis.util.hashtree.HashTreeUtil.SSZTypes;\n+import tech.pegasys.artemis.util.backing.ContainerViewWrite;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode;\n+import tech.pegasys.artemis.util.backing.type.BasicViewTypes;\n+import tech.pegasys.artemis.util.backing.type.ContainerViewType;\n+import tech.pegasys.artemis.util.backing.view.BasicViews.Bytes32View;\n+import tech.pegasys.artemis.util.backing.view.BasicViews.UInt64View;\n+import tech.pegasys.artemis.util.backing.view.ContainerViewImpl;\n import tech.pegasys.artemis.util.hashtree.Merkleizable;\n import tech.pegasys.artemis.util.sos.SimpleOffsetSerializable;\n \n-public class AttestationData implements SimpleOffsetSerializable, Merkleizable, SSZContainer {\n+@JsonAutoDetect(getterVisibility = Visibility.NONE)", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk2NjcwMQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386966701", "bodyText": "Agree, I'm also not a big fan of burdening core classes with serialization details.\nHowever this may make sense when the structure is changing from time to time and you need not forget to update your serializers in different places\nTicket for me: #1267", "author": "Nashatyrev", "createdAt": "2020-03-03T11:45:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk0ODA1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk1NTA0MQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r385955041", "bodyText": "These classes look immutable, but mutations are still possible via the ancestor view write methods (ViewWrite.clear(), CompositeViewWrite.update(), etc).  Should we do something like have an immutable Eth1Data interface + Eth1DataImpl ?", "author": "mbaxter", "createdAt": "2020-02-28T22:39:11Z", "path": "ethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/blocks/Eth1Data.java", "diffHunk": "@@ -114,49 +134,33 @@ public boolean equals(Object obj) {\n   }\n \n   /** @return the deposit_root */\n+  @JsonProperty\n   public Bytes32 getDeposit_root() {\n-    return deposit_root;\n-  }\n-\n-  /** @param deposit_root the deposit_root to set */\n-  public void setDeposit_root(Bytes32 deposit_root) {\n-    this.deposit_root = deposit_root;\n+    return ((Bytes32View) get(0)).get();\n   }\n \n+  @JsonProperty\n   public UnsignedLong getDeposit_count() {\n-    return deposit_count;\n-  }\n-\n-  public void setDeposit_count(UnsignedLong deposit_count) {", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAwNDMxNg==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387004316", "bodyText": "Oh yeah, that was lost in my todo list. I'm not sure if it worth spreading interfaces for such small immutable structs.\nI think it is better to create a base container class for those immutable structs: b69db95", "author": "Nashatyrev", "createdAt": "2020-03-03T13:03:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk1NTA0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEzMjcwNA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386132704", "bodyText": "Stray comment here:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public interface CompositeViewWriteRef<R extends ViewRead, W extends R /* & ViewWrite */>\n          \n          \n            \n            public interface CompositeViewWriteRef<R extends ViewRead, W extends R>", "author": "mbaxter", "createdAt": "2020-03-01T19:14:40Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/CompositeViewWriteRef.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing;\n+\n+/**\n+ * Represents a mutable composite view which is able to return a mutable child 'by reference' Any\n+ * modifications made to such child are reflected in this structure and its backing tree\n+ */\n+public interface CompositeViewWriteRef<R extends ViewRead, W extends R /* & ViewWrite */>", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3ODQyNQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386978425", "bodyText": "Removed", "author": "Nashatyrev", "createdAt": "2020-03-03T12:11:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEzMjcwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEzMzk2MQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386133961", "bodyText": "In general, I'd avoid setting defaults that only apply to some subtypes.\nSuggest moving this default implementation to CompositeViewType:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              default int getBitsSize() {\n          \n          \n            \n              int getBitsSize();", "author": "mbaxter", "createdAt": "2020-03-01T19:32:53Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/ViewType.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing;\n+\n+import tech.pegasys.artemis.util.backing.tree.TreeNode;\n+\n+/**\n+ * Base class for any SSZ type like Vector, List, Container, basic types\n+ * (https://github.com/ethereum/eth2.0-specs/blob/dev/ssz/simple-serialize.md#typing)\n+ */\n+public interface ViewType {\n+\n+  /**\n+   * Creates a default backing binary tree for this type E.g. if the type is basic then normally\n+   * just a single leaf node is created E.g. if the type is a complex structure with multi-level\n+   * nested vectors and containers then the complete tree including all descendant members subtrees\n+   * is created\n+   */\n+  TreeNode getDefaultTree();\n+\n+  /**\n+   * Creates immutable View over the tree which should correspond to this type If the tree structure\n+   * doesn't correspond this type that fact could only be detected later during access to View\n+   * members\n+   */\n+  ViewRead createFromTreeNode(TreeNode node);\n+\n+  /** Creates a default immutable View */\n+  default ViewRead getDefault() {\n+    return createFromTreeNode(getDefaultTree());\n+  }\n+\n+  /**\n+   * Returns the number of bits the element of this type occupies in a tree node More correct\n+   * definition is: how many elements of this type one tree node may contain All complex types\n+   * occupies the whole tree node and their bitsize assumed to be 256 Normally the bitsize < 256 is\n+   * for basic types that can be packed into a single leaf node\n+   */\n+  default int getBitsSize() {", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk4MTcyNQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386981725", "bodyText": "Yep, very good general rule \ud83d\udc4d\nChanged.", "author": "Nashatyrev", "createdAt": "2020-03-03T12:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEzMzk2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE1MTc0MA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386151740", "bodyText": "(nit) If you think its useful to keep these logs, I'd log them via Logger.trace()", "author": "mbaxter", "createdAt": "2020-03-01T23:26:13Z", "path": "util/src/test/java/tech/pegasys/artemis/util/backing/BasicListViewTest.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode;\n+import tech.pegasys.artemis.util.backing.type.BasicViewTypes;\n+import tech.pegasys.artemis.util.backing.type.ListViewType;\n+import tech.pegasys.artemis.util.backing.view.BasicViews.UInt64View;\n+\n+public class BasicListViewTest {\n+\n+  @Test\n+  public void simpleUInt64ListTest() {\n+    ListViewType<UInt64View> listType = new ListViewType<>(BasicViewTypes.UINT64_TYPE, 7);\n+    ListViewWrite<UInt64View> listView = listType.getDefault().createWritableCopy();\n+    TreeNode n0 = listView.getBackingNode();\n+    listView.append(new UInt64View(UnsignedLong.valueOf(0x111)));\n+    TreeNode n1 = listView.getBackingNode();\n+    listView.append(new UInt64View(UnsignedLong.valueOf(0x222)));\n+    listView.append(new UInt64View(UnsignedLong.valueOf(0x333)));\n+    listView.append(new UInt64View(UnsignedLong.valueOf(0x444)));\n+    TreeNode n2 = listView.getBackingNode();\n+    listView.append(new UInt64View(UnsignedLong.valueOf(0x555)));\n+    TreeNode n3 = listView.getBackingNode();\n+    listView.append(new UInt64View(UnsignedLong.valueOf(0x666)));\n+    listView.append(new UInt64View(UnsignedLong.valueOf(0x777)));\n+    TreeNode n4 = listView.getBackingNode();\n+    listView.set(0, new UInt64View(UnsignedLong.valueOf(0x800)));\n+    TreeNode n5 = listView.getBackingNode();\n+    listView.set(1, new UInt64View(UnsignedLong.valueOf(0x801)));\n+    listView.set(2, new UInt64View(UnsignedLong.valueOf(0x802)));\n+    listView.set(3, new UInt64View(UnsignedLong.valueOf(0x803)));\n+    listView.set(4, new UInt64View(UnsignedLong.valueOf(0x804)));\n+    TreeNode n6 = listView.getBackingNode();\n+    System.out.println(n0);\n+    System.out.println(n1);\n+    System.out.println(n2);\n+    System.out.println(n3);\n+    System.out.println(n4);\n+    System.out.println(n5);\n+    System.out.println(n6);", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAxNTcwNg==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387015706", "bodyText": "Removed", "author": "Nashatyrev", "createdAt": "2020-03-03T13:25:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE1MTc0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE1NDk1Nw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386154957", "bodyText": "(optional) I've seen naming conventions where this would be modified() because it returns a new object that is modified, vs a method modify() that would mutate the current instance.", "author": "mbaxter", "createdAt": "2020-03-02T00:03:20Z", "path": "util/src/main/java/tech/pegasys/artemis/util/SSZTypes/SSZList.java", "diffHunk": "@@ -13,48 +13,77 @@\n \n package tech.pegasys.artemis.util.SSZTypes;\n \n-import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n-import java.util.ArrayList;\n-import java.util.List;\n+import com.google.common.base.Preconditions;\n+import java.lang.reflect.Array;\n+import java.util.Collection;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n \n-@JsonSerialize(as = ArrayList.class)\n-public class SSZList<T> extends ArrayList<T> {\n+public interface SSZList<T> extends SSZImmutableCollection<T> {\n \n-  private long maxSize;\n-  private Class<T> classInfo;\n+  static <T> SSZMutableList<T> create(Class<? extends T> classInfo, long maxSize) {\n+    return new SSZArrayCollection<>(classInfo, maxSize, false);\n+  }\n+\n+  static <T> SSZMutableList<T> create(Stream<T> list, long maxSize, Class<? extends T> classInfo) {\n+    return new SSZArrayCollection<>(list.collect(Collectors.toList()), maxSize, classInfo, false);\n+  }\n \n-  public SSZList(Class<T> classInfo, long maxSize) {\n-    super();\n-    this.classInfo = classInfo;\n-    this.maxSize = maxSize;\n+  static <T> SSZMutableList<T> create(\n+      Collection<T> list, long maxSize, Class<? extends T> classInfo) {\n+    return create(list.stream(), maxSize, classInfo);\n   }\n \n-  public SSZList(SSZList<T> list) {\n-    super(list);\n-    maxSize = list.getMaxSize();\n-    this.classInfo = list.getElementType();\n+  static <T> SSZMutableList<T> create(SSZImmutableCollection<? extends T> list) {\n+    return new SSZArrayCollection<>(list.asList(), list.getMaxSize(), list.getElementType(), false);\n   }\n \n-  public SSZList(List<T> list, long maxSize, Class<T> classInfo) {\n-    super(list);\n-    this.maxSize = maxSize;\n-    this.classInfo = classInfo;\n+  static <T> SSZMutableList<T> concat(\n+      SSZImmutableCollection<? extends T> left, SSZImmutableCollection<? extends T> right) {\n+    Preconditions.checkArgument(\n+        left.getElementType().equals(right.getElementType()),\n+        \"Incompatible list types: %s != %s\",\n+        left.getElementType(),\n+        right.getElementType());\n+    SSZMutableList<T> ret = create(left.getElementType(), left.getMaxSize() + right.getMaxSize());\n+    ret.addAll(left);\n+    ret.addAll(right);\n+    return ret;\n   }\n \n-  @Override\n-  public boolean add(T object) {\n-    if (super.size() < maxSize) {\n-      return super.add(object);\n-    } else {\n-      return false;\n+  static <T> SSZList<T> singleton(T obj) {\n+    return new SSZArrayCollection<>(1, obj, false);\n+  }\n+\n+  default SSZList<T> reverse() {\n+    SSZMutableList<T> ret = create(getElementType(), getMaxSize());\n+    for (int i = size() - 1; i >= 0; i--) {\n+      ret.add(get(i));\n     }\n+    return ret;\n+  }\n+\n+  default SSZList<T> modify(Function<Stream<T>, Stream<T>> streamer) {", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAzNjA1Ng==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387036056", "bodyText": "Yes, exactly! I was also feeling some discomfort with modify name for immutable class. Renamed reverse -> reversed as well: 5a08d51\nAlso there is a couple of methods with the same semantics TreeNode.update() and TreeNode.set():\nhttps://github.com/PegaSysEng/teku/blob/546616c5e906bf249707cc7c3ec83a5a40026fbc/util/src/main/java/tech/pegasys/artemis/util/backing/tree/TreeNode.java#L143-L157\nMay be you have ideas on how to name them? Especially set sounds confusing for me", "author": "Nashatyrev", "createdAt": "2020-03-03T13:59:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE1NDk1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA0MjU1NA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387042554", "bodyText": "Maybe change both set and update to updated()?", "author": "mbaxter", "createdAt": "2020-03-03T14:09:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE1NDk1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE2Nzc2MQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387167761", "bodyText": "Sounds good \ud83d\udc4d", "author": "Nashatyrev", "createdAt": "2020-03-03T17:10:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE1NDk1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE1NjM3NQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386156375", "bodyText": "Might be clearer if we add a utility for calculating the generalized index:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                backingNode = backingNode.set(type.treeWidth() + index, child.getBackingNode());\n          \n          \n            \n                backingNode = backingNode.set(type.getGeneralizedIndex(index), child.getBackingNode());", "author": "mbaxter", "createdAt": "2020-03-02T00:20:20Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/view/ContainerViewImpl.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing.view;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n+import tech.pegasys.artemis.util.backing.CompositeViewWrite;\n+import tech.pegasys.artemis.util.backing.ContainerViewWrite;\n+import tech.pegasys.artemis.util.backing.ContainerViewWriteRef;\n+import tech.pegasys.artemis.util.backing.ViewRead;\n+import tech.pegasys.artemis.util.backing.ViewWrite;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode;\n+import tech.pegasys.artemis.util.backing.type.ContainerViewType;\n+\n+public class ContainerViewImpl<C extends ContainerViewImpl<C>>\n+    extends AbstractCompositeViewWrite<C, ViewRead> implements ContainerViewWriteRef {\n+\n+  private final ContainerViewType<? extends ContainerViewWrite> type;\n+  private TreeNode backingNode;\n+\n+  public ContainerViewImpl(ContainerViewType<? extends ContainerViewWrite> type) {\n+    this(type, type.getDefaultTree());\n+  }\n+\n+  public ContainerViewImpl(\n+      ContainerViewType<? extends ContainerViewWrite> type, TreeNode backingNode) {\n+    this.type = type;\n+    this.backingNode = backingNode;\n+  }\n+\n+  public ContainerViewImpl(\n+      ContainerViewType<? extends ContainerViewWrite> type, ViewRead... memberValues) {\n+    this(type, type.getDefaultTree());\n+    checkArgument(\n+        memberValues.length == getType().getMaxLength(),\n+        \"Wrong number of member values: %s\",\n+        memberValues.length);\n+    for (int i = 0; i < memberValues.length; i++) {\n+      set(i, memberValues[i]);\n+    }\n+  }\n+\n+  @Override\n+  public ContainerViewType<? extends ContainerViewWrite> getType() {\n+    return type;\n+  }\n+\n+  @Override\n+  public TreeNode getBackingNode() {\n+    return backingNode;\n+  }\n+\n+  @Override\n+  public ViewRead get(int index) {\n+    checkIndex(index);\n+    TreeNode node = backingNode.get(type.treeWidth() + index);\n+    return type.getChildType(index).createFromTreeNode(node);\n+  }\n+\n+  @Override\n+  public ViewWrite getByRef(int index) {\n+    ViewWrite writableCopy = get(index).createWritableCopy();\n+    if (writableCopy instanceof CompositeViewWrite) {\n+      ((CompositeViewWrite<?>) writableCopy).setInvalidator(viewWrite -> set(index, viewWrite));\n+    }\n+    return writableCopy;\n+  }\n+\n+  @Override\n+  public void set(int index, ViewRead child) {\n+    checkIndex(index);\n+    checkArgument(\n+        child.getType().equals(type.getChildType(index)),\n+        \"Wrong child type at index %s. Expected: %s, was %s\",\n+        index,\n+        type.getChildType(index),\n+        child.getType());\n+    backingNode = backingNode.set(type.treeWidth() + index, child.getBackingNode());", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA0Mzk2Ng==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387043966", "bodyText": "Your way is much cleaner \ud83d\udc4d\na3a5138", "author": "Nashatyrev", "createdAt": "2020-03-03T14:12:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE1NjM3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE1Nzg5Ng==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386157896", "bodyText": "Would be nice to try to add more descriptive type parameters.  For example:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class SSZBackingVector<C, R extends ViewRead> extends SSZAbstractCollection<C>\n          \n          \n            \n            public class SSZBackingVector<TValue, TView extends ViewRead> extends SSZAbstractCollection<TValue>", "author": "mbaxter", "createdAt": "2020-03-02T00:35:05Z", "path": "util/src/main/java/tech/pegasys/artemis/util/SSZTypes/SSZBackingVector.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.SSZTypes;\n+\n+import java.util.function.Function;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.artemis.util.backing.VectorViewWrite;\n+import tech.pegasys.artemis.util.backing.ViewRead;\n+\n+public class SSZBackingVector<C, R extends ViewRead> extends SSZAbstractCollection<C>", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA2MDYxNA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387060614", "bodyText": "Agree. But let me consider this for subsequent refactor since these classes are most likely to be removed ?", "author": "Nashatyrev", "createdAt": "2020-03-03T14:36:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE1Nzg5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ3NTQ3Ng==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386475476", "bodyText": "Should we enforce the constraint that bitSize should evenly divide 256?", "author": "mbaxter", "createdAt": "2020-03-02T15:49:23Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/type/BasicViewType.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing.type;\n+\n+import tech.pegasys.artemis.util.backing.ViewRead;\n+import tech.pegasys.artemis.util.backing.ViewType;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode;\n+import tech.pegasys.artemis.util.backing.tree.TreeUtil;\n+\n+/**\n+ * Represents primitive view type\n+ *\n+ * @param <C> Class of the basic view of this type\n+ */\n+public abstract class BasicViewType<C extends ViewRead> implements ViewType {\n+\n+  private final int bitsSize;\n+\n+  BasicViewType(int bitsSize) {\n+    this.bitsSize = bitsSize;", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA2NDI2MQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387064261", "bodyText": "\ud83d\udc4d", "author": "Nashatyrev", "createdAt": "2020-03-03T14:42:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ3NTQ3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ5ODY2OQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386498669", "bodyText": "(nit) Would be nice if this returned a String instead of printing directly", "author": "mbaxter", "createdAt": "2020-03-02T16:23:44Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/tree/TreeUtil.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing.tree;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n+import java.util.List;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.artemis.util.backing.Utils;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode.Commit;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode.Root;\n+import tech.pegasys.artemis.util.backing.tree.TreeNodeImpl.CommitImpl;\n+import tech.pegasys.artemis.util.backing.tree.TreeNodeImpl.RootImpl;\n+\n+/** Misc Backing binary tree utils */\n+public class TreeUtil {\n+\n+  public static final TreeNode ZERO_LEAF = new RootImpl(Bytes32.ZERO);\n+  private static final TreeNode[] ZERO_TREES;\n+\n+  static {\n+    ZERO_TREES = new TreeNode[64];\n+    ZERO_TREES[0] = ZERO_LEAF;\n+    for (int i = 1; i < ZERO_TREES.length; i++) {\n+      ZERO_TREES[i] = new CommitImpl(ZERO_TREES[i - 1], ZERO_TREES[i - 1]);\n+      ZERO_TREES[i].hashTreeRoot(); // pre-cache\n+    }\n+  }\n+\n+  /**\n+   * Creates a binary tree with `nextPowerOf2(maxLength)` width and following leaf nodes <code>\n+   * [zeroElement] * maxLength + [ZERO_LEAF] * (nextPowerOf2(maxLength) - maxLength)\n+   * </code>\n+   *\n+   * @param maxLength max number of leaf nodes\n+   * @param defaultNode default leaf element. For complex vectors it could be default vector element\n+   *     struct subtree\n+   */\n+  public static TreeNode createDefaultTree(long maxLength, TreeNode defaultNode) {\n+    return createTree(\n+        defaultNode, ZERO_LEAF.equals(defaultNode) ? 0 : maxLength, treeDepth(maxLength));\n+  }\n+\n+  /** Creates a binary tree of width `nextPowerOf2(leafNodes.size())` with specific leaf nodes */\n+  public static TreeNode createTree(List<TreeNode> leafNodes) {\n+    return createTree(leafNodes, treeDepth(leafNodes.size()));\n+  }\n+\n+  private static TreeNode createTree(TreeNode defaultNode, long defaultNodesCount, int depth) {\n+    if (defaultNodesCount == 0) {\n+      return ZERO_TREES[depth];\n+    } else if (depth == 0) {\n+      checkArgument(defaultNodesCount == 1);\n+      return defaultNode;\n+    } else {\n+      long leftNodesCount = Math.min(defaultNodesCount, 1 << (depth - 1));\n+      long rightNodesCount = defaultNodesCount - leftNodesCount;\n+      TreeNode lTree = createTree(defaultNode, leftNodesCount, depth - 1);\n+      TreeNode rTree =\n+          leftNodesCount == rightNodesCount\n+              ? lTree\n+              : createTree(defaultNode, rightNodesCount, depth - 1);\n+      return new CommitImpl(lTree, rTree);\n+    }\n+  }\n+\n+  private static TreeNode createTree(List<TreeNode> leafNodes, int depth) {\n+    if (leafNodes.isEmpty()) {\n+      return ZERO_TREES[depth];\n+    } else if (depth == 0) {\n+      checkArgument(leafNodes.size() == 1);\n+      return leafNodes.get(0);\n+    } else {\n+      long index = 1L << (depth - 1);\n+      int iIndex = index > leafNodes.size() ? leafNodes.size() : (int) index;\n+\n+      List<TreeNode> leftSublist = leafNodes.subList(0, iIndex);\n+      List<TreeNode> rightSublist = leafNodes.subList(iIndex, leafNodes.size());\n+      return new CommitImpl(\n+          createTree(leftSublist, depth - 1), createTree(rightSublist, depth - 1));\n+    }\n+  }\n+\n+  public static int treeDepth(long maxChunks) {\n+    return Long.bitCount(Utils.nextPowerOf2(maxChunks) - 1);\n+  }\n+\n+  /** Estimates the number of 'non-default' tree nodes */\n+  public static int estimateNonDefaultNodes(TreeNode node) {\n+    if (node instanceof Root) {\n+      return 1;\n+    } else {\n+      Commit commitNode = (Commit) node;\n+      if (commitNode.left() == commitNode.right()) {\n+        return 0;\n+      } else {\n+        return estimateNonDefaultNodes(commitNode.left())\n+            + estimateNonDefaultNodes(commitNode.right())\n+            + 1;\n+      }\n+    }\n+  }\n+\n+  /** Dumps the tree to stdout */\n+  public static void dumpBinaryTree(TreeNode node) {", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzAxNjQ0OA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387016448", "bodyText": "\ud83d\udc4d", "author": "Nashatyrev", "createdAt": "2020-03-03T13:26:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ5ODY2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUwMjYwNg==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386502606", "bodyText": "These tests don't have any assertions - should we either add some assertions or cut these tests?", "author": "mbaxter", "createdAt": "2020-03-02T16:29:45Z", "path": "util/src/test/java/tech/pegasys/artemis/util/backing/ContainerViewTest.java", "diffHunk": "@@ -0,0 +1,365 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.List;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode;\n+import tech.pegasys.artemis.util.backing.tree.TreeUtil;\n+import tech.pegasys.artemis.util.backing.type.BasicViewTypes;\n+import tech.pegasys.artemis.util.backing.type.ContainerViewType;\n+import tech.pegasys.artemis.util.backing.type.ListViewType;\n+import tech.pegasys.artemis.util.backing.type.VectorViewType;\n+import tech.pegasys.artemis.util.backing.view.BasicViews.Bytes32View;\n+import tech.pegasys.artemis.util.backing.view.BasicViews.UInt64View;\n+import tech.pegasys.artemis.util.backing.view.ContainerViewImpl;\n+\n+public class ContainerViewTest {\n+\n+  public interface ImmutableSubContainer extends ContainerViewRead {\n+\n+    UnsignedLong getLong1();\n+\n+    Bytes32 getBytes1();\n+  }\n+\n+  public interface SubContainerRead extends ContainerViewRead {\n+\n+    UnsignedLong getLong1();\n+\n+    UnsignedLong getLong2();\n+  }\n+\n+  public interface SubContainerWrite extends SubContainerRead, ContainerViewWrite {\n+\n+    void setLong1(UnsignedLong val);\n+\n+    void setLong2(UnsignedLong val);\n+  }\n+\n+  public interface ContainerRead extends ContainerViewRead {\n+\n+    UnsignedLong getLong1();\n+\n+    UnsignedLong getLong2();\n+\n+    SubContainerRead getSub1();\n+\n+    ListViewRead<UInt64View> getList1();\n+\n+    ListViewRead<SubContainerRead> getList2();\n+\n+    VectorViewRead<ImmutableSubContainer> getList3();\n+\n+    @Override\n+    ContainerWrite createWritableCopy();\n+  }\n+\n+  public interface ContainerWrite extends ContainerRead, ContainerViewWriteRef {\n+\n+    void setLong1(UnsignedLong val);\n+\n+    void setLong2(UnsignedLong val);\n+\n+    @Override\n+    SubContainerWrite getSub1();\n+\n+    @Override\n+    ListViewWrite<UInt64View> getList1();\n+\n+    @Override\n+    ListViewWriteRef<SubContainerRead, SubContainerWrite> getList2();\n+\n+    @Override\n+    VectorViewWrite<ImmutableSubContainer> getList3();\n+\n+    @Override\n+    ContainerRead commitChanges();\n+  }\n+\n+  public static class ImmutableSubContainerImpl extends ContainerViewImpl<ImmutableSubContainerImpl>\n+      implements ImmutableSubContainer {\n+\n+    public static final ContainerViewType<ImmutableSubContainerImpl> TYPE =\n+        new ContainerViewType<>(\n+            List.of(BasicViewTypes.UINT64_TYPE, BasicViewTypes.BYTES32_TYPE),\n+            ImmutableSubContainerImpl::new);\n+\n+    private ImmutableSubContainerImpl(\n+        ContainerViewType<ImmutableSubContainerImpl> type, TreeNode backingNode) {\n+      super(type, backingNode);\n+    }\n+\n+    public ImmutableSubContainerImpl(UnsignedLong long1, Bytes32 bytes1) {\n+      super(TYPE, new UInt64View(long1), new Bytes32View(bytes1));\n+    }\n+\n+    @Override\n+    public UnsignedLong getLong1() {\n+      return ((UInt64View) get(0)).get();\n+    }\n+\n+    @Override\n+    public Bytes32 getBytes1() {\n+      return ((Bytes32View) get(1)).get();\n+    }\n+  }\n+\n+  public static class SubContainerImpl extends ContainerViewImpl<SubContainerImpl>\n+      implements SubContainerWrite {\n+\n+    public static final ContainerViewType<SubContainerImpl> TYPE =\n+        new ContainerViewType<>(\n+            List.of(BasicViewTypes.UINT64_TYPE, BasicViewTypes.UINT64_TYPE), SubContainerImpl::new);\n+\n+    private SubContainerImpl(ContainerViewType<SubContainerImpl> type, TreeNode backingNode) {\n+      super(type, backingNode);\n+    }\n+\n+    @Override\n+    public UnsignedLong getLong1() {\n+      return ((UInt64View) get(0)).get();\n+    }\n+\n+    @Override\n+    public UnsignedLong getLong2() {\n+      return ((UInt64View) get(1)).get();\n+    }\n+\n+    @Override\n+    public void setLong1(UnsignedLong val) {\n+      set(0, new UInt64View(val));\n+    }\n+\n+    @Override\n+    public void setLong2(UnsignedLong val) {\n+      set(1, new UInt64View(val));\n+    }\n+  }\n+\n+  public static class ContainerImpl extends ContainerViewImpl<ContainerImpl>\n+      implements ContainerWrite {\n+\n+    public static final ContainerViewType<ContainerImpl> TYPE =\n+        new ContainerViewType<>(\n+            List.of(\n+                BasicViewTypes.UINT64_TYPE,\n+                BasicViewTypes.UINT64_TYPE,\n+                SubContainerImpl.TYPE,\n+                new ListViewType<>(BasicViewTypes.UINT64_TYPE, 10),\n+                new ListViewType<>(SubContainerImpl.TYPE, 2),\n+                new VectorViewType<>(ImmutableSubContainerImpl.TYPE, 2)),\n+            ContainerImpl::new);\n+\n+    public ContainerImpl(ContainerViewType<ContainerImpl> type, TreeNode backingNode) {\n+      super(type, backingNode);\n+    }\n+\n+    public static ContainerRead createDefault() {\n+      return TYPE.getDefault();\n+    }\n+\n+    @Override\n+    public UnsignedLong getLong1() {\n+      return ((UInt64View) get(0)).get();\n+    }\n+\n+    @Override\n+    public UnsignedLong getLong2() {\n+      return ((UInt64View) get(1)).get();\n+    }\n+\n+    @Override\n+    public SubContainerImpl getSub1() {\n+      return (SubContainerImpl) getByRef(2);\n+    }\n+\n+    @Override\n+    @SuppressWarnings(\"unchecked\")\n+    public ListViewWrite<UInt64View> getList1() {\n+      return (ListViewWrite<UInt64View>) getByRef(3);\n+    }\n+\n+    @Override\n+    @SuppressWarnings(\"unchecked\")\n+    public ListViewWriteRef<SubContainerRead, SubContainerWrite> getList2() {\n+      return (ListViewWriteRef<SubContainerRead, SubContainerWrite>) getByRef(4);\n+    }\n+\n+    @Override\n+    @SuppressWarnings(\"unchecked\")\n+    public VectorViewWrite<ImmutableSubContainer> getList3() {\n+      return (VectorViewWrite<ImmutableSubContainer>) getByRef(5);\n+    }\n+\n+    @Override\n+    public void setLong1(UnsignedLong val) {\n+      set(0, new UInt64View(val));\n+    }\n+\n+    @Override\n+    public void setLong2(UnsignedLong val) {\n+      set(1, new UInt64View(val));\n+    }\n+  }\n+\n+  @Test\n+  public void readWriteContainerTest1() {\n+    ContainerRead c1 = ContainerImpl.createDefault();\n+\n+    {\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getSub1().getLong1());\n+      Assertions.assertTrue(c1.getList1().isEmpty());\n+      Assertions.assertTrue(c1.getList2().isEmpty());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getList3().get(0).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1.getList3().get(0).getBytes1());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getList3().get(1).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1.getList3().get(1).getBytes1());\n+      Assertions.assertThrows(\n+          IndexOutOfBoundsException.class,\n+          () -> {\n+            c1.getList3().get(2);\n+          });\n+    }\n+\n+    ContainerWrite c1w = c1.createWritableCopy();\n+    c1w.setLong1(UnsignedLong.valueOf(0x1));\n+    c1w.setLong2(UnsignedLong.valueOf(0x2));\n+\n+    c1w.getSub1().setLong1(UnsignedLong.valueOf(0x111));\n+    c1w.getSub1().setLong2(UnsignedLong.valueOf(0x222));\n+\n+    c1w.getList1().append(UInt64View.fromLong(0x333));\n+    c1w.getList1().append(UInt64View.fromLong(0x444));\n+\n+    c1w.getList2()\n+        .append(\n+            sc -> {\n+              sc.setLong1(UnsignedLong.valueOf(0x555));\n+              sc.setLong2(UnsignedLong.valueOf(0x666));\n+            });\n+    SubContainerWrite sc1w = c1w.getList2().append();\n+    sc1w.setLong1(UnsignedLong.valueOf(0x777));\n+    sc1w.setLong2(UnsignedLong.valueOf(0x888));\n+\n+    c1w.getList3()\n+        .set(\n+            1,\n+            new ImmutableSubContainerImpl(\n+                UnsignedLong.valueOf(0x999), Bytes32.leftPad(Bytes.fromHexString(\"0xa999\"))));\n+\n+    {\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getSub1().getLong1());\n+      Assertions.assertTrue(c1.getList1().isEmpty());\n+      Assertions.assertTrue(c1.getList2().isEmpty());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getList3().get(0).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1.getList3().get(0).getBytes1());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getList3().get(1).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1.getList3().get(1).getBytes1());\n+\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x1), c1w.getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x2), c1w.getLong2());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x111), c1w.getSub1().getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x222), c1w.getSub1().getLong2());\n+      Assertions.assertEquals(2, c1w.getList1().size());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x333), c1w.getList1().get(0).get());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x444), c1w.getList1().get(1).get());\n+      Assertions.assertThrows(\n+          IndexOutOfBoundsException.class,\n+          () -> {\n+            c1w.getList1().get(2);\n+          });\n+      Assertions.assertEquals(2, c1w.getList2().size());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x555), c1w.getList2().get(0).getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x666), c1w.getList2().get(0).getLong2());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x777), c1w.getList2().get(1).getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x888), c1w.getList2().get(1).getLong2());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1w.getList3().get(0).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1w.getList3().get(0).getBytes1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x999), c1w.getList3().get(1).getLong1());\n+      Assertions.assertEquals(\n+          Bytes32.leftPad(Bytes.fromHexString(\"0xa999\")), c1w.getList3().get(1).getBytes1());\n+    }\n+\n+    ContainerRead c1r = c1w.commitChanges();\n+    TreeUtil.dumpBinaryTree(c1r.getBackingNode());\n+\n+    {\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getSub1().getLong1());\n+      Assertions.assertTrue(c1.getList1().isEmpty());\n+      Assertions.assertTrue(c1.getList2().isEmpty());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getList3().get(0).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1.getList3().get(0).getBytes1());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getList3().get(1).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1.getList3().get(1).getBytes1());\n+\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x1), c1r.getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x2), c1r.getLong2());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x111), c1r.getSub1().getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x222), c1r.getSub1().getLong2());\n+      Assertions.assertEquals(2, c1r.getList1().size());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x333), c1r.getList1().get(0).get());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x444), c1r.getList1().get(1).get());\n+      Assertions.assertThrows(\n+          IndexOutOfBoundsException.class,\n+          () -> {\n+            c1r.getList1().get(2);\n+          });\n+      Assertions.assertEquals(2, c1r.getList2().size());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x555), c1r.getList2().get(0).getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x666), c1r.getList2().get(0).getLong2());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x777), c1r.getList2().get(1).getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x888), c1r.getList2().get(1).getLong2());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1r.getList3().get(0).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1r.getList3().get(0).getBytes1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x999), c1r.getList3().get(1).getLong1());\n+      Assertions.assertEquals(\n+          Bytes32.leftPad(Bytes.fromHexString(\"0xa999\")), c1r.getList3().get(1).getBytes1());\n+    }\n+\n+    ContainerWrite c2w = c1r.createWritableCopy();\n+    c2w.getList2().getByRef(1).setLong2(UnsignedLong.valueOf(0xaaa));\n+    ContainerRead c2r = c2w.commitChanges();\n+\n+    Assertions.assertEquals(UnsignedLong.valueOf(0x888), c1r.getList2().get(1).getLong2());\n+    Assertions.assertEquals(UnsignedLong.valueOf(0xaaa), c2r.getList2().get(1).getLong2());\n+  }\n+\n+  @Test\n+  public void readWriteContainerTest2() {", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA0Njk2OQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387046969", "bodyText": "Removed", "author": "Nashatyrev", "createdAt": "2020-03-03T14:16:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUwMjYwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUwMzczMw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386503733", "bodyText": "As a general standard, we usually use assertJ for test assertions:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Assertions.assertEquals(UnsignedLong.valueOf(0xaaa), c2r.getList2().get(1).getLong2());\n          \n          \n            \n                assertThat(c2r.getList2().get(1).getLong2()).isEqualTo(UnsignedLong.valueOf(0xaaa));", "author": "mbaxter", "createdAt": "2020-03-02T16:31:30Z", "path": "util/src/test/java/tech/pegasys/artemis/util/backing/ContainerViewTest.java", "diffHunk": "@@ -0,0 +1,365 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.List;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode;\n+import tech.pegasys.artemis.util.backing.tree.TreeUtil;\n+import tech.pegasys.artemis.util.backing.type.BasicViewTypes;\n+import tech.pegasys.artemis.util.backing.type.ContainerViewType;\n+import tech.pegasys.artemis.util.backing.type.ListViewType;\n+import tech.pegasys.artemis.util.backing.type.VectorViewType;\n+import tech.pegasys.artemis.util.backing.view.BasicViews.Bytes32View;\n+import tech.pegasys.artemis.util.backing.view.BasicViews.UInt64View;\n+import tech.pegasys.artemis.util.backing.view.ContainerViewImpl;\n+\n+public class ContainerViewTest {\n+\n+  public interface ImmutableSubContainer extends ContainerViewRead {\n+\n+    UnsignedLong getLong1();\n+\n+    Bytes32 getBytes1();\n+  }\n+\n+  public interface SubContainerRead extends ContainerViewRead {\n+\n+    UnsignedLong getLong1();\n+\n+    UnsignedLong getLong2();\n+  }\n+\n+  public interface SubContainerWrite extends SubContainerRead, ContainerViewWrite {\n+\n+    void setLong1(UnsignedLong val);\n+\n+    void setLong2(UnsignedLong val);\n+  }\n+\n+  public interface ContainerRead extends ContainerViewRead {\n+\n+    UnsignedLong getLong1();\n+\n+    UnsignedLong getLong2();\n+\n+    SubContainerRead getSub1();\n+\n+    ListViewRead<UInt64View> getList1();\n+\n+    ListViewRead<SubContainerRead> getList2();\n+\n+    VectorViewRead<ImmutableSubContainer> getList3();\n+\n+    @Override\n+    ContainerWrite createWritableCopy();\n+  }\n+\n+  public interface ContainerWrite extends ContainerRead, ContainerViewWriteRef {\n+\n+    void setLong1(UnsignedLong val);\n+\n+    void setLong2(UnsignedLong val);\n+\n+    @Override\n+    SubContainerWrite getSub1();\n+\n+    @Override\n+    ListViewWrite<UInt64View> getList1();\n+\n+    @Override\n+    ListViewWriteRef<SubContainerRead, SubContainerWrite> getList2();\n+\n+    @Override\n+    VectorViewWrite<ImmutableSubContainer> getList3();\n+\n+    @Override\n+    ContainerRead commitChanges();\n+  }\n+\n+  public static class ImmutableSubContainerImpl extends ContainerViewImpl<ImmutableSubContainerImpl>\n+      implements ImmutableSubContainer {\n+\n+    public static final ContainerViewType<ImmutableSubContainerImpl> TYPE =\n+        new ContainerViewType<>(\n+            List.of(BasicViewTypes.UINT64_TYPE, BasicViewTypes.BYTES32_TYPE),\n+            ImmutableSubContainerImpl::new);\n+\n+    private ImmutableSubContainerImpl(\n+        ContainerViewType<ImmutableSubContainerImpl> type, TreeNode backingNode) {\n+      super(type, backingNode);\n+    }\n+\n+    public ImmutableSubContainerImpl(UnsignedLong long1, Bytes32 bytes1) {\n+      super(TYPE, new UInt64View(long1), new Bytes32View(bytes1));\n+    }\n+\n+    @Override\n+    public UnsignedLong getLong1() {\n+      return ((UInt64View) get(0)).get();\n+    }\n+\n+    @Override\n+    public Bytes32 getBytes1() {\n+      return ((Bytes32View) get(1)).get();\n+    }\n+  }\n+\n+  public static class SubContainerImpl extends ContainerViewImpl<SubContainerImpl>\n+      implements SubContainerWrite {\n+\n+    public static final ContainerViewType<SubContainerImpl> TYPE =\n+        new ContainerViewType<>(\n+            List.of(BasicViewTypes.UINT64_TYPE, BasicViewTypes.UINT64_TYPE), SubContainerImpl::new);\n+\n+    private SubContainerImpl(ContainerViewType<SubContainerImpl> type, TreeNode backingNode) {\n+      super(type, backingNode);\n+    }\n+\n+    @Override\n+    public UnsignedLong getLong1() {\n+      return ((UInt64View) get(0)).get();\n+    }\n+\n+    @Override\n+    public UnsignedLong getLong2() {\n+      return ((UInt64View) get(1)).get();\n+    }\n+\n+    @Override\n+    public void setLong1(UnsignedLong val) {\n+      set(0, new UInt64View(val));\n+    }\n+\n+    @Override\n+    public void setLong2(UnsignedLong val) {\n+      set(1, new UInt64View(val));\n+    }\n+  }\n+\n+  public static class ContainerImpl extends ContainerViewImpl<ContainerImpl>\n+      implements ContainerWrite {\n+\n+    public static final ContainerViewType<ContainerImpl> TYPE =\n+        new ContainerViewType<>(\n+            List.of(\n+                BasicViewTypes.UINT64_TYPE,\n+                BasicViewTypes.UINT64_TYPE,\n+                SubContainerImpl.TYPE,\n+                new ListViewType<>(BasicViewTypes.UINT64_TYPE, 10),\n+                new ListViewType<>(SubContainerImpl.TYPE, 2),\n+                new VectorViewType<>(ImmutableSubContainerImpl.TYPE, 2)),\n+            ContainerImpl::new);\n+\n+    public ContainerImpl(ContainerViewType<ContainerImpl> type, TreeNode backingNode) {\n+      super(type, backingNode);\n+    }\n+\n+    public static ContainerRead createDefault() {\n+      return TYPE.getDefault();\n+    }\n+\n+    @Override\n+    public UnsignedLong getLong1() {\n+      return ((UInt64View) get(0)).get();\n+    }\n+\n+    @Override\n+    public UnsignedLong getLong2() {\n+      return ((UInt64View) get(1)).get();\n+    }\n+\n+    @Override\n+    public SubContainerImpl getSub1() {\n+      return (SubContainerImpl) getByRef(2);\n+    }\n+\n+    @Override\n+    @SuppressWarnings(\"unchecked\")\n+    public ListViewWrite<UInt64View> getList1() {\n+      return (ListViewWrite<UInt64View>) getByRef(3);\n+    }\n+\n+    @Override\n+    @SuppressWarnings(\"unchecked\")\n+    public ListViewWriteRef<SubContainerRead, SubContainerWrite> getList2() {\n+      return (ListViewWriteRef<SubContainerRead, SubContainerWrite>) getByRef(4);\n+    }\n+\n+    @Override\n+    @SuppressWarnings(\"unchecked\")\n+    public VectorViewWrite<ImmutableSubContainer> getList3() {\n+      return (VectorViewWrite<ImmutableSubContainer>) getByRef(5);\n+    }\n+\n+    @Override\n+    public void setLong1(UnsignedLong val) {\n+      set(0, new UInt64View(val));\n+    }\n+\n+    @Override\n+    public void setLong2(UnsignedLong val) {\n+      set(1, new UInt64View(val));\n+    }\n+  }\n+\n+  @Test\n+  public void readWriteContainerTest1() {\n+    ContainerRead c1 = ContainerImpl.createDefault();\n+\n+    {\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getSub1().getLong1());\n+      Assertions.assertTrue(c1.getList1().isEmpty());\n+      Assertions.assertTrue(c1.getList2().isEmpty());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getList3().get(0).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1.getList3().get(0).getBytes1());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getList3().get(1).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1.getList3().get(1).getBytes1());\n+      Assertions.assertThrows(\n+          IndexOutOfBoundsException.class,\n+          () -> {\n+            c1.getList3().get(2);\n+          });\n+    }\n+\n+    ContainerWrite c1w = c1.createWritableCopy();\n+    c1w.setLong1(UnsignedLong.valueOf(0x1));\n+    c1w.setLong2(UnsignedLong.valueOf(0x2));\n+\n+    c1w.getSub1().setLong1(UnsignedLong.valueOf(0x111));\n+    c1w.getSub1().setLong2(UnsignedLong.valueOf(0x222));\n+\n+    c1w.getList1().append(UInt64View.fromLong(0x333));\n+    c1w.getList1().append(UInt64View.fromLong(0x444));\n+\n+    c1w.getList2()\n+        .append(\n+            sc -> {\n+              sc.setLong1(UnsignedLong.valueOf(0x555));\n+              sc.setLong2(UnsignedLong.valueOf(0x666));\n+            });\n+    SubContainerWrite sc1w = c1w.getList2().append();\n+    sc1w.setLong1(UnsignedLong.valueOf(0x777));\n+    sc1w.setLong2(UnsignedLong.valueOf(0x888));\n+\n+    c1w.getList3()\n+        .set(\n+            1,\n+            new ImmutableSubContainerImpl(\n+                UnsignedLong.valueOf(0x999), Bytes32.leftPad(Bytes.fromHexString(\"0xa999\"))));\n+\n+    {\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getSub1().getLong1());\n+      Assertions.assertTrue(c1.getList1().isEmpty());\n+      Assertions.assertTrue(c1.getList2().isEmpty());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getList3().get(0).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1.getList3().get(0).getBytes1());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getList3().get(1).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1.getList3().get(1).getBytes1());\n+\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x1), c1w.getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x2), c1w.getLong2());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x111), c1w.getSub1().getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x222), c1w.getSub1().getLong2());\n+      Assertions.assertEquals(2, c1w.getList1().size());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x333), c1w.getList1().get(0).get());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x444), c1w.getList1().get(1).get());\n+      Assertions.assertThrows(\n+          IndexOutOfBoundsException.class,\n+          () -> {\n+            c1w.getList1().get(2);\n+          });\n+      Assertions.assertEquals(2, c1w.getList2().size());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x555), c1w.getList2().get(0).getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x666), c1w.getList2().get(0).getLong2());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x777), c1w.getList2().get(1).getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x888), c1w.getList2().get(1).getLong2());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1w.getList3().get(0).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1w.getList3().get(0).getBytes1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x999), c1w.getList3().get(1).getLong1());\n+      Assertions.assertEquals(\n+          Bytes32.leftPad(Bytes.fromHexString(\"0xa999\")), c1w.getList3().get(1).getBytes1());\n+    }\n+\n+    ContainerRead c1r = c1w.commitChanges();\n+    TreeUtil.dumpBinaryTree(c1r.getBackingNode());\n+\n+    {\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getSub1().getLong1());\n+      Assertions.assertTrue(c1.getList1().isEmpty());\n+      Assertions.assertTrue(c1.getList2().isEmpty());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getList3().get(0).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1.getList3().get(0).getBytes1());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1.getList3().get(1).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1.getList3().get(1).getBytes1());\n+\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x1), c1r.getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x2), c1r.getLong2());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x111), c1r.getSub1().getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x222), c1r.getSub1().getLong2());\n+      Assertions.assertEquals(2, c1r.getList1().size());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x333), c1r.getList1().get(0).get());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x444), c1r.getList1().get(1).get());\n+      Assertions.assertThrows(\n+          IndexOutOfBoundsException.class,\n+          () -> {\n+            c1r.getList1().get(2);\n+          });\n+      Assertions.assertEquals(2, c1r.getList2().size());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x555), c1r.getList2().get(0).getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x666), c1r.getList2().get(0).getLong2());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x777), c1r.getList2().get(1).getLong1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x888), c1r.getList2().get(1).getLong2());\n+      Assertions.assertEquals(UnsignedLong.ZERO, c1r.getList3().get(0).getLong1());\n+      Assertions.assertEquals(Bytes32.ZERO, c1r.getList3().get(0).getBytes1());\n+      Assertions.assertEquals(UnsignedLong.valueOf(0x999), c1r.getList3().get(1).getLong1());\n+      Assertions.assertEquals(\n+          Bytes32.leftPad(Bytes.fromHexString(\"0xa999\")), c1r.getList3().get(1).getBytes1());\n+    }\n+\n+    ContainerWrite c2w = c1r.createWritableCopy();\n+    c2w.getList2().getByRef(1).setLong2(UnsignedLong.valueOf(0xaaa));\n+    ContainerRead c2r = c2w.commitChanges();\n+\n+    Assertions.assertEquals(UnsignedLong.valueOf(0x888), c1r.getList2().get(1).getLong2());\n+    Assertions.assertEquals(UnsignedLong.valueOf(0xaaa), c2r.getList2().get(1).getLong2());", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzExNzg3Mg==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387117872", "bodyText": "Migrated tests.", "author": "Nashatyrev", "createdAt": "2020-03-03T15:57:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUwMzczMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUwOTAyMw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386509023", "bodyText": "Do we need this work around right now?  Standard configs should work fine, right?  Even if there is an error in the config, it seems like it would be better to just throw in that case.", "author": "mbaxter", "createdAt": "2020-03-02T16:39:41Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/view/ListViewImpl.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing.view;\n+\n+import static com.google.common.base.Preconditions.checkPositionIndex;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.Arrays;\n+import java.util.List;\n+import tech.pegasys.artemis.util.backing.CompositeViewWrite;\n+import tech.pegasys.artemis.util.backing.ContainerViewWrite;\n+import tech.pegasys.artemis.util.backing.ListViewWriteRef;\n+import tech.pegasys.artemis.util.backing.VectorViewWrite;\n+import tech.pegasys.artemis.util.backing.ViewRead;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode;\n+import tech.pegasys.artemis.util.backing.type.BasicViewTypes;\n+import tech.pegasys.artemis.util.backing.type.ContainerViewType;\n+import tech.pegasys.artemis.util.backing.type.ListViewType;\n+import tech.pegasys.artemis.util.backing.type.VectorViewType;\n+import tech.pegasys.artemis.util.backing.view.BasicViews.UInt64View;\n+\n+public class ListViewImpl<R extends ViewRead, W extends R>\n+    extends AbstractCompositeViewWrite<ListViewImpl<R, W>, R> implements ListViewWriteRef<R, W> {\n+\n+  // TODO: temp workaround for the case\n+  // SLOTS_PER_ETH1_VOTING_PERIOD % SLOTS_PER_EPOCH != 0\n+  // see https://github.com/ethereum/eth2.0-specs/pull/1625\n+  public static boolean THROW_OUT_OF_BOUNDS = true;", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE1NTQ4NA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387155484", "bodyText": "Yep, this relates just to my benchmark configs (6-slots epoch). Switched all the stuff to the 'mainnet' config.", "author": "Nashatyrev", "createdAt": "2020-03-03T16:51:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUwOTAyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUwOTkwMw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386509903", "bodyText": "(optional) Perhaps we should make it more explicit that these methods are creating mutable lists:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              static <T> SSZMutableList<T> create(Class<? extends T> classInfo, long maxSize) {\n          \n          \n            \n              static <T> SSZMutableList<T> createMutable(Class<? extends T> classInfo, long maxSize) {", "author": "mbaxter", "createdAt": "2020-03-02T16:41:03Z", "path": "util/src/main/java/tech/pegasys/artemis/util/SSZTypes/SSZList.java", "diffHunk": "@@ -13,48 +13,77 @@\n \n package tech.pegasys.artemis.util.SSZTypes;\n \n-import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n-import java.util.ArrayList;\n-import java.util.List;\n+import com.google.common.base.Preconditions;\n+import java.lang.reflect.Array;\n+import java.util.Collection;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n \n-@JsonSerialize(as = ArrayList.class)\n-public class SSZList<T> extends ArrayList<T> {\n+public interface SSZList<T> extends SSZImmutableCollection<T> {\n \n-  private long maxSize;\n-  private Class<T> classInfo;\n+  static <T> SSZMutableList<T> create(Class<? extends T> classInfo, long maxSize) {", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA0NzI5MA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387047290", "bodyText": "\ud83d\udc4d", "author": "Nashatyrev", "createdAt": "2020-03-03T14:17:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUwOTkwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUyOTA3Mw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386529073", "bodyText": "Why can't we make writeable copies of lists?", "author": "mbaxter", "createdAt": "2020-03-02T17:12:33Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/ListViewRead.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing;\n+\n+import tech.pegasys.artemis.util.backing.type.ListViewType;\n+\n+/**\n+ * Immutable List view\n+ *\n+ * @param <R> Type of list elements\n+ */\n+public interface ListViewRead<R extends ViewRead> extends CompositeViewRead<R> {\n+\n+  @Override\n+  default ListViewWrite<R> createWritableCopy() {\n+    throw new UnsupportedOperationException();", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA1ODc4Nw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387058787", "bodyText": "\ud83d\udc4d Was just development artifacts", "author": "Nashatyrev", "createdAt": "2020-03-03T14:34:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUyOTA3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzNzQzOA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386537438", "bodyText": "I find the naming of these types a bit confusing.  What about:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              interface Root extends TreeNode {\n          \n          \n            \n              interface LeafNode extends TreeNode {", "author": "mbaxter", "createdAt": "2020-03-02T17:28:22Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/tree/TreeNode.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing.tree;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n+import java.util.function.Function;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.apache.tuweni.crypto.Hash;\n+import org.jetbrains.annotations.NotNull;\n+import tech.pegasys.artemis.util.backing.tree.TreeNodeImpl.RootImpl;\n+\n+/**\n+ * Basic interface for Backing Tree node Backing Binary Tree concept for SSZ structures is described\n+ * here: https://github.com/protolambda/eth-merkle-trees/blob/master/typing_partials.md#tree\n+ *\n+ * <p>Tree node is immutable by design. Any update on a tree creates new nodes which refer both new\n+ * data nodes and old unmodified nodes\n+ */\n+public interface TreeNode {\n+\n+  static TreeNode createRoot(Bytes32 val) {\n+    return new RootImpl(val);\n+  }\n+\n+  /** Leaf node of a tree which contains 'bytes32' value */\n+  interface Root extends TreeNode {", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEyMDc0NA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387120744", "bodyText": "I'm also not too comfortable with Root and Commit terms, but this is exactly how they are defined in the spec: https://github.com/protolambda/eth-merkle-trees/blob/master/typing_partials.md#structure\nI would prefer to stick with spec to avoid confusion, since the javadoc refers to this spec in several places.", "author": "Nashatyrev", "createdAt": "2020-03-03T16:01:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzNzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEzMDg5Mw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387130893", "bodyText": "I'd prefer clarifying the java names, and making a note that \"LeafNode\" corresponds to \"Root\" in the linked spec, etc.  But happy to leave the decision with you.", "author": "mbaxter", "createdAt": "2020-03-03T16:15:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzNzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE2NTUyNw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387165527", "bodyText": "Let's rename them. I remember Root class name confused me a couple of times during development", "author": "Nashatyrev", "createdAt": "2020-03-03T17:06:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzNzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE4MjMyNw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387182327", "bodyText": "dc71008", "author": "Nashatyrev", "createdAt": "2020-03-03T17:36:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzNzQzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzNzczMA==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386537730", "bodyText": "What do you think of:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              interface Commit extends TreeNode {\n          \n          \n            \n              interface InternalTreeNode extends TreeNode {", "author": "mbaxter", "createdAt": "2020-03-02T17:28:55Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/tree/TreeNode.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing.tree;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n+import java.util.function.Function;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.apache.tuweni.crypto.Hash;\n+import org.jetbrains.annotations.NotNull;\n+import tech.pegasys.artemis.util.backing.tree.TreeNodeImpl.RootImpl;\n+\n+/**\n+ * Basic interface for Backing Tree node Backing Binary Tree concept for SSZ structures is described\n+ * here: https://github.com/protolambda/eth-merkle-trees/blob/master/typing_partials.md#tree\n+ *\n+ * <p>Tree node is immutable by design. Any update on a tree creates new nodes which refer both new\n+ * data nodes and old unmodified nodes\n+ */\n+public interface TreeNode {\n+\n+  static TreeNode createRoot(Bytes32 val) {\n+    return new RootImpl(val);\n+  }\n+\n+  /** Leaf node of a tree which contains 'bytes32' value */\n+  interface Root extends TreeNode {\n+\n+    /** Returns node value */\n+    Bytes32 getRoot();\n+\n+    @Override\n+    default Bytes32 hashTreeRoot() {\n+      return getRoot();\n+    }\n+\n+    /**\n+     * @param target generalized index. Should be equal to 1\n+     * @return this node if 'target' == 1\n+     * @throws IllegalArgumentException if 'target' != 1\n+     */\n+    @NotNull\n+    @Override\n+    default TreeNode get(long target) {\n+      checkArgument(target == 1, \"Invalid root index: %s\", target);\n+      return this;\n+    }\n+\n+    @Override\n+    default TreeNode update(long target, Function<TreeNode, TreeNode> nodeUpdater) {\n+      checkArgument(target == 1, \"Invalid root index: %s\", target);\n+      return nodeUpdater.apply(this);\n+    }\n+  }\n+\n+  /** Branch node of a tree */\n+  interface Commit extends TreeNode {", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEyMTE3OQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387121179", "bodyText": "(#1133 (comment))", "author": "Nashatyrev", "createdAt": "2020-03-03T16:02:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzNzczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE2NDQ4Nw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387164487", "bodyText": "@mbaxter then may be BranchNode would be better? That sounds to me as more widespread term", "author": "Nashatyrev", "createdAt": "2020-03-03T17:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzNzczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE3NTgzMw==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387175833", "bodyText": "sure - sounds good to me", "author": "mbaxter", "createdAt": "2020-03-03T17:24:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzNzczMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0MDg4MQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386540881", "bodyText": "May be clearer with:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return Long.bitCount(Utils.nextPowerOf2(maxChunks) - 1);\n          \n          \n            \n                return Long.highestOneBit(Utils.nextPowerOf2(maxChunks)) - 1;\n          \n      \n    \n    \n  \n\n??", "author": "mbaxter", "createdAt": "2020-03-02T17:34:35Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/tree/TreeUtil.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing.tree;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+\n+import java.util.List;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.artemis.util.backing.Utils;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode.Commit;\n+import tech.pegasys.artemis.util.backing.tree.TreeNode.Root;\n+import tech.pegasys.artemis.util.backing.tree.TreeNodeImpl.CommitImpl;\n+import tech.pegasys.artemis.util.backing.tree.TreeNodeImpl.RootImpl;\n+\n+/** Misc Backing binary tree utils */\n+public class TreeUtil {\n+\n+  public static final TreeNode ZERO_LEAF = new RootImpl(Bytes32.ZERO);\n+  private static final TreeNode[] ZERO_TREES;\n+\n+  static {\n+    ZERO_TREES = new TreeNode[64];\n+    ZERO_TREES[0] = ZERO_LEAF;\n+    for (int i = 1; i < ZERO_TREES.length; i++) {\n+      ZERO_TREES[i] = new CommitImpl(ZERO_TREES[i - 1], ZERO_TREES[i - 1]);\n+      ZERO_TREES[i].hashTreeRoot(); // pre-cache\n+    }\n+  }\n+\n+  /**\n+   * Creates a binary tree with `nextPowerOf2(maxLength)` width and following leaf nodes <code>\n+   * [zeroElement] * maxLength + [ZERO_LEAF] * (nextPowerOf2(maxLength) - maxLength)\n+   * </code>\n+   *\n+   * @param maxLength max number of leaf nodes\n+   * @param defaultNode default leaf element. For complex vectors it could be default vector element\n+   *     struct subtree\n+   */\n+  public static TreeNode createDefaultTree(long maxLength, TreeNode defaultNode) {\n+    return createTree(\n+        defaultNode, ZERO_LEAF.equals(defaultNode) ? 0 : maxLength, treeDepth(maxLength));\n+  }\n+\n+  /** Creates a binary tree of width `nextPowerOf2(leafNodes.size())` with specific leaf nodes */\n+  public static TreeNode createTree(List<TreeNode> leafNodes) {\n+    return createTree(leafNodes, treeDepth(leafNodes.size()));\n+  }\n+\n+  private static TreeNode createTree(TreeNode defaultNode, long defaultNodesCount, int depth) {\n+    if (defaultNodesCount == 0) {\n+      return ZERO_TREES[depth];\n+    } else if (depth == 0) {\n+      checkArgument(defaultNodesCount == 1);\n+      return defaultNode;\n+    } else {\n+      long leftNodesCount = Math.min(defaultNodesCount, 1 << (depth - 1));\n+      long rightNodesCount = defaultNodesCount - leftNodesCount;\n+      TreeNode lTree = createTree(defaultNode, leftNodesCount, depth - 1);\n+      TreeNode rTree =\n+          leftNodesCount == rightNodesCount\n+              ? lTree\n+              : createTree(defaultNode, rightNodesCount, depth - 1);\n+      return new CommitImpl(lTree, rTree);\n+    }\n+  }\n+\n+  private static TreeNode createTree(List<TreeNode> leafNodes, int depth) {\n+    if (leafNodes.isEmpty()) {\n+      return ZERO_TREES[depth];\n+    } else if (depth == 0) {\n+      checkArgument(leafNodes.size() == 1);\n+      return leafNodes.get(0);\n+    } else {\n+      long index = 1L << (depth - 1);\n+      int iIndex = index > leafNodes.size() ? leafNodes.size() : (int) index;\n+\n+      List<TreeNode> leftSublist = leafNodes.subList(0, iIndex);\n+      List<TreeNode> rightSublist = leafNodes.subList(iIndex, leafNodes.size());\n+      return new CommitImpl(\n+          createTree(leftSublist, depth - 1), createTree(rightSublist, depth - 1));\n+    }\n+  }\n+\n+  public static int treeDepth(long maxChunks) {\n+    return Long.bitCount(Utils.nextPowerOf2(maxChunks) - 1);", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA1NjExMQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387056111", "bodyText": "Hm, your variant definitelty doesn't calculate tree depth. Did you mean to write anything else ?", "author": "Nashatyrev", "createdAt": "2020-03-03T14:29:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0MDg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwODgyMQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387108821", "bodyText": "nm - thought highestOneBit gave us the index of the highest bit", "author": "mbaxter", "createdAt": "2020-03-03T15:44:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0MDg4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0ODc3NQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r386548775", "bodyText": "(optional) Not sure how much of a headache it would be to move this package, but I think we should avoid dropping big libraries into util and instead try to make independent packages:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            package tech.pegasys.artemis.util.backing;\n          \n          \n            \n            package tech.pegasys.artemis.backingtree;", "author": "mbaxter", "createdAt": "2020-03-02T17:49:32Z", "path": "util/src/main/java/tech/pegasys/artemis/util/backing/BasicView.java", "diffHunk": "@@ -0,0 +1,21 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.util.backing;", "originalCommit": "d4fc41d2f455ad3019095470229fa3cd5922d9c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA1MDg5NQ==", "url": "https://github.com/ConsenSys/teku/pull/1133#discussion_r387050895", "bodyText": "I'm thinking about merging backing and SSZTypes packages and then we can probably create a distinct sub-module for all the ssz related stuff. Let's consider this option for the subsequent refactor?", "author": "Nashatyrev", "createdAt": "2020-03-03T14:22:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0ODc3NQ=="}], "type": "inlineReview"}, {"oid": "360e5f5395705d2b2440a2c9d3ffe06a0a16326e", "url": "https://github.com/ConsenSys/teku/commit/360e5f5395705d2b2440a2c9d3ffe06a0a16326e", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-backing-tree-concept\n\n# Conflicts:\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/state/BeaconState.java", "committedDate": "2020-03-03T09:52:27Z", "type": "commit"}, {"oid": "6c8ac7638c33113f21d65e240f69a099ba286f37", "url": "https://github.com/ConsenSys/teku/commit/6c8ac7638c33113f21d65e240f69a099ba286f37", "message": "Resolve merge errors. Move getActiveValidators() from the BeaconState to more local place (BeaconValidatorsHandler class)", "committedDate": "2020-03-03T11:13:38Z", "type": "commit"}, {"oid": "b89c7df1453fb0975ceb810389bacf041018c498", "url": "https://github.com/ConsenSys/teku/commit/b89c7df1453fb0975ceb810389bacf041018c498", "message": "Replace equals/hashCode to shorter and faster hashTreeRoot() based variants for backed structs", "committedDate": "2020-03-03T11:25:46Z", "type": "commit"}, {"oid": "e7e4d186b87f95621110c7ac4d8bfe2c516df63c", "url": "https://github.com/ConsenSys/teku/commit/e7e4d186b87f95621110c7ac4d8bfe2c516df63c", "message": "Use more specific *BackingNode term instead of *TreeNode", "committedDate": "2020-03-03T11:31:05Z", "type": "commit"}, {"oid": "75ad12773c8daa404aebc5ddf2a7ecf33c22f31a", "url": "https://github.com/ConsenSys/teku/commit/75ad12773c8daa404aebc5ddf2a7ecf33c22f31a", "message": "Move TypeView base class to 'type' subpackage", "committedDate": "2020-03-03T11:35:30Z", "type": "commit"}, {"oid": "5ab1bf77f8eedc4ade1794aa8495fd14fa465e07", "url": "https://github.com/ConsenSys/teku/commit/5ab1bf77f8eedc4ade1794aa8495fd14fa465e07", "message": "Apply spotless", "committedDate": "2020-03-03T11:55:28Z", "type": "commit"}, {"oid": "64c7a41a52e2580d8c0d5e9997721f070f9ce9f4", "url": "https://github.com/ConsenSys/teku/commit/64c7a41a52e2580d8c0d5e9997721f070f9ce9f4", "message": "Remove stray comment", "committedDate": "2020-03-03T12:10:47Z", "type": "commit"}, {"oid": "5c69f0a41af3f1d2b9b80d8a0e3b56c665604705", "url": "https://github.com/ConsenSys/teku/commit/5c69f0a41af3f1d2b9b80d8a0e3b56c665604705", "message": "Avoid implementing ViewType.getBitsSize() default that only apply to some subtypes. CompositeViewType 256 default value is applicable to all subtypes.", "committedDate": "2020-03-03T12:16:58Z", "type": "commit"}, {"oid": "b69db95ab355091f7c3f6e62f6fbbd1218121e9f", "url": "https://github.com/ConsenSys/teku/commit/b69db95ab355091f7c3f6e62f6fbbd1218121e9f", "message": "Create AbstractImmutableContainer as a base class for all immutable datastructs", "committedDate": "2020-03-03T13:01:06Z", "type": "commit"}, {"oid": "da69833ddb59032103ac399dd27fea30a66ac8c8", "url": "https://github.com/ConsenSys/teku/commit/da69833ddb59032103ac399dd27fea30a66ac8c8", "message": "Get rid of stdout in tests. dumpBinaryTree returns String", "committedDate": "2020-03-03T13:24:33Z", "type": "commit"}, {"oid": "84a521b23de59d63395f3578f788fb1637e1190c", "url": "https://github.com/ConsenSys/teku/commit/84a521b23de59d63395f3578f788fb1637e1190c", "message": "Fix the test", "committedDate": "2020-03-03T13:38:15Z", "type": "commit"}, {"oid": "5a08d51d06aa9a5653ffb56fdc8dd77884d67fab", "url": "https://github.com/ConsenSys/teku/commit/5a08d51d06aa9a5653ffb56fdc8dd77884d67fab", "message": "Rename modify/reverse methods for immutable SSZList to modified/reversed", "committedDate": "2020-03-03T13:56:30Z", "type": "commit"}, {"oid": "a3a51387434e686989fe5f34d1e5535c029afee1", "url": "https://github.com/ConsenSys/teku/commit/a3a51387434e686989fe5f34d1e5535c029afee1", "message": "Add CompositeViewType.getGeneralizedIndex(elementIndex) helper method instead of inlining 'magic arithmetic'", "committedDate": "2020-03-03T14:11:00Z", "type": "commit"}, {"oid": "1079da6b384cf5902c505d260f79bc8ed2dd4828", "url": "https://github.com/ConsenSys/teku/commit/1079da6b384cf5902c505d260f79bc8ed2dd4828", "message": "Remove obsolete interface methods defaults throwing UnsupportedOperationException", "committedDate": "2020-03-03T14:33:36Z", "type": "commit"}, {"oid": "41816a38cc04db1db2181a3150f4c32f7698fb1d", "url": "https://github.com/ConsenSys/teku/commit/41816a38cc04db1db2181a3150f4c32f7698fb1d", "message": "Check basic type bitsize argument constraints", "committedDate": "2020-03-03T14:41:43Z", "type": "commit"}, {"oid": "85cd0ec890fefc3dd4f3ffc8de1fd25132b9629a", "url": "https://github.com/ConsenSys/teku/commit/85cd0ec890fefc3dd4f3ffc8de1fd25132b9629a", "message": "Migrate new tests to assertJ", "committedDate": "2020-03-03T15:56:43Z", "type": "commit"}, {"oid": "becee7beca687a0aa15afc2cfabd90f093ed7224", "url": "https://github.com/ConsenSys/teku/commit/becee7beca687a0aa15afc2cfabd90f093ed7224", "message": "Fix boolean operators", "committedDate": "2020-03-03T16:17:52Z", "type": "commit"}, {"oid": "904a2383f062d28f4dcadfc5f02fd463618afe59", "url": "https://github.com/ConsenSys/teku/commit/904a2383f062d28f4dcadfc5f02fd463618afe59", "message": "Switch benchmarks to the mainnet configuration. Remove ssz list overflow workaround", "committedDate": "2020-03-03T16:48:59Z", "type": "commit"}, {"oid": "3efdb95527e33bc97ed2ffcd5a91c6ced5f4318b", "url": "https://github.com/ConsenSys/teku/commit/3efdb95527e33bc97ed2ffcd5a91c6ced5f4318b", "message": "Rename method to more descriptive", "committedDate": "2020-03-03T16:53:20Z", "type": "commit"}, {"oid": "b2232a0388279bf739fd5524dffca12dd0f3a52d", "url": "https://github.com/ConsenSys/teku/commit/b2232a0388279bf739fd5524dffca12dd0f3a52d", "message": "Rename method to more descriptive (non-committed files)", "committedDate": "2020-03-03T16:59:15Z", "type": "commit"}, {"oid": "587f0718091a38edf2e0e40755aed7a59451ef10", "url": "https://github.com/ConsenSys/teku/commit/587f0718091a38edf2e0e40755aed7a59451ef10", "message": "Rename TreeNode.set/update methods to TreeNode.updated. The latter suites more to immutable structure", "committedDate": "2020-03-03T17:00:51Z", "type": "commit"}, {"oid": "b8ccb2fce24c0bb5b7d09321fd1140cf37820608", "url": "https://github.com/ConsenSys/teku/commit/b8ccb2fce24c0bb5b7d09321fd1140cf37820608", "message": "Apply spotless", "committedDate": "2020-03-03T17:20:46Z", "type": "commit"}, {"oid": "dc7100825b3a7dd362f957c75883bb933983aee0", "url": "https://github.com/ConsenSys/teku/commit/dc7100825b3a7dd362f957c75883bb933983aee0", "message": "Rename TreeNode.Root/TreeNode.Commit to less confusing TreeNode.LeafNode/TreeNode.BranchNode", "committedDate": "2020-03-03T17:35:33Z", "type": "commit"}, {"oid": "cc080344a123384e33c8a67b2c10c7e2fb1e4ce7", "url": "https://github.com/ConsenSys/teku/commit/cc080344a123384e33c8a67b2c10c7e2fb1e4ce7", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-backing-tree-concept", "committedDate": "2020-03-03T17:35:41Z", "type": "commit"}, {"oid": "8faf77a476bd686896be4f42fac63a58392f1529", "url": "https://github.com/ConsenSys/teku/commit/8faf77a476bd686896be4f42fac63a58392f1529", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-backing-tree-concept\n\n# Conflicts:\n#\tethereum/statetransition/src/test-support/java/tech/pegasys/artemis/statetransition/AttestationGenerator.java\n#\tstorage/src/test/java/tech/pegasys/artemis/storage/CombinedChainDataClientTest.java", "committedDate": "2020-03-04T07:52:57Z", "type": "commit"}, {"oid": "837b908efa06bcc89211a94f52ada7eb96ddd77c", "url": "https://github.com/ConsenSys/teku/commit/837b908efa06bcc89211a94f52ada7eb96ddd77c", "message": "Resolve merge conflicts", "committedDate": "2020-03-04T08:02:29Z", "type": "commit"}, {"oid": "2500880bcefed88805a498ca4cd4b05a28694947", "url": "https://github.com/ConsenSys/teku/commit/2500880bcefed88805a498ca4cd4b05a28694947", "message": "Apply spotless", "committedDate": "2020-03-04T08:14:49Z", "type": "commit"}, {"oid": "fa7fdde7b65e246a018f5469588b448814c821fa", "url": "https://github.com/ConsenSys/teku/commit/fa7fdde7b65e246a018f5469588b448814c821fa", "message": "Fix blocks Generator", "committedDate": "2020-03-04T08:20:44Z", "type": "commit"}, {"oid": "1b39dee805c40da705683343e70eb80b91a43be5", "url": "https://github.com/ConsenSys/teku/commit/1b39dee805c40da705683343e70eb80b91a43be5", "message": "Initial backing tree implementation with ListView", "committedDate": "2020-01-29T16:10:19Z", "type": "commit"}, {"oid": "9825cde9751f6841d884767fb65f3305e87caf4e", "url": "https://github.com/ConsenSys/teku/commit/9825cde9751f6841d884767fb65f3305e87caf4e", "message": "Add backing tree basic list views", "committedDate": "2020-01-30T09:44:12Z", "type": "commit"}, {"oid": "8a20c79c86ceca5cd478b8b91e9311ef78668995", "url": "https://github.com/ConsenSys/teku/commit/8a20c79c86ceca5cd478b8b91e9311ef78668995", "message": "Some refactorings and renamings", "committedDate": "2020-01-30T12:07:52Z", "type": "commit"}, {"oid": "5edc13e31e97a3c59b8f3e2be64581a19f59e833", "url": "https://github.com/ConsenSys/teku/commit/5edc13e31e97a3c59b8f3e2be64581a19f59e833", "message": "Add Container view and Basic views. Some more refactoring", "committedDate": "2020-01-30T16:01:44Z", "type": "commit"}, {"oid": "0f9dc5adc5ca23c5eeb4223b5ed528e3e3e4244f", "url": "https://github.com/ConsenSys/teku/commit/0f9dc5adc5ca23c5eeb4223b5ed528e3e3e4244f", "message": "Add ContainerView. Add ListView prototype based on ContainerView(Vector, UInt64)", "committedDate": "2020-02-03T18:31:32Z", "type": "commit"}, {"oid": "ce78c9236557daa90e94a462ff34c20fcbfd8bd9", "url": "https://github.com/ConsenSys/teku/commit/ce78c9236557daa90e94a462ff34c20fcbfd8bd9", "message": "Refactoring: make basic list/vector containing View elements instead of generic types for the sake of simpler interface", "committedDate": "2020-02-04T14:35:01Z", "type": "commit"}, {"oid": "8dbdf7a4c79d2ba006ce8ac0d2e43133c5f7b3ba", "url": "https://github.com/ConsenSys/teku/commit/8dbdf7a4c79d2ba006ce8ac0d2e43133c5f7b3ba", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-backing-tree-concept", "committedDate": "2020-02-04T15:28:02Z", "type": "commit"}, {"oid": "c0a92899da0297a31af002a8461d156767128b5d", "url": "https://github.com/ConsenSys/teku/commit/c0a92899da0297a31af002a8461d156767128b5d", "message": "Apply Spotless", "committedDate": "2020-02-04T16:41:17Z", "type": "commit"}, {"oid": "a0df4741948e43dcd8396ff9ceb18b605e395e00", "url": "https://github.com/ConsenSys/teku/commit/a0df4741948e43dcd8396ff9ceb18b605e395e00", "message": "Fix warnings", "committedDate": "2020-02-04T16:58:42Z", "type": "commit"}, {"oid": "b74aa73d9c4c113bec80dafac8a135916168bbce", "url": "https://github.com/ConsenSys/teku/commit/b74aa73d9c4c113bec80dafac8a135916168bbce", "message": "Fix test warnings", "committedDate": "2020-02-04T17:03:34Z", "type": "commit"}, {"oid": "6906f283f911665e23b5b0dcc499023b2bd9084b", "url": "https://github.com/ConsenSys/teku/commit/6906f283f911665e23b5b0dcc499023b2bd9084b", "message": "Move test dumpTree method to tests module", "committedDate": "2020-02-04T17:33:03Z", "type": "commit"}, {"oid": "e7de8047ec33877e9a9926b03c376391dd8c7a5f", "url": "https://github.com/ConsenSys/teku/commit/e7de8047ec33877e9a9926b03c376391dd8c7a5f", "message": "Get rid of too abusing ViewType generic type for the sake of simplicity at cost of a couple of internal type casts", "committedDate": "2020-02-05T13:36:51Z", "type": "commit"}, {"oid": "74329083f3e13e37939b535232cd7d2a0dd7f72a", "url": "https://github.com/ConsenSys/teku/commit/74329083f3e13e37939b535232cd7d2a0dd7f72a", "message": "Unsuccessful efforts to split Views onto type-safe Read and Write interfaces", "committedDate": "2020-02-05T17:24:35Z", "type": "commit"}, {"oid": "eae22a5002364fe074f116ca8911889a1b81bdfa", "url": "https://github.com/ConsenSys/teku/commit/eae22a5002364fe074f116ca8911889a1b81bdfa", "message": "Fix compile error", "committedDate": "2020-02-05T17:39:40Z", "type": "commit"}, {"oid": "dfb67f039ed4ea613b14bac65bc29ba3c4ff7625", "url": "https://github.com/ConsenSys/teku/commit/dfb67f039ed4ea613b14bac65bc29ba3c4ff7625", "message": "Merge branch 'optimize-backing-tree-concept' into backing-tree-typesafe\n\n# Conflicts:\n#\tutil/src/main/java/tech/pegasys/artemis/util/backing/CompositeViewRead.java", "committedDate": "2020-02-06T08:28:07Z", "type": "commit"}, {"oid": "bcc6ee774e4480f682b2491ac2885ad7a9d7ef2b", "url": "https://github.com/ConsenSys/teku/commit/bcc6ee774e4480f682b2491ac2885ad7a9d7ef2b", "message": "First successful effort in splitting views to read/write", "committedDate": "2020-02-06T11:18:05Z", "type": "commit"}, {"oid": "20ab6866bd3827ebdc8c3408263ccd1480c093a8", "url": "https://github.com/ConsenSys/teku/commit/20ab6866bd3827ebdc8c3408263ccd1480c093a8", "message": "Bound list maxLength with long instead of int", "committedDate": "2020-02-06T12:22:24Z", "type": "commit"}, {"oid": "3d576837d696920f4c01c057b054be81c36cfb01", "url": "https://github.com/ConsenSys/teku/commit/3d576837d696920f4c01c057b054be81c36cfb01", "message": "Add hash tree root tests", "committedDate": "2020-02-06T14:17:42Z", "type": "commit"}, {"oid": "0155e2bbdd667803ecdecc3a552b1c107acfad60", "url": "https://github.com/ConsenSys/teku/commit/0155e2bbdd667803ecdecc3a552b1c107acfad60", "message": "Create TreeUtil class", "committedDate": "2020-02-06T14:18:01Z", "type": "commit"}, {"oid": "b2ddb70d0362ed4856d6f76d691eeed80eaa2e64", "url": "https://github.com/ConsenSys/teku/commit/b2ddb70d0362ed4856d6f76d691eeed80eaa2e64", "message": "Fix minor bug", "committedDate": "2020-02-06T14:18:21Z", "type": "commit"}, {"oid": "4ca90ff1dab941531fad21223cfcad1a1163092d", "url": "https://github.com/ConsenSys/teku/commit/4ca90ff1dab941531fad21223cfcad1a1163092d", "message": "Add backing List benchmark", "committedDate": "2020-02-06T14:18:54Z", "type": "commit"}, {"oid": "b7b14a91e88aed6384de5c9c341ed1e820c396b2", "url": "https://github.com/ConsenSys/teku/commit/b7b14a91e88aed6384de5c9c341ed1e820c396b2", "message": "Rename UnsignedLongView to UInt64View", "committedDate": "2020-02-06T15:22:17Z", "type": "commit"}, {"oid": "8f8e3b2c577feea685193ba5dade2764f921a212", "url": "https://github.com/ConsenSys/teku/commit/8f8e3b2c577feea685193ba5dade2764f921a212", "message": "Implement changes propagation up for data hierarchy for *Ref types", "committedDate": "2020-02-10T10:09:57Z", "type": "commit"}, {"oid": "d61a9d57f1993a00f6bad0cf991fde2bff362fa5", "url": "https://github.com/ConsenSys/teku/commit/d61a9d57f1993a00f6bad0cf991fde2bff362fa5", "message": "Merge remote-tracking branch 'pegasys/master' into backing-tree-typesafe", "committedDate": "2020-02-10T10:10:11Z", "type": "commit"}, {"oid": "f7e1736b86251d4fb2c2346d5ad3d28e23fbcd76", "url": "https://github.com/ConsenSys/teku/commit/f7e1736b86251d4fb2c2346d5ad3d28e23fbcd76", "message": "Spotless apply", "committedDate": "2020-02-10T10:13:10Z", "type": "commit"}, {"oid": "e8f7f97aa4df166239e360896546d434640425fb", "url": "https://github.com/ConsenSys/teku/commit/e8f7f97aa4df166239e360896546d434640425fb", "message": "Fix test warnings", "committedDate": "2020-02-10T11:07:31Z", "type": "commit"}, {"oid": "62aa72a884e44a80db5a50c921f90e92c4588c37", "url": "https://github.com/ConsenSys/teku/commit/62aa72a884e44a80db5a50c921f90e92c4588c37", "message": "Fix bench warnings", "committedDate": "2020-02-10T11:13:45Z", "type": "commit"}, {"oid": "6f81f4944ea75a7d4ee1793888ed269a123561e8", "url": "https://github.com/ConsenSys/teku/commit/6f81f4944ea75a7d4ee1793888ed269a123561e8", "message": "Refactor Fork class", "committedDate": "2020-02-10T13:03:12Z", "type": "commit"}, {"oid": "5ec1655d6e9654c8eebe2dc1c67fe157e837cf22", "url": "https://github.com/ConsenSys/teku/commit/5ec1655d6e9654c8eebe2dc1c67fe157e837cf22", "message": "Fix UnsignedLong creation", "committedDate": "2020-02-10T13:35:12Z", "type": "commit"}, {"oid": "2fad9e8e51e5f0268a4d7250ee34007bfd10fb87", "url": "https://github.com/ConsenSys/teku/commit/2fad9e8e51e5f0268a4d7250ee34007bfd10fb87", "message": "Temporarily return back SSZ structure fields for store", "committedDate": "2020-02-10T13:35:57Z", "type": "commit"}, {"oid": "34a61569d56332e73057e0a3dd445fe2989e5469", "url": "https://github.com/ConsenSys/teku/commit/34a61569d56332e73057e0a3dd445fe2989e5469", "message": "BlockHeader backing tree refactor", "committedDate": "2020-02-10T13:39:16Z", "type": "commit"}, {"oid": "cf905d9ccd406192fc6b656b7be48c27d079d854", "url": "https://github.com/ConsenSys/teku/commit/cf905d9ccd406192fc6b656b7be48c27d079d854", "message": "Validator backing tree refactor", "committedDate": "2020-02-11T08:28:28Z", "type": "commit"}, {"oid": "37e6899467cec6832cc510917672276702a9f1dc", "url": "https://github.com/ConsenSys/teku/commit/37e6899467cec6832cc510917672276702a9f1dc", "message": "Unify basic types (no more packed/unpacked types)", "committedDate": "2020-02-11T10:48:31Z", "type": "commit"}, {"oid": "a5b7c15fc599a96f474514e4fd166d985587c7c1", "url": "https://github.com/ConsenSys/teku/commit/a5b7c15fc599a96f474514e4fd166d985587c7c1", "message": "Unify basic types (no more packed/unpacked types)", "committedDate": "2020-02-11T10:52:02Z", "type": "commit"}, {"oid": "41a21ff757d93aadf5cada57475d445897fc6519", "url": "https://github.com/ConsenSys/teku/commit/41a21ff757d93aadf5cada57475d445897fc6519", "message": "Fix BitType bug", "committedDate": "2020-02-11T11:01:24Z", "type": "commit"}, {"oid": "d1fb303f9f8ec3e00886378d95a82d3a78ce24a2", "url": "https://github.com/ConsenSys/teku/commit/d1fb303f9f8ec3e00886378d95a82d3a78ce24a2", "message": "Merge branch 'optimize-backing-tree-concept' into backing-state-structs-refactor", "committedDate": "2020-02-11T11:01:48Z", "type": "commit"}, {"oid": "8d46292e428ecc9a1f8318695f960ca25f83a3d5", "url": "https://github.com/ConsenSys/teku/commit/8d46292e428ecc9a1f8318695f960ca25f83a3d5", "message": "Eth1Data backing tree refactor", "committedDate": "2020-02-11T12:07:52Z", "type": "commit"}, {"oid": "ea393a6b10675965d9092453145eb580820712d8", "url": "https://github.com/ConsenSys/teku/commit/ea393a6b10675965d9092453145eb580820712d8", "message": "Temp fix for intermittently failing MapDBDatabaseTest (fails on Win with OS error that temp artemis.db file couldn't be deleted due to process usage)", "committedDate": "2020-02-11T12:32:49Z", "type": "commit"}, {"oid": "cc41e2495ddebc07bc2767a245e1f2da1c52df7d", "url": "https://github.com/ConsenSys/teku/commit/cc41e2495ddebc07bc2767a245e1f2da1c52df7d", "message": "Fix Validator.hash_tree_root() to use backing tree node hash", "committedDate": "2020-02-11T13:17:43Z", "type": "commit"}, {"oid": "2197810ba59a4ac4e2c409fc70ac906ef698cbd5", "url": "https://github.com/ConsenSys/teku/commit/2197810ba59a4ac4e2c409fc70ac906ef698cbd5", "message": "Bix Bitlist view bug", "committedDate": "2020-02-11T15:10:26Z", "type": "commit"}, {"oid": "d53b6ef2e9d8a156dc9fcd5f4c74ecb793688a84", "url": "https://github.com/ConsenSys/teku/commit/d53b6ef2e9d8a156dc9fcd5f4c74ecb793688a84", "message": "Fix vector bug: vector may consist of a single RootNode", "committedDate": "2020-02-11T15:11:20Z", "type": "commit"}, {"oid": "25751895e2a6d1017f08c8e41f90b17a9096dd94", "url": "https://github.com/ConsenSys/teku/commit/25751895e2a6d1017f08c8e41f90b17a9096dd94", "message": "PendingAttestation, AttestationData, Checkpoint backing tree refactor", "committedDate": "2020-02-11T15:13:42Z", "type": "commit"}, {"oid": "b3efe10769f9c8d2dc1f96a1b957522c709492f5", "url": "https://github.com/ConsenSys/teku/commit/b3efe10769f9c8d2dc1f96a1b957522c709492f5", "message": "Merge remote-tracking branch 'pegasys/master' into backing-state-structs-refactor", "committedDate": "2020-02-12T11:51:26Z", "type": "commit"}, {"oid": "f5ebdf9fbe4177a0c9f74afba4dec7b3ba7959ba", "url": "https://github.com/ConsenSys/teku/commit/f5ebdf9fbe4177a0c9f74afba4dec7b3ba7959ba", "message": "Intermediate BeaconState refactoring commit which compiles", "committedDate": "2020-02-13T18:15:25Z", "type": "commit"}, {"oid": "a51c921c4021cb6a6566ef78bb1b3c8c5dac4eb9", "url": "https://github.com/ConsenSys/teku/commit/a51c921c4021cb6a6566ef78bb1b3c8c5dac4eb9", "message": "Finalize BeaconState backing tree refactor", "committedDate": "2020-02-14T10:23:41Z", "type": "commit"}, {"oid": "01e9e3a4d40ed677ad1848085e62a70edc80b402", "url": "https://github.com/ConsenSys/teku/commit/01e9e3a4d40ed677ad1848085e62a70edc80b402", "message": "Add compare hashes test", "committedDate": "2020-02-14T11:23:34Z", "type": "commit"}, {"oid": "8884d615764aa156acfe86089e18e79fddbd7354", "url": "https://github.com/ConsenSys/teku/commit/8884d615764aa156acfe86089e18e79fddbd7354", "message": "Fix BeaconState TYPE with missed member", "committedDate": "2020-02-14T11:24:33Z", "type": "commit"}, {"oid": "ca2f72e1564e357bd20452f6f5e4188fd9c698ff", "url": "https://github.com/ConsenSys/teku/commit/ca2f72e1564e357bd20452f6f5e4188fd9c698ff", "message": "Add hash_tree_root method to SSZList/Vector classes", "committedDate": "2020-02-14T11:24:56Z", "type": "commit"}, {"oid": "a053326fc9077ae4b637f633cc9c2803ad84ba0a", "url": "https://github.com/ConsenSys/teku/commit/a053326fc9077ae4b637f633cc9c2803ad84ba0a", "message": "Fix default backing tree generation for Vector and List. Add a special flag to VectorViewType to fill default vector with zeros instead of default elements", "committedDate": "2020-02-14T13:11:20Z", "type": "commit"}, {"oid": "d198424b2fb1e9670c8763ece99ba151c71fb0e3", "url": "https://github.com/ConsenSys/teku/commit/d198424b2fb1e9670c8763ece99ba151c71fb0e3", "message": "Refer to generic BeaconState instead of BeaconStateWithCache when possible", "committedDate": "2020-02-14T14:49:17Z", "type": "commit"}, {"oid": "7349972d0e78734bde427e0fad92552c9529b346", "url": "https://github.com/ConsenSys/teku/commit/7349972d0e78734bde427e0fad92552c9529b346", "message": "Merge remote-tracking branch 'origin/master' into backing-state-structs-refactor\n\n# Conflicts:\n#\teth-benchmark-tests/src/jmh/resources/blocks/blocks_epoch_6_validators_1024.ssz.gz\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/util/BeaconStateUtil.java\n#\tethereum/datastructures/src/test/java/tech/pegasys/artemis/datastructures/util/GenesisGeneratorTest.java", "committedDate": "2020-02-14T14:50:06Z", "type": "commit"}, {"oid": "f1d573b6d399f4011c495c2fff86442ac5dd8975", "url": "https://github.com/ConsenSys/teku/commit/f1d573b6d399f4011c495c2fff86442ac5dd8975", "message": "Fix merge conflicts", "committedDate": "2020-02-14T14:51:56Z", "type": "commit"}, {"oid": "eaad31292312a1266cb5df3617a590a89137f7db", "url": "https://github.com/ConsenSys/teku/commit/eaad31292312a1266cb5df3617a590a89137f7db", "message": "Add core structs toString()", "committedDate": "2020-02-17T12:09:06Z", "type": "commit"}, {"oid": "4532f85668c704328cccc3a5eb61595542ec7985", "url": "https://github.com/ConsenSys/teku/commit/4532f85668c704328cccc3a5eb61595542ec7985", "message": "Set default ProfilingRun parameter to 1K validators", "committedDate": "2020-02-17T12:34:39Z", "type": "commit"}, {"oid": "30f6eb0eaac7e34c8f82f8900474f92609449f63", "url": "https://github.com/ConsenSys/teku/commit/30f6eb0eaac7e34c8f82f8900474f92609449f63", "message": "Temp debug", "committedDate": "2020-02-17T12:44:12Z", "type": "commit"}, {"oid": "6c8eb8aa4367d0e387fb19a4efd5aa69237dea27", "url": "https://github.com/ConsenSys/teku/commit/6c8eb8aa4367d0e387fb19a4efd5aa69237dea27", "message": "Temp debug", "committedDate": "2020-02-17T12:50:00Z", "type": "commit"}, {"oid": "beec0307688155c03fe40837d2003c77cefc954e", "url": "https://github.com/ConsenSys/teku/commit/beec0307688155c03fe40837d2003c77cefc954e", "message": "Add AttestationData.toString()", "committedDate": "2020-02-17T12:58:54Z", "type": "commit"}, {"oid": "39254d4b341cef0591c9cdbcc4b352e81ea990d6", "url": "https://github.com/ConsenSys/teku/commit/39254d4b341cef0591c9cdbcc4b352e81ea990d6", "message": "Add AttestationData.toString()", "committedDate": "2020-02-17T13:01:24Z", "type": "commit"}, {"oid": "ebf3e48a3e8331f0873ad673c8283a2705ca8b79", "url": "https://github.com/ConsenSys/teku/commit/ebf3e48a3e8331f0873ad673c8283a2705ca8b79", "message": "Fix Bitlist View endianness", "committedDate": "2020-02-17T13:40:22Z", "type": "commit"}, {"oid": "a6f693049a4ec51361dd572ff08e32fdcd10d81b", "url": "https://github.com/ConsenSys/teku/commit/a6f693049a4ec51361dd572ff08e32fdcd10d81b", "message": "Add ViewType.createDefaultTree() method", "committedDate": "2020-02-18T08:51:43Z", "type": "commit"}, {"oid": "223d2ae8e4b38fc71725c4c3e8a785e0b9e6dad0", "url": "https://github.com/ConsenSys/teku/commit/223d2ae8e4b38fc71725c4c3e8a785e0b9e6dad0", "message": "Add ViewWrite.clear() method", "committedDate": "2020-02-18T09:20:39Z", "type": "commit"}, {"oid": "72348d348377f390f3bbf5ee61a6ba88ca7a5437", "url": "https://github.com/ConsenSys/teku/commit/72348d348377f390f3bbf5ee61a6ba88ca7a5437", "message": "Revert temp commit change", "committedDate": "2020-02-18T09:21:46Z", "type": "commit"}, {"oid": "5386e1ae557013b592a605cbdbaac7754a981745", "url": "https://github.com/ConsenSys/teku/commit/5386e1ae557013b592a605cbdbaac7754a981745", "message": "Temp commit", "committedDate": "2020-02-18T09:38:34Z", "type": "commit"}, {"oid": "889cd5d14a0f3cfd12c6acbb4254ef8c6aa4288e", "url": "https://github.com/ConsenSys/teku/commit/889cd5d14a0f3cfd12c6acbb4254ef8c6aa4288e", "message": "Fix NPE", "committedDate": "2020-02-18T11:53:09Z", "type": "commit"}, {"oid": "1dd075a0e17ba689eb7b7a5c7408e78b6adaacd5", "url": "https://github.com/ConsenSys/teku/commit/1dd075a0e17ba689eb7b7a5c7408e78b6adaacd5", "message": "Use clear() instead of setAll(empty list)", "committedDate": "2020-02-18T12:17:45Z", "type": "commit"}, {"oid": "9aaeb1219bc9fe98c5d4a3c115213745d8dae0c8", "url": "https://github.com/ConsenSys/teku/commit/9aaeb1219bc9fe98c5d4a3c115213745d8dae0c8", "message": "Add some tests", "committedDate": "2020-02-18T12:19:30Z", "type": "commit"}, {"oid": "6d1cd19b747f520c5308b4ab8202b149ed316029", "url": "https://github.com/ConsenSys/teku/commit/6d1cd19b747f520c5308b4ab8202b149ed316029", "message": "Fix bug: clear() should cause invalidate()", "committedDate": "2020-02-18T12:20:27Z", "type": "commit"}, {"oid": "2bd8b458892efeed63afa3a6ddac1cf6f5631315", "url": "https://github.com/ConsenSys/teku/commit/2bd8b458892efeed63afa3a6ddac1cf6f5631315", "message": "Revert temp change", "committedDate": "2020-02-18T12:20:41Z", "type": "commit"}, {"oid": "72855d9e3399856f7ad64ac17c9212e1e2ae9fd6", "url": "https://github.com/ConsenSys/teku/commit/72855d9e3399856f7ad64ac17c9212e1e2ae9fd6", "message": "Temp commit", "committedDate": "2020-02-18T14:06:26Z", "type": "commit"}, {"oid": "e991d43f95fd8aa0d327be6f7b363fceae72a783", "url": "https://github.com/ConsenSys/teku/commit/e991d43f95fd8aa0d327be6f7b363fceae72a783", "message": "Merge branch 'tmp-master' into backing-state-structs-refactor\n\n# Conflicts:\n#\teth-benchmark-tests/src/jmh/java/tech/pegasys/artemis/benchmarks/ProfilingRun.java", "committedDate": "2020-02-18T14:36:19Z", "type": "commit"}, {"oid": "50791c489596f3a7e2d2f14b02b5cd7dd9c1ffd7", "url": "https://github.com/ConsenSys/teku/commit/50791c489596f3a7e2d2f14b02b5cd7dd9c1ffd7", "message": "Resolve merge conflicts", "committedDate": "2020-02-18T14:37:19Z", "type": "commit"}, {"oid": "72abd7a204686a193dd643def6dc271a3ac00703", "url": "https://github.com/ConsenSys/teku/commit/72abd7a204686a193dd643def6dc271a3ac00703", "message": "Add validator PubKey cache", "committedDate": "2020-02-18T15:26:26Z", "type": "commit"}, {"oid": "5f327322840a81d7837ba75a8418b338c5cbcc8d", "url": "https://github.com/ConsenSys/teku/commit/5f327322840a81d7837ba75a8418b338c5cbcc8d", "message": "Fix state caches utilization", "committedDate": "2020-02-18T15:27:53Z", "type": "commit"}, {"oid": "a9c40b10b51ea0e649fdddae442a03e81cdce641", "url": "https://github.com/ConsenSys/teku/commit/a9c40b10b51ea0e649fdddae442a03e81cdce641", "message": "Remove obsolete blocks dump added by mistake", "committedDate": "2020-02-18T15:30:12Z", "type": "commit"}, {"oid": "1d616a92bb9e3be8d3f5f6560bff6cd4b5577b17", "url": "https://github.com/ConsenSys/teku/commit/1d616a92bb9e3be8d3f5f6560bff6cd4b5577b17", "message": "Switch Eth1Data to backing tree hash_tree_root", "committedDate": "2020-02-18T18:06:18Z", "type": "commit"}, {"oid": "9ef6877c00a02c6e1dad03093bd721cb579469f7", "url": "https://github.com/ConsenSys/teku/commit/9ef6877c00a02c6e1dad03093bd721cb579469f7", "message": "Minor cleanups", "committedDate": "2020-02-18T18:33:21Z", "type": "commit"}, {"oid": "4631da4bd6bf1f090794277a3cfbe94fd0483e1f", "url": "https://github.com/ConsenSys/teku/commit/4631da4bd6bf1f090794277a3cfbe94fd0483e1f", "message": "Remove experimental classes for now", "committedDate": "2020-02-18T18:49:42Z", "type": "commit"}, {"oid": "10f9c49628b104a4b40c02bb5e97aa2a1af2f63c", "url": "https://github.com/ConsenSys/teku/commit/10f9c49628b104a4b40c02bb5e97aa2a1af2f63c", "message": "Restrict TreeNode.toString() for Lists with huge maxSize", "committedDate": "2020-02-18T18:55:02Z", "type": "commit"}, {"oid": "c92a455fe8c82a2732758b000edec97d69e81266", "url": "https://github.com/ConsenSys/teku/commit/c92a455fe8c82a2732758b000edec97d69e81266", "message": "Replace BeaconState implementation class references with interfaces", "committedDate": "2020-02-18T21:04:39Z", "type": "commit"}, {"oid": "50481de7c53e7ec1f9bbe63a3cdb98f89d2c151a", "url": "https://github.com/ConsenSys/teku/commit/50481de7c53e7ec1f9bbe63a3cdb98f89d2c151a", "message": "Fix mainnet 16K validators blocks dum file, add 32K validators file", "committedDate": "2020-02-19T09:26:58Z", "type": "commit"}, {"oid": "61f79b9680e1a214239bcb51a0211aa17f573806", "url": "https://github.com/ConsenSys/teku/commit/61f79b9680e1a214239bcb51a0211aa17f573806", "message": "Get rid of another portion of BeaconState impl and BeaconStateWithCache references", "committedDate": "2020-02-19T11:41:29Z", "type": "commit"}, {"oid": "94c66942b1c0ff9248a086cfc183954a8ea7c590", "url": "https://github.com/ConsenSys/teku/commit/94c66942b1c0ff9248a086cfc183954a8ea7c590", "message": "Rename BeaconState/BeaconStateRead/BeaconStateWrite to BeaconStateImpl/BeaconState/MutableBeaconState, the same for Validator*", "committedDate": "2020-02-19T11:59:09Z", "type": "commit"}, {"oid": "0474eacc36ffa225273271a43fbf130fc2ff6075", "url": "https://github.com/ConsenSys/teku/commit/0474eacc36ffa225273271a43fbf130fc2ff6075", "message": "Remove methods which are obsolete for client", "committedDate": "2020-02-19T12:02:00Z", "type": "commit"}, {"oid": "764a6a6df551f7d3a8c17a9096a28e606dfd7147", "url": "https://github.com/ConsenSys/teku/commit/764a6a6df551f7d3a8c17a9096a28e606dfd7147", "message": "Refactor SSZTypes collections, use them where appropriate", "committedDate": "2020-02-19T16:25:26Z", "type": "commit"}, {"oid": "8e70eca6c43bb77d813364c26a4c706436b67626", "url": "https://github.com/ConsenSys/teku/commit/8e70eca6c43bb77d813364c26a4c706436b67626", "message": "Apply spotless", "committedDate": "2020-02-19T16:51:33Z", "type": "commit"}, {"oid": "89c47404b1d94c277608683b88bafd4bca5011a4", "url": "https://github.com/ConsenSys/teku/commit/89c47404b1d94c277608683b88bafd4bca5011a4", "message": "Merge remote-tracking branch 'pegasys/master' into backing-state-structs-refactor\n\n# Conflicts:\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/util/MerkleTree.java\n#\tethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/BlockAttestationsPool.java\n#\tstorage/src/test/java/tech/pegasys/artemis/storage/MapDbDatabaseTest.java\n#\tvalidator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/ValidatorCoordinator.java", "committedDate": "2020-02-19T16:55:27Z", "type": "commit"}, {"oid": "21d3463199179255d4e9276b342990c2f2288582", "url": "https://github.com/ConsenSys/teku/commit/21d3463199179255d4e9276b342990c2f2288582", "message": "Resolve merge compile issues", "committedDate": "2020-02-19T17:02:24Z", "type": "commit"}, {"oid": "dfc56fa37f3d9713e9c26135335058396b5f1f65", "url": "https://github.com/ConsenSys/teku/commit/dfc56fa37f3d9713e9c26135335058396b5f1f65", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-backing-tree-concept\n\n# Conflicts:\n#\teth-benchmark-tests/src/jmh/resources/blocks/blocks_epoch_6_validators_1024.ssz.gz", "committedDate": "2020-02-19T17:03:02Z", "type": "commit"}, {"oid": "6946f3b55dd24ccb985bf8cdf8a372b6a8b8e78b", "url": "https://github.com/ConsenSys/teku/commit/6946f3b55dd24ccb985bf8cdf8a372b6a8b8e78b", "message": "Merge branch 'optimize-backing-tree-concept' into backing-state-structs-refactor\n\n# Conflicts:\n#\teth-benchmark-tests/src/jmh/resources/blocks/blocks_epoch_6_validators_1024.ssz.gz", "committedDate": "2020-02-19T17:04:35Z", "type": "commit"}, {"oid": "75e3b2fd237461d9456b66ad430e4041d00e8da2", "url": "https://github.com/ConsenSys/teku/commit/75e3b2fd237461d9456b66ad430e4041d00e8da2", "message": "Fix errorprone warnings", "committedDate": "2020-02-20T08:38:38Z", "type": "commit"}, {"oid": "da70861aeb871df56c687906817cc353bf69aa9b", "url": "https://github.com/ConsenSys/teku/commit/da70861aeb871df56c687906817cc353bf69aa9b", "message": "Get rid of ValidatorImpl references where possible. Use Validator interface instead", "committedDate": "2020-02-20T09:39:31Z", "type": "commit"}, {"oid": "19a1d6ba31a257f33467e875d4eaf094a949c243", "url": "https://github.com/ConsenSys/teku/commit/19a1d6ba31a257f33467e875d4eaf094a949c243", "message": "Fix: create mutable ArrayList for [data]", "committedDate": "2020-02-20T12:09:37Z", "type": "commit"}, {"oid": "559a2820d162398986b68b5c64e5465c15988db6", "url": "https://github.com/ConsenSys/teku/commit/559a2820d162398986b68b5c64e5465c15988db6", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-backing-tree-concept\n\n# Conflicts:\n#\tdata/provider/src/main/java/tech/pegasys/artemis/provider/JsonProvider.java\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/state/BeaconStateWithCache.java", "committedDate": "2020-02-20T12:20:54Z", "type": "commit"}, {"oid": "96d12a0dc06cb43ab04ca4ed123c42d839e6b01c", "url": "https://github.com/ConsenSys/teku/commit/96d12a0dc06cb43ab04ca4ed123c42d839e6b01c", "message": "Fix merge error", "committedDate": "2020-02-20T12:35:21Z", "type": "commit"}, {"oid": "fa913ed94250a4e48021c8797c0fabab57dedc52", "url": "https://github.com/ConsenSys/teku/commit/fa913ed94250a4e48021c8797c0fabab57dedc52", "message": "Get rid of BeaconStateWithCache wrapper. Create BeaconStateCache interface instead", "committedDate": "2020-02-20T14:41:54Z", "type": "commit"}, {"oid": "076d285643d86d16df311742b41807e22da52402", "url": "https://github.com/ConsenSys/teku/commit/076d285643d86d16df311742b41807e22da52402", "message": "Merge branch 'backing-state-structs-refactor' into optimize-backing-tree-concept\n\n# Conflicts:\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/state/BeaconStateWithCache.java", "committedDate": "2020-02-20T14:42:37Z", "type": "commit"}, {"oid": "ce4dd491803a962ab50c9029fa7054e3d687e2f4", "url": "https://github.com/ConsenSys/teku/commit/ce4dd491803a962ab50c9029fa7054e3d687e2f4", "message": "Effort to fix SSZ SoS", "committedDate": "2020-02-20T15:32:34Z", "type": "commit"}, {"oid": "7c0c8beee23a2d0dae7a1d4e5a8e9fe71161c578", "url": "https://github.com/ConsenSys/teku/commit/7c0c8beee23a2d0dae7a1d4e5a8e9fe71161c578", "message": "Merge branch 'backing-state-structs-refactor' into optimize-backing-tree-concept", "committedDate": "2020-02-20T15:32:58Z", "type": "commit"}, {"oid": "3bd3aad55d33944b07d420870d430f41cecdb7d1", "url": "https://github.com/ConsenSys/teku/commit/3bd3aad55d33944b07d420870d430f41cecdb7d1", "message": "Add a couple of toString() methods", "committedDate": "2020-02-20T16:05:26Z", "type": "commit"}, {"oid": "88c61d60fadeaddb2647c15ea894964f37c39710", "url": "https://github.com/ConsenSys/teku/commit/88c61d60fadeaddb2647c15ea894964f37c39710", "message": "Fix Array backed SSZVector.size() method", "committedDate": "2020-02-20T16:06:22Z", "type": "commit"}]}