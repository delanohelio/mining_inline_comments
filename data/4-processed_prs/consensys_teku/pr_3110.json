{"pr_number": 3110, "pr_title": "fix retrieval of validators from beacon state.", "pr_createdAt": "2020-10-29T01:06:51Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3110", "timeline": [{"oid": "70abf57bfeb0e458aec62fe5efa47ad6a859d94f", "url": "https://github.com/ConsenSys/teku/commit/70abf57bfeb0e458aec62fe5efa47ad6a859d94f", "message": "fix retrieval of validators from beacon state.\n\n - Error codes were returning 500 for any issue, rather than the expected codes (#3105)\n\n - `/eth/v1/state/{state_id}/validators/{validator_id}` needed to get the correct state to work from (#3071)\n\n Fixes #3071\n Fixes #3105\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-29T01:06:07Z", "type": "commit"}, {"oid": "9e5e6c3f0e6c457d8c4907b035f3747874195880", "url": "https://github.com/ConsenSys/teku/commit/9e5e6c3f0e6c457d8c4907b035f3747874195880", "message": "Merge remote-tracking branch 'upstream/master' into 3077-validators-from-state", "committedDate": "2020-10-29T01:07:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg1MzY5OA==", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r513853698", "bodyText": "Maybe rather than having a ValidatorResponse.EMPTY ValidatorResponse.fromState could return an Optional<ValidatorResponse> then this could just flat map?", "author": "ajsutton", "createdAt": "2020-10-29T01:17:12Z", "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -617,9 +614,28 @@ public void requireStoreAvailable() {\n     return getValidatorSelector(state, validators)\n         .filter(getStatusPredicate(state, statusFilter))\n         .mapToObj(index -> ValidatorResponse.fromState(state, index))", "originalCommit": "9e5e6c3f0e6c457d8c4907b035f3747874195880", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg1Njc0MQ==", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r513856741", "bodyText": "it wanted SafeFuture<Optional<Optional<ValidatorResponse>>...", "author": "rolfyone", "createdAt": "2020-10-29T01:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg1MzY5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg1OTQ0MA==", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r513859440", "bodyText": "That sounds like you need a flatMap somewhere instead of just map.", "author": "ajsutton", "createdAt": "2020-10-29T01:27:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg1MzY5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg1NDQ2NA==", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r513854464", "bodyText": "We throw when the key isn't found or only when it's an invalid key?", "author": "ajsutton", "createdAt": "2020-10-29T01:18:53Z", "path": "data/provider/src/test/java/tech/pegasys/teku/api/ChainDataProviderTest.java", "diffHunk": "@@ -798,6 +798,29 @@ public void filteredValidatorsList_shouldFilterByValidatorPubkey() {\n     assertThat(pubkeys).containsExactly(key);\n   }\n \n+  @Test\n+  public void validatorParameterToIndex_shouldThrowBadRequestExceptionWhenIndexInvalid() {\n+    final ChainDataProvider provider =\n+        new ChainDataProvider(recentChainData, combinedChainDataClient);\n+    assertThrows(BadRequestException.class, () -> provider.validatorParameterToIndex(\"a\"));\n+  }\n+\n+  @Test\n+  public void validatorParameterToIndex_shouldThrowBadRequestExceptionWhenIndexTooHigh() {\n+    final ChainDataProvider provider =\n+        new ChainDataProvider(recentChainData, combinedChainDataClient);\n+    assertThrows(BadRequestException.class, () -> provider.validatorParameterToIndex(\"1024000\"));\n+  }\n+\n+  @Test\n+  public void validatorParameterToIndex_shouldThrowBadRequestExceptionWhenKeyNotFound() {", "originalCommit": "9e5e6c3f0e6c457d8c4907b035f3747874195880", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg1NzEzOQ==", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r513857139", "bodyText": "key not found is basically search by root, index not found is basically index out of bounds...", "author": "rolfyone", "createdAt": "2020-10-29T01:23:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg1NDQ2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzg1NDg0Nw==", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r513854847", "bodyText": "Would be better to check the index is valid ahead of time rather than catching the IndexOutOfBoundsException.", "author": "ajsutton", "createdAt": "2020-10-29T01:19:39Z", "path": "data/serializer/src/main/java/tech/pegasys/teku/api/response/v1/beacon/ValidatorResponse.java", "diffHunk": "@@ -60,14 +63,18 @@ public ValidatorResponse(\n   }\n \n   public static ValidatorResponse fromState(final BeaconState state, final Integer index) {\n-    tech.pegasys.teku.datastructures.state.Validator validatorInternal =\n-        state.getValidators().get(index);\n-    final UInt64 current_epoch = compute_epoch_at_slot(state.getSlot());\n-    return new ValidatorResponse(\n-        UInt64.valueOf(index),\n-        state.getBalances().get(index),\n-        getValidatorStatus(current_epoch, validatorInternal),\n-        new Validator(validatorInternal));\n+    try {\n+      tech.pegasys.teku.datastructures.state.Validator validatorInternal =\n+          state.getValidators().get(index);\n+      final UInt64 current_epoch = compute_epoch_at_slot(state.getSlot());\n+      return new ValidatorResponse(\n+          UInt64.valueOf(index),\n+          state.getBalances().get(index),\n+          getValidatorStatus(current_epoch, validatorInternal),\n+          new Validator(validatorInternal));\n+    } catch (IndexOutOfBoundsException ex) {\n+      return ValidatorResponse.EMPTY;", "originalCommit": "9e5e6c3f0e6c457d8c4907b035f3747874195880", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8221454ea2713d538ba949c11dfe577a55723ea8", "url": "https://github.com/ConsenSys/teku/commit/8221454ea2713d538ba949c11dfe577a55723ea8", "message": "changes per review feedback. also added handling for invalid Validator Status.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-29T04:05:30Z", "type": "commit"}, {"oid": "741b87b5ac0752d25678817e1e8968334eceb856", "url": "https://github.com/ConsenSys/teku/commit/741b87b5ac0752d25678817e1e8968334eceb856", "message": "Merge remote-tracking branch 'upstream/master' into 3077-validators-from-state", "committedDate": "2020-10-29T04:20:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzk2NjA0NQ==", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r513966045", "bodyText": "nit: this one can just use .flatMap instead of .map as it's not an IntStream.", "author": "ajsutton", "createdAt": "2020-10-29T04:48:00Z", "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -562,6 +559,7 @@ public void requireStoreAvailable() {\n       final tech.pegasys.teku.datastructures.state.BeaconState state) {\n     return validatorIndices.stream()\n         .map(index -> ValidatorResponse.fromState(state, index))\n+        .flatMap(Optional::stream)", "originalCommit": "741b87b5ac0752d25678817e1e8968334eceb856", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1MDA5MQ==", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r514050091", "bodyText": "im doing something wrong, because i the compiler didnt like me on this one...", "author": "rolfyone", "createdAt": "2020-10-29T07:24:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzk2NjA0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzk2NjU4OQ==", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r513966589", "bodyText": "If this is going to throw an exception if the index is too big then it doesn't need to return Optional because it will never return empty.  I wouldn't have expected a validator index being too big to be a bad request, it's just not found and so the validator wouldn't be included in the results.", "author": "ajsutton", "createdAt": "2020-10-29T04:49:27Z", "path": "data/serializer/src/main/java/tech/pegasys/teku/api/response/v1/beacon/ValidatorResponse.java", "diffHunk": "@@ -59,15 +62,20 @@ public ValidatorResponse(\n     this.validator = validator;\n   }\n \n-  public static ValidatorResponse fromState(final BeaconState state, final Integer index) {\n+  public static Optional<ValidatorResponse> fromState(\n+      final BeaconState state, final Integer index) {\n+    if (index >= state.getValidators().size()) {\n+      throw new BadRequestException(\"Validator index out of bounds: \" + index);\n+    }", "originalCommit": "741b87b5ac0752d25678817e1e8968334eceb856", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1MDQ1Mw==", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r514050453", "bodyText": "was getting index out of bounds, which you didnt want to catch, so this was option b, i'll have to have another look.", "author": "rolfyone", "createdAt": "2020-10-29T07:25:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzk2NjU4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5MDA1OQ==", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r514090059", "bodyText": "Just return Optional.empty() here instead of throwing an exception.", "author": "ajsutton", "createdAt": "2020-10-29T08:44:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzk2NjU4OQ=="}], "type": "inlineReview"}, {"oid": "0de956eb413fe1b650882e2b4fb18ab915516365", "url": "https://github.com/ConsenSys/teku/commit/0de956eb413fe1b650882e2b4fb18ab915516365", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-29T07:26:55Z", "type": "commit"}, {"oid": "4f457b2560820cc3fe4b7656d1b1d35c797b3292", "url": "https://github.com/ConsenSys/teku/commit/4f457b2560820cc3fe4b7656d1b1d35c797b3292", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-29T08:45:13Z", "type": "commit"}, {"oid": "39878a539cc686caf4c7b2f9a5ebe3132c51d11a", "url": "https://github.com/ConsenSys/teku/commit/39878a539cc686caf4c7b2f9a5ebe3132c51d11a", "message": "fix missing reference in swagger\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-29T21:25:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYwOTAxNg==", "url": "https://github.com/ConsenSys/teku/pull/3110#discussion_r514609016", "bodyText": "This looks like a case where it should result in not found rather than BadRequestException - the index can be parsed but there is no validator at that index. Suspect this should just return Optional.empty which matches the behaviour of a public key not being found and avoids a lot of places needing to check for an index being too large later.", "author": "ajsutton", "createdAt": "2020-10-29T22:43:26Z", "path": "data/provider/src/main/java/tech/pegasys/teku/api/ChainDataProvider.java", "diffHunk": "@@ -448,28 +447,26 @@ public void requireStoreAvailable() {\n         BLSPubKey publicKey = BLSPubKey.fromHexString(validatorParameter);\n         return getValidatorIndex(state, publicKey.asBLSPublicKey());\n       } catch (PublicKeyException ex) {\n-        throw new IllegalArgumentException(\n-            String.format(\"Invalid public key: %s\", validatorParameter));\n+        throw new BadRequestException(String.format(\"Invalid public key: %s\", validatorParameter));\n       }\n     } else {\n       try {\n         final UInt64 numericValidator = UInt64.valueOf(validatorParameter);\n         if (numericValidator.isGreaterThan(UInt64.valueOf(Integer.MAX_VALUE))) {\n-          throw new IllegalArgumentException(\n+          throw new BadRequestException(\n               String.format(\"Validator Index is too high to use: %s\", validatorParameter));\n         }\n         final int validatorIndex = numericValidator.intValue();\n         final int validatorCount = state.getValidators().size();\n         if (validatorIndex > validatorCount) {\n-          throw new IllegalArgumentException(\n+          throw new BadRequestException(\n               String.format(\n                   \"Invalid validator index: %d, exceeds validator count: %d\",\n                   validatorIndex, validatorCount));\n         }", "originalCommit": "39878a539cc686caf4c7b2f9a5ebe3132c51d11a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "15dde65ff19415599df1b103f0ffa5390007253c", "url": "https://github.com/ConsenSys/teku/commit/15dde65ff19415599df1b103f0ffa5390007253c", "message": "review comments\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-10-29T23:20:48Z", "type": "commit"}, {"oid": "d84acd493796abb485eb6cb2d0e46b9d0309daf6", "url": "https://github.com/ConsenSys/teku/commit/d84acd493796abb485eb6cb2d0e46b9d0309daf6", "message": "Merge remote-tracking branch 'upstream/master' into 3077-validators-from-state", "committedDate": "2020-10-29T23:23:38Z", "type": "commit"}]}