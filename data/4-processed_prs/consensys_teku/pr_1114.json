{"pr_number": 1114, "pr_title": "Optimize: use HashSet instead of ArrayList", "pr_createdAt": "2020-01-23T16:53:11Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1114", "timeline": [{"oid": "bcc60315ad654d49d500f7c8d8301cba935d6426", "url": "https://github.com/ConsenSys/teku/commit/bcc60315ad654d49d500f7c8d8301cba935d6426", "message": "Add activeValidatorsCache (naive static implementation)", "committedDate": "2020-01-23T09:19:23Z", "type": "commit"}, {"oid": "d724d3aab1f020d1c4b7aa71e87e39f9b1e9d69c", "url": "https://github.com/ConsenSys/teku/commit/d724d3aab1f020d1c4b7aa71e87e39f9b1e9d69c", "message": "Add TransitionCaches to the BeaconChainWithCache", "committedDate": "2020-01-23T09:27:26Z", "type": "commit"}, {"oid": "89d375ca06891b1d214094ac0a7beff94afc99cf", "url": "https://github.com/ConsenSys/teku/commit/89d375ca06891b1d214094ac0a7beff94afc99cf", "message": "Move activeValidators cache from ValidatorUtils statics to the TransitionsCache instance", "committedDate": "2020-01-23T09:27:43Z", "type": "commit"}, {"oid": "8588b1d60b72857ff10ec1a7e0130f2ea1990d0f", "url": "https://github.com/ConsenSys/teku/commit/8588b1d60b72857ff10ec1a7e0130f2ea1990d0f", "message": "Make LRUCache to evict last inserted entry instead of last accessed, since it is more appropriate for transition logic", "committedDate": "2020-01-23T09:50:49Z", "type": "commit"}, {"oid": "84ecfd1a24c5d394b183b526febce60a8c3e6776", "url": "https://github.com/ConsenSys/teku/commit/84ecfd1a24c5d394b183b526febce60a8c3e6776", "message": "Add javadocs", "committedDate": "2020-01-23T09:51:02Z", "type": "commit"}, {"oid": "c88eecc073a94bde9a3312e28730fbf69d59c7a7", "url": "https://github.com/ConsenSys/teku/commit/c88eecc073a94bde9a3312e28730fbf69d59c7a7", "message": "Apply spotless", "committedDate": "2020-01-23T10:55:07Z", "type": "commit"}, {"oid": "9a0a51f476df20d56fc11468af7d31b499365b30", "url": "https://github.com/ConsenSys/teku/commit/9a0a51f476df20d56fc11468af7d31b499365b30", "message": "Fix compiler warnings", "committedDate": "2020-01-23T11:36:38Z", "type": "commit"}, {"oid": "04f9319220e4e56f1c3b85dac1ab8f77595c25e5", "url": "https://github.com/ConsenSys/teku/commit/04f9319220e4e56f1c3b85dac1ab8f77595c25e5", "message": "Make LRUCache.copy() method thread-safe", "committedDate": "2020-01-23T12:54:11Z", "type": "commit"}, {"oid": "cfa0829bcbc02347f177b19f665d1bf927ddfbff", "url": "https://github.com/ConsenSys/teku/commit/cfa0829bcbc02347f177b19f665d1bf927ddfbff", "message": "Blocks generator: use the right keys source", "committedDate": "2020-01-23T13:14:05Z", "type": "commit"}, {"oid": "07206583d6e2e5b0df720ebcda3076328228c1b0", "url": "https://github.com/ConsenSys/teku/commit/07206583d6e2e5b0df720ebcda3076328228c1b0", "message": "Re-generate benchmark blocks for 0.9.4", "committedDate": "2020-01-23T13:48:36Z", "type": "commit"}, {"oid": "dad2554ecba9653bae9a6669c33652cda3ff3198", "url": "https://github.com/ConsenSys/teku/commit/dad2554ecba9653bae9a6669c33652cda3ff3198", "message": "Remove debug blocks printing", "committedDate": "2020-01-23T13:49:44Z", "type": "commit"}, {"oid": "ea93d0f994b367b001dcacb40e59a6c7641240ab", "url": "https://github.com/ConsenSys/teku/commit/ea93d0f994b367b001dcacb40e59a6c7641240ab", "message": "Add beacon_proposer_index and beacon_committee caches", "committedDate": "2020-01-23T14:15:15Z", "type": "commit"}, {"oid": "3889f655f4878cf5244efe1d09e5597025a4b707", "url": "https://github.com/ConsenSys/teku/commit/3889f655f4878cf5244efe1d09e5597025a4b707", "message": "Include 10K validators case into transition benchmark", "committedDate": "2020-01-23T14:15:58Z", "type": "commit"}, {"oid": "8db2731b1e24a6056af6ad41411548eadf4b1484", "url": "https://github.com/ConsenSys/teku/commit/8db2731b1e24a6056af6ad41411548eadf4b1484", "message": "Add base_reward cache", "committedDate": "2020-01-23T15:30:54Z", "type": "commit"}, {"oid": "3c2930d6846bdc3920f050f955943311bb134b65", "url": "https://github.com/ConsenSys/teku/commit/3c2930d6846bdc3920f050f955943311bb134b65", "message": "Using HashSet.contains() in the inner loop is more effective than ArrayList.contains()", "committedDate": "2020-01-23T16:50:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM5NTc1NA==", "url": "https://github.com/ConsenSys/teku/pull/1114#discussion_r370395754", "bodyText": "One pattern we may want to consider is allowing the caller of get_unslahsed_attesting_indices decide what type of collection it wants back.\nSo it would become:\nprivate static List<Integer> get_unslashed_attesting_indices(\n      BeaconState state, List<PendingAttestation> attestations) {\n    return get_unslashed_attesting_indices(state, attestations, ArrayList::new);\n  }\n\n  private static <T extends Collection<Integer>> T get_unslashed_attesting_indices(\n      BeaconState state,\n      List<PendingAttestation> attestations,\n      final Supplier<T> collectionFactory) {\n    TreeSet<Integer> output = new TreeSet<>();\n    for (PendingAttestation a : attestations) {\n      output.addAll(get_attesting_indices(state, a.getData(), a.getAggregation_bits()));\n    }\n    List<Integer> output_list = new ArrayList<>(output);\n    return output_list.stream()\n        .filter(index -> !state.getValidators().get(index).isSlashed())\n        .collect(Collectors.toCollection(collectionFactory));\n  }\n\nThen rather than having to copy the list into a HashSet you could just pass in HashSet::new and get a HashSet back.\nFrom a quick review of where this particular method is used I think we may always want a HashSet but I may have missed somewhere that order is important. I suspect the pattern of allowing the caller to determine the returned collection type will be useful in a bunch of places though.", "author": "ajsutton", "createdAt": "2020-01-23T22:47:36Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/util/EpochProcessorUtil.java", "diffHunk": "@@ -332,8 +333,9 @@ private static UnsignedLong get_base_reward(BeaconState state, int index) {\n       List<Integer> unslashed_attesting_indices =\n           get_unslashed_attesting_indices(state, attestations);", "originalCommit": "3c2930d6846bdc3920f050f955943311bb134b65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUxNzQwOQ==", "url": "https://github.com/ConsenSys/teku/pull/1114#discussion_r370517409", "bodyText": "Yep good point \ud83d\udc4d  And thanks for the code!\nPlease check latter commits", "author": "Nashatyrev", "createdAt": "2020-01-24T08:28:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM5NTc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3OTM5Ng==", "url": "https://github.com/ConsenSys/teku/pull/1114#discussion_r370879396", "bodyText": "Yeah looks good.  btw these optimisation PRs are all still draft so I can't actually approve them.", "author": "ajsutton", "createdAt": "2020-01-24T23:02:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM5NTc1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM5Njc5MQ==", "url": "https://github.com/ConsenSys/teku/pull/1114#discussion_r370396791", "bodyText": "nit: We try to use the interface for collection types (ie Set<Integer>) in variable declarations instead of the specific implementation of HashSet. Doesn't really matter here but as things are refactored over time to extract methods etc you can wind up with specific collection types in APIs that make it harder to reuse code.", "author": "ajsutton", "createdAt": "2020-01-23T22:50:22Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/artemis/statetransition/util/EpochProcessorUtil.java", "diffHunk": "@@ -332,8 +333,9 @@ private static UnsignedLong get_base_reward(BeaconState state, int index) {\n       List<Integer> unslashed_attesting_indices =\n           get_unslashed_attesting_indices(state, attestations);\n       UnsignedLong attesting_balance = get_total_balance(state, unslashed_attesting_indices);\n+      HashSet<Integer> unslashed_attesting_indices_set = new HashSet<>(unslashed_attesting_indices);", "originalCommit": "3c2930d6846bdc3920f050f955943311bb134b65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUxNzAzOQ==", "url": "https://github.com/ConsenSys/teku/pull/1114#discussion_r370517039", "bodyText": "You are right. That was just IDEA code assist :)\nHowever this is not relevant any more", "author": "Nashatyrev", "createdAt": "2020-01-24T08:27:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM5Njc5MQ=="}], "type": "inlineReview"}, {"oid": "61580fe6d1b90e8b4a0e45569073368d7a243540", "url": "https://github.com/ConsenSys/teku/commit/61580fe6d1b90e8b4a0e45569073368d7a243540", "message": "get_total_balance: widen parameter type from List to Collection since the order doesn't matter here.\nUse more laconic enhanced for statement instead of explicit Iterator.", "committedDate": "2020-01-24T08:23:01Z", "type": "commit"}, {"oid": "90c33df2913b35378c20a6278d4c2401b564a771", "url": "https://github.com/ConsenSys/teku/commit/90c33df2913b35378c20a6278d4c2401b564a771", "message": "get_unslashed_attesting_indices: can now create and return any Collection implementation.\nThis is to avoid unnecessary copying", "committedDate": "2020-01-24T08:25:06Z", "type": "commit"}, {"oid": "0d3626d3c658290c86f3db45d1504f6291ef391c", "url": "https://github.com/ConsenSys/teku/commit/0d3626d3c658290c86f3db45d1504f6291ef391c", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-list-to-set", "committedDate": "2020-01-24T08:25:19Z", "type": "commit"}, {"oid": "a3d3e5407c9153fb6d8b1d72028644719ebd062c", "url": "https://github.com/ConsenSys/teku/commit/a3d3e5407c9153fb6d8b1d72028644719ebd062c", "message": "Merge remote-tracking branch 'pegasys/master' into optimize-cache-base-reward\n\n# Conflicts:\n#\teth-benchmark-tests/src/jmh/resources/blocks/blocks_epoch_6_validators_10240.ssz.gz\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/state/TransitionCaches.java\n#\tethereum/datastructures/src/main/java/tech/pegasys/artemis/datastructures/util/cache/LRUCache.java", "committedDate": "2020-01-28T11:38:35Z", "type": "commit"}, {"oid": "79a23a435d0b6ed863979461b08e438f11638fa7", "url": "https://github.com/ConsenSys/teku/commit/79a23a435d0b6ed863979461b08e438f11638fa7", "message": "Merge branch 'optimize-cache-base-reward' into optimize-list-to-set", "committedDate": "2020-01-28T18:10:12Z", "type": "commit"}, {"oid": "60de780a3f491661a6d47cead21600adc3b4385e", "url": "https://github.com/ConsenSys/teku/commit/60de780a3f491661a6d47cead21600adc3b4385e", "message": "Merge branch 'master' into optimize-list-to-set", "committedDate": "2020-01-28T18:13:41Z", "type": "commit"}]}