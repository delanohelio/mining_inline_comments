{"pr_number": 1403, "pr_title": "Fix exception when Eth1DataCache prunes all the data it contains", "pr_createdAt": "2020-03-18T03:53:11Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1403", "timeline": [{"oid": "87297f2c1540221b1e8adf691b30a10b927d58b5", "url": "https://github.com/ConsenSys/teku/commit/87297f2c1540221b1e8adf691b30a10b927d58b5", "message": "Fix exception when Eth1DataCache prunes all the data it contains.", "committedDate": "2020-03-18T03:51:22Z", "type": "commit"}, {"oid": "aa08c115ed8506aae3104ba4e50a4353528ad503", "url": "https://github.com/ConsenSys/teku/commit/aa08c115ed8506aae3104ba4e50a4353528ad503", "message": "Use orElseThrow instead of separate check.", "committedDate": "2020-03-18T04:22:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMyMjM3OA==", "url": "https://github.com/ConsenSys/teku/pull/1403#discussion_r394322378", "bodyText": "neat", "author": "cemozerr", "createdAt": "2020-03-18T12:52:29Z", "path": "validator/coordinator/src/main/java/tech/pegasys/artemis/validator/coordinator/Eth1DataCache.java", "diffHunk": "@@ -153,9 +151,10 @@ private UnsignedLong secondsBeforeCurrentVotingPeriodStartTime(\n   }\n \n   private UnsignedLong computeTimeAtSlot(UnsignedLong slot) {\n-    if (genesisTime.isEmpty())\n-      throw new RuntimeException(\"computeTimeAtSlot called without genesisTime being set\");\n-    return genesisTime.get().plus(slot.times(UnsignedLong.valueOf(Constants.SECONDS_PER_SLOT)));\n+    return genesisTime\n+        .orElseThrow(", "originalCommit": "aa08c115ed8506aae3104ba4e50a4353528ad503", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMyNDcyNg==", "url": "https://github.com/ConsenSys/teku/pull/1403#discussion_r394324726", "bodyText": "The comment here is misleading. This cacheEth1BlockEvent3 is still inside the current voting period, and that's why it gets cleaned up.", "author": "cemozerr", "createdAt": "2020-03-18T12:56:24Z", "path": "validator/coordinator/src/test/java/tech/pegasys/artemis/validator/coordinator/Eth1DataCacheTest.java", "diffHunk": "@@ -288,6 +288,30 @@ void pruneAfterGenesis() {\n     assertThat(eth1DataCache.getMapForTesting().values()).containsExactly(eth1Data3);\n   }\n \n+  @Test\n+  void pruneAllBlockData() {\n+    eth1DataCache.startBeaconChainMode(genesisState);\n+    eth1DataCache.onSlot(new SlotEvent(START_SLOT));\n+\n+    // First two Eth1Data timestamps inside the spec range for this voting period\n+    CacheEth1BlockEvent cacheEth1BlockEvent1 =\n+        createRandomCacheEth1BlockEvent(UnsignedLong.valueOf(359));\n+    CacheEth1BlockEvent cacheEth1BlockEvent2 =\n+        createRandomCacheEth1BlockEvent(UnsignedLong.valueOf(360));\n+\n+    // This Eth1Data timestamp inside the spec range for the next voting period", "originalCommit": "aa08c115ed8506aae3104ba4e50a4353528ad503", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bf2d2643b51538306215824772d7e70665806e3f", "url": "https://github.com/ConsenSys/teku/commit/bf2d2643b51538306215824772d7e70665806e3f", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into handle-removing-all-eth1-data", "committedDate": "2020-03-18T21:13:57Z", "type": "commit"}, {"oid": "244ab8f041f2d4aefe22336ed4901568c9636317", "url": "https://github.com/ConsenSys/teku/commit/244ab8f041f2d4aefe22336ed4901568c9636317", "message": "Fix comment.", "committedDate": "2020-03-18T21:14:42Z", "type": "commit"}]}