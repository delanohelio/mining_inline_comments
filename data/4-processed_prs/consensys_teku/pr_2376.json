{"pr_number": 2376, "pr_title": "Extract BLS interfaces for pluggable implementations", "pr_createdAt": "2020-07-17T10:52:13Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2376", "timeline": [{"oid": "7fd531bb735616406bdab6f72bfccdf8ecaf621d", "url": "https://github.com/ConsenSys/teku/commit/7fd531bb735616406bdab6f72bfccdf8ecaf621d", "message": "Initial draft for BLS interfaces", "committedDate": "2020-07-16T18:02:55Z", "type": "commit"}, {"oid": "69300d6d746f78fa517e2f43c8da168adf84b450", "url": "https://github.com/ConsenSys/teku/commit/69300d6d746f78fa517e2f43c8da168adf84b450", "message": "exclude outdated junit transitive dependency from json-simple module", "committedDate": "2020-07-16T19:02:44Z", "type": "commit"}, {"oid": "8724e7f1e9d3bbff924de56ee13f0e83e47521ef", "url": "https://github.com/ConsenSys/teku/commit/8724e7f1e9d3bbff924de56ee13f0e83e47521ef", "message": "Rename test file to Win compatible", "committedDate": "2020-07-16T20:06:23Z", "type": "commit"}, {"oid": "84691cd609aed1ee0aa357b8c33dad7b152aa45b", "url": "https://github.com/ConsenSys/teku/commit/84691cd609aed1ee0aa357b8c33dad7b152aa45b", "message": "Merge branch 'fix-bls-tests-1' into feature-bls-interfaces", "committedDate": "2020-07-16T20:23:20Z", "type": "commit"}, {"oid": "a8bafde8097d10593540eb8c0270bae987d62107", "url": "https://github.com/ConsenSys/teku/commit/a8bafde8097d10593540eb8c0270bae987d62107", "message": "Another portion of draft changes", "committedDate": "2020-07-17T10:49:19Z", "type": "commit"}, {"oid": "b5762f4aee4b16a48a31b7ac859eabdf527eba07", "url": "https://github.com/ConsenSys/teku/commit/b5762f4aee4b16a48a31b7ac859eabdf527eba07", "message": "Adjust bls tests by separating them to abstract and implementation specific", "committedDate": "2020-07-17T13:01:37Z", "type": "commit"}, {"oid": "27aace71b79d77d6391efb4e797039e8be085abd", "url": "https://github.com/ConsenSys/teku/commit/27aace71b79d77d6391efb4e797039e8be085abd", "message": "Add NoopBLS12381 implementation", "committedDate": "2020-07-17T13:18:31Z", "type": "commit"}, {"oid": "5f93ac4be839856ed8ce4982d1c608ef08d70929", "url": "https://github.com/ConsenSys/teku/commit/5f93ac4be839856ed8ce4982d1c608ef08d70929", "message": "Fix warnings", "committedDate": "2020-07-17T13:24:24Z", "type": "commit"}, {"oid": "7c4faf635ea6915804b85790653e329101568426", "url": "https://github.com/ConsenSys/teku/commit/7c4faf635ea6915804b85790653e329101568426", "message": "Fix more warns", "committedDate": "2020-07-17T13:33:17Z", "type": "commit"}, {"oid": "c221980d33528bc0e081a9445d2ba7af6df2c3fe", "url": "https://github.com/ConsenSys/teku/commit/c221980d33528bc0e081a9445d2ba7af6df2c3fe", "message": "Merge remote-tracking branch 'pegasys/master' into feature-bls-interfaces\n\n# Conflicts:\n#\tbls/src/main/java/tech/pegasys/teku/bls/BLS.java\n#\tbls/src/main/java/tech/pegasys/teku/bls/BLSPublicKey.java\n#\tbls/src/test/java/tech/pegasys/teku/bls/BLSPublicKeyTest.java\n#\tdata/provider/src/main/java/tech/pegasys/teku/api/schema/BLSPubKey.java", "committedDate": "2020-07-17T13:37:37Z", "type": "commit"}, {"oid": "8c41c8d8a21a6be79118bac9892cdbca6f02ab9b", "url": "https://github.com/ConsenSys/teku/commit/8c41c8d8a21a6be79118bac9892cdbca6f02ab9b", "message": "Resolve merge conflicts", "committedDate": "2020-07-17T13:55:44Z", "type": "commit"}, {"oid": "aab091f6a18e7a86df5b45d5a6f2cddeb9244205", "url": "https://github.com/ConsenSys/teku/commit/aab091f6a18e7a86df5b45d5a6f2cddeb9244205", "message": "Fix the test", "committedDate": "2020-07-17T14:39:45Z", "type": "commit"}, {"oid": "2040313237e184415e6ec626704ca5946ab045c3", "url": "https://github.com/ConsenSys/teku/commit/2040313237e184415e6ec626704ca5946ab045c3", "message": "Fix the test", "committedDate": "2020-07-20T10:54:35Z", "type": "commit"}, {"oid": "69313d7198d78bec898b98c1d3d932c72bedf9bd", "url": "https://github.com/ConsenSys/teku/commit/69313d7198d78bec898b98c1d3d932c72bedf9bd", "message": "Merge remote-tracking branch 'pegasys/master' into feature-bls-interfaces", "committedDate": "2020-07-20T11:10:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUxNDg1MA==", "url": "https://github.com/ConsenSys/teku/pull/2376#discussion_r457514850", "bodyText": "Any particular reason to use a single instance here?  We should probably make the constructor private if we're going to use this pattern.", "author": "mbaxter", "createdAt": "2020-07-20T15:52:22Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/impl/mikuli/MikuliBLS12381.java", "diffHunk": "@@ -46,8 +52,9 @@\n  * <p>Apache Milagro can be included using the gradle dependency\n  * 'org.miracl.milagro.amcl:milagro-crypto-java'.\n  */\n-public final class BLS12381 {\n+public class MikuliBLS12381 implements BLS12381 {\n \n+  public static final MikuliBLS12381 INSTANCE = new MikuliBLS12381();", "originalCommit": "69313d7198d78bec898b98c1d3d932c72bedf9bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU4NDU3Mg==", "url": "https://github.com/ConsenSys/teku/pull/2376#discussion_r457584572", "bodyText": "Yes, did the private constructor. \ud83d\udc4d\nNot sure what do you mean regarding this singleton pattern?", "author": "Nashatyrev", "createdAt": "2020-07-20T17:45:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUxNDg1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU4NzU0Ng==", "url": "https://github.com/ConsenSys/teku/pull/2376#discussion_r457587546", "bodyText": "Just curious - wondering why we need the singleton pattern.  Not saying we should change this.", "author": "mbaxter", "createdAt": "2020-07-20T17:50:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUxNDg1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYwNTI4MA==", "url": "https://github.com/ConsenSys/teku/pull/2376#discussion_r457605280", "bodyText": "Cause it's stateless and I don't think anyone would need several instances. Singleton is more explicit in that respect imho.", "author": "Nashatyrev", "createdAt": "2020-07-20T18:22:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUxNDg1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUyNTA2MQ==", "url": "https://github.com/ConsenSys/teku/pull/2376#discussion_r457525061", "bodyText": "Instead of assuming these keys are a specific type, what if we have a static helper method MikuliPublicKey.create() that either casts and returns the signature or creates a new signature of the right type?", "author": "mbaxter", "createdAt": "2020-07-20T16:05:40Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/impl/mikuli/MikuliBLS12381.java", "diffHunk": "@@ -199,25 +216,50 @@ public static boolean coreAggregateVerify(\n    *\n    * @return the pair of values above in an opaque instance\n    */\n-  public static BatchSemiAggregate prepareBatchVerify(\n-      int index, List<PublicKey> publicKeys, Bytes message, Signature signature) {\n-\n+  @Override\n+  public BatchSemiAggregate prepareBatchVerify(\n+      int index, List<? extends PublicKey> publicKeys, Bytes message, Signature signature) {\n     G2Point sigG2Point;\n     G2Point msgG2Point;\n+\n+    List<MikuliPublicKey> mikuliPublicKeys =\n+        publicKeys.stream().map(pk -> (MikuliPublicKey) pk).collect(Collectors.toList());", "originalCommit": "69313d7198d78bec898b98c1d3d932c72bedf9bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYwMjIyMw==", "url": "https://github.com/ConsenSys/teku/pull/2376#discussion_r457602223", "bodyText": "Yes, good idea, however I would avoid scenarios when different implementations are used simultaneously.\nBTW, did I got your idea right? : 198f872", "author": "Nashatyrev", "createdAt": "2020-07-20T18:16:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUyNTA2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYxNTI0NQ==", "url": "https://github.com/ConsenSys/teku/pull/2376#discussion_r457615245", "bodyText": "yep - looks good! \ud83c\udf89\nI think there are a few more spots where we cast that can be replaced with the new helpers:\n\nhttps://github.com/PegaSysEng/teku/blob/198f872611fb6d5452009114eac4e3b70120439e/bls/src/main/java/tech/pegasys/teku/bls/impl/mikuli/MikuliBLS12381.java#L230\nhttps://github.com/PegaSysEng/teku/blob/198f872611fb6d5452009114eac4e3b70120439e/bls/src/main/java/tech/pegasys/teku/bls/impl/mikuli/MikuliBLS12381.java#L262\nhttps://github.com/PegaSysEng/teku/blob/198f872611fb6d5452009114eac4e3b70120439e/bls/src/main/java/tech/pegasys/teku/bls/impl/mikuli/MikuliBLS12381.java#L265", "author": "mbaxter", "createdAt": "2020-07-20T18:40:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUyNTA2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYzMTczNw==", "url": "https://github.com/ConsenSys/teku/pull/2376#discussion_r457631737", "bodyText": "Oh, right! Done!\nThought I've spotted all casts", "author": "Nashatyrev", "createdAt": "2020-07-20T19:09:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUyNTA2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU2MzYyMA==", "url": "https://github.com/ConsenSys/teku/pull/2376#discussion_r457563620", "bodyText": "Do we need this?  Seems potentially dangerous ...", "author": "mbaxter", "createdAt": "2020-07-20T17:08:56Z", "path": "bls/src/main/java/tech/pegasys/teku/bls/BLSSecretKey.java", "diffHunk": "@@ -79,4 +74,9 @@ public boolean equals(final Object o) {\n   public int hashCode() {\n     return Objects.hash(secretKey);\n   }\n+\n+  @Override\n+  public String toString() {\n+    return \"BLSSecretKey{\" + toBytes() + '}';", "originalCommit": "69313d7198d78bec898b98c1d3d932c72bedf9bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU4NTE2NA==", "url": "https://github.com/ConsenSys/teku/pull/2376#discussion_r457585164", "bodyText": "Yes, agree, it's dangerous indeed", "author": "Nashatyrev", "createdAt": "2020-07-20T17:46:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU2MzYyMA=="}], "type": "inlineReview"}, {"oid": "0f52af3ffd9cfd2056209232365ba9d0d0af532e", "url": "https://github.com/ConsenSys/teku/commit/0f52af3ffd9cfd2056209232365ba9d0d0af532e", "message": "Make singleton constructor private", "committedDate": "2020-07-20T17:42:55Z", "type": "commit"}, {"oid": "cdd7a380e55372520a0599eeabc5aea4fd5c107d", "url": "https://github.com/ConsenSys/teku/commit/cdd7a380e55372520a0599eeabc5aea4fd5c107d", "message": "Remove BLSSecretKey.toString() as might be dangerous", "committedDate": "2020-07-20T17:47:09Z", "type": "commit"}, {"oid": "198f872611fb6d5452009114eac4e3b70120439e", "url": "https://github.com/ConsenSys/teku/commit/198f872611fb6d5452009114eac4e3b70120439e", "message": "Fallback to creating MikuliPublickKey and MikuliSignature from bytes when passed instance is not of Mikuli type", "committedDate": "2020-07-20T17:58:24Z", "type": "commit"}, {"oid": "000e6d51ca34b8b84315fc27133ae54f365ab2dd", "url": "https://github.com/ConsenSys/teku/commit/000e6d51ca34b8b84315fc27133ae54f365ab2dd", "message": "Apply spotless", "committedDate": "2020-07-20T18:14:34Z", "type": "commit"}, {"oid": "677d313834bb17fd3a7c9777fe054b0ea5fffda5", "url": "https://github.com/ConsenSys/teku/commit/677d313834bb17fd3a7c9777fe054b0ea5fffda5", "message": "Make MikuliBLS12381 constructor protected since the NoopBLS12381 is derived", "committedDate": "2020-07-20T18:19:22Z", "type": "commit"}, {"oid": "832d7c068112f9993d25383e9cf79212bc14768d", "url": "https://github.com/ConsenSys/teku/commit/832d7c068112f9993d25383e9cf79212bc14768d", "message": "Use MikuliSignature.fromSignature instead of cast", "committedDate": "2020-07-20T19:09:20Z", "type": "commit"}, {"oid": "d7497b1f936ac2917c6eb86e1a132d23052663b6", "url": "https://github.com/ConsenSys/teku/commit/d7497b1f936ac2917c6eb86e1a132d23052663b6", "message": "Merge remote-tracking branch 'pegasys/master' into feature-bls-interfaces", "committedDate": "2020-07-20T19:10:13Z", "type": "commit"}, {"oid": "23d706a0821e197726fb388c40c42cf1f51d8790", "url": "https://github.com/ConsenSys/teku/commit/23d706a0821e197726fb388c40c42cf1f51d8790", "message": "Add log warning that BLS verification is disables for NoopBLS12381", "committedDate": "2020-07-21T10:32:57Z", "type": "commit"}, {"oid": "d63ed79997139f16bc96c5f532d691bada6a5ead", "url": "https://github.com/ConsenSys/teku/commit/d63ed79997139f16bc96c5f532d691bada6a5ead", "message": "Merge remote-tracking branch 'pegasys/master' into feature-bls-interfaces", "committedDate": "2020-07-21T10:33:03Z", "type": "commit"}]}