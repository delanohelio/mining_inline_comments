{"pr_number": 1335, "pr_title": "Multithreaded channels", "pr_createdAt": "2020-03-10T00:06:13Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1335", "timeline": [{"oid": "1d5d34717e432825fe1adde507422809055d48cb", "url": "https://github.com/ConsenSys/teku/commit/1d5d34717e432825fe1adde507422809055d48cb", "message": "Add annotation based approach to setting threads.", "committedDate": "2020-03-09T23:57:15Z", "type": "commit"}, {"oid": "86e42d38bf392509bb46bbf4ea591b7d3e6b4464", "url": "https://github.com/ConsenSys/teku/commit/86e42d38bf392509bb46bbf4ea591b7d3e6b4464", "message": "Switch to specifying the number of threads per subscriber, instead of per channel.", "committedDate": "2020-03-09T23:57:15Z", "type": "commit"}, {"oid": "d30f84cbea44968e56b8e7941500918a580a51db", "url": "https://github.com/ConsenSys/teku/commit/d30f84cbea44968e56b8e7941500918a580a51db", "message": "Undo more changes.", "committedDate": "2020-03-10T00:05:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQyMzk3MA==", "url": "https://github.com/ConsenSys/teku/pull/1335#discussion_r390423970", "bodyText": "(nit) Might be worth some javadoc that explains numberOfThreads will be used at the discretion of the specific implementation as the target degree of processing parallelism or something like that.\nPossibly we could rename to something like:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void subscribeMultithreaded(final T listener, final int numberOfThreads) {\n          \n          \n            \n              public void subscribe(final T listener, final int requestedParallelism) {\n          \n      \n    \n    \n  \n\nwhich is more generic, although maybe more obscure \ud83e\udd37\u200d\u2640", "author": "mbaxter", "createdAt": "2020-03-10T15:58:21Z", "path": "events/src/main/java/tech/pegasys/artemis/events/EventChannel.java", "diffHunk": "@@ -134,11 +134,16 @@ public T getPublisher() {\n     return publisher;\n   }\n \n-  public void subscribe(T listener) {\n+  public void subscribe(final T listener) {\n+    subscribeMultithreaded(listener, 1);\n+  }\n+\n+  public void subscribeMultithreaded(final T listener, final int numberOfThreads) {", "originalCommit": "d30f84cbea44968e56b8e7941500918a580a51db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY0OTc5NQ==", "url": "https://github.com/ConsenSys/teku/pull/1335#discussion_r390649795", "bodyText": "I've added some java doc.  I'm not too concerned about the fact that the number of threads is ignored for synchronous channels because we should only use those for testing anyway.\nI'm also more concerned that we'll accidentally make something multithreaded than that it will be single threaded.  So have stuck with subscribeMultithreaded as the name so it's really clear.", "author": "ajsutton", "createdAt": "2020-03-10T22:32:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQyMzk3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQyOTY0Nw==", "url": "https://github.com/ConsenSys/teku/pull/1335#discussion_r390429647", "bodyText": "I think spying on started1 and saying verify(started1).await() would be more clear here,  because the constants and the time unit makes the reader go look for other constants.", "author": "cemozerr", "createdAt": "2020-03-10T16:06:02Z", "path": "events/src/test/java/tech/pegasys/artemis/events/EventChannelTest.java", "diffHunk": "@@ -183,6 +196,54 @@ public void shouldDeliverEventsAsync() throws Exception {\n     inOrder.verifyNoMoreInteractions();\n   }\n \n+  @Test\n+  public void shouldDeliverAsyncEventsOnMultipleThreads() throws Exception {\n+    executor =\n+        Executors.newCachedThreadPool(\n+            new ThreadFactoryBuilder()\n+                .setDaemon(true)\n+                .setNameFormat(\"shoudlDeliverAsyncEventsOnMultipleThreads-%d\")\n+                .build());\n+    final EventChannel<WaitOnLatch> channel =\n+        EventChannel.createAsync(WaitOnLatch.class, executor, metricsSystem);\n+    final WaitOnLatch subscriber =\n+        (started, await, completed) -> {\n+          started.countDown();\n+          try {\n+            await.await();\n+            completed.countDown();\n+          } catch (InterruptedException e) {\n+            throw new RuntimeException(e);\n+          }\n+        };\n+    channel.subscribeMultithreaded(subscriber, 2); // Two subscribing threads\n+\n+    final CountDownLatch started1 = new CountDownLatch(1);\n+    final CountDownLatch await1 = new CountDownLatch(1);\n+    final CountDownLatch completed1 = new CountDownLatch(1);\n+    final CountDownLatch started2 = new CountDownLatch(1);\n+    final CountDownLatch await2 = new CountDownLatch(1);\n+    final CountDownLatch completed2 = new CountDownLatch(1);\n+\n+    // Publish two events\n+    channel.getPublisher().waitFor(started1, await1, completed1);\n+    channel.getPublisher().waitFor(started2, await2, completed2);\n+\n+    // Both events should start being processed\n+    assertThat(started1.await(5, TimeUnit.SECONDS)).isTrue();", "originalCommit": "d30f84cbea44968e56b8e7941500918a580a51db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY1MDY2Mw==", "url": "https://github.com/ConsenSys/teku/pull/1335#discussion_r390650663", "bodyText": "You can't use a spy in this case because the test is multithreaded and mockito is generally not thread safe.  I've extracted a private method to make it more readable though.", "author": "ajsutton", "createdAt": "2020-03-10T22:35:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQyOTY0Nw=="}], "type": "inlineReview"}, {"oid": "c044f5816ac71ae3b4283d492e05fc96f4be929a", "url": "https://github.com/ConsenSys/teku/commit/c044f5816ac71ae3b4283d492e05fc96f4be929a", "message": "Merge branch 'master' into multithreaded-channels", "committedDate": "2020-03-10T21:18:58Z", "type": "commit"}, {"oid": "729a87401e2795e8c9c0222be85cfd1de3997126", "url": "https://github.com/ConsenSys/teku/commit/729a87401e2795e8c9c0222be85cfd1de3997126", "message": "Add javadoc.", "committedDate": "2020-03-10T22:29:25Z", "type": "commit"}, {"oid": "8f57c90db987fd72242d3834805d2bb7e810f613", "url": "https://github.com/ConsenSys/teku/commit/8f57c90db987fd72242d3834805d2bb7e810f613", "message": "More javadoc.", "committedDate": "2020-03-10T22:30:33Z", "type": "commit"}, {"oid": "bf283db26c109d7fec61413820f02b5dc4e911c5", "url": "https://github.com/ConsenSys/teku/commit/bf283db26c109d7fec61413820f02b5dc4e911c5", "message": "Merge branch 'multithreaded-channels' of github.com:ajsutton/teku into multithreaded-channels", "committedDate": "2020-03-10T22:30:38Z", "type": "commit"}, {"oid": "5b2ddb440dbc812bdee7ab24e310d1a0b5b2b834", "url": "https://github.com/ConsenSys/teku/commit/5b2ddb440dbc812bdee7ab24e310d1a0b5b2b834", "message": "Extract private method for readability.", "committedDate": "2020-03-10T22:35:04Z", "type": "commit"}, {"oid": "068dfcd49f0e9113e5197eeaf2ee77d7a543d789", "url": "https://github.com/ConsenSys/teku/commit/068dfcd49f0e9113e5197eeaf2ee77d7a543d789", "message": "Merge branch 'master' into multithreaded-channels", "committedDate": "2020-03-10T22:36:57Z", "type": "commit"}]}