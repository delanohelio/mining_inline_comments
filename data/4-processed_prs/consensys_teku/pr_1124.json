{"pr_number": 1124, "pr_title": "Use EventChannels for deposits", "pr_createdAt": "2020-01-30T05:54:34Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1124", "timeline": [{"oid": "b58b5685bd5bbd7e8433dfda5cd4e10cb879e18b", "url": "https://github.com/ConsenSys/teku/commit/b58b5685bd5bbd7e8433dfda5cd4e10cb879e18b", "message": "Implement EventChannel as an alternative to EventBus.", "committedDate": "2020-01-22T05:26:47Z", "type": "commit"}, {"oid": "068054c7de7130f6d763ac1a8d8d072d8b3eedd9", "url": "https://github.com/ConsenSys/teku/commit/068054c7de7130f6d763ac1a8d8d072d8b3eedd9", "message": "Simple demonstration of using EventChannel by switching time events over to it.", "committedDate": "2020-01-22T05:36:58Z", "type": "commit"}, {"oid": "9f4f17f7cba665517246dce6af3895af48d48c91", "url": "https://github.com/ConsenSys/teku/commit/9f4f17f7cba665517246dce6af3895af48d48c91", "message": "Switch order.", "committedDate": "2020-01-22T21:30:28Z", "type": "commit"}, {"oid": "f58c94958a769d3ce0f5db30572bc2e9c2c691bd", "url": "https://github.com/ConsenSys/teku/commit/f58c94958a769d3ce0f5db30572bc2e9c2c691bd", "message": "Merge branch 'master' of github.com:PegaSysEng/artemis into typed-events", "committedDate": "2020-01-29T22:56:13Z", "type": "commit"}, {"oid": "9ec32f42386cdad62afb09d7c3ff9c63bbbe7cce", "url": "https://github.com/ConsenSys/teku/commit/9ec32f42386cdad62afb09d7c3ff9c63bbbe7cce", "message": "Add EventChannels class to manage a group of channels.", "committedDate": "2020-01-29T23:42:37Z", "type": "commit"}, {"oid": "5f87a5317e547a452d715986593f3e8776250301", "url": "https://github.com/ConsenSys/teku/commit/5f87a5317e547a452d715986593f3e8776250301", "message": "Support custom exception handlers.", "committedDate": "2020-01-30T00:16:49Z", "type": "commit"}, {"oid": "de54574f8487ca51a40579c80ce9b5e641821f20", "url": "https://github.com/ConsenSys/teku/commit/de54574f8487ca51a40579c80ce9b5e641821f20", "message": "Set stopped correctly.", "committedDate": "2020-01-30T04:24:52Z", "type": "commit"}, {"oid": "ac7ecf912137d9408ece588eb07ab009b7092029", "url": "https://github.com/ConsenSys/teku/commit/ac7ecf912137d9408ece588eb07ab009b7092029", "message": "Remove unused variables.", "committedDate": "2020-01-30T04:25:06Z", "type": "commit"}, {"oid": "0ad7804eb26ce3fcf73391ecac6e289c65299551", "url": "https://github.com/ConsenSys/teku/commit/0ad7804eb26ce3fcf73391ecac6e289c65299551", "message": "Back to event bus for time events, but use EventChannel for deposit events.", "committedDate": "2020-01-30T04:26:49Z", "type": "commit"}, {"oid": "7cf8fa91c958854f7f227856ce3e3e753a22bde2", "url": "https://github.com/ConsenSys/teku/commit/7cf8fa91c958854f7f227856ce3e3e753a22bde2", "message": "Use this prefix.", "committedDate": "2020-01-30T04:46:27Z", "type": "commit"}, {"oid": "216fe143a3978daf9ee8c339cefabe455c943364", "url": "https://github.com/ConsenSys/teku/commit/216fe143a3978daf9ee8c339cefabe455c943364", "message": "Use same exception handler as for event bus.", "committedDate": "2020-01-30T04:59:13Z", "type": "commit"}, {"oid": "2a01c79c5975f2d287d57a93b82ae853347606d6", "url": "https://github.com/ConsenSys/teku/commit/2a01c79c5975f2d287d57a93b82ae853347606d6", "message": "Fix failures.", "committedDate": "2020-01-30T06:00:42Z", "type": "commit"}, {"oid": "1fb3891ef238d77668e10a33e5d9e01aa1b4e0af", "url": "https://github.com/ConsenSys/teku/commit/1fb3891ef238d77668e10a33e5d9e01aa1b4e0af", "message": "Fix test.", "committedDate": "2020-01-30T06:05:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE2MTAxMg==", "url": "https://github.com/ConsenSys/teku/pull/1124#discussion_r373161012", "bodyText": "Why do you do this call? It seems a bit unnecessary, to make sure the number of arguments is correct?", "author": "cemozerr", "createdAt": "2020-01-30T19:53:56Z", "path": "events/src/main/java/tech/pegasys/artemis/events/EventDeliverer.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.events;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import tech.pegasys.artemis.util.events.Subscribers;\n+\n+abstract class EventDeliverer<T> implements InvocationHandler {\n+  private final Subscribers<T> subscribers = Subscribers.create(true);\n+\n+  void subscribe(T subscriber) {\n+    subscribers.subscribe(subscriber);\n+  }\n+\n+  @Override\n+  public Object invoke(final Object proxy, final Method method, final Object[] args) {\n+    if (method.getDeclaringClass().equals(Object.class)) {\n+      try {\n+        return method.invoke(this, args);", "originalCommit": "1fb3891ef238d77668e10a33e5d9e01aa1b4e0af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE2NDk1OQ==", "url": "https://github.com/ConsenSys/teku/pull/1124#discussion_r373164959", "bodyText": "So there are two sources of methods for an interface - those declared by the interface itself and those inherited from Object.  We only want to post events for the methods declared by the interface itself because the methods from Object require return values which we don't handle.\nSo for any method that's declared in the Object class we invoke the method on this which is the generated proxy object. Thus it winds up executing the default implementation fo those methods from Object.", "author": "ajsutton", "createdAt": "2020-01-30T20:02:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE2MTAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE4MzYwOA==", "url": "https://github.com/ConsenSys/teku/pull/1124#discussion_r373183608", "bodyText": "Gotcha, makes sense.", "author": "cemozerr", "createdAt": "2020-01-30T20:43:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE2MTAxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE2NzAzNA==", "url": "https://github.com/ConsenSys/teku/pull/1124#discussion_r373167034", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void shouldGetPublisherBeforeSubscriber() {\n          \n          \n            \n              public void shouldBeAbleToGetPublisherBeforeSubscriber() {", "author": "mbaxter", "createdAt": "2020-01-30T20:06:56Z", "path": "events/src/test/java/tech/pegasys/artemis/events/EventChannelsTest.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.artemis.events;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.verifyNoInteractions;\n+import static org.mockito.Mockito.verifyNoMoreInteractions;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class EventChannelsTest {\n+  private final EventChannels channels = new EventChannels(EventChannel::create);\n+\n+  @Test\n+  public void shouldGetPublisherBeforeSubscriber() {", "originalCommit": "1fb3891ef238d77668e10a33e5d9e01aa1b4e0af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ce418a53ea8579b14b1c1678e068dd430eaefc83", "url": "https://github.com/ConsenSys/teku/commit/ce418a53ea8579b14b1c1678e068dd430eaefc83", "message": "Rename test.\n\nCo-Authored-By: mbaxter <meredith.baxter@consensys.net>", "committedDate": "2020-01-30T20:58:27Z", "type": "commit"}, {"oid": "c1560c79c36ea42964da5d7cd1d3f89a3a3ad17a", "url": "https://github.com/ConsenSys/teku/commit/c1560c79c36ea42964da5d7cd1d3f89a3a3ad17a", "message": "Merge branch 'master' into typed-events", "committedDate": "2020-01-30T20:58:35Z", "type": "commit"}]}