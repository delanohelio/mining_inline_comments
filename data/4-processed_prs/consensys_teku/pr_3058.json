{"pr_number": 3058, "pr_title": "Add simple handling for rate limiting responses", "pr_createdAt": "2020-10-22T23:53:53Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3058", "timeline": [{"oid": "5e71fc098d927fb4d05463ba7e10511bb948959a", "url": "https://github.com/ConsenSys/teku/commit/5e71fc098d927fb4d05463ba7e10511bb948959a", "message": "Add simple handling for rate limiting responses by retrying after a 2 second delay.", "committedDate": "2020-10-22T23:52:02Z", "type": "commit"}, {"oid": "7247ea3cd3fbbdb93f456bfeedfaea5e8856c530", "url": "https://github.com/ConsenSys/teku/commit/7247ea3cd3fbbdb93f456bfeedfaea5e8856c530", "message": "Limit the number of retries because of 429 responses.", "committedDate": "2020-10-23T00:18:10Z", "type": "commit"}, {"oid": "d3acd5de72bb9562c5181ca0c38ae48adf23c7a9", "url": "https://github.com/ConsenSys/teku/commit/d3acd5de72bb9562c5181ca0c38ae48adf23c7a9", "message": "Fix test.", "committedDate": "2020-10-23T00:20:37Z", "type": "commit"}, {"oid": "399321d0d74cd184371dc78fa57bc66f873e7e04", "url": "https://github.com/ConsenSys/teku/commit/399321d0d74cd184371dc78fa57bc66f873e7e04", "message": "Sportless.", "committedDate": "2020-10-23T00:21:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUzNjIxNQ==", "url": "https://github.com/ConsenSys/teku/pull/3058#discussion_r510536215", "bodyText": "nit Beacon node has warned that we're making too many requests. Retrying after delay.", "author": "rolfyone", "createdAt": "2020-10-23T00:46:23Z", "path": "validator/remote/src/main/java/tech/pegasys/teku/validator/remote/RemoteValidatorApiHandler.java", "diffHunk": "@@ -299,8 +304,36 @@ public void subscribeToPersistentSubnets(final Set<SubnetSubscription> subnetSub\n                         s.getSubnetId(), s.getUnsubscriptionSlot()))\n             .collect(Collectors.toSet());\n \n-    asyncRunner\n-        .runAsync(() -> apiClient.subscribeToPersistentSubnets(schemaSubscriptions))\n+    sendRequest(() -> apiClient.subscribeToPersistentSubnets(schemaSubscriptions))\n         .finish(error -> LOG.error(\"Failed to subscribe to persistent subnets\", error));\n   }\n+\n+  private SafeFuture<Void> sendRequest(final ExceptionThrowingRunnable requestExecutor) {\n+    return sendRequest(\n+        () -> {\n+          requestExecutor.run();\n+          return null;\n+        });\n+  }\n+\n+  private <T> SafeFuture<T> sendRequest(final ExceptionThrowingSupplier<T> requestExecutor) {\n+    return asyncRunner.runAsync(() -> sendRequest(requestExecutor, 0));\n+  }\n+\n+  private <T> SafeFuture<T> sendRequest(\n+      final ExceptionThrowingSupplier<T> requestExecutor, final int attempt) {\n+    return SafeFuture.of(requestExecutor)\n+        .exceptionallyCompose(\n+            error -> {\n+              if (Throwables.getRootCause(error) instanceof RateLimitedException\n+                  && attempt < MAX_RATE_LIMITING_RETRIES) {\n+                LOG.warn(\n+                    \"Received Too Many Requests response from beacon node. Retrying after a delay.\");", "originalCommit": "399321d0d74cd184371dc78fa57bc66f873e7e04", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b7d3d0b457481095c4569cb3aa780b79c8847d57", "url": "https://github.com/ConsenSys/teku/commit/b7d3d0b457481095c4569cb3aa780b79c8847d57", "message": "Improve wording.", "committedDate": "2020-10-23T01:02:06Z", "type": "commit"}]}