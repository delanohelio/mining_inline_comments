{"pr_number": 2934, "pr_title": "Database V6: store all in a single Rocks DB instance by default ", "pr_createdAt": "2020-10-09T15:32:56Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2934", "timeline": [{"oid": "5a5aa7de97b032a5c70b8b5556b3f7fcc6475ac1", "url": "https://github.com/ConsenSys/teku/commit/5a5aa7de97b032a5c70b8b5556b3f7fcc6475ac1", "message": "Refactor DB Schema interfaces, add V6 database version", "committedDate": "2020-10-09T15:25:58Z", "type": "commit"}, {"oid": "45210ce6aeb9cbfcc5fb31752f80f9ee3758fb3e", "url": "https://github.com/ConsenSys/teku/commit/45210ce6aeb9cbfcc5fb31752f80f9ee3758fb3e", "message": "Give methods more canonical names", "committedDate": "2020-10-12T12:30:50Z", "type": "commit"}, {"oid": "b234a2912b9ac4a0007925849846b5c496781384", "url": "https://github.com/ConsenSys/teku/commit/b234a2912b9ac4a0007925849846b5c496781384", "message": "Name members and params more consistently in VersionedDatabaseFactory", "committedDate": "2020-10-12T13:00:23Z", "type": "commit"}, {"oid": "bf140bae62b45aa970b56d51dc8f6f258cc311e8", "url": "https://github.com/ConsenSys/teku/commit/bf140bae62b45aa970b56d51dc8f6f258cc311e8", "message": "Apply spotless", "committedDate": "2020-10-12T14:14:40Z", "type": "commit"}, {"oid": "f5ec7d2a41ce3e1238dfb4a374c24532e3d5f1d8", "url": "https://github.com/ConsenSys/teku/commit/f5ec7d2a41ce3e1238dfb4a374c24532e3d5f1d8", "message": "Create V6 DB metadata", "committedDate": "2020-10-12T14:14:58Z", "type": "commit"}, {"oid": "560f7f761d0260e4a601137c12ef9cdc46d85317", "url": "https://github.com/ConsenSys/teku/commit/560f7f761d0260e4a601137c12ef9cdc46d85317", "message": "Fix warning", "committedDate": "2020-10-12T14:34:35Z", "type": "commit"}, {"oid": "d004e277b9949cf59e3a9e9394767d0566168477", "url": "https://github.com/ConsenSys/teku/commit/d004e277b9949cf59e3a9e9394767d0566168477", "message": "Allow creating older DB versions (at least for testing)", "committedDate": "2020-10-12T15:06:39Z", "type": "commit"}, {"oid": "5251bc397838db1c6349f7d9dfea755f749f3e9c", "url": "https://github.com/ConsenSys/teku/commit/5251bc397838db1c6349f7d9dfea755f749f3e9c", "message": "Fit column IDs to one byte", "committedDate": "2020-10-12T15:28:39Z", "type": "commit"}, {"oid": "a5c9220d398a2569084d19faa4c5063229f74b1a", "url": "https://github.com/ConsenSys/teku/commit/a5c9220d398a2569084d19faa4c5063229f74b1a", "message": "In tests close DB on clean up", "committedDate": "2020-10-12T15:29:18Z", "type": "commit"}, {"oid": "630283955448061b63e3a342be14deca1472098f", "url": "https://github.com/ConsenSys/teku/commit/630283955448061b63e3a342be14deca1472098f", "message": "Adjust tests to DB V6", "committedDate": "2020-10-12T15:29:47Z", "type": "commit"}, {"oid": "0613eb8a6112440e107e821f144d393981c7b6ee", "url": "https://github.com/ConsenSys/teku/commit/0613eb8a6112440e107e821f144d393981c7b6ee", "message": "Spotless apply", "committedDate": "2020-10-12T15:33:24Z", "type": "commit"}, {"oid": "50816ec339b1afb33d9f74ac473483105f0c8750", "url": "https://github.com/ConsenSys/teku/commit/50816ec339b1afb33d9f74ac473483105f0c8750", "message": "Adjust DB version for test", "committedDate": "2020-10-12T15:46:10Z", "type": "commit"}, {"oid": "db12cddc412b133071a73713a08c12c026577e72", "url": "https://github.com/ConsenSys/teku/commit/db12cddc412b133071a73713a08c12c026577e72", "message": "Add V6 DB tests", "committedDate": "2020-10-12T16:10:11Z", "type": "commit"}, {"oid": "df96affcdd2444a3f0d2434595910a9925c79c12", "url": "https://github.com/ConsenSys/teku/commit/df96affcdd2444a3f0d2434595910a9925c79c12", "message": "Merge branch 'master' into feature/rocksdb-single-db", "committedDate": "2020-10-12T17:17:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3MzU5MA==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r503573590", "bodyText": "I think this might be a little simpler if we just use a boolean here - something like: shouldDefaultToSeparateDbs", "author": "mbaxter", "createdAt": "2020-10-12T22:53:13Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/VersionedDatabaseFactory.java", "diffHunk": "@@ -72,10 +78,30 @@ public VersionedDatabaseFactory(\n       final String createDatabaseVersion,\n       final long stateStorageFrequency,\n       final Eth1Address eth1Address) {\n+    this(\n+        metricsSystem,\n+        dataPath,\n+        Optional.empty(),\n+        dataStorageMode,\n+        createDatabaseVersion,\n+        stateStorageFrequency,\n+        eth1Address);\n+  }\n+\n+  public VersionedDatabaseFactory(\n+      final MetricsSystem metricsSystem,\n+      final String dataPath,\n+      final Optional<String> maybeArchiveDataPath,", "originalCommit": "df96affcdd2444a3f0d2434595910a9925c79c12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzcwOTA4MQ==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r503709081", "bodyText": "See my comment below: the idea was to allow a completely different location for archive DB", "author": "Nashatyrev", "createdAt": "2020-10-13T06:58:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3MzU5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3NDg4Mw==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r503574883", "bodyText": "We want all the dbs to be in the data directory:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                this.v6ArchiveDirectory =\n          \n          \n            \n                    maybeArchiveDataPath.map(p -> Paths.get(p).resolve(ARCHIVE_PATH).toFile());\n          \n          \n            \n                final String archiveDirPath =  shouldCreateSeparateDbs ? ARCHIVE_PATH : DB_PATH\n          \n          \n            \n                this.v6ArchiveDirectory = this.dataDirectory.toPath().resolve(archiveDirPath).toFile();", "author": "mbaxter", "createdAt": "2020-10-12T22:57:27Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/VersionedDatabaseFactory.java", "diffHunk": "@@ -72,10 +78,30 @@ public VersionedDatabaseFactory(\n       final String createDatabaseVersion,\n       final long stateStorageFrequency,\n       final Eth1Address eth1Address) {\n+    this(\n+        metricsSystem,\n+        dataPath,\n+        Optional.empty(),\n+        dataStorageMode,\n+        createDatabaseVersion,\n+        stateStorageFrequency,\n+        eth1Address);\n+  }\n+\n+  public VersionedDatabaseFactory(\n+      final MetricsSystem metricsSystem,\n+      final String dataPath,\n+      final Optional<String> maybeArchiveDataPath,\n+      final StateStorageMode dataStorageMode,\n+      final String createDatabaseVersion,\n+      final long stateStorageFrequency,\n+      final Eth1Address eth1Address) {\n     this.metricsSystem = metricsSystem;\n     this.dataDirectory = Paths.get(dataPath).toFile();\n     this.dbDirectory = this.dataDirectory.toPath().resolve(DB_PATH).toFile();\n-    this.archiveDirectory = this.dataDirectory.toPath().resolve(ARCHIVE_PATH).toFile();\n+    this.v5ArchiveDirectory = this.dataDirectory.toPath().resolve(ARCHIVE_PATH).toFile();\n+    this.v6ArchiveDirectory =\n+        maybeArchiveDataPath.map(p -> Paths.get(p).resolve(ARCHIVE_PATH).toFile());", "originalCommit": "df96affcdd2444a3f0d2434595910a9925c79c12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzcwODc3OA==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r503708778", "bodyText": "@ajsutton commented:\n\nThe original plan was to be able to put the archive dB in a different dir so it could be on a slower bigger disk.\n\nSo the exact idea was to allow a different path for archive directory", "author": "Nashatyrev", "createdAt": "2020-10-13T06:57:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3NDg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5NjI5MA==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r503996290", "bodyText": "Right - that makes sense actually :)", "author": "mbaxter", "createdAt": "2020-10-13T14:25:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3NDg4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3NjQyMg==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r503576422", "bodyText": "Any existing metadata should override preferences wrt single / multiple dbs:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      v6ArchiveDirectory.map(\n          \n          \n            \n                          dir ->\n          \n          \n            \n                              metaData\n          \n          \n            \n                                  .getSeparateDbConfiguration()\n          \n          \n            \n                                  .get()\n          \n          \n            \n                                  .getArchiveDbConfiguration()\n          \n          \n            \n                                  .withDatabaseDir(dir.toPath()));\n          \n          \n            \n                      v6ArchiveDirectory\n          \n          \n            \n                      .filter(__ -> !metaData.isSingleDB())\n          \n          \n            \n                      .map(dir ->\n          \n          \n            \n                              metaData\n          \n          \n            \n                                  .getSeparateDbConfiguration()\n          \n          \n            \n                                  .get()\n          \n          \n            \n                                  .getArchiveDbConfiguration()\n          \n          \n            \n                                  .withDatabaseDir(dir.toPath()));", "author": "mbaxter", "createdAt": "2020-10-12T23:02:27Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/VersionedDatabaseFactory.java", "diffHunk": "@@ -164,13 +208,61 @@ private Database createV4Database() {\n    */\n   private Database createV5Database() {\n     try {\n-      final DatabaseMetadata metaData =\n-          DatabaseMetadata.init(getMetadataFile(), DatabaseMetadata.v5Defaults());\n+      final V5DatabaseMetadata metaData =\n+          V5DatabaseMetadata.init(getMetadataFile(), V5DatabaseMetadata.v5Defaults());\n       DatabaseNetwork.init(getNetworkFile(), Constants.GENESIS_FORK_VERSION, eth1Address);\n       return RocksDbDatabase.createV4(\n           metricsSystem,\n           metaData.getHotDbConfiguration().withDatabaseDir(dbDirectory.toPath()),\n-          metaData.getArchiveDbConfiguration().withDatabaseDir(archiveDirectory.toPath()),\n+          metaData.getArchiveDbConfiguration().withDatabaseDir(v5ArchiveDirectory.toPath()),\n+          stateStorageMode,\n+          stateStorageFrequency);\n+    } catch (final IOException e) {\n+      throw new DatabaseStorageException(\"Failed to read metadata\", e);\n+    }\n+  }\n+\n+  private Database createV6Database() {\n+    try {\n+      final V6DatabaseMetadata defaultMetaData;\n+      if (v6ArchiveDirectory.isPresent()) {\n+        defaultMetaData = V6DatabaseMetadata.separateDBDefault();\n+      } else {\n+        defaultMetaData = V6DatabaseMetadata.singleDBDefault();\n+      }\n+\n+      final V6DatabaseMetadata metaData =\n+          V6DatabaseMetadata.init(getMetadataFile(), defaultMetaData);\n+      if (defaultMetaData.isSingleDB() != metaData.isSingleDB()) {\n+        throw new DatabaseStorageException(\n+            \"The database was originally created as \"\n+                + (metaData.isSingleDB() ? \"Single\" : \"Separate\")\n+                + \" but now accessed as \"\n+                + (defaultMetaData.isSingleDB() ? \"Single\" : \"Separate\"));\n+      }\n+\n+      DatabaseNetwork.init(getNetworkFile(), Constants.GENESIS_FORK_VERSION, eth1Address);\n+\n+      final RocksDbConfiguration hotOrSingleDBConfiguration =\n+          metaData.isSingleDB()\n+              ? metaData.getSingleDbConfiguration().get().getConfiguration()\n+              : metaData.getSeparateDbConfiguration().get().getHotDbConfiguration();\n+\n+      final Optional<RocksDbConfiguration> finalizedConfiguration =\n+          v6ArchiveDirectory.map(\n+              dir ->\n+                  metaData\n+                      .getSeparateDbConfiguration()\n+                      .get()\n+                      .getArchiveDbConfiguration()\n+                      .withDatabaseDir(dir.toPath()));", "originalCommit": "df96affcdd2444a3f0d2434595910a9925c79c12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzcxMzAxMA==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r503713010", "bodyText": "We are throwing exception if there is a mismatch between existing metadata and presence/absence of v6ArchiveDirectory. So the suggested filter() condition would always be true.\nhttps://github.com/PegaSysEng/teku/blob/d004e277b9949cf59e3a9e9394767d0566168477/storage/src/main/java/tech/pegasys/teku/storage/server/VersionedDatabaseFactory.java#L227-L242", "author": "Nashatyrev", "createdAt": "2020-10-13T07:06:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3NjQyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk5MzkxNg==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r503993916", "bodyText": "ah - i missed that, thanks!", "author": "mbaxter", "createdAt": "2020-10-13T14:22:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3NjQyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU4MDEzMQ==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r503580131", "bodyText": "Looks like these are being serialized - there's probably a flag to turn off this behavior", "author": "mbaxter", "createdAt": "2020-10-12T23:15:52Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/metadata/V6DatabaseMetadata.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.storage.server.metadata;\n+\n+import static com.fasterxml.jackson.dataformat.yaml.YAMLGenerator.Feature.WRITE_DOC_START_MARKER;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.annotation.JsonProperty.Access;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Optional;\n+import tech.pegasys.teku.storage.server.rocksdb.RocksDbConfiguration;\n+\n+/**\n+ * Defines the configuration for a database. The configuration used when a database is created is\n+ * written to a metadata.yaml file and reloaded to ensure we continue using compatible values for\n+ * the lifetime of that database.\n+ *\n+ * <p>To preserve backwards compatibility always ensure that the value assigned in field\n+ * declarations is compatible with existing databases. These values will be used if the field didn't\n+ * exist at the time the database was created, so typically should match the default.\n+ *\n+ * <p>If the value to use for new databases, differs from the original, set it in a factory function\n+ *\n+ * <p>Values that are safe to change for existing databases are marked with {@link\n+ * Access#WRITE_ONLY}. They will not be written to the metadata file but if present, the value will\n+ * be loaded providing a simple way to experiment with different values without it being fixed at\n+ * database creation.\n+ */\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class V6DatabaseMetadata {\n+\n+  @JsonIgnoreProperties(ignoreUnknown = true)\n+  public static class SingleDBMetadata {\n+    @JsonProperty(\"configuration\")\n+    private RocksDbConfiguration configuration;\n+\n+    public SingleDBMetadata() {}\n+\n+    public SingleDBMetadata(RocksDbConfiguration configuration) {\n+      this.configuration = configuration;\n+    }\n+\n+    public RocksDbConfiguration getConfiguration() {\n+      return configuration;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      return \"SingleDBMetadata{\" + \"configuration=\" + configuration + '}';\n+    }\n+  }\n+\n+  @JsonIgnoreProperties(ignoreUnknown = true)\n+  public static class SeparateDBMetadata {\n+    @JsonProperty(\"hotDbConfiguration\")\n+    private RocksDbConfiguration hotDbConfiguration;\n+\n+    @JsonProperty(\"archiveDbConfiguration\")\n+    private RocksDbConfiguration archiveDbConfiguration;\n+\n+    public SeparateDBMetadata() {}\n+\n+    public SeparateDBMetadata(\n+        RocksDbConfiguration hotDbConfiguration, RocksDbConfiguration archiveDbConfiguration) {\n+      this.hotDbConfiguration = hotDbConfiguration;\n+      this.archiveDbConfiguration = archiveDbConfiguration;\n+    }\n+\n+    public RocksDbConfiguration getHotDbConfiguration() {\n+      return hotDbConfiguration;\n+    }\n+\n+    public RocksDbConfiguration getArchiveDbConfiguration() {\n+      return archiveDbConfiguration;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      return \"SeparateDBMetadata{\"\n+          + \"hotDbConfiguration=\"\n+          + hotDbConfiguration\n+          + \", archiveDbConfiguration=\"\n+          + archiveDbConfiguration\n+          + '}';\n+    }\n+  }\n+\n+  @JsonProperty(\"singleDb\")\n+  private SingleDBMetadata singleDb;\n+\n+  @JsonProperty(\"separateDb\")\n+  private SeparateDBMetadata separateDb;\n+\n+  public V6DatabaseMetadata() {}\n+\n+  private V6DatabaseMetadata(RocksDbConfiguration singleDbConfiguration) {\n+    this.singleDb = new SingleDBMetadata(singleDbConfiguration);\n+  }\n+\n+  private V6DatabaseMetadata(\n+      RocksDbConfiguration hotDbConfiguration, RocksDbConfiguration archiveDbConfiguration) {\n+    this.separateDb = new SeparateDBMetadata(hotDbConfiguration, archiveDbConfiguration);\n+  }\n+\n+  public static V6DatabaseMetadata singleDBDefault() {\n+    return new V6DatabaseMetadata(RocksDbConfiguration.v6SingleDefaults());\n+  }\n+\n+  public static V6DatabaseMetadata separateDBDefault() {\n+    return new V6DatabaseMetadata(\n+        RocksDbConfiguration.v5HotDefaults(), RocksDbConfiguration.v5ArchiveDefaults());\n+  }\n+\n+  public Optional<SingleDBMetadata> getSingleDbConfiguration() {\n+    return Optional.ofNullable(singleDb);\n+  }\n+\n+  public Optional<SeparateDBMetadata> getSeparateDbConfiguration() {\n+    return Optional.ofNullable(separateDb);\n+  }", "originalCommit": "df96affcdd2444a3f0d2434595910a9925c79c12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzcyNjAzMQ==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r503726031", "bodyText": "Oh, thanks for pointing this \ud83d\udc4d\nFix here: 1b023b8\nAlso excluded serialization of a null field", "author": "Nashatyrev", "createdAt": "2020-10-13T07:28:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU4MDEzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU4MTE0OA==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r503581148", "bodyText": "Nice refactor :D", "author": "mbaxter", "createdAt": "2020-10-12T23:19:46Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/schema/SchemaFinalized.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.storage.server.rocksdb.schema;\n+\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+\n+public interface SchemaFinalized extends Schema {", "originalCommit": "df96affcdd2444a3f0d2434595910a9925c79c12", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1b023b894453f925fb7632eeb8d99d6486202bf8", "url": "https://github.com/ConsenSys/teku/commit/1b023b894453f925fb7632eeb8d99d6486202bf8", "message": "Fix V6DatabaseMetadata JSON serialization", "committedDate": "2020-10-13T07:26:53Z", "type": "commit"}, {"oid": "b77526701fd96abf35f6a1c1ab94ebd2b661542c", "url": "https://github.com/ConsenSys/teku/commit/b77526701fd96abf35f6a1c1ab94ebd2b661542c", "message": "Merge remote-tracking branch 'origin/feature/rocksdb-single-db' into feature/rocksdb-single-db", "committedDate": "2020-10-13T07:27:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAwNDg0NA==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r504004844", "bodyText": "(nit) Maybe something like \"serialization\" would be more descriptive\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            package tech.pegasys.teku.util.annotations;\n          \n          \n            \n            package tech.pegasys.teku.util.serialization;", "author": "mbaxter", "createdAt": "2020-10-13T14:35:44Z", "path": "util/src/main/java/tech/pegasys/teku/util/annotations/JsonExplicit.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.util.annotations;", "originalCommit": "1b023b894453f925fb7632eeb8d99d6486202bf8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAwNTA1Ng==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r504005056", "bodyText": "nice", "author": "mbaxter", "createdAt": "2020-10-13T14:36:00Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/metadata/V6DatabaseMetadata.java", "diffHunk": "@@ -42,9 +45,12 @@\n  * database creation.\n  */\n @JsonIgnoreProperties(ignoreUnknown = true)\n+@JsonExplicit", "originalCommit": "1b023b894453f925fb7632eeb8d99d6486202bf8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA3ODcyMQ==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r504078721", "bodyText": "There's a helper class that provides various db versions called StorageSystemArgumentsProvider - we should add the v6 dbs to that class.", "author": "mbaxter", "createdAt": "2020-10-13T16:10:09Z", "path": "storage/src/testFixtures/java/tech/pegasys/teku/storage/server/rocksdb/InMemoryRocksDbDatabaseFactory.java", "diffHunk": "@@ -36,7 +38,22 @@ public static Database createV4(\n         new StubMetricsSystem(), hotDb, coldDb, storageMode, stateStorageFrequency);\n   }\n \n+  public static Database createV6(", "originalCommit": "b77526701fd96abf35f6a1c1ab94ebd2b661542c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDYwNDI4Ng==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r504604286", "bodyText": "Right! Missed that place", "author": "Nashatyrev", "createdAt": "2020-10-14T11:32:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA3ODcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA4MDE3Mg==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r504080172", "bodyText": "Probably a good idea to create another test that uses separate dbs.", "author": "mbaxter", "createdAt": "2020-10-13T16:12:23Z", "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V6RocksDbDatabaseTest.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.storage.server.rocksdb;\n+\n+import java.io.File;\n+import tech.pegasys.teku.storage.server.DatabaseVersion;\n+import tech.pegasys.teku.storage.storageSystem.FileBackedStorageSystemBuilder;\n+import tech.pegasys.teku.storage.storageSystem.StorageSystem;\n+import tech.pegasys.teku.storage.store.StoreConfig;\n+import tech.pegasys.teku.util.config.StateStorageMode;\n+\n+public class V6RocksDbDatabaseTest extends AbstractRocksDbDatabaseWithHotStatesTest {\n+\n+  @Override\n+  protected StorageSystem createStorageSystem(", "originalCommit": "b77526701fd96abf35f6a1c1ab94ebd2b661542c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY0NDYxMw==", "url": "https://github.com/ConsenSys/teku/pull/2934#discussion_r504644613", "bodyText": "Added \ud83d\udc4d", "author": "Nashatyrev", "createdAt": "2020-10-14T12:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA4MDE3Mg=="}], "type": "inlineReview"}, {"oid": "762fffc2b843467af11be5e6c451311f5bae1d8f", "url": "https://github.com/ConsenSys/teku/commit/762fffc2b843467af11be5e6c451311f5bae1d8f", "message": "Rename package", "committedDate": "2020-10-14T11:24:03Z", "type": "commit"}, {"oid": "108d7a69cb9a1c1a14595b7b2eadfc78d071d946", "url": "https://github.com/ConsenSys/teku/commit/108d7a69cb9a1c1a14595b7b2eadfc78d071d946", "message": "Add V6 database factories for DB test cases", "committedDate": "2020-10-14T11:32:06Z", "type": "commit"}, {"oid": "edde6573d92ff38a0501a7337bf89f60d8d265b2", "url": "https://github.com/ConsenSys/teku/commit/edde6573d92ff38a0501a7337bf89f60d8d265b2", "message": "Add a V6 db test with a separate archive directory", "committedDate": "2020-10-14T12:42:15Z", "type": "commit"}, {"oid": "db4c6bda35b5ef18f8c1f8f886f65f6430e120cf", "url": "https://github.com/ConsenSys/teku/commit/db4c6bda35b5ef18f8c1f8f886f65f6430e120cf", "message": "Merge branch 'master' into feature/rocksdb-single-db", "committedDate": "2020-10-14T12:59:30Z", "type": "commit"}]}