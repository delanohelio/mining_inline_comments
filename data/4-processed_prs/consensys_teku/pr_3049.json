{"pr_number": 3049, "pr_title": "Track peer reputation score during sync", "pr_createdAt": "2020-10-22T04:09:57Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3049", "timeline": [{"oid": "7f6e59cf6157a219fb6feb6d161584c64470c0a4", "url": "https://github.com/ConsenSys/teku/commit/7f6e59cf6157a219fb6feb6d161584c64470c0a4", "message": "Track peer reputation score as they are used as part of sync so peers that sending us blocks from the wrong chain wind up being disconnected.", "committedDate": "2020-10-22T03:59:51Z", "type": "commit"}, {"oid": "73cb1b43b7b571f83df76c9db0cf85e8cf9a9466", "url": "https://github.com/ConsenSys/teku/commit/73cb1b43b7b571f83df76c9db0cf85e8cf9a9466", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into sync-peer-reputation", "committedDate": "2020-10-22T04:10:08Z", "type": "commit"}, {"oid": "1f6b0769c36ac6784592d96aff775d7dc391eb6d", "url": "https://github.com/ConsenSys/teku/commit/1f6b0769c36ac6784592d96aff775d7dc391eb6d", "message": "Perform reputation adjustments directly in the peer instead of via Reputationmanager.", "committedDate": "2020-10-22T04:20:48Z", "type": "commit"}, {"oid": "2b02d2b86bba9c232df56d679cec0169d7d31055", "url": "https://github.com/ConsenSys/teku/commit/2b02d2b86bba9c232df56d679cec0169d7d31055", "message": "Errorprone.", "committedDate": "2020-10-22T04:28:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3NTg5MA==", "url": "https://github.com/ConsenSys/teku/pull/3049#discussion_r509875890", "bodyText": "this peer is then unsuitable until restart, is that a bit harsh? should it just have a 'naughty corner' timeout?", "author": "rolfyone", "createdAt": "2020-10-22T04:42:12Z", "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/reputation/ReputationManager.java", "diffHunk": "@@ -121,5 +141,17 @@ private boolean isLocallyConsideredUnsuitable(\n       return locallyInitiated\n           && reason.map(r -> !LOCAL_TEMPORARY_DISCONNECT_REASONS.contains(r)).orElse(false);\n     }\n+\n+    public boolean adjustReputation(final ReputationAdjustment effect) {\n+      final int newScore =\n+          score.updateAndGet(\n+              current -> Math.min(MAX_REPUTATION_SCORE, current + effect.getScoreChange()));\n+      final boolean shouldDisconnect = newScore <= DISCONNECT_THRESHOLD;\n+      if (shouldDisconnect) {\n+        // Prevent our node from connecting out to the remote peer.\n+        unsuitable = true;\n+      }", "originalCommit": "2b02d2b86bba9c232df56d679cec0169d7d31055", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkwMTQ3Mw==", "url": "https://github.com/ConsenSys/teku/pull/3049#discussion_r509901473", "bodyText": "The peer can still connect to it, we just won't initiate a connection to the peer anymore.  Given they just tried to feed us bad info that seems wise. At some point we will likely need to go further and completely ban them, though that likely would be an even lower score (ie first time you just get disconnected, second time you get banned kind of policy).", "author": "ajsutton", "createdAt": "2020-10-22T06:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3NTg5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3NjcwMw==", "url": "https://github.com/ConsenSys/teku/pull/3049#discussion_r509876703", "bodyText": "we create 'shouldDisconnect, set unsuitable to the value of disconnect, return disconnect - maybe just store the value in unsuitable and return that?", "author": "rolfyone", "createdAt": "2020-10-22T04:45:26Z", "path": "networking/p2p/src/main/java/tech/pegasys/teku/networking/p2p/reputation/ReputationManager.java", "diffHunk": "@@ -121,5 +141,17 @@ private boolean isLocallyConsideredUnsuitable(\n       return locallyInitiated\n           && reason.map(r -> !LOCAL_TEMPORARY_DISCONNECT_REASONS.contains(r)).orElse(false);\n     }\n+\n+    public boolean adjustReputation(final ReputationAdjustment effect) {\n+      final int newScore =\n+          score.updateAndGet(\n+              current -> Math.min(MAX_REPUTATION_SCORE, current + effect.getScoreChange()));\n+      final boolean shouldDisconnect = newScore <= DISCONNECT_THRESHOLD;", "originalCommit": "2b02d2b86bba9c232df56d679cec0169d7d31055", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkwMTY3OA==", "url": "https://github.com/ConsenSys/teku/pull/3049#discussion_r509901678", "bodyText": "The peer may have already been marked unsuitable because of repeated failures to connect (e.g if the node is behind a firewall so can connect out but can't accept incoming connections).", "author": "ajsutton", "createdAt": "2020-10-22T06:10:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3NjcwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3NzA4OQ==", "url": "https://github.com/ConsenSys/teku/pull/3049#discussion_r509877089", "bodyText": "unless we're at 0 reputation, we wont be disconnecting here...", "author": "rolfyone", "createdAt": "2020-10-22T04:46:55Z", "path": "sync/src/main/java/tech/pegasys/teku/sync/multipeer/batches/PeerScoringConflictResolutionStrategy.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync.multipeer.batches;\n+\n+import static tech.pegasys.teku.networking.p2p.reputation.ReputationAdjustment.LARGE_PENALTY;\n+import static tech.pegasys.teku.networking.p2p.reputation.ReputationAdjustment.SMALL_PENALTY;\n+import static tech.pegasys.teku.networking.p2p.reputation.ReputationAdjustment.SMALL_REWARD;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.networking.eth2.peers.SyncSource;\n+\n+public class PeerScoringConflictResolutionStrategy implements ConflictResolutionStrategy {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  @Override\n+  public void verifyBatch(final Batch batch, final SyncSource originalSource) {\n+    LOG.debug(\"Invalidating batch {}\", batch);\n+    // We aren't sure if this peer is providing bad blocks or some other peer, so apply a small\n+    // penalty to the peer and re-download the data for the batch. If the peer is honest, it should\n+    // have more confirmed batches than contested and the small penalty to reputation won't matter.\n+    // If it's dishonest the penalties will add up until it is disconnected.\n+    originalSource.adjustReputation(SMALL_PENALTY);\n+    batch.markAsInvalid();\n+  }\n+\n+  @Override\n+  public void reportInvalidBatch(final Batch batch, final SyncSource source) {\n+    LOG.debug(\"Disconnecting peer {} for providing invalid batch data {}\", source, batch);\n+    source.adjustReputation(LARGE_PENALTY);", "originalCommit": "2b02d2b86bba9c232df56d679cec0169d7d31055", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkwMjExOQ==", "url": "https://github.com/ConsenSys/teku/pull/3049#discussion_r509902119", "bodyText": "Fixed log messages to match what we wound up doing.", "author": "ajsutton", "createdAt": "2020-10-22T06:11:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3NzA4OQ=="}], "type": "inlineReview"}, {"oid": "10b9ba6aba194e554ee059c32fb4baa65c547f6d", "url": "https://github.com/ConsenSys/teku/commit/10b9ba6aba194e554ee059c32fb4baa65c547f6d", "message": "Fix comments.", "committedDate": "2020-10-22T06:11:12Z", "type": "commit"}, {"oid": "eaf5dd2828741166ebf261378ef0f26f3ee3aafe", "url": "https://github.com/ConsenSys/teku/commit/eaf5dd2828741166ebf261378ef0f26f3ee3aafe", "message": "Merge branch 'master' into sync-peer-reputation", "committedDate": "2020-10-22T19:56:38Z", "type": "commit"}]}