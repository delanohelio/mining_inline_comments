{"pr_number": 1741, "pr_title": "Prune attestations from the aggregating pool", "pr_createdAt": "2020-05-08T09:20:45Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1741", "timeline": [{"oid": "0986b3806ea010c519c31d008464785ae4619685", "url": "https://github.com/ConsenSys/teku/commit/0986b3806ea010c519c31d008464785ae4619685", "message": "Prune attestations from the aggregating pool.\nFire slot events even while syncing so pruning actions are applied.", "committedDate": "2020-05-08T09:18:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE3MDcyNA==", "url": "https://github.com/ConsenSys/teku/pull/1741#discussion_r422170724", "bodyText": "nit: I was almost writing:\n\nIt would be nice to explicitly set the slot of the pruneAttestationData here. Otherwise, what if randomly it has a higher slot than the preserveAttestationData? AggregatingPool would clean both of them.\n\nThen noticed the randomAttestationDataToIncludeInBlock method actually sets the slot to SLOT - 1. It's a bit hard to see especially when looking at git diffs.", "author": "cemozerr", "createdAt": "2020-05-08T14:20:14Z", "path": "ethereum/statetransition/src/test/java/tech/pegasys/teku/statetransition/attestation/AggregatingAttestationPoolTest.java", "diffHunk": "@@ -121,12 +123,33 @@ public void getAttestationsForBlock_shouldNotAddMoreAttestationsThanAllowedInBlo\n     final Attestation attestation1 = addAttestationFromValidators(attestationData, 1, 2, 3, 4);\n     final Attestation attestation2 = addAttestationFromValidators(attestationData, 2, 5);\n     // Won't be included because of the 2 attestation limit.\n-    addAttestationFromValidators(attestationData, 2, 6);\n+    addAttestationFromValidators(attestationData, 2);\n \n     assertThat(aggregatingPool.getAttestationsForBlock(SLOT))\n         .containsExactly(attestation1, attestation2);\n   }\n \n+  @Test\n+  public void onSlot_shouldPruneAttestationsMoreThanTwoEpochsBehindCurrentSlot() {\n+    final AttestationData pruneAttestationData = randomAttestationDataToIncludeInBlock();", "originalCommit": "0986b3806ea010c519c31d008464785ae4619685", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "47809ed4d20b0452ffe5ebd78fa04006c70b3ea0", "url": "https://github.com/ConsenSys/teku/commit/47809ed4d20b0452ffe5ebd78fa04006c70b3ea0", "message": "Merge branch 'master' of github.com:PegaSysEng/teku into prune-attestation-aggregate-pool", "committedDate": "2020-05-09T00:00:14Z", "type": "commit"}, {"oid": "dc15be3ad448a15de776fe0e2e3a2f0b84841aa1", "url": "https://github.com/ConsenSys/teku/commit/dc15be3ad448a15de776fe0e2e3a2f0b84841aa1", "message": "Clarify and simplify the slot used for the attestation.", "committedDate": "2020-05-09T00:02:18Z", "type": "commit"}, {"oid": "7977c7fba50b2d53bca293c8d2df610f09e82857", "url": "https://github.com/ConsenSys/teku/commit/7977c7fba50b2d53bca293c8d2df610f09e82857", "message": "Fix.", "committedDate": "2020-05-09T00:02:59Z", "type": "commit"}]}