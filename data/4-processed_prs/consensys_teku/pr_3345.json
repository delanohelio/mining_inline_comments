{"pr_number": 3345, "pr_title": "update ForkProvider to run as a service", "pr_createdAt": "2020-12-02T03:18:49Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3345", "timeline": [{"oid": "4754922d1f9a09b2153c87960cb50c38b879a307", "url": "https://github.com/ConsenSys/teku/commit/4754922d1f9a09b2153c87960cb50c38b879a307", "message": "update ForkProvider to run as a service\n\nFork requests will now only happen once per client, per period of time, rather than each validator potentially initiating its own request over http.\n\nfixes #3304\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-12-02T03:17:22Z", "type": "commit"}, {"oid": "8d1d193f3b416b7e964ec28a270de29bacd1238f", "url": "https://github.com/ConsenSys/teku/commit/8d1d193f3b416b7e964ec28a270de29bacd1238f", "message": "Merge remote-tracking branch 'upstream/master' into 3304-refactor-fork-provider", "committedDate": "2020-12-02T03:19:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3NTM0Mg==", "url": "https://github.com/ConsenSys/teku/pull/3345#discussion_r533875342", "bodyText": "nit: move this initialiser to the field declaration.", "author": "ajsutton", "createdAt": "2020-12-02T03:38:47Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/ForkProvider.java", "diffHunk": "@@ -43,49 +43,63 @@ public ForkProvider(\n     this.asyncRunner = asyncRunner;\n     this.validatorApiChannel = validatorApiChannel;\n     this.genesisDataProvider = genesisDataProvider;\n+    currentFork = new SafeFuture<>();", "originalCommit": "8d1d193f3b416b7e964ec28a270de29bacd1238f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg5OTI0NA==", "url": "https://github.com/ConsenSys/teku/pull/3345#discussion_r533899244", "bodyText": "Not sure if you missed this or actually disagree, but typically this would be in the field declaration. :) Main reason is then you can see very clearly that it's not initially null.", "author": "ajsutton", "createdAt": "2020-12-02T05:05:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3NTM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkwMDI2Ng==", "url": "https://github.com/ConsenSys/teku/pull/3345#discussion_r533900266", "bodyText": "nope that's me having to manually merge and i missed it, sorry", "author": "rolfyone", "createdAt": "2020-12-02T05:09:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3NTM0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3NjY4NA==", "url": "https://github.com/ConsenSys/teku/pull/3345#discussion_r533876684", "bodyText": "This would overwrite the SafeFuture assigned in the constructor without actually completing it.  Probably should make the initial value a failed future if we're going to do this ( probably an IllegalStateException given it would mean getForkInfo is called before start is. Would have to be completely sure it never happens though so may be better to just have this be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                currentFork = getForkAndPeriodicallyUpdate();\n          \n          \n            \n                getForkAndPeriodicallyUpdate().propagateTo(currentFork);", "author": "ajsutton", "createdAt": "2020-12-02T03:43:32Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/ForkProvider.java", "diffHunk": "@@ -43,49 +43,63 @@ public ForkProvider(\n     this.asyncRunner = asyncRunner;\n     this.validatorApiChannel = validatorApiChannel;\n     this.genesisDataProvider = genesisDataProvider;\n+    currentFork = new SafeFuture<>();\n   }\n \n   public SafeFuture<ForkInfo> getForkInfo() {\n-    return currentFork.map(SafeFuture::completedFuture).orElseGet(this::loadForkInfo);\n+    return currentFork;\n   }\n \n-  public SafeFuture<ForkInfo> loadForkInfo() {\n-    return requestForkInfo()\n-        .exceptionallyCompose(\n-            error -> {\n-              LOG.error(\"Failed to retrieve current fork info. Retrying after delay\", error);\n-              return asyncRunner.runAfterDelay(\n-                  this::getForkInfo, FORK_RETRY_DELAY_SECONDS, TimeUnit.SECONDS);\n-            });\n-  }\n-\n-  private SafeFuture<ForkInfo> requestForkInfo() {\n-    return genesisDataProvider.getGenesisValidatorsRoot().thenCompose(this::requestFork);\n-  }\n-\n-  public SafeFuture<ForkInfo> requestFork(final Bytes32 genesisValidatorsRoot) {\n+  private SafeFuture<ForkInfo> getForkAndPeriodicallyUpdate() {\n     return validatorApiChannel\n         .getFork()\n         .thenCompose(\n             maybeFork -> {\n               if (maybeFork.isEmpty()) {\n                 LOG.trace(\"Fork info not available, retrying\");\n-                return asyncRunner.runAfterDelay(\n-                    this::requestForkInfo, FORK_RETRY_DELAY_SECONDS, TimeUnit.SECONDS);\n+                return scheduleNextRequest(FORK_RETRY_DELAY_SECONDS);\n               }\n-              final ForkInfo forkInfo =\n-                  new ForkInfo(maybeFork.orElseThrow(), genesisValidatorsRoot);\n-              currentFork = Optional.of(forkInfo);\n-              // Periodically refresh the current fork info.\n-              asyncRunner\n-                  .runAfterDelay(this::loadForkInfo, FORK_REFRESH_TIME_SECONDS, TimeUnit.SECONDS)\n-                  .reportExceptions();\n-              return SafeFuture.completedFuture(forkInfo);\n+\n+              scheduleNextRequest(FORK_REFRESH_TIME_SECONDS).reportExceptions();\n+              return getValidatorsRootAndCreateForkInfo(maybeFork.orElseThrow());\n+            })\n+        .exceptionallyCompose(\n+            error -> {\n+              LOG.error(\"Failed to retrieve current fork info. Retrying after delay\", error);\n+              return scheduleNextRequest(FORK_RETRY_DELAY_SECONDS);\n             });\n   }\n \n+  private SafeFuture<ForkInfo> getValidatorsRootAndCreateForkInfo(Fork fork) {\n+    return genesisDataProvider\n+        .getGenesisValidatorsRoot()\n+        .thenCompose(\n+            root -> {\n+              final ForkInfo forkInfo = new ForkInfo(fork, root);\n+              // anything waiting on the current future needs to be notified\n+              currentFork.complete(forkInfo);\n+              currentFork = SafeFuture.completedFuture(forkInfo);\n+              return currentFork;\n+            });\n+  }\n+\n+  private SafeFuture<ForkInfo> scheduleNextRequest(final long seconds) {\n+    return asyncRunner.runAfterDelay(this::getForkAndPeriodicallyUpdate, seconds, TimeUnit.SECONDS);\n+  }\n+\n   @Override\n   public String toString() {\n     return \"ForkProvider{\" + \"currentFork=\" + currentFork + '}';\n   }\n+\n+  @Override\n+  protected SafeFuture<?> doStart() {\n+    currentFork = getForkAndPeriodicallyUpdate();", "originalCommit": "8d1d193f3b416b7e964ec28a270de29bacd1238f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3ODIyNA==", "url": "https://github.com/ConsenSys/teku/pull/3345#discussion_r533878224", "bodyText": "This isn't right.  It will wind up recursively chaining the exceptionallyCompose at the end of this method until you potentially get a StackOverflowException.\nThe other places are ok to call loadForkInfo recursively because its either already in the last step of the chain or doesn't return the result and just uses reportExceptions.  That's why there was a split between loadForkInfo and requestForkInfo.", "author": "ajsutton", "createdAt": "2020-12-02T03:49:06Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/ForkProvider.java", "diffHunk": "@@ -43,49 +43,63 @@ public ForkProvider(\n     this.asyncRunner = asyncRunner;\n     this.validatorApiChannel = validatorApiChannel;\n     this.genesisDataProvider = genesisDataProvider;\n+    currentFork = new SafeFuture<>();\n   }\n \n   public SafeFuture<ForkInfo> getForkInfo() {\n-    return currentFork.map(SafeFuture::completedFuture).orElseGet(this::loadForkInfo);\n+    return currentFork;\n   }\n \n-  public SafeFuture<ForkInfo> loadForkInfo() {\n-    return requestForkInfo()\n-        .exceptionallyCompose(\n-            error -> {\n-              LOG.error(\"Failed to retrieve current fork info. Retrying after delay\", error);\n-              return asyncRunner.runAfterDelay(\n-                  this::getForkInfo, FORK_RETRY_DELAY_SECONDS, TimeUnit.SECONDS);\n-            });\n-  }\n-\n-  private SafeFuture<ForkInfo> requestForkInfo() {\n-    return genesisDataProvider.getGenesisValidatorsRoot().thenCompose(this::requestFork);\n-  }\n-\n-  public SafeFuture<ForkInfo> requestFork(final Bytes32 genesisValidatorsRoot) {\n+  private SafeFuture<ForkInfo> getForkAndPeriodicallyUpdate() {\n     return validatorApiChannel\n         .getFork()\n         .thenCompose(\n             maybeFork -> {\n               if (maybeFork.isEmpty()) {\n                 LOG.trace(\"Fork info not available, retrying\");\n-                return asyncRunner.runAfterDelay(\n-                    this::requestForkInfo, FORK_RETRY_DELAY_SECONDS, TimeUnit.SECONDS);\n+                return scheduleNextRequest(FORK_RETRY_DELAY_SECONDS);", "originalCommit": "8d1d193f3b416b7e964ec28a270de29bacd1238f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3ODM4Mg==", "url": "https://github.com/ConsenSys/teku/pull/3345#discussion_r533878382", "bodyText": "This should be calling start().\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                forkProvider.doStart().reportExceptions();\n          \n          \n            \n                forkProvider.start().reportExceptions();", "author": "ajsutton", "createdAt": "2020-12-02T03:49:40Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/ValidatorClientService.java", "diffHunk": "@@ -137,6 +141,7 @@ private static void addValidatorCountMetric(\n \n   @Override\n   protected SafeFuture<?> doStart() {\n+    forkProvider.doStart().reportExceptions();", "originalCommit": "8d1d193f3b416b7e964ec28a270de29bacd1238f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3ODQ2Mw==", "url": "https://github.com/ConsenSys/teku/pull/3345#discussion_r533878463", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                forkProvider.doStart().reportExceptions();\n          \n          \n            \n                forkProvider.start().reportExceptions();", "author": "ajsutton", "createdAt": "2020-12-02T03:49:59Z", "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/ForkProviderTest.java", "diffHunk": "@@ -50,6 +50,7 @@ public void shouldRequestForkWhenNotPreviouslyLoaded() {\n     when(genesisDataProvider.getGenesisValidatorsRoot())\n         .thenReturn(SafeFuture.completedFuture(forkInfo.getGenesisValidatorsRoot()));\n \n+    forkProvider.doStart().reportExceptions();", "originalCommit": "8d1d193f3b416b7e964ec28a270de29bacd1238f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3ODUyMA==", "url": "https://github.com/ConsenSys/teku/pull/3345#discussion_r533878520", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                forkProvider.doStart().reportExceptions();\n          \n          \n            \n                forkProvider.start().reportExceptions();", "author": "ajsutton", "createdAt": "2020-12-02T03:50:09Z", "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/ForkProviderTest.java", "diffHunk": "@@ -66,6 +67,7 @@ public void shouldReturnCachedForkWhenPreviouslyLoaded() {\n         .thenReturn(SafeFuture.completedFuture(forkInfo.getGenesisValidatorsRoot()));\n \n     // First request loads the fork\n+    forkProvider.doStart().reportExceptions();", "originalCommit": "8d1d193f3b416b7e964ec28a270de29bacd1238f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3ODU2NQ==", "url": "https://github.com/ConsenSys/teku/pull/3345#discussion_r533878565", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                forkProvider.doStart().reportExceptions();\n          \n          \n            \n                forkProvider.start().reportExceptions();", "author": "ajsutton", "createdAt": "2020-12-02T03:50:16Z", "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/ForkProviderTest.java", "diffHunk": "@@ -84,6 +86,7 @@ public void shouldPeriodicallyRequestUpdatedFork() {\n         .thenReturn(completedFuture(Optional.of(forkInfo.getFork())))\n         .thenReturn(completedFuture(Optional.of(updatedFork.getFork())));\n \n+    forkProvider.doStart().reportExceptions();", "originalCommit": "8d1d193f3b416b7e964ec28a270de29bacd1238f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3ODYwOQ==", "url": "https://github.com/ConsenSys/teku/pull/3345#discussion_r533878609", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                forkProvider.doStart().reportExceptions();\n          \n          \n            \n                forkProvider.start().reportExceptions();", "author": "ajsutton", "createdAt": "2020-12-02T03:50:24Z", "path": "validator/client/src/test/java/tech/pegasys/teku/validator/client/ForkProviderTest.java", "diffHunk": "@@ -101,7 +104,7 @@ public void shouldRetryWhenForkFailsToLoad() {\n     when(validatorApiChannel.getFork())\n         .thenReturn(failedFuture(new RuntimeException(\"Nope\")))\n         .thenReturn(completedFuture(Optional.of(forkInfo.getFork())));\n-\n+    forkProvider.doStart().reportExceptions();", "originalCommit": "8d1d193f3b416b7e964ec28a270de29bacd1238f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8f3ab54cb3b6ffd14abed97f0fee82a2613beaaf", "url": "https://github.com/ConsenSys/teku/commit/8f3ab54cb3b6ffd14abed97f0fee82a2613beaaf", "message": "review feedback\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-12-02T05:01:53Z", "type": "commit"}, {"oid": "1353810537e1d053f2643dd7355c2fca8885de39", "url": "https://github.com/ConsenSys/teku/commit/1353810537e1d053f2643dd7355c2fca8885de39", "message": "review feedback\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-12-02T05:11:00Z", "type": "commit"}, {"oid": "9e01311a0b37b54fa0512a2f8397eb2d7937cd56", "url": "https://github.com/ConsenSys/teku/commit/9e01311a0b37b54fa0512a2f8397eb2d7937cd56", "message": "Merge remote-tracking branch 'upstream/master' into 3304-refactor-fork-provider", "committedDate": "2020-12-02T05:19:46Z", "type": "commit"}]}