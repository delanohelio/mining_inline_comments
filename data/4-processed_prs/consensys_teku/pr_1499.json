{"pr_number": 1499, "pr_title": "beaconchain: enable processing of slot heads during sync and improve logging", "pr_createdAt": "2020-03-29T12:28:53Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1499", "timeline": [{"oid": "57a96dd508ac7f612eb0811f392036766e97c46a", "url": "https://github.com/ConsenSys/teku/commit/57a96dd508ac7f612eb0811f392036766e97c46a", "message": "logging: condense log output to one-liners\n\nSigned-off-by: /raw PONG _GHMoaCXLT <58883403+q9f@users.noreply.github.com>", "committedDate": "2020-03-29T12:26:13Z", "type": "commit"}, {"oid": "1efe5d2fedcede2c08a2c3320602ea2363707090", "url": "https://github.com/ConsenSys/teku/commit/1efe5d2fedcede2c08a2c3320602ea2363707090", "message": "services/beaconchain: improve verbosity of epoch and slot events\n\nSigned-off-by: /raw PONG _GHMoaCXLT <58883403+q9f@users.noreply.github.com>", "committedDate": "2020-03-29T13:06:32Z", "type": "commit"}, {"oid": "d9937cfa5cebd3b0d83d94ddb41542fe46df9ace", "url": "https://github.com/ConsenSys/teku/commit/d9937cfa5cebd3b0d83d94ddb41542fe46df9ace", "message": "logging: use a standard 8 color terminal palette\n\nSigned-off-by: /raw PONG _GHMoaCXLT <58883403+q9f@users.noreply.github.com>", "committedDate": "2020-03-29T13:26:33Z", "type": "commit"}, {"oid": "9fb53f4c6215e8cb5a4c49fd9f172a47f69c9079", "url": "https://github.com/ConsenSys/teku/commit/9fb53f4c6215e8cb5a4c49fd9f172a47f69c9079", "message": "logging: improve display of shortened root hash\n\nSigned-off-by: /raw PONG _GHMoaCXLT <58883403+q9f@users.noreply.github.com>", "committedDate": "2020-03-29T13:38:33Z", "type": "commit"}, {"oid": "66e18fa4b681b31f420b8d5c1375fafce1a1c49e", "url": "https://github.com/ConsenSys/teku/commit/66e18fa4b681b31f420b8d5c1375fafce1a1c49e", "message": "services/beaconchain: enable processing of slots during sync\n\nSigned-off-by: /raw PONG _GHMoaCXLT <58883403+q9f@users.noreply.github.com>", "committedDate": "2020-03-29T13:41:33Z", "type": "commit"}, {"oid": "f9f5a2f61ed0ffe7f70aa848e4d078578e99f946", "url": "https://github.com/ConsenSys/teku/commit/f9f5a2f61ed0ffe7f70aa848e4d078578e99f946", "message": "logging: add a syncEvent to EventLogger\n\nSigned-off-by: /raw PONG _GHMoaCXLT <58883403+q9f@users.noreply.github.com>", "committedDate": "2020-03-29T16:06:32Z", "type": "commit"}, {"oid": "22929c70b33015f817f6decdadb783de8af2d397", "url": "https://github.com/ConsenSys/teku/commit/22929c70b33015f817f6decdadb783de8af2d397", "message": "services/beaconchain: log syncEvent instead of slotEvent during sync\n\nSigned-off-by: /raw PONG _GHMoaCXLT <58883403+q9f@users.noreply.github.com>", "committedDate": "2020-03-29T16:07:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg3NTI0Nw==", "url": "https://github.com/ConsenSys/teku/pull/1499#discussion_r399875247", "bodyText": "It doesn't show in the GitHub UI but the second of these asterisks is slightly superscript.  Was that intentional? It's kind of cool but slightly disconcerting...", "author": "ajsutton", "createdAt": "2020-03-30T00:12:45Z", "path": "logging/src/main/java/tech/pegasys/teku/logging/EventLogger.java", "diffHunk": "@@ -33,25 +33,52 @@ private EventLogger(final String name) {\n   }\n \n   public void genesisEvent(final Bytes32 hashTreeRoot, final Bytes32 genesisBlockRoot) {\n-    info(\"******* Eth2Genesis Event*******\", Color.WHITE);\n-    log.info(\"Initial state root is {}\", hashTreeRoot.toHexString());\n-    log.info(\"Genesis block root is {}\", genesisBlockRoot.toHexString());\n+    final String genesisEventLog =\n+        String.format(\n+            \"Genesis Event *** Initial state root: %s, Genesis block root: %s\",", "originalCommit": "22929c70b33015f817f6decdadb783de8af2d397", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEwOTY3OQ==", "url": "https://github.com/ConsenSys/teku/pull/1499#discussion_r400109679", "bodyText": "Are you using the Fira Code font?\ntonsky/FiraCode#480", "author": "q9f", "createdAt": "2020-03-30T11:11:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg3NTI0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU0NzA3OA==", "url": "https://github.com/ConsenSys/teku/pull/1499#discussion_r400547078", "bodyText": "Yes, interesting.  Didn't expected three asterisks to be special.", "author": "ajsutton", "createdAt": "2020-03-30T23:05:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg3NTI0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg5MTcxNg==", "url": "https://github.com/ConsenSys/teku/pull/1499#discussion_r399891716", "bodyText": "We've wound up re-enabling quite a lot of processing by removing the isSyncActive check here. Time event handling is an area that's still pretty messy (hence the Thread.sleep calls in here) and since our fork choice isn't yet optimised we can wind up failing to keep up with these tick events which cause a bunch of other issues.  The early abort while syncing is a bit of a band-aid fix for that while we work through a complete solution.\nI've played around with it a bit and my suggestion would be 18c0ed2. It still winds up running fork choice on each slot while syncing which hurts at the moment since it's unoptimised but I think gives the results we need without doing any unnecessary work.", "author": "ajsutton", "createdAt": "2020-03-30T01:59:16Z", "path": "services/beaconchain/src/main/java/tech/pegasys/artemis/services/beaconchain/BeaconChainController.java", "diffHunk": "@@ -380,7 +380,7 @@ private void onStoreInitialized() {\n \n   @Override\n   public void onTick(Date date) {\n-    if (chainStorageClient.isPreGenesis() || syncService.isSyncActive()) {\n+    if (chainStorageClient.isPreGenesis()) {", "originalCommit": "22929c70b33015f817f6decdadb783de8af2d397", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEwODY3OQ==", "url": "https://github.com/ConsenSys/teku/pull/1499#discussion_r400108679", "bodyText": "The simplest solution is that we revert commit 66e18fa for now and come up with a proper solution for #1497 - this would leave all the logging implemented but still aborts early (therefore not posting synclogs - yet).\nOtherwise, 18c0ed2 looks good to me if you also prefer to have some sync logging. Let me compile it and see if it also addresses the /node/syncing endpoint issue.", "author": "q9f", "createdAt": "2020-03-30T11:09:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg5MTcxNg=="}], "type": "inlineReview"}, {"oid": "141fe809fdfaaf7aca479154b1325be49c50bd97", "url": "https://github.com/ConsenSys/teku/commit/141fe809fdfaaf7aca479154b1325be49c50bd97", "message": "services/beaconchain: tweak onTick logic to reduce processing during sync\n\nSigned-off-by: q9f <58883403+q9f@users.noreply.github.com>", "committedDate": "2020-03-30T11:52:16Z", "type": "commit"}, {"oid": "19334d27f7b2d2aa569b76589dd329f488bd30f5", "url": "https://github.com/ConsenSys/teku/commit/19334d27f7b2d2aa569b76589dd329f488bd30f5", "message": "Merge branch 'master' into q9-logger", "committedDate": "2020-03-30T11:54:30Z", "type": "commit"}, {"oid": "9604f5302ee36ecd7f91ccff31d37e7e8535f640", "url": "https://github.com/ConsenSys/teku/commit/9604f5302ee36ecd7f91ccff31d37e7e8535f640", "message": "Resolve conflicts with master", "committedDate": "2020-03-30T19:49:11Z", "type": "commit"}, {"oid": "6e474e3a9baf6209566fe9c1d0e18710447df9d8", "url": "https://github.com/ConsenSys/teku/commit/6e474e3a9baf6209566fe9c1d0e18710447df9d8", "message": "Merge branch 'master' into q9-logger", "committedDate": "2020-03-31T06:41:50Z", "type": "commit"}]}