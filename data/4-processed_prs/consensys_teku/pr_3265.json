{"pr_number": 3265, "pr_title": "Avoid repeatedly processing epoch transitions", "pr_createdAt": "2020-11-20T02:59:04Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3265", "timeline": [{"oid": "69cbcf979843f2718b685191160246a5dd802a7c", "url": "https://github.com/ConsenSys/teku/commit/69cbcf979843f2718b685191160246a5dd802a7c", "message": "Avoid repeatedly processing epoch transitions.", "committedDate": "2020-11-20T02:51:17Z", "type": "commit"}, {"oid": "2e26e1ddcca2067d9e7b4d8f4859889c93e976ba", "url": "https://github.com/ConsenSys/teku/commit/2e26e1ddcca2067d9e7b4d8f4859889c93e976ba", "message": "Merge branch 'master' of github.com:ConsenSys/teku into optimise-epoch-transition", "committedDate": "2020-11-20T02:59:14Z", "type": "commit"}, {"oid": "d2fbc7cce7569654d68264c41c228335fc0930f4", "url": "https://github.com/ConsenSys/teku/commit/d2fbc7cce7569654d68264c41c228335fc0930f4", "message": "Errorprone.", "committedDate": "2020-11-20T03:15:20Z", "type": "commit"}, {"oid": "4caf1bbcd28058b1e983d4ba23ed298faaf343e3", "url": "https://github.com/ConsenSys/teku/commit/4caf1bbcd28058b1e983d4ba23ed298faaf343e3", "message": "Update tests.", "committedDate": "2020-11-20T03:32:06Z", "type": "commit"}, {"oid": "8c30644e5c4f29bab7bbf752b47cd0a9fa8f6ffd", "url": "https://github.com/ConsenSys/teku/commit/8c30644e5c4f29bab7bbf752b47cd0a9fa8f6ffd", "message": "Merge branch 'master' of github.com:ConsenSys/teku into optimise-epoch-transition", "committedDate": "2020-11-25T23:06:12Z", "type": "commit"}, {"oid": "68094038d35ecbed918a59b35dad5b2a38a9a9bf", "url": "https://github.com/ConsenSys/teku/commit/68094038d35ecbed918a59b35dad5b2a38a9a9bf", "message": "Update new tests.", "committedDate": "2020-11-25T23:48:53Z", "type": "commit"}, {"oid": "fde597500eb760bff77f656c15188e5b1502c9a4", "url": "https://github.com/ConsenSys/teku/commit/fde597500eb760bff77f656c15188e5b1502c9a4", "message": "Merge branch 'master' of github.com:ConsenSys/teku into optimise-epoch-transition", "committedDate": "2020-11-27T01:20:51Z", "type": "commit"}, {"oid": "846c433c75e17098b6910da0d5208fe326103179", "url": "https://github.com/ConsenSys/teku/commit/846c433c75e17098b6910da0d5208fe326103179", "message": "Merge branch 'master' into optimise-epoch-transition", "committedDate": "2020-12-02T22:28:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3MTU2MA==", "url": "https://github.com/ConsenSys/teku/pull/3265#discussion_r534671560", "bodyText": "typo? (EPOCH + x)", "author": "rolfyone", "createdAt": "2020-12-03T05:06:49Z", "path": "ethereum/core/src/test/java/tech/pegasys/teku/core/stategenerator/StateAtSlotTaskTest.java", "diffHunk": "@@ -26,19 +26,21 @@\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n import tech.pegasys.teku.core.ChainBuilder;\n+import tech.pegasys.teku.core.StateTransition;\n import tech.pegasys.teku.core.stategenerator.CachingTaskQueue.CacheableTask;\n-import tech.pegasys.teku.core.stategenerator.CheckpointStateTask.AsyncStateProvider;\n+import tech.pegasys.teku.core.stategenerator.StateAtSlotTask.AsyncStateProvider;\n import tech.pegasys.teku.datastructures.blocks.SignedBlockAndState;\n+import tech.pegasys.teku.datastructures.blocks.SlotAndBlockRoot;\n import tech.pegasys.teku.datastructures.forkchoice.InvalidCheckpointException;\n import tech.pegasys.teku.datastructures.state.BeaconState;\n import tech.pegasys.teku.datastructures.state.Checkpoint;\n import tech.pegasys.teku.datastructures.util.BeaconStateUtil;\n import tech.pegasys.teku.infrastructure.async.SafeFuture;\n import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n \n-class CheckpointStateTaskTest {\n-  private static final UInt64 EPOCH = UInt64.valueOf(2);\n-  private static final UInt64 EPOCH_START_SLOT = BeaconStateUtil.compute_start_slot_at_epoch(EPOCH);\n+class StateAtSlotTaskTest {\n+  private static final UInt64 EPOCHx = UInt64.valueOf(2);", "originalCommit": "846c433c75e17098b6910da0d5208fe326103179", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYxODczMw==", "url": "https://github.com/ConsenSys/teku/pull/3265#discussion_r535618733", "bodyText": "Fixed.", "author": "ajsutton", "createdAt": "2020-12-03T21:06:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3MTU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3NDEyNg==", "url": "https://github.com/ConsenSys/teku/pull/3265#discussion_r534674126", "bodyText": "might be able to use orElseGet instead here?", "author": "rolfyone", "createdAt": "2020-12-03T05:14:56Z", "path": "validator/coordinator/src/main/java/tech/pegasys/teku/validator/coordinator/BlockFactory.java", "diffHunk": "@@ -87,7 +94,12 @@ public BeaconBlock createUnsignedBlock(\n     }\n \n     // Collect attestations to include\n-    final BeaconState blockSlotState = stateTransition.process_slots(blockPreState, newSlot);\n+    final BeaconState blockSlotState;\n+    if (maybeBlockSlotState.isPresent()) {\n+      blockSlotState = maybeBlockSlotState.get();\n+    } else {\n+      blockSlotState = stateTransition.process_slots(blockPreState, newSlot);\n+    }", "originalCommit": "846c433c75e17098b6910da0d5208fe326103179", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYxODY1Ng==", "url": "https://github.com/ConsenSys/teku/pull/3265#discussion_r535618656", "bodyText": "ah I remember trying that before now.... process_slots can throw checked exceptions so it doesn't work well with orElseGet.", "author": "ajsutton", "createdAt": "2020-12-03T21:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3NDEyNg=="}], "type": "inlineReview"}, {"oid": "ecd6298b0607dbd54680db27f59c61973517bae1", "url": "https://github.com/ConsenSys/teku/commit/ecd6298b0607dbd54680db27f59c61973517bae1", "message": "Remove stray x.", "committedDate": "2020-12-03T21:06:33Z", "type": "commit"}, {"oid": "19646b35f7b6e9b359717bf853eb29f2cad3e117", "url": "https://github.com/ConsenSys/teku/commit/19646b35f7b6e9b359717bf853eb29f2cad3e117", "message": "Merge branch 'master' of github.com:ConsenSys/teku into optimise-epoch-transition", "committedDate": "2020-12-03T21:06:36Z", "type": "commit"}, {"oid": "e0b3c55148f8807f75b26539b6ed5f4cd20883f4", "url": "https://github.com/ConsenSys/teku/commit/e0b3c55148f8807f75b26539b6ed5f4cd20883f4", "message": "Merge branch 'optimise-epoch-transition' of github.com:ajsutton/teku into optimise-epoch-transition", "committedDate": "2020-12-03T21:06:44Z", "type": "commit"}, {"oid": "d4548888505a22a771b254b724cdfa0b6bb60669", "url": "https://github.com/ConsenSys/teku/commit/d4548888505a22a771b254b724cdfa0b6bb60669", "message": "Merge branch 'master' of github.com:ConsenSys/teku into optimise-epoch-transition", "committedDate": "2020-12-07T00:21:53Z", "type": "commit"}, {"oid": "5fc65f3130447fa541e6ce872fd37fea2b3183da", "url": "https://github.com/ConsenSys/teku/commit/5fc65f3130447fa541e6ce872fd37fea2b3183da", "message": "Merge branch 'master' of github.com:ConsenSys/teku into optimise-epoch-transition", "committedDate": "2020-12-07T00:21:57Z", "type": "commit"}, {"oid": "b29f1eb5c42586397fde8c75785f165cb1b7d336", "url": "https://github.com/ConsenSys/teku/commit/b29f1eb5c42586397fde8c75785f165cb1b7d336", "message": "Merge branch 'master' into optimise-epoch-transition", "committedDate": "2020-12-07T02:36:19Z", "type": "commit"}, {"oid": "7feba4470ff00b0d01c89335acc38e7bfad82766", "url": "https://github.com/ConsenSys/teku/commit/7feba4470ff00b0d01c89335acc38e7bfad82766", "message": "Merge branch 'master' into optimise-epoch-transition", "committedDate": "2020-12-07T22:55:30Z", "type": "commit"}, {"oid": "c4be4086a060b30d40fa20fbf94c33fa7ac0c5a4", "url": "https://github.com/ConsenSys/teku/commit/c4be4086a060b30d40fa20fbf94c33fa7ac0c5a4", "message": "Merge branch 'master' into optimise-epoch-transition", "committedDate": "2020-12-08T00:07:25Z", "type": "commit"}]}