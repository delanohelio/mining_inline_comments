{"pr_number": 2613, "pr_title": "Use Guava Cache when creating `LimitedMap` rather than `LinkedHashMap`", "pr_createdAt": "2020-08-19T01:16:57Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2613", "timeline": [{"oid": "45bf758e3bf1a61b494116030ea1c190c7d686f3", "url": "https://github.com/ConsenSys/teku/commit/45bf758e3bf1a61b494116030ea1c190c7d686f3", "message": "Use Guava Cache when creating `LimitedMap` rather than `LinkedHashMap`.\nConcurrent access safe by default (and much more efficiently than using synchronizedMap) and will fix an issue where LinkedHashMap was unexpectedly exceeding it's expected maximum size.\nOnly least recently used eviction is supported. This was used in all but one place which never accessed individual items anyway so is unaffected by the change.", "committedDate": "2020-08-19T01:14:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY0ODg2MA==", "url": "https://github.com/ConsenSys/teku/pull/2613#discussion_r472648860", "bodyText": "is it worth investigating if we can explicitly make a call to update the accessed time of what we actually want to use?", "author": "rolfyone", "createdAt": "2020-08-19T03:42:09Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/OperationPool.java", "diffHunk": "@@ -47,10 +45,12 @@ public OperationPool(Class<T> clazz, OperationStateTransitionValidator<T> operat\n \n   public SSZList<T> getItemsForBlock(BeaconState stateAtBlockSlot) {\n     SSZMutableList<T> itemsToPutInBlock =\n-        SSZList.createMutable(clazz, maxNumberOfElementsInBlock.get(clazz));\n+        SSZList.createMutable(clazz, MAX_NUMBER_OF_ELEMENTS_IN_BLOCK.get(clazz));\n+    // Note that iterating through all items does not affect their access time so we are effectively\n+    // evicting the oldest entries when the size is exceeded as we only ever access via iteration.", "originalCommit": "45bf758e3bf1a61b494116030ea1c190c7d686f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY1ODExOA==", "url": "https://github.com/ConsenSys/teku/pull/2613#discussion_r472658118", "bodyText": "We used to deliberately use evict oldest policy here so this is actually what we wanted.", "author": "ajsutton", "createdAt": "2020-08-19T03:57:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY0ODg2MA=="}], "type": "inlineReview"}]}