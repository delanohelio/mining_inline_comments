{"pr_number": 1333, "pr_title": "update beaconStateHandler to make use of DataProvider abstraction", "pr_createdAt": "2020-03-09T23:00:05Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1333", "timeline": [{"oid": "28f24cfaedd0f977d36961badcbbdf88d3f95449", "url": "https://github.com/ConsenSys/teku/commit/28f24cfaedd0f977d36961badcbbdf88d3f95449", "message": "addresses #1315\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-03-09T04:52:30Z", "type": "commit"}, {"oid": "0006b3246650dacc035c8e844a13f63380337ac5", "url": "https://github.com/ConsenSys/teku/commit/0006b3246650dacc035c8e844a13f63380337ac5", "message": "Merge remote-tracking branch 'upstream/master' into 1315-beaconStateHandler\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-03-09T22:54:04Z", "type": "commit"}, {"oid": "d6d4fc0f859bd0792a335f91db6c069d9d00d253", "url": "https://github.com/ConsenSys/teku/commit/d6d4fc0f859bd0792a335f91db6c069d9d00d253", "message": "Merge remote-tracking branch 'upstream/master' into 1315-beaconStateHandler", "committedDate": "2020-03-09T22:54:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMDUwMA==", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390030500", "bodyText": "we don't want to use ValidatorsUtil?", "author": "macfarla", "createdAt": "2020-03-10T00:19:57Z", "path": "data/provider/src/main/java/tech/pegasys/artemis/api/schema/BeaconValidators.java", "diffHunk": "@@ -105,7 +114,12 @@ public static long getEffectiveListSize(\n     if (!activeOnly) {\n       return list.size();\n     } else {\n-      return list.stream().filter(v -> ValidatorsUtil.is_active_validator(v, epoch)).count();\n+      return list.stream().filter(v -> is_active_validator(v, epoch)).count();\n     }\n   }\n+\n+  private static boolean is_active_validator(Validator validator, UnsignedLong epoch) {", "originalCommit": "d6d4fc0f859bd0792a335f91db6c069d9d00d253", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA0MTMxNg==", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390041316", "bodyText": "its a different class...", "author": "rolfyone", "createdAt": "2020-03-10T01:02:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMDUwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMDc3MA==", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390030770", "bodyText": "BLSPublicKeySerializer renamed as Fork is confusing", "author": "macfarla", "createdAt": "2020-03-10T00:20:58Z", "path": "data/provider/src/main/java/tech/pegasys/artemis/api/schema/Fork.java", "diffHunk": "@@ -11,18 +11,19 @@\n  * specific language governing permissions and limitations under the License.\n  */\n \n-package tech.pegasys.artemis.provider;\n+package tech.pegasys.artemis.api.schema;\n \n-import com.fasterxml.jackson.core.JsonGenerator;\n-import com.fasterxml.jackson.databind.JsonSerializer;\n-import com.fasterxml.jackson.databind.SerializerProvider;\n-import java.io.IOException;\n-import tech.pegasys.artemis.util.bls.BLSPublicKey;\n+import com.google.common.primitives.UnsignedLong;\n+import tech.pegasys.artemis.util.SSZTypes.Bytes4;\n \n-public class BLSPublicKeySerializer extends JsonSerializer<BLSPublicKey> {", "originalCommit": "d6d4fc0f859bd0792a335f91db6c069d9d00d253", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA0MTQ2Nw==", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390041467", "bodyText": "wow, that's not what happened at all, one got deleted and one got added... not sure why it'd think it's renamed...", "author": "rolfyone", "createdAt": "2020-03-10T01:03:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMDc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMTIzNA==", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390031234", "bodyText": "nice", "author": "macfarla", "createdAt": "2020-03-10T00:22:56Z", "path": "data/beaconrestapi/src/main/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconStateHandler.java", "diffHunk": "@@ -81,48 +82,40 @@ public BeaconStateHandler(\n   public void handle(Context ctx) throws Exception {\n     try {\n       final Map<String, List<String>> parameters = ctx.queryParamMap();\n-      SafeFuture<Optional<BeaconState>> future = null;\n+      SafeFuture<Optional<BeaconState>> future;\n       if (parameters.size() == 0) {\n         throw new IllegalArgumentException(\"No query parameters specified\");\n       }\n-      if (!combinedClient.isStoreAvailable()) {\n+      if (!provider.isStoreAvailable()) {\n         ctx.status(SC_NO_CONTENT);\n         return;\n       }\n \n       if (parameters.containsKey(ROOT)) {\n-        future = queryByRootHash(validateQueryParameter(parameters, ROOT));\n+        future = provider.getStateByBlockRoot(getParameterValueAsBytes32(parameters, ROOT));", "originalCommit": "d6d4fc0f859bd0792a335f91db6c069d9d00d253", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMjM2NQ==", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390032365", "bodyText": "do we need to create a new BeaconState here?", "author": "macfarla", "createdAt": "2020-03-10T00:27:23Z", "path": "data/beaconrestapi/src/test/java/tech/pegasys/artemis/beaconrestapi/beaconhandlers/BeaconStateHandlerTest.java", "diffHunk": "@@ -87,86 +91,67 @@ public void shouldReturnNotFoundWhenQueryAgainstMissingRootObject() throws Excep\n \n   @Test\n   public void shouldReturnBadRequestWhenNoParameterSpecified() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of());\n-\n     handler.handle(context);\n-\n     verify(context).status(SC_BAD_REQUEST);\n   }\n \n   @Test\n   public void shouldReturnBadRequestWhenBadSlotSpecified() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of(SLOT, List.of(\"not-an-int\")));\n-\n     handler.handle(context);\n-\n     verify(context).status(SC_BAD_REQUEST);\n   }\n \n   @Test\n   public void shouldReturnBadRequestWhenBadParamSpecified() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of(EPOCH, List.of(\"not-an-int\")));\n-\n     handler.handle(context);\n-\n     verify(context).status(SC_BAD_REQUEST);\n   }\n \n   @Test\n   public void shouldReturnBeaconStateObjectWhenQueryByRoot() throws Exception {\n-    final BeaconStateHandler handler =\n-        new BeaconStateHandler(combinedChainDataClient, jsonProvider);\n+    final BeaconStateHandler handler = new BeaconStateHandler(provider, jsonProvider);\n     when(context.queryParamMap()).thenReturn(Map.of(ROOT, List.of(blockRoot.toHexString())));\n \n     handler.handle(context);\n \n     verify(context).result(args.capture());\n     SafeFuture<String> data = args.getValue();\n-    assertEquals(data.get(), jsonProvider.objectToJSON(beaconState));\n+    assertEquals(data.get(), jsonProvider.objectToJSON(new BeaconState(beaconStateInternal)));", "originalCommit": "d6d4fc0f859bd0792a335f91db6c069d9d00d253", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMjkwNw==", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390032907", "bodyText": "nvm I get it. beaconStateInternal is the internal data structure", "author": "macfarla", "createdAt": "2020-03-10T00:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMjM2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMzIwMA==", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390033200", "bodyText": "might make it clearer to make it a method call getMeTheExternalRepresentationOfTheInternalState(beaconStateInternal)", "author": "macfarla", "createdAt": "2020-03-10T00:30:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMjM2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA0MTc4Ng==", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390041786", "bodyText": "we're constructing the actual object we can use... i think the bigger problem is where we mix the handling of both objects, then it gets confusing... i'm trying to clean it up, but its not quite right yet...", "author": "rolfyone", "createdAt": "2020-03-10T01:04:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMjM2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA0NTU4OA==", "url": "https://github.com/ConsenSys/teku/pull/1333#discussion_r390045588", "bodyText": "I just realised that object is already constructed above, i'll clean this one up and it'll be more clear...", "author": "rolfyone", "createdAt": "2020-03-10T01:20:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMjM2NQ=="}], "type": "inlineReview"}, {"oid": "3804955108b49a571078e144648d839a89d640a3", "url": "https://github.com/ConsenSys/teku/commit/3804955108b49a571078e144648d839a89d640a3", "message": "spotless", "committedDate": "2020-03-10T01:12:15Z", "type": "commit"}, {"oid": "2367598fb9ae842dbb8017c1c9797a21912f1173", "url": "https://github.com/ConsenSys/teku/commit/2367598fb9ae842dbb8017c1c9797a21912f1173", "message": "commit feedback, and build failure from merge issue.", "committedDate": "2020-03-10T01:25:44Z", "type": "commit"}, {"oid": "f86b296ff11fbc8895b29607774c655d917244e2", "url": "https://github.com/ConsenSys/teku/commit/f86b296ff11fbc8895b29607774c655d917244e2", "message": "Merge remote-tracking branch 'upstream/master' into 1315-beaconStateHandler", "committedDate": "2020-03-10T01:28:04Z", "type": "commit"}]}