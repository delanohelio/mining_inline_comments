{"pr_number": 2139, "pr_title": "Implement operation pools", "pr_createdAt": "2020-06-12T17:13:58Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2139", "timeline": [{"oid": "ff1e9b2e4b0cd3f1fa1e8d130ed1d259cc327651", "url": "https://github.com/ConsenSys/teku/commit/ff1e9b2e4b0cd3f1fa1e8d130ed1d259cc327651", "message": "Implement operation pool for storing operations", "committedDate": "2020-06-12T17:14:56Z", "type": "commit"}, {"oid": "fac60ccf9fc42d27532f01a41b8a67c5957ce732", "url": "https://github.com/ConsenSys/teku/commit/fac60ccf9fc42d27532f01a41b8a67c5957ce732", "message": "Implement operation pools", "committedDate": "2020-06-12T17:14:56Z", "type": "commit"}, {"oid": "39226dd45a3dbae3941c661df289111cef828a1b", "url": "https://github.com/ConsenSys/teku/commit/39226dd45a3dbae3941c661df289111cef828a1b", "message": "Integrate operation pools", "committedDate": "2020-06-12T17:14:56Z", "type": "commit"}, {"oid": "908cd74ed0c04e5b1b67791149db6dd7aa5fbc04", "url": "https://github.com/ConsenSys/teku/commit/908cd74ed0c04e5b1b67791149db6dd7aa5fbc04", "message": "Further integrate gossip consumers", "committedDate": "2020-06-12T17:14:56Z", "type": "commit"}, {"oid": "21b2204dee49489ef5e354f1d13de2a661ad97ea", "url": "https://github.com/ConsenSys/teku/commit/21b2204dee49489ef5e354f1d13de2a661ad97ea", "message": "Add attester slashing consumer to topic handler", "committedDate": "2020-06-12T17:14:56Z", "type": "commit"}, {"oid": "03ae43fdc545f42635e05670a2d2b38d210ba620", "url": "https://github.com/ConsenSys/teku/commit/03ae43fdc545f42635e05670a2d2b38d210ba620", "message": "Start fixing tests", "committedDate": "2020-06-12T17:14:56Z", "type": "commit"}, {"oid": "04a62b9697aef38daf2ca1c4e1a0df04ae92e3a0", "url": "https://github.com/ConsenSys/teku/commit/04a62b9697aef38daf2ca1c4e1a0df04ae92e3a0", "message": "Fix test issue and run spotless", "committedDate": "2020-06-12T17:14:56Z", "type": "commit"}, {"oid": "04a62b9697aef38daf2ca1c4e1a0df04ae92e3a0", "url": "https://github.com/ConsenSys/teku/commit/04a62b9697aef38daf2ca1c4e1a0df04ae92e3a0", "message": "Fix test issue and run spotless", "committedDate": "2020-06-12T17:14:56Z", "type": "forcePushed"}, {"oid": "b71f8cf0ce338a01bcd0f93ed8451f337068a51a", "url": "https://github.com/ConsenSys/teku/commit/b71f8cf0ce338a01bcd0f93ed8451f337068a51a", "message": "Remove redundant interface", "committedDate": "2020-06-12T17:16:14Z", "type": "commit"}, {"oid": "e924d63ff415e459e2f97c7bf5a95264406f3366", "url": "https://github.com/ConsenSys/teku/commit/e924d63ff415e459e2f97c7bf5a95264406f3366", "message": "Remove verified block operations from pools", "committedDate": "2020-06-12T17:27:18Z", "type": "commit"}, {"oid": "71b977d38740ea87771339e2d647ae6a206f4f5f", "url": "https://github.com/ConsenSys/teku/commit/71b977d38740ea87771339e2d647ae6a206f4f5f", "message": "Run spotless & small fixes", "committedDate": "2020-06-12T17:33:07Z", "type": "commit"}, {"oid": "0ffdb6dacdf6bb3e38c9d919e809da766b70d327", "url": "https://github.com/ConsenSys/teku/commit/0ffdb6dacdf6bb3e38c9d919e809da766b70d327", "message": "Remove redundant validation", "committedDate": "2020-06-12T17:34:35Z", "type": "commit"}, {"oid": "df628ab80c9708a40f38523affd385dc628cd257", "url": "https://github.com/ConsenSys/teku/commit/df628ab80c9708a40f38523affd385dc628cd257", "message": "Fix block factory tests", "committedDate": "2020-06-12T17:51:40Z", "type": "commit"}, {"oid": "f918acc2ac97502d7d06c585fabaabb74e58573e", "url": "https://github.com/ConsenSys/teku/commit/f918acc2ac97502d7d06c585fabaabb74e58573e", "message": "Add tests & make small fix", "committedDate": "2020-06-12T19:52:39Z", "type": "commit"}, {"oid": "e1aa3b45e1a91deb7fee9b231cab8bacc27b473a", "url": "https://github.com/ConsenSys/teku/commit/e1aa3b45e1a91deb7fee9b231cab8bacc27b473a", "message": "Run spotless", "committedDate": "2020-06-12T19:55:44Z", "type": "commit"}, {"oid": "3206b84cc1994ba493b356a3b576c6dfe3231b66", "url": "https://github.com/ConsenSys/teku/commit/3206b84cc1994ba493b356a3b576c6dfe3231b66", "message": "Add test", "committedDate": "2020-06-12T20:07:57Z", "type": "commit"}, {"oid": "b17a5a74719b3caf81eda11261136cb4299f1076", "url": "https://github.com/ConsenSys/teku/commit/b17a5a74719b3caf81eda11261136cb4299f1076", "message": "Run spotless", "committedDate": "2020-06-12T20:08:55Z", "type": "commit"}, {"oid": "17613874d19c10aa12796d49631f8325c686429b", "url": "https://github.com/ConsenSys/teku/commit/17613874d19c10aa12796d49631f8325c686429b", "message": "Improve test function names", "committedDate": "2020-06-12T20:11:44Z", "type": "commit"}, {"oid": "bb15a64ab633b13b6b8d3da806e8e8978f7bbf0b", "url": "https://github.com/ConsenSys/teku/commit/bb15a64ab633b13b6b8d3da806e8e8978f7bbf0b", "message": "Change interface method argument name", "committedDate": "2020-06-12T20:15:30Z", "type": "commit"}, {"oid": "4317929f19713a5d20cb4c590776e8d348ea08e3", "url": "https://github.com/ConsenSys/teku/commit/4317929f19713a5d20cb4c590776e8d348ea08e3", "message": "Change interface method name", "committedDate": "2020-06-12T20:15:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyMTc3MA==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439621770", "bodyText": "This this intended to always be a single method?:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public interface OperationStateTransitionValidator<T> {\n          \n          \n            \n            @FunctionalInterface\n          \n          \n            \n            public interface OperationStateTransitionValidator<T> {", "author": "mbaxter", "createdAt": "2020-06-12T20:12:16Z", "path": "ethereum/core/src/main/java/tech/pegasys/teku/core/operationvalidators/OperationStateTransitionValidator.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.core.operationvalidators;\n+\n+import java.util.Optional;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n+\n+public interface OperationStateTransitionValidator<T> {", "originalCommit": "b17a5a74719b3caf81eda11261136cb4299f1076", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0NTIzMw==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439645233", "bodyText": "Not sure. But I'll add the modifier for now. It's only for legibility purposes, right?", "author": "cemozerr", "createdAt": "2020-06-12T21:15:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyMTc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyMzQ3Nw==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439623477", "bodyText": "There's an @Mock annotation you can use that works with generics:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              @SuppressWarnings(\"unchecked\")\n          \n          \n            \n              private final GossipedOperationConsumer<ValidateableAttestation> gossipedAttestationConsumer =\n          \n          \n            \n                  mock(GossipedOperationConsumer.class);\n          \n          \n            \n              @Mock\n          \n          \n            \n              private GossipedOperationConsumer<ValidateableAttestation> gossipedAttestationConsumer;\n          \n      \n    \n    \n  \n\nIf you go with this, you need to annotate the test class with @ExtendWith(MockitoExtension.class) I think.", "author": "mbaxter", "createdAt": "2020-06-12T20:16:40Z", "path": "networking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/AggregateGossipManagerTest.java", "diffHunk": "@@ -40,8 +40,10 @@\n   private final GossipNetwork gossipNetwork = mock(GossipNetwork.class);\n   private final GossipEncoding gossipEncoding = GossipEncoding.SSZ_SNAPPY;\n   private final TopicChannel topicChannel = mock(TopicChannel.class);\n-  private final GossipedAttestationConsumer gossipedAttestationConsumer =\n-      mock(GossipedAttestationConsumer.class);\n+\n+  @SuppressWarnings(\"unchecked\")\n+  private final GossipedOperationConsumer<ValidateableAttestation> gossipedAttestationConsumer =\n+      mock(GossipedOperationConsumer.class);", "originalCommit": "b17a5a74719b3caf81eda11261136cb4299f1076", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0NjM5Mg==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439646392", "bodyText": "Apparently to be able to use MockitoExtension.classwe need to import\norg.mockito:mockito-junit-jupiter. Not sure if it's worth the effort since @SupressWarning(\"unchecked\") serves basically the same purpose in the testing code and is fewer lines of code.", "author": "cemozerr", "createdAt": "2020-06-12T21:18:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyMzQ3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyNzQ1MA==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439627450", "bodyText": "I think you could simplify this by keeping maxNumberOfElements as an instance var:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public OperationPool(Class<T> clazz, OperationStateTransitionValidator<T> operationValidator) {\n          \n          \n            \n                this.clazz = clazz;\n          \n          \n            \n                this.operationValidator = operationValidator;\n          \n          \n            \n              }\n          \n          \n            \n              public OperationPool(Class<T> clazz, OperationStateTransitionValidator<T> operationValidator) {\n          \n          \n            \n                this.operationValidator = operationValidator;\n          \n          \n            \n                this.maxNumberOfElements = maxNumberOfElementsInBlock.get(clazz);\n          \n          \n            \n              }\n          \n      \n    \n    \n  \n\nOr even cutting out clazz altogether:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public OperationPool(Class<T> clazz, OperationStateTransitionValidator<T> operationValidator) {\n          \n          \n            \n                this.clazz = clazz;\n          \n          \n            \n                this.operationValidator = operationValidator;\n          \n          \n            \n              }\n          \n          \n            \n              public OperationPool(OperationStateTransitionValidator<T> operationValidator, final int maxElements) {\n          \n          \n            \n                this.operationValidator = operationValidator;\n          \n          \n            \n                this.maxNumberOfElements = maxElements;\n          \n          \n            \n              }", "author": "mbaxter", "createdAt": "2020-06-12T20:26:56Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/OperationPool.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.statetransition;\n+\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.Set;\n+import tech.pegasys.teku.core.operationvalidators.OperationStateTransitionValidator;\n+import tech.pegasys.teku.datastructures.operations.AttesterSlashing;\n+import tech.pegasys.teku.datastructures.operations.ProposerSlashing;\n+import tech.pegasys.teku.datastructures.operations.SignedVoluntaryExit;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n+import tech.pegasys.teku.ssz.SSZTypes.SSZList;\n+import tech.pegasys.teku.ssz.SSZTypes.SSZMutableList;\n+import tech.pegasys.teku.util.config.Constants;\n+\n+public class OperationPool<T> {\n+\n+  private static Map<Class<?>, Integer> maxNumberOfElementsInBlock =\n+      Map.of(\n+          SignedVoluntaryExit.class, Constants.MAX_VOLUNTARY_EXITS,\n+          ProposerSlashing.class, Constants.MAX_PROPOSER_SLASHINGS,\n+          AttesterSlashing.class, Constants.MAX_ATTESTER_SLASHINGS);\n+\n+  private Set<T> operations = new HashSet<>();\n+  private OperationStateTransitionValidator<T> operationValidator;\n+  private Class<T> clazz;\n+\n+  public OperationPool(Class<T> clazz, OperationStateTransitionValidator<T> operationValidator) {\n+    this.clazz = clazz;\n+    this.operationValidator = operationValidator;\n+  }", "originalCommit": "4317929f19713a5d20cb4c590776e8d348ea08e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0NzYwOQ==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439647609", "bodyText": "I like the idea of having the maxNumberOfELements get set inside the operation pool depending on class rather than someone being able to set them whatever they want. So I'll go with the first suggestion.", "author": "cemozerr", "createdAt": "2020-06-12T21:22:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyNzQ1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0ODM5OQ==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439648399", "bodyText": "Oh actually we do need the class information because we can't create the type-specific SSZMutableList if we don't.", "author": "cemozerr", "createdAt": "2020-06-12T21:24:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyNzQ1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0ODQ1OQ==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439648459", "bodyText": "So unfortunately we can't make this change.", "author": "cemozerr", "createdAt": "2020-06-12T21:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyNzQ1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyODA1Ng==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439628056", "bodyText": "Do you want to remove the element even if it wasn't included?  What if its valid for a different fork?", "author": "mbaxter", "createdAt": "2020-06-12T20:28:27Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/OperationPool.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.statetransition;\n+\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.Set;\n+import tech.pegasys.teku.core.operationvalidators.OperationStateTransitionValidator;\n+import tech.pegasys.teku.datastructures.operations.AttesterSlashing;\n+import tech.pegasys.teku.datastructures.operations.ProposerSlashing;\n+import tech.pegasys.teku.datastructures.operations.SignedVoluntaryExit;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n+import tech.pegasys.teku.ssz.SSZTypes.SSZList;\n+import tech.pegasys.teku.ssz.SSZTypes.SSZMutableList;\n+import tech.pegasys.teku.util.config.Constants;\n+\n+public class OperationPool<T> {\n+\n+  private static Map<Class<?>, Integer> maxNumberOfElementsInBlock =\n+      Map.of(\n+          SignedVoluntaryExit.class, Constants.MAX_VOLUNTARY_EXITS,\n+          ProposerSlashing.class, Constants.MAX_PROPOSER_SLASHINGS,\n+          AttesterSlashing.class, Constants.MAX_ATTESTER_SLASHINGS);\n+\n+  private Set<T> operations = new HashSet<>();\n+  private OperationStateTransitionValidator<T> operationValidator;\n+  private Class<T> clazz;\n+\n+  public OperationPool(Class<T> clazz, OperationStateTransitionValidator<T> operationValidator) {\n+    this.clazz = clazz;\n+    this.operationValidator = operationValidator;\n+  }\n+\n+  public SSZList<T> getItemsForBlock(BeaconState stateAtBlockSlot) {\n+    SSZMutableList<T> itemsToPutInBlock =\n+        SSZList.createMutable(clazz, maxNumberOfElementsInBlock.get(clazz));\n+    Iterator<T> iter = operations.iterator();\n+    int count = 0;\n+    int numberOfElementsToGet = maxNumberOfElementsInBlock.get(clazz);\n+    while (count < numberOfElementsToGet && iter.hasNext()) {\n+      T item = iter.next();\n+      if (operationValidator.validate(stateAtBlockSlot, item).isEmpty()) {\n+        itemsToPutInBlock.add(item);\n+        count++;\n+      }\n+      iter.remove();", "originalCommit": "4317929f19713a5d20cb4c590776e8d348ea08e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYzNzU2OQ==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439637569", "bodyText": "I think we would deal with elements that are valid for a different fork in a follow-up PR since there are a good amount of places in the codebase we need to do that.", "author": "cemozerr", "createdAt": "2020-06-12T20:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyODA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0OTY1OQ==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439649659", "bodyText": "But these items we're dropping won't be recoverable right?  Suggested making the operations limited in size, in which case there shouldn't be a problem holding on to these.", "author": "mbaxter", "createdAt": "2020-06-12T21:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyODA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1MDQyOA==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439650428", "bodyText": "That's a fair point.", "author": "cemozerr", "createdAt": "2020-06-12T21:31:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyODA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1MDQ1OQ==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439650459", "bodyText": "Making the change.", "author": "cemozerr", "createdAt": "2020-06-12T21:31:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyODA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1MDQ5Mw==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439650493", "bodyText": "Or maybe it would be better to toss them into a limited reorg collection or something so we don't keep re-processing them ... In which case we could just leave it for a follow-up", "author": "mbaxter", "createdAt": "2020-06-12T21:31:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyODA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1MDY2MA==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439650660", "bodyText": "Done.", "author": "cemozerr", "createdAt": "2020-06-12T21:31:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyODA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1MjcyMg==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439652722", "bodyText": "I set the operations to 1000 for each pool, which shouldn't be too much of a processing issue. But I don't have any strong preference. Want me to drop the operations or keep them?", "author": "cemozerr", "createdAt": "2020-06-12T21:38:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyODA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1NjgyNw==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439656827", "bodyText": "Maybe it's better to just come back to the reorg handling - lets make sure there's a ticket for reorg handling that links to this line of code.", "author": "mbaxter", "createdAt": "2020-06-12T21:51:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYyODA1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYzMDk0MQ==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439630941", "bodyText": "We should probably verify that the consumer gets called where expected.", "author": "mbaxter", "createdAt": "2020-06-12T20:35:52Z", "path": "networking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/topics/AttesterSlashingTopicHandlerTest.java", "diffHunk": "@@ -46,7 +51,7 @@\n \n   private AttesterSlashingTopicHandler topicHandler =\n       new AttesterSlashingTopicHandler(\n-          gossipEncoding, dataStructureUtil.randomForkInfo(), validator);\n+          gossipEncoding, dataStructureUtil.randomForkInfo(), validator, consumer);", "originalCommit": "4317929f19713a5d20cb4c590776e8d348ea08e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0OTMwMw==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439649303", "bodyText": "Done for all 3 new topic handlers.", "author": "cemozerr", "createdAt": "2020-06-12T21:27:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYzMDk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYzMTkzOA==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439631938", "bodyText": "We should set these to a no-op value rather than leaving them null.", "author": "mbaxter", "createdAt": "2020-06-12T20:38:18Z", "path": "networking/eth2/src/testFixtures/java/tech/pegasys/teku/networking/eth2/Eth2NetworkFactory.java", "diffHunk": "@@ -89,7 +94,10 @@ public void stopAll() {\n     protected AsyncRunner asyncRunner;\n     protected EventBus eventBus;\n     protected RecentChainData recentChainData;\n-    protected GossipedAttestationConsumer gossipedAttestationConsumer;\n+    protected GossipedOperationConsumer<ValidateableAttestation> gossipedAttestationConsumer;\n+    protected GossipedOperationConsumer<AttesterSlashing> gossipedAttesterSlashingConsumer;\n+    protected GossipedOperationConsumer<ProposerSlashing> gossipedProposerSlashingConsumer;\n+    protected GossipedOperationConsumer<SignedVoluntaryExit> gossipedVoluntaryExitConsumer;", "originalCommit": "4317929f19713a5d20cb4c590776e8d348ea08e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1NjM5Mw==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439656393", "bodyText": "Done.", "author": "cemozerr", "createdAt": "2020-06-12T21:50:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYzMTkzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYzMjYyOQ==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439632629", "bodyText": "We should either set these to a no-op value by default, or validate() that they get set if we want them to be required.  I'd think setting them with no-op values is probably fine.", "author": "mbaxter", "createdAt": "2020-06-12T20:40:11Z", "path": "networking/eth2/src/main/java/tech/pegasys/teku/networking/eth2/Eth2NetworkBuilder.java", "diffHunk": "@@ -50,7 +54,10 @@\n   private Eth2Config eth2Config;\n   private EventBus eventBus;\n   private RecentChainData recentChainData;\n-  private GossipedAttestationConsumer gossipedAttestationConsumer;\n+  private GossipedOperationConsumer<ValidateableAttestation> gossipedAttestationConsumer;\n+  private GossipedOperationConsumer<AttesterSlashing> gossipedAttesterSlashingConsumer;\n+  private GossipedOperationConsumer<ProposerSlashing> gossipedProposerSlashingConsumer;\n+  private GossipedOperationConsumer<SignedVoluntaryExit> gossipedVoluntaryExitConsumer;", "originalCommit": "4317929f19713a5d20cb4c590776e8d348ea08e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1NTAyMw==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439655023", "bodyText": "Validating makes sense to me.", "author": "cemozerr", "createdAt": "2020-06-12T21:45:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYzMjYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYzNTYxNw==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439635617", "bodyText": "We should probably check that these actually get included.", "author": "mbaxter", "createdAt": "2020-06-12T20:47:47Z", "path": "validator/coordinator/src/test/java/tech/pegasys/teku/validator/coordinator/BlockFactoryTest.java", "diffHunk": "@@ -73,6 +90,9 @@\n   void setUp() {\n     when(depositProvider.getDeposits(any(), any())).thenReturn(deposits);\n     when(attestationsPool.getAttestationsForBlock(any())).thenReturn(attestations);\n+    when(attesterSlashingPool.getItemsForBlock(any())).thenReturn(attesterSlashings);\n+    when(proposerSlashingPool.getItemsForBlock(any())).thenReturn(proposerSlashings);\n+    when(voluntaryExitPool.getItemsForBlock(any())).thenReturn(voluntaryExits);", "originalCommit": "4317929f19713a5d20cb4c590776e8d348ea08e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1MjIzOQ==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439652239", "bodyText": "Good catch. Done.", "author": "cemozerr", "createdAt": "2020-06-12T21:36:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYzNTYxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0OTA3MA==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439649070", "bodyText": "We probably want to limit the size of this right?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Set<T> operations = new HashSet<>();\n          \n          \n            \n              private Set<T> operations = LimitedSet.create(...);", "author": "mbaxter", "createdAt": "2020-06-12T21:26:51Z", "path": "ethereum/statetransition/src/main/java/tech/pegasys/teku/statetransition/OperationPool.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.statetransition;\n+\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.Set;\n+import tech.pegasys.teku.core.operationvalidators.OperationStateTransitionValidator;\n+import tech.pegasys.teku.datastructures.operations.AttesterSlashing;\n+import tech.pegasys.teku.datastructures.operations.ProposerSlashing;\n+import tech.pegasys.teku.datastructures.operations.SignedVoluntaryExit;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n+import tech.pegasys.teku.ssz.SSZTypes.SSZList;\n+import tech.pegasys.teku.ssz.SSZTypes.SSZMutableList;\n+import tech.pegasys.teku.util.config.Constants;\n+\n+public class OperationPool<T> {\n+\n+  private static Map<Class<?>, Integer> maxNumberOfElementsInBlock =\n+      Map.of(\n+          SignedVoluntaryExit.class, Constants.MAX_VOLUNTARY_EXITS,\n+          ProposerSlashing.class, Constants.MAX_PROPOSER_SLASHINGS,\n+          AttesterSlashing.class, Constants.MAX_ATTESTER_SLASHINGS);\n+\n+  private Set<T> operations = new HashSet<>();", "originalCommit": "4317929f19713a5d20cb4c590776e8d348ea08e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0OTY0Nw==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439649647", "bodyText": "Yeah we probably do. Any suggestions on the sizes of these sets?", "author": "cemozerr", "createdAt": "2020-06-12T21:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0OTA3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1MTAyNA==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439651024", "bodyText": "Done. Put 1000 for now.", "author": "cemozerr", "createdAt": "2020-06-12T21:32:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY0OTA3MA=="}], "type": "inlineReview"}, {"oid": "df62ef05e22ac6761aead91397b3628d56b0a2d6", "url": "https://github.com/ConsenSys/teku/commit/df62ef05e22ac6761aead91397b3628d56b0a2d6", "message": "Make variables final and test valid operation does get forwarded", "committedDate": "2020-06-12T21:27:58Z", "type": "commit"}, {"oid": "f9609f3b817d64701f0c557e00783c294719429c", "url": "https://github.com/ConsenSys/teku/commit/f9609f3b817d64701f0c557e00783c294719429c", "message": "Use limited set for pools and check block factory includes new operations", "committedDate": "2020-06-12T21:40:04Z", "type": "commit"}, {"oid": "ce707aa3fc679a0437c51b4c2766309601d65072", "url": "https://github.com/ConsenSys/teku/commit/ce707aa3fc679a0437c51b4c2766309601d65072", "message": "Validate gossiped operation consumers get set", "committedDate": "2020-06-12T21:46:06Z", "type": "commit"}, {"oid": "a500f8e07e032ed60da64fe1b95bba3d02bae8b7", "url": "https://github.com/ConsenSys/teku/commit/a500f8e07e032ed60da64fe1b95bba3d02bae8b7", "message": "Add noop consumers for Eth2NetworkFactory", "committedDate": "2020-06-12T21:49:17Z", "type": "commit"}, {"oid": "2bde15f7165f0fb3dadb11f17097d4cfc33b7fc5", "url": "https://github.com/ConsenSys/teku/commit/2bde15f7165f0fb3dadb11f17097d4cfc33b7fc5", "message": "Run spotless", "committedDate": "2020-06-12T21:51:58Z", "type": "commit"}, {"oid": "476baae17d9131595764ac1fa2817103c184979b", "url": "https://github.com/ConsenSys/teku/commit/476baae17d9131595764ac1fa2817103c184979b", "message": "Merge branch 'master' into implementOperationPools", "committedDate": "2020-06-12T21:52:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1ODAyOA==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r439658028", "bodyText": "We should also verify this isn't called in the other cases :D", "author": "mbaxter", "createdAt": "2020-06-12T21:56:09Z", "path": "networking/eth2/src/test/java/tech/pegasys/teku/networking/eth2/gossip/topics/AttesterSlashingTopicHandlerTest.java", "diffHunk": "@@ -60,6 +66,7 @@ public void handleMessage_validSlashing() {\n     Bytes serialized = gossipEncoding.encode(slashing);\n     final ValidationResult result = topicHandler.handleMessage(serialized);\n     assertThat(result).isEqualTo(ValidationResult.Valid);\n+    verify(consumer).forward(slashing);", "originalCommit": "476baae17d9131595764ac1fa2817103c184979b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIyMzU4NA==", "url": "https://github.com/ConsenSys/teku/pull/2139#discussion_r440223584", "bodyText": "Great point. I've added the checks.", "author": "cemozerr", "createdAt": "2020-06-15T14:38:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY1ODAyOA=="}], "type": "inlineReview"}, {"oid": "5abe7448b48ef2474afdbf412b5a7a2c1a6c41b0", "url": "https://github.com/ConsenSys/teku/commit/5abe7448b48ef2474afdbf412b5a7a2c1a6c41b0", "message": "Add more checks to tests", "committedDate": "2020-06-15T14:44:38Z", "type": "commit"}, {"oid": "a2d2a2e6b701def975656022cea48eceff1cfc48", "url": "https://github.com/ConsenSys/teku/commit/a2d2a2e6b701def975656022cea48eceff1cfc48", "message": "Merge branch 'master' into implementOperationPools", "committedDate": "2020-06-15T15:00:15Z", "type": "commit"}]}