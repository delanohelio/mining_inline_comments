{"pr_number": 2170, "pr_title": "Bump Solr 8.6.0", "pr_createdAt": "2020-07-15T20:52:28Z", "pr_url": "https://github.com/JanusGraph/janusgraph/pull/2170", "timeline": [{"oid": "ac7747535f29ada2d04185a2c419ab39b828905c", "url": "https://github.com/JanusGraph/janusgraph/commit/ac7747535f29ada2d04185a2c419ab39b828905c", "message": "Bump Solr 8.4.1\n\n* Remove ganglia\n\nFixes #1569\n\nSigned-off-by: Jan Jansen <jan.jansen@gdata.de>", "committedDate": "2020-07-15T21:09:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM4ODYzMQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455388631", "bodyText": "Why this address has changed?", "author": "porunov", "createdAt": "2020-07-15T21:57:04Z", "path": "janusgraph-solr/pom.xml", "diffHunk": "@@ -250,7 +282,7 @@\n                             <systemProperties>\n                                 <property>\n                                     <name>index.search.solr.zookeeper-url</name>\n-                                    <value>0.0.0.0:2181</value>\n+                                    <value>172.17.0.1:9983</value>", "originalCommit": "ac7747535f29ada2d04185a2c419ab39b828905c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzNDI2OQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455534269", "bodyText": "This address is the docker default gateway address. It would like to get rid of it. Beside this PR i also done some work on testcontainers which would cleanup this part.", "author": "farodin91", "createdAt": "2020-07-16T06:19:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM4ODYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM4OTMyMg==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455389322", "bodyText": "I didn't check, but why zookeeper is removed?", "author": "porunov", "createdAt": "2020-07-15T21:58:41Z", "path": "janusgraph-solr/pom.xml", "diffHunk": "@@ -328,7 +343,6 @@\n                                         </volumes>\n                                         <cmd>bash -c 'import-collections'</cmd>\n                                         <links>\n-                                            <link>zookeeper</link>", "originalCommit": "ac7747535f29ada2d04185a2c419ab39b828905c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzNDY0OQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455534649", "bodyText": "Zookeeper is include in solr if you are using different command to start solr as before my changes.", "author": "farodin91", "createdAt": "2020-07-16T06:20:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM4OTMyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM4OTY0NQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455389645", "bodyText": "Same here, don't understand why the address changed", "author": "porunov", "createdAt": "2020-07-15T21:59:27Z", "path": "janusgraph-solr/src/test/resources/import-collections.sh", "diffHunk": "@@ -15,7 +15,7 @@\n \n set -x\n \n-until $(curl --output /dev/null --silent --head --fail http://solr:8983); do sleep 5; done\n-for core in $(cat /tmp/collections.txt); do /opt/solr/server/scripts/cloud-scripts/zkcli.sh -zkhost zookeeper:2181 -cmd upconfig -confdir mydata -confname $core; done\n+until $(curl --output /dev/null --silent --head --fail http://172.17.0.1:8983); do sleep 5; done\n+for core in $(cat /tmp/collections.txt); do /opt/solr/server/scripts/cloud-scripts/zkcli.sh -zkhost 172.17.0.1:9983 -cmd upconfig -confdir mydata -confname $core; done", "originalCommit": "ac7747535f29ada2d04185a2c419ab39b828905c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM5MTMyMw==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455391323", "bodyText": "As I understand this PR upgrade Solr to 8.4.1 but we say that it is tested with Solr 8.5.2. Also, Can't we use Solr 8.6.0? If that's hard to upgrade to 8.6.0, I am totally fine with 8.4.1", "author": "porunov", "createdAt": "2020-07-15T22:03:19Z", "path": "docs/changelog.md", "diffHunk": "@@ -63,7 +63,7 @@ compile \"org.janusgraph:janusgraph-core:0.6.0\"\n * Oracle BerkeleyJE 7.5.11\n * Elasticsearch 6.0.1, 6.6.0, 7.6.2\n * Apache Lucene 7.0.0\n-* Apache Solr 7.0.0\n+* Apache Solr 7.7.2, 8.5.2", "originalCommit": "ac7747535f29ada2d04185a2c419ab39b828905c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "31bcb155a67642324990f10b7481b20a6a83a7c6", "url": "https://github.com/JanusGraph/janusgraph/commit/31bcb155a67642324990f10b7481b20a6a83a7c6", "message": "Bump Solr 8.6.0\n\n* Remove ganglia\n* Bump lucene backend to 8.6.0\n\nFixes #1569\n\nSigned-off-by: Jan Jansen <jan.jansen@gdata.de>", "committedDate": "2020-07-16T07:22:45Z", "type": "forcePushed"}, {"oid": "4116223974210f3fa2a49c63332b1a9fdc9a2b19", "url": "https://github.com/JanusGraph/janusgraph/commit/4116223974210f3fa2a49c63332b1a9fdc9a2b19", "message": "Bump Solr 8.6.0\n\n* Remove ganglia\n* Bump lucene backend to 8.6.0\n\nFixes #1569\n\nSigned-off-by: Jan Jansen <jan.jansen@gdata.de>", "committedDate": "2020-07-16T07:23:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyNzcwMQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455627701", "bodyText": "As described here: https://docs.datastax.com/en/developer/java-driver/3.5/manual/metrics/#metrics-4-compatibility\nWe need to add metrics-jmx also in out classpath.\nWe are getting NoClassDefFoundError: com/codahale/metrics/JmxReporter here: https://travis-ci.org/github/JanusGraph/janusgraph/jobs/708630586\nI think we can add 4.1.5 version of the required lib. I.e.:\n<dependency>\n    <groupId>io.dropwizard.metrics</groupId>\n    <artifactId>metrics-jmx</artifactId>\n    <version>${metrics.version}</version>\n</dependency>\n\nAlso, as metrics update indirectly reflects cql, I would use [full build] in the comment to be sure that those tests don't fail.", "author": "porunov", "createdAt": "2020-07-16T08:49:29Z", "path": "pom.xml", "diffHunk": "@@ -75,7 +75,7 @@\n         <mrunit.version>1.1.0</mrunit.version>\n         <mockito.version>2.23.0</mockito.version>\n         <jamm.version>0.3.0</jamm.version>\n-        <metrics.version>3.2.6</metrics.version>\n+        <metrics.version>4.1.5</metrics.version>", "originalCommit": "4116223974210f3fa2a49c63332b1a9fdc9a2b19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYzOTAyNQ==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455639025", "bodyText": "done let's hope.", "author": "farodin91", "createdAt": "2020-07-16T09:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyNzcwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY2NzYwNw==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455667607", "bodyText": "Also, I guess, we need to use withoutJMXReporting() when constructing CQL client right now as described in the upgrade guide. It says that if we want to use JmxReporter we need to use it in the following way:\nCluster cluster = Cluster.builder()\n        .withoutJMXReporting()\n        .build();\nJmxReporter reporter =\n    JmxReporter.forRegistry(cluster.getMetrics().getRegistry())\n        .inDomain(cluster.getClusterName() + \"-metrics\")\n        .build();\nreporter.start();\n\nI guess, if user sets a configuration property metrics.jmx.enabled=true we need to enable JmxReporter, otherwise we don't need to do it.\nMy assumption is that we need always use builder.withoutJMXReporting() when contrasting CQL Cluster. After CQL cluster is build, I think we could use some logic to start JmxReporter. I am not sure here and didn't test it, but I think something like the following code could be used:\nprivate void initializeJMXReporterIfEnabled(final Configuration configuration) throws PermanentBackendException {\n    if(configuration.get(METRICS_JMX_ENABLED)){\n        JmxReporter.Builder jmxBuilder = JmxReporter.forRegistry(cluster.getMetrics().getRegistry());\n        if(configuration.has(METRICS_JMX_DOMAIN)){\n            jmxBuilder = jmxBuilder.inDomain(configuration.get(METRICS_JMX_DOMAIN));\n        }\n        if(configuration.has(METRICS_JMX_AGENTID)){\n            List<MBeanServer> mBeanServers = MBeanServerFactory.findMBeanServer(configuration.get(METRICS_JMX_AGENTID));\n            if(mBeanServers.isEmpty()){\n                throw new PermanentBackendException(\"Didn't find mBeanServer with id \"+configuration.get(METRICS_JMX_AGENTID));\n            } else if(mBeanServers.size()>1){\n                throw new PermanentBackendException(\"Found multiple mBeanServers with id \"\n                    +configuration.get(METRICS_JMX_AGENTID)+\" but had to find only a single mBeanServer. \"+\n                    \"The next mBeanServers are found: \"\n                    +mBeanServers.stream().map(Object::toString).collect(Collectors.joining(\", \")));\n            }\n            jmxBuilder.registerWith(mBeanServers.get(0));\n        }\n        JmxReporter reporter = jmxBuilder.build();\n        reporter.start();\n    }\n}\n\nThat said, I didn't test if the above code works and didn't work with JmxReporter, so can't be sure on this.", "author": "porunov", "createdAt": "2020-07-16T09:54:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyNzcwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY4NTE2NA==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455685164", "bodyText": "I think what be better to deactivate it and in your pr we use the newer client. This would leader that your PR would be a blocker for 0.6 which is okay for me.", "author": "farodin91", "createdAt": "2020-07-16T10:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyNzcwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY5MjgxOA==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455692818", "bodyText": "After a little bit of research, I think the above code can be simplified because we are already registering JMXReporter if it is enabled.\n\nWhile building a CQL Cluster we need to add:\n\nbuilder.withoutJMXReporting();\n\n\nAfter the cluster is build we need to register CQL cluster metrics with our JMXReporter:\n\nMetricManager.INSTANCE.getRegistry().registerAll(cluster.getMetrics().getRegistry());\n\nI guess that's it but again, I didn't test it.\nThe related PR which automatically adds listeners has been merged in Dropwizard 4.1: dropwizard/metrics#1393\nSo, I guess it should work because we are updating out metrics to 4.1.5 in this PR.", "author": "porunov", "createdAt": "2020-07-16T10:40:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyNzcwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY5OTA2Ng==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455699066", "bodyText": "@farodin91 I'm OK with introducing a blocker but I would suggest to try the next approach before introducing a blocker: #2170 (comment)\nIf that works, we will be able to merge this PR without introducing a blocker", "author": "porunov", "createdAt": "2020-07-16T10:52:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyNzcwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY5OTI1NA==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455699254", "bodyText": "I added some lines to cql driver.", "author": "farodin91", "createdAt": "2020-07-16T10:52:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyNzcwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTcwMTc2Mg==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455701762", "bodyText": "Will wait for TravisCI to complete. If all tests pass, I will test this PR internally also.", "author": "porunov", "createdAt": "2020-07-16T10:57:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyNzcwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc2NzUzMg==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455767532", "bodyText": "You can't disable in the hadoop section easily jmx", "author": "farodin91", "createdAt": "2020-07-16T13:01:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyNzcwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc3NTY5OA==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455775698", "bodyText": "We could move org.janusgraph.hadoop for cql into its own project and try shading.", "author": "farodin91", "createdAt": "2020-07-16T13:14:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyNzcwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc4MjY4Mw==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455782683", "bodyText": "I found a possible solution.", "author": "farodin91", "createdAt": "2020-07-16T13:24:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyNzcwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgwMTgwMg==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r455801802", "bodyText": "You are genius. I even didn't think to include JmxReporter into the classpath. Tested locally CQLScanJobIT - all 3 tests passed.", "author": "porunov", "createdAt": "2020-07-16T13:51:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyNzcwMQ=="}], "type": "inlineReview"}, {"oid": "f015b641f56492908d458e84fb1d21bb4a529b86", "url": "https://github.com/JanusGraph/janusgraph/commit/f015b641f56492908d458e84fb1d21bb4a529b86", "message": "Bump Solr 8.6.0 [full build]\n\n* Bump io.dropwizard 4.1.5\n* Remove ganglia\n* Bump lucene backend to 8.6.0\n\nFixes #1569\n\nSigned-off-by: Jan Jansen <jan.jansen@gdata.de>", "committedDate": "2020-07-16T09:04:50Z", "type": "forcePushed"}, {"oid": "aae1e1820c4ae08653f02e1ea5f9e5800654a7ac", "url": "https://github.com/JanusGraph/janusgraph/commit/aae1e1820c4ae08653f02e1ea5f9e5800654a7ac", "message": "Bump Solr 8.6.0 [full build]\n\n* Bump io.dropwizard 4.1.5\n* Remove ganglia\n* Bump lucene backend to 8.6.0\n\nFixes #1569\n\nSigned-off-by: Jan Jansen <jan.jansen@gdata.de>", "committedDate": "2020-07-16T10:52:04Z", "type": "forcePushed"}, {"oid": "8c4fd002bbbe4077f290e18de1e3730fa60d729c", "url": "https://github.com/JanusGraph/janusgraph/commit/8c4fd002bbbe4077f290e18de1e3730fa60d729c", "message": " Bump Solr 8.6.0 [full build]\n\n* Bump io.dropwizard 4.1.5\n* Remove ganglia\n* Bump lucene backend to 8.6.0\n* Blind copy of the JmxReporter from version 3.2.6\n\nFixes #1569\n\nSigned-off-by: Jan Jansen <jan.jansen@gdata.de>", "committedDate": "2020-07-16T13:25:06Z", "type": "forcePushed"}, {"oid": "ae79f8e81e7778c76b9fa6ea92caef3b6b732d2c", "url": "https://github.com/JanusGraph/janusgraph/commit/ae79f8e81e7778c76b9fa6ea92caef3b6b732d2c", "message": "use 4.1 jmx [full build]", "committedDate": "2020-07-16T14:33:17Z", "type": "forcePushed"}, {"oid": "4fc1aa2287001f1443fe38836efdde4dae52617e", "url": "https://github.com/JanusGraph/janusgraph/commit/4fc1aa2287001f1443fe38836efdde4dae52617e", "message": " Bump Solr 8.6.0 [full build]\n\n* Bump io.dropwizard 4.1.5\n* Remove ganglia\n* Bump lucene backend to 8.6.0\n* Blind copy of the JmxReporter from version 4.1\n\nFixes #1569\n\nSigned-off-by: Jan Jansen <jan.jansen@gdata.de>", "committedDate": "2020-07-16T20:01:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU1MDc4MA==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r456550780", "bodyText": "Should it be 8.6.0?", "author": "porunov", "createdAt": "2020-07-17T16:35:20Z", "path": "janusgraph-solr/pom.xml", "diffHunk": "@@ -11,15 +11,23 @@\n     <url>https://janusgraph.org</url>\n     <properties>\n         <top.level.basedir>${basedir}/..</top.level.basedir>\n-        <solr7.test.version>7.0.0</solr7.test.version>\n-        <solr.test.version>${solr7.test.version}</solr.test.version>\n+        <solr7.test.version>7.7.2</solr7.test.version>\n+        <solr8.test.version>8.4.1</solr8.test.version>", "originalCommit": "4fc1aa2287001f1443fe38836efdde4dae52617e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njg3NjU5Mg==", "url": "https://github.com/JanusGraph/janusgraph/pull/2170#discussion_r456876592", "bodyText": "Done", "author": "farodin91", "createdAt": "2020-07-19T08:06:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU1MDc4MA=="}], "type": "inlineReview"}, {"oid": "3ae3db4a73ed0c92db8877927b6e16a3832a1b55", "url": "https://github.com/JanusGraph/janusgraph/commit/3ae3db4a73ed0c92db8877927b6e16a3832a1b55", "message": " Bump Solr 8.6.0 [full build]\n\n* Bump io.dropwizard 4.1.5\n* Remove ganglia\n* Bump lucene backend to 8.6.0\n* Blind copy of the JmxReporter from version 4.1\n\nFixes #1569\n\nSigned-off-by: Jan Jansen <jan.jansen@gdata.de>", "committedDate": "2020-07-19T08:05:57Z", "type": "forcePushed"}, {"oid": "d9b05c8a59d3fdc035b72630bca449aee9734db5", "url": "https://github.com/JanusGraph/janusgraph/commit/d9b05c8a59d3fdc035b72630bca449aee9734db5", "message": " Bump Solr 8.6.0 [full build]\n\n* Bump io.dropwizard 4.1.5\n* Remove ganglia\n* Bump lucene backend to 8.6.0\n* Blind copy of the JmxReporter from version 4.1\n\nFixes #1569\n\nSigned-off-by: Jan Jansen <jan.jansen@gdata.de>", "committedDate": "2020-07-19T19:52:01Z", "type": "forcePushed"}, {"oid": "2b743e0bf008d8875071458516b4f82c66ac89eb", "url": "https://github.com/JanusGraph/janusgraph/commit/2b743e0bf008d8875071458516b4f82c66ac89eb", "message": " Bump Solr 8.6.0 [full build]\n\n* Bump io.dropwizard 4.1.5\n* Remove ganglia\n* Bump lucene backend to 8.6.0\n* Blind copy of the JmxReporter from version 4.1\n\nFixes #1569\n\nSigned-off-by: Jan Jansen <jan.jansen@gdata.de>", "committedDate": "2020-07-19T19:53:02Z", "type": "commit"}, {"oid": "2b743e0bf008d8875071458516b4f82c66ac89eb", "url": "https://github.com/JanusGraph/janusgraph/commit/2b743e0bf008d8875071458516b4f82c66ac89eb", "message": " Bump Solr 8.6.0 [full build]\n\n* Bump io.dropwizard 4.1.5\n* Remove ganglia\n* Bump lucene backend to 8.6.0\n* Blind copy of the JmxReporter from version 4.1\n\nFixes #1569\n\nSigned-off-by: Jan Jansen <jan.jansen@gdata.de>", "committedDate": "2020-07-19T19:53:02Z", "type": "forcePushed"}]}