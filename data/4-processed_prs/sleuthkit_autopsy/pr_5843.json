{"pr_number": 5843, "pr_title": "6095/6097:  persona api & tests.", "pr_createdAt": "2020-04-22T20:01:17Z", "pr_url": "https://github.com/sleuthkit/autopsy/pull/5843", "timeline": [{"oid": "c3703c53e17fc3c503c9dfafdec4d77c92af4dbc", "url": "https://github.com/sleuthkit/autopsy/commit/c3703c53e17fc3c503c9dfafdec4d77c92af4dbc", "message": "Merge branch 'develop' of https://github.com/sleuthkit/autopsy into 6095-persona-api", "committedDate": "2020-04-14T12:28:05Z", "type": "commit"}, {"oid": "cdb09aeebfc4c79264a3bcf18a6463f05706fe5c", "url": "https://github.com/sleuthkit/autopsy/commit/cdb09aeebfc4c79264a3bcf18a6463f05706fe5c", "message": "Merge branch 'develop' of https://github.com/sleuthkit/autopsy into 6095-persona-api", "committedDate": "2020-04-22T19:18:27Z", "type": "commit"}, {"oid": "ccdd3651d646be5d5c36a3a2c26453e88665bbb5", "url": "https://github.com/sleuthkit/autopsy/commit/ccdd3651d646be5d5c36a3a2c26453e88665bbb5", "message": "6095: Persona API.", "committedDate": "2020-04-22T19:43:15Z", "type": "commit"}, {"oid": "818a0cbc9fd300d77e77d0cc539dc0c1542962bb", "url": "https://github.com/sleuthkit/autopsy/commit/818a0cbc9fd300d77e77d0cc539dc0c1542962bb", "message": "Addressed Codacy comments.", "committedDate": "2020-04-22T21:05:44Z", "type": "commit"}, {"oid": "6e0ff29969cb2b154b56192a9b345aa9170cdbd1", "url": "https://github.com/sleuthkit/autopsy/commit/6e0ff29969cb2b154b56192a9b345aa9170cdbd1", "message": "Removed unused imports.", "committedDate": "2020-04-23T11:53:36Z", "type": "commit"}, {"oid": "184382f2b798f78b97e58c6a666874b09389f7f5", "url": "https://github.com/sleuthkit/autopsy/commit/184382f2b798f78b97e58c6a666874b09389f7f5", "message": "Use a default persona name when one isn't specified.", "committedDate": "2020-04-23T13:34:56Z", "type": "commit"}, {"oid": "cb08eac551ec00a02c13e123639a40c97d106d93", "url": "https://github.com/sleuthkit/autopsy/commit/cb08eac551ec00a02c13e123639a40c97d106d93", "message": "- Added more tests to the functional test - creating cases and datasources, and account_instance attributes so that Persona could be traced back to a case/data source.\n- Fixed an issue with tests failing because Central Repo cache was not being cleared between tests, even though the underlying database itself was being recreated.\n- Fixed a bug in the Persona query.", "committedDate": "2020-04-23T23:51:32Z", "type": "commit"}, {"oid": "7ede90308845711102ecef93044b56234ef08d72", "url": "https://github.com/sleuthkit/autopsy/commit/7ede90308845711102ecef93044b56234ef08d72", "message": "Added APIS to:\n - get all Persona in a Case/dataSource.\n - get all cases/data sources for a persona.\n\nAdded additional test cases.", "committedDate": "2020-04-27T17:05:50Z", "type": "commit"}, {"oid": "b2e8b1319d7cf2edd001a5425c99f33e2f0bf3d3", "url": "https://github.com/sleuthkit/autopsy/commit/b2e8b1319d7cf2edd001a5425c99f33e2f0bf3d3", "message": "Addressed Codacy review comments.", "committedDate": "2020-04-27T17:56:04Z", "type": "commit"}, {"oid": "d542ac7ce9a2e0350dadfc2eca601ad7f6ee0303", "url": "https://github.com/sleuthkit/autopsy/commit/d542ac7ce9a2e0350dadfc2eca601ad7f6ee0303", "message": "Addressed review comments:\n - Moved d/b queries to corresponding suitable datamodel classes.\n - Dissolved and deleted PersonaHelper class.", "committedDate": "2020-04-28T19:34:30Z", "type": "commit"}, {"oid": "ce0a01c71c3cf5247930b287f830b35bcb050487", "url": "https://github.com/sleuthkit/autopsy/commit/ce0a01c71c3cf5247930b287f830b35bcb050487", "message": "Merge branch 'develop' of https://github.com/sleuthkit/autopsy into 6095-persona-api", "committedDate": "2020-04-30T19:59:53Z", "type": "commit"}, {"oid": "2b75a002565acfb5b5322cf5ec72afb83a46aa89", "url": "https://github.com/sleuthkit/autopsy/commit/2b75a002565acfb5b5322cf5ec72afb83a46aa89", "message": "Added APIS to query persona by:\n - persona name substring\n - account identifier substring.", "committedDate": "2020-05-01T17:10:23Z", "type": "commit"}, {"oid": "204d2e17d8dd91198f05725e543bf9a279c6e7fe", "url": "https://github.com/sleuthkit/autopsy/commit/204d2e17d8dd91198f05725e543bf9a279c6e7fe", "message": "Defined a new class, CentralRepoExaminer, to disambiguate from the Examiner class in case database.", "committedDate": "2020-05-01T17:39:50Z", "type": "commit"}, {"oid": "c682739d8ea74a032f8026d6986e152b568b98fc", "url": "https://github.com/sleuthkit/autopsy/commit/c682739d8ea74a032f8026d6986e152b568b98fc", "message": "Addressed Codacy comments.", "committedDate": "2020-05-01T18:50:00Z", "type": "commit"}, {"oid": "0deb182bc6e8d82f36485aa0acfb5194a893fe30", "url": "https://github.com/sleuthkit/autopsy/commit/0deb182bc6e8d82f36485aa0acfb5194a893fe30", "message": "- Removed pre-population of the examiner table.\n- Replaced getCurrentExaminer() method with getOrInsertExaminer()", "committedDate": "2020-05-04T14:30:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU1NDE1OQ==", "url": "https://github.com/sleuthkit/autopsy/pull/5843#discussion_r418554159", "bodyText": "There is a mismatch between making this interface public while the methods on CentralRepository that user it are package-private.", "author": "rcordovano", "createdAt": "2020-05-01T14:02:33Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepositoryDbQueryCallback.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Central Repository\n+ *\n+ * Copyright 2015-2020 Basis Technology Corp.\n+ * Contact: carrier <at> sleuthkit <dot> org\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.sleuthkit.autopsy.centralrepository.datamodel;\n+\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+\n+/**\n+ * An interface to process the resultset from a Central Repository DB query.\n+ * This enables clients of Central Repository to run custom queries and process\n+ * the results themselves.\n+ *\n+ */\n+public interface CentralRepositoryDbQueryCallback {", "originalCommit": "d542ac7ce9a2e0350dadfc2eca601ad7f6ee0303", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYwNTA1MA==", "url": "https://github.com/sleuthkit/autopsy/pull/5843#discussion_r418605050", "bodyText": "See discussion in Jira.", "author": "rcordovano", "createdAt": "2020-05-01T15:56:21Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepository.java", "diffHunk": "@@ -159,6 +161,23 @@ static boolean isEnabled() {\n      * @param eamCase The case to update\n      */\n     void updateCase(CorrelationCase eamCase) throws CentralRepoException;\n+    \n+    /**\n+     * Updates the examiners table, by adding current logged in user to\n+     * examiners table, if not already in there.\n+     * \n+     * @throws CentralRepoException If there is an error.\n+     *\n+     */\n+    void updateExaminers() throws CentralRepoException;", "originalCommit": "d542ac7ce9a2e0350dadfc2eca601ad7f6ee0303", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYwNTU0NA==", "url": "https://github.com/sleuthkit/autopsy/pull/5843#discussion_r418605544", "bodyText": "The only place this method, which exposes implementation details, appears to be called outside of the implementations of this interface is in test code where it is called on a newly created database that should have empty caches. Do we need to expose this method as part of this interface?", "author": "rcordovano", "createdAt": "2020-05-01T15:57:20Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepository.java", "diffHunk": "@@ -828,4 +874,8 @@ CorrelationAttributeInstance getCorrelationAttributeInstance(CorrelationAttribut\n     CentralRepoAccount getOrCreateAccount(CentralRepoAccount.CentralRepoAccountType crAccountType, String accountUniqueID) throws CentralRepoException;\n     \n              \n+    /**\n+     * Clears all caches.\n+     */\n+    void clearCaches();", "originalCommit": "d542ac7ce9a2e0350dadfc2eca601ad7f6ee0303", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU2Mzk0MA==", "url": "https://github.com/sleuthkit/autopsy/pull/5843#discussion_r419563940", "bodyText": "As it happens, although the setup() method in the test that gets called between EVERY test method wipes out the underlying database before the start of each test, the CentralRepository object, as returned by CentralRepository.getInstance(), is only created once.  With each invocation of the setup method, the caches held by the CentralRepository instance go out of sync and inconsistent with the database, causing errors due to database integrity.\nSince we've taken out caching of Examiners, this may not be necessary at the moment though.", "author": "raman-bt", "createdAt": "2020-05-04T16:27:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYwNTU0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyMTkzMA==", "url": "https://github.com/sleuthkit/autopsy/pull/5843#discussion_r418621930", "bodyText": "What is the intended use of this string? This seems to force the UI to check for \"NoName\" and either put empty text in the UI or swap in something more human readable. From a data modeling perspective, NULL seems more standard and it makes sense in terms of separation of the data layer from the presentation layer to allow the UI decide how to display NULL optional data.", "author": "rcordovano", "createdAt": "2020-05-01T16:34:30Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/Persona.java", "diffHunk": "@@ -79,9 +101,578 @@ public String toString() {\n             return description;\n         }\n \n-        public int getStatus() {\n+        public int getStatusId() {\n             return this.status_id;\n         }\n+\n+        static PersonaStatus fromId(int value) {\n+            for (PersonaStatus status : PersonaStatus.values()) {\n+                if (status.getStatusId() == value) {\n+                    return status;\n+                }\n+            }\n+            return PersonaStatus.UNKNOWN;\n+        }\n+    }\n+\n+    // Persona name to use if no name is specified.\n+    private static final String DEFAULT_PERSONA_NAME = \"NoName\";", "originalCommit": "d542ac7ce9a2e0350dadfc2eca601ad7f6ee0303", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM2NjU0OQ==", "url": "https://github.com/sleuthkit/autopsy/pull/5843#discussion_r419366549", "bodyText": "I don't believe we have any way of populating this displayName field in the database or this class at this time. It is not in the ERD. What is the use case envisioned for it? I think we can leave the table column alone since it already exists in the last release, but we can ignore it in this class.", "author": "rcordovano", "createdAt": "2020-05-04T11:21:18Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepoExaminer.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Central Repository\n+ *\n+ * Copyright 2020 Basis Technology Corp.\n+ * Contact: carrier <at> sleuthkit <dot> org\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.sleuthkit.autopsy.centralrepository.datamodel;\n+\n+/**\n+ * Encapsulates the concept of an examiner.\n+ */\n+final public class CentralRepoExaminer {\n+\n+    private final long id;  // Row id in the examiners table in central repo database.\n+    private final String loginName;\n+    private final String displayName;", "originalCommit": "c682739d8ea74a032f8026d6986e152b568b98fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM2Nzc3MA==", "url": "https://github.com/sleuthkit/autopsy/pull/5843#discussion_r419367770", "bodyText": "See discussion in Jira.", "author": "rcordovano", "createdAt": "2020-05-04T11:24:14Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepository.java", "diffHunk": "@@ -159,6 +160,23 @@ static boolean isEnabled() {\n      * @param eamCase The case to update\n      */\n     void updateCase(CorrelationCase eamCase) throws CentralRepoException;\n+    \n+    /**\n+     * Updates the examiners table, by adding current logged in user to\n+     * examiners table, if not already in there.\n+     * \n+     * @throws CentralRepoException If there is an error.\n+     *\n+     */\n+    void updateExaminers() throws CentralRepoException;\n+\n+    /**\n+     * Get the Examiner object for the current logged in user.\n+     *\n+     * @return Examiner Current examiner.\n+     * @throws CentralRepoException\n+     */\n+    CentralRepoExaminer getCurrentCentralRepoExaminer() throws CentralRepoException;", "originalCommit": "c682739d8ea74a032f8026d6986e152b568b98fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM3NDMzMQ==", "url": "https://github.com/sleuthkit/autopsy/pull/5843#discussion_r419374331", "bodyText": "This is a new file, the copyright should start in 2020.", "author": "rcordovano", "createdAt": "2020-05-04T11:38:28Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepositoryDbQueryCallback.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Central Repository\n+ *\n+ * Copyright 2015-2020 Basis Technology Corp.", "originalCommit": "c682739d8ea74a032f8026d6986e152b568b98fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM4NDg2Mg==", "url": "https://github.com/sleuthkit/autopsy/pull/5843#discussion_r419384862", "bodyText": "This method appears to be unused and able to be removed.", "author": "rcordovano", "createdAt": "2020-05-04T12:01:10Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/Persona.java", "diffHunk": "@@ -79,9 +100,626 @@ public String toString() {\n             return description;\n         }\n \n-        public int getStatus() {\n+        public int getStatusId() {\n             return this.status_id;\n         }\n+\n+        static PersonaStatus fromId(int value) {\n+            for (PersonaStatus status : PersonaStatus.values()) {\n+                if (status.getStatusId() == value) {\n+                    return status;\n+                }\n+            }\n+            return PersonaStatus.UNKNOWN;\n+        }\n+    }\n+\n+    // Persona name to use if no name is specified.\n+    private static final String DEFAULT_PERSONA_NAME = \"NoName\";\n+\n+    // primary key in the Personas table in CR database\n+    private final long id;\n+    private final String uuidStr;\n+    private final String name;\n+    private final String comment;\n+    private final long createdDate;\n+    private final long modifiedDate;\n+    private final PersonaStatus status;\n+    private final CentralRepoExaminer examiner;\n+\n+    public long getId() {\n+        return id;\n+    }\n+\n+    public String getUuidStr() {\n+        return uuidStr;\n+    }\n+\n+    public String getName() {\n+        return name;\n+    }\n+\n+    public String getComment() {\n+        return comment;\n+    }\n+\n+    public long getCreatedDate() {\n+        return createdDate;\n+    }\n+\n+    public long getModifiedDate() {\n+        return modifiedDate;\n+    }\n+\n+    public PersonaStatus getStatus() {\n+        return status;\n+    }\n+\n+    public CentralRepoExaminer getExaminer() {\n+        return examiner;\n+    }\n+\n+    Persona(long id, String uuidStr, String name, String comment, long created_date, long modified_date, PersonaStatus status, CentralRepoExaminer examiner) {\n+        this.id = id;\n+        this.uuidStr = uuidStr;\n+        this.name = name;\n+        this.comment = comment;\n+        this.createdDate = created_date;\n+        this.modifiedDate = modified_date;\n+        this.status = status;\n+        this.examiner = examiner;\n+    }\n+\n+    /**\n+     * Creates a Persona and associates the specified account with it.\n+     *\n+     * @param personaName Persona name.\n+     * @param comment Comment to associate with persona, may be null.\n+     * @param status Persona status\n+     * @param account Account for which the persona is being created.\n+     * @param justification Justification for why this account belongs to this\n+     * persona, may be null.\n+     * @param confidence Confidence level for this association of Persona &\n+     * account.\n+     *\n+     * @return PersonaAccount\n+     * @throws CentralRepoException If there is an error creating the Persona.\n+     */\n+    public static PersonaAccount createPersonaForAccount(String personaName, String comment, PersonaStatus status, CentralRepoAccount account, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+        Persona persona = createPersona(personaName, comment, status);\n+        return persona.addAccountToPersona(account, justification, confidence);\n+    }\n+\n+    /**\n+     * Inserts a row in the Persona tables.\n+     *\n+     * @param name Persona name, may be null - default name is used in that\n+     * case.\n+     * @param comment Comment to associate with persona, may be null.\n+     * @param status Persona status.\n+     *\n+     * @return Persona corresponding to the row inserted in the personas table.\n+     *\n+     * @throws CentralRepoException If there is an error in adding a row to\n+     * personas table.\n+     */\n+    private static Persona createPersona(String name, String comment, PersonaStatus status) throws CentralRepoException {\n+        // generate a UUID for the persona\n+        String uuidStr = UUID.randomUUID().toString();\n+        CentralRepoExaminer examiner = CentralRepository.getInstance().getCurrentCentralRepoExaminer();\n+\n+        Instant instant = Instant.now();\n+        Long timeStampMillis = instant.toEpochMilli();\n+        String insertClause = \" INTO personas (uuid, comment, name, created_date, modified_date, status_id, examiner_id ) \"\n+                + \"VALUES ( '\" + uuidStr + \"', \"\n+                + \"'\" + ((StringUtils.isBlank(comment) ? \"\" : SleuthkitCase.escapeSingleQuotes(comment))) + \"',\"\n+                + \"'\" + ((StringUtils.isBlank(name) ? DEFAULT_PERSONA_NAME : SleuthkitCase.escapeSingleQuotes(name))) + \"',\"\n+                + timeStampMillis.toString() + \",\"\n+                + timeStampMillis.toString() + \",\"\n+                + status.getStatusId() + \",\"\n+                + examiner.getId()\n+                + \")\";\n+\n+        CentralRepository.getInstance().executeInsertSQL(insertClause);\n+        return getPersonaByUUID(uuidStr);\n+    }\n+\n+    /**\n+     * Associates an account with a persona by creating a row in the\n+     * PersonaAccounts table.\n+     *\n+     * @param persona Persona to add the account to.\n+     * @param account Account to add to persona.\n+     * @param justification Reason for adding the account to persona, may be\n+     * null.\n+     * @param confidence Confidence level.\n+     *\n+     * @return PersonaAccount\n+     * @throws CentralRepoException If there is an error.\n+     */\n+    public PersonaAccount addAccountToPersona(CentralRepoAccount account, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+\n+        CentralRepoExaminer currentExaminer = CentralRepository.getInstance().getCurrentCentralRepoExaminer();\n+\n+        Instant instant = Instant.now();\n+        Long timeStampMillis = instant.toEpochMilli();\n+        String insertClause = \" INTO persona_accounts (persona_id, account_id, justification, confidence_id, date_added, examiner_id ) \"\n+                + \"VALUES ( \"\n+                + this.getId() + \", \"\n+                + account.getAccountId() + \", \"\n+                + \"'\" + ((StringUtils.isBlank(justification) ? \"\" : SleuthkitCase.escapeSingleQuotes(justification))) + \"', \"\n+                + confidence.getLevelId() + \", \"\n+                + timeStampMillis.toString() + \", \"\n+                + currentExaminer.getId()\n+                + \")\";\n+\n+        CentralRepository.getInstance().executeInsertSQL(insertClause);\n+        return new PersonaAccount(this, account, justification, confidence, timeStampMillis, currentExaminer);\n+    }\n+\n+    /**\n+     * Callback to process a Persona query from the persona table.\n+     */\n+    private static class PersonaQueryCallback implements CentralRepositoryDbQueryCallback {\n+\n+        private final Collection<Persona> personaList =  new ArrayList<>();\n+\n+        @Override\n+        public void process(ResultSet rs) throws SQLException {\n+\n+            while (rs.next()) {\n+                CentralRepoExaminer examiner = new CentralRepoExaminer(\n+                        rs.getInt(\"examiner_id\"),\n+                        rs.getString(\"login_name\"),\n+                        rs.getString(\"display_name\"));\n+\n+                PersonaStatus status = PersonaStatus.fromId(rs.getInt(\"status_id\"));\n+                Persona persona = new Persona(\n+                        rs.getInt(\"id\"),\n+                        rs.getString(\"uuid\"),\n+                        rs.getString(\"name\"),\n+                        rs.getString(\"comment\"),\n+                        Long.parseLong(rs.getString(\"created_date\")),\n+                        Long.parseLong(rs.getString(\"modified_date\")),\n+                        status,\n+                        examiner\n+                );\n+                \n+                personaList.add(persona);\n+            }\n+        }\n+\n+        Collection<Persona> getPersonas() {\n+            return Collections.unmodifiableCollection(personaList);\n+        }\n+    };\n+\n+    // Partial query string to select from personas table, \n+    // just supply the where clause.\n+    private static final String PERSONA_QUERY = \n+                  \"SELECT p.id, p.uuid, p.name, p.comment, p.created_date, p.modified_date, p.status_id, p.examiner_id, e.login_name, e.display_name \"\n+                + \"FROM personas as p \"\n+                + \"INNER JOIN examiners as e ON e.id = p.examiner_id \";\n+              \n+     \n+    /**\n+     * Gets the row from the Personas table with the given UUID, creates and\n+     * returns the Persona from that data.\n+     *\n+     * @param uuid Persona UUID to match.\n+     * @return Persona matching the given UUID, may be null if no match is\n+     * found.\n+     *\n+     * @throws CentralRepoException If there is an error in querying the\n+     * Personas table.\n+     */\n+    private static Persona getPersonaByUUID(String uuid) throws CentralRepoException {\n+\n+        String queryClause = \n+                PERSONA_QUERY\n+                + \"WHERE p.uuid = '\" + uuid + \"'\";\n+\n+        PersonaQueryCallback queryCallback = new PersonaQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+\n+        Collection<Persona> personas = queryCallback.getPersonas();\n+        \n+        Persona persona = personas.isEmpty() ? null : personas.iterator().next();\n+        return persona;\n+    }\n+\n+    /**\n+     * Gets the row from the Personas table with the given id, creates and\n+     * returns the Persona from that data.\n+     *\n+     * @param id Persona id to match.\n+     * @return Persona matching the given UUID, may be null if no match is\n+     * found.\n+     *\n+     * @throws CentralRepoException If there is an error in querying the\n+     * Personas table.\n+     */\n+    public static Persona getPersonaById(long id) throws CentralRepoException {", "originalCommit": "c682739d8ea74a032f8026d6986e152b568b98fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ3ODI2Mw==", "url": "https://github.com/sleuthkit/autopsy/pull/5843#discussion_r419478263", "bodyText": "This method seems misplaced here. Does it add anything vs. just calling the PersonaAccount API directly?", "author": "rcordovano", "createdAt": "2020-05-04T14:27:51Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/Persona.java", "diffHunk": "@@ -79,9 +100,626 @@ public String toString() {\n             return description;\n         }\n \n-        public int getStatus() {\n+        public int getStatusId() {\n             return this.status_id;\n         }\n+\n+        static PersonaStatus fromId(int value) {\n+            for (PersonaStatus status : PersonaStatus.values()) {\n+                if (status.getStatusId() == value) {\n+                    return status;\n+                }\n+            }\n+            return PersonaStatus.UNKNOWN;\n+        }\n+    }\n+\n+    // Persona name to use if no name is specified.\n+    private static final String DEFAULT_PERSONA_NAME = \"NoName\";\n+\n+    // primary key in the Personas table in CR database\n+    private final long id;\n+    private final String uuidStr;\n+    private final String name;\n+    private final String comment;\n+    private final long createdDate;\n+    private final long modifiedDate;\n+    private final PersonaStatus status;\n+    private final CentralRepoExaminer examiner;\n+\n+    public long getId() {\n+        return id;\n+    }\n+\n+    public String getUuidStr() {\n+        return uuidStr;\n+    }\n+\n+    public String getName() {\n+        return name;\n+    }\n+\n+    public String getComment() {\n+        return comment;\n+    }\n+\n+    public long getCreatedDate() {\n+        return createdDate;\n+    }\n+\n+    public long getModifiedDate() {\n+        return modifiedDate;\n+    }\n+\n+    public PersonaStatus getStatus() {\n+        return status;\n+    }\n+\n+    public CentralRepoExaminer getExaminer() {\n+        return examiner;\n+    }\n+\n+    Persona(long id, String uuidStr, String name, String comment, long created_date, long modified_date, PersonaStatus status, CentralRepoExaminer examiner) {\n+        this.id = id;\n+        this.uuidStr = uuidStr;\n+        this.name = name;\n+        this.comment = comment;\n+        this.createdDate = created_date;\n+        this.modifiedDate = modified_date;\n+        this.status = status;\n+        this.examiner = examiner;\n+    }\n+\n+    /**\n+     * Creates a Persona and associates the specified account with it.\n+     *\n+     * @param personaName Persona name.\n+     * @param comment Comment to associate with persona, may be null.\n+     * @param status Persona status\n+     * @param account Account for which the persona is being created.\n+     * @param justification Justification for why this account belongs to this\n+     * persona, may be null.\n+     * @param confidence Confidence level for this association of Persona &\n+     * account.\n+     *\n+     * @return PersonaAccount\n+     * @throws CentralRepoException If there is an error creating the Persona.\n+     */\n+    public static PersonaAccount createPersonaForAccount(String personaName, String comment, PersonaStatus status, CentralRepoAccount account, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+        Persona persona = createPersona(personaName, comment, status);\n+        return persona.addAccountToPersona(account, justification, confidence);\n+    }\n+\n+    /**\n+     * Inserts a row in the Persona tables.\n+     *\n+     * @param name Persona name, may be null - default name is used in that\n+     * case.\n+     * @param comment Comment to associate with persona, may be null.\n+     * @param status Persona status.\n+     *\n+     * @return Persona corresponding to the row inserted in the personas table.\n+     *\n+     * @throws CentralRepoException If there is an error in adding a row to\n+     * personas table.\n+     */\n+    private static Persona createPersona(String name, String comment, PersonaStatus status) throws CentralRepoException {\n+        // generate a UUID for the persona\n+        String uuidStr = UUID.randomUUID().toString();\n+        CentralRepoExaminer examiner = CentralRepository.getInstance().getCurrentCentralRepoExaminer();\n+\n+        Instant instant = Instant.now();\n+        Long timeStampMillis = instant.toEpochMilli();\n+        String insertClause = \" INTO personas (uuid, comment, name, created_date, modified_date, status_id, examiner_id ) \"\n+                + \"VALUES ( '\" + uuidStr + \"', \"\n+                + \"'\" + ((StringUtils.isBlank(comment) ? \"\" : SleuthkitCase.escapeSingleQuotes(comment))) + \"',\"\n+                + \"'\" + ((StringUtils.isBlank(name) ? DEFAULT_PERSONA_NAME : SleuthkitCase.escapeSingleQuotes(name))) + \"',\"\n+                + timeStampMillis.toString() + \",\"\n+                + timeStampMillis.toString() + \",\"\n+                + status.getStatusId() + \",\"\n+                + examiner.getId()\n+                + \")\";\n+\n+        CentralRepository.getInstance().executeInsertSQL(insertClause);\n+        return getPersonaByUUID(uuidStr);\n+    }\n+\n+    /**\n+     * Associates an account with a persona by creating a row in the\n+     * PersonaAccounts table.\n+     *\n+     * @param persona Persona to add the account to.\n+     * @param account Account to add to persona.\n+     * @param justification Reason for adding the account to persona, may be\n+     * null.\n+     * @param confidence Confidence level.\n+     *\n+     * @return PersonaAccount\n+     * @throws CentralRepoException If there is an error.\n+     */\n+    public PersonaAccount addAccountToPersona(CentralRepoAccount account, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+\n+        CentralRepoExaminer currentExaminer = CentralRepository.getInstance().getCurrentCentralRepoExaminer();\n+\n+        Instant instant = Instant.now();\n+        Long timeStampMillis = instant.toEpochMilli();\n+        String insertClause = \" INTO persona_accounts (persona_id, account_id, justification, confidence_id, date_added, examiner_id ) \"\n+                + \"VALUES ( \"\n+                + this.getId() + \", \"\n+                + account.getAccountId() + \", \"\n+                + \"'\" + ((StringUtils.isBlank(justification) ? \"\" : SleuthkitCase.escapeSingleQuotes(justification))) + \"', \"\n+                + confidence.getLevelId() + \", \"\n+                + timeStampMillis.toString() + \", \"\n+                + currentExaminer.getId()\n+                + \")\";\n+\n+        CentralRepository.getInstance().executeInsertSQL(insertClause);\n+        return new PersonaAccount(this, account, justification, confidence, timeStampMillis, currentExaminer);\n+    }\n+\n+    /**\n+     * Callback to process a Persona query from the persona table.\n+     */\n+    private static class PersonaQueryCallback implements CentralRepositoryDbQueryCallback {\n+\n+        private final Collection<Persona> personaList =  new ArrayList<>();\n+\n+        @Override\n+        public void process(ResultSet rs) throws SQLException {\n+\n+            while (rs.next()) {\n+                CentralRepoExaminer examiner = new CentralRepoExaminer(\n+                        rs.getInt(\"examiner_id\"),\n+                        rs.getString(\"login_name\"),\n+                        rs.getString(\"display_name\"));\n+\n+                PersonaStatus status = PersonaStatus.fromId(rs.getInt(\"status_id\"));\n+                Persona persona = new Persona(\n+                        rs.getInt(\"id\"),\n+                        rs.getString(\"uuid\"),\n+                        rs.getString(\"name\"),\n+                        rs.getString(\"comment\"),\n+                        Long.parseLong(rs.getString(\"created_date\")),\n+                        Long.parseLong(rs.getString(\"modified_date\")),\n+                        status,\n+                        examiner\n+                );\n+                \n+                personaList.add(persona);\n+            }\n+        }\n+\n+        Collection<Persona> getPersonas() {\n+            return Collections.unmodifiableCollection(personaList);\n+        }\n+    };\n+\n+    // Partial query string to select from personas table, \n+    // just supply the where clause.\n+    private static final String PERSONA_QUERY = \n+                  \"SELECT p.id, p.uuid, p.name, p.comment, p.created_date, p.modified_date, p.status_id, p.examiner_id, e.login_name, e.display_name \"\n+                + \"FROM personas as p \"\n+                + \"INNER JOIN examiners as e ON e.id = p.examiner_id \";\n+              \n+     \n+    /**\n+     * Gets the row from the Personas table with the given UUID, creates and\n+     * returns the Persona from that data.\n+     *\n+     * @param uuid Persona UUID to match.\n+     * @return Persona matching the given UUID, may be null if no match is\n+     * found.\n+     *\n+     * @throws CentralRepoException If there is an error in querying the\n+     * Personas table.\n+     */\n+    private static Persona getPersonaByUUID(String uuid) throws CentralRepoException {\n+\n+        String queryClause = \n+                PERSONA_QUERY\n+                + \"WHERE p.uuid = '\" + uuid + \"'\";\n+\n+        PersonaQueryCallback queryCallback = new PersonaQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+\n+        Collection<Persona> personas = queryCallback.getPersonas();\n+        \n+        Persona persona = personas.isEmpty() ? null : personas.iterator().next();\n+        return persona;\n+    }\n+\n+    /**\n+     * Gets the row from the Personas table with the given id, creates and\n+     * returns the Persona from that data.\n+     *\n+     * @param id Persona id to match.\n+     * @return Persona matching the given UUID, may be null if no match is\n+     * found.\n+     *\n+     * @throws CentralRepoException If there is an error in querying the\n+     * Personas table.\n+     */\n+    public static Persona getPersonaById(long id) throws CentralRepoException {\n+\n+        String queryClause = PERSONA_QUERY\n+                + \"WHERE p.id = \" + id;\n+\n+        PersonaQueryCallback queryCallback = new PersonaQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+\n+        Collection<Persona> personas = queryCallback.getPersonas();\n+        \n+        return personas.isEmpty() ? null : personas.iterator().next();\n+    }\n+\n+    /**\n+     * Gets the rows from the Personas table with matching name.\n+     *\n+     * @param partialName Name substring to match.\n+     * @return Collection of personas matching the given name substring, may be\n+     * empty if no match is found.\n+     *\n+     * @throws CentralRepoException If there is an error in querying the\n+     * Personas table.\n+     */\n+    public static Collection<Persona> getPersonaByName(String partialName) throws CentralRepoException {\n+\n+        String queryClause = PERSONA_QUERY\n+                + \"WHERE LOWER(p.name) LIKE \" + \"LOWER('%\" + partialName + \"%')\" ;\n+\n+        PersonaQueryCallback queryCallback = new PersonaQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+\n+        return queryCallback.getPersonas();\n+    }\n+    \n+    /**\n+     * Creates an alias for the Persona.\n+     *\n+     * @param alias Alias name.\n+     * @param justification Reason for assigning the alias, may be null.\n+     * @param confidence Confidence level.\n+     *\n+     * @return PersonaAlias\n+     * @throws CentralRepoException If there is an error in creating the alias.\n+     */\n+    public PersonaAlias addAlias(String alias, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+        return PersonaAlias.addPersonaAlias(this, alias, justification, confidence);\n+    }\n+\n+    /**\n+     * Gets all aliases for the persona.\n+     *\n+     * @return A collection of aliases, may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in retrieving aliases.\n+     */\n+    public Collection<PersonaAlias> getAliases() throws CentralRepoException {\n+        return PersonaAlias.getPersonaAliases(this.getId());\n+    }\n+\n+    /**\n+     * Adds specified metadata to the persona.\n+     *\n+     * @param name Metadata name.\n+     * @param value Metadata value.\n+     * @param justification Reason for adding the metadata, may be null.\n+     * @param confidence Confidence level.\n+     *\n+     * @return PersonaMetadata\n+     * @throws CentralRepoException If there is an error in adding metadata.\n+     */\n+    public PersonaMetadata addMetadata(String name, String value, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+        return PersonaMetadata.addPersonaMetadata(this.getId(), name, value, justification, confidence);\n+    }\n+\n+    /**\n+     * Gets all metadata for the persona.\n+     *\n+     * @return A collection of metadata, may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in retrieving aliases.\n+     */\n+    public Collection<PersonaMetadata> getMetadata() throws CentralRepoException {\n+        return PersonaMetadata.getPersonaMetadata(this.getId());\n+    }\n+\n+    /**\n+     * Gets all the Accounts for the Persona.\n+     *\n+     * @return Collection of PersonaAccounts, may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in getting the\n+     * persona_account.\n+     */\n+    public Collection<PersonaAccount> getPersonaAccounts() throws CentralRepoException {\n+        return PersonaAccount.getPersonaAccountsForPersona(this.getId());\n     }\n \n+    /**\n+     * Gets all the Persona for the specified Account.\n+     *\n+     * @param accountId Id of account for which to get the Personas for.\n+     * @return Collection of PersonaAccounts. may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in getting the\n+     * persona_account.\n+     */\n+    public static Collection<PersonaAccount> getPersonaAccountsForAccount(long accountId) throws CentralRepoException {", "originalCommit": "c682739d8ea74a032f8026d6986e152b568b98fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ3ODMzMw==", "url": "https://github.com/sleuthkit/autopsy/pull/5843#discussion_r419478333", "bodyText": "This method seems misplaced here. Does it add anything vs. just calling the PersonaAccount API directly?", "author": "rcordovano", "createdAt": "2020-05-04T14:27:56Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/Persona.java", "diffHunk": "@@ -79,9 +100,626 @@ public String toString() {\n             return description;\n         }\n \n-        public int getStatus() {\n+        public int getStatusId() {\n             return this.status_id;\n         }\n+\n+        static PersonaStatus fromId(int value) {\n+            for (PersonaStatus status : PersonaStatus.values()) {\n+                if (status.getStatusId() == value) {\n+                    return status;\n+                }\n+            }\n+            return PersonaStatus.UNKNOWN;\n+        }\n+    }\n+\n+    // Persona name to use if no name is specified.\n+    private static final String DEFAULT_PERSONA_NAME = \"NoName\";\n+\n+    // primary key in the Personas table in CR database\n+    private final long id;\n+    private final String uuidStr;\n+    private final String name;\n+    private final String comment;\n+    private final long createdDate;\n+    private final long modifiedDate;\n+    private final PersonaStatus status;\n+    private final CentralRepoExaminer examiner;\n+\n+    public long getId() {\n+        return id;\n+    }\n+\n+    public String getUuidStr() {\n+        return uuidStr;\n+    }\n+\n+    public String getName() {\n+        return name;\n+    }\n+\n+    public String getComment() {\n+        return comment;\n+    }\n+\n+    public long getCreatedDate() {\n+        return createdDate;\n+    }\n+\n+    public long getModifiedDate() {\n+        return modifiedDate;\n+    }\n+\n+    public PersonaStatus getStatus() {\n+        return status;\n+    }\n+\n+    public CentralRepoExaminer getExaminer() {\n+        return examiner;\n+    }\n+\n+    Persona(long id, String uuidStr, String name, String comment, long created_date, long modified_date, PersonaStatus status, CentralRepoExaminer examiner) {\n+        this.id = id;\n+        this.uuidStr = uuidStr;\n+        this.name = name;\n+        this.comment = comment;\n+        this.createdDate = created_date;\n+        this.modifiedDate = modified_date;\n+        this.status = status;\n+        this.examiner = examiner;\n+    }\n+\n+    /**\n+     * Creates a Persona and associates the specified account with it.\n+     *\n+     * @param personaName Persona name.\n+     * @param comment Comment to associate with persona, may be null.\n+     * @param status Persona status\n+     * @param account Account for which the persona is being created.\n+     * @param justification Justification for why this account belongs to this\n+     * persona, may be null.\n+     * @param confidence Confidence level for this association of Persona &\n+     * account.\n+     *\n+     * @return PersonaAccount\n+     * @throws CentralRepoException If there is an error creating the Persona.\n+     */\n+    public static PersonaAccount createPersonaForAccount(String personaName, String comment, PersonaStatus status, CentralRepoAccount account, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+        Persona persona = createPersona(personaName, comment, status);\n+        return persona.addAccountToPersona(account, justification, confidence);\n+    }\n+\n+    /**\n+     * Inserts a row in the Persona tables.\n+     *\n+     * @param name Persona name, may be null - default name is used in that\n+     * case.\n+     * @param comment Comment to associate with persona, may be null.\n+     * @param status Persona status.\n+     *\n+     * @return Persona corresponding to the row inserted in the personas table.\n+     *\n+     * @throws CentralRepoException If there is an error in adding a row to\n+     * personas table.\n+     */\n+    private static Persona createPersona(String name, String comment, PersonaStatus status) throws CentralRepoException {\n+        // generate a UUID for the persona\n+        String uuidStr = UUID.randomUUID().toString();\n+        CentralRepoExaminer examiner = CentralRepository.getInstance().getCurrentCentralRepoExaminer();\n+\n+        Instant instant = Instant.now();\n+        Long timeStampMillis = instant.toEpochMilli();\n+        String insertClause = \" INTO personas (uuid, comment, name, created_date, modified_date, status_id, examiner_id ) \"\n+                + \"VALUES ( '\" + uuidStr + \"', \"\n+                + \"'\" + ((StringUtils.isBlank(comment) ? \"\" : SleuthkitCase.escapeSingleQuotes(comment))) + \"',\"\n+                + \"'\" + ((StringUtils.isBlank(name) ? DEFAULT_PERSONA_NAME : SleuthkitCase.escapeSingleQuotes(name))) + \"',\"\n+                + timeStampMillis.toString() + \",\"\n+                + timeStampMillis.toString() + \",\"\n+                + status.getStatusId() + \",\"\n+                + examiner.getId()\n+                + \")\";\n+\n+        CentralRepository.getInstance().executeInsertSQL(insertClause);\n+        return getPersonaByUUID(uuidStr);\n+    }\n+\n+    /**\n+     * Associates an account with a persona by creating a row in the\n+     * PersonaAccounts table.\n+     *\n+     * @param persona Persona to add the account to.\n+     * @param account Account to add to persona.\n+     * @param justification Reason for adding the account to persona, may be\n+     * null.\n+     * @param confidence Confidence level.\n+     *\n+     * @return PersonaAccount\n+     * @throws CentralRepoException If there is an error.\n+     */\n+    public PersonaAccount addAccountToPersona(CentralRepoAccount account, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+\n+        CentralRepoExaminer currentExaminer = CentralRepository.getInstance().getCurrentCentralRepoExaminer();\n+\n+        Instant instant = Instant.now();\n+        Long timeStampMillis = instant.toEpochMilli();\n+        String insertClause = \" INTO persona_accounts (persona_id, account_id, justification, confidence_id, date_added, examiner_id ) \"\n+                + \"VALUES ( \"\n+                + this.getId() + \", \"\n+                + account.getAccountId() + \", \"\n+                + \"'\" + ((StringUtils.isBlank(justification) ? \"\" : SleuthkitCase.escapeSingleQuotes(justification))) + \"', \"\n+                + confidence.getLevelId() + \", \"\n+                + timeStampMillis.toString() + \", \"\n+                + currentExaminer.getId()\n+                + \")\";\n+\n+        CentralRepository.getInstance().executeInsertSQL(insertClause);\n+        return new PersonaAccount(this, account, justification, confidence, timeStampMillis, currentExaminer);\n+    }\n+\n+    /**\n+     * Callback to process a Persona query from the persona table.\n+     */\n+    private static class PersonaQueryCallback implements CentralRepositoryDbQueryCallback {\n+\n+        private final Collection<Persona> personaList =  new ArrayList<>();\n+\n+        @Override\n+        public void process(ResultSet rs) throws SQLException {\n+\n+            while (rs.next()) {\n+                CentralRepoExaminer examiner = new CentralRepoExaminer(\n+                        rs.getInt(\"examiner_id\"),\n+                        rs.getString(\"login_name\"),\n+                        rs.getString(\"display_name\"));\n+\n+                PersonaStatus status = PersonaStatus.fromId(rs.getInt(\"status_id\"));\n+                Persona persona = new Persona(\n+                        rs.getInt(\"id\"),\n+                        rs.getString(\"uuid\"),\n+                        rs.getString(\"name\"),\n+                        rs.getString(\"comment\"),\n+                        Long.parseLong(rs.getString(\"created_date\")),\n+                        Long.parseLong(rs.getString(\"modified_date\")),\n+                        status,\n+                        examiner\n+                );\n+                \n+                personaList.add(persona);\n+            }\n+        }\n+\n+        Collection<Persona> getPersonas() {\n+            return Collections.unmodifiableCollection(personaList);\n+        }\n+    };\n+\n+    // Partial query string to select from personas table, \n+    // just supply the where clause.\n+    private static final String PERSONA_QUERY = \n+                  \"SELECT p.id, p.uuid, p.name, p.comment, p.created_date, p.modified_date, p.status_id, p.examiner_id, e.login_name, e.display_name \"\n+                + \"FROM personas as p \"\n+                + \"INNER JOIN examiners as e ON e.id = p.examiner_id \";\n+              \n+     \n+    /**\n+     * Gets the row from the Personas table with the given UUID, creates and\n+     * returns the Persona from that data.\n+     *\n+     * @param uuid Persona UUID to match.\n+     * @return Persona matching the given UUID, may be null if no match is\n+     * found.\n+     *\n+     * @throws CentralRepoException If there is an error in querying the\n+     * Personas table.\n+     */\n+    private static Persona getPersonaByUUID(String uuid) throws CentralRepoException {\n+\n+        String queryClause = \n+                PERSONA_QUERY\n+                + \"WHERE p.uuid = '\" + uuid + \"'\";\n+\n+        PersonaQueryCallback queryCallback = new PersonaQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+\n+        Collection<Persona> personas = queryCallback.getPersonas();\n+        \n+        Persona persona = personas.isEmpty() ? null : personas.iterator().next();\n+        return persona;\n+    }\n+\n+    /**\n+     * Gets the row from the Personas table with the given id, creates and\n+     * returns the Persona from that data.\n+     *\n+     * @param id Persona id to match.\n+     * @return Persona matching the given UUID, may be null if no match is\n+     * found.\n+     *\n+     * @throws CentralRepoException If there is an error in querying the\n+     * Personas table.\n+     */\n+    public static Persona getPersonaById(long id) throws CentralRepoException {\n+\n+        String queryClause = PERSONA_QUERY\n+                + \"WHERE p.id = \" + id;\n+\n+        PersonaQueryCallback queryCallback = new PersonaQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+\n+        Collection<Persona> personas = queryCallback.getPersonas();\n+        \n+        return personas.isEmpty() ? null : personas.iterator().next();\n+    }\n+\n+    /**\n+     * Gets the rows from the Personas table with matching name.\n+     *\n+     * @param partialName Name substring to match.\n+     * @return Collection of personas matching the given name substring, may be\n+     * empty if no match is found.\n+     *\n+     * @throws CentralRepoException If there is an error in querying the\n+     * Personas table.\n+     */\n+    public static Collection<Persona> getPersonaByName(String partialName) throws CentralRepoException {\n+\n+        String queryClause = PERSONA_QUERY\n+                + \"WHERE LOWER(p.name) LIKE \" + \"LOWER('%\" + partialName + \"%')\" ;\n+\n+        PersonaQueryCallback queryCallback = new PersonaQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+\n+        return queryCallback.getPersonas();\n+    }\n+    \n+    /**\n+     * Creates an alias for the Persona.\n+     *\n+     * @param alias Alias name.\n+     * @param justification Reason for assigning the alias, may be null.\n+     * @param confidence Confidence level.\n+     *\n+     * @return PersonaAlias\n+     * @throws CentralRepoException If there is an error in creating the alias.\n+     */\n+    public PersonaAlias addAlias(String alias, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+        return PersonaAlias.addPersonaAlias(this, alias, justification, confidence);\n+    }\n+\n+    /**\n+     * Gets all aliases for the persona.\n+     *\n+     * @return A collection of aliases, may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in retrieving aliases.\n+     */\n+    public Collection<PersonaAlias> getAliases() throws CentralRepoException {\n+        return PersonaAlias.getPersonaAliases(this.getId());\n+    }\n+\n+    /**\n+     * Adds specified metadata to the persona.\n+     *\n+     * @param name Metadata name.\n+     * @param value Metadata value.\n+     * @param justification Reason for adding the metadata, may be null.\n+     * @param confidence Confidence level.\n+     *\n+     * @return PersonaMetadata\n+     * @throws CentralRepoException If there is an error in adding metadata.\n+     */\n+    public PersonaMetadata addMetadata(String name, String value, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+        return PersonaMetadata.addPersonaMetadata(this.getId(), name, value, justification, confidence);\n+    }\n+\n+    /**\n+     * Gets all metadata for the persona.\n+     *\n+     * @return A collection of metadata, may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in retrieving aliases.\n+     */\n+    public Collection<PersonaMetadata> getMetadata() throws CentralRepoException {\n+        return PersonaMetadata.getPersonaMetadata(this.getId());\n+    }\n+\n+    /**\n+     * Gets all the Accounts for the Persona.\n+     *\n+     * @return Collection of PersonaAccounts, may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in getting the\n+     * persona_account.\n+     */\n+    public Collection<PersonaAccount> getPersonaAccounts() throws CentralRepoException {\n+        return PersonaAccount.getPersonaAccountsForPersona(this.getId());\n     }\n \n+    /**\n+     * Gets all the Persona for the specified Account.\n+     *\n+     * @param accountId Id of account for which to get the Personas for.\n+     * @return Collection of PersonaAccounts. may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in getting the\n+     * persona_account.\n+     */\n+    public static Collection<PersonaAccount> getPersonaAccountsForAccount(long accountId) throws CentralRepoException {\n+        return PersonaAccount.getPersonaAccountsForAccount(accountId);\n+    }\n+\n+    /**\n+     * Gets all the Persona associated with all the accounts matching the given\n+     * account identifier substring.\n+     *\n+     * @param accountIdentifierSubstring Account identifier substring to search\n+     * for.\n+     * @return Collection of PersonaAccounts. may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in getting the\n+     * persona_account.\n+     */\n+    public static Collection<PersonaAccount> getPersonaAccountsForAccountIdentifier(String accountIdentifierSubstring) throws CentralRepoException {", "originalCommit": "c682739d8ea74a032f8026d6986e152b568b98fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUwNzY1Nw==", "url": "https://github.com/sleuthkit/autopsy/pull/5843#discussion_r419507657", "bodyText": "Missing period in comment.", "author": "rcordovano", "createdAt": "2020-05-04T15:07:36Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/CentralRepoExaminer.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Central Repository\n+ *\n+ * Copyright 2020 Basis Technology Corp.\n+ * Contact: carrier <at> sleuthkit <dot> org\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.sleuthkit.autopsy.centralrepository.datamodel;\n+\n+/**\n+ * Encapsulates the concept of an examiner.\n+ */\n+final public class CentralRepoExaminer {\n+\n+    private final long id;  // Row id in the examiners table in central repo database.\n+    private final String loginName;\n+    private final String displayName;\n+\n+    public CentralRepoExaminer(long id, String loginName, String displayName) {\n+        this.id = id;\n+        this.loginName = loginName;\n+        this.displayName = displayName;\n+    }\n+\n+    /**\n+     * Returns the id", "originalCommit": "c682739d8ea74a032f8026d6986e152b568b98fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUxNDMwMw==", "url": "https://github.com/sleuthkit/autopsy/pull/5843#discussion_r419514303", "bodyText": "I don't think we need this since we have getPersonaAccounts.", "author": "rcordovano", "createdAt": "2020-05-04T15:17:07Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/Persona.java", "diffHunk": "@@ -79,9 +100,626 @@ public String toString() {\n             return description;\n         }\n \n-        public int getStatus() {\n+        public int getStatusId() {\n             return this.status_id;\n         }\n+\n+        static PersonaStatus fromId(int value) {\n+            for (PersonaStatus status : PersonaStatus.values()) {\n+                if (status.getStatusId() == value) {\n+                    return status;\n+                }\n+            }\n+            return PersonaStatus.UNKNOWN;\n+        }\n+    }\n+\n+    // Persona name to use if no name is specified.\n+    private static final String DEFAULT_PERSONA_NAME = \"NoName\";\n+\n+    // primary key in the Personas table in CR database\n+    private final long id;\n+    private final String uuidStr;\n+    private final String name;\n+    private final String comment;\n+    private final long createdDate;\n+    private final long modifiedDate;\n+    private final PersonaStatus status;\n+    private final CentralRepoExaminer examiner;\n+\n+    public long getId() {\n+        return id;\n+    }\n+\n+    public String getUuidStr() {\n+        return uuidStr;\n+    }\n+\n+    public String getName() {\n+        return name;\n+    }\n+\n+    public String getComment() {\n+        return comment;\n+    }\n+\n+    public long getCreatedDate() {\n+        return createdDate;\n+    }\n+\n+    public long getModifiedDate() {\n+        return modifiedDate;\n+    }\n+\n+    public PersonaStatus getStatus() {\n+        return status;\n+    }\n+\n+    public CentralRepoExaminer getExaminer() {\n+        return examiner;\n+    }\n+\n+    Persona(long id, String uuidStr, String name, String comment, long created_date, long modified_date, PersonaStatus status, CentralRepoExaminer examiner) {\n+        this.id = id;\n+        this.uuidStr = uuidStr;\n+        this.name = name;\n+        this.comment = comment;\n+        this.createdDate = created_date;\n+        this.modifiedDate = modified_date;\n+        this.status = status;\n+        this.examiner = examiner;\n+    }\n+\n+    /**\n+     * Creates a Persona and associates the specified account with it.\n+     *\n+     * @param personaName Persona name.\n+     * @param comment Comment to associate with persona, may be null.\n+     * @param status Persona status\n+     * @param account Account for which the persona is being created.\n+     * @param justification Justification for why this account belongs to this\n+     * persona, may be null.\n+     * @param confidence Confidence level for this association of Persona &\n+     * account.\n+     *\n+     * @return PersonaAccount\n+     * @throws CentralRepoException If there is an error creating the Persona.\n+     */\n+    public static PersonaAccount createPersonaForAccount(String personaName, String comment, PersonaStatus status, CentralRepoAccount account, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+        Persona persona = createPersona(personaName, comment, status);\n+        return persona.addAccountToPersona(account, justification, confidence);\n+    }\n+\n+    /**\n+     * Inserts a row in the Persona tables.\n+     *\n+     * @param name Persona name, may be null - default name is used in that\n+     * case.\n+     * @param comment Comment to associate with persona, may be null.\n+     * @param status Persona status.\n+     *\n+     * @return Persona corresponding to the row inserted in the personas table.\n+     *\n+     * @throws CentralRepoException If there is an error in adding a row to\n+     * personas table.\n+     */\n+    private static Persona createPersona(String name, String comment, PersonaStatus status) throws CentralRepoException {\n+        // generate a UUID for the persona\n+        String uuidStr = UUID.randomUUID().toString();\n+        CentralRepoExaminer examiner = CentralRepository.getInstance().getCurrentCentralRepoExaminer();\n+\n+        Instant instant = Instant.now();\n+        Long timeStampMillis = instant.toEpochMilli();\n+        String insertClause = \" INTO personas (uuid, comment, name, created_date, modified_date, status_id, examiner_id ) \"\n+                + \"VALUES ( '\" + uuidStr + \"', \"\n+                + \"'\" + ((StringUtils.isBlank(comment) ? \"\" : SleuthkitCase.escapeSingleQuotes(comment))) + \"',\"\n+                + \"'\" + ((StringUtils.isBlank(name) ? DEFAULT_PERSONA_NAME : SleuthkitCase.escapeSingleQuotes(name))) + \"',\"\n+                + timeStampMillis.toString() + \",\"\n+                + timeStampMillis.toString() + \",\"\n+                + status.getStatusId() + \",\"\n+                + examiner.getId()\n+                + \")\";\n+\n+        CentralRepository.getInstance().executeInsertSQL(insertClause);\n+        return getPersonaByUUID(uuidStr);\n+    }\n+\n+    /**\n+     * Associates an account with a persona by creating a row in the\n+     * PersonaAccounts table.\n+     *\n+     * @param persona Persona to add the account to.\n+     * @param account Account to add to persona.\n+     * @param justification Reason for adding the account to persona, may be\n+     * null.\n+     * @param confidence Confidence level.\n+     *\n+     * @return PersonaAccount\n+     * @throws CentralRepoException If there is an error.\n+     */\n+    public PersonaAccount addAccountToPersona(CentralRepoAccount account, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+\n+        CentralRepoExaminer currentExaminer = CentralRepository.getInstance().getCurrentCentralRepoExaminer();\n+\n+        Instant instant = Instant.now();\n+        Long timeStampMillis = instant.toEpochMilli();\n+        String insertClause = \" INTO persona_accounts (persona_id, account_id, justification, confidence_id, date_added, examiner_id ) \"\n+                + \"VALUES ( \"\n+                + this.getId() + \", \"\n+                + account.getAccountId() + \", \"\n+                + \"'\" + ((StringUtils.isBlank(justification) ? \"\" : SleuthkitCase.escapeSingleQuotes(justification))) + \"', \"\n+                + confidence.getLevelId() + \", \"\n+                + timeStampMillis.toString() + \", \"\n+                + currentExaminer.getId()\n+                + \")\";\n+\n+        CentralRepository.getInstance().executeInsertSQL(insertClause);\n+        return new PersonaAccount(this, account, justification, confidence, timeStampMillis, currentExaminer);\n+    }\n+\n+    /**\n+     * Callback to process a Persona query from the persona table.\n+     */\n+    private static class PersonaQueryCallback implements CentralRepositoryDbQueryCallback {\n+\n+        private final Collection<Persona> personaList =  new ArrayList<>();\n+\n+        @Override\n+        public void process(ResultSet rs) throws SQLException {\n+\n+            while (rs.next()) {\n+                CentralRepoExaminer examiner = new CentralRepoExaminer(\n+                        rs.getInt(\"examiner_id\"),\n+                        rs.getString(\"login_name\"),\n+                        rs.getString(\"display_name\"));\n+\n+                PersonaStatus status = PersonaStatus.fromId(rs.getInt(\"status_id\"));\n+                Persona persona = new Persona(\n+                        rs.getInt(\"id\"),\n+                        rs.getString(\"uuid\"),\n+                        rs.getString(\"name\"),\n+                        rs.getString(\"comment\"),\n+                        Long.parseLong(rs.getString(\"created_date\")),\n+                        Long.parseLong(rs.getString(\"modified_date\")),\n+                        status,\n+                        examiner\n+                );\n+                \n+                personaList.add(persona);\n+            }\n+        }\n+\n+        Collection<Persona> getPersonas() {\n+            return Collections.unmodifiableCollection(personaList);\n+        }\n+    };\n+\n+    // Partial query string to select from personas table, \n+    // just supply the where clause.\n+    private static final String PERSONA_QUERY = \n+                  \"SELECT p.id, p.uuid, p.name, p.comment, p.created_date, p.modified_date, p.status_id, p.examiner_id, e.login_name, e.display_name \"\n+                + \"FROM personas as p \"\n+                + \"INNER JOIN examiners as e ON e.id = p.examiner_id \";\n+              \n+     \n+    /**\n+     * Gets the row from the Personas table with the given UUID, creates and\n+     * returns the Persona from that data.\n+     *\n+     * @param uuid Persona UUID to match.\n+     * @return Persona matching the given UUID, may be null if no match is\n+     * found.\n+     *\n+     * @throws CentralRepoException If there is an error in querying the\n+     * Personas table.\n+     */\n+    private static Persona getPersonaByUUID(String uuid) throws CentralRepoException {\n+\n+        String queryClause = \n+                PERSONA_QUERY\n+                + \"WHERE p.uuid = '\" + uuid + \"'\";\n+\n+        PersonaQueryCallback queryCallback = new PersonaQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+\n+        Collection<Persona> personas = queryCallback.getPersonas();\n+        \n+        Persona persona = personas.isEmpty() ? null : personas.iterator().next();\n+        return persona;\n+    }\n+\n+    /**\n+     * Gets the row from the Personas table with the given id, creates and\n+     * returns the Persona from that data.\n+     *\n+     * @param id Persona id to match.\n+     * @return Persona matching the given UUID, may be null if no match is\n+     * found.\n+     *\n+     * @throws CentralRepoException If there is an error in querying the\n+     * Personas table.\n+     */\n+    public static Persona getPersonaById(long id) throws CentralRepoException {\n+\n+        String queryClause = PERSONA_QUERY\n+                + \"WHERE p.id = \" + id;\n+\n+        PersonaQueryCallback queryCallback = new PersonaQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+\n+        Collection<Persona> personas = queryCallback.getPersonas();\n+        \n+        return personas.isEmpty() ? null : personas.iterator().next();\n+    }\n+\n+    /**\n+     * Gets the rows from the Personas table with matching name.\n+     *\n+     * @param partialName Name substring to match.\n+     * @return Collection of personas matching the given name substring, may be\n+     * empty if no match is found.\n+     *\n+     * @throws CentralRepoException If there is an error in querying the\n+     * Personas table.\n+     */\n+    public static Collection<Persona> getPersonaByName(String partialName) throws CentralRepoException {\n+\n+        String queryClause = PERSONA_QUERY\n+                + \"WHERE LOWER(p.name) LIKE \" + \"LOWER('%\" + partialName + \"%')\" ;\n+\n+        PersonaQueryCallback queryCallback = new PersonaQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+\n+        return queryCallback.getPersonas();\n+    }\n+    \n+    /**\n+     * Creates an alias for the Persona.\n+     *\n+     * @param alias Alias name.\n+     * @param justification Reason for assigning the alias, may be null.\n+     * @param confidence Confidence level.\n+     *\n+     * @return PersonaAlias\n+     * @throws CentralRepoException If there is an error in creating the alias.\n+     */\n+    public PersonaAlias addAlias(String alias, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+        return PersonaAlias.addPersonaAlias(this, alias, justification, confidence);\n+    }\n+\n+    /**\n+     * Gets all aliases for the persona.\n+     *\n+     * @return A collection of aliases, may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in retrieving aliases.\n+     */\n+    public Collection<PersonaAlias> getAliases() throws CentralRepoException {\n+        return PersonaAlias.getPersonaAliases(this.getId());\n+    }\n+\n+    /**\n+     * Adds specified metadata to the persona.\n+     *\n+     * @param name Metadata name.\n+     * @param value Metadata value.\n+     * @param justification Reason for adding the metadata, may be null.\n+     * @param confidence Confidence level.\n+     *\n+     * @return PersonaMetadata\n+     * @throws CentralRepoException If there is an error in adding metadata.\n+     */\n+    public PersonaMetadata addMetadata(String name, String value, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+        return PersonaMetadata.addPersonaMetadata(this.getId(), name, value, justification, confidence);\n+    }\n+\n+    /**\n+     * Gets all metadata for the persona.\n+     *\n+     * @return A collection of metadata, may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in retrieving aliases.\n+     */\n+    public Collection<PersonaMetadata> getMetadata() throws CentralRepoException {\n+        return PersonaMetadata.getPersonaMetadata(this.getId());\n+    }\n+\n+    /**\n+     * Gets all the Accounts for the Persona.\n+     *\n+     * @return Collection of PersonaAccounts, may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in getting the\n+     * persona_account.\n+     */\n+    public Collection<PersonaAccount> getPersonaAccounts() throws CentralRepoException {\n+        return PersonaAccount.getPersonaAccountsForPersona(this.getId());\n     }\n \n+    /**\n+     * Gets all the Persona for the specified Account.\n+     *\n+     * @param accountId Id of account for which to get the Personas for.\n+     * @return Collection of PersonaAccounts. may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in getting the\n+     * persona_account.\n+     */\n+    public static Collection<PersonaAccount> getPersonaAccountsForAccount(long accountId) throws CentralRepoException {\n+        return PersonaAccount.getPersonaAccountsForAccount(accountId);\n+    }\n+\n+    /**\n+     * Gets all the Persona associated with all the accounts matching the given\n+     * account identifier substring.\n+     *\n+     * @param accountIdentifierSubstring Account identifier substring to search\n+     * for.\n+     * @return Collection of PersonaAccounts. may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in getting the\n+     * persona_account.\n+     */\n+    public static Collection<PersonaAccount> getPersonaAccountsForAccountIdentifier(String accountIdentifierSubstring) throws CentralRepoException {\n+        return PersonaAccount.getPersonaAccountsForAccountIdentifier(accountIdentifierSubstring);\n+    }\n+    \n+    /**\n+     * Get all accounts associated with the persona.\n+     *\n+     * @return Collection of all accounts associated with the given persona, may\n+     * be empty.\n+     * @throws CentralRepoException If there is an error in getting the\n+     * accounts.\n+     */\n+    public Collection<CentralRepoAccount> getAccounts() throws CentralRepoException {\n+        return PersonaAccount.getAccountsForPersona(this.getId());\n+    }", "originalCommit": "c682739d8ea74a032f8026d6986e152b568b98fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUxODUyOQ==", "url": "https://github.com/sleuthkit/autopsy/pull/5843#discussion_r419518529", "bodyText": "getPersonaForDataSource => getPersonasForDataSource", "author": "rcordovano", "createdAt": "2020-05-04T15:23:00Z", "path": "Core/src/org/sleuthkit/autopsy/centralrepository/datamodel/Persona.java", "diffHunk": "@@ -79,9 +100,626 @@ public String toString() {\n             return description;\n         }\n \n-        public int getStatus() {\n+        public int getStatusId() {\n             return this.status_id;\n         }\n+\n+        static PersonaStatus fromId(int value) {\n+            for (PersonaStatus status : PersonaStatus.values()) {\n+                if (status.getStatusId() == value) {\n+                    return status;\n+                }\n+            }\n+            return PersonaStatus.UNKNOWN;\n+        }\n+    }\n+\n+    // Persona name to use if no name is specified.\n+    private static final String DEFAULT_PERSONA_NAME = \"NoName\";\n+\n+    // primary key in the Personas table in CR database\n+    private final long id;\n+    private final String uuidStr;\n+    private final String name;\n+    private final String comment;\n+    private final long createdDate;\n+    private final long modifiedDate;\n+    private final PersonaStatus status;\n+    private final CentralRepoExaminer examiner;\n+\n+    public long getId() {\n+        return id;\n+    }\n+\n+    public String getUuidStr() {\n+        return uuidStr;\n+    }\n+\n+    public String getName() {\n+        return name;\n+    }\n+\n+    public String getComment() {\n+        return comment;\n+    }\n+\n+    public long getCreatedDate() {\n+        return createdDate;\n+    }\n+\n+    public long getModifiedDate() {\n+        return modifiedDate;\n+    }\n+\n+    public PersonaStatus getStatus() {\n+        return status;\n+    }\n+\n+    public CentralRepoExaminer getExaminer() {\n+        return examiner;\n+    }\n+\n+    Persona(long id, String uuidStr, String name, String comment, long created_date, long modified_date, PersonaStatus status, CentralRepoExaminer examiner) {\n+        this.id = id;\n+        this.uuidStr = uuidStr;\n+        this.name = name;\n+        this.comment = comment;\n+        this.createdDate = created_date;\n+        this.modifiedDate = modified_date;\n+        this.status = status;\n+        this.examiner = examiner;\n+    }\n+\n+    /**\n+     * Creates a Persona and associates the specified account with it.\n+     *\n+     * @param personaName Persona name.\n+     * @param comment Comment to associate with persona, may be null.\n+     * @param status Persona status\n+     * @param account Account for which the persona is being created.\n+     * @param justification Justification for why this account belongs to this\n+     * persona, may be null.\n+     * @param confidence Confidence level for this association of Persona &\n+     * account.\n+     *\n+     * @return PersonaAccount\n+     * @throws CentralRepoException If there is an error creating the Persona.\n+     */\n+    public static PersonaAccount createPersonaForAccount(String personaName, String comment, PersonaStatus status, CentralRepoAccount account, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+        Persona persona = createPersona(personaName, comment, status);\n+        return persona.addAccountToPersona(account, justification, confidence);\n+    }\n+\n+    /**\n+     * Inserts a row in the Persona tables.\n+     *\n+     * @param name Persona name, may be null - default name is used in that\n+     * case.\n+     * @param comment Comment to associate with persona, may be null.\n+     * @param status Persona status.\n+     *\n+     * @return Persona corresponding to the row inserted in the personas table.\n+     *\n+     * @throws CentralRepoException If there is an error in adding a row to\n+     * personas table.\n+     */\n+    private static Persona createPersona(String name, String comment, PersonaStatus status) throws CentralRepoException {\n+        // generate a UUID for the persona\n+        String uuidStr = UUID.randomUUID().toString();\n+        CentralRepoExaminer examiner = CentralRepository.getInstance().getCurrentCentralRepoExaminer();\n+\n+        Instant instant = Instant.now();\n+        Long timeStampMillis = instant.toEpochMilli();\n+        String insertClause = \" INTO personas (uuid, comment, name, created_date, modified_date, status_id, examiner_id ) \"\n+                + \"VALUES ( '\" + uuidStr + \"', \"\n+                + \"'\" + ((StringUtils.isBlank(comment) ? \"\" : SleuthkitCase.escapeSingleQuotes(comment))) + \"',\"\n+                + \"'\" + ((StringUtils.isBlank(name) ? DEFAULT_PERSONA_NAME : SleuthkitCase.escapeSingleQuotes(name))) + \"',\"\n+                + timeStampMillis.toString() + \",\"\n+                + timeStampMillis.toString() + \",\"\n+                + status.getStatusId() + \",\"\n+                + examiner.getId()\n+                + \")\";\n+\n+        CentralRepository.getInstance().executeInsertSQL(insertClause);\n+        return getPersonaByUUID(uuidStr);\n+    }\n+\n+    /**\n+     * Associates an account with a persona by creating a row in the\n+     * PersonaAccounts table.\n+     *\n+     * @param persona Persona to add the account to.\n+     * @param account Account to add to persona.\n+     * @param justification Reason for adding the account to persona, may be\n+     * null.\n+     * @param confidence Confidence level.\n+     *\n+     * @return PersonaAccount\n+     * @throws CentralRepoException If there is an error.\n+     */\n+    public PersonaAccount addAccountToPersona(CentralRepoAccount account, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+\n+        CentralRepoExaminer currentExaminer = CentralRepository.getInstance().getCurrentCentralRepoExaminer();\n+\n+        Instant instant = Instant.now();\n+        Long timeStampMillis = instant.toEpochMilli();\n+        String insertClause = \" INTO persona_accounts (persona_id, account_id, justification, confidence_id, date_added, examiner_id ) \"\n+                + \"VALUES ( \"\n+                + this.getId() + \", \"\n+                + account.getAccountId() + \", \"\n+                + \"'\" + ((StringUtils.isBlank(justification) ? \"\" : SleuthkitCase.escapeSingleQuotes(justification))) + \"', \"\n+                + confidence.getLevelId() + \", \"\n+                + timeStampMillis.toString() + \", \"\n+                + currentExaminer.getId()\n+                + \")\";\n+\n+        CentralRepository.getInstance().executeInsertSQL(insertClause);\n+        return new PersonaAccount(this, account, justification, confidence, timeStampMillis, currentExaminer);\n+    }\n+\n+    /**\n+     * Callback to process a Persona query from the persona table.\n+     */\n+    private static class PersonaQueryCallback implements CentralRepositoryDbQueryCallback {\n+\n+        private final Collection<Persona> personaList =  new ArrayList<>();\n+\n+        @Override\n+        public void process(ResultSet rs) throws SQLException {\n+\n+            while (rs.next()) {\n+                CentralRepoExaminer examiner = new CentralRepoExaminer(\n+                        rs.getInt(\"examiner_id\"),\n+                        rs.getString(\"login_name\"),\n+                        rs.getString(\"display_name\"));\n+\n+                PersonaStatus status = PersonaStatus.fromId(rs.getInt(\"status_id\"));\n+                Persona persona = new Persona(\n+                        rs.getInt(\"id\"),\n+                        rs.getString(\"uuid\"),\n+                        rs.getString(\"name\"),\n+                        rs.getString(\"comment\"),\n+                        Long.parseLong(rs.getString(\"created_date\")),\n+                        Long.parseLong(rs.getString(\"modified_date\")),\n+                        status,\n+                        examiner\n+                );\n+                \n+                personaList.add(persona);\n+            }\n+        }\n+\n+        Collection<Persona> getPersonas() {\n+            return Collections.unmodifiableCollection(personaList);\n+        }\n+    };\n+\n+    // Partial query string to select from personas table, \n+    // just supply the where clause.\n+    private static final String PERSONA_QUERY = \n+                  \"SELECT p.id, p.uuid, p.name, p.comment, p.created_date, p.modified_date, p.status_id, p.examiner_id, e.login_name, e.display_name \"\n+                + \"FROM personas as p \"\n+                + \"INNER JOIN examiners as e ON e.id = p.examiner_id \";\n+              \n+     \n+    /**\n+     * Gets the row from the Personas table with the given UUID, creates and\n+     * returns the Persona from that data.\n+     *\n+     * @param uuid Persona UUID to match.\n+     * @return Persona matching the given UUID, may be null if no match is\n+     * found.\n+     *\n+     * @throws CentralRepoException If there is an error in querying the\n+     * Personas table.\n+     */\n+    private static Persona getPersonaByUUID(String uuid) throws CentralRepoException {\n+\n+        String queryClause = \n+                PERSONA_QUERY\n+                + \"WHERE p.uuid = '\" + uuid + \"'\";\n+\n+        PersonaQueryCallback queryCallback = new PersonaQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+\n+        Collection<Persona> personas = queryCallback.getPersonas();\n+        \n+        Persona persona = personas.isEmpty() ? null : personas.iterator().next();\n+        return persona;\n+    }\n+\n+    /**\n+     * Gets the row from the Personas table with the given id, creates and\n+     * returns the Persona from that data.\n+     *\n+     * @param id Persona id to match.\n+     * @return Persona matching the given UUID, may be null if no match is\n+     * found.\n+     *\n+     * @throws CentralRepoException If there is an error in querying the\n+     * Personas table.\n+     */\n+    public static Persona getPersonaById(long id) throws CentralRepoException {\n+\n+        String queryClause = PERSONA_QUERY\n+                + \"WHERE p.id = \" + id;\n+\n+        PersonaQueryCallback queryCallback = new PersonaQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+\n+        Collection<Persona> personas = queryCallback.getPersonas();\n+        \n+        return personas.isEmpty() ? null : personas.iterator().next();\n+    }\n+\n+    /**\n+     * Gets the rows from the Personas table with matching name.\n+     *\n+     * @param partialName Name substring to match.\n+     * @return Collection of personas matching the given name substring, may be\n+     * empty if no match is found.\n+     *\n+     * @throws CentralRepoException If there is an error in querying the\n+     * Personas table.\n+     */\n+    public static Collection<Persona> getPersonaByName(String partialName) throws CentralRepoException {\n+\n+        String queryClause = PERSONA_QUERY\n+                + \"WHERE LOWER(p.name) LIKE \" + \"LOWER('%\" + partialName + \"%')\" ;\n+\n+        PersonaQueryCallback queryCallback = new PersonaQueryCallback();\n+        CentralRepository.getInstance().executeSelectSQL(queryClause, queryCallback);\n+\n+        return queryCallback.getPersonas();\n+    }\n+    \n+    /**\n+     * Creates an alias for the Persona.\n+     *\n+     * @param alias Alias name.\n+     * @param justification Reason for assigning the alias, may be null.\n+     * @param confidence Confidence level.\n+     *\n+     * @return PersonaAlias\n+     * @throws CentralRepoException If there is an error in creating the alias.\n+     */\n+    public PersonaAlias addAlias(String alias, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+        return PersonaAlias.addPersonaAlias(this, alias, justification, confidence);\n+    }\n+\n+    /**\n+     * Gets all aliases for the persona.\n+     *\n+     * @return A collection of aliases, may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in retrieving aliases.\n+     */\n+    public Collection<PersonaAlias> getAliases() throws CentralRepoException {\n+        return PersonaAlias.getPersonaAliases(this.getId());\n+    }\n+\n+    /**\n+     * Adds specified metadata to the persona.\n+     *\n+     * @param name Metadata name.\n+     * @param value Metadata value.\n+     * @param justification Reason for adding the metadata, may be null.\n+     * @param confidence Confidence level.\n+     *\n+     * @return PersonaMetadata\n+     * @throws CentralRepoException If there is an error in adding metadata.\n+     */\n+    public PersonaMetadata addMetadata(String name, String value, String justification, Persona.Confidence confidence) throws CentralRepoException {\n+        return PersonaMetadata.addPersonaMetadata(this.getId(), name, value, justification, confidence);\n+    }\n+\n+    /**\n+     * Gets all metadata for the persona.\n+     *\n+     * @return A collection of metadata, may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in retrieving aliases.\n+     */\n+    public Collection<PersonaMetadata> getMetadata() throws CentralRepoException {\n+        return PersonaMetadata.getPersonaMetadata(this.getId());\n+    }\n+\n+    /**\n+     * Gets all the Accounts for the Persona.\n+     *\n+     * @return Collection of PersonaAccounts, may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in getting the\n+     * persona_account.\n+     */\n+    public Collection<PersonaAccount> getPersonaAccounts() throws CentralRepoException {\n+        return PersonaAccount.getPersonaAccountsForPersona(this.getId());\n     }\n \n+    /**\n+     * Gets all the Persona for the specified Account.\n+     *\n+     * @param accountId Id of account for which to get the Personas for.\n+     * @return Collection of PersonaAccounts. may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in getting the\n+     * persona_account.\n+     */\n+    public static Collection<PersonaAccount> getPersonaAccountsForAccount(long accountId) throws CentralRepoException {\n+        return PersonaAccount.getPersonaAccountsForAccount(accountId);\n+    }\n+\n+    /**\n+     * Gets all the Persona associated with all the accounts matching the given\n+     * account identifier substring.\n+     *\n+     * @param accountIdentifierSubstring Account identifier substring to search\n+     * for.\n+     * @return Collection of PersonaAccounts. may be empty.\n+     *\n+     * @throws CentralRepoException If there is an error in getting the\n+     * persona_account.\n+     */\n+    public static Collection<PersonaAccount> getPersonaAccountsForAccountIdentifier(String accountIdentifierSubstring) throws CentralRepoException {\n+        return PersonaAccount.getPersonaAccountsForAccountIdentifier(accountIdentifierSubstring);\n+    }\n+    \n+    /**\n+     * Get all accounts associated with the persona.\n+     *\n+     * @return Collection of all accounts associated with the given persona, may\n+     * be empty.\n+     * @throws CentralRepoException If there is an error in getting the\n+     * accounts.\n+     */\n+    public Collection<CentralRepoAccount> getAccounts() throws CentralRepoException {\n+        return PersonaAccount.getAccountsForPersona(this.getId());\n+    }\n+\n+    /**\n+     * Callback to process a query that gets cases for account instances of an\n+     * account\n+     */\n+    private static class CaseForAccountInstanceQueryCallback implements CentralRepositoryDbQueryCallback {\n+\n+        Collection<CorrelationCase> correlationCases = new ArrayList<>();\n+\n+        @Override\n+        public void process(ResultSet resultSet) throws CentralRepoException, SQLException {\n+\n+            while (resultSet.next()) {\n+                // get Case for case_id\n+                CorrelationCase correlationCase = CentralRepository.getInstance().getCaseById(resultSet.getInt(\"case_id\"));\n+                correlationCases.add(correlationCase);\n+            }\n+        }\n+\n+        Collection<CorrelationCase> getCases() {\n+            return Collections.unmodifiableCollection(correlationCases);\n+        }\n+    };\n+\n+    /**\n+     * Gets a list of cases that the persona appears in.\n+     *\n+     * @return Collection of cases that the persona appears in, may be empty.\n+     * @throws CentralRepoException If there is an error in getting the cases\n+     * from the database.\n+     */\n+    public Collection<CorrelationCase> getCases() throws CentralRepoException {\n+\n+        Collection<CorrelationCase> casesForPersona = new ArrayList<>();\n+\n+        // get all accounts for this persona\n+        Collection<CentralRepoAccount> accounts = this.getAccounts();\n+        for (CentralRepoAccount account : accounts) {\n+            int corrTypeId = account.getAccountType().getCorrelationTypeId();\n+            CorrelationAttributeInstance.Type correlationType = CentralRepository.getInstance().getCorrelationTypeById(corrTypeId);\n+\n+            String tableName = CentralRepoDbUtil.correlationTypeToInstanceTableName(correlationType);\n+            String querySql = \"SELECT DISTINCT case_id FROM \" + tableName\n+                    + \" WHERE account_id = \" + account.getAccountId();\n+\n+            CaseForAccountInstanceQueryCallback queryCallback = new CaseForAccountInstanceQueryCallback();\n+            CentralRepository.getInstance().executeSelectSQL(querySql, queryCallback);\n+\n+            // Add any cases that aren't already on the list.\n+            for (CorrelationCase corrCase : queryCallback.getCases()) {\n+                if (!casesForPersona.stream().anyMatch(p -> p.getCaseUUID().equalsIgnoreCase(corrCase.getCaseUUID()))) {\n+                    casesForPersona.add(corrCase);\n+                }\n+            }\n+        }\n+\n+        return casesForPersona;\n+    }\n+\n+    /**\n+     * Callback to process a query that gets data source for account instances\n+     * of an account\n+     */\n+    private static class DatasourceForAccountInstanceQueryCallback implements CentralRepositoryDbQueryCallback {\n+\n+        Collection<CorrelationDataSource> correlationDataSources = new ArrayList<>();\n+\n+        @Override\n+        public void process(ResultSet resultSet) throws CentralRepoException, SQLException {\n+\n+            while (resultSet.next()) {\n+                // get Case for case_id\n+\n+                CorrelationCase correlationCase = CentralRepository.getInstance().getCaseById(resultSet.getInt(\"case_id\"));\n+                CorrelationDataSource correlationDatasource = CentralRepository.getInstance().getDataSourceById(correlationCase, resultSet.getInt(\"data_source_id\"));\n+\n+                // Add data source to list if not already on it.\n+                if (!correlationDataSources.stream().anyMatch(p -> Objects.equals(p.getDataSourceObjectID(), correlationDatasource.getDataSourceObjectID()))) {\n+                    correlationDataSources.add(correlationDatasource);\n+                }\n+            }\n+        }\n+\n+        Collection<CorrelationDataSource> getDataSources() {\n+            return Collections.unmodifiableCollection(correlationDataSources);\n+        }\n+    };\n+\n+    /**\n+     * Gets all data sources that the persona appears in.\n+     *\n+     * @return Collection of data sources that the persona appears in, may be\n+     * empty.\n+     *\n+     * @throws CentralRepoException\n+     */\n+    public Collection<CorrelationDataSource> getDataSources() throws CentralRepoException {\n+        Collection<CorrelationDataSource> correlationDataSources = new ArrayList<>();\n+\n+        Collection<CentralRepoAccount> accounts = this.getAccounts();\n+        for (CentralRepoAccount account : accounts) {\n+            int corrTypeId = account.getAccountType().getCorrelationTypeId();\n+            CorrelationAttributeInstance.Type correlationType = CentralRepository.getInstance().getCorrelationTypeById(corrTypeId);\n+\n+            String tableName = CentralRepoDbUtil.correlationTypeToInstanceTableName(correlationType);\n+            String querySql = \"SELECT case_id, data_source_id FROM \" + tableName\n+                    + \" WHERE account_id = \" + account.getAccountId();\n+\n+            DatasourceForAccountInstanceQueryCallback queryCallback = new DatasourceForAccountInstanceQueryCallback();\n+            CentralRepository.getInstance().executeSelectSQL(querySql, queryCallback);\n+\n+            // Add any data sources that aren't already on the list.\n+            for (CorrelationDataSource correlationDatasource : queryCallback.getDataSources()) {\n+                if (!correlationDataSources.stream().anyMatch(p -> Objects.equals(p.getDataSourceObjectID(), correlationDatasource.getDataSourceObjectID()))) {\n+                    correlationDataSources.add(correlationDatasource);\n+                }\n+            }\n+        }\n+\n+        return correlationDataSources;\n+    }\n+\n+    /**\n+     * Callback to process a query that gets Personas for a case/datasource.\n+     */\n+    private static class PersonaFromAccountInstanceQueryCallback implements CentralRepositoryDbQueryCallback {\n+\n+        Collection<Persona> personasList = new ArrayList<>();\n+\n+        @Override\n+        public void process(ResultSet resultSet) throws CentralRepoException, SQLException {\n+\n+            while (resultSet.next()) {\n+\n+                // examiner that created the persona\n+                CentralRepoExaminer personaExaminer = new CentralRepoExaminer(\n+                        resultSet.getInt(\"persona_examiner_id\"),\n+                        resultSet.getString(\"persona_examiner_login_name\"),\n+                        resultSet.getString(\"persona_examiner_display_name\"));\n+\n+                // create persona\n+                PersonaStatus status = PersonaStatus.fromId(resultSet.getInt(\"status_id\"));\n+                Persona persona = new Persona(\n+                        resultSet.getInt(\"persona_id\"),\n+                        resultSet.getString(\"uuid\"),\n+                        resultSet.getString(\"name\"),\n+                        resultSet.getString(\"comment\"),\n+                        Long.parseLong(resultSet.getString(\"created_date\")),\n+                        Long.parseLong(resultSet.getString(\"modified_date\")),\n+                        status,\n+                        personaExaminer\n+                );\n+\n+                personasList.add(persona);\n+            }\n+        }\n+\n+        Collection<Persona> getPersonasList() {\n+            return Collections.unmodifiableCollection(personasList);\n+        }\n+    };\n+\n+    /**\n+     * Returns a query string for selecting personas for a case/datasource from\n+     * the X_instance table for the given account type.\n+     *\n+     * @param crAccountType Account type to generate the query string for.\n+     * @return Query substring.\n+     * @throws CentralRepoException\n+     */\n+    private static String getPersonaFromInstanceTableQueryTemplate(CentralRepoAccount.CentralRepoAccountType crAccountType) throws CentralRepoException {\n+\n+        int corrTypeId = crAccountType.getCorrelationTypeId();\n+        CorrelationAttributeInstance.Type correlationType = CentralRepository.getInstance().getCorrelationTypeById(corrTypeId);\n+\n+        String instanceTableName = CentralRepoDbUtil.correlationTypeToInstanceTableName(correlationType);\n+        return \"SELECT \" + instanceTableName + \".account_id, case_id, data_source_id, \"\n+                + \" personas.id as persona_id, personas.uuid, personas.name, personas.comment, personas.created_date, personas.modified_date, personas.status_id, \"\n+                + \" personas.examiner_id as persona_examiner_id, persona_examiner.login_name as persona_examiner_login_name, persona_examiner.display_name as persona_examiner_display_name \"\n+                + \" FROM \" + instanceTableName\n+                + \" JOIN persona_accounts as pa on pa.account_id = \" + instanceTableName + \".account_id\"\n+                + \" JOIN personas as personas on personas.id = pa.persona_id\"\n+                + \" JOIN examiners as persona_examiner ON persona_examiner.id = personas.examiner_id \";\n+\n+    }\n+\n+    /**\n+     * Get all the persona for a given case.\n+     *\n+     * @param correlationCase Case to look the persona in.\n+     *\n+     * @return Collection of personas, may be empty.\n+     * @throws CentralRepoException\n+     */\n+    public static Collection<Persona> getPersonasForCase(CorrelationCase correlationCase) throws CentralRepoException {\n+        Collection<Persona> personaList = new ArrayList<>();\n+\n+        Collection<CentralRepoAccount.CentralRepoAccountType> accountTypes = CentralRepository.getInstance().getAllAccountTypes();\n+        for (CentralRepoAccount.CentralRepoAccountType crAccountType : accountTypes) {\n+\n+            String querySql = getPersonaFromInstanceTableQueryTemplate(crAccountType)\n+                    + \" WHERE case_id = \" + correlationCase.getID();\n+\n+            PersonaFromAccountInstanceQueryCallback queryCallback = new PersonaFromAccountInstanceQueryCallback();\n+            CentralRepository.getInstance().executeSelectSQL(querySql, queryCallback);\n+\n+            // Add persona that aren't already on the list.\n+            for (Persona persona : queryCallback.getPersonasList()) {\n+                if (!personaList.stream().anyMatch(p -> Objects.equals(p.getUuidStr(), persona.getUuidStr()))) {\n+                    personaList.add(persona);\n+                }\n+            }\n+\n+        }\n+        return personaList;\n+    }\n+\n+    /**\n+     * Get all the persona for a given data source.\n+     *\n+     * @param CorrelationDataSource Data source to look the persona in.\n+     *\n+     * @return Collection of personas, may be empty.\n+     * @throws CentralRepoException\n+     */\n+    public static Collection<Persona> getPersonaForDataSource(CorrelationDataSource dataSource) throws CentralRepoException {", "originalCommit": "c682739d8ea74a032f8026d6986e152b568b98fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c852d6bdeb3a11ec606113f6cd0575e1f870b38d", "url": "https://github.com/sleuthkit/autopsy/commit/c852d6bdeb3a11ec606113f6cd0575e1f870b38d", "message": "Addressed review comments.", "committedDate": "2020-05-04T18:11:15Z", "type": "commit"}, {"oid": "6f4f5770ce682a7266675464c80bc3d74bf7aed6", "url": "https://github.com/sleuthkit/autopsy/commit/6f4f5770ce682a7266675464c80bc3d74bf7aed6", "message": "Addressed Codacy comment.", "committedDate": "2020-05-04T19:26:31Z", "type": "commit"}, {"oid": "83a79053698b4497fb166b411a0ce9ce75b8612d", "url": "https://github.com/sleuthkit/autopsy/commit/83a79053698b4497fb166b411a0ce9ce75b8612d", "message": "- Deleted unused method updateExaminers()\n- Added escaping of examiner name\n- Added a unit test for getOrInsertExaminer() method.", "committedDate": "2020-05-05T12:25:05Z", "type": "commit"}]}