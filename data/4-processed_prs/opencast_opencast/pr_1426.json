{"pr_number": 1426, "pr_title": "Autodetect browsers for admin ui tests, fix phantomJS openssl issue", "pr_createdAt": "2020-02-21T19:09:16Z", "pr_url": "https://github.com/opencast/opencast/pull/1426", "timeline": [{"oid": "38310c0ae4efb500c80879ca8bd7f99075244872", "url": "https://github.com/opencast/opencast/commit/38310c0ae4efb500c80879ca8bd7f99075244872", "message": "Introduces auto-detection of installed browsers for use in testing the admin UI, falling back to PhantomJS if none are detected.\n\nFixed #1424", "committedDate": "2020-02-21T17:23:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc2NzkwMA==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r382767900", "bodyText": "This can be removed, right?", "author": "lkiesow", "createdAt": "2020-02-21T19:35:58Z", "path": "modules/admin-ui/src/test/resources/karma.conf.js", "diffHunk": "@@ -52,14 +52,41 @@ module.exports = function (config) {\n \n         autoWatch : true,\n \n-        frameworks: ['jasmine'],\n+        frameworks: ['detectBrowsers', 'jasmine'],\n \n-        browsers : ['PhantomJS'],\n+        detectBrowsers: {\n+            enabled: true,\n+            usePhantomJS: true,\n+            preferHeadless: true,\n+            // post processing of browsers list\n+            // here you can edit the list of browsers used by karma\n+            postDetection: function(availableBrowsers) {\n+                /* Karma configuration with custom launchers\n+                customLaunchers: {\n+                    IE9: {\n+                        base: 'IE',\n+                        'x-ua-compatible': 'IE=EmulateIE9'\n+                    }\n+                }\n+                */", "originalCommit": "38310c0ae4efb500c80879ca8bd7f99075244872", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc5NDc3MQ==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r382794771", "bodyText": "Sure, I left it in so that if we need to define one at some point we would have a template, but I can remove it.", "author": "gregorydlogan", "createdAt": "2020-02-21T20:39:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc2NzkwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAzNDczNQ==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r383034735", "bodyText": "Let's remove it. I'm pretty sure we don't want a custom IE launcher at any point ;-)", "author": "lkiesow", "createdAt": "2020-02-23T20:13:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc2NzkwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc3MTM3Ng==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r382771376", "bodyText": "Since PhantomJS is long since abanfoned, do we want to continue using it? For a lot of the other test dependencies (ffprobe, sox, synfig, \u2026) we just don't run the tests if the dependency is not present and we could do that here as well. That would also make the build system a bit simpler since we don't need to check for special cases and would make things way easier on systems like Alpine Linux.\nThat said, I don't have a very stromg opinion here and if you want to keep it, I won't start a fight ;-P", "author": "lkiesow", "createdAt": "2020-02-21T19:43:39Z", "path": "modules/admin-ui/src/test/resources/karma.conf.js", "diffHunk": "@@ -52,14 +52,41 @@ module.exports = function (config) {\n \n         autoWatch : true,\n \n-        frameworks: ['jasmine'],\n+        frameworks: ['detectBrowsers', 'jasmine'],\n \n-        browsers : ['PhantomJS'],\n+        detectBrowsers: {\n+            enabled: true,\n+            usePhantomJS: true,", "originalCommit": "38310c0ae4efb500c80879ca8bd7f99075244872", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc5NjE2MQ==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r382796161", "bodyText": "What does removing Phantom do for Alpine?\nI don't really have a strong feeling about this either way, but here's my reasoning:\nIf, somehow, Opencast is being built on a system without a browser installed we want to be able to at least have some sense of whether things are working as expected.  That's where Phantom comes in.  It's not ideal, which is also why it's excluded if anything better is available, but it allows automated build images built without a browser to continue working.\nThat being said, it's not that big a deal to include Firefox as a build dep.", "author": "gregorydlogan", "createdAt": "2020-02-21T20:42:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc3MTM3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAzNDY3Ng==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r383034676", "bodyText": "What does removing Phantom do for Alpine?\n\nBy default, Opencast does not build on systems like Apine since Opencast downloads the PhantomJS binary which requires the glibc. Since most Linux distributions use glibc, Opencast builds on most Linux systems. Unfortunately, most are not all. Apline, for instance, uses the musl libc since it is quite a bit smaller. So, building Opencast on such systems is very hard due to parts like PhantomJS.\n\nIf, somehow, Opencast is being built on a system without a browser installed we want to be able to at least have some sense of whether things are working as expected.\n\nThe recent discussion about build systems at the Dev'n'Hack camp made me realize that these tests mainly have two target audiences:\n\n\nCI systems which, by now, are certainly our main defense against accidentally pushing broken stuff into the project \u2013 and the CI systems only work because of the tests. Everyone has to pass these unless it's local code which not a lot of people still have and which is their own responsibility.\n\n\nThe team of core developers needs a local testing environment since they are making a lot of changes to the project.\n\n\nIn both cases, having a browser isn't hard. In case of a new developer not having a browser on their machine \u2013 unlikely but could happen \u2013 this does not really matter since worst case, patches would fail in the CI.\nFinally, looking at users, no tests do not matter at all for several reasons:\n\nHardly any users build their own code today. They use packages, containers, tarballs, \u2026 meaning that they do not run these tests.\nPeople do not build on the systems they deploy on. We discourage that\u2026 which makes sense.\nIf tests for release versions fail for someone, we usually advise them to disable tests. After all, we know that the tests have passed on our systems so it's likely a glitch in the tests.\n\nThat is why I tend to go with simpler is better, preventing us from having to find out that things failed for someone just because they did not have r.g. Firefox installed and we didn't realize that this failed on a certain system since we are testing with browsers.\nReasons explained, I still leave the final to you ;-)", "author": "lkiesow", "createdAt": "2020-02-23T20:12:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc3MTM3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM1MjIwOQ==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r383352209", "bodyText": "Fair enough.  This will probably break Buildbot, and possibly Travis.  Let's see.", "author": "gregorydlogan", "createdAt": "2020-02-24T15:58:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc3MTM3Ng=="}], "type": "inlineReview"}, {"oid": "e8ab64a123bd87487077ec028f75d9d28b51c840", "url": "https://github.com/opencast/opencast/commit/e8ab64a123bd87487077ec028f75d9d28b51c840", "message": "1424: Removing PhantomJS support, and adding hard dependency on a browser for developers.", "committedDate": "2020-02-24T15:57:01Z", "type": "commit"}, {"oid": "92d53c474d72bbd867828f83c54ab72929e4e3a8", "url": "https://github.com/opencast/opencast/commit/92d53c474d72bbd867828f83c54ab72929e4e3a8", "message": "1424: Detecting that *no* browsers are installed and failing the build, rather than hanging.  It does not appear to be possible to skip the tests at this point.", "committedDate": "2020-03-05T22:04:56Z", "type": "commit"}, {"oid": "e927e5378a2f25a2348c9aadff53527ae6269f6a", "url": "https://github.com/opencast/opencast/commit/e927e5378a2f25a2348c9aadff53527ae6269f6a", "message": "Adding Safari support", "committedDate": "2020-03-06T16:50:34Z", "type": "commit"}, {"oid": "35cb8fde10e3c4e0e1f0eb764b1e50732573436c", "url": "https://github.com/opencast/opencast/commit/35cb8fde10e3c4e0e1f0eb764b1e50732573436c", "message": "Removing explicit plugins so that detect-browsers can detect and load plugins as needed.", "committedDate": "2020-03-10T14:10:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM0MDY1OQ==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r405340659", "bodyText": "We're no longer using PhantomJS, right? So this can be removed?", "author": "KatrinIhler", "createdAt": "2020-04-08T08:16:32Z", "path": "modules/admin-ui/Gruntfile.js", "diffHunk": "@@ -1,6 +1,10 @@\n // Generated on 2016-03-07 using generator-angular 0.15.1\n 'use strict';\n \n+// Prevents Debian 10 (at least) from erroring out if PhantomJS is being used\n+// Appears to be related to something in the config file, but we can't exactly ship our own config\n+process.env.OPENSSL_CONF='';\n+", "originalCommit": "35cb8fde10e3c4e0e1f0eb764b1e50732573436c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQzMzk5Nw==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r406433997", "bodyText": "Fixed.", "author": "gregorydlogan", "createdAt": "2020-04-09T19:40:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM0MDY1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM0OTExMQ==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r405349111", "bodyText": "So we don't know exactly which browsers work and which don't, right?", "author": "KatrinIhler", "createdAt": "2020-04-08T08:30:26Z", "path": "docs/guides/developer/docs/installation/source-linux.md", "diffHunk": "@@ -25,6 +25,7 @@ Required:\n     ffmpeg >= 3.2.4\n     maven >= 3.1\n     python >= 2.6, < 3.0\n+    firefox/chrome/some other major browser", "originalCommit": "35cb8fde10e3c4e0e1f0eb764b1e50732573436c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMwMzc2Ng==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r406303766", "bodyText": "It tries to detect all of them, but I'm hedging in the docs to keep maintenance low :)", "author": "gregorydlogan", "createdAt": "2020-04-09T15:51:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM0OTExMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM0OTM4Mw==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r405349383", "bodyText": "Since the plugin list was removed, does this still have to be here?", "author": "KatrinIhler", "createdAt": "2020-04-08T08:30:52Z", "path": "modules/admin-ui/package.json", "diffHunk": "@@ -36,11 +36,11 @@\n     \"karma\": \"^4.1.0\",\n     \"karma-chrome-launcher\": \"^2.2.0\",\n     \"karma-coverage\": \"^1.1.2\",\n+    \"karma-detect-browsers\": \"^2.0\",\n     \"karma-firefox-launcher\": \"^1.1.0\",\n     \"karma-jasmine\": \"^1.1.2\",\n     \"karma-ng-html2js-preprocessor\": \"^1.0.0\",\n-    \"karma-phantomjs-launcher\": \"^1.0.4\",\n-    \"phantomjs-prebuilt\": \"^2.1.16\",\n+    \"karma-safari-launcher\": \"^1.0.0\",", "originalCommit": "35cb8fde10e3c4e0e1f0eb764b1e50732573436c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMwNDgxNQ==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r406304815", "bodyText": "Yes, otherwise safari doesn't work.\nThis autodetection has a nasty side effect: if it can't find anything then it just sits forever. We need to cast a wide net, otherwise someone with a default Mac install will just be stuck.", "author": "gregorydlogan", "createdAt": "2020-04-09T15:52:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM0OTM4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzMDY2Nw==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r411330667", "bodyText": "But this will result in a build error in the end, right? Did I understand that correctly? Because being stuck forever would suck.", "author": "KatrinIhler", "createdAt": "2020-04-20T12:18:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM0OTM4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM5NDgyMQ==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r411394821", "bodyText": "Yep, line 78 in karma.conf throws an error if nothing is detected.", "author": "gregorydlogan", "createdAt": "2020-04-20T13:52:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM0OTM4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM0OTg5MA==", "url": "https://github.com/opencast/opencast/pull/1426#discussion_r405349890", "bodyText": "Same question as below.", "author": "KatrinIhler", "createdAt": "2020-04-08T08:31:39Z", "path": "modules/admin-ui/package-lock.json", "diffHunk": "@@ -4506,20 +4493,10 @@\n       \"integrity\": \"sha1-ENjIz6pBNvHIp22RpMvO7evsSjE=\",\n       \"dev\": true\n     },\n-    \"karma-phantomjs-launcher\": {\n-      \"version\": \"1.0.4\",\n-      \"resolved\": \"https://registry.npmjs.org/karma-phantomjs-launcher/-/karma-phantomjs-launcher-1.0.4.tgz\",\n-      \"integrity\": \"sha1-0jyjSAG9qYY60xjju0vUBisTrNI=\",\n-      \"dev\": true,\n-      \"requires\": {\n-        \"lodash\": \"^4.0.1\",\n-        \"phantomjs-prebuilt\": \"^2.1.7\"\n-      }\n-    },\n-    \"kew\": {\n-      \"version\": \"0.7.0\",\n-      \"resolved\": \"https://registry.npmjs.org/kew/-/kew-0.7.0.tgz\",\n-      \"integrity\": \"sha1-edk9LTM2PW/dKXCzNdkUGtWR15s=\",\n+    \"karma-safari-launcher\": {", "originalCommit": "35cb8fde10e3c4e0e1f0eb764b1e50732573436c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "339817147ad97cccca07f5bbc492bedb56348f64", "url": "https://github.com/opencast/opencast/commit/339817147ad97cccca07f5bbc492bedb56348f64", "message": "Removing bits to support Phantom on Deb10 since we no longer use Phantom", "committedDate": "2020-04-09T19:40:45Z", "type": "commit"}]}