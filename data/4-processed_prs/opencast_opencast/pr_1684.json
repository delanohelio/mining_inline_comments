{"pr_number": 1684, "pr_title": "Partial Retract WOH", "pr_createdAt": "2020-07-07T18:00:01Z", "pr_url": "https://github.com/opencast/opencast/pull/1684", "timeline": [{"oid": "aef5058b7805dd383fd41e16d9ef81ed38a605e7", "url": "https://github.com/opencast/opencast/commit/aef5058b7805dd383fd41e16d9ef81ed38a605e7", "message": "Adding partial retract WOH, which enables retraction of specific flavour(s) and tags rather than pulling down the whole mediapackage.\n\nWork sponsored by University of Cape Town", "committedDate": "2020-07-07T17:47:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUwMDc4MA==", "url": "https://github.com/opencast/opencast/pull/1684#discussion_r452500780", "bodyText": "Hi @gregorydlogan, a little \"gotcha\" here. Should be retract-partial.", "author": "NgoniChoga", "createdAt": "2020-07-09T21:28:59Z", "path": "docs/guides/admin/docs/workflowoperationhandlers/retract-partial-woh.md", "diffHunk": "@@ -0,0 +1,34 @@\n+Partial Retract Engage Workflow Operation\n+=========================================\n+\n+ID: `retract-partial`\n+\n+Description\n+-----------\n+\n+The PartialRetractEngageWorkflowOperationHandler retracts a subset of the published elements from the local Opencast Media Module.  This is useful to remove incorrect captions without reprocessing the entire workflow.  Note: the elements selected for retraction match any combination of flavor or tag, and the resulting publication may be unusable if you accidentally retract one or more delivery files.  Use this operation with caution.\n+\n+Parameter Table\n+---------------\n+\n+|configuration keys         |description                                                                                  |\n+|---------------------------|---------------------------------------------------------------------------------------------|\n+|retract-flavors            |Which flavor(s) to retract.  Use a comma to separate multiple flavors.                       |\n+|retract-tags               |Which tags(s) to retract.  Use a comma to separate multiple tags.                            |\n+\n+\n+Operation Example\n+-----------------\n+\n+```xml\n+<operation\n+    id=\"retract-engage\"", "originalCommit": "aef5058b7805dd383fd41e16d9ef81ed38a605e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkzNzk5MQ==", "url": "https://github.com/opencast/opencast/pull/1684#discussion_r452937991", "bodyText": "Ah, good catch!", "author": "gregorydlogan", "createdAt": "2020-07-10T16:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUwMDc4MA=="}], "type": "inlineReview"}, {"oid": "19ddfcc0488eb212ea557b762be7704274ba92bc", "url": "https://github.com/opencast/opencast/commit/19ddfcc0488eb212ea557b762be7704274ba92bc", "message": "Fixing incorrect op id in documentation.  Clarifying description in example.", "committedDate": "2020-07-10T16:09:17Z", "type": "commit"}, {"oid": "9cf1ef36fcb655463d6eda99e86e11420517b5d4", "url": "https://github.com/opencast/opencast/commit/9cf1ef36fcb655463d6eda99e86e11420517b5d4", "message": "Fixing incorrect merge resolution present in initial forward port from 8.x", "committedDate": "2020-07-10T20:35:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM0NDc1Mg==", "url": "https://github.com/opencast/opencast/pull/1684#discussion_r471344752", "bodyText": "is this null safe?\nbeacause of trimtonull", "author": "CGreweling", "createdAt": "2020-08-17T09:09:12Z", "path": "modules/distribution-workflowoperation/src/main/java/org/opencastproject/workflow/handler/distribution/PartialRetractEngageWorkflowOperationHandler.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/**\n+ * Licensed to The Apereo Foundation under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ *\n+ * The Apereo Foundation licenses this file to you under the Educational\n+ * Community License, Version 2.0 (the \"License\"); you may not use this file\n+ * except in compliance with the License. You may obtain a copy of the License\n+ * at:\n+ *\n+ *   http://opensource.org/licenses/ecl2.txt\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ *\n+ */\n+\n+package org.opencastproject.workflow.handler.distribution;\n+\n+import static org.apache.commons.lang3.StringUtils.isBlank;\n+import static org.opencastproject.workflow.handler.distribution.EngagePublicationChannel.CHANNEL_ID;\n+\n+import org.opencastproject.job.api.Job;\n+import org.opencastproject.job.api.JobContext;\n+import org.opencastproject.mediapackage.MediaPackage;\n+import org.opencastproject.mediapackage.MediaPackageElement;\n+import org.opencastproject.mediapackage.MediaPackageElementFlavor;\n+import org.opencastproject.mediapackage.MediaPackageException;\n+import org.opencastproject.mediapackage.Publication;\n+import org.opencastproject.mediapackage.selector.SimpleElementSelector;\n+import org.opencastproject.search.api.SearchException;\n+import org.opencastproject.search.api.SearchQuery;\n+import org.opencastproject.search.api.SearchResult;\n+import org.opencastproject.workflow.api.WorkflowInstance;\n+import org.opencastproject.workflow.api.WorkflowOperationException;\n+import org.opencastproject.workflow.api.WorkflowOperationInstance;\n+import org.opencastproject.workflow.api.WorkflowOperationResult;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.Collection;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+/**\n+ * Workflow operation for retracting parts of a media package from the engage player.\n+ */\n+public class PartialRetractEngageWorkflowOperationHandler extends RetractEngageWorkflowOperationHandler {\n+\n+  /** The logging facility */\n+  private static final Logger logger = LoggerFactory.getLogger(PartialRetractEngageWorkflowOperationHandler.class);\n+\n+  private static final String RETRACT_FLAVORS = \"retract-flavors\";\n+  private static final String RETRACT_TAGS = \"retract-tags\";\n+\n+  /**\n+   * {@inheritDoc}\n+   *\n+   * @see org.opencastproject.workflow.api.WorkflowOperationHandler#start(WorkflowInstance, JobContext)\n+   */\n+  @Override\n+  public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobContext context)\n+          throws WorkflowOperationException {\n+    WorkflowOperationInstance op = workflowInstance.getCurrentOperation();\n+\n+    // Check which tags have been configured\n+    String retractTargetTags = StringUtils.trimToEmpty(op.getConfiguration(RETRACT_TAGS));\n+    String retractTargetFlavors = StringUtils.trimToNull(op.getConfiguration(RETRACT_FLAVORS));\n+\n+    String[] retractTags = StringUtils.split(retractTargetTags, \",\");\n+    String[] retractFlavors = StringUtils.split(retractTargetFlavors, \",\");", "originalCommit": "9cf1ef36fcb655463d6eda99e86e11420517b5d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1MTk1NA==", "url": "https://github.com/opencast/opencast/pull/1684#discussion_r471551954", "bodyText": "Derp, that's what I get for copy and paste :)", "author": "gregorydlogan", "createdAt": "2020-08-17T15:19:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM0NDc1Mg=="}], "type": "inlineReview"}, {"oid": "1f89b86936a98e16f8afc996ab14426670c4cc54", "url": "https://github.com/opencast/opencast/commit/1f89b86936a98e16f8afc996ab14426670c4cc54", "message": "Fixing incorrect use of trimToNull.  ToNull here would generate NPEs later...", "committedDate": "2020-08-17T15:19:46Z", "type": "commit"}, {"oid": "6433d4d18d35408798a479b9bae335692001f049", "url": "https://github.com/opencast/opencast/commit/6433d4d18d35408798a479b9bae335692001f049", "message": "Resolving incorrect deendnecy", "committedDate": "2020-09-30T19:12:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgwODM4Mg==", "url": "https://github.com/opencast/opencast/pull/1684#discussion_r497808382", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              <configurations>\n          \n          \n            \n              </configurations>", "author": "lkiesow", "createdAt": "2020-09-30T21:22:34Z", "path": "docs/guides/admin/docs/workflowoperationhandlers/retract-partial-woh.md", "diffHunk": "@@ -0,0 +1,34 @@\n+Partial Retract Engage Workflow Operation\n+=========================================\n+\n+ID: `retract-partial`\n+\n+Description\n+-----------\n+\n+The PartialRetractEngageWorkflowOperationHandler retracts a subset of the published elements from the local Opencast Media Module.  This is useful to remove incorrect captions without reprocessing the entire workflow.  Note: the elements selected for retraction match any combination of flavor or tag, and the resulting publication may be unusable if you accidentally retract one or more delivery files.  Use this operation with caution.\n+\n+Parameter Table\n+---------------\n+\n+|configuration keys         |description                                                                                  |\n+|---------------------------|---------------------------------------------------------------------------------------------|\n+|retract-flavors            |Which flavor(s) to retract.  Use a comma to separate multiple flavors.                       |\n+|retract-tags               |Which tags(s) to retract.  Use a comma to separate multiple tags.                            |\n+\n+\n+Operation Example\n+-----------------\n+\n+```xml\n+<operation\n+    id=\"retract-partial\"\n+    fail-on-error=\"true\"\n+    exception-handler-workflow=\"partial-error\"\n+    description=\"Retracting elements flavored with presentation and tagged with preview from Engage\">\n+  <configurations>\n+    <configuration key=\"retract-flavors\">presentation/*</configuration>\n+    <configuration key=\"retract-tags\">preview</configuration>\n+  <configurations>", "originalCommit": "6433d4d18d35408798a479b9bae335692001f049", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}