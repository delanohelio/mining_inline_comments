{"pr_number": 1672, "pr_title": "Issue #1608: Improve deletion performance and remove the 1000 limit", "pr_createdAt": "2020-09-21T07:14:09Z", "pr_url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1672", "timeline": [{"oid": "0611deff9983c4841763e896d6f76e05ffcd9fba", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/0611deff9983c4841763e896d6f76e05ffcd9fba", "message": "changed long to ing", "committedDate": "2020-11-26T14:50:17Z", "type": "forcePushed"}, {"oid": "dc020a0d099fb27b4951fbc3a7148e12d23aae23", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/dc020a0d099fb27b4951fbc3a7148e12d23aae23", "message": "#1608: improve apoc.ttl to enable deletion of more than 1000 nodes at once", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "840c386d147a1d17b96c28d1d454f90a5c3dcc72", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/840c386d147a1d17b96c28d1d454f90a5c3dcc72", "message": "changes review", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "47a9d7139ca73abbe2203641b0f9dbece7d7cb3a", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/47a9d7139ca73abbe2203641b0f9dbece7d7cb3a", "message": "removed unused import, format", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "844ecb14d2727ab76497c3d165f47d6beb3e24d4", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/844ecb14d2727ab76497c3d165f47d6beb3e24d4", "message": "changed deprecated by, description and moved TTLTest from apoc.date to apoc.ttl", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "12daf4398b212f679f9c080da0259d5814621015", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/12daf4398b212f679f9c080da0259d5814621015", "message": "removed unused import DateExpiry", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "23cf8a867a5fb5e83bfd4d7da602b34cd2df7544", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/23cf8a867a5fb5e83bfd4d7da602b34cd2df7544", "message": "reset default limit 1000", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "042b0281ee7d77c69f2c443a150ea7de47f533a7", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/042b0281ee7d77c69f2c443a150ea7de47f533a7", "message": "changed test and query delete with periodic.iterate", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "f36d50ed9e2b86c642da84dba0b8c24451394340", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/f36d50ed9e2b86c642da84dba0b8c24451394340", "message": "removed import", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "d187d4e9ac9006e55e7f4d9d07dc372829a6eaef", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/d187d4e9ac9006e55e7f4d9d07dc372829a6eaef", "message": "removed whitespaces", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "18f1a2a7997ddcae4b2da55d1c358057bfb26de6", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/18f1a2a7997ddcae4b2da55d1c358057bfb26de6", "message": "changes review - added param batchsize", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "014718080ba16c353a4a0d1730a52fc031c35579", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/014718080ba16c353a4a0d1730a52fc031c35579", "message": "splitted periodic iterate, fixed log.info() and added rels to test", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "d0e1a42e27d82285107cc727777e872af333f2b5", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/d0e1a42e27d82285107cc727777e872af333f2b5", "message": "changed log handling", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "3a9e06ab230bbdd404ac30de8188d9fc9da44d06", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/3a9e06ab230bbdd404ac30de8188d9fc9da44d06", "message": "changes TTLTest", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "a6dd435b9b8f1cd53da93bdb3c4572213c3e0397", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/a6dd435b9b8f1cd53da93bdb3c4572213c3e0397", "message": "removed comment", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "271d1e96097f8e347a1598f88a64f6d3428e369f", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/271d1e96097f8e347a1598f88a64f6d3428e369f", "message": "white-space", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "19635eeae5a5f258e5ed0940339173dc2e64e798", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/19635eeae5a5f258e5ed0940339173dc2e64e798", "message": "added apoc.ttl.batchsize.dbname config", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "5aaca4d2b17a90d8c6dbc4136f24cefb3afa75c0", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/5aaca4d2b17a90d8c6dbc4136f24cefb3afa75c0", "message": "code clean", "committedDate": "2020-12-06T18:19:25Z", "type": "commit"}, {"oid": "07970c24cc7d4e8307773b4dfddd9363f1259fee", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/07970c24cc7d4e8307773b4dfddd9363f1259fee", "message": "added procedure in date/TTLTest.java", "committedDate": "2020-12-06T22:49:45Z", "type": "commit"}, {"oid": "07970c24cc7d4e8307773b4dfddd9363f1259fee", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/07970c24cc7d4e8307773b4dfddd9363f1259fee", "message": "added procedure in date/TTLTest.java", "committedDate": "2020-12-06T22:49:45Z", "type": "forcePushed"}, {"oid": "be0a94d463938da7cf8f41fb140e82fc1bbbe243", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/be0a94d463938da7cf8f41fb140e82fc1bbbe243", "message": "updated ttl adoc", "committedDate": "2020-12-07T10:55:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA1MTI1NQ==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1672#discussion_r545051255", "bodyText": "let's just use limit as parameter for batch size, we don't need this inner limit anymore it was just used as a \"poor mans\" single batch in the beginning.\nBut now with periodic iterate we have proper batching and can just delete everything in batches of size \"limit\"", "author": "jexp", "createdAt": "2020-12-17T12:26:34Z", "path": "full/src/main/java/apoc/ttl/TTLLifeCycle.java", "diffHunk": "@@ -45,22 +46,34 @@ public void start() {\n             long ttlScheduleDb = configValues.schedule;\n             ttlIndexJobHandle = scheduler.schedule(TTL_GROUP, this::createTTLIndex, (int)(ttlScheduleDb*0.8), TimeUnit.SECONDS);\n             long limitDb = configValues.limit;\n-            ttlJobHandle = scheduler.scheduleRecurring(TTL_GROUP, () -> expireNodes(limitDb), ttlScheduleDb, ttlScheduleDb, TimeUnit.SECONDS);\n+            long batchSizeDb = configValues.batchSize;\n+            ttlJobHandle = scheduler.scheduleRecurring(TTL_GROUP, () -> expireNodes(limitDb, batchSizeDb), ttlScheduleDb, ttlScheduleDb, TimeUnit.SECONDS);\n         }\n     }\n \n-    public void expireNodes(long limit) {\n+    public void expireNodes(long limit, long batchSize) {\n         try {\n             if (!Util.isWriteableInstance(db)) return;\n-            db.executeTransactionally(\"MATCH (t:TTL) where t.ttl < timestamp() WITH t LIMIT $limit DETACH DELETE t\",\n-                    Util.map(\"limit\", limit),\n-                    result -> {\n-                        QueryStatistics stats = result.getQueryStatistics();\n-                        if (stats.getNodesDeleted()>0) {\n-                            log.info(\"TTL: Expired %d nodes %d relationships\", stats.getNodesDeleted(), stats.getRelationshipsDeleted());\n-                        }\n-                        return null;\n-                    });\n+            String withLimit = (limit > 0) ? \"LIMIT $limit\" : \"\";\n+            String matchTTL = \"MATCH (t:TTL) WHERE t.ttl < timestamp() \";", "originalCommit": "be0a94d463938da7cf8f41fb140e82fc1bbbe243", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA1MzYzNA==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1672#discussion_r545053634", "bodyText": "see the id(n) thing I sent to @conker84", "author": "jexp", "createdAt": "2020-12-17T12:30:36Z", "path": "full/src/main/java/apoc/ttl/TTLLifeCycle.java", "diffHunk": "@@ -45,22 +46,34 @@ public void start() {\n             long ttlScheduleDb = configValues.schedule;\n             ttlIndexJobHandle = scheduler.schedule(TTL_GROUP, this::createTTLIndex, (int)(ttlScheduleDb*0.8), TimeUnit.SECONDS);\n             long limitDb = configValues.limit;\n-            ttlJobHandle = scheduler.scheduleRecurring(TTL_GROUP, () -> expireNodes(limitDb), ttlScheduleDb, ttlScheduleDb, TimeUnit.SECONDS);\n+            long batchSizeDb = configValues.batchSize;\n+            ttlJobHandle = scheduler.scheduleRecurring(TTL_GROUP, () -> expireNodes(limitDb, batchSizeDb), ttlScheduleDb, ttlScheduleDb, TimeUnit.SECONDS);\n         }\n     }\n \n-    public void expireNodes(long limit) {\n+    public void expireNodes(long limit, long batchSize) {\n         try {\n             if (!Util.isWriteableInstance(db)) return;\n-            db.executeTransactionally(\"MATCH (t:TTL) where t.ttl < timestamp() WITH t LIMIT $limit DETACH DELETE t\",\n-                    Util.map(\"limit\", limit),\n-                    result -> {\n-                        QueryStatistics stats = result.getQueryStatistics();\n-                        if (stats.getNodesDeleted()>0) {\n-                            log.info(\"TTL: Expired %d nodes %d relationships\", stats.getNodesDeleted(), stats.getRelationshipsDeleted());\n-                        }\n-                        return null;\n-                    });\n+            String withLimit = (limit > 0) ? \"LIMIT $limit\" : \"\";\n+            String matchTTL = \"MATCH (t:TTL) WHERE t.ttl < timestamp() \";\n+            String queryRels = matchTTL + \"WITH t \" + withLimit + \" MATCH (t)-[r]-() RETURN r\";\n+            String queryNodes = matchTTL +  \"RETURN t \" + withLimit;\n+            Map<String,Object> params = Util.map(\"limit\", limit, \"batchSize\", batchSize, \"queryRels\", queryRels, \"queryNodes\", queryNodes);\n+            long relationshipsDeleted = db.executeTransactionally(\n+                    \"CALL apoc.periodic.iterate($queryRels, 'DELETE r', {batchSize: $batchSize, params:{limit: $limit}})\",", "originalCommit": "be0a94d463938da7cf8f41fb140e82fc1bbbe243", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6c9722dcdfb98dc475b8527262ee03f96cad62a9", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/6c9722dcdfb98dc475b8527262ee03f96cad62a9", "message": "removed limit in periodic iterate - queries with id(n)", "committedDate": "2021-01-13T13:36:40Z", "type": "commit"}]}