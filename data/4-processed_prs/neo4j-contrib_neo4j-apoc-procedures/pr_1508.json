{"pr_number": 1508, "pr_title": "Apoc periodic iterate", "pr_createdAt": "2020-05-12T13:21:58Z", "pr_url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1508", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5NDI0NQ==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1508#discussion_r423794245", "bodyText": "Our rather than Out? :)", "author": "JMHReif", "createdAt": "2020-05-12T14:47:19Z", "path": "docs/asciidoc/graph-updates/periodic-iterate.adoc", "diffHunk": "@@ -69,6 +112,74 @@ CALL apoc.periodic.iterate(\n   {batchSize:100, parallel:true})\n ----\n \n-In the above code, we select all the `Order` nodes that have an order date greater than `October 13, 2016` (first Cypher statement).\n-Our configuration will batch those nodes into groups of 100 (`batchSize:100`) and run the batches in parallel for the second statement to process.\n-The second Cypher statement takes those groups and finds the nodes that have a `HAS_ITEM` relationship to other nodes, then sums up the value of those items and sets that sum as a property (`o.value`) for the total order value.\n\\ No newline at end of file\n+Let's break down the parameters passed to the procedure:\n+\n+* Our first Cypher statement selects all the `Order` nodes that have an order date greater than `October 13, 2016` (first Cypher statement).\n+* Out second Cypher statement takes those groups and finds the nodes that have a `HAS_ITEM` relationship to other nodes, then sums up the value of those items and sets that sum as a property (`o.value`) for the total order value.", "originalCommit": "ddb983d04902c07ba863fc8a6c4733738098a7ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5NDk3Mw==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1508#discussion_r423794973", "bodyText": "We can use rather than We an use? :)", "author": "JMHReif", "createdAt": "2020-05-12T14:48:13Z", "path": "docs/asciidoc/graph-updates/periodic-iterate.adoc", "diffHunk": "@@ -69,6 +112,74 @@ CALL apoc.periodic.iterate(\n   {batchSize:100, parallel:true})\n ----\n \n-In the above code, we select all the `Order` nodes that have an order date greater than `October 13, 2016` (first Cypher statement).\n-Our configuration will batch those nodes into groups of 100 (`batchSize:100`) and run the batches in parallel for the second statement to process.\n-The second Cypher statement takes those groups and finds the nodes that have a `HAS_ITEM` relationship to other nodes, then sums up the value of those items and sets that sum as a property (`o.value`) for the total order value.\n\\ No newline at end of file\n+Let's break down the parameters passed to the procedure:\n+\n+* Our first Cypher statement selects all the `Order` nodes that have an order date greater than `October 13, 2016` (first Cypher statement).\n+* Out second Cypher statement takes those groups and finds the nodes that have a `HAS_ITEM` relationship to other nodes, then sums up the value of those items and sets that sum as a property (`o.value`) for the total order value.\n+* Our configuration will batch those nodes into groups of 100 (`batchSize:100`) and run the batches in parallel for the second statement to process.\n+\n+If our operations statement calls a procedure that takes in a batch of values, we can use `batchMode: \"BATCH_SINGLE\"` to get access to a batch of values to pass to that procedure.\n+When we use `BATCH_SINGLE`, the operations statement will have access to the `$_batch` parameter, which will contain a list of the fields returned in the data-driven statement.\n+\n+For example, if the data driven statement is:\n+\n+[source,cypher]\n+----\n+RETURN 'mark' AS a, 'michael' AS b\n+UNION\n+RETURN 'jennifer' AS a, 'andrea' AS b\n+----\n+\n+The contents of the `$_batch` variable passed to the operations statement would be:\n+\n+[source,text]\n+----\n+[\n+  {a: \"mark\", b: \"michael\"},\n+  {a: \"jennifer\", b: \"andrea\"}\n+]\n+----\n+\n+Let's see an example of this in action.\n+We'll start by creating some nodes:\n+\n+.The following query creates 100,000 nodes with the label `Person` and property `id`\n+[source,cypher]\n+----\n+UNWIND range(1,100000) as id create (:Person {id: id})\n+----\n+\n+We can delete these nodes using the `apoc.nodes.delete` procedure.\n+See <<deleting-data>>.\n+\n+This procedure takes in a list of nodes, which we can extract from the `$_batch` parameter.\n+\n+.The following query streams all the `Person` nodes and then passes them in batches of size 100 to `apoc.nodes.delete`\n+[source,cypher]\n+----\n+CALL apoc.periodic.iterate(\n+  \"MATCH (p:Person) RETURN p\",\n+  // Extract `p` variable using list comprehension\n+  \"CALL apoc.nodes.delete([item in $_batch | item.p], size($_batch))\",\n+  {batchMode: \"BATCH_SINGLE\", batchSize: 100}\n+)\n+YIELD batch, operations;\n+----\n+\n+The contents of the `$_batch` parameter that is used in the operations statement would be as follows:\n+\n+[source,text]\n+----\n+[{p: Node<1>}, {p: Node<2>},...]\n+----\n+\n+We an use a https://neo4j.com/docs/cypher-manual/current/syntax/lists/#cypher-list-comprehension[list comprehension^] to extract the `p` variable from each item in the list.", "originalCommit": "ddb983d04902c07ba863fc8a6c4733738098a7ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5NzU4Mg==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1508#discussion_r423797582", "bodyText": "Should it be how the data-driven statement is processed by the INNER statement? Because the data-driven statement = outer statement?", "author": "JMHReif", "createdAt": "2020-05-12T14:51:35Z", "path": "docs/asciidoc/graph-updates/periodic-iterate.adoc", "diffHunk": "@@ -8,32 +8,68 @@ ifdef::backend-html5[]\n endif::[]\n \n The `apoc.periodic.iterate` procedure is helpful when you need to handle large amounts of data for import, refactoring, and other cases that require large transactions.\n-It provides a way to batch the data by dividing the workload into two parts - a data-driven statement and an operations statement.\n+It provides a way to batch the data by dividing the workload into two parts:\n \n-The data-driven statement is how you select what data needs handled.\n+a data-driven statement:: This defines how you select what data needs handled.\n You can provide a Cypher statement to select from existing graph data, read external data from a file or API, or retrieve data from another datastore.\n-The operations statement is what you want done to the selected data.\n+\n+an operation statement:: This defines what you want done to the selected data.\n You can do things like execute Cypher for updating or creating/deleting the data or run other procedures to manipulate and transform values before loading.\n \n-To run `apoc.periodic.iterate`, the data-driven statement is provided as the *first*, outer statement that results in a stream of values to be processed.\n-The operations statement is provided as the *second*, inner statement to process *one* element at a time or (with `iterateList:true`) a batch at a time.\n+The data-driven statement is provided as the *first*, outer statement that results in a stream of values to be processed.\n+The operations statement is provided as the *second*, inner statement to process *one* element at a time or (with `batchMode: \"BATCH\"`) a batch at a time.\n The results of the outer statement are passed to the inner statement as parameters, so they are automatically made available with their names.\n \n-.configuration options\n+.Config\n+[options=header]\n+|===\n+| name | type | default | description\n+| batchSize | Long | 10000 | run the specified number of operations statements in a single tx - params: {_count, _batch}\n+| parallel | boolean | false | run operations statements in parallel (note that statements might deadlock if conflicting)\n+| retries | Long | 0 | if the operations statement fails with an error, sleep 100ms and retry until retries-count is reached - param {_retry}\n+| batchMode | String | \"BATCH\" a| how data-driven statements should be processed by outer statement. Valid values are:", "originalCommit": "ddb983d04902c07ba863fc8a6c4733738098a7ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgzNTk5Nw==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1508#discussion_r423835997", "bodyText": "Haha, I was getting so confused by outer and inner! I've removed those words and replaced with data-driven and operation now", "author": "mneedham", "createdAt": "2020-05-12T15:40:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5NzU4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0MTU0NA==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1508#discussion_r423841544", "bodyText": "I don't think we need this you can use BatchMode#valueOf method instead", "author": "conker84", "createdAt": "2020-05-12T15:48:11Z", "path": "src/main/java/apoc/periodic/BatchMode.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package apoc.periodic;\n+\n+import apoc.util.Util;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+enum BatchMode {\n+    BATCH,\n+    BATCH_SINGLE,\n+    SINGLE;\n+\n+\n+    private static final Map<String, BatchMode> nameIndex =  new HashMap<>();\n+    static {\n+        for (BatchMode batchMode : BatchMode.values()) {\n+            nameIndex.put(batchMode.name(), batchMode);\n+        }\n+    }", "originalCommit": "e68a5488e696d5e341e46ba1328c06d3ee323c3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0MjMxNQ==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1508#discussion_r423842315", "bodyText": "if we get rid of nameIndex you can change it into:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        BatchMode lookedUpBatchMode = nameIndex.get(batchMode.toString().toUpperCase());\n          \n          \n            \n                        BatchMode lookedUpBatchMode = BatchMode.valueOf(batchMode.toString().toUpperCase());", "author": "conker84", "createdAt": "2020-05-12T15:49:19Z", "path": "src/main/java/apoc/periodic/BatchMode.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package apoc.periodic;\n+\n+import apoc.util.Util;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+enum BatchMode {\n+    BATCH,\n+    BATCH_SINGLE,\n+    SINGLE;\n+\n+\n+    private static final Map<String, BatchMode> nameIndex =  new HashMap<>();\n+    static {\n+        for (BatchMode batchMode : BatchMode.values()) {\n+            nameIndex.put(batchMode.name(), batchMode);\n+        }\n+    }\n+\n+   static BatchMode fromIterateList(boolean iterateList) {\n+        return iterateList ? BATCH : SINGLE;\n+    }\n+\n+    static BatchMode fromConfig(Map<String,Object> config) {\n+        Object batchMode = config.get(\"batchMode\");\n+\n+        if(batchMode != null) {\n+            BatchMode lookedUpBatchMode = nameIndex.get(batchMode.toString().toUpperCase());", "originalCommit": "e68a5488e696d5e341e46ba1328c06d3ee323c3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0NDM2MQ==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1508#discussion_r423844361", "bodyText": "And we can also get rid of the following exception", "author": "conker84", "createdAt": "2020-05-12T15:51:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0MjMxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0Mjk5NA==", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/pull/1508#discussion_r423842994", "bodyText": "Maybe a better name could be PeriodicUtils?\nAnd add a private constructor so we can prevent the initialization", "author": "conker84", "createdAt": "2020-05-12T15:50:13Z", "path": "src/main/java/apoc/periodic/PeriodicIterate.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package apoc.periodic;\n+\n+import apoc.util.Util;\n+import org.neo4j.internal.helpers.collection.Pair;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+public class PeriodicIterate {", "originalCommit": "e68a5488e696d5e341e46ba1328c06d3ee323c3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f4e2997b946ddfea25afbf68212c85a9385a6c5b", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/f4e2997b946ddfea25afbf68212c85a9385a6c5b", "message": "introduce batchMode", "committedDate": "2020-05-13T13:13:46Z", "type": "commit"}, {"oid": "d0fd6c0390e4fb71ad2f2049e3d6886208afbe92", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/d0fd6c0390e4fb71ad2f2049e3d6886208afbe92", "message": "Wire up batch mode -> iterateList -> BATCH defaults", "committedDate": "2020-05-13T13:13:46Z", "type": "commit"}, {"oid": "e97c48221ab2a9800f6d96d7b972468bdf3b4687", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/e97c48221ab2a9800f6d96d7b972468bdf3b4687", "message": "tidying up the periodic execution docs", "committedDate": "2020-05-13T13:13:46Z", "type": "commit"}, {"oid": "9c7f1b006594a30709185612d6123356c87b4cc4", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/9c7f1b006594a30709185612d6123356c87b4cc4", "message": "add docs explaining how to use BATCH_SINGLE", "committedDate": "2020-05-13T13:13:46Z", "type": "commit"}, {"oid": "86f8e2302f34193ec34fa3e96a7e17a9da42d64b", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/86f8e2302f34193ec34fa3e96a7e17a9da42d64b", "message": "operation", "committedDate": "2020-05-13T13:13:46Z", "type": "commit"}, {"oid": "63f07c2b8b754cd0389ad3776845c046b4e8f8fa", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/63f07c2b8b754cd0389ad3776845c046b4e8f8fa", "message": "remove outer and inner", "committedDate": "2020-05-13T13:13:46Z", "type": "commit"}, {"oid": "f21894091d410059f6d3cbb6a35b3c71d2fafb5d", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/f21894091d410059f6d3cbb6a35b3c71d2fafb5d", "message": "inline iterateList", "committedDate": "2020-05-13T13:13:46Z", "type": "commit"}, {"oid": "bf502154d92e7ebd90b920cd90ed478691a83d3b", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/bf502154d92e7ebd90b920cd90ed478691a83d3b", "message": "andrea feedback", "committedDate": "2020-05-13T13:14:44Z", "type": "commit"}, {"oid": "bf502154d92e7ebd90b920cd90ed478691a83d3b", "url": "https://github.com/neo4j-contrib/neo4j-apoc-procedures/commit/bf502154d92e7ebd90b920cd90ed478691a83d3b", "message": "andrea feedback", "committedDate": "2020-05-13T13:14:44Z", "type": "forcePushed"}]}