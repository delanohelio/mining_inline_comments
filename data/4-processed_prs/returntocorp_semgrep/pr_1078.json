{"pr_number": 1078, "pr_title": "Fix bug & add nice error for null YAML values", "pr_createdAt": "2020-06-19T16:59:00Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/1078", "timeline": [{"oid": "8afc08033210b3584dcb97d5958fe62b87cbc31d", "url": "https://github.com/returntocorp/semgrep/commit/8afc08033210b3584dcb97d5958fe62b87cbc31d", "message": "Fix bug & add nice error for null YAML values", "committedDate": "2020-06-19T17:01:39Z", "type": "forcePushed"}, {"oid": "c8312e84a80c090868d8bfbb92678c83caec92ee", "url": "https://github.com/returntocorp/semgrep/commit/c8312e84a80c090868d8bfbb92678c83caec92ee", "message": "Fix bug & add nice error for null YAML values", "committedDate": "2020-06-19T17:07:22Z", "type": "forcePushed"}, {"oid": "39742ddddff5209519ea52bbb533a511e87ce422", "url": "https://github.com/returntocorp/semgrep/commit/39742ddddff5209519ea52bbb533a511e87ce422", "message": "Fix bug & add nice error for null YAML values", "committedDate": "2020-06-19T17:08:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4MzMzNA==", "url": "https://github.com/returntocorp/semgrep/pull/1078#discussion_r442983334", "bodyText": "I would move this up to the top.", "author": "mschwager", "createdAt": "2020-06-19T18:16:30Z", "path": "semgrep/semgrep/rule_lang.py", "diffHunk": "@@ -224,9 +231,22 @@ class YamlMap:\n \n     def __init__(self, internal: Dict[YamlTree[str], YamlTree]):\n         self._internal = internal\n+        for k, v in self._internal.items():\n+            if v.value is None:\n+                from semgrep.error import InvalidRuleSchemaError", "originalCommit": "39742ddddff5209519ea52bbb533a511e87ce422", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4NTE1MQ==", "url": "https://github.com/returntocorp/semgrep/pull/1078#discussion_r442985151", "bodyText": "Is this so we can handle the None case later? Can we handle it here rather than pass the value along and deal with it later?", "author": "mschwager", "createdAt": "2020-06-19T18:21:02Z", "path": "semgrep/semgrep/rule_lang.py", "diffHunk": "@@ -185,10 +186,16 @@ def unroll(self) -> YamlValue:\n             return {str(k.unroll()): v.unroll() for k, v in self.value.items()}\n         elif isinstance(self.value, YamlTree):\n             return self.value.unroll()\n-        elif isinstance(self.value, str) or isinstance(self.value, int):\n+        elif (\n+            isinstance(self.value, str)\n+            or isinstance(self.value, int)\n+            or self.value is None", "originalCommit": "39742ddddff5209519ea52bbb533a511e87ce422", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4OTQ4NQ==", "url": "https://github.com/returntocorp/semgrep/pull/1078#discussion_r442989485", "bodyText": "This is actually the unrolling process (where we convert YAML into a regular dict to be used in cases where we don't care about spans anymore).\nBy handling the check in the YamlMap constructor, we're handling it as early as possible (at YAML parse time rather than failing later during unrolling).\nThis check could probably actually be deleted given the other code, but I figured it was probably better not to explode with a strange error as we did to Clint.\nIt's also not 100% clear to me we never want to allow explicit nulls, eg. in a list.", "author": "rcoh", "createdAt": "2020-06-19T18:31:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4NTE1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAwNTAzNg==", "url": "https://github.com/returntocorp/semgrep/pull/1078#discussion_r443005036", "bodyText": "Ahh, interesting, good catch.\n\nThis check could probably actually be deleted given the other code, but I figured it was probably better not to explode with a strange error as we did to Clint.\n\nI would actually argue that this is beneficial. Failing loudly and handling that case will let us know vs. failing silently with unexpected behavior somewhere later in the program.\n\nIt's also not 100% clear to me we never want to allow explicit nulls, eg. in a list.\n\nI think this is what we currently want - pretty much everything is a string at the moment. Again, I'd rather fail loudly and handle nulls if/when we need them in the future vs. trying to accommodate future functionality.\nThoughts?", "author": "mschwager", "createdAt": "2020-06-19T19:13:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4NTE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4NTQ2Ng==", "url": "https://github.com/returntocorp/semgrep/pull/1078#discussion_r442985466", "bodyText": "Was this unused?", "author": "mschwager", "createdAt": "2020-06-19T18:21:48Z", "path": "semgrep/semgrep/config_resolver.py", "diffHunk": "@@ -170,7 +170,6 @@ def load_config_from_local_path(\n             raise SemgrepError(\n                 f\"unable to find a config; path `{loc}` does not exist{addendum}\"\n             )\n-    raise Exception", "originalCommit": "39742ddddff5209519ea52bbb533a511e87ce422", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4NzgyMQ==", "url": "https://github.com/returntocorp/semgrep/pull/1078#discussion_r442987821", "bodyText": "yeah, unreachable code", "author": "rcoh", "createdAt": "2020-06-19T18:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4NTQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk4NTY3NQ==", "url": "https://github.com/returntocorp/semgrep/pull/1078#discussion_r442985675", "bodyText": "This looks unintentional.", "author": "mschwager", "createdAt": "2020-06-19T18:22:10Z", "path": "semgrep/semgrep/rule_lang.py", "diffHunk": "@@ -19,6 +19,7 @@\n from semgrep.constants import PLEASE_FILE_ISSUE_TEXT\n \n # Do not construct directly, use `SpanBuilder().add_source`\n+", "originalCommit": "39742ddddff5209519ea52bbb533a511e87ce422", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a526d8436de677a714cbf63590e9115537ff2bea", "url": "https://github.com/returntocorp/semgrep/commit/a526d8436de677a714cbf63590e9115537ff2bea", "message": "Fix bug & add nice error for null YAML values", "committedDate": "2020-06-22T16:39:05Z", "type": "commit"}, {"oid": "f9d9cd7cc89fb0773aed605b2949faa9580e5ebe", "url": "https://github.com/returntocorp/semgrep/commit/f9d9cd7cc89fb0773aed605b2949faa9580e5ebe", "message": "Fix extra newline, clarify comment", "committedDate": "2020-06-22T16:39:05Z", "type": "commit"}, {"oid": "9b0ff9062c5fd1b74c3ef33283dc44feaea24b43", "url": "https://github.com/returntocorp/semgrep/commit/9b0ff9062c5fd1b74c3ef33283dc44feaea24b43", "message": "Fix extra newline, reorder constructor", "committedDate": "2020-06-22T16:39:05Z", "type": "commit"}, {"oid": "1d5f4d418cb01eaff22dbec374e2251df37cca25", "url": "https://github.com/returntocorp/semgrep/commit/1d5f4d418cb01eaff22dbec374e2251df37cca25", "message": "Never allow null values anywhere in Semgrep YAML", "committedDate": "2020-06-22T17:06:14Z", "type": "forcePushed"}, {"oid": "1526c39988bf164e9dd20afcd0494f532f70f141", "url": "https://github.com/returntocorp/semgrep/commit/1526c39988bf164e9dd20afcd0494f532f70f141", "message": "Never allow null values anywhere in Semgrep YAML", "committedDate": "2020-06-22T17:11:48Z", "type": "commit"}, {"oid": "1526c39988bf164e9dd20afcd0494f532f70f141", "url": "https://github.com/returntocorp/semgrep/commit/1526c39988bf164e9dd20afcd0494f532f70f141", "message": "Never allow null values anywhere in Semgrep YAML", "committedDate": "2020-06-22T17:11:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwOTA4NQ==", "url": "https://github.com/returntocorp/semgrep/pull/1078#discussion_r443709085", "bodyText": "I would move this to the top of the file. It's nice to have all your imports in one place at the top vs. sprinkled throughout.", "author": "mschwager", "createdAt": "2020-06-22T17:14:10Z", "path": "semgrep/semgrep/rule_lang.py", "diffHunk": "@@ -258,12 +291,26 @@ def parse_yaml_preserve_spans(contents: str, filename: Optional[str]) -> YamlTre\n     parse yaml into a YamlTree object. The resulting spans are tracked in SourceTracker\n     so they can be used later when constructing error messages or displaying context.\n     \"\"\"\n-    # this uses the `RoundTripConstructor` which inherits from `SafeConstructor`\n     source_hash = SourceTracker.add_source(contents)\n \n+    # this uses the `RoundTripConstructor` which inherits from `SafeConstructor`\n     class SpanPreservingRuamelConstructor(RoundTripConstructor):\n         def construct_object(self, node: Node, deep: bool = False) -> YamlTree:\n             r = super().construct_object(node, deep)\n+            if r is None:\n+                from semgrep.error import InvalidRuleSchemaError", "originalCommit": "1526c39988bf164e9dd20afcd0494f532f70f141", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxMjMxMA==", "url": "https://github.com/returntocorp/semgrep/pull/1078#discussion_r443712310", "bodyText": "Circular imporr", "author": "rcoh", "createdAt": "2020-06-22T17:20:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcwOTA4NQ=="}], "type": "inlineReview"}]}