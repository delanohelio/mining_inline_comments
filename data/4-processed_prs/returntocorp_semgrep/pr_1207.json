{"pr_number": 1207, "pr_title": "Handle file-not-found errors more gracefully", "pr_createdAt": "2020-07-07T22:48:46Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/1207", "timeline": [{"oid": "f3c71caf42d49653dcd8e5198527c1cde487c085", "url": "https://github.com/returntocorp/semgrep/commit/f3c71caf42d49653dcd8e5198527c1cde487c085", "message": "Handle file-not-found errors more gracefully\n\nRe-factored target manager init method to use attr.s for clarity and passed output_handler to target_manager.", "committedDate": "2020-07-07T22:43:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwNjAxOQ==", "url": "https://github.com/returntocorp/semgrep/pull/1207#discussion_r451206019", "bodyText": "TargetManager should not need to know how to handle output. Probably better to have functions return relevant info and the caller can handle how it wants to deal with outputing said info.", "author": "brendongo", "createdAt": "2020-07-07T23:51:38Z", "path": "semgrep/semgrep/target_manager.py", "diffHunk": "@@ -62,26 +67,22 @@ def lang_to_exts(language: Language) -> List[FileExtension]:\n         raise _UnknownLanguageError(f\"Unsupported Language: {language}\")\n \n \n+@attr.s(auto_attribs=True)\n class TargetManager:\n-    def __init__(\n-        self,\n-        includes: List[str],\n-        excludes: List[str],\n-        targets: List[str],\n-        respect_git_ignore: bool,\n-    ) -> None:\n-        \"\"\"\n-            Handles all file include/exclude logic for semgrep\n+    \"\"\"\n+        Handles all file include/exclude logic for semgrep\n \n-            If respect_git_ignore is true then will only consider files that are\n-            tracked or (untracked but not ignored) by git\n-        \"\"\"\n-        self._targets = targets\n-        self._includes = includes\n-        self._excludes = excludes\n-        self._respect_git_ignore = respect_git_ignore\n+        If respect_git_ignore is true then will only consider files that are\n+        tracked or (untracked but not ignored) by git\n+    \"\"\"\n+\n+    targets: List[str]\n+    includes: List[str]\n+    excludes: List[str]\n+    respect_git_ignore: bool\n+    output_handler: OutputHandler", "originalCommit": "f3c71caf42d49653dcd8e5198527c1cde487c085", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIxMDk1OQ==", "url": "https://github.com/returntocorp/semgrep/pull/1207#discussion_r451210959", "bodyText": "Can you elaborate on this a bit more? I understand the preference for not making output_handler a required argument, but don't really understand the alternative you are suggesting (how would you change the FilesNotFoundError?)", "author": "chmccreery", "createdAt": "2020-07-08T00:09:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwNjAxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIxNTQ0Ng==", "url": "https://github.com/returntocorp/semgrep/pull/1207#discussion_r451215446", "bodyText": "@brendongo IMO we should really have a context object do this (a la Bento) or a reader monad or the like. But passing output_handler here is exactly how we separate knowing how to handle output from the TargetManager.", "author": "nbrahms", "createdAt": "2020-07-08T00:26:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwNjAxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIxNjI5NQ==", "url": "https://github.com/returntocorp/semgrep/pull/1207#discussion_r451216295", "bodyText": "I mean: TargetManager should concern itself with file includes excludes and not need to know how to use an output_handler object. Resolved targets can return a tuple with the second item being problematic files.", "author": "brendongo", "createdAt": "2020-07-08T00:30:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwNjAxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIxNzQ1OA==", "url": "https://github.com/returntocorp/semgrep/pull/1207#discussion_r451217458", "bodyText": "TargetManager should not need to know that any errors are \"handled\" or that they are even errors to begin with. The TargetManager just knows that of the files you handed it, these happened to not exist and it lets you know that. It's up to the caller to deal with this information.", "author": "brendongo", "createdAt": "2020-07-08T00:34:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwNjAxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNTI1MA==", "url": "https://github.com/returntocorp/semgrep/pull/1207#discussion_r451225250", "bodyText": "Thinking about this more and the list of files that don't exist is unrelated to the language so might be better placed in the constructor instead of in this code path. Seems like a significant endeavor would be supportive of getting this PR in as is with injection implementation and revisiting that and constructor in a follow up.", "author": "brendongo", "createdAt": "2020-07-08T01:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwNjAxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNTUyOA==", "url": "https://github.com/returntocorp/semgrep/pull/1207#discussion_r451225528", "bodyText": "you might want to think about the edge cases of a rule with multiple languages calling get_files multiple times though", "author": "brendongo", "createdAt": "2020-07-08T01:06:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwNjAxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIzMzYwMg==", "url": "https://github.com/returntocorp/semgrep/pull/1207#discussion_r451233602", "bodyText": "Good thought! We just tested this case and it seems to print out the right thing (only once)", "author": "chmccreery", "createdAt": "2020-07-08T01:38:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwNjAxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwNjU2OA==", "url": "https://github.com/returntocorp/semgrep/pull/1207#discussion_r451206568", "bodyText": "You might need to handle symlinked files as well?", "author": "brendongo", "createdAt": "2020-07-07T23:53:27Z", "path": "semgrep/semgrep/target_manager.py", "diffHunk": "@@ -237,23 +238,31 @@ def filtered_files(self, lang: Language) -> Set[Path]:\n         if lang in self._filtered_targets:\n             return self._filtered_targets[lang]\n \n-        targets = self.resolve_targets(self._targets)\n-        explicit_files, directories = partition_set(lambda p: not p.is_dir(), targets)\n+        targets = self.resolve_targets(self.targets)\n+\n+        files, directories = partition_set(lambda p: not p.is_dir(), targets)\n+\n+        # Error on non-existent files\n+        explicit_files, nonexistent_files = partition_set(lambda p: p.is_file(), files)", "originalCommit": "f3c71caf42d49653dcd8e5198527c1cde487c085", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIxMjE0Mw==", "url": "https://github.com/returntocorp/semgrep/pull/1207#discussion_r451212143", "bodyText": "It looks like is_file() should cover regular files and symlinks (and I just tested with symlinks and got the behavior I expected- but maybe that is not the desired behavior): https://docs.python.org/3/library/pathlib.html#pathlib.Path.is_file\nOr do you mean that symlinked files should be handled differently instead of lumped in with regular files?", "author": "chmccreery", "createdAt": "2020-07-08T00:14:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwNjU2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIxNjY1MA==", "url": "https://github.com/returntocorp/semgrep/pull/1207#discussion_r451216650", "bodyText": "Oh hmm so it does. Not sure why tests are failing then", "author": "brendongo", "createdAt": "2020-07-08T00:31:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwNjU2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyMTc1MQ==", "url": "https://github.com/returntocorp/semgrep/pull/1207#discussion_r451221751", "bodyText": "At least one of them is because we added the parameter to TargetManager but the test file still thinks it only takes 4 arguments... I'm working on it", "author": "chmccreery", "createdAt": "2020-07-08T00:51:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwNjU2OA=="}], "type": "inlineReview"}, {"oid": "93d1c7c00a43b2241f0f543f30ec69f53a26b47c", "url": "https://github.com/returntocorp/semgrep/commit/93d1c7c00a43b2241f0f543f30ec69f53a26b47c", "message": "Fix test failures from reordered arguments to TargetManager", "committedDate": "2020-07-08T01:29:04Z", "type": "commit"}, {"oid": "4f32bc77bad7a6381a556daccdb75a26713cf9e5", "url": "https://github.com/returntocorp/semgrep/commit/4f32bc77bad7a6381a556daccdb75a26713cf9e5", "message": "update CHANGELOG", "committedDate": "2020-07-08T20:29:06Z", "type": "commit"}]}