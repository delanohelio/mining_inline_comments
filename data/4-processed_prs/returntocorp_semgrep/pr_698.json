{"pr_number": 698, "pr_title": "Build release wheels", "pr_createdAt": "2020-05-06T16:22:32Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/698", "timeline": [{"oid": "0d5b56b88c176166c3a7252232fafa75fbfbb2ae", "url": "https://github.com/returntocorp/semgrep/commit/0d5b56b88c176166c3a7252232fafa75fbfbb2ae", "message": "Build release wheels", "committedDate": "2020-05-06T16:24:32Z", "type": "forcePushed"}, {"oid": "3d5680da9534210145494c4d6bba400d848016ac", "url": "https://github.com/returntocorp/semgrep/commit/3d5680da9534210145494c4d6bba400d848016ac", "message": "Build release wheels", "committedDate": "2020-05-06T16:46:10Z", "type": "commit"}, {"oid": "3d5680da9534210145494c4d6bba400d848016ac", "url": "https://github.com/returntocorp/semgrep/commit/3d5680da9534210145494c4d6bba400d848016ac", "message": "Build release wheels", "committedDate": "2020-05-06T16:46:10Z", "type": "forcePushed"}, {"oid": "1ec7494e210b95d724444b40bd348cf011fd42cf", "url": "https://github.com/returntocorp/semgrep/commit/1ec7494e210b95d724444b40bd348cf011fd42cf", "message": "Produce a wheel with the correct versions", "committedDate": "2020-05-06T18:25:35Z", "type": "commit"}, {"oid": "f32f59c5c20bc6625a2e5a5c3ad04a7c96470e4d", "url": "https://github.com/returntocorp/semgrep/commit/f32f59c5c20bc6625a2e5a5c3ad04a7c96470e4d", "message": "Try again for matrix builds", "committedDate": "2020-05-06T18:33:51Z", "type": "forcePushed"}, {"oid": "6cfcbcaad088de9e69c1483d12a97710f0e4d19f", "url": "https://github.com/returntocorp/semgrep/commit/6cfcbcaad088de9e69c1483d12a97710f0e4d19f", "message": "Try again for matrix builds", "committedDate": "2020-05-06T18:35:00Z", "type": "forcePushed"}, {"oid": "6daf2ec1c79da418915eea05712df58ace00e2cd", "url": "https://github.com/returntocorp/semgrep/commit/6daf2ec1c79da418915eea05712df58ace00e2cd", "message": "Try again for matrix builds", "committedDate": "2020-05-06T18:37:44Z", "type": "commit"}, {"oid": "6daf2ec1c79da418915eea05712df58ace00e2cd", "url": "https://github.com/returntocorp/semgrep/commit/6daf2ec1c79da418915eea05712df58ace00e2cd", "message": "Try again for matrix builds", "committedDate": "2020-05-06T18:37:44Z", "type": "forcePushed"}, {"oid": "cbb04a43ad6ef541f8bae3b3b6192f6023d0dd7a", "url": "https://github.com/returntocorp/semgrep/commit/cbb04a43ad6ef541f8bae3b3b6192f6023d0dd7a", "message": "Fix tox & install setuptools and wheel first", "committedDate": "2020-05-06T18:51:29Z", "type": "commit"}, {"oid": "a6be93da420b2bfea254bca8e00b88accbd73bf7", "url": "https://github.com/returntocorp/semgrep/commit/a6be93da420b2bfea254bca8e00b88accbd73bf7", "message": "Working on ubuntu wheels", "committedDate": "2020-05-06T19:14:57Z", "type": "commit"}, {"oid": "7e4b1a495768ff8f38d2b0da79e7877787226b59", "url": "https://github.com/returntocorp/semgrep/commit/7e4b1a495768ff8f38d2b0da79e7877787226b59", "message": "Upload wheels as artifacts", "committedDate": "2020-05-06T19:21:02Z", "type": "commit"}, {"oid": "1c718dd269dae0d5125fc66c795262b5632abec2", "url": "https://github.com/returntocorp/semgrep/commit/1c718dd269dae0d5125fc66c795262b5632abec2", "message": "Try again to fix tox tests", "committedDate": "2020-05-06T19:26:17Z", "type": "commit"}, {"oid": "d7e4e2beb04d852a0abeb588916169adddbf9186", "url": "https://github.com/returntocorp/semgrep/commit/d7e4e2beb04d852a0abeb588916169adddbf9186", "message": "Don't both building a nuitka binary on ubuntu.", "committedDate": "2020-05-06T19:44:06Z", "type": "commit"}, {"oid": "668771b0683de696dcfcbc6e0ef358d1c95eefdb", "url": "https://github.com/returntocorp/semgrep/commit/668771b0683de696dcfcbc6e0ef358d1c95eefdb", "message": "Produce a wheel for a lower OSX version", "committedDate": "2020-05-06T19:51:40Z", "type": "commit"}, {"oid": "50ebdb0854094195580007a3e76df4126eb94cd2", "url": "https://github.com/returntocorp/semgrep/commit/50ebdb0854094195580007a3e76df4126eb94cd2", "message": "Assorted fixes", "committedDate": "2020-05-06T20:24:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4NTkwNw==", "url": "https://github.com/returntocorp/semgrep/pull/698#discussion_r421085907", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                author_email=\"support@returntocorp.com\",\n          \n          \n            \n                author_email=\"support@r2c.dev\",", "author": "brendongo", "createdAt": "2020-05-06T20:54:53Z", "path": "semgrep/setup.py", "diffHunk": "@@ -1,15 +1,118 @@\n # type: ignore\n+import contextlib\n+import distutils.util\n+import os\n+import sys\n+\n import setuptools\n+from setuptools import setup\n+from setuptools.command.install import install\n+from wheel.bdist_wheel import bdist_wheel as _bdist_wheel\n+\n+\n+@contextlib.contextmanager\n+def chdir(dirname=None):\n+    curdir = os.getcwd()\n+    try:\n+        if dirname is not None:\n+            os.chdir(dirname)\n+        yield\n+    finally:\n+        os.chdir(curdir)\n+\n+\n+# TODO: what is the minimum OSX version?\n+MIN_OSX_VERSION = \"10_14\"\n+\n+# from https://stackoverflow.com/questions/45150304/how-to-force-a-python-wheel-to-be-platform-specific-when-building-it # noqa\n+class bdist_wheel(_bdist_wheel):\n+    def finalize_options(self):\n+        _bdist_wheel.finalize_options(self)\n+        # Mark us as not a pure python package (we have platform specific rust code)\n+        self.root_is_pure = False\n+\n+    def get_tag(self):\n+        # this set's us up to build generic wheels.\n+        # note: we're only doing this for windows right now (causes packaging issues\n+        # with osx)\n+        _, _, plat = _bdist_wheel.get_tag(self)\n+        # We don't need cPython\n+        python = \".\".join([\"py36\", \"py37\", \"py38\"])\n+        abi = \"none\"\n+\n+        if \"macosx\" in plat:\n+            plat = f\"macosx_{MIN_OSX_VERSION}_x86_64.whl\"\n+\n+        return python, abi, plat\n+\n+\n+try:\n+    with open(\"../README.md\") as f:\n+        long_description = f.read()\n+except FileNotFoundError:\n+    long_description = \"\"\n+\n+\n+class PostInstallCommand(install):\n+    \"\"\"Post-installation for installation mode.\"\"\"\n+\n+    def run(self):\n+        if \"TOX_ENV_NAME\" in os.environ:\n+            print(\"Not attempting to install binary while running under tox\")\n+            return\n+        # So ths builds the executable, and even installs it\n+        # but we can't install to the bin directory:\n+        #     https://github.com/pypa/setuptools/issues/210#issuecomment-216657975\n+        # take the advice from that comment, and move over after install\n+        source_dir = os.path.dirname(os.path.abspath(__file__))\n+\n+        if os.environ.get(\"PRECOMILED_LOCATION\"):\n+            source = os.environ[\"PRECOMPILED_LOCATION\"]\n+        else:\n+            repo_root = os.path.dirname(source_dir)\n+            if \"osx\" in distutils.util.get_platform():\n+                with chdir(repo_root):\n+                    os.system(os.path.join(repo_root, \"release-scripts/osx-release.sh\"))\n+                    source = os.path.join(repo_root, \"artifacts/semgrep-core\")\n+            else:\n+                with chdir(repo_root):\n+                    os.putenv(\"SKIP_NUITKA\", \"TRUE\")\n+                    os.system(\n+                        os.path.join(repo_root, \"release-scripts/ubuntu-release.sh\")\n+                    )\n+                    source = os.path.join(repo_root, \"semgrep-files/semgrep-core\")\n+\n+        ## setuptools_rust doesn't seem to let me specify a musl cross compilation target\n+        ## so instead just build ourselves here =(.\n+        # if os.system(\"cargo build --release %s\" % compile_args):\n+        #    raise ValueError(\"Failed to compile!\")\n+\n+        ## run this after trying to build with cargo (as otherwise this leaves\n+        ## venv in a bad state: https://github.com/benfred/py-spy/issues/69)\n+        install.run(self)\n+\n+        ## we're going to install the py-spy executable into the scripts directory\n+        ## but first make sure the scripts directory exists\n+        if not os.path.isdir(self.install_scripts):\n+            os.makedirs(self.install_scripts)\n+\n+        target = os.path.join(self.install_scripts, \"semgrep-core\")\n+        if os.path.isfile(target):\n+            os.remove(target)\n+\n+        self.copy_file(source, target)\n+\n \n-setuptools.setup(\n+setup(\n     name=\"semgrep\",  # Replace with your own username\n     version=\"0.6.0\",\n     author=\"Russell & Return 2 Corp\",\n-    author_email=\"author@example.com\",\n-    description=\"semgrep python wrapper\",\n-    long_description=\"bloop\",\n+    author_email=\"support@returntocorp.com\",", "originalCommit": "50ebdb0854094195580007a3e76df4126eb94cd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA4Njc5OA==", "url": "https://github.com/returntocorp/semgrep/pull/698#discussion_r421086798", "bodyText": "No version pinning?", "author": "brendongo", "createdAt": "2020-05-06T20:56:36Z", "path": "semgrep/requirements.txt", "diffHunk": "@@ -3,3 +3,4 @@ pytest==5.3.5\n pyyaml==5.3\n requests==2.22.0\n tox==3.14.6\n+wheel", "originalCommit": "50ebdb0854094195580007a3e76df4126eb94cd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA5MDEyNg==", "url": "https://github.com/returntocorp/semgrep/pull/698#discussion_r421090126", "bodyText": "Can we leave this on and archive the relevant places this fires on this PR", "author": "brendongo", "createdAt": "2020-05-06T21:02:31Z", "path": ".bento/config.yml", "diffHunk": "@@ -28,7 +28,7 @@ tools:\n     - subprocess-without-shell-equals-true\n     - try-except-continue\n     - urllib-urlopen\n-    run: true\n+    run: false", "originalCommit": "50ebdb0854094195580007a3e76df4126eb94cd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg4NDE5Mw==", "url": "https://github.com/returntocorp/semgrep/pull/698#discussion_r421884193", "bodyText": "done", "author": "rcoh", "createdAt": "2020-05-08T01:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA5MDEyNg=="}], "type": "inlineReview"}, {"oid": "c003b5d715d98afcd73b76f20b716d126f7ba9ab", "url": "https://github.com/returntocorp/semgrep/commit/c003b5d715d98afcd73b76f20b716d126f7ba9ab", "message": "Update semgrep/setup.py\n\nCo-authored-by: Brendon Go <brendon.go@gmail.com>", "committedDate": "2020-05-06T21:04:19Z", "type": "commit"}, {"oid": "04c9455d5081debf4e5a7ebfbd80fa51e0939554", "url": "https://github.com/returntocorp/semgrep/commit/04c9455d5081debf4e5a7ebfbd80fa51e0939554", "message": "Add pinned version for wheel", "committedDate": "2020-05-06T21:18:34Z", "type": "commit"}, {"oid": "695f512811587f4ca73689d64416907d9561b481", "url": "https://github.com/returntocorp/semgrep/commit/695f512811587f4ca73689d64416907d9561b481", "message": "Merge branch 'russell/build-wheels-test-release' of github.com:returntocorp/sgrep into russell/build-wheels-test-release", "committedDate": "2020-05-06T21:19:05Z", "type": "commit"}, {"oid": "a5239c196eb133af192832aeaa826f9bff390d1e", "url": "https://github.com/returntocorp/semgrep/commit/a5239c196eb133af192832aeaa826f9bff390d1e", "message": "Re-enable bandit and silence specific checks", "committedDate": "2020-05-08T01:19:47Z", "type": "commit"}, {"oid": "4ddc78d6c83fee96632ed81f2074ac580715a06e", "url": "https://github.com/returntocorp/semgrep/commit/4ddc78d6c83fee96632ed81f2074ac580715a06e", "message": "Update setup.py description", "committedDate": "2020-05-08T02:22:56Z", "type": "commit"}]}