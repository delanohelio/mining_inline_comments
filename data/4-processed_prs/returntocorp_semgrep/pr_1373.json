{"pr_number": 1373, "pr_title": "tests: add basic perf regression test", "pr_createdAt": "2020-07-27T22:15:08Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/1373", "timeline": [{"oid": "cc535682fce00a2baab517691cd39c852aee43f4", "url": "https://github.com/returntocorp/semgrep/commit/cc535682fce00a2baab517691cd39c852aee43f4", "message": "fixup! Calculate timing on frozen target and config", "committedDate": "2020-07-27T22:38:00Z", "type": "forcePushed"}, {"oid": "528b72b437c421f4f3677bd39aa684c4693833be", "url": "https://github.com/returntocorp/semgrep/commit/528b72b437c421f4f3677bd39aa684c4693833be", "message": "fixup! fixup! Calculate timing on frozen target and config", "committedDate": "2020-07-27T23:29:56Z", "type": "forcePushed"}, {"oid": "f0d7e6a56e8d638ab6ffdd451bac6bbfd4225116", "url": "https://github.com/returntocorp/semgrep/commit/f0d7e6a56e8d638ab6ffdd451bac6bbfd4225116", "message": "fixup! fixup! fixup! Calculate timing on frozen target and config", "committedDate": "2020-07-31T23:20:15Z", "type": "forcePushed"}, {"oid": "0179c4946c61337853cbd59a45da508508c55c43", "url": "https://github.com/returntocorp/semgrep/commit/0179c4946c61337853cbd59a45da508508c55c43", "message": "fixup! fixup! fixup! Calculate timing on frozen target and config", "committedDate": "2020-07-31T23:30:41Z", "type": "forcePushed"}, {"oid": "4653a945150316e88a88dd771074e76c54cc2fd3", "url": "https://github.com/returntocorp/semgrep/commit/4653a945150316e88a88dd771074e76c54cc2fd3", "message": "fixup! fixup! fixup! Calculate timing on frozen target and config", "committedDate": "2020-08-01T00:09:05Z", "type": "forcePushed"}, {"oid": "b1f6c7e6340700c722eb039b4264f365ee5201d2", "url": "https://github.com/returntocorp/semgrep/commit/b1f6c7e6340700c722eb039b4264f365ee5201d2", "message": "fixup! fixup! fixup! Calculate timing on frozen target and config", "committedDate": "2020-08-01T00:19:55Z", "type": "forcePushed"}, {"oid": "2d871782138860f3a6b44b24f1f89d564a257175", "url": "https://github.com/returntocorp/semgrep/commit/2d871782138860f3a6b44b24f1f89d564a257175", "message": "fixup! fixup! fixup! Calculate timing on frozen target and config", "committedDate": "2020-08-01T00:37:04Z", "type": "forcePushed"}, {"oid": "762c1a6f18ef40ff51133c834015aa54ba22dd0c", "url": "https://github.com/returntocorp/semgrep/commit/762c1a6f18ef40ff51133c834015aa54ba22dd0c", "message": "Calculate timing on frozen target and config", "committedDate": "2020-08-04T21:55:02Z", "type": "commit"}, {"oid": "5357d34d73e12bf4c394ed1eff7e4871627361d0", "url": "https://github.com/returntocorp/semgrep/commit/5357d34d73e12bf4c394ed1eff7e4871627361d0", "message": "fixup! Calculate timing on frozen target and config", "committedDate": "2020-08-04T21:55:02Z", "type": "commit"}, {"oid": "73078d5ad3380b73f2d721b6a7b6f22d47d8a04a", "url": "https://github.com/returntocorp/semgrep/commit/73078d5ad3380b73f2d721b6a7b6f22d47d8a04a", "message": "fixup! fixup! Calculate timing on frozen target and config", "committedDate": "2020-08-04T21:55:02Z", "type": "commit"}, {"oid": "97f7614f3c119333607031449f5812ce8fef95af", "url": "https://github.com/returntocorp/semgrep/commit/97f7614f3c119333607031449f5812ce8fef95af", "message": "fixup! fixup! fixup! Calculate timing on frozen target and config", "committedDate": "2020-08-04T21:55:02Z", "type": "commit"}, {"oid": "3f81a59bb27544b4b458011ca699acfddb08fb82", "url": "https://github.com/returntocorp/semgrep/commit/3f81a59bb27544b4b458011ca699acfddb08fb82", "message": "Calculate timing on frozen target and config", "committedDate": "2020-08-04T21:56:29Z", "type": "commit"}, {"oid": "5b80dddc2a895dd731a6ac85bbca2d7e3d1fb378", "url": "https://github.com/returntocorp/semgrep/commit/5b80dddc2a895dd731a6ac85bbca2d7e3d1fb378", "message": "fixup! Calculate timing on frozen target and config", "committedDate": "2020-08-04T21:56:29Z", "type": "commit"}, {"oid": "3cb751aa5bb26424cf0607628eb493fff9d98e19", "url": "https://github.com/returntocorp/semgrep/commit/3cb751aa5bb26424cf0607628eb493fff9d98e19", "message": "fixup! fixup! Calculate timing on frozen target and config", "committedDate": "2020-08-04T21:56:56Z", "type": "commit"}, {"oid": "0439bc8294d73734254bf51ae28b8f045b5c6955", "url": "https://github.com/returntocorp/semgrep/commit/0439bc8294d73734254bf51ae28b8f045b5c6955", "message": "tests: add basic perf regression", "committedDate": "2020-08-04T23:34:16Z", "type": "commit"}, {"oid": "0439bc8294d73734254bf51ae28b8f045b5c6955", "url": "https://github.com/returntocorp/semgrep/commit/0439bc8294d73734254bf51ae28b8f045b5c6955", "message": "tests: add basic perf regression", "committedDate": "2020-08-04T23:34:16Z", "type": "forcePushed"}, {"oid": "0cbfb068f1807dc23a376ff9d385ce8d1eaccde5", "url": "https://github.com/returntocorp/semgrep/commit/0cbfb068f1807dc23a376ff9d385ce8d1eaccde5", "message": "fixup! tests: add basic perf regression", "committedDate": "2020-08-05T00:42:35Z", "type": "commit"}, {"oid": "66bf13027e860e254025c1ca561b2f76ac26455c", "url": "https://github.com/returntocorp/semgrep/commit/66bf13027e860e254025c1ca561b2f76ac26455c", "message": "fixup! fixup! tests: add basic perf regression", "committedDate": "2020-08-05T21:35:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUwNDY3OQ==", "url": "https://github.com/returntocorp/semgrep/pull/1373#discussion_r466504679", "bodyText": "Instead of testing 3 repositories in one function manually can we instead parametrize the function to take a repo, SHA hash, and expected runtime? This will improve extensibility and allow us to easily test one set of parameters from the command line (via pytest's -k flag). I think xdist will also allow us to parallelize the 3 repositories.", "author": "mschwager", "createdAt": "2020-08-06T15:40:06Z", "path": "semgrep/tests/performance/test_ci_perf.py", "diffHunk": "@@ -1,203 +1,49 @@\n-import pipes\n import subprocess\n-from pathlib import Path\n-from typing import NamedTuple\n+import time\n \n import pytest\n \n-from ..conftest import TESTS_PATH\n \n-EXTENSIONS = {\n-    \"python\": \"py\",\n-    \"go\": \"go\",\n-    \"javascript\": \"js\",\n-}\n-\n-\n-def sloc(path, extension=None):\n-    \"\"\"Quick hack in lieu of installing sloccount\"\"\"\n-    if extension:\n-        extension_pat = f\"-name '*.{extension}'\"\n-    else:\n-        extension_pat = \"\"\n-    t = pipes.Template()\n-    t.prepend(f\"find {path} {extension_pat}\", \".-\")\n-    t.append(\"xargs cat\", \"--\")\n-    t.append(\"wc -l\", \"--\")\n-    f = t.open(\"pipefile\", \"r\")\n-    return int(f.read())\n-\n-\n-def test_sloc():\n-    assert sloc(path=\".\", extension=\"py\") > 0\n-\n-\n-class RepoCase(NamedTuple):\n-    url: str\n-    sha: str\n-    language: str\n-    # used to decouple test runs when we change what the\n-    # test is actually doing for benchmarking\n-    version: str = \"1\"\n-\n-    @property\n-    def test_id(self):\n-        repo_name = self.url.split(\"/\")[-1]\n-        return f\"{repo_name}-v{self.version}\"\n-\n-\n-@pytest.mark.parametrize(\n-    \"repo_case\",\n-    [\n-        # SHAs of May 6, 2020\n-        RepoCase(\n-            \"https://github.com/coinbase/node-process-lock\", \"dd687bc\", \"javascript\"\n-        ),\n-        RepoCase(\"https://github.com/getsentry/sentry\", \"f25ea5dc\", \"python\"),\n-        RepoCase(\n-            \"https://github.com/bkimminich/juice-shop.git\", \"e03629b\", \"javascript\"\n-        ),\n-    ],\n-    ids=lambda case: case.test_id,\n-)\n-def test_default_packs(run_semgrep_in_tmp, clone_github_repo, benchmark, repo_case):\n+@pytest.mark.qa\n+def test_perf(clone_github_repo):", "originalCommit": "66bf13027e860e254025c1ca561b2f76ac26455c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIwNjU0Nw==", "url": "https://github.com/returntocorp/semgrep/pull/1373#discussion_r467206547", "bodyText": "Will make this change", "author": "brendongo", "createdAt": "2020-08-07T18:36:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUwNDY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIzMDQ4Mw==", "url": "https://github.com/returntocorp/semgrep/pull/1373#discussion_r467230483", "bodyText": "Actually this only tests two repositories with a shared rule repo and the repositories are executed differently (cause of --exclude in one of them) and have different expected timeout. So not a lot of shared code. Thoughts on parametrizing if/when we add more cases in the future?", "author": "brendongo", "createdAt": "2020-08-07T19:30:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUwNDY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI1MjQ2NQ==", "url": "https://github.com/returntocorp/semgrep/pull/1373#discussion_r467252465", "bodyText": "Sounds good \ud83d\udc4d", "author": "mschwager", "createdAt": "2020-08-07T20:24:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUwNDY3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUwNTk5OA==", "url": "https://github.com/returntocorp/semgrep/pull/1373#discussion_r466505998", "bodyText": "I think we can remove this whole file, it's only referenced in benchmark.yml.", "author": "mschwager", "createdAt": "2020-08-06T15:41:55Z", "path": "install-scripts/latest-artifact-for-branch.py", "diffHunk": "@@ -100,12 +100,6 @@ def install_semgrep_core(url: str) -> None:\n         sys.exit(1)\n \n \n-def download_benchmarks(url: str, output: str) -> None:", "originalCommit": "66bf13027e860e254025c1ca561b2f76ac26455c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f54c2c246d831d3fafe876fe487a963091f037b0", "url": "https://github.com/returntocorp/semgrep/commit/f54c2c246d831d3fafe876fe487a963091f037b0", "message": "fixup! fixup! fixup! tests: add basic perf regression", "committedDate": "2020-08-06T22:56:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI1MjgzMw==", "url": "https://github.com/returntocorp/semgrep/pull/1373#discussion_r467252833", "bodyText": "Looks like we can remove this whole [pytest] key now.", "author": "mschwager", "createdAt": "2020-08-07T20:25:23Z", "path": "semgrep/tox.ini", "diffHunk": "@@ -11,4 +11,3 @@ setenv =\n     PIPENV_VERBOSITY = -1\n \n [pytest]", "originalCommit": "f54c2c246d831d3fafe876fe487a963091f037b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI1NjI5OQ==", "url": "https://github.com/returntocorp/semgrep/pull/1373#discussion_r467256299", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            [pytest]", "author": "brendongo", "createdAt": "2020-08-07T20:34:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI1MjgzMw=="}], "type": "inlineReview"}, {"oid": "f5fc998b7ee11e123b31ae7582678fd4320e437d", "url": "https://github.com/returntocorp/semgrep/commit/f5fc998b7ee11e123b31ae7582678fd4320e437d", "message": "Update semgrep/tox.ini", "committedDate": "2020-08-07T20:34:08Z", "type": "commit"}]}