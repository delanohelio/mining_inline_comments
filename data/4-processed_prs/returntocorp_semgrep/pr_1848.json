{"pr_number": 1848, "pr_title": "Spacegrep integration in Python layer", "pr_createdAt": "2020-10-16T15:42:01Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/1848", "timeline": [{"oid": "bf2aa3721d13a812b09a18be8fa3774473ae0799", "url": "https://github.com/returntocorp/semgrep/commit/bf2aa3721d13a812b09a18be8fa3774473ae0799", "message": "Added 0.25.0 release date to CHANGELOG", "committedDate": "2020-09-23T18:18:04Z", "type": "commit"}, {"oid": "769a651afe914ff1fd433373abcc92c72a04c86b", "url": "https://github.com/returntocorp/semgrep/commit/769a651afe914ff1fd433373abcc92c72a04c86b", "message": "Merge branch 'develop' of https://github.com/returntocorp/semgrep into develop", "committedDate": "2020-09-29T17:55:11Z", "type": "commit"}, {"oid": "2329e8a5144fff82bec01ffe22d921034c958d7c", "url": "https://github.com/returntocorp/semgrep/commit/2329e8a5144fff82bec01ffe22d921034c958d7c", "message": "Replace 'pack' with 'set' in README", "committedDate": "2020-09-29T18:08:52Z", "type": "commit"}, {"oid": "f4f61a09c250b68f1542f688bb3eaf41eb01287d", "url": "https://github.com/returntocorp/semgrep/commit/f4f61a09c250b68f1542f688bb3eaf41eb01287d", "message": "Merge branch 'develop' of https://github.com/returntocorp/semgrep into develop", "committedDate": "2020-09-30T19:39:28Z", "type": "commit"}, {"oid": "fb49f65075283ec2851cbd92e5caff94307c0f24", "url": "https://github.com/returntocorp/semgrep/commit/fb49f65075283ec2851cbd92e5caff94307c0f24", "message": "Merge", "committedDate": "2020-10-12T17:44:00Z", "type": "commit"}, {"oid": "6a33817b43c9f3607e91cbf93ed3a1fa28c22cad", "url": "https://github.com/returntocorp/semgrep/commit/6a33817b43c9f3607e91cbf93ed3a1fa28c22cad", "message": "Merge branch 'develop' of https://github.com/returntocorp/semgrep into develop", "committedDate": "2020-10-15T15:46:33Z", "type": "commit"}, {"oid": "c450fcbdd9de2cc8919a3cbc88481736765d3cfd", "url": "https://github.com/returntocorp/semgrep/commit/c450fcbdd9de2cc8919a3cbc88481736765d3cfd", "message": "Merge branch 'develop' of https://github.com/returntocorp/semgrep into develop", "committedDate": "2020-10-15T16:29:36Z", "type": "commit"}, {"oid": "44c9647d0d529f76a40f48dde8c0099d932fec2d", "url": "https://github.com/returntocorp/semgrep/commit/44c9647d0d529f76a40f48dde8c0099d932fec2d", "message": "Merge branch 'develop' of https://github.com/returntocorp/semgrep into develop", "committedDate": "2020-10-16T14:30:41Z", "type": "commit"}, {"oid": "24e167ac02488aab7ca448e11482581bf4fcc937", "url": "https://github.com/returntocorp/semgrep/commit/24e167ac02488aab7ca448e11482581bf4fcc937", "message": "wip: integrate spacegrep command", "committedDate": "2020-10-16T15:42:21Z", "type": "commit"}, {"oid": "d51e46ad1406b350a8e658ab3f1eff443af41eee", "url": "https://github.com/returntocorp/semgrep/commit/d51e46ad1406b350a8e658ab3f1eff443af41eee", "message": "add self", "committedDate": "2020-10-16T15:42:21Z", "type": "commit"}, {"oid": "a96eb0c5f3bc35e3f279e0a38a3a1d677f6a9759", "url": "https://github.com/returntocorp/semgrep/commit/a96eb0c5f3bc35e3f279e0a38a3a1d677f6a9759", "message": "spacegrep is invoked now", "committedDate": "2020-10-16T15:42:21Z", "type": "commit"}, {"oid": "cabe8288058f2de75eca1b47416d510ea45f887e", "url": "https://github.com/returntocorp/semgrep/commit/cabe8288058f2de75eca1b47416d510ea45f887e", "message": "Add 'generic' to languages", "committedDate": "2020-10-16T15:42:21Z", "type": "commit"}, {"oid": "a320e41bb48da76c5c55c429ae1126545eac2f89", "url": "https://github.com/returntocorp/semgrep/commit/a320e41bb48da76c5c55c429ae1126545eac2f89", "message": "Working spacegrep implementation, assuming spacegrep is on PATH. Refactored spacegrep integration code into spacegrep.py", "committedDate": "2020-10-16T15:42:21Z", "type": "commit"}, {"oid": "15dcaf999e285879558e6285399d6ace8d31a585", "url": "https://github.com/returntocorp/semgrep/commit/15dcaf999e285879558e6285399d6ace8d31a585", "message": "Support rule file compositions", "committedDate": "2020-10-16T15:42:21Z", "type": "commit"}, {"oid": "2779e1411477147bccab6accc1c45ce810f4e748", "url": "https://github.com/returntocorp/semgrep/commit/2779e1411477147bccab6accc1c45ce810f4e748", "message": "Add tests for spacegrep", "committedDate": "2020-10-16T15:42:21Z", "type": "commit"}, {"oid": "3230ddd500a616e168c4cb5dede88ad72e0a09c8", "url": "https://github.com/returntocorp/semgrep/commit/3230ddd500a616e168c4cb5dede88ad72e0a09c8", "message": "Fix offset issue by using bol from spacegrep instead of cnum", "committedDate": "2020-10-16T15:42:21Z", "type": "commit"}, {"oid": "85192acd131ab14d90c6e2c6bd099681ffbf517a", "url": "https://github.com/returntocorp/semgrep/commit/85192acd131ab14d90c6e2c6bd099681ffbf517a", "message": "Add new test for spacegrep using raw HTTP response for funsies", "committedDate": "2020-10-16T15:42:21Z", "type": "commit"}, {"oid": "4fedf0277198505571dc8a9dfe85aadc857de79f", "url": "https://github.com/returntocorp/semgrep/commit/4fedf0277198505571dc8a9dfe85aadc857de79f", "message": "Find spacegrep binary on system rather than hardcode it; use new spacegrep output JSON format; patch in correct offsets, to be fixed in the future", "committedDate": "2020-10-16T15:42:21Z", "type": "commit"}, {"oid": "4fedf0277198505571dc8a9dfe85aadc857de79f", "url": "https://github.com/returntocorp/semgrep/commit/4fedf0277198505571dc8a9dfe85aadc857de79f", "message": "Find spacegrep binary on system rather than hardcode it; use new spacegrep output JSON format; patch in correct offsets, to be fixed in the future", "committedDate": "2020-10-16T15:42:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYwMjk2Nw==", "url": "https://github.com/returntocorp/semgrep/pull/1848#discussion_r506602967", "bodyText": "ok, I'll look into this. I specifically added 1 here and there before exporting to json because a comment I found in the ocaml code said so.", "author": "mjambon", "createdAt": "2020-10-16T16:57:23Z", "path": "semgrep/semgrep/spacegrep.py", "diffHunk": "@@ -0,0 +1,93 @@\n+import json\n+import logging\n+import re\n+import subprocess\n+from pathlib import Path\n+from typing import Any\n+from typing import cast\n+from typing import Dict\n+from typing import List\n+from typing import Optional\n+\n+logger = logging.getLogger(__name__)\n+\n+from semgrep.constants import PLEASE_FILE_ISSUE_TEXT\n+from semgrep.constants import SPACEGREP_PATH\n+from semgrep.core_exception import CoreException\n+from semgrep.error import InvalidPatternError\n+from semgrep.pattern import Pattern\n+from semgrep.pattern_match import PatternMatch\n+from semgrep.util import sub_run\n+\n+\n+def run_spacegrep(patterns: List[Pattern], targets: List[Path]) -> dict:\n+    matches: List[dict] = []\n+    errors: List[dict] = []\n+    for pattern in patterns:\n+        if not isinstance(pattern._pattern, str):\n+            raise NotImplementedError(\n+                f\"Support for {type(pattern._pattern)} has not been implemented yet.\"\n+            )\n+        pattern_str = pattern._pattern  # TODO: Handle pattern Dict\n+        for target in targets:\n+            cmd = [\n+                SPACEGREP_PATH,\n+                \"--output-format\",\n+                \"semgrep\",\n+                \"-d\",\n+                str(target),\n+                pattern_str,\n+            ]\n+            p = sub_run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)\n+            raw_output = p.stdout\n+            raw_error = p.stderr\n+\n+            output_json = _parse_spacegrep_output(raw_output)\n+            output_json[\"matches\"] = _patch_id(pattern, output_json.get(\"matches\", []))\n+            output_json[\"matches\"] = _patch_lines(output_json.get(\"matches\", []))\n+\n+            matches.extend(output_json[\"matches\"])\n+            errors.extend(output_json[\"errors\"])\n+\n+    return {\n+        \"matches\": matches,\n+        \"errors\": errors,\n+    }\n+\n+\n+def _parse_spacegrep_output(raw_output: bytes) -> dict:\n+    try:\n+        output = raw_output.decode(\"utf-8\")\n+        data = json.loads(output)\n+        return cast(dict, data)\n+    except Exception:\n+        logger.error(\"spacegrep output could not be parsed as JSON.\")\n+        return {}\n+\n+\n+def _patch_id(pattern: Pattern, matches: List[dict]) -> List[dict]:\n+    patched = []\n+    for match in matches:\n+        match[\"check_id\"] = pattern._id\n+        patched.append(match)\n+    return patched\n+\n+\n+def _patch_lines(matches: List[dict]) -> List[dict]:\n+    patched = []\n+    for match in matches:\n+        with open(match[\"path\"], \"r\") as fin:\n+            data = fin.readlines()\n+        start_l = match.get(\"start\", {}).get(\"line\", 0)\n+        start_c = match.get(\"start\", {}).get(\"col\", 0)\n+        end_l = match.get(\"end\", {}).get(\"line\", 0)\n+        end_c = match.get(\"end\", {}).get(\"col\", 0)\n+\n+        lines = data[start_l - 2 : end_l - 1]\n+        lines[0] = lines[0][start_c - 1 :]\n+        lines[-1] = lines[-1][: end_c - 1]", "originalCommit": "4fedf0277198505571dc8a9dfe85aadc857de79f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "366e9ae325fcebf4341484cacbab2911a8776d6a", "url": "https://github.com/returntocorp/semgrep/commit/366e9ae325fcebf4341484cacbab2911a8776d6a", "message": "Update test snapshots", "committedDate": "2020-10-16T17:13:42Z", "type": "commit"}, {"oid": "e9be6190338099bc3a01e0432a1c188e84a7b9b4", "url": "https://github.com/returntocorp/semgrep/commit/e9be6190338099bc3a01e0432a1c188e84a7b9b4", "message": "WIP Trying to fix spacegrep problems in CI (#1854)\n\nAdd missing option for static linking spacegrep in CI.", "committedDate": "2020-10-17T02:34:25Z", "type": "commit"}, {"oid": "4a31dd35dd7ccd9b133f961181852070b408e62c", "url": "https://github.com/returntocorp/semgrep/commit/4a31dd35dd7ccd9b133f961181852070b408e62c", "message": "Fix permissions on osx artifacts", "committedDate": "2020-10-17T03:28:12Z", "type": "commit"}, {"oid": "596654e0142b51600e7a1cb33fb23086fbf2d7e5", "url": "https://github.com/returntocorp/semgrep/commit/596654e0142b51600e7a1cb33fb23086fbf2d7e5", "message": "Fix location bug and missing metavariable '$' in spacegrep's json output (#1853)\n\n* Fix location bug and missing metavariable '$' in spacegrep's json output\r\n\r\n* Clarify documentation about locations\r\n\r\n* Fix documentation\r\n\r\n* Remove compatibility crutch\r\n\r\n* Tentatively fix off-by-one line numbering\r\n\r\n* Update test snapshots\r\n\r\n* Update test snapshots.... again\r\n\r\nCo-authored-by: Martin Jambon <Martin Jambon>\r\nCo-authored-by: grayson <grayson@returntocorp.com>", "committedDate": "2020-10-19T21:32:00Z", "type": "commit"}, {"oid": "d3bb65148286fed464d4738c3decaee57ef49d9d", "url": "https://github.com/returntocorp/semgrep/commit/d3bb65148286fed464d4738c3decaee57ef49d9d", "message": "See what happens when we don't copy executables to /usr/bin", "committedDate": "2020-10-20T04:41:30Z", "type": "commit"}, {"oid": "b6079ad47b2e568772a62fcc4a278340c71ba6fe", "url": "https://github.com/returntocorp/semgrep/commit/b6079ad47b2e568772a62fcc4a278340c71ba6fe", "message": "Fail early if semgrep-core doesn't exist. Same thing for spacegrep.", "committedDate": "2020-10-21T00:26:23Z", "type": "commit"}, {"oid": "daea78d405c3335bb63842775e2397af44b96e85", "url": "https://github.com/returntocorp/semgrep/commit/daea78d405c3335bb63842775e2397af44b96e85", "message": "Re-enable install into /usr/bin for testing", "committedDate": "2020-10-21T02:03:50Z", "type": "commit"}, {"oid": "e6ee8881b88ed63fcae78658bc86fb918f96d0cc", "url": "https://github.com/returntocorp/semgrep/commit/e6ee8881b88ed63fcae78658bc86fb918f96d0cc", "message": "Copy spacegrep and spacecat into the wheel package", "committedDate": "2020-10-21T02:04:49Z", "type": "commit"}, {"oid": "8f415e8fa7792c579e9f30e3d2677c29013a2d77", "url": "https://github.com/returntocorp/semgrep/commit/8f415e8fa7792c579e9f30e3d2677c29013a2d77", "message": "Remove space before newline in expected test output.", "committedDate": "2020-10-21T03:15:35Z", "type": "commit"}, {"oid": "69f3e489eced02a96fad7e11cc7e70c40bd8423f", "url": "https://github.com/returntocorp/semgrep/commit/69f3e489eced02a96fad7e11cc7e70c40bd8423f", "message": "Remove trailing newline from expected output (introduced by accident by\nwell-intended text editor)", "committedDate": "2020-10-21T04:07:41Z", "type": "commit"}]}