{"pr_number": 249, "pr_title": "Feature/generic import matching", "pr_createdAt": "2020-03-04T23:46:36Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/249", "timeline": [{"oid": "9f1cb7de4c37167dd479b7cedc56387a5293d961", "url": "https://github.com/returntocorp/semgrep/commit/9f1cb7de4c37167dd479b7cedc56387a5293d961", "message": "add imports.py and a python ast.parse test", "committedDate": "2020-03-03T18:25:02Z", "type": "commit"}, {"oid": "8ac49e6638e6f7b9dc8b5280fefd7a02e4ab1243", "url": "https://github.com/returntocorp/semgrep/commit/8ac49e6638e6f7b9dc8b5280fefd7a02e4ab1243", "message": "revert ocaml code that accidently got committed", "committedDate": "2020-03-03T18:29:57Z", "type": "commit"}, {"oid": "552e8df8b8d37903143912836114ac2d816b87d8", "url": "https://github.com/returntocorp/semgrep/commit/552e8df8b8d37903143912836114ac2d816b87d8", "message": "some tests passing", "committedDate": "2020-03-03T18:47:18Z", "type": "commit"}, {"oid": "8d78b77f0c325e56a85715efbf91071253fc83f4", "url": "https://github.com/returntocorp/semgrep/commit/8d78b77f0c325e56a85715efbf91071253fc83f4", "message": "handle aliases", "committedDate": "2020-03-03T18:53:25Z", "type": "commit"}, {"oid": "00fee171191faf065048207bdee8b7a57f11a520", "url": "https://github.com/returntocorp/semgrep/commit/00fee171191faf065048207bdee8b7a57f11a520", "message": "add negative test cases", "committedDate": "2020-03-03T19:08:29Z", "type": "commit"}, {"oid": "9529013c9e3b817df11ad33067ae9ebca07ad6d3", "url": "https://github.com/returntocorp/semgrep/commit/9529013c9e3b817df11ad33067ae9ebca07ad6d3", "message": "step one: equivalent ImportFrom, ImportAs, ImportAll", "committedDate": "2020-03-03T19:59:32Z", "type": "commit"}, {"oid": "c3118cc8594d5cfae35d31cb137e0a0290e63eba", "url": "https://github.com/returntocorp/semgrep/commit/c3118cc8594d5cfae35d31cb137e0a0290e63eba", "message": "use for import *", "committedDate": "2020-03-03T20:01:54Z", "type": "commit"}, {"oid": "254dc1990e72e44b9148947f37ff3856d627a57f", "url": "https://github.com/returntocorp/semgrep/commit/254dc1990e72e44b9148947f37ff3856d627a57f", "message": "document todos", "committedDate": "2020-03-03T20:06:07Z", "type": "commit"}, {"oid": "ca9bf72c5b74a5ca2c3402ab49318ea0a625e4a7", "url": "https://github.com/returntocorp/semgrep/commit/ca9bf72c5b74a5ca2c3402ab49318ea0a625e4a7", "message": "add in subset matching", "committedDate": "2020-03-04T21:33:19Z", "type": "commit"}, {"oid": "b2c4a6785453647e8b351b22b592742d5562b34e", "url": "https://github.com/returntocorp/semgrep/commit/b2c4a6785453647e8b351b22b592742d5562b34e", "message": "Merge branch 'develop' into feature/generic-import-matching", "committedDate": "2020-03-04T23:46:04Z", "type": "commit"}, {"oid": "fc961e82713493604aad5d8f98067fcef1500be8", "url": "https://github.com/returntocorp/semgrep/commit/fc961e82713493604aad5d8f98067fcef1500be8", "message": "javascript test cases", "committedDate": "2020-03-04T23:49:10Z", "type": "commit"}, {"oid": "392b4a38a3b42fa81db1a1d89577dc9308eaa151", "url": "https://github.com/returntocorp/semgrep/commit/392b4a38a3b42fa81db1a1d89577dc9308eaa151", "message": "add tests for go", "committedDate": "2020-03-05T00:13:16Z", "type": "commit"}, {"oid": "f28219290125b0877efac4213262233e0d82ce35", "url": "https://github.com/returntocorp/semgrep/commit/f28219290125b0877efac4213262233e0d82ce35", "message": "failing import tests for golang", "committedDate": "2020-03-05T00:16:13Z", "type": "commit"}, {"oid": "65b45c16d1e57d19eb2cc9fd493645105d158003", "url": "https://github.com/returntocorp/semgrep/commit/65b45c16d1e57d19eb2cc9fd493645105d158003", "message": "blacken", "committedDate": "2020-03-05T00:41:20Z", "type": "commit"}, {"oid": "caf629ecee8f272fe4a2f9a3fcdd3ed5dabef540", "url": "https://github.com/returntocorp/semgrep/commit/caf629ecee8f272fe4a2f9a3fcdd3ed5dabef540", "message": "broken", "committedDate": "2020-03-05T19:09:12Z", "type": "commit"}, {"oid": "72d288d980014b14b0ef0d830056d3be6bb2f8dc", "url": "https://github.com/returntocorp/semgrep/commit/72d288d980014b14b0ef0d830056d3be6bb2f8dc", "message": "compiles", "committedDate": "2020-03-05T19:09:12Z", "type": "commit"}, {"oid": "5ad5aa315665af1acf4c9f60114ea468849f1025", "url": "https://github.com/returntocorp/semgrep/commit/5ad5aa315665af1acf4c9f60114ea468849f1025", "message": "share w Drew", "committedDate": "2020-03-05T19:09:12Z", "type": "commit"}, {"oid": "7bdd8bfcfea725924ff60d05e25349f81863b17c", "url": "https://github.com/returntocorp/semgrep/commit/7bdd8bfcfea725924ff60d05e25349f81863b17c", "message": "perfix matching working", "committedDate": "2020-03-05T19:09:12Z", "type": "commit"}, {"oid": "c52bd4d198cefdf51bfcebb4db5b9c1d6a913b88", "url": "https://github.com/returntocorp/semgrep/commit/c52bd4d198cefdf51bfcebb4db5b9c1d6a913b88", "message": "golang tests working", "committedDate": "2020-03-05T19:09:13Z", "type": "commit"}, {"oid": "edda59dbcec92c0778a820b27f76433f7605def7", "url": "https://github.com/returntocorp/semgrep/commit/edda59dbcec92c0778a820b27f76433f7605def7", "message": "missing javascript parser", "committedDate": "2020-03-05T19:09:13Z", "type": "commit"}, {"oid": "20024d08c663c860caac8cf2f26f079bd00cd0bc", "url": "https://github.com/returntocorp/semgrep/commit/20024d08c663c860caac8cf2f26f079bd00cd0bc", "message": "javascript tests TODO", "committedDate": "2020-03-05T19:09:50Z", "type": "commit"}, {"oid": "6e0bf3dc46c337183e67c88ccd4e0ab39d6842a7", "url": "https://github.com/returntocorp/semgrep/commit/6e0bf3dc46c337183e67c88ccd4e0ab39d6842a7", "message": "update new shape of ImportFrom (see pfff b888e5)", "committedDate": "2020-03-05T19:29:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc5MDA0NA==", "url": "https://github.com/returntocorp/semgrep/pull/249#discussion_r388790044", "bodyText": "not sure what this has to do with this PR. Because of some rebasing stuff?", "author": "aryx", "createdAt": "2020-03-06T09:17:13Z", "path": "bin/main_sgrep.ml", "diffHunk": "@@ -57,6 +57,7 @@ let lang = ref \"unset\"\n \n let case_sensitive = ref false\n let match_format = ref Matching_report.Normal\n+let r2c = ref false", "originalCommit": "6e0bf3dc46c337183e67c88ccd4e0ab39d6842a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc5MDgzOA==", "url": "https://github.com/returntocorp/semgrep/pull/249#discussion_r388790838", "bodyText": "This will not work. The <= OCaml operator does not do what you think.\nIf you use Common2.set, then you should use Common2.include_set, or you should use commons/set_.mli which is a defunctorized version simpler to use than the set.ml in the ocaml standard library.", "author": "aryx", "createdAt": "2020-03-06T09:18:56Z", "path": "lib/generic_vs_generic.ml", "diffHunk": "@@ -305,6 +305,15 @@ let rec m_list f a b =\n   | _::_, _ ->\n       fail ()\n \n+let m_list_subset a b =\n+  (* match if a is a subset of b *)\n+  let set_a = Common2.set a in\n+  let set_b = Common2.set b in\n+  if set_a <= set_b then", "originalCommit": "6e0bf3dc46c337183e67c88ccd4e0ab39d6842a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc5MTY1MA==", "url": "https://github.com/returntocorp/semgrep/pull/249#discussion_r388791650", "bodyText": "Actually it's never used in the file, so you should remove this dead code. Actually the OCaml compiler warns against such deadcode when you have a function not used in the file if it's not exported (but I forgot to define a generic_vs_generic.mli file, so it's on me).", "author": "aryx", "createdAt": "2020-03-06T09:20:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc5MDgzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc5MjUyMg==", "url": "https://github.com/returntocorp/semgrep/pull/249#discussion_r388792522", "bodyText": "maybe a little comment here before this case like (* a prefix is ok *)", "author": "aryx", "createdAt": "2020-03-06T09:22:26Z", "path": "lib/generic_vs_generic.ml", "diffHunk": "@@ -370,10 +390,44 @@ let m_dotted_name a b =\n   (* TODO: [$X] should match any list *)\n   (a, b) -> (m_list m_ident) a b\n \n+\n+let rec m_list_prefix f a b =\n+  match a, b with\n+  | [], [] ->\n+      return ()\n+  | xa::aas, xb::bbs ->\n+      f xa xb >>= (fun () ->\n+      m_list_prefix f aas bbs >>= (fun () ->\n+        return ()\n+      )\n+      )\n+  | [], _ -> return ()", "originalCommit": "6e0bf3dc46c337183e67c88ccd4e0ab39d6842a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwNTIzMg==", "url": "https://github.com/returntocorp/semgrep/pull/249#discussion_r388805232", "bodyText": "This is not an Ast_generic.label. This is conceptually restricted to labels as in 'goto foo' foo:.\nMaybe vscode told you it was that because most IDEs don't know how to handle typedefs.", "author": "aryx", "createdAt": "2020-03-06T09:47:00Z", "path": "lib/generic_vs_generic.ml", "diffHunk": "@@ -1936,23 +1990,64 @@ and m_macro_definition a b =\n (* Directives (Module import/export, macros) *)\n (* ------------------------------------------------------------------------- *)\n \n+\n+(* normalize from:\n+    from foo import bar -> import foo.bar\n+    from foo.bar import baz -> import foo.bar.baz\n+    from foo.bar.baz import yoo -> import foo.bar.baz.yoo\n+\n+    TODO: we plan to refactor ImportFrom such that it has at most one identifier; this function assumes that has already happened\n+*)\n+and normalize_import_as (a0: Parse_info.token_mutable) (from_module_name: Ast_generic.module_name) (import_opt: Ast_generic.alias option) = \n+  match from_module_name with \n+  | Ast_generic.DottedName idents -> \n+    begin\n+    match import_opt with \n+    | Some(import) ->\n+      let (import_ident_name: Ast_generic.label), _ = import in", "originalCommit": "6e0bf3dc46c337183e67c88ccd4e0ab39d6842a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwNTg0Mw==", "url": "https://github.com/returntocorp/semgrep/pull/249#discussion_r388805843", "bodyText": "ImportFrom should never have a None; You put an alias option in ast_generic.ml but this is wrong.\nIf you need a normalized form that is sgrep specific, create one in this file and do the matching on that.", "author": "aryx", "createdAt": "2020-03-06T09:48:11Z", "path": "lib/generic_vs_generic.ml", "diffHunk": "@@ -1936,23 +1990,64 @@ and m_macro_definition a b =\n (* Directives (Module import/export, macros) *)\n (* ------------------------------------------------------------------------- *)\n \n+\n+(* normalize from:\n+    from foo import bar -> import foo.bar\n+    from foo.bar import baz -> import foo.bar.baz\n+    from foo.bar.baz import yoo -> import foo.bar.baz.yoo\n+\n+    TODO: we plan to refactor ImportFrom such that it has at most one identifier; this function assumes that has already happened\n+*)\n+and normalize_import_as (a0: Parse_info.token_mutable) (from_module_name: Ast_generic.module_name) (import_opt: Ast_generic.alias option) = \n+  match from_module_name with \n+  | Ast_generic.DottedName idents -> \n+    begin\n+    match import_opt with \n+    | Some(import) ->\n+      let (import_ident_name: Ast_generic.label), _ = import in\n+      let new_module_name: Ast_generic.dotted_ident = idents @ [import_ident_name] in \n+        A.ImportFrom(a0, Ast_generic.DottedName new_module_name, None)", "originalCommit": "6e0bf3dc46c337183e67c88ccd4e0ab39d6842a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwODU3NA==", "url": "https://github.com/returntocorp/semgrep/pull/249#discussion_r388808574", "bodyText": "So this is now deadcode since you call normalize before.\nThis is not what we should do, because now you've prevented people to match on specific import constructs.\nFor example how do you detect bad code using 'from x import *' that people may want to search specifically for.\n/home/pad/github/sgrep/sgrep/_build/default/bin/main_sgrep.exe -lang python -e from foo import * tests/python/\n/home/pad/github/sgrep/sgrep/tests/python/import_negatives.py:2\nimport foo.bar.baz\nWe don't want that.\nInstead what we should do is we should try to match with the specific stuff first, and if it does not match, then we can try some normalization, but only if people use the very general 'import foo'.\nOnly 'import foo' should be allowed to match the more complex one (what I call less-is-more, that is it's ok to specifiy less information in the pattern, here no aliasing, and no '*', but we should still enable people when they want to be precise to match precisely what they want).", "author": "aryx", "createdAt": "2020-03-06T09:53:19Z", "path": "lib/generic_vs_generic.ml", "diffHunk": "@@ -1936,23 +1990,64 @@ and m_macro_definition a b =\n (* Directives (Module import/export, macros) *)\n (* ------------------------------------------------------------------------- *)\n \n+\n+(* normalize from:\n+    from foo import bar -> import foo.bar\n+    from foo.bar import baz -> import foo.bar.baz\n+    from foo.bar.baz import yoo -> import foo.bar.baz.yoo\n+\n+    TODO: we plan to refactor ImportFrom such that it has at most one identifier; this function assumes that has already happened\n+*)\n+and normalize_import_as (a0: Parse_info.token_mutable) (from_module_name: Ast_generic.module_name) (import_opt: Ast_generic.alias option) = \n+  match from_module_name with \n+  | Ast_generic.DottedName idents -> \n+    begin\n+    match import_opt with \n+    | Some(import) ->\n+      let (import_ident_name: Ast_generic.label), _ = import in\n+      let new_module_name: Ast_generic.dotted_ident = idents @ [import_ident_name] in \n+        A.ImportFrom(a0, Ast_generic.DottedName new_module_name, None)\n+    | None -> A.ImportFrom(a0, from_module_name, None)\n+  end;  \n+  | Ast_generic.FileName _ -> (* TODO *)\n+    A.ImportFrom(a0, from_module_name, import_opt)\n+\n+and strip_aliases (aliases: Ast_generic.alias list) = List.map (fun (ident, _) -> ident) aliases\n+\n+(* \n+  a function that will take ImportFrom, ImportAs, ImportAll -> normalized \n+  ImportFrom for matching `import` purposes\n+*)\n+and normalize_import i =\n+  match i with\n+  | A.ImportFrom(a0, from_module_name, import) -> normalize_import_as a0 from_module_name import\n+  | A.ImportAs(a0, a1, _) -> normalize_import_as a0 a1 None\n+  | A.ImportAll(a0, a1, _) -> normalize_import_as a0 a1 None\n+  | _ -> i\n+\n and m_directive a b = \n-  match a, b with\n-  | A.ImportFrom(a0, a1, a2), B.ImportFrom(b0, b1, b2) ->\n+  let normal_a = normalize_import a in\n+  let normal_b = normalize_import b in\n+  (*\n+    pr2 (spf \"A = %s\" (str_of_any (Dir normal_a)));\n+    pr2 (spf \"B = %s\" (str_of_any (Dir normal_b)));\n+  *)\n+  (* a is the pattern, b is the target*)\n+  match normal_a, normal_b with\n+  | A.ImportFrom(a0, a1, _), B.ImportFrom(b0, b1, _) ->\n     m_tok a0 b0 >>= (fun () ->\n-    m_module_name a1 b1 >>= (fun () -> \n-    (m_list m_alias) a2 b2 >>= (fun () -> \n-    return ()\n-    )))\n+    m_module_name_prefix a1 b1 >>= (fun () -> \n+    return()\n+    ))\n   | A.ImportAs(a0, a1, a2), B.ImportAs(b0, b1, b2) ->", "originalCommit": "6e0bf3dc46c337183e67c88ccd4e0ab39d6842a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwOTA0Nw==", "url": "https://github.com/returntocorp/semgrep/pull/249#discussion_r388809047", "bodyText": "this is deadcode too now.", "author": "aryx", "createdAt": "2020-03-06T09:54:07Z", "path": "lib/generic_vs_generic.ml", "diffHunk": "@@ -1936,23 +1990,64 @@ and m_macro_definition a b =\n (* Directives (Module import/export, macros) *)\n (* ------------------------------------------------------------------------- *)\n \n+\n+(* normalize from:\n+    from foo import bar -> import foo.bar\n+    from foo.bar import baz -> import foo.bar.baz\n+    from foo.bar.baz import yoo -> import foo.bar.baz.yoo\n+\n+    TODO: we plan to refactor ImportFrom such that it has at most one identifier; this function assumes that has already happened\n+*)\n+and normalize_import_as (a0: Parse_info.token_mutable) (from_module_name: Ast_generic.module_name) (import_opt: Ast_generic.alias option) = \n+  match from_module_name with \n+  | Ast_generic.DottedName idents -> \n+    begin\n+    match import_opt with \n+    | Some(import) ->\n+      let (import_ident_name: Ast_generic.label), _ = import in\n+      let new_module_name: Ast_generic.dotted_ident = idents @ [import_ident_name] in \n+        A.ImportFrom(a0, Ast_generic.DottedName new_module_name, None)\n+    | None -> A.ImportFrom(a0, from_module_name, None)\n+  end;  \n+  | Ast_generic.FileName _ -> (* TODO *)\n+    A.ImportFrom(a0, from_module_name, import_opt)\n+\n+and strip_aliases (aliases: Ast_generic.alias list) = List.map (fun (ident, _) -> ident) aliases\n+\n+(* \n+  a function that will take ImportFrom, ImportAs, ImportAll -> normalized \n+  ImportFrom for matching `import` purposes\n+*)\n+and normalize_import i =\n+  match i with\n+  | A.ImportFrom(a0, from_module_name, import) -> normalize_import_as a0 from_module_name import\n+  | A.ImportAs(a0, a1, _) -> normalize_import_as a0 a1 None\n+  | A.ImportAll(a0, a1, _) -> normalize_import_as a0 a1 None\n+  | _ -> i\n+\n and m_directive a b = \n-  match a, b with\n-  | A.ImportFrom(a0, a1, a2), B.ImportFrom(b0, b1, b2) ->\n+  let normal_a = normalize_import a in\n+  let normal_b = normalize_import b in\n+  (*\n+    pr2 (spf \"A = %s\" (str_of_any (Dir normal_a)));\n+    pr2 (spf \"B = %s\" (str_of_any (Dir normal_b)));\n+  *)\n+  (* a is the pattern, b is the target*)\n+  match normal_a, normal_b with\n+  | A.ImportFrom(a0, a1, _), B.ImportFrom(b0, b1, _) ->\n     m_tok a0 b0 >>= (fun () ->\n-    m_module_name a1 b1 >>= (fun () -> \n-    (m_list m_alias) a2 b2 >>= (fun () -> \n-    return ()\n-    )))\n+    m_module_name_prefix a1 b1 >>= (fun () -> \n+    return()\n+    ))\n   | A.ImportAs(a0, a1, a2), B.ImportAs(b0, b1, b2) ->\n     m_tok a0 b0 >>= (fun () ->\n-    m_module_name a1 b1 >>= (fun () -> \n+    m_module_name_prefix a1 b1 >>= (fun () -> \n     (m_option m_ident) a2 b2 >>= (fun () -> \n     return ()\n     )))\n   | A.ImportAll(a0, a1, a2), B.ImportAll(b0, b1, b2) ->", "originalCommit": "6e0bf3dc46c337183e67c88ccd4e0ab39d6842a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwOTI5MA==", "url": "https://github.com/returntocorp/semgrep/pull/249#discussion_r388809290", "bodyText": "What is this script for?\nMaybe a small comment at the top explaining its usage and a trace example of its use?", "author": "aryx", "createdAt": "2020-03-06T09:54:40Z", "path": "scripts/import_parser_python_ast.py", "diffHunk": "@@ -0,0 +1,14 @@\n+import ast", "originalCommit": "6e0bf3dc46c337183e67c88ccd4e0ab39d6842a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwOTg3Nw==", "url": "https://github.com/returntocorp/semgrep/pull/249#discussion_r388809877", "bodyText": "The file should be renamed less_imports.sgrep, because it fits in the 'less-is-ok' big principle of sgrep (see the README.md and its Design section). I'm opened to a better name than 'less-is-ok'.", "author": "aryx", "createdAt": "2020-03-06T09:55:47Z", "path": "tests/go/imports.sgrep", "diffHunk": "@@ -0,0 +1 @@\n+import \"foo/bar\"", "originalCommit": "6e0bf3dc46c337183e67c88ccd4e0ab39d6842a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgxMjg4OQ==", "url": "https://github.com/returntocorp/semgrep/pull/249#discussion_r388812889", "bodyText": "should be renamed too less_imports_prefix.sgrep", "author": "aryx", "createdAt": "2020-03-06T10:01:32Z", "path": "tests/go/imports_prefix.sgrep", "diffHunk": "@@ -0,0 +1 @@\n+import \"foo\"", "originalCommit": "6e0bf3dc46c337183e67c88ccd4e0ab39d6842a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}