{"pr_number": 1845, "pr_title": "Make spacegrep export json for semgrep", "pr_createdAt": "2020-10-16T01:26:57Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/1845", "timeline": [{"oid": "cb6a1fb6e478d2c0f6540b80d21fa387ee1b17ea", "url": "https://github.com/returntocorp/semgrep/commit/cb6a1fb6e478d2c0f6540b80d21fa387ee1b17ea", "message": "Add atd interface to export matches in json for semgrep", "committedDate": "2020-10-15T06:32:10Z", "type": "commit"}, {"oid": "95cab0f70b5c7f00ea2b8c9974ac98b941acbb6a", "url": "https://github.com/returntocorp/semgrep/commit/95cab0f70b5c7f00ea2b8c9974ac98b941acbb6a", "message": "Add '--output-format semgrep' option to spacegrep, producing json output", "committedDate": "2020-10-16T01:01:23Z", "type": "commit"}, {"oid": "6da262af29a6ddb719a0fb5bc10dbd91f6f75e11", "url": "https://github.com/returntocorp/semgrep/commit/6da262af29a6ddb719a0fb5bc10dbd91f6f75e11", "message": "Fix pfff submodule", "committedDate": "2020-10-16T01:20:00Z", "type": "commit"}, {"oid": "c276b821e285c27f3e10cd2eb769c02958b5c7f1", "url": "https://github.com/returntocorp/semgrep/commit/c276b821e285c27f3e10cd2eb769c02958b5c7f1", "message": "Merge remote-tracking branch 'origin/develop' into spacejson", "committedDate": "2020-10-16T01:21:03Z", "type": "commit"}, {"oid": "43ef4e341700508b2fa2d0bc10ad44e3644ee6de", "url": "https://github.com/returntocorp/semgrep/commit/43ef4e341700508b2fa2d0bc10ad44e3644ee6de", "message": "Fix 'offset' field in json locations", "committedDate": "2020-10-16T01:30:13Z", "type": "commit"}, {"oid": "833fec2f64b0e958603288c5ae35041a8716cca3", "url": "https://github.com/returntocorp/semgrep/commit/833fec2f64b0e958603288c5ae35041a8716cca3", "message": "Add spacegrep tests to CI", "committedDate": "2020-10-16T01:56:30Z", "type": "commit"}, {"oid": "01f37e6d4267147b9624fd5e72da605c50c9484d", "url": "https://github.com/returntocorp/semgrep/commit/01f37e6d4267147b9624fd5e72da605c50c9484d", "message": "Fix command for testing spacegrep", "committedDate": "2020-10-16T02:09:49Z", "type": "commit"}, {"oid": "0441f342a9a157718db11e5df8c9f2c81f9a1c99", "url": "https://github.com/returntocorp/semgrep/commit/0441f342a9a157718db11e5df8c9f2c81f9a1c99", "message": "Fix spacegrep test command", "committedDate": "2020-10-16T02:22:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjExOTM3NQ==", "url": "https://github.com/returntocorp/semgrep/pull/1845#discussion_r506119375", "bodyText": "Type definitions for JSON communication with the semgrep Python wrapper.", "author": "aryx", "createdAt": "2020-10-16T07:26:02Z", "path": "spacegrep/src/lib/Semgrep.atd", "diffHunk": "@@ -0,0 +1,71 @@\n+(*\n+   Type definitions for json communication with semgrep.", "originalCommit": "0441f342a9a157718db11e5df8c9f2c81f9a1c99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjEyMDI1OQ==", "url": "https://github.com/returntocorp/semgrep/pull/1845#discussion_r506120259", "bodyText": "Nice!\nI should probably use it in semgrep-core too now that they are in the same repo :)", "author": "aryx", "createdAt": "2020-10-16T07:26:43Z", "path": "spacegrep/src/lib/Semgrep.atd", "diffHunk": "@@ -0,0 +1,71 @@\n+(*\n+   Type definitions for json communication with semgrep.\n+\n+   Inferred from JSON_report.ml in semgrep-core.\n+*)\n+\n+type match_results = {", "originalCommit": "0441f342a9a157718db11e5df8c9f2c81f9a1c99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjEyMTE4MQ==", "url": "https://github.com/returntocorp/semgrep/pull/1845#discussion_r506121181", "bodyText": "it's actually in pfff/h_program-lang/R2c.ml", "author": "aryx", "createdAt": "2020-10-16T07:27:48Z", "path": "spacegrep/src/lib/Semgrep.atd", "diffHunk": "@@ -0,0 +1,71 @@\n+(*\n+   Type definitions for json communication with semgrep.\n+\n+   Inferred from JSON_report.ml in semgrep-core.\n+*)\n+\n+type match_results = {\n+  matches: match_ list;\n+  errors: error list;\n+  stats: stats;\n+}\n+\n+type stats = {\n+  okfiles: int;\n+  errorfiles: int;\n+}\n+\n+type match_ = {\n+  ?check_id: string option; (* rule ID *)\n+  path: string; (* source file *)\n+  start: position;\n+  end_ <json name=\"end\">: position;\n+  extra: match_extra;\n+}\n+\n+(* See R2c.ml in semgrep-core *)", "originalCommit": "0441f342a9a157718db11e5df8c9f2c81f9a1c99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjEyMzI2NA==", "url": "https://github.com/returntocorp/semgrep/pull/1845#discussion_r506123264", "bodyText": "Anyway you should need it. It's used when a metavariable matches an identifier and we want to make sure that independent matches on the same identifer name correspond to same scoped identifier (see Naming_AST.ml in pfff))", "author": "aryx", "createdAt": "2020-10-16T07:30:16Z", "path": "spacegrep/src/lib/Semgrep.atd", "diffHunk": "@@ -0,0 +1,71 @@\n+(*\n+   Type definitions for json communication with semgrep.\n+\n+   Inferred from JSON_report.ml in semgrep-core.\n+*)\n+\n+type match_results = {\n+  matches: match_ list;\n+  errors: error list;\n+  stats: stats;\n+}\n+\n+type stats = {\n+  okfiles: int;\n+  errorfiles: int;\n+}\n+\n+type match_ = {\n+  ?check_id: string option; (* rule ID *)\n+  path: string; (* source file *)\n+  start: position;\n+  end_ <json name=\"end\">: position;\n+  extra: match_extra;\n+}\n+\n+(* See R2c.ml in semgrep-core *)\n+type error = {\n+  ?check_id: string option;\n+  path: string;\n+  start: position;\n+  end_ <json name=\"end\">: position;\n+  extra: error_extra;\n+}\n+\n+type position = {\n+  line: int; (* starts at 1 *)\n+  col: int; (* starts at 1 *)\n+  offset: int; (* byte position from the beginning of the file, starts at 0 *)\n+}\n+\n+type match_extra = {\n+  ?message: string option; (* rule.message (?) *)\n+  metavars: (string * metavar_value) list <json repr=\"object\">;\n+}\n+\n+type error_extra = {\n+  message: string;\n+  line: string;\n+}\n+\n+type metavar_value = {\n+  start: position;\n+  end_ <json name=\"end\">: position;\n+  abstract_content: string; (* value? *)\n+  unique_id: unique_id;\n+}\n+\n+(*\n+   This is just the variant for type=AST.\n+   In order to accommodate two record types into one variant, use\n+   the atdgen feature called a json adapter.\n+*)\n+type unique_id = {\n+  type_ <json name=\"type\">: unique_id_type;\n+  md5sum: string;\n+}\n+\n+type unique_id_type = [\n+(*  | ID <json name=\"id\"> *) (* variant not supported at the moment *)", "originalCommit": "0441f342a9a157718db11e5df8c9f2c81f9a1c99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjEyMzY1NQ==", "url": "https://github.com/returntocorp/semgrep/pull/1845#discussion_r506123655", "bodyText": "Nice! I need to use this atdgen more.", "author": "aryx", "createdAt": "2020-10-16T07:31:03Z", "path": "spacegrep/src/lib/Semgrep.ml", "diffHunk": "@@ -0,0 +1,78 @@\n+(*\n+   Convert matches to the format expected by the semgrep wrapper,\n+   similar to what semgrep-core produces.\n+*)\n+\n+open Match\n+open Semgrep_t\n+\n+let semgrep_pos (x : Lexing.position) : Semgrep_t.position =\n+  {\n+    line = x.pos_lnum + 1;\n+    col = x.pos_cnum - x.pos_bol + 1;\n+    offset = x.pos_cnum;\n+  }\n+\n+let unique_id_of_loc (loc : Loc.t) : unique_id =\n+  let md5sum =\n+    Marshal.to_string loc []\n+    |> Digest.string\n+    |> Digest.to_hex\n+  in\n+  {\n+    type_ = `AST;\n+    md5sum;\n+  }\n+\n+let convert_capture x =\n+  let pos1, pos2 = x.loc in\n+  x.name, {\n+    start = semgrep_pos pos1;\n+    end_ = semgrep_pos pos2;\n+    abstract_content = x.value;\n+    unique_id = unique_id_of_loc x.loc;\n+  }\n+\n+(*\n+   Convert match results to the format expected by semgrep.\n+*)\n+let make_semgrep_json doc_matches : Semgrep_t.match_results =\n+  let matches =\n+    List.map (fun (src, pat_matches) ->\n+      let path = Src_file.source_string src in\n+      List.map (fun (pat_id, matches) ->\n+        let check_id = Some (string_of_int pat_id) in\n+        List.map (fun match_ ->\n+          let ((pos1, _), (_, pos2)) = match_.region in\n+          let metavars = List.map convert_capture match_.captures in\n+          let extra = {\n+            message = None;\n+            metavars;\n+          } in\n+          ({\n+            check_id;\n+            path;\n+            start = semgrep_pos pos1;\n+            end_ = semgrep_pos pos2;\n+            extra;\n+          } : match_)\n+        ) matches\n+      ) pat_matches\n+      |> List.flatten\n+    ) doc_matches\n+    |> List.flatten\n+  in\n+  {\n+    matches;\n+    errors = [];\n+    stats = {\n+      okfiles = List.length doc_matches;\n+      errorfiles = 0;\n+    };\n+  }\n+\n+let print_semgrep_json doc_matches =\n+  make_semgrep_json doc_matches\n+  |> Semgrep_j.string_of_match_results", "originalCommit": "0441f342a9a157718db11e5df8c9f2c81f9a1c99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}