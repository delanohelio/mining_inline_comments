{"pr_number": 1137, "pr_title": "Cache version checking to speed up runs", "pr_createdAt": "2020-06-25T16:31:17Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/1137", "timeline": [{"oid": "f71bafdaa455760db25b4c65f58ca51a5e9ad72c", "url": "https://github.com/returntocorp/semgrep/commit/f71bafdaa455760db25b4c65f58ca51a5e9ad72c", "message": "Cache version checking to speed up runs", "committedDate": "2020-06-25T16:28:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY4ODI4OQ==", "url": "https://github.com/returntocorp/semgrep/pull/1137#discussion_r445688289", "bodyText": "IIRC we're not autogenerating this file any more.", "author": "mschwager", "createdAt": "2020-06-25T16:32:12Z", "path": ".gitignore", "diffHunk": "@@ -149,5 +149,4 @@ dmypy.json\n *.DS_Store\n \n # Ignore autogenerated version file\n-semgrep/semgrep/version.py", "originalCommit": "f71bafdaa455760db25b4c65f58ca51a5e9ad72c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY4OTg4MQ==", "url": "https://github.com/returntocorp/semgrep/pull/1137#discussion_r445689881", "bodyText": "Using .cache isn't ideal on OSX, but I figured this was fine compared to pulling in another dependency like appdirs just to grab a directory. If a user has strong feels about this they can always set SEMGREP_VERSION_CACHE_PATH.", "author": "mschwager", "createdAt": "2020-06-25T16:34:51Z", "path": "semgrep/semgrep/version.py", "diffHunk": "@@ -0,0 +1,118 @@\n+import os\n+import time\n+from pathlib import Path\n+from typing import Optional\n+\n+import requests\n+from packaging.version import InvalidVersion\n+from packaging.version import Version\n+\n+from semgrep import constants\n+from semgrep import util\n+\n+VERSION_CHECK_URL = str(\n+    os.environ.get(\n+        \"SEMGREP_VERSION_CHECK_URL\", \"https://semgrep.live/api/check-version\"\n+    )\n+)\n+VERSION_CHECK_TIMEOUT = int(\n+    os.environ.get(\n+        \"SEMGREP_VERSION_CHECK_TIMEOUT\", 2  # Don't block user's for too long\n+    )\n+)\n+VERSION_CACHE_PATH = Path(\n+    os.environ.get(\n+        \"SEMGREP_VERSION_CACHE_PATH\",\n+        Path(os.path.expanduser(\"~/.cache\")) / \"semgrep_version\",", "originalCommit": "f71bafdaa455760db25b4c65f58ca51a5e9ad72c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "06af4fe2d44914877902189bec7c7945f4c4ddfc", "url": "https://github.com/returntocorp/semgrep/commit/06af4fe2d44914877902189bec7c7945f4c4ddfc", "message": "Appease 'requests' lint rule", "committedDate": "2020-06-25T16:36:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcwODQwMA==", "url": "https://github.com/returntocorp/semgrep/pull/1137#discussion_r445708400", "bodyText": "If you want a more accurate test you can actually assert that _fetch_latest_version was only called once", "author": "brendongo", "createdAt": "2020-06-25T17:05:28Z", "path": "semgrep/tests/unit/test_version.py", "diffHunk": "@@ -0,0 +1,17 @@\n+import time\n+\n+from semgrep.version import is_running_latest\n+\n+\n+def test_version_check_caching(tmp_path):\n+    tmp_cache_path = tmp_path / \"semgrep_version\"\n+\n+    time1 = time.time()\n+    is_running_latest(tmp_cache_path)\n+    time1 = time.time() - time1\n+\n+    time2 = time.time()\n+    is_running_latest(tmp_cache_path)", "originalCommit": "06af4fe2d44914877902189bec7c7945f4c4ddfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcwOTgyNw==", "url": "https://github.com/returntocorp/semgrep/pull/1137#discussion_r445709827", "bodyText": "Thoughts on copying the tests from https://github.com/returntocorp/bento/blob/master/tests/test_version.py ?", "author": "brendongo", "createdAt": "2020-06-25T17:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcwODQwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcxMTY1OQ==", "url": "https://github.com/returntocorp/semgrep/pull/1137#discussion_r445711659", "bodyText": "Do we need to check if the parent exists if we call mkdir with exist_ok=True anyway?", "author": "brendongo", "createdAt": "2020-06-25T17:11:12Z", "path": "semgrep/semgrep/version.py", "diffHunk": "@@ -0,0 +1,119 @@\n+import os\n+import time\n+from pathlib import Path\n+from typing import Optional\n+\n+from packaging.version import InvalidVersion\n+from packaging.version import Version\n+\n+from semgrep import constants\n+from semgrep import util\n+\n+VERSION_CHECK_URL = str(\n+    os.environ.get(\n+        \"SEMGREP_VERSION_CHECK_URL\", \"https://semgrep.live/api/check-version\"\n+    )\n+)\n+VERSION_CHECK_TIMEOUT = int(\n+    os.environ.get(\n+        \"SEMGREP_VERSION_CHECK_TIMEOUT\", 2  # Don't block user's for too long\n+    )\n+)\n+VERSION_CACHE_PATH = Path(\n+    os.environ.get(\n+        \"SEMGREP_VERSION_CACHE_PATH\",\n+        Path(os.path.expanduser(\"~/.cache\")) / \"semgrep_version\",\n+    )\n+)\n+\n+\n+def _fetch_latest_version(\n+    url: str = VERSION_CHECK_URL, timeout: int = VERSION_CHECK_TIMEOUT\n+) -> Optional[str]:\n+    try:\n+        import requests\n+\n+        resp = requests.get(\n+            url,\n+            headers={\"User-Agent\": f\"Semgrep/{constants.__VERSION__}\"},\n+            timeout=timeout,\n+        )\n+    except Exception as e:\n+        util.debug_print(f\"Fetching latest version failed to connect: {e}\")\n+        return None\n+    else:\n+        if resp.status_code != requests.codes.OK:\n+            util.debug_print(\n+                f\"Fetching latest version received HTTP error code: {resp.status_code}\"\n+            )\n+            return None\n+        try:\n+            resp_json = resp.json()\n+        except ValueError:\n+            util.debug_print(\"Fetching latest version received invalid JSON\")\n+            return None\n+        else:\n+            return str(resp_json[\"latest\"])\n+\n+\n+def _get_version_from_cache(version_cache_path: Path) -> Optional[str]:\n+    now = time.time()\n+\n+    if version_cache_path.is_file():\n+        with version_cache_path.open() as f:\n+            timestamp_str = f.readline().strip()\n+            latest_version_str = f.readline().strip()\n+\n+            try:\n+                # Treat time as integer seconds so no need to deal with str float conversion\n+                timestamp = int(timestamp_str)\n+            except ValueError:\n+                util.debug_print(f\"Version cache invalid timestamp: {timestamp_str}\")\n+                return None\n+\n+            one_day = 86400\n+            if now - timestamp > one_day:\n+                util.debug_print(f\"Version cache expired: {timestamp_str}:{now}\")\n+                return None\n+\n+            return latest_version_str\n+\n+    util.debug_print(\"Version cache does not exist\")\n+    return None\n+\n+\n+def _get_latest_version(version_cache_path: Path) -> Optional[str]:\n+    latest_version_str = _get_version_from_cache(version_cache_path)\n+    if latest_version_str is None:\n+        latest_version_str = _fetch_latest_version()\n+        if latest_version_str is None:\n+            # Request timed out or invalid\n+            return None\n+\n+        if not version_cache_path.parent.is_dir():\n+            version_cache_path.parent.mkdir(parents=True, exist_ok=True)", "originalCommit": "06af4fe2d44914877902189bec7c7945f4c4ddfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc0Mjg2Mg==", "url": "https://github.com/returntocorp/semgrep/pull/1137#discussion_r445742862", "bodyText": "Good call!", "author": "mschwager", "createdAt": "2020-06-25T18:06:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcxMTY1OQ=="}], "type": "inlineReview"}, {"oid": "251b00e00a34bbbdaaed0901f6e74d0e5079e226", "url": "https://github.com/returntocorp/semgrep/commit/251b00e00a34bbbdaaed0901f6e74d0e5079e226", "message": "Address PR suggestions", "committedDate": "2020-06-25T19:30:57Z", "type": "commit"}, {"oid": "9989efb7520c0127a03c18787ff59cb28f566f5c", "url": "https://github.com/returntocorp/semgrep/commit/9989efb7520c0127a03c18787ff59cb28f566f5c", "message": "Don't depend on timing anymore which could be flaky", "committedDate": "2020-06-25T19:39:16Z", "type": "commit"}]}