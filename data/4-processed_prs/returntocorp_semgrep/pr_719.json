{"pr_number": 719, "pr_title": "Add support for SARIF format with --sarif", "pr_createdAt": "2020-05-08T08:19:10Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/719", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAxMzEzOA==", "url": "https://github.com/returntocorp/semgrep/pull/719#discussion_r422013138", "bodyText": "This is to satisfy the type hints. Should never happen as we control the output_format value in our code.", "author": "underyx", "createdAt": "2020-05-08T08:20:52Z", "path": "semgrep/semgrep/output.py", "diffHunk": "@@ -105,15 +109,48 @@ def build_output_json(rule_matches: List[RuleMatch], semgrep_errors: List[Any])\n     return json.dumps(output_json)\n \n \n+def _sarif_tool_info() -> Dict[str, Any]:\n+    return {\"name\": \"semgrep\", \"semanticVersion\": __VERSION__}\n+\n+\n+def build_sarif_output(\n+    rule_matches: List[RuleMatch], rules: FrozenSet[Rule], semgrep_errors: List[Any]\n+) -> str:\n+    \"\"\"\n+    Format matches in SARIF v2.1.0 formatted JSON.\n+\n+    - written based on https://help.github.com/en/github/finding-security-vulnerabilities-and-errors-in-your-code/about-sarif-support-for-code-scanning\n+    - which links to this schema https://github.com/oasis-tcs/sarif-spec/blob/master/Schemata/sarif-schema-2.1.0.json\n+    - full spec is at https://docs.oasis-open.org/sarif/sarif/v2.1.0/cs01/sarif-v2.1.0-cs01.html\n+    \"\"\"\n+    output_dict = {\n+        \"$schema\": \"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json\",\n+        \"version\": \"2.1.0\",\n+        \"tool\": {\n+            \"driver\": {\n+                **_sarif_tool_info(),\n+                \"rules\": [rule.to_sarif() for rule in rules],\n+            }\n+        },\n+        \"results\": [match.to_sarif() for match in rule_matches],\n+    }\n+    return json.dumps(output_dict)\n+\n+\n def build_output(\n     rule_matches: List[RuleMatch],\n+    rules: FrozenSet[Rule],\n     semgrep_errors: List[Any],\n-    json_format: bool,\n+    output_format: str,\n     color_output: bool,\n ) -> str:\n-    if json_format:\n+    if output_format == \"json\":\n         return build_output_json(rule_matches, semgrep_errors)\n-    else:\n+    elif output_format == \"sarif\":\n+        return build_sarif_output(rule_matches, rules, semgrep_errors)\n+    elif output_format == \"normal\":\n         return \"\\n\".join(\n             build_normal_output(rule_matches, semgrep_errors, color_output)\n         )\n+    else:\n+        raise RuntimeError(f\"Not sure how to format as '{output_format}'\")", "originalCommit": "12f5c31bf846b525920e7c0df2ac3fd295f53881", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e41ff742769f0812f7920a1fbc37637fedd56b75", "url": "https://github.com/returntocorp/semgrep/commit/e41ff742769f0812f7920a1fbc37637fedd56b75", "message": "Add support for SARIF format with --sarif\n\nCloses https://github.com/returntocorp/enterprise/issues/140", "committedDate": "2020-05-11T12:53:52Z", "type": "commit"}, {"oid": "c6e3e8aa661f3e91e2a22b03295ab8dfbeb21353", "url": "https://github.com/returntocorp/semgrep/commit/c6e3e8aa661f3e91e2a22b03295ab8dfbeb21353", "message": "test_sarif_output: Make snapshots deterministic", "committedDate": "2020-05-11T12:53:53Z", "type": "commit"}, {"oid": "e9220e2cf625fe908d809abd3d00d71c0773272b", "url": "https://github.com/returntocorp/semgrep/commit/e9220e2cf625fe908d809abd3d00d71c0773272b", "message": "output: Use an enum for format options", "committedDate": "2020-05-11T12:53:53Z", "type": "commit"}, {"oid": "920032be445aa2bb1d721073f26a042484d891d2", "url": "https://github.com/returntocorp/semgrep/commit/920032be445aa2bb1d721073f26a042484d891d2", "message": "fixup! Add support for SARIF format with --sarif", "committedDate": "2020-05-11T12:53:53Z", "type": "commit"}, {"oid": "beeea09adfe3d1c93182bb9d967536e3b0655fd6", "url": "https://github.com/returntocorp/semgrep/commit/beeea09adfe3d1c93182bb9d967536e3b0655fd6", "message": "CHANGELOG: Add SARIF entry", "committedDate": "2020-05-11T12:57:19Z", "type": "commit"}, {"oid": "99b111927cc4a0b17134b7c88744206c0c8b429f", "url": "https://github.com/returntocorp/semgrep/commit/99b111927cc4a0b17134b7c88744206c0c8b429f", "message": "output.md: Document SARIF format", "committedDate": "2020-05-11T13:07:50Z", "type": "commit"}, {"oid": "1c683140739e54d0c190f67b6e652f46d8e9605e", "url": "https://github.com/returntocorp/semgrep/commit/1c683140739e54d0c190f67b6e652f46d8e9605e", "message": "output.md: Reformat JSON examples", "committedDate": "2020-05-11T13:09:00Z", "type": "commit"}, {"oid": "5c7ff99ac832da2bd0ab53d679fe3cf337601aef", "url": "https://github.com/returntocorp/semgrep/commit/5c7ff99ac832da2bd0ab53d679fe3cf337601aef", "message": "README: Add note on output options", "committedDate": "2020-05-11T13:15:52Z", "type": "commit"}, {"oid": "5c7ff99ac832da2bd0ab53d679fe3cf337601aef", "url": "https://github.com/returntocorp/semgrep/commit/5c7ff99ac832da2bd0ab53d679fe3cf337601aef", "message": "README: Add note on output options", "committedDate": "2020-05-11T13:15:52Z", "type": "forcePushed"}]}