{"pr_number": 1824, "pr_title": "Add 'metavariable-comparison' frontend to expression eval", "pr_createdAt": "2020-10-13T17:13:20Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/1824", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEyNTUyNg==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504125526", "bodyText": "I think this may have been unintentionally left in. It makes it difficult to debug this module because it's impossible to set the logger level to DEBUG with this here. Now that we have the --debug flag I think this is no longer necessary, or unintentional.", "author": "mschwager", "createdAt": "2020-10-13T17:14:46Z", "path": "semgrep/semgrep/evaluation.py", "diffHunk": "@@ -11,13 +11,12 @@\n from typing import Tuple\n \n logger = logging.getLogger(__name__)\n-# disable logging from this module most of the time", "originalCommit": "a59a58f9cbf4b9cb719dc833299632b1b0b0e019", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0NTczNQ==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504145735", "bodyText": "I did it intentionally -- it was really difficult to debug other parts of the program with the large amount of output this module spews. But very open to other approaches", "author": "ievans", "createdAt": "2020-10-13T17:49:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEyNTUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5MTEwMg==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504191102", "bodyText": "Hmm, I usually try to err on the side of over-outputting with debug output vs. under-outputting. It's much easier to filter existing output than include additional output information in an already released version. If you're looking for a specific message in the debug output you can always:\n$ semgrep --debug ... 2>&1 | grep 'compiled result'\n\nOr, if you want to squelch a particularly noisy log line you can do something like:\n$ semgrep --debug  ... 2>&1 | grep -v 'after filter'\n\nAnother good option here is including %(name)s in our logger format in semgrep/semgrep/util.py. Then we could do something like the following to squelch a single module's logging:\n$ semgrep --debug  ... 2>&1 | grep -v 'semgrep.evaluation'", "author": "mschwager", "createdAt": "2020-10-13T19:05:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEyNTUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4Nzg3MA==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504287870", "bodyText": "I now use in semgrep-core a logging library inspired by the python one, and you can use a config file to specify the different levels for the different modules outside the code. See https://github.com/returntocorp/semgrep/blob/develop/semgrep-core/log_config.json.ex1", "author": "aryx", "createdAt": "2020-10-13T22:11:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEyNTUyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEyNTc3MQ==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504125771", "bodyText": "This is no longer needed with the jsonschema changes.", "author": "mschwager", "createdAt": "2020-10-13T17:15:07Z", "path": "semgrep/semgrep/evaluation.py", "diffHunk": "@@ -193,14 +254,6 @@ def _evaluate_single_expression(\n         )\n         return output_ranges\n     elif expression.operator == OPERATORS.METAVARIABLE_REGEX:\n-        if (", "originalCommit": "a59a58f9cbf4b9cb719dc833299632b1b0b0e019", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzMDYxMA==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504230610", "bodyText": "could also be called pattern-where-python-safe", "author": "aryx", "createdAt": "2020-10-13T20:18:04Z", "path": "docs/configuration-files.md", "diffHunk": "@@ -19,6 +19,7 @@ Contents:\n   * [`pattern-either`](configuration-files.md#pattern-either)\n   * [`pattern-regex`](configuration-files.md#pattern-regex)\n   * [`metavariable-regex`](configuration-files.md#metavariable-regex)\n+  * [`metavariable-comparison`](configuration-files.md#metavariable-comparison)", "originalCommit": "64f8eebcd90f8c358c9803d2c70f13512c316700", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzMjg1MA==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504232850", "bodyText": "Maybe the only safe thing people want to express are comparisons, so maybe it's not a bad name but it does not really give room for being more than that. For example some people wanted to check if $X in [1, 42, 57]\nand it's not really a comparison (or maybe it is).", "author": "aryx", "createdAt": "2020-10-13T20:20:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzMDYxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI1MTg0NQ==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504251845", "bodyText": "IMO, naming it pattern-where-python-safe will make people question why they'd ever need pattern-where-python and what the differences between the two are. Then we'd have to document all the differences, which may be hard to grok for someone without a program analysis background. E.g. \"what's the difference between an expression and a statement\", \"why can't I call functions X, Y, and Z?\", etc. This would also tie our hands if we ever decided to open up the list of available languages. I.e. would we also have a pattern-where-javascript-safe?\nKeeping this distinct from pattern-where-python allows for a simpler mental model of our operators IMO.", "author": "mschwager", "createdAt": "2020-10-13T20:53:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzMDYxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4ODgwMg==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504288802", "bodyText": "sounds fair.", "author": "aryx", "createdAt": "2020-10-13T22:13:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzMDYxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyMjUwOQ==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r507822509", "bodyText": "I like the resolution here. I also would add that this suggestion would make the unsafe variant our de facto default, which is something we should always strive to avoid.", "author": "underyx", "createdAt": "2020-10-19T14:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzMDYxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNDMwMA==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504234300", "bodyText": "maybe say also \"and as opposed to pattern-where-python is guaranteed to be safe and so can be computed without\n--unsafe-eval-do-at-your-own-risk CLI parameter\".", "author": "aryx", "createdAt": "2020-10-13T20:21:39Z", "path": "docs/configuration-files.md", "diffHunk": "@@ -224,6 +226,64 @@ rules:\n     severity: ERROR\n ```\n \n+### `metavariable-comparison`\n+\n+The `metavariable-comparison` operator compares metavariables against a basic [Python comparison](https://docs.python.org/3/reference/expressions.html#comparisons)\n+expression. This is useful for filtering results based on a [metavariable's](/docs/pattern-features.md#metavariables) value.", "originalCommit": "64f8eebcd90f8c358c9803d2c70f13512c316700", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNTA1MA==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504235050", "bodyText": "why the quote around the metavariable? we don't put quote to express patterns.", "author": "aryx", "createdAt": "2020-10-13T20:22:26Z", "path": "docs/configuration-files.md", "diffHunk": "@@ -224,6 +226,64 @@ rules:\n     severity: ERROR\n ```\n \n+### `metavariable-comparison`\n+\n+The `metavariable-comparison` operator compares metavariables against a basic [Python comparison](https://docs.python.org/3/reference/expressions.html#comparisons)\n+expression. This is useful for filtering results based on a [metavariable's](/docs/pattern-features.md#metavariables) value.\n+\n+**Example**\n+\n+The `metavariable-comparison` operator is a mapping which requires the\n+`metavariable` and `comparison` keys. It can be combined with other pattern operators:\n+\n+```yaml\n+rules:\n+  - id: superuser-port\n+    patterns:\n+      - pattern: set_port($ARG)\n+      - metavariable-comparison:\n+          metavariable: '$ARG'", "originalCommit": "64f8eebcd90f8c358c9803d2c70f13512c316700", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzODc0Nw==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504238747", "bodyText": "Also why specify the metavariable ... just export all the metavariables in the current matched state and pass it to semgrep-core -eval.\nAlso this prevents to use multiple metavariables comparisons as $X < $Y.", "author": "aryx", "createdAt": "2020-10-13T20:28:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNTA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI1NjYwMA==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504256600", "bodyText": "Specifying the metavariable allows for the base and strip behavior. We could do something like make metavariables, bases, and strips all lists or something so we can specify multiple, but I went with the simplest approach here.", "author": "mschwager", "createdAt": "2020-10-13T21:02:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNTA1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNTQ2OQ==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504235469", "bodyText": "same, why the quote? The main interest of yaml is to remove the need for quotes no?", "author": "aryx", "createdAt": "2020-10-13T20:22:51Z", "path": "docs/configuration-files.md", "diffHunk": "@@ -224,6 +226,64 @@ rules:\n     severity: ERROR\n ```\n \n+### `metavariable-comparison`\n+\n+The `metavariable-comparison` operator compares metavariables against a basic [Python comparison](https://docs.python.org/3/reference/expressions.html#comparisons)\n+expression. This is useful for filtering results based on a [metavariable's](/docs/pattern-features.md#metavariables) value.\n+\n+**Example**\n+\n+The `metavariable-comparison` operator is a mapping which requires the\n+`metavariable` and `comparison` keys. It can be combined with other pattern operators:\n+\n+```yaml\n+rules:\n+  - id: superuser-port\n+    patterns:\n+      - pattern: set_port($ARG)\n+      - metavariable-comparison:\n+          metavariable: '$ARG'\n+          comparison: '$ARG < 1024'", "originalCommit": "64f8eebcd90f8c358c9803d2c70f13512c316700", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI1NTg4Mw==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504255883", "bodyText": "Hah, I think YAML provides a bit more than lack of quotes over JSON :D\nI've been burned one too many times by YAML interpreting string data as a different scalar type, so I always quote strings by default now /shrug. An interesting example here was including git short hashes in YAML data, so on the off chance your commit hash was like 1234567 YAML would interpret it as an integer instead of the usual string like 5dbfa6d. That was a fun bug to track down.\nI don't have strong feelings - feel free to change the examples in the docs if you'd like.", "author": "mschwager", "createdAt": "2020-10-13T21:01:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNTQ2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4OTE5Nw==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504289197", "bodyText": "Got it, no the examples are fine, I was just worried I misunderstood something with YAML.", "author": "aryx", "createdAt": "2020-10-13T22:14:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNTQ2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNzAzNA==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504237034", "bodyText": "the number syntax itself contains the base, why specify the base here?\nOCaml, and I guess Python will be able to read 0xa or 10 or 0o82 or whatever syntax and convert to an internal number.", "author": "aryx", "createdAt": "2020-10-13T20:24:54Z", "path": "docs/configuration-files.md", "diffHunk": "@@ -224,6 +226,64 @@ rules:\n     severity: ERROR\n ```\n \n+### `metavariable-comparison`\n+\n+The `metavariable-comparison` operator compares metavariables against a basic [Python comparison](https://docs.python.org/3/reference/expressions.html#comparisons)\n+expression. This is useful for filtering results based on a [metavariable's](/docs/pattern-features.md#metavariables) value.\n+\n+**Example**\n+\n+The `metavariable-comparison` operator is a mapping which requires the\n+`metavariable` and `comparison` keys. It can be combined with other pattern operators:\n+\n+```yaml\n+rules:\n+  - id: superuser-port\n+    patterns:\n+      - pattern: set_port($ARG)\n+      - metavariable-comparison:\n+          metavariable: '$ARG'\n+          comparison: '$ARG < 1024'\n+    message: \"module setting superuser port\"\n+    languages: [python]\n+    severity: ERROR\n+```\n+\n+This will catch code like `set_port(80)` or `set_port(443)`, but not `set_port(8080)`.\n+\n+The `metavariable-comparison` operator also takes optional `base: int` and", "originalCommit": "64f8eebcd90f8c358c9803d2c70f13512c316700", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2MjQ0NQ==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504262445", "bodyText": "I don't think that's true at the moment. The regex for integer detection is currently ^[0-9]+$, which misses 0x, 0o, etc. Since the metavariable content is always initially a string, I wanted to provide a mechanism for parsing the string value in different bases.\nGenerally, if you look at our semgrep-rules, the majority of rules using pattern-where-python perform a simple comparison, and often parse a number in a different base, or perform a string strip. I know this implementation isn't the maximally powerful/generalized solution, it instead aims to cover the majority of use cases, not all of them, and hit the sweet spot between power and usability (and minimize --dangerously... usage). E.g.\n24:  - pattern-where-python: |\n25-      int(vars['$PERM'], 8) > 0o600\n\n18:  - pattern-where-python: |-\n19-      int(vars['$BITS']) < 2048\n\n18:  - pattern-where-python: |-\n19-      int(vars['$SIZE']) < 128\n\n11:  - pattern-where-python: int(vars['$NUM'].replace('\"', '')) > 32767 or int(vars['$NUM'].replace('\"', '')) < -32768\n\n21:  - pattern-where-python: |-\n22-      int(vars['$NUM'].replace('\"', '')) > 2147483647 or int(vars['$NUM'].replace('\"', '')) < -2147483648", "author": "mschwager", "createdAt": "2020-10-13T21:14:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNzAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTU1NTk3MA==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r505555970", "bodyText": "@aryx I had a thought here: would it make more sense for semgrep-core to simply take in the data as the corresponding JSON type instead of performing string parsing? I.e. a JSON integer is an integer, a JSON float is a float, a JSON string is a string, etc, instead of trying to interpret the data with regexs. That way Python can interpret the metavariable data it receives, then semgrep-core can simply operate on the JSON types.\nIMO Python is better equipped to deal with things like string parsing, while OCaml is obviously better equipped to deal with program analysis tasks.", "author": "mschwager", "createdAt": "2020-10-15T13:47:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNzAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTU4NDY3MQ==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r505584671", "bodyText": "Yes, good idea (but no Python is not better equipped for string parsing :) )", "author": "aryx", "createdAt": "2020-10-15T14:23:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNzAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTU4NTAwMw==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r505585003", "bodyText": "I'll modify -eval to accept directly the right Json type.", "author": "aryx", "createdAt": "2020-10-15T14:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNzAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYyNjc0MQ==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r505626741", "bodyText": "@mschwager #1839", "author": "aryx", "createdAt": "2020-10-15T15:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNzAzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNzQyOQ==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504237429", "bodyText": "again, I don't think we need strip, if the metavariable matches a string, then -eval will do the right thing and allow only operations on strings.", "author": "aryx", "createdAt": "2020-10-13T20:25:31Z", "path": "docs/configuration-files.md", "diffHunk": "@@ -224,6 +226,64 @@ rules:\n     severity: ERROR\n ```\n \n+### `metavariable-comparison`\n+\n+The `metavariable-comparison` operator compares metavariables against a basic [Python comparison](https://docs.python.org/3/reference/expressions.html#comparisons)\n+expression. This is useful for filtering results based on a [metavariable's](/docs/pattern-features.md#metavariables) value.\n+\n+**Example**\n+\n+The `metavariable-comparison` operator is a mapping which requires the\n+`metavariable` and `comparison` keys. It can be combined with other pattern operators:\n+\n+```yaml\n+rules:\n+  - id: superuser-port\n+    patterns:\n+      - pattern: set_port($ARG)\n+      - metavariable-comparison:\n+          metavariable: '$ARG'\n+          comparison: '$ARG < 1024'\n+    message: \"module setting superuser port\"\n+    languages: [python]\n+    severity: ERROR\n+```\n+\n+This will catch code like `set_port(80)` or `set_port(443)`, but not `set_port(8080)`.\n+\n+The `metavariable-comparison` operator also takes optional `base: int` and\n+`strip: bool` keys. These keys set the integer base the metavariable value\n+should be interpreted as and remove quotes from the metavariable value,", "originalCommit": "64f8eebcd90f8c358c9803d2c70f13512c316700", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2MzE4Mw==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504263183", "bodyText": "strip is for strings that look like integers. E.g.\n21:  - pattern-where-python: |-\n22-      int(vars['$NUM'].replace('\"', '')) > 2147483647 or int(vars['$NUM'].replace('\"', '')) < -2147483648\n\n11:  - pattern-where-python: int(vars['$NUM'].replace('\"', '')) > 32767 or int(vars['$NUM'].replace('\"', '')) < -32768\n\nPerforming string operations on \"2147483647\" won't be helpful in this situation.", "author": "mschwager", "createdAt": "2020-10-13T21:16:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzNzQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzOTE3Nw==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504239177", "bodyText": "@brendongo might get rid of the use of abstract_content at some point, which is quite fragile.", "author": "aryx", "createdAt": "2020-10-13T20:28:56Z", "path": "semgrep/semgrep/evaluation.py", "diffHunk": "@@ -56,6 +55,68 @@ def get_re_range_matches(\n     return result\n \n \n+def compare_range_match(\n+    metavariable: str,\n+    comparison: str,\n+    strip: Optional[bool],\n+    base: Optional[int],\n+    content: str,\n+) -> bool:\n+\n+    if strip:\n+        content = content.strip(\"\\\"'`\")\n+\n+    try:\n+        # Assume float data if \".\" in content\n+        if \".\" in content:\n+            converted = float(content)\n+        else:\n+            if base:\n+                converted = int(content, base=base)\n+            else:\n+                converted = int(content)\n+    except ValueError:\n+        logger.debug(\n+            f\"metavariable '{metavariable}' incorrect comparison type '{content}'\"\n+        )\n+        return False\n+\n+    return metavariable_comparison(metavariable, comparison, converted)\n+\n+\n+def get_comparison_range_matches(\n+    metavariable: str,\n+    comparison: str,\n+    strip: Optional[bool],\n+    base: Optional[int],\n+    ranges: Set[Range],\n+    pattern_matches: List[PatternMatch],\n+) -> Set[Range]:\n+\n+    result: Set[Range] = set()\n+    for _range in ranges:\n+        if metavariable not in _range.vars:\n+            logger.debug(f\"metavariable '{metavariable}' missing in range '{_range}'\")\n+            continue\n+\n+        any_matching_ranges = any(\n+            pm.range == _range\n+            and metavariable in pm.metavars\n+            and compare_range_match(\n+                metavariable,\n+                comparison,\n+                strip,\n+                base,\n+                pm.metavars[metavariable][\"abstract_content\"],", "originalCommit": "64f8eebcd90f8c358c9803d2c70f13512c316700", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2MzQwOQ==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504263409", "bodyText": "It's used in quite a few places, so we'll have to tread carefully if/when we do.", "author": "mschwager", "createdAt": "2020-10-13T21:16:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzOTE3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzOTg1Nw==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504239857", "bodyText": "I can fix that and sort on the semgrep-core side. This is ugly indeed otherwise to impose an order.\nSorry.", "author": "aryx", "createdAt": "2020-10-13T20:30:09Z", "path": "semgrep/semgrep/metavariable_comparison.py", "diffHunk": "@@ -0,0 +1,34 @@\n+import collections\n+import json\n+import subprocess\n+import tempfile\n+from typing import Union\n+\n+from semgrep.constants import PLEASE_FILE_ISSUE_TEXT\n+from semgrep.constants import SEMGREP_PATH\n+from semgrep.error import SemgrepError\n+from semgrep.util import sub_check_output\n+\n+\n+def metavariable_comparison(\n+    metavariable: str, comparison: str, content: Union[int, float]\n+) -> bool:\n+    # semgrep-core requires the 'language' key be before the 'code' key,", "originalCommit": "64f8eebcd90f8c358c9803d2c70f13512c316700", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2Mzc0Mg==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504263742", "bodyText": "No worries! That was going to be one of my v2 feature requests. That and float support :)", "author": "mschwager", "createdAt": "2020-10-13T21:17:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDIzOTg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI0MDQyMQ==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r504240421", "bodyText": "Note that if it returns NONE, this means the expression passed was not considered safe or part of the handled subset. Maybe you want to return that information to the user.", "author": "aryx", "createdAt": "2020-10-13T20:31:17Z", "path": "semgrep/semgrep/metavariable_comparison.py", "diffHunk": "@@ -0,0 +1,34 @@\n+import collections\n+import json\n+import subprocess\n+import tempfile\n+from typing import Union\n+\n+from semgrep.constants import PLEASE_FILE_ISSUE_TEXT\n+from semgrep.constants import SEMGREP_PATH\n+from semgrep.error import SemgrepError\n+from semgrep.util import sub_check_output\n+\n+\n+def metavariable_comparison(\n+    metavariable: str, comparison: str, content: Union[int, float]\n+) -> bool:\n+    # semgrep-core requires the 'language' key be before the 'code' key,\n+    # so we must use an OrderedDict with special ordering here\n+    core_request = collections.OrderedDict()\n+    core_request[\"metavars\"] = {metavariable: str(content)}\n+    core_request[\"language\"] = \"python\"  # Hardcode for now\n+    core_request[\"code\"] = comparison\n+\n+    with tempfile.NamedTemporaryFile(\"w\") as temp_file:\n+        json.dump(core_request, temp_file)\n+        temp_file.flush()\n+        cmd = [SEMGREP_PATH, \"-eval\", temp_file.name]\n+        try:\n+            output = sub_check_output(cmd)\n+        except subprocess.CalledProcessError as ex:\n+            raise SemgrepError(\n+                f\"error invoking semgrep with:\\n\\t{' '.join(cmd)}\\n\\t{ex}\\n{PLEASE_FILE_ISSUE_TEXT}\"\n+            )\n+\n+    return output.strip() == b\"true\"", "originalCommit": "64f8eebcd90f8c358c9803d2c70f13512c316700", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "87b4a9cfd54ae7406eaf76424cf5eaadfd19ea2b", "url": "https://github.com/returntocorp/semgrep/commit/87b4a9cfd54ae7406eaf76424cf5eaadfd19ea2b", "message": "Add 'metavariable-comparison' frontend to expression eval\n\nFixes #1724.\n\nThings notably out-of-scope for the first iteration of this functionality:\n\n1.) Multi-language expressions\n2.) Multi-metavariable expressions\n\nPer (1), let's start small with a language we know well and expand from\nthere as needed. Per (2), we can leverage the logical AND functionality\nof 'patterns' here instead of multiple metavariables in the same\nexpression. Again, let's start small and iterate as needed.", "committedDate": "2020-10-15T16:19:42Z", "type": "commit"}, {"oid": "b9be44103056383c7979db04ae01684f098c8116", "url": "https://github.com/returntocorp/semgrep/commit/b9be44103056383c7979db04ae01684f098c8116", "message": "Bump CHANGELOG", "committedDate": "2020-10-15T16:20:12Z", "type": "commit"}, {"oid": "64c3f947efe9db10bc93261553dba9052589c88b", "url": "https://github.com/returntocorp/semgrep/commit/64c3f947efe9db10bc93261553dba9052589c88b", "message": "Update for latest JSON changes, and add invalid comparison expression handling/test", "committedDate": "2020-10-15T16:42:42Z", "type": "commit"}, {"oid": "64c3f947efe9db10bc93261553dba9052589c88b", "url": "https://github.com/returntocorp/semgrep/commit/64c3f947efe9db10bc93261553dba9052589c88b", "message": "Update for latest JSON changes, and add invalid comparison expression handling/test", "committedDate": "2020-10-15T16:42:42Z", "type": "forcePushed"}, {"oid": "9949f274722672f7a8681d3fd2a0b34fb2ddadcb", "url": "https://github.com/returntocorp/semgrep/commit/9949f274722672f7a8681d3fd2a0b34fb2ddadcb", "message": "Use correct variable", "committedDate": "2020-10-15T17:13:48Z", "type": "commit"}, {"oid": "8f8bbeed756ce87b80e94777caa592544b3f0bf8", "url": "https://github.com/returntocorp/semgrep/commit/8f8bbeed756ce87b80e94777caa592544b3f0bf8", "message": "Bad CHANGELOG overwrite", "committedDate": "2020-10-15T19:09:56Z", "type": "commit"}, {"oid": "15da55f5e9c9f0538493ab0f6bae4c1a6a607cd4", "url": "https://github.com/returntocorp/semgrep/commit/15da55f5e9c9f0538493ab0f6bae4c1a6a607cd4", "message": "Don't fail hard if we encounter a variable name or other string", "committedDate": "2020-10-15T19:59:19Z", "type": "commit"}, {"oid": "536d391dd6a87b9912df1e04cb897cd307598230", "url": "https://github.com/returntocorp/semgrep/commit/536d391dd6a87b9912df1e04cb897cd307598230", "message": "Allow base of 0", "committedDate": "2020-10-16T19:41:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyNTY0Mg==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r507825642", "bodyText": "Could we also document whether it can compare strings to, for instance, ensure alphabetical ordering?", "author": "underyx", "createdAt": "2020-10-19T15:02:03Z", "path": "docs/configuration-files.md", "diffHunk": "@@ -224,6 +226,64 @@ rules:\n     severity: ERROR\n ```\n \n+### `metavariable-comparison`\n+\n+The `metavariable-comparison` operator compares metavariables against a basic [Python comparison](https://docs.python.org/3/reference/expressions.html#comparisons)\n+expression. This is useful for filtering results based on a [metavariable's](/docs/pattern-features.md#metavariables) value.\n+\n+**Example**\n+\n+The `metavariable-comparison` operator is a mapping which requires the\n+`metavariable` and `comparison` keys. It can be combined with other pattern operators:\n+\n+```yaml\n+rules:\n+  - id: superuser-port\n+    patterns:\n+      - pattern: set_port($ARG)\n+      - metavariable-comparison:\n+          metavariable: '$ARG'\n+          comparison: '$ARG < 1024'\n+    message: \"module setting superuser port\"\n+    languages: [python]\n+    severity: ERROR\n+```\n+\n+This will catch code like `set_port(80)` or `set_port(443)`, but not `set_port(8080)`.", "originalCommit": "536d391dd6a87b9912df1e04cb897cd307598230", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg0MDUxNQ==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r507840515", "bodyText": "Although semgrep-core is wired up for performing basic string comparisons I didn't include this in the Python interface. The pattern-regex operator can be used for string operations. I tend to split these use-cases in my mind like this: pattern-regex is useful for performing string operations and pattern-comparison is useful for performing numeric operations.", "author": "mschwager", "createdAt": "2020-10-19T15:22:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyNTY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg1Mzg3Nw==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r507853877", "bodyText": "I was thinking of a pattern like\n$FIRST = ...\n$SECOND = ...\n\nand then ensuring $FIRST < $SECOND to check for alphabetical order in a whole file.\n\nIs there a way to do this with regex? \ud83e\udd14\nCould we specify in the docs that only numeric comparisons are supported, then?", "author": "underyx", "createdAt": "2020-10-19T15:39:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyNTY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg2NzkzNQ==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r507867935", "bodyText": "... and then ensuring $FIRST < $SECOND to check for alphabetical order in a whole file.\n\nI don't think I understand what you're trying to achieve here. You want to determine if a non-code file is in alphabetical order? Like a CSV file? This can't be done with a regex, especially because these operators only handle a single metavariable.\n\nCould we specify in the docs that only numeric comparisons are supported, then?\n\nSure thing \ud83d\udc4d", "author": "mschwager", "createdAt": "2020-10-19T15:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyNTY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg3MDgxMQ==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r507870811", "bodyText": "I meant, in a constants.py, which looks like:\nFOO_LOGIN = \"me\"\nFOO_PASS = \"hunter2\"\n\nBAR_PASS = \"hunter3\"\nI'd write\n  pattern: |\n    $FIRST = ...\n    $SECOND = ...\n  metavariable-comparison:\n    comparison: $FIRST < $SECOND\nto ensure that BAR_PASS is defined first and thus the whole file is in alphabetical order.", "author": "underyx", "createdAt": "2020-10-19T16:01:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyNTY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg3MTk0Ng==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r507871946", "bodyText": "Reference: https://eslint.org/docs/rules/sort-vars", "author": "underyx", "createdAt": "2020-10-19T16:02:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyNTY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg4NjA3Mw==", "url": "https://github.com/returntocorp/semgrep/pull/1824#discussion_r507886073", "bodyText": "Oh I see what you mean. That behavior is not currently supported. Lexicographical ordering of strings seems like a fairly niche use-case that I'd like to avoid for the v1 of this functionality in the interest of moving forward.", "author": "mschwager", "createdAt": "2020-10-19T16:23:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgyNTY0Mg=="}], "type": "inlineReview"}, {"oid": "0292510c82c6205aa6a2eadcaf91fe4120cf528b", "url": "https://github.com/returntocorp/semgrep/commit/0292510c82c6205aa6a2eadcaf91fe4120cf528b", "message": "Add 'numeric' note", "committedDate": "2020-10-19T16:00:34Z", "type": "commit"}]}