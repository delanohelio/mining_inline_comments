{"pr_number": 937, "pr_title": "Add a clone_github_repo fixture", "pr_createdAt": "2020-06-05T21:56:32Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/937", "timeline": [{"oid": "845569145f526652c7e7d2f74ff36e141fdadee2", "url": "https://github.com/returntocorp/semgrep/commit/845569145f526652c7e7d2f74ff36e141fdadee2", "message": "Add a clone_github_repo fixture\n\nThe fixture uses a cache dir (determined automatically, or settable with GITHUB_REPO_CACHE environment variable)\n\nOn CI, we will read & write to this cache to speed up builds.", "committedDate": "2020-06-05T21:57:50Z", "type": "commit"}, {"oid": "845569145f526652c7e7d2f74ff36e141fdadee2", "url": "https://github.com/returntocorp/semgrep/commit/845569145f526652c7e7d2f74ff36e141fdadee2", "message": "Add a clone_github_repo fixture\n\nThe fixture uses a cache dir (determined automatically, or settable with GITHUB_REPO_CACHE environment variable)\n\nOn CI, we will read & write to this cache to speed up builds.", "committedDate": "2020-06-05T21:57:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE5MDYyNQ==", "url": "https://github.com/returntocorp/semgrep/pull/937#discussion_r436190625", "bodyText": "Add comment on what this function does", "author": "brendongo", "createdAt": "2020-06-05T22:23:22Z", "path": "semgrep/tests/conftest.py", "diffHunk": "@@ -88,6 +92,86 @@ def _run_semgrep(\n     return output\n \n \n+REPO_CACHE = Path(\n+    os.path.expanduser(\n+        os.environ.get(\"GITHUB_REPO_CACHE\", appdirs.user_cache_dir(\"semgrep-tests\"))\n+    )\n+)\n+\n+\n+@pytest.fixture()\n+def clone_github_repo():\n+    yield _github_repo_retry_wrapper\n+\n+\n+@contextlib.contextmanager\n+def chdir(dirname=None):\n+    curdir = os.getcwd()\n+    try:\n+        if dirname is not None:\n+            os.chdir(dirname)\n+        yield\n+    finally:\n+        os.chdir(curdir)\n+\n+\n+def _github_repo_retry_wrapper(\n+    repo_url: str, sha: Optional[str] = None, retries: int = 3\n+):\n+    sha_str = sha or \"latest\"\n+    repo_dir = \"-\".join(repo_url.split(\"/\")[-2:]) + \"-\" + sha_str\n+    repo_destination = REPO_CACHE / repo_dir\n+    try:\n+        return _github_repo(repo_url, sha, repo_destination)\n+    except (GitError, subprocess.CalledProcessError) as ex:\n+        print(f\"Failed to clone github repo for tests {ex}\")\n+        if repo_destination.exists():\n+            shutil.rmtree(repo_destination)\n+        if retries == 0:\n+            raise\n+        else:\n+            return _github_repo_retry_wrapper(repo_url, sha, retries - 1)\n+\n+\n+class GitError(BaseException):\n+    pass\n+\n+\n+def _github_repo(repo_url: str, sha: Optional[str], repo_destination: Path):", "originalCommit": "845569145f526652c7e7d2f74ff36e141fdadee2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ce4742e457d5a71746b8aafd60a8cc452f01029e", "url": "https://github.com/returntocorp/semgrep/commit/ce4742e457d5a71746b8aafd60a8cc452f01029e", "message": "Add docs, fix benchmark", "committedDate": "2020-06-06T00:11:59Z", "type": "commit"}, {"oid": "6c5df0c0ad3f6402ffee8bd2a34305b810c0b24f", "url": "https://github.com/returntocorp/semgrep/commit/6c5df0c0ad3f6402ffee8bd2a34305b810c0b24f", "message": "Use a different cache key to unbreak things", "committedDate": "2020-06-08T20:33:35Z", "type": "commit"}, {"oid": "cd5b8679239d1faca08c625400e2fd72ccdf8610", "url": "https://github.com/returntocorp/semgrep/commit/cd5b8679239d1faca08c625400e2fd72ccdf8610", "message": "sgrep-build image having problems with cache", "committedDate": "2020-06-08T21:10:53Z", "type": "forcePushed"}, {"oid": "7f3516806dc7ac51ed381e1a907060c64799968a", "url": "https://github.com/returntocorp/semgrep/commit/7f3516806dc7ac51ed381e1a907060c64799968a", "message": "sgrep-build image having problems with cache", "committedDate": "2020-06-08T21:15:31Z", "type": "commit"}, {"oid": "7f3516806dc7ac51ed381e1a907060c64799968a", "url": "https://github.com/returntocorp/semgrep/commit/7f3516806dc7ac51ed381e1a907060c64799968a", "message": "sgrep-build image having problems with cache", "committedDate": "2020-06-08T21:15:31Z", "type": "forcePushed"}, {"oid": "3c7634fafa0bd8e76f36da174dd93bb2733ffb3a", "url": "https://github.com/returntocorp/semgrep/commit/3c7634fafa0bd8e76f36da174dd93bb2733ffb3a", "message": "Re-enable the test job", "committedDate": "2020-06-08T21:19:30Z", "type": "commit"}]}