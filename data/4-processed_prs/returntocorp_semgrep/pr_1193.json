{"pr_number": 1193, "pr_title": "Random evaluation.py cleanup", "pr_createdAt": "2020-07-02T16:01:17Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/1193", "timeline": [{"oid": "651794c3f6417cd370d37e9fbf84ff8b9569bc1f", "url": "https://github.com/returntocorp/semgrep/commit/651794c3f6417cd370d37e9fbf84ff8b9569bc1f", "message": "Random evaluation.py cleanup", "committedDate": "2020-07-02T16:00:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTExOTA2MA==", "url": "https://github.com/returntocorp/semgrep/pull/1193#discussion_r449119060", "bodyText": "flake8 suggestion", "author": "mschwager", "createdAt": "2020-07-02T16:01:33Z", "path": "semgrep/semgrep/evaluation.py", "diffHunk": "@@ -92,7 +92,7 @@ def _evaluate_single_expression(\n         )\n         return output_ranges\n     elif expression.operator == OPERATORS.WHERE_PYTHON:\n-        if not flags or flags[RCE_RULE_FLAG] != True:\n+        if not flags or not flags[RCE_RULE_FLAG]:", "originalCommit": "651794c3f6417cd370d37e9fbf84ff8b9569bc1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTExOTQ0Mg==", "url": "https://github.com/returntocorp/semgrep/pull/1193#discussion_r449119442", "bodyText": "This is just re-stating the mypy types and doesn't really contribute anything", "author": "mschwager", "createdAt": "2020-07-02T16:02:15Z", "path": "semgrep/semgrep/evaluation.py", "diffHunk": "@@ -137,39 +137,35 @@ def _evaluate_single_expression(\n         raise UnknownOperatorError(f\"unknown operator {expression.operator}\")\n \n \n-# Given a `where-python` expression as a string and currently matched metavars,", "originalCommit": "651794c3f6417cd370d37e9fbf84ff8b9569bc1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTEyMDAyMA==", "url": "https://github.com/returntocorp/semgrep/pull/1193#discussion_r449120020", "bodyText": "\"Be careful\" doesn't really tell me anything here - the # nosem below tells me this is \"approved insecure behavior\"", "author": "mschwager", "createdAt": "2020-07-02T16:03:06Z", "path": "semgrep/semgrep/evaluation.py", "diffHunk": "@@ -137,39 +137,35 @@ def _evaluate_single_expression(\n         raise UnknownOperatorError(f\"unknown operator {expression.operator}\")\n \n \n-# Given a `where-python` expression as a string and currently matched metavars,\n-# return whether the expression matches as a boolean\n def _where_python_statement_matches(\n     where_expression: str, metavars: Dict[str, Any]\n ) -> bool:\n     # TODO: filter out obvious dangerous things here\n-    output_var = None\n+    result = False\n \n-    # HACK: we're executing arbitrary Python in the where-python,", "originalCommit": "651794c3f6417cd370d37e9fbf84ff8b9569bc1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTEyMDM5MQ==", "url": "https://github.com/returntocorp/semgrep/pull/1193#discussion_r449120391", "bodyText": "It's impossible to statically determine the type here, the isinstance call below confirms the type for us \ud83d\udc4d", "author": "mschwager", "createdAt": "2020-07-02T16:03:44Z", "path": "semgrep/semgrep/evaluation.py", "diffHunk": "@@ -137,39 +137,35 @@ def _evaluate_single_expression(\n         raise UnknownOperatorError(f\"unknown operator {expression.operator}\")\n \n \n-# Given a `where-python` expression as a string and currently matched metavars,\n-# return whether the expression matches as a boolean\n def _where_python_statement_matches(\n     where_expression: str, metavars: Dict[str, Any]\n ) -> bool:\n     # TODO: filter out obvious dangerous things here\n-    output_var = None\n+    result = False\n \n-    # HACK: we're executing arbitrary Python in the where-python,\n-    # be careful my friend\n-    vars = {k: v[\"abstract_content\"] for k, v in metavars.items()}\n+    local_vars = {k: v[\"abstract_content\"] for k, v in metavars.items()}\n     RETURN_VAR = \"semgrep_pattern_return\"\n     try:\n         cleaned_where_expression = where_expression.strip()\n         lines = cleaned_where_expression.split(\"\\n\")\n         new_last_line = f\"{RETURN_VAR} = {lines[-1]}\"\n         lines[-1] = new_last_line\n         to_eval = \"\\n\".join(lines)\n-        scope = {\"vars\": vars}\n+        scope = {\"vars\": local_vars}\n         # fmt: off\n         exec(to_eval, scope)  # nosem: contrib.dlint.dlint-equivalent.insecure-exec-use, python.lang.security.audit.exec-detected.exec-detected\n         # fmt: on\n-        output_var = scope[RETURN_VAR]\n+        result = scope[RETURN_VAR]  # type: ignore", "originalCommit": "651794c3f6417cd370d37e9fbf84ff8b9569bc1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTEyMDY4OQ==", "url": "https://github.com/returntocorp/semgrep/pull/1193#discussion_r449120689", "bodyText": "This function is no longer used after we removed the --exclude-tests flag.", "author": "mschwager", "createdAt": "2020-07-02T16:04:15Z", "path": "semgrep/semgrep/evaluation.py", "diffHunk": "@@ -189,10 +185,6 @@ def safe_relative_to(a: Path, b: Path) -> Path:\n         return a\n \n \n-def should_exclude_this_path(path: Path) -> bool:", "originalCommit": "651794c3f6417cd370d37e9fbf84ff8b9569bc1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTEyMTI0Ng==", "url": "https://github.com/returntocorp/semgrep/pull/1193#discussion_r449121246", "bodyText": "vars is a builtin Python function, let's avoid using it as a local variable name.", "author": "mschwager", "createdAt": "2020-07-02T16:05:03Z", "path": "semgrep/semgrep/evaluation.py", "diffHunk": "@@ -137,39 +137,35 @@ def _evaluate_single_expression(\n         raise UnknownOperatorError(f\"unknown operator {expression.operator}\")\n \n \n-# Given a `where-python` expression as a string and currently matched metavars,\n-# return whether the expression matches as a boolean\n def _where_python_statement_matches(\n     where_expression: str, metavars: Dict[str, Any]\n ) -> bool:\n     # TODO: filter out obvious dangerous things here\n-    output_var = None\n+    result = False\n \n-    # HACK: we're executing arbitrary Python in the where-python,\n-    # be careful my friend\n-    vars = {k: v[\"abstract_content\"] for k, v in metavars.items()}\n+    local_vars = {k: v[\"abstract_content\"] for k, v in metavars.items()}", "originalCommit": "651794c3f6417cd370d37e9fbf84ff8b9569bc1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}