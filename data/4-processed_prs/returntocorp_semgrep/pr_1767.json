{"pr_number": 1767, "pr_title": "Convert tree-sitter parse error exn to Parse_info.Parsing_error", "pr_createdAt": "2020-10-01T14:46:42Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/1767", "timeline": [{"oid": "2687b409a587e12d13b1b23604d8319bcdcab261", "url": "https://github.com/returntocorp/semgrep/commit/2687b409a587e12d13b1b23604d8319bcdcab261", "message": "Convert tree-sitter parse error exn to Parse_info.Parsing_error\n\nThere is already some code to automatically intercept Parse_info exns\nto display their location, so better to use a consistent scheme\nacross pfff and tree-sitter parsers.\n\ntest plan:\n```\n(semgrep) pad@yrax:~/semgrep/tests/OTHER/parsing_errors$ semgrep -l ts -e 'FOO' .\nwarn: parse error\n  --> err.ts:2\n2 |          return 1+\n  |          ^^^^^^^^^\n= help: If the code appears to be valid, this may be a semgrep bug.\nCould not parse err.ts as ts\n\nWarnings exist. Run with `--strict` to turn warnings into errors.\n```\n\nbetter than the previous error that was always reported on the first line.\nThis also improves error location for the errors reported in\nhttps://github.com/returntocorp/semgrep/issues/1713", "committedDate": "2020-10-01T14:45:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM1MTMxMA==", "url": "https://github.com/returntocorp/semgrep/pull/1767#discussion_r498351310", "bodyText": "To get the constructor, you can do Printexc.exn_slot_name exn (since ocaml 4.02). But I don't see how to do the rest without Obj, other than catching the exception in the child (or make the parser return an Ok/Error).", "author": "mjambon", "createdAt": "2020-10-01T15:53:39Z", "path": "semgrep-core/parsing/Parse_tree_sitter_helpers.ml", "diffHunk": "@@ -92,6 +92,45 @@ let combine_tokens env xs =\n       let t = token env x in\n       t\n \n+let mk_tree_sitter_error (err : Tree_sitter_run.Tree_sitter_error.t) =\n+  let start = err.start_pos in\n+  let loc = {\n+    PI.str = err.substring;\n+    charpos = 0; (* fake *)\n+    line = start.row + 1;\n+    column = start.column;\n+    file = err.file.name;\n+  } in\n+  loc\n+\n+let convert_tree_sitter_exn_to_pfff_exn f =\n+  try f ()\n+  with\n+  (* The case below is what we would like to do! However if\n+   * you use Parallel.invoke to invoke the tree-sitter parser, this\n+   * code below will never trigger. Indeed, unmarshalled exn\n+   * can't be used in match or try or used for structural equality\n+   * hence the ugly workaround below. See marshal.mli or Paralle.ml for\n+   * more information.\n+   *)\n+  | Tree_sitter_run.Tree_sitter_error.Error ts_error ->\n+    let loc = mk_tree_sitter_error ts_error in\n+    let info = { PI.token = PI.OriginTok loc; transfo = PI.NoTransfo } in\n+    raise (PI.Parsing_error info)\n+\n+  (* !!!UGLY!!! remove this once we don't use Paralle.invoke *)\n+  | exn ->\n+      let s = Common.exn_to_s exn in\n+      if s = \"Tree_sitter_run.Tree_sitter_error.Error(_)\" then begin\n+        let t = Obj.repr exn in\n+        let info = Obj.field t 1 in\n+        let (ts_error : Tree_sitter_run.Tree_sitter_error.t) = Obj.obj info in\n+        let loc = mk_tree_sitter_error ts_error in\n+        let info = { PI.token = PI.OriginTok loc; transfo = PI.NoTransfo } in\n+        raise (PI.Parsing_error info)\n+      end else raise exn", "originalCommit": "2687b409a587e12d13b1b23604d8319bcdcab261", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM1Njc4MQ==", "url": "https://github.com/returntocorp/semgrep/pull/1767#discussion_r498356781", "bodyText": "yep, the parser could return an algebraic data type. Only exn (open variants) have this marshalling issue.\nStill, I like this hacky solution :)", "author": "aryx", "createdAt": "2020-10-01T16:02:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM1MTMxMA=="}], "type": "inlineReview"}]}