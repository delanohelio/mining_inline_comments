{"pr_number": 1668, "pr_title": "Use base image for docker build", "pr_createdAt": "2020-09-11T01:56:25Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/1668", "timeline": [{"oid": "03e90c456347ef9250dc28324f55f3d99cfa1725", "url": "https://github.com/returntocorp/semgrep/commit/03e90c456347ef9250dc28324f55f3d99cfa1725", "message": "Use ocaml base images hosted on r2c's DockerHub account.", "committedDate": "2020-09-11T01:27:24Z", "type": "commit"}, {"oid": "e73e34258d31ca07b65eaa12be989d2352921283", "url": "https://github.com/returntocorp/semgrep/commit/e73e34258d31ca07b65eaa12be989d2352921283", "message": "Use base ocaml image with pre-installed opam packages for\nthe dockerfile build.", "committedDate": "2020-09-11T01:43:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2MzM5MQ==", "url": "https://github.com/returntocorp/semgrep/pull/1668#discussion_r487163391", "bodyText": "Can we pin this to a specific hash. We want this public docker image to build as deterministically as possible", "author": "brendongo", "createdAt": "2020-09-11T16:42:11Z", "path": "Dockerfile", "diffHunk": "@@ -6,19 +6,15 @@\n # of the 'semgrep' wrapping.\n #\n \n-FROM ocaml/opam2:alpine@sha256:4c2ce9a181b4b12442a68fc221d0b753959ec80e24eae3bf788eeca4dcb9a293 as build-semgrep-core\n+FROM returntocorp/ocaml:alpine as build-semgrep-core", "originalCommit": "e73e34258d31ca07b65eaa12be989d2352921283", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE3MzMwNA==", "url": "https://github.com/returntocorp/semgrep/pull/1668#discussion_r487173304", "bodyText": "I was wondering about that. In addition to reproducibility, we want to stay current with the ocaml packages and reduce the amount of maintenance. How about we use the latest image but we print the image ID at runtime (docker build) for troubleshooting purposes?\nOn DockerHub, we could set a tag based on the date e.g. returntocorp/ocaml:alpine-2020-09-11 in addition to returntocorp/ocaml:alpine. I would still reference returntocorp/ocaml:alpine in CI builds but a message would indicate that returntocorp/ocaml:alpine-2020-09-11 is available for troubleshooting purposes.\nI'll take care of tagging with dates. This should be helpful to see what changed from one week to another.", "author": "mjambon", "createdAt": "2020-09-11T17:00:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2MzM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE3ODMwOQ==", "url": "https://github.com/returntocorp/semgrep/pull/1668#discussion_r487178309", "bodyText": "My worry with having a dynamically updating image behind a single tag is that if someone has returntocorp/ocaml:alpine downloaded on the computer from 5 weeks ago when they docker build again it wont actually pull the latest but use the locally cached one. Not sure what level of caching GithubActions does which might also affect this. Will errors even occur when this happens or is it just a cache miss for dependencies and we end up downloading the needed ones anyway.", "author": "brendongo", "createdAt": "2020-09-11T17:10:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2MzM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM2NDg5Nw==", "url": "https://github.com/returntocorp/semgrep/pull/1668#discussion_r487364897", "bodyText": "if someone has returntocorp/ocaml:alpine downloaded on the computer from 5 weeks ago when they docker build again it wont actually pull the latest\n\nI hadn't realized that. That's a good point.", "author": "mjambon", "createdAt": "2020-09-12T04:13:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2MzM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzM2NTY4OA==", "url": "https://github.com/returntocorp/semgrep/pull/1668#discussion_r487365688", "bodyText": "So what I did is the following:\n\nThe generated dockerfile used to build the ocaml base image contains a dummy command with the current date (e.g. RUN echo 2020-09-11), which ensure the ocaml image is always fresh.\nSuch ocaml images are built weekly.\nEach image is doubly tagged: as just alpine and as alpine-2020-09-11. See https://hub.docker.com/repository/docker/returntocorp/ocaml\n\nFor semgrep's Dockerfile, I suggest using the version like alpine-2020-09-11, which won't change and is friendlier than a hash. This makes it easy to communicate with users, and easy for us to see when it gets old and should be updated.\nFor our CI, I suggest sticking with the latest image such as alpine, and it's sufficiently easy to find out which one was used for a given job, by looking at the list of tags on dockerhub.", "author": "mjambon", "createdAt": "2020-09-12T04:23:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE2MzM5MQ=="}], "type": "inlineReview"}, {"oid": "5c556366a81648216b6c5b997202e1f0ce08f81b", "url": "https://github.com/returntocorp/semgrep/commit/5c556366a81648216b6c5b997202e1f0ce08f81b", "message": "Use immutable image for main dockerfile", "committedDate": "2020-09-12T04:24:55Z", "type": "commit"}, {"oid": "6ac67aa4f75929fa64ccdeae6e429a8cf66ef8fe", "url": "https://github.com/returntocorp/semgrep/commit/6ac67aa4f75929fa64ccdeae6e429a8cf66ef8fe", "message": "Merge remote-tracking branch 'origin/develop' into ocaml-base", "committedDate": "2020-09-14T20:46:00Z", "type": "commit"}]}