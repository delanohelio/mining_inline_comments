{"pr_number": 1712, "pr_title": "Adds a merge rules helper script", "pr_createdAt": "2020-09-21T22:52:39Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/1712", "timeline": [{"oid": "4043d8a1d1aee6ea572b3976953b96ad7cf8f371", "url": "https://github.com/returntocorp/semgrep/commit/4043d8a1d1aee6ea572b3976953b96ad7cf8f371", "message": "Adds a merge rules helper script\n\nmerge-rules.py is a helper script that will create a single yml file by merging all yaml/yml files in a directory and all subdirectories. \r\nSkips directories and files with a leading . \r\n\r\nUseful for local work (slicing and dicing rules) and as help for creation of .semgrep.yml files for CI", "committedDate": "2020-09-21T22:51:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg5NDUzMQ==", "url": "https://github.com/returntocorp/semgrep/pull/1712#discussion_r492894531", "bodyText": "hey @tkisason thanks for the PR! Can we add in a case for no args to print the help? seems to me that sys.argv[1] will fail if no args given", "author": "DrewDennison", "createdAt": "2020-09-22T17:00:52Z", "path": "scripts/merge-rules.py", "diffHunk": "@@ -0,0 +1,42 @@\n+#!/usr/bin/env python3\n+import os\n+import sys\n+from ruamel.yaml import YAML\n+\n+\n+def getRulefilesFromPath(path):\n+    rulefiles = []\n+    for root, dirs, files in os.walk(path):\n+        dirs[:] = [d for d in dirs if not d.startswith(\".\")]\n+        for name in files:\n+            file = os.path.join(root, name)\n+            if (file.endswith(\".yml\") or file.endswith(\".yaml\")) and (\n+                not name.startswith(\".\")\n+            ):\n+                rulefiles.append(file)\n+    print(f\"Found {len(rulefiles)} rulefiles\")\n+    return rulefiles\n+\n+\n+def mergeRules(rulefilelist, outputfile):\n+    yaml = YAML(typ=\"rt\")\n+    rulefile = {\"rules\": []}\n+    for file in rulefilelist:\n+        rulefileyaml = yaml.load(open(file))\n+        rulefile[\"rules\"] += rulefileyaml[\"rules\"]\n+    rulecount = len(rulefile[\"rules\"])\n+    print(f\"Created {rulecount} rules\")\n+    output = open(outputfile, \"w\")\n+    yaml.dump(rulefile, output)\n+    output.close()\n+\n+\n+if __name__ == \"__main__\":\n+    if len(sys.argv) != 3:\n+        print(\"Merges all yaml/yml files in a directory and all subdirs\")\n+        print(\"Skips directories and files prefixed with a .\")\n+        print(f\"Usage {sys.argv[0]} [input folder] [output filename]\")\n+    else:", "originalCommit": "4043d8a1d1aee6ea572b3976953b96ad7cf8f371", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkzMjg0MQ==", "url": "https://github.com/returntocorp/semgrep/pull/1712#discussion_r492932841", "bodyText": "This is exactly how it works. It will check if there are exactly 3 arguments (script name, input folder and output filename) and this is not satisfied it will print out the help:\n(semgrep-rule-merger) ~/workspace/semgrep-rule-merger> ./semgrep-rule-merger.py\nMerges all yaml/yml files in a directory and all subdirs\nSkips directories and files prefixed with a .\nUsage ./semgrep-rule-merger.py [input folder] [output filename]\n(semgrep-rule-merger) ~/workspace/semgrep-rule-merger> ./semgrep-rule-merger.py semgrep-rules\nMerges all yaml/yml files in a directory and all subdirs\nSkips directories and files prefixed with a .\nUsage ./semgrep-rule-merger.py [input folder] [output filename]\n(semgrep-rule-merger) ~/workspace/semgrep-rule-merger> ./semgrep-rule-merger.py semgrep-rules out.yml foo\nMerges all yaml/yml files in a directory and all subdirs\nSkips directories and files prefixed with a .\nUsage ./semgrep-rule-merger.py [input folder] [output filename]\nIf 3 arguments are passed, then it will run the needed functions.\nIs this ok or should i change it in some way?", "author": "tkisason", "createdAt": "2020-09-22T18:04:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg5NDUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQyMDg1Mg==", "url": "https://github.com/returntocorp/semgrep/pull/1712#discussion_r494420852", "bodyText": "@DrewDennison Note the if len(sys.argv) == 3... are we good to merge this one?", "author": "nbrahms", "createdAt": "2020-09-24T15:41:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg5NDUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxMzg4NQ==", "url": "https://github.com/returntocorp/semgrep/pull/1712#discussion_r495213885", "bodyText": "lgtm", "author": "chmccreery", "createdAt": "2020-09-25T20:24:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg5NDUzMQ=="}], "type": "inlineReview"}]}