{"pr_number": 1185, "pr_title": "Store whether we had a timeout on a file in the parsing cache", "pr_createdAt": "2020-07-01T20:53:55Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/1185", "timeline": [{"oid": "832a53650528a479c0eb0242068db7c517beff06", "url": "https://github.com/returntocorp/semgrep/commit/832a53650528a479c0eb0242068db7c517beff06", "message": "Store whether we had a timeout on a file in the parsing cache\n\nThis should help fix #1156\nSee the comment in the diff for more information.\n\nTest plan:\n\ndevelop/home/pad/semgrep/tests/PERF $ rm -rf /tmp/xxx/\ndevelop/home/pad/semgrep/tests/PERF $ time yy -use_parsing_cache /tmp/xxx -lang js -e '$X == $X' timeout.js\n+ /home/pad/github/semgrep/semgrep-core/_build/default/bin/Main.exe -use_parsing_cache /tmp/xxx -lang js -e $X == $X timeout.js\ntimeout.js:1:0: Timeout\n\nFatal error: exception Common.Timeout\n...\n5.528 secs\ndevelop/home/pad/semgrep/tests/PERF $ time yy -use_parsing_cache /tmp/xxx -lang js -e '$X == $X' timeout.js\n+ /home/pad/github/semgrep/semgrep-core/_build/default/bin/Main.exe -use_parsing_cache /tmp/xxx -lang js -e $X == $X timeout.js\ntimeout.js:1:0: Fatal Error: Common.Timeout\nFatal error: exception Common.Timeout\n...\n0.498 secs", "committedDate": "2020-07-01T20:53:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxMTM5Mw==", "url": "https://github.com/returntocorp/semgrep/pull/1185#discussion_r448611393", "bodyText": "Should we store just timeouts or any parse error as well?", "author": "brendongo", "createdAt": "2020-07-01T20:55:20Z", "path": "semgrep-core/bin/Main.ml", "diffHunk": "@@ -380,8 +382,20 @@ let parse_generic lang file =\n   Naming_AST.resolve lang ast;\n   Constant_propagation.propagate lang ast;\n   (*e: [[Main_semgrep_core.parse_generic()]] resolve names in the AST *)\n-  ast\n+  Left ast\n+ (* This is a bit subtle, but we now store in the cache whether we had\n+  * a timeout on this file. Indeed, semgrep now calls semgrep-core\n+  * per rule, and if one file timeout during parsing, it would timeout\n+  * for each rule, but we don't want to wait each time 5sec for each rule.\n+  * So here we store the exn in the cache, and below we reraise it\n+  * after we got it back from the cache.\n+  *)\n+ with Timeout -> Right Timeout", "originalCommit": "832a53650528a479c0eb0242068db7c517beff06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxMzA4OA==", "url": "https://github.com/returntocorp/semgrep/pull/1185#discussion_r448613088", "bodyText": "yep, maybe better cache any exn.\nI think only when we got a timeout things are really annoying performance wise because we\nwill do n times 5s, but it's true that maybe sometimes parsing takes only 4s but end up in a parse error.\nI'll change the diff.", "author": "aryx", "createdAt": "2020-07-01T20:59:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxMTM5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxMzA0OQ==", "url": "https://github.com/returntocorp/semgrep/pull/1185#discussion_r448613049", "bodyText": "What does Left and Right do?", "author": "brendongo", "createdAt": "2020-07-01T20:58:59Z", "path": "semgrep-core/bin/Main.ml", "diffHunk": "@@ -380,8 +382,20 @@ let parse_generic lang file =\n   Naming_AST.resolve lang ast;\n   Constant_propagation.propagate lang ast;\n   (*e: [[Main_semgrep_core.parse_generic()]] resolve names in the AST *)\n-  ast\n+  Left ast", "originalCommit": "832a53650528a479c0eb0242068db7c517beff06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxNTM2NQ==", "url": "https://github.com/returntocorp/semgrep/pull/1185#discussion_r448615365", "bodyText": "Left and Right are constructors defined in pfff/.../Common.ml\nThey are a pretty standard idiom in OCaml and haskell to represent an alternative between 2 types.\nIt's defined as  type ('a, 'b) either = Left of 'a | Right of 'b", "author": "aryx", "createdAt": "2020-07-01T21:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxMzA0OQ=="}], "type": "inlineReview"}, {"oid": "0c70c469d93bf4bab18f85b9c1acae17c37204f4", "url": "https://github.com/returntocorp/semgrep/commit/0c70c469d93bf4bab18f85b9c1acae17c37204f4", "message": "* semgrep-core/bin/Main.ml: brendon's comment", "committedDate": "2020-07-01T21:02:29Z", "type": "commit"}, {"oid": "49e5dfe373c93b2206013e52cd1d3120e4989c5f", "url": "https://github.com/returntocorp/semgrep/commit/49e5dfe373c93b2206013e52cd1d3120e4989c5f", "message": "* semgrep-core/bin/Main.ml: revert back to just Timeout because\nof some weird regressions otherwise", "committedDate": "2020-07-01T22:16:13Z", "type": "commit"}]}