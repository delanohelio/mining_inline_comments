{"pr_number": 860, "pr_title": "Documentation touchups", "pr_createdAt": "2020-05-28T22:06:11Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/860", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1MDk2Mw==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r432150963", "bodyText": "Fixing up a small typo from earlier.", "author": "mschwager", "createdAt": "2020-05-28T22:06:37Z", "path": "docs/configuration-files.md", "diffHunk": "@@ -91,14 +94,15 @@ All required fields must be present at the top-level of a rule. I.e. immediately\n | [`pattern-either`](configuration-files.md#pattern-either)_\\*_ | `array` | Logical OR of multiple patterns. |\n | [`pattern-regex`](configuration-files.md#pattern-regex)_\\*_ | `string` | Search files for [Python `re`](https://docs.python.org/3/library/re.html) compatible expressions. |\n \n-* _\\* Only one of `pattern`, `patterns`, `pattern-either`, or `pattern-regex` is required._\n+_\\* Only one of `pattern`, `patterns`, `pattern-either`, or `pattern-regex` is required._", "originalCommit": "cb6ce51fc3574e1c31da405edebb98652b4e586d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1MTA0Ng==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r432151046", "bodyText": "fix was missing here.", "author": "mschwager", "createdAt": "2020-05-28T22:06:49Z", "path": "docs/configuration-files.md", "diffHunk": "@@ -91,14 +94,15 @@ All required fields must be present at the top-level of a rule. I.e. immediately\n | [`pattern-either`](configuration-files.md#pattern-either)_\\*_ | `array` | Logical OR of multiple patterns. |\n | [`pattern-regex`](configuration-files.md#pattern-regex)_\\*_ | `string` | Search files for [Python `re`](https://docs.python.org/3/library/re.html) compatible expressions. |\n \n-* _\\* Only one of `pattern`, `patterns`, `pattern-either`, or `pattern-regex` is required._\n+_\\* Only one of `pattern`, `patterns`, `pattern-either`, or `pattern-regex` is required._\n \n **Optional:**\n \n | Field | Type | Description |\n | :--- | :--- | :--- |\n-| [`metadata`](advanced.md#metadata) | `object` | Arbitrary user-provided data. Use to attach data to rules without affecting semgrep's behavior |\n-| [`paths`](configuration-files.md#paths) | `object` | Paths to run this check on, or to ignore this check in. See [examples](advanced.md#paths). |\n+| [`fix`](configuration-files.md#fix) | `object` | Simple search-and-replace autofix functionality. |", "originalCommit": "cb6ce51fc3574e1c31da405edebb98652b4e586d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1MTUxNw==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r432151517", "bodyText": "I lumped negations in with \"Note that the behavior is consistent across all child operators: pattern, pattern-not, pattern-regex, pattern-inside, pattern-not-inside.\" above. Does that make sense?", "author": "mschwager", "createdAt": "2020-05-28T22:07:59Z", "path": "docs/configuration-files.md", "diffHunk": "@@ -272,91 +276,90 @@ rules:\n \n This rule looks for usage of Django's [`FloatField`](https://docs.djangoproject.com/en/3.0/ref/models/fields/#django.db.models.FloatField) model when storing currency information. `FloatField` can lead to rounding errors and should be avoided in favor of [`DecimalField`](https://docs.djangoproject.com/en/3.0/ref/models/fields/#django.db.models.DecimalField) when dealing with currency. Here the `pattern-where-python` operator allows us to utilize the Python `in` statement to filter findings that look like currency.\n \n-## Metavariable matching\n+## Metavariable Matching\n \n-### Metavariables in logical inclusions\n+Metavariable matching operates differently for logical AND (`patterns`)\n+and logical OR (`pattern-either`) parent operators. Note that the behavior is\n+consistent across all child operators: `pattern`, `pattern-not`,\n+`pattern-regex`, `pattern-inside`, `pattern-not-inside`.\n \n-Patterns' matched metavariable values are enforced to be identical when performing logical inclusion operations (`patterns`, `pattern-inside`) on matches.\n+### Metavariables in Logical ANDs\n+\n+Metavariable values must be identical across sub-patterns when performing\n+logical AND operations with the `patterns` operator.\n \n **Example**\n \n-Consider the configuration:\n+Consider the following rule:\n+\n ```yaml\n-  patterns:\n-    - pattern-inside: |\n-        def $F($X):\n-            ...\n-    - pattern: open($X)\n+rules:\n+  - id: function-args-to-open\n+    patterns:\n+      - pattern-inside: |\n+          def $F($X):\n+              ...\n+      - pattern: open($X)\n+    message: \"Function argument passed to open() builtin\"\n+    languages: [python]\n+    severity: ERROR\n ```\n \n-This configuration will match this Python code:\n+This rule will match the following code:\n+\n ```python\n def foo(path):\n     open(path)\n ```\n \n But will not match this code:\n+\n ```python\n def foo(path):\n     open(something_else)\n ```\n \n-### Metavariables in logical negations", "originalCommit": "cb6ce51fc3574e1c31da405edebb98652b4e586d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1ODkwMA==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r432158900", "bodyText": "I think the example is useful, so I'd probably leave it in its own section \ud83e\udd37", "author": "nbrahms", "createdAt": "2020-05-28T22:28:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1MTUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ5NzgzOA==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r432497838", "bodyText": "Does it make sense to include it as another example under the patterns metavariable matching section?", "author": "mschwager", "createdAt": "2020-05-29T13:53:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1MTUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA3NDg5OQ==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r434074899", "bodyText": "sure", "author": "nbrahms", "createdAt": "2020-06-02T18:07:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1MTUxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1MjA3OA==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r432152078", "bodyText": "I think this was originally a typo in location. This got lumped in between two \"Ellipsis Operator\" sub-headers.", "author": "mschwager", "createdAt": "2020-05-28T22:09:32Z", "path": "docs/pattern-features.md", "diffHunk": "@@ -228,31 +228,6 @@ pattern: $X = 1 + 2 + ...\n foo = 1 + 2 + 3 + 4\n ```\n \n-### Deep Expression Operator", "originalCommit": "cb6ce51fc3574e1c31da405edebb98652b4e586d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1ODE4MA==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r432158180", "bodyText": "The reason I used \"inclusion\" here is that it covers both patterns and pattern-inside.\nNot sure what the best \"boolean\" analogy is here.", "author": "nbrahms", "createdAt": "2020-05-28T22:26:04Z", "path": "docs/configuration-files.md", "diffHunk": "@@ -272,91 +276,90 @@ rules:\n \n This rule looks for usage of Django's [`FloatField`](https://docs.djangoproject.com/en/3.0/ref/models/fields/#django.db.models.FloatField) model when storing currency information. `FloatField` can lead to rounding errors and should be avoided in favor of [`DecimalField`](https://docs.djangoproject.com/en/3.0/ref/models/fields/#django.db.models.DecimalField) when dealing with currency. Here the `pattern-where-python` operator allows us to utilize the Python `in` statement to filter findings that look like currency.\n \n-## Metavariable matching\n+## Metavariable Matching\n \n-### Metavariables in logical inclusions\n+Metavariable matching operates differently for logical AND (`patterns`)\n+and logical OR (`pattern-either`) parent operators. Note that the behavior is\n+consistent across all child operators: `pattern`, `pattern-not`,\n+`pattern-regex`, `pattern-inside`, `pattern-not-inside`.\n \n-Patterns' matched metavariable values are enforced to be identical when performing logical inclusion operations (`patterns`, `pattern-inside`) on matches.\n+### Metavariables in Logical ANDs", "originalCommit": "cb6ce51fc3574e1c31da405edebb98652b4e586d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ5MDk1NA==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r432490954", "bodyText": "Maybe I'm misunderstanding how this works. My understanding is that metavariable matching occurs across patterns and pattern-either operators. It's operates differently in these cases, but the behavior is consistent across all child operators: pattern, pattern-not, pattern-regex, pattern-inside, pattern-not-inside.\nIs pattern-inside doing something special compared to pattern, pattern-not, etc?", "author": "mschwager", "createdAt": "2020-05-29T13:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1ODE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAyMDk1Ng==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r434020956", "bodyText": "Hmm, pattern-inside is not a simple boolean AND when used inside patterns (IIRC, it is not commutative, for instance). This is why I've been distinguishing it from other child node of patterns. \ud83e\udd37", "author": "nbrahms", "createdAt": "2020-06-02T16:41:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1ODE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE2NDU0Nw==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r434164547", "bodyText": "In my head, this is a logical AND:\npatterns:\n  - pattern: ...\n  - pattern: ...\nand this is not:\npatterns:\n  - pattern-inside: ...\n  - pattern: ...", "author": "nbrahms", "createdAt": "2020-06-02T20:44:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1ODE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE2ODU2OA==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r434168568", "bodyText": "Ahh, I see what you're saying. When using pattern-inside, A & B is not necessarily the same as B & A, so it's not truly a logical AND operation. Regardless, I still think the best way to word this to an average/entry-level engineer is as an AND operation for two reasons:\n\nI think user's will understand this better as an AND operation. For example, in Python these two statements are not equivalent in the same sense: False and operation_with_side_effect() vs. operation_with_side_effect() and False. Yet Python still describes this as an and.\nWe describe this as an AND operation elsewhere in semgrep, and that's fundamentally how we think about the patterns operator. pattern & pattern-inside vs. pattern-inside & pattern are not the same, but I believe that's how people intuitively think about it when using patterns.\n\nMaybe this is indicative of a broader docs need around the inside operators. I.e. we should state these non-equivalences upfront vs. doing it piecemeal in the metavariable matching section. Although I haven't heard any confusion from user's around this yet, so maybe it's not as big of an issue as we think it is. I think user's will intuitively understand that two code snippets cannot simultaneously be inside each other.\nMore broadly, I still think the best way to split these docs up is: under patterns the metavariables must match, and under pattern-either they don't have to match. After you understand that, then things should be consistent with other semgrep behavior.", "author": "mschwager", "createdAt": "2020-06-02T20:52:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1ODE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIxNTA2Ng==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r434215066", "bodyText": "Also, I might just be wrong... at least in the simple case:\n\nhttps://semgrep.live/PekN?version=develop\nhttps://semgrep.live/JDdo?version=develop\n\n\ud83e\udd37 Given this I think my mental model matches up with yours a lot better.", "author": "nbrahms", "createdAt": "2020-06-02T22:43:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1ODE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYwMzU5MQ==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r434603591", "bodyText": "Oh interesting, I wouldn't've assumed that would work either. Well, the other upside of relentlessly documenting things is we get to learn how things work too :)", "author": "mschwager", "createdAt": "2020-06-03T14:19:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1ODE4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1ODMwNA==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r432158304", "bodyText": "This should mention pattern-inside, as all the real-world examples would use pattern-inside.", "author": "nbrahms", "createdAt": "2020-05-28T22:26:24Z", "path": "docs/configuration-files.md", "diffHunk": "@@ -272,91 +276,90 @@ rules:\n \n This rule looks for usage of Django's [`FloatField`](https://docs.djangoproject.com/en/3.0/ref/models/fields/#django.db.models.FloatField) model when storing currency information. `FloatField` can lead to rounding errors and should be avoided in favor of [`DecimalField`](https://docs.djangoproject.com/en/3.0/ref/models/fields/#django.db.models.DecimalField) when dealing with currency. Here the `pattern-where-python` operator allows us to utilize the Python `in` statement to filter findings that look like currency.\n \n-## Metavariable matching\n+## Metavariable Matching\n \n-### Metavariables in logical inclusions\n+Metavariable matching operates differently for logical AND (`patterns`)\n+and logical OR (`pattern-either`) parent operators. Note that the behavior is\n+consistent across all child operators: `pattern`, `pattern-not`,\n+`pattern-regex`, `pattern-inside`, `pattern-not-inside`.\n \n-Patterns' matched metavariable values are enforced to be identical when performing logical inclusion operations (`patterns`, `pattern-inside`) on matches.\n+### Metavariables in Logical ANDs\n+\n+Metavariable values must be identical across sub-patterns when performing\n+logical AND operations with the `patterns` operator.", "originalCommit": "cb6ce51fc3574e1c31da405edebb98652b4e586d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ5NzA2MQ==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r432497061", "bodyText": "What's special about pattern-inside vs. say pattern-not-inside? My understanding is that all child operators have consistent behavior under the patterns operator.\nWhen trying to break this down I see it as: metavariables must match under the patterns operator, and don't need to match under the pattern-either operator. From there, all child operators essentially act as you would expect.\nSo instead of thinking about this in 3 special cases: 1.) (patterns, pattern-inside), 2.) (patterns, pattern-not-inside), 3.) (pattern-either, pattern), I see it as (patterns, <any-child-operator>) and (patterns-either, <any-child-operator>).\nAm I missing something important about the inside operators?", "author": "mschwager", "createdAt": "2020-05-29T13:52:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1ODMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAyMTY5Nw==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r434021697", "bodyText": "See above re. behavior of -inside. I might be (very) confused here, but IIRC, pattern-inside does not conjugate like an AND.", "author": "nbrahms", "createdAt": "2020-06-02T16:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1ODMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE2Mzg0NQ==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r434163845", "bodyText": "TBH, I haven't thought through what happens with metavariables when pattern comes before pattern-inside inside a patterns block...", "author": "nbrahms", "createdAt": "2020-06-02T20:42:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1ODMwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1ODY4Ng==", "url": "https://github.com/returntocorp/semgrep/pull/860#discussion_r432158686", "bodyText": "The behavior is consistent with which top-level operator?", "author": "nbrahms", "createdAt": "2020-05-28T22:27:31Z", "path": "docs/configuration-files.md", "diffHunk": "@@ -272,91 +276,90 @@ rules:\n \n This rule looks for usage of Django's [`FloatField`](https://docs.djangoproject.com/en/3.0/ref/models/fields/#django.db.models.FloatField) model when storing currency information. `FloatField` can lead to rounding errors and should be avoided in favor of [`DecimalField`](https://docs.djangoproject.com/en/3.0/ref/models/fields/#django.db.models.DecimalField) when dealing with currency. Here the `pattern-where-python` operator allows us to utilize the Python `in` statement to filter findings that look like currency.\n \n-## Metavariable matching\n+## Metavariable Matching\n \n-### Metavariables in logical inclusions\n+Metavariable matching operates differently for logical AND (`patterns`)\n+and logical OR (`pattern-either`) parent operators. Note that the behavior is", "originalCommit": "cb6ce51fc3574e1c31da405edebb98652b4e586d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9a9a5829917e6190149fea487fa3c29864f10278", "url": "https://github.com/returntocorp/semgrep/commit/9a9a5829917e6190149fea487fa3c29864f10278", "message": "Documentation touchups", "committedDate": "2020-05-29T21:18:00Z", "type": "commit"}, {"oid": "9a9a5829917e6190149fea487fa3c29864f10278", "url": "https://github.com/returntocorp/semgrep/commit/9a9a5829917e6190149fea487fa3c29864f10278", "message": "Documentation touchups", "committedDate": "2020-05-29T21:18:00Z", "type": "forcePushed"}]}