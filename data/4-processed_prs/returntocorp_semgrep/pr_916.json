{"pr_number": 916, "pr_title": "Remove print_error_exit in favor of using exceptions", "pr_createdAt": "2020-06-04T16:42:08Z", "pr_url": "https://github.com/returntocorp/semgrep/pull/916", "timeline": [{"oid": "e3c8173adbc9698274109dc1936c5033c2665bea", "url": "https://github.com/returntocorp/semgrep/commit/e3c8173adbc9698274109dc1936c5033c2665bea", "message": "Remove print_error_exit in favor of using exceptions", "committedDate": "2020-06-04T16:46:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3NzU5NA==", "url": "https://github.com/returntocorp/semgrep/pull/916#discussion_r435477594", "bodyText": "Including the cmd here will produce non-deterministic results in tests. This is because the command contains a temporary file path pointing to the rule file, which will change every run. We can either find some workaround, or just not include the cmd info. Personally I don't find it very useful.", "author": "mschwager", "createdAt": "2020-06-04T18:47:10Z", "path": "semgrep/semgrep/core_runner.py", "diffHunk": "@@ -294,16 +297,13 @@ def _run_rules(\n                                     output_json\n                                 )\n                             else:\n-                                print_error(\n-                                    f\"unexpected non-json output while invoking semgrep core with {' '.join(cmd)} \\n {ex}\"\n+                                raise SemgrepError(\n+                                    f\"unexpected non-json output while invoking semgrep-core:\\n\\t{ex}\\n{PLEASE_FILE_ISSUE_TEXT}\"\n                                 )\n-                                print_error_exit(f\"\\n{PLEASE_FILE_ISSUE_TEXT}\")\n-                                raise ex  # let our general exception handler take care of this\n                         except Exception as e:\n-                            print_error(\n-                                f\"non-zero return code while invoking semgrep with:\\n\\t{' '.join(cmd)}\\n{ex} {e}\"\n+                            raise SemgrepError(", "originalCommit": "5c117658bb16d341cd511911e8c315329272caef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUwNzE0Nw==", "url": "https://github.com/returntocorp/semgrep/pull/916#discussion_r435507147", "bodyText": "Yeah I'm fine with removing cmd. Since really with tmp files you cant actually run that command afterwards anyway.", "author": "brendongo", "createdAt": "2020-06-04T19:43:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3NzU5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3ODQ4Nw==", "url": "https://github.com/returntocorp/semgrep/pull/916#discussion_r435478487", "bodyText": "This was causing some tests to fail. print_error_exit was defaulting to FATAL_EXIT_CODE, while we were initially defaulting to 1. This should clean it up \ud83d\udc4d", "author": "mschwager", "createdAt": "2020-06-04T18:48:54Z", "path": "semgrep/semgrep/error.py", "diffHunk": "@@ -6,7 +16,7 @@ class SemgrepError(Exception):\n     are displayed to the user.\n     \"\"\"\n \n-    def __init__(self, *args: object, code: int = 1) -> None:\n+    def __init__(self, *args: object, code: int = FATAL_EXIT_CODE) -> None:", "originalCommit": "5c117658bb16d341cd511911e8c315329272caef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3ODc1OA==", "url": "https://github.com/returntocorp/semgrep/pull/916#discussion_r435478758", "bodyText": "This doesn't make any sense :P", "author": "mschwager", "createdAt": "2020-06-04T18:49:24Z", "path": "semgrep/tests/e2e/snapshots/test_rule_parser/test_rule_parser__failure__error_messages/bad1/error.txt", "diffHunk": "@@ -1,2 +1,2 @@\n-rules/syntax/bad1.yaml: inside rule id eqeq-is-bad, pattern fields can't look like this: only ['pattern-inside', 'pattern-not-inside', 'pattern-either', 'pattern-not', 'pattern', 'patterns', 'pattern-where-python', 'fix', 'equivalences', 'pattern-regex'] operators can have children, but found `['pattern-inside']` with children", "originalCommit": "5c117658bb16d341cd511911e8c315329272caef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3OTI0Mg==", "url": "https://github.com/returntocorp/semgrep/pull/916#discussion_r435479242", "bodyText": "Small cleanup here, this was something like and_inside, now it's pattern-inside.", "author": "mschwager", "createdAt": "2020-06-04T18:50:17Z", "path": "semgrep/semgrep/rule.py", "diffHunk": "@@ -55,7 +55,7 @@ def _parse_boolean_expression(\n                         )\n                     else:\n                         raise InvalidRuleSchemaError(\n-                            f\"operator {operator} must have children\"\n+                            f\"operator {boolean_operator} must have children\"", "originalCommit": "5c117658bb16d341cd511911e8c315329272caef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ3OTYzNA==", "url": "https://github.com/returntocorp/semgrep/pull/916#discussion_r435479634", "bodyText": "Without sorting here we will get non-deterministic results in the tests.", "author": "mschwager", "createdAt": "2020-06-04T18:50:55Z", "path": "semgrep/semgrep/semgrep_main.py", "diffHunk": "@@ -46,12 +47,12 @@ def validate_single_rule(config_id: str, rule: Dict[str, Any]) -> Optional[Rule]\n     if not rule_keys.issubset(YAML_ALL_VALID_RULE_KEYS):\n         extra_keys = rule_keys - YAML_ALL_VALID_RULE_KEYS\n         print_error(\n-            f\"{config_id} has invalid rule key {extra_keys} at rule id {rule_id_err_msg}, can only have: {YAML_ALL_VALID_RULE_KEYS}\"\n+            f\"{config_id} has an invalid top-level rule key {extra_keys} at rule id {rule_id_err_msg}, can only have: {sorted(YAML_ALL_VALID_RULE_KEYS)}\"", "originalCommit": "5c117658bb16d341cd511911e8c315329272caef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4MDEzNw==", "url": "https://github.com/returntocorp/semgrep/pull/916#discussion_r435480137", "bodyText": "It doesn't really make sense to raise SemgrepError here since we're in the tests.", "author": "mschwager", "createdAt": "2020-06-04T18:51:51Z", "path": "semgrep/semgrep/test.py", "diffHunk": "@@ -307,7 +306,7 @@ def main(\n def test_main(args: argparse.Namespace) -> None:\n     _test_compute_confusion_matrix()\n     if len(args.target) != 1:\n-        print_error_exit(\"only one target directory allowed for tests\")\n+        raise Exception(\"only one target directory allowed for tests\")", "originalCommit": "5c117658bb16d341cd511911e8c315329272caef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b6fa36be2fd5c7e0e288421d49fd138eb7c250c2", "url": "https://github.com/returntocorp/semgrep/commit/b6fa36be2fd5c7e0e288421d49fd138eb7c250c2", "message": "Remove print_error_exit in favor of using exceptions", "committedDate": "2020-06-04T19:50:15Z", "type": "commit"}, {"oid": "8c9d64507b51a2b1aaed1b6851273ae25a372a16", "url": "https://github.com/returntocorp/semgrep/commit/8c9d64507b51a2b1aaed1b6851273ae25a372a16", "message": "Move EXIT_CODEs to error.py and correct default error code from 1 -> 2", "committedDate": "2020-06-04T19:50:15Z", "type": "commit"}, {"oid": "8c9d64507b51a2b1aaed1b6851273ae25a372a16", "url": "https://github.com/returntocorp/semgrep/commit/8c9d64507b51a2b1aaed1b6851273ae25a372a16", "message": "Move EXIT_CODEs to error.py and correct default error code from 1 -> 2", "committedDate": "2020-06-04T19:50:15Z", "type": "forcePushed"}, {"oid": "6594620f87e92b9a6769ae58ddf69b9bbf408fa0", "url": "https://github.com/returntocorp/semgrep/commit/6594620f87e92b9a6769ae58ddf69b9bbf408fa0", "message": "Remove unused import", "committedDate": "2020-06-04T19:54:54Z", "type": "commit"}]}