{"pr_number": 382, "pr_title": "Allow publishing release candidate versions", "pr_createdAt": "2020-08-14T00:26:25Z", "pr_url": "https://github.com/linkedin/rest.li/pull/382", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM0OTM4NQ==", "url": "https://github.com/linkedin/rest.li/pull/382#discussion_r470349385", "bodyText": "Does it mean if TARGET is at non-master branch, then it can be released as a rc?", "author": "BrianPin", "createdAt": "2020-08-14T00:59:32Z", "path": "scripts/help-text/release.txt", "diffHunk": "@@ -1,9 +1,13 @@\n Usage: ./scripts/release [OPTION]... [TARGET_COMMIT]\n-Releases a new version of Rest.li by creating and pushing a tag at TARGET_COMMIT (defaults to HEAD).\n-This script must be run from the root project directory.\n+Releases a new version of Rest.li by creating and pushing a tag at TARGET_COMMIT (defaults to HEAD). This script must be\n+run from the root project directory. TARGET_COMMIT must be an ancestor of master, unless the version being released is a\n+release candidate version.", "originalCommit": "2a3501d97d6186e3fa1272e4305c8338c29aef2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3NjYzNA==", "url": "https://github.com/linkedin/rest.li/pull/382#discussion_r470376634", "bodyText": "It means:\n\nNormal releases must be an ancestor of master.\nCandidate releases can be on any branch.", "author": "evanw555", "createdAt": "2020-08-14T02:31:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM0OTM4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2MjQxNA==", "url": "https://github.com/linkedin/rest.li/pull/382#discussion_r470362414", "bodyText": "Just curious, when we release a rc, the prefix version should be in the future or in the past?\nI think the common should be:\nsay we are now at v0.1\nwe are going to v0.2 but have some rc,\nso we have\nv0.2-rc1\nv0.2-rc2\nthen when everything works,\nv0.2 is the released.\nWe shall have more rc\\d  and probably the prefix version string should never happened?\nI verified other rc conventions by looking at linux\nhttps://github.com/torvalds/linux/releases", "author": "BrianPin", "createdAt": "2020-08-14T01:29:52Z", "path": "scripts/release", "diffHunk": "@@ -45,9 +43,64 @@ if [ -z \"$VERSION\" ]; then\n   exit 1\n fi\n \n+# Determine if the version is a release candidate version\n+RELEASE_CANDIDATE=false\n+if [[ \"$VERSION\" =~ ^[0-9]+\\.[0-9]+\\.[0-9]+-rc\\.[0-9]+$ ]]; then\n+  RELEASE_CANDIDATE=true\n+fi\n+\n+# Ensure that the target commit is an ancestor of master\n+git merge-base --is-ancestor $TARGET_COMMIT master\n+if [ $? != 0 ]; then\n+  if $RELEASE_CANDIDATE; then\n+    # Since this is a release candidate, allow it with a warning and confirmation\n+    echo -n \"You're attempting to publish a release candidate from a non-master branch. Are you sure you want to do this? (y/N) \"\n+    read ANSWER\n+    if [[ ! \"$ANSWER\" =~ ^[yY]+$ ]]; then\n+      echo 'Aborting...'\n+      exit 1\n+    fi\n+  else\n+    # In the general case, don't allow it\n+    echo \"Invalid target: $TARGET\"\n+    echo 'Please select a target commit which is an ancestor of master.'\n+    exit 1\n+  fi\n+fi\n+\n+# Update local tags\n+echo -n 'Updating local tags via remote fetch... '\n+git fetch origin > /dev/null 2>&1\n+echo 'done'\n+\n+# Perform some release candidate assertions, if applicable\n+if $RELEASE_CANDIDATE; then\n+  SUFFIXLESS_VERSION=${VERSION%-*}\n+  # Assert that this release candidate precedes the associated release\n+  if [ \"$(git tag --list v$SUFFIXLESS_VERSION)\" ]; then\n+    echo \"Cannot create release candidate $VERSION, as a release for $SUFFIXLESS_VERSION already exists.\"\n+    echo \"Release candidates must come before proper releases, so please bump the project version in $PROPERTIES_FILE and try again.\"\n+    exit 1\n+  fi\n+  # Assert that there exists no available lower RC number (e.g. don't allow 1.2.3-rc.2 if 1.2.3-rc.1 is available)\n+  RC_NUMBER=1\n+  while true; do\n+    RC_VERSION=\"$SUFFIXLESS_VERSION-rc.$RC_NUMBER\"\n+    # Break once we've reached the current RC number\n+    if [ \"$VERSION\" = \"$RC_VERSION\" ]; then break; fi\n+    # If this rc number is available,\n+    if [ -z \"$(git tag --list \"v$RC_VERSION\")\" ]; then\n+      echo \"Cannot create release candidate $VERSION, as $RC_VERSION doesn't exist.\"", "originalCommit": "2a3501d97d6186e3fa1272e4305c8338c29aef2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3NzM0NQ==", "url": "https://github.com/linkedin/rest.li/pull/382#discussion_r470377345", "bodyText": "I agree with your assessment, that's how it should be. The release script is designed with this pattern in mind, and it fails in the following cases:\n\nTrying to release 0.1-rc.1 after 0.1 has already been released (line 81)\nTrying to release 0.1-rc.2 before 0.1-rc.1 has been released (applies for any combination of numbers; line 93)\n\nThe logic you've highlighted is the latter.", "author": "evanw555", "createdAt": "2020-08-14T02:35:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2MjQxNA=="}], "type": "inlineReview"}, {"oid": "b72a74188ecd95e5050e0273c0bf9cec1bbb2aa4", "url": "https://github.com/linkedin/rest.li/commit/b72a74188ecd95e5050e0273c0bf9cec1bbb2aa4", "message": "Allow publishing release candidate versions\n\nThis change will allow the maintainers of Rest.li to publish release\ncandidate versions (e.g. 1.2.3-rc.1) from non-master branches in order\nto test experimental features in a safe way as dictated by industry\nconvention as per the SemVer spec. Also cleans up the changelog a bit.", "committedDate": "2020-08-15T02:30:24Z", "type": "commit"}, {"oid": "b72a74188ecd95e5050e0273c0bf9cec1bbb2aa4", "url": "https://github.com/linkedin/rest.li/commit/b72a74188ecd95e5050e0273c0bf9cec1bbb2aa4", "message": "Allow publishing release candidate versions\n\nThis change will allow the maintainers of Rest.li to publish release\ncandidate versions (e.g. 1.2.3-rc.1) from non-master branches in order\nto test experimental features in a safe way as dictated by industry\nconvention as per the SemVer spec. Also cleans up the changelog a bit.", "committedDate": "2020-08-15T02:30:24Z", "type": "forcePushed"}]}