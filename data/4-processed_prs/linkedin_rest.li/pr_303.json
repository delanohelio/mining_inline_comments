{"pr_number": 303, "pr_title": "Handle valueClass NPE issue and give warnings", "pr_createdAt": "2020-05-19T23:57:31Z", "pr_url": "https://github.com/linkedin/rest.li/pull/303", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3OTc1Mg==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r427679752", "bodyText": "nit: A bit suggestion on the grammar:\nwe expect the return type to be 'Record' \nOtherwise looks good to me.", "author": "junchuanwang", "createdAt": "2020-05-20T00:45:42Z", "path": "restli-server/src/main/java/com/linkedin/restli/internal/server/model/RestLiAnnotationReader.java", "diffHunk": "@@ -2595,6 +2595,13 @@ private static void validateFinderMethod(final ResourceMethodDescriptor finderMe\n     Method method = finderMethodDescriptor.getMethod();\n     Class<?> valueClass = resourceModel.getValueClass();\n \n+    if (valueClass == null)\n+    {\n+      throw new ResourceConfigException(\"@Finder method '\" + method.getName()\n+          + \"' on class '\" + resourceModel.getResourceClass().getName()\n+          + \"' has an invalid return type, we expect return type to be a record '\");", "originalCommit": "495242fa4143fd692b7c65d68e1ae0477dc59ecc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4MTU1OQ==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r427681559", "bodyText": "I agree with Junchuan, however this seems to imply that the return type must be exactly Record. I'd suggest just copying the phrasing from other exceptions in this file: The return type must be a RecordTemplate.", "author": "evanw555", "createdAt": "2020-05-20T00:52:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3OTc1Mg=="}], "type": "inlineReview"}, {"oid": "9bd6f28c3a8151d8b74b703c21ddace554045f10", "url": "https://github.com/linkedin/rest.li/commit/9bd6f28c3a8151d8b74b703c21ddace554045f10", "message": "Handling NPE for finder resources using non-RecordTemplate classes", "committedDate": "2020-05-21T00:36:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkzOTM3Mg==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r428939372", "bodyText": "nit : brace should be in the following line.", "author": "nickibi", "createdAt": "2020-05-21T21:59:41Z", "path": "restli-server/src/test/java/com/linkedin/restli/internal/server/model/TestRestLiApiBuilder.java", "diffHunk": "@@ -198,4 +198,33 @@ public void testActionReturnType(Class<?> resourceClass, Class<?> expectedAction\n       Assert.assertEquals(resourceMethodDescriptor.getActionReturnType(), expectedActionReturnType);\n     }\n   }\n+\n+  @DataProvider(name = \"unstructuredFinderReturnTypeData\")\n+  private Object[][] unstructuredFinderReturnTypeData()\n+  {\n+    return new Object[][]\n+        {\n+            {fooBarFinderResource.class, \"The return type must be a RecordTemplate\"}\n+        };\n+  }\n+\n+  /**\n+   * Ensures that when finder methods are processed, if the return type is not of a Record, then it will be warned.\n+   * For instance, it should recognize that the \"logical\" return type for a method\n+   * {@code Task<ActionResult<String>> doFoo();} is {@code String.class}.\n+   *\n+   * @param resourceClass resource used as an input\n+   */\n+  @Test(dataProvider = \"unstructuredFinderReturnTypeData\")\n+  public void testFinderUnsupportedReturnType(Class<?> resourceClass, String expectedPartialMessage)\n+  {\n+    try {", "originalCommit": "7a551a716c2e0c59ff09336c0df8e50dc6515bc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MTk2Ng==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r428941966", "bodyText": "nit: same here", "author": "nickibi", "createdAt": "2020-05-21T22:06:13Z", "path": "restli-server/src/test/java/com/linkedin/restli/internal/server/model/TestRestLiApiBuilder.java", "diffHunk": "@@ -198,4 +198,33 @@ public void testActionReturnType(Class<?> resourceClass, Class<?> expectedAction\n       Assert.assertEquals(resourceMethodDescriptor.getActionReturnType(), expectedActionReturnType);\n     }\n   }\n+\n+  @DataProvider(name = \"unstructuredFinderReturnTypeData\")\n+  private Object[][] unstructuredFinderReturnTypeData()\n+  {\n+    return new Object[][]\n+        {\n+            {fooBarFinderResource.class, \"The return type must be a RecordTemplate\"}\n+        };\n+  }\n+\n+  /**\n+   * Ensures that when finder methods are processed, if the return type is not of a Record, then it will be warned.\n+   * For instance, it should recognize that the \"logical\" return type for a method\n+   * {@code Task<ActionResult<String>> doFoo();} is {@code String.class}.\n+   *\n+   * @param resourceClass resource used as an input\n+   */\n+  @Test(dataProvider = \"unstructuredFinderReturnTypeData\")\n+  public void testFinderUnsupportedReturnType(Class<?> resourceClass, String expectedPartialMessage)\n+  {\n+    try {\n+      RestLiApiBuilder.buildResourceModels(Collections.singleton(resourceClass));\n+      Assert.fail(\"For the finder resource class with a non RecordTemplate sub class, we shall throw an exception\");\n+    } catch (ResourceConfigException resourceConfigException) {", "originalCommit": "7a551a716c2e0c59ff09336c0df8e50dc6515bc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk0MjcwMg==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r428942702", "bodyText": "nit: space before and after \"=\"", "author": "nickibi", "createdAt": "2020-05-21T22:08:07Z", "path": "restli-server/src/test/java/com/linkedin/restli/internal/server/model/SampleResources.java", "diffHunk": "@@ -759,4 +761,16 @@ public void AttachmentParamsIncorrectDataTypeAction(@RestLiAttachmentsParam Stri\n \n   @RestLiCollection(name = \"collectionComplexKeyTask\")\n   class CollectionComplexKeyTask extends ComplexKeyResourceTaskTemplate<EmptyRecord, EmptyRecord, EmptyRecord> {}\n+\n+  @RestLiCollection(name=\"lucky\",keyName=\"dayOfWeek\")", "originalCommit": "7a551a716c2e0c59ff09336c0df8e50dc6515bc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4NDY5MA==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r428984690", "bodyText": "nit: extra space after \"{\" and before \"}\"", "author": "nickibi", "createdAt": "2020-05-22T00:33:41Z", "path": "restli-server/src/test/java/com/linkedin/restli/internal/server/model/TestRestLiApiBuilder.java", "diffHunk": "@@ -198,4 +198,33 @@ public void testActionReturnType(Class<?> resourceClass, Class<?> expectedAction\n       Assert.assertEquals(resourceMethodDescriptor.getActionReturnType(), expectedActionReturnType);\n     }\n   }\n+\n+  @DataProvider(name = \"unstructuredFinderReturnTypeData\")\n+  private Object[][] unstructuredFinderReturnTypeData()\n+  {\n+    return new Object[][]\n+        {\n+            {fooBarFinderResource.class, \"The return type must be a RecordTemplate\"}", "originalCommit": "7a551a716c2e0c59ff09336c0df8e50dc6515bc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4NTk3NQ==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r428985975", "bodyText": "Do you think \"return Collections.singletonList(\"gotLuck!\")\" is cleaner?", "author": "nickibi", "createdAt": "2020-05-22T00:38:59Z", "path": "restli-server/src/test/java/com/linkedin/restli/internal/server/model/SampleResources.java", "diffHunk": "@@ -759,4 +761,16 @@ public void AttachmentParamsIncorrectDataTypeAction(@RestLiAttachmentsParam Stri\n \n   @RestLiCollection(name = \"collectionComplexKeyTask\")\n   class CollectionComplexKeyTask extends ComplexKeyResourceTaskTemplate<EmptyRecord, EmptyRecord, EmptyRecord> {}\n+\n+  @RestLiCollection(name=\"lucky\",keyName=\"dayOfWeek\")\n+  public class fooBarFinderResource extends UnstructuredDataCollectionResourceTemplate<Integer>\n+  {\n+    @Finder(\"findFooBar\")\n+    public List<String> findLucky(@PagingContextParam final PagingContext context, @QueryParam(\"dayOfWeek\") Integer dayOfWeek) throws Exception\n+    {\n+      List<String> res = new LinkedList<>();\n+      res.add(\"gotLuck!\");\n+      return res;", "originalCommit": "7a551a716c2e0c59ff09336c0df8e50dc6515bc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA2MTQ4MQ==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r429061481", "bodyText": "nits:\n\neither make the T lowercase or replace the preceding comma with a period.\nremove the dangling ' at the end of the message.", "author": "evanw555", "createdAt": "2020-05-22T06:16:18Z", "path": "restli-server/src/main/java/com/linkedin/restli/internal/server/model/RestLiAnnotationReader.java", "diffHunk": "@@ -2595,6 +2595,13 @@ private static void validateFinderMethod(final ResourceMethodDescriptor finderMe\n     Method method = finderMethodDescriptor.getMethod();\n     Class<?> valueClass = resourceModel.getValueClass();\n \n+    if (valueClass == null)\n+    {\n+      throw new ResourceConfigException(\"@Finder method '\" + method.getName()\n+          + \"' on class '\" + resourceModel.getResourceClass().getName()\n+          + \"' has an invalid return type, The return type must be a RecordTemplate'\");", "originalCommit": "7a551a716c2e0c59ff09336c0df8e50dc6515bc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA2MjgxNg==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r429062816", "bodyText": "Given that this file is bloated with resource classes, I'd suggest naming this something meaningful to clarify what it's testing. I'd suggest _____Resource where the prefix describes what scenario it covers (e.g. NonRecordFinderResource or UnsupportedReturnTypeFinderResource)", "author": "evanw555", "createdAt": "2020-05-22T06:20:37Z", "path": "restli-server/src/test/java/com/linkedin/restli/internal/server/model/SampleResources.java", "diffHunk": "@@ -759,4 +761,16 @@ public void AttachmentParamsIncorrectDataTypeAction(@RestLiAttachmentsParam Stri\n \n   @RestLiCollection(name = \"collectionComplexKeyTask\")\n   class CollectionComplexKeyTask extends ComplexKeyResourceTaskTemplate<EmptyRecord, EmptyRecord, EmptyRecord> {}\n+\n+  @RestLiCollection(name=\"lucky\",keyName=\"dayOfWeek\")\n+  public class fooBarFinderResource extends UnstructuredDataCollectionResourceTemplate<Integer>", "originalCommit": "7a551a716c2e0c59ff09336c0df8e50dc6515bc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA2MzUzOA==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r429063538", "bodyText": "I'd recommend avoiding the term \"unstructured\" here, since it may be confused with another Rest.li feature (\"unstructured data resource\")", "author": "evanw555", "createdAt": "2020-05-22T06:22:58Z", "path": "restli-server/src/test/java/com/linkedin/restli/internal/server/model/TestRestLiApiBuilder.java", "diffHunk": "@@ -198,4 +198,33 @@ public void testActionReturnType(Class<?> resourceClass, Class<?> expectedAction\n       Assert.assertEquals(resourceMethodDescriptor.getActionReturnType(), expectedActionReturnType);\n     }\n   }\n+\n+  @DataProvider(name = \"unstructuredFinderReturnTypeData\")\n+  private Object[][] unstructuredFinderReturnTypeData()", "originalCommit": "7a551a716c2e0c59ff09336c0df8e50dc6515bc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA2Mzg4NQ==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r429063885", "bodyText": "Given that there's only one case being tested, it's acceptable to hard code the inputs rather than using a data provider. Caveat would be if this case will likely get extended. Your call.", "author": "evanw555", "createdAt": "2020-05-22T06:24:10Z", "path": "restli-server/src/test/java/com/linkedin/restli/internal/server/model/TestRestLiApiBuilder.java", "diffHunk": "@@ -198,4 +198,33 @@ public void testActionReturnType(Class<?> resourceClass, Class<?> expectedAction\n       Assert.assertEquals(resourceMethodDescriptor.getActionReturnType(), expectedActionReturnType);\n     }\n   }\n+\n+  @DataProvider(name = \"unstructuredFinderReturnTypeData\")\n+  private Object[][] unstructuredFinderReturnTypeData()\n+  {\n+    return new Object[][]\n+        {\n+            {fooBarFinderResource.class, \"The return type must be a RecordTemplate\"}\n+        };\n+  }\n+\n+  /**\n+   * Ensures that when finder methods are processed, if the return type is not of a Record, then it will be warned.\n+   * For instance, it should recognize that the \"logical\" return type for a method\n+   * {@code Task<ActionResult<String>> doFoo();} is {@code String.class}.\n+   *\n+   * @param resourceClass resource used as an input\n+   */\n+  @Test(dataProvider = \"unstructuredFinderReturnTypeData\")", "originalCommit": "7a551a716c2e0c59ff09336c0df8e50dc6515bc4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2OTc5OQ==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r429369799", "bodyText": "I will add more resources class to test since it addresses this concern and also provide more coverage", "author": "BrianPin", "createdAt": "2020-05-22T17:28:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA2Mzg4NQ=="}], "type": "inlineReview"}, {"oid": "022a8e986e7791f67e005d4e410cef4453cc6733", "url": "https://github.com/linkedin/rest.li/commit/022a8e986e7791f67e005d4e410cef4453cc6733", "message": "Address testShutdownRequestOutstanding failure by following flaky test processing", "committedDate": "2020-05-22T17:01:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY4MDU0MQ==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r430680541", "bodyText": "Fix the error message", "author": "karthikbalasub", "createdAt": "2020-05-26T20:12:52Z", "path": "restli-server/src/main/java/com/linkedin/restli/internal/server/model/RestLiAnnotationReader.java", "diffHunk": "@@ -2595,6 +2626,12 @@ private static void validateFinderMethod(final ResourceMethodDescriptor finderMe\n     Method method = finderMethodDescriptor.getMethod();\n     Class<?> valueClass = resourceModel.getValueClass();\n \n+    if (valueClass == null)\n+    {\n+      throw new ResourceConfigException(\"Class '\" + resourceModel.getResourceClass().getName()\n+          + \"' is not supported for @Finder method\");", "originalCommit": "52bceeeceb1485b894f852d70d0ca1d94a1d5d70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc4MDE2Mg==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r430780162", "bodyText": "I suppose it is meant to remove \"for\"", "author": "BrianPin", "createdAt": "2020-05-27T00:31:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY4MDU0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY4MjUwMg==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r430682502", "bodyText": "You can use the expectedExceptions and expectedExceptionsMessageRegExp attributes of the @test annotation", "author": "karthikbalasub", "createdAt": "2020-05-26T20:16:37Z", "path": "restli-server/src/test/java/com/linkedin/restli/internal/server/model/TestRestLiApiBuilder.java", "diffHunk": "@@ -198,4 +198,62 @@ public void testActionReturnType(Class<?> resourceClass, Class<?> expectedAction\n       Assert.assertEquals(resourceMethodDescriptor.getActionReturnType(), expectedActionReturnType);\n     }\n   }\n+\n+  @DataProvider(name = \"unsupportedFinderResourceTypeData\")\n+  private Object[][] unsupportedFinderResourceTypeData()\n+  {\n+    return new Object[][]\n+        {\n+            { FinderUnsupportedKeyUnstructuredDataResource.class, \"KeyUnstructuredDataResource class does not support for @Finder methods\" },\n+            { FinderUnsupportedSingleUnstructuredDataResource.class, \"SingleUnstructuredDataResource class does not support for @Finder methods\" }\n+        };\n+  }\n+\n+  /**\n+   * Ensures that when finder methods are processed, if the return type is not of a Record, then it will be warned.\n+   * For instance, it should recognize that the \"logical\" return type for a method\n+   * {@code Task<ActionResult<String>> doFoo();} is {@code String.class}.\n+   *\n+   * @param resourceClass resource used as an input\n+   */\n+  @Test(dataProvider = \"unsupportedFinderResourceTypeData\")\n+  public void testFinderUnsupportedResourceType(Class<?> resourceClass, String expectedPartialMessage)\n+  {\n+    try\n+    {\n+      RestLiApiBuilder.buildResourceModels(Collections.singleton(resourceClass));\n+      Assert.fail(\"For the finder resource class with a non RecordTemplate sub class, we shall throw an exception\");\n+    }\n+    catch (ResourceConfigException resourceConfigException)\n+    {\n+      Assert.assertTrue(resourceConfigException.getMessage().contains(expectedPartialMessage),\n+          String.format(\"Expected %s with message containing \\\"%s\\\" but instead found message \\\"%s\\\"\",\n+              ResourceConfigException.class.getSimpleName(), expectedPartialMessage, resourceConfigException.getMessage()));\n+    }\n+  }\n+\n+  @DataProvider(name = \"finderSupportedResourceTypeData\")\n+  private Object[][] finderSupportedResourceTypeData()\n+  {\n+    return new Object[][]\n+        {\n+            { FinderSupportedAssociationDataResource.class },\n+            { FinderSupportedComplexKeyDataResource.class },\n+            { FinderWithActionResource.class }\n+        };\n+  }\n+\n+  @Test(dataProvider = \"finderSupportedResourceTypeData\")\n+  public void testFinderSupportedResourceType(Class<?> resourceClass)", "originalCommit": "52bceeeceb1485b894f852d70d0ca1d94a1d5d70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc4Mjk0OQ==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r430782949", "bodyText": "This test is to ensure other resources classes other then the: [KeyUnstructuredDataResource, SingleUnstructuredDataResource] are not getting an exception, so the code in the test is not expecting exceptions. But the annotation of the two you suggested I will put them in my first test which there it expects exceptions.", "author": "BrianPin", "createdAt": "2020-05-27T00:41:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY4MjUwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY4Mjg2Nw==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r430682867", "bodyText": "nit: remove \"for\"\n.. does not support @finder methods\"", "author": "karthikbalasub", "createdAt": "2020-05-26T20:17:19Z", "path": "restli-server/src/main/java/com/linkedin/restli/internal/server/model/RestLiAnnotationReader.java", "diffHunk": "@@ -554,6 +554,20 @@ else if (KeyUnstructuredDataResource.class.isAssignableFrom(collectionResourceCl\n         @SuppressWarnings(\"unchecked\")\n         Class<? extends KeyUnstructuredDataResource<?>> clazz = (Class<? extends KeyUnstructuredDataResource<?>>) collectionResourceClass;\n         actualTypeArguments = ReflectionUtils.getTypeArgumentsParametrized(KeyUnstructuredDataResource.class, clazz);\n+        for (Method method : collectionResourceClass.getDeclaredMethods())\n+        {\n+          if (method.isSynthetic())\n+          {\n+            continue;\n+          }\n+          Finder finderAnno = method.getAnnotation(Finder.class);\n+          if (finderAnno == null)\n+          {\n+            continue;\n+          }\n+          throw new ResourceConfigException(\"Class '\" + collectionResourceClass.getName() + \"' of a\"\n+              + \"KeyUnstructuredDataResource class does not support for @Finder methods\");", "originalCommit": "52bceeeceb1485b894f852d70d0ca1d94a1d5d70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY4MjkyOQ==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r430682929", "bodyText": "nit: remove \"for\"\n.. does not support @finder methods\"", "author": "karthikbalasub", "createdAt": "2020-05-26T20:17:25Z", "path": "restli-server/src/main/java/com/linkedin/restli/internal/server/model/RestLiAnnotationReader.java", "diffHunk": "@@ -665,6 +679,23 @@ private static ResourceModel processSimpleResource(final Class<?> resourceClass,\n       List<Class<?>> kvParams = ReflectionUtils.getTypeArguments(SingleObjectResource.class, clazz);\n       valueClass = kvParams.get(0).asSubclass(RecordTemplate.class);\n     }\n+    else\n+    {\n+      for (Method method : resourceClass.getDeclaredMethods())\n+      {\n+        if (method.isSynthetic())\n+        {\n+          continue;\n+        }\n+        Finder finderAnno = method.getAnnotation(Finder.class);\n+        if (finderAnno == null)\n+        {\n+          continue;\n+        }\n+        throw new ResourceConfigException(\"Class '\" + resourceClass.getName() + \"' of a SingleUnstructuredDataResource \"\n+            + \"class does not support for @Finder methods\");", "originalCommit": "52bceeeceb1485b894f852d70d0ca1d94a1d5d70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwNDY0NQ==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r430904645", "bodyText": "nit: this should be \"does not support @finder\"", "author": "karthikbalasub", "createdAt": "2020-05-27T07:16:08Z", "path": "restli-server/src/main/java/com/linkedin/restli/internal/server/model/RestLiAnnotationReader.java", "diffHunk": "@@ -2629,7 +2629,7 @@ private static void validateFinderMethod(final ResourceMethodDescriptor finderMe\n     if (valueClass == null)\n     {\n       throw new ResourceConfigException(\"Class '\" + resourceModel.getResourceClass().getName()\n-          + \"' is not supported for @Finder method\");\n+          + \"' is not supported @Finder method\");", "originalCommit": "1aa8d8fc46b95a7856af8401be77990a6ab64774", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwNTAwOA==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r430905008", "bodyText": "Not needed as the test framework would fail if expected exception is not thrown", "author": "karthikbalasub", "createdAt": "2020-05-27T07:16:53Z", "path": "restli-server/src/test/java/com/linkedin/restli/internal/server/model/TestRestLiApiBuilder.java", "diffHunk": "@@ -216,20 +216,13 @@ public void testActionReturnType(Class<?> resourceClass, Class<?> expectedAction\n    *\n    * @param resourceClass resource used as an input\n    */\n-  @Test(dataProvider = \"unsupportedFinderResourceTypeData\")\n+  @Test(dataProvider = \"unsupportedFinderResourceTypeData\",\n+      expectedExceptions = ResourceConfigException.class,\n+      expectedExceptionsMessageRegExp = \"Class '.*' of a ((SingleUnstructuredDataResource)|(KeyUnstructuredDataResource)) class does not support @Finder methods\")\n   public void testFinderUnsupportedResourceType(Class<?> resourceClass, String expectedPartialMessage)\n   {\n-    try\n-    {\n-      RestLiApiBuilder.buildResourceModels(Collections.singleton(resourceClass));\n-      Assert.fail(\"For the finder resource class with a non RecordTemplate sub class, we shall throw an exception\");\n-    }\n-    catch (ResourceConfigException resourceConfigException)\n-    {\n-      Assert.assertTrue(resourceConfigException.getMessage().contains(expectedPartialMessage),\n-          String.format(\"Expected %s with message containing \\\"%s\\\" but instead found message \\\"%s\\\"\",\n-              ResourceConfigException.class.getSimpleName(), expectedPartialMessage, resourceConfigException.getMessage()));\n-    }\n+    RestLiApiBuilder.buildResourceModels(Collections.singleton(resourceClass));\n+    Assert.fail(\"For the finder resource class with a non RecordTemplate sub class, we shall throw an exception\");", "originalCommit": "1aa8d8fc46b95a7856af8401be77990a6ab64774", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0957d7533acadfff5e8d5ad1cefe1158d418ae66", "url": "https://github.com/linkedin/rest.li/commit/0957d7533acadfff5e8d5ad1cefe1158d418ae66", "message": "Handling NPE for finder resources using non-RecordTemplate classes", "committedDate": "2020-05-28T03:50:41Z", "type": "commit"}, {"oid": "1b0200cb9a537f54bc7c0574c61621290d677c5b", "url": "https://github.com/linkedin/rest.li/commit/1b0200cb9a537f54bc7c0574c61621290d677c5b", "message": "Address testShutdownRequestOutstanding failure by following flaky test processing", "committedDate": "2020-05-28T03:50:41Z", "type": "commit"}, {"oid": "56cb228b7aa7974eca22284ef30501f058857b37", "url": "https://github.com/linkedin/rest.li/commit/56cb228b7aa7974eca22284ef30501f058857b37", "message": "Address comments", "committedDate": "2020-05-28T03:50:41Z", "type": "commit"}, {"oid": "dcc1872eae620bf6748d6b7aea4fb89870749d81", "url": "https://github.com/linkedin/rest.li/commit/dcc1872eae620bf6748d6b7aea4fb89870749d81", "message": "Fix wording from return type to unstructured resources", "committedDate": "2020-05-28T03:50:41Z", "type": "commit"}, {"oid": "82d584080292956c143a0ef4ce240f57ef028b40", "url": "https://github.com/linkedin/rest.li/commit/82d584080292956c143a0ef4ce240f57ef028b40", "message": "Change to stop the process early when we find out there is finder method in SingleUnstructuredDataResource or KeyUnstructuredDataResource also make valueClass NPE check result message generic", "committedDate": "2020-05-28T03:50:42Z", "type": "commit"}, {"oid": "d3a3267129d67364dd82f1d1cb0107eff8b75932", "url": "https://github.com/linkedin/rest.li/commit/d3a3267129d67364dd82f1d1cb0107eff8b75932", "message": "Add 3 supported resouce class in unit test, fix over the 2 unsupported resource class for finder in unit test", "committedDate": "2020-05-28T03:50:42Z", "type": "commit"}, {"oid": "0439b7eb03324960cb9609b312fbfc1f452b8c49", "url": "https://github.com/linkedin/rest.li/commit/0439b7eb03324960cb9609b312fbfc1f452b8c49", "message": "for wc-test", "committedDate": "2020-05-28T03:50:42Z", "type": "commit"}, {"oid": "13e152d478e7b79468698a0de07a9833ab2c27bb", "url": "https://github.com/linkedin/rest.li/commit/13e152d478e7b79468698a0de07a9833ab2c27bb", "message": "Change the version to a proper format", "committedDate": "2020-05-28T03:50:42Z", "type": "commit"}, {"oid": "4fe0af476cfaaebf809a0323fca4df65a7d36080", "url": "https://github.com/linkedin/rest.li/commit/4fe0af476cfaaebf809a0323fca4df65a7d36080", "message": "Addressing Karthik's comments", "committedDate": "2020-05-28T03:50:42Z", "type": "commit"}, {"oid": "dbdaed1026cd5c700b09fdcd823f0d6c5099fc4f", "url": "https://github.com/linkedin/rest.li/commit/dbdaed1026cd5c700b09fdcd823f0d6c5099fc4f", "message": "Addressing wording in the case where valueClass is null, also remove redundant assert in testing", "committedDate": "2020-05-28T03:50:42Z", "type": "commit"}, {"oid": "dbdaed1026cd5c700b09fdcd823f0d6c5099fc4f", "url": "https://github.com/linkedin/rest.li/commit/dbdaed1026cd5c700b09fdcd823f0d6c5099fc4f", "message": "Addressing wording in the case where valueClass is null, also remove redundant assert in testing", "committedDate": "2020-05-28T03:50:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExNzAxOA==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r432117018", "bodyText": "If you're using expectedExceptionsMessageRegExp, then you don't need the second parameter anymore. You can also remove it from the data provider.", "author": "evanw555", "createdAt": "2020-05-28T20:53:34Z", "path": "restli-server/src/test/java/com/linkedin/restli/internal/server/model/TestRestLiApiBuilder.java", "diffHunk": "@@ -198,4 +198,54 @@ public void testActionReturnType(Class<?> resourceClass, Class<?> expectedAction\n       Assert.assertEquals(resourceMethodDescriptor.getActionReturnType(), expectedActionReturnType);\n     }\n   }\n+\n+  @DataProvider(name = \"unsupportedFinderResourceTypeData\")\n+  private Object[][] unsupportedFinderResourceTypeData()\n+  {\n+    return new Object[][]\n+        {\n+            { FinderUnsupportedKeyUnstructuredDataResource.class, \"KeyUnstructuredDataResource class does not support @Finder methods\" },\n+            { FinderUnsupportedSingleUnstructuredDataResource.class, \"SingleUnstructuredDataResource class does not support @Finder methods\" }\n+        };\n+  }\n+\n+  /**\n+   * Ensures that when finder methods are processed, if the return type is not of a Record, then it will be warned.\n+   * For instance, it should recognize that the \"logical\" return type for a method\n+   * {@code Task<ActionResult<String>> doFoo();} is {@code String.class}.\n+   *\n+   * @param resourceClass resource used as an input\n+   */\n+  @Test(dataProvider = \"unsupportedFinderResourceTypeData\",\n+      expectedExceptions = ResourceConfigException.class,\n+      expectedExceptionsMessageRegExp = \"Class '.*' of a ((SingleUnstructuredDataResource)|(KeyUnstructuredDataResource)) class does not support @Finder methods\")\n+  public void testFinderUnsupportedResourceType(Class<?> resourceClass, String expectedPartialMessage)", "originalCommit": "dbdaed1026cd5c700b09fdcd823f0d6c5099fc4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExNzQyNA==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r432117424", "bodyText": "This javadoc is out-of-date", "author": "evanw555", "createdAt": "2020-05-28T20:54:23Z", "path": "restli-server/src/test/java/com/linkedin/restli/internal/server/model/TestRestLiApiBuilder.java", "diffHunk": "@@ -198,4 +198,54 @@ public void testActionReturnType(Class<?> resourceClass, Class<?> expectedAction\n       Assert.assertEquals(resourceMethodDescriptor.getActionReturnType(), expectedActionReturnType);\n     }\n   }\n+\n+  @DataProvider(name = \"unsupportedFinderResourceTypeData\")\n+  private Object[][] unsupportedFinderResourceTypeData()\n+  {\n+    return new Object[][]\n+        {\n+            { FinderUnsupportedKeyUnstructuredDataResource.class, \"KeyUnstructuredDataResource class does not support @Finder methods\" },\n+            { FinderUnsupportedSingleUnstructuredDataResource.class, \"SingleUnstructuredDataResource class does not support @Finder methods\" }\n+        };\n+  }\n+\n+  /**\n+   * Ensures that when finder methods are processed, if the return type is not of a Record, then it will be warned.", "originalCommit": "dbdaed1026cd5c700b09fdcd823f0d6c5099fc4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE5MjQ3OQ==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r432192479", "bodyText": "I re-write it to \"Ensures that when finder methods are processed, when the resource value class is a SingleUnstructuredDataResource or a KeyUnstructuredDataResource, we will end up with a ResourceConfigException because we don't support that righ tnow.\" Hope that seems like a good doc string.", "author": "BrianPin", "createdAt": "2020-05-29T00:19:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExNzQyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExODc0Mw==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r432118743", "bodyText": "Where's the @finder method? Also you can do public class to be consistent with the other classes here.", "author": "evanw555", "createdAt": "2020-05-28T20:56:58Z", "path": "restli-server/src/test/java/com/linkedin/restli/internal/server/model/SampleResources.java", "diffHunk": "@@ -759,4 +762,53 @@ public void AttachmentParamsIncorrectDataTypeAction(@RestLiAttachmentsParam Stri\n \n   @RestLiCollection(name = \"collectionComplexKeyTask\")\n   class CollectionComplexKeyTask extends ComplexKeyResourceTaskTemplate<EmptyRecord, EmptyRecord, EmptyRecord> {}\n+\n+  @RestLiCollection(name = \"lucky\", keyName = \"dayOfWeek\")\n+  public class FinderUnsupportedKeyUnstructuredDataResource extends UnstructuredDataCollectionResourceTemplate<Integer>\n+  {\n+    @Finder(\"key\")\n+    public List<String> findLucky(@PagingContextParam final PagingContext context,\n+                                 @QueryParam(\"dayOfWeek\") Integer dayOfWeek) throws Exception\n+    {\n+      return Collections.singletonList(\"finderReturns\");\n+    }\n+  }\n+\n+  @RestLiSimpleResource(name=\"single\")\n+  public class FinderUnsupportedSingleUnstructuredDataResource extends UnstructuredDataSimpleResourceTemplate\n+  {\n+    @Finder(\"single\")\n+    public List<EmptyRecord> findLucky(@PagingContextParam final PagingContext context,\n+                                      @QueryParam(\"dayOfWeek\") Integer dayOfWeek) throws Exception\n+    {\n+      return Collections.singletonList(new EmptyRecord());\n+    }\n+  }\n+\n+  @RestLiAssociation(\n+      name=\"associate\",\n+      assocKeys={@Key(name=\"followerID\", type=long.class), @Key(name=\"followeeID\", type=long.class)})\n+  public class FinderSupportedAssociationDataResource extends AssociationResourceTemplate<EmptyRecord>\n+  {\n+    @Finder(\"associate\")\n+    public List<EmptyRecord> find(@PagingContextParam final PagingContext context,\n+        @QueryParam(\"dayOfWeek\") Integer dayOfWeek) throws Exception\n+    {\n+      return Collections.singletonList(new EmptyRecord());\n+    }\n+  }\n+\n+  @RestLiCollection(name=\"collectionComplexKey\")\n+  public class FinderSupportedComplexKeyDataResource extends ComplexKeyResourceTemplate<EmptyRecord, EmptyRecord, EmptyRecord>\n+  {\n+    @Finder(\"complex\")\n+    public List<EmptyRecord> find(@PagingContextParam final PagingContext context,\n+                                  @QueryParam(\"dayOfWeek\") Integer dayOfWeek) throws Exception\n+    {\n+      return Collections.singletonList(new EmptyRecord());\n+    }\n+  }\n+\n+  @RestLiActions(name = \"foo\")\n+  static class FinderWithActionResource {}", "originalCommit": "dbdaed1026cd5c700b09fdcd823f0d6c5099fc4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExOTA5Mg==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r432119092", "bodyText": "nit: would suggest pluralizing as methods. This also is consistent with your other new exception.", "author": "evanw555", "createdAt": "2020-05-28T20:57:42Z", "path": "restli-server/src/main/java/com/linkedin/restli/internal/server/model/RestLiAnnotationReader.java", "diffHunk": "@@ -2595,6 +2626,12 @@ private static void validateFinderMethod(final ResourceMethodDescriptor finderMe\n     Method method = finderMethodDescriptor.getMethod();\n     Class<?> valueClass = resourceModel.getValueClass();\n \n+    if (valueClass == null)\n+    {\n+      throw new ResourceConfigException(\"Class '\" + resourceModel.getResourceClass().getSimpleName()\n+          + \"' does not support @Finder method\");", "originalCommit": "dbdaed1026cd5c700b09fdcd823f0d6c5099fc4f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyMDk5MQ==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r432120991", "bodyText": "This logic seems overly complicated to me, and it's also duplicated. Could you not simply have a check in validateFinderMethod which accesses the class type via the ResourceModel? Perhaps I'm missing something...", "author": "evanw555", "createdAt": "2020-05-28T21:01:18Z", "path": "restli-server/src/main/java/com/linkedin/restli/internal/server/model/RestLiAnnotationReader.java", "diffHunk": "@@ -554,6 +554,20 @@ else if (KeyUnstructuredDataResource.class.isAssignableFrom(collectionResourceCl\n         @SuppressWarnings(\"unchecked\")\n         Class<? extends KeyUnstructuredDataResource<?>> clazz = (Class<? extends KeyUnstructuredDataResource<?>>) collectionResourceClass;\n         actualTypeArguments = ReflectionUtils.getTypeArgumentsParametrized(KeyUnstructuredDataResource.class, clazz);\n+        for (Method method : collectionResourceClass.getDeclaredMethods())", "originalCommit": "dbdaed1026cd5c700b09fdcd823f0d6c5099fc4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI0MDA5Mg==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r432240092", "bodyText": "Consolidated to the method 'validateFinderMethod'", "author": "BrianPin", "createdAt": "2020-05-29T03:46:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyMDk5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyMjA0MA==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r432122040", "bodyText": "nit: Class X of a Y class doesn't really make sense. It would be more clear to say Class X extending Y\nAlso, I'd suggest not hard-coding the class names into the String message. You should programmatically get the class name. This lets the navigate/refactor tool find this reference.", "author": "evanw555", "createdAt": "2020-05-28T21:03:30Z", "path": "restli-server/src/main/java/com/linkedin/restli/internal/server/model/RestLiAnnotationReader.java", "diffHunk": "@@ -554,6 +554,20 @@ else if (KeyUnstructuredDataResource.class.isAssignableFrom(collectionResourceCl\n         @SuppressWarnings(\"unchecked\")\n         Class<? extends KeyUnstructuredDataResource<?>> clazz = (Class<? extends KeyUnstructuredDataResource<?>>) collectionResourceClass;\n         actualTypeArguments = ReflectionUtils.getTypeArgumentsParametrized(KeyUnstructuredDataResource.class, clazz);\n+        for (Method method : collectionResourceClass.getDeclaredMethods())\n+        {\n+          if (method.isSynthetic())\n+          {\n+            continue;\n+          }\n+          Finder finderAnno = method.getAnnotation(Finder.class);\n+          if (finderAnno == null)\n+          {\n+            continue;\n+          }\n+          throw new ResourceConfigException(\"Class '\" + collectionResourceClass.getSimpleName() + \"' of a\"", "originalCommit": "dbdaed1026cd5c700b09fdcd823f0d6c5099fc4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI0MDAwNw==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r432240007", "bodyText": "Done", "author": "BrianPin", "createdAt": "2020-05-29T03:45:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyMjA0MA=="}], "type": "inlineReview"}, {"oid": "82bbb0e5d3615e5c3580288d4c4cd819903ea43a", "url": "https://github.com/linkedin/rest.li/commit/82bbb0e5d3615e5c3580288d4c4cd819903ea43a", "message": "Addressing Evan's comment", "committedDate": "2020-05-29T03:45:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2MTMzOQ==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r432661339", "bodyText": "I just realized that this will not have the intended effect. If class A extends some template class, and that extends KeyUnstructuredDataResource, then this will print the name of the template class (I think). I would suggest not printing the name of the superclass and instead just append ...because it's an unstructured data resource at the end of the message.", "author": "evanw555", "createdAt": "2020-05-29T18:24:20Z", "path": "restli-server/src/main/java/com/linkedin/restli/internal/server/model/RestLiAnnotationReader.java", "diffHunk": "@@ -2595,6 +2595,13 @@ private static void validateFinderMethod(final ResourceMethodDescriptor finderMe\n     Method method = finderMethodDescriptor.getMethod();\n     Class<?> valueClass = resourceModel.getValueClass();\n \n+    if (SingleUnstructuredDataResource.class.isAssignableFrom(resourceModel.getResourceClass())\n+        || KeyUnstructuredDataResource.class.isAssignableFrom(resourceModel.getResourceClass()))\n+    {\n+      throw new ResourceConfigException(\"Class '\" + resourceModel.getResourceClass().getSimpleName()\n+          + \"' extends the '\" + resourceModel.getResourceClass().getSuperclass().getSimpleName() + \"' class does not support @Finder methods\");", "originalCommit": "82bbb0e5d3615e5c3580288d4c4cd819903ea43a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY3ODMwMQ==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r432678301", "bodyText": "yep. make sense", "author": "BrianPin", "createdAt": "2020-05-29T19:00:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2MTMzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2MjU0MA==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r432662540", "bodyText": "Although this is alright, an alternative would be to leverage the logic in ResourceModel#getResourceEntityType to do this check without it being class-specific. You can avoid logic duplication this way.", "author": "evanw555", "createdAt": "2020-05-29T18:26:53Z", "path": "restli-server/src/main/java/com/linkedin/restli/internal/server/model/RestLiAnnotationReader.java", "diffHunk": "@@ -2595,6 +2595,13 @@ private static void validateFinderMethod(final ResourceMethodDescriptor finderMe\n     Method method = finderMethodDescriptor.getMethod();\n     Class<?> valueClass = resourceModel.getValueClass();\n \n+    if (SingleUnstructuredDataResource.class.isAssignableFrom(resourceModel.getResourceClass())", "originalCommit": "82bbb0e5d3615e5c3580288d4c4cd819903ea43a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY4MDc2MA==", "url": "https://github.com/linkedin/rest.li/pull/303#discussion_r432680760", "bodyText": "cool, makes me know one more thing", "author": "BrianPin", "createdAt": "2020-05-29T19:05:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2MjU0MA=="}], "type": "inlineReview"}, {"oid": "6d3539331b352adb82ccfff86d2f8386a9c1df57", "url": "https://github.com/linkedin/rest.li/commit/6d3539331b352adb82ccfff86d2f8386a9c1df57", "message": "Addressing Evan's comment about code quality and readability", "committedDate": "2020-05-29T19:10:06Z", "type": "commit"}, {"oid": "4a19b7856201f5d34ea122a6df7a54c74cbafefc", "url": "https://github.com/linkedin/rest.li/commit/4a19b7856201f5d34ea122a6df7a54c74cbafefc", "message": "address comment about redundant resource class in test where it won't hit the changed code path", "committedDate": "2020-05-29T22:09:06Z", "type": "commit"}]}