{"pr_number": 246, "pr_title": "Fix #245: Refactor RestRequestBuilderGenerator to accept arg file wit\u2026", "pr_createdAt": "2020-03-31T20:36:49Z", "pr_url": "https://github.com/linkedin/rest.li/pull/246", "timeline": [{"oid": "152fbd837600027f95e732e52ea505ca3eedc7d4", "url": "https://github.com/linkedin/rest.li/commit/152fbd837600027f95e732e52ea505ca3eedc7d4", "message": "Add Gradle task support for arg file generation", "committedDate": "2020-03-31T21:17:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIxOTQ5Mg==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401219492", "bodyText": "Add license", "author": "evanw555", "createdAt": "2020-03-31T21:14:46Z", "path": "restli-tools/src/test/java/com/linkedin/restli/tools/clientgen/TestRestRequestBuilderGeneratorEntryPoint.java", "diffHunk": "@@ -0,0 +1,141 @@\n+package com.linkedin.restli.tools.clientgen;", "originalCommit": "777098ad6aee6a6e616971a4ddd650705a06e0f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIzMzc4NQ==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401233785", "bodyText": "Will do.", "author": "DPUkyle", "createdAt": "2020-03-31T21:44:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIxOTQ5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyMDE5Ng==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401220196", "bodyText": "Is this basically just a copy of the existing test, but using PSVM instead? Would it be possible to keep this in the existing test class, or would that be too messy you think?", "author": "evanw555", "createdAt": "2020-03-31T21:16:08Z", "path": "restli-tools/src/test/java/com/linkedin/restli/tools/clientgen/TestRestRequestBuilderGeneratorEntryPoint.java", "diffHunk": "@@ -0,0 +1,141 @@\n+package com.linkedin.restli.tools.clientgen;\n+\n+import com.linkedin.data.schema.generator.AbstractGenerator;\n+import com.linkedin.pegasus.generator.PegasusDataTemplateGenerator;\n+import com.linkedin.restli.internal.common.RestliVersion;\n+import com.linkedin.restli.tools.ExporterTestUtils;\n+import org.testng.Assert;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileReader;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.Collections;\n+\n+public class TestRestRequestBuilderGeneratorEntryPoint {", "originalCommit": "777098ad6aee6a6e616971a4ddd650705a06e0f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIzMzU1OQ==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401233559", "bodyText": "Due to the messiness of the sysprop backup/restore, I chose to extract it to a separate class. I'm still worried about parallelism or unwanted side-effects of this, so we should kill this.", "author": "DPUkyle", "createdAt": "2020-03-31T21:44:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyMDE5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyNDA4MA==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401224080", "bodyText": "Can just be package-private, right?", "author": "evanw555", "createdAt": "2020-03-31T21:24:03Z", "path": "restli-tools/src/main/java/com/linkedin/restli/tools/clientgen/RestRequestBuilderGenerator.java", "diffHunk": "@@ -51,8 +51,8 @@\n  */\n public class RestRequestBuilderGenerator\n {\n-  private static final String GENERATOR_REST_GENERATE_DATATEMPLATES = \"generator.rest.generate.datatemplates\";\n-  private static final String GENERATOR_REST_GENERATE_VERSION = \"generator.rest.generate.version\";\n+  protected static final String GENERATOR_REST_GENERATE_DATATEMPLATES = \"generator.rest.generate.datatemplates\";\n+  protected static final String GENERATOR_REST_GENERATE_VERSION = \"generator.rest.generate.version\";", "originalCommit": "152fbd837600027f95e732e52ea505ca3eedc7d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIzMzY3MQ==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401233671", "bodyText": "Yes, I'll try with default access.", "author": "DPUkyle", "createdAt": "2020-03-31T21:44:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyNDA4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIzNjMwMQ==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401236301", "bodyText": "Default access works.", "author": "DPUkyle", "createdAt": "2020-03-31T21:49:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyNDA4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyNDE5MA==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401224190", "bodyText": "Although this logic is quite simple, it would probably be worthwhile to refactor this into its own utility class within :gradle-plugins, something like ArgumentFileBuilder (I say \"___Builder\" to stress that static utilities are unmaintainable) which handles creating the temp file and returning its \"ID\" (e.g. @/something/something). I think this would be a simple refactoring and would allow us to easily reuse it later, plus it removes complexity from this class.", "author": "evanw555", "createdAt": "2020-03-31T21:24:14Z", "path": "gradle-plugins/src/main/java/com/linkedin/pegasus/gradle/tasks/GenerateRestClientTask.java", "diffHunk": "@@ -156,11 +168,26 @@ public void generate()\n         javaExecSpec.jvmArgs(\"-Dgenerator.rest.generate.version=2.0.0\"); //RestRequestBuilderGenerator.run(version)\n         javaExecSpec.jvmArgs(\"-Droot.path=\" + getProject().getRootDir().getPath());\n         javaExecSpec.args(_destinationDir.getAbsolutePath());\n-        javaExecSpec.args(files);\n+        javaExecSpec.args(sources);\n       }).assertNormalExitValue()\n     );\n   }\n \n+  /**\n+   * Helper method to generate an argument file, containing one input file per line.\n+   * This should be prefixed with '@' and passed to the final argument of RestRequestBuilderGenerator.\n+   */\n+  private File createArgFile(String prefix, List<String> files) {", "originalCommit": "152fbd837600027f95e732e52ea505ca3eedc7d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI1MzE0MA==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401253140", "bodyText": "Added class ArgumentFileGenerator. Note that it can't live in restli-tools as pegasus-plugins has no dependency on it.", "author": "DPUkyle", "createdAt": "2020-03-31T22:29:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyNDE5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyNTU4Ng==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401225586", "bodyText": "Can you add a TODO here which says that we want to refactor this tool into a nicer CLI app using Commons-CLI?", "author": "evanw555", "createdAt": "2020-03-31T21:27:10Z", "path": "restli-tools/src/main/java/com/linkedin/restli/tools/clientgen/RestRequestBuilderGenerator.java", "diffHunk": "@@ -51,8 +51,8 @@\n  */", "originalCommit": "152fbd837600027f95e732e52ea505ca3eedc7d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI1Mjg2OQ==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401252869", "bodyText": "Done (line 62)", "author": "DPUkyle", "createdAt": "2020-03-31T22:29:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyNTU4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyNTYyNg==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401225626", "bodyText": "Similar comment as the one above, there should be a utility class within :restli-tools which handles the parsing side of things. Although this logic here isn't too complicated, this will proactively keep this sort of stuff from exploding if we need to extend or reuse it, plus it keeps this class clean.", "author": "evanw555", "createdAt": "2020-03-31T21:27:16Z", "path": "restli-tools/src/main/java/com/linkedin/restli/tools/clientgen/RestRequestBuilderGenerator.java", "diffHunk": "@@ -64,10 +64,19 @@\n   public static void main(String[] args)\n       throws IOException\n   {\n+    String[] sources = new String[0];\n+\n     if (args.length < 2)\n     {\n       _log.error(\"Usage: RestRequestBuilderGenerator targetDirectoryPath [sourceFile or sourceDirectory]+\");\n       System.exit(1);\n+    } else if (args.length == 2 && args[1].startsWith(\"@\")) {", "originalCommit": "152fbd837600027f95e732e52ea505ca3eedc7d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI1MjgwNA==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401252804", "bodyText": "Added class ArgumentFileProcessor", "author": "DPUkyle", "createdAt": "2020-03-31T22:29:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyNTYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI3OTc2Mg==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401279762", "bodyText": "Since this utility is only accessible within the :gradle-plugins module, I think it's safe to let this method assume the temp dir to be Task#getTemporaryDir. This would make the code simpler from the caller's POV. What do you think?\nEdit: Is it done this way because Gradle temp dirs are associated with a particular task?", "author": "evanw555", "createdAt": "2020-03-31T23:51:21Z", "path": "gradle-plugins/src/main/java/com/linkedin/pegasus/gradle/internal/ArgumentFileGenerator.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+   Copyright (c) 2020 LinkedIn Corp.\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+\n+package com.linkedin.pegasus.gradle.internal;\n+\n+import org.gradle.api.GradleException;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.List;\n+\n+public class ArgumentFileGenerator\n+{\n+\n+  private ArgumentFileGenerator()\n+  {\n+    // prevent instantiation\n+  }\n+\n+  /**\n+   *  Helper method to generate an argument file, containing one input file per line.\n+   *  This should be later prefixed with '@' and passed to the final argument of RestRequestBuilderGenerator.\n+   *\n+   * @param prefix unique value to prepend to the arg file name\n+   * @param files the iterable to write to an arg file, one line per entry\n+   * @param tempDir the directory to hold the file (If invoked from Gradle, use org.gradle.api.Task#getTemporaryDir()", "originalCommit": "6c5b5b913eb6d29165be1292c84106090ffac9de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwNzc1MQ==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401307751", "bodyText": "Yes I did it this way to use as few Gradle APIs as possible; if we use Task#getTempoaryDir() as default storage for the arg File, the caller would have to pass a reference to the Task object, which is kind of icky too. Let's leave it as-is.", "author": "DPUkyle", "createdAt": "2020-04-01T01:35:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI3OTc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM0NzgwOQ==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401347809", "bodyText": "Now I get it, makes sense.", "author": "evanw555", "createdAt": "2020-04-01T04:21:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI3OTc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4MDMwNA==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401280304", "bodyText": "Calling this param files is confusing, since it doesn't refer to the arg file itself but rather to its inputs. I'd suggest renaming to args, entries, values, inputs, or something along those lines. In addition, we may reuse this utility later in a case where the args aren't necessarily filepaths.", "author": "evanw555", "createdAt": "2020-03-31T23:53:10Z", "path": "gradle-plugins/src/main/java/com/linkedin/pegasus/gradle/internal/ArgumentFileGenerator.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+   Copyright (c) 2020 LinkedIn Corp.\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+\n+package com.linkedin.pegasus.gradle.internal;\n+\n+import org.gradle.api.GradleException;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.List;\n+\n+public class ArgumentFileGenerator\n+{\n+\n+  private ArgumentFileGenerator()\n+  {\n+    // prevent instantiation\n+  }\n+\n+  /**\n+   *  Helper method to generate an argument file, containing one input file per line.\n+   *  This should be later prefixed with '@' and passed to the final argument of RestRequestBuilderGenerator.\n+   *\n+   * @param prefix unique value to prepend to the arg file name\n+   * @param files the iterable to write to an arg file, one line per entry\n+   * @param tempDir the directory to hold the file (If invoked from Gradle, use org.gradle.api.Task#getTemporaryDir()\n+   * @return argument file which can be passed to a CLI or other JavaExec task\n+   */\n+  public static File createArgFile(String prefix, List<String> files, File tempDir)", "originalCommit": "6c5b5b913eb6d29165be1292c84106090ffac9de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwODAwNw==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401308007", "bodyText": "Fair enough - although I don't intend this to become the \"restli standard\". We need to stop passing arguments via sysprops on the CLI, and use a proper framework like jcommander. I'm OK with commons-cli too if it can support the argfile syntax. Otherwise I strongly recommend jcommander.", "author": "DPUkyle", "createdAt": "2020-04-01T01:36:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4MDMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM0ODE1Mw==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401348153", "bodyText": "Ah, I see. So for now, this will hold us over, and we'll potentially have to use it if we run into the same issue for another task in the near future. The long-term vision will be to migrate all our tools to C-CLI or JCommander.", "author": "evanw555", "createdAt": "2020-04-01T04:22:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4MDMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM0ODY2OQ==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401348669", "bodyText": "\ud83d\udc4d", "author": "DPUkyle", "createdAt": "2020-04-01T04:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI4MDMwNA=="}], "type": "inlineReview"}, {"oid": "0a26d1169b09ba2a5770c97bb8c7f0daa91f553d", "url": "https://github.com/linkedin/rest.li/commit/0a26d1169b09ba2a5770c97bb8c7f0daa91f553d", "message": "Fix #245: Refactor RestRequestBuilderGenerator to accept arg file with '@' syntax\n\n - Add test coverage for psvm method\n - Add Gradle utility class for arg file generation", "committedDate": "2020-04-01T01:42:39Z", "type": "forcePushed"}, {"oid": "74e28daec586bbdd9d9967cf34e2ed2e048fd143", "url": "https://github.com/linkedin/rest.li/commit/74e28daec586bbdd9d9967cf34e2ed2e048fd143", "message": "Fix #245: Refactor RestRequestBuilderGenerator to accept arg file with '@' syntax\n\n - Add test coverage for psvm method\n - Add Gradle utility class for arg file generation", "committedDate": "2020-04-01T04:18:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM0ODg2Nw==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401348867", "bodyText": "Oh no - IntelliJ refactor got a bit too creative. Let me undo this change.", "author": "DPUkyle", "createdAt": "2020-04-01T04:26:00Z", "path": "generator-test/build.gradle", "diffHunk": "@@ -12,7 +12,7 @@ project.idea.module.testSourceDirs.add('src/test/javaPegasus')\n apply from: \"${buildScriptDirPath}/dataTemplate.gradle\"\n apply from: \"${buildScriptDirPath}/avroSchema.gradle\"\n \n-// generate pdsc files under \"unionPegasus\" directory with explicit ordering\n+// generate pdsc args under \"unionPegasus\" directory with explicit ordering", "originalCommit": "74e28daec586bbdd9d9967cf34e2ed2e048fd143", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM0OTM4Mw==", "url": "https://github.com/linkedin/rest.li/pull/246#discussion_r401349383", "bodyText": "Fixed.", "author": "DPUkyle", "createdAt": "2020-04-01T04:28:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM0ODg2Nw=="}], "type": "inlineReview"}, {"oid": "68ec7f6e39e0dcb3b7c98e85a7e5ce51eab1bffe", "url": "https://github.com/linkedin/rest.li/commit/68ec7f6e39e0dcb3b7c98e85a7e5ce51eab1bffe", "message": "Fix #245: Refactor RestRequestBuilderGenerator to accept arg file with '@' syntax\n\n - Add test coverage for psvm method\n - Add Gradle utility class for arg file generation", "committedDate": "2020-04-01T04:27:50Z", "type": "forcePushed"}, {"oid": "716446367902b9baa83f92dcbe30c6b6ae1408ed", "url": "https://github.com/linkedin/rest.li/commit/716446367902b9baa83f92dcbe30c6b6ae1408ed", "message": "Fix #245: Refactor RestRequestBuilderGenerator to accept arg file with '@' syntax\n\n - Add test coverage for psvm method\n - Add Gradle utility class for arg file generation", "committedDate": "2020-04-01T04:37:02Z", "type": "forcePushed"}, {"oid": "df885fa459a7cc32c2ec1be7af7cf7b6b08b7ade", "url": "https://github.com/linkedin/rest.li/commit/df885fa459a7cc32c2ec1be7af7cf7b6b08b7ade", "message": "Fix #245: Refactor RestRequestBuilderGenerator to accept arg file with '@' syntax\n\n - Add test coverage for psvm method\n - Add Gradle utility class for arg file generation", "committedDate": "2020-04-07T02:18:51Z", "type": "commit"}, {"oid": "df885fa459a7cc32c2ec1be7af7cf7b6b08b7ade", "url": "https://github.com/linkedin/rest.li/commit/df885fa459a7cc32c2ec1be7af7cf7b6b08b7ade", "message": "Fix #245: Refactor RestRequestBuilderGenerator to accept arg file with '@' syntax\n\n - Add test coverage for psvm method\n - Add Gradle utility class for arg file generation", "committedDate": "2020-04-07T02:18:51Z", "type": "forcePushed"}]}