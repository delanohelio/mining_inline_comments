{"pr_number": 5012, "pr_title": "FISH-796 Fix clustered singleton bugs and added test", "pr_createdAt": "2020-11-28T02:47:50Z", "pr_url": "https://github.com/payara/Payara/pull/5012", "timeline": [{"oid": "2e41083fef47731165be8712053f7c40df89d27e", "url": "https://github.com/payara/Payara/commit/2e41083fef47731165be8712053f7c40df89d27e", "message": "fixed clustered singleton bugs appeared during migration to Hazelcast 4.0", "committedDate": "2020-11-28T05:03:17Z", "type": "forcePushed"}, {"oid": "dfc9ddc93b9dbf473b65e76cce7f0d16ed143a87", "url": "https://github.com/payara/Payara/commit/dfc9ddc93b9dbf473b65e76cce7f0d16ed143a87", "message": "fixed clustered singleton bugs appeared during migration to Hazelcast 4", "committedDate": "2020-11-28T05:32:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ0NzAzMQ==", "url": "https://github.com/payara/Payara/pull/5012#discussion_r535447031", "bodyText": "I'm not quite sure why I changed this, needs a bit further investigating", "author": "lprimak", "createdAt": "2020-12-03T17:43:23Z", "path": "appserver/payara-appserver-modules/payara-micro-cdi/src/main/java/fish/payara/micro/cdi/extension/cluster/ClusterScopedInterceptor.java", "diffHunk": "@@ -105,11 +104,11 @@ Object postConstruct(InvocationContext invocationContext) throws Exception {\n     Object preDestroy(InvocationContext invocationContext) throws Exception {\n         Class<?> beanClass = invocationContext.getTarget().getClass().getSuperclass();\n         Clustered clusteredAnnotation = getAnnotation(beanManager, beanClass);\n-        clusteredLookup.setClusteredSessionKey(beanClass);\n+        clusteredLookup.setClusteredSessionKeyIfNotSet(beanClass, clusteredAnnotation);\n         IAtomicLong count = clusteredLookup.getClusteredUsageCount();\n         if (count.decrementAndGet() <= 0) {\n             clusteredLookup.getClusteredSingletonMap().delete(clusteredLookup.getClusteredSessionKey());\n-            count.destroy();\n+            count.set(0);", "originalCommit": "e0869e43a2756107151d3f22f1ed3bf448191fe0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ0NzM0Mg==", "url": "https://github.com/payara/Payara/pull/5012#discussion_r535447342", "bodyText": "Will try to test without that change and if it passes, will revert this change, then we are good to go", "author": "lprimak", "createdAt": "2020-12-03T17:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ0NzAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ1OTAxOA==", "url": "https://github.com/payara/Payara/pull/5012#discussion_r535459018", "bodyText": "passed", "author": "lprimak", "createdAt": "2020-12-03T18:00:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ0NzAzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ1MDM2OA==", "url": "https://github.com/payara/Payara/pull/5012#discussion_r535450368", "bodyText": "same here", "author": "lprimak", "createdAt": "2020-12-03T17:48:21Z", "path": "appserver/ejb/ejb-container/src/main/java/com/sun/ejb/containers/AbstractSingletonContainer.java", "diffHunk": "@@ -713,7 +713,7 @@ public void destroy(Object obj) {\n                 IAtomicLong count = clusteredLookup.getClusteredUsageCount();\n                 if (count.decrementAndGet() <= 0) {\n                     clusteredLookup.getClusteredSingletonMap().delete(clusteredLookup.getClusteredSessionKey());\n-                    count.destroy();\n+                    count.set(0);", "originalCommit": "e0869e43a2756107151d3f22f1ed3bf448191fe0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d2d7e9ef9b45887e9e90cbab3f6f34b47fc77cc5", "url": "https://github.com/payara/Payara/commit/d2d7e9ef9b45887e9e90cbab3f6f34b47fc77cc5", "message": "fixed bugs in clustered singleton, added arquillian tests", "committedDate": "2020-12-03T19:09:21Z", "type": "forcePushed"}, {"oid": "efab4a7ddfb79c1afcd9b2e98241e689cbc14ca1", "url": "https://github.com/payara/Payara/commit/efab4a7ddfb79c1afcd9b2e98241e689cbc14ca1", "message": "fixed bugs in clustered singleton, added arquillian tests", "committedDate": "2020-12-03T19:59:30Z", "type": "commit"}, {"oid": "efab4a7ddfb79c1afcd9b2e98241e689cbc14ca1", "url": "https://github.com/payara/Payara/commit/efab4a7ddfb79c1afcd9b2e98241e689cbc14ca1", "message": "fixed bugs in clustered singleton, added arquillian tests", "committedDate": "2020-12-03T19:59:30Z", "type": "forcePushed"}, {"oid": "d55f76583f6e4088d5bef177ea388603745f0b56", "url": "https://github.com/payara/Payara/commit/d55f76583f6e4088d5bef177ea388603745f0b56", "message": "clustered singleton-related CP objects can't be destroyed", "committedDate": "2020-12-03T21:57:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1NjkzOQ==", "url": "https://github.com/payara/Payara/pull/5012#discussion_r536256939", "bodyText": "This looks like a leaked file from NetBeans, probably needs deleting", "author": "MattGill98", "createdAt": "2020-12-04T17:25:21Z", "path": "appserver/tests/payara-samples/samples/clustered-singleton/clustered-singleton-test/licenseheader.txt", "diffHunk": "@@ -0,0 +1,43 @@\n+<#if licenseFirst??>", "originalCommit": "d55f76583f6e4088d5bef177ea388603745f0b56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI2MjU2MA==", "url": "https://github.com/payara/Payara/pull/5012#discussion_r536262560", "bodyText": "ok", "author": "lprimak", "createdAt": "2020-12-04T17:34:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1NjkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1ODE3NA==", "url": "https://github.com/payara/Payara/pull/5012#discussion_r536258174", "bodyText": "I'd like the packages changing to fish.payara, inkeeping with the other tests", "author": "MattGill98", "createdAt": "2020-12-04T17:27:24Z", "path": "appserver/tests/payara-samples/samples/clustered-singleton/clustered-singleton-test/src/main/java/com/flowlogix/clust/singleton/interceptor/ClusteredInterceptor.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) [2016-2017] Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package com.flowlogix.clust.singleton.interceptor;", "originalCommit": "d55f76583f6e4088d5bef177ea388603745f0b56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI2MjY2MQ==", "url": "https://github.com/payara/Payara/pull/5012#discussion_r536262661", "bodyText": "ok", "author": "lprimak", "createdAt": "2020-12-04T17:34:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1ODE3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1ODgzNA==", "url": "https://github.com/payara/Payara/pull/5012#discussion_r536258834", "bodyText": "Oh god, didn't we do a tonne of work a while ago to remove Lombok?\nI'm not concerned with what our answer is, but I'd like it resolved before we continue this loop of adding and removing lombok", "author": "MattGill98", "createdAt": "2020-12-04T17:28:20Z", "path": "appserver/tests/payara-samples/samples/clustered-singleton/clustered-singleton-test/src/main/java/com/flowlogix/clust/singleton/interceptor/ClusteredInterceptor.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) [2016-2017] Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package com.flowlogix.clust.singleton.interceptor;\n+\n+import com.flowlogix.clust.singleton.ClusteredSingletonInterceptedEJB;\n+import java.io.Serializable;\n+import javax.interceptor.AroundConstruct;\n+import javax.interceptor.AroundInvoke;\n+import javax.interceptor.AroundTimeout;\n+import javax.interceptor.InvocationContext;\n+import lombok.Cleanup;", "originalCommit": "d55f76583f6e4088d5bef177ea388603745f0b56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI2Mjg3Mw==", "url": "https://github.com/payara/Payara/pull/5012#discussion_r536262873", "bodyText": "ok", "author": "lprimak", "createdAt": "2020-12-04T17:34:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1ODgzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3MjU3Mw==", "url": "https://github.com/payara/Payara/pull/5012#discussion_r536372573", "bodyText": "haha that tonne of work introduced most of these bugs :)", "author": "lprimak", "createdAt": "2020-12-04T20:51:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1ODgzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3Mjc0Nw==", "url": "https://github.com/payara/Payara/pull/5012#discussion_r536372747", "bodyText": "This time Im going to do this correctly by using delombok plugin :)", "author": "lprimak", "createdAt": "2020-12-04T20:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1ODgzNA=="}], "type": "inlineReview"}, {"oid": "25221244c3715ee0ca058b793f9aae6840afc688", "url": "https://github.com/payara/Payara/commit/25221244c3715ee0ca058b793f9aae6840afc688", "message": "Merge branch 'master' into Fix-Clustered-Singleton-Bugs", "committedDate": "2020-12-04T20:30:36Z", "type": "commit"}, {"oid": "5c7a88138cd57804160795b969c5bac6bff5f494", "url": "https://github.com/payara/Payara/commit/5c7a88138cd57804160795b969c5bac6bff5f494", "message": "renamed packages", "committedDate": "2020-12-04T20:50:55Z", "type": "commit"}, {"oid": "2b2270002ce3e248317002a3c8ea8c0ec1b62a7d", "url": "https://github.com/payara/Payara/commit/2b2270002ce3e248317002a3c8ea8c0ec1b62a7d", "message": "delombok", "committedDate": "2020-12-04T21:40:47Z", "type": "commit"}, {"oid": "4bea4a71d8952ef4fe2a96567ac83c1338178a24", "url": "https://github.com/payara/Payara/commit/4bea4a71d8952ef4fe2a96567ac83c1338178a24", "message": "bump version number", "committedDate": "2020-12-04T21:43:57Z", "type": "commit"}, {"oid": "14be950fdf2c3de5d2efd602913bd3e3cd6aa8d1", "url": "https://github.com/payara/Payara/commit/14be950fdf2c3de5d2efd602913bd3e3cd6aa8d1", "message": "minor cleanup of UUID", "committedDate": "2020-12-04T21:47:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM1NDEwOA==", "url": "https://github.com/payara/Payara/pull/5012#discussion_r537354108", "bodyText": "Looks like there are some copyright headers that need fixing, then this is good to go IMO", "author": "MattGill98", "createdAt": "2020-12-07T09:29:25Z", "path": "appserver/tests/payara-samples/samples/clustered-singleton/clustered-singleton-test/src/main/java/fish/payara/samples/clustered/singleton/ClusteredAnnotatedAPI2.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) [2016-2017] Payara Foundation and/or its affiliates. All rights reserved.", "originalCommit": "14be950fdf2c3de5d2efd602913bd3e3cd6aa8d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "49a35d343be295d52c5ee47a93c90a4f50bd3822", "url": "https://github.com/payara/Payara/commit/49a35d343be295d52c5ee47a93c90a4f50bd3822", "message": "copyright updates", "committedDate": "2020-12-07T16:52:37Z", "type": "commit"}]}