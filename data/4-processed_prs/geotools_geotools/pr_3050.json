{"pr_number": 3050, "pr_title": "[GEOT-6653] Add InFunction optimization to MemoryFilterOptimizer", "pr_createdAt": "2020-07-06T17:51:09Z", "pr_url": "https://github.com/geotools/geotools/pull/3050", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwOTUzNQ==", "url": "https://github.com/geotools/geotools/pull/3050#discussion_r450709535", "bodyText": "This code does repeated passes over data structures as long as the or children, while a traditional loop could have done everything in a single pass, just keeping track of the first property name found, and the list of literals found in the process.\nJust saying, streams are not always an improvement, had this been in a performance critical section of code, the penalty would have been severe. But it's in a one-off, so it does not matter much, you can leave it as is.", "author": "aaime", "createdAt": "2020-07-07T08:51:46Z", "path": "modules/library/render/src/main/java/org/geotools/renderer/lite/MemoryFilterOptimizer.java", "diffHunk": "@@ -111,7 +117,58 @@ public Object visit(Not filter, Object extraData) {\n \n     @Override\n     public Object visit(Or filter, Object extraData) {\n-        return memoize(filter, extraData, super::visit);\n+        return memoize(filter, extraData, this::inFilterOptimizer);\n+    }\n+\n+    /** Checks if an Or filter can be replaced by a single IN condition. */\n+    private Object inFilterOptimizer(Or filter, Object extraData) {\n+        InFunction inFilter = replaceWithInFilter(filter);\n+        if (inFilter == null) return super.visit(filter, extraData);\n+        return ff.equals(inFilter, ff.literal(true));\n+    }\n+\n+    private InFunction replaceWithInFilter(Or filter) {\n+        List<Filter> children = filter.getChildren();\n+        if (children.size() == 0", "originalCommit": "f82232810e5fcbaa8a5db88b53717e298a85111a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI3ODgwOQ==", "url": "https://github.com/geotools/geotools/pull/3050#discussion_r451278809", "bodyText": "Indeed a single iteration over the collection is possible and faster, so I did the fix, thanks!", "author": "fernandor777", "createdAt": "2020-07-08T04:41:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcwOTUzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxMDE5MA==", "url": "https://github.com/geotools/geotools/pull/3050#discussion_r450710190", "bodyText": "This test covers only the happy case, could you write tests for the exception paths, like or with different properties, and with comparisons other than equality?", "author": "aaime", "createdAt": "2020-07-07T08:52:52Z", "path": "modules/library/render/src/test/java/org/geotools/renderer/lite/MemoryFilterOptimizerTest.java", "diffHunk": "@@ -144,4 +148,35 @@ public void testEqualFeatureTypes() throws Exception {\n         Mockito.verify(spy, Mockito.times(0)).getAttribute(name);\n         Mockito.verify(spy, Mockito.times(1)).getAttribute(0);\n     }\n+\n+    public void testInFunctionOptimizer() throws Exception {", "originalCommit": "f82232810e5fcbaa8a5db88b53717e298a85111a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI3ODk3Mg==", "url": "https://github.com/geotools/geotools/pull/3050#discussion_r451278972", "bodyText": "Agreed, added test cases when the In function optimization is not accomplished.", "author": "fernandor777", "createdAt": "2020-07-08T04:41:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxMDE5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxMjM0MQ==", "url": "https://github.com/geotools/geotools/pull/3050#discussion_r450712341", "bodyText": "Nitpicking here, an \"in\" optimization can be performed over pairs of \"Expression, Literal\", e.g., strLow(myAtt) = 'abc' or strLow(myAtt) = 'def' or (a + b) = 10 or (a + 10) = 12 can be both optimized with the in function. The only requirement is that all non literal bits in the comparison are equal. Again, probably not the most common case, up to you if you want to generalize or not.", "author": "aaime", "createdAt": "2020-07-07T08:56:24Z", "path": "modules/library/render/src/main/java/org/geotools/renderer/lite/MemoryFilterOptimizer.java", "diffHunk": "@@ -111,7 +117,58 @@ public Object visit(Not filter, Object extraData) {\n \n     @Override\n     public Object visit(Or filter, Object extraData) {\n-        return memoize(filter, extraData, super::visit);\n+        return memoize(filter, extraData, this::inFilterOptimizer);\n+    }\n+\n+    /** Checks if an Or filter can be replaced by a single IN condition. */\n+    private Object inFilterOptimizer(Or filter, Object extraData) {\n+        InFunction inFilter = replaceWithInFilter(filter);\n+        if (inFilter == null) return super.visit(filter, extraData);\n+        return ff.equals(inFilter, ff.literal(true));\n+    }\n+\n+    private InFunction replaceWithInFilter(Or filter) {\n+        List<Filter> children = filter.getChildren();\n+        if (children.size() == 0\n+                || !children.stream().allMatch(f -> f instanceof PropertyIsEqualTo)) return null;\n+        @SuppressWarnings({\"unchecked\", \"rawtypes\"})\n+        List<PropertyIsEqualTo> equalsList = (List) children;\n+        // get the parameters pairs, including nulls when the requirements are not accomplished\n+        List<Pair<PropertyName, Literal>> parameters =\n+                equalsList.stream().map(eq -> getEqualsParameters(eq)).collect(Collectors.toList());\n+        // check if any pair is null\n+        if (parameters.stream().anyMatch(Objects::isNull)) return null;\n+        // check all the property names are the same\n+        String propertyName = parameters.get(0).getKey().getPropertyName();\n+        if (!parameters\n+                .stream()\n+                .allMatch(pair -> Objects.equals(propertyName, pair.getKey().getPropertyName())))\n+            return null;\n+        // build the In function\n+        List<Expression> inParameters = new ArrayList<>(parameters.size() + 1);\n+        inParameters.add(parameters.get(0).getKey());\n+        inParameters.addAll(\n+                parameters.stream().map(p -> p.getValue()).collect(Collectors.toList()));\n+        InFunction inFunction = new InFunction();\n+        inFunction.setParameters(inParameters);\n+        return inFunction;\n+    }\n+\n+    private Pair<PropertyName, Literal> getEqualsParameters(PropertyIsEqualTo equals) {", "originalCommit": "f82232810e5fcbaa8a5db88b53717e298a85111a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI4ODYyMA==", "url": "https://github.com/geotools/geotools/pull/3050#discussion_r451288620", "bodyText": "Nice hint, added expression support.", "author": "fernandor777", "createdAt": "2020-07-08T05:18:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxMjM0MQ=="}], "type": "inlineReview"}, {"oid": "5fbb2ecdfef58966ad914746f874a3c66de2f884", "url": "https://github.com/geotools/geotools/commit/5fbb2ecdfef58966ad914746f874a3c66de2f884", "message": "[GEOT-6653] Add InFunction optimization to MemoryFilterOptimizer", "committedDate": "2020-07-08T05:21:17Z", "type": "commit"}, {"oid": "5fbb2ecdfef58966ad914746f874a3c66de2f884", "url": "https://github.com/geotools/geotools/commit/5fbb2ecdfef58966ad914746f874a3c66de2f884", "message": "[GEOT-6653] Add InFunction optimization to MemoryFilterOptimizer", "committedDate": "2020-07-08T05:21:17Z", "type": "forcePushed"}]}