{"pr_number": 3122, "pr_title": "[GEOT-6687] AzimulthalEquidistantProjectionHandlerFactory is not handling false origins", "pr_createdAt": "2020-08-28T16:34:27Z", "pr_url": "https://github.com/geotools/geotools/pull/3122", "timeline": [{"oid": "20f600693d55e7ec4955c1f7e32e9b63abbcf4da", "url": "https://github.com/geotools/geotools/commit/20f600693d55e7ec4955c1f7e32e9b63abbcf4da", "message": "[GEOT-6687] AzimulthalEquidistantProjectionHandlerFactory is not handling false origins", "committedDate": "2020-08-28T16:29:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MjIzMA==", "url": "https://github.com/geotools/geotools/pull/3122#discussion_r479582230", "bodyText": "I thought through putting a try catch around these, in order to throw the original TransformException exception. It is more useful to have this failure so you can tell exactly how far it got.", "author": "jodygarnett", "createdAt": "2020-08-29T00:19:56Z", "path": "modules/library/main/src/main/java/org/geotools/renderer/crs/AzimulthalEquidistantProjectionHandlerFactory.java", "diffHunk": "@@ -161,12 +161,37 @@ private void initializeDatelineCutter(CoordinateReferenceSystem crs, Point2D.Dou\n                 Geometry difference = renderingGeometry.difference(bufferedDateline);\n                 List<Polygon> polygons = PolygonExtracter.getPolygons(difference);\n                 for (Polygon p : polygons) {\n-                    Geometry transformed =\n-                            JTS.transform(\n-                                    p,\n-                                    CRS.findMathTransform(\n-                                            renderingEnvelope.getCoordinateReferenceSystem(),\n-                                            sourceCRS));\n+                    Geometry transformed = null;\n+                    try {\n+                        transformed =\n+                                JTS.transform(\n+                                        p,\n+                                        CRS.findMathTransform(\n+                                                renderingEnvelope.getCoordinateReferenceSystem(),\n+                                                sourceCRS));\n+                    } catch (TransformException e) {\n+                        // uh oh, got into a special case of the target projection... go step by\n+                        // step\n+                        Geometry polygonWGS84 =\n+                                JTS.transform(\n+                                        p,\n+                                        CRS.findMathTransform(\n+                                                renderingEnvelope.getCoordinateReferenceSystem(),\n+                                                DefaultGeographicCRS.WGS84));\n+                        ProjectionHandler handler =\n+                                ProjectionHandlerFinder.getHandler(\n+                                        new ReferencedEnvelope(sourceCRS),\n+                                        DefaultGeographicCRS.WGS84,\n+                                        false);\n+                        if (handler == null) throw e;\n+                        Geometry preProcessed = handler.preProcess(polygonWGS84);\n+                        transformed =\n+                                JTS.transform(\n+                                        preProcessed,\n+                                        CRS.findMathTransform(\n+                                                renderingEnvelope.getCoordinateReferenceSystem(),\n+                                                sourceCRS));", "originalCommit": "20f600693d55e7ec4955c1f7e32e9b63abbcf4da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYzMzE5OA==", "url": "https://github.com/geotools/geotools/pull/3122#discussion_r479633198", "bodyText": "The method declares to throw TransformException, so in case JTS.transform throws, it's going to go out of the method and handled at higher level, logged or re-wrapped. Don't think anything is lost. Have I misunderstood your comment?", "author": "aaime", "createdAt": "2020-08-29T10:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MjIzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDg0NzE5NQ==", "url": "https://github.com/geotools/geotools/pull/3122#discussion_r480847195", "bodyText": "Nope it is fine, was trying to decide if there was any value in throwing the origional exception (there was not)", "author": "jodygarnett", "createdAt": "2020-09-01T05:52:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MjIzMA=="}], "type": "inlineReview"}]}