{"pr_number": 2780, "pr_title": "[GEOT-6505] MBStyle exponential math is not a match for Mapbox GL one", "pr_createdAt": "2020-01-31T17:26:06Z", "pr_url": "https://github.com/geotools/geotools/pull/2780", "timeline": [{"oid": "0a8aaea9f8fa2738fbb1a1c4999264c7b447629c", "url": "https://github.com/geotools/geotools/commit/0a8aaea9f8fa2738fbb1a1c4999264c7b447629c", "message": "[GEOT-6505] MBStyle exponential math is not a match for Mapbox GL one", "committedDate": "2020-01-31T17:24:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY5NTkwNg==", "url": "https://github.com/geotools/geotools/pull/2780#discussion_r373695906", "bodyText": "Good research!\nsidebar: Is @Private annotation useful?", "author": "jodygarnett", "createdAt": "2020-01-31T21:34:45Z", "path": "modules/unsupported/mbstyle/src/main/java/org/geotools/mbstyle/function/ExponentialFunction.java", "diffHunk": "@@ -171,21 +171,57 @@ public Object evaluate(Object object) {\n \n     private double numericExponential(\n             Object object, double inputValue, double base, Stop lower, Stop upper) {\n-\n         double stop1 = lower.stop.evaluate(object, Double.class);\n         double value1 = lower.value.evaluate(object, Double.class);\n         double stop2 = upper.stop.evaluate(object, Double.class);\n         double value2 = upper.value.evaluate(object, Double.class);\n+        double t = exponentialInterpolationRatio(object, inputValue, base, stop1, stop2);\n \n-        // Basic exponential function:\n-        //\n-        // value_i = scale*(stop_i)^base - offset\n-        //\n-        // Determine scale and offset based on the upper and lower stops:\n-        double scale = (value2 - value1) / (Math.pow(stop2, base) - Math.pow(stop1, base));\n-        double offset = value1 - scale * Math.pow(stop1, base);\n+        return (value1 * (1 - t)) + (value2 * t);\n+    }\n \n-        return offset + scale * Math.pow(inputValue, base);\n+    /**\n+     * Description from\n+     * https://github.com/mapbox/mapbox-gl-js/blob/master/src/style-spec/expression/definitions/interpolate.js#L220\n+     *\n+     * <p>Returns a **ratio** that can be used to interpolate between exponential function stops.\n+     * How it works: Two consecutive stop values define a (scaled and shifted) exponential function\n+     * `f(x) = a * base^x + b`, where `base` is the user-specified base, and `a` and `b` are\n+     * constants affording sufficient degrees of freedom to fit the function to the given stops.\n+     *\n+     * <p>Here's a bit of algebra that lets us compute `f(x)` directly from the stop values without\n+     * explicitly solving for `a` and `b`:\n+     *\n+     * <p>First stop value: `f(x0) = y0 = a * base^x0 + b` Second stop value: `f(x1) = y1 = a *\n+     * base^x1 + b` => `y1 - y0 = a(base^x1 - base^x0)` => `a = (y1 - y0)/(base^x1 - base^x0)`\n+     *\n+     * <p>Desired value: `f(x) = y = a * base^x + b` => `f(x) = y0 + a * (base^x - base^x0)`\n+     *\n+     * <p>From the above, we can replace the `a` in `a * (base^x - base^x0)` and do a little\n+     * algebra: ``` a * (base^x - base^x0) = (y1 - y0)/(base^x1 - base^x0) * (base^x - base^x0) =\n+     * (y1 - y0) * (base^x - base^x0) / (base^x1 - base^x0) ```\n+     *\n+     * <p>If we let `(base^x - base^x0) / (base^x1 base^x0)`, then we have `f(x) = y0 + (y1 - y0) *\n+     * ratio`. In other words, `ratio` may be treated as an interpolation factor between the two\n+     * stops' output values.\n+     *\n+     * <p>(Note: a slightly different form for `ratio`, `(base^(x-x0) - 1) / (base^(x1-x0) - 1) `,\n+     * is equivalent, but requires fewer expensive `Math.pow()` operations.)\n+     *\n+     * @private\n+     */\n+    private double exponentialInterpolationRatio(", "originalCommit": "0a8aaea9f8fa2738fbb1a1c4999264c7b447629c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}