{"pr_number": 3265, "pr_title": "[GEOT-6762]: CSS to SLD translation supporting ColorMapEntries with CQL Expression", "pr_createdAt": "2020-12-21T09:32:02Z", "pr_url": "https://github.com/geotools/geotools/pull/3265", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE2NjUyNQ==", "url": "https://github.com/geotools/geotools/pull/3265#discussion_r547166525", "bodyText": "This should have its own test, and maybe its own ticket too.", "author": "aaime", "createdAt": "2020-12-22T09:28:43Z", "path": "modules/library/cql/src/main/java/org/geotools/filter/text/commons/ExpressionToText.java", "diffHunk": "@@ -147,15 +146,22 @@ public Object visit(Add expression, Object extraData) {\n      */\n     @Override\n     public Object visit(Divide expression, Object extraData) {\n-\n         StringBuilder output = asStringBuilder(extraData);\n-        expression.getExpression1().accept(this, output);\n+        visitWithBrackets(expression.getExpression1(), output);\n         output.append(\" / \");\n-        expression.getExpression2().accept(this, output);\n-\n+        visitWithBrackets(expression.getExpression2(), output);\n         return output;\n     }\n \n+    private void visitWithBrackets(Expression expression, StringBuilder output) {", "originalCommit": "8762f457b012c019232796432ef40a4b71065f8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE3NzQxOA==", "url": "https://github.com/geotools/geotools/pull/3265#discussion_r547177418", "bodyText": "The ParseSyntheticTest is actually already containing that test.\nWould that be ok?", "author": "dromagnoli", "createdAt": "2020-12-22T09:50:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE2NjUyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxMTk0Mg==", "url": "https://github.com/geotools/geotools/pull/3265#discussion_r547211942", "bodyText": "I have added a separate CQL text validating the expressions structure/order.", "author": "dromagnoli", "createdAt": "2020-12-22T10:59:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE2NjUyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE2NzYwOA==", "url": "https://github.com/geotools/geotools/pull/3265#discussion_r547167608", "bodyText": "So this builds the final result and checks the default values for env are respected?\nI would also verify that the ColorMap/ColorMapEntries have the expected structure, similar to the one we'd get out of a SLD parse.", "author": "aaime", "createdAt": "2020-12-22T09:30:50Z", "path": "modules/unsupported/css/src/test/java/org/geotools/styling/css/ParserSyntheticTest.java", "diffHunk": "@@ -820,4 +830,51 @@ public void testMultiNestedSelectors() {\n         assertThat(selector, instanceOf(clazz));\n         return clazz.cast(selector);\n     }\n+\n+    @Test\n+    public void testDynamicColorMapEntryFromCss() throws Exception {\n+        String css =\n+                \"* { raster-channels: 'auto'; raster-color-map: color-map-entry(\"\n+                        + \"[env('color','#FF0000')], \"\n+                        + \"[env('min', 1) + 2 * (env('max',10) - env('min',1)) / 3],\"\n+                        + \"[env('customOpacity', 1)])  ;}\";\n+        LinearColorMap colorMap = buildColorMapFromCss(css);", "originalCommit": "8762f457b012c019232796432ef40a4b71065f8e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxMTYxMw==", "url": "https://github.com/geotools/geotools/pull/3265#discussion_r547211613", "bodyText": "Yep. it does 2 passes.\none checking for the default value and one right after having set some ENV values so that the result get different.\nI have updated the test to check that the colormap has the expected structure.", "author": "dromagnoli", "createdAt": "2020-12-22T10:59:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE2NzYwOA=="}], "type": "inlineReview"}, {"oid": "369d6dee07eb0a77b708abb6bd7bf17d7c2dc267", "url": "https://github.com/geotools/geotools/commit/369d6dee07eb0a77b708abb6bd7bf17d7c2dc267", "message": "[GEOT-6762]: CSS to SLD translation supporting ColorMapEntries with CQL Expression", "committedDate": "2020-12-22T10:57:00Z", "type": "commit"}, {"oid": "369d6dee07eb0a77b708abb6bd7bf17d7c2dc267", "url": "https://github.com/geotools/geotools/commit/369d6dee07eb0a77b708abb6bd7bf17d7c2dc267", "message": "[GEOT-6762]: CSS to SLD translation supporting ColorMapEntries with CQL Expression", "committedDate": "2020-12-22T10:57:00Z", "type": "forcePushed"}]}