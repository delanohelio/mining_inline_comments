{"pr_number": 2822, "pr_title": "[GEOT-6520] GeoPackage store aggregates performance regression", "pr_createdAt": "2020-02-29T13:52:15Z", "pr_url": "https://github.com/geotools/geotools/pull/2822", "timeline": [{"oid": "ddbb2453834c97f6e77ae3a885d3d217c8297592", "url": "https://github.com/geotools/geotools/commit/ddbb2453834c97f6e77ae3a885d3d217c8297592", "message": "[GEOT-6520] GeoPackage store aggregates performance regression", "committedDate": "2020-02-29T13:49:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA1NzE4MQ==", "url": "https://github.com/geotools/geotools/pull/2822#discussion_r386057181", "bodyText": "Did we want Double here? Like standard deviation below?", "author": "jodygarnett", "createdAt": "2020-02-29T21:35:08Z", "path": "modules/library/main/src/main/java/org/geotools/feature/visitor/AverageVisitor.java", "diffHunk": "@@ -86,6 +87,20 @@ public void init(SimpleFeatureCollection collection) {\n         return Arrays.asList(expr);\n     }\n \n+    @Override\n+    public Optional<List<Class>> getResultType(List<Class> inputTypes) {\n+        if (inputTypes == null || inputTypes.size() != 1)\n+            throw new IllegalArgumentException(\n+                    \"Expecting a single type in input, not \" + inputTypes);\n+\n+        Class type = inputTypes.get(0);\n+        if (Number.class.isAssignableFrom(type)) {\n+            return Optional.of(inputTypes);", "originalCommit": "ddbb2453834c97f6e77ae3a885d3d217c8297592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA4OTAxOQ==", "url": "https://github.com/geotools/geotools/pull/2822#discussion_r386089019", "bodyText": "Well spotted. I've fixed it and added tests, along with some other type related fixes. They are not used by the aggregation fix, but they better be right anyways, could be of use down the road.", "author": "aaime", "createdAt": "2020-03-01T08:48:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA1NzE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA1NzQzNA==", "url": "https://github.com/geotools/geotools/pull/2822#discussion_r386057434", "bodyText": "Thanks for testing/fixing this!", "author": "jodygarnett", "createdAt": "2020-02-29T21:39:34Z", "path": "modules/plugin/geopkg/src/test/java/org/geotools/geopkg/GeoPkgDatetimeTest.java", "diffHunk": "@@ -102,10 +115,53 @@ public void testUnique() throws IOException {\n         SimpleFeatureSource fs = gpkg.getFeatureSource(gpkg.getTypeNames()[0]);\n \n         SimpleFeatureCollection features = fs.getFeatures();\n-        features.accepts(highlander, new NullProgressListener());\n+        features.accepts(highlander, NULL_LISTENER);\n \n-        Set<Date> uniqueSet = highlander.getUnique();\n+        Set uniqueSet = highlander.getUnique();\n         assertEquals(uniqueSet.size(), features.size());\n+        for (Object value : uniqueSet) {\n+            assertThat(value, CoreMatchers.instanceOf(Date.class));\n+        }\n+    }\n+\n+    @Test\n+    public void testMax() throws IOException {\n+        MaxVisitor max = new MaxVisitor(\"date\");\n+        SimpleFeatureSource fs = gpkg.getFeatureSource(gpkg.getTypeNames()[0]);\n+\n+        SimpleFeatureCollection features = fs.getFeatures();\n+        features.accepts(max, NULL_LISTENER);\n+\n+        assertEquals(java.sql.Date.valueOf(\"2020-02-23\"), max.getMax());", "originalCommit": "ddbb2453834c97f6e77ae3a885d3d217c8297592", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "94acfe0c779bf8b8a5ad568290e2dfca6ced01dc", "url": "https://github.com/geotools/geotools/commit/94acfe0c779bf8b8a5ad568290e2dfca6ced01dc", "message": "[GEOT-6520] Review follow up", "committedDate": "2020-03-01T08:46:13Z", "type": "commit"}]}