{"pr_number": 2858, "pr_title": "[GEOT-6536] : BBOX Filter without geom attribute when using FESConfig\u2026", "pr_createdAt": "2020-04-01T13:13:37Z", "pr_url": "https://github.com/geotools/geotools/pull/2858", "timeline": [{"oid": "1b6d0a985d7648048e8203da7ccdb0b73653ec1b", "url": "https://github.com/geotools/geotools/commit/1b6d0a985d7648048e8203da7ccdb0b73653ec1b", "message": "[GEOT-6536] : BBOX Filter without geom attribute when using FESConfiguration", "committedDate": "2020-04-01T13:12:03Z", "type": "commit"}, {"oid": "10316e3ba80643b0bd1de5c30d7a529bac86f628", "url": "https://github.com/geotools/geotools/commit/10316e3ba80643b0bd1de5c30d7a529bac86f628", "message": "dummy commit to trigger CI/CD workflow", "committedDate": "2020-04-02T14:50:52Z", "type": "commit"}, {"oid": "869a7b7fbb97587172b08840bfddbe905286242d", "url": "https://github.com/geotools/geotools/commit/869a7b7fbb97587172b08840bfddbe905286242d", "message": "Merge branch 'master' of https://github.com/eropartz/geotools", "committedDate": "2020-04-02T14:51:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ2MTI2MQ==", "url": "https://github.com/geotools/geotools/pull/2858#discussion_r411461261", "bodyText": "Letting it simply throw the exception is an easier way to get the test to fail, also gives all details including a stack trace, while this only reports the error message.", "author": "aaime", "createdAt": "2020-04-20T15:15:00Z", "path": "modules/extension/xsd/xsd-fes/src/test/java/org/geotools/filter/v2_0/bindings/BBoxBindingTest.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package org.geotools.filter.v2_0.bindings;\n+\n+import java.io.IOException;\n+import org.geotools.factory.CommonFactoryFinder;\n+import org.geotools.filter.v2_0.FES;\n+import org.geotools.filter.v2_0.FESTestSupport;\n+import org.geotools.geometry.jts.ReferencedEnvelope;\n+import org.geotools.referencing.CRS;\n+import org.geotools.xsd.Encoder;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.opengis.filter.Filter;\n+import org.opengis.filter.FilterFactory2;\n+import org.opengis.filter.expression.Literal;\n+import org.opengis.filter.expression.PropertyName;\n+import org.opengis.filter.spatial.BBOX;\n+import org.opengis.geometry.MismatchedDimensionException;\n+import org.opengis.referencing.FactoryException;\n+import org.opengis.referencing.NoSuchAuthorityCodeException;\n+\n+public class BBoxBindingTest extends FESTestSupport {\n+\n+    @Test\n+    public void testEncode() {\n+        FilterFactory2 ff = CommonFactoryFinder.getFilterFactory2();\n+\n+        try {\n+            ReferencedEnvelope env =\n+                    new ReferencedEnvelope(\n+                            Double.valueOf(48.81752162),\n+                            Double.valueOf(48.81915540),\n+                            Double.valueOf(-3.47568429),\n+                            Double.valueOf(-3.47261370),\n+                            CRS.decode(\"EPSG:4326\"));\n+            Filter bboxFilter = ff.bbox(ff.property(\"geom\"), env);\n+            Encoder encoder = new Encoder(createConfiguration());\n+            String encodedFilter = encoder.encodeAsString(bboxFilter, FES.Filter);\n+            Assert.assertTrue(\n+                    encodedFilter.contains(\"<fes:ValueReference>geom</fes:ValueReference>\"));\n+            Assert.assertTrue(\n+                    encodedFilter.contains(\n+                            \"<gml:Envelope srsDimension=\\\"2\\\" srsName=\\\"urn:ogc:def:crs:EPSG::4326\\\">\"));\n+            Assert.assertTrue(\n+                    encodedFilter.contains(\n+                            \"<gml:lowerCorner>48.817522 -3.475684</gml:lowerCorner>\"));\n+            Assert.assertTrue(\n+                    encodedFilter.contains(\n+                            \"<gml:upperCorner>48.819155 -3.472614</gml:upperCorner>\"));\n+\n+        } catch (MismatchedDimensionException e) {", "originalCommit": "869a7b7fbb97587172b08840bfddbe905286242d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzMjIyOQ==", "url": "https://github.com/geotools/geotools/pull/2858#discussion_r411532229", "bodyText": "OK, Unit test catch exception removed", "author": "eropartz", "createdAt": "2020-04-20T16:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ2MTI2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ2MTM2MA==", "url": "https://github.com/geotools/geotools/pull/2858#discussion_r411461360", "bodyText": "Same as above.", "author": "aaime", "createdAt": "2020-04-20T15:15:08Z", "path": "modules/extension/xsd/xsd-fes/src/test/java/org/geotools/filter/v2_0/bindings/BBoxBindingTest.java", "diffHunk": "@@ -0,0 +1,98 @@\n+package org.geotools.filter.v2_0.bindings;\n+\n+import java.io.IOException;\n+import org.geotools.factory.CommonFactoryFinder;\n+import org.geotools.filter.v2_0.FES;\n+import org.geotools.filter.v2_0.FESTestSupport;\n+import org.geotools.geometry.jts.ReferencedEnvelope;\n+import org.geotools.referencing.CRS;\n+import org.geotools.xsd.Encoder;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.opengis.filter.Filter;\n+import org.opengis.filter.FilterFactory2;\n+import org.opengis.filter.expression.Literal;\n+import org.opengis.filter.expression.PropertyName;\n+import org.opengis.filter.spatial.BBOX;\n+import org.opengis.geometry.MismatchedDimensionException;\n+import org.opengis.referencing.FactoryException;\n+import org.opengis.referencing.NoSuchAuthorityCodeException;\n+\n+public class BBoxBindingTest extends FESTestSupport {\n+\n+    @Test\n+    public void testEncode() {\n+        FilterFactory2 ff = CommonFactoryFinder.getFilterFactory2();\n+\n+        try {\n+            ReferencedEnvelope env =\n+                    new ReferencedEnvelope(\n+                            Double.valueOf(48.81752162),\n+                            Double.valueOf(48.81915540),\n+                            Double.valueOf(-3.47568429),\n+                            Double.valueOf(-3.47261370),\n+                            CRS.decode(\"EPSG:4326\"));\n+            Filter bboxFilter = ff.bbox(ff.property(\"geom\"), env);\n+            Encoder encoder = new Encoder(createConfiguration());\n+            String encodedFilter = encoder.encodeAsString(bboxFilter, FES.Filter);\n+            Assert.assertTrue(\n+                    encodedFilter.contains(\"<fes:ValueReference>geom</fes:ValueReference>\"));\n+            Assert.assertTrue(\n+                    encodedFilter.contains(\n+                            \"<gml:Envelope srsDimension=\\\"2\\\" srsName=\\\"urn:ogc:def:crs:EPSG::4326\\\">\"));\n+            Assert.assertTrue(\n+                    encodedFilter.contains(\n+                            \"<gml:lowerCorner>48.817522 -3.475684</gml:lowerCorner>\"));\n+            Assert.assertTrue(\n+                    encodedFilter.contains(\n+                            \"<gml:upperCorner>48.819155 -3.472614</gml:upperCorner>\"));\n+\n+        } catch (MismatchedDimensionException e) {\n+            Assert.fail(e.getMessage());\n+        } catch (NoSuchAuthorityCodeException e) {\n+            Assert.fail(e.getMessage());\n+        } catch (FactoryException e) {\n+            Assert.fail(e.getMessage());\n+        } catch (IOException e) {\n+            Assert.fail(e.getMessage());\n+        }\n+    }\n+\n+    @Test\n+    public void testParse() {\n+        String xml =\n+                \"<fes:Filter \"\n+                        + \"xmlns:xs='http://www.w3.org/2001/XMLSchema' \"\n+                        + \"xmlns:fes='http://www.opengis.net/fes/2.0' \"\n+                        + \"xmlns:gml='http://www.opengis.net/gml/3.2'>\"\n+                        + \"\t\t<fes:BBOX>\"\n+                        + \"\t\t\t<fes:ValueReference>geom</fes:ValueReference>\"\n+                        + \"\t\t\t<gml:Envelope srsDimension='2' srsName='urn:ogc:def:crs:EPSG::4326'>\"\n+                        + \"\t\t\t\t<gml:lowerCorner>48.817522 -3.475684</gml:lowerCorner>\"\n+                        + \"\t\t\t\t<gml:upperCorner>48.819155 -3.472614</gml:upperCorner>\"\n+                        + \"\t\t\t</gml:Envelope>\"\n+                        + \"\t\t</fes:BBOX>\"\n+                        + \"</fes:Filter>\";\n+\n+        try {\n+            buildDocument(xml);\n+            BBOX bbox = (BBOX) parse();\n+            assertNotNull(bbox);\n+\n+            assertTrue(bbox.getExpression1() instanceof PropertyName);\n+            assertEquals(\"geom\", ((PropertyName) bbox.getExpression1()).getPropertyName());\n+\n+            assertTrue(bbox.getExpression2() instanceof Literal);\n+            assertTrue(bbox.getExpression2().evaluate(null) instanceof ReferencedEnvelope);\n+\n+            ReferencedEnvelope env = (ReferencedEnvelope) bbox.getExpression2().evaluate(null);\n+            assertEquals(Double.valueOf(48.817522), env.getMinX());\n+            assertEquals(Double.valueOf(-3.475684), env.getMinY());\n+            assertEquals(Double.valueOf(48.819155), env.getMaxX());\n+            assertEquals(Double.valueOf(-3.472614), env.getMaxY());\n+\n+        } catch (Exception e) {", "originalCommit": "869a7b7fbb97587172b08840bfddbe905286242d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzMjI5NA==", "url": "https://github.com/geotools/geotools/pull/2858#discussion_r411532294", "bodyText": "OK, Unit test catch exception removed", "author": "eropartz", "createdAt": "2020-04-20T16:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ2MTM2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ2NjQ2OQ==", "url": "https://github.com/geotools/geotools/pull/2858#discussion_r411466469", "bodyText": "Interesting... but legit it seems, from the schema:\n<xsd:complexType name=\"BBOXType\">\n<xsd:complexContent>\n<xsd:extension base=\"fes:SpatialOpsType\">\n<xsd:choice maxOccurs=\"2\">\n<xsd:element ref=\"fes:expression\"/>\n<xsd:any namespace=\"##other\"/>\n</xsd:choice>\n</xsd:extension>\n</xsd:complexContent>\n</xsd:complexType>\n\nGuess the original writer just migrated the code from the superclass, without noticing the schema definition is quite different compared to Filter 1.1, e.g.:\n<xsd:complexType name=\"BBOXType\">\n<xsd:complexContent>\n<xsd:extension base=\"ogc:SpatialOpsType\">\n<xsd:sequence>\n<xsd:element ref=\"ogc:PropertyName\" minOccurs=\"0\"/>\n<xsd:element ref=\"gml:Envelope\"/>\n</xsd:sequence>\n</xsd:extension>\n</xsd:complexContent>\n</xsd:complexType>", "author": "aaime", "createdAt": "2020-04-20T15:21:31Z", "path": "modules/extension/xsd/xsd-fes/src/main/java/org/geotools/filter/v2_0/bindings/BBOXTypeBinding.java", "diffHunk": "@@ -82,7 +82,7 @@ public Class getType() {\n     public Object getProperty(Object object, QName name) throws Exception {\n         BBOX box = (BBOX) object;\n \n-        if (FES.ValueReference.equals(name)) {\n+        if (FES.expression.equals(name)) {", "originalCommit": "869a7b7fbb97587172b08840bfddbe905286242d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f3fe0229ad0e421f8b0df5caad9aa7ca7fab7a1f", "url": "https://github.com/geotools/geotools/commit/f3fe0229ad0e421f8b0df5caad9aa7ca7fab7a1f", "message": "Unit test throw exception instead of assert", "committedDate": "2020-04-20T15:49:37Z", "type": "commit"}]}