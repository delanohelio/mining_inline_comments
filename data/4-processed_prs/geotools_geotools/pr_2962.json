{"pr_number": 2962, "pr_title": "[GEOT-6614]: WKB FootprintLoader messup when concurrently loading", "pr_createdAt": "2020-06-04T16:58:05Z", "pr_url": "https://github.com/geotools/geotools/pull/2962", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc1ODU4MQ==", "url": "https://github.com/geotools/geotools/pull/2962#discussion_r435758581", "bodyText": "Why eat the exception? A normal execution should not throw it, I would let it throw it instead of silently catchig it.", "author": "aaime", "createdAt": "2020-06-05T08:09:18Z", "path": "modules/plugin/imagemosaic/src/test/java/org/geotools/gce/imagemosaic/ImageMosaicFootprintsTest.java", "diffHunk": "@@ -1622,4 +1625,67 @@ private void assertFootprintsCleanup(\n         assertThat(existingFilesPastCleanup, Matchers.emptyArray());\n         assertEquals(otherFilesCount, directory.listFiles(notFileFilter).length);\n     }\n+\n+    @Test\n+    public void testConcurrentWKBFootprintsLoading() throws Exception {\n+        WKBLoaderSPI loaderSPI = new WKBLoaderSPI();\n+        FootprintLoader loader = loaderSPI.createLoader();\n+        File newFolder = folder.newFolder();\n+\n+        // Get a sample WKB file and its footprint geometry\n+        File footprintFile = TestData.file(this, \"footprint_wkbs/r1c1.wkb\");\n+        String footprintPath = footprintFile.getAbsolutePath();\n+        String fileName = FilenameUtils.getName(footprintPath);\n+        footprintPath = footprintPath.substring(0, footprintPath.length() - 4);\n+        Geometry footprint = loader.loadFootprint(footprintPath);\n+\n+        int numberOfSamples = 60;\n+        String[] testFiles = new String[numberOfSamples];\n+\n+        // Let's copy the sample WKB to N different files\n+        for (int i = 0; i < numberOfSamples; i++) {\n+            String newName = fileName.replace(\"c1\", String.format(\"c%03d\", i));\n+            File ithFile = new File(newFolder, newName);\n+            FileUtils.copyFile(footprintFile, ithFile);\n+            File ithFootprintFile = new File(newFolder, FilenameUtils.getBaseName(newName));\n+            testFiles[i] = ithFootprintFile.getAbsolutePath();\n+        }\n+\n+        // Concurrently load the footprints of these sample WKB files\n+        // and add the results to a Geometries list, also counting\n+        // any error occurred during footprint parsing\n+        ExecutorService service = Executors.newFixedThreadPool(numberOfSamples / 2);\n+        CountDownLatch latch = new CountDownLatch(numberOfSamples);\n+        List<Geometry> geometries = new ArrayList<>(numberOfSamples);\n+        AtomicInteger errors = new AtomicInteger();\n+        try {\n+            for (int i = 0; i < numberOfSamples; i++) {\n+                int finalI = i;\n+                service.submit(\n+                        () -> {\n+                            try {\n+                                geometries.add(loader.loadFootprint(testFiles[finalI]));\n+                            } catch (InterruptedException e) {\n+                                // Handle exception\n+                            } catch (Exception e) {\n+                                errors.getAndIncrement();\n+                            }\n+                            latch.countDown();\n+                        });\n+            }\n+            latch.await();\n+        } catch (InterruptedException e) {", "originalCommit": "1d8c33b1c698aff3df02641f52ad023c8903db34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MzE0NQ==", "url": "https://github.com/geotools/geotools/pull/2962#discussion_r435773145", "bodyText": "@aaime\nFixed.", "author": "dromagnoli", "createdAt": "2020-06-05T08:36:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc1ODU4MQ=="}], "type": "inlineReview"}, {"oid": "0470652114963d2cceaef4a2c9d7fbe245d79021", "url": "https://github.com/geotools/geotools/commit/0470652114963d2cceaef4a2c9d7fbe245d79021", "message": "[GEOT-6614]: WKB FootprintLoader messup when concurrently loading", "committedDate": "2020-06-05T08:35:40Z", "type": "commit"}, {"oid": "0470652114963d2cceaef4a2c9d7fbe245d79021", "url": "https://github.com/geotools/geotools/commit/0470652114963d2cceaef4a2c9d7fbe245d79021", "message": "[GEOT-6614]: WKB FootprintLoader messup when concurrently loading", "committedDate": "2020-06-05T08:35:40Z", "type": "forcePushed"}]}