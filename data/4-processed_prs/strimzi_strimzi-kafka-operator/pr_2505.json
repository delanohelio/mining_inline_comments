{"pr_number": 2505, "pr_title": "ST: Add PVC deletion check to avoid that newly created cluster will try to mount old PV", "pr_createdAt": "2020-02-04T14:58:46Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2505", "timeline": [{"oid": "02cea7bbbc2325f99fc7fcf2dc95abcca62002b2", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/02cea7bbbc2325f99fc7fcf2dc95abcca62002b2", "message": "Add PVC deletion to avoid that newly created cluster will try to mount old PV\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-02-04T14:56:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY1MzQxMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2505#discussion_r375653411", "bodyText": "a question ... we have deleteClaim property on the storage which is actually for deleting PVCs when the cluster is deployed. Should you set this flag for your deployed Kafka cluster and then waiting just for deletion instead of forcing it?", "author": "ppatierno", "createdAt": "2020-02-06T06:00:39Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/kubeUtils/objects/PersistentVolumeClaimUtils.java", "diffHunk": "@@ -47,4 +50,22 @@ public static void waitUntilPVCAnnotationChange(Map<String, String> newAnnotatio\n             });\n         LOGGER.info(\"PVC annotation has changed {}\", newAnnotation.toString());\n     }\n+\n+    public static void waitUntilPVCDeletion(String clusterName) {\n+        LOGGER.info(\"Waiting till PVC deletion for cluster {}\", clusterName);\n+        TestUtils.waitFor(\"Waiting till PVC will be deleted {}\", Constants.GLOBAL_POLL_INTERVAL, Constants.GLOBAL_STATUS_TIMEOUT,\n+            () -> {\n+                List<PersistentVolumeClaim> pvcList = kubeClient().listPersistentVolumeClaims().stream().filter(pvc -> pvc.getMetadata().getName().contains(clusterName)).collect(Collectors.toList());\n+                if (pvcList.isEmpty()) {\n+                    return true;\n+                } else {\n+                    for (PersistentVolumeClaim pvc : pvcList) {\n+                        LOGGER.warn(\"PVC {} is not deleted yet! Triggering force delete by cmd client!\", pvc.getMetadata().getName());\n+                        cmdKubeClient().deleteByName(\"pvc\", pvc.getMetadata().getName());", "originalCommit": "02cea7bbbc2325f99fc7fcf2dc95abcca62002b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgwNDUyNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2505#discussion_r375804524", "bodyText": "It's a valid point. I was thinking that we have deleteClaim: true by default but by default it's set to fase. I will change this as well. However, this check which I added is just double check that everything is deleted before new test starts and in case if's still up, we force the deletion. We are doing same with STs, Deployment, etc.", "author": "Frawless", "createdAt": "2020-02-06T12:25:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY1MzQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg0MTg2NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2505#discussion_r375841865", "bodyText": "So it means that it's the current test deleting the PVCs if you are leaving the deleteClaim to the default false.\nI guess it's not the purpose of this test to check that deleteClaim is working fine when it's true. Do you have a corresponding ST for it?", "author": "ppatierno", "createdAt": "2020-02-06T13:47:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY1MzQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI2NzMwOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2505#discussion_r376267309", "bodyText": "Yes we have separated tests for that. I will double check if they are working as expected with these changes just to avoid need to create another fix PR.", "author": "Frawless", "createdAt": "2020-02-07T08:31:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY1MzQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM0MDgzMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2505#discussion_r376340830", "bodyText": "Tests related to deleteClaim options are fine so I am going to mark this one as ready for merge.", "author": "Frawless", "createdAt": "2020-02-07T11:18:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY1MzQxMQ=="}], "type": "inlineReview"}, {"oid": "7d22b5ad8c4304f81ac05aef0f0515fc4e92bd40", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7d22b5ad8c4304f81ac05aef0f0515fc4e92bd40", "message": "Add deleteClaim option for PVC to true\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>", "committedDate": "2020-02-07T08:11:10Z", "type": "commit"}]}