{"pr_number": 2363, "pr_title": "KafkaConnector: Support connector pause/resume and status", "pr_createdAt": "2020-01-06T13:59:56Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363", "timeline": [{"oid": "00c98bfd06439207f1606bbf4eff3ea89d45539a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/00c98bfd06439207f1606bbf4eff3ea89d45539a", "message": "Update derived resources\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-01-07T13:32:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTE4NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r363991184", "bodyText": "What are the usecases for pausing connectors? I'm wondering how well would this work with GitOps models etc. Whether the use case is to pause it in Git or whether it is operational thing in which case GitOps would again unpause it.", "author": "scholzj", "createdAt": "2020-01-07T22:53:13Z", "path": "api/src/main/java/io/strimzi/api/kafka/model/KafkaConnectorSpec.java", "diffHunk": "@@ -32,6 +32,7 @@\n \n     private String className;\n     private Integer tasksMax;\n+    private Boolean pause;", "originalCommit": "00c98bfd06439207f1606bbf4eff3ea89d45539a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEyNjMwMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364126300", "bodyText": "Pausing a connector stops its tasks without causing a rebalance. So it's less invasive to the cluster as a whole than deleting the connector and recreating it later. One use case would be, for example, pausing a connector while performing some upgrade on the external system (to avoid generating lots of errors).", "author": "tombentley", "createdAt": "2020-01-08T09:08:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM0MTM2Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364341362", "bodyText": "So I guess it is across multiple reconciliations and for more than few minutes. I guess it makes sense to have it as field than. As annotation, it would be more as resume annotation and pause annotation and that would cause mess if we later start handling failed connectors etc. So I guess we can keep is more like this to describe a state and not an action.", "author": "scholzj", "createdAt": "2020-01-08T17:05:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTE4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTY2OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r363991668", "bodyText": "Since the resource is a single connector, do we need to have this wrapped into the connector field? Would it be better to have these one level higher? (feel free to say no if you are convinced by this)", "author": "scholzj", "createdAt": "2020-01-07T22:54:43Z", "path": "api/src/test/resources/io/strimzi/api/kafka/model/KafkaConnector.out.yaml", "diffHunk": "@@ -10,4 +10,19 @@ spec:\n   tasksMax: 2\n   config:\n     file: \"/home/source/test.source.txt\"\n-    topic: \"test.topic\"\n\\ No newline at end of file\n+    topic: \"test.topic\"\n+status:\n+  observedGeneration: 0\n+  connector:", "originalCommit": "00c98bfd06439207f1606bbf4eff3ea89d45539a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEyODYxMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364128612", "bodyText": "I wanted to have a single property in which to put the JSON connector status which we receive from the API. I'm not attached to the name (connectorStatus might be better?). The alternative would be to merge the properties of the result from the API with our own properties.\nstatus:\n    observedGeneration: ...#ours\n    conditions: ...#ours\n    connector: # connect's\n      state: PAUSED\n      worker_id: 172.17.0.11:8083\n    name: my-source-connector # connect's\n    tasks: # connect's\n    - id: 0\n      state: RUNNING\n      worker_id: 172.17.0.11:8083\n    type: source # connect's\n\nwhich would be less clear I think, and risk (though it's not likely) a collision in the future if proerties were added to the connect API response.", "author": "tombentley", "createdAt": "2020-01-08T09:13:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEzNzUyMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364137523", "bodyText": "Tbh using connectorStatus under status which is about a connector sounds weird to me.\nMy view is that we are providing a Kubernetes \"view\" of the connector so mixing information from us and from Connect REST API should be the way to go without trying to define \"borders\"?. I can get your concern about future collisions but maybe this won't happen :-)", "author": "ppatierno", "createdAt": "2020-01-08T09:34:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDMzOTgzMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364339833", "bodyText": "Ok, lets keep it as connector.", "author": "scholzj", "createdAt": "2020-01-08T17:01:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM2MzM2OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364363368", "bodyText": "Can we think of a better name? I don't like connector.connector either. It's connectorStatus right now, which I personally think is slightly better, but maybe apiStatus is clearer?", "author": "tombentley", "createdAt": "2020-01-08T17:55:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU3NDE3OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364574178", "bodyText": "@tombentley yes I would use something like api<SOMETHING>. The only thing I am not sure is using \"status\" because we already are under the status field. Maybe apiConnect? Otherwise, let's go for apiStatus I think it's better than the current connectorStatus.", "author": "ppatierno", "createdAt": "2020-01-09T06:18:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDYwOTU5Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364609596", "bodyText": "apiStatus would suggest a status of some API to me, not a status of some entity inside this API.", "author": "scholzj", "createdAt": "2020-01-09T08:30:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDYxMDY2Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364610667", "bodyText": "True. And it's not like where is another source for the status information. So let's settle on connectorStatus.", "author": "tombentley", "createdAt": "2020-01-09T08:33:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTY2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTgwMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r363991802", "bodyText": "Why do we use JsonNode here? Is it just to safe the APi modeling?", "author": "scholzj", "createdAt": "2020-01-07T22:55:07Z", "path": "api/src/main/java/io/strimzi/api/kafka/model/status/KafkaConnectorStatus.java", "diffHunk": "@@ -22,7 +25,19 @@\n @JsonPropertyOrder({ \"conditions\", \"observedGeneration\", \"url\" })\n @EqualsAndHashCode\n @ToString(callSuper = true)\n+@SuppressFBWarnings(\"SE_BAD_FIELD\")\n public class KafkaConnectorStatus extends Status {\n     private static final long serialVersionUID = 1L;\n \n+    private JsonNode connector;\n+\n+    @JsonInclude(JsonInclude.Include.NON_NULL)\n+    @Description(\"The connector status, as reported by the Kafka Connect REST API.\")\n+    public JsonNode getConnector() {", "originalCommit": "00c98bfd06439207f1606bbf4eff3ea89d45539a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEzMDYwOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364130608", "bodyText": "Originally I went to the trouble of writing classes to model the API response schema, but I decided that was probably a bad idea since we end up coupling our CRD schema to Connect's API response schema (which we don't control, thus creating compatibility problems for us if their response gains extra properties).\nSo I decided that our schema should basically have this property whose JSON type should be object. Usually we use a Map<String, Object> for that, I thought it wasn't trivial to get Jackson to do that. Looking again, maybe it's a lot easier than I thought... I'll take a look.", "author": "tombentley", "createdAt": "2020-01-08T09:18:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEzMTQzNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364131434", "bodyText": "Do you remember we had problem using JsonNode with the KafkaClusterRebalanceStatus.optimizationResult field so we moved to use Map<String, Object>. The optimization result is a JSON quite like the connector information you get from the Connect REST API.", "author": "ppatierno", "createdAt": "2020-01-08T09:20:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEzNjUyNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364136525", "bodyText": "I don't recall the problem, but I was prepared to \"fix\" the CrdGenerator and DocGenerator to make JsonNode work. But having said that, I'm going to try again to make Map work.", "author": "tombentley", "createdAt": "2020-01-08T09:32:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDMzOTU1NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364339554", "bodyText": "So I wonder if this is just shifting the Connect APi stability to the users when we do not model the classes. But I guess I can live with it.", "author": "scholzj", "createdAt": "2020-01-08T17:01:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM2MTgzNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364361836", "bodyText": "Indeed, but the alternative (us being in the loop to provide compatibility and/or needing to update a schema for it) seemed more attractive to me.", "author": "tombentley", "createdAt": "2020-01-08T17:51:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MTgwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MzI3NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r363993274", "bodyText": "Is the FAILED state actually set anywhere in the code? Or is it just here?", "author": "scholzj", "createdAt": "2020-01-07T22:59:54Z", "path": "api/src/test/resources/io/strimzi/api/kafka/model/KafkaConnector.out.yaml", "diffHunk": "@@ -10,4 +10,19 @@ spec:\n   tasksMax: 2\n   config:\n     file: \"/home/source/test.source.txt\"\n-    topic: \"test.topic\"\n\\ No newline at end of file\n+    topic: \"test.topic\"\n+status:\n+  observedGeneration: 0\n+  connector:\n+    name: \"hdfs-sink-connector\"\n+    connector:\n+      state: \"RUNNING\"\n+      worker_id: \"whatever:8083\"\n+    tasks:\n+    - id: 0\n+      state: \"FAILED\"", "originalCommit": "00c98bfd06439207f1606bbf4eff3ea89d45539a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEzMjMwNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364132305", "bodyText": "Connect has these states:\n        UNASSIGNED,\n        RUNNING,\n        PAUSED,\n        FAILED,\n        DESTROYED,\n\nOur code only cares about RUNNING and PAUSED (so as to decide whether a pause or resume is necessary). In any case, the state is just passed through to the CR status.", "author": "tombentley", "createdAt": "2020-01-08T09:22:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MzI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDMzODg4Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364338886", "bodyText": "Ok, so the status would list all of them and let you monitor the state. We just don't do anything about them so far.", "author": "scholzj", "createdAt": "2020-01-08T16:59:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk5MzI3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExNTUxNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364115517", "bodyText": "this is quite related to what I mentioned in the comment on the PR. Why having connector.connector.state (or .worker_id) instead of just connector.state (or .worker_id)?", "author": "ppatierno", "createdAt": "2020-01-08T08:41:32Z", "path": "api/src/test/resources/io/strimzi/api/kafka/model/KafkaConnector.out.yaml", "diffHunk": "@@ -10,4 +10,19 @@ spec:\n   tasksMax: 2\n   config:\n     file: \"/home/source/test.source.txt\"\n-    topic: \"test.topic\"\n\\ No newline at end of file\n+    topic: \"test.topic\"\n+status:\n+  observedGeneration: 0\n+  connector:\n+    name: \"hdfs-sink-connector\"\n+    connector:\n+      state: \"RUNNING\"\n+      worker_id: \"whatever:8083\"", "originalCommit": "00c98bfd06439207f1606bbf4eff3ea89d45539a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEzNTkzNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2363#discussion_r364135936", "bodyText": "The first connector is the name of the property in our schema (which we could rename connectorStatus or anything else which we can agree on). The second connector is the name of a property in the Connect API response which we have no control over.", "author": "tombentley", "createdAt": "2020-01-08T09:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExNTUxNw=="}], "type": "inlineReview"}, {"oid": "6a3440b9fef1f6419939d0f0364604d7db01ee34", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6a3440b9fef1f6419939d0f0364604d7db01ee34", "message": "    KafkaConnector: Support connector pause/resume\n\n    * Add a `pause` property to the `KafkaConnector.spec` to control pause/resume\n    * Add a `connector` property to the `KafkaConnector.status` to expose\n      connector status. This is the JSON result of the\n      GET /connectors/<connector>/status endpoint. With this change a\n      typical status looks like like this:\n        ```\n          status:\n            conditions:\n            - lastTransitionTime: \"2020-01-06T13:44:20.031Z\"\n              status: \"True\"\n              type: Ready\n            connector:\n              connector:\n                state: PAUSED\n                worker_id: 172.17.0.11:8083\n              name: my-source-connector\n              tasks:\n              - id: 0\n                state: RUNNING\n                worker_id: 172.17.0.11:8083\n              type: source\n            observedGeneration: 2\n        ```\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-01-08T12:27:00Z", "type": "commit"}, {"oid": "6a3440b9fef1f6419939d0f0364604d7db01ee34", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6a3440b9fef1f6419939d0f0364604d7db01ee34", "message": "    KafkaConnector: Support connector pause/resume\n\n    * Add a `pause` property to the `KafkaConnector.spec` to control pause/resume\n    * Add a `connector` property to the `KafkaConnector.status` to expose\n      connector status. This is the JSON result of the\n      GET /connectors/<connector>/status endpoint. With this change a\n      typical status looks like like this:\n        ```\n          status:\n            conditions:\n            - lastTransitionTime: \"2020-01-06T13:44:20.031Z\"\n              status: \"True\"\n              type: Ready\n            connector:\n              connector:\n                state: PAUSED\n                worker_id: 172.17.0.11:8083\n              name: my-source-connector\n              tasks:\n              - id: 0\n                state: RUNNING\n                worker_id: 172.17.0.11:8083\n              type: source\n            observedGeneration: 2\n        ```\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-01-08T12:27:00Z", "type": "forcePushed"}, {"oid": "3fd8c231a765b5a307172cde3b4ebb35d9169bb6", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3fd8c231a765b5a307172cde3b4ebb35d9169bb6", "message": "spotbugs\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-01-08T13:16:46Z", "type": "commit"}, {"oid": "e6b063112a49bae6ecc22b12cf1888fb8ae766a7", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e6b063112a49bae6ecc22b12cf1888fb8ae766a7", "message": "import\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-01-08T14:03:18Z", "type": "commit"}, {"oid": "e6b063112a49bae6ecc22b12cf1888fb8ae766a7", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e6b063112a49bae6ecc22b12cf1888fb8ae766a7", "message": "import\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-01-08T14:03:18Z", "type": "forcePushed"}]}