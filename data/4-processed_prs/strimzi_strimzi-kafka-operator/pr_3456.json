{"pr_number": 3456, "pr_title": "[systemtest][mm2] Test scale mm2 to zero replicas", "pr_createdAt": "2020-08-05T10:54:59Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3456", "timeline": [{"oid": "57b1fc1468a79a437ae623d71a146e75668b4abf", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/57b1fc1468a79a437ae623d71a146e75668b4abf", "message": "add test for scaling mm2 to zero\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-05T10:55:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY3NjU5OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3456#discussion_r465676599", "bodyText": "Since you already do asserts on the status, maybe you can also check that url is not set.", "author": "scholzj", "createdAt": "2020-08-05T12:03:06Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/mirrormaker/MirrorMaker2ST.java", "diffHunk": "@@ -653,6 +655,39 @@ void testMirrorMaker2CorrectlyMirrorsHeaders() {\n         assertThat(log, containsString(header1));\n         assertThat(log, containsString(header2));\n     }\n+\n+    @Test\n+    void testScaleMirrorMaker2ToZero() {\n+        // Deploy source kafka\n+        KafkaResource.kafkaEphemeral(kafkaClusterSourceName, 1, 1).done();\n+        // Deploy target kafka\n+        KafkaResource.kafkaEphemeral(kafkaClusterTargetName, 1, 1).done();\n+\n+        KafkaMirrorMaker2Resource.kafkaMirrorMaker2(CLUSTER_NAME, kafkaClusterTargetName, kafkaClusterSourceName, 3, false)\n+            .editMetadata()\n+                .addToLabels(\"type\", \"kafka-mirror-maker-2\")\n+            .endMetadata()\n+            .done();\n+\n+        long oldObsGen = KafkaMirrorMaker2Resource.kafkaMirrorMaker2Client().inNamespace(NAMESPACE).withName(CLUSTER_NAME).get().getStatus().getObservedGeneration();\n+        String mm2DepName = KafkaMirrorMaker2Resources.deploymentName(CLUSTER_NAME);\n+        List<String> mm2Pods = kubeClient().listPodNames(\"type\", \"kafka-mirror-maker-2\");\n+        assertThat(mm2Pods.size(), is(3));\n+\n+        LOGGER.info(\"Scaling MirrorMaker to zero\");\n+        KafkaMirrorMaker2Resource.replaceKafkaMirrorMaker2Resource(CLUSTER_NAME, mm2 -> mm2.getSpec().setReplicas(0));\n+\n+        PodUtils.waitForPodsReady(kubeClient().getDeploymentSelectors(mm2DepName), 0, true);\n+\n+        mm2Pods = kubeClient().listPodNames(\"type\", \"kafka-mirror-maker-2\");\n+        KafkaMirrorMaker2Status mm2Status = KafkaMirrorMaker2Resource.kafkaMirrorMaker2Client().inNamespace(NAMESPACE).withName(CLUSTER_NAME).get().getStatus();\n+        long actualObsGen = KafkaMirrorMaker2Resource.kafkaMirrorMaker2Client().inNamespace(NAMESPACE).withName(CLUSTER_NAME).get().getStatus().getObservedGeneration();\n+\n+        assertThat(mm2Pods.size(), is(0));\n+        assertThat(mm2Status.getConditions().get(0).getType(), is(\"Ready\"));\n+        assertThat(actualObsGen, is(not(oldObsGen)));", "originalCommit": "57b1fc1468a79a437ae623d71a146e75668b4abf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwMTcyNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3456#discussion_r465801727", "bodyText": "\"MirrorMaker2\"", "author": "ppatierno", "createdAt": "2020-08-05T15:13:53Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/mirrormaker/MirrorMaker2ST.java", "diffHunk": "@@ -653,6 +655,40 @@ void testMirrorMaker2CorrectlyMirrorsHeaders() {\n         assertThat(log, containsString(header1));\n         assertThat(log, containsString(header2));\n     }\n+\n+    @Test\n+    void testScaleMirrorMaker2ToZero() {\n+        // Deploy source kafka\n+        KafkaResource.kafkaEphemeral(kafkaClusterSourceName, 1, 1).done();\n+        // Deploy target kafka\n+        KafkaResource.kafkaEphemeral(kafkaClusterTargetName, 1, 1).done();\n+\n+        KafkaMirrorMaker2Resource.kafkaMirrorMaker2(CLUSTER_NAME, kafkaClusterTargetName, kafkaClusterSourceName, 3, false)\n+            .editMetadata()\n+                .addToLabels(\"type\", \"kafka-mirror-maker-2\")\n+            .endMetadata()\n+            .done();\n+\n+        long oldObsGen = KafkaMirrorMaker2Resource.kafkaMirrorMaker2Client().inNamespace(NAMESPACE).withName(CLUSTER_NAME).get().getStatus().getObservedGeneration();\n+        String mm2DepName = KafkaMirrorMaker2Resources.deploymentName(CLUSTER_NAME);\n+        List<String> mm2Pods = kubeClient().listPodNames(\"type\", \"kafka-mirror-maker-2\");\n+        assertThat(mm2Pods.size(), is(3));\n+\n+        LOGGER.info(\"Scaling MirrorMaker to zero\");", "originalCommit": "a081d24404f8f139354671a36b918d4fb223abea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1dbc5b45eb85d3d6cb7bf77dba3ccbb87b41a605", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1dbc5b45eb85d3d6cb7bf77dba3ccbb87b41a605", "message": "add test for scaling mm2 to zero\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-05T20:59:01Z", "type": "commit"}, {"oid": "28af3512aeaffae55e60482775adf5294d9a40f2", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/28af3512aeaffae55e60482775adf5294d9a40f2", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-05T20:59:01Z", "type": "commit"}, {"oid": "094c3a277520d98a8339d0a67d139ce96abd2bd7", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/094c3a277520d98a8339d0a67d139ce96abd2bd7", "message": "comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-05T20:59:01Z", "type": "commit"}, {"oid": "923151fdc50212823d1a4c024a045d398ab6f1cd", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/923151fdc50212823d1a4c024a045d398ab6f1cd", "message": "fixup! comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-05T22:24:43Z", "type": "commit"}, {"oid": "923151fdc50212823d1a4c024a045d398ab6f1cd", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/923151fdc50212823d1a4c024a045d398ab6f1cd", "message": "fixup! comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-05T22:24:43Z", "type": "forcePushed"}, {"oid": "63a06ef89552d4051f723f4d41155234fb320817", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/63a06ef89552d4051f723f4d41155234fb320817", "message": "fixup! fixup! comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-06T07:04:37Z", "type": "commit"}, {"oid": "63a06ef89552d4051f723f4d41155234fb320817", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/63a06ef89552d4051f723f4d41155234fb320817", "message": "fixup! fixup! comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-06T07:04:37Z", "type": "forcePushed"}]}