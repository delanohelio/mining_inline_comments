{"pr_number": 3206, "pr_title": "Helm3 crds", "pr_createdAt": "2020-06-16T18:07:32Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0NTAwMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441045001", "bodyText": "This appears unused in both _helpers.tpl so I went ahead and cleaned it up. This is split into a separate commit and I can remove it if we don't want this change.", "author": "michael-barker", "createdAt": "2020-06-16T18:08:41Z", "path": "helm-charts/helm2/strimzi-kafka-operator/templates/_helpers.tpl", "diffHunk": "@@ -31,19 +31,6 @@ Create chart name and version as used by the chart label.\n {{- printf \"%s-%s\" .Chart.Name .Chart.Version | replace \"+\" \"_\" | trunc 63 | trimSuffix \"-\" -}}\n {{- end -}}\n \n-{{/*", "originalCommit": "570e61f3f45ee85a8241bdddb6a52316ef9d11c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0NTU0NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441045544", "bodyText": "imageRepositoryOverride and imageTagOverride are used in the chart but not present in the values.yaml. This was added to both charts for reference.", "author": "michael-barker", "createdAt": "2020-06-16T18:09:35Z", "path": "helm-charts/helm2/strimzi-kafka-operator/values.yaml", "diffHunk": "@@ -117,7 +116,7 @@ readinessProbe:\n   periodSeconds: 30\n \n # Override the docker image repository used by all Strimzi images\n-# imageRepositoryOverride: foobar\n+imageRepositoryOverride: \"\"", "originalCommit": "570e61f3f45ee85a8241bdddb6a52316ef9d11c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0NTk4OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441045989", "bodyText": "All templating is removed from the CRDs as templates are not support in the crds directory for Helm 3.", "author": "michael-barker", "createdAt": "2020-06-16T18:10:25Z", "path": "helm-charts/helm3/strimzi-kafka-operator/crds/040-Crd-kafka.yaml", "diffHunk": "@@ -1,15 +1,10 @@\n-{{- if .Values.createGlobalResources -}}", "originalCommit": "570e61f3f45ee85a8241bdddb6a52316ef9d11c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0NjU3MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441046570", "bodyText": "Since the CRDs no longer contain templates, we're able to remove several usages of yq to modify the yml.", "author": "michael-barker", "createdAt": "2020-06-16T18:11:24Z", "path": "install/Makefile", "diffHunk": "@@ -38,32 +38,26 @@ crd_install_helm2:\n crd_install_helm3:\n \t$(CP) ./cluster-operator/043-Crd-kafkatopic.yaml ./topic-operator/04-Crd-kafkatopic.yaml\n \t$(CP) ./cluster-operator/044-Crd-kafkauser.yaml ./user-operator/04-Crd-kafkauser.yaml\n-\t$(CP) ./cluster-operator/040-Crd-kafka.yaml ../helm-charts/helm3/strimzi-kafka-operator/templates/040-Crd-kafka.yaml\n-\t$(CP) ./cluster-operator/041-Crd-kafkaconnect.yaml ../helm-charts/helm3/strimzi-kafka-operator/templates/041-Crd-kafkaconnect.yaml\n-\t$(CP) ./cluster-operator/042-Crd-kafkaconnects2i.yaml ../helm-charts/helm3/strimzi-kafka-operator/templates/042-Crd-kafkaconnects2i.yaml\n-\t$(CP) ./cluster-operator/043-Crd-kafkatopic.yaml ../helm-charts/helm3/strimzi-kafka-operator/templates/043-Crd-kafkatopic.yaml\n-\t$(CP) ./cluster-operator/044-Crd-kafkauser.yaml ../helm-charts/helm3/strimzi-kafka-operator/templates/044-Crd-kafkauser.yaml\n-\t$(CP) ./cluster-operator/045-Crd-kafkamirrormaker.yaml ../helm-charts/helm3/strimzi-kafka-operator/templates/045-Crd-kafkamirrormaker.yaml\n-\t$(CP) ./cluster-operator/046-Crd-kafkabridge.yaml ../helm-charts/helm3/strimzi-kafka-operator/templates/046-Crd-kafkabridge.yaml\n-\t$(CP) ./cluster-operator/047-Crd-kafkaconnector.yaml ../helm-charts/helm3/strimzi-kafka-operator/templates/047-Crd-kafkaconnector.yaml\n-\t$(CP) ./cluster-operator/048-Crd-kafkamirrormaker2.yaml ../helm-charts/helm3/strimzi-kafka-operator/templates/048-Crd-kafkamirrormaker2.yaml\n-\t$(CP) ./cluster-operator/049-Crd-kafkarebalance.yaml ../helm-charts/helm3/strimzi-kafka-operator/templates/049-Crd-kafkarebalance.yaml\n-\toldpath=`pwd` && cd ../helm-charts/helm3/strimzi-kafka-operator/templates/ &&  $(FIND) . -type f -name '04*-Crd-*.yaml' -exec yq write -i {} metadata.labels.app \"{{ template \\\"strimzi.name\\\" . }}\" \\; && cd $$oldpath", "originalCommit": "570e61f3f45ee85a8241bdddb6a52316ef9d11c2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bb397a9ca4c80c3c4c3e769eacaf3a7f6497348b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/bb397a9ca4c80c3c4c3e769eacaf3a7f6497348b", "message": "Move Helm 3 chart CRDs to the crds directory (#3203)\n\nHelm charts can have dependencies on other Helm charts. When a\ndependent chart has CRDs that need to be installed and the parent\nchart is installing CRs using those CRDs, ordering becomes\nimportant. In Helm 3 this ordering is handled by placing the CRDs\nin a special crds directory. Helm will always install these CRDs\nfirst.\n\nBy moving the CRDs to the crds directory, charts can include\nStrimzi as a dependency without ordering issues related to\ninstalling CRDs.\n\nSigned-off-by: Michael Barker <michael.barker.84@gmail.com>", "committedDate": "2020-06-16T18:18:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwMzQzOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441103438", "bodyText": "I think the app label is fairly useful to find all resources belonging to the app ... I wonder if we should find a way to add it back. But not sure what the options are if the templates are not supported here.", "author": "scholzj", "createdAt": "2020-06-16T19:51:37Z", "path": "helm-charts/helm3/strimzi-kafka-operator/crds/040-Crd-kafka.yaml", "diffHunk": "@@ -1,15 +1,10 @@\n-{{- if .Values.createGlobalResources -}}\n apiVersion: apiextensions.k8s.io/v1beta1\n kind: CustomResourceDefinition\n metadata:\n   name: kafkas.kafka.strimzi.io\n   labels:\n-    app: '{{ template \"strimzi.name\" . }}'", "originalCommit": "bb397a9ca4c80c3c4c3e769eacaf3a7f6497348b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyMjQ5NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441122494", "bodyText": "Previously, the default value here is \"strimzi\" as set in _helpers.tpl. I was able to find 2 examples where charts that define the CRDs in the crds directory apply an app label. Should I add the app label back and set it to \"strimzi\"?\nhttps://github.com/helm/charts/blob/master/stable/etcd-operator/crds/etcd-cluster-crd.yaml#L8\nhttps://github.com/helm/charts/blob/master/stable/jaeger-operator/crds/crd.yaml#L9\nI guess this could be a breaking change if a user is looking at these labels for something. I can't think of a use case though where someone would do that for CRDs.", "author": "michael-barker", "createdAt": "2020-06-16T20:29:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwMzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyMzE5OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441123198", "bodyText": "TBH, I find it useful. But I'm also fine to follow the Helm conventions which I don't know too much.", "author": "scholzj", "createdAt": "2020-06-16T20:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwMzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyMzU2OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441123568", "bodyText": "I also guess it makes no sense to have here hardcoded app: strimzi while in the other resources to have configurable app: something-else.", "author": "scholzj", "createdAt": "2020-06-16T20:30:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwMzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzNjM2MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441136360", "bodyText": "@scholzj @sgkiokas After running make crd_install the app label was added back. I had originally edited the CRDs directly not understand that they were generated by the makefile. Do we have a consensus on whether to keep the app label or should I update the makefile to remove the app label?", "author": "michael-barker", "createdAt": "2020-06-16T20:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwMzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE2Mjg2NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441162865", "bodyText": "I think you said on the beginning that templates are not support in the crds directory for Helm 3 ... so to be honest it is not clear to me if keep the app label actually works or not. If it works I would keep it I guess.", "author": "scholzj", "createdAt": "2020-06-16T21:51:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwMzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE5MjMwMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441192303", "bodyText": "This wouldn't be a template. The app label would be hard coded to the value \"strimzi\".", "author": "michael-barker", "createdAt": "2020-06-16T23:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwMzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMxNjQ4NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441316485", "bodyText": "Ah, ok. I think that makes really sense only if we hardcode the app label to strimzi in the other resources as well. Otherwise I see little value in it. Is it common in other Helm Charts to have the app label configurable?", "author": "scholzj", "createdAt": "2020-06-17T06:46:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwMzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2NDIzNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441364234", "bodyText": "I'm in agreement here, the app label is not really necessary, since we can easily find them due to having a deterministic resource group.\nWhichever is easiest from a generation perspective, either keeping the app label or not adding the label is what I suggest we do here.", "author": "samuel-hawker", "createdAt": "2020-06-17T08:13:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwMzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU0Njk4Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441546986", "bodyText": "Whichever is easiest from a generation perspective, either keeping the app label or not adding the label is what I suggest we do here.\n\n@samuel-hawker Shouldn't be difficult to write a yq command to remove the app label but easiest is to leave it.", "author": "michael-barker", "createdAt": "2020-06-17T13:31:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwMzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYzNjI5Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441636297", "bodyText": "Yes leave it for now and we can remove it if there is sensible justification for it.", "author": "samuel-hawker", "createdAt": "2020-06-17T15:30:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEwMzQzOA=="}], "type": "inlineReview"}, {"oid": "26714c2471ec490c59b3124fe52f1e1acb8f4070", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/26714c2471ec490c59b3124fe52f1e1acb8f4070", "message": "Move Helm 3 chart CRDs to the crds directory (#3203)\n\nHelm charts can have dependencies on other Helm charts. When a\ndependent chart has CRDs that need to be installed and the parent\nchart is installing CRs using those CRDs, ordering becomes\nimportant. In Helm 3 this ordering is handled by placing the CRDs\nin a special crds directory. Helm will always install these CRDs\nfirst.\n\nBy moving the CRDs to the crds directory, charts can include\nStrimzi as a dependency without ordering issues related to\ninstalling CRDs.\n\nSigned-off-by: Michael Barker <michael.barker.84@gmail.com>", "committedDate": "2020-06-16T20:31:55Z", "type": "forcePushed"}, {"oid": "eead3f8b238810ad24a7844a8568568572b66c3d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/eead3f8b238810ad24a7844a8568568572b66c3d", "message": "Move Helm 3 chart CRDs to the crds directory (#3203)\n\nHelm charts can have dependencies on other Helm charts. When a\ndependent chart has CRDs that need to be installed and the parent\nchart is installing CRs using those CRDs, ordering becomes\nimportant. In Helm 3 this ordering is handled by placing the CRDs\nin a special crds directory. Helm will always install these CRDs\nfirst.\n\nBy moving the CRDs to the crds directory, charts can include\nStrimzi as a dependency without ordering issues related to\ninstalling CRDs.\n\nSigned-off-by: Michael Barker <michael.barker.84@gmail.com>", "committedDate": "2020-06-17T13:29:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMzc0MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3206#discussion_r441723741", "bodyText": "The build was failing for me locally with JDK 14 due to more strict ordering for headers in Javadoc.", "author": "michael-barker", "createdAt": "2020-06-17T17:51:57Z", "path": "crd-generator/src/main/java/io/strimzi/crdgenerator/CrdGenerator.java", "diffHunk": "@@ -63,7 +63,7 @@\n  * <p>The tool works by recursing through class properties (in the JavaBeans sense)\n  * and the types of those properties, guided by the annotations.</p>\n  *\n- * <h3>Annotations</h3>\n+ * <h2>Annotations</h2>", "originalCommit": "33216b7f2eb82ed4b4cf0ec9b56fb05f896752e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7a58c4d106d8a35fbac8d47734fa10edb2416abb", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7a58c4d106d8a35fbac8d47734fa10edb2416abb", "message": "Add used but missing values to chart values.yaml\n\nimageRepositoryOverride and imageTagOverride are used but do not exist\nthe the values.yaml for the charts. Adding them with a default value of\nan empty string preserves existing behavior but makes the values more\nvisible to user when referencing the values.yaml.\n\nSigned-off-by: Michael Barker <michael.barker.84@gmail.com>", "committedDate": "2020-06-17T17:53:21Z", "type": "commit"}, {"oid": "080cc4ee73c07be6a5498cac1967ea9112d9a3c4", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/080cc4ee73c07be6a5498cac1967ea9112d9a3c4", "message": "Remove unused Helm template in _helpers.tpl\n\nRemoving the dockerRegistryOverride from _helpers.tpl for both charts as this\nvalue is unused. The imageRepositoryOverride template appears to serve the\nsame purpose and is used in the charts.\n\nSigned-off-by: Michael Barker <michael.barker.84@gmail.com>", "committedDate": "2020-06-17T17:53:21Z", "type": "commit"}, {"oid": "e9ef53fb1b6a2135543b44182a2d015b97dd2207", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e9ef53fb1b6a2135543b44182a2d015b97dd2207", "message": "Move Helm 3 chart CRDs to the crds directory (#3203)\n\nHelm charts can have dependencies on other Helm charts. When a\ndependent chart has CRDs that need to be installed and the parent\nchart is installing CRs using those CRDs, ordering becomes\nimportant. In Helm 3 this ordering is handled by placing the CRDs\nin a special crds directory. Helm will always install these CRDs\nfirst.\n\nBy moving the CRDs to the crds directory, charts can include\nStrimzi as a dependency without ordering issues related to\ninstalling CRDs.\n\nSigned-off-by: Michael Barker <michael.barker.84@gmail.com>", "committedDate": "2020-06-17T17:53:21Z", "type": "commit"}, {"oid": "00c178b7f66bdd8304670fd16530bceb5ee92de8", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/00c178b7f66bdd8304670fd16530bceb5ee92de8", "message": "Fix Javadoc header ordering\n\nWhen building with JDK 14, the build fails with an error due to stricter Javadoc\nrules added in JDK 13.\n\nSigned-off-by: Michael Barker <michael.barker.84@gmail.com>", "committedDate": "2020-06-17T17:53:21Z", "type": "commit"}, {"oid": "48a83d8be1b1247b9919647c1d90f3b2b0b7381b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/48a83d8be1b1247b9919647c1d90f3b2b0b7381b", "message": "Fix missing trailing slash in multi-line command\n\nThe script echoed by the build script when there are uncommitted changes to\ngenerator or derived resources was missing a trailing slash causing the\ncommand to fail when copying and pasting the command.\n\nSigned-off-by: Michael Barker <michael.barker.84@gmail.com>", "committedDate": "2020-06-17T17:53:21Z", "type": "commit"}, {"oid": "48a83d8be1b1247b9919647c1d90f3b2b0b7381b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/48a83d8be1b1247b9919647c1d90f3b2b0b7381b", "message": "Fix missing trailing slash in multi-line command\n\nThe script echoed by the build script when there are uncommitted changes to\ngenerator or derived resources was missing a trailing slash causing the\ncommand to fail when copying and pasting the command.\n\nSigned-off-by: Michael Barker <michael.barker.84@gmail.com>", "committedDate": "2020-06-17T17:53:21Z", "type": "forcePushed"}, {"oid": "dc9a7d316fd3d1dfc10a720cd047ebde8606bd76", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/dc9a7d316fd3d1dfc10a720cd047ebde8606bd76", "message": "Fix generated resources\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-06-17T19:37:51Z", "type": "commit"}]}