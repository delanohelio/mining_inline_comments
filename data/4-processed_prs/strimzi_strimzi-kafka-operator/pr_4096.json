{"pr_number": 4096, "pr_title": "Kafka connect: add jmxOptions", "pr_createdAt": "2020-12-12T01:18:16Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4096", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTc5MTY5Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4096#discussion_r541791697", "bodyText": "Why do we need this import when we did not changed anything?", "author": "scholzj", "createdAt": "2020-12-12T22:19:43Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaMirrorMakerAssemblyOperator.java", "diffHunk": "@@ -5,6 +5,7 @@\n package io.strimzi.operator.cluster.operator.assembly;\n \n import io.fabric8.kubernetes.api.model.ConfigMap;\n+import io.fabric8.kubernetes.api.model.Secret;", "originalCommit": "022f482a2c1fbe0cc53f1737fb90198255d01ca8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTc5MTcxNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4096#discussion_r541791716", "bodyText": "Same as above.", "author": "scholzj", "createdAt": "2020-12-12T22:19:50Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaMirrorMakerAssemblyOperator.java", "diffHunk": "@@ -20,6 +21,7 @@\n import io.strimzi.operator.cluster.ClusterOperatorConfig;\n import io.strimzi.operator.PlatformFeaturesAvailability;\n import io.strimzi.operator.cluster.model.InvalidResourceException;\n+import io.strimzi.operator.cluster.model.KafkaConnectCluster;", "originalCommit": "022f482a2c1fbe0cc53f1737fb90198255d01ca8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTc5NDQ5Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4096#discussion_r541794496", "bodyText": "Could you please not group the imports? (Not just here but in all the files)", "author": "scholzj", "createdAt": "2020-12-12T22:38:38Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaConnectCluster.java", "diffHunk": "@@ -4,31 +4,7 @@\n  */\n package io.strimzi.operator.cluster.model;\n \n-import io.fabric8.kubernetes.api.model.Affinity;\n-import io.fabric8.kubernetes.api.model.AffinityBuilder;\n-import io.fabric8.kubernetes.api.model.ConfigMapVolumeSource;\n-import io.fabric8.kubernetes.api.model.Container;\n-import io.fabric8.kubernetes.api.model.ContainerBuilder;\n-import io.fabric8.kubernetes.api.model.ContainerPort;\n-import io.fabric8.kubernetes.api.model.EnvVar;\n-import io.fabric8.kubernetes.api.model.EnvVarBuilder;\n-import io.fabric8.kubernetes.api.model.EnvVarSource;\n-import io.fabric8.kubernetes.api.model.EnvVarSourceBuilder;\n-import io.fabric8.kubernetes.api.model.HasMetadata;\n-import io.fabric8.kubernetes.api.model.IntOrString;\n-import io.fabric8.kubernetes.api.model.LocalObjectReference;\n-import io.fabric8.kubernetes.api.model.Quantity;\n-import io.fabric8.kubernetes.api.model.ResourceRequirements;\n-import io.fabric8.kubernetes.api.model.ResourceRequirementsBuilder;\n-import io.fabric8.kubernetes.api.model.SecretVolumeSource;\n-import io.fabric8.kubernetes.api.model.SecurityContext;\n-import io.fabric8.kubernetes.api.model.Service;\n-import io.fabric8.kubernetes.api.model.ServicePort;\n-import io.fabric8.kubernetes.api.model.Toleration;\n-import io.fabric8.kubernetes.api.model.Volume;\n-import io.fabric8.kubernetes.api.model.VolumeBuilder;\n-import io.fabric8.kubernetes.api.model.VolumeMount;\n-import io.fabric8.kubernetes.api.model.VolumeMountBuilder;\n+import io.fabric8.kubernetes.api.model.*;", "originalCommit": "022f482a2c1fbe0cc53f1737fb90198255d01ca8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6901a340c1f5f95072c44a67681ab11e5f2d462e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6901a340c1f5f95072c44a67681ab11e5f2d462e", "message": "fix test\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2020-12-16T19:12:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5MDE4Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4096#discussion_r544590183", "bodyText": "Could you add this test also for the KafkaConnectAssemblyOperatorTest and for KAfkaMirrorMaker2AssemblyOperatorTest? That would help to have it tested for all of them.", "author": "scholzj", "createdAt": "2020-12-16T20:09:46Z", "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaConnectS2IAssemblyOperatorTest.java", "diffHunk": "@@ -1073,4 +1099,15 @@ public void testCreateClusterWithSameNameAsConnectFails(VertxTestContext context\n             })));\n     }\n \n+    @Test\n+    public void testCreateClusterWithJmxEnabled(VertxTestContext context) {\n+        String kcs2iName = \"foo\";\n+        String kcs2iNamespace = \"test\";\n+        KafkaConnectS2I kcs2i = ResourceUtils.createEmptyKafkaConnectS2I(kcs2iNamespace, kcs2iName);\n+        kcs2i.getSpec().setJmxOptions(new KafkaJmxOptionsBuilder()\n+                .withAuthentication(new KafkaJmxAuthenticationPasswordBuilder().build())\n+                .build());\n+\n+        createCluster(context, kcs2i, false);\n+    }", "originalCommit": "6901a340c1f5f95072c44a67681ab11e5f2d462e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDYyMDMxOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4096#discussion_r544620318", "bodyText": "yes of course that make sense", "author": "mgarmes", "createdAt": "2020-12-16T21:01:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5MDE4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYwMTcwNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4096#discussion_r546601706", "bodyText": "This is almost exactly the same code as we have in kafka_run.sh (the only difference I can see is in the KAFKA_CONNECT_JMX_ENABLED vs KAFKA_JMX_ENABLED). I think it would be good to factor out some common script that we could source from both, rather than duplicating.", "author": "tombentley", "createdAt": "2020-12-21T09:35:45Z", "path": "docker-images/kafka/scripts/kafka_connect_run.sh", "diffHunk": "@@ -45,6 +45,29 @@ if [ \"$KAFKA_CONNECT_METRICS_ENABLED\" = \"true\" ]; then\n     export KAFKA_OPTS\n fi\n \n+if [ \"$KAFKA_CONNECT_JMX_ENABLED\" = \"true\" ]; then\n+  KAFKA_JMX_OPTS=\"-Dcom.sun.management.jmxremote.port=9999 -Dcom.sun.management.jmxremote.rmi.port=9999 -Dcom.sun.management.jmxremote=true -Djava.rmi.server.hostname=$(hostname -i) -Djava.net.preferIPv4Stack=true\"\n+\n+  if [ -n \"$KAFKA_CONNECT_JMX_USERNAME\" ]; then\n+    # Secure JMX port on 9999 with username and password\n+    JMX_ACCESS_FILE=\"/tmp/access.file\"\n+    JMX_PASSWORD_FILE=\"/tmp/password.file\"\n+\n+    cat << EOF > \"${JMX_ACCESS_FILE}\"\n+${KAFKA_CONNECT_JMX_USERNAME} readonly\n+EOF\n+\n+    cat << EOF > \"${JMX_PASSWORD_FILE}\"\n+$KAFKA_CONNECT_JMX_USERNAME $KAFKA_CONNECT_JMX_PASSWORD\n+EOF\n+    chmod 400 \"${JMX_PASSWORD_FILE}\"\n+    KAFKA_JMX_OPTS=\"${KAFKA_JMX_OPTS} -Dcom.sun.management.jmxremote.access.file=${JMX_ACCESS_FILE} -Dcom.sun.management.jmxremote.password.file=${JMX_PASSWORD_FILE}  -Dcom.sun.management.jmxremote.authenticate=true\"\n+  else\n+    # expose the port insecurely\n+    KAFKA_JMX_OPTS=\"${KAFKA_JMX_OPTS} -Dcom.sun.management.jmxremote.authenticate=false\"\n+  fi\n+fi", "originalCommit": "c6accd46e26f600053a5c03251b8fcede140ed3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDU2Nzc4OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4096#discussion_r554567789", "bodyText": "hello @tombentley , what do you suggest as name for that script ? bests", "author": "mgarmes", "createdAt": "2021-01-10T13:28:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYwMTcwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjU3MTQzNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4096#discussion_r556571435", "bodyText": "build_jmx_opts.sh?", "author": "tombentley", "createdAt": "2021-01-13T14:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYwMTcwNg=="}], "type": "inlineReview"}, {"oid": "448aead679cd6f9b60d2c6dd8d68585ab80648c9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/448aead679cd6f9b60d2c6dd8d68585ab80648c9", "message": "refactor jmx for kafka_*_run", "committedDate": "2021-01-13T16:02:59Z", "type": "forcePushed"}, {"oid": "00efb68d67932bf0e72553fd2e28b25784aeb201", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/00efb68d67932bf0e72553fd2e28b25784aeb201", "message": "merge\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-13T17:32:22Z", "type": "forcePushed"}, {"oid": "a0d648c4d6f043e0b5409b20d887e56475968ba0", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a0d648c4d6f043e0b5409b20d887e56475968ba0", "message": "Kafka connect: add jmxOptions\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-13T17:36:58Z", "type": "commit"}, {"oid": "79ce975024a8d5b01245d41f5e98ccebf61bf9b1", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/79ce975024a8d5b01245d41f5e98ccebf61bf9b1", "message": "fix imports + add kafka-connect jmx port as  ContainerPort\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-13T17:36:58Z", "type": "commit"}, {"oid": "afffe7d670f41e5b7d687f2afd1c6409669cb762", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/afffe7d670f41e5b7d687f2afd1c6409669cb762", "message": "fix imports + add kafka-connect jmx port as  ContainerPort\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-13T17:36:58Z", "type": "commit"}, {"oid": "9a0bc93c6f6e7b4265a0f6897dd0f01b7bf75d21", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9a0bc93c6f6e7b4265a0f6897dd0f01b7bf75d21", "message": "update tests & doc & crd\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-13T17:43:08Z", "type": "commit"}, {"oid": "60400c5db6338edf8a2b052a556231463bf91dfb", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/60400c5db6338edf8a2b052a556231463bf91dfb", "message": "fix style\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-13T17:43:08Z", "type": "commit"}, {"oid": "c788888866a334587df52322bd805669b26b7e57", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c788888866a334587df52322bd805669b26b7e57", "message": "fix test\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-13T17:43:08Z", "type": "commit"}, {"oid": "06d44def5596cd3fd483774d69bb4eab9464f5d9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/06d44def5596cd3fd483774d69bb4eab9464f5d9", "message": "add tests\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-13T17:43:08Z", "type": "commit"}, {"oid": "5cb4c9f502ed81139c6fc7f39ef89727a9431653", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5cb4c9f502ed81139c6fc7f39ef89727a9431653", "message": "add change log\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-13T17:43:08Z", "type": "commit"}, {"oid": "af06cfd4dc948f0ad45241fdb8235c1d1284b456", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/af06cfd4dc948f0ad45241fdb8235c1d1284b456", "message": "refactor jmx for kafka_*_run\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-13T17:43:08Z", "type": "commit"}, {"oid": "8bba662aedb2c01d604d396c80d076a861a0edc6", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8bba662aedb2c01d604d396c80d076a861a0edc6", "message": "merge\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-13T17:43:08Z", "type": "commit"}, {"oid": "8bba662aedb2c01d604d396c80d076a861a0edc6", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8bba662aedb2c01d604d396c80d076a861a0edc6", "message": "merge\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-13T17:43:08Z", "type": "forcePushed"}, {"oid": "89227d790e75491a77f760d5128669c33284f1f1", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/89227d790e75491a77f760d5128669c33284f1f1", "message": "update changelog\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-13T17:47:40Z", "type": "commit"}, {"oid": "89227d790e75491a77f760d5128669c33284f1f1", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/89227d790e75491a77f760d5128669c33284f1f1", "message": "update changelog\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-13T17:47:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjkzMzk3OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4096#discussion_r556933979", "bodyText": "Do we really want to echo this? won't it print the password into STDOUT?", "author": "scholzj", "createdAt": "2021-01-13T22:59:44Z", "path": "docker-images/kafka/scripts/set_kafka_jmx_options.sh", "diffHunk": "@@ -0,0 +1,31 @@\n+#!/usr/bin/env bash\n+set -e\n+\n+JMX_ENABLED=\"$1\"\n+JMX_USERNAME=\"$2\"\n+JMX_PASSWORD=\"$3\"\n+\n+echo \"${JMX_ENABLED}, ${JMX_USERNAME}, ${JMX_PASSWORD}\"", "originalCommit": "89227d790e75491a77f760d5128669c33284f1f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjkzNDAxOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4096#discussion_r556934018", "bodyText": "This seems to break the shellcheck validation ... I think you need to put these into double quotes.", "author": "scholzj", "createdAt": "2021-01-13T22:59:46Z", "path": "docker-images/kafka/scripts/kafka_run.sh", "diffHunk": "@@ -17,28 +17,7 @@ rm -f /var/opt/kafka/kafka-ready /var/opt/kafka/zk-connected 2> /dev/null\n KAFKA_OPTS=\"$KAFKA_OPTS -javaagent:$(ls \"$KAFKA_HOME\"/libs/kafka-agent*.jar)=/var/opt/kafka/kafka-ready:/var/opt/kafka/zk-connected\"\n export KAFKA_OPTS\n \n-if [ \"$KAFKA_JMX_ENABLED\" = \"true\" ]; then\n-  KAFKA_JMX_OPTS=\"-Dcom.sun.management.jmxremote.port=9999 -Dcom.sun.management.jmxremote.rmi.port=9999 -Dcom.sun.management.jmxremote=true -Djava.rmi.server.hostname=$(hostname -i) -Djava.net.preferIPv4Stack=true\"\n-\n-  if [ -n \"$KAFKA_JMX_USERNAME\" ]; then\n-    # Secure JMX port on 9999 with username and password\n-    JMX_ACCESS_FILE=\"/tmp/access.file\"\n-    JMX_PASSWORD_FILE=\"/tmp/password.file\"\n-\n-    cat << EOF > \"${JMX_ACCESS_FILE}\"\n-${KAFKA_JMX_USERNAME} readonly\n-EOF\n-\n-    cat << EOF > \"${JMX_PASSWORD_FILE}\"\n-$KAFKA_JMX_USERNAME $KAFKA_JMX_PASSWORD\n-EOF\n-    chmod 400 \"${JMX_PASSWORD_FILE}\"\n-    KAFKA_JMX_OPTS=\"${KAFKA_JMX_OPTS} -Dcom.sun.management.jmxremote.access.file=${JMX_ACCESS_FILE} -Dcom.sun.management.jmxremote.password.file=${JMX_PASSWORD_FILE}  -Dcom.sun.management.jmxremote.authenticate=true\"\n-  else\n-    # expose the port insecurely\n-    KAFKA_JMX_OPTS=\"${KAFKA_JMX_OPTS} -Dcom.sun.management.jmxremote.authenticate=false\"\n-  fi\n-fi\n+. ./set_kafka_jmx_options.sh ${KAFKA_JMX_ENABLED} ${KAFKA_JMX_USERNAME} ${KAFKA_JMX_PASSWORD}", "originalCommit": "89227d790e75491a77f760d5128669c33284f1f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6b04dc88e2e50e51244047056135a72835658397", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6b04dc88e2e50e51244047056135a72835658397", "message": "fix style\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-14T08:52:10Z", "type": "commit"}, {"oid": "91b37e96443f1f1ba6f16fbe94371e5481b6dade", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/91b37e96443f1f1ba6f16fbe94371e5481b6dade", "message": "fix tests\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-14T09:58:55Z", "type": "commit"}, {"oid": "2ae528ed769e0715e144da2e60467c52b888c1fb", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2ae528ed769e0715e144da2e60467c52b888c1fb", "message": "fix tests\n\nSigned-off-by: Mohammed Amine GARMES <mohammed-amine.garmes@amadeus.com>", "committedDate": "2021-01-14T12:09:05Z", "type": "commit"}]}