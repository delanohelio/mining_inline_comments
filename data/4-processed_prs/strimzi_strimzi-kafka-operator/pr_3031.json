{"pr_number": 3031, "pr_title": "Build Strimzi with Java11", "pr_createdAt": "2020-05-15T13:27:34Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031", "timeline": [{"oid": "41d32c768eef69703e428b2c58bf4aed4fb18907", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/41d32c768eef69703e428b2c58bf4aed4fb18907", "message": "Build Strimzi with Java11\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-15T14:07:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5NjgyMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r428896823", "bodyText": "Isn't this a setKafkaTopics?", "author": "samuel-hawker", "createdAt": "2020-05-21T20:30:07Z", "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -1202,6 +1203,7 @@ public ReconcileState(Set<TopicName> succeeded, Set<TopicName> undetermined, Map\n             this.succeeded = succeeded;\n             this.undetermined = undetermined;\n             this.failed = failed;\n+            this.ktList = emptyList();\n         }\n \n         public void addKafkaTopics(List<KafkaTopic> ktList) {", "originalCommit": "41d32c768eef69703e428b2c58bf4aed4fb18907", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE4MTcxOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r429181718", "bodyText": "What do you mean? It is just patching Spotbugs violation of dereferencing field which was not initialized in the constructor.", "author": "sknot-rh", "createdAt": "2020-05-22T11:00:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5NjgyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE1ODcyMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r431158722", "bodyText": "He's asking why the method is called addKafkaTopics and not setKafkaTopics().", "author": "tombentley", "createdAt": "2020-05-27T14:06:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5NjgyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4ODk2NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r429088964", "bodyText": "shouldn't we keep this on version 1.8 until the migration to java11 ?", "author": "Frawless", "createdAt": "2020-05-22T07:33:58Z", "path": "Jenkinsfile-pr", "diffHunk": "@@ -37,6 +37,7 @@ pipeline {\n         TEST_CLUSTER_ADMIN = \"admin\"\n         OPERATOR_IMAGE_PULL_POLICY = \"IfNotPresent\"\n         COMPONENTS_IMAGE_PULL_POLICY = \"IfNotPresent\"\n+        JAVA_VERSION = \"11\"", "originalCommit": "41d32c768eef69703e428b2c58bf4aed4fb18907", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE4MTkwOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r429181908", "bodyText": "Is this question or suggestion? :)", "author": "sknot-rh", "createdAt": "2020-05-22T11:00:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4ODk2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgxMzkxOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r429813918", "bodyText": "Kinda both :)", "author": "Frawless", "createdAt": "2020-05-25T08:49:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4ODk2NA=="}], "type": "inlineReview"}, {"oid": "bb5484c253981c7fa31863a868a2f1970a402ffa", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/bb5484c253981c7fa31863a868a2f1970a402ffa", "message": "patch\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-26T12:45:13Z", "type": "forcePushed"}, {"oid": "3857fbbdcbe68f0bbcd116deb339c3d92bc81c3b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3857fbbdcbe68f0bbcd116deb339c3d92bc81c3b", "message": "Build Strimzi with Java11\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-26T13:46:19Z", "type": "commit"}, {"oid": "5ba6ec577b9722cd98b677f44f2f7d826d4ee48c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5ba6ec577b9722cd98b677f44f2f7d826d4ee48c", "message": "revert jenkins\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-26T13:46:19Z", "type": "commit"}, {"oid": "5e61c212fcd55bb23f1cf6d07b4b7a89e17c40f7", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5e61c212fcd55bb23f1cf6d07b4b7a89e17c40f7", "message": "revert me later: debug j11 build\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-26T13:46:19Z", "type": "commit"}, {"oid": "361873ca93d2f1ec6a03009a81b3a569effaaf77", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/361873ca93d2f1ec6a03009a81b3a569effaaf77", "message": "patch\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-26T13:46:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE1NDc1MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r431154751", "bodyText": "Is this still necessary?", "author": "tombentley", "createdAt": "2020-05-27T14:00:45Z", "path": ".azure/build-pipeline.yaml", "diffHunk": "@@ -64,7 +64,7 @@ jobs:\n         env:\n           DOCKER_USER: $(DOCKER_USER)\n           DOCKER_PASS: $(DOCKER_PASS_SECRET)\n-          MVN_ARGS: '-B'\n+          MVN_ARGS: '-B -X -e'", "originalCommit": "bb5484c253981c7fa31863a868a2f1970a402ffa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU4MDczOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r431580738", "bodyText": "No, not really. I was trying to debug ClusterOperatorTest which is failing in most cases. There is some race condition with vertx I think.", "author": "sknot-rh", "createdAt": "2020-05-28T04:54:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE1NDc1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE1Njk0MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r431156940", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        log.warn(\"Failed to close vertx instance. \", e);\n          \n          \n            \n                        log.warn(\"Failed to close vertx instance.\", e);", "author": "tombentley", "createdAt": "2020-05-27T14:03:44Z", "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/ClusterOperatorTest.java", "diffHunk": "@@ -76,7 +79,11 @@ public static void before() {\n \n     @AfterAll\n     public static void after() {\n-        vertx.close();\n+        try {\n+            vertx.close();\n+        } catch (Exception e) {\n+            log.warn(\"Failed to close vertx instance. \", e);", "originalCommit": "bb5484c253981c7fa31863a868a2f1970a402ffa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE1NzkwOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r431157908", "bodyText": "Why this this needed?", "author": "tombentley", "createdAt": "2020-05-27T14:04:58Z", "path": "pom.xml", "diffHunk": "@@ -784,6 +784,8 @@\n                         <ENV_VAR_EXISTS_BOOLEAN>true</ENV_VAR_EXISTS_BOOLEAN>\n                     </environmentVariables>\n                     <trimStackTrace>false</trimStackTrace>\n+                    <argLine>-Xmx1024m</argLine>\n+                    <forkedProcessExitTimeoutInSeconds>120</forkedProcessExitTimeoutInSeconds>", "originalCommit": "bb5484c253981c7fa31863a868a2f1970a402ffa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU4MzU2Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r431583567", "bodyText": "ClusterOperatorTest is flaky and I was trying to find out whether it is env issue or some bug in this tests. You can check the log for example there: https://dev.azure.com/cncf/strimzi/_build/results?buildId=40416&view=logs&j=66711cbf-ca69-5603-44b4-df4438498017&t=b249c5e2-84b8-5b78-6f19-55caa3f2c635", "author": "sknot-rh", "createdAt": "2020-05-28T05:06:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE1NzkwOA=="}], "type": "inlineReview"}, {"oid": "75f4d41c175a7fd37b58e44e7d16b49cd669525d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/75f4d41c175a7fd37b58e44e7d16b49cd669525d", "message": "comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-28T05:00:04Z", "type": "commit"}, {"oid": "75f4d41c175a7fd37b58e44e7d16b49cd669525d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/75f4d41c175a7fd37b58e44e7d16b49cd669525d", "message": "comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-28T05:00:04Z", "type": "forcePushed"}, {"oid": "8d08e72f546b4c7537ea815d4645b8f25bcbbcf2", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8d08e72f546b4c7537ea815d4645b8f25bcbbcf2", "message": "test closing\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-29T11:03:07Z", "type": "forcePushed"}, {"oid": "cb544bdbc5000dce003ac0f8b9753db6a5e7f4c2", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/cb544bdbc5000dce003ac0f8b9753db6a5e7f4c2", "message": "test closing\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-29T12:54:01Z", "type": "forcePushed"}, {"oid": "219b8cd0a5ae7e3069492fa49906d5aaee49a203", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/219b8cd0a5ae7e3069492fa49906d5aaee49a203", "message": "test closing\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-29T13:03:09Z", "type": "forcePushed"}, {"oid": "c80b0ecab4ee52aed99ce3740de76c9a7c8e9e6a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c80b0ecab4ee52aed99ce3740de76c9a7c8e9e6a", "message": "test closing\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-29T13:33:37Z", "type": "commit"}, {"oid": "c80b0ecab4ee52aed99ce3740de76c9a7c8e9e6a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c80b0ecab4ee52aed99ce3740de76c9a7c8e9e6a", "message": "test closing\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-29T13:33:37Z", "type": "forcePushed"}, {"oid": "51a6bcdac29b831efce9f92e0783f4094eb6060d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/51a6bcdac29b831efce9f92e0783f4094eb6060d", "message": "another try\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-06-01T07:24:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY5NTA2Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r433695067", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final Logger log = LogManager.getLogger(ClusterOperatorTest.class.getName());\n          \n          \n            \n                private static final Logger log = LogManager.getLogger(ClusterOperatorTest.class);", "author": "tombentley", "createdAt": "2020-06-02T08:07:31Z", "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/ClusterOperatorTest.java", "diffHunk": "@@ -52,6 +55,7 @@\n @ExtendWith(VertxExtension.class)\n public class ClusterOperatorTest {\n     private static Vertx vertx;\n+    private static final Logger log = LogManager.getLogger(ClusterOperatorTest.class.getName());", "originalCommit": "51a6bcdac29b831efce9f92e0783f4094eb6060d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzcwMzg2NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r433703864", "bodyText": "I don't really understand why this had to change due to a simple change in JDK. If this is just trying to remove a flaky test perhaps that should be done in a separate PR, or at least the PR description should mention that you've fixed a flaky test in addition to changing the JDK.", "author": "tombentley", "createdAt": "2020-06-02T08:22:42Z", "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/ClusterOperatorTest.java", "diffHunk": "@@ -165,29 +169,37 @@ private void startStop(VertxTestContext context, String namespaces, boolean open\n \n         Map<String, String> env = buildEnv(namespaces);\n \n-        Checkpoint async = context.checkpoint();\n+        CountDownLatch latch = new CountDownLatch(namespaceList.size() + 1);\n+\n         Main.run(vertx, client, new PlatformFeaturesAvailability(openShift, KubernetesVersion.V1_9),\n                     ClusterOperatorConfig.fromMap(env, KafkaVersionTestUtils.getKafkaVersionLookup()))\n             .onComplete(context.succeeding(v -> context.verify(() -> {\n                 assertThat(\"A verticle per namespace\", vertx.deploymentIDs(), hasSize(namespaceList.size()));\n-\n                 for (String deploymentId: vertx.deploymentIDs()) {\n-                    vertx.undeploy(deploymentId, context.succeeding());\n+                    vertx.undeploy(deploymentId, asyncResult -> {\n+                        if (asyncResult.failed()) {\n+                            log.error(\"Failed to undeploy {}\", deploymentId);\n+                            context.failNow(asyncResult.cause());\n+                        }\n+                        latch.countDown();\n+                    });\n                 }\n \n                 int maximumExpectedNumberOfWatchers = (openShift ? 9 : 7) * namespaceList.size(); // we do not have connectS2I on k8s\n                 assertThat(\"Looks like there were more watchers than namespaces\",\n                         numWatchers.get(), lessThanOrEqualTo(maximumExpectedNumberOfWatchers));\n-                async.flag();\n+                latch.countDown();\n             })));\n+        latch.await(10, TimeUnit.SECONDS);\n+        context.completeNow();", "originalCommit": "51a6bcdac29b831efce9f92e0783f4094eb6060d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc3NzU2MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r433777561", "bodyText": "With java11 it started failing more often so most of the java11 builds failed. I wanted to make the build green. I can split it into another PR if you wish.", "author": "sknot-rh", "createdAt": "2020-06-02T10:30:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzcwMzg2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzcwNTkyMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r433705923", "bodyText": "Again, I don't understand why this needed to change. Presumably because you saw an NPE, right? But the question is not \"How do I get rid of the NPE as quickly as possible\" it's \"what race means we're not seeing this NPE, and was that an NPE the original author thought could never happen?\" The answer to that question might reveal some defect in the logic which using an emptyList() is just hiding.", "author": "tombentley", "createdAt": "2020-06-02T08:26:09Z", "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -1202,9 +1203,10 @@ public ReconcileState(Set<TopicName> succeeded, Set<TopicName> undetermined, Map\n             this.succeeded = succeeded;\n             this.undetermined = undetermined;\n             this.failed = failed;\n+            this.ktList = emptyList();", "originalCommit": "51a6bcdac29b831efce9f92e0783f4094eb6060d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc3NDYxMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3031#discussion_r433774613", "bodyText": "I did not see the NPE. Spotbugs with java 11 started complaining about dereferencing ktList which has not been initialized in constructor.", "author": "sknot-rh", "createdAt": "2020-06-02T10:24:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzcwNTkyMw=="}], "type": "inlineReview"}, {"oid": "124333b607ac556d8cd1d19d0784b9b9d270bc77", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/124333b607ac556d8cd1d19d0784b9b9d270bc77", "message": "comment\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-06-02T11:16:07Z", "type": "commit"}]}