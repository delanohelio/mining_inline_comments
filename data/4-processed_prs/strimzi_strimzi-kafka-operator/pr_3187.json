{"pr_number": 3187, "pr_title": "[systemtest][enhancement] Variable timeout part 1 - resource readiness", "pr_createdAt": "2020-06-11T11:56:00Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3187", "timeline": [{"oid": "1b70234f756ce01be83658bc22f02702baf4d614", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1b70234f756ce01be83658bc22f02702baf4d614", "message": "fix the STs\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-11T21:11:52Z", "type": "forcePushed"}, {"oid": "11a90745bbd31f8ee5d24fdcf01b54ca78e62858", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/11a90745bbd31f8ee5d24fdcf01b54ca78e62858", "message": "fix the STs\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-22T19:14:41Z", "type": "forcePushed"}, {"oid": "33c1f6838a2a4321ae7c9cd88c2faed3e6250317", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/33c1f6838a2a4321ae7c9cd88c2faed3e6250317", "message": "add enum and methods\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-23T13:47:57Z", "type": "commit"}, {"oid": "e9a6e4240a9620e9798b2158ec54804c5531dd96", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e9a6e4240a9620e9798b2158ec54804c5531dd96", "message": "add more resources for readiness and method to get timeout for pods\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-23T13:47:57Z", "type": "commit"}, {"oid": "b28be11fe748cd347c53eaec3a1f04257fa837d0", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b28be11fe748cd347c53eaec3a1f04257fa837d0", "message": "edit timeouts in utils classes\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-23T13:47:57Z", "type": "commit"}, {"oid": "cb79739fd7a762db7b2a3051d17c9f141185b696", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/cb79739fd7a762db7b2a3051d17c9f141185b696", "message": "add more resource types to Constants class\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-23T13:47:57Z", "type": "commit"}, {"oid": "8e0b4f5fd7d9e9b392368070b6023b5c46d75b46", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8e0b4f5fd7d9e9b392368070b6023b5c46d75b46", "message": "fix the STs\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-23T13:47:57Z", "type": "commit"}, {"oid": "760ba02f413336c09f591d12704e1b8ec42fb4b7", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/760ba02f413336c09f591d12704e1b8ec42fb4b7", "message": "rebase\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-23T13:47:57Z", "type": "commit"}, {"oid": "f1a03e7d9a7a3f0f3f9a51dc9d00c352d5a3c800", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f1a03e7d9a7a3f0f3f9a51dc9d00c352d5a3c800", "message": "fixup! rebase\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-23T13:47:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNTUxNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3187#discussion_r444335517", "bodyText": "CruiseControl and Exporter are part of Kafka. Wouldn't be btter to use Deployment timeout here?", "author": "Frawless", "createdAt": "2020-06-23T16:00:31Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/resources/ResourceOperation.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.systemtest.resources;\n+\n+import io.strimzi.api.kafka.model.Kafka;\n+import io.strimzi.api.kafka.model.KafkaBridge;\n+import io.strimzi.api.kafka.model.KafkaConnect;\n+import io.strimzi.api.kafka.model.KafkaConnectS2I;\n+import io.strimzi.api.kafka.model.KafkaConnector;\n+import io.strimzi.api.kafka.model.KafkaMirrorMaker;\n+import io.strimzi.api.kafka.model.KafkaMirrorMaker2;\n+import io.strimzi.api.kafka.model.KafkaRebalance;\n+import io.strimzi.systemtest.Constants;\n+\n+import java.time.Duration;\n+\n+public class ResourceOperation {\n+    public static long getTimeoutForResourceReadiness(String kind) {\n+        long timeout;\n+\n+        switch (kind) {\n+            case Kafka.RESOURCE_KIND:\n+                timeout = Duration.ofMinutes(14).toMillis();\n+                break;\n+            case KafkaConnect.RESOURCE_KIND:\n+            case KafkaConnectS2I.RESOURCE_KIND:\n+            case KafkaMirrorMaker2.RESOURCE_KIND:\n+            case Constants.DEPLOYMENT_CONFIG:\n+                timeout = Duration.ofMinutes(10).toMillis();\n+                break;\n+            case KafkaRebalance.RESOURCE_KIND:\n+            case KafkaMirrorMaker.RESOURCE_KIND:\n+            case KafkaBridge.RESOURCE_KIND:\n+            case KafkaConnector.RESOURCE_KIND:\n+            case Constants.STATEFUL_SET:\n+            case Constants.DEPLOYMENT:\n+                timeout = Duration.ofMinutes(8).toMillis();\n+                break;\n+            case Constants.KAFKA_CRUISE_CONTROL:\n+            case Constants.KAFKA_EXPORTER:", "originalCommit": "d52381308b41750bfda47cbeae251be36267e8a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0NTg2NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3187#discussion_r444345865", "bodyText": "Hmm good point, I thought that split it to more Constants and leave it on smaller timeout will be better, but thanks for the comment.", "author": "im-konge", "createdAt": "2020-06-23T16:15:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNTUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0NjczMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3187#discussion_r444346730", "bodyText": "Well I don't say it's wrong, but it might be better to rename it to Kafka_CRUISE_CONTROL_DPELOYMENT for example and then use some timeout under it, same for exporter", "author": "Frawless", "createdAt": "2020-06-23T16:17:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNTUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM1NTk5MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3187#discussion_r444355990", "bodyText": "Good idea, fixed :)", "author": "im-konge", "createdAt": "2020-06-23T16:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNTUxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNTg4Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3187#discussion_r444335882", "bodyText": "Rebalance and Connector readiness will take much less time than others", "author": "Frawless", "createdAt": "2020-06-23T16:01:02Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/resources/ResourceOperation.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.systemtest.resources;\n+\n+import io.strimzi.api.kafka.model.Kafka;\n+import io.strimzi.api.kafka.model.KafkaBridge;\n+import io.strimzi.api.kafka.model.KafkaConnect;\n+import io.strimzi.api.kafka.model.KafkaConnectS2I;\n+import io.strimzi.api.kafka.model.KafkaConnector;\n+import io.strimzi.api.kafka.model.KafkaMirrorMaker;\n+import io.strimzi.api.kafka.model.KafkaMirrorMaker2;\n+import io.strimzi.api.kafka.model.KafkaRebalance;\n+import io.strimzi.systemtest.Constants;\n+\n+import java.time.Duration;\n+\n+public class ResourceOperation {\n+    public static long getTimeoutForResourceReadiness(String kind) {\n+        long timeout;\n+\n+        switch (kind) {\n+            case Kafka.RESOURCE_KIND:\n+                timeout = Duration.ofMinutes(14).toMillis();\n+                break;\n+            case KafkaConnect.RESOURCE_KIND:\n+            case KafkaConnectS2I.RESOURCE_KIND:\n+            case KafkaMirrorMaker2.RESOURCE_KIND:\n+            case Constants.DEPLOYMENT_CONFIG:\n+                timeout = Duration.ofMinutes(10).toMillis();\n+                break;\n+            case KafkaRebalance.RESOURCE_KIND:", "originalCommit": "d52381308b41750bfda47cbeae251be36267e8a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0NDc0Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3187#discussion_r444344742", "bodyText": "Yeah, good point, gonna move it. I wasn't 100% sure where to put it", "author": "im-konge", "createdAt": "2020-06-23T16:14:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNTg4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjgxNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3187#discussion_r444336816", "bodyText": "I dont think this is a good aproach. The pods are ready after some time after creation, the number of pods doesn't affect it I think. It make sense for rolling updates", "author": "Frawless", "createdAt": "2020-06-23T16:02:29Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/resources/ResourceOperation.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.systemtest.resources;\n+\n+import io.strimzi.api.kafka.model.Kafka;\n+import io.strimzi.api.kafka.model.KafkaBridge;\n+import io.strimzi.api.kafka.model.KafkaConnect;\n+import io.strimzi.api.kafka.model.KafkaConnectS2I;\n+import io.strimzi.api.kafka.model.KafkaConnector;\n+import io.strimzi.api.kafka.model.KafkaMirrorMaker;\n+import io.strimzi.api.kafka.model.KafkaMirrorMaker2;\n+import io.strimzi.api.kafka.model.KafkaRebalance;\n+import io.strimzi.systemtest.Constants;\n+\n+import java.time.Duration;\n+\n+public class ResourceOperation {\n+    public static long getTimeoutForResourceReadiness(String kind) {\n+        long timeout;\n+\n+        switch (kind) {\n+            case Kafka.RESOURCE_KIND:\n+                timeout = Duration.ofMinutes(14).toMillis();\n+                break;\n+            case KafkaConnect.RESOURCE_KIND:\n+            case KafkaConnectS2I.RESOURCE_KIND:\n+            case KafkaMirrorMaker2.RESOURCE_KIND:\n+            case Constants.DEPLOYMENT_CONFIG:\n+                timeout = Duration.ofMinutes(10).toMillis();\n+                break;\n+            case KafkaRebalance.RESOURCE_KIND:\n+            case KafkaMirrorMaker.RESOURCE_KIND:\n+            case KafkaBridge.RESOURCE_KIND:\n+            case KafkaConnector.RESOURCE_KIND:\n+            case Constants.STATEFUL_SET:\n+            case Constants.DEPLOYMENT:\n+                timeout = Duration.ofMinutes(8).toMillis();\n+                break;\n+            case Constants.KAFKA_CRUISE_CONTROL:\n+            case Constants.KAFKA_EXPORTER:\n+                timeout = Duration.ofMinutes(4).toMillis();\n+                break;\n+            default:\n+                timeout = Duration.ofMinutes(2).toMillis();\n+        }\n+\n+        return timeout;\n+    }\n+\n+    public static long getTimeoutForPodsReadiness(int expectPods) {\n+        return Duration.ofMinutes(4).toMillis() * expectPods;", "originalCommit": "d52381308b41750bfda47cbeae251be36267e8a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0MjUyNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3187#discussion_r444342525", "bodyText": "This is for the waitForPodsReady methods, not for creation .. should I change it?", "author": "im-konge", "createdAt": "2020-06-23T16:10:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM0NzY2Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3187#discussion_r444347667", "bodyText": "waitForPodsReady are used for pod readiness after creation or when rolling update already finished so you don't need to wait x * number of pods because you will probably wait only for 1 pod in that case.", "author": "Frawless", "createdAt": "2020-06-23T16:18:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM1MjQzNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3187#discussion_r444352434", "bodyText": "When you are waiting for pods, do you think that for example 5minutes will be enough for 3 pods to get ready? If yes, I'm gonna change it to fixed 5 minutes \ud83d\ude04", "author": "im-konge", "createdAt": "2020-06-23T16:26:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjgxNg=="}], "type": "inlineReview"}, {"oid": "9bb50f2d35f614420aa3eadd25d5666cde886f4e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9bb50f2d35f614420aa3eadd25d5666cde886f4e", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-23T17:33:29Z", "type": "commit"}, {"oid": "9bb50f2d35f614420aa3eadd25d5666cde886f4e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9bb50f2d35f614420aa3eadd25d5666cde886f4e", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-23T17:33:29Z", "type": "forcePushed"}]}