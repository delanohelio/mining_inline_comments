{"pr_number": 2446, "pr_title": "Remove external listeners", "pr_createdAt": "2020-01-23T14:43:08Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2446", "timeline": [{"oid": "7ee6027651fd84e535122b8984a58c70b7d6bda6", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7ee6027651fd84e535122b8984a58c70b7d6bda6", "message": "KafkaST: Remove external listeners from tests where are not needed\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-01-23T14:48:57Z", "type": "forcePushed"}, {"oid": "44d3d62e0c5738b9e0232091e462c032ed18e78b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/44d3d62e0c5738b9e0232091e462c032ed18e78b", "message": "ConnectS2IST: Remove externalListener from test\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-01-28T11:40:01Z", "type": "forcePushed"}, {"oid": "274fc53dfb0615c671d19c8288702465eedfe8d7", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/274fc53dfb0615c671d19c8288702465eedfe8d7", "message": "KafkaST, AllNamespaceST and ConnectS2IST: Remove external listeners\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-01-28T12:17:57Z", "type": "forcePushed"}, {"oid": "c0eb575687332ff787186a5cb225987ac285d8d5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c0eb575687332ff787186a5cb225987ac285d8d5", "message": "KafkaST, AllNamespaceST and ConnectS2IST: Remove external listeners\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-01-28T12:32:43Z", "type": "forcePushed"}, {"oid": "470f24704948bdc20d6d2254717df3652dc64213", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/470f24704948bdc20d6d2254717df3652dc64213", "message": "KafkaST, AllNamespaceST and ConnectS2IST: Remove external listeners\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-01-28T12:38:03Z", "type": "forcePushed"}, {"oid": "fd256bc822a37b714b65a8727331049000039778", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/fd256bc822a37b714b65a8727331049000039778", "message": "AllNamespaceST: Remove external listeners\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-01-30T09:17:54Z", "type": "forcePushed"}, {"oid": "3fa2e0bb8e6c6147e85cd2a3df7edd99ca5b9958", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3fa2e0bb8e6c6147e85cd2a3df7edd99ca5b9958", "message": "AllNamespaceST: Remove external listeners\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-01-30T09:22:59Z", "type": "forcePushed"}, {"oid": "807005b088f9d174d00beae8407aa2293ec265a7", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/807005b088f9d174d00beae8407aa2293ec265a7", "message": "AllNamespaceST: Add wait for KafkaUser creation and update deploy of clients\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-01-30T14:55:44Z", "type": "forcePushed"}, {"oid": "529fece172197bb2c8285388fb3de2bbd4061863", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/529fece172197bb2c8285388fb3de2bbd4061863", "message": "KafkaST: Remove external listeners and fix tests\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-01T22:03:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwOTI0MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2446#discussion_r373809241", "bodyText": "Do we need the two empty lines?", "author": "scholzj", "createdAt": "2020-02-01T23:53:31Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/AllNamespaceST.java", "diffHunk": "@@ -41,6 +44,7 @@\n     private static final String THIRD_NAMESPACE = \"third-namespace-test\";\n     private static final String SECOND_CLUSTER_NAME = CLUSTER_NAME + \"-second\";\n \n+", "originalCommit": "529fece172197bb2c8285388fb3de2bbd4061863", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgxMzY1Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2446#discussion_r373813653", "bodyText": "Deleted, sorry about that.", "author": "im-konge", "createdAt": "2020-02-02T02:04:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgwOTI0MQ=="}], "type": "inlineReview"}, {"oid": "e69ddb5c704d1110cadbe86132440b667b96a2ec", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e69ddb5c704d1110cadbe86132440b667b96a2ec", "message": "KafkaST: Remove external listeners and fix tests\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-02T02:02:28Z", "type": "forcePushed"}, {"oid": "6096c258fdd44b65ee348f352ba08aeb58fac147", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6096c258fdd44b65ee348f352ba08aeb58fac147", "message": "KafkaST: Remove external listeners and fix tests\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-03T09:14:51Z", "type": "forcePushed"}, {"oid": "5cbfc5b6b6ee1abd7a68b350e47bb6477e7159ea", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5cbfc5b6b6ee1abd7a68b350e47bb6477e7159ea", "message": "KafkaST: Remove external listeners and fix tests\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-03T13:03:32Z", "type": "forcePushed"}, {"oid": "f3cd8dca72687fe2e243d479bdc7b5f1f32148ac", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f3cd8dca72687fe2e243d479bdc7b5f1f32148ac", "message": "Fix tests after refactor\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:17:30Z", "type": "forcePushed"}, {"oid": "ba9ff3c27befa85f6069e8a4bbf88349229501b4", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ba9ff3c27befa85f6069e8a4bbf88349229501b4", "message": "Add asserts for checking kafka configuration\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:22:05Z", "type": "commit"}, {"oid": "201ad3c545a67809f34f0ca9425ab8ae9a128cc2", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/201ad3c545a67809f34f0ca9425ab8ae9a128cc2", "message": "Fix kafka user quotas deleting (#2394)\n\n* Fix kafka user quotas deleting\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>\n\n* use scram name\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>\n\n* mocking\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:22:05Z", "type": "commit"}, {"oid": "eca52ee89e4e8f7c4bca16c6e4596f167636ed60", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/eca52ee89e4e8f7c4bca16c6e4596f167636ed60", "message": "Remove external listeners from tests where are not needed\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:22:05Z", "type": "commit"}, {"oid": "abb670bb16957d006955fb1486f0521d0170ba7c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/abb670bb16957d006955fb1486f0521d0170ba7c", "message": "Change availabilityTest with new external kafka client's check\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:22:05Z", "type": "commit"}, {"oid": "6b084053da5d812a61fe160a8055cc06150ab654", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6b084053da5d812a61fe160a8055cc06150ab654", "message": "KafkaST: Remove external listeners from tests where are not needed\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:22:05Z", "type": "commit"}, {"oid": "537ce68495a84dd390bde9a3086996323c8ca213", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/537ce68495a84dd390bde9a3086996323c8ca213", "message": "ConnectS2IST: Remove externalListener from test\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:22:37Z", "type": "commit"}, {"oid": "5418330972be474787bcc88c07c1e06cd101155d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5418330972be474787bcc88c07c1e06cd101155d", "message": "KafkaST, AllNamespaceST and ConnectS2IST: Remove external listeners\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:23:07Z", "type": "commit"}, {"oid": "b6e90f4f533456b2093f8c0b933fa9050325635e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b6e90f4f533456b2093f8c0b933fa9050325635e", "message": "AllNamespaceST: Remove external listeners\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:23:07Z", "type": "commit"}, {"oid": "b87815d84efb20f07ad5250d96930629d804a3d8", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b87815d84efb20f07ad5250d96930629d804a3d8", "message": "AllNamespaceST: Add wait for KafkaUser creation and update deploy of clients\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:23:07Z", "type": "commit"}, {"oid": "4d235d2769cf9a765355e6f0da1abbf19485663b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4d235d2769cf9a765355e6f0da1abbf19485663b", "message": "ConnectS2IST: Update deploy of kafka clients\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:23:07Z", "type": "commit"}, {"oid": "7290ba75590bafa114936643aab76a13b2ce892c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7290ba75590bafa114936643aab76a13b2ce892c", "message": "RollingUpdateST: Remove external listeners\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:24:09Z", "type": "commit"}, {"oid": "93d346f80c02144567ffed32348f8d63fd8e6928", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/93d346f80c02144567ffed32348f8d63fd8e6928", "message": "KafkaST: Remove external listeners and fix tests\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:24:09Z", "type": "commit"}, {"oid": "b215acb610acc0cbfb6d15492e10f222c10c08a3", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b215acb610acc0cbfb6d15492e10f222c10c08a3", "message": "Renaming all externalKafkaClient methods to internalKafkaClient after refactor\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:24:09Z", "type": "commit"}, {"oid": "750f165236f721a50aa258f846bebb5d3613b875", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/750f165236f721a50aa258f846bebb5d3613b875", "message": "Fix tests after refactor\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:24:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY3ODExOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2446#discussion_r374678118", "bodyText": "same as above", "author": "Frawless", "createdAt": "2020-02-04T13:46:59Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java", "diffHunk": "@@ -771,7 +773,7 @@ void testForTopicOperator() throws InterruptedException {\n         KafkaUtils.waitUntilKafkaCRIsReady(CLUSTER_NAME);\n \n         assertThat(KafkaCmdClient.describeTopicUsingPodCli(CLUSTER_NAME, 0, \"topic-from-cli\"),\n-                hasItems(\"PartitionCount:2\"));\n+                hasItems(\"PartitionCount:\", \"2\"));", "originalCommit": "750f165236f721a50aa258f846bebb5d3613b875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY3ODE1NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2446#discussion_r374678155", "bodyText": "You should check only for one item PartitionsCount:2, I removed the whitespace in one of my recent PRs so it should work now.", "author": "Frawless", "createdAt": "2020-02-04T13:47:03Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java", "diffHunk": "@@ -757,7 +759,7 @@ void testForTopicOperator() throws InterruptedException {\n         KafkaUtils.waitUntilKafkaCRIsReady(CLUSTER_NAME);\n \n         assertThat(KafkaCmdClient.describeTopicUsingPodCli(CLUSTER_NAME, 0, \"my-topic\"),\n-                hasItems(\"PartitionCount:2\"));\n+                hasItems(\"PartitionCount:\", \"2\"));", "originalCommit": "750f165236f721a50aa258f846bebb5d3613b875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY3ODYwNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2446#discussion_r374678604", "bodyText": "Are you sure this is sufficient ? I think we can hit there race-condition where pods will be in terminating, same for PVC but Kafka CR will be deleted.", "author": "Frawless", "createdAt": "2020-02-04T13:47:54Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java", "diffHunk": "@@ -1169,7 +1171,7 @@ void testKafkaJBODDeleteClaimsTrueFalse() {\n         // kafka cluster already deployed\n         verifyVolumeNamesAndLabels(2, 2, 10);\n         LOGGER.info(\"Deleting cluster\");\n-        cmdKubeClient().deleteByName(\"kafka\", CLUSTER_NAME).waitForResourceDeletion(\"pod\", KafkaResources.kafkaPodName(CLUSTER_NAME, 0));\n+        cmdKubeClient().deleteByName(\"kafka\", CLUSTER_NAME).waitForResourceDeletion(\"Kafka\", CLUSTER_NAME);", "originalCommit": "750f165236f721a50aa258f846bebb5d3613b875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY3ODg3Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2446#discussion_r374678872", "bodyText": "You can use CLUSTER_NAME instead of my-cluster", "author": "Frawless", "createdAt": "2020-02-04T13:48:25Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java", "diffHunk": "@@ -1645,22 +1652,19 @@ void testUOListeningOnlyUsersInSameCluster() {\n \n     @Test\n     void testMessagesAreStoredInDisk() throws Exception {\n-        KafkaResource.kafkaEphemeral(CLUSTER_NAME, 1, 1)\n-            .editSpec()\n-                .editKafka()\n-                    .editListeners()\n-                        .withNewKafkaListenerExternalNodePort()\n-                            .withTls(false)\n-                        .endKafkaListenerExternalNodePort()\n-                    .endListeners()\n-                .endKafka()\n-            .endSpec()\n-            .done();\n+        KafkaResource.kafkaEphemeral(CLUSTER_NAME, 1, 1).done();\n \n         Map<String, String> kafkaPodsSnapshot = StatefulSetUtils.ssSnapshot(kafkaStatefulSetName(CLUSTER_NAME));\n \n         KafkaTopicResource.topic(CLUSTER_NAME, TEST_TOPIC_NAME, 1, 1).done();\n \n+        KafkaClientsResource.deployKafkaClients(false, CLUSTER_NAME + \"-\" + Constants.KAFKA_CLIENTS).done();\n+\n+        final String kafkaClientsPodName =\n+                ResourceManager.kubeClient().listPodsByPrefixInName(\"my-cluster\" + \"-\" + Constants.KAFKA_CLIENTS).get(0).getMetadata().getName();", "originalCommit": "750f165236f721a50aa258f846bebb5d3613b875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY3ODk3Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2446#discussion_r374678972", "bodyText": "same as above", "author": "Frawless", "createdAt": "2020-02-04T13:48:35Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java", "diffHunk": "@@ -1714,18 +1721,20 @@ void testConsumerOffsetFiles() throws Exception {\n         KafkaResource.kafkaEphemeral(CLUSTER_NAME, 3, 1)\n             .editSpec()\n                 .editKafka()\n-                    .editListeners()\n-                        .withNewKafkaListenerExternalNodePort()\n-                            .withTls(false)\n-                        .endKafkaListenerExternalNodePort()\n-                    .endListeners()\n                     .withConfig(kafkaConfig)\n                 .endKafka()\n             .endSpec()\n             .done();\n \n         KafkaTopicResource.topic(CLUSTER_NAME, TEST_TOPIC_NAME, 3, 1).done();\n \n+        KafkaClientsResource.deployKafkaClients(false, CLUSTER_NAME + \"-\" + Constants.KAFKA_CLIENTS).done();\n+\n+        final String kafkaClientsPodName =\n+                ResourceManager.kubeClient().listPodsByPrefixInName(\"my-cluster\" + \"-\" + Constants.KAFKA_CLIENTS).get(0).getMetadata().getName();", "originalCommit": "750f165236f721a50aa258f846bebb5d3613b875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9051d4a0de0ca360f53669080d87d0de03528739", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9051d4a0de0ca360f53669080d87d0de03528739", "message": "Fix tests after refactor\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:53:50Z", "type": "commit"}, {"oid": "9051d4a0de0ca360f53669080d87d0de03528739", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9051d4a0de0ca360f53669080d87d0de03528739", "message": "Fix tests after refactor\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-02-04T13:53:50Z", "type": "forcePushed"}]}