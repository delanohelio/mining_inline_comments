{"pr_number": 4005, "pr_title": "Improve Strimzi network policies for Cluster Operator access", "pr_createdAt": "2020-11-25T21:48:12Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005", "timeline": [{"oid": "b2d314b98fe17c7b3b3256492892e8be3ed2968f", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b2d314b98fe17c7b3b3256492892e8be3ed2968f", "message": "Improve Strimzi network policies for Cluster Operator access\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-11-25T21:37:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM1MDQyNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533350425", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            This variable should not be configured manually but should use the Kubernetes Downward API.\n          \n          \n            \n            Do not configure this variable manually. Use the Kubernetes Downward API.", "author": "PaulRMellor", "createdAt": "2020-12-01T11:51:24Z", "path": "documentation/modules/ref-operator-cluster.adoc", "diffHunk": "@@ -27,6 +27,23 @@ env:\n The timeout for internal operations, in milliseconds. This value should be\n increased when using Strimzi on clusters where regular Kubernetes operations take longer than usual (because of slow downloading of Docker images, for example).\n \n+`STRIMZI_OPERATOR_NAMESPACE`:: The name of the namespace where the Strimzi Cluster Operator is running.\n+This variable should not be configured manually but should use the Kubernetes Downward API.", "originalCommit": "b2d314b98fe17c7b3b3256492892e8be3ed2968f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM1MTM3Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533351376", "bodyText": "Do we want to show example use of downward api?", "author": "PaulRMellor", "createdAt": "2020-12-01T11:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM1MDQyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4ODQ2Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533388466", "bodyText": "Do we want to show example use of downward api?\n\nNo, I do not think we should do it. The user is not expected to touch it. It is in the docs only as an explanation.", "author": "scholzj", "createdAt": "2020-12-01T12:59:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM1MDQyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM1MzExMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533353111", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            These labels will be used to configure the namespace selector in network policies to allow Strimzi Cluster Operator to access the operands only from namespace with these labels.\n          \n          \n            \n            Namespace labels are used to configure the namespace selector in network policies to allow the Strimzi Cluster Operator to only have access to the operands from the namespace with these labels.", "author": "PaulRMellor", "createdAt": "2020-12-01T11:55:57Z", "path": "documentation/modules/ref-operator-cluster.adoc", "diffHunk": "@@ -27,6 +27,23 @@ env:\n The timeout for internal operations, in milliseconds. This value should be\n increased when using Strimzi on clusters where regular Kubernetes operations take longer than usual (because of slow downloading of Docker images, for example).\n \n+`STRIMZI_OPERATOR_NAMESPACE`:: The name of the namespace where the Strimzi Cluster Operator is running.\n+This variable should not be configured manually but should use the Kubernetes Downward API.\n++\n+[source,yaml,options=\"nowrap\"]\n+----\n+env:\n+  - name: STRIMZI_OPERATOR_NAMESPACE\n+    valueFrom:\n+      fieldRef:\n+        fieldPath: metadata.namespace\n+----\n+\n+`STRIMZI_OPERATOR_NAMESPACE_LABELS`:: Optional.\n+The labels of the namespace where the Strimzi Cluster Operator is running.\n+These labels will be used to configure the namespace selector in network policies to allow Strimzi Cluster Operator to access the operands only from namespace with these labels.", "originalCommit": "b2d314b98fe17c7b3b3256492892e8be3ed2968f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM1MzcwNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533353706", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            When not set, the namespace selector in network policies will be configured to allow access from Strimzi Cluster Operator from any namespace in the Kubernetes cluster.\n          \n          \n            \n            When not set, the namespace selector in network policies is configured to allow access to the Strimzi Cluster Operator from any namespace in the Kubernetes cluster.", "author": "PaulRMellor", "createdAt": "2020-12-01T11:56:57Z", "path": "documentation/modules/ref-operator-cluster.adoc", "diffHunk": "@@ -27,6 +27,23 @@ env:\n The timeout for internal operations, in milliseconds. This value should be\n increased when using Strimzi on clusters where regular Kubernetes operations take longer than usual (because of slow downloading of Docker images, for example).\n \n+`STRIMZI_OPERATOR_NAMESPACE`:: The name of the namespace where the Strimzi Cluster Operator is running.\n+This variable should not be configured manually but should use the Kubernetes Downward API.\n++\n+[source,yaml,options=\"nowrap\"]\n+----\n+env:\n+  - name: STRIMZI_OPERATOR_NAMESPACE\n+    valueFrom:\n+      fieldRef:\n+        fieldPath: metadata.namespace\n+----\n+\n+`STRIMZI_OPERATOR_NAMESPACE_LABELS`:: Optional.\n+The labels of the namespace where the Strimzi Cluster Operator is running.\n+These labels will be used to configure the namespace selector in network policies to allow Strimzi Cluster Operator to access the operands only from namespace with these labels.\n+When not set, the namespace selector in network policies will be configured to allow access from Strimzi Cluster Operator from any namespace in the Kubernetes cluster.", "originalCommit": "b2d314b98fe17c7b3b3256492892e8be3ed2968f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM1NDQzOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533354438", "bodyText": "Assuming there's a from and to here", "author": "PaulRMellor", "createdAt": "2020-12-01T11:58:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM1MzcwNg=="}], "type": "inlineReview"}, {"oid": "18f4076caa421c75f62cc1f71c868fc2fbc67680", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/18f4076caa421c75f62cc1f71c868fc2fbc67680", "message": "Apply suggestions from code review\r\n\r\nSigned-off-by: Jakub Scholz <www@scholzj.com>\n\nCo-authored-by: PaulRMellor <47596553+PaulRMellor@users.noreply.github.com>", "committedDate": "2020-12-01T12:54:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQyNzE0Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533427147", "bodyText": "Looks like this is repeated 3 times, can we extract a method?", "author": "tombentley", "createdAt": "2020-12-01T13:59:38Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/ZookeeperCluster.java", "diffHunk": "@@ -412,7 +421,20 @@ public NetworkPolicy generateNetworkPolicy(boolean namespaceAndPodSelectorNetwor\n             expressions4.put(Labels.STRIMZI_KIND_LABEL, \"cluster-operator\");\n             labelSelector4.setMatchLabels(expressions4);\n             clusterOperatorPeer.setPodSelector(labelSelector4);\n-            clusterOperatorPeer.setNamespaceSelector(new LabelSelector());\n+\n+            if (!namespace.equals(operatorNamespace)) {\n+                // If CO and Zoo do not run in the same namespace, we need to handle cross namespace access\n+\n+                if (operatorNamespaceLabels != null)    {\n+                    // If user specified the namespace labels, we can use them to make the selector as tight as possible\n+                    LabelSelector nsLabelSelector = new LabelSelector();\n+                    nsLabelSelector.setMatchLabels(operatorNamespaceLabels.toMap());\n+                    clusterOperatorPeer.setNamespaceSelector(nsLabelSelector);\n+                } else {\n+                    // If no namespace labels were specified, we open the network policy to COs in all namespaces\n+                    clusterOperatorPeer.setNamespaceSelector(new LabelSelector());\n+                }\n+            }", "originalCommit": "18f4076caa421c75f62cc1f71c868fc2fbc67680", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU4MDcwOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533580708", "bodyText": "Good idea. Thanks.", "author": "scholzj", "createdAt": "2020-12-01T17:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQyNzE0Nw=="}], "type": "inlineReview"}, {"oid": "e01f042299df92ab709a7f2f23baa48db4bc039b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e01f042299df92ab709a7f2f23baa48db4bc039b", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-01T17:09:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5Mzk3OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533693978", "bodyText": "\"namespace s\" -> \"namespace as\" ?", "author": "ppatierno", "createdAt": "2020-12-01T20:16:05Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/ModelUtils.java", "diffHunk": "@@ -479,4 +481,33 @@ public static AffinityBuilder populateAffinityBuilderWithRackLabelSelector(Affin\n         }\n         return builder;\n     }\n+\n+    /**\n+     * Decides whether the Cluster Operator needs namespaceSelector to be configured in the network policies in order\n+     * to talk with the operands. This follows the following rules:\n+     *     - If it runs in the same namespace s the operand, do not set namespace selector", "originalCommit": "e01f042299df92ab709a7f2f23baa48db4bc039b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b47a6a9d858ee7a8f66a07c692de4a2ffe4403fc", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b47a6a9d858ee7a8f66a07c692de4a2ffe4403fc", "message": "Review comments II\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-01T20:23:57Z", "type": "commit"}]}