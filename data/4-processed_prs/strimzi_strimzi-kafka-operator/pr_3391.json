{"pr_number": 3391, "pr_title": "[systemtest] Load ST variables from json config", "pr_createdAt": "2020-07-27T11:01:52Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3391", "timeline": [{"oid": "18893f94092313506d63a0c4d0b74ac2ee52d2c3", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/18893f94092313506d63a0c4d0b74ac2ee52d2c3", "message": "[SystemTest] Load ST env from configuration\n\nSigned-off-by: David Kornel <kornys@outlook.com>", "committedDate": "2020-07-27T10:50:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgyMzE3MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3391#discussion_r460823170", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            file is defined by env variable `CONFIG`, if `CONFIG` env variable is not defined, default config location is used `systemtests/config.json`.\n          \n          \n            \n            file is defined by env variable `CONFIG`, if `CONFIG` env variable is not defined, default config location is used `systemtest/config.json`.", "author": "Frawless", "createdAt": "2020-07-27T11:25:35Z", "path": "development-docs/TESTING.md", "diffHunk": "@@ -181,6 +181,14 @@ All available test groups are listed in [Constants](systemtest/src/main/java/io/\n ## Environment variables\n \n System tests can be configured by several environment variables, which are loaded before test execution.\n+Variables can be defined via env or via configuration file, this file can be placed anywhere and path to this\n+file is defined by env variable `CONFIG`, if `CONFIG` env variable is not defined, default config location is used `systemtests/config.json`.", "originalCommit": "2b03a9dc22c77d8ae118c02f36ac76907fd1e54e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fc0c0eeab8b404363253eae726660822e615b23d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/fc0c0eeab8b404363253eae726660822e615b23d", "message": "Write doc\n\nSigned-off-by: David Kornel <kornys@outlook.com>", "committedDate": "2020-07-27T12:09:11Z", "type": "forcePushed"}, {"oid": "036196cd0cdd259312786b264893e305c171ae09", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/036196cd0cdd259312786b264893e305c171ae09", "message": "Write doc\n\nSigned-off-by: David Kornel <kornys@outlook.com>", "committedDate": "2020-07-27T12:42:41Z", "type": "commit"}, {"oid": "036196cd0cdd259312786b264893e305c171ae09", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/036196cd0cdd259312786b264893e305c171ae09", "message": "Write doc\n\nSigned-off-by: David Kornel <kornys@outlook.com>", "committedDate": "2020-07-27T12:42:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3Mjg0Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3391#discussion_r461172842", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Variables can be defined via env or via configuration file, this file can be placed anywhere and path to this\n          \n          \n            \n            file is defined by env variable `CONFIG`, if `CONFIG` env variable is not defined, default config location is used `systemtest/config.json`.\n          \n          \n            \n            \n          \n          \n            \n            Loading of variables has following priority:\n          \n          \n            \n            1. Environment variable\n          \n          \n            \n            2. Variable defined in config\n          \n          \n            \n            3. Default value\n          \n          \n            \n            Variables can be defined via environmental variables or a configuration file, this file can be located anywhere on the file system as long as a path is provided to this file. \n          \n          \n            \n            The path is defined by environmental variable `SYSTEM_TEST_CONFIG_PATH`, if the `SYSTEM_TEST_CONFIG_PATH` environmental variable is not defined, the default config file location is used `systemtest/config.json`.\n          \n          \n            \n            \n          \n          \n            \n            Loading of system configuration has the following priority order:\n          \n          \n            \n            1. Environment variable\n          \n          \n            \n            2. Variable defined in configuration file\n          \n          \n            \n            3. Default value\n          \n      \n    \n    \n  \n\nI recommend CONFIG -> SYSTEM_TEST_CONFIG_PATH as it's less likely to conflict with pre-set envars on running systems.", "author": "samuel-hawker", "createdAt": "2020-07-27T21:12:08Z", "path": "development-docs/TESTING.md", "diffHunk": "@@ -181,6 +181,14 @@ All available test groups are listed in [Constants](systemtest/src/main/java/io/\n ## Environment variables\n \n System tests can be configured by several environment variables, which are loaded before test execution.\n+Variables can be defined via env or via configuration file, this file can be placed anywhere and path to this\n+file is defined by env variable `CONFIG`, if `CONFIG` env variable is not defined, default config location is used `systemtest/config.json`.\n+\n+Loading of variables has following priority:\n+1. Environment variable\n+2. Variable defined in config\n+3. Default value", "originalCommit": "036196cd0cdd259312786b264893e305c171ae09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MzI0OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3391#discussion_r461173248", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String CONFIG_ENV = \"CONFIG\";\n          \n          \n            \n                private static final String CONFIG_FILE_PATH_ENVAR = \"SYSTEM_TEST_CONFIG_PATH\";", "author": "samuel-hawker", "createdAt": "2020-07-27T21:12:56Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/Environment.java", "diffHunk": "@@ -4,18 +4,33 @@\n  */\n package io.strimzi.systemtest;\n \n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n \n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n import java.util.Locale;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.function.Function;\n \n /**\n  * Class which holds environment variables for system tests.\n  */\n public class Environment {\n \n     private static final Logger LOGGER = LogManager.getLogger(Environment.class);\n+    private static final Map<String, String> VALUES = new HashMap<>();\n+    private static final JsonNode JSON_DATA = loadJsonEnv();\n \n+    /**\n+     * Specify config json/yaml path with env variables values\n+     */\n+    private static final String CONFIG_ENV = \"CONFIG\";", "originalCommit": "036196cd0cdd259312786b264893e305c171ae09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3Mzk1Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3391#discussion_r461173957", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Specify config json/yaml path with env variables values\n          \n          \n            \n                 * Specify the system test configuration file path from an environmental variable\n          \n          \n            \n                 * This configuration file has a JSON or YAML format", "author": "samuel-hawker", "createdAt": "2020-07-27T21:14:21Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/Environment.java", "diffHunk": "@@ -4,18 +4,33 @@\n  */\n package io.strimzi.systemtest;\n \n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n \n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n import java.util.Locale;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.function.Function;\n \n /**\n  * Class which holds environment variables for system tests.\n  */\n public class Environment {\n \n     private static final Logger LOGGER = LogManager.getLogger(Environment.class);\n+    private static final Map<String, String> VALUES = new HashMap<>();\n+    private static final JsonNode JSON_DATA = loadJsonEnv();\n \n+    /**\n+     * Specify config json/yaml path with env variables values", "originalCommit": "036196cd0cdd259312786b264893e305c171ae09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3NTExMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3391#discussion_r461175113", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static JsonNode loadJsonEnv() {\n          \n          \n            \n                private static JsonNode loadConfigurationFile() {\n          \n      \n    \n    \n  \n\nI would recommend this renaming to make clearer what it is doing, the fact that the file is JSON/YAML is an implementation detail and (hopefully) should be obvious from the documentation + return type", "author": "samuel-hawker", "createdAt": "2020-07-27T21:16:40Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/Environment.java", "diffHunk": "@@ -161,4 +164,35 @@ public static boolean isHelmInstall() {\n     public static boolean useLatestReleasedBridge() {\n         return Environment.BRIDGE_IMAGE.equals(Environment.BRIDGE_IMAGE_DEFAULT);\n     }\n+\n+    private static String getOrDefault(String varName, String defaultValue) {\n+        return getOrDefault(varName, String::toString, defaultValue);\n+    }\n+\n+    private static <T> T getOrDefault(String var, Function<String, T> converter, T defaultValue) {\n+        String value = System.getenv(var) != null ?\n+                System.getenv(var) :\n+                (Objects.requireNonNull(JSON_DATA).get(var) != null ?\n+                        JSON_DATA.get(var).asText() :\n+                        null);\n+        T returnValue = defaultValue;\n+        if (value != null) {\n+            returnValue = converter.apply(value);\n+        }\n+        VALUES.put(var, String.valueOf(returnValue));\n+        return returnValue;\n+    }\n+\n+    private static JsonNode loadJsonEnv() {", "originalCommit": "036196cd0cdd259312786b264893e305c171ae09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "92ba4a96a63e443ecc1cbde704844c681e769b0e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/92ba4a96a63e443ecc1cbde704844c681e769b0e", "message": "Address comments\n\nSigned-off-by: David Kornel <kornys@outlook.com>", "committedDate": "2020-07-28T07:46:54Z", "type": "commit"}]}