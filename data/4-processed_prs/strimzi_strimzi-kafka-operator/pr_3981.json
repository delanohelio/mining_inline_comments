{"pr_number": 3981, "pr_title": "[DOC] Guidelines for downgrade", "pr_createdAt": "2020-11-19T16:06:32Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981", "timeline": [{"oid": "0571ccf533e7c607aff7fc063dfa4d9f36c95a6c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/0571ccf533e7c607aff7fc063dfa4d9f36c95a6c", "message": "[DOC] Guidelines for downgrade\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-11-19T16:02:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzAxODI3NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r527018274", "bodyText": "Should this still be here?", "author": "scholzj", "createdAt": "2020-11-19T16:21:20Z", "path": "documentation/assemblies/upgrading/assembly-downgrade-kafka-versions.adoc", "diffHunk": "@@ -1,20 +1,13 @@\n // This assembly is included in the following assemblies:\n //\n-// assembly-upgrade.adoc\n-\n-\n-[id='assembly-downgrading-kafka-versions-{context}']\n+// assembly-downgrade.adoc\n \n+[id='assembly-downgrade-kafka-versions-{context}']\n = Downgrading Kafka\n \n Kafka version downgrades are performed using the Cluster Operator.\n \n-Whether and how the Cluster Operator performs a downgrade depends on the differences between versions of:\n-\n-* Interbroker protocol\n-* Log message format\n-* ZooKeeper\n-\n+//Version constraints on the downgrade", "originalCommit": "0571ccf533e7c607aff7fc063dfa4d9f36c95a6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzAyMDA0Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r527020047", "bodyText": "Note on the file included in the assembly", "author": "PaulRMellor", "createdAt": "2020-11-19T16:23:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzAxODI3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY0MDYzOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r527640638", "bodyText": "Suggested change:\nperformed by the Cluster Operator.", "author": "laidan6000", "createdAt": "2020-11-20T11:51:05Z", "path": "documentation/assemblies/upgrading/assembly-downgrade-kafka-versions.adoc", "diffHunk": "@@ -1,20 +1,13 @@\n // This assembly is included in the following assemblies:\n //\n-// assembly-upgrade.adoc\n-\n-\n-[id='assembly-downgrading-kafka-versions-{context}']\n+// assembly-downgrade.adoc\n \n+[id='assembly-downgrade-kafka-versions-{context}']\n = Downgrading Kafka\n \n Kafka version downgrades are performed using the Cluster Operator.", "originalCommit": "0571ccf533e7c607aff7fc063dfa4d9f36c95a6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY0MTU3Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r527641572", "bodyText": "I'm not sure about the square bracket convention here. Perhaps bold is better?", "author": "laidan6000", "createdAt": "2020-11-20T11:53:01Z", "path": "documentation/modules/upgrading/proc-downgrade-brokers-older-kafka.adoc", "diffHunk": "@@ -8,30 +8,11 @@\n \n This procedure describes how you can downgrade a Strimzi Kafka cluster to a lower (previous) version of Kafka, such as downgrading from {KafkaVersionHigher} to {KafkaVersionLower}.\n \n-[IMPORTANT]\n-====\n-Downgrading is _not possible_ if the new version has ever used a `log.message.format.version` that is not supported by the previous version, including when the default value for `log.message.format.version` is used. For example, this resource can be downgraded to Kafka version {KafkaVersionLower} because the `log.message.format.version` has not been changed:\n-\n-[source,yaml,subs=attributes+]\n-----\n-apiVersion: v1alpha1\n-kind: Kafka\n-spec:\n-  # ...\n-  kafka:\n-    version: {KafkaVersionHigher}\n-    config:\n-      log.message.format.version: \"{LogMsgVersLower}\"\n-      # ...\n-----\n-\n-The downgrade would not be possible if the `log.message.format.version` was set at `\"{LogMsgVersHigher}\"` or a value was absent (so that the parameter took the default value for a {KafkaVersionHigher} broker of {LogMsgVersHigher}).\n-====\n-\n .Prerequisites\n \n For the `Kafka` resource to be downgraded, check:\n \n+* [IMPORTANT] xref:com-target-downgrade-version-{context}[Compatibility of Kafka versions].", "originalCommit": "0571ccf533e7c607aff7fc063dfa4d9f36c95a6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgyNDUzNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r527824537", "bodyText": "I tried the bold, but thought just the capital was enough in the end. We use a similar format elsewhere, like with ADVANCED OPTION: for callouts", "author": "PaulRMellor", "createdAt": "2020-11-20T16:53:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY0MTU3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY0MjI1MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r527642251", "bodyText": "Suggested change:\nUse the same wording in lines 17 and 18:\nKafka version being downgraded to", "author": "laidan6000", "createdAt": "2020-11-20T11:54:25Z", "path": "documentation/modules/upgrading/proc-downgrade-brokers-older-kafka.adoc", "diffHunk": "@@ -8,30 +8,11 @@\n \n This procedure describes how you can downgrade a Strimzi Kafka cluster to a lower (previous) version of Kafka, such as downgrading from {KafkaVersionHigher} to {KafkaVersionLower}.\n \n-[IMPORTANT]\n-====\n-Downgrading is _not possible_ if the new version has ever used a `log.message.format.version` that is not supported by the previous version, including when the default value for `log.message.format.version` is used. For example, this resource can be downgraded to Kafka version {KafkaVersionLower} because the `log.message.format.version` has not been changed:\n-\n-[source,yaml,subs=attributes+]\n-----\n-apiVersion: v1alpha1\n-kind: Kafka\n-spec:\n-  # ...\n-  kafka:\n-    version: {KafkaVersionHigher}\n-    config:\n-      log.message.format.version: \"{LogMsgVersLower}\"\n-      # ...\n-----\n-\n-The downgrade would not be possible if the `log.message.format.version` was set at `\"{LogMsgVersHigher}\"` or a value was absent (so that the parameter took the default value for a {KafkaVersionHigher} broker of {LogMsgVersHigher}).\n-====\n-\n .Prerequisites\n \n For the `Kafka` resource to be downgraded, check:\n \n+* [IMPORTANT] xref:com-target-downgrade-version-{context}[Compatibility of Kafka versions].\n * The Cluster Operator, which supports both versions of Kafka, is up and running.\n * The `Kafka.spec.kafka.config` does not contain options that are not supported in the version of Kafka you are downgrading to.", "originalCommit": "0571ccf533e7c607aff7fc063dfa4d9f36c95a6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgyNjQ3MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r527826470", "bodyText": "\ud83d\udc4d  I changed both to: by the Kafka version being downgraded to.", "author": "PaulRMellor", "createdAt": "2020-11-20T16:55:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY0MjI1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY0MzI1NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r527643255", "bodyText": "I would just remove \"What to do next\" from this module.", "author": "laidan6000", "createdAt": "2020-11-20T11:56:22Z", "path": "documentation/modules/upgrading/proc-upgrade-cluster-operator.adoc", "diffHunk": "@@ -52,4 +52,4 @@ You now have an updated Cluster Operator, but the version of Kafka running in th\n \n .What to do next\n \n-Following the Cluster Operator upgrade, you can perform a xref:assembly-upgrading-kafka-versions-str[Kafka upgrade].\n+Following the Cluster Operator upgrade, you can perform a xref:assembly-upgrading-kafka-versions-str[Kafka downgrade].", "originalCommit": "0571ccf533e7c607aff7fc063dfa4d9f36c95a6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgyOTYyOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r527829628", "bodyText": "Assuming you mean just the title. Removed.", "author": "PaulRMellor", "createdAt": "2020-11-20T16:59:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY0MzI1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg1MTYxMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r527851612", "bodyText": "I actually meant the whole thing! Why would a user downgrade Kafka after they've upgraded the Cluster Operator?", "author": "laidan6000", "createdAt": "2020-11-20T17:31:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY0MzI1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY0NDEwNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r527644104", "bodyText": "You can or you must?", "author": "laidan6000", "createdAt": "2020-11-20T11:58:12Z", "path": "documentation/modules/upgrading/proc-downgrade-cluster-operator.adoc", "diffHunk": "@@ -0,0 +1,51 @@\n+// Module included in the following assemblies:\n+//\n+// assembly-downgrade.adoc\n+\n+[id='proc-downgrade-cluster-operator-{context}']\n+= Downgrading the Cluster Operator to a previous version\n+\n+This procedure describes how to downgrade a Cluster Operator deployment to a previous version.\n+\n+.Prerequisites\n+\n+* An existing Cluster Operator deployment is available.\n+* You have xref:downloads-{context}[downloaded the installation files for the previous version].\n+\n+.Procedure\n+\n+. Take note of any configuration changes made to the existing Cluster Operator resources (in the `/install/cluster-operator` directory).\n+Any changes will be *overwritten* by the previous version of the Cluster Operator.\n+\n+. Update the Cluster Operator.\n+\n+.. Modify the installation files for the previous version according to the namespace the Cluster Operator is running in.\n++\n+include::snip-cluster-operator-namespace-sed.adoc[]\n++\n+.. If you modified one or more environment variables in your existing Cluster Operator `Deployment`, edit the\n+`install/cluster-operator/060-Deployment-cluster-operator.yaml` file to use those environment variables.\n+\n+. When you have an updated configuration, deploy it along with the rest of the installation resources:\n++\n+[source,shell,subs=\"+quotes,attributes\"]\n+----\n+kubectl apply -f install/cluster-operator\n+----\n++\n+Wait for the rolling updates to complete.\n+\n+. Get the image for the Kafka pod to ensure the downgrade was successful:\n++\n+[source,shell,subs=\"+quotes,attributes\"]\n+----\n+kubectl get po my-cluster-kafka-0 -o jsonpath='{.spec.containers[0].image}'\n+----\n++\n+The image tag shows the new Strimzi version followed by the Kafka version. For example, `_NEW-STRIMZI-VERSION_-kafka-_CURRENT-KAFKA-VERSION_`.\n+\n+You now have an updated Cluster Operator, but the version of Kafka running in the cluster it manages is unchanged.\n+\n+.What to do next\n+\n+Following the Cluster Operator downgrade, you can perform a xref:assembly-downgrade-kafka-versions-{context}[Kafka downgrade].", "originalCommit": "0571ccf533e7c607aff7fc063dfa4d9f36c95a6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgzMTM0OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r527831348", "bodyText": "Can, as in it's now possible after the CO downgrade. Though that's only the case if messages haven't been logged with the later version.", "author": "PaulRMellor", "createdAt": "2020-11-20T17:02:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY0NDEwNA=="}], "type": "inlineReview"}, {"oid": "b67586c573bf4156f2d3b2bb3b4db024981fe83f", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b67586c573bf4156f2d3b2bb3b4db024981fe83f", "message": "review edits DL\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-11-20T17:06:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY0NjcwNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r528646706", "bodyText": "This is not correct. The operator currently takes charge of the interbroker protocol, and updates it automatically. That means that the user cannot safely downgrade the brokers, even if they didn't complete the upgrade. I.e. once they've started to upgrade the Kafka cluster then they can't currently safely back out. They can upgrade and downgrade the operator.", "author": "tombentley", "createdAt": "2020-11-23T11:48:51Z", "path": "documentation/assemblies/upgrading/assembly-downgrade.adoc", "diffHunk": "@@ -0,0 +1,26 @@\n+// This assembly is included in the following assemblies:\n+//\n+// deploying/master.adoc\n+\n+[id='assembly-downgrade-{context}']\n+= Downgrading Strimzi\n+\n+If you are encountering issues with the latest version of Strimzi,\n+you can revert your installation to the previous version.\n+\n+As with the Strimzi upgrade process, you can perform your downgrade in two stages:\n+\n+. Revert your Cluster Operator to the previous Strimzi version.\n+** xref:proc-downgrade-cluster-operator-{context}[]\n+\n+. Downgrade all Kafka brokers and client applications to the previous Kafka version.", "originalCommit": "b67586c573bf4156f2d3b2bb3b4db024981fe83f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI2ODIzMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r529268232", "bodyText": "@tombentley Thanks Tom. I thought we could perform the downgrade if interbroker versions were the same. So you recommend we drop the section on downgrading Kafka entirely for now?", "author": "PaulRMellor", "createdAt": "2020-11-24T07:55:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY0NjcwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQxMTQ0Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r529411446", "bodyText": "@PaulRMellor yeah, it would work like that if the operator didn't bump the interbroker version for you. IOW once you've changed Kafka.spec.kafka.version you've essentially changed the interbroker version, and Kafka downgrade is no longer possible. So, yes we should drop the section on downgrading Kafka for the time being.", "author": "tombentley", "createdAt": "2020-11-24T10:22:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY0NjcwNg=="}], "type": "inlineReview"}, {"oid": "2a000f70e889c31d2c400072b41c53a0033a9dd2", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2a000f70e889c31d2c400072b41c53a0033a9dd2", "message": "remove kafka downgrade sections\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-11-25T12:07:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQzNzE1OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r532437158", "bodyText": "It's not just this, it's used to gate other persistent data too (such as the versions of JSON persisted in zookeeper).", "author": "tombentley", "createdAt": "2020-11-30T09:01:03Z", "path": "documentation/modules/upgrading/con-downgrade-target-version.adoc", "diffHunk": "@@ -4,15 +4,40 @@\n \n [id='com-target-downgrade-version-{context}']\n \n-= Target downgrade version\n+= Kafka version compatibility for downgrades\n \n-How the Cluster Operator handles a downgrade operation depends on the `log.message.format.version`.\n+Kafka downgrades are dependent on compatible current and target xref:ref-kafka-versions-{context}[Kafka versions],\n+and the state at which messages have been logged.\n \n-* If the target downgrade version of Kafka has the same `log.message.format.version` as the current version, the Cluster Operator downgrades by performing a single rolling restart of the brokers.\n-* If the target downgrade version of Kafka has a different `log.message.format.version`, downgrading is only possible if the running cluster has _always_ had `log.message.format.version` set to the version used by the downgraded version.\n-+\n+You cannot revert to the previous Kafka version if the `inter.broker.protocol.version` differs, or messages have been added\n+to message logs that use a newer `log.message.format.version`.\n+\n+The `inter.broker.protocol.version` determines the schema used in the messages written to `__consumer_offsets`.", "originalCommit": "2a000f70e889c31d2c400072b41c53a0033a9dd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY4MDU4NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r532680585", "bodyText": "How about:\n\nThe inter.broker.protocol.version determines the schemas used for persistent metadata stored by the broker, such as the schema for messages written to __consumer_offsets.\n\nUnless we want to go into more detail?", "author": "PaulRMellor", "createdAt": "2020-11-30T15:26:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQzNzE1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY4MTEyNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r532681124", "bodyText": "This section is being left out for now", "author": "PaulRMellor", "createdAt": "2020-11-30T15:27:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQzNzE1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQzNzk1OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r532437959", "bodyText": "While that's true, it doesn't inform the reader about what the consequences of that will be. We should be clear that, in general, it  basically results in a \"broker cluster\". The rest of this concept then goes into detailed talk about the log message format version which could easily mislead people into thinking this sentence is not really a problem. I think we should probably omit the following sentences because they're mostly irrelevant due to a broker cluster generally being a \"game over\" situation.", "author": "tombentley", "createdAt": "2020-11-30T09:02:23Z", "path": "documentation/modules/upgrading/con-downgrade-target-version.adoc", "diffHunk": "@@ -4,15 +4,40 @@\n \n [id='com-target-downgrade-version-{context}']\n \n-= Target downgrade version\n+= Kafka version compatibility for downgrades\n \n-How the Cluster Operator handles a downgrade operation depends on the `log.message.format.version`.\n+Kafka downgrades are dependent on compatible current and target xref:ref-kafka-versions-{context}[Kafka versions],\n+and the state at which messages have been logged.\n \n-* If the target downgrade version of Kafka has the same `log.message.format.version` as the current version, the Cluster Operator downgrades by performing a single rolling restart of the brokers.\n-* If the target downgrade version of Kafka has a different `log.message.format.version`, downgrading is only possible if the running cluster has _always_ had `log.message.format.version` set to the version used by the downgraded version.\n-+\n+You cannot revert to the previous Kafka version if the `inter.broker.protocol.version` differs, or messages have been added\n+to message logs that use a newer `log.message.format.version`.\n+\n+The `inter.broker.protocol.version` determines the schema used in the messages written to `__consumer_offsets`.\n+If you downgrade to a version of Kafka that uses an earlier `inter.broker.protocol.version`, the broker will not understand the messages.", "originalCommit": "2a000f70e889c31d2c400072b41c53a0033a9dd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY4MjQ2Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r532682463", "bodyText": "We're leaving this section out for now. I'm not sure how much we will want to retain when this situation is rectified?", "author": "PaulRMellor", "createdAt": "2020-11-30T15:29:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQzNzk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjY4NzIxOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r532687219", "bodyText": "I've updated this sentence to:\n\nTherefore, if you downgrade to a version of Kafka that uses an earlier inter.broker.protocol.version, the cluster will not work.", "author": "PaulRMellor", "createdAt": "2020-11-30T15:35:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQzNzk1OQ=="}], "type": "inlineReview"}, {"oid": "365b588a20010b605b8a81b0a126a7d53ca97d8c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/365b588a20010b605b8a81b0a126a7d53ca97d8c", "message": "review edits TB\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-11-30T15:36:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAwNzYwNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r534007606", "bodyText": "The latest version of Strimzi sounds weird given the documentation is for the latest Strimzi version for a month or two but then it is for some older version but might be still use. Can we maybe rephrase it to say something like If you are encountering issues with the version of Strimzi you upgraded to?", "author": "scholzj", "createdAt": "2020-12-02T09:15:08Z", "path": "documentation/assemblies/upgrading/assembly-downgrade.adoc", "diffHunk": "@@ -0,0 +1,26 @@\n+// This assembly is included in the following assemblies:\n+//\n+// deploying/master.adoc\n+\n+[id='assembly-downgrade-{context}']\n+= Downgrading Strimzi\n+\n+If you are encountering issues with the latest version of Strimzi,", "originalCommit": "365b588a20010b605b8a81b0a126a7d53ca97d8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxMTQxOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r534011419", "bodyText": "I think this will be confusing ... saying it happens in two stages for me gives it a particular order. But the order is not so simple. For example, I'm running Strimzi 0.19.0 with Kafka 2.5. And I upgrade first to Strimzi 0.20 + Kafka 2.5 and then to Kafka 2.6. In that case, the order here is actually first to downgrade Kafka 2.6 to 2.5 if still possible and then to downgrade Strimzi 0.20 to 0.19.", "author": "scholzj", "createdAt": "2020-12-02T09:20:32Z", "path": "documentation/assemblies/upgrading/assembly-downgrade.adoc", "diffHunk": "@@ -0,0 +1,26 @@\n+// This assembly is included in the following assemblies:\n+//\n+// deploying/master.adoc\n+\n+[id='assembly-downgrade-{context}']\n+= Downgrading Strimzi\n+\n+If you are encountering issues with the latest version of Strimzi,\n+you can revert your installation to the previous version.\n+\n+As with the Strimzi upgrade process, you can perform your downgrade in two stages:\n+\n+. Revert your Cluster Operator to the previous Strimzi version.\n+** xref:proc-downgrade-cluster-operator-{context}[]\n+\n+. Downgrade all Kafka brokers and client applications to the previous Kafka version.\n+** xref:assembly-downgrade-kafka-versions-{context}[]", "originalCommit": "365b588a20010b605b8a81b0a126a7d53ca97d8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI5MTgzNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r534291835", "bodyText": "I've simplified to:\nYou can perform a downgrade to:\n\n. Revert your Cluster Operator to the previous Strimzi version.\n** xref:proc-downgrade-cluster-operator-{context}[]\n\n. Downgrade all Kafka brokers and client applications to the previous Kafka version.\n** xref:assembly-downgrade-kafka-versions-{context}[]", "author": "PaulRMellor", "createdAt": "2020-12-02T16:11:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxMTQxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI5MjEwNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r534292104", "bodyText": "This section won't be in the doc yet", "author": "PaulRMellor", "createdAt": "2020-12-02T16:11:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxMTQxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNDIzNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r534014235", "bodyText": "This has to be part of the Cluster Operator downgrade. It does not have to be changed with Kafka downgrade. The operator supports the new format with any Kafka version it supports.\nI also wonder if we should make it more generic: Revert any changes to the CRs or something. As there are more new things in each release. E.g. rack awareness in Connect, host aliases and other things are not supported after the operator downgrade and need to be removed. So making it more generic would be IMHO a plus.", "author": "scholzj", "createdAt": "2020-12-02T09:24:38Z", "path": "documentation/modules/upgrading/proc-downgrade-brokers-older-kafka.adoc", "diffHunk": "@@ -70,6 +51,11 @@ NOTE: You must format the value of `log.message.format.version` as a string to p\n +\n See xref:con-versions-and-images-str[]\n \n+.. If you changed the Kafka listener configuration to use the array format of the `GenericKafkaListener` schema,\n+revert the `Kafka.spec.kafka.listeners` to use the old format.\n++\n+See xref:con-upgrade-listeners-str[]", "originalCommit": "365b588a20010b605b8a81b0a126a7d53ca97d8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM0ODkzNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r534348937", "bodyText": "Removed from this procedure and added a new generic procedure to the CO downgrade procedure.", "author": "PaulRMellor", "createdAt": "2020-12-02T17:27:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNDIzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNDUxOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r534014519", "bodyText": "Same as earlier ... the latest version sounds weird and confusing here.", "author": "scholzj", "createdAt": "2020-12-02T09:25:01Z", "path": "documentation/modules/upgrading/proc-downgrade-cluster-operator.adoc", "diffHunk": "@@ -0,0 +1,50 @@\n+// Module included in the following assemblies:\n+//\n+// assembly-downgrade.adoc\n+\n+[id='proc-downgrade-cluster-operator-{context}']\n+= Downgrading the Cluster Operator to a previous version\n+\n+If you are encountering issues with the latest version of Strimzi,", "originalCommit": "365b588a20010b605b8a81b0a126a7d53ca97d8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM1MjkxNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r534352916", "bodyText": "Changed to:\nIf you are encountering issues with Strimzi,\nyou can revert your installation.", "author": "PaulRMellor", "createdAt": "2020-12-02T17:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNDUxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNTA4Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r534015082", "bodyText": "Is this because of the inter.broker.protocol.version? Or why is it the case?", "author": "scholzj", "createdAt": "2020-12-02T09:25:46Z", "path": "documentation/modules/upgrading/proc-upgrade-brokers-newer-kafka.adoc", "diffHunk": "@@ -67,6 +68,10 @@ spec:\n ----\n <1> This is changed to the new version\n <2> This remains at the current version\n+--\n++\n+WARNING: You cannot downgrade Kafka once `spec.kafka.version` has changed.", "originalCommit": "365b588a20010b605b8a81b0a126a7d53ca97d8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE1NDg2Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r534154867", "bodyText": "inter.broker.protocol.version indeed", "author": "tombentley", "createdAt": "2020-12-02T13:11:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNTA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIzODExMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r534238112", "bodyText": "Changed to:\n\nWARNING: You cannot downgrade Kafka once spec.kafka.version has changed, as the inter.broker.protocol.version for the new Kafka version will differ.  The protocol version determines the schemas used for persistent metadata stored by the broker, including messages written to __consumer_offsets. The cluster will not understand the messages.", "author": "PaulRMellor", "createdAt": "2020-12-02T15:04:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNTA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI0NDIwNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r534244204", "bodyText": "Are we cherry-picking this for 0.20 release branch? If not, maybe we should think about this a bit more to improve the experience of this before we do 0.21 and before we merge this.", "author": "scholzj", "createdAt": "2020-12-02T15:12:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNTA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM1NDUwOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r534354508", "bodyText": "Yes. Once it's cherry-picked, we can bring the kafka downgrade sections back in and improve the chapter a whole.", "author": "PaulRMellor", "createdAt": "2020-12-02T17:35:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNTA4Mg=="}], "type": "inlineReview"}, {"oid": "8e50e52b6abdf4302b6b581400f31fdd4f395bac", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8e50e52b6abdf4302b6b581400f31fdd4f395bac", "message": "review edits JS\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-12-02T17:36:07Z", "type": "commit"}, {"oid": "d312c15e5a911bb24d2d5bd501ce0e7f0b56069a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d312c15e5a911bb24d2d5bd501ce0e7f0b56069a", "message": "review edits JS\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-12-02T18:00:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1NDUzNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r536054535", "bodyText": "Just checking that the correct module is included in the master.adoc?", "author": "laidan6000", "createdAt": "2020-12-04T12:09:55Z", "path": "documentation/deploying/master.adoc", "diffHunk": "@@ -20,3 +20,5 @@ include::assemblies/deploying/assembly-deploy-verify.adoc[leveloffset=+1]\n include::assemblies/metrics/assembly-metrics.adoc[leveloffset=+1]\n //Upgrading the deployment\n include::assemblies/upgrading/assembly-upgrade.adoc[leveloffset=+1]\n+//Downgrading the deployment\n+include::modules/upgrading/proc-downgrade-cluster-operator.adoc[leveloffset=+1]", "originalCommit": "d312c15e5a911bb24d2d5bd501ce0e7f0b56069a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ0OTYzMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r537449630", "bodyText": "For the time being, yes. There's a new module for downgrading, but we're concentrating only on the CO downgrade for the time being. Other files exists, but won't be included yet.", "author": "PaulRMellor", "createdAt": "2020-12-07T11:56:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1NDUzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1NzMzNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r536057335", "bodyText": "In Strimzi 0.19.0, this file is named 050-Deployment-strimzi-cluster-operator.yaml.", "author": "laidan6000", "createdAt": "2020-12-04T12:15:14Z", "path": "documentation/modules/upgrading/proc-downgrade-cluster-operator.adoc", "diffHunk": "@@ -0,0 +1,52 @@\n+// Module included in the following assemblies:\n+//\n+// assembly-downgrade.adoc\n+\n+[id='proc-downgrade-cluster-operator-{context}']\n+= Downgrading the Cluster Operator to a previous version\n+\n+If you are encountering issues with Strimzi,\n+you can revert your installation.\n+\n+This procedure describes how to downgrade a Cluster Operator deployment to a previous version.\n+\n+.Prerequisites\n+\n+* An existing Cluster Operator deployment is available.\n+* You have xref:downloads-{context}[downloaded the installation files for the previous version].\n+\n+.Procedure\n+\n+. Take note of any configuration changes made to the existing Cluster Operator resources (in the `/install/cluster-operator` directory).\n+Any changes will be *overwritten* by the previous version of the Cluster Operator.\n++\n+. Revert your custom resources to reflect the supported configuration options available for the version of Strimzi you are downgrading to.\n+\n+. Update the Cluster Operator.\n+\n+.. Modify the installation files for the previous version according to the namespace the Cluster Operator is running in.\n++\n+include::snip-cluster-operator-namespace-sed.adoc[]\n++\n+.. If you modified one or more environment variables in your existing Cluster Operator `Deployment`, edit the\n+`install/cluster-operator/060-Deployment-cluster-operator.yaml` file to use those environment variables.", "originalCommit": "d312c15e5a911bb24d2d5bd501ce0e7f0b56069a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUwMTQ1MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r537501451", "bodyText": "Still 060, but new name.", "author": "PaulRMellor", "createdAt": "2020-12-07T13:22:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1NzMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1ODI2Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r536058262", "bodyText": "Suggested change:\nYour Cluster Operator was downgraded to the previous version.", "author": "laidan6000", "createdAt": "2020-12-04T12:17:01Z", "path": "documentation/modules/upgrading/proc-downgrade-cluster-operator.adoc", "diffHunk": "@@ -0,0 +1,52 @@\n+// Module included in the following assemblies:\n+//\n+// assembly-downgrade.adoc\n+\n+[id='proc-downgrade-cluster-operator-{context}']\n+= Downgrading the Cluster Operator to a previous version\n+\n+If you are encountering issues with Strimzi,\n+you can revert your installation.\n+\n+This procedure describes how to downgrade a Cluster Operator deployment to a previous version.\n+\n+.Prerequisites\n+\n+* An existing Cluster Operator deployment is available.\n+* You have xref:downloads-{context}[downloaded the installation files for the previous version].\n+\n+.Procedure\n+\n+. Take note of any configuration changes made to the existing Cluster Operator resources (in the `/install/cluster-operator` directory).\n+Any changes will be *overwritten* by the previous version of the Cluster Operator.\n++\n+. Revert your custom resources to reflect the supported configuration options available for the version of Strimzi you are downgrading to.\n+\n+. Update the Cluster Operator.\n+\n+.. Modify the installation files for the previous version according to the namespace the Cluster Operator is running in.\n++\n+include::snip-cluster-operator-namespace-sed.adoc[]\n++\n+.. If you modified one or more environment variables in your existing Cluster Operator `Deployment`, edit the\n+`install/cluster-operator/060-Deployment-cluster-operator.yaml` file to use those environment variables.\n+\n+. When you have an updated configuration, deploy it along with the rest of the installation resources:\n++\n+[source,shell,subs=\"+quotes,attributes\"]\n+----\n+kubectl apply -f install/cluster-operator\n+----\n++\n+Wait for the rolling updates to complete.\n+\n+. Get the image for the Kafka pod to ensure the downgrade was successful:\n++\n+[source,shell,subs=\"+quotes,attributes\"]\n+----\n+kubectl get po my-cluster-kafka-0 -o jsonpath='{.spec.containers[0].image}'\n+----\n++\n+The image tag shows the new Strimzi version followed by the Kafka version. For example, `_NEW-STRIMZI-VERSION_-kafka-_CURRENT-KAFKA-VERSION_`.\n+\n+You now have an updated Cluster Operator.", "originalCommit": "d312c15e5a911bb24d2d5bd501ce0e7f0b56069a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1OTAzMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r536059031", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            WARNING: You cannot downgrade Kafka once `spec.kafka.version` has changed, as the `inter.broker.protocol.version` for the new Kafka version will differ. The protocol version determines the schemas used for persistent metadata stored by the broker, including messages written to `__consumer_offsets`. The cluster will not understand the messages.\n          \n          \n            \n            WARNING: You cannot downgrade Kafka after `spec.kafka.version` has changed, because the `inter.broker.protocol.version` for the new Kafka version will differ. The inter-broker protocol version determines the schemas used for persistent metadata stored by the broker, including messages written to `__consumer_offsets`. The downgraded cluster will not understand the messages.", "author": "laidan6000", "createdAt": "2020-12-04T12:18:29Z", "path": "documentation/modules/upgrading/proc-upgrade-brokers-newer-kafka.adoc", "diffHunk": "@@ -67,6 +68,9 @@ spec:\n ----\n <1> This is changed to the new version\n <2> This remains at the current version\n+--\n++\n+WARNING: You cannot downgrade Kafka once `spec.kafka.version` has changed, as the `inter.broker.protocol.version` for the new Kafka version will differ. The protocol version determines the schemas used for persistent metadata stored by the broker, including messages written to `__consumer_offsets`. The cluster will not understand the messages.", "originalCommit": "d312c15e5a911bb24d2d5bd501ce0e7f0b56069a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA1OTQ3OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r536059479", "bodyText": "Typo in module ID: con.", "author": "laidan6000", "createdAt": "2020-12-04T12:19:19Z", "path": "documentation/modules/upgrading/con-downgrade-target-version.adoc", "diffHunk": "@@ -4,15 +4,40 @@\n \n [id='com-target-downgrade-version-{context}']", "originalCommit": "d312c15e5a911bb24d2d5bd501ce0e7f0b56069a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2MjY3Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r536062673", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If you downgrade to a version of Kafka that uses an earlier `inter.broker.protocol.version`, the cluster will not work as it will not understand the messages.\n          \n          \n            \n            If you downgrade to a version of Kafka that uses an earlier `inter.broker.protocol.version`, the cluster will not work because it will not understand the messages.", "author": "laidan6000", "createdAt": "2020-12-04T12:25:01Z", "path": "documentation/modules/upgrading/con-downgrade-target-version.adoc", "diffHunk": "@@ -4,15 +4,40 @@\n \n [id='com-target-downgrade-version-{context}']\n \n-= Target downgrade version\n+= Kafka version compatibility for downgrades\n \n-How the Cluster Operator handles a downgrade operation depends on the `log.message.format.version`.\n+Kafka downgrades are dependent on compatible current and target xref:ref-kafka-versions-{context}[Kafka versions],\n+and the state at which messages have been logged.\n \n-* If the target downgrade version of Kafka has the same `log.message.format.version` as the current version, the Cluster Operator downgrades by performing a single rolling restart of the brokers.\n-* If the target downgrade version of Kafka has a different `log.message.format.version`, downgrading is only possible if the running cluster has _always_ had `log.message.format.version` set to the version used by the downgraded version.\n-+\n+You cannot revert to the previous Kafka version if the `inter.broker.protocol.version` differs, or messages have been added\n+to message logs that use a newer `log.message.format.version`.\n+\n+The `inter.broker.protocol.version` determines the schemas used for persistent metadata stored by the broker, such as the schema for messages written to `__consumer_offsets`.\n+If you downgrade to a version of Kafka that uses an earlier `inter.broker.protocol.version`, the cluster will not work as it will not understand the messages.", "originalCommit": "d312c15e5a911bb24d2d5bd501ce0e7f0b56069a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7b33df6773492c654f46c825ffc18f00ee22d189", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7b33df6773492c654f46c825ffc18f00ee22d189", "message": "review edits DL\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-12-07T13:51:42Z", "type": "commit"}, {"oid": "7ea3fdcfecd766c051fcddbcd5218ebe9f6a213e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7ea3fdcfecd766c051fcddbcd5218ebe9f6a213e", "message": "typo fix\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-12-07T16:27:30Z", "type": "commit"}, {"oid": "dfb1b7c989f76d96619d0bed5bf09ba862216c0f", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/dfb1b7c989f76d96619d0bed5bf09ba862216c0f", "message": "review edits - reintroducing downgrade of kafka\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-12-09T12:00:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5NzMwNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r540897307", "bodyText": "@tombentley - we do the check on the Kafka pod for the CO upgrade?", "author": "PaulRMellor", "createdAt": "2020-12-11T11:58:48Z", "path": "documentation/modules/upgrading/proc-upgrade-cluster-operator.adoc", "diffHunk": "@@ -42,14 +44,12 @@ Wait for the rolling updates to complete.\n kubectl get po my-cluster-kafka-0 -o jsonpath='{.spec.containers[0].image}'", "originalCommit": "dfb1b7c989f76d96619d0bed5bf09ba862216c0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA2NTgzOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r541065838", "bodyText": "wdym?", "author": "tombentley", "createdAt": "2020-12-11T16:22:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5NzMwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI3MzU0MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r542273541", "bodyText": "It was something that @michalxo mentioned when reviewing the procedure. He wondered why we don't do the verification on the CO pod.\nkubectl get pod <cluster-operator-pod-name> -o jsonpath='{.spec.containers[0].image}'\n        quay.io/strimzi/operator:latest%", "author": "PaulRMellor", "createdAt": "2020-12-14T10:26:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5NzMwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkxNzE2Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r544917163", "bodyText": "Still not understanding this. get po and get pod are the same thing. Or are you referring to the quay.io/strimzi/operator:latest% bit?", "author": "tombentley", "createdAt": "2020-12-17T08:57:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5NzMwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTAyODIwMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r545028202", "bodyText": "Looking at my comment in Jira, I think the latter is what I meant to suggest for a change ->\n\n$ kubectl get pod <cluster-operator-pod-name> -o jsonpath='{.spec.containers[0].image}'\n        quay.io/strimzi/operator:latest%", "author": "michalxo", "createdAt": "2020-12-17T11:46:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5NzMwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIwMjQ2OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r545202469", "bodyText": "IMHO the upgrade of the operator is successful after all operand pods roll to the new images. So checking the image in the Kafka pods makes more sense than checking it in the Cluster Operator pod.", "author": "scholzj", "createdAt": "2020-12-17T15:58:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5NzMwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIxOTcyOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r545219729", "bodyText": "Ah, finally I understand what's being asked here! (Sorry if I was being dense). Yes, checking on the operand pods makes more sense.", "author": "tombentley", "createdAt": "2020-12-17T16:21:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5NzMwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI4MzIxNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r545283217", "bodyText": "@PaulRMellor If you do any edits to this, I think using the full name - kubectl get pod makes more sense in documentation.", "author": "scholzj", "createdAt": "2020-12-17T17:49:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5NzMwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg0MTU4NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r546841584", "bodyText": "@tombentley @scholzj @michalxo  -- Sorry for the confusion and thanks for the comments. I've left the commands as is, but changed to pod rather than po", "author": "PaulRMellor", "createdAt": "2020-12-21T17:43:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5NzMwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0NDk4MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r541044981", "bodyText": "@scholzj api version check on the upgrade and downgrade procedures. We have v1alpha1 in our examples", "author": "PaulRMellor", "createdAt": "2020-12-11T15:51:51Z", "path": "documentation/modules/upgrading/con-downgrade-target-version.adoc", "diffHunk": "@@ -2,17 +2,42 @@\n //\n // assembly-downgrading-kafka-versions.adoc\n \n-[id='com-target-downgrade-version-{context}']\n+[id='con-target-downgrade-version-{context}']\n \n-= Target downgrade version\n+= Kafka version compatibility for downgrades\n \n-How the Cluster Operator handles a downgrade operation depends on the `log.message.format.version`.\n+Kafka downgrades are dependent on compatible current and target xref:ref-kafka-versions-{context}[Kafka versions],\n+and the state at which messages have been logged.\n \n-* If the target downgrade version of Kafka has the same `log.message.format.version` as the current version, the Cluster Operator downgrades by performing a single rolling restart of the brokers.\n-* If the target downgrade version of Kafka has a different `log.message.format.version`, downgrading is only possible if the running cluster has _always_ had `log.message.format.version` set to the version used by the downgraded version.\n-+\n+You cannot revert to the previous Kafka version if the `inter.broker.protocol.version` differs, or messages have been added\n+to message logs that use a newer `log.message.format.version`.\n+\n+The `inter.broker.protocol.version` determines the schemas used for persistent metadata stored by the broker, such as the schema for messages written to `__consumer_offsets`.\n+If you downgrade to a version of Kafka that uses an earlier `inter.broker.protocol.version`, the cluster will not work because it will not understand the messages.\n+\n+If the target downgrade version of Kafka has:\n+\n+* The _same_ `log.message.format.version` as the current version, the Cluster Operator downgrades by performing a single rolling restart of the brokers.\n+* A _different_ `log.message.format.version`, downgrading is only possible if the running cluster has _always_ had `log.message.format.version` set to the version used by the downgraded version.\n This is typically only the case if the upgrade procedure was aborted before the `log.message.format.version` was changed.\n In this case, the downgrade requires:\n-+\n+\n ** Two rolling restarts of the brokers if the interbroker protocol of the two versions is different\n ** A single rolling restart if they are the same\n+\n+Downgrading is _not possible_ if the new version has ever used a `log.message.format.version` that is not supported by the previous version, including when the default value for `log.message.format.version` is used. For example, this resource can be downgraded to Kafka version {KafkaVersionLower} because the `log.message.format.version` has not been changed:\n+\n+[source,yaml,subs=attributes+]\n+----\n+apiVersion: v1alpha1", "originalCommit": "dfb1b7c989f76d96619d0bed5bf09ba862216c0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQyMDMyMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r541420322", "bodyText": "Aren't we normally using some variable? It should definitely be v1beta1.", "author": "scholzj", "createdAt": "2020-12-11T23:42:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0NDk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUyMjMyNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r543522325", "bodyText": "I've replaced with the {KafkaApiVersion} variable.", "author": "PaulRMellor", "createdAt": "2020-12-15T17:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0NDk4MQ=="}], "type": "inlineReview"}, {"oid": "0672d30067060e134de191823bdcb40d886e4107", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/0672d30067060e134de191823bdcb40d886e4107", "message": "review edits MT\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-12-11T16:12:21Z", "type": "commit"}, {"oid": "de6657af322fec9b639853295abcab2ba2264e85", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/de6657af322fec9b639853295abcab2ba2264e85", "message": "review edits - api version update\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-12-15T17:03:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkxMzM0NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r544913345", "bodyText": "An \"earlier IBP\" isn't quite the right language. Each version of Kafka supports a range of IBPs, so \"earlier\" is a little ambiguous (it could be taken to mean earlier in the range of IBPs supported by a particular version).\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If you downgrade to a version of Kafka that uses an earlier `inter.broker.protocol.version`, the cluster will not work because it will not understand the messages.\n          \n          \n            \n            If you downgrade to a version of Kafka that doesn't understand an `inter.broker.protocol.version` that has (ever) been previously used in the cluster the broker will encounter data they cannot understand.", "author": "tombentley", "createdAt": "2020-12-17T08:51:22Z", "path": "documentation/modules/upgrading/con-downgrade-target-version.adoc", "diffHunk": "@@ -2,17 +2,42 @@\n //\n // assembly-downgrading-kafka-versions.adoc\n \n-[id='com-target-downgrade-version-{context}']\n+[id='con-target-downgrade-version-{context}']\n \n-= Target downgrade version\n+= Kafka version compatibility for downgrades\n \n-How the Cluster Operator handles a downgrade operation depends on the `log.message.format.version`.\n+Kafka downgrades are dependent on compatible current and target xref:ref-kafka-versions-{context}[Kafka versions],\n+and the state at which messages have been logged.\n \n-* If the target downgrade version of Kafka has the same `log.message.format.version` as the current version, the Cluster Operator downgrades by performing a single rolling restart of the brokers.\n-* If the target downgrade version of Kafka has a different `log.message.format.version`, downgrading is only possible if the running cluster has _always_ had `log.message.format.version` set to the version used by the downgraded version.\n-+\n+You cannot revert to the previous Kafka version if the `inter.broker.protocol.version` differs, or messages have been added\n+to message logs that use a newer `log.message.format.version`.\n+\n+The `inter.broker.protocol.version` determines the schemas used for persistent metadata stored by the broker, such as the schema for messages written to `__consumer_offsets`.\n+If you downgrade to a version of Kafka that uses an earlier `inter.broker.protocol.version`, the cluster will not work because it will not understand the messages.", "originalCommit": "de6657af322fec9b639853295abcab2ba2264e85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkxNDQxMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r544914412", "bodyText": "This sentence on its own (I know is clarified in a couple of sentences time) might make the reader think they can just change the IBP first.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            You cannot revert to the previous Kafka version if the `inter.broker.protocol.version` differs, or messages have been added\n          \n          \n            \n            You cannot revert to the previous Kafka version if that version don't support any of the `inter.broker.protocol.version` settings which have ever been used in that cluster, or messages have been added", "author": "tombentley", "createdAt": "2020-12-17T08:53:08Z", "path": "documentation/modules/upgrading/con-downgrade-target-version.adoc", "diffHunk": "@@ -2,17 +2,42 @@\n //\n // assembly-downgrading-kafka-versions.adoc\n \n-[id='com-target-downgrade-version-{context}']\n+[id='con-target-downgrade-version-{context}']\n \n-= Target downgrade version\n+= Kafka version compatibility for downgrades\n \n-How the Cluster Operator handles a downgrade operation depends on the `log.message.format.version`.\n+Kafka downgrades are dependent on compatible current and target xref:ref-kafka-versions-{context}[Kafka versions],\n+and the state at which messages have been logged.\n \n-* If the target downgrade version of Kafka has the same `log.message.format.version` as the current version, the Cluster Operator downgrades by performing a single rolling restart of the brokers.\n-* If the target downgrade version of Kafka has a different `log.message.format.version`, downgrading is only possible if the running cluster has _always_ had `log.message.format.version` set to the version used by the downgraded version.\n-+\n+You cannot revert to the previous Kafka version if the `inter.broker.protocol.version` differs, or messages have been added", "originalCommit": "de6657af322fec9b639853295abcab2ba2264e85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b47a1467c5c70ce86975285d2aa6ce9c7e42b83c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b47a1467c5c70ce86975285d2aa6ce9c7e42b83c", "message": "review edits TB\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-12-21T17:47:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE5NDQwMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3981#discussion_r547194400", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            You cannot revert to the previous Kafka version if that version don't support any of the `inter.broker.protocol.version` settings which have ever been used in that cluster,\n          \n          \n            \n            You cannot revert to the previous Kafka version if that version don't support any of the `inter.broker.protocol.version` settings which have _ever been used_ in that cluster,", "author": "tombentley", "createdAt": "2020-12-22T10:24:19Z", "path": "documentation/modules/upgrading/con-downgrade-target-version.adoc", "diffHunk": "@@ -2,17 +2,42 @@\n //\n // assembly-downgrading-kafka-versions.adoc\n \n-[id='com-target-downgrade-version-{context}']\n+[id='con-target-downgrade-version-{context}']\n \n-= Target downgrade version\n+= Kafka version compatibility for downgrades\n \n-How the Cluster Operator handles a downgrade operation depends on the `log.message.format.version`.\n+Kafka downgrades are dependent on compatible current and target xref:ref-kafka-versions-{context}[Kafka versions],\n+and the state at which messages have been logged.\n \n-* If the target downgrade version of Kafka has the same `log.message.format.version` as the current version, the Cluster Operator downgrades by performing a single rolling restart of the brokers.\n-* If the target downgrade version of Kafka has a different `log.message.format.version`, downgrading is only possible if the running cluster has _always_ had `log.message.format.version` set to the version used by the downgraded version.\n-+\n+You cannot revert to the previous Kafka version if that version don't support any of the `inter.broker.protocol.version` settings which have ever been used in that cluster,", "originalCommit": "b47a1467c5c70ce86975285d2aa6ce9c7e42b83c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5bc77af9711dddd7731edfd9be91ac8ff80297ea", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5bc77af9711dddd7731edfd9be91ac8ff80297ea", "message": "review edits TB\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2021-01-05T10:04:07Z", "type": "commit"}, {"oid": "ef540e55068758298023098bf16a461f6a73dace", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ef540e55068758298023098bf16a461f6a73dace", "message": "build fix -- contraction\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2021-01-05T10:51:17Z", "type": "commit"}]}