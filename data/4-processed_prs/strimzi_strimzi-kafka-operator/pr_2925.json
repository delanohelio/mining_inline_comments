{"pr_number": 2925, "pr_title": "Fix mm2 status ordering", "pr_createdAt": "2020-04-30T09:36:53Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2925", "timeline": [{"oid": "92d031c8fd1312520a3865e035bdda680fbd6c23", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/92d031c8fd1312520a3865e035bdda680fbd6c23", "message": "Fix mm2 status ordering\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-04-30T09:33:51Z", "type": "commit"}, {"oid": "d0abbfab7888d94c7eb42514064bda4608be12cf", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d0abbfab7888d94c7eb42514064bda4608be12cf", "message": "spotbugs\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-04-30T10:30:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ5ODk1MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2925#discussion_r418498951", "bodyText": "I've been enjoying the Optional class recently - these lines could be updated to:\nString name1 = Optional.ofNullable(props1.get(\"name\")).map(Object::toString).orElse(\"\");\nString name2 = Optional.ofNullable(props2.get(\"name\")).map(Object::toString).orElse(\"\");", "author": "ajborley", "createdAt": "2020-05-01T10:54:47Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaMirrorMaker2AssemblyOperator.java", "diffHunk": "@@ -371,11 +373,23 @@ private static String addTLSConfigToMirrorMaker2ConnectorConfig(Map<String, Obje\n         return securityProtocol;\n     }\n \n+    static class ConnectorsComparator implements Comparator<Map<String, Object>>, Serializable {\n+        private static final long serialVersionUID = 1L;\n+\n+        @Override\n+        public int compare(Map<String, Object> m1, Map<String, Object> m2) {\n+            String name1 = m1.get(\"name\") == null ? \"\" : m1.get(\"name\").toString();\n+            String name2 = m2.get(\"name\") == null ? \"\" : m2.get(\"name\").toString();", "originalCommit": "d0abbfab7888d94c7eb42514064bda4608be12cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU5NjYzMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2925#discussion_r418596633", "bodyText": "I agree with Andrew here, the use of the Optional makes the intent of the line slightly clearer. Though by convention Strimzi as a project does tend to use null checks over optionals...\nPerhaps one of the other maintainers has an opinion on this, @ppatierno ?", "author": "samuel-hawker", "createdAt": "2020-05-01T15:38:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ5ODk1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk3MTkxNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2925#discussion_r418971914", "bodyText": "TBH, I'm probably more old school. The original code from @stanlyDoge is much easier to read for me. But I do not have a problem if he changes it according to your suggestion.", "author": "scholzj", "createdAt": "2020-05-02T15:31:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ5ODk1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE0Nzk0Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2925#discussion_r419147943", "bodyText": "I am old school as @scholzj and I agree with him that the actual code is more readable and understandable.", "author": "ppatierno", "createdAt": "2020-05-03T19:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ5ODk1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyMTg5OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2925#discussion_r418521899", "bodyText": "It does seems strange to me that the processing of the current and desired statuses is not the same before the comparison.", "author": "AndrewJSchofield", "createdAt": "2020-05-01T12:30:45Z", "path": "operator-common/src/main/java/io/strimzi/operator/cluster/model/StatusDiff.java", "diffHunk": "@@ -24,7 +25,7 @@\n     private final boolean isEmpty;\n \n     public StatusDiff(Status current, Status desired) {\n-        JsonNode source = patchMapper().valueToTree(current == null ? \"{}\" : current);\n+        JsonNode source = patchMapper().configure(SerializationFeature.ORDER_MAP_ENTRIES_BY_KEYS, true).valueToTree(current == null ? \"{}\" : current);\n         JsonNode target = patchMapper().valueToTree(desired == null ? \"{}\" : desired);", "originalCommit": "d0abbfab7888d94c7eb42514064bda4608be12cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU5NzQxMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2925#discussion_r418597413", "bodyText": "I'm in agreement here, @stanlyDoge is there a reason line 29 is not as below?\nJsonNode target = patchMapper().configure(SerializationFeature.ORDER_MAP_ENTRIES_BY_KEYS, true).valueToTree(desired == null ? \"{}\" : desired);\n\nIt would make sense to me that we should be sorting both the source and the target for comparison?", "author": "samuel-hawker", "createdAt": "2020-05-01T15:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyMTg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU5ODMyOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2925#discussion_r418598329", "bodyText": "* @return true when the diffed statuses match\nMight be a slight improvement", "author": "samuel-hawker", "createdAt": "2020-05-01T15:41:41Z", "path": "operator-common/src/main/java/io/strimzi/operator/cluster/model/StatusDiff.java", "diffHunk": "@@ -53,7 +54,7 @@ public StatusDiff(Status current, Status desired) {\n     /**\n      * Returns whether the Diff is empty or not\n      *\n-     * @return true when the storage configurations are the same\n+     * @return true when the statuses are the same", "originalCommit": "d0abbfab7888d94c7eb42514064bda4608be12cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk3MDcyMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2925#discussion_r418970721", "bodyText": "Is this something we should also use in other places where we use the JsonDiff?", "author": "scholzj", "createdAt": "2020-05-02T15:21:13Z", "path": "operator-common/src/main/java/io/strimzi/operator/cluster/model/StatusDiff.java", "diffHunk": "@@ -24,7 +25,7 @@\n     private final boolean isEmpty;\n \n     public StatusDiff(Status current, Status desired) {\n-        JsonNode source = patchMapper().valueToTree(current == null ? \"{}\" : current);\n+        JsonNode source = patchMapper().configure(SerializationFeature.ORDER_MAP_ENTRIES_BY_KEYS, true).valueToTree(current == null ? \"{}\" : current);", "originalCommit": "d0abbfab7888d94c7eb42514064bda4608be12cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTIyMTk4MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2925#discussion_r419221981", "bodyText": "I do not think that is necessary. Of course, the diff is better human-readable, if it contains multiple keys.", "author": "sknot-rh", "createdAt": "2020-05-04T05:44:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk3MDcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkzNTE3Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2925#discussion_r419935177", "bodyText": "I guess I don't fully understand why this line is necessary. I can see how changes to the ordering of the array mirrorMaker2Status.getConnectors() would affect the jsondiff (and hence why the comparator is the solution to that), but IIUC the jsondiff shouldn't care about the order of maps (see RFC6902).", "author": "tombentley", "createdAt": "2020-05-05T08:11:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk3MDcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA5NjE2OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2925#discussion_r420096168", "bodyText": "It does not have any functional impact. It just makes debug log more readable for a human being.", "author": "sknot-rh", "createdAt": "2020-05-05T13:11:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk3MDcyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE0Nzc4OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2925#discussion_r420147789", "bodyText": "Please can we add a comment to say that.", "author": "tombentley", "createdAt": "2020-05-05T14:21:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk3MDcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk3MTEwNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2925#discussion_r418971105", "bodyText": "I wonder if the name properly describes what it does. All it compares is the names of the connectors. Not the connectors them self - for example their settings etc. If nothing else, this should have some javadoc describing what it does in more detail.\nMaybe we could also move the class to the end of the file? I find it a bit weird to have it in the middle.", "author": "scholzj", "createdAt": "2020-05-02T15:24:23Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaMirrorMaker2AssemblyOperator.java", "diffHunk": "@@ -371,11 +373,23 @@ private static String addTLSConfigToMirrorMaker2ConnectorConfig(Map<String, Obje\n         return securityProtocol;\n     }\n \n+    static class ConnectorsComparator implements Comparator<Map<String, Object>>, Serializable {", "originalCommit": "d0abbfab7888d94c7eb42514064bda4608be12cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "72da45e0ac1863a362cb4f78ff1af67a59519ab0", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/72da45e0ac1863a362cb4f78ff1af67a59519ab0", "message": "review comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-04T05:56:39Z", "type": "commit"}, {"oid": "16d086e069beebdad170c7e732068d7c428b7d26", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/16d086e069beebdad170c7e732068d7c428b7d26", "message": "comment\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-05T14:31:38Z", "type": "commit"}]}