{"pr_number": 3700, "pr_title": "[systemtest][upgrade] Make testUpgradeKafkaWithoutVersion use examples from last released version", "pr_createdAt": "2020-09-23T15:15:34Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3700", "timeline": [{"oid": "b881de8b7c82a489af782e7879b3662f5a1cc21e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b881de8b7c82a489af782e7879b3662f5a1cc21e", "message": "change testUpgradeKafkaWithoutVersion to use example kafka from last released version\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-09-23T15:08:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA2ODM2OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3700#discussion_r494068368", "bodyText": "Should we also add CLUSTER_NAME as a parameter and change it in the kafkaPersistent? It is \"hardcoded\" in the yaml to be my-cluster but in the ST it might be changed eventually.", "author": "sknot-rh", "createdAt": "2020-09-24T06:31:11Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/upgrade/StrimziUpgradeST.java", "diffHunk": "@@ -176,18 +182,16 @@ void testChainUpgrade() throws Exception {\n     void testUpgradeKafkaWithoutVersion() throws IOException {\n         File dir = FileUtils.downloadAndUnzip(latestReleasedOperator);\n \n-        coDir = new File(dir, \"strimzi-0.19.0/install/cluster-operator/\");\n+        File kafkaPersistent = new File(dir, \"strimzi-\" + latestReleasedVersion + \"/examples/kafka/kafka-persistent.yaml\");\n+        coDir = new File(dir, \"strimzi-\" + latestReleasedVersion + \"/install/cluster-operator/\");\n \n         // Modify + apply installation files\n         copyModifyApply(coDir);\n+        // Apply Kafka Persistent without version\n+        applyKafkaWithoutVersion(kafkaPersistent);", "originalCommit": "b881de8b7c82a489af782e7879b3662f5a1cc21e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA3OTQ4NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3700#discussion_r494079485", "bodyText": "I think that's a good idea! Thanks!", "author": "im-konge", "createdAt": "2020-09-24T06:56:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA2ODM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA2OTAxMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3700#discussion_r494069012", "bodyText": "ObjectNode metadataNode = (ObjectNode) node.at(\"/metadata\");\nmetadataNode.replace(\"name\", clusterName);\n\nor similar", "author": "sknot-rh", "createdAt": "2020-09-24T06:32:50Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/upgrade/StrimziUpgradeST.java", "diffHunk": "@@ -208,6 +212,15 @@ void testUpgradeKafkaWithoutVersion() throws IOException {\n                 .stream().filter(c -> c.getName().equals(\"kafka\")).findFirst().get().getImage(), containsString(\"2.6.0\"));\n     }\n \n+    void applyKafkaWithoutVersion(File kafka) throws IOException {\n+        YAMLMapper mapper = new YAMLMapper();\n+        JsonNode node = mapper.readTree(kafka);\n+        ObjectNode kafkaNode = (ObjectNode) node.at(\"/spec/kafka\");\n+        kafkaNode.remove(\"version\");\n+", "originalCommit": "b881de8b7c82a489af782e7879b3662f5a1cc21e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "69e5afecf510b4e7a86fd6de81dd0c5dd3fc94d5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/69e5afecf510b4e7a86fd6de81dd0c5dd3fc94d5", "message": "standa's comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-09-24T07:23:35Z", "type": "commit"}, {"oid": "b0d3f7f0df1476faa8f1ea693343a31c088c92ac", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b0d3f7f0df1476faa8f1ea693343a31c088c92ac", "message": "disable test\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-09-24T07:54:34Z", "type": "forcePushed"}, {"oid": "30bb376defef22eca35dfd1def72a77909e14cee", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/30bb376defef22eca35dfd1def72a77909e14cee", "message": "disable test\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-09-24T08:46:07Z", "type": "commit"}, {"oid": "30bb376defef22eca35dfd1def72a77909e14cee", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/30bb376defef22eca35dfd1def72a77909e14cee", "message": "disable test\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-09-24T08:46:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE0Nzk0OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3700#discussion_r494147949", "bodyText": "I guess you need to also change the message format version?", "author": "scholzj", "createdAt": "2020-09-24T08:51:25Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/upgrade/StrimziUpgradeST.java", "diffHunk": "@@ -208,6 +215,20 @@ void testUpgradeKafkaWithoutVersion() throws IOException {\n                 .stream().filter(c -> c.getName().equals(\"kafka\")).findFirst().get().getImage(), containsString(\"2.6.0\"));\n     }\n \n+    void applyKafkaWithoutVersion(File kafka, String clusterName) throws IOException {\n+        YAMLMapper mapper = new YAMLMapper();\n+        JsonNode node = mapper.readTree(kafka);\n+        ObjectNode kafkaNode = (ObjectNode) node.at(\"/spec/kafka\");\n+        kafkaNode.remove(\"version\");", "originalCommit": "30bb376defef22eca35dfd1def72a77909e14cee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE1NDIzNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3700#discussion_r494154235", "bodyText": "I was thinking that too, but in the example there is already the log.message.format.version so I decided to not add it there:\nconfig:\n        log.message.format.version: \"2.5\"\n        offsets.topic.replication.factor: 3\n        transaction.state.log.min.isr: 2\n        transaction.state.log.replication.factor: 3\n\n\nI guess I can add it there to be sure.", "author": "im-konge", "createdAt": "2020-09-24T09:01:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE0Nzk0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE0ODM1Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3700#discussion_r494148353", "bodyText": "Can this be some constant somewhere on the beginning? (the version I mean)", "author": "scholzj", "createdAt": "2020-09-24T08:52:02Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/upgrade/StrimziUpgradeST.java", "diffHunk": "@@ -208,6 +215,20 @@ void testUpgradeKafkaWithoutVersion() throws IOException {\n                 .stream().filter(c -> c.getName().equals(\"kafka\")).findFirst().get().getImage(), containsString(\"2.6.0\"));", "originalCommit": "30bb376defef22eca35dfd1def72a77909e14cee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE1NDQ1NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3700#discussion_r494154455", "bodyText": "Sure", "author": "im-konge", "createdAt": "2020-09-24T09:01:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE0ODM1Mw=="}], "type": "inlineReview"}, {"oid": "c9f6c7affbea7b914670d377ad166fa97b3844ff", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c9f6c7affbea7b914670d377ad166fa97b3844ff", "message": "scholzj comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-09-24T09:46:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE4OTg3Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3700#discussion_r494189876", "bodyText": "Wouldnt be better to use this from kafka-versions.yaml?", "author": "Frawless", "createdAt": "2020-09-24T09:59:16Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/upgrade/StrimziUpgradeST.java", "diffHunk": "@@ -183,6 +183,7 @@ void testChainUpgrade() throws Exception {\n     @Test\n     @Disabled(\"Disabled because of bug https://github.com/strimzi/strimzi-kafka-operator/issues/3685\")\n     void testUpgradeKafkaWithoutVersion() throws IOException {\n+        String latestKafkaVersion = \"2.6.0\";", "originalCommit": "c9f6c7affbea7b914670d377ad166fa97b3844ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE4OTk3NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3700#discussion_r494189974", "bodyText": "Same as above", "author": "Frawless", "createdAt": "2020-09-24T09:59:27Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/upgrade/StrimziUpgradeST.java", "diffHunk": "@@ -221,6 +222,9 @@ void applyKafkaWithoutVersion(File kafka, String clusterName) throws IOException\n         ObjectNode kafkaNode = (ObjectNode) node.at(\"/spec/kafka\");\n         kafkaNode.remove(\"version\");\n \n+        ObjectNode kafkaConfigNode = (ObjectNode) kafkaNode.at(\"/config\");\n+        kafkaConfigNode.put(\"log.message.format.version\", \"2.5\");", "originalCommit": "c9f6c7affbea7b914670d377ad166fa97b3844ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5808dd662701120d668b47b6b14812aaaaab4283", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5808dd662701120d668b47b6b14812aaaaab4283", "message": "fixup! scholzj comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-09-24T12:04:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk4ODgxMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3700#discussion_r494988811", "bodyText": "Why does this needs to be a class parameter? Why not pass it directly into the single method using it?", "author": "scholzj", "createdAt": "2020-09-25T13:31:00Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/upgrade/StrimziUpgradeST.java", "diffHunk": "@@ -172,22 +180,24 @@ void testChainUpgrade() throws Exception {\n         }\n     }\n \n+    // TODO: remove disabled tag after fix of issue #3685\n     @Test\n+    @Disabled(\"Disabled because of bug https://github.com/strimzi/strimzi-kafka-operator/issues/3685\")\n     void testUpgradeKafkaWithoutVersion() throws IOException {\n         File dir = FileUtils.downloadAndUnzip(latestReleasedOperator);\n+        File kafkaPersistent = new File(dir, \"strimzi-\" + latestReleasedVersion + \"/examples/kafka/kafka-persistent.yaml\");\n+        coDir = new File(dir, \"strimzi-\" + latestReleasedVersion + \"/install/cluster-operator/\");\n+        kafkaVersions = FileUtils.downloadYaml(\"https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/\" + latestReleasedVersion + \"/kafka-versions.yaml\");", "originalCommit": "5808dd662701120d668b47b6b14812aaaaab4283", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk5MjIwMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3700#discussion_r494992202", "bodyText": "Why not read the file into the Kafka class which you can configure directly? It would be easier than going through the JSON tree, or?", "author": "scholzj", "createdAt": "2020-09-25T13:36:24Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/upgrade/StrimziUpgradeST.java", "diffHunk": "@@ -205,7 +215,32 @@ void testUpgradeKafkaWithoutVersion() throws IOException {\n         DeploymentUtils.waitTillDepHasRolled(KafkaResources.entityOperatorDeploymentName(CLUSTER_NAME), 1, eoSnapshot);\n \n         assertThat(kubeClient().getStatefulSet(KafkaResources.kafkaStatefulSetName(CLUSTER_NAME)).getSpec().getTemplate().getSpec().getContainers()\n-                .stream().filter(c -> c.getName().equals(\"kafka\")).findFirst().get().getImage(), containsString(\"2.6.0\"));\n+                .stream().filter(c -> c.getName().equals(\"kafka\")).findFirst().get().getImage(), containsString(latestKafkaVersion));\n+    }\n+\n+    String getValueForLastKafkaVersionInFile(String field) throws IOException {\n+        YAMLMapper mapper = new YAMLMapper();\n+        JsonNode node = mapper.readTree(kafkaVersions);\n+        ObjectNode kafkaVersionNode = (ObjectNode) node.get(node.size() - 1);\n+\n+        return kafkaVersionNode.get(field).asText();\n+    }\n+\n+    void applyKafkaWithoutVersion(File kafka, String clusterName) throws IOException {", "originalCommit": "5808dd662701120d668b47b6b14812aaaaab4283", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk5NDA1MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3700#discussion_r494994051", "bodyText": "Out of curiosity, what is the philosophy of this test with regards to versions? Does it always run operator upgrade against previous release without the version field? Or does it run Kafka upgrade from older Kafka version without upgrade?\nFor 0.19.0 it does both. But for example 0.18.0 -> 0.19.0 IIRC does not change Kafkas so it would test only operator upgrade. I think this should be clarified in the comments to know how and when should the version number be bumped. (in general, both tests might have their value)", "author": "scholzj", "createdAt": "2020-09-25T13:39:24Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/upgrade/StrimziUpgradeST.java", "diffHunk": "@@ -91,8 +99,8 @@\n     // ExpectedTopicCount contains additionally consumer-offset topic, my-topic and continuous-topic\n     private final int expectedTopicCount = upgradeTopicCount + 3;\n \n-    private final String latestReleasedOperator = \"https://github.com/strimzi/strimzi-kafka-operator/releases/download/0.19.0/strimzi-0.19.0.zip\";\n-\n+    private final String latestReleasedVersion = \"0.19.0\";", "originalCommit": "5808dd662701120d668b47b6b14812aaaaab4283", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU5NjYyNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3700#discussion_r496596627", "bodyText": "AFAIK this should test ability of upgrade the CO and then Kafka when the Kafka version is set to null. The CO should roll the pods after upgrade and then the version of Kafka should be set.\nTBH I was thinking about adding test for upgrading Kafka by version (so upgrade from 2.4.0 to 2.5.0, then upgrade the CO to master and upgrade to Kafka to the 2.6.0). If it's good idea and it will make some sense, then I can add it.\nThat's MPOV.", "author": "im-konge", "createdAt": "2020-09-29T10:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk5NDA1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY3OTAyOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3700#discussion_r496679028", "bodyText": "IIRC we wanted there upgrade CO from version X, kafka Y, to CO version Z and kafka Y + 1 at the end", "author": "Frawless", "createdAt": "2020-09-29T12:34:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk5NDA1MQ=="}], "type": "inlineReview"}, {"oid": "a9dbbc57578819455b3724ec8a12879658742a32", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a9dbbc57578819455b3724ec8a12879658742a32", "message": "fixup! fixup! scholzj comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-09-29T10:08:32Z", "type": "commit"}, {"oid": "9b8d14894c6ed49798676705459126735422c0e6", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9b8d14894c6ed49798676705459126735422c0e6", "message": "add comment and TODO\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-09-30T06:25:58Z", "type": "commit"}]}