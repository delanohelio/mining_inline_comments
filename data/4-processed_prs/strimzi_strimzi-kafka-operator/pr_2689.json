{"pr_number": 2689, "pr_title": "Patch double setting of Xmx and Xms options", "pr_createdAt": "2020-03-12T08:27:03Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2689", "timeline": [{"oid": "a00c86c8e710d4427866b7b2e78989ecabbd90d1", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a00c86c8e710d4427866b7b2e78989ecabbd90d1", "message": "Patch double setting of Xmx and Xms options\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-03-12T08:25:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ3MDIwNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2689#discussion_r391470207", "bodyText": "So what if they set -Xms to a higher value that MAX_HEAP? Or, similarly, what if they've set -Xmx and it's lower than the MAX_HEAP used for -Xms?", "author": "tombentley", "createdAt": "2020-03-12T08:42:09Z", "path": "docker-images/operator/scripts/launch_java.sh", "diffHunk": "@@ -20,9 +20,18 @@ function get_gc_opts {\n   fi\n }\n \n-MAX_HEAP=`get_heap_size`\n-if [ -n \"$MAX_HEAP\" ]; then\n-  JAVA_OPTS=\"-Xms${MAX_HEAP}m -Xmx${MAX_HEAP}m $JAVA_OPTS\"\n+if [[ $JAVA_OPTS != *\"-Xms\"* || $JAVA_OPTS != *\"-Xmx\"* ]]; then\n+  MAX_HEAP=`get_heap_size`\n+  if [[ $JAVA_OPTS != *\"-Xms\"* ]]; then\n+      if [ -n \"$MAX_HEAP\" ]; then\n+        JAVA_OPTS=\"-Xms${MAX_HEAP}m $JAVA_OPTS\"\n+      fi\n+  fi\n+  if [[ $JAVA_OPTS != *\"-Xmx\"* ]]; then\n+      if [ -n \"$MAX_HEAP\" ]; then\n+        JAVA_OPTS=\"-Xmx${MAX_HEAP}m $JAVA_OPTS\"\n+      fi", "originalCommit": "a00c86c8e710d4427866b7b2e78989ecabbd90d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "91d0d481078ca039e7ad992634e6cb8731ee2be4", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/91d0d481078ca039e7ad992634e6cb8731ee2be4", "message": "check max heap\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-03-12T13:32:32Z", "type": "commit"}, {"oid": "148b6f6261e2f2153dc59fe5a95df8648f092d38", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/148b6f6261e2f2153dc59fe5a95df8648f092d38", "message": "checkstyle\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-03-12T14:08:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI3Njg5OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2689#discussion_r392276899", "bodyText": "Why are we using a env var called STRIMZI_JAVA_SYSTEM_PROPERTIES to pass things which are not system properties (as in -D options)?", "author": "tombentley", "createdAt": "2020-03-13T14:52:43Z", "path": "docker-images/operator/scripts/dynamic_resources.sh", "diffHunk": "@@ -15,3 +15,26 @@ function get_heap_size {\n     echo \"${CONTAINER_HEAP_MAX}\"\n   fi\n }\n+\n+function set_xmx_xms {\n+  MAX_HEAP=`get_heap_size`\n+  if [ -n \"$MAX_HEAP\" ]; then\n+      if [[ $STRIMZI_JAVA_SYSTEM_PROPERTIES == *\"-Xmx\"* ]]; then", "originalCommit": "148b6f6261e2f2153dc59fe5a95df8648f092d38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyMTk1MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2689#discussion_r392321950", "bodyText": "MAX_HEAP was supposed to be a heuristic for what to set Xmx to if it was not explicitly configured. Recent versions of java have their own heuristic for figuring out the heap size to use inside a container, based on the container memory limit. IIRC the get_heap_size dates from before that was in java 8, but there was another motivation of get_heap_size: In the Kafka container we don't really want the JVM ergonomics to be based on the container memory limit, because we want plenty of 'spare' memory to be used by the page cache. So we needed a way to be able to configure the memory in a container-aware way, but potentially with fine control over how much of the container memory to use. At the time the only way to do this was using -XX:MaxRAMFraction which suffered from the issue described in https://bugs.openjdk.java.net/browse/JDK-8186315. As you can see that was fixed in Java 10. So once we move to Java 11 we should be able to simplify this.\nSo today, with Java memory ergonomics being container aware, I think the Kafka part is the only thing we still need to worry about. I.e. we probably don't need to call get_heap_size at all for non-Kafka containers.\nNow, if you read get_heap_size it is expecting two arguments, which are not being passed here (though they are being passed in kafka_run.sh, where the DYNAMIC_HEAP_FRACTION is our workaround for the fact that Java 8 lacks the -XX:MaxRAMPercentage option mentioned in the linked issue).\nSo I think we should remove this MAX_HEAP stuff from launch_java.sh entirely. If we need to do any meddling with Xmx etc it should be done in the script which calls launch_java.sh.", "author": "tombentley", "createdAt": "2020-03-13T16:04:06Z", "path": "docker-images/operator/scripts/dynamic_resources.sh", "diffHunk": "@@ -15,3 +15,26 @@ function get_heap_size {\n     echo \"${CONTAINER_HEAP_MAX}\"\n   fi\n }\n+\n+function set_xmx_xms {\n+  MAX_HEAP=`get_heap_size`", "originalCommit": "148b6f6261e2f2153dc59fe5a95df8648f092d38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyMjI5MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2689#discussion_r392322290", "bodyText": "If Xmx is set we should use that. We would only use MAX_HEAP when Xmx is not set, but as discussed above, I don't think we need this function, and it certainly shouldn't be called from launch_java.sh.", "author": "tombentley", "createdAt": "2020-03-13T16:04:40Z", "path": "docker-images/operator/scripts/dynamic_resources.sh", "diffHunk": "@@ -15,3 +15,26 @@ function get_heap_size {\n     echo \"${CONTAINER_HEAP_MAX}\"\n   fi\n }\n+\n+function set_xmx_xms {\n+  MAX_HEAP=`get_heap_size`\n+  if [ -n \"$MAX_HEAP\" ]; then\n+      if [[ $STRIMZI_JAVA_SYSTEM_PROPERTIES == *\"-Xmx\"* ]]; then\n+          XMX_STRING=$(echo $STRIMZI_JAVA_SYSTEM_PROPERTIES | sed -n 's/.*\\(-Xmx[0-9]\\+.\\).*/\\1/p')\n+          XMX_MBYTES=$(($(echo $XMX_STRING | cut -c 5- | gawk -f ./bin/to_bytes.gawk)/1024**2))\n+          if [[ $XMX_MBYTES -lt $MAX_HEAP ]]; then\n+             # \"Xmx set less than MAX_HEAP, using MAX_HEAP\"\n+             JAVA_OPTS=$(echo $JAVA_OPTS | sed s/$XMX_STRING/-Xmx${MAX_HEAP}m/)\n+          fi", "originalCommit": "148b6f6261e2f2153dc59fe5a95df8648f092d38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU4NjI5MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2689#discussion_r392586291", "bodyText": "So... if I understand this correctly, we should just remove all this Xms & Xmx fiddling from operator images. Is that right?", "author": "sknot-rh", "createdAt": "2020-03-14T12:52:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyMjI5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyNDAwNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2689#discussion_r392324006", "bodyText": "Same comment.", "author": "tombentley", "createdAt": "2020-03-13T16:07:41Z", "path": "docker-images/operator/scripts/dynamic_resources.sh", "diffHunk": "@@ -15,3 +15,26 @@ function get_heap_size {\n     echo \"${CONTAINER_HEAP_MAX}\"\n   fi\n }\n+\n+function set_xmx_xms {\n+  MAX_HEAP=`get_heap_size`\n+  if [ -n \"$MAX_HEAP\" ]; then\n+      if [[ $STRIMZI_JAVA_SYSTEM_PROPERTIES == *\"-Xmx\"* ]]; then\n+          XMX_STRING=$(echo $STRIMZI_JAVA_SYSTEM_PROPERTIES | sed -n 's/.*\\(-Xmx[0-9]\\+.\\).*/\\1/p')\n+          XMX_MBYTES=$(($(echo $XMX_STRING | cut -c 5- | gawk -f ./bin/to_bytes.gawk)/1024**2))\n+          if [[ $XMX_MBYTES -lt $MAX_HEAP ]]; then\n+             # \"Xmx set less than MAX_HEAP, using MAX_HEAP\"\n+             JAVA_OPTS=$(echo $JAVA_OPTS | sed s/$XMX_STRING/-Xmx${MAX_HEAP}m/)\n+          fi\n+      fi\n+\n+      if [[ $STRIMZI_JAVA_SYSTEM_PROPERTIES == *\"-Xms\"* ]]; then\n+          XMS_STRING=$(echo $STRIMZI_JAVA_SYSTEM_PROPERTIES | sed -n 's/.*\\(-Xms[0-9]\\+.\\).*/\\1/p')\n+          XMS_MBYTES=$(($(echo $XMS_STRING | cut -c 5- | gawk -f ./bin/to_bytes.gawk)/1024**2))\n+          if [[ $XMS_MBYTES -gt $MAX_HEAP ]]; then\n+             # \"Xms set greater than MAX_HEAP, using MAX_HEAP\"\n+             JAVA_OPTS=$(echo $JAVA_OPTS | sed s/$XMS_STRING/-Xms${MAX_HEAP}m/)", "originalCommit": "148b6f6261e2f2153dc59fe5a95df8648f092d38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e9aafa06c3830c9368e0620dfa4e9d0bd1952472", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e9aafa06c3830c9368e0620dfa4e9d0bd1952472", "message": "confused commit\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-03-14T13:36:55Z", "type": "commit"}, {"oid": "e9aafa06c3830c9368e0620dfa4e9d0bd1952472", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e9aafa06c3830c9368e0620dfa4e9d0bd1952472", "message": "confused commit\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-03-14T13:36:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM2MzI1Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2689#discussion_r394363253", "bodyText": "You shouldn't delete this: It's still used for kafka.", "author": "tombentley", "createdAt": "2020-03-18T13:55:06Z", "path": "docker-images/operator/scripts/dynamic_resources.sh", "diffHunk": "@@ -1,17 +0,0 @@\n-#!/usr/bin/env bash\n-\n-function get_heap_size {\n-  CONTAINER_MEMORY_IN_BYTES=`cat /sys/fs/cgroup/memory/memory.limit_in_bytes`\n-   # use max of 31G memory, java performs much better with Compressed Ordinary Object Pointers\n-  DEFAULT_MEMORY_CEILING=$((31 * 2**20))\n-  if [ \"${CONTAINER_MEMORY_IN_BYTES}\" -lt \"${DEFAULT_MEMORY_CEILING}\" ]; then\n-    if [ -z $CONTAINER_HEAP_PERCENT ]; then\n-      CONTAINER_HEAP_PERCENT=0.50\n-    fi\n-\n-    CONTAINER_MEMORY_IN_MB=$((${CONTAINER_MEMORY_IN_BYTES}/1024**2))\n-    CONTAINER_HEAP_MAX=$(echo \"${CONTAINER_MEMORY_IN_MB} ${CONTAINER_HEAP_PERCENT}\" | awk '{ printf \"%d\", $1 * $2 }')\n-\n-    echo \"${CONTAINER_HEAP_MAX}\"\n-  fi\n-}", "originalCommit": "e9aafa06c3830c9368e0620dfa4e9d0bd1952472", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM3MjE4Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2689#discussion_r394372182", "bodyText": "Does not kafka have its own script at strimzi-kafka-operator/docker-images/kafka/scripts/dynamic_resources.sh?", "author": "sknot-rh", "createdAt": "2020-03-18T14:07:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM2MzI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM3ODkzNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2689#discussion_r394378935", "bodyText": "Right. Thanks!", "author": "tombentley", "createdAt": "2020-03-18T14:16:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM2MzI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM2MzQzOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2689#discussion_r394363438", "bodyText": "Do we still need to add this file?", "author": "tombentley", "createdAt": "2020-03-18T13:55:23Z", "path": "docker-images/operator/scripts/to_bytes.gawk", "diffHunk": "@@ -0,0 +1,11 @@\n+# Use gawk because gnu awk can't extract regexp groups; gawk has `match`\n+BEGIN {\n+  suffixes[\"\"]=1\n+  suffixes[\"K\"]=1024\n+  suffixes[\"M\"]=1024**2\n+  suffixes[\"G\"]=1024**3\n+}\n+\n+match($0, /([0-9.]*)([kKmMgG]?)/, a) {\n+  printf(\"%d\", a[1] * suffixes[toupper(a[2])])\n+}", "originalCommit": "e9aafa06c3830c9368e0620dfa4e9d0bd1952472", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6334d3ab672076f6ecb8d66f36854b1239e5904d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6334d3ab672076f6ecb8d66f36854b1239e5904d", "message": "remove unnecessary file\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-03-18T14:28:27Z", "type": "commit"}, {"oid": "d14e1846bbaddff4671a5fb920422cdd3c922992", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d14e1846bbaddff4671a5fb920422cdd3c922992", "message": "doc\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-03-27T16:13:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgxMzA4Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2689#discussion_r399813083", "bodyText": "I'm not sure this is understandable for everyone what to do. The env var is always a String ... so I think it should be just a String with the system properties as it would be passed to Java? As in -Dxxx=yyy -Duuu=vvv? Or is it somehting else?", "author": "scholzj", "createdAt": "2020-03-29T15:28:25Z", "path": "documentation/modules/proc-deploying-the-topic-operator-standalone.adoc", "diffHunk": "@@ -20,6 +20,8 @@ For instance, it can operate _with_ any Kafka cluster, not necessarily one deplo\n .. The `STRIMZI_KAFKA_BOOTSTRAP_SERVERS` environment variable in `Deployment.spec.template.spec.containers[0].env` should be set to a list of bootstrap brokers in your Kafka cluster, given as a comma-separated list of `_hostname_:\u200d_port_` pairs.\n .. The `STRIMZI_ZOOKEEPER_CONNECT` environment variable in `Deployment.spec.template.spec.containers[0].env` should be set to a list of the ZooKeeper nodes, given as a comma-separated list of `_hostname_:\u200d_port_` pairs. This should be the same ZooKeeper cluster that your Kafka cluster is using.\n .. The `STRIMZI_NAMESPACE` environment variable in `Deployment.spec.template.spec.containers[0].env` should be set to the Kubernetes namespace in which you want the operator to watch for  `KafkaTopic` resources.\n+.. The `STRIMZI_JAVA_OPTS` environment variable in `Deployment.spec.template.spec.containers[0].env` should be set to the Java options (for example,  `Xmx` and `Xms`) used for the JVM running Topic Operator.\n+.. The `STRIMZI_JAVA_SYSTEM_PROPERTIES` environment variable in `Deployment.spec.template.spec.containers[0].env` should be set to the list of `-D` options which are set to the Topic Operator.", "originalCommit": "d14e1846bbaddff4671a5fb920422cdd3c922992", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgxMzIxMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2689#discussion_r399813211", "bodyText": "Again, I'm not sure this is completely clear. Maybe you should add a complete example such as -Xmx=512M -Xms=256M?", "author": "scholzj", "createdAt": "2020-03-29T15:29:13Z", "path": "documentation/modules/proc-deploying-the-topic-operator-standalone.adoc", "diffHunk": "@@ -20,6 +20,8 @@ For instance, it can operate _with_ any Kafka cluster, not necessarily one deplo\n .. The `STRIMZI_KAFKA_BOOTSTRAP_SERVERS` environment variable in `Deployment.spec.template.spec.containers[0].env` should be set to a list of bootstrap brokers in your Kafka cluster, given as a comma-separated list of `_hostname_:\u200d_port_` pairs.\n .. The `STRIMZI_ZOOKEEPER_CONNECT` environment variable in `Deployment.spec.template.spec.containers[0].env` should be set to a list of the ZooKeeper nodes, given as a comma-separated list of `_hostname_:\u200d_port_` pairs. This should be the same ZooKeeper cluster that your Kafka cluster is using.\n .. The `STRIMZI_NAMESPACE` environment variable in `Deployment.spec.template.spec.containers[0].env` should be set to the Kubernetes namespace in which you want the operator to watch for  `KafkaTopic` resources.\n+.. The `STRIMZI_JAVA_OPTS` environment variable in `Deployment.spec.template.spec.containers[0].env` should be set to the Java options (for example,  `Xmx` and `Xms`) used for the JVM running Topic Operator.", "originalCommit": "d14e1846bbaddff4671a5fb920422cdd3c922992", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgxMzIzMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2689#discussion_r399813233", "bodyText": "Same as above?", "author": "scholzj", "createdAt": "2020-03-29T15:29:27Z", "path": "documentation/modules/proc-deploying-the-user-operator-standalone.adoc", "diffHunk": "@@ -22,6 +22,8 @@ The `Secret` should contain the public key of the Certificate Authority under th\n The `Secret` should contain the private key of the Certificate Authority under the key `ca.key`.\n .. The `STRIMZI_ZOOKEEPER_CONNECT` environment variable in `Deployment.spec.template.spec.containers[0].env` should be set to a list of the ZooKeeper nodes, given as a comma-separated list of `_hostname_:\u200d_port_` pairs. This should be the same ZooKeeper cluster that your Kafka cluster is using.\n .. The `STRIMZI_NAMESPACE` environment variable in `Deployment.spec.template.spec.containers[0].env` should be set to the Kubernetes namespace in which you want the operator to watch for  `KafkaUser` resources.\n+.. The `STRIMZI_JAVA_OPTS` environment variable in `Deployment.spec.template.spec.containers[0].env` should be set to the Java options (for example, `Xmx` and `Xms`) used for the JVM running User Operator.\n+.. The `STRIMZI_JAVA_SYSTEM_PROPERTIES` environment variable in `Deployment.spec.template.spec.containers[0].env` should be set to the list of `-D` options which are set to the User Operator.", "originalCommit": "d14e1846bbaddff4671a5fb920422cdd3c922992", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b0746ff303e8e6d56dc94a2b089ef19365ab7679", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b0746ff303e8e6d56dc94a2b089ef19365ab7679", "message": "comment\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-03-30T07:20:45Z", "type": "commit"}]}