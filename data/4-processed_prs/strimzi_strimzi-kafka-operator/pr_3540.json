{"pr_number": 3540, "pr_title": "KafkaRoller: Common Admin client, and always check canRoll", "pr_createdAt": "2020-08-24T12:10:11Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3540", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY0MTcxNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3540#discussion_r475641714", "bodyText": "Force-rolled suggests something went wrong. But in case of the controller this might be the first actual check of whether it can be restarted because before it was always deferred. So I think this message is right for other pods but not for the controller.", "author": "scholzj", "createdAt": "2020-08-24T14:11:31Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaRoller.java", "diffHunk": "@@ -346,8 +343,13 @@ private void restartIfNecessary(int podId, RestartContext restartContext)\n             }\n         } catch (ForceableProblem e) {\n             if (restartContext.backOff.done() || e.forceNow) {\n-                log.warn(\"{}: Pod {} will be force-rolled\", reconciliation, podName(podId));\n-                restartAndAwaitReadiness(pod, operationTimeoutMs, TimeUnit.MILLISECONDS);\n+                if (canRoll(allClient, podId, 60_000, TimeUnit.MILLISECONDS)) {\n+                    log.warn(\"{}: Pod {} will be force-rolled\", reconciliation, podName(podId));", "originalCommit": "37dbe54904c82db5798708779049c24eee04c0ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY1MDkxNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3540#discussion_r475650915", "bodyText": "This does not make sense to me. You should not respond to ForceableProblem thrown from canRoll by running canRoll again. Maybe canRoll should not throw ForceableProblem then?", "author": "scholzj", "createdAt": "2020-08-24T14:24:54Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaRoller.java", "diffHunk": "@@ -346,8 +343,13 @@ private void restartIfNecessary(int podId, RestartContext restartContext)\n             }\n         } catch (ForceableProblem e) {\n             if (restartContext.backOff.done() || e.forceNow) {\n-                log.warn(\"{}: Pod {} will be force-rolled\", reconciliation, podName(podId));\n-                restartAndAwaitReadiness(pod, operationTimeoutMs, TimeUnit.MILLISECONDS);\n+                if (canRoll(allClient, podId, 60_000, TimeUnit.MILLISECONDS)) {", "originalCommit": "37dbe54904c82db5798708779049c24eee04c0ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "084cd57cf8a08d4597dc9c32065eccefb4ce27de", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/084cd57cf8a08d4597dc9c32065eccefb4ce27de", "message": "Use a common Admin client in KafkaRoller for some calls\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-08-26T15:03:04Z", "type": "commit"}, {"oid": "24917785e1542476c26bfa9ca29c827fb47db707", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/24917785e1542476c26bfa9ca29c827fb47db707", "message": "fixup\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-08-26T15:03:07Z", "type": "commit"}, {"oid": "9272b15e6f09fe7b08e6653d9a513ac11678fe0e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9272b15e6f09fe7b08e6653d9a513ac11678fe0e", "message": "simplify\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-08-26T15:03:07Z", "type": "commit"}, {"oid": "e61f5d28a194c37d557ba64e60b6c8072af6a683", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e61f5d28a194c37d557ba64e60b6c8072af6a683", "message": "Fix failing test\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-08-26T15:03:07Z", "type": "commit"}, {"oid": "404e109c6b54d76c52a2edea59435b541f9a3060", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/404e109c6b54d76c52a2edea59435b541f9a3060", "message": "Add test\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-08-26T15:03:07Z", "type": "commit"}, {"oid": "309c1225c6a43d76a8a8f8698f5c6b6ea7447fba", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/309c1225c6a43d76a8a8f8698f5c6b6ea7447fba", "message": "spotbugs\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-08-26T15:03:07Z", "type": "commit"}, {"oid": "87f6a8dc89c5e8ffb18eff99f943ec8495ffca55", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/87f6a8dc89c5e8ffb18eff99f943ec8495ffca55", "message": "Spurious spotbugs error\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-08-26T15:03:07Z", "type": "commit"}, {"oid": "588cbdf0beab88c2bd989b89774d4fa4834aee19", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/588cbdf0beab88c2bd989b89774d4fa4834aee19", "message": "Add test\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-08-26T15:03:07Z", "type": "commit"}, {"oid": "8abe02bef578811f9415b5c6eafada4f637a851d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8abe02bef578811f9415b5c6eafada4f637a851d", "message": "Grr\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-08-26T15:03:07Z", "type": "commit"}, {"oid": "5d45ba97f41d267ae1563ee38782b3e8dc734c12", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5d45ba97f41d267ae1563ee38782b3e8dc734c12", "message": "non-fatal\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-08-26T15:03:07Z", "type": "commit"}, {"oid": "c8d0059950dabedeaf3c67177b8d40788c7b716a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c8d0059950dabedeaf3c67177b8d40788c7b716a", "message": "Treat SslAuthenticationException specially\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-08-26T15:19:22Z", "type": "commit"}, {"oid": "70f01ead00a50261bc39c5d07ea7d77cbf734673", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/70f01ead00a50261bc39c5d07ea7d77cbf734673", "message": "Improve\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-08-26T15:19:24Z", "type": "commit"}, {"oid": "70f01ead00a50261bc39c5d07ea7d77cbf734673", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/70f01ead00a50261bc39c5d07ea7d77cbf734673", "message": "Improve\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-08-26T15:19:24Z", "type": "forcePushed"}, {"oid": "051798d03e50cdc449492ffbee9b25b84aa03aa3", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/051798d03e50cdc449492ffbee9b25b84aa03aa3", "message": "Fixup\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>", "committedDate": "2020-08-28T11:41:51Z", "type": "commit"}]}