{"pr_number": 3103, "pr_title": "[systemtest][fix] Update testJSONFormatLogging", "pr_createdAt": "2020-05-27T10:53:22Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3103", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA1NTk4Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3103#discussion_r431055987", "bodyText": "Can this be compiled as a static variable instead of doing it at every run?", "author": "scholzj", "createdAt": "2020-05-27T11:47:25Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/StUtils.java", "diffHunk": "@@ -201,13 +202,17 @@ public static JsonArray expectedServiceDiscoveryInfo(String plainAuth, String tl\n     public static boolean checkLogForJSONFormat(Map<String, String> pods, String containerName) {\n         boolean isJSON = false;\n \n+        String regex = \"(\\\\{.*})\\\\{\";\n+        Pattern pattern = Pattern.compile(regex);", "originalCommit": "c57ba77df124532138d3effdee55b3337b823fa9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA2NDAzOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3103#discussion_r431064039", "bodyText": "Fixed, thanks for the comment.", "author": "im-konge", "createdAt": "2020-05-27T12:02:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA1NTk4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA1NjA2Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3103#discussion_r431056066", "bodyText": "Same as above", "author": "scholzj", "createdAt": "2020-05-27T11:47:34Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/StUtils.java", "diffHunk": "@@ -201,13 +202,17 @@ public static JsonArray expectedServiceDiscoveryInfo(String plainAuth, String tl\n     public static boolean checkLogForJSONFormat(Map<String, String> pods, String containerName) {\n         boolean isJSON = false;\n \n+        String regex = \"(\\\\{.*})\\\\{\";\n+        Pattern pattern = Pattern.compile(regex);\n+\n         for (String podName : pods.keySet()) {\n-            String logs = kubeClient().logs(podName, containerName).replaceFirst(\"([^{]+)\", \"\");\n-            try {\n-                new JsonObject(logs);\n+            String log = cmdKubeClient().exec(true, false, \"logs\", podName, \"-c\", containerName, \"--tail=100\").out();\n+            log = log.replaceAll(\"[\\n|\\r]\", \"\");\n+            Matcher matcher = pattern.matcher(log);", "originalCommit": "c57ba77df124532138d3effdee55b3337b823fa9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA2NDE0Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3103#discussion_r431064146", "bodyText": "Fixed as well, thanks for the comment", "author": "im-konge", "createdAt": "2020-05-27T12:03:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA1NjA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA5NTA1Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3103#discussion_r431095056", "bodyText": "Do you really mean that character class containing \\n, \\r and |, or did you just mean to include only \\n and \\r? If the latter that would be [\\n\\r]. If the former it might be better to use [\\n\\r|] to make it clearer that you really meant to include |.", "author": "tombentley", "createdAt": "2020-05-27T12:55:55Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/StUtils.java", "diffHunk": "@@ -202,12 +206,13 @@ public static boolean checkLogForJSONFormat(Map<String, String> pods, String con\n         boolean isJSON = false;\n \n         for (String podName : pods.keySet()) {\n-            String logs = kubeClient().logs(podName, containerName).replaceFirst(\"([^{]+)\", \"\");\n-            try {\n-                new JsonObject(logs);\n+            String log = cmdKubeClient().exec(true, false, \"logs\", podName, \"-c\", containerName, \"--tail=100\").out();\n+            log = log.replaceAll(\"[\\n|\\r]\", \"\");", "originalCommit": "f282774481246d0f30349277d2cb3ed7dbaa86cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEwMzM3NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3103#discussion_r431103374", "bodyText": "I meant to include \\n and \\r, I saw that's working regex for this. Because in the log we can find both of these and I wanted to change it to \"\"", "author": "im-konge", "createdAt": "2020-05-27T13:03:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA5NTA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTExMjA3OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3103#discussion_r431112079", "bodyText": "Regex has different syntax for if you're trying a match one of a set of characters (the \"character class\", where, among other possibilities, you spell out the chars within [ and ] with no separator, e.g. [abc]) or one of a set of other regexes (the \"group\", where you spell out the subexpressions within ( and ) each separated with |, e.g. (foo|bar)).\nThe regex you used will also match a |, which isn't what you meant. It probably doesm't make much difference in this particular case, but it's worth getting regexes right as in other cases it might make a big difference.", "author": "tombentley", "createdAt": "2020-05-27T13:11:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA5NTA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEyODEwMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3103#discussion_r431128103", "bodyText": "Okay, thanks for the explanation, I'm gonna fix it :).", "author": "im-konge", "createdAt": "2020-05-27T13:25:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA5NTA1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA5NjMyNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3103#discussion_r431096324", "bodyText": "Again, just to clarify, I assume it's fine that JSON_PATTERN doesn't understand nested {}, and that you're not expecting that in the log?", "author": "tombentley", "createdAt": "2020-05-27T12:57:59Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/StUtils.java", "diffHunk": "@@ -202,12 +206,13 @@ public static boolean checkLogForJSONFormat(Map<String, String> pods, String con\n         boolean isJSON = false;\n \n         for (String podName : pods.keySet()) {\n-            String logs = kubeClient().logs(podName, containerName).replaceFirst(\"([^{]+)\", \"\");\n-            try {\n-                new JsonObject(logs);\n+            String log = cmdKubeClient().exec(true, false, \"logs\", podName, \"-c\", containerName, \"--tail=100\").out();\n+            log = log.replaceAll(\"[\\n|\\r]\", \"\");\n+            jsonMatcher = JSON_PATTERN.matcher(log);", "originalCommit": "f282774481246d0f30349277d2cb3ed7dbaa86cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM4NzI4MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3103#discussion_r431387280", "bodyText": "If I remember correctly, at least one of the loggers has some nested JSON objects. So it should not rely on the log messages being always flat.", "author": "scholzj", "createdAt": "2020-05-27T19:19:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA5NjMyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM4NTU4Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3103#discussion_r431385587", "bodyText": "Does this need to be static? I guess it might make sense only for the pattern?", "author": "scholzj", "createdAt": "2020-05-27T19:17:39Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/StUtils.java", "diffHunk": "@@ -37,6 +38,9 @@\n \n     private static final Pattern VERSION_IMAGE_PATTERN = Pattern.compile(\"(?<version>[0-9.]+)=(?<image>[^\\\\s]*)\");\n \n+    private static final Pattern JSON_PATTERN = Pattern.compile(\"}[\\\\n]+\\\\{\");\n+    private static Matcher jsonMatcher;", "originalCommit": "5465962c9039899fe65bacb7079fde0b8a4c6cfb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "db47787d6ae6f5d6df8ed37f2d18d6f5241ce07c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/db47787d6ae6f5d6df8ed37f2d18d6f5241ce07c", "message": "fixup! fixup! fix container name for CO\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-28T07:25:01Z", "type": "forcePushed"}, {"oid": "1278889c3532bbc335be3ce1add6721f9b7efea1", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1278889c3532bbc335be3ce1add6721f9b7efea1", "message": "fixup! fixup! fix container name for CO\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-28T07:25:25Z", "type": "forcePushed"}, {"oid": "c7fa32110fc6b8cd43cd9c001118e056c0b97a9e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c7fa32110fc6b8cd43cd9c001118e056c0b97a9e", "message": "fixup! change the assertion -> looks like JSON\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-28T10:52:05Z", "type": "forcePushed"}, {"oid": "d0686d373de27480e3841f04e064aa9e73491e00", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d0686d373de27480e3841f04e064aa9e73491e00", "message": "maybe now will the JsonArray work :)\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-28T18:41:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQ5OTE2Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3103#discussion_r432499166", "bodyText": "What you have should be fine, but I see no harm in allowing for \\r in line terminators.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final Pattern JSON_PATTERN = Pattern.compile(\"}[\\\\n]+\\\\{\");\n          \n          \n            \n                private static final Pattern JSON_PATTERN = Pattern.compile(\"}[\\\\n\\\\r]+\\\\{\");", "author": "tombentley", "createdAt": "2020-05-29T13:56:00Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/StUtils.java", "diffHunk": "@@ -37,6 +38,8 @@\n \n     private static final Pattern VERSION_IMAGE_PATTERN = Pattern.compile(\"(?<version>[0-9.]+)=(?<image>[^\\\\s]*)\");\n \n+    private static final Pattern JSON_PATTERN = Pattern.compile(\"}[\\\\n]+\\\\{\");", "originalCommit": "d0686d373de27480e3841f04e064aa9e73491e00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjUwMzE4Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3103#discussion_r432503182", "bodyText": "This is not as efficient as it could be because the first replaceAll() returns a String, so subsequent replaceAll/First() will have to compile the regex on each invocation. Since you have this in a loop that potentially a lot of time wasted compiling the two patterns N times. You could use an explicit Pattern.compile, factored out into constants to avoid this overhead.\nAlso the .replaceAll(\"\\n\", \" \") is probably unnecessary if you used DOTALL in the replaceFirst().\nFinally it's worth adding comments about what each replacement is doing to the output in order to make it valid JSON you can parse with JsonArray().", "author": "tombentley", "createdAt": "2020-05-29T14:02:39Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/StUtils.java", "diffHunk": "@@ -200,14 +203,19 @@ public static JsonArray expectedServiceDiscoveryInfo(String plainAuth, String tl\n \n     public static boolean checkLogForJSONFormat(Map<String, String> pods, String containerName) {\n         boolean isJSON = false;\n+        //this is only for decrease the number of records - kafka have record/line, operators record/11lines\n+        String tail = \"--tail=\" + (containerName.contains(\"operator\") ? \"50\" : \"10\");\n \n         for (String podName : pods.keySet()) {\n-            String logs = kubeClient().logs(podName, containerName).replaceFirst(\"([^{]+)\", \"\");\n+            String log = cmdKubeClient().execInCurrentNamespace(false, \"logs\", podName, \"-c\", containerName, tail).out();\n+            Matcher matcher = JSON_PATTERN.matcher(log);\n+            log = \"[\" + matcher.replaceAll(\"}, \\\\{\").replaceAll(\"\\n\", \" \").replaceFirst(\"(.*\\\\s)}, \\\\{\", \"{\") + \"]\";", "originalCommit": "d0686d373de27480e3841f04e064aa9e73491e00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "56ad307fd852b2737b08f7f777ae9fec8d909b33", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/56ad307fd852b2737b08f7f777ae9fec8d909b33", "message": "fix testJSONFormatLogging and add option to disable logging of output\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-29T16:16:40Z", "type": "commit"}, {"oid": "000b9ef0804bf49b02b5d47e4423f088ecddebcf", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/000b9ef0804bf49b02b5d47e4423f088ecddebcf", "message": "fixup! fix testJSONFormatLogging and add option to disable logging of output\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-29T16:16:40Z", "type": "commit"}, {"oid": "0a28fd27553af2e2dfe3274565a2eacd0f69f0a3", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/0a28fd27553af2e2dfe3274565a2eacd0f69f0a3", "message": "fix container name for CO\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-29T16:16:40Z", "type": "commit"}, {"oid": "182093fe5cbf3eb48024106bae341663290f7906", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/182093fe5cbf3eb48024106bae341663290f7906", "message": "fixup! fix container name for CO\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-29T16:16:40Z", "type": "commit"}, {"oid": "f6b0e2b018682d1f73818003ff2d30fbed2f8daa", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f6b0e2b018682d1f73818003ff2d30fbed2f8daa", "message": "fixup! fixup! fix container name for CO\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-29T16:16:40Z", "type": "commit"}, {"oid": "b51eade116527c8d3dcbe4bb35fe1e224649c076", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b51eade116527c8d3dcbe4bb35fe1e224649c076", "message": "maybe now will the JsonArray work :)\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-29T16:16:40Z", "type": "commit"}, {"oid": "c197d790b19670dd665c363090a081fe2d86742a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c197d790b19670dd665c363090a081fe2d86742a", "message": "fixup! maybe now will the JsonArray work :)\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-29T17:21:27Z", "type": "forcePushed"}, {"oid": "7e151a7483bdb3360b34e7d75ca67b70433b66ef", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7e151a7483bdb3360b34e7d75ca67b70433b66ef", "message": "fixup! maybe now will the JsonArray work :)\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-29T18:14:11Z", "type": "commit"}, {"oid": "7e151a7483bdb3360b34e7d75ca67b70433b66ef", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7e151a7483bdb3360b34e7d75ca67b70433b66ef", "message": "fixup! maybe now will the JsonArray work :)\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-05-29T18:14:11Z", "type": "forcePushed"}]}