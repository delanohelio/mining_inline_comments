{"pr_number": 3883, "pr_title": "Topic Operator metrics", "pr_createdAt": "2020-10-27T15:15:36Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3883", "timeline": [{"oid": "1ba46948445f43c348687d97ece30e18af4b3bae", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1ba46948445f43c348687d97ece30e18af4b3bae", "message": "Topic Operator metrics\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-10-27T15:14:05Z", "type": "commit"}, {"oid": "faee4f8a39dfcee9b0ea12862212c1dbb1b2860a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/faee4f8a39dfcee9b0ea12862212c1dbb1b2860a", "message": "fix\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-11-02T08:10:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3NTMxNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3883#discussion_r517275315", "bodyText": "Basing it on names seems fragile. I think it would be better to have a constructor parameter for whether a particular Reconciliation should count towards metrics.", "author": "tombentley", "createdAt": "2020-11-04T11:24:08Z", "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -914,18 +921,31 @@ public void onMaxAttemptsExceeded(MaxAttemptsExceededException e) {\n \n         public Reconciliation(String name) {\n             this.name = name;\n-            this.reconciliationTimerSample = Timer.start(metrics.meterRegistry());\n-            reconciliationsCounter.increment();\n+            if (isEventWatched()) {\n+                LOGGER.debug(\"Metric {} triggered\", this.name);\n+                this.reconciliationTimerSample = Timer.start(metrics.meterRegistry());\n+                reconciliationsCounter.increment();\n+            }\n         }\n \n         public void failed() {\n-            reconciliationTimerSample.stop(reconciliationsTimer);\n-            failedReconciliationsCounter.increment();\n+            if (isEventWatched()) {\n+                LOGGER.debug(\"failed reconciliation {}\", name);\n+                reconciliationTimerSample.stop(reconciliationsTimer);\n+                failedReconciliationsCounter.increment();\n+            }\n         }\n \n         public void succeeded() {\n-            reconciliationTimerSample.stop(reconciliationsTimer);\n-            successfulReconciliationsCounter.increment();\n+            if (isEventWatched()) {\n+                LOGGER.debug(\"succeeded reconciliation {}\", name);\n+                reconciliationTimerSample.stop(reconciliationsTimer);\n+                successfulReconciliationsCounter.increment();\n+            }\n+        }\n+\n+        private boolean isEventWatched() {\n+            return !\"onResourceEvent\".equals(name) && !\"reconcile-from-kafka\".equals(name);", "originalCommit": "faee4f8a39dfcee9b0ea12862212c1dbb1b2860a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3NjYyMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3883#discussion_r517276621", "bodyText": "Why does this get counted as a (successful) reconciliation, but when there are topics each one counts as successful? What are we counting? The number of times the timer goes off or the number of time we actually deal with a topic?", "author": "tombentley", "createdAt": "2020-11-04T11:26:28Z", "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -1229,6 +1249,10 @@ public void setKafkaTopics(List<KafkaTopic> ktList) {\n         }).compose(reconcileState -> {\n             List<Future> futs = new ArrayList<>();\n             topicCounter.set(reconcileState.ktList.size());\n+            if (reconcileState.ktList.size() == 0) {\n+                reconciliationsCounter.increment();\n+                successfulReconciliationsCounter.increment();\n+            }\n             for (KafkaTopic kt : reconcileState.ktList) {", "originalCommit": "faee4f8a39dfcee9b0ea12862212c1dbb1b2860a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3OTczNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3883#discussion_r517279737", "bodyText": "Ah, it should not be there.", "author": "sknot-rh", "createdAt": "2020-11-04T11:32:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3NjYyMQ=="}], "type": "inlineReview"}, {"oid": "01a9f41b1a3bc03ccf4cc4d4643f1809442c5ef4", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/01a9f41b1a3bc03ccf4cc4d4643f1809442c5ef4", "message": "fix\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-11-04T13:05:10Z", "type": "commit"}, {"oid": "01a9f41b1a3bc03ccf4cc4d4643f1809442c5ef4", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/01a9f41b1a3bc03ccf4cc4d4643f1809442c5ef4", "message": "fix\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-11-04T13:05:10Z", "type": "forcePushed"}]}