{"pr_number": 3240, "pr_title": "Fixed log4j2 support for the bridge", "pr_createdAt": "2020-06-25T10:37:26Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3240", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAyNDY0Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3240#discussion_r446024642", "bodyText": "Maybe it would be better, at this point to change the value of ANCILLARY_CM_KEY_LOG_CONFIG to \"log4j2.properties\" and override getAncillaryConfigMapKeyLogConfig() on the Kafka and other things which are still log4j 1.", "author": "tombentley", "createdAt": "2020-06-26T07:50:11Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/AbstractModel.java", "diffHunk": "@@ -1203,7 +1203,7 @@ protected String determineImagePullPolicy(ImagePullPolicy requestedImagePullPoli\n         }\n     }\n \n-    String getAncillaryConfigMapKeyLogConfig() {\n+    public String getAncillaryConfigMapKeyLogConfig() {", "originalCommit": "14c6b4c80a6faa93e65f327cade17641ca179236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA1NjAzNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3240#discussion_r446056034", "bodyText": "Why? For making log4j2 the new default?", "author": "ppatierno", "createdAt": "2020-06-26T08:53:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAyNDY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA2MTkyNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3240#discussion_r446061924", "bodyText": "Yes, AFAIK all the Strimzi stuff is using log4j2 at this point. Kafka will move at some point. IDK about Zookeeper, but I'm not aware of any reason it has to be log4j 1 any more. So it makes more sense to just override this method for Kafka than having to override it for everything except Kafka.", "author": "tombentley", "createdAt": "2020-06-26T09:05:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAyNDY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2MjYyMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3240#discussion_r446162622", "bodyText": "I searched a little bit more in the code and it seems we have ZooKeeper, Kafka, Kafka Connect, Cruise Control, Mirror Maker and Mirror Maker 2 all using log4j 1 ... while just operator and bridge are using log4j2. So 6 vs 3 ... is it really useful doing the change now?", "author": "ppatierno", "createdAt": "2020-06-26T12:48:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAyNDY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2NzQwMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3240#discussion_r446167403", "bodyText": "No, I guess not.\nHowever, we're going to have to do this at some point:\n\nlog4jv1 has at least 1 CVE and will not be fixed, so there are good reasons to move\nZookeeper and CC both use slf4j as a facade, so there's a good chance we could switch to using lo4j2 as the back end with no ill effects. It should be enough to grep to see if they import anything more than loggers.\napache/kafka#7898 is making steady progress, so hopefully it won't be long before Kafka changes too.\n\nSo maybe I'm a little premature, but our work here is not done.", "author": "tombentley", "createdAt": "2020-06-26T12:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAyNDY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE3MjA3MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3240#discussion_r446172070", "bodyText": "We can open an issue and propose the change to the Cruise Control community? Do you think that we should contribute to the same for ZooKeeper as well? Anyway, we rely on the ZooKeeper version brought by Kafka, right? So even if moving to log4j2 on Zookeeper we have to wait for Kafka community to takes that version.", "author": "ppatierno", "createdAt": "2020-06-26T13:07:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAyNDY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIyNTMwOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3240#discussion_r446225308", "bodyText": "See https://issues.apache.org/jira/browse/ZOOKEEPER-2342. The comments suggest that is basically just works, and the only reason they've stuck with v1 so far is simply for compatibility with v1 configuration syntax. Also:\n$ grep -Fr 'import org.apache.log' .\n./zookeeper-server/src/test/java/org/apache/zookeeper/audit/Log4jAuditLoggerTest.java:import org.apache.log4j.Layout;\n./zookeeper-server/src/test/java/org/apache/zookeeper/audit/Log4jAuditLoggerTest.java:import org.apache.log4j.Level;\n./zookeeper-server/src/test/java/org/apache/zookeeper/audit/Log4jAuditLoggerTest.java:import org.apache.log4j.Logger;\n./zookeeper-server/src/test/java/org/apache/zookeeper/audit/Log4jAuditLoggerTest.java:import org.apache.log4j.SimpleLayout;\n./zookeeper-server/src/test/java/org/apache/zookeeper/audit/Log4jAuditLoggerTest.java:import org.apache.log4j.WriterAppender;\n./zookeeper-server/src/test/java/org/apache/zookeeper/audit/StandaloneServerAuditTest.java:import org.apache.log4j.Layout;\n./zookeeper-server/src/test/java/org/apache/zookeeper/audit/StandaloneServerAuditTest.java:import org.apache.log4j.Level;\n./zookeeper-server/src/test/java/org/apache/zookeeper/audit/StandaloneServerAuditTest.java:import org.apache.log4j.Logger;\n./zookeeper-server/src/test/java/org/apache/zookeeper/audit/StandaloneServerAuditTest.java:import org.apache.log4j.SimpleLayout;\n./zookeeper-server/src/test/java/org/apache/zookeeper/audit/StandaloneServerAuditTest.java:import org.apache.log4j.WriterAppender;\n./zookeeper-server/src/test/java/org/apache/zookeeper/test/ReadOnlyModeTest.java:import org.apache.log4j.Layout;\n./zookeeper-server/src/test/java/org/apache/zookeeper/test/ReadOnlyModeTest.java:import org.apache.log4j.Level;\n./zookeeper-server/src/test/java/org/apache/zookeeper/test/ReadOnlyModeTest.java:import org.apache.log4j.Logger;\n./zookeeper-server/src/test/java/org/apache/zookeeper/test/ReadOnlyModeTest.java:import org.apache.log4j.WriterAppender;\n./zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java:import org.apache.log4j.Level;\n./zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java:import org.apache.log4j.Logger;\n./zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java:import org.apache.log4j.PatternLayout;\n./zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/QuorumPeerMainTest.java:import org.apache.log4j.WriterAppender;\n\nI.e. the only place where they depend on log4j v1 is in the tests.\nFor CC that grep shows nothing.\nSo there's pretty much nothing to do, unless you want to get bogged down in the config compatibility debate. But that needn't concern us: In both cases we could switch really easily if we wanted to, it's just a matter of writing a log4j2 config file or using v2's support for reading v1 configs: http://logging.apache.org/log4j/2.x/manual/migration.html and arranging the classpath appropriately.", "author": "tombentley", "createdAt": "2020-06-26T14:39:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAyNDY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg4NDAwOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3240#discussion_r446884009", "bodyText": "Maybe I read it wrong. As far as I can see they are talking about adding log4j2 dependency at runtime which is not in ZK 3.5.7 shipped with Kafka 2.5.0 in the current Strimzi version. So how is going to work without that dependency but just adding the right log4j2 file? That issue seems to be focused to address this in ZK 3.7, or?", "author": "ppatierno", "createdAt": "2020-06-29T10:12:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAyNDY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAyNTczNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3240#discussion_r446025737", "bodyText": "So, hang on one moment. In the bridge itself we have two copies of this config, and now in the CO we're also embedding a 3rd copy. Is that really necessary?", "author": "tombentley", "createdAt": "2020-06-26T07:52:13Z", "path": "cluster-operator/src/main/resources/kafkaBridgeDefaultLoggingProperties", "diffHunk": "@@ -1,9 +1,24 @@\n-log4j.appender.CONSOLE=org.apache.log4j.ConsoleAppender\n-log4j.appender.CONSOLE.layout=org.apache.log4j.PatternLayout\n-log4j.appender.CONSOLE.layout.ConversionPattern=%d{ISO8601} %p %m (%c) [%t]%n\n-bridge.root.logger=INFO\n-log4j.rootLogger=${bridge.root.logger}, CONSOLE\n-log4j.logger.http.openapi.operation.healthy=WARN, CONSOLE\n-log4j.additivity.http.openapi.operation.healthy=false\n-log4j.logger.http.openapi.operation.ready=WARN, CONSOLE\n-log4j.additivity.http.openapi.operation.ready=false\n\\ No newline at end of file\n+name = BridgeConfig", "originalCommit": "14c6b4c80a6faa93e65f327cade17641ca179236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA1NjQ5Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3240#discussion_r446056492", "bodyText": "This copy is from where the CO creates the configmap with the logging configuration.\nThe other two in the bridge project are mostly related 1) for development (in the resources) 2) in the config folder for bridge running on bare metal.", "author": "ppatierno", "createdAt": "2020-06-26T08:54:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAyNTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA2MTkwOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3240#discussion_r446061908", "bodyText": "So if the bridge classpath one is really \"for development\" what's it doing built into the bridge jar? If, on the other hand, that was a sensible default then there would be no need to have the default here.", "author": "tombentley", "createdAt": "2020-06-26T09:04:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAyNTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA2NzY0NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3240#discussion_r446067644", "bodyText": "It's in the jar to avoid that you have to start your bridge in the IDE specifying a log4j2.properties file path for logging configuration.\nAbout having it here, currently, it's placed in the configmap mounted as volume and then it is set in the bridge run script as following:\nexport KAFKA_BRIDGE_LOG4J_OPTS=\"-Dlog4j2.configurationFile=file:$STRIMZI_HOME/custom-config/log4j2.properties\n\nusing the embedded one directly then means that if we remove that line, the user cannot specify an external logging file anymore, right? And changing the default logging would mean releasing a new bridge then, while we much more release the operator often than the bridge.\nOr I am just misleading your point :-)", "author": "ppatierno", "createdAt": "2020-06-26T09:16:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAyNTczNw=="}], "type": "inlineReview"}, {"oid": "c2f8b5b0ccf1de8d6b6487b3a54b7bb93d3aa638", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c2f8b5b0ccf1de8d6b6487b3a54b7bb93d3aa638", "message": "Fixed log4j2 support in the bridge\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>", "committedDate": "2020-06-29T15:31:38Z", "type": "commit"}, {"oid": "c155da975aaf57e272ad38249bfc03b1c7fc73fa", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c155da975aaf57e272ad38249bfc03b1c7fc73fa", "message": "Updated bridge version to latest 0.17.0\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>", "committedDate": "2020-06-29T15:32:51Z", "type": "commit"}, {"oid": "c155da975aaf57e272ad38249bfc03b1c7fc73fa", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c155da975aaf57e272ad38249bfc03b1c7fc73fa", "message": "Updated bridge version to latest 0.17.0\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>", "committedDate": "2020-06-29T15:32:51Z", "type": "forcePushed"}, {"oid": "4185b766d27925fbd9b5f0e0bfc12d83ec0ddb73", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4185b766d27925fbd9b5f0e0bfc12d83ec0ddb73", "message": "Update derived resources\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>", "committedDate": "2020-06-29T19:55:31Z", "type": "commit"}, {"oid": "5a47826f4232b2465d1b1af9e0dff60992a087f9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5a47826f4232b2465d1b1af9e0dff60992a087f9", "message": "Updated missing files with bridge 0.17.0\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>", "committedDate": "2020-06-30T09:30:48Z", "type": "commit"}, {"oid": "ccbecdbc52ff140a7e53cf31e5cd08055ebed795", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ccbecdbc52ff140a7e53cf31e5cd08055ebed795", "message": "Fixed regression test about bridge logging\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>", "committedDate": "2020-06-30T12:45:54Z", "type": "commit"}]}