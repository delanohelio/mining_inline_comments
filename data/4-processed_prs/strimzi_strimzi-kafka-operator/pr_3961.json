{"pr_number": 3961, "pr_title": "Integration of OAuth over PLAIN", "pr_createdAt": "2020-11-16T10:18:02Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIyOTg0MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524229841", "bodyText": "Wrongly committed file? There seems to be a bunch of them.", "author": "scholzj", "createdAt": "2020-11-16T12:38:59Z", "path": "install/cluster-operator/020-RoleBinding-strimzi-cluster-operator.yaml-e", "diffHunk": "@@ -0,0 +1,14 @@\n+apiVersion: rbac.authorization.k8s.io/v1", "originalCommit": "f5d91d9fa9b79befdce4d2ac9325203115456f09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3ODEzNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524478136", "bodyText": "The build produced a bunch of these inside the source tree - I assumed these should be added like most of the other autogenerated things inside the source tree. So these yaml-e files should be generated as they currently are, but should not be included in git? What are they for?", "author": "mstruk", "createdAt": "2020-11-16T18:19:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIyOTg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4MDI5MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524480290", "bodyText": "They should not have the .yaml-e extension. It should be just .yaml. This has to be something in your environment causing this.", "author": "scholzj", "createdAt": "2020-11-16T18:23:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIyOTg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA2MTk5NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r525061994", "bodyText": "No idea how they got generated, can't reproduce it.", "author": "mstruk", "createdAt": "2020-11-17T10:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIyOTg0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMTMzMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524231333", "bodyText": "For easier readability, should the enablePlain and enableOAuthBearer be next to each other?", "author": "scholzj", "createdAt": "2020-11-16T12:40:24Z", "path": "documentation/modules/oauth/proc-oauth-authentication-broker-config.adoc", "diffHunk": "@@ -121,12 +121,18 @@ Depending on how you apply OAuth 2.0 authentication, and the type of authorizati\n     fallbackUserNamePrefix: client-account- <3>\n     validTokenType: bearer <4>\n     userInfoEndpointUri: __https://OAUTH-SERVER-ADDRESS/auth/realms/external/protocol/openid-connect/userinfo__ <5>\n+    enablePlain: true <6>\n+    tokenEndpointUri: __https://OAUTH-SERVER-ADDRESS/auth/realms/external/protocol/openid-connect/token__ <7>\n+    enableOAuthBearer: false <8>", "originalCommit": "f5d91d9fa9b79befdce4d2ac9325203115456f09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3OTI2Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524479266", "bodyText": "I put tokenEndpointUri after enablePlain because it's relevant only when enablePlain is true, so it made sense to me to put it there. But we can also put it after enableOAuthBearer so the other two are next to each other.", "author": "mstruk", "createdAt": "2020-11-16T18:21:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMTMzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4MTA1Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524481053", "bodyText": "But we can also put it after enableOAuthBearer so the other two are next to each other.\n\nI guess that makes sense then.", "author": "scholzj", "createdAt": "2020-11-16T18:24:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMTMzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA4NzM5OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r525087398", "bodyText": "What about flipping the order like this:\nenableOAuthBearer: false\nenablePlain: true\ntokenEndpointUri: https://...", "author": "mstruk", "createdAt": "2020-11-17T11:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMTMzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEzNzQxOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r525137418", "bodyText": "Yeah, that works for me perfectly fine.", "author": "scholzj", "createdAt": "2020-11-17T13:04:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMTMzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMjI0NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524232244", "bodyText": "What is the purpose of this script? Should it really be added?", "author": "scholzj", "createdAt": "2020-11-16T12:41:15Z", "path": "docker-images/kafka/scripts/jwt.sh", "diffHunk": "@@ -0,0 +1,14 @@\n+#!/bin/bash", "originalCommit": "f5d91d9fa9b79befdce4d2ac9325203115456f09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4MDE0MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524480140", "bodyText": "It's a little tool that allows you to peer into a JWT token. You can see some useful information - like when it expires, and who it was issued for. It's can be useful in combination with oauth.sh.", "author": "mstruk", "createdAt": "2020-11-16T18:23:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMjI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4MTQzOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524481439", "bodyText": "So why should it be in the container images? Should it be in /tools instead?", "author": "scholzj", "createdAt": "2020-11-16T18:25:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMjI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUzNTY2MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524535660", "bodyText": "This script needs to connect to the authorization server using the same hostname that the Kafka Broker uses. For that reason it may need to be executed from the pod running in the same Kubernetes cluster.\nDo we have a better candidate image?", "author": "mstruk", "createdAt": "2020-11-16T19:57:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMjI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU0MDA4MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524540081", "bodyText": "Running something in the broker pod is a bad practice from several different angles. The tool does not have any help, but it looks like it just base64 decodes the token. So why does it need to run from the broker pod? Why can't it run from a local machine?\nWhat are the scenarios where one needs to run it? And who is expected to run this? In production environment only absolute minimum of people should have the access levels to do so. So it should be avoided.", "author": "scholzj", "createdAt": "2020-11-16T20:06:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMjI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU2MTQ2NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524561464", "bodyText": "This tool can be run outside the pod, but base64 it relies on differs between platforms so having it in the image gives it a predictable environment where it's guaranteed to work. It's true that only a small portion of users will ever be interested in this tool. You'd only use it on the token you just got with oauth.sh, so it is only useful if oauth.sh is also there.\nIn order to connect to the Kafka Cluster using Kafka CLI tools you need Kafka image. While you maybe wouldn't use kubectl exec on the production broker, you'd still use the Strimzi Kafka image:\nkubectl run -ti --rm --restart=Never --image=quay.io/strimzi/kafka:latest-kafka-2.6.0 cli -- /bin/sh", "author": "mstruk", "createdAt": "2020-11-16T20:46:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMjI0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMjM0Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524232346", "bodyText": "What is the purpose of this script? Should it really be added?", "author": "scholzj", "createdAt": "2020-11-16T12:41:21Z", "path": "docker-images/kafka/scripts/oauth.sh", "diffHunk": "@@ -0,0 +1,133 @@\n+#!/bin/bash", "originalCommit": "f5d91d9fa9b79befdce4d2ac9325203115456f09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4MTIxOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524481219", "bodyText": "This is the script that allows you to login as a client or as a user to an OAuth2 authorization server and get an access token or a refresh token which you can then use to authenticate when running kafka CLI tools.", "author": "mstruk", "createdAt": "2020-11-16T18:24:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMjM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4MjAxOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524482019", "bodyText": "Again ... not sure this should be in the container.", "author": "scholzj", "createdAt": "2020-11-16T18:26:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMjM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUzMTU4OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524531589", "bodyText": "It is certainly a matter of convenience to have it in this image.\nIt allows for the following usage pattern:\nkubectl exec -ti my-cluster-kafka-0 -- /bin/sh\n\nACCESS_TOKEN=$(./oauth.sh --endpoint http://keycloak:8080/auth/realms/kafka-authz/protocol/openid-connect/token --client-id team-a-client --secret team-a-client-secret --access -q)\necho $ACCESS_TOKEN\n\ncat > /tmp/team-a-client-plain.properties << EOF\nsecurity.protocol=SASL_PLAINTEXT\nsasl.mechanism=PLAIN\nsasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required \\\n username=\"team-a-client\" \\\n password=\"$ACCESS_TOKEN\" ;\nEOF\n\nbin/kafka-console-producer.sh --broker-list my-cluster-kafka-0:9092 --topic a_messages \\\n --producer.config=/tmp/team-a-client-plain.properties\n\nWithout the oauth.sh script present I have two options:\n\nUse kubectl cp to copy the script into the running container, every OAuth example using this pattern would have to include this step\nUse some other image with oauth.sh prepackaged. Probably that image won't contain kafka CLI tools, therefore the obtained access token will have to be copied over into the other shell. But in any case, is there another image in the project that would be appropriate for this?", "author": "mstruk", "createdAt": "2020-11-16T19:50:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMjM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU0MzM5OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524543398", "bodyText": "Similar to the script above:\n\nYou do not want to run this inside the broker pod\nIn real production environments you should not have access to run this inside the pod. So what are the scenarios where you expect to run it?\n\nIf any, I think the test-client image would be more appropriate for this. Since this seems to be pretty much them same - a tool useful for testing. But it looks like some standard tool for development and testing. So having it in the tools directory seems appropriate.", "author": "scholzj", "createdAt": "2020-11-16T20:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMjM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU2NDI3MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r524564271", "bodyText": "See above.\nI'm fine with having it in another image. I want to use it in examples so it should be something we propose people use / consider a 'good practice'.", "author": "mstruk", "createdAt": "2020-11-16T20:51:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMjM0Ng=="}], "type": "inlineReview"}, {"oid": "f98afa53c112f1e5806a9fc14f4e90bbc5b8b492", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f98afa53c112f1e5806a9fc14f4e90bbc5b8b492", "message": "Add SNAPSHOTS repository with latest strimzi-kafka-oauth master builds\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2020-12-05T09:51:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUzNDA4NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r537534084", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            over SASL_OAUTHBEARER.Default value is `true`.\n          \n          \n            \n                                            over SASL_OAUTHBEARER. Default value is `true`.", "author": "tombentley", "createdAt": "2020-12-07T14:09:09Z", "path": "api/src/test/resources/io/strimzi/api/kafka/model/040-Crd-kafka-crdApi-v1.yaml", "diffHunk": "@@ -275,6 +275,15 @@ spec:\n                               type: boolean\n                               description: Enable or disable ECDSA support by installing\n                                 BouncyCastle crypto provider. Default value is `false`.\n+                            enableOauthBearer:\n+                              type: boolean\n+                              description: Enable or disable OAuth authentication\n+                                over SASL_OAUTHBEARER.Default value is `true`.", "originalCommit": "c9de4e480e69ec58fcad226574ee93ce9a83504d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU4MDYxMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r537580611", "bodyText": "Will have to fix this in the annotation in the CR class since that's the source from where this is generated as part of the build.", "author": "mstruk", "createdAt": "2020-12-07T15:08:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUzNDA4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUzNDE4Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r537534186", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            when this mechanism is used.Default value is `false`.\n          \n          \n            \n                                            when this mechanism is used. Default value is `false`.", "author": "tombentley", "createdAt": "2020-12-07T14:09:16Z", "path": "api/src/test/resources/io/strimzi/api/kafka/model/040-Crd-kafka-crdApi-v1.yaml", "diffHunk": "@@ -275,6 +275,15 @@ spec:\n                               type: boolean\n                               description: Enable or disable ECDSA support by installing\n                                 BouncyCastle crypto provider. Default value is `false`.\n+                            enableOauthBearer:\n+                              type: boolean\n+                              description: Enable or disable OAuth authentication\n+                                over SASL_OAUTHBEARER.Default value is `true`.\n+                            enablePlain:\n+                              type: boolean\n+                              description: Enable or disable OAuth authentication\n+                                over SASL_PLAIN. There is no re-authentication support\n+                                when this mechanism is used.Default value is `false`.", "originalCommit": "c9de4e480e69ec58fcad226574ee93ce9a83504d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUzOTUwNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r537539504", "bodyText": "Aside: I do see the Uri in this name and feel bad about the inconsistency with enableECDSA. In hindsight it should have been enableEcdsa. Maybe that's something we should change for v1beta2, WDYT @scholzj @ppatierno @alesj ?", "author": "tombentley", "createdAt": "2020-12-07T14:16:02Z", "path": "helm-charts/helm3/strimzi-kafka-operator/crds/040-Crd-kafka.yaml", "diffHunk": "@@ -848,6 +881,9 @@ spec:\n                                       - certificate\n                                       - secretName\n                                   description: Trusted certificates for TLS connection to the OAuth server.\n+                                tokenEndpointUri:", "originalCommit": "c9de4e480e69ec58fcad226574ee93ce9a83504d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE0MDIzMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r539140233", "bodyText": "If we replace keycloak-core with nimbus-jose-jwt we could possibly remove the enableECDSA flag altogether because I think it would be enabled automatically without the need to install Bouncycastle crypto providers.", "author": "mstruk", "createdAt": "2020-12-09T09:21:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUzOTUwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk3MzU2OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r539973568", "bodyText": "so as far as I understood both mechanisms can be enabled at the same time? How it's going to work in that case?", "author": "ppatierno", "createdAt": "2020-12-10T08:35:44Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaBrokerConfigurationBuilder.java", "diffHunk": "@@ -273,9 +274,24 @@ private void configureAuthentication(String listenerName, List<String> securityP\n                 options.add(\"oauth.ssl.truststore.type=\\\"PKCS12\\\"\");\n             }\n \n-            writer.println(String.format(\"listener.name.%s.oauthbearer.sasl.server.callback.handler.class=io.strimzi.kafka.oauth.server.JaasServerOauthValidatorCallbackHandler\", listenerNameInProperty));\n-            writer.println(String.format(\"listener.name.%s.oauthbearer.sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required unsecuredLoginStringClaim_sub=\\\"thePrincipalName\\\" %s;\", listenerNameInProperty, String.join(\" \", options)));\n-            writer.println(String.format(\"listener.name.%s.sasl.enabled.mechanisms=OAUTHBEARER\", listenerNameInProperty));\n+            StringBuilder enabledMechanisms = new StringBuilder();\n+            if (oauth.isEnableOauthBearer()) {\n+                writer.println(String.format(\"listener.name.%s.oauthbearer.sasl.server.callback.handler.class=io.strimzi.kafka.oauth.server.JaasServerOauthValidatorCallbackHandler\", listenerNameInProperty));\n+                writer.println(String.format(\"listener.name.%s.oauthbearer.sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required unsecuredLoginStringClaim_sub=\\\"thePrincipalName\\\" %s;\", listenerNameInProperty, String.join(\" \", options)));\n+                enabledMechanisms.append(\"OAUTHBEARER\");\n+            }\n+\n+            if (oauth.isEnablePlain()) {\n+                addOption(options, ServerPlainConfig.OAUTH_TOKEN_ENDPOINT_URI, oauth.getTokenEndpointUri());\n+                writer.println(String.format(\"listener.name.%s.plain.sasl.server.callback.handler.class=io.strimzi.kafka.oauth.server.plain.JaasServerOauthOverPlainValidatorCallbackHandler\", listenerNameInProperty));\n+                writer.println(String.format(\"listener.name.%s.plain.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required %s;\", listenerNameInProperty, String.join(\" \", options)));\n+                if (enabledMechanisms.length() > 0) {\n+                    enabledMechanisms.append(\",\");\n+                }\n+                enabledMechanisms.append(\"PLAIN\");\n+            }\n+\n+            writer.println(String.format(\"listener.name.%s.sasl.enabled.mechanisms=%s\", listenerNameInProperty, enabledMechanisms));", "originalCommit": "8ac3fb4f8ba1ae9f1ad75c95411dccc9aa3e650f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA2MTk5NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r540061994", "bodyText": "SASL works by client specifying which mechanism it wants to use, and simply attempting to use that mechanism on the listener. If it fails it is free to try with some other mechanism. The broker simply delegates to the requested mechanism if it was configured and enabled, otherwise it responds to the client that the mechanism is not available.\nOn the server you therefore get multiple enabled SASL mechanisms on the listener:\nlistener.name.external-9094.sasl.enabled.mechanisms: OAUTHBEARER, PLAIN\n\nAnd then each mechanism is properly configured with correct server-side callback handlers:\nlistener.name.external-9094.oauthbearer.sasl.server.callback.handler.class=io.strimzi.kafka.oauth.server.JaasServerOauthValidatorCallbackHandler\nlistener.name.external-9094.oauthbearer.sasl.jaas.config=org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required  OPTIONS ...;\n\nlistener.name.external-9094.plain.sasl.server.callback.handler.class: io.strimzi.kafka.oauth.server.plain.JaasServerOauthOverPlainValidatorCallbackHandler\nlistener.name.external-9094.plain.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required OPTIONS ...;", "author": "mstruk", "createdAt": "2020-12-10T10:41:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk3MzU2OA=="}], "type": "inlineReview"}, {"oid": "b76e4fe9e71a6521dac014440f5fb517a5de0f1a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b76e4fe9e71a6521dac014440f5fb517a5de0f1a", "message": "Use a custom maven repo for strimzi-kafka-oauth artifacts\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-01-15T10:18:53Z", "type": "forcePushed"}, {"oid": "daf24637dfae2a3149a1830a6540703520cf6c58", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/daf24637dfae2a3149a1830a6540703520cf6c58", "message": "Integration of OAuth over PLAIN\n\nThree config properties added to 'oauth' authentication:\n- 'enablePlain' (`false` by default) and 'enableOauthBearer' (`true` by default) for controlling which SASL mechanisms to enable\n- 'tokenEndpointUri' for setting the endpoint used by broker-side to exchange the received clientId and the secret for the access token\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:35Z", "type": "commit"}, {"oid": "b85f663ac19f771b785d1e5a8b0dc619e21f2491", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b85f663ac19f771b785d1e5a8b0dc619e21f2491", "message": "Add oauth.sh script to kafka images\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:40Z", "type": "commit"}, {"oid": "ef208c57643ba3abcca83e494543182255240aa4", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ef208c57643ba3abcca83e494543182255240aa4", "message": "Add jwt.sh script to kafka images + add tokenEndpointUri to authentication for to support clientId + secret with SASL_PLAIN\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:40Z", "type": "commit"}, {"oid": "dddf6e95ffe7105babf98063249180155f37ef4e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/dddf6e95ffe7105babf98063249180155f37ef4e", "message": "Add some tests for SASL_PLAIN\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "9c7899b29d0515ba310665af8685dd943577937e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9c7899b29d0515ba310665af8685dd943577937e", "message": "Remove the .yaml-e files from install/cluster-operator\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "e094e53cb484eacdcda2d86f488e2ca36abb0a50", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e094e53cb484eacdcda2d86f488e2ca36abb0a50", "message": "Change ordering for the new options in the docs\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "053cc52bd8786e61829aff74767833eeaab44da5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/053cc52bd8786e61829aff74767833eeaab44da5", "message": "Fix capitalisation of enableOAuthBearer\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "e17566272cd1021e3e15769bb3d100ef7aab1303", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e17566272cd1021e3e15769bb3d100ef7aab1303", "message": "Add SNAPSHOTS repository with latest strimzi-kafka-oauth master builds\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "97336b91fd341491527a0a6d480120d1900b4bee", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/97336b91fd341491527a0a6d480120d1900b4bee", "message": "Remove oauth.sh and jwt.sh scripts from docker images.\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "853e5b252a6ed040c0d7a53ab30dec6a57d898b5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/853e5b252a6ed040c0d7a53ab30dec6a57d898b5", "message": "Fix spaces in generated docs\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "31b0ba869216d67f581be53cfc84eb1b2d3cb6e0", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/31b0ba869216d67f581be53cfc84eb1b2d3cb6e0", "message": "OAuth over PLAIN fix - decouple 'oauth' authentication from 'keycloak' authorization\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "66647223b0845afdf17faf04d5267fd397b957d7", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/66647223b0845afdf17faf04d5267fd397b957d7", "message": "OAuth over PLAIN fix tests for after the coupling fix\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "a752f15feeabf48d616639b4313e25e2d06a2e7c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a752f15feeabf48d616639b4313e25e2d06a2e7c", "message": "OAuth over PLAIN - better fix that avoids multiple kafka.principal.builder declarations\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T08:58:41Z", "type": "commit"}, {"oid": "b510cc906caaf80bf268564e79415015da8b6745", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b510cc906caaf80bf268564e79415015da8b6745", "message": "Use a custom maven repo for strimzi-kafka-oauth artifacts\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T09:00:49Z", "type": "commit"}, {"oid": "ca23b454399cd739e3d57ed42f7c17d337b64029", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ca23b454399cd739e3d57ed42f7c17d337b64029", "message": "Exclude json-path dependency of oauth-common\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T09:00:56Z", "type": "commit"}, {"oid": "5edc8bdf84debfb4c6fd761bb12a9d780159f3a5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5edc8bdf84debfb4c6fd761bb12a9d780159f3a5", "message": "Use staging maven repo for 0.7.0 CR2 and exlude json-path deps\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T09:08:33Z", "type": "commit"}, {"oid": "5edc8bdf84debfb4c6fd761bb12a9d780159f3a5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5edc8bdf84debfb4c6fd761bb12a9d780159f3a5", "message": "Use staging maven repo for 0.7.0 CR2 and exlude json-path deps\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T09:08:33Z", "type": "forcePushed"}, {"oid": "73c43f2a2b8258bfafaf32c45660ac6904a7f7e0", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/73c43f2a2b8258bfafaf32c45660ac6904a7f7e0", "message": "Fix staging maven repo for 0.7.0 CR2\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T10:16:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODAwMzQzOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r568003439", "bodyText": "Why do we need this?", "author": "scholzj", "createdAt": "2021-02-01T17:24:15Z", "path": "docker-images/kafka/kafka-thirdparty-libs/2.5.x/pom.xml", "diffHunk": "@@ -26,6 +26,14 @@\n             <id>jcenter</id>\n             <url>https://jcenter.bintray.com/</url>\n         </repository>\n+        <repository>\n+            <id>staging</id>\n+            <url>https://oss.sonatype.org/content/repositories/snapshots/</url>\n+        </repository>", "originalCommit": "73c43f2a2b8258bfafaf32c45660ac6904a7f7e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODAwMzY3Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r568003676", "bodyText": "Same as above, why do we need this?", "author": "scholzj", "createdAt": "2021-02-01T17:24:38Z", "path": "docker-images/kafka/kafka-thirdparty-libs/2.6.x/pom.xml", "diffHunk": "@@ -26,6 +26,14 @@\n             <id>jcenter</id>\n             <url>https://jcenter.bintray.com/</url>\n         </repository>\n+        <repository>\n+            <id>staging</id>\n+            <url>https://oss.sonatype.org/content/repositories/snapshots/</url>\n+        </repository>", "originalCommit": "73c43f2a2b8258bfafaf32c45660ac6904a7f7e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODAwMzk2Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r568003967", "bodyText": "Same as above, why do we need this?", "author": "scholzj", "createdAt": "2021-02-01T17:25:05Z", "path": "docker-images/kafka/kafka-thirdparty-libs/2.7.x/pom.xml", "diffHunk": "@@ -26,6 +26,14 @@\n             <id>jcenter</id>\n             <url>https://jcenter.bintray.com/</url>\n         </repository>\n+        <repository>\n+            <id>staging</id>\n+            <url>https://oss.sonatype.org/content/repositories/snapshots/</url>\n+        </repository>", "originalCommit": "73c43f2a2b8258bfafaf32c45660ac6904a7f7e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODAwNDMwOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3961#discussion_r568004308", "bodyText": "Same as above, why do we need this?", "author": "scholzj", "createdAt": "2021-02-01T17:25:37Z", "path": "pom.xml", "diffHunk": "@@ -147,6 +147,17 @@\n         </repository>\n     </distributionManagement>\n \n+    <repositories>\n+        <repository>\n+            <id>staging</id>\n+            <url>https://oss.sonatype.org/content/repositories/snapshots/</url>\n+        </repository>", "originalCommit": "73c43f2a2b8258bfafaf32c45660ac6904a7f7e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2ca084dd49d8b799db6e22421ce17688eda4fc66", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2ca084dd49d8b799db6e22421ce17688eda4fc66", "message": "Remove unnecessary staging repo\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-01T17:38:04Z", "type": "commit"}, {"oid": "7872e59040b167827e4b79f5520ed91cc2a219b9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7872e59040b167827e4b79f5520ed91cc2a219b9", "message": "Add kafka-oauth-server-plain.jar to kafka 2.7.0 image\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-03T12:13:09Z", "type": "commit"}, {"oid": "ba5dfc01fab86d681a84b40713614d3816d11eda", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ba5dfc01fab86d681a84b40713614d3816d11eda", "message": "Remove RC maven repository so that strimzi-kafka-oauth 0.7.0 release libs are used\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2021-02-05T14:15:24Z", "type": "commit"}]}