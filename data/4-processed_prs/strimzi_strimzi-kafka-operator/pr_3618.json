{"pr_number": 3618, "pr_title": "A debugging guide", "pr_createdAt": "2020-09-09T07:11:21Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3618", "timeline": [{"oid": "9dd446e50319cd6102a42fc1b347d260cbab8678", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9dd446e50319cd6102a42fc1b347d260cbab8678", "message": "A debugging guide\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2020-09-09T07:02:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5MjA0OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3618#discussion_r485392049", "bodyText": "don't think that changing the local port is necessary, it could just confuse user that now should attach the debugger on localhost:5006 instead of 5005", "author": "ppatierno", "createdAt": "2020-09-09T07:20:54Z", "path": "development-docs/DEBUGGING.md", "diffHunk": "@@ -0,0 +1,188 @@\n+# Debugging Guide for Strimzi\n+\n+This guide primarily explains how to perform remote debugging of code deployed to Kubernetes with strimzi/operator image, and the strimzi/kafka images.\n+\n+<!-- TOC depthFrom:2 -->\n+\n+- [Activating remote debugging using the agent](#activating-remote-debugging-using-the-agent)\n+- [Remote debugging the Strimzi Cluster Operator](#remote-debugging-the-strimzi-cluster-operator)\n+- [Remote debugging the Kafka Broker](#remote-debugging-the-kafka-broker)\n+- [Using the IntelliJ IDEA for debugging](#using-the-intellij-idea-for-debugging)\n+  - [Setting the breakpoints](#setting-the-breakpoints)\n+  - [Evaluating expressions when suspended](#evaluating-expressions-when-suspended)\n+  - [Resolving code version mismatches](#resolving-code-version-mismatches)\n+\n+<!-- /TOC -->\n+\n+## Activating remote debugging using the agent\n+\n+Java runtime (the JVM) comes with an agent that provides support for remote debugging. Using you Java IDE you can connect to a remote process over a TCP connection, and perform debugging actions like setting breakpoints, suspending threads, gathering stack and heap info, and evaluating arbitrary java code inside the running JVM.\n+\n+In order to activate remote debugging the java process needs to be run with an additional argument like the following:\n+\n+    -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005\n+\n+This starts a TCP server on localhost using the specified port (5005 in this case). Connection is only possible from the localhost.\n+Because we used `suspend=y` the start up of the JVM will stall, and wait for the debug client to connect.\n+All the popular Java IDEs support remote debugging.\n+\n+\n+## Remote debugging the Strimzi Cluster Operator\n+\n+Strimzi Cluster Operator is installed through Deployment definition in `install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml`.\n+\n+We can enable remote debugging by adding the `JAVA_OPTS` environment variable to `strimzi-cluster-operator` container in this file:\n+\n+          env:\n+            ...\n+            - name: JAVA_OPTS\n+              value: \"-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005\"\n+\n+\n+Let's also increase the livenessProbe timeout:\n+\n+          livenessProbe:\n+            initialDelaySeconds: 3600\n+            timeoutSeconds: 3600\n+\n+Apply the modified file:\n+\n+    kubectl apply -f install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml\n+\n+We also need to open the port for localhost access:\n+\n+    kubectl port-forward $(oc get pod | grep strimzi-cluster-operator | awk '{printf $1}') 5006:5005", "originalCommit": "9dd446e50319cd6102a42fc1b347d260cbab8678", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQwNDYzMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3618#discussion_r485404631", "bodyText": "Good catch, not supposed to be like this - just I locally used it like this because I had two port-forwards of 5005 open at the same time.", "author": "mstruk", "createdAt": "2020-09-09T07:43:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5MjA0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5MjM0OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3618#discussion_r485392348", "bodyText": "any explanation on why? just for checking that the CO is now stopped and waiting for the remote session to be attached? is it worth to explain it?", "author": "ppatierno", "createdAt": "2020-09-09T07:21:29Z", "path": "development-docs/DEBUGGING.md", "diffHunk": "@@ -0,0 +1,188 @@\n+# Debugging Guide for Strimzi\n+\n+This guide primarily explains how to perform remote debugging of code deployed to Kubernetes with strimzi/operator image, and the strimzi/kafka images.\n+\n+<!-- TOC depthFrom:2 -->\n+\n+- [Activating remote debugging using the agent](#activating-remote-debugging-using-the-agent)\n+- [Remote debugging the Strimzi Cluster Operator](#remote-debugging-the-strimzi-cluster-operator)\n+- [Remote debugging the Kafka Broker](#remote-debugging-the-kafka-broker)\n+- [Using the IntelliJ IDEA for debugging](#using-the-intellij-idea-for-debugging)\n+  - [Setting the breakpoints](#setting-the-breakpoints)\n+  - [Evaluating expressions when suspended](#evaluating-expressions-when-suspended)\n+  - [Resolving code version mismatches](#resolving-code-version-mismatches)\n+\n+<!-- /TOC -->\n+\n+## Activating remote debugging using the agent\n+\n+Java runtime (the JVM) comes with an agent that provides support for remote debugging. Using you Java IDE you can connect to a remote process over a TCP connection, and perform debugging actions like setting breakpoints, suspending threads, gathering stack and heap info, and evaluating arbitrary java code inside the running JVM.\n+\n+In order to activate remote debugging the java process needs to be run with an additional argument like the following:\n+\n+    -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005\n+\n+This starts a TCP server on localhost using the specified port (5005 in this case). Connection is only possible from the localhost.\n+Because we used `suspend=y` the start up of the JVM will stall, and wait for the debug client to connect.\n+All the popular Java IDEs support remote debugging.\n+\n+\n+## Remote debugging the Strimzi Cluster Operator\n+\n+Strimzi Cluster Operator is installed through Deployment definition in `install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml`.\n+\n+We can enable remote debugging by adding the `JAVA_OPTS` environment variable to `strimzi-cluster-operator` container in this file:\n+\n+          env:\n+            ...\n+            - name: JAVA_OPTS\n+              value: \"-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005\"\n+\n+\n+Let's also increase the livenessProbe timeout:\n+\n+          livenessProbe:\n+            initialDelaySeconds: 3600\n+            timeoutSeconds: 3600\n+\n+Apply the modified file:\n+\n+    kubectl apply -f install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml\n+\n+We also need to open the port for localhost access:\n+\n+    kubectl port-forward $(oc get pod | grep strimzi-cluster-operator | awk '{printf $1}') 5006:5005\n+\n+Start tailing the operator pod:\n+\n+    oc logs $(oc get pod | grep strimzi-cluster-operator | awk '{printf $1}') -f ", "originalCommit": "9dd446e50319cd6102a42fc1b347d260cbab8678", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5NzgwMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3618#discussion_r485397803", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Java runtime (the JVM) comes with an agent that provides support for remote debugging. Using you Java IDE you can connect to a remote process over a TCP connection, and perform debugging actions like setting breakpoints, suspending threads, gathering stack and heap info, and evaluating arbitrary java code inside the running JVM.\n          \n          \n            \n            The Java runtime (the JVM) comes with an agent that provides support for remote debugging. Using your Java IDE you can connect to a remote process over a TCP connection, and perform debugging actions like setting breakpoints, suspending threads, gathering stack and heap info, and evaluating arbitrary Java code inside the running JVM.", "author": "tombentley", "createdAt": "2020-09-09T07:31:27Z", "path": "development-docs/DEBUGGING.md", "diffHunk": "@@ -0,0 +1,188 @@\n+# Debugging Guide for Strimzi\n+\n+This guide primarily explains how to perform remote debugging of code deployed to Kubernetes with strimzi/operator image, and the strimzi/kafka images.\n+\n+<!-- TOC depthFrom:2 -->\n+\n+- [Activating remote debugging using the agent](#activating-remote-debugging-using-the-agent)\n+- [Remote debugging the Strimzi Cluster Operator](#remote-debugging-the-strimzi-cluster-operator)\n+- [Remote debugging the Kafka Broker](#remote-debugging-the-kafka-broker)\n+- [Using the IntelliJ IDEA for debugging](#using-the-intellij-idea-for-debugging)\n+  - [Setting the breakpoints](#setting-the-breakpoints)\n+  - [Evaluating expressions when suspended](#evaluating-expressions-when-suspended)\n+  - [Resolving code version mismatches](#resolving-code-version-mismatches)\n+\n+<!-- /TOC -->\n+\n+## Activating remote debugging using the agent\n+\n+Java runtime (the JVM) comes with an agent that provides support for remote debugging. Using you Java IDE you can connect to a remote process over a TCP connection, and perform debugging actions like setting breakpoints, suspending threads, gathering stack and heap info, and evaluating arbitrary java code inside the running JVM.", "originalCommit": "9dd446e50319cd6102a42fc1b347d260cbab8678", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5ODI1Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3618#discussion_r485398257", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Strimzi Cluster Operator is installed through Deployment definition in `install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml`.\n          \n          \n            \n            Strimzi Cluster Operator is installed through the Deployment definition in `install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml`.", "author": "tombentley", "createdAt": "2020-09-09T07:32:18Z", "path": "development-docs/DEBUGGING.md", "diffHunk": "@@ -0,0 +1,188 @@\n+# Debugging Guide for Strimzi\n+\n+This guide primarily explains how to perform remote debugging of code deployed to Kubernetes with strimzi/operator image, and the strimzi/kafka images.\n+\n+<!-- TOC depthFrom:2 -->\n+\n+- [Activating remote debugging using the agent](#activating-remote-debugging-using-the-agent)\n+- [Remote debugging the Strimzi Cluster Operator](#remote-debugging-the-strimzi-cluster-operator)\n+- [Remote debugging the Kafka Broker](#remote-debugging-the-kafka-broker)\n+- [Using the IntelliJ IDEA for debugging](#using-the-intellij-idea-for-debugging)\n+  - [Setting the breakpoints](#setting-the-breakpoints)\n+  - [Evaluating expressions when suspended](#evaluating-expressions-when-suspended)\n+  - [Resolving code version mismatches](#resolving-code-version-mismatches)\n+\n+<!-- /TOC -->\n+\n+## Activating remote debugging using the agent\n+\n+Java runtime (the JVM) comes with an agent that provides support for remote debugging. Using you Java IDE you can connect to a remote process over a TCP connection, and perform debugging actions like setting breakpoints, suspending threads, gathering stack and heap info, and evaluating arbitrary java code inside the running JVM.\n+\n+In order to activate remote debugging the java process needs to be run with an additional argument like the following:\n+\n+    -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005\n+\n+This starts a TCP server on localhost using the specified port (5005 in this case). Connection is only possible from the localhost.\n+Because we used `suspend=y` the start up of the JVM will stall, and wait for the debug client to connect.\n+All the popular Java IDEs support remote debugging.\n+\n+\n+## Remote debugging the Strimzi Cluster Operator\n+\n+Strimzi Cluster Operator is installed through Deployment definition in `install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml`.", "originalCommit": "9dd446e50319cd6102a42fc1b347d260cbab8678", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5ODc1OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3618#discussion_r485398758", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Let's also increase the livenessProbe timeout:\n          \n          \n            \n            Let's also increase the livenessProbe timeout (to avoid Kubernetes restarting the pod if we're slow in attaching the debugger):", "author": "tombentley", "createdAt": "2020-09-09T07:33:17Z", "path": "development-docs/DEBUGGING.md", "diffHunk": "@@ -0,0 +1,188 @@\n+# Debugging Guide for Strimzi\n+\n+This guide primarily explains how to perform remote debugging of code deployed to Kubernetes with strimzi/operator image, and the strimzi/kafka images.\n+\n+<!-- TOC depthFrom:2 -->\n+\n+- [Activating remote debugging using the agent](#activating-remote-debugging-using-the-agent)\n+- [Remote debugging the Strimzi Cluster Operator](#remote-debugging-the-strimzi-cluster-operator)\n+- [Remote debugging the Kafka Broker](#remote-debugging-the-kafka-broker)\n+- [Using the IntelliJ IDEA for debugging](#using-the-intellij-idea-for-debugging)\n+  - [Setting the breakpoints](#setting-the-breakpoints)\n+  - [Evaluating expressions when suspended](#evaluating-expressions-when-suspended)\n+  - [Resolving code version mismatches](#resolving-code-version-mismatches)\n+\n+<!-- /TOC -->\n+\n+## Activating remote debugging using the agent\n+\n+Java runtime (the JVM) comes with an agent that provides support for remote debugging. Using you Java IDE you can connect to a remote process over a TCP connection, and perform debugging actions like setting breakpoints, suspending threads, gathering stack and heap info, and evaluating arbitrary java code inside the running JVM.\n+\n+In order to activate remote debugging the java process needs to be run with an additional argument like the following:\n+\n+    -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005\n+\n+This starts a TCP server on localhost using the specified port (5005 in this case). Connection is only possible from the localhost.\n+Because we used `suspend=y` the start up of the JVM will stall, and wait for the debug client to connect.\n+All the popular Java IDEs support remote debugging.\n+\n+\n+## Remote debugging the Strimzi Cluster Operator\n+\n+Strimzi Cluster Operator is installed through Deployment definition in `install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml`.\n+\n+We can enable remote debugging by adding the `JAVA_OPTS` environment variable to `strimzi-cluster-operator` container in this file:\n+\n+          env:\n+            ...\n+            - name: JAVA_OPTS\n+              value: \"-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005\"\n+\n+\n+Let's also increase the livenessProbe timeout:", "originalCommit": "9dd446e50319cd6102a42fc1b347d260cbab8678", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5OTI2NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3618#discussion_r485399265", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Kafka Broker pods are defined through 'my-cluster-kafka' StatefulSet which is created by Strimzi Kafka Operator.\n          \n          \n            \n            Kafka Broker pods are defined through the 'my-cluster-kafka' StatefulSet which is created by Strimzi Kafka Operator.", "author": "tombentley", "createdAt": "2020-09-09T07:34:15Z", "path": "development-docs/DEBUGGING.md", "diffHunk": "@@ -0,0 +1,188 @@\n+# Debugging Guide for Strimzi\n+\n+This guide primarily explains how to perform remote debugging of code deployed to Kubernetes with strimzi/operator image, and the strimzi/kafka images.\n+\n+<!-- TOC depthFrom:2 -->\n+\n+- [Activating remote debugging using the agent](#activating-remote-debugging-using-the-agent)\n+- [Remote debugging the Strimzi Cluster Operator](#remote-debugging-the-strimzi-cluster-operator)\n+- [Remote debugging the Kafka Broker](#remote-debugging-the-kafka-broker)\n+- [Using the IntelliJ IDEA for debugging](#using-the-intellij-idea-for-debugging)\n+  - [Setting the breakpoints](#setting-the-breakpoints)\n+  - [Evaluating expressions when suspended](#evaluating-expressions-when-suspended)\n+  - [Resolving code version mismatches](#resolving-code-version-mismatches)\n+\n+<!-- /TOC -->\n+\n+## Activating remote debugging using the agent\n+\n+Java runtime (the JVM) comes with an agent that provides support for remote debugging. Using you Java IDE you can connect to a remote process over a TCP connection, and perform debugging actions like setting breakpoints, suspending threads, gathering stack and heap info, and evaluating arbitrary java code inside the running JVM.\n+\n+In order to activate remote debugging the java process needs to be run with an additional argument like the following:\n+\n+    -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005\n+\n+This starts a TCP server on localhost using the specified port (5005 in this case). Connection is only possible from the localhost.\n+Because we used `suspend=y` the start up of the JVM will stall, and wait for the debug client to connect.\n+All the popular Java IDEs support remote debugging.\n+\n+\n+## Remote debugging the Strimzi Cluster Operator\n+\n+Strimzi Cluster Operator is installed through Deployment definition in `install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml`.\n+\n+We can enable remote debugging by adding the `JAVA_OPTS` environment variable to `strimzi-cluster-operator` container in this file:\n+\n+          env:\n+            ...\n+            - name: JAVA_OPTS\n+              value: \"-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005\"\n+\n+\n+Let's also increase the livenessProbe timeout:\n+\n+          livenessProbe:\n+            initialDelaySeconds: 3600\n+            timeoutSeconds: 3600\n+\n+Apply the modified file:\n+\n+    kubectl apply -f install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml\n+\n+We also need to open the port for localhost access:\n+\n+    kubectl port-forward $(oc get pod | grep strimzi-cluster-operator | awk '{printf $1}') 5006:5005\n+\n+Start tailing the operator pod:\n+\n+    oc logs $(oc get pod | grep strimzi-cluster-operator | awk '{printf $1}') -f \n+\n+You can now start the remote debug session from your IDE.\n+\n+\n+## Remote debugging the Kafka Broker\n+\n+Kafka Broker pods are defined through 'my-cluster-kafka' StatefulSet which is created by Strimzi Kafka Operator.", "originalCommit": "9dd446e50319cd6102a42fc1b347d260cbab8678", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQwMDI3Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3618#discussion_r485400277", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Before remotely connecting with IDE you'll want to start tailing the `my-cluster-kafka-0` broker pod:\n          \n          \n            \n            Before remotely connecting with your IDE you'll want to start tailing the `my-cluster-kafka-0` broker pod:", "author": "tombentley", "createdAt": "2020-09-09T07:36:05Z", "path": "development-docs/DEBUGGING.md", "diffHunk": "@@ -0,0 +1,188 @@\n+# Debugging Guide for Strimzi\n+\n+This guide primarily explains how to perform remote debugging of code deployed to Kubernetes with strimzi/operator image, and the strimzi/kafka images.\n+\n+<!-- TOC depthFrom:2 -->\n+\n+- [Activating remote debugging using the agent](#activating-remote-debugging-using-the-agent)\n+- [Remote debugging the Strimzi Cluster Operator](#remote-debugging-the-strimzi-cluster-operator)\n+- [Remote debugging the Kafka Broker](#remote-debugging-the-kafka-broker)\n+- [Using the IntelliJ IDEA for debugging](#using-the-intellij-idea-for-debugging)\n+  - [Setting the breakpoints](#setting-the-breakpoints)\n+  - [Evaluating expressions when suspended](#evaluating-expressions-when-suspended)\n+  - [Resolving code version mismatches](#resolving-code-version-mismatches)\n+\n+<!-- /TOC -->\n+\n+## Activating remote debugging using the agent\n+\n+Java runtime (the JVM) comes with an agent that provides support for remote debugging. Using you Java IDE you can connect to a remote process over a TCP connection, and perform debugging actions like setting breakpoints, suspending threads, gathering stack and heap info, and evaluating arbitrary java code inside the running JVM.\n+\n+In order to activate remote debugging the java process needs to be run with an additional argument like the following:\n+\n+    -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005\n+\n+This starts a TCP server on localhost using the specified port (5005 in this case). Connection is only possible from the localhost.\n+Because we used `suspend=y` the start up of the JVM will stall, and wait for the debug client to connect.\n+All the popular Java IDEs support remote debugging.\n+\n+\n+## Remote debugging the Strimzi Cluster Operator\n+\n+Strimzi Cluster Operator is installed through Deployment definition in `install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml`.\n+\n+We can enable remote debugging by adding the `JAVA_OPTS` environment variable to `strimzi-cluster-operator` container in this file:\n+\n+          env:\n+            ...\n+            - name: JAVA_OPTS\n+              value: \"-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005\"\n+\n+\n+Let's also increase the livenessProbe timeout:\n+\n+          livenessProbe:\n+            initialDelaySeconds: 3600\n+            timeoutSeconds: 3600\n+\n+Apply the modified file:\n+\n+    kubectl apply -f install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml\n+\n+We also need to open the port for localhost access:\n+\n+    kubectl port-forward $(oc get pod | grep strimzi-cluster-operator | awk '{printf $1}') 5006:5005\n+\n+Start tailing the operator pod:\n+\n+    oc logs $(oc get pod | grep strimzi-cluster-operator | awk '{printf $1}') -f \n+\n+You can now start the remote debug session from your IDE.\n+\n+\n+## Remote debugging the Kafka Broker\n+\n+Kafka Broker pods are defined through 'my-cluster-kafka' StatefulSet which is created by Strimzi Kafka Operator.\n+\n+In order to activate the remote debugging we need to get the Kafka Broker to run with remote debugging agent activated.\n+\n+This can be achieved by adding the following to your Kafka CR cluster definition:\n+\n+```\n+\n+spec:\n+  kafka:\n+    ...\n+\n+    livenessProbe:\n+      initialDelaySeconds: 3600\n+      timeoutSeconds: 3600\n+    template:\n+      kafkaContainer:\n+        env:\n+        - name: KAFKA_DEBUG\n+          value: \"y\"\n+        - name: DEBUG_SUSPEND_FLAG\n+          value: \"y\"\n+        - name: JAVA_DEBUG_PORT\n+          value: \"5005\"\n+\n+```\n+\n+We also need to open the specified port (5005 in this case) to be reachable from your host machine:\n+\n+    kubectl port-forward my-cluster-kafka-0 5005\n+\n+If you want to map to a different local port use the LOCAL:REMOTE format, for example:\n+\n+    kubectl port-forward my-cluster-kafka-0 8787:5005\n+\n+All you now have to do is deploy the new Kafka cluster definition, configure remote debugging in your favourite IDE, telling it to connect to localhost:5005, and start your debug session.\n+\n+With `DEBUG_SUSPEND_FLAG` set to 'y', the Kafka Broker process will wait during startup for remote degugger (IDE) to connect before continuing with JVM start up.\n+\n+In Kafka CR we have adjusted the probes to prevent Kubernetes from killing the broker whose execution is suspended due to a breakpoint.\n+\n+Before remotely connecting with IDE you'll want to start tailing the `my-cluster-kafka-0` broker pod:", "originalCommit": "9dd446e50319cd6102a42fc1b347d260cbab8678", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ2ODA2Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3618#discussion_r485468067", "bodyText": "for remote degugger typo", "author": "michalxo", "createdAt": "2020-09-09T09:21:59Z", "path": "development-docs/DEBUGGING.md", "diffHunk": "@@ -0,0 +1,188 @@\n+# Debugging Guide for Strimzi\n+\n+This guide primarily explains how to perform remote debugging of code deployed to Kubernetes with strimzi/operator image, and the strimzi/kafka images.\n+\n+<!-- TOC depthFrom:2 -->\n+\n+- [Activating remote debugging using the agent](#activating-remote-debugging-using-the-agent)\n+- [Remote debugging the Strimzi Cluster Operator](#remote-debugging-the-strimzi-cluster-operator)\n+- [Remote debugging the Kafka Broker](#remote-debugging-the-kafka-broker)\n+- [Using the IntelliJ IDEA for debugging](#using-the-intellij-idea-for-debugging)\n+  - [Setting the breakpoints](#setting-the-breakpoints)\n+  - [Evaluating expressions when suspended](#evaluating-expressions-when-suspended)\n+  - [Resolving code version mismatches](#resolving-code-version-mismatches)\n+\n+<!-- /TOC -->\n+\n+## Activating remote debugging using the agent\n+\n+Java runtime (the JVM) comes with an agent that provides support for remote debugging. Using you Java IDE you can connect to a remote process over a TCP connection, and perform debugging actions like setting breakpoints, suspending threads, gathering stack and heap info, and evaluating arbitrary java code inside the running JVM.\n+\n+In order to activate remote debugging the java process needs to be run with an additional argument like the following:\n+\n+    -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005\n+\n+This starts a TCP server on localhost using the specified port (5005 in this case). Connection is only possible from the localhost.\n+Because we used `suspend=y` the start up of the JVM will stall, and wait for the debug client to connect.\n+All the popular Java IDEs support remote debugging.\n+\n+\n+## Remote debugging the Strimzi Cluster Operator\n+\n+Strimzi Cluster Operator is installed through Deployment definition in `install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml`.\n+\n+We can enable remote debugging by adding the `JAVA_OPTS` environment variable to `strimzi-cluster-operator` container in this file:\n+\n+          env:\n+            ...\n+            - name: JAVA_OPTS\n+              value: \"-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005\"\n+\n+\n+Let's also increase the livenessProbe timeout:\n+\n+          livenessProbe:\n+            initialDelaySeconds: 3600\n+            timeoutSeconds: 3600\n+\n+Apply the modified file:\n+\n+    kubectl apply -f install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml\n+\n+We also need to open the port for localhost access:\n+\n+    kubectl port-forward $(oc get pod | grep strimzi-cluster-operator | awk '{printf $1}') 5006:5005\n+\n+Start tailing the operator pod:\n+\n+    oc logs $(oc get pod | grep strimzi-cluster-operator | awk '{printf $1}') -f \n+\n+You can now start the remote debug session from your IDE.\n+\n+\n+## Remote debugging the Kafka Broker\n+\n+Kafka Broker pods are defined through 'my-cluster-kafka' StatefulSet which is created by Strimzi Kafka Operator.\n+\n+In order to activate the remote debugging we need to get the Kafka Broker to run with remote debugging agent activated.\n+\n+This can be achieved by adding the following to your Kafka CR cluster definition:\n+\n+```\n+\n+spec:\n+  kafka:\n+    ...\n+\n+    livenessProbe:\n+      initialDelaySeconds: 3600\n+      timeoutSeconds: 3600\n+    template:\n+      kafkaContainer:\n+        env:\n+        - name: KAFKA_DEBUG\n+          value: \"y\"\n+        - name: DEBUG_SUSPEND_FLAG\n+          value: \"y\"\n+        - name: JAVA_DEBUG_PORT\n+          value: \"5005\"\n+\n+```\n+\n+We also need to open the specified port (5005 in this case) to be reachable from your host machine:\n+\n+    kubectl port-forward my-cluster-kafka-0 5005\n+\n+If you want to map to a different local port use the LOCAL:REMOTE format, for example:\n+\n+    kubectl port-forward my-cluster-kafka-0 8787:5005\n+\n+All you now have to do is deploy the new Kafka cluster definition, configure remote debugging in your favourite IDE, telling it to connect to localhost:5005, and start your debug session.\n+\n+With `DEBUG_SUSPEND_FLAG` set to 'y', the Kafka Broker process will wait during startup for remote degugger (IDE) to connect before continuing with JVM start up.", "originalCommit": "9dd446e50319cd6102a42fc1b347d260cbab8678", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "af53c972f3146bb8a4b30801c6970f2989739e8c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/af53c972f3146bb8a4b30801c6970f2989739e8c", "message": "Apply suggestions from code review\n\nCo-authored-by: Tom Bentley <tombentley@users.noreply.github.com>\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2020-09-09T09:22:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ2OTAyNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3618#discussion_r485469026", "bodyText": "Is there any option I can set to make this wait longer?", "author": "michalxo", "createdAt": "2020-09-09T09:23:27Z", "path": "development-docs/DEBUGGING.md", "diffHunk": "@@ -0,0 +1,188 @@\n+# Debugging Guide for Strimzi\n+\n+This guide primarily explains how to perform remote debugging of code deployed to Kubernetes with strimzi/operator image, and the strimzi/kafka images.\n+\n+<!-- TOC depthFrom:2 -->\n+\n+- [Activating remote debugging using the agent](#activating-remote-debugging-using-the-agent)\n+- [Remote debugging the Strimzi Cluster Operator](#remote-debugging-the-strimzi-cluster-operator)\n+- [Remote debugging the Kafka Broker](#remote-debugging-the-kafka-broker)\n+- [Using the IntelliJ IDEA for debugging](#using-the-intellij-idea-for-debugging)\n+  - [Setting the breakpoints](#setting-the-breakpoints)\n+  - [Evaluating expressions when suspended](#evaluating-expressions-when-suspended)\n+  - [Resolving code version mismatches](#resolving-code-version-mismatches)\n+\n+<!-- /TOC -->\n+\n+## Activating remote debugging using the agent\n+\n+Java runtime (the JVM) comes with an agent that provides support for remote debugging. Using you Java IDE you can connect to a remote process over a TCP connection, and perform debugging actions like setting breakpoints, suspending threads, gathering stack and heap info, and evaluating arbitrary java code inside the running JVM.\n+\n+In order to activate remote debugging the java process needs to be run with an additional argument like the following:\n+\n+    -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005\n+\n+This starts a TCP server on localhost using the specified port (5005 in this case). Connection is only possible from the localhost.\n+Because we used `suspend=y` the start up of the JVM will stall, and wait for the debug client to connect.\n+All the popular Java IDEs support remote debugging.\n+\n+\n+## Remote debugging the Strimzi Cluster Operator\n+\n+Strimzi Cluster Operator is installed through Deployment definition in `install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml`.\n+\n+We can enable remote debugging by adding the `JAVA_OPTS` environment variable to `strimzi-cluster-operator` container in this file:\n+\n+          env:\n+            ...\n+            - name: JAVA_OPTS\n+              value: \"-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005\"\n+\n+\n+Let's also increase the livenessProbe timeout:\n+\n+          livenessProbe:\n+            initialDelaySeconds: 3600\n+            timeoutSeconds: 3600\n+\n+Apply the modified file:\n+\n+    kubectl apply -f install/cluster-operator/060-Deployment-strimzi-cluster-operator.yaml\n+\n+We also need to open the port for localhost access:\n+\n+    kubectl port-forward $(oc get pod | grep strimzi-cluster-operator | awk '{printf $1}') 5006:5005\n+\n+Start tailing the operator pod:\n+\n+    oc logs $(oc get pod | grep strimzi-cluster-operator | awk '{printf $1}') -f \n+\n+You can now start the remote debug session from your IDE.\n+\n+\n+## Remote debugging the Kafka Broker\n+\n+Kafka Broker pods are defined through 'my-cluster-kafka' StatefulSet which is created by Strimzi Kafka Operator.\n+\n+In order to activate the remote debugging we need to get the Kafka Broker to run with remote debugging agent activated.\n+\n+This can be achieved by adding the following to your Kafka CR cluster definition:\n+\n+```\n+\n+spec:\n+  kafka:\n+    ...\n+\n+    livenessProbe:\n+      initialDelaySeconds: 3600\n+      timeoutSeconds: 3600\n+    template:\n+      kafkaContainer:\n+        env:\n+        - name: KAFKA_DEBUG\n+          value: \"y\"\n+        - name: DEBUG_SUSPEND_FLAG\n+          value: \"y\"\n+        - name: JAVA_DEBUG_PORT\n+          value: \"5005\"\n+\n+```\n+\n+We also need to open the specified port (5005 in this case) to be reachable from your host machine:\n+\n+    kubectl port-forward my-cluster-kafka-0 5005\n+\n+If you want to map to a different local port use the LOCAL:REMOTE format, for example:\n+\n+    kubectl port-forward my-cluster-kafka-0 8787:5005\n+\n+All you now have to do is deploy the new Kafka cluster definition, configure remote debugging in your favourite IDE, telling it to connect to localhost:5005, and start your debug session.\n+\n+With `DEBUG_SUSPEND_FLAG` set to 'y', the Kafka Broker process will wait during startup for remote degugger (IDE) to connect before continuing with JVM start up.\n+\n+In Kafka CR we have adjusted the probes to prevent Kubernetes from killing the broker whose execution is suspended due to a breakpoint.\n+\n+Before remotely connecting with IDE you'll want to start tailing the `my-cluster-kafka-0` broker pod:\n+\n+    kubectl logs my-cluster-kafka-0 -f\n+\n+You should see the following as the last line:\n+\n+    Listening for transport dt_socket at address: 5005\n+\n+You can now start a remote debug session from your IDE.\n+\n+Note: Apache Kafka is written in a way that it detects stalled request processing threads and may exit the JVM that appears to have stalled.", "originalCommit": "9dd446e50319cd6102a42fc1b347d260cbab8678", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ3NDMzMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3618#discussion_r485474331", "bodyText": "Maybe using 'Suspend All (threads)' breakpoint option would help - if all threads are suspended the one doing the shutdown can't trigger it. But it would trigger it as soon as you let the thread continue a normal execution (the green play button). Maybe there are some low level settings to prolong the tolerated request thread stall. Maybe check the upstream Kafka docs.", "author": "mstruk", "createdAt": "2020-09-09T09:31:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ2OTAyNg=="}], "type": "inlineReview"}, {"oid": "3bff7ff78acaca114f5a7a2ac6a527eaf31da42a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3bff7ff78acaca114f5a7a2ac6a527eaf31da42a", "message": "Minor changes\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2020-09-09T09:26:40Z", "type": "commit"}, {"oid": "3bff7ff78acaca114f5a7a2ac6a527eaf31da42a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3bff7ff78acaca114f5a7a2ac6a527eaf31da42a", "message": "Minor changes\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2020-09-09T09:26:40Z", "type": "forcePushed"}, {"oid": "d63dbc29b24d911ba4355576887b351cb5439519", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d63dbc29b24d911ba4355576887b351cb5439519", "message": "Typo\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>", "committedDate": "2020-09-09T09:39:11Z", "type": "commit"}]}