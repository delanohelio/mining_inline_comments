{"pr_number": 3924, "pr_title": "[systemtest] Test for user's secret prefix", "pr_createdAt": "2020-11-05T11:58:05Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3924", "timeline": [{"oid": "d1a29ffde480634bbdeef015683eda162918e862", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d1a29ffde480634bbdeef015683eda162918e862", "message": "add test for user secret prefix\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-11-05T11:54:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk5OTAxMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3924#discussion_r517999010", "bodyText": "Should you check the actual deletion in addition to this?", "author": "scholzj", "createdAt": "2020-11-05T12:01:03Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/user/UserST.java", "diffHunk": "@@ -216,6 +217,42 @@ void testUserWithQuotas(KafkaUser user) {\n         });\n     }\n \n+    @Test\n+    void testCreatingUsersWithSecretPrefix() {\n+        String clusterName = \"second-cluster\";\n+        String secretPrefix = \"top-secret-\";\n+        String tlsUserName = \"encrypted-leopold\";\n+        String scramShaUserName = \"scramed-leopold\";\n+\n+        KafkaResource.kafkaEphemeral(clusterName, 3)\n+            .editSpec()\n+                .editEntityOperator()\n+                    .editUserOperator()\n+                        .withNewSecretPrefix(secretPrefix)\n+                    .endUserOperator()\n+                .endEntityOperator()\n+            .endSpec()\n+            .done();\n+\n+        KafkaUserResource.tlsUser(clusterName, tlsUserName).done();\n+        KafkaUserResource.scramShaUser(clusterName, scramShaUserName).done();\n+\n+        Secret tlsSecret = kubeClient().getSecret(secretPrefix + tlsUserName);\n+        Secret scramShaSecret = kubeClient().getSecret(secretPrefix + scramShaUserName);\n+\n+        LOGGER.info(\"Checking if user secrets with secret prefixes exists\");\n+        assertNotNull(tlsSecret);\n+        assertNotNull(scramShaSecret);\n+\n+        LOGGER.info(\"Checking if secrets contains right user names\");\n+        assertThat(tlsSecret.getMetadata().getOwnerReferences().get(0).getName(), is(tlsUserName));\n+        assertThat(scramShaSecret.getMetadata().getOwnerReferences().get(0).getName(), is(scramShaUserName));", "originalCommit": "d1a29ffde480634bbdeef015683eda162918e862", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk5OTU0Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3924#discussion_r517999542", "bodyText": "Not sure I see the point of this. The KafkaUser resources are created by you on line 237+238. So you are just checking if you used the right name there. What you really want to check is the username in Kafka and CN of the certificate I guess.", "author": "scholzj", "createdAt": "2020-11-05T12:01:56Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/user/UserST.java", "diffHunk": "@@ -216,6 +217,42 @@ void testUserWithQuotas(KafkaUser user) {\n         });\n     }\n \n+    @Test\n+    void testCreatingUsersWithSecretPrefix() {\n+        String clusterName = \"second-cluster\";\n+        String secretPrefix = \"top-secret-\";\n+        String tlsUserName = \"encrypted-leopold\";\n+        String scramShaUserName = \"scramed-leopold\";\n+\n+        KafkaResource.kafkaEphemeral(clusterName, 3)\n+            .editSpec()\n+                .editEntityOperator()\n+                    .editUserOperator()\n+                        .withNewSecretPrefix(secretPrefix)\n+                    .endUserOperator()\n+                .endEntityOperator()\n+            .endSpec()\n+            .done();\n+\n+        KafkaUserResource.tlsUser(clusterName, tlsUserName).done();\n+        KafkaUserResource.scramShaUser(clusterName, scramShaUserName).done();\n+\n+        Secret tlsSecret = kubeClient().getSecret(secretPrefix + tlsUserName);\n+        Secret scramShaSecret = kubeClient().getSecret(secretPrefix + scramShaUserName);\n+\n+        LOGGER.info(\"Checking if user secrets with secret prefixes exists\");\n+        assertNotNull(tlsSecret);\n+        assertNotNull(scramShaSecret);\n+\n+        LOGGER.info(\"Checking if secrets contains right user names\");\n+        assertThat(tlsSecret.getMetadata().getOwnerReferences().get(0).getName(), is(tlsUserName));\n+        assertThat(scramShaSecret.getMetadata().getOwnerReferences().get(0).getName(), is(scramShaUserName));\n+\n+        LOGGER.info(\"Checking if users are created without the secret prefixes\");\n+        assertNotNull(KafkaUserResource.kafkaUserClient().inNamespace(NAMESPACE).withName(tlsUserName).get());\n+        assertNotNull(KafkaUserResource.kafkaUserClient().inNamespace(NAMESPACE).withName(scramShaUserName).get());", "originalCommit": "d1a29ffde480634bbdeef015683eda162918e862", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk5OTg1MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3924#discussion_r517999851", "bodyText": "Is there any first cluster?", "author": "scholzj", "createdAt": "2020-11-05T12:02:33Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/user/UserST.java", "diffHunk": "@@ -216,6 +217,42 @@ void testUserWithQuotas(KafkaUser user) {\n         });\n     }\n \n+    @Test\n+    void testCreatingUsersWithSecretPrefix() {\n+        String clusterName = \"second-cluster\";", "originalCommit": "d1a29ffde480634bbdeef015683eda162918e862", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAwMjAyNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3924#discussion_r518002025", "bodyText": "Yes, here:\nprivate void deployTestSpecificResources() {\n        KafkaResource.kafkaEphemeral(CLUSTER_NAME, 1, 1).done();\n    }\n\nThat's for other tests, so I guess it's better to have different kafka cluster here.\nThe method is used in @BeforeAll block**", "author": "im-konge", "createdAt": "2020-11-05T12:06:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk5OTg1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODExNDU4Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3924#discussion_r518114586", "bodyText": "Soooo ... I can live with it if that is really what you want to do. But this is kinda mess to create one cluster before all here, the next one inside test etc. It makes the tests hard to read and understand but also debug. Probably outside the scope of this PR, but it would be good to have this done in some more clear way and maybe not mix the tests in one class etc.", "author": "scholzj", "createdAt": "2020-11-05T14:57:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk5OTg1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczMTU0MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3924#discussion_r519731540", "bodyText": "I'll take a look at it and try to separate it to two suites, if it'll make sense. Thanks for this spot.", "author": "im-konge", "createdAt": "2020-11-09T11:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk5OTg1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTczMzc1Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3924#discussion_r519733757", "bodyText": "Anyway, as I said, that is more general readability ... feel free to leave it for later, it does not need to be addressed in this PR.", "author": "scholzj", "createdAt": "2020-11-09T11:19:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk5OTg1MQ=="}], "type": "inlineReview"}, {"oid": "be1724891319d9f086500c6ef7f73a13c4900c1c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/be1724891319d9f086500c6ef7f73a13c4900c1c", "message": "comments and adding prefix for secret to clients\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-11-09T15:58:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA2MzU4OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3924#discussion_r520063589", "bodyText": "Should you try to send/receive also for the SCRAM user?", "author": "scholzj", "createdAt": "2020-11-09T19:23:56Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/user/UserST.java", "diffHunk": "@@ -216,6 +223,85 @@ void testUserWithQuotas(KafkaUser user) {\n         });\n     }\n \n+    @Test\n+    void testCreatingUsersWithSecretPrefix() {\n+        String clusterName = \"second-cluster\";\n+        String secretPrefix = \"top-secret-\";\n+        String tlsUserName = \"encrypted-leopold\";\n+        String scramShaUserName = \"scramed-leopold\";\n+\n+        KafkaResource.kafkaEphemeral(clusterName, 3)\n+            .editSpec()\n+                .editKafka()\n+                    .withNewListeners()\n+                        .addNewGenericKafkaListener()\n+                            .withName(Constants.TLS_LISTENER_DEFAULT_NAME)\n+                            .withPort(9093)\n+                            .withType(KafkaListenerType.INTERNAL)\n+                            .withTls(true)\n+                            .withNewKafkaListenerAuthenticationTlsAuth()\n+                            .endKafkaListenerAuthenticationTlsAuth()\n+                        .endGenericKafkaListener()\n+                    .endListeners()\n+                .endKafka()\n+                .editEntityOperator()\n+                    .editUserOperator()\n+                        .withNewSecretPrefix(secretPrefix)\n+                    .endUserOperator()\n+                .endEntityOperator()\n+            .endSpec()\n+            .done();\n+\n+        KafkaTopicResource.topic(clusterName, TOPIC_NAME).done();\n+        KafkaUser tlsUser = KafkaUserResource.tlsUser(clusterName, tlsUserName).done();\n+        KafkaUserResource.scramShaUser(clusterName, scramShaUserName).done();\n+\n+        KafkaClientsResource.deployKafkaClients(true, clusterName + \"-\" + Constants.KAFKA_CLIENTS, true, null, secretPrefix, tlsUser).done();\n+        String kafkaClientsName = kubeClient().listPodsByPrefixInName(clusterName + \"-\" + Constants.KAFKA_CLIENTS).get(0).getMetadata().getName();\n+\n+        InternalKafkaClient internalKafkaClient = new InternalKafkaClient.Builder()\n+            .withUsingPodName(kafkaClientsName)\n+            .withNamespaceName(NAMESPACE)\n+            .withTopicName(TOPIC_NAME)\n+            .withKafkaUsername(tlsUserName)\n+            .withSecurityProtocol(SecurityProtocol.SASL_SSL)\n+            .withListenerName(Constants.TLS_LISTENER_DEFAULT_NAME)\n+            .withClusterName(clusterName)\n+            .withMessageCount(MESSAGE_COUNT)\n+            .withSecretPrefix(secretPrefix)\n+            .build();\n+\n+        internalKafkaClient.assertSentAndReceivedMessages(\n+            internalKafkaClient.sendMessagesTls(),\n+            internalKafkaClient.receiveMessagesTls()\n+        );", "originalCommit": "be1724891319d9f086500c6ef7f73a13c4900c1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM2NTAyMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3924#discussion_r521365022", "bodyText": "Yes, I wanted to add it :) thanks", "author": "im-konge", "createdAt": "2020-11-11T13:41:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA2MzU4OQ=="}], "type": "inlineReview"}, {"oid": "49a85788333558d2491518439b0f737bfe231a2b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/49a85788333558d2491518439b0f737bfe231a2b", "message": "add sending messages for scram-sha\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-11-11T13:40:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM5MDA5Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3924#discussion_r521390096", "bodyText": "Should this be SASL_PLAINTEXT?", "author": "scholzj", "createdAt": "2020-11-11T14:20:23Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/user/UserST.java", "diffHunk": "@@ -216,6 +223,112 @@ void testUserWithQuotas(KafkaUser user) {\n         });\n     }\n \n+    @Test\n+    void testCreatingUsersWithSecretPrefix() {\n+        String clusterName = \"second-cluster\";\n+        String secretPrefix = \"top-secret-\";\n+        String tlsUserName = \"encrypted-leopold\";\n+        String scramShaUserName = \"scramed-leopold\";\n+\n+        KafkaResource.kafkaEphemeral(clusterName, 3)\n+            .editSpec()\n+                .editKafka()\n+                    .withNewListeners()\n+                        .addNewGenericKafkaListener()\n+                            .withName(Constants.PLAIN_LISTENER_DEFAULT_NAME)\n+                            .withPort(9092)\n+                            .withType(KafkaListenerType.INTERNAL)\n+                            .withTls(false)\n+                            .withNewKafkaListenerAuthenticationScramSha512Auth()\n+                            .endKafkaListenerAuthenticationScramSha512Auth()\n+                        .endGenericKafkaListener()\n+                        .addNewGenericKafkaListener()\n+                            .withName(Constants.TLS_LISTENER_DEFAULT_NAME)\n+                            .withPort(9093)\n+                            .withType(KafkaListenerType.INTERNAL)\n+                            .withTls(true)\n+                            .withNewKafkaListenerAuthenticationTlsAuth()\n+                            .endKafkaListenerAuthenticationTlsAuth()\n+                        .endGenericKafkaListener()\n+                    .endListeners()\n+                .endKafka()\n+                .editEntityOperator()\n+                    .editUserOperator()\n+                        .withNewSecretPrefix(secretPrefix)\n+                    .endUserOperator()\n+                .endEntityOperator()\n+            .endSpec()\n+            .done();\n+\n+        KafkaTopicResource.topic(clusterName, TOPIC_NAME).done();\n+        KafkaUser tlsUser = KafkaUserResource.tlsUser(clusterName, tlsUserName).done();\n+        KafkaUser scramShaUser = KafkaUserResource.scramShaUser(clusterName, scramShaUserName).done();\n+\n+        LOGGER.info(\"Deploying KafkaClients pod for TLS listener\");\n+        KafkaClientsResource.deployKafkaClients(true, clusterName + \"-tls-\" + Constants.KAFKA_CLIENTS, true, Constants.TLS_LISTENER_DEFAULT_NAME, secretPrefix, tlsUser).done();\n+        String tlsKafkaClientsName = kubeClient().listPodsByPrefixInName(clusterName + \"-tls-\" + Constants.KAFKA_CLIENTS).get(0).getMetadata().getName();\n+\n+        LOGGER.info(\"Deploying KafkaClients pod for PLAIN listener\");\n+        KafkaClientsResource.deployKafkaClients(false, clusterName + \"-plain-\" + Constants.KAFKA_CLIENTS, true, Constants.PLAIN_LISTENER_DEFAULT_NAME, secretPrefix, scramShaUser).done();\n+        String plainKafkaClientsName = kubeClient().listPodsByPrefixInName(clusterName + \"-plain-\" + Constants.KAFKA_CLIENTS).get(0).getMetadata().getName();\n+\n+        InternalKafkaClient internalKafkaClient = new InternalKafkaClient.Builder()\n+            .withUsingPodName(tlsKafkaClientsName)\n+            .withNamespaceName(NAMESPACE)\n+            .withTopicName(TOPIC_NAME)\n+            .withKafkaUsername(tlsUserName)\n+            .withSecurityProtocol(SecurityProtocol.SASL_SSL)\n+            .withListenerName(Constants.TLS_LISTENER_DEFAULT_NAME)\n+            .withClusterName(clusterName)\n+            .withMessageCount(MESSAGE_COUNT)\n+            .withSecretPrefix(secretPrefix)\n+            .build();\n+\n+        LOGGER.info(\"Checking if TLS user is able to send messages\");\n+        internalKafkaClient.assertSentAndReceivedMessages(\n+            internalKafkaClient.sendMessagesTls(),\n+            internalKafkaClient.receiveMessagesTls()\n+        );\n+\n+        internalKafkaClient = internalKafkaClient.toBuilder()\n+            .withUsingPodName(plainKafkaClientsName)\n+            .withSecurityProtocol(SecurityProtocol.PLAINTEXT)", "originalCommit": "49a85788333558d2491518439b0f737bfe231a2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM5MTA5Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3924#discussion_r521391092", "bodyText": "Should this be checked before sending the messages? It seems to me like a pre-requisite for it. Withotu the secrets, the clients should not work.", "author": "scholzj", "createdAt": "2020-11-11T14:21:46Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/user/UserST.java", "diffHunk": "@@ -216,6 +223,112 @@ void testUserWithQuotas(KafkaUser user) {\n         });\n     }\n \n+    @Test\n+    void testCreatingUsersWithSecretPrefix() {\n+        String clusterName = \"second-cluster\";\n+        String secretPrefix = \"top-secret-\";\n+        String tlsUserName = \"encrypted-leopold\";\n+        String scramShaUserName = \"scramed-leopold\";\n+\n+        KafkaResource.kafkaEphemeral(clusterName, 3)\n+            .editSpec()\n+                .editKafka()\n+                    .withNewListeners()\n+                        .addNewGenericKafkaListener()\n+                            .withName(Constants.PLAIN_LISTENER_DEFAULT_NAME)\n+                            .withPort(9092)\n+                            .withType(KafkaListenerType.INTERNAL)\n+                            .withTls(false)\n+                            .withNewKafkaListenerAuthenticationScramSha512Auth()\n+                            .endKafkaListenerAuthenticationScramSha512Auth()\n+                        .endGenericKafkaListener()\n+                        .addNewGenericKafkaListener()\n+                            .withName(Constants.TLS_LISTENER_DEFAULT_NAME)\n+                            .withPort(9093)\n+                            .withType(KafkaListenerType.INTERNAL)\n+                            .withTls(true)\n+                            .withNewKafkaListenerAuthenticationTlsAuth()\n+                            .endKafkaListenerAuthenticationTlsAuth()\n+                        .endGenericKafkaListener()\n+                    .endListeners()\n+                .endKafka()\n+                .editEntityOperator()\n+                    .editUserOperator()\n+                        .withNewSecretPrefix(secretPrefix)\n+                    .endUserOperator()\n+                .endEntityOperator()\n+            .endSpec()\n+            .done();\n+\n+        KafkaTopicResource.topic(clusterName, TOPIC_NAME).done();\n+        KafkaUser tlsUser = KafkaUserResource.tlsUser(clusterName, tlsUserName).done();\n+        KafkaUser scramShaUser = KafkaUserResource.scramShaUser(clusterName, scramShaUserName).done();\n+\n+        LOGGER.info(\"Deploying KafkaClients pod for TLS listener\");\n+        KafkaClientsResource.deployKafkaClients(true, clusterName + \"-tls-\" + Constants.KAFKA_CLIENTS, true, Constants.TLS_LISTENER_DEFAULT_NAME, secretPrefix, tlsUser).done();\n+        String tlsKafkaClientsName = kubeClient().listPodsByPrefixInName(clusterName + \"-tls-\" + Constants.KAFKA_CLIENTS).get(0).getMetadata().getName();\n+\n+        LOGGER.info(\"Deploying KafkaClients pod for PLAIN listener\");\n+        KafkaClientsResource.deployKafkaClients(false, clusterName + \"-plain-\" + Constants.KAFKA_CLIENTS, true, Constants.PLAIN_LISTENER_DEFAULT_NAME, secretPrefix, scramShaUser).done();\n+        String plainKafkaClientsName = kubeClient().listPodsByPrefixInName(clusterName + \"-plain-\" + Constants.KAFKA_CLIENTS).get(0).getMetadata().getName();\n+\n+        InternalKafkaClient internalKafkaClient = new InternalKafkaClient.Builder()\n+            .withUsingPodName(tlsKafkaClientsName)\n+            .withNamespaceName(NAMESPACE)\n+            .withTopicName(TOPIC_NAME)\n+            .withKafkaUsername(tlsUserName)\n+            .withSecurityProtocol(SecurityProtocol.SASL_SSL)\n+            .withListenerName(Constants.TLS_LISTENER_DEFAULT_NAME)\n+            .withClusterName(clusterName)\n+            .withMessageCount(MESSAGE_COUNT)\n+            .withSecretPrefix(secretPrefix)\n+            .build();\n+\n+        LOGGER.info(\"Checking if TLS user is able to send messages\");\n+        internalKafkaClient.assertSentAndReceivedMessages(\n+            internalKafkaClient.sendMessagesTls(),\n+            internalKafkaClient.receiveMessagesTls()\n+        );\n+\n+        internalKafkaClient = internalKafkaClient.toBuilder()\n+            .withUsingPodName(plainKafkaClientsName)\n+            .withSecurityProtocol(SecurityProtocol.PLAINTEXT)\n+            .withListenerName(Constants.PLAIN_LISTENER_DEFAULT_NAME)\n+            .withKafkaUsername(scramShaUserName)\n+            .build();\n+\n+        LOGGER.info(\"Checking if SCRAM-SHA user is able to send messages\");\n+        internalKafkaClient.assertSentAndReceivedMessages(\n+            internalKafkaClient.sendMessagesPlain(),\n+            internalKafkaClient.receiveMessagesPlain()\n+        );\n+\n+        Secret tlsSecret = kubeClient().getSecret(secretPrefix + tlsUserName);\n+        Secret scramShaSecret = kubeClient().getSecret(secretPrefix + scramShaUserName);\n+\n+        LOGGER.info(\"Checking if user secrets with secret prefixes exists\");\n+        assertNotNull(tlsSecret);\n+        assertNotNull(scramShaSecret);", "originalCommit": "49a85788333558d2491518439b0f737bfe231a2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d0da313db9a1c308d222d4799978bca05c3a0dae", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d0da313db9a1c308d222d4799978bca05c3a0dae", "message": "fixup! add sending messages for scram-sha\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-11-11T14:38:26Z", "type": "commit"}]}