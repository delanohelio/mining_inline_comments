{"pr_number": 3156, "pr_title": "[systemtest] testClusterCaRemovedTriggersRollingUpdate -> \"fix\"", "pr_createdAt": "2020-06-04T21:15:20Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156", "timeline": [{"oid": "be6d950437190066f8e1c4c13273492d37e6da00", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/be6d950437190066f8e1c4c13273492d37e6da00", "message": "move test from one suite to another\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-04T21:27:40Z", "type": "commit"}, {"oid": "be6d950437190066f8e1c4c13273492d37e6da00", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/be6d950437190066f8e1c4c13273492d37e6da00", "message": "move test from one suite to another\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-04T21:27:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2Mzk0Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#discussion_r435763946", "bodyText": "This scenario is a little niche, might it be useful to add a documented comment?\nAlso might we want to also unit test this scenario?", "author": "samuel-hawker", "createdAt": "2020-06-05T08:19:59Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/rollingupdate/ManualRollingUpdateST.java", "diffHunk": "@@ -144,6 +145,50 @@ void testManualTriggeringRollingUpdate() {\n         assertThat(received, is(sent));\n     }\n \n+    @Test\n+    void testRollingUpdateOnNextReconciliationAfterClusterCAKeyDel() {", "originalCommit": "be6d950437190066f8e1c4c13273492d37e6da00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3NjY5OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#discussion_r435776699", "bodyText": "Yeah, I can add it.\nI think the second part is for @scholzj", "author": "im-konge", "createdAt": "2020-06-05T08:43:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2Mzk0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc4MDc2Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#discussion_r435780767", "bodyText": "I guess everything can be unit tested ... But real E2E test has probably more value than something full of mocking etc. which is how the unit test would end. So I think we should definitely keep this ST and if someone writes UT as well, it would be just a bonus.", "author": "scholzj", "createdAt": "2020-06-05T08:50:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2Mzk0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg1Mjc4MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#discussion_r435852780", "bodyText": "I added the scenario as a comment, thanks :)", "author": "im-konge", "createdAt": "2020-06-05T11:11:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2Mzk0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NDgxNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#discussion_r435764816", "bodyText": "I would avoid using terms like accident, a delete in theory could be intentional.\nbest we cover cases of intentional or accidental removal and refer to it as zookeeperDeletedCert and kafkaDeletedCert ?", "author": "samuel-hawker", "createdAt": "2020-06-05T08:21:29Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/rollingupdate/ManualRollingUpdateST.java", "diffHunk": "@@ -144,6 +145,50 @@ void testManualTriggeringRollingUpdate() {\n         assertThat(received, is(sent));\n     }\n \n+    @Test\n+    void testRollingUpdateOnNextReconciliationAfterClusterCAKeyDel() {\n+        KafkaResource.kafkaPersistent(CLUSTER_NAME, 3, 3).done();\n+        String topicName = KafkaTopicUtils.generateRandomNameOfTopic();\n+        KafkaTopicResource.topic(CLUSTER_NAME, topicName, 2, 2).done();\n+\n+        KafkaUser user = KafkaUserResource.tlsUser(CLUSTER_NAME, USER_NAME).done();\n+\n+        KafkaClientsResource.deployKafkaClients(true, CLUSTER_NAME + \"-\" + Constants.KAFKA_CLIENTS, user).done();\n+        final String defaultKafkaClientsPodName =\n+            ResourceManager.kubeClient().listPodsByPrefixInName(CLUSTER_NAME + \"-\" + Constants.KAFKA_CLIENTS).get(0).getMetadata().getName();\n+\n+        InternalKafkaClient internalKafkaClient = new InternalKafkaClient.Builder()\n+            .withUsingPodName(defaultKafkaClientsPodName)\n+            .withTopicName(topicName)\n+            .withNamespaceName(NAMESPACE)\n+            .withClusterName(CLUSTER_NAME)\n+            .withMessageCount(MESSAGE_COUNT)\n+            .withKafkaUsername(USER_NAME)\n+            .build();\n+\n+        Map<String, String> kafkaPods = StatefulSetUtils.ssSnapshot(KafkaResources.kafkaStatefulSetName(CLUSTER_NAME));\n+        Map<String, String> zkPods = StatefulSetUtils.ssSnapshot(KafkaResources.zookeeperStatefulSetName(CLUSTER_NAME));\n+\n+        int sent = internalKafkaClient.sendMessagesTls();\n+        assertThat(sent, is(MESSAGE_COUNT));\n+\n+        String zkCrtBeforeAccident = kubeClient(NAMESPACE).getSecret(CLUSTER_NAME + \"-zookeeper-nodes\").getData().get(CLUSTER_NAME + \"-zookeeper-0.crt\");", "originalCommit": "be6d950437190066f8e1c4c13273492d37e6da00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NTE5NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#discussion_r435765194", "bodyText": "I am aware as well that you didn't write these, but if you're moving the code, we should think about enhancing it slightly if we can.", "author": "samuel-hawker", "createdAt": "2020-06-05T08:22:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NDgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTgzNDAxMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#discussion_r435834011", "bodyText": "I didn't but I'm glad for comments to make the test better. So don't worry. :)", "author": "im-konge", "createdAt": "2020-06-05T10:29:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NDgxNg=="}], "type": "inlineReview"}, {"oid": "395c24447ae22907e0442372e9d74297c1332ad8", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/395c24447ae22907e0442372e9d74297c1332ad8", "message": "add scenario comment and change the names of vars\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-05T11:13:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkxMzEzNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#discussion_r435913137", "bodyText": "I would prefer more structural comment like:\n\nSetup Kafka persistent with 3 replicas\nCreate KafkaUser\nRun producer and consumer to see if cluster is working\nRemove cluster CA key\nKafka and ZK pods should roll, wiat until rolling update finish\nCheck that CA certificates were renewed\nTry consumer, producer and consume rmeessages again with new certificates", "author": "Frawless", "createdAt": "2020-06-05T13:16:02Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/rollingupdate/ManualRollingUpdateST.java", "diffHunk": "@@ -144,6 +145,57 @@ void testManualTriggeringRollingUpdate() {\n         assertThat(received, is(sent));\n     }\n \n+    /**\n+     * Scenario of the test:\n+     * Firstly customer tries to send messages and checks if he is able to consume the messages,\n+     * then he delete the cluster CA key. Now should Kafka and Zookeper pods roll.\n+     * After the rolling update is done, the CA key/certificate should be renewed,\n+     * but should be different than the previous one. Then, again, he tries to\n+     * send messages with new generated cluster certificate.\n+     */", "originalCommit": "395c24447ae22907e0442372e9d74297c1332ad8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA2MTYxNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#discussion_r436061616", "bodyText": "100% agree with Frawless here, the scenario should be brief, precise and not meander.\nE.g.:\nContext of the test in a sentence\n1. Step 1\n2. Step 2\n...\n\nThis means that as the operator evolves if the mechanisms change the disconnect between the comments and the test code are easier to notice and correct or indeed to notice that he operator is not upholding the behaviour our tests are claiming it should have.", "author": "samuel-hawker", "createdAt": "2020-06-05T17:29:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkxMzEzNw=="}], "type": "inlineReview"}, {"oid": "ce5d530191be68b8b8155702a226939e3b320463", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ce5d530191be68b8b8155702a226939e3b320463", "message": "fixup! add scenario comment and change the names of vars\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-05T17:49:17Z", "type": "commit"}, {"oid": "b123bc4e50c6deea3cc4c0ba07498deaae585dcd", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b123bc4e50c6deea3cc4c0ba07498deaae585dcd", "message": "fixup! fixup! add scenario comment and change the names of vars\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-06-05T17:50:46Z", "type": "commit"}]}