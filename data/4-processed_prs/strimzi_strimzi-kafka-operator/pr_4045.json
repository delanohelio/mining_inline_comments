{"pr_number": 4045, "pr_title": "[systemtest] Tests for deploying Kafka and KafkaConnect without CRBs and enabled/disabled RackAware", "pr_createdAt": "2020-12-03T17:02:25Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045", "timeline": [{"oid": "21c223b9da3ad543716dd298875355ec74bf043e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/21c223b9da3ad543716dd298875355ec74bf043e", "message": "add tests for missing CRBs and some improvements to KafkaConnectResource and utils\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-12-03T16:20:34Z", "type": "commit"}, {"oid": "66765ee328ffc111d5d1e6e9ad14b6be99cc123a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/66765ee328ffc111d5d1e6e9ad14b6be99cc123a", "message": "fixup! add tests for missing CRBs and some improvements to KafkaConnectResource and utils\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-12-03T17:28:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5NTU2NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r535595565", "bodyText": "ClusterOpratorRBAC is better name from my POV", "author": "Frawless", "createdAt": "2020-12-03T20:50:00Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/ClusterOperatorST.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.systemtest.operators;\n+\n+import io.strimzi.api.kafka.model.status.Condition;\n+import io.strimzi.systemtest.AbstractST;\n+import io.strimzi.systemtest.resources.KubernetesResource;\n+import io.strimzi.systemtest.resources.ResourceManager;\n+import io.strimzi.systemtest.resources.crd.KafkaConnectResource;\n+import io.strimzi.systemtest.resources.crd.KafkaResource;\n+import io.strimzi.systemtest.resources.operator.BundleResource;\n+import io.strimzi.systemtest.utils.kafkaUtils.KafkaConnectUtils;\n+import io.strimzi.systemtest.utils.kafkaUtils.KafkaUtils;\n+import io.strimzi.test.TestUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+\n+import static io.strimzi.systemtest.Constants.CONNECT;\n+import static io.strimzi.systemtest.Constants.REGRESSION;\n+import static io.strimzi.systemtest.enums.CustomResourceStatus.NotReady;\n+import static io.strimzi.systemtest.resources.ResourceManager.cmdKubeClient;\n+import static io.strimzi.systemtest.resources.ResourceManager.kubeClient;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+@Tag(REGRESSION)\n+public class ClusterOperatorST extends AbstractST {", "originalCommit": "66765ee328ffc111d5d1e6e9ad14b6be99cc123a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4OTU2NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r535689564", "bodyText": "I thought that this will be suite also for another tests related just to CO ... but yes, this can be also the good one.", "author": "im-konge", "createdAt": "2020-12-03T22:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5NTU2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAxOTk0Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r536019942", "bodyText": "well other class in operators are for CO as well. Maybe even a different name would be better", "author": "Frawless", "createdAt": "2020-12-04T11:06:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5NTU2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjcwODQyOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r536708428", "bodyText": "Yeah I'll think about different name, good catch", "author": "im-konge", "createdAt": "2020-12-05T11:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5NTU2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQxNjA5MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r537416091", "bodyText": "Agreed with Jakub here, ClusterOpratorRbac is better here", "author": "samuel-hawker", "createdAt": "2020-12-07T11:01:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5NTU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5NzA4OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r535597089", "bodyText": "Shouldn't be allowNP based on env variable for NetowkrPolicies?", "author": "Frawless", "createdAt": "2020-12-03T20:51:24Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/resources/crd/KafkaConnectResource.java", "diffHunk": "@@ -87,8 +91,8 @@ private static KafkaConnectBuilder defaultKafkaConnect(KafkaConnect kafkaConnect\n             .endSpec();\n     }\n \n-    private static DoneableKafkaConnect deployKafkaConnect(KafkaConnect kafkaConnect) {\n-        if (Environment.DEFAULT_TO_DENY_NETWORK_POLICIES) {\n+    private static DoneableKafkaConnect deployKafkaConnect(KafkaConnect kafkaConnect, boolean allowNP) {", "originalCommit": "66765ee328ffc111d5d1e6e9ad14b6be99cc123a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTYwMDUzNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r535600536", "bodyText": "By default is on true, so you'll have to deploy KafkaClients pod even if you don't want to send/receive messages or do some requests on Connect's API. From my POV it's better to determine, if we want to deploy KafkaConnect with NP or without, to not create extra Clients pod.", "author": "im-konge", "createdAt": "2020-12-03T20:54:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5NzA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAyMDM5NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r536020395", "bodyText": "make sense. We should try to improve this thing with NP and clients pod, but not in this PR.", "author": "Frawless", "createdAt": "2020-12-04T11:07:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5NzA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMyMTM3Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r536321377", "bodyText": "Yep, that's what I planned, thanks", "author": "im-konge", "createdAt": "2020-12-04T19:14:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU5NzA4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQxNTI0Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r537415242", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static DoneableKafkaConnect deployKafkaConnect(KafkaConnect kafkaConnect, boolean allowNP) {\n          \n          \n            \n                    if (Environment.DEFAULT_TO_DENY_NETWORK_POLICIES && allowNP) {\n          \n          \n            \n                        KubernetesResource.allowNetworkPolicySettingsForResource(kafkaConnect, KafkaConnectResources.deploymentName(kafkaConnect.getMetadata().getName()));\n          \n          \n            \n                    }\n          \n          \n            \n                    return new DoneableKafkaConnect(kafkaConnect, kC -> {\n          \n          \n            \n                private static DoneableKafkaConnect deployKafkaConnectWithNetworkPolicy(KafkaConnect kafkaConnect) {\n          \n          \n            \n                    if (Environment.DEFAULT_TO_DENY_NETWORK_POLICIES && allowNP) {\n          \n          \n            \n                        KubernetesResource.allowNetworkPolicySettingsForResource(kafkaConnect, KafkaConnectResources.deploymentName(kafkaConnect.getMetadata().getName()));\n          \n          \n            \n                    }\n          \n          \n            \n                    return deployKafkaConnect(kafkaConnect)\n          \n          \n            \n                  }\n          \n          \n            \n            \n          \n          \n            \n                private static DoneableKafkaConnect deployKafkaConnect(KafkaConnect kafkaConnect) {\n          \n          \n            \n                    return new DoneableKafkaConnect(kafkaConnect, kC -> {\n          \n      \n    \n    \n  \n\nThis is cleaner in my opinion, boolean arguments are the devil", "author": "samuel-hawker", "createdAt": "2020-12-07T11:00:00Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/resources/crd/KafkaConnectResource.java", "diffHunk": "@@ -87,8 +91,8 @@ private static KafkaConnectBuilder defaultKafkaConnect(KafkaConnect kafkaConnect\n             .endSpec();\n     }\n \n-    private static DoneableKafkaConnect deployKafkaConnect(KafkaConnect kafkaConnect) {\n-        if (Environment.DEFAULT_TO_DENY_NETWORK_POLICIES) {\n+    private static DoneableKafkaConnect deployKafkaConnect(KafkaConnect kafkaConnect, boolean allowNP) {\n+        if (Environment.DEFAULT_TO_DENY_NETWORK_POLICIES && allowNP) {\n             KubernetesResource.allowNetworkPolicySettingsForResource(kafkaConnect, KafkaConnectResources.deploymentName(kafkaConnect.getMetadata().getName()));\n         }\n         return new DoneableKafkaConnect(kafkaConnect, kC -> {", "originalCommit": "66765ee328ffc111d5d1e6e9ad14b6be99cc123a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQxNTQ0OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r537415449", "bodyText": "A different method signature is preferable to passing true/false", "author": "samuel-hawker", "createdAt": "2020-12-07T11:00:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQxNTI0Mg=="}], "type": "inlineReview"}, {"oid": "f6dd55281800d1fe94e48880b0b4c80925a888d2", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f6dd55281800d1fe94e48880b0b4c80925a888d2", "message": "change name of ST, do some cleanup in KafkaConnectResource (addressing Sam's comments)\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-12-07T17:13:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIwMTM5Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r538201393", "bodyText": "You can remove the booleans similarly from here and line 45", "author": "samuel-hawker", "createdAt": "2020-12-08T10:03:41Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/resources/crd/KafkaConnectResource.java", "diffHunk": "@@ -39,12 +39,17 @@\n     }\n \n     public static DoneableKafkaConnect kafkaConnect(String name, int kafkaConnectReplicas) {\n-        return kafkaConnect(name, name, kafkaConnectReplicas);\n+        return kafkaConnect(name, name, kafkaConnectReplicas, true);\n     }\n \n-    public static DoneableKafkaConnect kafkaConnect(String name, String clusterName, int kafkaConnectReplicas) {\n+    public static DoneableKafkaConnect kafkaConnect(String name, int kafkaConnectReplicas, boolean allowNP) {\n+        return kafkaConnect(name, name, kafkaConnectReplicas, allowNP);\n+    }\n+\n+    public static DoneableKafkaConnect kafkaConnect(String name, String clusterName, int kafkaConnectReplicas, boolean allowNP) {", "originalCommit": "f6dd55281800d1fe94e48880b0b4c80925a888d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxMzAyNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r538213025", "bodyText": "Hmmm ... I was thinking that I'll leave it like this, so we just specify in the KafkaConnect \"creation\" if we want it with NP or not..\nBut yes, I can create the kafkaConnectWithoutNetworkPolicies method and kafkaConnectWithNetworkPolicies.\nThese two (which you mentioned - line 45 and 49) are global and if I will change the naming, I will have to change it everywhere.\nWDYT @samuel-hawker and @Frawless ? Will we leave it like this or should I rename them all?", "author": "im-konge", "createdAt": "2020-12-08T10:20:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIwMTM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIzNzE5Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r538237197", "bodyText": "I don't think it's that problematic here, since this is the highest level of abstraction I think we are going when deploying a KafkaConnect.\nI am happy for you to leave as is, but there is nothing worse than passing a boolean through a chain of 5 functions was my origin point! (Which this isn't doing)", "author": "samuel-hawker", "createdAt": "2020-12-08T10:51:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIwMTM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwODM5NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r538808394", "bodyText": "Maybe it's really ridiculous, but I have some changes (small refactor) of these Network policies methods for all other resources. How about to do everything in that one? Sorry ... I'll request you for the review there", "author": "im-konge", "createdAt": "2020-12-08T21:07:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIwMTM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg2Njc1MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4045#discussion_r538866751", "bodyText": "No problem!", "author": "samuel-hawker", "createdAt": "2020-12-08T22:49:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIwMTM5Mw=="}], "type": "inlineReview"}, {"oid": "6595839fad7e992fc187843ffdb3dc4047d10e12", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6595839fad7e992fc187843ffdb3dc4047d10e12", "message": "fixes for failing tests after my changes\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-12-08T21:06:38Z", "type": "commit"}, {"oid": "cc4cc8b6fc01c2523e20ca25f771e280c31281d6", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/cc4cc8b6fc01c2523e20ca25f771e280c31281d6", "message": "fixup! fixes for failing tests after my changes\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-12-09T11:19:15Z", "type": "commit"}]}