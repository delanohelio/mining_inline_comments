{"pr_number": 2564, "pr_title": "CO validation for cluster size and dependent configs", "pr_createdAt": "2020-02-17T12:06:15Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564", "timeline": [{"oid": "36a6880f8555be787627599ef71ec54dd5ff8bd6", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/36a6880f8555be787627599ef71ec54dd5ff8bd6", "message": "CO validation for cluster size and dependent configs\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-17T12:04:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU0MjkxMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r380542913", "bodyText": "Unless there's already been some validation of the config by this point, then you can't assume that the value of the propertyName is parseable as an int, so you need to catch NumberFormatException.", "author": "tombentley", "createdAt": "2020-02-18T09:15:30Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -658,6 +662,18 @@ public static KafkaCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup vers\n         return result;\n     }\n \n+    private static void validateConfigProperty(String propertyName, KafkaClusterSpec kafkaClusterSpec) {\n+        String orLess = kafkaClusterSpec.getReplicas() > 1 ? \" or less\" : \"\";\n+        if (kafkaClusterSpec.getConfig() != null) {\n+            if (kafkaClusterSpec.getConfig().get(propertyName) != null) {\n+                if (Integer.parseInt(kafkaClusterSpec.getConfig().get(propertyName).toString()) > kafkaClusterSpec.getReplicas()) {", "originalCommit": "36a6880f8555be787627599ef71ec54dd5ff8bd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU0MzQ5Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r380543497", "bodyText": "The message should explain why the upper bound is that is it. \"... because spec.kafka.replicas is N\".", "author": "tombentley", "createdAt": "2020-02-18T09:16:29Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -658,6 +662,18 @@ public static KafkaCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup vers\n         return result;\n     }\n \n+    private static void validateConfigProperty(String propertyName, KafkaClusterSpec kafkaClusterSpec) {\n+        String orLess = kafkaClusterSpec.getReplicas() > 1 ? \" or less\" : \"\";\n+        if (kafkaClusterSpec.getConfig() != null) {\n+            if (kafkaClusterSpec.getConfig().get(propertyName) != null) {\n+                if (Integer.parseInt(kafkaClusterSpec.getConfig().get(propertyName).toString()) > kafkaClusterSpec.getReplicas()) {\n+                    log.warn(\"Kafka configuration '{}' should be set to {}{}.\", propertyName, kafkaClusterSpec.getReplicas(), orLess);", "originalCommit": "36a6880f8555be787627599ef71ec54dd5ff8bd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU0Mzk0NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r380543944", "bodyText": "We should either warn or throw (which will only result in another log), not both so as to avoid duplicate log entries.", "author": "tombentley", "createdAt": "2020-02-18T09:17:14Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -658,6 +662,18 @@ public static KafkaCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup vers\n         return result;\n     }\n \n+    private static void validateConfigProperty(String propertyName, KafkaClusterSpec kafkaClusterSpec) {\n+        String orLess = kafkaClusterSpec.getReplicas() > 1 ? \" or less\" : \"\";\n+        if (kafkaClusterSpec.getConfig() != null) {\n+            if (kafkaClusterSpec.getConfig().get(propertyName) != null) {\n+                if (Integer.parseInt(kafkaClusterSpec.getConfig().get(propertyName).toString()) > kafkaClusterSpec.getReplicas()) {\n+                    log.warn(\"Kafka configuration '{}' should be set to {}{}.\", propertyName, kafkaClusterSpec.getReplicas(), orLess);\n+                    throw new InvalidResourceException(\"Kafka configuration '\" + propertyName + \"' should be set to \" + kafkaClusterSpec.getReplicas() + orLess + \".\");", "originalCommit": "36a6880f8555be787627599ef71ec54dd5ff8bd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c3c464a98e2e072743e1ca3f30b003e03f970b92", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c3c464a98e2e072743e1ca3f30b003e03f970b92", "message": "Tomments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-18T15:24:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc0NDQ4Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r380744483", "bodyText": "I don't think you need isOk. Just return from within the catch block.\nAlso, use proper logging to say that  should be an integer, rather than e.printStackTrace();", "author": "tombentley", "createdAt": "2020-02-18T15:27:28Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -662,16 +662,25 @@ public static KafkaCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup vers\n         return result;\n     }\n \n-    private static void validateConfigProperty(String propertyName, KafkaClusterSpec kafkaClusterSpec) {\n+    protected static boolean validateConfigProperty(String propertyName, KafkaClusterSpec kafkaClusterSpec) {\n+        /* test */\n+        boolean isOk = true;\n         String orLess = kafkaClusterSpec.getReplicas() > 1 ? \" or less\" : \"\";\n         if (kafkaClusterSpec.getConfig() != null) {\n             if (kafkaClusterSpec.getConfig().get(propertyName) != null) {\n-                if (Integer.parseInt(kafkaClusterSpec.getConfig().get(propertyName).toString()) > kafkaClusterSpec.getReplicas()) {\n-                    log.warn(\"Kafka configuration '{}' should be set to {}{}.\", propertyName, kafkaClusterSpec.getReplicas(), orLess);\n-                    throw new InvalidResourceException(\"Kafka configuration '\" + propertyName + \"' should be set to \" + kafkaClusterSpec.getReplicas() + orLess + \".\");\n+                try {\n+                    int propertyVal = Integer.parseInt(kafkaClusterSpec.getConfig().get(propertyName).toString());\n+                    if (propertyVal > kafkaClusterSpec.getReplicas()) {\n+                        isOk = false;\n+                        log.warn(\"Kafka configuration '{}' should be set to {}{} because 'spec.kafka.replicas' is {}\", propertyName, kafkaClusterSpec.getReplicas(), orLess, kafkaClusterSpec.getReplicas());\n+                    }\n+                } catch (NumberFormatException e) {\n+                    isOk = false;\n+                    e.printStackTrace();", "originalCommit": "c3c464a98e2e072743e1ca3f30b003e03f970b92", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "218bb9ac3bd3b8986119e23a2588dae9b54f639a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/218bb9ac3bd3b8986119e23a2588dae9b54f639a", "message": "Tomments2\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-18T15:31:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MzY2Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r380943666", "bodyText": "This seems a bit weird now. You validate it, but return boolean and do nothing with it. Shouldn't you throw an exception or something? Eventually, if you agreed with @tombentley to only print warning I can live with it, but why return boolean then? Or did I missed something?", "author": "scholzj", "createdAt": "2020-02-18T21:25:00Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -658,6 +662,25 @@ public static KafkaCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup vers\n         return result;\n     }\n \n+    protected static boolean validateIntConfigProperty(String propertyName, KafkaClusterSpec kafkaClusterSpec) {", "originalCommit": "218bb9ac3bd3b8986119e23a2588dae9b54f639a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA5MTUwMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r381091502", "bodyText": "If the user configuration is wrong and the Kafka cluster is not going to work, I agree with Jakub that an exception could be raised. It should avoid having the reconcile ends well and starting an unusable cluster , right?", "author": "ppatierno", "createdAt": "2020-02-19T06:00:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MzY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTExOTMyMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r381119320", "bodyText": "It could be a void method but I did not find a better way how to test its output via unit test. Raising an exception might be better as it can be expected in the test.", "author": "sknot-rh", "createdAt": "2020-02-19T07:38:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MzY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE0NDk5MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r381144990", "bodyText": "io.strimzi.test.logging.TestLogger is something I wrote ages ago to be able to test the ValidationVisitor, maybe we could use it for testing this too?", "author": "tombentley", "createdAt": "2020-02-19T08:41:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MzY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE3MzcwNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r381173704", "bodyText": "I was looking for something like this. However, now the exception is used. Is that ok?", "author": "sknot-rh", "createdAt": "2020-02-19T09:35:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MzY2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA5MDI2NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r381090265", "bodyText": "just put the second condition on the first if as well, or?", "author": "ppatierno", "createdAt": "2020-02-19T05:55:17Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -658,6 +662,25 @@ public static KafkaCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup vers\n         return result;\n     }\n \n+    protected static boolean validateIntConfigProperty(String propertyName, KafkaClusterSpec kafkaClusterSpec) {\n+        String orLess = kafkaClusterSpec.getReplicas() > 1 ? \" or less\" : \"\";\n+        if (kafkaClusterSpec.getConfig() != null) {\n+            if (kafkaClusterSpec.getConfig().get(propertyName) != null) {", "originalCommit": "218bb9ac3bd3b8986119e23a2588dae9b54f639a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cc9be590afb1386c75898199abdbbbe4962e4ee9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/cc9be590afb1386c75898199abdbbbe4962e4ee9", "message": "review comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-19T08:07:37Z", "type": "commit"}]}