{"pr_number": 4070, "pr_title": "Make it possible to roll Kafka or ZooKeeper pods individually", "pr_createdAt": "2020-12-08T21:16:23Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4070", "timeline": [{"oid": "d6844bad6d89f8fe33b7e5588c7a83683cc6dc7a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d6844bad6d89f8fe33b7e5588c7a83683cc6dc7a", "message": "Make it possible to roll Kafka or ZooKeeper pods individually\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-08T21:20:53Z", "type": "commit"}, {"oid": "97959eef75cf1f711018ac348b4d07d3e81ea4a7", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/97959eef75cf1f711018ac348b4d07d3e81ea4a7", "message": "CHANGELOG.md\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-08T21:21:43Z", "type": "commit"}, {"oid": "97959eef75cf1f711018ac348b4d07d3e81ea4a7", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/97959eef75cf1f711018ac348b4d07d3e81ea4a7", "message": "CHANGELOG.md\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-08T21:21:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3NDU2Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4070#discussion_r539174563", "bodyText": "commented code?", "author": "ppatierno", "createdAt": "2020-12-09T10:08:48Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -753,6 +753,66 @@ public void checkCustomCaSecret(CertificateAuthority ca, Secret certSecret, Secr\n                     });\n         }\n \n+        /**\n+         * Does rolling update of Kafka pods based on the annotation on Pod level\n+         *\n+         * @param sts   The Kafka StatefulSet definition needed for the rolling update\n+         *\n+         * @return  Future with the result of the rolling update\n+         */\n+        @SuppressWarnings(\"deprecation\")\n+        Future<Void> kafkaManualPodRollingUpdate(StatefulSet sts) {\n+            return podOperations.listAsync(namespace, kafkaCluster.getSelectorLabels())\n+                    .compose(pods -> {\n+                        List<String> podsToRoll = new ArrayList<>(0);\n+\n+                        for (Pod pod : pods)    {\n+                            if (Annotations.booleanAnnotation(pod, Annotations.ANNO_STRIMZI_IO_MANUAL_ROLLING_UPDATE,\n+                                    false, Annotations.ANNO_OP_STRIMZI_IO_MANUAL_ROLLING_UPDATE)) {\n+                                podsToRoll.add(pod.getMetadata().getName());\n+                            }\n+                        }\n+\n+                        if (!podsToRoll.isEmpty())  {\n+                            return maybeRollKafka(sts, pod -> {\n+                                if (pod != null && podsToRoll.contains(pod.getMetadata().getName())) {\n+                                    log.debug(\"{}: Rolling Kafka pod {} due to manual rolling update annotation on a pod\", reconciliation, pod.getMetadata().getName());\n+                                    return singletonList(\"manual rolling update annotation on a pod\");\n+                                } else {\n+                                    return null;\n+                                }\n+                            });\n+                        } else {\n+                            return Future.succeededFuture();\n+                        }\n+\n+                        /*Future<Void> podRoll = Future.succeededFuture();\n+\n+                        for (String podName : podsToRoll)   {\n+                            podRoll = podRoll.compose(ignore -> {\n+                                return maybeRollKafka(sts, pod -> {\n+                                    if (pod != null && podName.equals(pod.getMetadata().getName())) {\n+                                        log.debug(\"{}: Rolling Kafka pod {} due to manual rolling update annotation on a pod\", reconciliation, podName);\n+                                        return singletonList(\"manual rolling update annotation on a pod\");\n+                                    } else {\n+                                        return null;\n+                                    }\n+                                });\n+                            });\n+                        }\n+\n+                        return withVoid(podRoll);*/", "originalCommit": "97959eef75cf1f711018ac348b4d07d3e81ea4a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3OTY3NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4070#discussion_r539179675", "bodyText": "Fixed. Thanks for noticing.", "author": "scholzj", "createdAt": "2020-12-09T10:16:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3NDU2Mw=="}], "type": "inlineReview"}, {"oid": "fa252d51601002c6a4dd2a946ba4e30abb7c66e0", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/fa252d51601002c6a4dd2a946ba4e30abb7c66e0", "message": "Remove commented out code\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-09T10:15:56Z", "type": "commit"}]}