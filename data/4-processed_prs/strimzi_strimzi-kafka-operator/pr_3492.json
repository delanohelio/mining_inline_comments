{"pr_number": 3492, "pr_title": "[DOC] clarify the config for mounting secrets as volumes", "pr_createdAt": "2020-08-11T06:55:17Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492", "timeline": [{"oid": "a5394ae36f2f4eec35f25349c41a301737d28e9e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a5394ae36f2f4eec35f25349c41a301737d28e9e", "message": "[DOC] clarify the config for mounting secrets as volumes\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-08-11T06:52:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDYwOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492#discussion_r468370609", "bodyText": "is there a kind of list of supported config providers somewhere @tombentley ?", "author": "ppatierno", "createdAt": "2020-08-11T07:08:30Z", "path": "documentation/modules/proc-kafka-connect-mounting-volumes.adoc", "diffHunk": "@@ -43,42 +55,48 @@ metadata:\n spec:\n   # ...\n   config:\n-    config.providers: file\n-    config.providers.file.class: org.apache.kafka.common.config.provider.FileConfigProvider\n+    config.providers: file <1>", "originalCommit": "a5394ae36f2f4eec35f25349c41a301737d28e9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM5NjE0NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492#discussion_r468396145", "bodyText": "The config.providers is just a list of aliases used to define other config params. config.proviers.${alias}.class defines the class of each one but each provider can take other parameters since they're Configurable. The alias has no meaning other than as a way to tying the class and parameters together in the config file and say which providers to use via config.providers. Currently Kafka only provides FileConfigProvider, KIP-632 will add a DirectoryConfigProvider which is better suited to use with mounted secrets and configmaps. Users can write their own config providers, for example to hook into things like Vault but like other plugins Strimzi doesn't really support that at the moment.", "author": "tombentley", "createdAt": "2020-08-11T07:58:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQwNTMwOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492#discussion_r468405308", "bodyText": "So I think that we should explain that in the examples as you highlight that config.providers defines an alias and you have to use that alias in the config.proviers.${alias}.class parameter. Tbh it was not clear to me.", "author": "ppatierno", "createdAt": "2020-08-11T08:15:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ3MDMxOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492#discussion_r468470318", "bodyText": "@PaulRMellor ^^", "author": "ppatierno", "createdAt": "2020-08-11T10:07:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM3NjY2MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492#discussion_r469376660", "bodyText": "@ppatierno - how about:\n\n<1> The alias for the configuration provider, which is used to define other configuration parameters.\nUse a comma-separated list if you want to add more than one provider.\n<2> The FileConfigProvider is the configuration provider that provides values from properties files.\nThe parameter uses the alias from config.providers, taking the form config.providers.${alias}.class.", "author": "PaulRMellor", "createdAt": "2020-08-12T16:10:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM5MTg4OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492#discussion_r468391889", "bodyText": "It's a bit weird calling it a \"properties file\" when it's not a file.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            <1> Properties file containing the connector configuration.\n          \n          \n            \n            <1> The connector configuration in properties file format.", "author": "tombentley", "createdAt": "2020-08-11T07:50:51Z", "path": "documentation/modules/proc-kafka-connect-mounting-volumes.adoc", "diffHunk": "@@ -25,13 +33,17 @@ metadata:\n   name: mysecret\n type: Opaque\n stringData:\n-  connector.properties: |-\n-    dbUsername: my-user\n+  connector.properties: |- <1>\n+    dbUsername: my-user <2>\n     dbPassword: my-password\n ----\n+<1> Properties file containing the connector configuration.", "originalCommit": "a5394ae36f2f4eec35f25349c41a301737d28e9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM5NDM5MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492#discussion_r468394390", "bodyText": "The file part is just an alias used for configuration purposes (to able multiple config providers to be used).\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Configuration providers allow you to load configuration values from the Secret.\n          \n          \n            \n            In this procedure, the configuration provider is named `file`.\n          \n          \n            \n            A Secret named `mysecret` is mounted to a volume named `connector-config`.\n          \n          \n            \n            The Kafka `FileConfigProvider` class is used to read and extract database _username_ and _password_ property values from the Secret\n          \n          \n            \n            to use in the connector configuration.\n          \n          \n            \n            Configuration providers allow you to load configuration values from external sources.\n          \n          \n            \n            In this procedure, a Secret named `mysecret` is mounted to a volume named `connector-config`. The Kafka `FileConfigProvider` is given the alias `file`  and used to read and extract database _username_ and _password_ property values from the file to use in the connector configuration.", "author": "tombentley", "createdAt": "2020-08-11T07:55:28Z", "path": "documentation/modules/proc-kafka-connect-mounting-volumes.adoc", "diffHunk": "@@ -4,9 +4,16 @@\n \n [id='proc-kafka-connect-mounting-volumes-{context}']\n \n-= Mounting Secrets as volumes\n+= Mounting Secrets as volumes for connector configuration\n \n-You can create a Kubernetes Secret, mount it as a volume to Kafka Connect, and then use it to configure a Kafka Connect connector.\n+You can create a Kubernetes Secret, mount it as a volume to Kafka Connect,\n+and then use it to configure a Kafka Connect connector.\n+\n+Configuration providers allow you to load configuration values from the Secret.\n+In this procedure, the configuration provider is named `file`.\n+A Secret named `mysecret` is mounted to a volume named `connector-config`.\n+The Kafka `FileConfigProvider` class is used to read and extract database _username_ and _password_ property values from the Secret\n+to use in the connector configuration.", "originalCommit": "a5394ae36f2f4eec35f25349c41a301737d28e9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM5ODQ2MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492#discussion_r468398460", "bodyText": "Right now it's only really possible to use the FileConfigProvider, but let's keep the 2nd sentence in anticipation of  KIP-632.", "author": "tombentley", "createdAt": "2020-08-11T08:02:46Z", "path": "documentation/modules/proc-kafka-connect-mounting-volumes.adoc", "diffHunk": "@@ -43,42 +55,48 @@ metadata:\n spec:\n   # ...\n   config:\n-    config.providers: file\n-    config.providers.file.class: org.apache.kafka.common.config.provider.FileConfigProvider\n+    config.providers: file <1>\n+    config.providers.file.class: org.apache.kafka.common.config.provider.FileConfigProvider <2>\n   #...\n   externalConfiguration:\n     volumes:\n-      - name: connector-config\n+      - name: connector-config <3>\n         secret:\n-          secretName: mysecret\n+          secretName: mysecret <4>\n ----\n+<1> The name of the configuration provider. Use a comma-separted list for more than one provider.", "originalCommit": "a5394ae36f2f4eec35f25349c41a301737d28e9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ2NTc0OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492#discussion_r468465749", "bodyText": "Thanks for clarifying Tom. I changed to:\n<1> The alias for the configuration provider. Use a comma-separated list if you want to add more than one provider.\nLet me know if you think we need to add more.", "author": "PaulRMellor", "createdAt": "2020-08-11T09:58:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM5ODQ2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM5ODk0Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492#discussion_r468398947", "bodyText": "It's not used by the provider, it is the provider.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            <2> The `FileConfigProvider` class used by the configuration provider to access the properties file.\n          \n          \n            \n            <2> The `FileConfigProvider` is a configuration provider which provides values from properties files.", "author": "tombentley", "createdAt": "2020-08-11T08:03:49Z", "path": "documentation/modules/proc-kafka-connect-mounting-volumes.adoc", "diffHunk": "@@ -43,42 +55,48 @@ metadata:\n spec:\n   # ...\n   config:\n-    config.providers: file\n-    config.providers.file.class: org.apache.kafka.common.config.provider.FileConfigProvider\n+    config.providers: file <1>\n+    config.providers.file.class: org.apache.kafka.common.config.provider.FileConfigProvider <2>\n   #...\n   externalConfiguration:\n     volumes:\n-      - name: connector-config\n+      - name: connector-config <3>\n         secret:\n-          secretName: mysecret\n+          secretName: mysecret <4>\n ----\n+<1> The name of the configuration provider. Use a comma-separted list for more than one provider.\n+<2> The `FileConfigProvider` class used by the configuration provider to access the properties file.", "originalCommit": "a5394ae36f2f4eec35f25349c41a301737d28e9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQwMDMyNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492#discussion_r468400326", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            <1> Path to the username property value. The path takes the form `/opt/kafka/external-configuration/_SECRET-VOLUME-NAME_/_PROPERTIES-FILENAME:USERNAME-VALUE_`.\n          \n          \n            \n            <1> Path to the username property value. The path takes the form `/opt/kafka/external-configuration/_SECRET-VOLUME-NAME_/_PROPERTIES-FILENAME:USERNAME-PROPERTY_`.", "author": "tombentley", "createdAt": "2020-08-11T08:06:26Z", "path": "documentation/modules/proc-kafka-connect-mounting-volumes.adoc", "diffHunk": "@@ -43,42 +55,48 @@ metadata:\n spec:\n   # ...\n   config:\n-    config.providers: file\n-    config.providers.file.class: org.apache.kafka.common.config.provider.FileConfigProvider\n+    config.providers: file <1>\n+    config.providers.file.class: org.apache.kafka.common.config.provider.FileConfigProvider <2>\n   #...\n   externalConfiguration:\n     volumes:\n-      - name: connector-config\n+      - name: connector-config <3>\n         secret:\n-          secretName: mysecret\n+          secretName: mysecret <4>\n ----\n+<1> The name of the configuration provider. Use a comma-separted list for more than one provider.\n+<2> The `FileConfigProvider` class used by the configuration provider to access the properties file.\n+<3> The name of the volume containing the Secret.\n+<4> The name of the Secret.\n \n . Apply the changes to your Kafka Connect deployment.\n +\n-Use `kubectl apply`:\n [source,shell,subs=+quotes]\n-kubectl apply -f _your-file_\n+kubectl apply -f _KAFKA-CONNECT-CONFIG-FILE_\n \n . Configure your connector\n * If you are using the Kafka Connect HTTP REST interface, use the values from the mounted properties file in your JSON payload with connector configuration.\n For example:\n +\n [source,json,subs=\"attributes+\"]\n ----\n-{  \n+{\n    \"name\":\"my-connector\",\n    \"config\":{\n       \"connector.class\":\"MyDbConnector\",\n       \"tasks.max\":\"3\",\n       \"database\": \"my-postgresql:5432\",\n-      \"username\":\"${file:/opt/kafka/external-configuration/connector-config/connector.properties:dbUsername}\",\n-      \"password\":\"${file:/opt/kafka/external-configuration/connector-config/connector.properties:dbPassword}\",\n+      \"username\":\"${file:/opt/kafka/external-configuration/connector-config/connector.properties:dbUsername}\", <1>\n+      \"password\":\"${file:/opt/kafka/external-configuration/connector-config/connector.properties:dbPassword}\", <2>\n       # ...\n    }\n }\n ----\n+<1> Path to the username property value. The path takes the form `/opt/kafka/external-configuration/_SECRET-VOLUME-NAME_/_PROPERTIES-FILENAME:USERNAME-VALUE_`.", "originalCommit": "a5394ae36f2f4eec35f25349c41a301737d28e9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQwMDQzMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492#discussion_r468400430", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            <2> Path to the password property value. The path takes the form `/opt/kafka/external-configuration/_SECRET-VOLUME-NAME_/_PROPERTIES-FILENAME:PASSWORD-VALUE_`.\n          \n          \n            \n            <2> Path to the password property value. The path takes the form `/opt/kafka/external-configuration/_SECRET-VOLUME-NAME_/_PROPERTIES-FILENAME:PASSWORD-PROPERTY_`.", "author": "tombentley", "createdAt": "2020-08-11T08:06:37Z", "path": "documentation/modules/proc-kafka-connect-mounting-volumes.adoc", "diffHunk": "@@ -43,42 +55,48 @@ metadata:\n spec:\n   # ...\n   config:\n-    config.providers: file\n-    config.providers.file.class: org.apache.kafka.common.config.provider.FileConfigProvider\n+    config.providers: file <1>\n+    config.providers.file.class: org.apache.kafka.common.config.provider.FileConfigProvider <2>\n   #...\n   externalConfiguration:\n     volumes:\n-      - name: connector-config\n+      - name: connector-config <3>\n         secret:\n-          secretName: mysecret\n+          secretName: mysecret <4>\n ----\n+<1> The name of the configuration provider. Use a comma-separted list for more than one provider.\n+<2> The `FileConfigProvider` class used by the configuration provider to access the properties file.\n+<3> The name of the volume containing the Secret.\n+<4> The name of the Secret.\n \n . Apply the changes to your Kafka Connect deployment.\n +\n-Use `kubectl apply`:\n [source,shell,subs=+quotes]\n-kubectl apply -f _your-file_\n+kubectl apply -f _KAFKA-CONNECT-CONFIG-FILE_\n \n . Configure your connector\n * If you are using the Kafka Connect HTTP REST interface, use the values from the mounted properties file in your JSON payload with connector configuration.\n For example:\n +\n [source,json,subs=\"attributes+\"]\n ----\n-{  \n+{\n    \"name\":\"my-connector\",\n    \"config\":{\n       \"connector.class\":\"MyDbConnector\",\n       \"tasks.max\":\"3\",\n       \"database\": \"my-postgresql:5432\",\n-      \"username\":\"${file:/opt/kafka/external-configuration/connector-config/connector.properties:dbUsername}\",\n-      \"password\":\"${file:/opt/kafka/external-configuration/connector-config/connector.properties:dbPassword}\",\n+      \"username\":\"${file:/opt/kafka/external-configuration/connector-config/connector.properties:dbUsername}\", <1>\n+      \"password\":\"${file:/opt/kafka/external-configuration/connector-config/connector.properties:dbPassword}\", <2>\n       # ...\n    }\n }\n ----\n+<1> Path to the username property value. The path takes the form `/opt/kafka/external-configuration/_SECRET-VOLUME-NAME_/_PROPERTIES-FILENAME:USERNAME-VALUE_`.\n+<2> Path to the password property value. The path takes the form `/opt/kafka/external-configuration/_SECRET-VOLUME-NAME_/_PROPERTIES-FILENAME:PASSWORD-VALUE_`.", "originalCommit": "a5394ae36f2f4eec35f25349c41a301737d28e9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4e8eadc7cecbf9de1c2e49d063d841a74bdeb7ed", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4e8eadc7cecbf9de1c2e49d063d841a74bdeb7ed", "message": "review edits TB\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-08-11T10:05:34Z", "type": "commit"}, {"oid": "f93e7e5c0b8e000edc56756e07fd1f5842485f5c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f93e7e5c0b8e000edc56756e07fd1f5842485f5c", "message": "review edits PP\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-08-12T16:29:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk3MjM3MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492#discussion_r469972371", "bodyText": "Are the itallics necessary here?", "author": "laidan6000", "createdAt": "2020-08-13T13:59:06Z", "path": "documentation/modules/proc-kafka-connect-mounting-volumes.adoc", "diffHunk": "@@ -25,13 +33,17 @@ metadata:\n   name: mysecret\n type: Opaque\n stringData:\n-  connector.properties: |-\n-    dbUsername: my-user\n+  connector.properties: |- <1>\n+    dbUsername: my-user <2>\n     dbPassword: my-password\n ----\n+<1> The connector configuration in properties file format.\n+<2> Database _username_ and _password_ properties used in the configuration.", "originalCommit": "f93e7e5c0b8e000edc56756e07fd1f5842485f5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc1NDc5OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492#discussion_r475754799", "bodyText": "Not really. Removed.", "author": "PaulRMellor", "createdAt": "2020-08-24T16:50:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk3MjM3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk3NDYyMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3492#discussion_r469974622", "bodyText": "This sentence is quite difficult to parse! You could change it as follows:\nIn the config section and the externalConfiguration section of the KafkaConnect or KafkaConnectS2I custom resource, configure the configuration provider to reference the secret.", "author": "laidan6000", "createdAt": "2020-08-13T14:02:25Z", "path": "documentation/modules/proc-kafka-connect-mounting-volumes.adoc", "diffHunk": "@@ -25,13 +33,17 @@ metadata:\n   name: mysecret\n type: Opaque\n stringData:\n-  connector.properties: |-\n-    dbUsername: my-user\n+  connector.properties: |- <1>\n+    dbUsername: my-user <2>\n     dbPassword: my-password\n ----\n+<1> The connector configuration in properties file format.\n+<2> Database _username_ and _password_ properties used in the configuration.\n \n . Create or edit the Kafka Connect resource.\n-Configure the `FileConfigProvider` in the `config` section and the `externalConfiguration` section of the `KafkaConnect` or `KafkaConnectS2I` custom resource to reference the secret.\n++\n+Configure the configuration provider in the `config` section and the `externalConfiguration` section of the `KafkaConnect` or `KafkaConnectS2I` custom resource to reference the secret.", "originalCommit": "f93e7e5c0b8e000edc56756e07fd1f5842485f5c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "136074019098a386373574d58f7b91a87782ddac", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/136074019098a386373574d58f7b91a87782ddac", "message": "review edits DL\n\nSigned-off-by: prmellor <pmellor@redhat.com>", "committedDate": "2020-08-24T16:52:42Z", "type": "commit"}]}