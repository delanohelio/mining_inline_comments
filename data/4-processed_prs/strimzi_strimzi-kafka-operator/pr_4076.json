{"pr_number": 4076, "pr_title": "#4035: Patch Rancher Cattle annotations when reconciling services", "pr_createdAt": "2020-12-09T14:35:35Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk2NDMwMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076#discussion_r539964303", "bodyText": "I think we should be more precise to have RANCHER in the const name because it's the only one having this annotation AFAIU, right?", "author": "ppatierno", "createdAt": "2020-12-10T08:21:00Z", "path": "operator-common/src/main/java/io/strimzi/operator/common/operator/resource/ServiceOperator.java", "diffHunk": "@@ -11,13 +11,19 @@\n import io.fabric8.kubernetes.client.KubernetesClient;\n import io.fabric8.kubernetes.client.dsl.MixedOperation;\n import io.fabric8.kubernetes.client.dsl.ServiceResource;\n+import io.strimzi.operator.common.Util;\n import io.vertx.core.Future;\n import io.vertx.core.Vertx;\n \n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n /**\n  * Operations for {@code Service}s.\n  */\n public class ServiceOperator extends AbstractResourceOperator<KubernetesClient, Service, ServiceList, DoneableService, ServiceResource<Service, DoneableService>> {\n+    private static final String CATTLE_ANNOTATION_SEED = \"cattle.io\";", "originalCommit": "29b636377e25b94a6825595b305c1aa197141ade", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk2NDk1NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076#discussion_r539964954", "bodyText": "instead of having a specific method for just this \"cattle\" annotation, why not having a more general one passing a list of annotations to patch which in this case will continue just one annotation for now?", "author": "ppatierno", "createdAt": "2020-12-10T08:22:02Z", "path": "operator-common/src/main/java/io/strimzi/operator/common/operator/resource/ServiceOperator.java", "diffHunk": "@@ -70,6 +77,31 @@ public ServiceOperator(Vertx vertx, KubernetesClient client) {\n         }\n     }\n \n+    /**\n+     * Finds annotations managed by the Rancher cattle agents (if any), and merge them into the desired spec.\n+     *\n+     * This makes sure there is no infinite loop where Rancher tries to add annotations, while Rancher keeps\n+     * removing them during reconciliation.\n+     *\n+     * @param current   Current Service\n+     * @param desired   Desired Service\n+     */\n+    private void patchCattleAnnotations(Service current, Service desired) {", "originalCommit": "29b636377e25b94a6825595b305c1aa197141ade", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDAxNDA4Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076#discussion_r540014082", "bodyText": "Is there a preferred place (like configuration file / dependency) to store this \"list of annotations\", or would the private static final OK for this?", "author": "mluiten", "createdAt": "2020-12-10T09:34:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk2NDk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDAxNjc4OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076#discussion_r540016789", "bodyText": "We have this Annotations class https://github.com/strimzi/strimzi-kafka-operator/blob/master/operator-common/src/main/java/io/strimzi/operator/common/Annotations.java", "author": "ppatierno", "createdAt": "2020-12-10T09:38:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk2NDk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDAzMjM0MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076#discussion_r540032340", "bodyText": "I have refactored the code; can you check if this is better? :)", "author": "mluiten", "createdAt": "2020-12-10T10:00:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk2NDk1NA=="}], "type": "inlineReview"}, {"oid": "c3eeae08cfbe13bb64f81232a995c0013e88edf3", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c3eeae08cfbe13bb64f81232a995c0013e88edf3", "message": "Patch Rancher Cattle annotations when reconciling services (#4035)\n\nSigned-off-by: Menno Luiten <menno.luiten@ah.nl>", "committedDate": "2020-12-10T09:37:57Z", "type": "commit"}, {"oid": "c3eeae08cfbe13bb64f81232a995c0013e88edf3", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c3eeae08cfbe13bb64f81232a995c0013e88edf3", "message": "Patch Rancher Cattle annotations when reconciling services (#4035)\n\nSigned-off-by: Menno Luiten <menno.luiten@ah.nl>", "committedDate": "2020-12-10T09:37:57Z", "type": "forcePushed"}, {"oid": "f393d39a71b5247b4df6a335ea87d92f84debc29", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f393d39a71b5247b4df6a335ea87d92f84debc29", "message": "Moved configuration of load balancer annotation to whitelist in Annotations (#4035)\n\nSigned-off-by: Menno Luiten <menno.luiten@ah.nl>", "committedDate": "2020-12-10T09:59:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU1NTc1NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076#discussion_r540555755", "bodyText": "I wonder if we really need the matching here. If the contains or startsWith which was used originally wasn't better in terms of performance etc. @tombentley WDYT?", "author": "scholzj", "createdAt": "2020-12-10T22:51:19Z", "path": "operator-common/src/main/java/io/strimzi/operator/common/operator/resource/ServiceOperator.java", "diffHunk": "@@ -70,6 +78,31 @@ public ServiceOperator(Vertx vertx, KubernetesClient client) {\n         }\n     }\n \n+    /**\n+     * Finds annotations managed by the Rancher cattle agents (if any), and merge them into the desired spec.\n+     *\n+     * This makes sure there is no infinite loop where Rancher tries to add annotations, while Rancher keeps\n+     * removing them during reconciliation.\n+     *\n+     * @param current   Current Service\n+     * @param desired   Desired Service\n+     */\n+    private void patchAnnotations(Service current, Service desired) {\n+        Map<String, String> currentAnnotations = current.getMetadata().getAnnotations();\n+        if (currentAnnotations != null) {\n+            Map<String, String> matchedAnnotations = currentAnnotations.keySet().stream()\n+                    .filter(annotation -> LOADBALANCER_ANNOTATION_WHITELIST.stream().anyMatch(whitelist -> whitelist.test(annotation)))", "originalCommit": "f393d39a71b5247b4df6a335ea87d92f84debc29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk1MzI0MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076#discussion_r540953240", "bodyText": "I replaced the regex'es with startsWith :-)", "author": "mluiten", "createdAt": "2020-12-11T13:39:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU1NTc1NQ=="}], "type": "inlineReview"}, {"oid": "ad4c25510cf80677146a5b24068dfc8af30c844b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ad4c25510cf80677146a5b24068dfc8af30c844b", "message": "Replace regex with startsWith for better performance\n\nSigned-off-by: Menno Luiten <menno.luiten@ah.nl>", "committedDate": "2020-12-11T13:59:22Z", "type": "commit"}, {"oid": "ad4c25510cf80677146a5b24068dfc8af30c844b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ad4c25510cf80677146a5b24068dfc8af30c844b", "message": "Replace regex with startsWith for better performance\n\nSigned-off-by: Menno Luiten <menno.luiten@ah.nl>", "committedDate": "2020-12-11T13:59:22Z", "type": "forcePushed"}, {"oid": "4e17034f6831c04cbb34a40a7f55b696c8518f64", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4e17034f6831c04cbb34a40a7f55b696c8518f64", "message": "Fix checkstyles\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-12T00:00:13Z", "type": "commit"}]}