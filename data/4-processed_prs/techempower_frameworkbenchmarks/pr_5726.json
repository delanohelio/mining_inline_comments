{"pr_number": 5726, "pr_title": "Add benchmark for Frank", "pr_createdAt": "2020-06-02T19:01:10Z", "pr_url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5726", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk5NjIwMg==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5726#discussion_r438996202", "bodyText": "@panesofglass Apologies for taking so long to review.\nThe object for the json test needs to be instantiated and serialized on every request.\nstruct {| message = \"Hello, World!\" |} and this serialization should be moved into the function below.", "author": "nbrady-techempower", "createdAt": "2020-06-11T18:43:05Z", "path": "frameworks/FSharp/frank/src/App/Program.fs", "diffHunk": "@@ -0,0 +1,126 @@\n+module App.App\n+\n+open System\n+open System.IO\n+open System.Threading.Tasks\n+open Microsoft.AspNetCore.Hosting\n+open Microsoft.AspNetCore.Http\n+open Dapper\n+open Frank.Builder\n+open FSharp.Control.Tasks\n+open Npgsql\n+open App\n+open Models\n+\n+let private DefaultCapacity = 1386\n+let private MaxBuilderSize = DefaultCapacity * 3\n+let private BufferSize = 27\n+\n+type MemoryStreamCache = \n+    \n+    [<ThreadStatic>]\n+    [<DefaultValue>]\n+    static val mutable private instance: MemoryStream\n+\n+    static member Get() = MemoryStreamCache.Get(DefaultCapacity)\n+    static member Get(capacity:int) = \n+        \n+        if capacity <= MaxBuilderSize then\n+            let ms = MemoryStreamCache.instance;\n+            let capacity = max capacity DefaultCapacity\n+            \n+            if ms <> null && capacity <= ms.Capacity then\n+                MemoryStreamCache.instance <- null;\n+                ms.SetLength 0L\n+                ms\n+            else\n+                new MemoryStream(capacity)\n+        else\n+            new MemoryStream(capacity)\n+\n+    static member Release(ms:MemoryStream) = \n+        if ms.Capacity <= MaxBuilderSize then\n+            MemoryStreamCache.instance <- ms\n+\n+let inline contentLength x = new Nullable<int64> ( int64 x )\n+\n+let json' data : HttpContext -> Task<unit> =\n+    let bytes = Utf8Json.JsonSerializer.Serialize(data)", "originalCommit": "8f1d20430dfd3e23324d058bf118dc949c431217", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAzMDkwNw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5726#discussion_r439030907", "bodyText": "Also, I just looked at some other F# implementations and I see that Zebra has this problem since 2018", "author": "nbrady-techempower", "createdAt": "2020-06-11T19:51:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk5NjIwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAzMTQ2NA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5726#discussion_r439031464", "bodyText": "Ah, thank you! I'll update.", "author": "panesofglass", "createdAt": "2020-06-11T19:52:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk5NjIwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAzNTE3NA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5726#discussion_r439035174", "bodyText": "@panesofglass  if I put a printfn \"test\" here and then hit the json route over and over again, it will not print. If it is moved into the function, it will, so this is not currently meeting the requirements.", "author": "nbrady-techempower", "createdAt": "2020-06-11T20:00:16Z", "path": "frameworks/FSharp/frank/src/App/Program.fs", "diffHunk": "@@ -0,0 +1,126 @@\n+module App.App\n+\n+open System\n+open System.IO\n+open System.Threading.Tasks\n+open Microsoft.AspNetCore.Hosting\n+open Microsoft.AspNetCore.Http\n+open Dapper\n+open Frank.Builder\n+open FSharp.Control.Tasks\n+open Npgsql\n+open App\n+open Models\n+\n+let private DefaultCapacity = 1386\n+let private MaxBuilderSize = DefaultCapacity * 3\n+let private BufferSize = 27\n+\n+type MemoryStreamCache = \n+    \n+    [<ThreadStatic>]\n+    [<DefaultValue>]\n+    static val mutable private instance: MemoryStream\n+\n+    static member Get() = MemoryStreamCache.Get(DefaultCapacity)\n+    static member Get(capacity:int) = \n+        \n+        if capacity <= MaxBuilderSize then\n+            let ms = MemoryStreamCache.instance;\n+            let capacity = max capacity DefaultCapacity\n+            \n+            if ms <> null && capacity <= ms.Capacity then\n+                MemoryStreamCache.instance <- null;\n+                ms.SetLength 0L\n+                ms\n+            else\n+                new MemoryStream(capacity)\n+        else\n+            new MemoryStream(capacity)\n+\n+    static member Release(ms:MemoryStream) = \n+        if ms.Capacity <= MaxBuilderSize then\n+            MemoryStreamCache.instance <- ms\n+\n+let inline contentLength x = new Nullable<int64> ( int64 x )\n+\n+let json' data : HttpContext -> Task<unit> =\n+    let bytes = Utf8Json.JsonSerializer.Serialize(data)", "originalCommit": "8f1d20430dfd3e23324d058bf118dc949c431217", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAzNjYwOQ==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5726#discussion_r439036609", "bodyText": "You are correct. I misread and thought it was already under the fun ctx -> ... bit. I have updated it so that it serializes on each request.", "author": "panesofglass", "createdAt": "2020-06-11T20:03:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAzNTE3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAzNjgxMw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5726#discussion_r439036813", "bodyText": "Just to be clear, the plaintext route does not have the same requirements.", "author": "nbrady-techempower", "createdAt": "2020-06-11T20:03:53Z", "path": "frameworks/FSharp/frank/src/App/Program.fs", "diffHunk": "@@ -45,21 +45,21 @@ type MemoryStreamCache =\n let inline contentLength x = new Nullable<int64> ( int64 x )\n \n let json' data : HttpContext -> Task<unit> =\n-    let bytes = Utf8Json.JsonSerializer.Serialize(data)\n     fun ctx -> \n         ctx.Response.ContentLength <- contentLength bytes.Length\n         ctx.Response.ContentType <- \"application/json\"\n         ctx.Response.StatusCode <- 200\n+        let bytes = Utf8Json.JsonSerializer.Serialize(data)\n         task {\n             do! ctx.Response.Body.WriteAsync(bytes, 0, bytes.Length)\n         }\n \n let text' (msg:string): HttpContext -> Task<unit> =\n-    let bytes = System.Text.Encoding.UTF8.GetBytes(msg)\n     fun ctx ->\n         ctx.Response.ContentLength <- contentLength bytes.Length\n         ctx.Response.ContentType <- \"text/plain\"\n         ctx.Response.StatusCode <- 200\n+        let bytes = System.Text.Encoding.UTF8.GetBytes(msg)", "originalCommit": "b20c8c0ce9b4f55a77fbd182126e6c5220e2a352", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAzODQwMA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5726#discussion_r439038400", "bodyText": "Ah, thanks!", "author": "panesofglass", "createdAt": "2020-06-11T20:07:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAzNjgxMw=="}], "type": "inlineReview"}, {"oid": "e7dea323d324bd6c0a37a3af44d9bf2a5581bfa7", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/e7dea323d324bd6c0a37a3af44d9bf2a5581bfa7", "message": "Add benchmark for Frank", "committedDate": "2020-06-12T00:10:00Z", "type": "commit"}, {"oid": "4fb1d678c6aaa8363c565c031ed09c084ca08e18", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/4fb1d678c6aaa8363c565c031ed09c084ca08e18", "message": "Add Red Hat Linux Transport for comparison", "committedDate": "2020-06-12T00:10:00Z", "type": "commit"}, {"oid": "83d3bf07e94419c28ae7ab1655e858d931db518c", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/83d3bf07e94419c28ae7ab1655e858d931db518c", "message": "Update versions", "committedDate": "2020-06-12T00:20:10Z", "type": "commit"}, {"oid": "83d3bf07e94419c28ae7ab1655e858d931db518c", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/83d3bf07e94419c28ae7ab1655e858d931db518c", "message": "Update versions", "committedDate": "2020-06-12T00:20:10Z", "type": "forcePushed"}, {"oid": "b0eedd4ac14e80db79170d8e9a155a9cdfc3122f", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/b0eedd4ac14e80db79170d8e9a155a9cdfc3122f", "message": "Keep Server header", "committedDate": "2020-06-12T01:00:22Z", "type": "commit"}, {"oid": "1ffc661aebc23bc2e745093d51a1cce87de7555b", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/1ffc661aebc23bc2e745093d51a1cce87de7555b", "message": "Production-like HTML rendering and OOB JSON rendering", "committedDate": "2020-06-12T02:32:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4MjMxNg==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5726#discussion_r439482316", "bodyText": "Sorry to be a pain here, but this struct creation still needs to be moved into the function at line 24. My understanding of what is happening here is that this struct is only being created once and then being serialized on each request. It also needs to be instantiated on each request.\nhttps://github.com/TechEmpower/FrameworkBenchmarks/wiki/Project-Information-Framework-Tests-Overview#json-serialization\n\ni. For each request, an object mapping the key message to Hello, World! must be instantiated.", "author": "nbrady-techempower", "createdAt": "2020-06-12T15:17:05Z", "path": "frameworks/FSharp/frank/src/App/Program.fs", "diffHunk": "@@ -0,0 +1,88 @@\n+module App.App\n+\n+open System\n+open System.IO\n+open System.Text\n+open System.Text.Json.Serialization\n+open System.Text.Json\n+open System.Threading.Tasks\n+open Microsoft.AspNetCore.Hosting\n+open Microsoft.AspNetCore.Http\n+open Microsoft.Extensions.Logging\n+open Dapper\n+open Giraffe\n+open Frank.Builder\n+open FSharp.Control.Tasks\n+open Npgsql\n+open Models\n+\n+let inline contentLength x = new Nullable<int64> ( int64 x )\n+\n+let json' data : HttpContext -> Task =\n+    let options = JsonSerializerOptions()\n+    options.Converters.Add(JsonFSharpConverter())\n+    fun ctx ->\n+        ctx.Response.ContentType <- \"application/json\"\n+        ctx.Response.StatusCode <- 200\n+        JsonSerializer.SerializeAsync(ctx.Response.Body, data)\n+\n+let text' (msg:string): HttpContext -> Task =\n+    let bytes = Encoding.UTF8.GetBytes(msg)\n+    fun ctx ->\n+        ctx.Response.ContentLength <- contentLength bytes.Length\n+        ctx.Response.ContentType <- \"text/plain\"\n+        ctx.Response.StatusCode <- 200\n+        ctx.Response.Body.WriteAsync(bytes, 0, bytes.Length)\n+\n+// Pulled from Giraffe example\n+let fortunes' = \n+    let extra = { id = 0; message = \"Additional fortune added at request time.\" }\n+    fun next (ctx: HttpContext) ->\n+        let conn = new NpgsqlConnection(ConnectionString)\n+        ctx.Response.RegisterForDispose conn\n+        task {\n+            let! data = conn.QueryAsync<Fortune>(\"SELECT id, message FROM fortune\")\n+\n+            let fortunes = \n+                let xs = data.AsList()\n+                xs.Add extra\n+                xs.Sort FortuneComparer\n+                xs\n+\n+            return! htmlView (HtmlViews.fortunes fortunes) next ctx\n+        }\n+\n+// Resources\n+\n+let plaintext = \n+    resource \"/plaintext\" {\n+        name \"Plain text\"\n+        get (text' \"Hello, World!\")\n+    }\n+\n+let json =\n+    resource \"/json\" {\n+        name \"JSON\"\n+        get (json' struct {|message=\"Hello, World!\"|})", "originalCommit": "1ffc661aebc23bc2e745093d51a1cce87de7555b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUwMzI0OQ==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5726#discussion_r439503249", "bodyText": "No worries. Sorry that I misunderstood.", "author": "panesofglass", "createdAt": "2020-06-12T15:55:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ4MjMxNg=="}], "type": "inlineReview"}, {"oid": "3cb996efb8974b7a0cff9fc7a6af97a3237c042d", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/3cb996efb8974b7a0cff9fc7a6af97a3237c042d", "message": "Update Program.fs", "committedDate": "2020-06-12T15:59:51Z", "type": "commit"}, {"oid": "26a37bbacfc4331ed922c8e5853c9f4cd7b0086f", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/26a37bbacfc4331ed922c8e5853c9f4cd7b0086f", "message": "Update Program.fs", "committedDate": "2020-06-12T16:00:56Z", "type": "commit"}]}