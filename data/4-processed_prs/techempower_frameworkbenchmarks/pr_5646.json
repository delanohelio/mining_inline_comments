{"pr_number": 5646, "pr_title": "Add libsniper HTTP client/server library", "pr_createdAt": "2020-04-24T21:15:14Z", "pr_url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5646", "timeline": [{"oid": "5ef26453f09ed2ebf6a18eac1f1758b38982bf05", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/5ef26453f09ed2ebf6a18eac1f1758b38982bf05", "message": "libsniper is a small, very fast C++ library for writing highload HTTP services (f.e. RTB services)", "committedDate": "2020-04-24T21:08:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjEzNTIwNw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5646#discussion_r416135207", "bodyText": "Thanks for your contribution @OlegRomanenko\nI don't see any type of routing here. Please see rule 6 in the General Requirements\n\nSome form of request routing is required, even if only a single test type (e.g., Plaintext) is implemented. In most cases, the framework's canonical router or a mainstream router library will be used. In some cases, it is considered normal and sufficiently production-grade to use hand-crafted minimalist routing using control structures such as if/else branching. This is acceptable where it is considered canonical for the framework.", "author": "nbrady-techempower", "createdAt": "2020-04-27T20:44:45Z", "path": "frameworks/C++/libsniper/libsniper_bench/src/main.cpp", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright (c) 2020, RTBtech, MediaSniper, Oleg Romanenko (oleg@romanenko.ro)\n+ */\n+\n+#include <sniper/event/Loop.h>\n+#include <sniper/event/Timer.h>\n+#include <sniper/http/Server.h>\n+#include <sniper/log/log.h>\n+#include <sniper/std/check.h>\n+#include <sniper/std/vector.h>\n+#include <sniper/threads/Stop.h>\n+#include <thread>\n+\n+using namespace sniper;\n+\n+class Server\n+{\n+public:\n+    explicit Server()\n+    {\n+        for (unsigned i = 0; i < std::thread::hardware_concurrency(); i++)\n+            _workers.emplace_back(&Server::worker_noexcept, this, i);\n+    }\n+\n+    ~Server()\n+    {\n+        for (auto& w : _workers)\n+            if (w.joinable())\n+                w.join();\n+    }\n+\n+private:\n+    void worker_noexcept(unsigned int thread_num) noexcept\n+    {\n+        try {\n+            worker(thread_num);\n+        }\n+        catch (std::exception& e) {\n+            log_err(e.what());\n+        }\n+        catch (...) {\n+            log_err(\"[Server] non std::exception occured\");\n+        }\n+    }\n+\n+    static string gen_date()\n+    {\n+        return fmt::format(\"Date: {:%a, %d %b %Y %H:%M:%S} GMT\\r\\n\", fmt::gmtime(time(nullptr)));\n+    }\n+\n+    void worker(unsigned thread_num)\n+    {\n+        auto loop = event::make_loop();\n+        check(loop, \"[Server] cannot init event loop\");\n+\n+        http::server::Config config;\n+        config.max_conns = 100000;\n+        config.connection.keep_alive_timeout = 10min;\n+        config.connection.request_read_timeout = 10s;\n+\n+        http::Server http_server(loop, config);\n+        check(http_server.bind(\"\", 8090), \"[Server] cannot bind to localhost:8090\");\n+\n+        string date = gen_date();\n+        http_server.set_cb_request([&, this](const auto& conn, const auto& req, const auto& resp) {", "originalCommit": "5ef26453f09ed2ebf6a18eac1f1758b38982bf05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM2NDkyNA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5646#discussion_r416364924", "bodyText": "Oh sorry! I forgot about routing. We do not use routing in production.\nFixed.", "author": "OlegRomanenko", "createdAt": "2020-04-28T06:38:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjEzNTIwNw=="}], "type": "inlineReview"}, {"oid": "ab63e6096881c22e9f66d0024767c0ddb9834092", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/ab63e6096881c22e9f66d0024767c0ddb9834092", "message": "Add request routing", "committedDate": "2020-04-28T06:33:21Z", "type": "commit"}]}