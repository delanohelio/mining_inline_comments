{"pr_number": 6215, "pr_title": "http-jl performance updates", "pr_createdAt": "2020-12-16T23:44:35Z", "pr_url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6215", "timeline": [{"oid": "5386e4aba0423b8e668a328e272d72aa4657d9c3", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/5386e4aba0423b8e668a328e272d72aa4657d9c3", "message": "fix: use project.toml, make multi-threaded and multi-core", "committedDate": "2020-12-16T23:28:46Z", "type": "commit"}, {"oid": "828a3d233f3714951bce9728a30b007595d21b96", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/828a3d233f3714951bce9728a30b007595d21b96", "message": "fix: rename README => README.md", "committedDate": "2020-12-16T23:44:18Z", "type": "commit"}, {"oid": "91d03ff21037c99ad01cc27a178c8adc8930b466", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/91d03ff21037c99ad01cc27a178c8adc8930b466", "message": "style: delete commented out code", "committedDate": "2020-12-16T23:57:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyODI3NA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6215#discussion_r544728274", "bodyText": "Maybe include a [compat] section here?\nSo can use ]up to update manifest while respecting semver", "author": "oxinabox", "createdAt": "2020-12-17T00:48:08Z", "path": "frameworks/Julia/Http.jl/Project.toml", "diffHunk": "@@ -0,0 +1,3 @@\n+[deps]\n+HTTP = \"cd3eb016-35fb-5094-929b-558a96fad6f3\"\n+JSON3 = \"0f8b85d8-7281-11e9-16c2-39a750bddbf1\"", "originalCommit": "91d03ff21037c99ad01cc27a178c8adc8930b466", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a041bd9724d3521aaa58705d7d5e5765953e27a1", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/a041bd9724d3521aaa58705d7d5e5765953e27a1", "message": "build: add compat to project.toml, bump julia version", "committedDate": "2020-12-17T01:52:11Z", "type": "commit"}, {"oid": "e294694b2196e1d653d2f741233f00e158890a94", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/e294694b2196e1d653d2f741233f00e158890a94", "message": "fix: revert to correct code", "committedDate": "2020-12-17T01:55:40Z", "type": "commit"}, {"oid": "21aa61ea0ce7fd24c78701fe36c0cc8f8b4855ee", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/21aa61ea0ce7fd24c78701fe36c0cc8f8b4855ee", "message": "docs: update package reference", "committedDate": "2020-12-17T02:00:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM4MzA4Mw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6215#discussion_r545383083", "bodyText": "Does this make a difference in this benchmark, btw?", "author": "cmcaine", "createdAt": "2020-12-17T20:28:16Z", "path": "frameworks/Julia/Http.jl/run.sh", "diffHunk": "@@ -1,6 +1,7 @@\n #!/bin/sh\n \n for i in $(seq 0 $(($(nproc --all)-1))); do\n-\tjulia server.jl\n+\tjulia --threads auto server.jl &", "originalCommit": "21aa61ea0ce7fd24c78701fe36c0cc8f8b4855ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQyMjc0Nw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6215#discussion_r545422747", "bodyText": "The running multiple in processes in the background makes a big difference.  The threads might make some difference, but it's less pronounced if at all (no harm in having them though?).", "author": "mcmcgrath13", "createdAt": "2020-12-17T21:44:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM4MzA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ2NTAwNA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6215#discussion_r545465004", "bodyText": "I would have expected that either would do (threads or multiprocess) if HTTP.jl is multithreaded.\nAs far as I can see in the code, tho, I think HTTP.jl doesn't start its own threads, but is expected to work if you call listen in multiple threads, so I wouldn't expect --threads auto to do much unless you change server.jl to use threads. OTOH, there's no point launching loads of threads if you're doing multiprocessing anyway (you probably want one thread or process  per core, not more).", "author": "cmcaine", "createdAt": "2020-12-17T23:10:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM4MzA4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ2Njk5NQ==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6215#discussion_r545466995", "bodyText": "FWIW, I think this is all you need to make this multithreaded:\nThreads.@threads for _ in 1:Threads.nthreads()\n    HTTP.listen(\"0.0.0.0\", 8080, reuseaddr=true) do http\n        # blah\n    end\nend", "author": "cmcaine", "createdAt": "2020-12-17T23:15:13Z", "path": "frameworks/Julia/Http.jl/server.jl", "diffHunk": "@@ -1,7 +1,13 @@\n+using Pkg\n+\n+Pkg.activate(@__DIR__)\n+\n using HTTP\n-using JSON\n+import JSON3\n using Dates\n+using Sockets\n \n+@info \"starting listener\"\n HTTP.listen(\"0.0.0.0\", 8080, reuseaddr=true) do http", "originalCommit": "21aa61ea0ce7fd24c78701fe36c0cc8f8b4855ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUwNzkyMA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6215#discussion_r545507920", "bodyText": "Thanks! I tried this both with the multiple processes and without and both were significantly slower than the current state - any theories as to why?", "author": "mcmcgrath13", "createdAt": "2020-12-18T01:10:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ2Njk5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUxNDg5Ng==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6215#discussion_r545514896", "bodyText": "Sorry for the bad steer! I'm just skimming the code in HTTP.jl, but nothing is screaming out to me.\nIf you're doing multiprocess with SO_REUSEPORT (which you are if reuseaddr=true and you're on a *nix), then the kernel can handle all the shared state (working out which stream is for which listener) for you, and maybe whatever Julia is doing in threaded mode is getting in the way of that?\nOr it could be something to do with your OS. Maybe the process ulimits aren't high enough, so 8 threads sharing the same limits are losing out when compared to 8 processes with independent ulimits. No real idea. Just guesses.", "author": "cmcaine", "createdAt": "2020-12-18T01:32:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ2Njk5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ2NzUzOQ==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6215#discussion_r545467539", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            using Sockets\n          \n      \n    \n    \n  \n\nThis import is unused. Maybe you intended to use the @ip_str macro below?", "author": "cmcaine", "createdAt": "2020-12-17T23:16:39Z", "path": "frameworks/Julia/Http.jl/server.jl", "diffHunk": "@@ -1,7 +1,13 @@\n+using Pkg\n+\n+Pkg.activate(@__DIR__)\n+\n using HTTP\n-using JSON\n+import JSON3\n using Dates\n+using Sockets", "originalCommit": "21aa61ea0ce7fd24c78701fe36c0cc8f8b4855ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "83a6e31e7ab53b1f11716dc23e7566b0abf41598", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/83a6e31e7ab53b1f11716dc23e7566b0abf41598", "message": "Update frameworks/Julia/Http.jl/server.jl\n\nCo-authored-by: Colin Caine <cmcaine@gmail.com>", "committedDate": "2020-12-18T01:09:43Z", "type": "commit"}]}