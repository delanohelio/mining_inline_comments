{"pr_number": 5728, "pr_title": "Improved the Quarkus benchmark and added a pgclient variant", "pr_createdAt": "2020-06-03T13:32:12Z", "pr_url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYzNTY5Mw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r434635693", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \"webserver\": \"Undertow\",\n          \n          \n            \n                    \"webserver\": \"None\",\n          \n      \n    \n    \n  \n\nthe pgclient implementation is using reactive routes from from vert.x-web. This should not be Undertow", "author": "johnaohara", "createdAt": "2020-06-03T15:01:57Z", "path": "frameworks/Java/quarkus/benchmark_config.json", "diffHunk": "@@ -55,7 +41,7 @@\n         \"flavor\": \"None\",\n         \"orm\": \"Micro\",\n         \"platform\": \"JAX-RS\",\n-        \"webserver\": \"None\",\n+        \"webserver\": \"Undertow\",", "originalCommit": "e86f670a22bf01360b0e028e0b9573888a05d2b3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYzNzkxNw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r434637917", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                sudo podman run --ulimit memlock=-1:-1 -it --rm=true --network host --memory-swappiness=0 --name HibernateTestingPGSQL -e POSTGRES_USER=benchmarkdbuser -e POSTGRES_PASSWORD=benchmarkdbpass -e POSTGRES_DB=hello_world -p 5432:5432 postgres:12\n          \n          \n            \n            Using podman;\n          \n          \n            \n            \n          \n          \n            \n                    podman run --ulimit memlock=-1:-1 -it --rm=true --network host --memory-swappiness=0 --name HibernateTestingPGSQL -e POSTGRES_USER=benchmarkdbuser -e POSTGRES_PASSWORD=benchmarkdbpass -e POSTGRES_DB=hello_world -p 5432:5432 postgres:12\n          \n          \n            \n            \n          \n          \n            \n            Using docker;\n          \n          \n            \n            \n          \n          \n            \n                    sudo docker run --ulimit memlock=-1:-1 -it --rm=true --network host --memory-swappiness=0 --name HibernateTestingPGSQL -e POSTGRES_USER=benchmarkdbuser -e POSTGRES_PASSWORD=benchmarkdbpass -e POSTGRES_DB=hello_world -p 5432:5432 postgres:12\n          \n      \n    \n    \n  \n\npodman should run as the current user, also provide an alternative for using docker", "author": "johnaohara", "createdAt": "2020-06-03T15:04:57Z", "path": "frameworks/Java/quarkus/hibernate/README.md", "diffHunk": "@@ -0,0 +1,69 @@\n+# Local development\n+\n+During development it might be easier to start a PostgreSQL instance directly:\n+\n+    sudo podman run --ulimit memlock=-1:-1 -it --rm=true --network host --memory-swappiness=0 --name HibernateTestingPGSQL -e POSTGRES_USER=benchmarkdbuser -e POSTGRES_PASSWORD=benchmarkdbpass -e POSTGRES_DB=hello_world -p 5432:5432 postgres:12", "originalCommit": "e86f670a22bf01360b0e028e0b9573888a05d2b3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4ODA5Ng==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r434788096", "bodyText": "Instantiating a new object for each request is one of the requirements.\n\ni. For each request, an object mapping the key message to Hello, World! must be instantiated.", "author": "michaelhixson", "createdAt": "2020-06-03T19:00:54Z", "path": "frameworks/Java/quarkus/hibernate/src/main/java/io/quarkus/benchmark/resource/JsonResource.java", "diffHunk": "@@ -1,22 +1,22 @@\n package io.quarkus.benchmark.resource;\n \n-import java.util.Map;\n-import java.util.concurrent.CompletableFuture;\n-import java.util.concurrent.CompletionStage;\n-\n import javax.ws.rs.GET;\n import javax.ws.rs.Path;\n import javax.ws.rs.Produces;\n import javax.ws.rs.core.MediaType;\n+import java.util.Collections;\n+import java.util.Map;\n \n @Path(\"/json\")\n public class JsonResource {\n     private static final String MESSAGE = \"message\";\n     private static final String HELLO = \"Hello, World!\";\n+    private static final Map<String, String> map = Collections.singletonMap( MESSAGE, HELLO );", "originalCommit": "af116a29ebabba790e6ec76651085ae89f49440e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgxMzI0Nw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r434813247", "bodyText": "Oops, missed that. Fixed.", "author": "FroMage", "createdAt": "2020-06-03T19:46:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4ODA5Ng=="}], "type": "inlineReview"}, {"oid": "b862ee66d9c41b9e4eec37f440ba1785fc14bd2d", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/b862ee66d9c41b9e4eec37f440ba1785fc14bd2d", "message": "Improved the Quarkus benchmark and added a pgclient variant", "committedDate": "2020-06-03T19:45:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NTQwOA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r436295408", "bodyText": "should flight recorder be enabled for benchmarks?", "author": "kenyee", "createdAt": "2020-06-06T19:42:40Z", "path": "frameworks/Java/quarkus/hibernate/start-app.sh", "diffHunk": "@@ -0,0 +1 @@\n+java -XX:+FlightRecorder -XX:+UseParallelGC -Dquarkus.datasource.url=jdbc:postgresql://localhost:5432/hello_world?loggerLevel=OFF\\&disableColumnSanitiser=true\\&assumeMinServerVersion=12\\&sslmode=disable -Dquarkus.http.host=127.0.0.1 -Djava.lang.Integer.IntegerCache.high=10000 -Dvertx.disableHttpHeadersValidation=true -Dvertx.disableMetrics=true -Dvertx.disableH2c=true -Dvertx.disableWebsockets=true -Dvertx.flashPolicyHandler=false -Dvertx.threadChecks=false -Dvertx.disableContextTimings=true -Dvertx.disableTCCL=true -Dhibernate.allow_update_outside_transaction=true -Djboss.threads.eqe.statistics=false -jar target/hibernate-1.0-SNAPSHOT-runner.jar", "originalCommit": "b862ee66d9c41b9e4eec37f440ba1785fc14bd2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUyOTk1Ng==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r436529956", "bodyText": "This is for developping the benchmark, to figure out how to make it better.", "author": "FroMage", "createdAt": "2020-06-08T08:22:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NTQwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NTUwMw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r436295503", "bodyText": "would be nice for these to be constants for readability", "author": "kenyee", "createdAt": "2020-06-06T19:44:27Z", "path": "frameworks/Java/quarkus/pgclient/src/main/java/io/quarkus/benchmark/repository/pgclient/PgClientFactory.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package io.quarkus.benchmark.repository.pgclient;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.enterprise.inject.Produces;\n+import javax.inject.Inject;\n+\n+import org.eclipse.microprofile.config.inject.ConfigProperty;\n+\n+import io.vertx.mutiny.core.Vertx;\n+import io.vertx.mutiny.pgclient.PgPool;\n+import io.vertx.pgclient.PgConnectOptions;\n+import io.vertx.sqlclient.PoolOptions;\n+\n+@ApplicationScoped\n+public class PgClientFactory {\n+\n+\t@ConfigProperty(name = \"quarkus.datasource.url\")\n+\tString url;\n+\n+\t@ConfigProperty(name = \"quarkus.datasource.username\")\n+\tString user;\n+\n+\t@ConfigProperty(name = \"quarkus.datasource.password\")\n+\tString pass;\n+\n+\t@Inject\n+\tVertx vertx;\n+\n+\t@Produces\n+\t@ApplicationScoped\n+\tpublic PgClients pgClients() {\n+\t    return new PgClients(this);\n+\t}\n+\n+\n+\tPgPool sqlClient(int size) {\n+\t\tPoolOptions options = new PoolOptions();\n+\t\tPgConnectOptions connectOptions = new PgConnectOptions();\n+\t\t// vertx-reactive:postgresql://tfb-database:5432/hello_world\n+\t\tMatcher matcher = Pattern.compile(\"vertx-reactive:postgresql://([-a-zA-Z]+):([0-9]+)/(.*)\").matcher(url);\n+\t\tmatcher.matches();\n+\t\tconnectOptions.setDatabase(matcher.group(3));", "originalCommit": "b862ee66d9c41b9e4eec37f440ba1785fc14bd2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUzMjI3OA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r436532278", "bodyText": "Done.", "author": "FroMage", "createdAt": "2020-06-08T08:26:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NTUwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NTU1MQ==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r436295551", "bodyText": "would be nice for the 4 to be a constant for readability", "author": "kenyee", "createdAt": "2020-06-06T19:45:07Z", "path": "frameworks/Java/quarkus/pgclient/src/main/java/io/quarkus/benchmark/repository/pgclient/PgClients.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package io.quarkus.benchmark.repository.pgclient;\n+\n+import io.vertx.mutiny.pgclient.PgPool;\n+import io.vertx.mutiny.sqlclient.SqlClient;\n+\n+class PgClients {\n+    private ThreadLocal<SqlClient> sqlClient = new ThreadLocal<>();\n+    private ThreadLocal<PgPool> pool = new ThreadLocal<>();\n+    private PgClientFactory pgClientFactory;\n+\n+\t// for ArC\n+\tpublic PgClients() {\n+\t}\n+\n+\tpublic PgClients(PgClientFactory pgClientFactory) {\n+\t    this.pgClientFactory = pgClientFactory;\n+    }\n+\n+    SqlClient getClient() {\n+        SqlClient ret = sqlClient.get();\n+        if(ret == null) {\n+            ret = pgClientFactory.sqlClient(1);\n+            sqlClient.set(ret);\n+        }\n+\t\treturn ret;\n+\t}\n+\n+\tsynchronized PgPool getPool() {\n+        PgPool ret = pool.get();\n+        if(ret == null) {\n+            ret = pgClientFactory.sqlClient(4);", "originalCommit": "b862ee66d9c41b9e4eec37f440ba1785fc14bd2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUzMjIyMA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r436532220", "bodyText": "Done.", "author": "FroMage", "createdAt": "2020-06-08T08:26:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NTU1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NTYyMw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r436295623", "bodyText": "isn't specifying the column names explicitly faster than using *?", "author": "kenyee", "createdAt": "2020-06-06T19:46:11Z", "path": "frameworks/Java/quarkus/pgclient/src/main/java/io/quarkus/benchmark/repository/pgclient/WorldRepository.java", "diffHunk": "@@ -1,46 +1,38 @@\n package io.quarkus.benchmark.repository.pgclient;\n \n-import java.util.concurrent.Executors;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n \n import javax.enterprise.context.ApplicationScoped;\n import javax.inject.Inject;\n \n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n import io.quarkus.benchmark.model.World;\n-import io.reactivex.Maybe;\n-import io.reactivex.Scheduler;\n-import io.reactivex.Single;\n-import io.reactivex.schedulers.Schedulers;\n-import io.vertx.reactivex.pgclient.PgPool;\n-import io.vertx.reactivex.sqlclient.RowIterator;\n-import io.vertx.reactivex.sqlclient.RowSet;\n-import io.vertx.reactivex.sqlclient.Tuple;\n+import io.smallrye.mutiny.Uni;\n+import io.vertx.mutiny.sqlclient.Row;\n+import io.vertx.mutiny.sqlclient.Tuple;\n \n @ApplicationScoped\n public class WorldRepository {\n \n-    private static Logger LOG = LoggerFactory.getLogger(WorldRepository.class);\n-\n     @Inject\n-    PgPool client;\n-\n-    private final Scheduler scheduler = Schedulers.from(Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors() * 2));\n-\n-    public Maybe<World> find(int id) {\n-        return client.rxPreparedQuery(\"SELECT id, randomnumber FROM world WHERE id = $1\", Tuple.of(id))\n-                .map(RowSet::iterator)\n-                .filter(RowIterator::hasNext)\n-                .map(RowIterator::next)\n-                .map(row -> new World(row.getInteger(0), row.getInteger(1)))\n-                .subscribeOn(scheduler);\n+    PgClients clients;\n+\n+    public Uni<World> find(int id) {\n+        return clients.getClient().preparedQuery(\"SELECT * FROM World WHERE id = $1\", Tuple.of(id))", "originalCommit": "b862ee66d9c41b9e4eec37f440ba1785fc14bd2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUzMjE2Mw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r436532163", "bodyText": "True, fixed.", "author": "FroMage", "createdAt": "2020-06-08T08:26:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NTYyMw=="}], "type": "inlineReview"}, {"oid": "28e83d9d2d342cb931e925580b35f50ed891b7ca", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/28e83d9d2d342cb931e925580b35f50ed891b7ca", "message": "Improved the Quarkus benchmark and added a pgclient variant", "committedDate": "2020-06-08T08:26:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ3MTcyNA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r439471724", "bodyText": "As of right now, you need a test named \"default\" or the toolset spits up a bunch of warnings. You'll have to change this and rename the quarkus-hibernate.dockerfile to quarkus.dockerfile", "author": "nbrady-techempower", "createdAt": "2020-06-12T14:58:43Z", "path": "frameworks/Java/quarkus/benchmark_config.json", "diffHunk": "@@ -2,8 +2,12 @@\n   \"framework\": \"quarkus\",\n   \"tests\": [\n     {\n-      \"default\": {\n+      \"hibernate\": {", "originalCommit": "28e83d9d2d342cb931e925580b35f50ed891b7ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAzMjg5Mg==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r440032892", "bodyText": "Thanks. If I do that, will we still get two entries in the benchmark run or do I actually need to split this off into another entry entirely?", "author": "FroMage", "createdAt": "2020-06-15T09:04:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ3MTcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI5OTQ5NQ==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r440299495", "bodyText": "Sorry, I don't understand the question. We're just changing the key to the test. It shouldn't change the number of entries or require you split anything off.", "author": "nbrady-techempower", "createdAt": "2020-06-15T16:28:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ3MTcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMwMjk0Nw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r440302947", "bodyText": "Just to clarify: this will still end up with two different result lines in the benchmark results, right?", "author": "FroMage", "createdAt": "2020-06-15T16:34:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ3MTcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMwNDIxMw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r440304213", "bodyText": "Ah, yes. You will have a quarkus result which will be the first \"default\" one, and then a quarkus-pgclient result. There will still be two different result lines.", "author": "nbrady-techempower", "createdAt": "2020-06-15T16:36:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ3MTcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3MTI2MQ==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/5728#discussion_r440671261", "bodyText": "OK thanks, done.", "author": "FroMage", "createdAt": "2020-06-16T08:19:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ3MTcyNA=="}], "type": "inlineReview"}, {"oid": "0c464c0296f71ce67ba4d2f38ac280c0d0ce6554", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/0c464c0296f71ce67ba4d2f38ac280c0d0ce6554", "message": "Improved the Quarkus benchmark and added a pgclient variant", "committedDate": "2020-06-16T08:14:38Z", "type": "commit"}, {"oid": "0c464c0296f71ce67ba4d2f38ac280c0d0ce6554", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/0c464c0296f71ce67ba4d2f38ac280c0d0ce6554", "message": "Improved the Quarkus benchmark and added a pgclient variant", "committedDate": "2020-06-16T08:14:38Z", "type": "forcePushed"}]}