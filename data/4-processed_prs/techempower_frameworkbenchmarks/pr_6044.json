{"pr_number": 6044, "pr_title": "Optimise swoole-pg", "pr_createdAt": "2020-09-27T14:43:46Z", "pr_url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6044", "timeline": [{"oid": "4e4b7c92048f52e81afb7e7d7b0e9bb6d90916fe", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/4e4b7c92048f52e81afb7e7d7b0e9bb6d90916fe", "message": "Optimise swoole-pg", "committedDate": "2020-09-27T14:42:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5MzUzNw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6044#discussion_r495593537", "bodyText": "$db->s is useless and could be removed.\nThis is enouth, no?\n$db->prepare('s', 'SELECT id, randomnumber FROM World WHERE id = $1');", "author": "jcheron", "createdAt": "2020-09-27T17:06:14Z", "path": "frameworks/PHP/swoole/swoole-server.php", "diffHunk": "@@ -38,15 +38,15 @@\n     // Create an array with the response string.\n     $arr = [];\n \n-    $db->prepare('s', 'SELECT id, randomnumber FROM World WHERE id = $1');\n+    $db->s = $db->s ?? $db->prepare('s', 'SELECT id, randomnumber FROM World WHERE id = $1');", "originalCommit": "4e4b7c92048f52e81afb7e7d7b0e9bb6d90916fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwMTUzMw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6044#discussion_r495601533", "bodyText": "@jcheron Thanks for the review, but$db->s is used to store states, it is initialized only once across multiple requests and added by purpose.\nThere is no such API $db->s->execute([$id]);.\nSame thing for the following suggestions.", "author": "doubaokun", "createdAt": "2020-09-27T18:35:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5MzUzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYyMDM3OA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6044#discussion_r495620378", "bodyText": "I wrongly assumed (looking at the results) that the initialization was done only once for each worker, since the query is named (s):\n$db->prepare('s', 'SELECT id, randomnumber FROM World WHERE id = $1');\nThis is indeed not the case.\nSo you only use $db->s to avoid preparing the same query several times, it's ok.\nI have some difficulties to figure out the implementation logic of Swoole_postgres (which doesn't respect the same interface as Mysq).\nYou can just make it a little shorter by using:\n$db->s ??= $db->prepare('s', 'SELECT id, randomnumber FROM World WHERE id = $1');", "author": "jcheron", "createdAt": "2020-09-27T21:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5MzUzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYyMDk5NA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6044#discussion_r495620994", "bodyText": "Hi @jcheron, these variable are for checking if the prepare query is executed at least once and making sure they are executed only once. For performance reason, these prepare queries are only executed one time for all the requests after the change. Hope this make sense?", "author": "doubaokun", "createdAt": "2020-09-27T21:57:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5MzUzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYyMzU4OQ==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6044#discussion_r495623589", "bodyText": "Hi @doubaokun\nI modified my previous comment after testing", "author": "jcheron", "createdAt": "2020-09-27T22:26:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5MzUzNw=="}], "type": "inlineReview"}, {"oid": "3a7f95b9c15ea0f5310497c8d2c00abf3d49459c", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/3a7f95b9c15ea0f5310497c8d2c00abf3d49459c", "message": "updated.", "committedDate": "2020-09-27T22:32:48Z", "type": "commit"}]}