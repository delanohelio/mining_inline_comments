{"pr_number": 6023, "pr_title": "Lithium update", "pr_createdAt": "2020-09-21T09:34:05Z", "pr_url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6023", "timeline": [{"oid": "6314af57f54c139651bb6af6c217074373f5f371", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/6314af57f54c139651bb6af6c217074373f5f371", "message": "Lithium update", "committedDate": "2020-09-21T09:53:40Z", "type": "commit"}, {"oid": "991c38cf4e4249cef8e3fa20c13d85cae1c68b34", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/991c38cf4e4249cef8e3fa20c13d85cae1c68b34", "message": "Lithium update", "committedDate": "2020-09-21T10:08:00Z", "type": "commit"}, {"oid": "69887f91cd2b88a658ec332fc2ba7d860a703243", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/69887f91cd2b88a658ec332fc2ba7d860a703243", "message": "Lithium update", "committedDate": "2020-09-21T10:17:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE2OTcxNw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6023#discussion_r492169717", "bodyText": "It's too early on Monday morning for me to figure out exactly what this cache is doing or why it's needed but if it's caching anything so that subsequent serializations require less work, it's a violation of the last rule in the JSON requirements.\n\nThe serialization to JSON must not be cached\n\nhttps://github.com/TechEmpower/FrameworkBenchmarks/wiki/Project-Information-Framework-Tests-Overview#json-serialization", "author": "nbrady-techempower", "createdAt": "2020-09-21T15:53:18Z", "path": "frameworks/C++/lithium/lithium.cc", "diffHunk": "@@ -54,7 +54,31 @@ void siege(int port) {\n }\n #endif\n \n-lru_cache<int, decltype(mmm(s::id = int(), s::randomNumber = int()))> world_cache(10000);\n+struct json_cache {\n+\n+  template <typename T>\n+  void insert(T o) { \n+    if (0 == buffer.size())\n+      positions.push_back(buffer.size());\n+    buffer.append(json_encode(o)); \n+    positions.push_back(buffer.size());\n+  }\n+  std::string get_json_array(const std::vector<int>& ids) {\n+    std::string json = \"[\";\n+    json.append(buffer, positions[ids[0]], positions[ids[0]+1] - positions[ids[0]]);\n+    for (int i = 1; i < ids.size(); i++) {\n+      json.append(1, ',');\n+      json.append(buffer, positions[ids[i]], positions[ids[i]+1] - positions[ids[i]]);\n+    }\n+    json.append(1, ']');\n+    return json;\n+  }\n+\n+  std::string buffer;\n+  std::vector<int> positions;\n+};\n+\n+json_cache world_cache;", "originalCommit": "69887f91cd2b88a658ec332fc2ba7d860a703243", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI1MDk1Ng==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6023#discussion_r492250956", "bodyText": "Sorry @nbrady-techempower  I forgot about this rule. I removed the json caching in my last commit.", "author": "matt-42", "createdAt": "2020-09-21T18:06:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE2OTcxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI1MzQ0NQ==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6023#discussion_r492253445", "bodyText": "Thanks! Will merge when it passes travis!", "author": "nbrady-techempower", "createdAt": "2020-09-21T18:11:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE2OTcxNw=="}], "type": "inlineReview"}, {"oid": "365ac0271cec6b210de3122a951e661b8667d3e3", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/365ac0271cec6b210de3122a951e661b8667d3e3", "message": "Lithium: Remove json caching.", "committedDate": "2020-09-21T18:22:49Z", "type": "commit"}, {"oid": "cb46b674484155975a21ef8e57ad8c0a7c8b783c", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/cb46b674484155975a21ef8e57ad8c0a7c8b783c", "message": "Lithium: Fix cached queries.", "committedDate": "2020-09-21T19:10:16Z", "type": "commit"}]}