{"pr_number": 6157, "pr_title": "fix: make OCaml webmachine multiprocess", "pr_createdAt": "2020-11-22T01:29:55Z", "pr_url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157", "timeline": [{"oid": "63aecce94483b6b7c68d8b0fbb03f72b39d97100", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/63aecce94483b6b7c68d8b0fbb03f72b39d97100", "message": "fix: make OCaml webmachine multiprocess\n\n* revert haproxy http mode + keep alive as it incurred a 40% performance penalty\n* spawned child processes is configurable with CORE_COUNT to still allow\n  a fair Haproxy comparison", "committedDate": "2020-11-22T01:27:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTMyNQ==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528269325", "bodyText": "We should probably remove haproxy from the OCaml benchmarks, now that we know that sharing a socket yields better throughput", "author": "blandinw", "createdAt": "2020-11-22T02:06:28Z", "path": "frameworks/OCaml/webmachine/haproxy.cfg", "diffHunk": "@@ -7,10 +7,10 @@ global\n     nbthread    2\n \n defaults\n-    mode                    http\n+    mode                    tcp", "originalCommit": "63aecce94483b6b7c68d8b0fbb03f72b39d97100", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI4Nzc1OA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528287758", "bodyText": "In the long term yes but I would like to have one run completed to see how much overhead it adds. Locally the plaintext test actually produces a higher RPS behind haproxy than with the multiprocess approach.", "author": "rbjorklin", "createdAt": "2020-11-22T06:02:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTMyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTQyOA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528269428", "bodyText": "We probably shouldn't ignore the return value (promise) of all the async Lwt functions.\nAlternatively, you can use regular Printf when you're not serving requests yet.", "author": "blandinw", "createdAt": "2020-11-22T02:07:40Z", "path": "frameworks/OCaml/webmachine/src/src/bin/tfb.ml", "diffHunk": "@@ -138,7 +139,46 @@ class queries =\n       Wm.continue (`String (Lib.Db_j.string_of_queries json)) rd\n   end\n \n+let dump_lwt () =\n+  let options =\n+    [\n+      (\"fd_passing\", `fd_passing);\n+      (\"fdatasync\", `fdatasync);\n+      (\"get_affinity\", `get_affinity);\n+      (\"get_cpu\", `get_cpu);\n+      (\"get_credentials\", `get_credentials);\n+      (\"libev\", `libev);\n+      (\"madvise\", `madvise);\n+      (\"mincore\", `mincore);\n+      (\"recv_msg\", `recv_msg);\n+      (\"send_msg\", `send_msg);\n+      (\"set_affinity\", `set_affinity);\n+      (\"wait4\", `wait4);\n+    ]\n+  in\n+  ignore @@ Lwt_io.eprintf \"Lwt:\\n\";", "originalCommit": "63aecce94483b6b7c68d8b0fbb03f72b39d97100", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI4Nzg2MA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528287860", "bodyText": "I agree I just don't know how to make it work without either ignoring the promise or using the regular Printf. My Lwt foo is pretty weak so any pointers on how to make this work with Lwt_io without ignore would be appreciated.", "author": "rbjorklin", "createdAt": "2020-11-22T06:04:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTQyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODM4MzUxNw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528383517", "bodyText": "Lwt exposes a monadic API (monadic just means that you chain things together using the bind, aka. >>= or >|= operators) to allow you to do just that.\nCurrently, you're starting up async computations in a fire and forget fashion instead of executing them sequentially. If you're familiar with Javascript promises, you can think of >>= and >|= as .then(). You can look at my code in httpaf_unix.ml for an example of using the monadic API. There's a lot of information encoded in the type signatures of the Lwt monadic functions, do not hesitate to scrutinize them, as well as the type signatures of >>=, >|= and Lwt_main.run.", "author": "blandinw", "createdAt": "2020-11-22T18:13:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTQyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTQzOQ==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528269439", "bodyText": "why not use all cores?", "author": "blandinw", "createdAt": "2020-11-22T02:07:58Z", "path": "frameworks/OCaml/webmachine/src/src/bin/tfb.ml", "diffHunk": "@@ -138,7 +139,46 @@ class queries =\n       Wm.continue (`String (Lib.Db_j.string_of_queries json)) rd\n   end\n \n+let dump_lwt () =\n+  let options =\n+    [\n+      (\"fd_passing\", `fd_passing);\n+      (\"fdatasync\", `fdatasync);\n+      (\"get_affinity\", `get_affinity);\n+      (\"get_cpu\", `get_cpu);\n+      (\"get_credentials\", `get_credentials);\n+      (\"libev\", `libev);\n+      (\"madvise\", `madvise);\n+      (\"mincore\", `mincore);\n+      (\"recv_msg\", `recv_msg);\n+      (\"send_msg\", `send_msg);\n+      (\"set_affinity\", `set_affinity);\n+      (\"wait4\", `wait4);\n+    ]\n+  in\n+  ignore @@ Lwt_io.eprintf \"Lwt:\\n\";\n+  List.iter\n+    (fun (str, opt) ->\n+      ignore @@ Lwt_io.eprintf \"  %s = %b\\n\" str (Lwt_sys.have opt))\n+    options\n+\n let main () =\n+  (* https://github.com/mirage/ocaml-cohttp/issues/328#issuecomment-222583580 *)\n+  Lwt_io.set_default_buffer_size 0x10000;\n+  let nproc =\n+    match Sys.getenv \"CORE_COUNT\" with", "originalCommit": "63aecce94483b6b7c68d8b0fbb03f72b39d97100", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI4ODA0Nw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528288047", "bodyText": "I wanted to compare the forking shared socket approach with a multiprocess multisocket approach while still using your tweaks to memoize the Date header.", "author": "rbjorklin", "createdAt": "2020-11-22T06:06:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTQzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTQ0OQ==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528269449", "bodyText": "See above, don't discard returned promise, or use regular Printf", "author": "blandinw", "createdAt": "2020-11-22T02:08:21Z", "path": "frameworks/OCaml/webmachine/src/src/bin/tfb.ml", "diffHunk": "@@ -138,7 +139,46 @@ class queries =\n       Wm.continue (`String (Lib.Db_j.string_of_queries json)) rd\n   end\n \n+let dump_lwt () =\n+  let options =\n+    [\n+      (\"fd_passing\", `fd_passing);\n+      (\"fdatasync\", `fdatasync);\n+      (\"get_affinity\", `get_affinity);\n+      (\"get_cpu\", `get_cpu);\n+      (\"get_credentials\", `get_credentials);\n+      (\"libev\", `libev);\n+      (\"madvise\", `madvise);\n+      (\"mincore\", `mincore);\n+      (\"recv_msg\", `recv_msg);\n+      (\"send_msg\", `send_msg);\n+      (\"set_affinity\", `set_affinity);\n+      (\"wait4\", `wait4);\n+    ]\n+  in\n+  ignore @@ Lwt_io.eprintf \"Lwt:\\n\";\n+  List.iter\n+    (fun (str, opt) ->\n+      ignore @@ Lwt_io.eprintf \"  %s = %b\\n\" str (Lwt_sys.have opt))\n+    options\n+\n let main () =\n+  (* https://github.com/mirage/ocaml-cohttp/issues/328#issuecomment-222583580 *)\n+  Lwt_io.set_default_buffer_size 0x10000;\n+  let nproc =\n+    match Sys.getenv \"CORE_COUNT\" with\n+    | x -> int_of_string x\n+    | exception Not_found ->\n+        Unix.open_process_in \"getconf _NPROCESSORS_ONLN\"\n+        |> input_line\n+        |> int_of_string\n+  in\n+  ignore @@ Lwt_io.eprintf \"Detected %d cores\\n\" nproc;", "originalCommit": "63aecce94483b6b7c68d8b0fbb03f72b39d97100", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTc4Mw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528269783", "bodyText": "See above, don't discard returned promise, or use regular Printf", "author": "blandinw", "createdAt": "2020-11-22T02:12:05Z", "path": "frameworks/OCaml/webmachine/src/src/bin/tfb.ml", "diffHunk": "@@ -138,7 +139,46 @@ class queries =\n       Wm.continue (`String (Lib.Db_j.string_of_queries json)) rd\n   end\n \n+let dump_lwt () =\n+  let options =\n+    [\n+      (\"fd_passing\", `fd_passing);\n+      (\"fdatasync\", `fdatasync);\n+      (\"get_affinity\", `get_affinity);\n+      (\"get_cpu\", `get_cpu);\n+      (\"get_credentials\", `get_credentials);\n+      (\"libev\", `libev);\n+      (\"madvise\", `madvise);\n+      (\"mincore\", `mincore);\n+      (\"recv_msg\", `recv_msg);\n+      (\"send_msg\", `send_msg);\n+      (\"set_affinity\", `set_affinity);\n+      (\"wait4\", `wait4);\n+    ]\n+  in\n+  ignore @@ Lwt_io.eprintf \"Lwt:\\n\";\n+  List.iter\n+    (fun (str, opt) ->\n+      ignore @@ Lwt_io.eprintf \"  %s = %b\\n\" str (Lwt_sys.have opt))\n+    options\n+\n let main () =\n+  (* https://github.com/mirage/ocaml-cohttp/issues/328#issuecomment-222583580 *)\n+  Lwt_io.set_default_buffer_size 0x10000;\n+  let nproc =\n+    match Sys.getenv \"CORE_COUNT\" with\n+    | x -> int_of_string x\n+    | exception Not_found ->\n+        Unix.open_process_in \"getconf _NPROCESSORS_ONLN\"\n+        |> input_line\n+        |> int_of_string\n+  in\n+  ignore @@ Lwt_io.eprintf \"Detected %d cores\\n\" nproc;\n+  let ulimit_n =\n+    Unix.open_process_in \"ulimit -n\" |> input_line |> int_of_string\n+  in\n+  ignore @@ Lwt_io.eprintf \"Detected %d max open files\\n\" ulimit_n;", "originalCommit": "63aecce94483b6b7c68d8b0fbb03f72b39d97100", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTgxMA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528269810", "bodyText": "See above, don't discard returned promise, or use regular Printf", "author": "blandinw", "createdAt": "2020-11-22T02:12:13Z", "path": "frameworks/OCaml/webmachine/src/src/bin/tfb.ml", "diffHunk": "@@ -160,35 +200,36 @@ let main () =\n      | Some result -> result)\n     >>= fun (status, headers, body, _) ->\n     let headers = Header.add headers \"Server\" \"webmachine\" in\n-    let headers = Header.add headers \"Date\" (Lib.Time.now ()) in\n+    let headers = Header.add headers \"Date\" Lib.Time.(!memo_date) in\n     Server.respond ~headers ~body ~status ()\n   in\n \n-  let config = Server.make ~callback () in\n-  Server.create ~mode:(`TCP (`Port port)) config >|= fun () ->\n-  Printf.eprintf \"hello_lwt: listening on 0.0.0.0:%d%!\" port\n-\n-let () =\n-  let options =\n-    [\n-      (\"fd_passing\", `fd_passing);\n-      (\"fdatasync\", `fdatasync);\n-      (\"get_affinity\", `get_affinity);\n-      (\"get_cpu\", `get_cpu);\n-      (\"get_credentials\", `get_credentials);\n-      (\"libev\", `libev);\n-      (\"madvise\", `madvise);\n-      (\"mincore\", `mincore);\n-      (\"recv_msg\", `recv_msg);\n-      (\"send_msg\", `send_msg);\n-      (\"set_affinity\", `set_affinity);\n-      (\"wait4\", `wait4);\n-    ]\n+  let ipaddr = Unix.inet_addr_any in\n+  let sockaddr = Unix.ADDR_INET (ipaddr, port) in\n+  let socket =\n+    Lwt_unix.socket (Unix.domain_of_sockaddr sockaddr) Unix.SOCK_STREAM 0\n   in\n-  List.iter\n-    (fun (str, opt) ->\n-      print_endline (\"option \" ^ str ^ \": \" ^ string_of_bool (Lwt_sys.have opt)))\n-    options;\n-  (* https://github.com/mirage/ocaml-cohttp/issues/328#issuecomment-222583580 *)\n-  Lwt_io.set_default_buffer_size 0x10000;\n-  Lwt_main.run (main ())\n+  Lwt_unix.setsockopt socket Unix.SO_REUSEADDR true;\n+\n+  Lwt_main.run\n+  @@ ( Lwt_unix.bind socket sockaddr >|= fun () ->\n+       Lwt_unix.listen socket (Lwt_unix.somaxconn () [@ocaml.warning \"-3\"]) );\n+\n+  for i = 1 to nproc do\n+    ignore @@ Lwt_io.flush_all ();", "originalCommit": "63aecce94483b6b7c68d8b0fbb03f72b39d97100", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTgxNg==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528269816", "bodyText": "See above, don't discard returned promise, or use regular Printf", "author": "blandinw", "createdAt": "2020-11-22T02:12:18Z", "path": "frameworks/OCaml/webmachine/src/src/bin/tfb.ml", "diffHunk": "@@ -160,35 +200,36 @@ let main () =\n      | Some result -> result)\n     >>= fun (status, headers, body, _) ->\n     let headers = Header.add headers \"Server\" \"webmachine\" in\n-    let headers = Header.add headers \"Date\" (Lib.Time.now ()) in\n+    let headers = Header.add headers \"Date\" Lib.Time.(!memo_date) in\n     Server.respond ~headers ~body ~status ()\n   in\n \n-  let config = Server.make ~callback () in\n-  Server.create ~mode:(`TCP (`Port port)) config >|= fun () ->\n-  Printf.eprintf \"hello_lwt: listening on 0.0.0.0:%d%!\" port\n-\n-let () =\n-  let options =\n-    [\n-      (\"fd_passing\", `fd_passing);\n-      (\"fdatasync\", `fdatasync);\n-      (\"get_affinity\", `get_affinity);\n-      (\"get_cpu\", `get_cpu);\n-      (\"get_credentials\", `get_credentials);\n-      (\"libev\", `libev);\n-      (\"madvise\", `madvise);\n-      (\"mincore\", `mincore);\n-      (\"recv_msg\", `recv_msg);\n-      (\"send_msg\", `send_msg);\n-      (\"set_affinity\", `set_affinity);\n-      (\"wait4\", `wait4);\n-    ]\n+  let ipaddr = Unix.inet_addr_any in\n+  let sockaddr = Unix.ADDR_INET (ipaddr, port) in\n+  let socket =\n+    Lwt_unix.socket (Unix.domain_of_sockaddr sockaddr) Unix.SOCK_STREAM 0\n   in\n-  List.iter\n-    (fun (str, opt) ->\n-      print_endline (\"option \" ^ str ^ \": \" ^ string_of_bool (Lwt_sys.have opt)))\n-    options;\n-  (* https://github.com/mirage/ocaml-cohttp/issues/328#issuecomment-222583580 *)\n-  Lwt_io.set_default_buffer_size 0x10000;\n-  Lwt_main.run (main ())\n+  Lwt_unix.setsockopt socket Unix.SO_REUSEADDR true;\n+\n+  Lwt_main.run\n+  @@ ( Lwt_unix.bind socket sockaddr >|= fun () ->\n+       Lwt_unix.listen socket (Lwt_unix.somaxconn () [@ocaml.warning \"-3\"]) );\n+\n+  for i = 1 to nproc do\n+    ignore @@ Lwt_io.flush_all ();\n+    if Lwt_unix.fork () = 0 then (\n+      (* child *)\n+      Lib.Time.refresh_date ();\n+      ignore\n+      @@ Lwt_io.eprintf \"Listening on %s:%d (child %d)\\n\"", "originalCommit": "63aecce94483b6b7c68d8b0fbb03f72b39d97100", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTg2Nw==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528269867", "bodyText": "See above, don't discard returned promise, or use regular Printf", "author": "blandinw", "createdAt": "2020-11-22T02:13:05Z", "path": "frameworks/OCaml/webmachine/src/src/bin/tfb.ml", "diffHunk": "@@ -160,35 +200,36 @@ let main () =\n      | Some result -> result)\n     >>= fun (status, headers, body, _) ->\n     let headers = Header.add headers \"Server\" \"webmachine\" in\n-    let headers = Header.add headers \"Date\" (Lib.Time.now ()) in\n+    let headers = Header.add headers \"Date\" Lib.Time.(!memo_date) in\n     Server.respond ~headers ~body ~status ()\n   in\n \n-  let config = Server.make ~callback () in\n-  Server.create ~mode:(`TCP (`Port port)) config >|= fun () ->\n-  Printf.eprintf \"hello_lwt: listening on 0.0.0.0:%d%!\" port\n-\n-let () =\n-  let options =\n-    [\n-      (\"fd_passing\", `fd_passing);\n-      (\"fdatasync\", `fdatasync);\n-      (\"get_affinity\", `get_affinity);\n-      (\"get_cpu\", `get_cpu);\n-      (\"get_credentials\", `get_credentials);\n-      (\"libev\", `libev);\n-      (\"madvise\", `madvise);\n-      (\"mincore\", `mincore);\n-      (\"recv_msg\", `recv_msg);\n-      (\"send_msg\", `send_msg);\n-      (\"set_affinity\", `set_affinity);\n-      (\"wait4\", `wait4);\n-    ]\n+  let ipaddr = Unix.inet_addr_any in\n+  let sockaddr = Unix.ADDR_INET (ipaddr, port) in\n+  let socket =\n+    Lwt_unix.socket (Unix.domain_of_sockaddr sockaddr) Unix.SOCK_STREAM 0\n   in\n-  List.iter\n-    (fun (str, opt) ->\n-      print_endline (\"option \" ^ str ^ \": \" ^ string_of_bool (Lwt_sys.have opt)))\n-    options;\n-  (* https://github.com/mirage/ocaml-cohttp/issues/328#issuecomment-222583580 *)\n-  Lwt_io.set_default_buffer_size 0x10000;\n-  Lwt_main.run (main ())\n+  Lwt_unix.setsockopt socket Unix.SO_REUSEADDR true;\n+\n+  Lwt_main.run\n+  @@ ( Lwt_unix.bind socket sockaddr >|= fun () ->\n+       Lwt_unix.listen socket (Lwt_unix.somaxconn () [@ocaml.warning \"-3\"]) );\n+\n+  for i = 1 to nproc do\n+    ignore @@ Lwt_io.flush_all ();\n+    if Lwt_unix.fork () = 0 then (\n+      (* child *)\n+      Lib.Time.refresh_date ();\n+      ignore\n+      @@ Lwt_io.eprintf \"Listening on %s:%d (child %d)\\n\"\n+           (Unix.string_of_inet_addr ipaddr)\n+           port i;\n+      let config = Server.make ~callback () in\n+      ignore @@ Server.create ~mode:(`TCP (`Socket socket)) config;", "originalCommit": "63aecce94483b6b7c68d8b0fbb03f72b39d97100", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTg4NA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528269884", "bodyText": "You need to loop here, because any signal is gonna wake up the process", "author": "blandinw", "createdAt": "2020-11-22T02:13:27Z", "path": "frameworks/OCaml/webmachine/src/src/bin/tfb.ml", "diffHunk": "@@ -160,35 +200,36 @@ let main () =\n      | Some result -> result)\n     >>= fun (status, headers, body, _) ->\n     let headers = Header.add headers \"Server\" \"webmachine\" in\n-    let headers = Header.add headers \"Date\" (Lib.Time.now ()) in\n+    let headers = Header.add headers \"Date\" Lib.Time.(!memo_date) in\n     Server.respond ~headers ~body ~status ()\n   in\n \n-  let config = Server.make ~callback () in\n-  Server.create ~mode:(`TCP (`Port port)) config >|= fun () ->\n-  Printf.eprintf \"hello_lwt: listening on 0.0.0.0:%d%!\" port\n-\n-let () =\n-  let options =\n-    [\n-      (\"fd_passing\", `fd_passing);\n-      (\"fdatasync\", `fdatasync);\n-      (\"get_affinity\", `get_affinity);\n-      (\"get_cpu\", `get_cpu);\n-      (\"get_credentials\", `get_credentials);\n-      (\"libev\", `libev);\n-      (\"madvise\", `madvise);\n-      (\"mincore\", `mincore);\n-      (\"recv_msg\", `recv_msg);\n-      (\"send_msg\", `send_msg);\n-      (\"set_affinity\", `set_affinity);\n-      (\"wait4\", `wait4);\n-    ]\n+  let ipaddr = Unix.inet_addr_any in\n+  let sockaddr = Unix.ADDR_INET (ipaddr, port) in\n+  let socket =\n+    Lwt_unix.socket (Unix.domain_of_sockaddr sockaddr) Unix.SOCK_STREAM 0\n   in\n-  List.iter\n-    (fun (str, opt) ->\n-      print_endline (\"option \" ^ str ^ \": \" ^ string_of_bool (Lwt_sys.have opt)))\n-    options;\n-  (* https://github.com/mirage/ocaml-cohttp/issues/328#issuecomment-222583580 *)\n-  Lwt_io.set_default_buffer_size 0x10000;\n-  Lwt_main.run (main ())\n+  Lwt_unix.setsockopt socket Unix.SO_REUSEADDR true;\n+\n+  Lwt_main.run\n+  @@ ( Lwt_unix.bind socket sockaddr >|= fun () ->\n+       Lwt_unix.listen socket (Lwt_unix.somaxconn () [@ocaml.warning \"-3\"]) );\n+\n+  for i = 1 to nproc do\n+    ignore @@ Lwt_io.flush_all ();\n+    if Lwt_unix.fork () = 0 then (\n+      (* child *)\n+      Lib.Time.refresh_date ();\n+      ignore\n+      @@ Lwt_io.eprintf \"Listening on %s:%d (child %d)\\n\"\n+           (Unix.string_of_inet_addr ipaddr)\n+           port i;\n+      let config = Server.make ~callback () in\n+      ignore @@ Server.create ~mode:(`TCP (`Socket socket)) config;\n+      let forever, _ = Lwt.wait () in\n+      Lwt_main.run forever;\n+      exit 0 )\n+  done;\n+  Unix.pause ()", "originalCommit": "63aecce94483b6b7c68d8b0fbb03f72b39d97100", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI4ODE2NQ==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528288165", "bodyText": "It seems to work without a loop, what could happen?\nWith the loop all signals are effectively ignored, right?", "author": "rbjorklin", "createdAt": "2020-11-22T06:07:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODM4NjIzNA==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528386234", "bodyText": "Well, if you want to keep the (parent) process running (for example if it's your monitored Docker process), you should loop to avoid exiting.\nIf you don't care about the parent process (as currently, since haproxy is actually the monitored Docker process), you can just remove Unix.pause altogether. You'd need to update the code if you get rid of haproxy.\nMy main point was that the current version (Unix.pause without loop) looks unintended.", "author": "blandinw", "createdAt": "2020-11-22T18:34:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTkwMQ==", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/pull/6157#discussion_r528269901", "bodyText": "why not use all cores?", "author": "blandinw", "createdAt": "2020-11-22T02:13:46Z", "path": "frameworks/OCaml/webmachine/webmachine-haproxy.dockerfile", "diffHunk": "@@ -8,6 +8,8 @@ ENV TZ  :/etc/localtime\n # https://linux.die.net/man/1/ocamlrun\n # https://blog.janestreet.com/memory-allocator-showdown/\n ENV OCAMLRUNPARAM a=2,o=240\n+# This makes the program only spawn one child process to serve requests\n+ENV CORE_COUNT 1", "originalCommit": "63aecce94483b6b7c68d8b0fbb03f72b39d97100", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "53ea7ffb5003c0032b2b56e3a1ef251e9c6c4610", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/53ea7ffb5003c0032b2b56e3a1ef251e9c6c4610", "message": "chore: address review comments for OCaml webmachine", "committedDate": "2020-11-23T05:36:06Z", "type": "commit"}, {"oid": "a9076f94d5f2ea8e79708fc5f14d480b93108101", "url": "https://github.com/TechEmpower/FrameworkBenchmarks/commit/a9076f94d5f2ea8e79708fc5f14d480b93108101", "message": "fix(OCaml): use sparse ocamlformat style for better diff-ability", "committedDate": "2020-11-23T05:37:12Z", "type": "commit"}]}