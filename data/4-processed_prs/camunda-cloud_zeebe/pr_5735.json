{"pr_number": 5735, "pr_title": "chore(ci): stash/unstash build artifacts", "pr_createdAt": "2020-10-30T14:00:52Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5735", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTExOTg1Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5735#discussion_r515119857", "bodyText": "Only the jars build by us in the Build (Java) stage are stashed and unstashed, we still need to download all external dependencies from nexus so this can no longer be offline", "author": "korthout", "createdAt": "2020-10-30T14:02:11Z", "path": ".ci/scripts/distribution/it-java.sh", "diffHunk": "@@ -5,7 +5,7 @@ export JAVA_TOOL_OPTIONS=\"$JAVA_TOOL_OPTIONS -XX:MaxRAMFraction=$((LIMITS_CPU))\"\n \n tmpfile=$(mktemp)\n \n-mvn -o -B --fail-never -T$LIMITS_CPU -s ${MAVEN_SETTINGS_XML} verify -P skip-unstable-ci,parallel-tests -pl qa/integration-tests -pl upgrade-tests -DtestMavenId=2 -Dsurefire.rerunFailingTestsCount=7 | tee ${tmpfile}\n+mvn -B --fail-never -T$LIMITS_CPU -s ${MAVEN_SETTINGS_XML} verify -P skip-unstable-ci,parallel-tests -pl qa/integration-tests -pl upgrade-tests -DtestMavenId=2 -Dsurefire.rerunFailingTestsCount=7 | tee ${tmpfile}", "originalCommit": "c6e33397b2d435821d0044f54defda7890243f93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEyMjAwOA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5735#discussion_r515122008", "bodyText": "Can't we just stash the whole .m2 folder?", "author": "npepinpe", "createdAt": "2020-10-30T14:04:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTExOTg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzMTA4NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5735#discussion_r515131084", "bodyText": "Please don't, that will depending on the size put severe load on the Jenkins central server as per https://www.jenkins.io/doc/pipeline/steps/workflow-basic-steps/#stash-stash-some-files-to-be-used-later-in-the-build:\n\nThis is because stashed files are archived in a compressed TAR, and with large files this demands considerable on-master resources, particularly CPU time. There's not a hard stash size limit, but between 5-100 MB you should probably consider alternatives.", "author": "cmur2", "createdAt": "2020-10-30T14:18:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTExOTg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzMjExMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5735#discussion_r515132113", "bodyText": "Hm, I suggested this because Optimize does it I think ;) What would you propose? Re-downloading all the artifacts is non negligible, and sometimes may cause builds to fail (which is one of the reason we decided to go offline after the initial pull in the past).", "author": "npepinpe", "createdAt": "2020-10-30T14:19:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTExOTg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzMjQwOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5735#discussion_r515132409", "bodyText": "With stashing the artifacts produced by the Build (Java) stage we're already a bit over the limits suggested by the documentation. To preserve the whole .m2 folder a completely different approach needs to be taken, e.g. using a GCloud storage bucket with subfolders per branch and build number. This in turn involves having the GCloud SDK/gsutil tool available to the build and proper authentication etc.", "author": "cmur2", "createdAt": "2020-10-30T14:20:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTExOTg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEzNDkyNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5735#discussion_r515134925", "bodyText": "Hm, I suggested this because Optimize does it I think ;)\n\nI think Optimize caches also not everything but just org.camunda Maven group artifacts I think: https://github.com/camunda/camunda-optimize/blob/master/Jenkinsfile#L319\n\nRe-downloading all the artifacts is non negligible, and sometimes may cause builds to fail (which is one of the reason we decided to go offline after the initial pull in the past).\n\nRe-downloading is quite fine because we employ Maven caches located in the same K8s cluster as the CI jobs. They are referred using cluster-local URLs so also quite isolated and stable.", "author": "cmur2", "createdAt": "2020-10-30T14:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTExOTg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE0OTYxMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5735#discussion_r515149612", "bodyText": "@npepinpe do you see any other issues with not using --offline?", "author": "korthout", "createdAt": "2020-10-30T14:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTExOTg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE1Mjg5OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5735#discussion_r515152898", "bodyText": "I honestly can't remember why we did that, maybe @menski can?", "author": "npepinpe", "createdAt": "2020-10-30T14:50:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTExOTg1Nw=="}], "type": "inlineReview"}, {"oid": "89bc2f668be76287b289be82fd54728d1b627b07", "url": "https://github.com/camunda-cloud/zeebe/commit/89bc2f668be76287b289be82fd54728d1b627b07", "message": "chore(ci): stash/unstash build artifacts", "committedDate": "2020-10-30T14:04:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyMTY5MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5735#discussion_r515221691", "bodyText": "This change will be supported by camunda/infra-core#1729 but I'm holding back merging camunda/infra-core#1729 before it becomes clear that this PR get's green-lit.", "author": "cmur2", "createdAt": "2020-10-30T16:26:37Z", "path": "Jenkinsfile", "diffHunk": "@@ -69,12 +69,20 @@ pipeline {\n         }\n \n         stage('Build (Java)') {\n+            environment {\n+                VERSION = readMavenPom(file: 'parent/pom.xml').getVersion()\n+            }\n             steps {\n                 container('maven') {\n-                    configFileProvider([configFile(fileId: 'maven-nexus-settings-zeebe', variable: 'MAVEN_SETTINGS_XML')]) {\n+                    configFileProvider([configFile(fileId: 'maven-nexus-settings-zeebe-local-repo', variable: 'MAVEN_SETTINGS_XML')]) {", "originalCommit": "89bc2f668be76287b289be82fd54728d1b627b07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI1MTcxNA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5735#discussion_r524251714", "bodyText": "@cmur2 should that change be made before this is merged?", "author": "korthout", "createdAt": "2020-11-16T13:03:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyMTY5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2MjM1MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5735#discussion_r524262350", "bodyText": "The order here is arbitrary as the change is already applied in https://ci.zeebe.camunda.cloud/configfiles/editConfig?id=maven-nexus-settings-zeebe-local-repo so my PR camunda/infra-core#1729 can go before or after, it merely makes official configuration as code what is applied in prod.", "author": "cmur2", "createdAt": "2020-11-16T13:21:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyMTY5MQ=="}], "type": "inlineReview"}, {"oid": "f0b41dddd831f7f7a4a99fe6def4eb007ed4f1b7", "url": "https://github.com/camunda-cloud/zeebe/commit/f0b41dddd831f7f7a4a99fe6def4eb007ed4f1b7", "message": "chore(ci): split IT test-compile from verify", "committedDate": "2020-11-12T15:09:36Z", "type": "forcePushed"}, {"oid": "1ab8d8c4a1703389390b249c005a17e052d0bf8b", "url": "https://github.com/camunda-cloud/zeebe/commit/1ab8d8c4a1703389390b249c005a17e052d0bf8b", "message": "chore(ci): split IT test-compile from verify", "committedDate": "2020-11-12T15:25:10Z", "type": "forcePushed"}, {"oid": "a887f6a02db2a221ed3709c44a846d74eda7d724", "url": "https://github.com/camunda-cloud/zeebe/commit/a887f6a02db2a221ed3709c44a846d74eda7d724", "message": "chore(ci): split IT test-compile from verify", "committedDate": "2020-11-12T15:49:24Z", "type": "forcePushed"}, {"oid": "21e5b4a1dbb69766a78afd578987a75e7d29ab1c", "url": "https://github.com/camunda-cloud/zeebe/commit/21e5b4a1dbb69766a78afd578987a75e7d29ab1c", "message": "chore(ci): split IT test-compile from verify", "committedDate": "2020-11-12T16:14:23Z", "type": "forcePushed"}, {"oid": "eb986531609f827a8c339bff2f36c33d374050a2", "url": "https://github.com/camunda-cloud/zeebe/commit/eb986531609f827a8c339bff2f36c33d374050a2", "message": "chore(ci): split IT test-compile from verify", "committedDate": "2020-11-12T16:29:36Z", "type": "forcePushed"}, {"oid": "9423a6ca909a3cc2feef8675c6babe80b72f4aad", "url": "https://github.com/camunda-cloud/zeebe/commit/9423a6ca909a3cc2feef8675c6babe80b72f4aad", "message": "chore(ci): split IT test-compile from verify", "committedDate": "2020-11-12T16:47:17Z", "type": "forcePushed"}, {"oid": "6641951467cd632080fdcdf2c340d49a40cabf9a", "url": "https://github.com/camunda-cloud/zeebe/commit/6641951467cd632080fdcdf2c340d49a40cabf9a", "message": "chore(ci): split IT test-compile from verify", "committedDate": "2020-11-12T16:52:52Z", "type": "forcePushed"}, {"oid": "c46ed6a40b15630928f0c88d52e88d0a110aaf63", "url": "https://github.com/camunda-cloud/zeebe/commit/c46ed6a40b15630928f0c88d52e88d0a110aaf63", "message": "chore(ci): split IT test-compile from verify", "committedDate": "2020-11-12T17:37:55Z", "type": "forcePushed"}, {"oid": "45343b472be87801b490fb4f70d4f0b24caacfe8", "url": "https://github.com/camunda-cloud/zeebe/commit/45343b472be87801b490fb4f70d4f0b24caacfe8", "message": "chore(ci): tryout go-offline-maven-plugin", "committedDate": "2020-11-13T13:14:09Z", "type": "forcePushed"}, {"oid": "aa75a150170d3b4fb716e0e726e444cc8611210f", "url": "https://github.com/camunda-cloud/zeebe/commit/aa75a150170d3b4fb716e0e726e444cc8611210f", "message": "chore(ci): tryout go-offline-maven-plugin", "committedDate": "2020-11-13T13:31:54Z", "type": "forcePushed"}, {"oid": "00570f660a122eaa94163d37f28f17372b8318d6", "url": "https://github.com/camunda-cloud/zeebe/commit/00570f660a122eaa94163d37f28f17372b8318d6", "message": "chore(ci): tryout go-offline-maven-plugin", "committedDate": "2020-11-13T15:40:09Z", "type": "forcePushed"}, {"oid": "0ec1cfc9bd824cedf9ef7854d5fde0428f3dca8f", "url": "https://github.com/camunda-cloud/zeebe/commit/0ec1cfc9bd824cedf9ef7854d5fde0428f3dca8f", "message": "chore(ci): always analyze dependencies", "committedDate": "2020-11-13T16:18:43Z", "type": "forcePushed"}, {"oid": "1ba4bfca3905c48ca09ea074a3d63b6bf6a1dfa1", "url": "https://github.com/camunda-cloud/zeebe/commit/1ba4bfca3905c48ca09ea074a3d63b6bf6a1dfa1", "message": "chore(ci): always analyze dependencies", "committedDate": "2020-11-13T16:25:02Z", "type": "forcePushed"}, {"oid": "aebb4e91ac8e9454a57bb78e92ce28149142f6f6", "url": "https://github.com/camunda-cloud/zeebe/commit/aebb4e91ac8e9454a57bb78e92ce28149142f6f6", "message": "chore(ci): split IT prepare-offline from verify", "committedDate": "2020-11-16T09:25:38Z", "type": "forcePushed"}, {"oid": "438227154e79379a1208495eca443d5862b7e417", "url": "https://github.com/camunda-cloud/zeebe/commit/438227154e79379a1208495eca443d5862b7e417", "message": "chore(ci): split IT prepare-offline from verify", "committedDate": "2020-11-16T15:19:32Z", "type": "forcePushed"}, {"oid": "1169b902cea9a9a18f8b5e1e9beae3a3939b43d6", "url": "https://github.com/camunda-cloud/zeebe/commit/1169b902cea9a9a18f8b5e1e9beae3a3939b43d6", "message": "chore(ci): split IT prepare-offline from verify", "committedDate": "2020-11-16T15:34:54Z", "type": "forcePushed"}, {"oid": "92583ab182b4f70b49e94f2aa81cd994004c640d", "url": "https://github.com/camunda-cloud/zeebe/commit/92583ab182b4f70b49e94f2aa81cd994004c640d", "message": "fix(ci): try add junit surefire provider as dyn dep", "committedDate": "2020-11-17T10:34:07Z", "type": "forcePushed"}, {"oid": "1d7373a790169086544bbe235bed288786597c78", "url": "https://github.com/camunda-cloud/zeebe/commit/1d7373a790169086544bbe235bed288786597c78", "message": "chore(ci): stash/unstash build artifacts", "committedDate": "2020-11-17T10:42:23Z", "type": "commit"}, {"oid": "e499ce74508a392b67abaf9c0f01bea5dc8afebd", "url": "https://github.com/camunda-cloud/zeebe/commit/e499ce74508a392b67abaf9c0f01bea5dc8afebd", "message": "chore(ci): split IT prepare-offline from verify", "committedDate": "2020-11-17T12:35:08Z", "type": "commit"}, {"oid": "9276a857b73e4c37482c622a9f52f85d5e0710da", "url": "https://github.com/camunda-cloud/zeebe/commit/9276a857b73e4c37482c622a9f52f85d5e0710da", "message": "chore(ci): move dep-analysis out of profile", "committedDate": "2020-11-17T17:05:48Z", "type": "commit"}, {"oid": "9276a857b73e4c37482c622a9f52f85d5e0710da", "url": "https://github.com/camunda-cloud/zeebe/commit/9276a857b73e4c37482c622a9f52f85d5e0710da", "message": "chore(ci): move dep-analysis out of profile", "committedDate": "2020-11-17T17:05:48Z", "type": "forcePushed"}, {"oid": "c6813d189082ff5d211ad205cdb47a92f580cd13", "url": "https://github.com/camunda-cloud/zeebe/commit/c6813d189082ff5d211ad205cdb47a92f580cd13", "message": "fix(ci): use test-compile instead of initialize", "committedDate": "2020-11-17T18:54:55Z", "type": "commit"}]}