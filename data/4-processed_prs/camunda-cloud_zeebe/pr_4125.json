{"pr_number": 4125, "pr_title": "Align Java client with new cache format", "pr_createdAt": "2020-03-25T11:16:55Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/4125", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4MzUwNA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r397983504", "bodyText": "Is it in the spec that expiresIn is passed a seconds? Where is expires in coming from?", "author": "npepinpe", "createdAt": "2020-03-25T16:15:12Z", "path": "clients/java/src/main/java/io/zeebe/client/impl/ZeebeClientCredentials.java", "diffHunk": "@@ -50,9 +51,29 @@ public String getTokenType() {\n     return tokenType;\n   }\n \n+  @JsonSetter(\"expiry\")\n+  public void setExpiry(final String expiry) {\n+    this.expiry = ZonedDateTime.parse(expiry);\n+  }\n+\n+  @JsonSetter(\"expires_in\")\n+  public void setExpiresIn(final String expiresIn) {\n+    this.expiry = ZonedDateTime.now().plusSeconds(Long.parseLong(expiresIn));", "originalCommit": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQyNjM2MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r401426361", "bodyText": "Yes, https://tools.ietf.org/html/rfc6749#section-5.1 . I'm not sure if this is what you mean by \"where is it coming from\" but it comes from the auth response, like the access token and the bearer type.", "author": "MiguelPires", "createdAt": "2020-04-01T08:02:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4MzUwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4NTM5NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r397985395", "bodyText": "Can type be null?", "author": "npepinpe", "createdAt": "2020-03-25T16:17:45Z", "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -72,9 +71,12 @@ public void applyCredentials(final Metadata headers) throws IOException {\n       loadCredentials();\n     }\n \n-    headers.put(\n-        HEADER_AUTH_KEY,\n-        String.format(\"%s %s\", credentials.getTokenType(), credentials.getAccessToken()));\n+    String type = credentials.getTokenType();\n+    if (!type.isEmpty()) {", "originalCommit": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQyODI5Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r401428297", "bodyText": "Not unless something went wrong but I add a check nonetheless", "author": "MiguelPires", "createdAt": "2020-04-01T08:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4NTM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4NTk4Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r397985987", "bodyText": "If type == 'c', I think this will throw an out of bounds exception when doing type.substring(1)?", "author": "npepinpe", "createdAt": "2020-03-25T16:18:34Z", "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -72,9 +71,12 @@ public void applyCredentials(final Metadata headers) throws IOException {\n       loadCredentials();\n     }\n \n-    headers.put(\n-        HEADER_AUTH_KEY,\n-        String.format(\"%s %s\", credentials.getTokenType(), credentials.getAccessToken()));\n+    String type = credentials.getTokenType();\n+    if (!type.isEmpty()) {\n+      type = Character.toUpperCase(type.charAt(0)) + type.substring(1);", "originalCommit": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzMDQ4OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r401430489", "bodyText": "No, only if the index (1) was larger than the length (which we check in the line before)", "author": "MiguelPires", "createdAt": "2020-04-01T08:09:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4NTk4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ4OTY2NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r401489664", "bodyText": "\ud83d\udc4d", "author": "npepinpe", "createdAt": "2020-04-01T09:47:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4NTk4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk5MDM3OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r397990378", "bodyText": "What a strange little API that takes a string for charset and not the charset type...", "author": "npepinpe", "createdAt": "2020-03-25T16:24:11Z", "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -120,36 +122,48 @@ private boolean refreshCredentials() throws IOException {\n     final ZeebeClientCredentials fetchedCredentials = fetchCredentials();\n     credentialsCache.put(endpoint, fetchedCredentials).writeCache();\n \n-    if (fetchedCredentials.equals(credentials)) {\n-      return false;\n+    if (credentials == null || !credentials.isValid() || !fetchedCredentials.equals(credentials)) {\n+      credentials = fetchedCredentials;\n+      LOG.debug(\"Refreshed credentials.\");\n+\n+      return true;\n     }\n \n-    credentials = fetchedCredentials;\n-    LOG.debug(\"Refreshed credentials.\");\n-    return true;\n+    return false;\n   }\n \n-  private static String createJsonPayload(final OAuthCredentialsProviderBuilder builder)\n-      throws JsonProcessingException {\n+  private static String createParams(final OAuthCredentialsProviderBuilder builder) {\n     final Map<String, String> payload = new HashMap<>();\n     payload.put(\"client_id\", builder.getClientId());\n     payload.put(\"client_secret\", builder.getClientSecret());\n     payload.put(\"audience\", builder.getAudience());\n     payload.put(\"grant_type\", \"client_credentials\");\n \n-    return JSON_MAPPER.writeValueAsString(payload);\n+    final StringBuilder sb = new StringBuilder();\n+    payload.forEach((key, value) -> sb.append(String.format(\"%s=%s&\", encode(key), encode(value))));\n+    sb.deleteCharAt(sb.length() - 1);\n+    return sb.toString();\n+  }\n+\n+  private static String encode(final String param) {\n+    try {\n+      return URLEncoder.encode(param, StandardCharsets.UTF_8.name());", "originalCommit": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzMTQ2Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r401431467", "bodyText": "Later versions take the charset as well but only since java 10", "author": "MiguelPires", "createdAt": "2020-04-01T08:11:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk5MDM3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk5NDc3MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r397994770", "bodyText": "Nit: would this also work without having to deal with the awkward deletion of the last '&'?\n    payload.entrySet().stream()\n        .map(e -> encode(e.getKey()) + \"=\" + encode(e.getValue()))\n        .collect(Collectors.joining(\"&\"));\nDidn't test it, just off the top of my head, feel free to ignore if it seems more complicated - I just always find this extra deleting awkward", "author": "npepinpe", "createdAt": "2020-03-25T16:30:00Z", "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -120,36 +122,48 @@ private boolean refreshCredentials() throws IOException {\n     final ZeebeClientCredentials fetchedCredentials = fetchCredentials();\n     credentialsCache.put(endpoint, fetchedCredentials).writeCache();\n \n-    if (fetchedCredentials.equals(credentials)) {\n-      return false;\n+    if (credentials == null || !credentials.isValid() || !fetchedCredentials.equals(credentials)) {\n+      credentials = fetchedCredentials;\n+      LOG.debug(\"Refreshed credentials.\");\n+\n+      return true;\n     }\n \n-    credentials = fetchedCredentials;\n-    LOG.debug(\"Refreshed credentials.\");\n-    return true;\n+    return false;\n   }\n \n-  private static String createJsonPayload(final OAuthCredentialsProviderBuilder builder)\n-      throws JsonProcessingException {\n+  private static String createParams(final OAuthCredentialsProviderBuilder builder) {\n     final Map<String, String> payload = new HashMap<>();\n     payload.put(\"client_id\", builder.getClientId());\n     payload.put(\"client_secret\", builder.getClientSecret());\n     payload.put(\"audience\", builder.getAudience());\n     payload.put(\"grant_type\", \"client_credentials\");\n \n-    return JSON_MAPPER.writeValueAsString(payload);\n+    final StringBuilder sb = new StringBuilder();\n+    payload.forEach((key, value) -> sb.append(String.format(\"%s=%s&\", encode(key), encode(value))));", "originalCommit": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzMjg0Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r401432846", "bodyText": "I agree, that's a better solution", "author": "MiguelPires", "createdAt": "2020-04-01T08:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk5NDc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYzMzE3Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r398633177", "bodyText": "Do we need to add the queryParams as query params if we pass them as body as well?", "author": "npepinpe", "createdAt": "2020-03-26T14:50:18Z", "path": "clients/java/src/main/java/io/zeebe/client/impl/oauth/OAuthCredentialsProvider.java", "diffHunk": "@@ -120,36 +122,48 @@ private boolean refreshCredentials() throws IOException {\n     final ZeebeClientCredentials fetchedCredentials = fetchCredentials();\n     credentialsCache.put(endpoint, fetchedCredentials).writeCache();\n \n-    if (fetchedCredentials.equals(credentials)) {\n-      return false;\n+    if (credentials == null || !credentials.isValid() || !fetchedCredentials.equals(credentials)) {\n+      credentials = fetchedCredentials;\n+      LOG.debug(\"Refreshed credentials.\");\n+\n+      return true;\n     }\n \n-    credentials = fetchedCredentials;\n-    LOG.debug(\"Refreshed credentials.\");\n-    return true;\n+    return false;\n   }\n \n-  private static String createJsonPayload(final OAuthCredentialsProviderBuilder builder)\n-      throws JsonProcessingException {\n+  private static String createParams(final OAuthCredentialsProviderBuilder builder) {\n     final Map<String, String> payload = new HashMap<>();\n     payload.put(\"client_id\", builder.getClientId());\n     payload.put(\"client_secret\", builder.getClientSecret());\n     payload.put(\"audience\", builder.getAudience());\n     payload.put(\"grant_type\", \"client_credentials\");\n \n-    return JSON_MAPPER.writeValueAsString(payload);\n+    final StringBuilder sb = new StringBuilder();\n+    payload.forEach((key, value) -> sb.append(String.format(\"%s=%s&\", encode(key), encode(value))));\n+    sb.deleteCharAt(sb.length() - 1);\n+    return sb.toString();\n+  }\n+\n+  private static String encode(final String param) {\n+    try {\n+      return URLEncoder.encode(param, StandardCharsets.UTF_8.name());\n+    } catch (UnsupportedEncodingException e) {\n+      throw new UncheckedIOException(\"Failed while encoding OAuth request parameters: \", e);\n+    }\n   }\n \n   private ZeebeClientCredentials fetchCredentials() throws IOException {\n     final HttpURLConnection connection =\n-        (HttpURLConnection) authorizationServerUrl.openConnection();\n+        (HttpURLConnection)\n+            new URL(String.format(\"%s?%s\", authorizationServerUrl, queryParams)).openConnection();", "originalCommit": "1729e373b5daee58b5bcea7cef9cc7c790c6ebfc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ3MDQxOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4125#discussion_r401470419", "bodyText": "No, that's a mistake. Thanks", "author": "MiguelPires", "createdAt": "2020-04-01T09:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYzMzE3Nw=="}], "type": "inlineReview"}, {"oid": "6b164d016c0b55c0da73d0b39484fd49407bf160", "url": "https://github.com/camunda-cloud/zeebe/commit/6b164d016c0b55c0da73d0b39484fd49407bf160", "message": "chore(clients/java): apply review feedback", "committedDate": "2020-04-01T09:52:21Z", "type": "forcePushed"}, {"oid": "976181895defeef61d29b447320a10b320334207", "url": "https://github.com/camunda-cloud/zeebe/commit/976181895defeef61d29b447320a10b320334207", "message": "chore(clients/java): align cache format with Go client\n\n* uses expiry instead of expires_in\n* robustness improvements (allows unknown fields, checks validity before request,etc)\n* add support to test clients with oauth2 providers", "committedDate": "2020-04-01T19:23:48Z", "type": "commit"}, {"oid": "976181895defeef61d29b447320a10b320334207", "url": "https://github.com/camunda-cloud/zeebe/commit/976181895defeef61d29b447320a10b320334207", "message": "chore(clients/java): align cache format with Go client\n\n* uses expiry instead of expires_in\n* robustness improvements (allows unknown fields, checks validity before request,etc)\n* add support to test clients with oauth2 providers", "committedDate": "2020-04-01T19:23:48Z", "type": "forcePushed"}]}