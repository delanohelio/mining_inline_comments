{"pr_number": 4139, "pr_title": "chore(qa): fix flaky snapshot replication test", "pr_createdAt": "2020-03-27T11:09:12Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/4139", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIwMTAxMA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4139#discussion_r399201010", "bodyText": "Nit: to get rid of warnings, you can use orElseThrow() instead of get() in tests, since probably if we didn't find it you'd want to abort anyway.", "author": "npepinpe", "createdAt": "2020-03-27T11:31:57Z", "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/SnapshotReplicationTest.java", "diffHunk": "@@ -77,9 +77,16 @@ public void shouldReplicateSnapshots() {\n   public void shouldReceiveLatestSnapshotOnRejoin() {\n     // given\n     final var leaderNodeId = clusteringRule.getLeaderForPartition(1).getNodeId();\n-    final var otherBrokers = clusteringRule.getOtherBrokerObjects(leaderNodeId);\n-    final var firstFollowerId = otherBrokers.get(0).getConfig().getCluster().getNodeId();\n-    final var secondFollowerId = otherBrokers.get(1).getConfig().getCluster().getNodeId();\n+    final var followers =\n+        clusteringRule.getOtherBrokerObjects(leaderNodeId).stream()\n+            .map(b -> b.getConfig().getCluster().getNodeId())\n+            .collect(Collectors.toList());\n+\n+    // Temp fix to make sure we don't restart broker-0 due to\n+    // https://github.com/zeebe-io/atomix/issues/208\n+    final var firstFollowerId = followers.stream().filter(nodeId -> nodeId != 0).findFirst().get();", "originalCommit": "7679ca22ebd8fa10e4251a3e5711996723dfd870", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIwMTQ1OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4139#discussion_r399201458", "bodyText": "Nit: by using implicit variable inference with var above, the type of firstFollowerId is now Number (i.e. it was not implicitly unboxed by casting it to int), so != checks object instance equality. I mean it works here but not sure if this is what you intended \ud83d\ude05", "author": "npepinpe", "createdAt": "2020-03-27T11:32:52Z", "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/SnapshotReplicationTest.java", "diffHunk": "@@ -77,9 +77,16 @@ public void shouldReplicateSnapshots() {\n   public void shouldReceiveLatestSnapshotOnRejoin() {\n     // given\n     final var leaderNodeId = clusteringRule.getLeaderForPartition(1).getNodeId();\n-    final var otherBrokers = clusteringRule.getOtherBrokerObjects(leaderNodeId);\n-    final var firstFollowerId = otherBrokers.get(0).getConfig().getCluster().getNodeId();\n-    final var secondFollowerId = otherBrokers.get(1).getConfig().getCluster().getNodeId();\n+    final var followers =\n+        clusteringRule.getOtherBrokerObjects(leaderNodeId).stream()\n+            .map(b -> b.getConfig().getCluster().getNodeId())\n+            .collect(Collectors.toList());\n+\n+    // Temp fix to make sure we don't restart broker-0 due to\n+    // https://github.com/zeebe-io/atomix/issues/208\n+    final var firstFollowerId = followers.stream().filter(nodeId -> nodeId != 0).findFirst().get();\n+    final var secondFollowerId =\n+        followers.stream().filter(nodeId -> nodeId != firstFollowerId).findFirst().get();", "originalCommit": "7679ca22ebd8fa10e4251a3e5711996723dfd870", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIwMjUzNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4139#discussion_r399202536", "bodyText": "Nit: I guess we could just sort by nodeId and always pick the last one, which is for sure not 0. But the intent of what we're doing may be less clear as we're not explicitly checking for != 0, which is more obvious. Plus I hope this is temporary, so \ud83e\udd37\u200d\u2642\ufe0f", "author": "npepinpe", "createdAt": "2020-03-27T11:34:53Z", "path": "qa/integration-tests/src/test/java/io/zeebe/broker/it/clustering/SnapshotReplicationTest.java", "diffHunk": "@@ -77,9 +77,16 @@ public void shouldReplicateSnapshots() {\n   public void shouldReceiveLatestSnapshotOnRejoin() {\n     // given\n     final var leaderNodeId = clusteringRule.getLeaderForPartition(1).getNodeId();\n-    final var otherBrokers = clusteringRule.getOtherBrokerObjects(leaderNodeId);\n-    final var firstFollowerId = otherBrokers.get(0).getConfig().getCluster().getNodeId();\n-    final var secondFollowerId = otherBrokers.get(1).getConfig().getCluster().getNodeId();\n+    final var followers =\n+        clusteringRule.getOtherBrokerObjects(leaderNodeId).stream()\n+            .map(b -> b.getConfig().getCluster().getNodeId())", "originalCommit": "7679ca22ebd8fa10e4251a3e5711996723dfd870", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9c0b590e0ca9aa41eb0d56802d6d2169e31f6379", "url": "https://github.com/camunda-cloud/zeebe/commit/9c0b590e0ca9aa41eb0d56802d6d2169e31f6379", "message": "chore(qa): fix flaky snapshot replication test", "committedDate": "2020-03-27T11:56:16Z", "type": "commit"}, {"oid": "9c0b590e0ca9aa41eb0d56802d6d2169e31f6379", "url": "https://github.com/camunda-cloud/zeebe/commit/9c0b590e0ca9aa41eb0d56802d6d2169e31f6379", "message": "chore(qa): fix flaky snapshot replication test", "committedDate": "2020-03-27T11:56:16Z", "type": "forcePushed"}]}