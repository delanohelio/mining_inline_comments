{"pr_number": 4108, "pr_title": "chore(broker): improve fault tolerance on snapshot replication errors", "pr_createdAt": "2020-03-23T11:07:22Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/4108", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYxODYzNw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4108#discussion_r396618637", "bodyText": "We could also use this new utility in DbPendingSnapshot.", "author": "deepthidevaki", "createdAt": "2020-03-23T17:16:16Z", "path": "util/src/main/java/io/zeebe/util/FileUtil.java", "diffHunk": "@@ -31,16 +32,28 @@\n \n   public static final Logger LOG = Loggers.FILE_LOGGER;\n \n+  private FileUtil() {}\n+\n   public static void deleteFolder(final String path) throws IOException {\n     final Path directory = Paths.get(path);\n \n     deleteFolder(directory);\n   }\n \n+  public static void ensureDirectoryExists(final Path directory) throws IOException {", "originalCommit": "1294ff39415d3736d3afe944268ee4898f7b4af7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYyMTI0NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4108#discussion_r396621245", "bodyText": "\ud83d\udc4d", "author": "deepthidevaki", "createdAt": "2020-03-23T17:19:57Z", "path": "broker/src/main/java/io/zeebe/broker/clustering/atomix/storage/snapshot/DbSnapshotStore.java", "diffHunk": "@@ -203,6 +205,15 @@ private DbSnapshot put(final Path directory, final DbSnapshotMetadata metadata)\n     return put(new DbSnapshot(destination, metadata));\n   }\n \n+  private void tryAtomicDirectoryMove(final Path directory, final Path destination)\n+      throws IOException {\n+    try {\n+      Files.move(directory, destination, StandardCopyOption.ATOMIC_MOVE);", "originalCommit": "1294ff39415d3736d3afe944268ee4898f7b4af7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1d5f193a801dd53edcfc805b06320c4a18bd4d07", "url": "https://github.com/camunda-cloud/zeebe/commit/1d5f193a801dd53edcfc805b06320c4a18bd4d07", "message": "chore(util): add FileUtil#ensureDirectoryExists", "committedDate": "2020-03-24T14:04:46Z", "type": "commit"}, {"oid": "0d61f0c9bacb7ee0abd41110dcf4f20f9f76c2b6", "url": "https://github.com/camunda-cloud/zeebe/commit/0d61f0c9bacb7ee0abd41110dcf4f20f9f76c2b6", "message": "chore(logstreams): invalidate snapshot on consume chunk failure\n\n- handles IOExceptions on consume chunk to invalid the snapshot\n- does not invalidate snapshot anymore if a chunk already exists", "committedDate": "2020-03-24T14:05:23Z", "type": "commit"}, {"oid": "572d7d5fb3ba443d2c66cdb576bbf2d46fd158a4", "url": "https://github.com/camunda-cloud/zeebe/commit/572d7d5fb3ba443d2c66cdb576bbf2d46fd158a4", "message": "chore(broker): handle snapshot commit I/O errors\n\n- properly handles snapshot commit I/O related errors instead of letting\n  them bubble up\n- attempts to perform atomic move when committing snapshot to avoid\n  having partial snapshots where applicable, with a fallback to normal\n  copy method", "committedDate": "2020-03-24T14:05:23Z", "type": "commit"}, {"oid": "513a4cd55e6515b25a93804a437b41b76226d5ee", "url": "https://github.com/camunda-cloud/zeebe/commit/513a4cd55e6515b25a93804a437b41b76226d5ee", "message": "chore(broker): fail writing pending snapshot if directory cannot be created", "committedDate": "2020-03-24T14:05:23Z", "type": "commit"}, {"oid": "513a4cd55e6515b25a93804a437b41b76226d5ee", "url": "https://github.com/camunda-cloud/zeebe/commit/513a4cd55e6515b25a93804a437b41b76226d5ee", "message": "chore(broker): fail writing pending snapshot if directory cannot be created", "committedDate": "2020-03-24T14:05:23Z", "type": "forcePushed"}]}