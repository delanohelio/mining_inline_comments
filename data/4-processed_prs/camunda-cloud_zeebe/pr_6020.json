{"pr_number": 6020, "pr_title": "Fixes multi agent post verification analysis", "pr_createdAt": "2020-12-16T17:40:19Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/6020", "timeline": [{"oid": "913b82b49caf3d58a05ea21d930f7b3af9df8d39", "url": "https://github.com/camunda-cloud/zeebe/commit/913b82b49caf3d58a05ea21d930f7b3af9df8d39", "message": "fix(ci): fix multi-agent post analysis\n\n- fixes JaCoCo analysis by stashing the IT agent results and unstashing\n  them in the main agent to make them available during post analysis\n- fixes flaky test analysis/build status by stashing the IT agent\n  results and unstashing them in the main agent for post analysis", "committedDate": "2020-12-16T17:41:19Z", "type": "forcePushed"}, {"oid": "840220f6688f7d96ba8d59901c8e75611088e643", "url": "https://github.com/camunda-cloud/zeebe/commit/840220f6688f7d96ba8d59901c8e75611088e643", "message": "fix(ci): fix multi-agent post analysis\n\n- fixes JaCoCo analysis by stashing the IT agent results and unstashing\n  them in the main agent to make them available during post analysis\n- fixes flaky test analysis/build status by stashing the IT agent\n  results and unstashing them in the main agent for post analysis", "committedDate": "2020-12-16T20:56:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkzNTY0Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/6020#discussion_r544935647", "bodyText": "Do we want to run test coverage for integration tests? I find this approach rather unusual.\nNormally, code coverage is recorded for unit tests primarily. Because for unit tests the code being executed is often the code being testen.\nFor integration tests, there is so much code being executed during a test that the code coverage metric becomes less useful.", "author": "pihme", "createdAt": "2020-12-17T09:25:14Z", "path": "Jenkinsfile", "diffHunk": "@@ -234,6 +250,13 @@ pipeline {\n                             post {\n                                 always {\n                                     junit testResults: \"**/*/TEST*${SUREFIRE_REPORT_NAME_SUFFIX}*.xml\", keepLongStdio: true\n+                                    stash allowEmpty: true, name: itJacocoStashName, includes: '**/*.exec'", "originalCommit": "840220f6688f7d96ba8d59901c8e75611088e643", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk0OTg5Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/6020#discussion_r544949893", "bodyText": "Actually I agree, it's simply that I wanted to restore the previous state (where we would've been running code coverage for integration tests). If we don't want this we should disable jacoco for the integration tests. I'm happy to do this as well, it should be just a simple addition in the IT module.", "author": "npepinpe", "createdAt": "2020-12-17T09:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkzNTY0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkzNzUxMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/6020#discussion_r544937513", "bodyText": "Question for my understanding:\nWhy do we need to stash these files for IT tests, but not for the other tests? Or in other words, how can I know for which agent I need to stash/unstash things and for which I don't need it?\nIs there same way we can make this clearer, e.g. by given the agents different names?", "author": "pihme", "createdAt": "2020-12-17T09:27:49Z", "path": "Jenkinsfile", "diffHunk": "@@ -234,6 +250,13 @@ pipeline {\n                             post {\n                                 always {\n                                     junit testResults: \"**/*/TEST*${SUREFIRE_REPORT_NAME_SUFFIX}*.xml\", keepLongStdio: true\n+                                    stash allowEmpty: true, name: itJacocoStashName, includes: '**/*.exec'\n+                                }\n+\n+                                failure {\n+                                    zip zipFile: 'test-reports-it.zip', archive: true, glob: \"**/*/surefire-reports/**\"\n+                                    zip zipFile: 'test-errors-it.zip', archive: true, glob: \"**/hs_err_*.log\"\n+                                    stash allowEmpty: true, name: itFlakyTestStashName, includes: '**/FlakyTests.txt'", "originalCommit": "840220f6688f7d96ba8d59901c8e75611088e643", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk1ODI1MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/6020#discussion_r544958251", "bodyText": "At the beginning of the pipeline, we define an agent:\nhttps://github.com/zeebe-io/zeebe/blob/9c7aa2cf9813e10dd7ddba65a8495bc94d7d5b0b/Jenkinsfile#L22-L30\nThis becomes our main/default agent for all stages, pre/post phases, etc. Everything in the pipeline, unless otherwise specified, runs in the main agent and thus shares the same workspace.\nYou can execute certain stages/steps in a different agent. To do this, in the stage, you need to explicitly say that you will use a different agent, e.g.:\nhttps://github.com/zeebe-io/zeebe/blob/9c7aa2cf9813e10dd7ddba65a8495bc94d7d5b0b/Jenkinsfile#L183-L191\nWhile you can't associate an agent block to a variable in a Groovy pipeline (unfortunately - I tried! although who knows, maybe I didn't do it well), they do have a name, or at least an ID - the label property of the agent. It will start a pod with that label and name, so you can use that to debug/introspect it with k8s. Note that if an agent with that label already exists, it will simply be reused (regardless of the podSpec). However, keep in mind that agents (Except the main one) are not kept around between stages, so you would always have a fresh workspace if you were specifying it in multiple places.\nEverything in that stage (so any nested stages/steps) will be executed on that agent, which has its own workspace. Workspaces are completely isolated from each other (as are agents), so any modifications done in one are not reflected in the others. This means, building the distribution in the main agent would only build it there, or running flaky tests analysis would only produce a FlakyTests.txt file in the agent where you ran the analysis.\nFinally, if you have a stage A which contains a nested stage B, where A is executed in the main agent and B is executed in a different agent, the post phase of A will be executed in the same agent as A, so it will only have access to that workspace. So if you want to see results from B (e.g. FlakyTests.txt), you need to copy it over to the workspace of A.\nSo to answer your question of how you know which agent you need to stash/unstash, it depends on what you want to do. Ideally the agents are entirely independent and we don't need to, but as you saw there's some cases where we want to share build artefacts (e.g. the distro, the FlakyTests.txt file, etc.).\nHope that helps!", "author": "npepinpe", "createdAt": "2020-12-17T09:57:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkzNzUxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk2MjE4OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/6020#discussion_r544962189", "bodyText": "I've added a comment which I hope explains a bit better what I just wrote.", "author": "npepinpe", "createdAt": "2020-12-17T10:03:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkzNzUxMw=="}], "type": "inlineReview"}, {"oid": "3f9b479f1bffc91a612c43d5b49afba839fa4955", "url": "https://github.com/camunda-cloud/zeebe/commit/3f9b479f1bffc91a612c43d5b49afba839fa4955", "message": "fix(ci): fix multi-agent post analysis\n\n- fixes JaCoCo analysis by stashing the IT agent results and unstashing\n  them in the main agent to make them available during post analysis\n- fixes flaky test analysis/build status by stashing the IT agent\n  results and unstashing them in the main agent for post analysis", "committedDate": "2020-12-17T10:06:28Z", "type": "commit"}, {"oid": "7c20b16417eadf17303a30a4457a89f7dc9f1723", "url": "https://github.com/camunda-cloud/zeebe/commit/7c20b16417eadf17303a30a4457a89f7dc9f1723", "message": "chore(qa): skip JaCoCo for IT", "committedDate": "2020-12-17T10:06:28Z", "type": "commit"}, {"oid": "7c20b16417eadf17303a30a4457a89f7dc9f1723", "url": "https://github.com/camunda-cloud/zeebe/commit/7c20b16417eadf17303a30a4457a89f7dc9f1723", "message": "chore(qa): skip JaCoCo for IT", "committedDate": "2020-12-17T10:06:28Z", "type": "forcePushed"}]}