{"pr_number": 6021, "pr_title": "CI scripts/pipeline clean up", "pr_createdAt": "2020-12-16T20:05:02Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/6021", "timeline": [{"oid": "f9971ab0094cc8e25e5ae963e5dc10ec43cd64f5", "url": "https://github.com/camunda-cloud/zeebe/commit/f9971ab0094cc8e25e5ae963e5dc10ec43cd64f5", "message": "chore(ci): extract utility function", "committedDate": "2020-12-16T20:58:40Z", "type": "forcePushed"}, {"oid": "5c2a58d6854e93f170f69232f9c86da32733a92c", "url": "https://github.com/camunda-cloud/zeebe/commit/5c2a58d6854e93f170f69232f9c86da32733a92c", "message": "chore(ci): extract utility function\n\n- centralizes how flaky tests are analyzed into a single utility\n  function", "committedDate": "2020-12-16T21:03:26Z", "type": "forcePushed"}, {"oid": "33d15bb5ecd6d24a3982239736d170cc55adc060", "url": "https://github.com/camunda-cloud/zeebe/commit/33d15bb5ecd6d24a3982239736d170cc55adc060", "message": "chore(ci): always stash results even if empty", "committedDate": "2020-12-17T10:20:08Z", "type": "forcePushed"}, {"oid": "ddcd99bbc040e52793937034049bc9d60b08f551", "url": "https://github.com/camunda-cloud/zeebe/commit/ddcd99bbc040e52793937034049bc9d60b08f551", "message": "chore(ci): dry up CI pipeline\n\n- comments variables and certain non obvious steps/ordering of steps\n- reuses helper functions as much as possible in Jenkinsfile\n- ensures maven is configured in a consistent way across multiple\n  scripts, whether building or testing\n- extract test-compile and prepare offline for the IT agent into the\n  prepare phase\n- centralizes how flaky tests are analyzed into a single utility\n  function", "committedDate": "2020-12-17T12:09:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA1MDQzNA==", "url": "https://github.com/camunda-cloud/zeebe/pull/6021#discussion_r545050434", "bodyText": "Moved here to avoid error if there are only flaky tests in the main agent, since you cannot test if a stash is present or not", "author": "npepinpe", "createdAt": "2020-12-17T12:25:14Z", "path": "Jenkinsfile", "diffHunk": "@@ -248,20 +259,19 @@ pipeline {\n \n                             steps {\n                                 timeout(time: longTimeoutMinutes, unit: 'MINUTES') {\n-                                    unstash name: \"zeebe-build\"\n                                     runMavenContainerCommand('.ci/scripts/distribution/it-java.sh')\n                                 }\n                             }\n \n                             post {\n                                 always {\n                                     junit testResults: \"**/*/TEST*${SUREFIRE_REPORT_NAME_SUFFIX}*.xml\", keepLongStdio: true\n+                                    stash allowEmpty: true, name: itFlakyTestStashName, includes: '**/FlakyTests.txt'", "originalCommit": "ddcd99bbc040e52793937034049bc9d60b08f551", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4MTM4MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/6021#discussion_r547181380", "bodyText": "This variable does not appear to be used anywhere, previously it was exported (see prev L3) and I think that may be important. Please verify", "author": "korthout", "createdAt": "2020-12-22T09:58:18Z", "path": ".ci/scripts/distribution/test-java8.sh", "diffHunk": "@@ -1,29 +1,28 @@\n #!/bin/bash -eux\n \n-export JAVA_TOOL_OPTIONS=\"$JAVA_TOOL_OPTIONS -XX:MaxRAMFraction=$((LIMITS_CPU))\"\n-\n-mvn -v\n-\n+source \"${BASH_SOURCE%/*}/../lib/flaky-tests.sh\"\n+\n+# getconf is a POSIX way to get the number of processors available which works on both Linux and macOS\n+LIMITS_CPU=${LIMITS_CPU:-$(getconf _NPROCESSORS_ONLN)}\n+MAVEN_PARALLELISM=${MAVEN_PARALLELISM:-$LIMITS_CPU}\n+SUREFIRE_FORK_COUNT=${SUREFIRE_FORK_COUNT:-}\n+MAVEN_PROPERTIES=(\n+  -DtestMavenId=3\n+  -Dsurefire.rerunFailingTestsCount=7\n+)\n tmpfile=$(mktemp)\n \n-mvn -o -B --fail-never -T$LIMITS_CPU -s ${MAVEN_SETTINGS_XML} verify -pl clients/java -DtestMavenId=3 -Dsurefire.rerunFailingTestsCount=7 | tee ${tmpfile}\n+if [ ! -z \"$SUREFIRE_FORK_COUNT\" ]; then\n+  MAVEN_PROPERTIES+=(\"-DforkCount=$SUREFIRE_FORK_COUNT\")\n+  # if we know the fork count, we can limit the max heap for each fork to ensure we're not OOM killed\n+  JAVA_TOOL_OPTIONS=\"${JAVA_TOOL_OPTIONS} -XX:MaxRAMPercentage=$((100 / ($MAVEN_PARALLELISM * $SUREFIRE_FORK_COUNT)))\"", "originalCommit": "ddcd99bbc040e52793937034049bc9d60b08f551", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjU4NTI3Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/6021#discussion_r552585276", "bodyText": "Ah, you're right it should be exported! \ud83d\ude48", "author": "npepinpe", "createdAt": "2021-01-06T12:59:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4MTM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjU4Njg4NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/6021#discussion_r552586884", "bodyText": "Consequences of not exporting means that you could run out of memory (the famous error code 137), but it seems not to have affected us too much.", "author": "npepinpe", "createdAt": "2021-01-06T13:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4MTM4MA=="}], "type": "inlineReview"}, {"oid": "f761296352ac5a826c431e53eaa1c5aa7bed71e5", "url": "https://github.com/camunda-cloud/zeebe/commit/f761296352ac5a826c431e53eaa1c5aa7bed71e5", "message": "chore(ci): dry up CI pipeline\n\n- comments variables and certain non obvious steps/ordering of steps\n- reuses helper functions as much as possible in Jenkinsfile\n- ensures maven is configured in a consistent way across multiple\n  scripts, whether building or testing\n- extract test-compile and prepare offline for the IT agent into the\n  prepare phase\n- centralizes how flaky tests are analyzed into a single utility\n  function", "committedDate": "2021-01-06T13:54:51Z", "type": "commit"}, {"oid": "f761296352ac5a826c431e53eaa1c5aa7bed71e5", "url": "https://github.com/camunda-cloud/zeebe/commit/f761296352ac5a826c431e53eaa1c5aa7bed71e5", "message": "chore(ci): dry up CI pipeline\n\n- comments variables and certain non obvious steps/ordering of steps\n- reuses helper functions as much as possible in Jenkinsfile\n- ensures maven is configured in a consistent way across multiple\n  scripts, whether building or testing\n- extract test-compile and prepare offline for the IT agent into the\n  prepare phase\n- centralizes how flaky tests are analyzed into a single utility\n  function", "committedDate": "2021-01-06T13:54:51Z", "type": "forcePushed"}]}