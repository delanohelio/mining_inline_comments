{"pr_number": 4607, "pr_title": "chore(atomix): initialize event subscriptions after listener is added", "pr_createdAt": "2020-05-27T06:18:11Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/4607", "timeline": [{"oid": "0c2110150de553e4315d0ca29b38352bbfe290cb", "url": "https://github.com/camunda-cloud/zeebe/commit/0c2110150de553e4315d0ca29b38352bbfe290cb", "message": "chore(atomix): initialize cluster event subscriptions after listener is added", "committedDate": "2020-05-27T06:12:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU2OTk5MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/4607#discussion_r431569990", "bodyText": "hm maybe we shouldn't put this to trace \ud83d\ude05", "author": "Zelldon", "createdAt": "2020-05-28T04:07:21Z", "path": "atomix/cluster/src/test/resources/log4j2-test.xml", "diffHunk": "@@ -9,7 +9,7 @@\n \n   <Loggers>\n     <Logger name=\"io.zeebe\" level=\"debug\"/>\n-    <Logger name=\"io.atomix\" level=\"debug\"/>\n+    <Logger name=\"io.atomix\" level=\"trace\"/>", "originalCommit": "0c2110150de553e4315d0ca29b38352bbfe290cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTczOTgwMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4607#discussion_r431739802", "bodyText": "If trace was enabled, debugging would have been easier by reading the logs from jenkins.  Traces gives an idea on the order of these operations. Is it too much to enable traces for test? It's not production.", "author": "deepthidevaki", "createdAt": "2020-05-28T10:35:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU2OTk5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc1OTAyMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4607#discussion_r431759021", "bodyText": "It's not production.\n\nTrue. But it still is quite noisy even debugging level and increases the log sizes of all tests, which is not necessary. But if you disagree just leave it as it is.", "author": "Zelldon", "createdAt": "2020-05-28T11:13:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU2OTk5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc2MjA4Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/4607#discussion_r431762086", "bodyText": "For some tests it could be noisy. But as long as no important log is removed, it would be ok right? In most cases I cannot reproduce these flaky tests locally and I rely on the jenkins logs to debug. If there are no relevant logs, then I have to spend a lot of time thinking what could have gone wrong, like in this case. How about enabling it trace now, and if it creates problems for other tests turn it back to debug?", "author": "deepthidevaki", "createdAt": "2020-05-28T11:19:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU2OTk5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc2MjYwMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4607#discussion_r431762603", "bodyText": "sounds good \ud83d\udc4d", "author": "Zelldon", "createdAt": "2020-05-28T11:20:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU2OTk5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3MDI5NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4607#discussion_r431570295", "bodyText": "might make sense to do that in the membershipService#addListener? Because this problem will also arise on other places probably furthermore the membership is in charge to do that I would say.", "author": "Zelldon", "createdAt": "2020-05-28T04:08:37Z", "path": "atomix/cluster/src/main/java/io/atomix/cluster/messaging/impl/DefaultClusterEventService.java", "diffHunk": "@@ -189,6 +190,10 @@ private String topicsAsString(final Set<String> topics) {\n           Executors.newSingleThreadScheduledExecutor(\n               namedThreads(\"atomix-cluster-event-executor-%d\", LOGGER));\n       membershipService.addListener(this);\n+      // Listener doesn't receive notification about the Members added before the listener is added.\n+      membershipService\n+          .getMembers()\n+          .forEach(m -> event(new ClusterMembershipEvent(Type.MEMBER_ADDED, m)));", "originalCommit": "0c2110150de553e4315d0ca29b38352bbfe290cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc1NTk5Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4607#discussion_r431755992", "bodyText": "That's right. It would prevent similar bugs in future. It is not the first time we encountered this I guess. That said, is it ok if I do it in another PR? We have to verify if it breaks existing listeners.", "author": "deepthidevaki", "createdAt": "2020-05-28T11:07:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3MDI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc1Njc5NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4607#discussion_r431756795", "bodyText": "Yes then please create a follow up issue \ud83d\ude42", "author": "Zelldon", "createdAt": "2020-05-28T11:08:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3MDI5NQ=="}], "type": "inlineReview"}]}