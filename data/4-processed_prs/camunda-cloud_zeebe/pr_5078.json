{"pr_number": 5078, "pr_title": "Improve stability of AtomixTransportTest", "pr_createdAt": "2020-07-30T09:31:47Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5078", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg4NTQ4Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5078#discussion_r462885482", "bodyText": "It is a bit confusing why this is called retry timeout for the request timeout.", "author": "Zelldon", "createdAt": "2020-07-30T09:55:11Z", "path": "transport/src/test/java/io/zeebe/transport/impl/AtomixTransportTest.java", "diffHunk": "@@ -202,7 +205,7 @@ public void shouldFailResponseWhenRequestHandlerThrowsException() {\n     // when\n     final var requestFuture =\n         clientTransport.sendRequestWithRetry(\n-            nodeAddressSupplier, new Request(\"messageABC\"), Duration.ofSeconds(1));\n+            nodeAddressSupplier, new Request(\"messageABC\"), RETRY_TIMEOUT);", "originalCommit": "a032407d651cf9c82da09f5e259237d40f683d69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMzcyNw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5078#discussion_r462923727", "bodyText": "Ok. I can rename it to REQUEST_TIMEOUT", "author": "saig0", "createdAt": "2020-07-30T11:12:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg4NTQ4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg4NjE2NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5078#discussion_r462886164", "bodyText": "You change the behavior of some tests, might make the tests more flaky, since now you have the request timeout and latch timeout as same value.", "author": "Zelldon", "createdAt": "2020-07-30T09:56:28Z", "path": "transport/src/test/java/io/zeebe/transport/impl/AtomixTransportTest.java", "diffHunk": "@@ -260,17 +265,18 @@ public void shouldRetryAndSucceedAfterNodeIsResolved() throws InterruptedExcepti\n     final var nodeAddressRef = new AtomicReference<String>();\n     final var retryLatch = new CountDownLatch(3);\n     serverTransport.subscribe(0, new DirectlyResponder()).join();\n+\n     final var requestFuture =\n         clientTransport.sendRequestWithRetry(\n             () -> {\n               retryLatch.countDown();\n               return nodeAddressRef.get();\n             },\n             new Request(\"messageABC\"),\n-            Duration.ofSeconds(5));", "originalCommit": "a032407d651cf9c82da09f5e259237d40f683d69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyNTcxMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5078#discussion_r462925713", "bodyText": "I don't think that I changed the behavior of the tests \ud83e\udd14 Setting the request timeout to the same as the timeout of the latch should be ok because the request and latch should be finished before 10 seconds.\nPlease correct me if I'm wrong.", "author": "saig0", "createdAt": "2020-07-30T11:16:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg4NjE2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyODgyNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5078#discussion_r462928826", "bodyText": "This is just an assumption, right? Since we don't know why we have the execution pauses it can also stop longer right? If the latch and timeout is the same it can happen that the timeout happens before. We not asserting that the latch succeed btw. before it waited until it the latch was triggered now you added a timeout which means you need to assert it.", "author": "Zelldon", "createdAt": "2020-07-30T11:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg4NjE2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk0MzY3Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5078#discussion_r462943673", "bodyText": "I reduced the timeout of the latch. If the request takes longer then the test has a higher chance to pass.\nI avoid checking the latch result for more stability. Otherwise, a test would fail if it retries just 2 of 3 times. The actual behavior is tested afterward (i.e. checking the response future).", "author": "saig0", "createdAt": "2020-07-30T11:55:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg4NjE2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg4NjczNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5078#discussion_r462886735", "bodyText": "I would like to keep the request timeouts higher", "author": "Zelldon", "createdAt": "2020-07-30T09:57:31Z", "path": "transport/src/test/java/io/zeebe/transport/impl/AtomixTransportTest.java", "diffHunk": "@@ -283,16 +289,17 @@ public void shouldRetryAndSucceedAfterResponseIsValid() throws InterruptedExcept\n     // given\n     final var retryLatch = new CountDownLatch(2);\n     serverTransport.subscribe(0, new DirectlyResponder(bytes -> retryLatch.countDown())).join();\n+\n     final var responseValidation = new AtomicBoolean(false);\n     final var requestFuture =\n         clientTransport.sendRequestWithRetry(\n             nodeAddressSupplier,\n             (responseToValidate) -> responseValidation.get(),\n             new Request(\"messageABC\"),\n-            Duration.ofSeconds(3));", "originalCommit": "a032407d651cf9c82da09f5e259237d40f683d69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyNjEyOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5078#discussion_r462926129", "bodyText": "You would like to wait for more than 10 seconds? What do you suggest? \ud83d\ude09", "author": "saig0", "createdAt": "2020-07-30T11:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg4NjczNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyOTEzOA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5078#discussion_r462929138", "bodyText": "My comment was about higher request timeout then latch timeout", "author": "Zelldon", "createdAt": "2020-07-30T11:24:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg4NjczNQ=="}], "type": "inlineReview"}, {"oid": "c7f71b40e95f561279f64b13b37d164fb8b7a1bd", "url": "https://github.com/camunda-cloud/zeebe/commit/c7f71b40e95f561279f64b13b37d164fb8b7a1bd", "message": "test(transport): improve test stability\n\n* increase timeouts when waiting on a response - in CI, the response can take longer for unclear reasons", "committedDate": "2020-07-31T05:16:40Z", "type": "commit"}, {"oid": "c7f71b40e95f561279f64b13b37d164fb8b7a1bd", "url": "https://github.com/camunda-cloud/zeebe/commit/c7f71b40e95f561279f64b13b37d164fb8b7a1bd", "message": "test(transport): improve test stability\n\n* increase timeouts when waiting on a response - in CI, the response can take longer for unclear reasons", "committedDate": "2020-07-31T05:16:40Z", "type": "forcePushed"}]}