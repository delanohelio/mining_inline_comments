{"pr_number": 6017, "pr_title": "fix(broker): pick latest snapshot on load when multiple snapshots exists", "pr_createdAt": "2020-12-15T11:31:51Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/6017", "timeline": [{"oid": "3580ce37bb41608658b58d3377bf0313cdf359e8", "url": "https://github.com/camunda-cloud/zeebe/commit/3580ce37bb41608658b58d3377bf0313cdf359e8", "message": "fix(broker): pick latest snapshot on load when multiple snapshots exists\n- Also try to delete the snapshot if atomic move fails. If snapshot was partially moved, it would be considered a valid snapshot after a restart.", "committedDate": "2020-12-16T09:34:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkzNzc5NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/6017#discussion_r544937794", "bodyText": "Couldn't we delete the snapshot here if it's less recent than the latestPersistedSnapshot?", "author": "MiguelPires", "createdAt": "2020-12-17T09:28:16Z", "path": "snapshot/src/main/java/io/zeebe/snapshots/broker/impl/FileBasedSnapshotStore.java", "diffHunk": "@@ -71,7 +71,14 @@ private FileBasedSnapshot loadLatestSnapshot(final Path snapshotDirectory) {\n     FileBasedSnapshot latestPersistedSnapshot = null;\n     try (final var stream = Files.newDirectoryStream(snapshotDirectory)) {\n       for (final var path : stream) {\n-        latestPersistedSnapshot = collectSnapshot(path);\n+        final var snapshot = collectSnapshot(path);\n+        if (latestPersistedSnapshot == null) {\n+          latestPersistedSnapshot = snapshot;\n+        } else if (snapshot != null", "originalCommit": "3580ce37bb41608658b58d3377bf0313cdf359e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA0MzcwMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/6017#discussion_r545043702", "bodyText": "Yes. I fixed it now. I now refactored it to make it explicit that we are deleting all older snapshot.", "author": "deepthidevaki", "createdAt": "2020-12-17T12:13:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkzNzc5NA=="}], "type": "inlineReview"}, {"oid": "4ff6326e24ed8ba07fbbcdba649e703eb89f1bce", "url": "https://github.com/camunda-cloud/zeebe/commit/4ff6326e24ed8ba07fbbcdba649e703eb89f1bce", "message": "fix(broker): pick latest snapshot on load when multiple snapshots exists\n- Also try to delete the snapshot if atomic move fails. If snapshot was partially moved, it would be considered a valid snapshot after a restart.", "committedDate": "2020-12-17T13:28:59Z", "type": "commit"}, {"oid": "4ff6326e24ed8ba07fbbcdba649e703eb89f1bce", "url": "https://github.com/camunda-cloud/zeebe/commit/4ff6326e24ed8ba07fbbcdba649e703eb89f1bce", "message": "fix(broker): pick latest snapshot on load when multiple snapshots exists\n- Also try to delete the snapshot if atomic move fails. If snapshot was partially moved, it would be considered a valid snapshot after a restart.", "committedDate": "2020-12-17T13:28:59Z", "type": "forcePushed"}]}