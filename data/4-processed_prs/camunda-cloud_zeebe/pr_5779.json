{"pr_number": 5779, "pr_title": "docs(upgrade): adjust upgrade guide to new feature flag", "pr_createdAt": "2020-11-06T16:55:32Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5779", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4MTQ3NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5779#discussion_r518881474", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            > **Important:** Currently, we are facing an [issue](https://github.com/zeebe-io/zeebe/issues/5581) that can corrupt the data when upgrading from Zeebe 0.24.3 and before to a new version. The issue affects the reprocessing (i.e. rehydrating the data from the records on the log stream) and can be omitted by restoring the data from a snapshot. Please follow the recommended procedure to minimize the risk of losing data.\n          \n          \n            \n            > **Important:** Currently, we are facing an [issue](https://github.com/zeebe-io/zeebe/issues/5581) that can corrupt the data when upgrading from Zeebe 0.24.3 and lower to a newer version. The issue affects the reprocessing (i.e. rehydrating the data from the records on the log stream) and can be omitted by restoring the data from a snapshot. Please follow the recommended procedure to minimize the risk of losing data.", "author": "npepinpe", "createdAt": "2020-11-06T16:59:01Z", "path": "docs/src/operations/upgrade.md", "diffHunk": "@@ -12,19 +10,17 @@ Zeebe is designed to allow a rolling upgrade of a cluster. The brokers can be up\n 1. Continue with the next broker until all brokers are upgraded\n 1. Upgrade the standalone gateways\n \n-> Because of current issue, it is not recommended to perform a rolling upgrade. Please follow the upgrade procedure instead.\n+> Because of an existing issue in Zeebe versions before 0.24.4, it is not recommended to perform a rolling upgrade. Please follow the upgrade procedure instead.\n \n-## Upgrade Procedure\n+## Upgrade Procedure for Zeebe before 0.24.4\n \n The following procedure describes how to upgrade a broker. If the cluster contains multiple brokers then these steps can be done for all brokers in parallel. Standalone gateways should be upgraded after all brokers in the cluster are upgraded to avoid mismatches in the protocol version.\n \n-Note that this procedure results in a downtime of the whole cluster. Currently, a rolling upgrade is not recommended to avoid that an upgraded broker do reprocessing and is affected by the issue.\n-\n-> TODO: describe how to perform the upgrade on Kubernetes/Helm\n+Note that this procedure results in a downtime of the whole cluster. Currently, a rolling upgrade is not recommended for upgrading from Zeebe 0.24.3 and before to avoid that an upgraded broker do reprocessing and is affected by the issue.\n \n ### Preparing the Upgrade\n \n-#### From broker version < 24.4\n+> **Important:** Currently, we are facing an [issue](https://github.com/zeebe-io/zeebe/issues/5581) that can corrupt the data when upgrading from Zeebe 0.24.3 and before to a new version. The issue affects the reprocessing (i.e. rehydrating the data from the records on the log stream) and can be omitted by restoring the data from a snapshot. Please follow the recommended procedure to minimize the risk of losing data.", "originalCommit": "96ca3b2e4f01e3bfd46d4a67b6ac2c346983f3ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4MjI4OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5779#discussion_r518882289", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            We recommend to enable it after upgrading to a new version of Zeebe for the first run after the upgrade as described in the [update proceedure](#upgrade-procedure-for-zeebe-before-0244).\n          \n          \n            \n            We recommend to enable it after upgrading Zeebe from a version lower than 0.24.4 to a version greater than or equal to 0.24.4 on the first run after the upgrade, as described in the [update proceedure](#upgrade-procedure-for-zeebe-before-0244).", "author": "npepinpe", "createdAt": "2020-11-06T17:00:17Z", "path": "docs/src/operations/upgrade.md", "diffHunk": "@@ -150,3 +137,17 @@ An operation can be triggered using a `POST` request with an empty body. It is a\n     ```\n \n The response of the operation is the current status of the partitions. It is sent after the operation is triggered. It doesn't wait until the operation is performed.\n+\n+## Experimental: Detect Reprocessing Inconsistency\n+\n+With Zeebe 0.24.5 and 0.25.1 a new exterimental feature was introduced which detects inconsistency of the logstream on upgrade to mitigate the following\n+[issue](https://github.com/zeebe-io/zeebe/issues/5581).\n+\n+We recommend to enable it after upgrading to a new version of Zeebe for the first run after the upgrade as described in the [update proceedure](#upgrade-procedure-for-zeebe-before-0244).", "originalCommit": "96ca3b2e4f01e3bfd46d4a67b6ac2c346983f3ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4MjYzMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5779#discussion_r518882633", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            After you [verified that the upgrade](#verifying-the-upgrade) was successfull, we recommend to disable it again by unsetting the environment variable.\n          \n          \n            \n            After you [verified that the upgrade](#verifying-the-upgrade) was successful, we recommend to disable it again by unsetting the environment variable and restarting your brokers.", "author": "npepinpe", "createdAt": "2020-11-06T17:00:55Z", "path": "docs/src/operations/upgrade.md", "diffHunk": "@@ -150,3 +137,17 @@ An operation can be triggered using a `POST` request with an empty body. It is a\n     ```\n \n The response of the operation is the current status of the partitions. It is sent after the operation is triggered. It doesn't wait until the operation is performed.\n+\n+## Experimental: Detect Reprocessing Inconsistency\n+\n+With Zeebe 0.24.5 and 0.25.1 a new exterimental feature was introduced which detects inconsistency of the logstream on upgrade to mitigate the following\n+[issue](https://github.com/zeebe-io/zeebe/issues/5581).\n+\n+We recommend to enable it after upgrading to a new version of Zeebe for the first run after the upgrade as described in the [update proceedure](#upgrade-procedure-for-zeebe-before-0244).\n+You can enable it using the following environment variable:\n+\n+```\n+ZEEBE_BROKER_EXPERIMENTAL_DETECTREPROCESSINGINCONSISTENCY=\"true\"\n+```\n+\n+After you [verified that the upgrade](#verifying-the-upgrade) was successfull, we recommend to disable it again by unsetting the environment variable.", "originalCommit": "96ca3b2e4f01e3bfd46d4a67b6ac2c346983f3ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4Mzk1NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5779#discussion_r518883955", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            > Because of an existing issue in Zeebe versions before 0.24.4, it is not recommended to perform a rolling upgrade. Please follow the upgrade procedure instead.\n          \n          \n            \n            > If you are upgrading Zeebe from 0.24.4 to a newer version, then you can simply perform a rolling upgrade. However, if you are upgrading Zeebe from a version lower than 0.24.4, it is not recommended to perform a rolling upgrade. Please follow the upgrade procedure described below instead.", "author": "npepinpe", "createdAt": "2020-11-06T17:03:28Z", "path": "docs/src/operations/upgrade.md", "diffHunk": "@@ -12,19 +10,17 @@ Zeebe is designed to allow a rolling upgrade of a cluster. The brokers can be up\n 1. Continue with the next broker until all brokers are upgraded\n 1. Upgrade the standalone gateways\n \n-> Because of current issue, it is not recommended to perform a rolling upgrade. Please follow the upgrade procedure instead.\n+> Because of an existing issue in Zeebe versions before 0.24.4, it is not recommended to perform a rolling upgrade. Please follow the upgrade procedure instead.", "originalCommit": "96ca3b2e4f01e3bfd46d4a67b6ac2c346983f3ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9fe6c13c055c893da5715bc8c3999bb99386b020", "url": "https://github.com/camunda-cloud/zeebe/commit/9fe6c13c055c893da5715bc8c3999bb99386b020", "message": "docs(upgrade): adjust upgrade guide to new feature flag", "committedDate": "2020-11-06T17:28:07Z", "type": "forcePushed"}, {"oid": "8bc0384ae64284cedc313c7f326d41db118eeb3c", "url": "https://github.com/camunda-cloud/zeebe/commit/8bc0384ae64284cedc313c7f326d41db118eeb3c", "message": "docs(upgrade): adjust upgrade guide to new feature flag", "committedDate": "2020-11-06T17:36:36Z", "type": "commit"}, {"oid": "8bc0384ae64284cedc313c7f326d41db118eeb3c", "url": "https://github.com/camunda-cloud/zeebe/commit/8bc0384ae64284cedc313c7f326d41db118eeb3c", "message": "docs(upgrade): adjust upgrade guide to new feature flag", "committedDate": "2020-11-06T17:36:36Z", "type": "forcePushed"}]}