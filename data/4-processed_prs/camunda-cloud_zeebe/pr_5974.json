{"pr_number": 5974, "pr_title": "Add more metrics for processing latency", "pr_createdAt": "2020-12-07T10:45:42Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5974", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUwNTAyMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5974#discussion_r537505023", "bodyText": "Can you explain the choice to include deserialization as part of the processing time?", "author": "npepinpe", "createdAt": "2020-12-07T13:27:46Z", "path": "engine/src/main/java/io/zeebe/engine/processing/streamprocessor/ProcessingStateMachine.java", "diffHunk": "@@ -217,8 +217,8 @@ private void processEvent(final LoggedEvent event) {\n       return;\n     }\n \n-    metrics.processingLatency(\n-        metadata.getRecordType(), event.getTimestamp(), ActorClock.currentTimeMillis());\n+    final long processingStartTime = ActorClock.currentTimeMillis();\n+    metrics.processingLatency(metadata.getRecordType(), event.getTimestamp(), processingStartTime);", "originalCommit": "0b5b3ac6cb50b28d4786244b3c9a0f25e970bcde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyMjMxNA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5974#discussion_r537522314", "bodyText": "As a first step I did not want to narrow the scope of a metrics. If processing duration is higher than what we expect, then we can narrow down the metrics to smaller blocks. Would you like to take deserialization out of the processing time?", "author": "deepthidevaki", "createdAt": "2020-12-07T13:53:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUwNTAyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyNDg5MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5974#discussion_r537524890", "bodyText": "I mostly wanted to know if it was a conscious choice, and if so, why. Do you think it might be confusing/unexpected that deserializing is part of the processing time? I think it might be a little unexpected, but once you know it doesn't sound out of place imho, you can make a case that it is part of the processing.", "author": "npepinpe", "createdAt": "2020-12-07T13:57:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUwNTAyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYzOTY4OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5974#discussion_r537639689", "bodyText": "Actually, I wanted to include the complete processing - from this event is ready to process until the next event is ready. This would give us an idea how much time we spent in StreamProcessor. So that should include the steps updateState and writeEvent, which is not currently included in the processing time. Wdyt? Shall I update it? Then it wouldn't be weird to have deserializing also part of the processing time.", "author": "deepthidevaki", "createdAt": "2020-12-07T16:22:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUwNTAyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY1Njg0Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/5974#discussion_r537656846", "bodyText": "That makes more sense - we can make it more granular by adding a metric per step later on (i.e. updateState, writeFollowUpEvents, etc.). If we add one here, can we also add one in reprocessing? Both will be very useful when refactoring how we do stream processing next quarter \ud83d\udc4d", "author": "npepinpe", "createdAt": "2020-12-07T16:45:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUwNTAyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM2NjA0OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5974#discussion_r542366048", "bodyText": "I think it would be interesting to find hotspots by adding value type/intent as labels - however I'm not sure if that creates too much dimensions/data explosion. We can definitely do that as a second iteration though.", "author": "npepinpe", "createdAt": "2020-12-14T13:02:59Z", "path": "engine/src/main/java/io/zeebe/engine/metrics/StreamProcessorMetrics.java", "diffHunk": "@@ -64,6 +72,13 @@ public void processingLatency(\n         .observe((processed - written) / 1000f);\n   }\n \n+  public void processingDuration(\n+      final RecordType recordType, final long started, final long processed) {\n+    PROCESSING_DURATION\n+        .labels(recordType.name(), partitionIdLabel)", "originalCommit": "81740e07b8879b803487431c4086e7bc6af8b625", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM2OTUyMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5974#discussion_r542369521", "bodyText": "Yes. We can improve it when we need it.", "author": "deepthidevaki", "createdAt": "2020-12-14T13:08:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM2NjA0OA=="}], "type": "inlineReview"}, {"oid": "df654fe70e38b6c146a19fc29155d4bdc0f70840", "url": "https://github.com/camunda-cloud/zeebe/commit/df654fe70e38b6c146a19fc29155d4bdc0f70840", "message": "chore(broker): add commit latency metrics", "committedDate": "2020-12-14T13:09:40Z", "type": "commit"}, {"oid": "82b2cc2decae70e8d246857a75cc886fa35b6425", "url": "https://github.com/camunda-cloud/zeebe/commit/82b2cc2decae70e8d246857a75cc886fa35b6425", "message": "chore(monitor): add panels for commit latency metrics", "committedDate": "2020-12-14T13:09:41Z", "type": "commit"}, {"oid": "05dc428da2dc31de405d3e19374df391de8ced54", "url": "https://github.com/camunda-cloud/zeebe/commit/05dc428da2dc31de405d3e19374df391de8ced54", "message": "chore(monitor): filter by pod in latency panels", "committedDate": "2020-12-14T13:09:41Z", "type": "commit"}, {"oid": "05dc428da2dc31de405d3e19374df391de8ced54", "url": "https://github.com/camunda-cloud/zeebe/commit/05dc428da2dc31de405d3e19374df391de8ced54", "message": "chore(monitor): filter by pod in latency panels", "committedDate": "2020-12-14T13:09:41Z", "type": "forcePushed"}]}