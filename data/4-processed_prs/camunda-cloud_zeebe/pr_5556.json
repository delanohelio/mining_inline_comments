{"pr_number": 5556, "pr_title": "chore(atomix): expose internal raft configs", "pr_createdAt": "2020-10-09T12:26:53Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5556", "timeline": [{"oid": "0504669f2f17311e6e446b6052b9f3e83b8f6d7c", "url": "https://github.com/camunda-cloud/zeebe/commit/0504669f2f17311e6e446b6052b9f3e83b8f6d7c", "message": "chore(atomix): expose internal raft configs", "committedDate": "2020-10-09T12:24:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5NTQ4NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502395485", "bodyText": "Nit: maybe we can call appending instead inFlightAppendCount? Just from the name, I kind of expected it to be a boolean flag \ud83d\ude05 I know it was already like this, but if we're already changing this code... \ud83d\udc40", "author": "npepinpe", "createdAt": "2020-10-09T12:34:19Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/cluster/impl/RaftMemberContext.java", "diffHunk": "@@ -96,8 +100,9 @@ public void resetState(final RaftLog log) {\n   public boolean canAppend() {\n     return appending == 0\n         || (appendSucceeded\n-            && appending < MAX_APPENDS\n-            && System.currentTimeMillis() - (timeStats.getMean() / MAX_APPENDS) >= appendTime);\n+            && appending < maxAppendsPerMember", "originalCommit": "0504669f2f17311e6e446b6052b9f3e83b8f6d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQxNzcxNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502417716", "bodyText": "\ud83d\ude06 yeah I can change that as well. I just replaced the occurrences tbh", "author": "Zelldon", "createdAt": "2020-10-09T13:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5NTQ4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5ODk5Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502398997", "bodyText": "Random question, I know this has nothing to do with your PR, but...I found this kind of hard to read. So we can append if the last append succeeded, the current append count is less than max appends, and the time since the last append is greater than or equal to the mean of the 8 observed last append latencies divided by the max number of appends? Did I read that right?", "author": "npepinpe", "createdAt": "2020-10-09T12:40:57Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/cluster/impl/RaftMemberContext.java", "diffHunk": "@@ -96,8 +100,9 @@ public void resetState(final RaftLog log) {\n   public boolean canAppend() {\n     return appending == 0\n         || (appendSucceeded\n-            && appending < MAX_APPENDS\n-            && System.currentTimeMillis() - (timeStats.getMean() / MAX_APPENDS) >= appendTime);\n+            && appending < maxAppendsPerMember\n+            && System.currentTimeMillis() - (timeStats.getMean() / maxAppendsPerMember)", "originalCommit": "0504669f2f17311e6e446b6052b9f3e83b8f6d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQxOTk5OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502419999", "bodyText": "Could be I not really get the last part tbh", "author": "Zelldon", "createdAt": "2020-10-09T13:17:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5ODk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyNDY1MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502424650", "bodyText": "So yes it seems it calculates the latencies by hand and tries to only send a new append when we are over the avg latency - weird", "author": "Zelldon", "createdAt": "2020-10-09T13:24:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5ODk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyNDc3NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502424775", "bodyText": "wasnt aware of that", "author": "Zelldon", "createdAt": "2020-10-09T13:25:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5ODk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyNTE3Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502425173", "bodyText": "Could we just send more append and the follower could also just ack the last one? then we know it also received the previous?", "author": "Zelldon", "createdAt": "2020-10-09T13:25:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5ODk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyNTk3Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502425973", "bodyText": "So it sort of tries to do flow control by not sending appends faster than what the other node has managed to acknowledge, I guess. Wouldn't this potentially calculate though a high average? Let's say the follower has a slow spike, if we only send based on the rolling average, would that really go lower over time? Probably not to the optimal value", "author": "npepinpe", "createdAt": "2020-10-09T13:26:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5ODk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyNjQ4MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502426480", "bodyText": "Yes, I think in the long run we want to do an async pipeline where the follower also acknowledges the last write it flushed (with async flush, not sync) anyway.", "author": "npepinpe", "createdAt": "2020-10-09T13:27:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5ODk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyNzE2MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502427161", "bodyText": "It only evaluates the last 8 values calcs the mean of that and then divides that by 2 to get the avg ? Hm Idk we probably need to experiment on this thing or just remove it ^^", "author": "Zelldon", "createdAt": "2020-10-09T13:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5ODk5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwMDY0Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502400643", "bodyText": "iirc, these will get serialized by kryo right? just to be safe, this should be fine from now on with the new compatible serializer, but did we test this? i guess it only breaks rolling upgrade, which is broken now anyway though \ud83e\udd14", "author": "npepinpe", "createdAt": "2020-10-09T12:43:58Z", "path": "atomix/cluster/src/main/java/io/atomix/raft/partition/RaftPartitionGroupConfig.java", "diffHunk": "@@ -37,6 +37,8 @@\n   private Duration electionTimeout = DEFAULT_ELECTION_TIMEOUT;\n   private Duration heartbeatInterval = DEFAULT_HEARTBEAT_INTERVAL;\n   private RaftStorageConfig storageConfig = new RaftStorageConfig();\n+  private int maxAppendsPerFollower = 2;", "originalCommit": "0504669f2f17311e6e446b6052b9f3e83b8f6d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQxNDQ3Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502414476", "bodyText": "Tbh I always worry to touch the config and this is so stupid \ud83d\ude05 I can't tell what happens currently", "author": "Zelldon", "createdAt": "2020-10-09T13:08:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwMDY0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQzNDEzOA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502434138", "bodyText": "@npepinpe do I need to do something here?", "author": "Zelldon", "createdAt": "2020-10-09T13:39:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwMDY0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQzNDgwNA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502434804", "bodyText": "No it was just a question - I think it would be fine with the PR Miguel will merge with the new version serializer, where you can add new fields. @MiguelPires ?", "author": "npepinpe", "createdAt": "2020-10-09T13:41:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwMDY0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwMTE1Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502401152", "bodyText": "I guess we can write the real value instead of Integer.MAX_VALUE :)", "author": "npepinpe", "createdAt": "2020-10-09T12:44:54Z", "path": "broker/src/main/java/io/zeebe/broker/system/SystemContext.java", "diffHunk": "@@ -34,6 +34,9 @@\n       \"Snapshot period %s needs to be larger then or equals to one minute.\";\n   private static final String MMAP_REPLICATION_ERROR_MSG =\n       \"Using memory mapped storage level is currently unsafe with replication enabled; if you wish to use replication, set useMmap flag to false (e.g. ZEEBE_BROKER_DATA_USEMMAP=false)\";\n+  private static final String MAX_BATCH_SIZE_ERROR_MSG =\n+      \"Expected to have an append batch size maximum which is non negative and smaller then Integer.MAX_VALUE, but was '%s'.\";", "originalCommit": "0504669f2f17311e6e446b6052b9f3e83b8f6d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQxNjMwNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502416305", "bodyText": "hm yeah \ud83e\udd37", "author": "Zelldon", "createdAt": "2020-10-09T13:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwMTE1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQzNTkwMA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502435900", "bodyText": "Actually I did this because I think it is more readable then 2147483647 and everyone knows what int max is \ud83d\ude05 But I can change it", "author": "Zelldon", "createdAt": "2020-10-09T13:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwMTE1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQzNjYxNA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502436614", "bodyText": "I would add the value, since I'm not sure everyone knows what Integer.MAX_VALUE is (is it signed? unsigned? is it int32? int64? maybe they're not java devs \ud83e\udd37\u200d\u2642\ufe0f).", "author": "npepinpe", "createdAt": "2020-10-09T13:43:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwMTE1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwMTM5MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502401390", "bodyText": "Any reason we validate just the batch size and not the max appends?", "author": "npepinpe", "createdAt": "2020-10-09T12:45:18Z", "path": "broker/src/main/java/io/zeebe/broker/system/SystemContext.java", "diffHunk": "@@ -76,6 +79,12 @@ private void validateConfiguration() {\n       throw new IllegalArgumentException(String.format(NODE_ID_ERROR_MSG, nodeId, clusterSize));\n     }\n \n+    final var maxAppendBatchSize = cluster.getMaxAppendBatchSize();", "originalCommit": "0504669f2f17311e6e446b6052b9f3e83b8f6d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQxNTUwOA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5556#discussion_r502415508", "bodyText": "Actually I thought about it as well and just did it because it is the DataSize type where I need to have a smaller value then int max. Whether it is negative will be validated in the Atomix Building", "author": "Zelldon", "createdAt": "2020-10-09T13:09:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwMTM5MA=="}], "type": "inlineReview"}, {"oid": "f97f37fd98a09bc540920e0598ba2ea9fd6d1ecc", "url": "https://github.com/camunda-cloud/zeebe/commit/f97f37fd98a09bc540920e0598ba2ea9fd6d1ecc", "message": "chore(broker): follow up", "committedDate": "2020-10-09T13:49:46Z", "type": "commit"}, {"oid": "b15d77c985f28c9d9a7d6f4dd72401eefbb9dda1", "url": "https://github.com/camunda-cloud/zeebe/commit/b15d77c985f28c9d9a7d6f4dd72401eefbb9dda1", "message": "chore(broker): introduce experimental cfg\n\n * move new configurations for raft internals to experimental cfg\n * experimental cfg are subject to change and might also contain dangerous configurations so be aware if you change something in this", "committedDate": "2020-10-10T08:28:11Z", "type": "commit"}, {"oid": "b15d77c985f28c9d9a7d6f4dd72401eefbb9dda1", "url": "https://github.com/camunda-cloud/zeebe/commit/b15d77c985f28c9d9a7d6f4dd72401eefbb9dda1", "message": "chore(broker): introduce experimental cfg\n\n * move new configurations for raft internals to experimental cfg\n * experimental cfg are subject to change and might also contain dangerous configurations so be aware if you change something in this", "committedDate": "2020-10-10T08:28:11Z", "type": "forcePushed"}]}