{"pr_number": 4281, "pr_title": "chore(engine): add onFailed stream processor lifecycle", "pr_createdAt": "2020-04-08T13:56:22Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/4281", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg1NTUzMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4281#discussion_r407855533", "bodyText": "Why this failed?", "author": "Zelldon", "createdAt": "2020-04-14T04:11:51Z", "path": "engine/src/test/java/io/zeebe/engine/util/TestStreams.java", "diffHunk": "@@ -444,7 +444,11 @@ public void close() throws Exception {\n         return;\n       }\n \n-      asyncSnapshotDirector.closeAsync().join();\n+      try {\n+        asyncSnapshotDirector.closeAsync().join();\n+      } catch (final Exception e) {\n+        Loggers.IO_LOGGER.debug(\"Close snapshot director failed\", e);", "originalCommit": "76020d3f96b29a47aa54c9271a975928d3f444e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk5MDMwNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/4281#discussion_r407990306", "bodyText": "When we try to close asyncSnapshotDirector, Stream processor actor can be already closed because it has failed. AsynsSnapshotDirector tries to get the lastCommitPosition but fails because StreamProcessor is closed/failed.", "author": "deepthidevaki", "createdAt": "2020-04-14T09:20:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg1NTUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEwNDM1MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4281#discussion_r410104351", "bodyText": "this is no longer true due to removing the enforcing snapshot", "author": "Zelldon", "createdAt": "2020-04-17T09:27:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg1NTUzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg1NTc5Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4281#discussion_r407855793", "bodyText": "do we need the mock since we already have the latch with the other listener ?", "author": "Zelldon", "createdAt": "2020-04-14T04:12:47Z", "path": "engine/src/test/java/io/zeebe/engine/processor/StreamProcessorTest.java", "diffHunk": "@@ -87,6 +87,37 @@ public void onRecovered(final ReadonlyProcessingContext context) {\n     inOrder.verifyNoMoreInteractions();\n   }\n \n+  @Test\n+  public void shouldCallStreamProcessorLifecycleOnFail() throws InterruptedException {\n+    // given\n+    final StreamProcessorLifecycleAware lifecycleAware = mock(StreamProcessorLifecycleAware.class);\n+    final CountDownLatch failedLatch = new CountDownLatch(1);\n+    streamProcessorRule.startTypedStreamProcessor(\n+        (processors, state) ->\n+            processors\n+                .withListener(lifecycleAware)\n+                .withListener(\n+                    new StreamProcessorLifecycleAware() {\n+                      @Override\n+                      public void onRecovered(final ReadonlyProcessingContext context) {\n+                        throw new RuntimeException(\"force fail\");\n+                      }\n+\n+                      @Override\n+                      public void onFailed() {\n+                        failedLatch.countDown();\n+                      }\n+                    }));\n+\n+    // when\n+    assertThat(failedLatch.await(1000, TimeUnit.MILLISECONDS)).isTrue();\n+\n+    // then\n+    verify(lifecycleAware, times(1)).onRecovered(any());", "originalCommit": "76020d3f96b29a47aa54c9271a975928d3f444e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk5MjAzNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4281#discussion_r407992035", "bodyText": "Found the mock useful to verify that onClose() is never called.", "author": "deepthidevaki", "createdAt": "2020-04-14T09:23:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg1NTc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk5NTk2Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4281#discussion_r407995963", "bodyText": "Yes I saw that, but actually we should avoid to test something which should not happen, because this is often error prone and hard to test. I mean how long do you want to wait to ensure that it never happens :) It makes also hard to change things later. We should more focus on things we can verify. I really like the answer https://softwareengineering.stackexchange.com/a/345664/182290 on a related question", "author": "Zelldon", "createdAt": "2020-04-14T09:29:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg1NTc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA2MDk0Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/4281#discussion_r408060943", "bodyText": "Make sense. But if we don't test it, what prevents me from accidentally invoking listener:onClose() when the actor failed? Isn't part of the contract that either listener.onFailed or listener.onClose is invoked but not both?", "author": "deepthidevaki", "createdAt": "2020-04-14T11:22:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg1NTc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA3NTkwMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4281#discussion_r408075901", "bodyText": "Actually nothing. But the question is also should the test prevent you from such thing? When the end result is the same it should be fine right? No matter how many or what kind of methods are called. Is it really part of the contract ? Does it need to be? What values gives us this. As I said we should try to avoid these kind of couplings, since it makes harder to add new features.\nI know I also did this sometimes, since sometimes we have the feeling that we have to make sure such thing doesn't happen. But it makes things often more complicate then it needs to be. We should try to focus on things we can guarantee and verify without using mocks. Like I put a into a function and get b, but I don't care how it is calculated. On these listeners tests it is a bit harder I know.\nBut what we can do is just test things which should happen. Like if something fails it should call onFailure. When I close it, it should call onClose.", "author": "Zelldon", "createdAt": "2020-04-14T11:51:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg1NTc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE0Nzg5MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/4281#discussion_r408147891", "bodyText": "ok \ud83d\udc4d", "author": "deepthidevaki", "createdAt": "2020-04-14T13:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg1NTc5Mw=="}], "type": "inlineReview"}, {"oid": "0344a91bfa8e6bbcd9adcca2b522a604a4a49e07", "url": "https://github.com/camunda-cloud/zeebe/commit/0344a91bfa8e6bbcd9adcca2b522a604a4a49e07", "message": "chore(engine): add onFailed stream processor lifecycle", "committedDate": "2020-04-14T13:48:36Z", "type": "forcePushed"}, {"oid": "7b24e788ccdb078a9f0245db84b85b9052e485df", "url": "https://github.com/camunda-cloud/zeebe/commit/7b24e788ccdb078a9f0245db84b85b9052e485df", "message": "chore(engine): add onFailed stream processor lifecycle", "committedDate": "2020-04-17T12:35:59Z", "type": "forcePushed"}, {"oid": "f1b9d16ca8cab9ff70698f048efeaacdde7c4e4b", "url": "https://github.com/camunda-cloud/zeebe/commit/f1b9d16ca8cab9ff70698f048efeaacdde7c4e4b", "message": "chore(engine): add onFailed stream processor lifecycle", "committedDate": "2020-04-17T13:02:35Z", "type": "commit"}, {"oid": "f1b9d16ca8cab9ff70698f048efeaacdde7c4e4b", "url": "https://github.com/camunda-cloud/zeebe/commit/f1b9d16ca8cab9ff70698f048efeaacdde7c4e4b", "message": "chore(engine): add onFailed stream processor lifecycle", "committedDate": "2020-04-17T13:02:35Z", "type": "forcePushed"}]}