{"pr_number": 3811, "pr_title": "chore(gateway): prevent exceptions on already cancelled calls", "pr_createdAt": "2020-02-08T15:33:39Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/3811", "timeline": [{"oid": "21b6320f3317bbd95f5a50d27e7520b18e32981c", "url": "https://github.com/camunda-cloud/zeebe/commit/21b6320f3317bbd95f5a50d27e7520b18e32981c", "message": "chore(gateway): prevent exceptions on already cancelled calls\n\n- adds a check in the long polling request context to avoid completing\n  cancelled requests\n- prevents throwing an exception on cancelled calls and instead log it\n  at TRACE level", "committedDate": "2020-02-08T15:31:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA1NzM4Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3811#discussion_r380057383", "bodyText": "Could we somehow reuse the method sendRequest, i dont like this duplication.", "author": "Zelldon", "createdAt": "2020-02-17T09:08:22Z", "path": "gateway/src/main/java/io/zeebe/gateway/EndpointManager.java", "diffHunk": "@@ -320,6 +326,11 @@ public void updateJobRetries(\n       return;\n     }\n \n+    final ServerCallStreamObserver<GrpcResponseT> serverObserver =\n+        (ServerCallStreamObserver<GrpcResponseT>) streamObserver;\n+    serverObserver.setOnCancelHandler(\n+        () -> Loggers.GATEWAY_LOGGER.trace(\"gRPC {} request cancelled\", grpcRequest.getClass()));\n+\n     brokerClient.sendRequest(", "originalCommit": "21b6320f3317bbd95f5a50d27e7520b18e32981c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA2MTg3Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/3811#discussion_r380061876", "bodyText": "\ud83d\udc4d", "author": "npepinpe", "createdAt": "2020-02-17T09:17:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA1NzM4Mw=="}], "type": "inlineReview"}, {"oid": "a2be57d3437a672509f4d8d75e0aec839321bc87", "url": "https://github.com/camunda-cloud/zeebe/commit/a2be57d3437a672509f4d8d75e0aec839321bc87", "message": "chore(gateway): extract helper method to reduce duplication", "committedDate": "2020-02-18T20:56:49Z", "type": "commit"}, {"oid": "abe08abc220a47471bc160ffa7de54fe7ec17ecb", "url": "https://github.com/camunda-cloud/zeebe/commit/abe08abc220a47471bc160ffa7de54fe7ec17ecb", "message": "chore(gateway): remove unused methods", "committedDate": "2020-02-18T20:57:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU0OTk2Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3811#discussion_r382549962", "bodyText": "What happend before without the handler again? Sorry \ud83d\ude05", "author": "Zelldon", "createdAt": "2020-02-21T12:13:09Z", "path": "gateway/src/main/java/io/zeebe/gateway/EndpointManager.java", "diffHunk": "@@ -320,13 +322,22 @@ public void updateJobRetries(\n       return;\n     }\n \n+    suppressCancelledException(grpcRequest, streamObserver);\n     brokerClient.sendRequest(\n         brokerRequest,\n         (key, response) -> consumeResponse(responseMapper, streamObserver, key, response),\n         error -> streamObserver.onError(convertThrowable(error)),\n         timeout);\n   }\n \n+  private <GrpcRequestT, GrpcResponseT> void suppressCancelledException(\n+      final GrpcRequestT grpcRequest, final StreamObserver<GrpcResponseT> streamObserver) {\n+    final ServerCallStreamObserver<GrpcResponseT> serverObserver =\n+        (ServerCallStreamObserver<GrpcResponseT>) streamObserver;\n+    serverObserver.setOnCancelHandler(", "originalCommit": "abe08abc220a47471bc160ffa7de54fe7ec17ecb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU1MDcxMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3811#discussion_r382550711", "bodyText": "Because these exceptions are fixed with the addition check right?\nI 2020-01-30T03:17:21.480895200Z io.grpc.StatusRuntimeException: CANCELLED: call already cancelled\n\tat io.grpc.Status.asRuntimeException(Status.java:524) ~[grpc-api-1.26.0.jar:1.26.0]\n\tat io.grpc.stub.ServerCalls$ServerCallStreamObserverImpl.onCompleted(ServerCalls.java:368) ~[grpc-stub-1.26.0.jar:1.26.0]\n\tat io.zeebe.gateway.impl.job.LongPollingActivateJobsRequest.complete(LongPollingActivateJobsRequest.java:73) ~[zeebe-gateway-0.23.0-SNAPSHOT.jar:0.23.0-SNAPSHOT]\n\tat io.zeebe.gateway.impl.job.LongPollingActivateJobsRequest.timeout(LongPollingActivateJobsRequest.java:95) ~[zeebe-gateway-0.23.0-SNAPSHOT.jar:0.23.0-SNAPSHOT]\n\tat io.zeebe.gateway.impl.job.LongPollingActivateJobsHandler.lambda$addTimeOut$9(LongPollingActivateJobsHandler.java:191) ~[zeebe-gateway-0.23.0-SNAPSHOT.jar:0.23.0-SNAPSHOT]\n\tat io.zeebe.util.sched.ActorJob.invoke(ActorJob.java:76) [zeebe-util-0.23.0-SNAPSHOT.jar:0.23.0-SNAPSHOT]\n\tat io.zeebe.util.sched.ActorJob.execute(ActorJob.java:39) [zeebe-util-0.23.0-SNAPSHOT.jar:0.23.0-SNAPSHOT]\n\tat io.zeebe.util.sched.ActorTask.execute(ActorTask.java:115) [zeebe-util-0.23.0-SNAPSHOT.jar:0.23.0-SNAPSHOT]\n\tat io.zeebe.util.sched.ActorThread.executeCurrentTask(ActorThread.java:107) [zeebe-util-0.23.0-SNAPSHOT.jar:0.23.0-SNAPSHOT]\n\tat io.zeebe.util.sched.ActorThread.doWork(ActorThread.java:91) [zeebe-util-0.23.0-SNAPSHOT.jar:0.23.0-SNAPSHOT]\n\tat io.zeebe.util.sched.ActorThread.run(ActorThread.java:195) [zeebe-util-0.23.0-SNAPSHOT.jar:0.23.0-SNAPSHOT]", "author": "Zelldon", "createdAt": "2020-02-21T12:15:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU0OTk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjY3OTAyOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3811#discussion_r382679029", "bodyText": "Yes, it's the current way grpc-java has to disable throwing an exception when the call was already cancelled (not ideal imo, but that's their current recommended workaround)", "author": "npepinpe", "createdAt": "2020-02-21T16:28:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU0OTk2Mg=="}], "type": "inlineReview"}]}