{"pr_number": 5977, "pr_title": "5964 wait for end of qa run", "pr_createdAt": "2020-12-07T15:03:06Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5977", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyOTY2Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#discussion_r537629667", "bodyText": "Is error.txt used for anything? Or do you just want to silence it? If that's the case, you can just redirect to /dev/null, i.e.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \"${zbctl}\"  activate jobs \"$businessKey\" > activationresponse.txt 2>error.txt\n          \n          \n            \n                \"${zbctl}\"  activate jobs \"$businessKey\" > activationresponse.txt 2>/dev/null", "author": "npepinpe", "createdAt": "2020-12-07T16:10:04Z", "path": ".ci/scripts/distribution/qa-testbench.sh", "diffHunk": "@@ -1,7 +1,50 @@\n-#!/bin/sh -eux\n+#!/bin/bash -eux\n \n chmod +x clients/go/cmd/zbctl/dist/zbctl\n \n-alias zbctl=\"clients/go/cmd/zbctl/dist/zbctl\"\n+zbctl=\"clients/go/cmd/zbctl/dist/zbctl\"\n \n-zbctl create instance qa-protocol --variables \"${QA_RUN_VARIABLES}\"\n+\"${zbctl}\" create instance external-tool-integration --variables \"${QA_RUN_VARIABLES}\"\n+\n+businessKey=\"${BUSINESS_KEY}\"\n+\n+waiting=1\n+\n+echo \"Waiting for result of $businessKey\"\n+\n+while [ $waiting -eq 1 ]; do\n+\n+    \"${zbctl}\"  activate jobs \"$businessKey\" > activationresponse.txt 2>error.txt", "originalCommit": "9a77749624029966dee4cd3010c095467cd790cd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYzMjMzNA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#discussion_r537632334", "bodyText": "You can do\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            while [ $waiting -eq 1 ]; do\n          \n          \n            \n            while true; do\n          \n      \n    \n    \n  \n\nAnd use a break statement to break out of the loop instead of setting the variable to 1. So for example:\nwhile true ; do\n    ...\n    if [ -z \"$key\" ]; then\n        ...\n    else\n        echo \"QA run completed\"\n        break\n    fi\ndone", "author": "npepinpe", "createdAt": "2020-12-07T16:13:33Z", "path": ".ci/scripts/distribution/qa-testbench.sh", "diffHunk": "@@ -1,7 +1,50 @@\n-#!/bin/sh -eux\n+#!/bin/bash -eux\n \n chmod +x clients/go/cmd/zbctl/dist/zbctl\n \n-alias zbctl=\"clients/go/cmd/zbctl/dist/zbctl\"\n+zbctl=\"clients/go/cmd/zbctl/dist/zbctl\"\n \n-zbctl create instance qa-protocol --variables \"${QA_RUN_VARIABLES}\"\n+\"${zbctl}\" create instance external-tool-integration --variables \"${QA_RUN_VARIABLES}\"\n+\n+businessKey=\"${BUSINESS_KEY}\"\n+\n+waiting=1\n+\n+echo \"Waiting for result of $businessKey\"\n+\n+while [ $waiting -eq 1 ]; do", "originalCommit": "9a77749624029966dee4cd3010c095467cd790cd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYzMzQwNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#discussion_r537633406", "bodyText": "With the information we have here, can we link to the result page already? Could save you time if you can just immediately click to go and see your results. Here or in the build results, whichever.", "author": "npepinpe", "createdAt": "2020-12-07T16:14:55Z", "path": ".ci/scripts/distribution/qa-testbench.sh", "diffHunk": "@@ -1,7 +1,50 @@\n-#!/bin/sh -eux\n+#!/bin/bash -eux\n \n chmod +x clients/go/cmd/zbctl/dist/zbctl\n \n-alias zbctl=\"clients/go/cmd/zbctl/dist/zbctl\"\n+zbctl=\"clients/go/cmd/zbctl/dist/zbctl\"\n \n-zbctl create instance qa-protocol --variables \"${QA_RUN_VARIABLES}\"\n+\"${zbctl}\" create instance external-tool-integration --variables \"${QA_RUN_VARIABLES}\"\n+\n+businessKey=\"${BUSINESS_KEY}\"\n+\n+waiting=1\n+\n+echo \"Waiting for result of $businessKey\"\n+\n+while [ $waiting -eq 1 ]; do\n+\n+    \"${zbctl}\"  activate jobs \"$businessKey\" > activationresponse.txt 2>error.txt\n+\n+    key=$(jq -r '.key' < activationresponse.txt)\n+\n+    if [ -z \"$key\" ]; then\n+        echo \"Still waiting\"\n+        sleep 5m\n+    else\n+        echo \"QA run completed\"\n+        waiting=0\n+    fi\n+done\n+\n+key=$(jq -r '.key' < activationresponse.txt)\n+\n+echo \"Job key is: $key\"\n+\n+variables=$(jq -r '.variables' < activationresponse.txt)\n+\n+echo \"Job variables are: $variables\"\n+\n+testResult=$(echo \"$variables\" | jq -r '.aggregatedTestResult')\n+\n+echo \"Test result is: $testResult\"\n+\n+\"${zbctl}\"  complete job \"$key\"\n+\n+if [ \"$testResult\" == \"FAILED\" ]; then\n+  echo \"Test failed\"", "originalCommit": "9a77749624029966dee4cd3010c095467cd790cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5NTY5MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#discussion_r537695690", "bodyText": "Which result page? Not sure what you mean?", "author": "pihme", "createdAt": "2020-12-07T17:36:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYzMzQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5ODMwNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#discussion_r537698306", "bodyText": "The Test Reports (Zeebe Cluster Testbench) Google doc - but I already noticed you mentioned we'll be pulling in the results in a separate PR, so that's moot \ud83d\udc4d", "author": "npepinpe", "createdAt": "2020-12-07T17:40:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYzMzQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzczNzE2Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#discussion_r537737163", "bodyText": "@npepinpe Still no idea what you mean. And I have no plans to do much more than what is already there. Let's discuss that tomorrow. Maybe there was a misunderstanding or I missed somethin.", "author": "pihme", "createdAt": "2020-12-07T18:38:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYzMzQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc4MTU4Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#discussion_r537781586", "bodyText": "Yeah, I was probably not explaining myself correctly.\nI was thinking, what would I do when I see that the QA stage fails - where should I look, how can I know what went wrong? As far as I know, we have a shared spreadsheet in Google Docs which collects the test results. To correlate the results, I need to know the generation so I can look up the relevant tests in there. Once I know what went wrong, what else can I do? I can find the cluster ID and look up the logs in Google Cloud, or check Operate in Testbench.\nI just thought, that's a lot of places and I need to know all of these - what if we added the links directly in the test results/build result? That way I can just click on it and be taken directly from Jenkins to the relevant places to figure out what went wrong.\nBut like I said, if you plan on already importing the results into Jenkins, then there's nothing to be done \ud83d\udc4d\nHope that helps, otherwise let's quickly talk about it in our sync so I can improve how I communicate \ud83d\ude42", "author": "npepinpe", "createdAt": "2020-12-07T19:43:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYzMzQwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc4NjcxMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#discussion_r537786713", "bodyText": "Yeah, let's talk about it tomorrow. I don't plan to export test results into Jenkins - not in the way I think you imagine it. Which I realize now sounds confusing.\nSo the only test result that Jenkins will know about is whether all tests succeeded or any test failed. This is done with this PR and I wanted to keep it at that,\nBut I understand your desire to make correlation easier.\nThere is: zeebe-io/zeebe-cluster-testbench#188\nThis will make it easier. But maybe we need a little more.", "author": "pihme", "createdAt": "2020-12-07T19:51:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYzMzQwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYzNDU3MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#discussion_r537634570", "bodyText": "Is dropping the time out on purpose?", "author": "npepinpe", "createdAt": "2020-12-07T16:16:31Z", "path": "Jenkinsfile", "diffHunk": "@@ -278,33 +278,41 @@ pipeline {\n                 DOCKER_GCR = credentials(\"zeebe-gcr-serviceaccount-json\")\n                 ZEEBE_AUTHORIZATION_SERVER_URL = 'https://login.cloud.ultrawombat.com/oauth/token'\n                 ZEEBE_CLIENT_ID = 'W5a4JUc3I1NIetNnodo3YTvdsRIFb12w'\n-                QA_RUN_VARIABLES = \"{\\\"zeebeImage\\\": \\\"${env.IMAGE}:${env.TAG}\\\", \\\"generationTemplate\\\": \\\"${params.GENERATION_TEMPLATE}\\\", \\\"channel\\\": \\\"Internal Dev\\\", \" +\n-                    \"\\\"branch\\\": \\\"${env.BRANCH_NAME}\\\", \\\"build\\\": \\\"${currentBuild.absoluteUrl}\\\"}\"\n+                QA_RUN_VARIABLES = \"{\\\"zeebeImage\\\": \\\"${env.IMAGE}:${env.TAG}\\\", \\\"generationTemplate\\\": \\\"${params.GENERATION_TEMPLATE}\\\", \" +\n+                                    \"\\\"channel\\\": \\\"Internal Dev\\\", \\\"branch\\\": \\\"${env.BRANCH_NAME}\\\", \\\"build\\\": \\\"${currentBuild.absoluteUrl}\\\", \" +\n+                                    \"\\\"businessKey\\\": \\\"${currentBuild.absoluteUrl}\\\", \\\"processId\\\": \\\"qa-protocol\\\"}\"\n+                BUSINESS_KEY = \"${currentBuild.absoluteUrl}\"\n             }\n \n             steps {\n-                timeout(time: shortTimeoutMinutes, unit: 'MINUTES') {", "originalCommit": "9a77749624029966dee4cd3010c095467cd790cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5NzQyMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5977#discussion_r537697423", "bodyText": "Yes, it is intended. Before this was the timeout for starting the QA run. And then there was a second step to wait for user input, which had no timeout. Now the waiting for the result is part of this process. Currently, the QA run has to wait until all analyses have been completed, so it can take an arbitrary number of time.\nLater this week we hopefully have an implementation that sends the result to Jenkins as soon as possible, without waiting for the analysis to be completed. At this point we could add a generous timeout again here.", "author": "pihme", "createdAt": "2020-12-07T17:39:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYzNDU3MA=="}], "type": "inlineReview"}, {"oid": "6db520dcea77b6713b6b6f50a67f50b35f3a8438", "url": "https://github.com/camunda-cloud/zeebe/commit/6db520dcea77b6713b6b6f50a67f50b35f3a8438", "message": "chore(ci): automatically collect result of QA run", "committedDate": "2020-12-07T18:41:02Z", "type": "commit"}, {"oid": "6db520dcea77b6713b6b6f50a67f50b35f3a8438", "url": "https://github.com/camunda-cloud/zeebe/commit/6db520dcea77b6713b6b6f50a67f50b35f3a8438", "message": "chore(ci): automatically collect result of QA run", "committedDate": "2020-12-07T18:41:02Z", "type": "forcePushed"}]}