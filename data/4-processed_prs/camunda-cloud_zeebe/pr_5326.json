{"pr_number": 5326, "pr_title": "Control variable propagation of call activities with new attribute", "pr_createdAt": "2020-09-10T07:13:52Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5326", "timeline": [{"oid": "28f7dd22e636261f78b015e0a9c6d07c6443cc00", "url": "https://github.com/camunda-cloud/zeebe/commit/28f7dd22e636261f78b015e0a9c6d07c6443cc00", "message": "docs(bpmn-workflows): update call activity docs", "committedDate": "2020-09-10T07:58:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMyNjc0Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5326#discussion_r486326742", "bodyText": "Why explicitly only this interface? As I understand it we want to be backwards compatible, so we should change or delete existing interfaces, but we should always be able to add new ones right?", "author": "korthout", "createdAt": "2020-09-10T13:15:58Z", "path": "bpmn-model/pom.xml", "diffHunk": "@@ -57,6 +59,16 @@\n       <plugin>\n         <groupId>org.codehaus.mojo</groupId>\n         <artifactId>clirr-maven-plugin</artifactId>\n+        <configuration>\n+          <ignored>\n+            <ignored>\n+              <!-- ignore new methods in the Zeebe element instance interfaces -->", "originalCommit": "28f7dd22e636261f78b015e0a9c6d07c6443cc00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc1OTI5Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5326#discussion_r486759292", "bodyText": "Adding new methods should be okay. I included only the package io/zeebe/model/bpmn/instance/zeebe because that was the scope that I changed. In the future, we may include other packages. But for now, I would limit it to what we need.", "author": "saig0", "createdAt": "2020-09-11T03:58:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMyNjc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM0MDMxMQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5326#discussion_r486340311", "bodyText": "This behavior can be customized by defining output mappings at the call activity\n\nIs that true? Is the behavior still working for variables that are not defined in the output mapping when there are other output mappings defined and this prop is set to true?", "author": "korthout", "createdAt": "2020-09-10T13:34:39Z", "path": "docs/src/bpmn-workflows/call-activities/call-activities.md", "diffHunk": "@@ -32,9 +32,9 @@ When the call activity is activated then **all variables** of the call activity\n \n Input mappings can be used to create new local variables in the scope of the call activity. These variables are also copied to the created workflow instance.\n \n-By default, all variables of the created workflow instance are propagated to the call activity. This behavior can be customized by defining output mappings at the call activity. The output mappings are applied on completing the call activity.\n-This is especially important in the case of a call activity in a parallel flow to avoid overriding variables (e.g. when it is marked as\n-[parallel multi-instance](/bpmn-workflows/multi-instance/multi-instance.html#variable-mappings)).\n+If the attribute `propagateAllChildVariables` is set (default: `true`) then all variables of the created workflow instance are propagated to the call activity. This behavior can be customized by defining output mappings at the call activity. The output mappings are applied on completing the call activity.", "originalCommit": "28f7dd22e636261f78b015e0a9c6d07c6443cc00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc2MDA3Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5326#discussion_r486760072", "bodyText": "If any output mapping is defined then the mappings are applied and only the variables are propagated that are defined in the mappings.\nDo you have a suggestion on how to make this more clear in the docs?", "author": "saig0", "createdAt": "2020-09-11T04:01:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM0MDMxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcxNDU5MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5326#discussion_r487714590", "bodyText": "How about something like this: propagation of all variables is ignored when output mapping is defined, output mapping can be used to customize propagation, propagation is applied on completing.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If the attribute `propagateAllChildVariables` is set (default: `true`) then all variables of the created workflow instance are propagated to the call activity. This behavior can be customized by defining output mappings at the call activity. The output mappings are applied on completing the call activity.\n          \n          \n            \n            If the attribute `propagateAllChildVariables` is set (default: `true`) then all variables of the created workflow instance are propagated to the call activity. This behavior is ignored when output mappings are defined at the call activity. Output mappings can thus be used to customize which variables are propagated. The variable propagation is applied on completing the call activity.", "author": "korthout", "createdAt": "2020-09-14T07:46:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM0MDMxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM0MjgyMw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5326#discussion_r486342823", "bodyText": "I'm not sure this if statement is correct. If there are output mappings, but the new property is disabled, then this would still propagate all temp vars.", "author": "korthout", "createdAt": "2020-09-10T13:37:23Z", "path": "engine/src/main/java/io/zeebe/engine/processing/bpmn/container/CallActivityProcessor.java", "diffHunk": "@@ -136,7 +136,12 @@ public void onChildCompleted(\n     switch (currentState) {\n       case ELEMENT_ACTIVATED:\n         stateTransitionBehavior.transitionToCompleting(callActivityContext);\n-        stateBehavior.propagateTemporaryVariables(childContext, callActivityContext);\n+\n+        if (element.getOutputMappings().isPresent()\n+            || element.isPropagateAllChildVariablesEnabled()) {", "originalCommit": "28f7dd22e636261f78b015e0a9c6d07c6443cc00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc2MDYzMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5326#discussion_r486760632", "bodyText": "Yes, it is correct \ud83d\ude05  We need to set the temp variables to apply the output mappings on completing the call activity. Since this is done in another step (i.e. when processing another record), we need to copy all variables to temp.", "author": "saig0", "createdAt": "2020-09-11T04:03:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM0MjgyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM0NDY4Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5326#discussion_r486344682", "bodyText": "Would be good to add a test case for the following cases:\n\npropagateAllChildVariables = false && no output mappings\npropagateAllChildVariables = false && output mappings\npropagateAllChildVariables = true && no output mappings\npropagateAllChildVariables = true && output mappings", "author": "korthout", "createdAt": "2020-09-10T13:38:58Z", "path": "engine/src/test/java/io/zeebe/engine/processing/bpmn/activity/CallActivityTest.java", "diffHunk": "@@ -222,6 +222,34 @@ public void shouldPropagateVariablesToParent() {\n         .containsExactly(tuple(workflowInstanceKey, \"y\", \"2\"));\n   }\n \n+  @Test\n+  public void shouldNotPropagateVariablesToParentIfDisabled() {", "originalCommit": "28f7dd22e636261f78b015e0a9c6d07c6443cc00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc2MjI3Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5326#discussion_r486762273", "bodyText": "The cases are almost covered by the following tests:\n\npropagateAllChildVariables = false && no output mappings -> shouldNotPropagateVariablesToParentIfDisabled\npropagateAllChildVariables = false && output mappings -> behaves like  shouldApplyOutputMappings but we can add an additional test\npropagateAllChildVariables = true && no output mappings -> shouldPropagateVariablesToParent\npropagateAllChildVariables = true && output mappings -> shouldApplyOutputMappings", "author": "saig0", "createdAt": "2020-09-11T04:11:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM0NDY4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcxNTU4OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5326#discussion_r487715588", "bodyText": "Sorry, I did not look at the existing tests only at new code. I think it is fine like this, although I'm also fine if you add the \"propagateAllChildVariables = false && output mappings\" case explicitly.", "author": "korthout", "createdAt": "2020-09-14T07:47:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM0NDY4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM1MjU2MA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5326#discussion_r486352560", "bodyText": "It might be better to use INPUT_COLLECTION.size() instead of jobCounter.get(), to make the expected part less 'dynamic'.", "author": "korthout", "createdAt": "2020-09-10T13:46:08Z", "path": "engine/src/test/java/io/zeebe/engine/processing/bpmn/multiinstance/MultiInstanceCallActivityTest.java", "diffHunk": "@@ -185,6 +195,68 @@ public void shouldCancelChildInstancesOnTermination() {\n             BpmnElementType.PROCESS);\n   }\n \n+  @Test\n+  public void shouldCollectOutputFromChildInstance() {\n+    // given\n+    final BpmnModelInstance parentWorkflow =\n+        parentWorkflowWithCallActivity(\n+            callActivity ->\n+                callActivity\n+                    .zeebeOutputExpression(\"x\", \"result\")\n+                    .multiInstance(\n+                        b ->\n+                            b.zeebeInputCollectionExpression(INPUT_COLLECTION_VARIABLE)\n+                                .zeebeOutputElementExpression(\"result\")\n+                                .zeebeOutputCollection(\"results\")));\n+\n+    ENGINE.deployment().withXmlResource(\"wf-parent.bpmn\", parentWorkflow).deploy();\n+\n+    final long workflowInstanceKey =\n+        ENGINE\n+            .workflowInstance()\n+            .ofBpmnProcessId(PROCESS_ID_PARENT)\n+            .withVariable(INPUT_COLLECTION_VARIABLE, INPUT_COLLECTION)\n+            .create();\n+\n+    // when\n+    awaitJobsCreated(INPUT_COLLECTION.size());\n+\n+    final var jobCounter = new AtomicInteger();\n+\n+    ENGINE\n+        .jobs()\n+        .withType(jobType)\n+        .activate()\n+        .getValue()\n+        .getJobKeys()\n+        .forEach(\n+            jobKey ->\n+                ENGINE\n+                    .job()\n+                    .withKey(jobKey)\n+                    .withVariable(\"x\", jobCounter.incrementAndGet())\n+                    .complete());\n+\n+    RecordingExporter.workflowInstanceRecords(WorkflowInstanceIntent.ELEMENT_COMPLETED)\n+        .withWorkflowInstanceKey(workflowInstanceKey)\n+        .withElementType(BpmnElementType.MULTI_INSTANCE_BODY)\n+        .await();\n+\n+    // then\n+    final var expectedOutputCollection =\n+        JsonUtil.toJson(\n+            IntStream.rangeClosed(1, jobCounter.get()).boxed().collect(Collectors.toList()));", "originalCommit": "28f7dd22e636261f78b015e0a9c6d07c6443cc00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc2MDc0Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/5326#discussion_r486760746", "bodyText": "Ok \ud83d\udc4d", "author": "saig0", "createdAt": "2020-09-11T04:04:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM1MjU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQyMjI3Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5326#discussion_r488422277", "bodyText": "Nitpick: personally, I would write this sentence differently. But do with this what you want. \ud83d\ude04\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If the attribute `propagateAllChildVariables` is set (default: `true`) then all variables of the created workflow instance are propagated to the call activity. This behavior can be customized by defining output mappings at the call activity. The output mappings are applied on completing the call activity and only the variables are propagated that are defined in the output mappings.\n          \n          \n            \n            If the attribute `propagateAllChildVariables` is set (default: `true`) then all variables of the created workflow instance are propagated to the call activity. This behavior can be customized by defining output mappings at the call activity. The output mappings are applied on completing the call activity and only those variables that are defined in the output mappings are propagated.", "author": "korthout", "createdAt": "2020-09-15T06:41:26Z", "path": "docs/src/bpmn-workflows/call-activities/call-activities.md", "diffHunk": "@@ -32,7 +32,7 @@ When the call activity is activated then **all variables** of the call activity\n \n Input mappings can be used to create new local variables in the scope of the call activity. These variables are also copied to the created workflow instance.\n \n-If the attribute `propagateAllChildVariables` is set (default: `true`) then all variables of the created workflow instance are propagated to the call activity. This behavior can be customized by defining output mappings at the call activity. The output mappings are applied on completing the call activity.\n+If the attribute `propagateAllChildVariables` is set (default: `true`) then all variables of the created workflow instance are propagated to the call activity. This behavior can be customized by defining output mappings at the call activity. The output mappings are applied on completing the call activity and only the variables are propagated that are defined in the output mappings.", "originalCommit": "67b6fdc493e81f8962c88f4f4fa21c7edeba8e59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ec13d1bcc13b152dbf62f7da15ad14d74b054674", "url": "https://github.com/camunda-cloud/zeebe/commit/ec13d1bcc13b152dbf62f7da15ad14d74b054674", "message": "fix(engine): control variable propagation with new attribute\n\n* add a new Zeebe attribute for call activities to control if variables should be copied from a child instance\n* the new attribute is set by default to be backward-compatible and not change the existing behavior", "committedDate": "2020-09-15T06:59:42Z", "type": "commit"}, {"oid": "ec13d1bcc13b152dbf62f7da15ad14d74b054674", "url": "https://github.com/camunda-cloud/zeebe/commit/ec13d1bcc13b152dbf62f7da15ad14d74b054674", "message": "fix(engine): control variable propagation with new attribute\n\n* add a new Zeebe attribute for call activities to control if variables should be copied from a child instance\n* the new attribute is set by default to be backward-compatible and not change the existing behavior", "committedDate": "2020-09-15T06:59:42Z", "type": "forcePushed"}]}