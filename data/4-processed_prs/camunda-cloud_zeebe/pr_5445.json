{"pr_number": 5445, "pr_title": "Records contains the version of the broker", "pr_createdAt": "2020-09-30T11:11:48Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5445", "timeline": [{"oid": "eb98f5040b45dd8c1032d8dd639afaa6c16c56af", "url": "https://github.com/camunda-cloud/zeebe/commit/eb98f5040b45dd8c1032d8dd639afaa6c16c56af", "message": "feat(broker): records with broker version\n\n* add the version of the broker to the record metadata that wrote the record\n* expose the version in the exporter API\n* add a new property in the ES record template", "committedDate": "2020-09-30T11:09:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQzMDI1Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5445#discussion_r497430257", "bodyText": "I wrote this test in the broker because some records are written from broker code (e.g. deployments, user commands, message subscription records, etc.).", "author": "saig0", "createdAt": "2020-09-30T11:16:56Z", "path": "broker/src/test/java/io/zeebe/broker/engine/RecordVersionTest.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.broker.engine;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import io.zeebe.broker.test.EmbeddedBrokerRule;\n+import io.zeebe.model.bpmn.Bpmn;\n+import io.zeebe.model.bpmn.BpmnModelInstance;\n+import io.zeebe.protocol.record.Record;\n+import io.zeebe.protocol.record.ValueType;\n+import io.zeebe.protocol.record.intent.DeploymentIntent;\n+import io.zeebe.protocol.record.intent.WorkflowInstanceCreationIntent;\n+import io.zeebe.test.broker.protocol.commandapi.CommandApiRule;\n+import io.zeebe.test.util.BrokerClassRuleHelper;\n+import io.zeebe.test.util.record.RecordingExporter;\n+import io.zeebe.util.VersionUtil;\n+import java.io.ByteArrayOutputStream;\n+import java.util.List;\n+import java.util.Map;\n+import org.junit.ClassRule;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.RuleChain;\n+\n+public final class RecordVersionTest {", "originalCommit": "eb98f5040b45dd8c1032d8dd639afaa6c16c56af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQzMDc0Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/5445#discussion_r497430746", "bodyText": "The protocol version is always set then calling metadata.reset().", "author": "saig0", "createdAt": "2020-09-30T11:17:57Z", "path": "engine/src/main/java/io/zeebe/engine/processing/streamprocessor/writers/TypedCommandWriterImpl.java", "diffHunk": "@@ -31,7 +30,6 @@\n   protected long sourceRecordPosition = -1;\n \n   public TypedCommandWriterImpl(final LogStreamBatchWriter batchWriter) {\n-    metadata.protocolVersion(Protocol.PROTOCOL_VERSION);", "originalCommit": "eb98f5040b45dd8c1032d8dd639afaa6c16c56af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQzMTYyNA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5445#discussion_r497431624", "bodyText": "If it reads a record from a previous version then decoder.brokerVersion() returns null.", "author": "saig0", "createdAt": "2020-09-30T11:19:51Z", "path": "protocol-impl/src/main/java/io/zeebe/protocol/impl/record/RecordMetadata.java", "diffHunk": "@@ -64,6 +73,16 @@ public void wrap(final DirectBuffer buffer, int offset, final int length) {\n     intent = Intent.fromProtocolValue(valueType, decoder.intent());\n     rejectionType = decoder.rejectionType();\n \n+    brokerVersion =\n+        Optional.ofNullable(decoder.brokerVersion())\n+            .map(\n+                versionDecoder ->\n+                    new VersionInfo(\n+                        versionDecoder.majorVersion(),\n+                        versionDecoder.minorVersion(),\n+                        versionDecoder.patchVersion()))\n+            .orElse(VersionInfo.UNKNOWN);", "originalCommit": "eb98f5040b45dd8c1032d8dd639afaa6c16c56af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQzMjI5Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/5445#discussion_r497432296", "bodyText": "By default, it set the current version. So, we don't need to set the version explicitly when using the log stream writer.", "author": "saig0", "createdAt": "2020-09-30T11:21:10Z", "path": "protocol-impl/src/main/java/io/zeebe/protocol/impl/record/RecordMetadata.java", "diffHunk": "@@ -202,6 +236,7 @@ public RecordMetadata reset() {\n     intent = null;\n     rejectionType = RejectionType.NULL_VAL;\n     rejectionReason.wrap(0, 0);\n+    brokerVersion = CURRENT_BROKER_VERSION;", "originalCommit": "eb98f5040b45dd8c1032d8dd639afaa6c16c56af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQzMjg5Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5445#discussion_r497432893", "bodyText": "The main change of this PR. Adding a new field for the broker version. Following https://github.com/real-logic/simple-binary-encoding/wiki/Message-Versioning.", "author": "saig0", "createdAt": "2020-09-30T11:22:28Z", "path": "protocol/src/main/resources/protocol.xml", "diffHunk": "@@ -97,6 +104,7 @@\n     <field name=\"intent\" id=\"6\" type=\"uint8\"/>\n     <!-- populated when RecordType is COMMAND_REJECTION -->\n     <field name=\"rejectionType\" id=\"7\" type=\"RejectionType\"/>\n+    <field name=\"brokerVersion\" id=\"9\" type=\"Version\" sinceVersion=\"2\" presence=\"optional\" />", "originalCommit": "eb98f5040b45dd8c1032d8dd639afaa6c16c56af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}