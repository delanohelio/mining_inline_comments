{"pr_number": 3809, "pr_title": "chore(clients/go): time out container wait strategy and output container logs", "pr_createdAt": "2020-02-07T16:25:04Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/3809", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ4MzU4OA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3809#discussion_r376483588", "bodyText": "if block ends with a return statement, so drop this else and outdent its block (move short variable declaration to its own line if necessary) (from golint)", "author": "golangcibot", "createdAt": "2020-02-07T16:26:42Z", "path": "clients/go/internal/containersuite/containerSuite.go", "diffHunk": "@@ -57,6 +59,35 @@ func (s zeebeWaitStrategy) WaitUntilReady(ctx context.Context, target wait.Strat\n \t\treturn err\n \t}\n \n+\tdefer func() {\n+\t\t_ = zbClient.Close()\n+\t}()\n+\n+\tfinishedChan := make(chan error, 1)\n+\tgo s.waitForTopology(finishedChan, zbClient)\n+\n+\tselect {\n+\tcase err = <-finishedChan:\n+\t\treturn err\n+\tcase <-time.After(utils.DefaultContainerWaitTimeout):\n+\t\treader, err := target.Logs(ctx)\n+\t\tif err != nil {\n+\t\t\treturn fmt.Errorf(\"Timed out awaiting container, and failed to obtain container logs: %w\", err)\n+\t\t}\n+\t\tif bytes, err := ioutil.ReadAll(reader); err != nil {\n+\t\t\t_, _ = fmt.Fprint(os.Stderr, \"=====================================\\n\")\n+\t\t\t_, _ = fmt.Fprint(os.Stderr, \"Container logs\\n\")\n+\t\t\t_, _ = fmt.Fprint(os.Stderr, \"=====================================\\n\")\n+\t\t\t_, _ = fmt.Fprintf(os.Stderr, \"%s\", bytes)\n+\n+\t\t\treturn fmt.Errorf(\"Timed out awaiting container\")\n+\t\t} else {", "originalCommit": "c88ada2a716338fba2dd1245a59e336af0f039c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5fb10cbf500f62536c9f307b817ab8cae661cb3f", "url": "https://github.com/camunda-cloud/zeebe/commit/5fb10cbf500f62536c9f307b817ab8cae661cb3f", "message": "chore(clients/go): increase default container timeout", "committedDate": "2020-02-10T08:44:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk1NjM4NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3809#discussion_r376956384", "bodyText": "I think you want to do the opposite here, print the logs if the error is nil", "author": "MiguelPires", "createdAt": "2020-02-10T09:47:33Z", "path": "clients/go/internal/containersuite/containerSuite.go", "diffHunk": "@@ -57,6 +59,35 @@ func (s zeebeWaitStrategy) WaitUntilReady(ctx context.Context, target wait.Strat\n \t\treturn err\n \t}\n \n+\tdefer func() {\n+\t\t_ = zbClient.Close()\n+\t}()\n+\n+\tfinishedChan := make(chan error, 1)\n+\tgo s.waitForTopology(finishedChan, zbClient)\n+\n+\tselect {\n+\tcase err = <-finishedChan:\n+\t\treturn err\n+\tcase <-time.After(utils.DefaultContainerWaitTimeout):\n+\t\treader, err := target.Logs(ctx)\n+\t\tif err != nil {\n+\t\t\treturn fmt.Errorf(\"Timed out awaiting container, and failed to obtain container logs: %w\", err)\n+\t\t}\n+\t\tif bytes, err := ioutil.ReadAll(reader); err != nil {", "originalCommit": "5fb10cbf500f62536c9f307b817ab8cae661cb3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk2MjkzNQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3809#discussion_r376962935", "bodyText": "Here you can just do errors.New since you're not formatting. The end result is the same though so not a big deal", "author": "MiguelPires", "createdAt": "2020-02-10T09:58:53Z", "path": "clients/go/internal/containersuite/containerSuite.go", "diffHunk": "@@ -57,6 +59,35 @@ func (s zeebeWaitStrategy) WaitUntilReady(ctx context.Context, target wait.Strat\n \t\treturn err\n \t}\n \n+\tdefer func() {\n+\t\t_ = zbClient.Close()\n+\t}()\n+\n+\tfinishedChan := make(chan error, 1)\n+\tgo s.waitForTopology(finishedChan, zbClient)\n+\n+\tselect {\n+\tcase err = <-finishedChan:\n+\t\treturn err\n+\tcase <-time.After(utils.DefaultContainerWaitTimeout):\n+\t\treader, err := target.Logs(ctx)\n+\t\tif err != nil {\n+\t\t\treturn fmt.Errorf(\"Timed out awaiting container, and failed to obtain container logs: %w\", err)\n+\t\t}\n+\t\tif bytes, err := ioutil.ReadAll(reader); err != nil {\n+\t\t\t_, _ = fmt.Fprint(os.Stderr, \"=====================================\\n\")\n+\t\t\t_, _ = fmt.Fprint(os.Stderr, \"Container logs\\n\")\n+\t\t\t_, _ = fmt.Fprint(os.Stderr, \"=====================================\\n\")\n+\t\t\t_, _ = fmt.Fprintf(os.Stderr, \"%s\", bytes)\n+\n+\t\t\treturn fmt.Errorf(\"Timed out awaiting container\")", "originalCommit": "5fb10cbf500f62536c9f307b817ab8cae661cb3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzAyNzE1MQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3809#discussion_r377027151", "bodyText": "hm, I wanted to avoid using the errors package since I don't really need it? What's the difference?", "author": "npepinpe", "createdAt": "2020-02-10T12:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk2MjkzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzAzNDA0Mw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3809#discussion_r377034043", "bodyText": "nvm found it :)", "author": "npepinpe", "createdAt": "2020-02-10T12:30:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk2MjkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk2MzMwNw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3809#discussion_r376963307", "bodyText": "Error messages shouldn't be capitalized or end with punctuation because they're usually wrapped (this applies to the other errors as well)", "author": "MiguelPires", "createdAt": "2020-02-10T09:59:38Z", "path": "clients/go/internal/containersuite/containerSuite.go", "diffHunk": "@@ -57,6 +59,35 @@ func (s zeebeWaitStrategy) WaitUntilReady(ctx context.Context, target wait.Strat\n \t\treturn err\n \t}\n \n+\tdefer func() {\n+\t\t_ = zbClient.Close()\n+\t}()\n+\n+\tfinishedChan := make(chan error, 1)\n+\tgo s.waitForTopology(finishedChan, zbClient)\n+\n+\tselect {\n+\tcase err = <-finishedChan:\n+\t\treturn err\n+\tcase <-time.After(utils.DefaultContainerWaitTimeout):\n+\t\treader, err := target.Logs(ctx)\n+\t\tif err != nil {\n+\t\t\treturn fmt.Errorf(\"Timed out awaiting container, and failed to obtain container logs: %w\", err)", "originalCommit": "5fb10cbf500f62536c9f307b817ab8cae661cb3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzAyNjkzMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3809#discussion_r377026932", "bodyText": "Fair enough \ud83d\udc4d", "author": "npepinpe", "createdAt": "2020-02-10T12:15:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk2MzMwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MTAyOQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/3809#discussion_r376971029", "bodyText": "If this method stays the same, one thing we can do here is have the parameter as finished chan<- error which makes this a write-only channel and explicitly tells us what happens with it.", "author": "MiguelPires", "createdAt": "2020-02-10T10:14:17Z", "path": "clients/go/internal/containersuite/containerSuite.go", "diffHunk": "@@ -57,6 +59,35 @@ func (s zeebeWaitStrategy) WaitUntilReady(ctx context.Context, target wait.Strat\n \t\treturn err\n \t}\n \n+\tdefer func() {\n+\t\t_ = zbClient.Close()\n+\t}()\n+\n+\tfinishedChan := make(chan error, 1)\n+\tgo s.waitForTopology(finishedChan, zbClient)\n+\n+\tselect {\n+\tcase err = <-finishedChan:\n+\t\treturn err\n+\tcase <-time.After(utils.DefaultContainerWaitTimeout):\n+\t\treader, err := target.Logs(ctx)\n+\t\tif err != nil {\n+\t\t\treturn fmt.Errorf(\"Timed out awaiting container, and failed to obtain container logs: %w\", err)\n+\t\t}\n+\t\tif bytes, err := ioutil.ReadAll(reader); err != nil {\n+\t\t\t_, _ = fmt.Fprint(os.Stderr, \"=====================================\\n\")\n+\t\t\t_, _ = fmt.Fprint(os.Stderr, \"Container logs\\n\")\n+\t\t\t_, _ = fmt.Fprint(os.Stderr, \"=====================================\\n\")\n+\t\t\t_, _ = fmt.Fprintf(os.Stderr, \"%s\", bytes)\n+\n+\t\t\treturn fmt.Errorf(\"Timed out awaiting container\")\n+\t\t}\n+\n+\t\treturn fmt.Errorf(\"Timed out awaiting container, but failed to read container logs: %w\", err)\n+\t}\n+}\n+\n+func (s zeebeWaitStrategy) waitForTopology(finishedChan chan error, zbClient zbc.Client) {", "originalCommit": "5fb10cbf500f62536c9f307b817ab8cae661cb3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzAyNzMyNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3809#discussion_r377027326", "bodyText": "That's probably a good idea, we can make it bidi if we ever need it \ud83d\udc4d", "author": "npepinpe", "createdAt": "2020-02-10T12:16:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MTAyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MTU4Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/3809#discussion_r376971586", "bodyText": "I wouldn't pass the channel into the method since I think it restricts the reusability of this method (you can only use it in a separate goroutine and you have to give it a channel). I'd either: a) make the method synchronous and have the lambda put the error value in the channel or b) make it asynchronous and self contained, by having it create the channel and go routine itself", "author": "MiguelPires", "createdAt": "2020-02-10T10:15:26Z", "path": "clients/go/internal/containersuite/containerSuite.go", "diffHunk": "@@ -57,6 +59,35 @@ func (s zeebeWaitStrategy) WaitUntilReady(ctx context.Context, target wait.Strat\n \t\treturn err\n \t}\n \n+\tdefer func() {\n+\t\t_ = zbClient.Close()\n+\t}()\n+\n+\tfinishedChan := make(chan error, 1)\n+\tgo s.waitForTopology(finishedChan, zbClient)", "originalCommit": "5fb10cbf500f62536c9f307b817ab8cae661cb3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzAyNjY3Nw==", "url": "https://github.com/camunda-cloud/zeebe/pull/3809#discussion_r377026677", "bodyText": "How would you time it out if we made synchronous?", "author": "npepinpe", "createdAt": "2020-02-10T12:14:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MTU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzAyOTEwNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/3809#discussion_r377029106", "bodyText": "go func() {\n\t\tfinishedChan <- s.waitForTopology(zbClient)\n\t}()\nand waitForTopology would just synchronously return the error", "author": "MiguelPires", "createdAt": "2020-02-10T12:20:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MTU4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk4MjcxMA==", "url": "https://github.com/camunda-cloud/zeebe/pull/3809#discussion_r376982710", "bodyText": "Minor thing: you can do fmt.Fprintln if you want", "author": "MiguelPires", "createdAt": "2020-02-10T10:36:56Z", "path": "clients/go/internal/containersuite/containerSuite.go", "diffHunk": "@@ -57,6 +59,35 @@ func (s zeebeWaitStrategy) WaitUntilReady(ctx context.Context, target wait.Strat\n \t\treturn err\n \t}\n \n+\tdefer func() {\n+\t\t_ = zbClient.Close()\n+\t}()\n+\n+\tfinishedChan := make(chan error, 1)\n+\tgo s.waitForTopology(finishedChan, zbClient)\n+\n+\tselect {\n+\tcase err = <-finishedChan:\n+\t\treturn err\n+\tcase <-time.After(utils.DefaultContainerWaitTimeout):\n+\t\treader, err := target.Logs(ctx)\n+\t\tif err != nil {\n+\t\t\treturn fmt.Errorf(\"Timed out awaiting container, and failed to obtain container logs: %w\", err)\n+\t\t}\n+\t\tif bytes, err := ioutil.ReadAll(reader); err != nil {\n+\t\t\t_, _ = fmt.Fprint(os.Stderr, \"=====================================\\n\")\n+\t\t\t_, _ = fmt.Fprint(os.Stderr, \"Container logs\\n\")", "originalCommit": "5fb10cbf500f62536c9f307b817ab8cae661cb3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0fe302f522969700f9f5f26ea7695bb0aa1bfaa0", "url": "https://github.com/camunda-cloud/zeebe/commit/0fe302f522969700f9f5f26ea7695bb0aa1bfaa0", "message": "chore(clients/go): time out container wait strategy and output container logs", "committedDate": "2020-02-10T13:05:24Z", "type": "commit"}, {"oid": "0fe302f522969700f9f5f26ea7695bb0aa1bfaa0", "url": "https://github.com/camunda-cloud/zeebe/commit/0fe302f522969700f9f5f26ea7695bb0aa1bfaa0", "message": "chore(clients/go): time out container wait strategy and output container logs", "committedDate": "2020-02-10T13:05:24Z", "type": "forcePushed"}]}