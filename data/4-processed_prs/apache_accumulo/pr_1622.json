{"pr_number": 1622, "pr_title": "fixes #1621: The ClientPool thread pool allows all core threads to time out", "pr_createdAt": "2020-06-04T18:20:26Z", "pr_url": "https://github.com/apache/accumulo/pull/1622", "timeline": [{"oid": "dbfab01a39e7bc6ac92f8641fc4b1c0f0c22039f", "url": "https://github.com/apache/accumulo/commit/dbfab01a39e7bc6ac92f8641fc4b1c0f0c22039f", "message": "fixes #1621: The ClientPool thread pool allows all core threads to time out\n  * Added properties to allow overridding the allowCoreThreadTimeout in\n    various threadpools: master incoming requests, tserver incoming requests, master bulk imports", "committedDate": "2020-06-04T18:17:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2Nzc2NQ==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r435467765", "bodyText": "The default of true maintains the current behavior, however that behavior seemed problematic in the issue you opened.  Makes me wonder if the default should be false.", "author": "keith-turner", "createdAt": "2020-06-04T18:34:13Z", "path": "core/src/main/java/org/apache/accumulo/core/conf/Property.java", "diffHunk": "@@ -452,6 +458,9 @@\n       \"The time to wait for a tablet server to process a bulk import request.\"),\n   TSERV_MINTHREADS(\"tserver.server.threads.minimum\", \"20\", PropertyType.COUNT,\n       \"The minimum number of threads to use to handle incoming requests.\"),\n+  TSERV_MINTHREADS_ALLOW_TIMEOUT(\"tserver.server.thread.timeout.allowed\", \"true\",", "originalCommit": "dbfab01a39e7bc6ac92f8641fc4b1c0f0c22039f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUwNzI3MA==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r435507270", "bodyText": "I thought about that.  I think this only really becomes a problem when you are dealing with very large numbers of threads (300+ maybe) which is why I left the default as true.  I am certainly will to change it to false however.", "author": "ivakegg", "createdAt": "2020-06-04T19:44:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2Nzc2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxMjM0OA==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r435512348", "bodyText": "I am slightly in favor of false because it addresses a known problem and seems like it should not cause problems, but it could.  The way this change is structured it does not change all of the existing code to false just a few select places, which is good.  Leaving most of the internal usage w/ a hard coded true is good and changing just these configurable ones to false may be a good way to go.", "author": "keith-turner", "createdAt": "2020-06-04T19:53:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2Nzc2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg5NDM0NA==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r435894344", "bodyText": "ok, I am game for that.  I will change it now.", "author": "ivakegg", "createdAt": "2020-06-05T12:40:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2Nzc2NQ=="}], "type": "inlineReview"}, {"oid": "4d6991afc9c9589b829c2b9677a47e85586cc5aa", "url": "https://github.com/apache/accumulo/commit/4d6991afc9c9589b829c2b9677a47e85586cc5aa", "message": "re #1621: Changed the default to \"false\" for the ...ALLOW_TIMEOUT properties", "committedDate": "2020-06-05T12:43:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1NDc1Mw==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r436854753", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              TSERV_MINTHREADS_ALLOW_TIMEOUT(\"tserver.server.thread.timeout.allowed\", \"false\",\n          \n          \n            \n              TSERV_MINTHREADS_ALLOW_TIMEOUT(\"tserver.server.threads.timeout.allowed\", \"false\",", "author": "keith-turner", "createdAt": "2020-06-08T16:57:54Z", "path": "core/src/main/java/org/apache/accumulo/core/conf/Property.java", "diffHunk": "@@ -452,6 +458,9 @@\n       \"The time to wait for a tablet server to process a bulk import request.\"),\n   TSERV_MINTHREADS(\"tserver.server.threads.minimum\", \"20\", PropertyType.COUNT,\n       \"The minimum number of threads to use to handle incoming requests.\"),\n+  TSERV_MINTHREADS_ALLOW_TIMEOUT(\"tserver.server.thread.timeout.allowed\", \"false\",", "originalCommit": "4d6991afc9c9589b829c2b9677a47e85586cc5aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1NDk0Ng==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r436854946", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              MASTER_MINTHREADS_ALLOW_TIMEOUT(\"master.server.thread.timeout.allowed\", \"false\",\n          \n          \n            \n              MASTER_MINTHREADS_ALLOW_TIMEOUT(\"master.server.threads.timeout.allowed\", \"false\",", "author": "keith-turner", "createdAt": "2020-06-08T16:58:14Z", "path": "core/src/main/java/org/apache/accumulo/core/conf/Property.java", "diffHunk": "@@ -259,6 +262,9 @@\n       \"Regular expression that defines the set of Tablet Servers that will perform bulk imports\"),\n   MASTER_MINTHREADS(\"master.server.threads.minimum\", \"20\", PropertyType.COUNT,\n       \"The minimum number of threads to use to handle incoming requests.\"),\n+  MASTER_MINTHREADS_ALLOW_TIMEOUT(\"master.server.thread.timeout.allowed\", \"false\",", "originalCommit": "4d6991afc9c9589b829c2b9677a47e85586cc5aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1NTIwMA==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r436855200", "bodyText": "To me making the property perfix the same as far as possible with the existing prop provides a clue that these two props go together.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              MASTER_BULK_THREADPOOL_ALLOW_TIMEOUT(\"master.bulk.thread.timeout.allowed\", \"false\",\n          \n          \n            \n              MASTER_BULK_THREADPOOL_ALLOW_TIMEOUT(\"master.bulk.threadpool.timeout.allowed\", \"false\",", "author": "keith-turner", "createdAt": "2020-06-08T16:58:42Z", "path": "core/src/main/java/org/apache/accumulo/core/conf/Property.java", "diffHunk": "@@ -246,6 +246,9 @@\n       \"The number of attempts to bulk import a RFile before giving up.\"),\n   MASTER_BULK_THREADPOOL_SIZE(\"master.bulk.threadpool.size\", \"5\", PropertyType.COUNT,\n       \"The number of threads to use when coordinating a bulk import.\"),\n+  MASTER_BULK_THREADPOOL_ALLOW_TIMEOUT(\"master.bulk.thread.timeout.allowed\", \"false\",", "originalCommit": "4d6991afc9c9589b829c2b9677a47e85586cc5aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1NzU5MQ==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r436857591", "bodyText": "While we are examining this code, I think it would be a good idea to increase this timeout to a few minutes and use a a private constant.   Maybe 3 to 5 mins.  Could do private static final   TIMEOUT_SECS=180\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                super(coreAndMax, coreAndMax, 4L, TimeUnit.SECONDS, queue, new NamingThreadFactory(name));\n          \n          \n            \n                super(coreAndMax, coreAndMax, TIMEOUT_SECS, TimeUnit.SECONDS, queue, new NamingThreadFactory(name));", "author": "keith-turner", "createdAt": "2020-06-08T17:02:57Z", "path": "core/src/main/java/org/apache/accumulo/core/util/SimpleThreadPool.java", "diffHunk": "@@ -28,15 +28,16 @@\n  */\n public class SimpleThreadPool extends ThreadPoolExecutor {\n \n-  public SimpleThreadPool(int max, final String name) {\n-    super(max, max, 4L, TimeUnit.SECONDS, new LinkedBlockingQueue<>(),\n+  public SimpleThreadPool(int coreAndMax, boolean allowCoreThreadTimeOut, final String name) {\n+    super(coreAndMax, coreAndMax, 4L, TimeUnit.SECONDS, new LinkedBlockingQueue<>(),\n         new NamingThreadFactory(name));\n-    allowCoreThreadTimeOut(true);\n+    allowCoreThreadTimeOut(allowCoreThreadTimeOut);\n   }\n \n-  public SimpleThreadPool(int max, final String name, BlockingQueue<Runnable> queue) {\n-    super(max, max, 4L, TimeUnit.SECONDS, queue, new NamingThreadFactory(name));\n-    allowCoreThreadTimeOut(true);\n+  public SimpleThreadPool(int coreAndMax, boolean allowCoreThreadTimeOut, final String name,\n+      BlockingQueue<Runnable> queue) {\n+    super(coreAndMax, coreAndMax, 4L, TimeUnit.SECONDS, queue, new NamingThreadFactory(name));", "originalCommit": "4d6991afc9c9589b829c2b9677a47e85586cc5aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzMjU0NQ==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r444332545", "bodyText": "I changed this to TIMEOUT_SECS with a value of 180.  I am wondering whether this should be configurable as well.  @keith-turner thoughts?", "author": "ivakegg", "createdAt": "2020-06-23T15:56:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1NzU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUzNDI4OQ==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r444534289", "bodyText": "I am not sure it needs to be made configurable.  If it were configurable maybe we could have a single property with just the timeout and a timeout of zero means no timeout.", "author": "keith-turner", "createdAt": "2020-06-23T22:03:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1NzU5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM4NjI0Mw==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r448386243", "bodyText": "Your idea is starting to grow on me.  Instead of ALLOW_TIMEOUT properties I will create a THREAD_TIMEOUT properties which default to 0.  I will work that through and update unless I find any issues.", "author": "ivakegg", "createdAt": "2020-07-01T14:04:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1NzU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg1Nzc4MA==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r436857780", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                super(coreAndMax, coreAndMax, 4L, TimeUnit.SECONDS, new LinkedBlockingQueue<>(),\n          \n          \n            \n                super(coreAndMax, coreAndMax, TIMEOUT_SECS, TimeUnit.SECONDS, new LinkedBlockingQueue<>(),", "author": "keith-turner", "createdAt": "2020-06-08T17:03:15Z", "path": "core/src/main/java/org/apache/accumulo/core/util/SimpleThreadPool.java", "diffHunk": "@@ -28,15 +28,16 @@\n  */\n public class SimpleThreadPool extends ThreadPoolExecutor {\n \n-  public SimpleThreadPool(int max, final String name) {\n-    super(max, max, 4L, TimeUnit.SECONDS, new LinkedBlockingQueue<>(),\n+  public SimpleThreadPool(int coreAndMax, boolean allowCoreThreadTimeOut, final String name) {\n+    super(coreAndMax, coreAndMax, 4L, TimeUnit.SECONDS, new LinkedBlockingQueue<>(),", "originalCommit": "4d6991afc9c9589b829c2b9677a47e85586cc5aa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgzMjk1Nw==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r440832957", "bodyText": "minor nit: I think this is a great set of features; however, I had a question about the wording. \"True... if... allowed\" made me think another setting would impact this, but I imagine it is the case that if this is true then timeouts can occur.\n\"Allows request threads to time out when no work is available\" might be more clear but @keith-turner spent more time here so he can likely correct me from his perspective -- and it may be the case that my interpretation is wrong.", "author": "phrocker", "createdAt": "2020-06-16T13:05:05Z", "path": "core/src/main/java/org/apache/accumulo/core/conf/Property.java", "diffHunk": "@@ -452,6 +458,9 @@\n       \"The time to wait for a tablet server to process a bulk import request.\"),\n   TSERV_MINTHREADS(\"tserver.server.threads.minimum\", \"20\", PropertyType.COUNT,\n       \"The minimum number of threads to use to handle incoming requests.\"),\n+  TSERV_MINTHREADS_ALLOW_TIMEOUT(\"tserver.server.thread.timeout.allowed\", \"false\",\n+      PropertyType.BOOLEAN,\n+      \"True if the incoming request threads are allowed to timeout with no work available.\"),", "originalCommit": "4d6991afc9c9589b829c2b9677a47e85586cc5aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjI1NA==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r444336254", "bodyText": "I have no problem changing the descriptions as such.  done.", "author": "ivakegg", "createdAt": "2020-06-23T16:01:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgzMjk1Nw=="}], "type": "inlineReview"}, {"oid": "6b7c4662406ade21d50ada9add35a2576809205b", "url": "https://github.com/apache/accumulo/commit/6b7c4662406ade21d50ada9add35a2576809205b", "message": "Update core/src/main/java/org/apache/accumulo/core/conf/Property.java\n\nCo-authored-by: Keith Turner <kturner@apache.org>", "committedDate": "2020-06-23T14:20:32Z", "type": "commit"}, {"oid": "d02af53a2b23df64b5b808553222bfbe876b9c95", "url": "https://github.com/apache/accumulo/commit/d02af53a2b23df64b5b808553222bfbe876b9c95", "message": "Update core/src/main/java/org/apache/accumulo/core/conf/Property.java\n\nCo-authored-by: Keith Turner <kturner@apache.org>", "committedDate": "2020-06-23T14:20:40Z", "type": "commit"}, {"oid": "8f43f0eea064723e58ae7152e5b9718b845314b9", "url": "https://github.com/apache/accumulo/commit/8f43f0eea064723e58ae7152e5b9718b845314b9", "message": "Update core/src/main/java/org/apache/accumulo/core/conf/Property.java\n\nCo-authored-by: Keith Turner <kturner@apache.org>", "committedDate": "2020-06-23T14:20:47Z", "type": "commit"}, {"oid": "3bfd3b1bd0f5758ab02b49f176adfbcc302266b9", "url": "https://github.com/apache/accumulo/commit/3bfd3b1bd0f5758ab02b49f176adfbcc302266b9", "message": "re #1621: Increased the thread pool timeout.", "committedDate": "2020-06-23T15:50:15Z", "type": "commit"}, {"oid": "748ebbcdc8aa24db501c0d4f5df7afcb8ec85993", "url": "https://github.com/apache/accumulo/commit/748ebbcdc8aa24db501c0d4f5df7afcb8ec85993", "message": "re #1621: refine property description", "committedDate": "2020-06-23T16:00:51Z", "type": "commit"}, {"oid": "c7d70a6a0d2c3f859e3299831812ae30cec27e95", "url": "https://github.com/apache/accumulo/commit/c7d70a6a0d2c3f859e3299831812ae30cec27e95", "message": "re #1621: Changed the mechanism to supply a timeout property instead of allow_timeout boolean", "committedDate": "2020-07-01T19:37:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYyNjUyMw==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r448626523", "bodyText": "Would it work to only do the following in the constructor?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                super(coreAndMax, coreAndMax, threadTimeOut, TimeUnit.MILLISECONDS, new LinkedBlockingQueue<>(),\n          \n          \n            \n                this(coreAndMax, threadTimeOut, name, new LinkedBlockingQueue<>());", "author": "keith-turner", "createdAt": "2020-07-01T21:30:16Z", "path": "core/src/main/java/org/apache/accumulo/core/util/SimpleThreadPool.java", "diffHunk": "@@ -28,15 +28,32 @@\n  */\n public class SimpleThreadPool extends ThreadPoolExecutor {\n \n-  public SimpleThreadPool(int max, final String name) {\n-    super(max, max, 4L, TimeUnit.SECONDS, new LinkedBlockingQueue<>(),\n+  // the number of seconds before we allow a thread to terminate with non-use.\n+  public static final long DEFAULT_TIMEOUT_MILLISECS = 180000L;\n+\n+  public SimpleThreadPool(int coreAndMax, final String name) {\n+    this(coreAndMax, DEFAULT_TIMEOUT_MILLISECS, name);\n+  }\n+\n+  public SimpleThreadPool(int coreAndMax, long threadTimeOut, final String name) {\n+    super(coreAndMax, coreAndMax, threadTimeOut, TimeUnit.MILLISECONDS, new LinkedBlockingQueue<>(),", "originalCommit": "c7d70a6a0d2c3f859e3299831812ae30cec27e95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyODQwNQ==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r450828405", "bodyText": "That would work and would be cleaner.  I could also them remove the redundant lines after.  I will add this change.", "author": "ivakegg", "createdAt": "2020-07-07T12:32:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYyNjUyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg1MDg1NQ==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r450850855", "bodyText": "done", "author": "ivakegg", "createdAt": "2020-07-07T13:09:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYyNjUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMjI3OQ==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r448632279", "bodyText": "I was trying to ensure the parameter order was correct when looking at this PR.  Once I realized you had consistently put the timeout after the number of threads here and elsewhere it made verifying the order much easier.", "author": "keith-turner", "createdAt": "2020-07-01T21:44:29Z", "path": "server/base/src/main/java/org/apache/accumulo/server/rpc/TServerUtils.java", "diffHunk": "@@ -231,8 +236,8 @@ public static ServerAddress startServer(MetricsSystem metricsSystem, ServerConte\n    */\n   public static ServerAddress createThreadedSelectorServer(HostAndPort address,\n       TProcessor processor, TProtocolFactory protocolFactory, final String serverName,\n-      final int numThreads, final int numSTThreads, long timeBetweenThreadChecks,\n-      long maxMessageSize) throws TTransportException {\n+      final int numThreads, final long threadTimeOut, final int numSTThreads,", "originalCommit": "c7d70a6a0d2c3f859e3299831812ae30cec27e95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg1MTAwNQ==", "url": "https://github.com/apache/accumulo/pull/1622#discussion_r450851005", "bodyText": "cool", "author": "ivakegg", "createdAt": "2020-07-07T13:09:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMjI3OQ=="}], "type": "inlineReview"}, {"oid": "3ee8dc2b6fac6287652942863e999b9ca694bfb0", "url": "https://github.com/apache/accumulo/commit/3ee8dc2b6fac6287652942863e999b9ca694bfb0", "message": "re #1621: Simplified constructors in the SimpleThreadPool", "committedDate": "2020-07-07T13:08:46Z", "type": "commit"}]}