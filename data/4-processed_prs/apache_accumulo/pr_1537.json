{"pr_number": 1537, "pr_title": "Add PrintInfo options to dump full keys, apply formatter", "pr_createdAt": "2020-02-28T00:44:05Z", "pr_url": "https://github.com/apache/accumulo/pull/1537", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ3NTAyMA==", "url": "https://github.com/apache/accumulo/pull/1537#discussion_r385475020", "bodyText": "This is a general question - would this reflection code need to change for jdk-11+ (for when this is merged forward)? Specifically, is this still the standard way to use reflection, or has the \"standard\" changed?  From what I've read it looks okay, but thought it warranted checking.", "author": "EdColeman", "createdAt": "2020-02-28T02:12:44Z", "path": "core/src/main/java/org/apache/accumulo/core/file/rfile/PrintInfo.java", "diffHunk": "@@ -119,6 +182,18 @@ public String keyword() {\n     return \"rfile-info\";\n   }\n \n+  protected Class<? extends Formatter> getFormater(String formatterClazz) {\n+    try {\n+      if (formatterClazz != null) {\n+        return this.getClass().getClassLoader().loadClass(formatterClazz)\n+            .asSubclass(Formatter.class);\n+      }\n+    } catch (ClassNotFoundException e) {\n+      System.err.println(\"Could not find formatter class: \" + formatterClazz);\n+    }\n+    return null;\n+  }\n+", "originalCommit": "403dfe12dc2b953b06f909094c60cd536b79d3bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ3NzQyMw==", "url": "https://github.com/apache/accumulo/pull/1537#discussion_r385477423", "bodyText": "I think this will work fine in Java 11, since it uses the class loader of the current class, and not the system class loader.", "author": "ctubbsii", "createdAt": "2020-02-28T02:23:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ3NTAyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkxODc3OA==", "url": "https://github.com/apache/accumulo/pull/1537#discussion_r385918778", "bodyText": "The formatter class is a bit of a mess.  What do you think about accepting any class that implements BiFunction<Key, Value, String>?  If you have a strong need specifically for the formatter, please ignore the comments related to BiFunction", "author": "keith-turner", "createdAt": "2020-02-28T20:57:45Z", "path": "core/src/main/java/org/apache/accumulo/core/file/rfile/PrintInfo.java", "diffHunk": "@@ -49,6 +59,12 @@\n   static class Opts extends Help {\n     @Parameter(names = {\"-d\", \"--dump\"}, description = \"dump the key/value pairs\")\n     boolean dump = false;\n+    @Parameter(names = {\"--fullKeys\"},\n+        description = \"dump full keys regardless of length, do no truncate, implies --dump\")\n+    boolean fullKeys = false;\n+    @Parameter(names = {\"--formatter\"},\n+        description = \"specify a formatter class to apply to rfile contents, implies --dump\")", "originalCommit": "403dfe12dc2b953b06f909094c60cd536b79d3bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ2NzkyMQ==", "url": "https://github.com/apache/accumulo/pull/1537#discussion_r386467921", "bodyText": "Let me give this a shot. I can't recall whether Formatter implements BiFunction<Key, Value String> - I suspect it does not", "author": "drewfarris", "createdAt": "2020-03-02T15:38:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkxODc3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyMTU4Ng==", "url": "https://github.com/apache/accumulo/pull/1537#discussion_r385921586", "bodyText": "If using BiFunction could possibly do\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Formatter formatter = null;\n          \n          \n            \n                    if (opts.formatterClazz != null) {\n          \n          \n            \n                      final Class<? extends Formatter> formatterClass = getFormater(opts.formatterClazz);\n          \n          \n            \n                      FormatterConfig config = new FormatterConfig();\n          \n          \n            \n                      config.setPrintTimestamps(true);\n          \n          \n            \n                      formatter =\n          \n          \n            \n                          FormatterFactory.getFormatter(formatterClass, new FormatterAdapter(dataIter), config);\n          \n          \n            \n                    }\n          \n          \n            \n                    BiFunction<Key,Value,String> formatter = null;\n          \n          \n            \n                    if (opts.formatterClazz != null) {\n          \n          \n            \n                      final Class<? extends BiFunction<Key,Value,String>> formatterClass = getFormater(opts.formatterClazz);\n          \n          \n            \n                      formatter = formatterClass.newInstance();\n          \n          \n            \n                    } else if (opts.fullKeys) {\n          \n          \n            \n                      formatter = (key, value) - > {key.toStringNoTruncate() + \" -> \" + value};\n          \n          \n            \n                    } else if(opts.dump){\n          \n          \n            \n                       formatter = (key, value) - > {key + \" -> \" + value};\n          \n          \n            \n                    }", "author": "keith-turner", "createdAt": "2020-02-28T21:05:06Z", "path": "core/src/main/java/org/apache/accumulo/core/file/rfile/PrintInfo.java", "diffHunk": "@@ -192,23 +268,43 @@ public void execute(final String[] args) throws Exception {\n           }\n         }\n \n+        Formatter formatter = null;\n+        if (opts.formatterClazz != null) {\n+          final Class<? extends Formatter> formatterClass = getFormater(opts.formatterClazz);\n+          FormatterConfig config = new FormatterConfig();\n+          config.setPrintTimestamps(true);\n+          formatter =\n+              FormatterFactory.getFormatter(formatterClass, new FormatterAdapter(dataIter), config);\n+        }", "originalCommit": "403dfe12dc2b953b06f909094c60cd536b79d3bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyMTgwMg==", "url": "https://github.com/apache/accumulo/pull/1537#discussion_r385921802", "bodyText": "If using BiFunction this could go away.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        while (formatter.hasNext()) {\n          \n          \n            \n                          System.out.print(formatter.next());\n          \n          \n            \n                          if (System.out.checkError()) {\n          \n          \n            \n                            return;\n          \n          \n            \n                          }\n          \n          \n            \n                        }", "author": "keith-turner", "createdAt": "2020-02-28T21:05:41Z", "path": "core/src/main/java/org/apache/accumulo/core/file/rfile/PrintInfo.java", "diffHunk": "@@ -192,23 +268,43 @@ public void execute(final String[] args) throws Exception {\n           }\n         }\n \n+        Formatter formatter = null;\n+        if (opts.formatterClazz != null) {\n+          final Class<? extends Formatter> formatterClass = getFormater(opts.formatterClazz);\n+          FormatterConfig config = new FormatterConfig();\n+          config.setPrintTimestamps(true);\n+          formatter =\n+              FormatterFactory.getFormatter(formatterClass, new FormatterAdapter(dataIter), config);\n+        }\n+\n         for (String lgName : localityGroupCF.keySet()) {\n           LocalityGroupUtil.seek(dataIter, new Range(), lgName, localityGroupCF);\n-          while (dataIter.hasTop()) {\n-            Key key = dataIter.getTopKey();\n-            Value value = dataIter.getTopValue();\n-            if (opts.dump) {\n-              System.out.println(key + \" -> \" + value);\n-              if (System.out.checkError())\n+\n+          if (formatter != null) {\n+            while (formatter.hasNext()) {\n+              System.out.print(formatter.next());\n+              if (System.out.checkError()) {\n                 return;\n+              }\n             }", "originalCommit": "403dfe12dc2b953b06f909094c60cd536b79d3bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyMjI4Nw==", "url": "https://github.com/apache/accumulo/pull/1537#discussion_r385922287", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          if (opts.dump || opts.fullKeys) {\n          \n          \n            \n                            System.out\n          \n          \n            \n                                .println((opts.fullKeys ? key.toStringNoTruncate() : key) + \" -> \" + value);\n          \n          \n            \n                          if (formatter != null) {\n          \n          \n            \n                            System.out\n          \n          \n            \n                                .println(formatter.apply(key,value));", "author": "keith-turner", "createdAt": "2020-02-28T21:06:53Z", "path": "core/src/main/java/org/apache/accumulo/core/file/rfile/PrintInfo.java", "diffHunk": "@@ -192,23 +268,43 @@ public void execute(final String[] args) throws Exception {\n           }\n         }\n \n+        Formatter formatter = null;\n+        if (opts.formatterClazz != null) {\n+          final Class<? extends Formatter> formatterClass = getFormater(opts.formatterClazz);\n+          FormatterConfig config = new FormatterConfig();\n+          config.setPrintTimestamps(true);\n+          formatter =\n+              FormatterFactory.getFormatter(formatterClass, new FormatterAdapter(dataIter), config);\n+        }\n+\n         for (String lgName : localityGroupCF.keySet()) {\n           LocalityGroupUtil.seek(dataIter, new Range(), lgName, localityGroupCF);\n-          while (dataIter.hasTop()) {\n-            Key key = dataIter.getTopKey();\n-            Value value = dataIter.getTopValue();\n-            if (opts.dump) {\n-              System.out.println(key + \" -> \" + value);\n-              if (System.out.checkError())\n+\n+          if (formatter != null) {\n+            while (formatter.hasNext()) {\n+              System.out.print(formatter.next());\n+              if (System.out.checkError()) {\n                 return;\n+              }\n             }\n-            if (opts.histogram) {\n-              kvHistogram.add(key.getSize() + value.getSize());\n-            }\n-            if (opts.keyStats) {\n-              dataKeyStats.add(key);\n+          } else {\n+            while (dataIter.hasTop()) {\n+              Key key = dataIter.getTopKey();\n+              Value value = dataIter.getTopValue();\n+              if (opts.dump || opts.fullKeys) {\n+                System.out\n+                    .println((opts.fullKeys ? key.toStringNoTruncate() : key) + \" -> \" + value);", "originalCommit": "403dfe12dc2b953b06f909094c60cd536b79d3bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyMjU4Nw==", "url": "https://github.com/apache/accumulo/pull/1537#discussion_r385922587", "bodyText": "If using BiFunction, would not need this class.", "author": "keith-turner", "createdAt": "2020-02-28T21:07:45Z", "path": "core/src/main/java/org/apache/accumulo/core/file/rfile/PrintInfo.java", "diffHunk": "@@ -110,6 +126,53 @@ public void print(String indent) {\n     }\n   }\n \n+  static class FormatterAdapter implements Iterable<Entry<Key,Value>> {", "originalCommit": "403dfe12dc2b953b06f909094c60cd536b79d3bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyMjk3NQ==", "url": "https://github.com/apache/accumulo/pull/1537#discussion_r385922975", "bodyText": "This seems a bit dicey.  The underlying iterator is reset under the formatter for each locality group.  If formatter were stateful with hasNext() this may cause problems.", "author": "keith-turner", "createdAt": "2020-02-28T21:08:55Z", "path": "core/src/main/java/org/apache/accumulo/core/file/rfile/PrintInfo.java", "diffHunk": "@@ -192,23 +268,43 @@ public void execute(final String[] args) throws Exception {\n           }\n         }\n \n+        Formatter formatter = null;\n+        if (opts.formatterClazz != null) {\n+          final Class<? extends Formatter> formatterClass = getFormater(opts.formatterClazz);\n+          FormatterConfig config = new FormatterConfig();\n+          config.setPrintTimestamps(true);\n+          formatter =\n+              FormatterFactory.getFormatter(formatterClass, new FormatterAdapter(dataIter), config);\n+        }\n+\n         for (String lgName : localityGroupCF.keySet()) {\n           LocalityGroupUtil.seek(dataIter, new Range(), lgName, localityGroupCF);\n-          while (dataIter.hasTop()) {\n-            Key key = dataIter.getTopKey();\n-            Value value = dataIter.getTopValue();\n-            if (opts.dump) {\n-              System.out.println(key + \" -> \" + value);\n-              if (System.out.checkError())\n+\n+          if (formatter != null) {\n+            while (formatter.hasNext()) {", "originalCommit": "403dfe12dc2b953b06f909094c60cd536b79d3bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ2OTM5Mg==", "url": "https://github.com/apache/accumulo/pull/1537#discussion_r386469392", "bodyText": "Yeah, I wasn't too happy about this one either. I suspect one approach would be to create a new instance of the formatter for each locality group.", "author": "drewfarris", "createdAt": "2020-03-02T15:40:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkyMjk3NQ=="}], "type": "inlineReview"}, {"oid": "5b5976fd2ac14896fadaeb7bc1fbe359facf55fa", "url": "https://github.com/apache/accumulo/commit/5b5976fd2ac14896fadaeb7bc1fbe359facf55fa", "message": "Add PrintInfo options to dump full keys, apply formatter", "committedDate": "2020-03-06T22:22:41Z", "type": "commit"}, {"oid": "5b5976fd2ac14896fadaeb7bc1fbe359facf55fa", "url": "https://github.com/apache/accumulo/commit/5b5976fd2ac14896fadaeb7bc1fbe359facf55fa", "message": "Add PrintInfo options to dump full keys, apply formatter", "committedDate": "2020-03-06T22:22:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE4OTAxNA==", "url": "https://github.com/apache/accumulo/pull/1537#discussion_r389189014", "bodyText": "If you assign the unchecked code to a variable, you can add this suppression on just that assignment, so it doesn't mask other (fixable, avoidable) problems in the method.", "author": "ctubbsii", "createdAt": "2020-03-06T23:16:03Z", "path": "core/src/main/java/org/apache/accumulo/core/file/rfile/PrintInfo.java", "diffHunk": "@@ -138,6 +146,19 @@ public String description() {\n     return \"Prints rfile info\";\n   }\n \n+  @SuppressWarnings(\"unchecked\")", "originalCommit": "5b5976fd2ac14896fadaeb7bc1fbe359facf55fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE4OTI3OA==", "url": "https://github.com/apache/accumulo/pull/1537#discussion_r389189278", "bodyText": "If the user's command-line cannot be satisfied (probably a typo in their class name), we should probably hard-fail by letting this exception fall through, rather than returning null and by effetively wasting time dumping a file in a format the user doesn't want.", "author": "ctubbsii", "createdAt": "2020-03-06T23:17:13Z", "path": "core/src/main/java/org/apache/accumulo/core/file/rfile/PrintInfo.java", "diffHunk": "@@ -138,6 +146,19 @@ public String description() {\n     return \"Prints rfile info\";\n   }\n \n+  @SuppressWarnings(\"unchecked\")\n+  protected Class<? extends BiFunction<Key,Value,String>> getFormatter(String formatterClazz) {\n+    try {\n+      if (formatterClazz != null) {\n+        return (Class<? extends BiFunction<Key,Value,String>>) this.getClass().getClassLoader()\n+            .loadClass(formatterClazz).asSubclass(BiFunction.class);\n+      }\n+    } catch (ClassNotFoundException e) {\n+      System.err.println(\"Could not find formatter class: \" + formatterClazz);", "originalCommit": "5b5976fd2ac14896fadaeb7bc1fbe359facf55fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0ede311a3ea5b85a1952457c25d8b619be3b3a73", "url": "https://github.com/apache/accumulo/commit/0ede311a3ea5b85a1952457c25d8b619be3b3a73", "message": "Updates per code review", "committedDate": "2020-03-10T13:02:22Z", "type": "commit"}]}