{"pr_number": 1670, "pr_title": "#1631 - Tablet in memory compaction ID is updated before metadata write", "pr_createdAt": "2020-08-03T18:44:59Z", "pr_url": "https://github.com/apache/accumulo/pull/1670", "timeline": [{"oid": "f5bde3becd0ab3a68e0f7448d1d65598b2e1599e", "url": "https://github.com/apache/accumulo/commit/f5bde3becd0ab3a68e0f7448d1d65598b2e1599e", "message": "Fixing master", "committedDate": "2020-06-18T16:21:08Z", "type": "commit"}, {"oid": "20b5640c072a497fd0dee5f86a536fb8ea31281c", "url": "https://github.com/apache/accumulo/commit/20b5640c072a497fd0dee5f86a536fb8ea31281c", "message": "Merge branch 'master' of https://github.com/apache/accumulo", "committedDate": "2020-06-18T16:22:04Z", "type": "commit"}, {"oid": "eb98a46024716df3fff97d0c65f85e1e5e885f68", "url": "https://github.com/apache/accumulo/commit/eb98a46024716df3fff97d0c65f85e1e5e885f68", "message": "WIP Fixes #1473 - Added readTablets() to Ample.", "committedDate": "2020-07-07T12:02:07Z", "type": "commit"}, {"oid": "c8f527d493b4341327c4307966a843b1d46dbebc", "url": "https://github.com/apache/accumulo/commit/c8f527d493b4341327c4307966a843b1d46dbebc", "message": "Switch BulkImport back to original version", "committedDate": "2020-07-07T17:06:39Z", "type": "commit"}, {"oid": "732d1e5abc684e86259b20fbccaf6f2cbd0fb702", "url": "https://github.com/apache/accumulo/commit/732d1e5abc684e86259b20fbccaf6f2cbd0fb702", "message": "Fixes #1473 - Added test with mock table in AccumuloClientIT", "committedDate": "2020-07-10T13:35:12Z", "type": "commit"}, {"oid": "44767101ba328751800b96947d332da3584d1a4b", "url": "https://github.com/apache/accumulo/commit/44767101ba328751800b96947d332da3584d1a4b", "message": "Fixes #1473 - Added readTablets() function to Ample. Made TabletsMetadata Builder protected class.", "committedDate": "2020-07-20T12:50:38Z", "type": "commit"}, {"oid": "b7cebe4366ee4f3c0dc2493d192155ae4e90b872", "url": "https://github.com/apache/accumulo/commit/b7cebe4366ee4f3c0dc2493d192155ae4e90b872", "message": "Fixes #1631 - Surrounded MetadataTabe update call in try-catch. Sets flag that calls setLastCompactionID if Metadata update successful.", "committedDate": "2020-08-03T18:37:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg3NDM5OA==", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r492874398", "bodyText": "Should use primitive, rather than boxed form.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Boolean updateMetadataTabletFail = false;\n          \n          \n            \n                    boolean updateMetadataTabletFail = false;", "author": "ctubbsii", "createdAt": "2020-09-22T16:29:19Z", "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/CompactableUtils.java", "diffHunk": "@@ -441,10 +441,17 @@ private UserCompactionHelper(CompactionConfig compactionConfig, Tablet tablet,\n       }\n \n       if (selectedFiles.isEmpty()) {\n-        tablet.setLastCompactionID(compactionId);\n-\n-        MetadataTableUtil.updateTabletCompactID(tablet.getExtent(), compactionId,\n-            tablet.getTabletServer().getContext(), tablet.getTabletServer().getLock());\n+        Boolean updateMetadataTabletFail = false;", "originalCommit": "b7cebe4366ee4f3c0dc2493d192155ae4e90b872", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg4MDQxMw==", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r492880413", "bodyText": "This catches exceptions that were previously thrown. Is this a valid change in behavior? Why wouldn't it be sufficient to simply reorder these lines, and let the exception be thrown?", "author": "ctubbsii", "createdAt": "2020-09-22T16:38:33Z", "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/CompactableUtils.java", "diffHunk": "@@ -441,10 +441,17 @@ private UserCompactionHelper(CompactionConfig compactionConfig, Tablet tablet,\n       }\n \n       if (selectedFiles.isEmpty()) {\n-        tablet.setLastCompactionID(compactionId);\n-\n-        MetadataTableUtil.updateTabletCompactID(tablet.getExtent(), compactionId,\n-            tablet.getTabletServer().getContext(), tablet.getTabletServer().getLock());\n+        Boolean updateMetadataTabletFail = false;\n+        try {\n+          MetadataTableUtil.updateTabletCompactID(tablet.getExtent(), compactionId,\n+              tablet.getTabletServer().getContext(), tablet.getTabletServer().getLock());\n+        } catch (Exception exc) {\n+          updateMetadataTabletFail = true;\n+          log.error(exc.getMessage());\n+        }", "originalCommit": "b7cebe4366ee4f3c0dc2493d192155ae4e90b872", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYxNTUwOQ==", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r493615509", "bodyText": "I see what you mean. updateTabletCompactID does not throw any exception. I thought that this would guarantee no attempts to set the LastCompactionID if the Metadata table update failed. Thinking it over, simply reordering the method calls should work.", "author": "cradal", "createdAt": "2020-09-23T13:58:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjg4MDQxMw=="}], "type": "inlineReview"}, {"oid": "0d2eed962d3ba2e461ac1058246a93dbcc37e70b", "url": "https://github.com/apache/accumulo/commit/0d2eed962d3ba2e461ac1058246a93dbcc37e70b", "message": "Merge branch 'main' of https://github.com/apache/accumulo into accumulo-#1473", "committedDate": "2020-09-23T13:13:30Z", "type": "commit"}, {"oid": "a2537fdaabac678a63c0bdd9edcd0cee1d2d72f1", "url": "https://github.com/apache/accumulo/commit/a2537fdaabac678a63c0bdd9edcd0cee1d2d72f1", "message": "Update server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/CompactableUtils.java\n\nCo-authored-by: Christopher Tubbs <ctubbsii@apache.org>", "committedDate": "2020-09-23T13:29:44Z", "type": "commit"}, {"oid": "c83cb90a072a4d1a02ca3dc971e9e6c62305f853", "url": "https://github.com/apache/accumulo/commit/c83cb90a072a4d1a02ca3dc971e9e6c62305f853", "message": "Merge branch 'main' into accumulo-#1631", "committedDate": "2020-09-23T17:28:55Z", "type": "commit"}, {"oid": "9ec1c7a28c6d93176743806a8fbcc8287a6ad5a4", "url": "https://github.com/apache/accumulo/commit/9ec1c7a28c6d93176743806a8fbcc8287a6ad5a4", "message": "Merge branch 'main' into accumulo-#1631", "committedDate": "2020-09-24T18:04:10Z", "type": "commit"}, {"oid": "7a6a63251a2f55b3f3cbb31ecb75b0a27a3381ac", "url": "https://github.com/apache/accumulo/commit/7a6a63251a2f55b3f3cbb31ecb75b0a27a3381ac", "message": "Fixes #1631 - Removed try-catch from compaction IDcode. Removed code intended for another ticket.", "committedDate": "2020-09-24T20:21:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg2MjE3Mw==", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r496862173", "bodyText": "Is this needed?", "author": "ctubbsii", "createdAt": "2020-09-29T16:13:23Z", "path": "core/src/main/java/org/apache/accumulo/core/metadata/schema/TabletsMetadata.java", "diffHunk": "@@ -371,6 +371,10 @@ private TabletsMetadata(Scanner scanner, Iterable<TabletMetadata> tmi) {\n     this.tablets = tmi;\n   }\n \n+  public TabletsMetadata() {\n+\n+  }\n+", "originalCommit": "7a6a63251a2f55b3f3cbb31ecb75b0a27a3381ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f54d0bd05243c752b62be24f311170d95d218bfd", "url": "https://github.com/apache/accumulo/commit/f54d0bd05243c752b62be24f311170d95d218bfd", "message": "Fixes #1631 - Removed unused method stub", "committedDate": "2020-09-30T13:26:21Z", "type": "commit"}, {"oid": "ae295483eb1e8272eda77b381d4b169eb05070fd", "url": "https://github.com/apache/accumulo/commit/ae295483eb1e8272eda77b381d4b169eb05070fd", "message": "Moved tablet.setLastCompactionID to be called after id is set in metadata table.", "committedDate": "2020-10-09T16:56:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjYxNTc1Mw==", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r502615753", "bodyText": "I believe there is a related comment a few lines above that can probably be removed, about known consistency issue between minor and major compactions", "author": "ctubbsii", "createdAt": "2020-10-09T18:52:40Z", "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/DatafileManager.java", "diffHunk": "@@ -458,6 +457,7 @@ StoredTabletFile bringMajorCompactionOnline(Set<StoredTabletFile> oldDatafiles,\n         filesInUseByScans, newFile, compactionId, dfv,\n         tablet.getTabletServer().getClientAddressString(), lastLocation,\n         tablet.getTabletServer().getLock());\n+    tablet.setLastCompactionID(compactionId);", "originalCommit": "ae295483eb1e8272eda77b381d4b169eb05070fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM2MTM1MA==", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r503361350", "bodyText": "Actually that comment is still relevant.  The tablet's list of files are still being updated before the the metadata table update is made.  For minor compactions the tablets list of files is updated after the metadata update. The comment was referring to when the in memory list of files is updated.", "author": "keith-turner", "createdAt": "2020-10-12T15:10:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjYxNTc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYxNzY3MA==", "url": "https://github.com/apache/accumulo/pull/1670#discussion_r503617670", "bodyText": "Oh my mistake.", "author": "ctubbsii", "createdAt": "2020-10-13T01:32:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjYxNTc1Mw=="}], "type": "inlineReview"}, {"oid": "cc7ff8dcf33e092f3c21c2a7e114390e312d84cb", "url": "https://github.com/apache/accumulo/commit/cc7ff8dcf33e092f3c21c2a7e114390e312d84cb", "message": "Fixes #1631 - Removed unneeded comment from DataFileManager", "committedDate": "2020-10-09T19:41:25Z", "type": "commit"}, {"oid": "79e9c59c47d5b5aaa301bee6abb5c08a12ca6cd9", "url": "https://github.com/apache/accumulo/commit/79e9c59c47d5b5aaa301bee6abb5c08a12ca6cd9", "message": "Fixes #1631 - Added comment back into DatafileManager.", "committedDate": "2020-10-13T13:19:30Z", "type": "commit"}]}