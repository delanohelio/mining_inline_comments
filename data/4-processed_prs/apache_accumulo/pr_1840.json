{"pr_number": 1840, "pr_title": "Closes #1689: Don't catch Throwable (unless it's rethrown)", "pr_createdAt": "2020-12-17T18:44:02Z", "pr_url": "https://github.com/apache/accumulo/pull/1840", "timeline": [{"oid": "74303f2e7cebb0f00925a5e690f8d552393d743b", "url": "https://github.com/apache/accumulo/commit/74303f2e7cebb0f00925a5e690f8d552393d743b", "message": "Closes #1689: Don't catch Throwable (unless its rethrown)", "committedDate": "2020-12-17T18:40:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0NTczMw==", "url": "https://github.com/apache/accumulo/pull/1840#discussion_r545345733", "bodyText": "Is there value in adding this to the result if we're re-throwing?", "author": "ctubbsii", "createdAt": "2020-12-17T19:26:15Z", "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/scan/LookupTask.java", "diffHunk": "@@ -177,9 +177,13 @@ public void run() {\n       }\n     } catch (SampleNotPresentException e) {\n       addResult(e);\n-    } catch (Throwable e) {\n+    } catch (Exception e) {\n       log.warn(\"exception while doing multi-scan \", e);\n       addResult(e);\n+    } catch (Error t) {\n+      log.warn(\"Error while doing multi-scan \", t);\n+      addResult(t);", "originalCommit": "74303f2e7cebb0f00925a5e690f8d552393d743b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM2MTQ4NA==", "url": "https://github.com/apache/accumulo/pull/1840#discussion_r545361484", "bodyText": "I was following what the other catch clauses were doing here. I assume that the addResult() call is putting the exception on the result queue to be sent back to the client. It's possible that this error could make it's way back to the client before the tserver is halted.", "author": "dlmarion", "createdAt": "2020-12-17T19:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0NTczMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM4ODA4MA==", "url": "https://github.com/apache/accumulo/pull/1840#discussion_r545388080", "bodyText": "If there's an actual Error, we probably shouldn't leak those details to the client. The client will get a TApplicationException when the server fails. It's probably not worth creating new work before the Error falls through and is ultimately handled. We probably also don't need the log message, either, because the code that will eventually handle the Error should provide a useful message/stack trace, and this would be redundant. It's probably better to just let it fall through and not even try to catch-handle-rethrow.", "author": "ctubbsii", "createdAt": "2020-12-17T20:37:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0NTczMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM5MTg1MA==", "url": "https://github.com/apache/accumulo/pull/1840#discussion_r545391850", "bodyText": "I can remove this Error handling, I was just trying to follow the pattern.", "author": "dlmarion", "createdAt": "2020-12-17T20:44:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0NTczMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0NzkxNQ==", "url": "https://github.com/apache/accumulo/pull/1840#discussion_r545347915", "bodyText": "Should this be more specific, like RuntimeException?", "author": "ctubbsii", "createdAt": "2020-12-17T19:29:41Z", "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/scan/NextBatchTask.java", "diffHunk": "@@ -89,14 +88,16 @@ public void run() {\n       }\n     } catch (TooManyFilesException | SampleNotPresentException e) {\n       addResult(e);\n-    } catch (OutOfMemoryError ome) {\n-      Halt.halt(\"Ran out of memory scanning \" + scanSession.extent + \" for \" + scanSession.client,\n-          1);\n-      addResult(ome);\n-    } catch (Throwable e) {\n+    } catch (Exception e) {", "originalCommit": "74303f2e7cebb0f00925a5e690f8d552393d743b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM2MjcyNw==", "url": "https://github.com/apache/accumulo/pull/1840#discussion_r545362727", "bodyText": "I can do that.", "author": "dlmarion", "createdAt": "2020-12-17T19:53:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0NzkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0ODQwNQ==", "url": "https://github.com/apache/accumulo/pull/1840#discussion_r545348405", "bodyText": "The message here has changed and no longer has the scan session client included. Also, you should use slf4j substitution syntax to format the message.\nAre we sure we want to change the behavior to no longer Halt here? Is this change dependent on the one in #1818 to handle the shutdown?", "author": "ctubbsii", "createdAt": "2020-12-17T19:30:26Z", "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/scan/NextBatchTask.java", "diffHunk": "@@ -89,14 +88,16 @@ public void run() {\n       }\n     } catch (TooManyFilesException | SampleNotPresentException e) {\n       addResult(e);\n-    } catch (OutOfMemoryError ome) {\n-      Halt.halt(\"Ran out of memory scanning \" + scanSession.extent + \" for \" + scanSession.client,\n-          1);\n-      addResult(ome);\n-    } catch (Throwable e) {\n+    } catch (Exception e) {\n       log.warn(\"exception while scanning tablet \"\n           + (scanSession == null ? \"(unknown)\" : scanSession.extent), e);\n       addResult(e);\n+    } catch (Error t) {\n+      log.warn(\n+          \"Error while scanning tablet \" + (scanSession == null ? \"(unknown)\" : scanSession.extent),\n+          t);", "originalCommit": "74303f2e7cebb0f00925a5e690f8d552393d743b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM2NDI5OA==", "url": "https://github.com/apache/accumulo/pull/1840#discussion_r545364298", "bodyText": "The message here has changed and no longer has the scan session client included.\n\nI'm not sure what yo umean, this is an copy of the log message in the catch clause above it.\n\nAlso, you should use slf4j substitution syntax to format the message.\n\nI can do that\n\nIs this change dependent on the one in #1818 to handle the shutdown?\n\nYes, I mentioned that in the initial comment on the PR. These changes assume that #1818 gets merged.", "author": "dlmarion", "createdAt": "2020-12-17T19:56:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0ODQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM4OTM4Mw==", "url": "https://github.com/apache/accumulo/pull/1840#discussion_r545389383", "bodyText": "I'm not sure what yo umean, this is an copy of the log message in the catch clause above it.\n\nThe previous message from the Halt had \" for \" + scanSession.client, but this log message does not mention the scanSession.client at all.\n\nYes, I mentioned that in the initial comment on the PR. These changes assume that #1818 gets merged.\n\nThanks, I must've missed that.", "author": "ctubbsii", "createdAt": "2020-12-17T20:39:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0ODQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM5MjQ4NQ==", "url": "https://github.com/apache/accumulo/pull/1840#discussion_r545392485", "bodyText": "As the log message you are referencing is in an Error handler, I should remove it as well given your comments in LookupTask?", "author": "dlmarion", "createdAt": "2020-12-17T20:45:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0ODQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQwNTAxMw==", "url": "https://github.com/apache/accumulo/pull/1840#discussion_r545405013", "bodyText": "probably \ud83d\ude3a", "author": "ctubbsii", "createdAt": "2020-12-17T21:09:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0ODQwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0OTQzOQ==", "url": "https://github.com/apache/accumulo/pull/1840#discussion_r545349439", "bodyText": "This seems to be wrapping the exception with a RTE. Are there even checked exceptions that can occur here? If so, we probably should enumerate them explicitly, and only wrap checked exceptions, leaving RTEs unwrapped.", "author": "ctubbsii", "createdAt": "2020-12-17T19:32:10Z", "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/tablet/MinorCompactionTask.java", "diffHunk": "@@ -111,7 +111,7 @@ public void run() {\n       if (tablet.needsSplit()) {\n         tablet.getTabletServer().executeSplit(tablet);\n       }\n-    } catch (Throwable t) {\n+    } catch (Exception t) {", "originalCommit": "74303f2e7cebb0f00925a5e690f8d552393d743b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "76755fa4e1696d1cf76e25f592ed905eb2208086", "url": "https://github.com/apache/accumulo/commit/76755fa4e1696d1cf76e25f592ed905eb2208086", "message": "re #1689: addressing PR comments", "committedDate": "2020-12-17T20:08:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM5MTMxNg==", "url": "https://github.com/apache/accumulo/pull/1840#discussion_r545391316", "bodyText": "This is good because it preserves existing behavior with regard to RTEs, but I suspect that eventually, we'll want to reconsider whether we want RTEs to get sent back to the client, or if we would want them to fall through and trigger a TApplicationException (which is like an HTTP 500 error), so that we don't leak arbitrary exceptions back to the client.", "author": "ctubbsii", "createdAt": "2020-12-17T20:43:25Z", "path": "server/tserver/src/main/java/org/apache/accumulo/tserver/scan/NextBatchTask.java", "diffHunk": "@@ -89,14 +89,15 @@ public void run() {\n       }\n     } catch (TooManyFilesException | SampleNotPresentException e) {\n       addResult(e);\n-    } catch (OutOfMemoryError ome) {\n-      Halt.halt(\"Ran out of memory scanning \" + scanSession.extent + \" for \" + scanSession.client,\n-          1);\n-      addResult(ome);\n-    } catch (Throwable e) {\n-      log.warn(\"exception while scanning tablet \"\n-          + (scanSession == null ? \"(unknown)\" : scanSession.extent), e);\n+    } catch (IOException | RuntimeException e) {", "originalCommit": "76755fa4e1696d1cf76e25f592ed905eb2208086", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "024201a7a692ce291cbe4649b2a6ee4b497b8c1d", "url": "https://github.com/apache/accumulo/commit/024201a7a692ce291cbe4649b2a6ee4b497b8c1d", "message": "re #1689: Remove catch and re-throw of Error", "committedDate": "2020-12-17T20:57:41Z", "type": "commit"}, {"oid": "c6cb743fbe4273e0e9fb75e2b1290d051a417e01", "url": "https://github.com/apache/accumulo/commit/c6cb743fbe4273e0e9fb75e2b1290d051a417e01", "message": "Merge branch 'main' into 1689-dont-catch-throwable\n\nConflicts:\n\tserver/tserver/src/main/java/org/apache/accumulo/tserver/log/LogSorter.java", "committedDate": "2021-01-11T14:07:21Z", "type": "commit"}, {"oid": "2a8ab15438b39b91da306ec23a9207fc04517b94", "url": "https://github.com/apache/accumulo/commit/2a8ab15438b39b91da306ec23a9207fc04517b94", "message": "re #1689: fix possible null pointer dereference error in SpotBugs", "committedDate": "2021-01-11T14:39:25Z", "type": "commit"}, {"oid": "83c8c17f543fe74ceb914bf17751d4a009b0ea24", "url": "https://github.com/apache/accumulo/commit/83c8c17f543fe74ceb914bf17751d4a009b0ea24", "message": "Merge branch 'main' into 1689-dont-catch-throwable\n\nConflicts:\n\tcore/src/main/java/org/apache/accumulo/core/clientImpl/TabletServerBatchWriter.java\n\tserver/tserver/src/main/java/org/apache/accumulo/tserver/TabletServerResourceManager.java\n\tserver/tserver/src/main/java/org/apache/accumulo/tserver/scan/NextBatchTask.java", "committedDate": "2021-01-19T12:44:06Z", "type": "commit"}]}