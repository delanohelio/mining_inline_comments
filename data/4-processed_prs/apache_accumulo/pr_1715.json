{"pr_number": 1715, "pr_title": "Deprecation of VFS Class Loader items, new Context class loader management", "pr_createdAt": "2020-09-25T21:13:32Z", "pr_url": "https://github.com/apache/accumulo/pull/1715", "timeline": [{"oid": "2345f07c4f6c16f05ad30a2d37b1324850d70ab7", "url": "https://github.com/apache/accumulo/commit/2345f07c4f6c16f05ad30a2d37b1324850d70ab7", "message": "Adding new ReloadingVFSClassLoader, ContextClassLoaderFactory for managing context classloaders", "committedDate": "2020-09-11T18:08:53Z", "type": "commit"}, {"oid": "ed31a83e8a6e1ccfa75b003afaf1a54bea0a54a1", "url": "https://github.com/apache/accumulo/commit/ed31a83e8a6e1ccfa75b003afaf1a54bea0a54a1", "message": "Resolve failures from maven build plugins", "committedDate": "2020-09-11T18:52:38Z", "type": "commit"}, {"oid": "5f1e6c004f1f823b6fa2aea93d899fa79c12b0f5", "url": "https://github.com/apache/accumulo/commit/5f1e6c004f1f823b6fa2aea93d899fa79c12b0f5", "message": "Added / updated Deprecation annotations", "committedDate": "2020-09-11T19:06:42Z", "type": "commit"}, {"oid": "f32cebb0da7267d1dab072d0c9391afcf766dd07", "url": "https://github.com/apache/accumulo/commit/f32cebb0da7267d1dab072d0c9391afcf766dd07", "message": "Merge branch 'main' into add-new-vfs-classloader-impl", "committedDate": "2020-09-11T19:12:57Z", "type": "commit"}, {"oid": "9e3dec252fa6b16280a35ae3761febfa8fed0863", "url": "https://github.com/apache/accumulo/commit/9e3dec252fa6b16280a35ae3761febfa8fed0863", "message": "Merge branch 'main' into add-new-vfs-classloader-impl", "committedDate": "2020-09-21T13:05:36Z", "type": "commit"}, {"oid": "a65a9b6a2eabd470d294232b06ea95c0d81ab31c", "url": "https://github.com/apache/accumulo/commit/a65a9b6a2eabd470d294232b06ea95c0d81ab31c", "message": "Moved new classloader to its own repo", "committedDate": "2020-09-21T13:53:32Z", "type": "commit"}, {"oid": "41d82b0d0339177165fcf17299d34ef03d2fdbf3", "url": "https://github.com/apache/accumulo/commit/41d82b0d0339177165fcf17299d34ef03d2fdbf3", "message": "Throw runtime exception instead of returning null when classloader does not exist for contextName", "committedDate": "2020-09-21T14:34:32Z", "type": "commit"}, {"oid": "a3c6d5dacfcb64d6cc62c3c150e4b26a0717e75d", "url": "https://github.com/apache/accumulo/commit/a3c6d5dacfcb64d6cc62c3c150e4b26a0717e75d", "message": "Code formatting changes", "committedDate": "2020-09-21T14:54:56Z", "type": "commit"}, {"oid": "ecc30ad56a66431c544b093d457ce31ed89e6ef4", "url": "https://github.com/apache/accumulo/commit/ecc30ad56a66431c544b093d457ce31ed89e6ef4", "message": "javadoc issues", "committedDate": "2020-09-21T15:18:58Z", "type": "commit"}, {"oid": "d623ecfd3bc80ee8ed8fc47503ba7074e2adfa13", "url": "https://github.com/apache/accumulo/commit/d623ecfd3bc80ee8ed8fc47503ba7074e2adfa13", "message": "Update contexts immediately", "committedDate": "2020-09-21T15:54:45Z", "type": "commit"}, {"oid": "83271cef563fc5a79f7ba835d59ba6b9556f15fd", "url": "https://github.com/apache/accumulo/commit/83271cef563fc5a79f7ba835d59ba6b9556f15fd", "message": "Remove the updateContexts method, this was a leftover from a previous design", "committedDate": "2020-09-21T17:22:29Z", "type": "commit"}, {"oid": "364ebd4a9a6c5bf8bf32d8b4c69748e29c300482", "url": "https://github.com/apache/accumulo/commit/364ebd4a9a6c5bf8bf32d8b4c69748e29c300482", "message": "Fix for configuration properties only being read once", "committedDate": "2020-09-21T19:30:56Z", "type": "commit"}, {"oid": "180bb4d4ab8a2aa2b05d6fb15ff4bf0c2f32c0eb", "url": "https://github.com/apache/accumulo/commit/180bb4d4ab8a2aa2b05d6fb15ff4bf0c2f32c0eb", "message": "Removed duplicate property", "committedDate": "2020-09-22T13:28:40Z", "type": "commit"}, {"oid": "77f0edf78ddc8985c0edb60573d66cbeded9e8d5", "url": "https://github.com/apache/accumulo/commit/77f0edf78ddc8985c0edb60573d66cbeded9e8d5", "message": "Merge branch 'main' into add-new-vfs-classloader-impl", "committedDate": "2020-09-25T12:57:06Z", "type": "commit"}, {"oid": "304a8f167aba40f8c421421ae8719fdbe732d732", "url": "https://github.com/apache/accumulo/commit/304a8f167aba40f8c421421ae8719fdbe732d732", "message": "Updates from testing locally", "committedDate": "2020-09-25T20:14:25Z", "type": "commit"}, {"oid": "725913089dc8552d657d2a7a2776ec44119b3c3a", "url": "https://github.com/apache/accumulo/commit/725913089dc8552d657d2a7a2776ec44119b3c3a", "message": "Merge branch 'main' into add-new-vfs-classloader-impl", "committedDate": "2020-10-05T12:36:56Z", "type": "commit"}, {"oid": "78c72ca433f82f7f64a3490ce3b34ed4fac405ae", "url": "https://github.com/apache/accumulo/commit/78c72ca433f82f7f64a3490ce3b34ed4fac405ae", "message": "Made non-context classloader pluggable as `java.system.class.loader` does not allow for reloading.", "committedDate": "2020-10-06T18:43:44Z", "type": "commit"}, {"oid": "ef0715ba2f9a649a2b30a230989a8f27e7a52b8f", "url": "https://github.com/apache/accumulo/commit/ef0715ba2f9a649a2b30a230989a8f27e7a52b8f", "message": "Backed out change to make system class loader pluggable.", "committedDate": "2020-10-07T17:35:21Z", "type": "commit"}, {"oid": "6c379e338ce19369db0c0846fc66dd4e63b082c5", "url": "https://github.com/apache/accumulo/commit/6c379e338ce19369db0c0846fc66dd4e63b082c5", "message": "Changes from testing", "committedDate": "2020-10-07T20:21:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkzMjY4MQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r501932681", "bodyText": "It may be nice to have an accumulo prefix in this property, since its a java system property and not an Accumulo configuration property.  Maybe something like accumulo.server.class.loader.factory.  This would be similar to the way log4j prefixes its Java system properties.", "author": "keith-turner", "createdAt": "2020-10-08T18:35:55Z", "path": "core/src/main/java/org/apache/accumulo/core/classloader/AccumuloClassLoader.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import java.lang.reflect.InvocationTargetException;\n+\n+import org.apache.accumulo.core.spi.common.ClassLoaderFactory;\n+import org.apache.accumulo.core.spi.common.ClassLoaderFactory.Printer;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class AccumuloClassLoader {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(AccumuloClassLoader.class);\n+\n+  private static final String CLASS_LOADER_FACTORY = \"general.class.loader.factory\";", "originalCommit": "78c72ca433f82f7f64a3490ce3b34ed4fac405ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkzNDQ5MA==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r501934490", "bodyText": "This javadoc could mention its a Java system property.", "author": "keith-turner", "createdAt": "2020-10-08T18:39:02Z", "path": "core/src/main/java/org/apache/accumulo/core/spi/common/ClassLoaderFactory.java", "diffHunk": "@@ -18,44 +18,33 @@\n  */\n package org.apache.accumulo.core.spi.common;\n \n-import java.util.Collections;\n-import java.util.Iterator;\n-import java.util.Map.Entry;\n-\n /**\n- * The ClassLoaderFactory is defined by the property general.context.factory. The factory\n- * implementation is configured externally to Accumulo and will return a ClassLoader for a given\n- * contextName.\n- *\n+ * The ClassLoaderFactory implementation is defined by the property general.class.loader.factory.", "originalCommit": "78c72ca433f82f7f64a3490ce3b34ed4fac405ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkzNTMyMg==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r501935322", "bodyText": "Why is this commented out code here?", "author": "keith-turner", "createdAt": "2020-10-08T18:40:30Z", "path": "start/src/main/java/org/apache/accumulo/start/Main.java", "diffHunk": "@@ -86,42 +63,42 @@ public static void main(final String[] args) {\n       // determine whether a keyword was used or a class name, and execute it with the remaining\n       // args\n       String keywordOrClassName = args[0];\n-      KeywordExecutable keywordExec = getExecutables(loader).get(keywordOrClassName);\n+      KeywordExecutable keywordExec = getExecutables(CLASSLOADER).get(keywordOrClassName);\n       if (keywordExec != null) {\n         execKeyword(keywordExec, stripArgs(args, 1));\n       } else {\n         execMainClassName(keywordOrClassName, stripArgs(args, 1));\n       }\n \n     } catch (Throwable t) {\n-      log.error(\"Uncaught exception\", t);\n+      LOG.error(\"Uncaught exception\", t);\n       System.exit(1);\n     }\n   }\n \n-  public static synchronized ClassLoader getClassLoader() {\n-    if (classLoader == null) {\n-      try {\n-        classLoader = (ClassLoader) getVFSClassLoader().getMethod(\"getClassLoader\").invoke(null);\n-        Thread.currentThread().setContextClassLoader(classLoader);\n-      } catch (IOException | IllegalArgumentException | ReflectiveOperationException\n-          | SecurityException e) {\n-        log.error(\"Problem initializing the class loader\", e);\n-        System.exit(1);\n-      }\n-    }\n-    return classLoader;\n-  }\n-\n-  public static synchronized Class<?> getVFSClassLoader()\n-      throws IOException, ClassNotFoundException {\n-    if (vfsClassLoader == null) {\n-      Thread.currentThread().setContextClassLoader(AccumuloClassLoader.getClassLoader());\n-      vfsClassLoader = AccumuloClassLoader.getClassLoader()\n-          .loadClass(\"org.apache.accumulo.start.classloader.vfs.AccumuloVFSClassLoader\");\n-    }\n-    return vfsClassLoader;\n-  }\n+  // public static synchronized ClassLoader getClassLoader() {", "originalCommit": "78c72ca433f82f7f64a3490ce3b34ed4fac405ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkzNjAwOQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r501936009", "bodyText": "Javadoc needs a since tag", "author": "keith-turner", "createdAt": "2020-10-08T18:41:41Z", "path": "core/src/main/java/org/apache/accumulo/core/spi/common/ContextClassLoaderFactory.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.spi.common;\n+\n+import java.util.Collections;\n+import java.util.Iterator;\n+import java.util.Map.Entry;\n+\n+/**\n+ * The ContextClassLoaderFactory implementation is defined by the property\n+ * general.context.class.loader.factory. The implementation is configured externally to Accumulo and\n+ * will return a ClassLoader for a given contextName.", "originalCommit": "78c72ca433f82f7f64a3490ce3b34ed4fac405ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkzNjcxMw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r501936713", "bodyText": "I suspect this needs javadoc w/ since tag.  I don't think Inner classes inherit since tags from outer classes javadoc, but not 100% sure.", "author": "keith-turner", "createdAt": "2020-10-08T18:42:57Z", "path": "core/src/main/java/org/apache/accumulo/core/spi/common/ContextClassLoaderFactory.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.spi.common;\n+\n+import java.util.Collections;\n+import java.util.Iterator;\n+import java.util.Map.Entry;\n+\n+/**\n+ * The ContextClassLoaderFactory implementation is defined by the property\n+ * general.context.class.loader.factory. The implementation is configured externally to Accumulo and\n+ * will return a ClassLoader for a given contextName.\n+ */\n+public interface ContextClassLoaderFactory {\n+\n+  static class ClassLoaderFactoryConfiguration {", "originalCommit": "78c72ca433f82f7f64a3490ce3b34ed4fac405ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAwNzMzMA==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r502007330", "bodyText": "They shouldn't inherit from the outer class, but it's also package-private, so it shouldn't matter.", "author": "ctubbsii", "createdAt": "2020-10-08T20:56:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkzNjcxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyMjc0OA==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r502022748", "bodyText": "I think all members of interfaces are implicitly public.", "author": "keith-turner", "createdAt": "2020-10-08T21:28:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkzNjcxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUxMzY0OA==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518513648", "bodyText": "I think all members of interfaces are implicitly public.\n\nInteresting. I hadn't considered if that might be true for classes defined in an interface. I know it applies to methods and fields. A quick Google search didn't help answer this for me, so I'll have to experiment to see if that holds for static inner classes.", "author": "ctubbsii", "createdAt": "2020-11-06T04:14:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkzNjcxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkzOTMyOQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r501939329", "bodyText": "For SPI methods that take multiple arguments other SPI interfaces use Parameters interfaces.  This makes it easy to add more parameters to the method in the future w/o causing issues for existing implementers.  Below is one example of this.\n\n  \n    \n      accumulo/core/src/main/java/org/apache/accumulo/core/spi/scan/ScanDispatcher.java\n    \n    \n         Line 62\n      in\n      80ee9ca\n    \n    \n    \n    \n\n        \n          \n           default void init(InitParameters params) {", "author": "keith-turner", "createdAt": "2020-10-08T18:47:37Z", "path": "core/src/main/java/org/apache/accumulo/core/spi/common/ClassLoaderFactory.java", "diffHunk": "@@ -18,44 +18,33 @@\n  */\n package org.apache.accumulo.core.spi.common;\n \n-import java.util.Collections;\n-import java.util.Iterator;\n-import java.util.Map.Entry;\n-\n /**\n- * The ClassLoaderFactory is defined by the property general.context.factory. The factory\n- * implementation is configured externally to Accumulo and will return a ClassLoader for a given\n- * contextName.\n- *\n+ * The ClassLoaderFactory implementation is defined by the property general.class.loader.factory.\n+ * The implementation will return a ClassLoader to be used for dynamically loading classes.\n  */\n public interface ClassLoaderFactory {\n \n-  static class ClassLoaderFactoryConfiguration {\n-\n-    public Iterator<Entry<String,String>> get() {\n-      return Collections.emptyIterator();\n-    }\n+  public interface Printer {\n+    void print(String s);\n   }\n \n   /**\n-   * Initialize the ClassLoaderFactory. Implementations may need a reference to the configuration so\n-   * that it can clean up contexts that are no longer being used.\n+   * Return the configured classloader\n    *\n-   * @param conf\n-   *          Accumulo configuration properties\n-   * @throws Exception\n-   *           if error initializing ClassLoaderFactory\n+   * @return classloader the configured classloader\n    */\n-  void initialize(ClassLoaderFactoryConfiguration conf) throws Exception;\n+  ClassLoader getClassLoader() throws Exception;\n \n   /**\n+   * Print the classpath to the Printer\n    *\n-   * @param contextName\n-   *          name of classloader context\n-   * @return classloader configured for the context\n-   * @throws IllegalArgumentException\n-   *           if contextName is not supported\n+   * @param cl\n+   *          classloader\n+   * @param out\n+   *          printer\n+   * @param debug\n+   *          enable debug output\n    */\n-  ClassLoader getClassLoader(String contextName) throws IllegalArgumentException;\n+  void printClassPath(ClassLoader cl, Printer out, boolean debug);", "originalCommit": "78c72ca433f82f7f64a3490ce3b34ed4fac405ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk0NDA0MA==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r501944040", "bodyText": "In the past when running test against Accumulo w/ lots of concurrent scans and profiling tablets servers, the static synchronization around class loading was something that showed up in profiling data.  Every scan uses class loaders to create iterators and this static synch causes locking contention between scans.   This in an existing problem with the current code and I don't think changes are needed here, seeing this reminded me of the problem.  I need to see if I opened an issue for this.", "author": "keith-turner", "createdAt": "2020-10-08T18:55:51Z", "path": "core/src/main/java/org/apache/accumulo/core/classloader/ClassLoaderUtil.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+public class ClassLoaderUtil {\n+\n+  public static synchronized <U> Class<? extends U> loadClass(String contextName, String className,", "originalCommit": "78c72ca433f82f7f64a3490ce3b34ed4fac405ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk4NDIxNQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r501984215", "bodyText": "Now that you bring it up, I'm not sure that this needs to be synchronized.", "author": "dlmarion", "createdAt": "2020-10-08T20:10:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk0NDA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyOTk3Mg==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r502029972", "bodyText": "Looking into this overall issue a bit further in the existing code, iterators call AccumuloVFSClassLoader.loadClass() which is static and synchronized.  Also the iterator loading code has a class cache, maybe this was created to avoid the global synchronization.  Also I did not find an issue, will open one after looking into it a bit more.", "author": "keith-turner", "createdAt": "2020-10-08T21:44:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk0NDA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzMTQ1MQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r502031451", "bodyText": "The cache is only narrowly used, so the synchronization is probably still problematic I'll open an issue.", "author": "keith-turner", "createdAt": "2020-10-08T21:47:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk0NDA0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzNDM4OA==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r502034388", "bodyText": "Created #1730", "author": "keith-turner", "createdAt": "2020-10-08T21:54:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk0NDA0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk0NTcwMQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r501945701", "bodyText": "Could name the class InitializationParameters to be consistent w/ other SPI interfaces.", "author": "keith-turner", "createdAt": "2020-10-08T18:58:28Z", "path": "core/src/main/java/org/apache/accumulo/core/spi/common/ContextClassLoaderFactory.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.spi.common;\n+\n+import java.util.Collections;\n+import java.util.Iterator;\n+import java.util.Map.Entry;\n+\n+/**\n+ * The ContextClassLoaderFactory implementation is defined by the property\n+ * general.context.class.loader.factory. The implementation is configured externally to Accumulo and\n+ * will return a ClassLoader for a given contextName.\n+ */\n+public interface ContextClassLoaderFactory {\n+\n+  static class ClassLoaderFactoryConfiguration {\n+\n+    public Iterator<Entry<String,String>> get() {\n+      return Collections.emptyIterator();\n+    }\n+  }\n+\n+  /**\n+   * Initialize the ClassLoaderFactory. Implementations may need a reference to the configuration so\n+   * that it can clean up contexts that are no longer being used.\n+   *\n+   * @param conf\n+   *          Accumulo configuration properties\n+   * @throws Exception\n+   *           if error initializing ClassLoaderFactory\n+   */\n+  void initialize(ClassLoaderFactoryConfiguration conf) throws Exception;", "originalCommit": "78c72ca433f82f7f64a3490ce3b34ed4fac405ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTk0OTc5Nw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r501949797", "bodyText": "Other SPI interfaces use ServiceEnvironment to expose Accumulo configuration to plugins.\n\n  \n    \n      accumulo/core/src/main/java/org/apache/accumulo/core/spi/common/ServiceEnvironment.java\n    \n    \n         Line 35\n      in\n      80ee9ca\n    \n    \n    \n    \n\n        \n          \n           public interface ServiceEnvironment extends PluginEnvironment {", "author": "keith-turner", "createdAt": "2020-10-08T19:05:47Z", "path": "core/src/main/java/org/apache/accumulo/core/spi/common/ContextClassLoaderFactory.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.spi.common;\n+\n+import java.util.Collections;\n+import java.util.Iterator;\n+import java.util.Map.Entry;\n+\n+/**\n+ * The ContextClassLoaderFactory implementation is defined by the property\n+ * general.context.class.loader.factory. The implementation is configured externally to Accumulo and\n+ * will return a ClassLoader for a given contextName.\n+ */\n+public interface ContextClassLoaderFactory {\n+\n+  static class ClassLoaderFactoryConfiguration {\n+\n+    public Iterator<Entry<String,String>> get() {", "originalCommit": "78c72ca433f82f7f64a3490ce3b34ed4fac405ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "477efaa21916f0c5cd0816882af1d0e22161200b", "url": "https://github.com/apache/accumulo/commit/477efaa21916f0c5cd0816882af1d0e22161200b", "message": "Capturing working state", "committedDate": "2020-10-08T19:48:23Z", "type": "commit"}, {"oid": "2e435155afe8e2c23c3286294046dc38b4acbc81", "url": "https://github.com/apache/accumulo/commit/2e435155afe8e2c23c3286294046dc38b4acbc81", "message": "Merge branch 'main' into add-new-vfs-classloader-impl", "committedDate": "2020-10-19T12:26:25Z", "type": "commit"}, {"oid": "44b763afed568d58778bb455627b8216a743818e", "url": "https://github.com/apache/accumulo/commit/44b763afed568d58778bb455627b8216a743818e", "message": "latest changes from testing", "committedDate": "2020-10-20T16:21:04Z", "type": "commit"}, {"oid": "b10e6706977fd707bce78a1e50bdc528d6871b6a", "url": "https://github.com/apache/accumulo/commit/b10e6706977fd707bce78a1e50bdc528d6871b6a", "message": "Merge branch 'main' into add-new-vfs-classloader-impl\n\nConflicts:\n\tserver/manager/src/main/java/org/apache/accumulo/master/Master.java", "committedDate": "2020-10-21T13:42:30Z", "type": "commit"}, {"oid": "e0e9cbbc83a9bd5699d2a6bb782c93a2ef66e95b", "url": "https://github.com/apache/accumulo/commit/e0e9cbbc83a9bd5699d2a6bb782c93a2ef66e95b", "message": "remove unused imports", "committedDate": "2020-10-22T13:25:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE3NjIyMA==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r511176220", "bodyText": "The following are the rational behind the suggestion below.\n\nUsing a parameters interface makes evolving the SPI over time much simpler.  Its easy to add additional parameters in the future w/o breaking existing code that was written against the SPI.\nUsing the Configuration interface used by other SPI interface is consistent and offers more options.  For example this interface offers an isSet() method that allows checking if a user set a property.  There is no way to do this by analyzing the values because some props have default values.\n\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /**\n          \n          \n            \n               * Initialize the ClassLoaderFactory. Implementations may need a reference to the configuration so\n          \n          \n            \n               * that it can clean up contexts that are no longer being used.\n          \n          \n            \n               *\n          \n          \n            \n               * @param contextProperties\n          \n          \n            \n               *          Accumulo configuration properties\n          \n          \n            \n               * @throws Exception\n          \n          \n            \n               *           if error initializing ClassLoaderFactory\n          \n          \n            \n               */\n          \n          \n            \n              void initialize(Supplier<Map<String,String>> contextProperties) throws Exception;\n          \n          \n            \n              public interface InitParameters {\n          \n          \n            \n                  /**\n          \n          \n            \n               * @return A view of Accumulo's system level configuration. This is backed by system level config\n          \n          \n            \n               *         in zookeeper, which falls back to site configuration, which falls back to the default\n          \n          \n            \n               *         configuration.\n          \n          \n            \n               */\n          \n          \n            \n                Configuration getConfiguration();\n          \n          \n            \n              }\n          \n          \n            \n            \n          \n          \n            \n              /**\n          \n          \n            \n               * Initialize the ClassLoaderFactory. Implementations may need a reference to the configuration so\n          \n          \n            \n               * that it can clean up contexts that are no longer being used.\n          \n          \n            \n               *\n          \n          \n            \n               * @throws Exception\n          \n          \n            \n               *           if error initializing ClassLoaderFactory\n          \n          \n            \n               */\n          \n          \n            \n              void initialize(InitParameters initParam) throws Exception;", "author": "keith-turner", "createdAt": "2020-10-23T22:07:43Z", "path": "core/src/main/java/org/apache/accumulo/core/spi/common/ContextClassLoaderFactory.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.spi.common;\n+\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+/**\n+ * The ClassLoaderFactory is defined by the property general.context.factory. The factory\n+ * implementation is configured externally to Accumulo and will return a ClassLoader for a given\n+ * contextName.\n+ *\n+ * @since 2.1.0\n+ *\n+ */\n+public interface ContextClassLoaderFactory {\n+\n+  /**\n+   * Initialize the ClassLoaderFactory. Implementations may need a reference to the configuration so\n+   * that it can clean up contexts that are no longer being used.\n+   *\n+   * @param contextProperties\n+   *          Accumulo configuration properties\n+   * @throws Exception\n+   *           if error initializing ClassLoaderFactory\n+   */\n+  void initialize(Supplier<Map<String,String>> contextProperties) throws Exception;", "originalCommit": "e0e9cbbc83a9bd5699d2a6bb782c93a2ef66e95b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ1MDE0OQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517450149", "bodyText": "@keith-turner It looks like ServiceEnvironmentImpl and ConfigurationImpl are the classes used to create the Configuration used in this manner. Both of these objects are in server-base, which depends on accumulo-core. Suggestions on how to move forward? I think ContextClassLoaderFactory should remain in core as that is where the SPI classes are. It looks like I might be able to move ServiceEnvironmentImpl up to accumulo-core.", "author": "dlmarion", "createdAt": "2020-11-04T15:59:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE3NjIyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ2Mjc4OA==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517462788", "bodyText": "I can't move ServiceEnvironmentImpl up to accumulo-core due to its depedency on ServerContext.", "author": "dlmarion", "createdAt": "2020-11-04T16:16:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE3NjIyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ2ODM3NQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518468375", "bodyText": "I think what you did with moving ConfigurationImpl and using the ConfigurationImpl is good.  Would still recommend the parameters interface as it gives more options for mutating the SPI in the future w/o causing pain to anyone who has taken the time to implement the interface.", "author": "keith-turner", "createdAt": "2020-11-06T01:22:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE3NjIyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUxMTgxNw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518511817", "bodyText": "Would still recommend the parameters interface as it gives more options for mutating the SPI in the future w/o causing pain to anyone who has taken the time to implement the interface.\n\nI think I would disagree with the need to create an evolve-able parameter type here. I don't think it's a good idea to support a dedicated parameter type because that implies we're constructing a framework that can evolve, on which complex subclass implementations can support being initialized based on internal Accumulo objects. That's antithetical to what we're trying to do here.\nThis ClassloaderFactory is not your typical SPI (like sampling or iterators or balancers), where behavior is coupled to Accumulo functionality. Rather, classloading is something that should be done largely independently of Accumulo... as it is something on which other parts of Accumulo depend. Its initialization API should not itself depend on Accumulo objects that would be passed in using these parameter types, because that could create cyclical dependencies (Accumulo depends on classloader, which depends on Accumulo internal objects passed as parameters, which depends on classloader...).\nThe only thing this interface needs from Accumulo is initial configuration, which just happens to be carried in Accumulo's own configuration files. We should merely pass that information along to this. We should never pass along any other internal state objects as parameters. Besides, the classloader factory should be instantiated early, before any meaningful state is generated in Accumulo. So, it should never have the opportunity to initialize based on internal Accumulo state anyway... just initial configuration files.\nSo, I think it's a conscious decision to make the initialization parameter only a configuration mapping. It will ensure we keep the classloading stuff as decoupled as possible from Accumulo's internal workings, and merely responsible for providing classloaders that the rest of Accumulo can reliably depend on, based on the implementer's own independent criteria.", "author": "ctubbsii", "createdAt": "2020-11-06T04:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE3NjIyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUxMjgzMQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518512831", "bodyText": "Actually, because classloading can get messy, I've debated arguing in favor of removing this initialize method entirely, and just expecting implementations rely on their own way of getting configuration (their own config files, or environment parsing), so it's even more decoupled from Accumulo. But... that would make our own provided implementations that are currently built-in (for preserving existing behavior) more difficult, because they wouldn't be able to read general.classpaths, etc.", "author": "ctubbsii", "createdAt": "2020-11-06T04:10:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE3NjIyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA1OTExNQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r519059115", "bodyText": "The concept that we know everything we may ever want to pass into a method is not something that has worked out too well in the past for the Accumulo API and its riddled with many duplicative overloaded methods as a result.   The parameter interface is an attempt to avoid repeating a mistake that has been made many times in the past.\nI don't think there is a 0% chance that another parameter will ever be needed.  While valid use case likely exists, we may or may not encounter them.  I have no idea what the chances are, so I am ok w/ someone making the judgement call that its not worth worrying about.  Personally I would worry about it simply based on past experience w/ API evolution.", "author": "keith-turner", "createdAt": "2020-11-06T23:49:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE3NjIyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIyNjI5Nw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r525226297", "bodyText": "It wasn't so much that I think \"we know everything we may ever want to pass\", so much as it was \"I want to restrict what we can pass, to avoid scope creep\". I don't feel too strongly about this and am okay with Keith's API strategy here.", "author": "ctubbsii", "createdAt": "2020-11-17T15:05:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE3NjIyMA=="}], "type": "inlineReview"}, {"oid": "1088247aebd207abbe4fb8d92c6cf6a6430fe0b6", "url": "https://github.com/apache/accumulo/commit/1088247aebd207abbe4fb8d92c6cf6a6430fe0b6", "message": "Merge branch 'main' into add-new-vfs-classloader-impl\n\nConflicts:\n\tserver/manager/src/main/java/org/apache/accumulo/master/Master.java", "committedDate": "2020-11-04T16:47:15Z", "type": "commit"}, {"oid": "185781592df4c899d6e67a50da824986a5729c2a", "url": "https://github.com/apache/accumulo/commit/185781592df4c899d6e67a50da824986a5729c2a", "message": "re #1747 moved ConfigurationImpl from server-base to core to use in ContextClassLoaderFactory", "committedDate": "2020-11-04T18:41:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUzMzA0Nw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517533047", "bodyText": "Since initialize isn't synchronized, do we want to do something here to prevent this from being changed (by a competing thread) once set?", "author": "ctubbsii", "createdAt": "2020-11-04T18:03:35Z", "path": "core/src/main/java/org/apache/accumulo/core/classloader/ContextClassLoaders.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import org.apache.accumulo.core.conf.Property;\n+import org.apache.accumulo.core.spi.common.ContextClassLoaderFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ContextClassLoaders {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(ContextClassLoaders.class);\n+\n+  public static final String CONTEXT_CLASS_LOADER_FACTORY = \"general.context.class.loader.factory\";\n+\n+  private static ContextClassLoaderFactory FACTORY;", "originalCommit": "1088247aebd207abbe4fb8d92c6cf6a6430fe0b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgxMjE3Ng==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518812176", "bodyText": "I can synchronize the method with no penalty as it's only called once per server process.", "author": "dlmarion", "createdAt": "2020-11-06T15:09:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUzMzA0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUzMzMzNQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517533335", "bodyText": "Can we move this warnings suppression closer to the objects that it applies to, if we must have it?", "author": "ctubbsii", "createdAt": "2020-11-04T18:04:07Z", "path": "core/src/main/java/org/apache/accumulo/core/classloader/ContextClassLoaders.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import org.apache.accumulo.core.conf.Property;\n+import org.apache.accumulo.core.spi.common.ContextClassLoaderFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ContextClassLoaders {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(ContextClassLoaders.class);\n+\n+  public static final String CONTEXT_CLASS_LOADER_FACTORY = \"general.context.class.loader.factory\";\n+\n+  private static ContextClassLoaderFactory FACTORY;\n+  private static Supplier<Map<String,String>> CONF;\n+\n+  /**\n+   * Initialize the ContextClassLoaderFactory\n+   *\n+   * @param conf\n+   *          AccumuloConfiguration object\n+   */\n+  @SuppressWarnings(\"unchecked\")", "originalCommit": "1088247aebd207abbe4fb8d92c6cf6a6430fe0b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgxMjczNA==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518812734", "bodyText": "I removed the annotation as I can't move it closer.", "author": "dlmarion", "createdAt": "2020-11-06T15:10:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUzMzMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUzNTg1Mw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517535853", "bodyText": "I think this should call .getKey() instead of .toString()", "author": "ctubbsii", "createdAt": "2020-11-04T18:08:32Z", "path": "core/src/main/java/org/apache/accumulo/core/classloader/ContextClassLoaders.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import org.apache.accumulo.core.conf.Property;\n+import org.apache.accumulo.core.spi.common.ContextClassLoaderFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ContextClassLoaders {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(ContextClassLoaders.class);\n+\n+  public static final String CONTEXT_CLASS_LOADER_FACTORY = \"general.context.class.loader.factory\";\n+\n+  private static ContextClassLoaderFactory FACTORY;\n+  private static Supplier<Map<String,String>> CONF;\n+\n+  /**\n+   * Initialize the ContextClassLoaderFactory\n+   *\n+   * @param conf\n+   *          AccumuloConfiguration object\n+   */\n+  @SuppressWarnings(\"unchecked\")\n+  public static void initialize(Supplier<Map<String,String>> conf) throws Exception {\n+    if (null == CONF) {\n+      CONF = conf;\n+      LOG.info(\"Creating ContextClassLoaderFactory\");\n+      var factoryName = CONF.get().get(Property.GENERAL_CONTEXT_CLASSLOADER_FACTORY.toString());", "originalCommit": "1088247aebd207abbe4fb8d92c6cf6a6430fe0b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUzNjM1Ng==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517536356", "bodyText": "Should use .getKey() instead of .toString().", "author": "ctubbsii", "createdAt": "2020-11-04T18:09:20Z", "path": "core/src/main/java/org/apache/accumulo/core/classloader/LegacyVFSContextClassLoaderFactory.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import java.io.IOException;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.function.Supplier;\n+\n+import org.apache.accumulo.core.conf.Property;\n+import org.apache.accumulo.core.spi.common.ContextClassLoaderFactory;\n+import org.apache.accumulo.start.classloader.vfs.AccumuloVFSClassLoader;\n+import org.apache.accumulo.start.classloader.vfs.ContextManager;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Deprecated(since = \"2.1.0\", forRemoval = true)\n+public class LegacyVFSContextClassLoaderFactory implements ContextClassLoaderFactory {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(LegacyVFSContextClassLoaderFactory.class);\n+\n+  public void initialize(Supplier<Map<String,String>> contextProperties) {\n+    try {\n+      AccumuloVFSClassLoader.getContextManager()\n+          .setContextConfig(new ContextManager.DefaultContextsConfig() {\n+            @Override\n+            public Map<String,String> getVfsContextClasspathProperties() {\n+              return contextProperties.get();\n+            }\n+          });\n+      LOG.debug(\"ContextManager configuration set\");\n+      new Timer(\"LegacyVFSContextClassLoaderFactory-cleanup\", true)\n+          .scheduleAtFixedRate(new TimerTask() {\n+            @Override\n+            public void run() {\n+              try {\n+                if (LOG.isTraceEnabled()) {\n+                  LOG.trace(\"LegacyVFSContextClassLoaderFactory-cleanup thread, properties: {}\",\n+                      contextProperties.get());\n+                }\n+                Set<String> configuredContexts = new HashSet<>();\n+                contextProperties.get().keySet().forEach(k -> {\n+                  if (k.startsWith(Property.VFS_CONTEXT_CLASSPATH_PROPERTY.toString())) {", "originalCommit": "1088247aebd207abbe4fb8d92c6cf6a6430fe0b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUzNzUxMQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517537511", "bodyText": "UncheckedIOException should be used to wrap IOException as a runtime exception.", "author": "ctubbsii", "createdAt": "2020-11-04T18:11:14Z", "path": "core/src/main/java/org/apache/accumulo/core/classloader/LegacyVFSContextClassLoaderFactory.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import java.io.IOException;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.function.Supplier;\n+\n+import org.apache.accumulo.core.conf.Property;\n+import org.apache.accumulo.core.spi.common.ContextClassLoaderFactory;\n+import org.apache.accumulo.start.classloader.vfs.AccumuloVFSClassLoader;\n+import org.apache.accumulo.start.classloader.vfs.ContextManager;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Deprecated(since = \"2.1.0\", forRemoval = true)\n+public class LegacyVFSContextClassLoaderFactory implements ContextClassLoaderFactory {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(LegacyVFSContextClassLoaderFactory.class);\n+\n+  public void initialize(Supplier<Map<String,String>> contextProperties) {\n+    try {\n+      AccumuloVFSClassLoader.getContextManager()\n+          .setContextConfig(new ContextManager.DefaultContextsConfig() {\n+            @Override\n+            public Map<String,String> getVfsContextClasspathProperties() {\n+              return contextProperties.get();\n+            }\n+          });\n+      LOG.debug(\"ContextManager configuration set\");\n+      new Timer(\"LegacyVFSContextClassLoaderFactory-cleanup\", true)\n+          .scheduleAtFixedRate(new TimerTask() {\n+            @Override\n+            public void run() {\n+              try {\n+                if (LOG.isTraceEnabled()) {\n+                  LOG.trace(\"LegacyVFSContextClassLoaderFactory-cleanup thread, properties: {}\",\n+                      contextProperties.get());\n+                }\n+                Set<String> configuredContexts = new HashSet<>();\n+                contextProperties.get().keySet().forEach(k -> {\n+                  if (k.startsWith(Property.VFS_CONTEXT_CLASSPATH_PROPERTY.toString())) {\n+                    configuredContexts.add(\n+                        k.substring(Property.VFS_CONTEXT_CLASSPATH_PROPERTY.toString().length()));\n+                  }\n+                });\n+                LOG.trace(\"LegacyVFSContextClassLoaderFactory-cleanup thread, contexts in use: {}\",\n+                    configuredContexts);\n+                AccumuloVFSClassLoader.getContextManager().removeUnusedContexts(configuredContexts);\n+              } catch (IOException e) {\n+                LOG.warn(\"{}\", e.getMessage(), e);\n+              }\n+            }\n+          }, 60000, 60000);\n+      LOG.debug(\"Context cleanup timer started at 60s intervals\");\n+    } catch (IOException e) {\n+      throw new RuntimeException(e);", "originalCommit": "1088247aebd207abbe4fb8d92c6cf6a6430fe0b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgxOTAxMw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518819013", "bodyText": "interesting, didn't know about that. Thanks.", "author": "dlmarion", "createdAt": "2020-11-06T15:19:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUzNzUxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUzNzY1NQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517537655", "bodyText": "UncheckedIOException", "author": "ctubbsii", "createdAt": "2020-11-04T18:11:31Z", "path": "core/src/main/java/org/apache/accumulo/core/classloader/LegacyVFSContextClassLoaderFactory.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import java.io.IOException;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.Timer;\n+import java.util.TimerTask;\n+import java.util.function.Supplier;\n+\n+import org.apache.accumulo.core.conf.Property;\n+import org.apache.accumulo.core.spi.common.ContextClassLoaderFactory;\n+import org.apache.accumulo.start.classloader.vfs.AccumuloVFSClassLoader;\n+import org.apache.accumulo.start.classloader.vfs.ContextManager;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Deprecated(since = \"2.1.0\", forRemoval = true)\n+public class LegacyVFSContextClassLoaderFactory implements ContextClassLoaderFactory {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(LegacyVFSContextClassLoaderFactory.class);\n+\n+  public void initialize(Supplier<Map<String,String>> contextProperties) {\n+    try {\n+      AccumuloVFSClassLoader.getContextManager()\n+          .setContextConfig(new ContextManager.DefaultContextsConfig() {\n+            @Override\n+            public Map<String,String> getVfsContextClasspathProperties() {\n+              return contextProperties.get();\n+            }\n+          });\n+      LOG.debug(\"ContextManager configuration set\");\n+      new Timer(\"LegacyVFSContextClassLoaderFactory-cleanup\", true)\n+          .scheduleAtFixedRate(new TimerTask() {\n+            @Override\n+            public void run() {\n+              try {\n+                if (LOG.isTraceEnabled()) {\n+                  LOG.trace(\"LegacyVFSContextClassLoaderFactory-cleanup thread, properties: {}\",\n+                      contextProperties.get());\n+                }\n+                Set<String> configuredContexts = new HashSet<>();\n+                contextProperties.get().keySet().forEach(k -> {\n+                  if (k.startsWith(Property.VFS_CONTEXT_CLASSPATH_PROPERTY.toString())) {\n+                    configuredContexts.add(\n+                        k.substring(Property.VFS_CONTEXT_CLASSPATH_PROPERTY.toString().length()));\n+                  }\n+                });\n+                LOG.trace(\"LegacyVFSContextClassLoaderFactory-cleanup thread, contexts in use: {}\",\n+                    configuredContexts);\n+                AccumuloVFSClassLoader.getContextManager().removeUnusedContexts(configuredContexts);\n+              } catch (IOException e) {\n+                LOG.warn(\"{}\", e.getMessage(), e);\n+              }\n+            }\n+          }, 60000, 60000);\n+      LOG.debug(\"Context cleanup timer started at 60s intervals\");\n+    } catch (IOException e) {\n+      throw new RuntimeException(e);\n+    }\n+\n+  }\n+\n+  @Override\n+  public ClassLoader getClassLoader(String contextName) throws IllegalArgumentException {\n+    try {\n+      return AccumuloVFSClassLoader.getContextManager().getClassLoader(contextName);\n+    } catch (IOException e) {\n+      throw new RuntimeException(\"Error getting context class loader for context: \" + contextName,", "originalCommit": "1088247aebd207abbe4fb8d92c6cf6a6430fe0b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU1MzIwNw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517553207", "bodyText": "Is there not an appropriate existing utility class where this single static method can live? I think there's similar methods in the ConfigurationTypeHelper class.", "author": "ctubbsii", "createdAt": "2020-11-04T18:38:57Z", "path": "core/src/main/java/org/apache/accumulo/core/classloader/ClassLoaderUtil.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import org.apache.accumulo.start.classloader.vfs.AccumuloVFSClassLoader;\n+\n+public class ClassLoaderUtil {\n+\n+  public static <U> Class<? extends U> loadClass(String contextName, String className,\n+      Class<U> extension) throws ClassNotFoundException {\n+    if (contextName != null && !contextName.equals(\"\"))\n+      return ContextClassLoaders.getClassLoader(contextName).loadClass(className)\n+          .asSubclass(extension);\n+    else\n+      return AccumuloVFSClassLoader.loadClass(className, extension);\n+\n+  }", "originalCommit": "1088247aebd207abbe4fb8d92c6cf6a6430fe0b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgxMDQ4MA==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518810480", "bodyText": "ConfigurationTypeHelper calls this utility class now. It's certainly possible to move this method to a new class, I'm not sure which class is appropriate. Suggestions?", "author": "dlmarion", "createdAt": "2020-11-06T15:06:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU1MzIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU1NDAzOQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517554039", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (contextName != null && !contextName.equals(\"\"))\n          \n          \n            \n                if (contextName != null && !contextName.isEmpty())", "author": "ctubbsii", "createdAt": "2020-11-04T18:40:24Z", "path": "core/src/main/java/org/apache/accumulo/core/classloader/ClassLoaderUtil.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import org.apache.accumulo.start.classloader.vfs.AccumuloVFSClassLoader;\n+\n+public class ClassLoaderUtil {\n+\n+  public static <U> Class<? extends U> loadClass(String contextName, String className,\n+      Class<U> extension) throws ClassNotFoundException {\n+    if (contextName != null && !contextName.equals(\"\"))", "originalCommit": "1088247aebd207abbe4fb8d92c6cf6a6430fe0b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgxMDMwMA==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518810300", "bodyText": "Changed.", "author": "dlmarion", "createdAt": "2020-11-06T15:06:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU1NDAzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU1NTczNQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517555735", "bodyText": "You used isBlank above to check this instead of isEmpty, which implies that the string is not already stripped of whitespace. So, that implies factoryName might need to be stripped of surrounding whitespace. If it's not possible for it to have surrounding whitespace, then isEmpty might be more appropriate above than isBlank.", "author": "ctubbsii", "createdAt": "2020-11-04T18:43:29Z", "path": "core/src/main/java/org/apache/accumulo/core/classloader/ContextClassLoaders.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import org.apache.accumulo.core.conf.Property;\n+import org.apache.accumulo.core.spi.common.ContextClassLoaderFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ContextClassLoaders {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(ContextClassLoaders.class);\n+\n+  public static final String CONTEXT_CLASS_LOADER_FACTORY = \"general.context.class.loader.factory\";\n+\n+  private static ContextClassLoaderFactory FACTORY;\n+  private static Supplier<Map<String,String>> CONF;\n+\n+  /**\n+   * Initialize the ContextClassLoaderFactory\n+   *\n+   * @param conf\n+   *          AccumuloConfiguration object\n+   */\n+  @SuppressWarnings(\"unchecked\")\n+  public static void initialize(Supplier<Map<String,String>> conf) throws Exception {\n+    if (null == CONF) {\n+      CONF = conf;\n+      LOG.info(\"Creating ContextClassLoaderFactory\");\n+      var factoryName = CONF.get().get(Property.GENERAL_CONTEXT_CLASSLOADER_FACTORY.toString());\n+      if (null == factoryName || factoryName.isBlank()) {\n+        LOG.info(\"No ClassLoaderFactory specified\");\n+        return;\n+      }\n+      try {\n+        var factoryClass = Class.forName(factoryName);", "originalCommit": "1088247aebd207abbe4fb8d92c6cf6a6430fe0b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgxMzUwNQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518813505", "bodyText": "Changed to isEmpty()", "author": "dlmarion", "createdAt": "2020-11-06T15:11:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU1NTczNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU1NjA2Mw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517556063", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      FACTORY.initialize(new Supplier<Map<String,String>>() {\n          \n          \n            \n                        @Override\n          \n          \n            \n                        public Map<String,String> get() {\n          \n          \n            \n                          return CONF.get();\n          \n          \n            \n                        }\n          \n          \n            \n                      });\n          \n          \n            \n                      FACTORY.initialize(() -> CONF.get());", "author": "ctubbsii", "createdAt": "2020-11-04T18:44:06Z", "path": "core/src/main/java/org/apache/accumulo/core/classloader/ContextClassLoaders.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import org.apache.accumulo.core.conf.Property;\n+import org.apache.accumulo.core.spi.common.ContextClassLoaderFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ContextClassLoaders {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(ContextClassLoaders.class);\n+\n+  public static final String CONTEXT_CLASS_LOADER_FACTORY = \"general.context.class.loader.factory\";\n+\n+  private static ContextClassLoaderFactory FACTORY;\n+  private static Supplier<Map<String,String>> CONF;\n+\n+  /**\n+   * Initialize the ContextClassLoaderFactory\n+   *\n+   * @param conf\n+   *          AccumuloConfiguration object\n+   */\n+  @SuppressWarnings(\"unchecked\")\n+  public static void initialize(Supplier<Map<String,String>> conf) throws Exception {\n+    if (null == CONF) {\n+      CONF = conf;\n+      LOG.info(\"Creating ContextClassLoaderFactory\");\n+      var factoryName = CONF.get().get(Property.GENERAL_CONTEXT_CLASSLOADER_FACTORY.toString());\n+      if (null == factoryName || factoryName.isBlank()) {\n+        LOG.info(\"No ClassLoaderFactory specified\");\n+        return;\n+      }\n+      try {\n+        var factoryClass = Class.forName(factoryName);\n+        if (ContextClassLoaderFactory.class.isAssignableFrom(factoryClass)) {\n+          LOG.info(\"Creating ContextClassLoaderFactory: {}\", factoryName);\n+          FACTORY = ((Class<? extends ContextClassLoaderFactory>) factoryClass)\n+              .getDeclaredConstructor().newInstance();\n+          FACTORY.initialize(new Supplier<Map<String,String>>() {\n+            @Override\n+            public Map<String,String> get() {\n+              return CONF.get();\n+            }\n+          });", "originalCommit": "1088247aebd207abbe4fb8d92c6cf6a6430fe0b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU1ODE5Mw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517558193", "bodyText": "You're catching an RTE to log and then throw a different RTE. This adds redundant logs and makes it harder to get a meaningful stack trace. It'd be better to just let the IAE fall through.", "author": "ctubbsii", "createdAt": "2020-11-04T18:47:49Z", "path": "core/src/main/java/org/apache/accumulo/core/classloader/ContextClassLoaders.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import org.apache.accumulo.core.conf.Property;\n+import org.apache.accumulo.core.spi.common.ContextClassLoaderFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ContextClassLoaders {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(ContextClassLoaders.class);\n+\n+  public static final String CONTEXT_CLASS_LOADER_FACTORY = \"general.context.class.loader.factory\";\n+\n+  private static ContextClassLoaderFactory FACTORY;\n+  private static Supplier<Map<String,String>> CONF;\n+\n+  /**\n+   * Initialize the ContextClassLoaderFactory\n+   *\n+   * @param conf\n+   *          AccumuloConfiguration object\n+   */\n+  @SuppressWarnings(\"unchecked\")\n+  public static void initialize(Supplier<Map<String,String>> conf) throws Exception {\n+    if (null == CONF) {\n+      CONF = conf;\n+      LOG.info(\"Creating ContextClassLoaderFactory\");\n+      var factoryName = CONF.get().get(Property.GENERAL_CONTEXT_CLASSLOADER_FACTORY.toString());\n+      if (null == factoryName || factoryName.isBlank()) {\n+        LOG.info(\"No ClassLoaderFactory specified\");\n+        return;\n+      }\n+      try {\n+        var factoryClass = Class.forName(factoryName);\n+        if (ContextClassLoaderFactory.class.isAssignableFrom(factoryClass)) {\n+          LOG.info(\"Creating ContextClassLoaderFactory: {}\", factoryName);\n+          FACTORY = ((Class<? extends ContextClassLoaderFactory>) factoryClass)\n+              .getDeclaredConstructor().newInstance();\n+          FACTORY.initialize(new Supplier<Map<String,String>>() {\n+            @Override\n+            public Map<String,String> get() {\n+              return CONF.get();\n+            }\n+          });\n+        } else {\n+          throw new RuntimeException(factoryName + \" does not implement ContextClassLoaderFactory\");\n+        }\n+      } catch (ClassNotFoundException | InstantiationException | IllegalAccessException\n+          | IllegalArgumentException | InvocationTargetException | NoSuchMethodException\n+          | SecurityException e) {\n+        LOG.error(\n+            \"Unable to load and initialize class: {}. Ensure that the jar containing the ContextClassLoaderFactory is on the classpath\",\n+            factoryName);\n+        throw e;\n+      }\n+    } else {\n+      LOG.debug(\"ContextClassLoaderFactory already initialized.\");\n+    }\n+  }\n+\n+  /**\n+   * Return the ClassLoader for the given contextName\n+   *\n+   * @param contextName\n+   *          name\n+   * @return ClassLoader for contextName, do not cache this\n+   * @throws RuntimeException\n+   *           if contextName not configured\n+   */\n+  public static ClassLoader getClassLoader(String contextName) {\n+    try {\n+      // Cannot cache the ClassLoader result as it\n+      // may change when the ClassLoader reloads\n+      return FACTORY.getClassLoader(contextName);\n+    } catch (IllegalArgumentException e) {\n+      LOG.error(\"ContextClassLoaderFactory is not configured for context: {}\", contextName);\n+      throw new RuntimeException(\n+          \"ContextClassLoaderFactory is not configured for context: \" + contextName);", "originalCommit": "1088247aebd207abbe4fb8d92c6cf6a6430fe0b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgxNzkxMQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518817911", "bodyText": "Made this change.", "author": "dlmarion", "createdAt": "2020-11-06T15:17:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU1ODE5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU1ODczMQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517558731", "bodyText": "It looks like this constructor was added, but not used.", "author": "ctubbsii", "createdAt": "2020-11-04T18:48:52Z", "path": "core/src/main/java/org/apache/accumulo/core/conf/ConfigurationCopy.java", "diffHunk": "@@ -49,9 +50,17 @@ public ConfigurationCopy(Map<String,String> config) {\n    *          configuration property iterable to use for copying\n    */\n   public ConfigurationCopy(Iterable<Entry<String,String>> config) {\n-    for (Entry<String,String> entry : config) {\n-      copy.put(entry.getKey(), entry.getValue());\n-    }\n+    this(config.iterator());\n+  }\n+\n+  /**\n+   * Creates a new configuration.\n+   *\n+   * @param config\n+   *          configuration property iterator to use for copying\n+   */\n+  public ConfigurationCopy(Iterator<Entry<String,String>> config) {\n+    config.forEachRemaining(e -> copy.put(e.getKey(), e.getValue()));", "originalCommit": "1088247aebd207abbe4fb8d92c6cf6a6430fe0b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU2MDMyNA==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517560324", "bodyText": "Is this method even necessary? Could just have a getter for the FACTORY. I'm not sure this static method adds much in terms of convenience.", "author": "ctubbsii", "createdAt": "2020-11-04T18:51:43Z", "path": "core/src/main/java/org/apache/accumulo/core/classloader/ContextClassLoaders.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import java.lang.reflect.InvocationTargetException;\n+\n+import org.apache.accumulo.core.conf.AccumuloConfiguration;\n+import org.apache.accumulo.core.conf.Property;\n+import org.apache.accumulo.core.spi.common.ContextClassLoaderFactory;\n+import org.apache.accumulo.core.util.ConfigurationImpl;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class ContextClassLoaders {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(ContextClassLoaders.class);\n+\n+  public static final String CONTEXT_CLASS_LOADER_FACTORY = \"general.context.class.loader.factory\";\n+\n+  private static ContextClassLoaderFactory FACTORY;\n+  private static AccumuloConfiguration CONF;\n+\n+  /**\n+   * Initialize the ContextClassLoaderFactory\n+   *\n+   * @param conf\n+   *          AccumuloConfiguration object\n+   */\n+  @SuppressWarnings(\"unchecked\")\n+  public static void initialize(AccumuloConfiguration conf) throws Exception {\n+    if (null == CONF) {\n+      CONF = conf;\n+      LOG.info(\"Creating ContextClassLoaderFactory\");\n+      var factoryName = CONF.get(Property.GENERAL_CONTEXT_CLASSLOADER_FACTORY.toString());\n+      if (null == factoryName || factoryName.isBlank()) {\n+        LOG.info(\"No ClassLoaderFactory specified\");\n+        return;\n+      }\n+      try {\n+        var factoryClass = Class.forName(factoryName);\n+        if (ContextClassLoaderFactory.class.isAssignableFrom(factoryClass)) {\n+          LOG.info(\"Creating ContextClassLoaderFactory: {}\", factoryName);\n+          FACTORY = ((Class<? extends ContextClassLoaderFactory>) factoryClass)\n+              .getDeclaredConstructor().newInstance();\n+          FACTORY.initialize(new ConfigurationImpl(CONF));\n+        } else {\n+          throw new RuntimeException(factoryName + \" does not implement ContextClassLoaderFactory\");\n+        }\n+      } catch (ClassNotFoundException | InstantiationException | IllegalAccessException\n+          | IllegalArgumentException | InvocationTargetException | NoSuchMethodException\n+          | SecurityException e) {\n+        LOG.error(\n+            \"Unable to load and initialize class: {}. Ensure that the jar containing the ContextClassLoaderFactory is on the classpath\",\n+            factoryName);\n+        throw e;\n+      }\n+    } else {\n+      LOG.debug(\"ContextClassLoaderFactory already initialized.\");\n+    }\n+  }\n+\n+  /**\n+   * Return the ClassLoader for the given contextName\n+   *\n+   * @param contextName\n+   *          name\n+   * @return ClassLoader for contextName, do not cache this\n+   * @throws RuntimeException\n+   *           if contextName not configured\n+   */\n+  public static ClassLoader getClassLoader(String contextName) {", "originalCommit": "185781592df4c899d6e67a50da824986a5729c2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgxNzg0MQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518817841", "bodyText": "Made this change.", "author": "dlmarion", "createdAt": "2020-11-06T15:17:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU2MDMyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU2MjY4MA==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517562680", "bodyText": "We should inline this property's key. I don't think there's a reason to have that string located in a separate constant outside this class. That was only done for some of the VFS stuff that existed in the start module. But, this constant is just in a different location in the core module.", "author": "ctubbsii", "createdAt": "2020-11-04T18:55:34Z", "path": "core/src/main/java/org/apache/accumulo/core/conf/Property.java", "diffHunk": "@@ -196,6 +198,9 @@\n           + \"Additionally, this property no longer does property interpolation of environment \"\n           + \"variables, such as '$ACCUMULO_HOME'. Use commons-configuration syntax,\"\n           + \"'${env:ACCUMULO_HOME}' instead.\"),\n+  GENERAL_CONTEXT_CLASSLOADER_FACTORY(ContextClassLoaders.CONTEXT_CLASS_LOADER_FACTORY,\n+      LegacyVFSContextClassLoaderFactory.class.getName(), PropertyType.STRING,\n+      \"Name of classloader factory to be used to create classloaders for named contexts.\"),", "originalCommit": "185781592df4c899d6e67a50da824986a5729c2a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxOTc0Mw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517619743", "bodyText": "Should we use semicolon as the delimiter, because so this behaves more like a CLASSPATH?", "author": "ctubbsii", "createdAt": "2020-11-04T20:43:21Z", "path": "core/src/test/java/org/apache/accumulo/core/classloader/URLClassLoaderFactory.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.net.URLClassLoader;\n+import java.util.ArrayList;\n+\n+import org.apache.accumulo.core.client.PluginEnvironment.Configuration;\n+import org.apache.accumulo.core.spi.common.ContextClassLoaderFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class URLClassLoaderFactory implements ContextClassLoaderFactory {\n+\n+  private static final String COMMA = \",\";", "originalCommit": "185781592df4c899d6e67a50da824986a5729c2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgyMjQ0Mw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518822443", "bodyText": "I'm not sure that this is important as it's a test class", "author": "dlmarion", "createdAt": "2020-11-06T15:23:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxOTc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgzNDc4Mw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518834783", "bodyText": "Oh right. I was thinking we'd provide this one as a reference imlementation built-in, for users. If it's just a test, user experience doesn't matter.", "author": "ctubbsii", "createdAt": "2020-11-06T15:42:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxOTc0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTAyOTE3OA==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r519029178", "bodyText": "Some times test cases are a good way to find code to build upon - especially if there is no reference implementation or examples in documentation.  Not saying that this instance needs to change, but more of a something to keep in mind.", "author": "EdColeman", "createdAt": "2020-11-06T22:06:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxOTc0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMDE1Nw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517620157", "bodyText": "It would be good to use more specific RTEs instead of the generic one, whenever a more appropriate one is available. Here, IllegalArgumentException would be appropriate.", "author": "ctubbsii", "createdAt": "2020-11-04T20:44:12Z", "path": "core/src/test/java/org/apache/accumulo/core/classloader/URLClassLoaderFactory.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.net.URLClassLoader;\n+import java.util.ArrayList;\n+\n+import org.apache.accumulo.core.client.PluginEnvironment.Configuration;\n+import org.apache.accumulo.core.spi.common.ContextClassLoaderFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class URLClassLoaderFactory implements ContextClassLoaderFactory {\n+\n+  private static final String COMMA = \",\";\n+  private static final Logger LOG = LoggerFactory.getLogger(URLClassLoaderFactory.class);\n+\n+  @Override\n+  public void initialize(Configuration contextProperties) throws Exception {}\n+\n+  @Override\n+  public ClassLoader getClassLoader(String contextName) throws IllegalArgumentException {\n+    // The context name is the classpath.\n+    var parts = contextName.split(COMMA);\n+    var urls = new ArrayList<URL>();\n+    for (String p : parts) {\n+      try {\n+        urls.add(new URL(p));\n+      } catch (MalformedURLException e) {\n+        LOG.error(\"Error creating URL from classpath segment: \" + p);\n+        throw new RuntimeException(\"Error creating URL from classpath segment: \" + p, e);", "originalCommit": "185781592df4c899d6e67a50da824986a5729c2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgyNDAxNA==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518824014", "bodyText": "Changed to throw IAE", "author": "dlmarion", "createdAt": "2020-11-06T15:26:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMDE1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMDg1OQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517620859", "bodyText": "Should log or throw, but not both. This is how we get duplicate log messages in the log files. The caller can choose to log as part of its handling mechanism, if you choose to throw.", "author": "ctubbsii", "createdAt": "2020-11-04T20:45:27Z", "path": "core/src/test/java/org/apache/accumulo/core/classloader/URLClassLoaderFactory.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.net.URLClassLoader;\n+import java.util.ArrayList;\n+\n+import org.apache.accumulo.core.client.PluginEnvironment.Configuration;\n+import org.apache.accumulo.core.spi.common.ContextClassLoaderFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class URLClassLoaderFactory implements ContextClassLoaderFactory {\n+\n+  private static final String COMMA = \",\";\n+  private static final Logger LOG = LoggerFactory.getLogger(URLClassLoaderFactory.class);\n+\n+  @Override\n+  public void initialize(Configuration contextProperties) throws Exception {}\n+\n+  @Override\n+  public ClassLoader getClassLoader(String contextName) throws IllegalArgumentException {\n+    // The context name is the classpath.\n+    var parts = contextName.split(COMMA);\n+    var urls = new ArrayList<URL>();\n+    for (String p : parts) {\n+      try {\n+        urls.add(new URL(p));\n+      } catch (MalformedURLException e) {\n+        LOG.error(\"Error creating URL from classpath segment: \" + p);", "originalCommit": "185781592df4c899d6e67a50da824986a5729c2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgyMzg3MQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r518823871", "bodyText": "I removed the log", "author": "dlmarion", "createdAt": "2020-11-06T15:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMDg1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMjQwMw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517622403", "bodyText": "This can probably be done a bit more succinctly with streams, something like:\n  var urls = Stream.of(contextName.split(DELIM)).map( p -> toUrl(p) ).collect(Collectors.toList());", "author": "ctubbsii", "createdAt": "2020-11-04T20:48:30Z", "path": "core/src/test/java/org/apache/accumulo/core/classloader/URLClassLoaderFactory.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.classloader;\n+\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.net.URLClassLoader;\n+import java.util.ArrayList;\n+\n+import org.apache.accumulo.core.client.PluginEnvironment.Configuration;\n+import org.apache.accumulo.core.spi.common.ContextClassLoaderFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class URLClassLoaderFactory implements ContextClassLoaderFactory {\n+\n+  private static final String COMMA = \",\";\n+  private static final Logger LOG = LoggerFactory.getLogger(URLClassLoaderFactory.class);\n+\n+  @Override\n+  public void initialize(Configuration contextProperties) throws Exception {}\n+\n+  @Override\n+  public ClassLoader getClassLoader(String contextName) throws IllegalArgumentException {\n+    // The context name is the classpath.\n+    var parts = contextName.split(COMMA);\n+    var urls = new ArrayList<URL>();\n+    for (String p : parts) {\n+      try {\n+        urls.add(new URL(p));\n+      } catch (MalformedURLException e) {", "originalCommit": "185781592df4c899d6e67a50da824986a5729c2a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNTAzNw==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517625037", "bodyText": "Maybe only catch checked exceptions here. Anything falling through that isn't a checked exception is already an RTE and we don't need to rewrap as a new RTE.", "author": "ctubbsii", "createdAt": "2020-11-04T20:53:47Z", "path": "server/manager/src/main/java/org/apache/accumulo/master/Master.java", "diffHunk": "@@ -378,14 +377,12 @@ public static void main(String[] args) throws Exception {\n         Property.MASTER_TABLET_BALANCER, TabletBalancer.class, new DefaultLoadBalancer());\n     this.tabletBalancer.init(context);\n \n-    AccumuloVFSClassLoader.getContextManager()\n-        .setContextConfig(new ContextManager.DefaultContextsConfig() {\n-          @Override\n-          public Map<String,String> getVfsContextClasspathProperties() {\n-            return getConfiguration()\n-                .getAllPropertiesWithPrefix(Property.VFS_CONTEXT_CLASSPATH_PROPERTY);\n-          }\n-        });\n+    try {\n+      ContextClassLoaders.initialize(aconf);\n+    } catch (Exception e1) {\n+      log.error(\"Error configuring ContextClassLoaderFactory\", e1);\n+      throw new RuntimeException(\"Error configuring ContextClassLoaderFactory\", e1);\n+    }", "originalCommit": "185781592df4c899d6e67a50da824986a5729c2a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyOTk2OQ==", "url": "https://github.com/apache/accumulo/pull/1715#discussion_r517629969", "bodyText": "I think there might be an IT that checks the printed strings... not sure. It's fine if it changes, but the IT might need to be updated.", "author": "ctubbsii", "createdAt": "2020-11-04T21:03:43Z", "path": "start/src/main/java/org/apache/accumulo/start/classloader/vfs/AccumuloVFSClassLoader.java", "diffHunk": "@@ -358,48 +360,24 @@ public static void printClassPath(Printer out, boolean debug) {\n           continue;\n         }\n \n-        String classLoaderDescription;\n-        switch (level) {\n-          case 1:\n-            classLoaderDescription =\n-                level + \": Java System Classloader (loads Java system resources)\";\n-            break;\n-          case 2:\n-            classLoaderDescription =\n-                level + \": Java Classloader (loads everything defined by java classpath)\";\n-            break;\n-          case 3:\n-            classLoaderDescription =\n-                level + \": Accumulo Classloader (loads everything defined by general.classpaths)\";\n-            break;\n-          case 4:\n-            classLoaderDescription = level + \": Accumulo Dynamic Classloader \"\n-                + \"(loads everything defined by general.dynamic.classpaths)\";\n-            break;\n-          default:\n-            classLoaderDescription = level + \": Mystery Classloader (\"\n-                + \"someone probably added a classloader and didn't update the switch statement in \"\n-                + AccumuloVFSClassLoader.class.getName() + \")\";\n-            break;\n-        }\n-\n         boolean sawFirst = false;\n+        String classLoaderDescription = \"Level: \" + level + \", Name: \" + classLoader.getName()\n+            + \", class: \" + classLoader.getClass().getName();\n         if (classLoader.getClass().getName().startsWith(\"jdk.internal\")) {\n           if (debug) {\n-            out.print(\"Level \" + classLoaderDescription + \" \" + classLoader.getClass().getName()\n-                + \" configuration not inspectable.\\n\");\n+            out.print(classLoaderDescription + \": configuration not inspectable.\\n\");", "originalCommit": "185781592df4c899d6e67a50da824986a5729c2a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "741bda3d88f472c2e1900ceb68de3a804d5cc79d", "url": "https://github.com/apache/accumulo/commit/741bda3d88f472c2e1900ceb68de3a804d5cc79d", "message": "address comments in PR", "committedDate": "2020-11-06T16:00:28Z", "type": "commit"}, {"oid": "c796f0e40ceba6c6ca3ba74b0f13421a16ab4919", "url": "https://github.com/apache/accumulo/commit/c796f0e40ceba6c6ca3ba74b0f13421a16ab4919", "message": "fix checkstyle", "committedDate": "2020-11-06T16:30:12Z", "type": "commit"}, {"oid": "fb2e873a0ddb4fb97b9c51c16eef58438902bf80", "url": "https://github.com/apache/accumulo/commit/fb2e873a0ddb4fb97b9c51c16eef58438902bf80", "message": "inlined property name", "committedDate": "2020-11-16T15:19:59Z", "type": "commit"}]}