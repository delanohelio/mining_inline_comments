{"pr_number": 1667, "pr_title": "Fix #1663 - Missing metrics files running CI tests", "pr_createdAt": "2020-07-31T02:18:34Z", "pr_url": "https://github.com/apache/accumulo/pull/1667", "timeline": [{"oid": "5e881448d5dfb0b4d8f09c3d2092384c54bd718f", "url": "https://github.com/apache/accumulo/commit/5e881448d5dfb0b4d8f09c3d2092384c54bd718f", "message": "Fix #1663 - Missing metrics files running CI tests\n\n- excluded hadoop-metrics2-accumulo.properties from jar plugin\n- added gc metrics config sample to template", "committedDate": "2020-07-31T02:05:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4MDIyMw==", "url": "https://github.com/apache/accumulo/pull/1667#discussion_r463380223", "bodyText": "This should probably exist only in the test module, rather than in the root pom.", "author": "ctubbsii", "createdAt": "2020-07-31T02:58:36Z", "path": "pom.xml", "diffHunk": "@@ -658,6 +658,9 @@\n           <groupId>org.apache.maven.plugins</groupId>\n           <artifactId>maven-jar-plugin</artifactId>\n           <configuration>\n+            <excludes>\n+              <exclude>**/hadoop-metrics2-accumulo.properties</exclude>\n+            </excludes>", "originalCommit": "5e881448d5dfb0b4d8f09c3d2092384c54bd718f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM5MDk3MQ==", "url": "https://github.com/apache/accumulo/pull/1667#discussion_r463390971", "bodyText": "Should I add a complete maven-jar-plugin to the test module pom?  I looked there but I did not see one configured. I thought about it, but was unsure if a new plugin configuration or promoting it to the parent would be preferred.\nHaving it in the parent does have a side benefit that if any module ends up needing a metrics file for testing it would be excluded by default.\nIt's your call as to the preferred approach.", "author": "EdColeman", "createdAt": "2020-07-31T03:50:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4MDIyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NDQ1MQ==", "url": "https://github.com/apache/accumulo/pull/1667#discussion_r463874451", "bodyText": "Placing the plugin section in the test module pom with this configured there would be preferred, so it doesn't unintentionally apply to other modules, and also so it's more visible to people modifying the test module in the future, in case they modify it in a way that is impacted by this configuration.\nOther modules wouldn't be affected anyway, since they would use src/test/resources. The only reason the test module is affected is because it uses src/main/resources. If we actually wanted to intentionally put this file in another module's src/main/resources, we wouldn't want this configuration to accidentally omit it.", "author": "ctubbsii", "createdAt": "2020-07-31T22:37:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4MDIyMw=="}], "type": "inlineReview"}, {"oid": "7de2d4b04bd4b81393a37979704799f5c62bf90b", "url": "https://github.com/apache/accumulo/commit/7de2d4b04bd4b81393a37979704799f5c62bf90b", "message": "move property excludes to module instead of parent pom", "committedDate": "2020-07-31T15:03:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NDczOA==", "url": "https://github.com/apache/accumulo/pull/1667#discussion_r463874738", "bodyText": "This can be omitted, as it would be merged with the configuration from the parent anyway. We only need to specify the portions that we wish to override in here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      </excludes>\n          \n          \n            \n                      <archive>\n          \n          \n            \n                        <manifestEntries>\n          \n          \n            \n                          <Sealed>true</Sealed>\n          \n          \n            \n                          <Implementation-Build>${mvngit.commit.id}</Implementation-Build>\n          \n          \n            \n                        </manifestEntries>\n          \n          \n            \n                      </archive>\n          \n          \n            \n                      </excludes>", "author": "ctubbsii", "createdAt": "2020-07-31T22:38:51Z", "path": "test/pom.xml", "diffHunk": "@@ -270,6 +270,21 @@\n           </execution>\n         </executions>\n       </plugin>\n+      <plugin>\n+        <groupId>org.apache.maven.plugins</groupId>\n+        <artifactId>maven-jar-plugin</artifactId>\n+        <configuration>\n+          <excludes>\n+            <exclude>**/hadoop-metrics2-accumulo.properties</exclude>\n+          </excludes>\n+          <archive>\n+            <manifestEntries>\n+              <Sealed>true</Sealed>\n+              <Implementation-Build>${mvngit.commit.id}</Implementation-Build>\n+            </manifestEntries>\n+          </archive>", "originalCommit": "7de2d4b04bd4b81393a37979704799f5c62bf90b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4474082ede6d95b6a7088a8a48a66a1e6ee4c1ab", "url": "https://github.com/apache/accumulo/commit/4474082ede6d95b6a7088a8a48a66a1e6ee4c1ab", "message": "address pr comments to remove redundant local override", "committedDate": "2020-08-03T16:27:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU0NTMwMg==", "url": "https://github.com/apache/accumulo/pull/1667#discussion_r464545302", "bodyText": "It occurs to me... does this still allow metrics to work when we're doing testing? If it's not in the jar, how does it get on the class path?", "author": "ctubbsii", "createdAt": "2020-08-03T17:08:40Z", "path": "test/pom.xml", "diffHunk": "@@ -270,6 +270,15 @@\n           </execution>\n         </executions>\n       </plugin>\n+      <plugin>\n+        <groupId>org.apache.maven.plugins</groupId>\n+        <artifactId>maven-jar-plugin</artifactId>\n+        <configuration>\n+          <excludes>\n+            <exclude>**/hadoop-metrics2-accumulo.properties</exclude>", "originalCommit": "4474082ede6d95b6a7088a8a48a66a1e6ee4c1ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4MDQ1OQ==", "url": "https://github.com/apache/accumulo/pull/1667#discussion_r464580459", "bodyText": "I was under the impression that the maven-jar-plugin would be called during assembly (package?)  If you build / test under maven, the property file will still be there.  So, any testing that uses classes / files under ..../target/...  should still work.\nYou are correct though, if you tried to run it tests using just the jars - unless you provided a metrics configuration file with metrics output configured, then the tests that check those files would fail. If you go to the trouble to run the tests outside of maven using a command line, then if you got that far, adding a suitable config file may not be much of a hurdle and forces you to provide a configuration that you want for your needs.\nOne issue is that the metrics config file is specifying ./target/name as a know location for the output files - this was so that mvn clean would remove them and they would not be left hanging around.\nI suppose that if there was another well know location that would always be suitable for writes, then that could be used instead.  Sounds like just specified /tmp, but that's making an assumption that /tmp would always be suitable - for example would docker / containers / aws / ... prefer not to use /tmp but something else?  And then there's the clean-up - would need something besides (or modification) mvn clean.  Sure, /tmp may eventually get cleaned, but seems good practice not to depend on that.", "author": "EdColeman", "createdAt": "2020-08-03T18:11:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU0NTMwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU4OTE3Ng==", "url": "https://github.com/apache/accumulo/pull/1667#discussion_r464589176", "bodyText": "maven-jar-plugin runs during the package phase of the default lifecycle. Usually, the maven-assembly-plugin is also configured to run during the package phase, but only if a user manually configured it, since it's not bound to the default lifecycle by default.\nIf our tests pass, I have no problem excluding it from the jar. Like you said, our metrics file is set for target directory, specifically, so it's clear it's only for our tests anyway. And, if our test code were reused, it wouldn't be hard for the caller to provide its own metrics config file.\nI would avoid /tmp. It's best to use the target/ directory, and write to no other directories in a Maven build.\nMy final point of feedback, then, is just a suggestion to use the path explicitly, rather than wildcards:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        <exclude>**/hadoop-metrics2-accumulo.properties</exclude>\n          \n          \n            \n                        <exclude>src/main/resources/hadoop-metrics2-accumulo.properties</exclude>", "author": "ctubbsii", "createdAt": "2020-08-03T18:28:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU0NTMwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYwNjkzNw==", "url": "https://github.com/apache/accumulo/pull/1667#discussion_r464606937", "bodyText": "Hit commit via ui, becuase - sure that's reasonable - and then decided to test - oops.  Anyway I don't think that works as intended - might be src is assumed?  Anyway, checking now...", "author": "EdColeman", "createdAt": "2020-08-03T19:05:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU0NTMwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYxNTI3NA==", "url": "https://github.com/apache/accumulo/pull/1667#discussion_r464615274", "bodyText": "Oh! The jar plugin's base directory might be target/classes, where the compiler plugin leaves class files and the resource plugin leaves resources. It might just work with the file name only, since this resource isn't in a subdirectory. Not sure.", "author": "ctubbsii", "createdAt": "2020-08-03T19:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU0NTMwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0ODg4Mw==", "url": "https://github.com/apache/accumulo/pull/1667#discussion_r464648883", "bodyText": "So I basically tried more restrictive paths combinations and **/filename seems to be the \"most\" specific that actually excluded the file from the created jar - basically revered the UI generated commit. I examined the jars created with the current changes and run -Psunny and things look okay as it stands now.", "author": "EdColeman", "createdAt": "2020-08-03T20:37:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU0NTMwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgzNDk5NQ==", "url": "https://github.com/apache/accumulo/pull/1667#discussion_r464834995", "bodyText": "I tested the following more narrow construction, and it seems to work fine (see my last comment for why):\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        <exclude>**/hadoop-metrics2-accumulo.properties</exclude>\n          \n          \n            \n                        <exclude>hadoop-metrics2-accumulo.properties</exclude>", "author": "ctubbsii", "createdAt": "2020-08-04T06:48:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU0NTMwMg=="}], "type": "inlineReview"}, {"oid": "1ceea4fb39552d71d2388a4f7fa27ca814201076", "url": "https://github.com/apache/accumulo/commit/1ceea4fb39552d71d2388a4f7fa27ca814201076", "message": "Update test/pom.xml\n\nCo-authored-by: Christopher Tubbs <ctubbsii@apache.org>", "committedDate": "2020-08-03T18:38:36Z", "type": "commit"}, {"oid": "e79bedb9f30908956182afe069dca5e31a7caebe", "url": "https://github.com/apache/accumulo/commit/e79bedb9f30908956182afe069dca5e31a7caebe", "message": "revert excluding full path - does not work as expected", "committedDate": "2020-08-03T19:42:02Z", "type": "commit"}, {"oid": "a5ab7f99d1f6bee90090fbff69b9bf3cdd137cdb", "url": "https://github.com/apache/accumulo/commit/a5ab7f99d1f6bee90090fbff69b9bf3cdd137cdb", "message": "Update test/pom.xml", "committedDate": "2020-08-04T13:05:13Z", "type": "commit"}]}