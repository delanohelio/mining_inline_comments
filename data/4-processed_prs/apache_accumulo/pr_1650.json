{"pr_number": 1650, "pr_title": "Batching Strategy for SimpleGarbageCollector Fix #1543", "pr_createdAt": "2020-07-07T11:56:49Z", "pr_url": "https://github.com/apache/accumulo/pull/1650", "timeline": [{"oid": "d2d2d37ee95912cfcfef266f93ef3ee3729db0fa", "url": "https://github.com/apache/accumulo/commit/d2d2d37ee95912cfcfef266f93ef3ee3729db0fa", "message": "Batching Strategy for SimpleGarbageCollector", "committedDate": "2020-07-07T11:29:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk0NDc2Nw==", "url": "https://github.com/apache/accumulo/pull/1650#discussion_r450944767", "bodyText": "I don't think the method comment is true anymore.  Perhaps this method name and comments should be changed altogether.", "author": "ivakegg", "createdAt": "2020-07-07T15:17:06Z", "path": "server/gc/src/main/java/org/apache/accumulo/gc/SimpleGarbageCollector.java", "diffHunk": "@@ -669,14 +665,13 @@ private HostAndPort startStatsService() {\n   /**\n    * Checks if the system is almost out of memory.\n    *\n-   * @param runtime\n-   *          Java runtime\n+   * @param candidateLength\n+   *          Candidate Length\n    * @return true if system is almost out of memory\n-   * @see #CANDIDATE_MEMORY_PERCENTAGE\n+   * @see #CANDIDATE_BATCH_SIZE\n    */\n-  static boolean almostOutOfMemory(Runtime runtime) {\n-    return runtime.totalMemory() - runtime.freeMemory()\n-        > CANDIDATE_MEMORY_PERCENTAGE * runtime.maxMemory();\n+  static boolean almostOutOfMemory(Long candidateLength) {", "originalCommit": "d2d2d37ee95912cfcfef266f93ef3ee3729db0fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk1MTM3OA==", "url": "https://github.com/apache/accumulo/pull/1650#discussion_r450951378", "bodyText": "That's fair, I wasn't quite sure on that either. Do you have any suggestions?", "author": "Manno15", "createdAt": "2020-07-07T15:26:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk0NDc2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyMzQ0OA==", "url": "https://github.com/apache/accumulo/pull/1650#discussion_r451223448", "bodyText": "The method is so simple now, I would inline it and remove the associated test.", "author": "keith-turner", "createdAt": "2020-07-08T00:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk0NDc2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ0MTkxNw==", "url": "https://github.com/apache/accumulo/pull/1650#discussion_r451441917", "bodyText": "That is what I originally had but was unsure on if removing the test was a good idea.", "author": "Manno15", "createdAt": "2020-07-08T10:28:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk0NDc2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNTI4Nw==", "url": "https://github.com/apache/accumulo/pull/1650#discussion_r451225287", "bodyText": "May be useful to include the batch size.  This probably needs to be reformatted.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      log.info(\"List of delete candidates has exceeded the batch size\"\n          \n          \n            \n                          + \" threshold. Attempting to delete what has been gathered so far.\");\n          \n          \n            \n                      log.info(\"Candidate batch of size {} has exceeded the\"\n          \n          \n            \n                          + \" threshold. Attempting to delete what has been gathered so far.\", candidateLength);", "author": "keith-turner", "createdAt": "2020-07-08T01:05:50Z", "path": "server/gc/src/main/java/org/apache/accumulo/gc/SimpleGarbageCollector.java", "diffHunk": "@@ -209,20 +205,20 @@ public boolean getCandidates(String continuePoint, List<String> result)\n         throws TableNotFoundException {\n \n       Iterator<String> candidates = getContext().getAmple().getGcCandidates(level, continuePoint);\n+      long candidateLength = 0;\n \n       result.clear();\n \n       while (candidates.hasNext()) {\n-        String cand = candidates.next();\n-\n-        result.add(cand);\n-        if (almostOutOfMemory(Runtime.getRuntime())) {\n-          log.info(\"List of delete candidates has exceeded the memory\"\n+        String candidate = candidates.next();\n+        candidateLength += candidate.length();\n+        result.add(candidate);\n+        if (almostOutOfMemory(candidateLength)) {\n+          log.info(\"List of delete candidates has exceeded the batch size\"\n               + \" threshold. Attempting to delete what has been gathered so far.\");", "originalCommit": "d2d2d37ee95912cfcfef266f93ef3ee3729db0fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cc3274d8d2384433ed1d13cc12d0b7074c80c39d", "url": "https://github.com/apache/accumulo/commit/cc3274d8d2384433ed1d13cc12d0b7074c80c39d", "message": "Remove test and make fuction inline per request", "committedDate": "2020-07-08T10:56:48Z", "type": "commit"}]}