{"pr_number": 1765, "pr_title": "Issue #1742 - Added forEach to ScannerBase. Added test in ScannerIT.", "pr_createdAt": "2020-11-02T18:25:00Z", "pr_url": "https://github.com/apache/accumulo/pull/1765", "timeline": [{"oid": "5b60b8cb384c3cae7d3b5af9c5ecf9c1411d3225", "url": "https://github.com/apache/accumulo/commit/5b60b8cb384c3cae7d3b5af9c5ecf9c1411d3225", "message": "Issue #1742 - Added forEach method in ScannerBase. Added test in ScannerIT.", "committedDate": "2020-11-02T18:21:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM2Mjk4Ng==", "url": "https://github.com/apache/accumulo/pull/1765#discussion_r516362986", "bodyText": "Needs a @since 2.1.0 javadoc tag.", "author": "keith-turner", "createdAt": "2020-11-03T00:35:26Z", "path": "core/src/main/java/org/apache/accumulo/core/client/ScannerBase.java", "diffHunk": "@@ -356,4 +357,10 @@ default void fetchColumn(CharSequence colFam, CharSequence colQual) {\n   default void setExecutionHints(Map<String,String> hints) {\n     throw new UnsupportedOperationException();\n   }\n+\n+  default void forEach(BiConsumer<? super Key,? super Value> keyValueConsumer) {", "originalCommit": "5b60b8cb384c3cae7d3b5af9c5ecf9c1411d3225", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5f7d7007e483fe6ff528b55271fbdb566bca22c3", "url": "https://github.com/apache/accumulo/commit/5f7d7007e483fe6ff528b55271fbdb566bca22c3", "message": "Issue #1742 - Removed test in ScannerIT. Added standalone ScannerBase test.", "committedDate": "2020-11-10T12:10:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwMjQ3Mg==", "url": "https://github.com/apache/accumulo/pull/1765#discussion_r520702472", "bodyText": "You don't need to compare CF and CQ, you can compare Key equality directly. That will shorten the test code a bit. You also don't need to call toString() on anything.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  Map.Entry<Key,Value> expectedEntry = s.iterator().next();\n          \n          \n            \n                  Key expectedKey = expectedEntry.getKey();\n          \n          \n            \n                  Value expectedValue = expectedEntry.getValue();\n          \n          \n            \n            \n          \n          \n            \n                  String expectedCf = expectedKey.getColumnFamily().toString();\n          \n          \n            \n                  String actualCf = entry.getKey().getColumnFamily().toString();\n          \n          \n            \n            \n          \n          \n            \n                  String expectedCq = expectedKey.getColumnQualifier().toString();\n          \n          \n            \n                  String actualCq = entry.getKey().getColumnQualifier().toString();\n          \n          \n            \n            \n          \n          \n            \n                  String expectedVal = expectedValue.toString();\n          \n          \n            \n                  String actualVal = entry.getValue().toString();\n          \n          \n            \n            \n          \n          \n            \n                  assertEquals(expectedCf, actualCf);\n          \n          \n            \n                  assertEquals(expectedCq, actualCq);\n          \n          \n            \n                  assertEquals(expectedVal, actualVal);\n          \n          \n            \n                  Map.Entry<Key,Value> expectedEntry = s.iterator().next();\n          \n          \n            \n                  assertEquals(expectedEntry.getKey(), entry.getKey());\n          \n          \n            \n                  assertEquals(expectedEntry.getValue(), entry.getValue());", "author": "ctubbsii", "createdAt": "2020-11-10T16:34:35Z", "path": "core/src/test/java/org/apache/accumulo/core/clientImpl/ScannerBaseTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.clientImpl;\n+\n+import static org.easymock.EasyMock.createMock;\n+import static org.easymock.EasyMock.expect;\n+import static org.easymock.EasyMock.replay;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+\n+import org.apache.accumulo.core.client.ScannerBase;\n+import org.apache.accumulo.core.data.Key;\n+import org.apache.accumulo.core.data.Value;\n+import org.apache.hadoop.io.Text;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class ScannerBaseTest {\n+\n+  private ScannerBase s;\n+  private Map<Key,Value> scannerMap;\n+  private Iterator<Map.Entry<Key,Value>> it;\n+  private Key key;\n+  private Value val;\n+  private BiConsumer<Key,Value> keyValueConsumer;\n+  private forEachTester fet;\n+\n+  private static class forEachTester {\n+\n+    private Map<Key,Value> map;\n+\n+    forEachTester(Map<Key,Value> map) {\n+      this.map = map;\n+    }\n+\n+    public void forEach(BiConsumer<? super Key,? super Value> keyValueConsumer) {\n+      for (Map.Entry<Key,Value> entry : this.map.entrySet()) {\n+        keyValueConsumer.accept(entry.getKey(), entry.getValue());\n+      }\n+    }\n+  }\n+\n+  @Before\n+  public void setUp() throws Exception {\n+    s = createMock(ScannerBase.class);\n+  }\n+\n+  @Test\n+  public void testScannerBaseForEach() throws Exception {\n+    key = new Key(new Text(\"a\"), new Text(\"cf1\"), new Text(\"cq1\"));\n+    val = new Value(new Text(\"v1\"));\n+    scannerMap = new HashMap<>();\n+\n+    scannerMap.put(key, val);\n+\n+    fet = new forEachTester(scannerMap);\n+\n+    it = scannerMap.entrySet().iterator();\n+\n+    expect(s.iterator()).andReturn(it).times(3);\n+    replay(s);\n+\n+    Map<Key,Value> map = new HashMap<>();\n+\n+    class MyBiConsumer implements BiConsumer<Key,Value> {\n+      @Override\n+      public void accept(Key key, Value value) {\n+        map.put(key, value);\n+      }\n+    }\n+\n+    keyValueConsumer = new MyBiConsumer();\n+\n+    fet.forEach(keyValueConsumer);\n+\n+    // Test the Scanner values put into the map via keyValueConsumer\n+\n+    for (Map.Entry<Key,Value> entry : map.entrySet()) {\n+      Map.Entry<Key,Value> expectedEntry = s.iterator().next();\n+      Key expectedKey = expectedEntry.getKey();\n+      Value expectedValue = expectedEntry.getValue();\n+\n+      String expectedCf = expectedKey.getColumnFamily().toString();\n+      String actualCf = entry.getKey().getColumnFamily().toString();\n+\n+      String expectedCq = expectedKey.getColumnQualifier().toString();\n+      String actualCq = entry.getKey().getColumnQualifier().toString();\n+\n+      String expectedVal = expectedValue.toString();\n+      String actualVal = entry.getValue().toString();\n+\n+      assertEquals(expectedCf, actualCf);\n+      assertEquals(expectedCq, actualCq);\n+      assertEquals(expectedVal, actualVal);", "originalCommit": "5f7d7007e483fe6ff528b55271fbdb566bca22c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwNDAxNA==", "url": "https://github.com/apache/accumulo/pull/1765#discussion_r520704014", "bodyText": "I don't think most (if any) of these should be class members. They can be local variables in the test case.", "author": "ctubbsii", "createdAt": "2020-11-10T16:36:36Z", "path": "core/src/test/java/org/apache/accumulo/core/clientImpl/ScannerBaseTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.clientImpl;\n+\n+import static org.easymock.EasyMock.createMock;\n+import static org.easymock.EasyMock.expect;\n+import static org.easymock.EasyMock.replay;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+\n+import org.apache.accumulo.core.client.ScannerBase;\n+import org.apache.accumulo.core.data.Key;\n+import org.apache.accumulo.core.data.Value;\n+import org.apache.hadoop.io.Text;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class ScannerBaseTest {\n+\n+  private ScannerBase s;\n+  private Map<Key,Value> scannerMap;\n+  private Iterator<Map.Entry<Key,Value>> it;\n+  private Key key;\n+  private Value val;\n+  private BiConsumer<Key,Value> keyValueConsumer;\n+  private forEachTester fet;", "originalCommit": "5f7d7007e483fe6ff528b55271fbdb566bca22c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwNTQ1Mg==", "url": "https://github.com/apache/accumulo/pull/1765#discussion_r520705452", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Map<Key,Value> map = new HashMap<>();\n          \n          \n            \n            \n          \n          \n            \n                class MyBiConsumer implements BiConsumer<Key,Value> {\n          \n          \n            \n                  @Override\n          \n          \n            \n                  public void accept(Key key, Value value) {\n          \n          \n            \n                    map.put(key, value);\n          \n          \n            \n                  }\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                keyValueConsumer = new MyBiConsumer();\n          \n          \n            \n            \n          \n          \n            \n                fet.forEach(keyValueConsumer);\n          \n          \n            \n                Map<Key,Value> map = new HashMap<>();\n          \n          \n            \n                fet.forEach((k,v) -> map.put(k,v));", "author": "ctubbsii", "createdAt": "2020-11-10T16:38:38Z", "path": "core/src/test/java/org/apache/accumulo/core/clientImpl/ScannerBaseTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.clientImpl;\n+\n+import static org.easymock.EasyMock.createMock;\n+import static org.easymock.EasyMock.expect;\n+import static org.easymock.EasyMock.replay;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+\n+import org.apache.accumulo.core.client.ScannerBase;\n+import org.apache.accumulo.core.data.Key;\n+import org.apache.accumulo.core.data.Value;\n+import org.apache.hadoop.io.Text;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class ScannerBaseTest {\n+\n+  private ScannerBase s;\n+  private Map<Key,Value> scannerMap;\n+  private Iterator<Map.Entry<Key,Value>> it;\n+  private Key key;\n+  private Value val;\n+  private BiConsumer<Key,Value> keyValueConsumer;\n+  private forEachTester fet;\n+\n+  private static class forEachTester {\n+\n+    private Map<Key,Value> map;\n+\n+    forEachTester(Map<Key,Value> map) {\n+      this.map = map;\n+    }\n+\n+    public void forEach(BiConsumer<? super Key,? super Value> keyValueConsumer) {\n+      for (Map.Entry<Key,Value> entry : this.map.entrySet()) {\n+        keyValueConsumer.accept(entry.getKey(), entry.getValue());\n+      }\n+    }\n+  }\n+\n+  @Before\n+  public void setUp() throws Exception {\n+    s = createMock(ScannerBase.class);\n+  }\n+\n+  @Test\n+  public void testScannerBaseForEach() throws Exception {\n+    key = new Key(new Text(\"a\"), new Text(\"cf1\"), new Text(\"cq1\"));\n+    val = new Value(new Text(\"v1\"));\n+    scannerMap = new HashMap<>();\n+\n+    scannerMap.put(key, val);\n+\n+    fet = new forEachTester(scannerMap);\n+\n+    it = scannerMap.entrySet().iterator();\n+\n+    expect(s.iterator()).andReturn(it).times(3);\n+    replay(s);\n+\n+    Map<Key,Value> map = new HashMap<>();\n+\n+    class MyBiConsumer implements BiConsumer<Key,Value> {\n+      @Override\n+      public void accept(Key key, Value value) {\n+        map.put(key, value);\n+      }\n+    }\n+\n+    keyValueConsumer = new MyBiConsumer();\n+\n+    fet.forEach(keyValueConsumer);", "originalCommit": "5f7d7007e483fe6ff528b55271fbdb566bca22c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwNTcyMQ==", "url": "https://github.com/apache/accumulo/pull/1765#discussion_r520705721", "bodyText": "Should verify mock objects at the end of the test.", "author": "ctubbsii", "createdAt": "2020-11-10T16:39:03Z", "path": "core/src/test/java/org/apache/accumulo/core/clientImpl/ScannerBaseTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.clientImpl;\n+\n+import static org.easymock.EasyMock.createMock;\n+import static org.easymock.EasyMock.expect;\n+import static org.easymock.EasyMock.replay;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+\n+import org.apache.accumulo.core.client.ScannerBase;\n+import org.apache.accumulo.core.data.Key;\n+import org.apache.accumulo.core.data.Value;\n+import org.apache.hadoop.io.Text;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class ScannerBaseTest {\n+\n+  private ScannerBase s;\n+  private Map<Key,Value> scannerMap;\n+  private Iterator<Map.Entry<Key,Value>> it;\n+  private Key key;\n+  private Value val;\n+  private BiConsumer<Key,Value> keyValueConsumer;\n+  private forEachTester fet;\n+\n+  private static class forEachTester {\n+\n+    private Map<Key,Value> map;\n+\n+    forEachTester(Map<Key,Value> map) {\n+      this.map = map;\n+    }\n+\n+    public void forEach(BiConsumer<? super Key,? super Value> keyValueConsumer) {\n+      for (Map.Entry<Key,Value> entry : this.map.entrySet()) {\n+        keyValueConsumer.accept(entry.getKey(), entry.getValue());\n+      }\n+    }\n+  }\n+\n+  @Before\n+  public void setUp() throws Exception {\n+    s = createMock(ScannerBase.class);\n+  }\n+\n+  @Test\n+  public void testScannerBaseForEach() throws Exception {\n+    key = new Key(new Text(\"a\"), new Text(\"cf1\"), new Text(\"cq1\"));\n+    val = new Value(new Text(\"v1\"));\n+    scannerMap = new HashMap<>();\n+\n+    scannerMap.put(key, val);\n+\n+    fet = new forEachTester(scannerMap);\n+\n+    it = scannerMap.entrySet().iterator();\n+\n+    expect(s.iterator()).andReturn(it).times(3);\n+    replay(s);\n+\n+    Map<Key,Value> map = new HashMap<>();\n+\n+    class MyBiConsumer implements BiConsumer<Key,Value> {\n+      @Override\n+      public void accept(Key key, Value value) {\n+        map.put(key, value);\n+      }\n+    }\n+\n+    keyValueConsumer = new MyBiConsumer();\n+\n+    fet.forEach(keyValueConsumer);\n+\n+    // Test the Scanner values put into the map via keyValueConsumer\n+\n+    for (Map.Entry<Key,Value> entry : map.entrySet()) {\n+      Map.Entry<Key,Value> expectedEntry = s.iterator().next();\n+      Key expectedKey = expectedEntry.getKey();\n+      Value expectedValue = expectedEntry.getValue();\n+\n+      String expectedCf = expectedKey.getColumnFamily().toString();\n+      String actualCf = entry.getKey().getColumnFamily().toString();\n+\n+      String expectedCq = expectedKey.getColumnQualifier().toString();\n+      String actualCq = entry.getKey().getColumnQualifier().toString();\n+\n+      String expectedVal = expectedValue.toString();\n+      String actualVal = entry.getValue().toString();\n+\n+      assertEquals(expectedCf, actualCf);\n+      assertEquals(expectedCq, actualCq);\n+      assertEquals(expectedVal, actualVal);\n+    }", "originalCommit": "5f7d7007e483fe6ff528b55271fbdb566bca22c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwNjEyMA==", "url": "https://github.com/apache/accumulo/pull/1765#discussion_r520706120", "bodyText": "This can be done in the test. It doesn't need to be here, unless it's common code for multiple tests.", "author": "ctubbsii", "createdAt": "2020-11-10T16:39:34Z", "path": "core/src/test/java/org/apache/accumulo/core/clientImpl/ScannerBaseTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.clientImpl;\n+\n+import static org.easymock.EasyMock.createMock;\n+import static org.easymock.EasyMock.expect;\n+import static org.easymock.EasyMock.replay;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+\n+import org.apache.accumulo.core.client.ScannerBase;\n+import org.apache.accumulo.core.data.Key;\n+import org.apache.accumulo.core.data.Value;\n+import org.apache.hadoop.io.Text;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class ScannerBaseTest {\n+\n+  private ScannerBase s;\n+  private Map<Key,Value> scannerMap;\n+  private Iterator<Map.Entry<Key,Value>> it;\n+  private Key key;\n+  private Value val;\n+  private BiConsumer<Key,Value> keyValueConsumer;\n+  private forEachTester fet;\n+\n+  private static class forEachTester {\n+\n+    private Map<Key,Value> map;\n+\n+    forEachTester(Map<Key,Value> map) {\n+      this.map = map;\n+    }\n+\n+    public void forEach(BiConsumer<? super Key,? super Value> keyValueConsumer) {\n+      for (Map.Entry<Key,Value> entry : this.map.entrySet()) {\n+        keyValueConsumer.accept(entry.getKey(), entry.getValue());\n+      }\n+    }\n+  }\n+\n+  @Before\n+  public void setUp() throws Exception {\n+    s = createMock(ScannerBase.class);\n+  }", "originalCommit": "5f7d7007e483fe6ff528b55271fbdb566bca22c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "126c53fb1168faa72a1587bf2682663a3b10b12c", "url": "https://github.com/apache/accumulo/commit/126c53fb1168faa72a1587bf2682663a3b10b12c", "message": "Issue #1742 - Updated test.", "committedDate": "2020-11-10T19:24:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2OTExMg==", "url": "https://github.com/apache/accumulo/pull/1765#discussion_r520869112", "bodyText": "Didn't notice this before, but Java class names should start uppercase.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static class forEachTester {\n          \n          \n            \n              private static class ForEachTester {", "author": "ctubbsii", "createdAt": "2020-11-10T20:57:17Z", "path": "core/src/test/java/org/apache/accumulo/core/clientImpl/ScannerBaseTest.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.clientImpl;\n+\n+import static org.easymock.EasyMock.createMock;\n+import static org.easymock.EasyMock.expect;\n+import static org.easymock.EasyMock.replay;\n+import static org.easymock.EasyMock.verify;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+\n+import org.apache.accumulo.core.client.ScannerBase;\n+import org.apache.accumulo.core.data.Key;\n+import org.apache.accumulo.core.data.Value;\n+import org.apache.hadoop.io.Text;\n+import org.junit.Test;\n+\n+public class ScannerBaseTest {\n+\n+  private static class forEachTester {", "originalCommit": "126c53fb1168faa72a1587bf2682663a3b10b12c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg3NDY4Nw==", "url": "https://github.com/apache/accumulo/pull/1765#discussion_r520874687", "bodyText": "Later comment makes this suggestion unnecessary. The class isn't needed at all.", "author": "ctubbsii", "createdAt": "2020-11-10T21:08:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2OTExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg3MTYzNg==", "url": "https://github.com/apache/accumulo/pull/1765#discussion_r520871636", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                ScannerBase s;\n          \n          \n            \n                Map<Key,Value> scannerMap;\n          \n          \n            \n                Iterator<Map.Entry<Key,Value>> it;\n          \n          \n            \n                Key key;\n          \n          \n            \n                Value val;\n          \n          \n            \n                BiConsumer<Key,Value> keyValueConsumer;\n          \n          \n            \n                forEachTester fet;\n          \n          \n            \n            \n          \n          \n            \n                s = createMock(ScannerBase.class);\n          \n          \n            \n                key = new Key(new Text(\"a\"), new Text(\"cf1\"), new Text(\"cq1\"));\n          \n          \n            \n                val = new Value(new Text(\"v1\"));\n          \n          \n            \n                scannerMap = new HashMap<>();\n          \n          \n            \n            \n          \n          \n            \n                scannerMap.put(key, val);\n          \n          \n            \n            \n          \n          \n            \n                fet = new forEachTester(scannerMap);\n          \n          \n            \n            \n          \n          \n            \n                it = scannerMap.entrySet().iterator();\n          \n          \n            \n                ScannerBase s = createMock(ScannerBase.class);\n          \n          \n            \n                Map<Key,Value> scannerMap = new HashMap<>();\n          \n          \n            \n                scannerMap.put(new Key(new Text(\"a\"), new Text(\"cf1\"), new Text(\"cq1\")), new Value(new Text(\"v1\")));\n          \n          \n            \n                scannerMap.put(new Key(new Text(\"b\"), new Text(\"cf1\"), new Text(\"cq1\")), new Value(new Text(\"v2\")));\n          \n          \n            \n                ForEachTester fet = new ForEachTester(scannerMap);\n          \n          \n            \n            \n          \n          \n            \n                Iterator<Map.Entry<Key,Value>> it = scannerMap.entrySet().iterator();", "author": "ctubbsii", "createdAt": "2020-11-10T21:02:04Z", "path": "core/src/test/java/org/apache/accumulo/core/clientImpl/ScannerBaseTest.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.clientImpl;\n+\n+import static org.easymock.EasyMock.createMock;\n+import static org.easymock.EasyMock.expect;\n+import static org.easymock.EasyMock.replay;\n+import static org.easymock.EasyMock.verify;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+\n+import org.apache.accumulo.core.client.ScannerBase;\n+import org.apache.accumulo.core.data.Key;\n+import org.apache.accumulo.core.data.Value;\n+import org.apache.hadoop.io.Text;\n+import org.junit.Test;\n+\n+public class ScannerBaseTest {\n+\n+  private static class forEachTester {\n+\n+    private Map<Key,Value> map;\n+\n+    forEachTester(Map<Key,Value> map) {\n+      this.map = map;\n+    }\n+\n+    public void forEach(BiConsumer<? super Key,? super Value> keyValueConsumer) {\n+      for (Map.Entry<Key,Value> entry : this.map.entrySet()) {\n+        keyValueConsumer.accept(entry.getKey(), entry.getValue());\n+      }\n+    }\n+  }\n+\n+  @Test\n+  public void testScannerBaseForEach() throws Exception {\n+\n+    ScannerBase s;\n+    Map<Key,Value> scannerMap;\n+    Iterator<Map.Entry<Key,Value>> it;\n+    Key key;\n+    Value val;\n+    BiConsumer<Key,Value> keyValueConsumer;\n+    forEachTester fet;\n+\n+    s = createMock(ScannerBase.class);\n+    key = new Key(new Text(\"a\"), new Text(\"cf1\"), new Text(\"cq1\"));\n+    val = new Value(new Text(\"v1\"));\n+    scannerMap = new HashMap<>();\n+\n+    scannerMap.put(key, val);\n+\n+    fet = new forEachTester(scannerMap);\n+\n+    it = scannerMap.entrySet().iterator();", "originalCommit": "126c53fb1168faa72a1587bf2682663a3b10b12c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg3MzUxNA==", "url": "https://github.com/apache/accumulo/pull/1765#discussion_r520873514", "bodyText": "After simplifying a bit myself, it seems like that the forEach concept is being tested on the ForEachTester object, but the test is never actually calling the ScannerBase.forEach method... which is the method that this test case should be covering.\nIt would be better if ScannerBase was a partial mock... overriding iterator() (as you've already done), but leaving the implementation of forEach alone, and calling that in your test. The ForEachTester class doesn't seem necessary at all. It can simply be deleted.", "author": "ctubbsii", "createdAt": "2020-11-10T21:05:50Z", "path": "core/src/test/java/org/apache/accumulo/core/clientImpl/ScannerBaseTest.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.core.clientImpl;\n+\n+import static org.easymock.EasyMock.createMock;\n+import static org.easymock.EasyMock.expect;\n+import static org.easymock.EasyMock.replay;\n+import static org.easymock.EasyMock.verify;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+\n+import org.apache.accumulo.core.client.ScannerBase;\n+import org.apache.accumulo.core.data.Key;\n+import org.apache.accumulo.core.data.Value;\n+import org.apache.hadoop.io.Text;\n+import org.junit.Test;\n+\n+public class ScannerBaseTest {\n+\n+  private static class forEachTester {\n+\n+    private Map<Key,Value> map;\n+\n+    forEachTester(Map<Key,Value> map) {\n+      this.map = map;\n+    }\n+\n+    public void forEach(BiConsumer<? super Key,? super Value> keyValueConsumer) {\n+      for (Map.Entry<Key,Value> entry : this.map.entrySet()) {\n+        keyValueConsumer.accept(entry.getKey(), entry.getValue());\n+      }\n+    }\n+  }\n+\n+  @Test\n+  public void testScannerBaseForEach() throws Exception {\n+\n+    ScannerBase s;\n+    Map<Key,Value> scannerMap;\n+    Iterator<Map.Entry<Key,Value>> it;\n+    Key key;\n+    Value val;\n+    BiConsumer<Key,Value> keyValueConsumer;\n+    forEachTester fet;\n+\n+    s = createMock(ScannerBase.class);\n+    key = new Key(new Text(\"a\"), new Text(\"cf1\"), new Text(\"cq1\"));\n+    val = new Value(new Text(\"v1\"));\n+    scannerMap = new HashMap<>();\n+\n+    scannerMap.put(key, val);\n+\n+    fet = new forEachTester(scannerMap);\n+\n+    it = scannerMap.entrySet().iterator();\n+\n+    expect(s.iterator()).andReturn(it).times(1);\n+    replay(s);\n+\n+    Map<Key,Value> map = new HashMap<>();\n+    fet.forEach(map::put);", "originalCommit": "126c53fb1168faa72a1587bf2682663a3b10b12c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dc1755fdec7b0366f738f6b0e2db73f16b21d776", "url": "https://github.com/apache/accumulo/commit/dc1755fdec7b0366f738f6b0e2db73f16b21d776", "message": "Issue #1742 - Removed mocks. Created ScannerBase subclass for test.", "committedDate": "2020-11-17T18:49:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQyMjQ5OQ==", "url": "https://github.com/apache/accumulo/pull/1765#discussion_r525422499", "bodyText": "Extending List forces you to add implementations for a bunch of methods. You can just implement ScannerBase, and have a constructor that takes a map, which itself is easily constructed, using Map.of(...). MockScanner's iterator() method can just return map.entrySet().iterator().", "author": "ctubbsii", "createdAt": "2020-11-17T19:16:05Z", "path": "core/src/test/java/org/apache/accumulo/core/clientImpl/ScannerBaseTest.java", "diffHunk": "@@ -20,71 +20,121 @@\n \n import static org.easymock.EasyMock.createMock;\n import static org.easymock.EasyMock.expect;\n+import static org.easymock.EasyMock.expectLastCall;\n+import static org.easymock.EasyMock.partialMockBuilder;\n import static org.easymock.EasyMock.replay;\n import static org.easymock.EasyMock.verify;\n import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n \n+import java.awt.*;\n+import java.util.ArrayList;\n import java.util.HashMap;\n import java.util.Iterator;\n import java.util.Map;\n+import java.util.Scanner;\n+import java.util.concurrent.TimeUnit;\n import java.util.function.BiConsumer;\n \n+import org.apache.accumulo.core.client.AccumuloClient;\n+import org.apache.accumulo.core.client.IteratorSetting;\n import org.apache.accumulo.core.client.ScannerBase;\n+import org.apache.accumulo.core.client.sample.SamplerConfiguration;\n import org.apache.accumulo.core.data.Key;\n import org.apache.accumulo.core.data.Value;\n+import org.apache.accumulo.core.security.Authorizations;\n import org.apache.hadoop.io.Text;\n+import org.apache.hadoop.shaded.org.mockito.Mockito;\n+import org.easymock.EasyMock;\n import org.junit.Test;\n \n public class ScannerBaseTest {\n \n-  private static class forEachTester {\n-\n-    private Map<Key,Value> map;\n-\n-    forEachTester(Map<Key,Value> map) {\n-      this.map = map;\n-    }\n-\n-    public void forEach(BiConsumer<? super Key,? super Value> keyValueConsumer) {\n-      for (Map.Entry<Key,Value> entry : this.map.entrySet()) {\n-        keyValueConsumer.accept(entry.getKey(), entry.getValue());\n-      }\n-    }\n-  }\n-\n   @Test\n   public void testScannerBaseForEach() throws Exception {\n \n-    ScannerBase s;\n-    Map<Key,Value> scannerMap;\n-    Iterator<Map.Entry<Key,Value>> it;\n-    Key key;\n-    Value val;\n-    BiConsumer<Key,Value> keyValueConsumer;\n-    forEachTester fet;\n+    //This subclass of ScannerBase contains a List that ScannerBase.forEach() can\n+    //iterate over for testing purposes.\n+    class MockScanner extends List implements ScannerBase {", "originalCommit": "dc1755fdec7b0366f738f6b0e2db73f16b21d776", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "339d1ad06896f299eb54847707bdf69229e45adf", "url": "https://github.com/apache/accumulo/commit/339d1ad06896f299eb54847707bdf69229e45adf", "message": "Issue #1742 - Removed List/added Map to test object.", "committedDate": "2020-11-18T11:40:53Z", "type": "commit"}]}