{"pr_number": 1568, "pr_title": "Support multiple tservers / node in accumulo-service", "pr_createdAt": "2020-03-21T02:21:03Z", "pr_url": "https://github.com/apache/accumulo/pull/1568", "timeline": [{"oid": "3d91d5c32960401df1d1c196213fc0184d9bade5", "url": "https://github.com/apache/accumulo/commit/3d91d5c32960401df1d1c196213fc0184d9bade5", "message": "Support multiple tservers / node in helper scripts\n\nEnhances accumulo-cluster to start multiple TServers / node if\nNUM_TSERVERS is exported (outside of accumulo-env.sh). Corresponding\nchanges in accumulo.properties (tserver.port.search and\nreplication.receipt.service.port) are still needed.", "committedDate": "2020-03-25T01:17:56Z", "type": "forcePushed"}, {"oid": "4ff3ae3892f10f434433f878fe66f7122ab98a46", "url": "https://github.com/apache/accumulo/commit/4ff3ae3892f10f434433f878fe66f7122ab98a46", "message": "Support multiple tservers / node in helper scripts\n\nEnhances accumulo-cluster to start multiple TServers / node if\nNUM_TSERVERS is exported (outside of accumulo-env.sh). Corresponding\nchanges in accumulo.properties (tserver.port.search and\nreplication.receipt.service.port) are still needed.", "committedDate": "2020-03-25T02:34:39Z", "type": "commit"}, {"oid": "4ff3ae3892f10f434433f878fe66f7122ab98a46", "url": "https://github.com/apache/accumulo/commit/4ff3ae3892f10f434433f878fe66f7122ab98a46", "message": "Support multiple tservers / node in helper scripts\n\nEnhances accumulo-cluster to start multiple TServers / node if\nNUM_TSERVERS is exported (outside of accumulo-env.sh). Corresponding\nchanges in accumulo.properties (tserver.port.search and\nreplication.receipt.service.port) are still needed.", "committedDate": "2020-03-25T02:34:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyMzgzMg==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r397923832", "bodyText": "Not sure the following will work, the thought is to make running on localhost and remote consistent.  Both ensuring the env var is not set when running the script.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                service_instance_cmd=\n          \n          \n            \n                service_instance_cmd=\"export ACCUMULO_SERVICE_INSTANCE=;\"", "author": "keith-turner", "createdAt": "2020-03-25T15:00:34Z", "path": "assemble/bin/accumulo-cluster", "diffHunk": "@@ -100,15 +100,45 @@ function get_ip() {\n   echo \"$ip_addr\"\n }\n \n+function set_last_instance_id() {\n+  if [[ \"$service\" == \"tserver\" ]]; then\n+    last_instance_id=${NUM_TSERVERS:-1}\n+  else\n+    last_instance_id=1\n+  fi\n+}\n+\n+function set_service_instance_if_needed() {\n+  if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} > 1 ]]; then\n+    export ACCUMULO_SERVICE_INSTANCE=$inst_id\n+    service_instance_cmd=\"export ACCUMULO_SERVICE_INSTANCE=${inst_id};\"\n+  else\n+    export ACCUMULO_SERVICE_INSTANCE=\n+    service_instance_cmd=", "originalCommit": "4ff3ae3892f10f434433f878fe66f7122ab98a46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODExMzE0MA==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398113140", "bodyText": "Will consider and implement. Thanks!", "author": "arvindshmicrosoft", "createdAt": "2020-03-25T19:26:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyMzgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA3NjM4MQ==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r399076381", "bodyText": "Thanks Keith. With the suggestions that Christopher made, this has been handled in a different way now. Please take a look.", "author": "arvindshmicrosoft", "createdAt": "2020-03-27T07:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyMzgzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2MjQ0OA==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r399562448", "bodyText": "Those changes look good and consistent.", "author": "keith-turner", "createdAt": "2020-03-27T22:15:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyMzgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA1ODE5MA==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398058190", "bodyText": "This mixes double equals and single equals. Both are equivalent in bash double-square braces, so it's fine either way, but it'd be nice to be consistent.", "author": "ctubbsii", "createdAt": "2020-03-25T17:57:41Z", "path": "assemble/bin/accumulo-cluster", "diffHunk": "@@ -100,15 +100,45 @@ function get_ip() {\n   echo \"$ip_addr\"\n }\n \n+function set_last_instance_id() {\n+  if [[ \"$service\" == \"tserver\" ]]; then\n+    last_instance_id=${NUM_TSERVERS:-1}\n+  else\n+    last_instance_id=1\n+  fi\n+}\n+\n+function set_service_instance_if_needed() {\n+  if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} > 1 ]]; then\n+    export ACCUMULO_SERVICE_INSTANCE=$inst_id\n+    service_instance_cmd=\"export ACCUMULO_SERVICE_INSTANCE=${inst_id};\"\n+  else\n+    export ACCUMULO_SERVICE_INSTANCE=\n+    service_instance_cmd=\n+  fi\n+}\n+\n+function control_service() {\n+  set_last_instance_id\n+\n+  for (( inst_id=1; inst_id<=last_instance_id; inst_id++ ))\n+  do\n+    set_service_instance_if_needed\n+\n+    if [[ $host == localhost || $host = \"$(hostname -s)\" || $host = \"$(hostname -f)\" || $host = $(get_ip) ]] ; then", "originalCommit": "4ff3ae3892f10f434433f878fe66f7122ab98a46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODExMzUzOQ==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398113539", "bodyText": "Cool! Since this was existing code, I did not pay attention. I will address it.", "author": "arvindshmicrosoft", "createdAt": "2020-03-25T19:26:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA1ODE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODEyMTQ1MQ==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398121451", "bodyText": "I didn't notice it was existing code. It's fine if you want to leave it. It's entirely up to you.", "author": "ctubbsii", "createdAt": "2020-03-25T19:40:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA1ODE5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA2OTgzNQ==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398069835", "bodyText": "Could use a simple local variable here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              set_last_instance_id\n          \n          \n            \n              local last_instance_id; last_instance_id=1\n          \n          \n            \n              [[ \"$service\" = \"tserver\" ]] && last_instance_id=${NUM_TSERVERS:-1}", "author": "ctubbsii", "createdAt": "2020-03-25T18:15:11Z", "path": "assemble/bin/accumulo-cluster", "diffHunk": "@@ -100,15 +100,45 @@ function get_ip() {\n   echo \"$ip_addr\"\n }\n \n+function set_last_instance_id() {\n+  if [[ \"$service\" == \"tserver\" ]]; then\n+    last_instance_id=${NUM_TSERVERS:-1}\n+  else\n+    last_instance_id=1\n+  fi\n+}\n+\n+function set_service_instance_if_needed() {\n+  if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} > 1 ]]; then\n+    export ACCUMULO_SERVICE_INSTANCE=$inst_id\n+    service_instance_cmd=\"export ACCUMULO_SERVICE_INSTANCE=${inst_id};\"\n+  else\n+    export ACCUMULO_SERVICE_INSTANCE=\n+    service_instance_cmd=\n+  fi\n+}\n+\n+function control_service() {\n+  set_last_instance_id", "originalCommit": "4ff3ae3892f10f434433f878fe66f7122ab98a46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3MDU3Mw==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398070573", "bodyText": "This can be inline'd. It's only used once, and doesn't do much.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n            function set_last_instance_id() {\n          \n          \n            \n              if [[ \"$service\" == \"tserver\" ]]; then\n          \n          \n            \n                last_instance_id=${NUM_TSERVERS:-1}\n          \n          \n            \n              else\n          \n          \n            \n                last_instance_id=1\n          \n          \n            \n              fi\n          \n          \n            \n            }", "author": "ctubbsii", "createdAt": "2020-03-25T18:16:17Z", "path": "assemble/bin/accumulo-cluster", "diffHunk": "@@ -100,15 +100,45 @@ function get_ip() {\n   echo \"$ip_addr\"\n }\n \n+function set_last_instance_id() {\n+  if [[ \"$service\" == \"tserver\" ]]; then\n+    last_instance_id=${NUM_TSERVERS:-1}\n+  else\n+    last_instance_id=1\n+  fi\n+}\n+", "originalCommit": "4ff3ae3892f10f434433f878fe66f7122ab98a46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3MTE5NQ==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398071195", "bodyText": "Should use numeric greater-than comparison here, instead of ASCII lexical comparison:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} > 1 ]]; then\n          \n          \n            \n              if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} -gt 1 ]]; then", "author": "ctubbsii", "createdAt": "2020-03-25T18:17:13Z", "path": "assemble/bin/accumulo-cluster", "diffHunk": "@@ -100,15 +100,45 @@ function get_ip() {\n   echo \"$ip_addr\"\n }\n \n+function set_last_instance_id() {\n+  if [[ \"$service\" == \"tserver\" ]]; then\n+    last_instance_id=${NUM_TSERVERS:-1}\n+  else\n+    last_instance_id=1\n+  fi\n+}\n+\n+function set_service_instance_if_needed() {\n+  if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} > 1 ]]; then", "originalCommit": "4ff3ae3892f10f434433f878fe66f7122ab98a46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODExMzk0OA==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398113948", "bodyText": "Thanks. I had run shellcheck initially but forgot to run it before pushing this round of updates. Indeed that caught this issue as well. I'll make sure I fix it.", "author": "arvindshmicrosoft", "createdAt": "2020-03-25T19:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3MTE5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODEyMDgzMA==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398120830", "bodyText": "I saw you already fixed the \"unnecesarry $ in math expression\" issue. shellcheck is awesome, isn't it? \ud83d\ude3a", "author": "ctubbsii", "createdAt": "2020-03-25T19:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3MTE5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3MzEyNg==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398073126", "bodyText": "Instead of creating a second variable and exporting here, you can probably just execute it with the environment variable set for the execution:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  $SSH \"$host\" \"bash -c '${service_instance_cmd} ${bin}/accumulo-service \\\"$service\\\" \\\"$control_cmd\\\"'\"\n          \n          \n            \n                  $SSH \"$host\" \"bash -c 'ACCUMULO_SERVICE_INSTANCE='\"$ACCUMULO_SERVICE_INSTANCE\"' ${bin}/accumulo-service \\\"$service\\\" \\\"$control_cmd\\\"'\"", "author": "ctubbsii", "createdAt": "2020-03-25T18:20:07Z", "path": "assemble/bin/accumulo-cluster", "diffHunk": "@@ -100,15 +100,45 @@ function get_ip() {\n   echo \"$ip_addr\"\n }\n \n+function set_last_instance_id() {\n+  if [[ \"$service\" == \"tserver\" ]]; then\n+    last_instance_id=${NUM_TSERVERS:-1}\n+  else\n+    last_instance_id=1\n+  fi\n+}\n+\n+function set_service_instance_if_needed() {\n+  if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} > 1 ]]; then\n+    export ACCUMULO_SERVICE_INSTANCE=$inst_id\n+    service_instance_cmd=\"export ACCUMULO_SERVICE_INSTANCE=${inst_id};\"\n+  else\n+    export ACCUMULO_SERVICE_INSTANCE=\n+    service_instance_cmd=\n+  fi\n+}\n+\n+function control_service() {\n+  set_last_instance_id\n+\n+  for (( inst_id=1; inst_id<=last_instance_id; inst_id++ ))\n+  do\n+    set_service_instance_if_needed\n+\n+    if [[ $host == localhost || $host = \"$(hostname -s)\" || $host = \"$(hostname -f)\" || $host = $(get_ip) ]] ; then\n+      \"${bin}/accumulo-service\" \"$service\" \"$control_cmd\"\n+    else\n+      $SSH \"$host\" \"bash -c '${service_instance_cmd} ${bin}/accumulo-service \\\"$service\\\" \\\"$control_cmd\\\"'\"", "originalCommit": "4ff3ae3892f10f434433f878fe66f7122ab98a46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODEyMDI3Nw==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398120277", "bodyText": "Ah - I think the usage of the semicolon in my script was the reason the variable was not visible within the accumulo-service script. I guess I was going off the syntax in the docs which has a semicolon between the ACCUMULO_SEVICE_INSTANCE variable and the accumulo script. I wonder now if that is a typo which needs to be addressed?", "author": "arvindshmicrosoft", "createdAt": "2020-03-25T19:38:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3MzEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE2MDg2Nw==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398160867", "bodyText": "Ah, yeah, that's definitely a typo in the docs. I'll fix that.", "author": "ctubbsii", "createdAt": "2020-03-25T20:51:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3MzEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE2MjM4NQ==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398162385", "bodyText": "The docs will further need to be updated to mention the use of NUM_TSERVERS for 2.1 and later, once this PR gets merged.", "author": "ctubbsii", "createdAt": "2020-03-25T20:53:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3MzEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIzNTA1Nw==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398235057", "bodyText": "Thank you and I did plan to submit a docs PR for NUM_TSERVERS usage when this change is done.", "author": "arvindshmicrosoft", "createdAt": "2020-03-25T23:38:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3MzEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA3NTY5OQ==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r399075699", "bodyText": "The changes have been done - please review when you have a chance.", "author": "arvindshmicrosoft", "createdAt": "2020-03-27T07:22:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3MzEyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA3NDg2MQ==", "url": "https://github.com/apache/accumulo/pull/1568#discussion_r398074861", "bodyText": "Could pass the arguments to the function instead of setting up global variables and picking them up in the function.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              control_service\n          \n          \n            \n              control_service start \"$@\"", "author": "ctubbsii", "createdAt": "2020-03-25T18:22:47Z", "path": "assemble/bin/accumulo-cluster", "diffHunk": "@@ -100,15 +100,45 @@ function get_ip() {\n   echo \"$ip_addr\"\n }\n \n+function set_last_instance_id() {\n+  if [[ \"$service\" == \"tserver\" ]]; then\n+    last_instance_id=${NUM_TSERVERS:-1}\n+  else\n+    last_instance_id=1\n+  fi\n+}\n+\n+function set_service_instance_if_needed() {\n+  if [[ \"$service\" == \"tserver\" && ${NUM_TSERVERS:-1} > 1 ]]; then\n+    export ACCUMULO_SERVICE_INSTANCE=$inst_id\n+    service_instance_cmd=\"export ACCUMULO_SERVICE_INSTANCE=${inst_id};\"\n+  else\n+    export ACCUMULO_SERVICE_INSTANCE=\n+    service_instance_cmd=\n+  fi\n+}\n+\n+function control_service() {\n+  set_last_instance_id\n+\n+  for (( inst_id=1; inst_id<=last_instance_id; inst_id++ ))\n+  do\n+    set_service_instance_if_needed\n+\n+    if [[ $host == localhost || $host = \"$(hostname -s)\" || $host = \"$(hostname -f)\" || $host = $(get_ip) ]] ; then\n+      \"${bin}/accumulo-service\" \"$service\" \"$control_cmd\"\n+    else\n+      $SSH \"$host\" \"bash -c '${service_instance_cmd} ${bin}/accumulo-service \\\"$service\\\" \\\"$control_cmd\\\"'\"\n+    fi\n+  done\n+}\n+\n function start_service() {\n   host=\"$1\"\n   service=\"$2\"\n+  control_cmd=\"start\"\n \n-  if [[ $host == \"localhost\" || $host == $(hostname -f) || $host == $(hostname -s) || $host == $(get_ip) ]]; then\n-    \"${bin}/accumulo-service\" \"$service\" start\n-  else\n-    $SSH \"$host\" \"bash -c '${bin}/accumulo-service \\\"$service\\\" start'\"\n-  fi\n+  control_service", "originalCommit": "4ff3ae3892f10f434433f878fe66f7122ab98a46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3e2fa5f59396eca7eb86d0af02e169b60692fae8", "url": "https://github.com/apache/accumulo/commit/3e2fa5f59396eca7eb86d0af02e169b60692fae8", "message": "Address code review comments\n\n* Inline trivial functions within accumulo-cluster\n* Use numeric comparison correctly and double equals consistently\n* Efficiently pass ACCUMULO_SERVICE_INSTANCE to SSH connections\n* Adds accumulo.metrics.service.instance to accumulo-env.sh to ensure\n  that metrics for different TServers are correctly identified", "committedDate": "2020-03-27T07:19:26Z", "type": "commit"}]}