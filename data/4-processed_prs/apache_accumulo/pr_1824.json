{"pr_number": 1824, "pr_title": "Upgrade to jline3", "pr_createdAt": "2020-12-04T19:11:00Z", "pr_url": "https://github.com/apache/accumulo/pull/1824", "timeline": [{"oid": "152e5bc99eea54ff151fc1d224f7d4fb6ed5689a", "url": "https://github.com/apache/accumulo/commit/152e5bc99eea54ff151fc1d224f7d4fb6ed5689a", "message": "Optimizations, more changes based on jline3 javadocs", "committedDate": "2020-12-11T12:53:46Z", "type": "forcePushed"}, {"oid": "c6b3935fdea467464230548a3be7ba89d3f49280", "url": "https://github.com/apache/accumulo/commit/c6b3935fdea467464230548a3be7ba89d3f49280", "message": "fix conflict", "committedDate": "2020-12-11T12:56:44Z", "type": "commit"}, {"oid": "da17a92286e640f035814aff5b45b852e10395b9", "url": "https://github.com/apache/accumulo/commit/da17a92286e640f035814aff5b45b852e10395b9", "message": "minor changes", "committedDate": "2020-12-11T12:56:53Z", "type": "commit"}, {"oid": "b5c390d56a04ee19d9ea1955a1092b13130080b4", "url": "https://github.com/apache/accumulo/commit/b5c390d56a04ee19d9ea1955a1092b13130080b4", "message": "changes from mailing list suggestions", "committedDate": "2020-12-11T12:56:53Z", "type": "commit"}, {"oid": "b7e52752033b07fe6ccc6230c04b042fb2c9df99", "url": "https://github.com/apache/accumulo/commit/b7e52752033b07fe6ccc6230c04b042fb2c9df99", "message": "changes from testing", "committedDate": "2020-12-11T12:56:53Z", "type": "commit"}, {"oid": "cfdcae9ce1883be9d82789dedb3961efb0bb7f1e", "url": "https://github.com/apache/accumulo/commit/cfdcae9ce1883be9d82789dedb3961efb0bb7f1e", "message": "Optimizations, more changes based on jline3 javadocs", "committedDate": "2020-12-11T12:56:53Z", "type": "commit"}, {"oid": "cfdcae9ce1883be9d82789dedb3961efb0bb7f1e", "url": "https://github.com/apache/accumulo/commit/cfdcae9ce1883be9d82789dedb3961efb0bb7f1e", "message": "Optimizations, more changes based on jline3 javadocs", "committedDate": "2020-12-11T12:56:53Z", "type": "forcePushed"}, {"oid": "ce6bdcc47470cce89d2ad71185456fd841bf8de1", "url": "https://github.com/apache/accumulo/commit/ce6bdcc47470cce89d2ad71185456fd841bf8de1", "message": "fix build error", "committedDate": "2020-12-11T13:27:58Z", "type": "commit"}, {"oid": "a0363d04a800c54c1ee23c3730794542c318d170", "url": "https://github.com/apache/accumulo/commit/a0363d04a800c54c1ee23c3730794542c318d170", "message": "fix clear command. Add some reader opts", "committedDate": "2020-12-11T14:14:32Z", "type": "commit"}, {"oid": "ccc78af60a4d1fe76cba251a1cc856cb3b54372f", "url": "https://github.com/apache/accumulo/commit/ccc78af60a4d1fe76cba251a1cc856cb3b54372f", "message": "fix build error, work on more missing pieces", "committedDate": "2020-12-11T15:52:57Z", "type": "commit"}, {"oid": "756cf19bfdd90de6207403a04d59810e15b77ac4", "url": "https://github.com/apache/accumulo/commit/756cf19bfdd90de6207403a04d59810e15b77ac4", "message": "small changes for testing", "committedDate": "2020-12-14T18:22:01Z", "type": "commit"}, {"oid": "89ae18c30eb2010656dc85c5d1d0f1fef1a555e3", "url": "https://github.com/apache/accumulo/commit/89ae18c30eb2010656dc85c5d1d0f1fef1a555e3", "message": "fix history by disabling timestamp requirment", "committedDate": "2020-12-22T17:24:10Z", "type": "commit"}, {"oid": "7accc062ce4a7c60a6e243214402bfe93f159e4c", "url": "https://github.com/apache/accumulo/commit/7accc062ce4a7c60a6e243214402bfe93f159e4c", "message": "Merge branch 'main' of https://github.com/apache/accumulo into upgrade_to_Jline3", "committedDate": "2020-12-22T17:44:36Z", "type": "commit"}, {"oid": "14fd3a474ac0ee44837f9ddbecfdd4af8922d160", "url": "https://github.com/apache/accumulo/commit/14fd3a474ac0ee44837f9ddbecfdd4af8922d160", "message": "Merge branch 'main' of https://github.com/apache/accumulo into upgrade_to_Jline3", "committedDate": "2020-12-28T12:03:55Z", "type": "commit"}, {"oid": "041e2c5debcf094ca92f1d09d4ec2c97407b398c", "url": "https://github.com/apache/accumulo/commit/041e2c5debcf094ca92f1d09d4ec2c97407b398c", "message": "formatting and removal of commented code", "committedDate": "2020-12-29T13:25:45Z", "type": "commit"}, {"oid": "35ea10f3ff3f5256e3eb6be22ea2e73e868fcac9", "url": "https://github.com/apache/accumulo/commit/35ea10f3ff3f5256e3eb6be22ea2e73e868fcac9", "message": "fix help command so quits on 'q' properly", "committedDate": "2020-12-29T17:03:23Z", "type": "commit"}, {"oid": "2b2cf4767e813382d3e21785095d3293e4f0ffea", "url": "https://github.com/apache/accumulo/commit/2b2cf4767e813382d3e21785095d3293e4f0ffea", "message": "formatting and removal of more comments", "committedDate": "2020-12-29T17:25:19Z", "type": "commit"}, {"oid": "025276b4dda385c3aea7482a424215a4f4f48b04", "url": "https://github.com/apache/accumulo/commit/025276b4dda385c3aea7482a424215a4f4f48b04", "message": "fix clear command/test and history command test", "committedDate": "2020-12-30T18:45:38Z", "type": "commit"}, {"oid": "17bc02be94ec693847c4dbf78d837bf08b1cd637", "url": "https://github.com/apache/accumulo/commit/17bc02be94ec693847c4dbf78d837bf08b1cd637", "message": "fix history command test", "committedDate": "2021-01-05T14:20:05Z", "type": "commit"}, {"oid": "4c225e01f4aa8fb8de16bee5d6013207665c7035", "url": "https://github.com/apache/accumulo/commit/4c225e01f4aa8fb8de16bee5d6013207665c7035", "message": "fix SetIterCommand test", "committedDate": "2021-01-05T15:03:38Z", "type": "commit"}, {"oid": "ccb92114d9ae1cc60a3f0c65a9a6a3ced3509ebe", "url": "https://github.com/apache/accumulo/commit/ccb92114d9ae1cc60a3f0c65a9a6a3ced3509ebe", "message": "add assumption so github QA will pass", "committedDate": "2021-01-05T16:02:00Z", "type": "commit"}, {"oid": "61a1755547fc0f9fd6290eb4abe704b775657618", "url": "https://github.com/apache/accumulo/commit/61a1755547fc0f9fd6290eb4abe704b775657618", "message": "get everything read for review", "committedDate": "2021-01-05T18:13:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjc1NTA3MQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r552755071", "bodyText": "Does anyone know why the print statements are like this as opposed to one/fewer prints with linebreaks (\\n). It seems as though there might be a reason printlns are used in this way, but it seems like it would be cleaner to consolidate this text into less prints if possible. I see that it was this way before this PR so its not quite related but I was just curious.", "author": "DomGarguilo", "createdAt": "2021-01-06T16:11:19Z", "path": "server/base/src/main/java/org/apache/accumulo/server/init/Initialize.java", "diffHunk": "@@ -271,19 +273,23 @@ static boolean checkInit(VolumeManager fs, SiteConfiguration sconf, Configuratio\n       return false;\n     }\n     if (sconf.get(Property.INSTANCE_SECRET).equals(Property.INSTANCE_SECRET.getDefaultValue())) {\n-      ConsoleReader c = getConsoleReader();\n-      c.beep();\n-      c.println();\n-      c.println();\n-      c.println(\"Warning!!! Your instance secret is still set to the default,\"\n-          + \" this is not secure. We highly recommend you change it.\");\n-      c.println();\n-      c.println();\n-      c.println(\"You can change the instance secret in accumulo by using:\");\n-      c.println(\"   bin/accumulo \" + org.apache.accumulo.server.util.ChangeSecret.class.getName());\n-      c.println(\"You will also need to edit your secret in your configuration\"\n-          + \" file by adding the property instance.secret to your\"\n-          + \" accumulo.properties. Without this accumulo will not operate\" + \" correctly\");\n+      LineReader c = getLineReader();\n+      c.getTerminal().puts(InfoCmp.Capability.bell);\n+      c.getTerminal().writer().println();", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjgzODExMg==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r552838112", "bodyText": "Sometimes this is done for readability, sometimes to reuse a buffer for performance to avoid unnecessary string concatenation (as in StringBuilder append methods), and sometimes to defer to environment-specific implementations (like cross-platform newline differences). It could also just be more convenient for a developer to copy/paste as many println calls as they want, rather than edit in a specific number of \\n in several different String literals.\nI'm not sure why it's used this way in this particular case, but probably some combination of readability and developer convenience. But, it probably also makes sense in this case to defer to the terminal's environment-specific implementation, since the terminal itself is intended as an abstraction around the command-line environment.", "author": "ctubbsii", "createdAt": "2021-01-06T17:30:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjc1NTA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg1MjE1NA==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r552852154", "bodyText": "Okay great. Thanks for the explanation.", "author": "DomGarguilo", "createdAt": "2021-01-06T17:46:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjc1NTA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjkwNTYwOQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r552905609", "bodyText": "Could the portion before && be replaced with more?  I know this is unrelated but thought I would point it out.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    delete = line != null && (line.equalsIgnoreCase(\"y\") || line.equalsIgnoreCase(\"yes\"));\n          \n          \n            \n                    delete = more && (line.equalsIgnoreCase(\"y\") || line.equalsIgnoreCase(\"yes\"));", "author": "DomGarguilo", "createdAt": "2021-01-06T19:01:10Z", "path": "shell/src/main/java/org/apache/accumulo/shell/format/DeleterFormatter.java", "diffHunk": "@@ -79,33 +79,36 @@ public String next() {\n     Mutation m = new Mutation(key.getRow());\n     String entryStr = formatEntry(next, isDoTimestamps());\n     boolean delete = force;\n-    try {\n-      if (!force) {\n-        shellState.getReader().flush();\n+    if (!force) {\n+      try {\n+        shellState.getWriter().flush();\n+        // this will cause end of file Exception for one of the formatter tests\n         String line = shellState.getReader().readLine(\"Delete { \" + entryStr + \" } ? \");\n         more = line != null;\n         delete = line != null && (line.equalsIgnoreCase(\"y\") || line.equalsIgnoreCase(\"yes\"));", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njc0NDcyNQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r566744725", "bodyText": "I will add this. Sorry for the overlook.", "author": "Manno15", "createdAt": "2021-01-29T11:05:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjkwNTYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDc0ODU2MQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564748561", "bodyText": "I suggest adding a log.warn or log.error here to capture the exception within the logs.", "author": "lbschanno", "createdAt": "2021-01-26T18:47:30Z", "path": "shell/src/main/java/org/apache/accumulo/shell/Shell.java", "diffHunk": "@@ -584,40 +586,39 @@ public int start() throws IOException {\n \n         // If tab completion is true we need to reset\n         if (tabCompletion) {\n-          if (userCompletor != null) {\n-            reader.removeCompleter(userCompletor);\n-          }\n-\n           userCompletor = setupCompletion();\n-          reader.addCompleter(userCompletor);\n+          ((LineReaderImpl) reader).setCompleter(userCompletor);\n         }\n \n-        reader.setPrompt(getDefaultPrompt());\n-        input = reader.readLine();\n+        input = reader.readLine(getDefaultPrompt());\n         if (input == null) {\n-          reader.println();\n           return exitCode;\n         } // User Canceled (Ctrl+D)\n \n         execCommand(input, disableAuthTimeout, false);\n       } catch (UserInterruptException uie) {\n         // User Cancelled (Ctrl+C)\n-        reader.println();\n+        writer.println();\n \n         String partialLine = uie.getPartialLine();\n         if (partialLine == null || \"\".equals(uie.getPartialLine().trim())) {\n           // No content, actually exit\n           return exitCode;\n         }\n       } finally {\n-        reader.flush();\n+        writer.flush();\n       }\n     }\n   }\n \n   public void shutdown() {\n     if (reader != null) {\n-      reader.close();\n+      try {\n+        terminal.close();\n+        reader = null;\n+      } catch (IOException e) {\n+        e.printStackTrace();", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg0MTA1Nw==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564841057", "bodyText": "I concur. We don't generally just print stack traces with e.printStackTrace().", "author": "ctubbsii", "createdAt": "2021-01-26T21:21:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDc0ODU2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTIxODY1MQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565218651", "bodyText": "I will add.", "author": "Manno15", "createdAt": "2021-01-27T11:03:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDc0ODU2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTMzNTQ3Nw==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565335477", "bodyText": "I noticed a printExcetion function included in the shell class already so I used that for this. Let me know if that suffices", "author": "Manno15", "createdAt": "2021-01-27T14:08:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDc0ODU2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgwMDQ5MQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564800491", "bodyText": "Did you test CTRL-C without the lines below? Or kill -2 <pid> ?", "author": "dlmarion", "createdAt": "2021-01-26T20:09:57Z", "path": "shell/src/main/java/org/apache/accumulo/shell/Shell.java", "diffHunk": "@@ -543,23 +551,17 @@ public int start() throws IOException {\n     if (!accumuloDir.exists() && !accumuloDir.mkdirs()) {\n       log.warn(\"Unable to make directory for history at {}\", accumuloDir);\n     }\n-    try {\n-      final FileHistory history = new FileHistory(new File(historyPath));\n-      reader.setHistory(history);\n-      // Add shutdown hook to flush file history, per jline javadocs\n-      Runtime.getRuntime().addShutdownHook(new Thread(() -> {\n-        try {\n-          history.flush();\n-        } catch (IOException e) {\n-          log.warn(\"Could not flush history to file.\");\n-        }\n-      }));\n-    } catch (IOException e) {\n-      log.warn(\"Unable to load history file at {}\", historyPath);\n-    }\n+\n+    // Remove Timestamps for history file. Fixes incompatibility issues\n+    reader.unsetOpt(LineReader.Option.HISTORY_TIMESTAMPED);\n+\n+    // Set history file\n+    reader.setVariable(LineReader.HISTORY_FILE, new File(historyPath));\n \n     // Turn Ctrl+C into Exception instead of JVM exit\n-    reader.setHandleUserInterrupt(true);\n+    // Not 100% sure this is necessary anymore.", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgyMzM3NA==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564823374", "bodyText": "I believe CTRL-C still worked without it but I will double check tomorrow to verify.", "author": "Manno15", "createdAt": "2021-01-26T20:49:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgwMDQ5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTMwNzMyMQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565307321", "bodyText": "In my testing, both the main branch and these changes do have the same functionality for CTRL-C but they both might be wrong. When I  hit CTRL-C, it exits the shell which I do not think is what we are going for. I tested the jline3 demo and CTRL-C will reset back to the shell but not exit the shell. That is probably the functionality we want. The funny thing is, I am implementing what they did in their demo but for some reason, it does not seem to be working. So this will take some more investigating.", "author": "Manno15", "createdAt": "2021-01-27T13:29:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgwMDQ5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTMxNTY1Ng==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565315656", "bodyText": "I did find that when I CTRL-C in the middle of the help command, it does work properly. As in it throws the interrupt exception but doesn't exit the process. It only exits if I CTRL-C when just sitting in the shell. So this signal handle is at least needed for that, unsure on why it still exits when CTRL-C not during a command.", "author": "Manno15", "createdAt": "2021-01-27T13:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgwMDQ5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTUzOTgyOQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565539829", "bodyText": "This is because of the block below. Not sure if this is a feature that we want or not.\ncatch (UserInterruptException uie) {\n        // User Cancelled (Ctrl+C)\n        reader.println();\n        writer.println();\n\n        String partialLine = uie.getPartialLine();\n        if (partialLine == null || \"\".equals(uie.getPartialLine().trim())) {\n          // No content, actually exit\n          return exitCode;\n        }", "author": "Manno15", "createdAt": "2021-01-27T18:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgwMDQ5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgyNzkxNQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564827915", "bodyText": "It might make sense to assign the writer to a new variable, so that way all this line wrapping doesn't occur.\nvar w = c.getTerminal().writer();\nw.println(...);", "author": "ctubbsii", "createdAt": "2021-01-26T20:57:42Z", "path": "server/base/src/main/java/org/apache/accumulo/server/init/Initialize.java", "diffHunk": "@@ -271,19 +273,23 @@ static boolean checkInit(VolumeManager fs, SiteConfiguration sconf, Configuratio\n       return false;\n     }\n     if (sconf.get(Property.INSTANCE_SECRET).equals(Property.INSTANCE_SECRET.getDefaultValue())) {\n-      ConsoleReader c = getConsoleReader();\n-      c.beep();\n-      c.println();\n-      c.println();\n-      c.println(\"Warning!!! Your instance secret is still set to the default,\"\n-          + \" this is not secure. We highly recommend you change it.\");\n-      c.println();\n-      c.println();\n-      c.println(\"You can change the instance secret in accumulo by using:\");\n-      c.println(\"   bin/accumulo \" + org.apache.accumulo.server.util.ChangeSecret.class.getName());\n-      c.println(\"You will also need to edit your secret in your configuration\"\n-          + \" file by adding the property instance.secret to your\"\n-          + \" accumulo.properties. Without this accumulo will not operate\" + \" correctly\");\n+      LineReader c = getLineReader();\n+      c.getTerminal().puts(InfoCmp.Capability.bell);\n+      c.getTerminal().writer().println();\n+      c.getTerminal().writer().println();\n+\n+      c.getTerminal().writer()", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTM0MzUwNQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565343505", "bodyText": "Done in latest commit", "author": "Manno15", "createdAt": "2021-01-27T14:18:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgyNzkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgyODgwMA==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564828800", "bodyText": "These splits should be on separate lines. It seems like either this behavior has changed, or there's a problem with these tests.", "author": "ctubbsii", "createdAt": "2021-01-26T20:59:13Z", "path": "test/src/main/java/org/apache/accumulo/test/ShellServerIT.java", "diffHunk": "@@ -895,7 +904,7 @@ public void clonetableOffline() throws Exception {\n     ts.exec(\"scan\", false, \"TableOfflineException\", true);\n     ts.exec(\"constraint --list -t \" + clone, true, \"VisibilityConstraint=2\", true);\n     ts.exec(\"config -t \" + clone + \" -np\", true, \"123M\", true);\n-    ts.exec(\"getsplits -t \" + clone, true, \"a\\nb\\nc\\n\");\n+    ts.exec(\"getsplits -t \" + clone, true, \"abc\");", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ4MDkwNw==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565480907", "bodyText": "Yep, that was my mistake. Apparently, in PrintShell I replaced a printLn() with just a print().", "author": "Manno15", "createdAt": "2021-01-27T17:06:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgyODgwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzMDA0Ng==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564830046", "bodyText": "I wonder if it would make more sense to pass in \"terminal\" instead of just the reader?", "author": "ctubbsii", "createdAt": "2021-01-26T21:01:19Z", "path": "test/src/main/java/org/apache/accumulo/test/ShellServerIT.java", "diffHunk": "@@ -182,14 +186,19 @@ public String getErrorMessage() {\n     public TestOutputStream output;\n     public StringInputStream input;\n     public Shell shell;\n+    public LineReader reader;\n+    public Terminal terminal;\n \n     TestShell(String user, String rootPass, String instanceName, String zookeepers, File configFile)\n         throws IOException {\n       ClientInfo info = ClientInfo.from(configFile.toPath());\n       // start the shell\n       output = new TestOutputStream();\n       input = new StringInputStream();\n-      shell = new Shell(new ConsoleReader(input, output));\n+      terminal = new DumbTerminal(input, output);\n+      terminal.setSize(new Size(80, 24));\n+      reader = LineReaderBuilder.builder().terminal(terminal).build();\n+      shell = new Shell(reader);", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTM0ODM5MQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565348391", "bodyText": "I am unsure if it would change anything since the terminal gets attached to the reader. We could just pass in \"terminal\" and then build the reader inside Shell.java so keep things consistent there. Not sure what that would gain ultimately.", "author": "Manno15", "createdAt": "2021-01-27T14:24:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzMDA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQzODA1MA==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565438050", "bodyText": "The gain is just more intuitive API semantics (possibly) and maybe exposing a more stable jline API... a terminal being a high level object and line reader a lower level component.", "author": "ctubbsii", "createdAt": "2021-01-27T16:12:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzMDA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ0NjQ0NQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565446445", "bodyText": "I will look into it further once I get through the rest of the comments.", "author": "Manno15", "createdAt": "2021-01-27T16:22:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzMDA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjQ1NzYyMw==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r566457623", "bodyText": "I think your other comment explained that LineReader was more the primary object to interact with, not the terminal. If that's the case, then my suggestion here probably is fine to ignore.", "author": "ctubbsii", "createdAt": "2021-01-28T22:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzMDA0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzMDQwOQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564830409", "bodyText": "If these tests pass without the newline, then that seems like it would indicate a breaking change to getsplits.", "author": "ctubbsii", "createdAt": "2021-01-26T21:02:03Z", "path": "test/src/main/java/org/apache/accumulo/test/ShellIT.java", "diffHunk": "@@ -207,9 +215,9 @@ public void addGetSplitsTest() throws IOException {\n     exec(\"addsplits arg\", false, \"java.lang.IllegalStateException: Not in a table context\");\n     exec(\"createtable test\", true);\n     exec(\"addsplits 1 \\\\x80\", true);\n-    exec(\"getsplits\", true, \"1\\n\\\\x80\");\n+    exec(\"getsplits\", true, \"1\\\\x80\");\n     exec(\"getsplits -m 1\", true, \"1\");\n-    exec(\"getsplits -b64\", true, \"MQ==\\ngA==\");\n+    exec(\"getsplits -b64\", true, \"MQ==gA==\");", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ4NDk4MA==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565484980", "bodyText": "Same issue as above. Printed instead of PrintLn", "author": "Manno15", "createdAt": "2021-01-27T17:12:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzMDQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzMDc3NQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564830775", "bodyText": "What's this comment about?", "author": "ctubbsii", "createdAt": "2021-01-26T21:02:42Z", "path": "shell/src/test/java/org/apache/accumulo/shell/format/DeleterFormatterTest.java", "diffHunk": "@@ -133,6 +141,7 @@ public void testNo() throws IOException {\n     assertTrue(formatter.hasNext());\n   }\n \n+  // Need to properly fix this test.", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTM1MDY4Ng==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565350686", "bodyText": "Related to your other comment below in DeleterFormatter.", "author": "Manno15", "createdAt": "2021-01-27T14:27:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzMDc3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzMjkyNA==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564832924", "bodyText": "Is there a way to add the history directly to the terminal, and using its line reader, or do we have to create a new line reader separately from the terminal?", "author": "ctubbsii", "createdAt": "2021-01-26T21:06:43Z", "path": "shell/src/test/java/org/apache/accumulo/shell/commands/HistoryCommandTest.java", "diffHunk": "@@ -56,38 +62,41 @@ public void setUp() throws Exception {\n     expect(cl.hasOption(\"np\")).andReturn(true);\n     replay(cl);\n \n-    History history = new MemoryHistory();\n+    History history = new DefaultHistory();\n     history.add(\"foo\");\n     history.add(\"bar\");\n \n     baos = new ByteArrayOutputStream();\n \n     String input = String.format(\"!1%n\"); // Construct a platform dependent new-line\n-    reader = new ConsoleReader(new ByteArrayInputStream(input.getBytes()), baos);\n-    reader.setHistory(history);\n+    terminal = TerminalBuilder.builder().system(false)\n+        .streams(new ByteArrayInputStream(input.getBytes()), baos).build();\n+    reader = LineReaderBuilder.builder().history(history).terminal(terminal).build();", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ5NDgxOQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565494819", "bodyText": "The line reader is what contains the history and also contains the terminal object. Not the other way around. The line reader seems to be the higher-level object though I agree that it doesn't make the most sense. It is probably like this so it doesn't differentiate itself too much from ConsoleReader in jline2.\nThe reader object in terminal is a bit different than a LineReader and isn't as friendly to use.", "author": "Manno15", "createdAt": "2021-01-27T17:25:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzMjkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjQ1NjYxNg==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r566456616", "bodyText": "Makes sense! Thanks for the explanation.", "author": "ctubbsii", "createdAt": "2021-01-28T22:40:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzMjkyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzMzg0Nw==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564833847", "bodyText": "Is it safe to use the impl here? Doing so seems fragile.", "author": "ctubbsii", "createdAt": "2021-01-26T21:08:13Z", "path": "shell/src/test/java/org/apache/accumulo/shell/ShellConfigTest.java", "diffHunk": "@@ -29,14 +29,14 @@\n import java.io.PrintStream;\n import java.nio.file.Files;\n \n+import org.jline.reader.impl.LineReaderImpl;", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ5NzgyNQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565497825", "bodyText": "I forgot to update this test to use a dumb terminal like the other tests.", "author": "Manno15", "createdAt": "2021-01-27T17:29:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzMzg0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzNDQ5Nw==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564834497", "bodyText": "Which one? Why? Can it be fixed?", "author": "ctubbsii", "createdAt": "2021-01-26T21:09:20Z", "path": "shell/src/main/java/org/apache/accumulo/shell/format/DeleterFormatter.java", "diffHunk": "@@ -79,33 +79,36 @@ public String next() {\n     Mutation m = new Mutation(key.getRow());\n     String entryStr = formatEntry(next, isDoTimestamps());\n     boolean delete = force;\n-    try {\n-      if (!force) {\n-        shellState.getReader().flush();\n+    if (!force) {\n+      try {\n+        shellState.getWriter().flush();\n+        // this will cause end of file Exception for one of the formatter tests", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTM1MDM1Ng==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565350356", "bodyText": "This is related to the other comment you mentioned in the DeleterFormatterTest. I will have to refresh my memory on it a bit.", "author": "Manno15", "createdAt": "2021-01-27T14:27:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzNDQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTM1ODQ4OA==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565358488", "bodyText": "the failure happens on line 86 where it tries to read the delete prompt.  When DeleterFormatterTest.testNoConfirmation() is ran, it hits that line but gets an end of file marker instead.", "author": "Manno15", "createdAt": "2021-01-27T14:37:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzNDQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQwODQyMg==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565408422", "bodyText": "It is possible that Jline3 changed something behind the scenes. On the main branch, line returns null when trying to read the prompt. Currently, it reads the end of file. Not sure what the best approach to fix it yet but I am trying to get it to where it returns null.\nEDIT: Looks like the EndOfFile Exception is new to jline3 and is thrown by readLine now. I should have noticed that difference earlier. Not sure the best way to adapt DeleterFormatter to take that into consideration.", "author": "Manno15", "createdAt": "2021-01-27T15:36:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzNDQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjAzNDAyMw==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r566034023", "bodyText": "I added a potential fix for this in my latest commit. It is probably good enough without completely rewriting DeleterFormatter", "author": "Manno15", "createdAt": "2021-01-28T11:52:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzNDQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzNzE4Ng==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564837186", "bodyText": "It looks like Iterator was used here previously because .entries() returned a type of Iterator. However, it now looks like .getHistory() returns a type of Iterable, which gives an opportunity to write this differently, using Java streams or something, and to avoid the use of Guava's Iterators.transform() in favor of Java built-ins. It's not important, though. It's fine either way.", "author": "ctubbsii", "createdAt": "2021-01-26T21:14:21Z", "path": "shell/src/main/java/org/apache/accumulo/shell/commands/HistoryCommand.java", "diffHunk": "@@ -39,11 +39,11 @@\n   public int execute(final String fullCommand, final CommandLine cl, final Shell shellState)\n       throws IOException {\n     if (cl.hasOption(clearHist.getOpt())) {\n-      shellState.getReader().getHistory().clear();\n+      shellState.getReader().getHistory().purge();\n     } else {\n-      Iterator<Entry> source = shellState.getReader().getHistory().entries();\n+      Iterator<History.Entry> source = shellState.getReader().getHistory().iterator();\n       Iterator<String> historyIterator = Iterators.transform(source,\n-          input -> String.format(\"%d: %s\", input.index() + 1, input.value()));\n+          input -> String.format(\"%d: %s\", input.index() + 1, input.line()));", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTUxNTQwMw==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565515403", "bodyText": "This is something I can look for additional work after this PR. I did briefly look at trying to implement it and noticed a decent amount of code to change at where we interpret the results and print to shell.", "author": "Manno15", "createdAt": "2021-01-27T17:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzNzE4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzNzgyOA==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564837828", "bodyText": "Have you tested the bell to make sure it actually rings? (might depend on your local development environment).", "author": "ctubbsii", "createdAt": "2021-01-26T21:15:33Z", "path": "shell/src/main/java/org/apache/accumulo/shell/commands/HiddenCommand.java", "diffHunk": "@@ -42,9 +43,9 @@ public String description() {\n   public int execute(final String fullCommand, final CommandLine cl, final Shell shellState)\n       throws Exception {\n     if (rand.nextInt(10) == 0) {\n-      shellState.getReader().beep();\n-      shellState.getReader().println();\n-      shellState.getReader()\n+      shellState.getTerminal().puts(InfoCmp.Capability.bell);", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTIzOTczOA==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565239738", "bodyText": "I have not but I will try on my end. This was how the devs on the mailing list said to do it. I never heard the bell on the old shell so I am not sure if I will hear this one.", "author": "Manno15", "createdAt": "2021-01-27T11:37:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzNzgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQzNTE4NQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565435185", "bodyText": "The bell should be the same one you hear in Linux if you got backspace repeatedly on an empty line. If you can't hear it by trying that, then it's probably configurable in your system sound settings to enable it.", "author": "ctubbsii", "createdAt": "2021-01-27T16:08:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzNzgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ2Nzk0NQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565467945", "bodyText": "Confirmed that the bell is there with these changes. Had to do a bit of settings adjustments in my terminal to make it audible.", "author": "Manno15", "createdAt": "2021-01-27T16:49:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzNzgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzOTg0Mg==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564839842", "bodyText": "These warning suppressions might not make sense anymore, now that you've added the appropriate generics to the candidates list.", "author": "ctubbsii", "createdAt": "2021-01-26T21:18:49Z", "path": "shell/src/main/java/org/apache/accumulo/shell/ShellCompletor.java", "diffHunk": "@@ -45,13 +48,16 @@ public ShellCompletor(Token rootToken, Map<CompletionSet,Set<String>> options) {\n \n   @Override\n   @SuppressWarnings({\"unchecked\", \"rawtypes\"})", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTUyMDk2Mg==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565520962", "bodyText": "Removed in the latest commit", "author": "Manno15", "createdAt": "2021-01-27T18:02:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDgzOTg0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg0MjE3MA==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r564842170", "bodyText": "This println previously existed, so the user's bash shell or whatever, wouldn't print its prompt at the end of Accumulo's prompt, when existing by closing the input stream. I assume by removing this println, that no longer occurs? If it does, that should probably be put back.", "author": "ctubbsii", "createdAt": "2021-01-26T21:23:06Z", "path": "shell/src/main/java/org/apache/accumulo/shell/Shell.java", "diffHunk": "@@ -584,40 +586,39 @@ public int start() throws IOException {\n \n         // If tab completion is true we need to reset\n         if (tabCompletion) {\n-          if (userCompletor != null) {\n-            reader.removeCompleter(userCompletor);\n-          }\n-\n           userCompletor = setupCompletion();\n-          reader.addCompleter(userCompletor);\n+          ((LineReaderImpl) reader).setCompleter(userCompletor);\n         }\n \n-        reader.setPrompt(getDefaultPrompt());\n-        input = reader.readLine();\n+        input = reader.readLine(getDefaultPrompt());\n         if (input == null) {\n-          reader.println();", "originalCommit": "61a1755547fc0f9fd6290eb4abe704b775657618", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTUzMzg3OQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r565533879", "bodyText": "I don't believe this still occurs but I will add it back because I don't have a great way to test and a println doesn't hurt. I also just noticed that CTRL-D will throw an EndOfFileException if I do it on a blank line so I'll add a catch for that exception. This might make that if statement redundant if that is the only situation input could be null.", "author": "Manno15", "createdAt": "2021-01-27T18:22:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg0MjE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjQ1NjA2MQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r566456061", "bodyText": "I don't believe this still occurs but I will add it back because I don't have a great way to test and a println doesn't hurt.\n\nManually/visual testing for this is sufficient.\n\nI also just noticed that CTRL-D will throw an EndOfFileException if I do it on a blank line so I'll add a catch for that exception. This might make that if statement redundant if that is the only situation input could be null.\n\nHmm, yeah, if it's causing that to explicitly be thrown, then it might be redundant. Handling it by catching the exception is much more clear. As long as the output doesn't get jumbled, and we get a new line when Ctrl-D is entered, I'm not too concerned about how the handling is implemented, as long as the behavior works.", "author": "ctubbsii", "createdAt": "2021-01-28T22:39:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg0MjE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njc0NDI1OQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r566744259", "bodyText": "I will do more testing to confirm then push out my findings, CTRL-D for sure is hit by the exception and everything looks good there. I just need to make sure there is no other case input will equal null and to see what happens if something like that does happen.", "author": "Manno15", "createdAt": "2021-01-29T11:04:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg0MjE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njc5NzAzMQ==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r566797031", "bodyText": "From my testing, there is no reasonable way for a user to make input null beyond hitting CTRL-D, which sends a EOF exception. I interpret that as the user wanting to exit (which is standard for BASH but we can change that if we want). My latest commit reflects that idea.", "author": "Manno15", "createdAt": "2021-01-29T12:46:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg0MjE3MA=="}], "type": "inlineReview"}, {"oid": "9d0f658e598dadefa66b1c04935623f094a36c8a", "url": "https://github.com/apache/accumulo/commit/9d0f658e598dadefa66b1c04935623f094a36c8a", "message": "Merge branch 'main' of https://github.com/apache/accumulo into upgrade_to_Jline3", "committedDate": "2021-01-27T12:17:47Z", "type": "commit"}, {"oid": "32942afdbba4b65845c5b9160e3c83474afbeffc", "url": "https://github.com/apache/accumulo/commit/32942afdbba4b65845c5b9160e3c83474afbeffc", "message": "clarify signal handler and use print exception function", "committedDate": "2021-01-27T13:47:51Z", "type": "commit"}, {"oid": "2e5028316e39f4f4837d0ac6f4da4f8fd684a53f", "url": "https://github.com/apache/accumulo/commit/2e5028316e39f4f4837d0ac6f4da4f8fd684a53f", "message": "fix line wrapping", "committedDate": "2021-01-27T14:18:13Z", "type": "commit"}, {"oid": "61d28d841e4316f9ab8bc902da276aaa4eab912b", "url": "https://github.com/apache/accumulo/commit/61d28d841e4316f9ab8bc902da276aaa4eab912b", "message": "fix shellIT and shellServerIT", "committedDate": "2021-01-27T17:18:26Z", "type": "commit"}, {"oid": "ce9da51cdf75684e6b1587dd9c43543f5a263f28", "url": "https://github.com/apache/accumulo/commit/ce9da51cdf75684e6b1587dd9c43543f5a263f28", "message": "fix shellConfigTest", "committedDate": "2021-01-27T17:36:30Z", "type": "commit"}, {"oid": "057588d31ca0b1927a3e5f5fe710b0c560a33f64", "url": "https://github.com/apache/accumulo/commit/057588d31ca0b1927a3e5f5fe710b0c560a33f64", "message": "remove suprressed warnings", "committedDate": "2021-01-27T18:02:32Z", "type": "commit"}, {"oid": "25b84d1cf06c6cc4808dcc8da569bb455a5d046a", "url": "https://github.com/apache/accumulo/commit/25b84d1cf06c6cc4808dcc8da569bb455a5d046a", "message": "catch EndOfFileException and add printLn back", "committedDate": "2021-01-27T18:43:37Z", "type": "commit"}, {"oid": "adc4af6ab35ca4c3a3a85515d3225ce3a2cbc443", "url": "https://github.com/apache/accumulo/commit/adc4af6ab35ca4c3a3a85515d3225ce3a2cbc443", "message": "possible fix for deleterFormatterTest", "committedDate": "2021-01-28T11:50:06Z", "type": "commit"}, {"oid": "e4af962b245021735f31b96baccf744d7c67198f", "url": "https://github.com/apache/accumulo/commit/e4af962b245021735f31b96baccf744d7c67198f", "message": "diable terminal from using Jansi as default", "committedDate": "2021-01-28T15:08:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjQ1Mzk0Ng==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r566453946", "bodyText": "I think this suggestion was made previously, but may have been overlooked.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  delete = line != null && (line.equalsIgnoreCase(\"y\") || line.equalsIgnoreCase(\"yes\"));\n          \n          \n            \n                  delete = more && (line.equalsIgnoreCase(\"y\") || line.equalsIgnoreCase(\"yes\"));", "author": "ctubbsii", "createdAt": "2021-01-28T22:35:06Z", "path": "shell/src/main/java/org/apache/accumulo/shell/format/DeleterFormatter.java", "diffHunk": "@@ -79,33 +79,36 @@ public String next() {\n     Mutation m = new Mutation(key.getRow());\n     String entryStr = formatEntry(next, isDoTimestamps());\n     boolean delete = force;\n-    try {\n-      if (!force) {\n-        shellState.getReader().flush();\n-        String line = shellState.getReader().readLine(\"Delete { \" + entryStr + \" } ? \");\n-        more = line != null;\n-        delete = line != null && (line.equalsIgnoreCase(\"y\") || line.equalsIgnoreCase(\"yes\"));\n+    String line;\n+    if (!force) {\n+      try {\n+        shellState.getWriter().flush();\n+        String prompt = \"Delete { \" + entryStr + \" } ? \";\n+        line = shellState.getReader().readLine(prompt);\n+      } catch (EndOfFileException ignored) {\n+        // Reached the end of file. Line is null to keep old functionality.\n+        line = null;\n       }\n-      if (delete) {\n-        m.putDelete(key.getColumnFamily(), key.getColumnQualifier(),\n-            new ColumnVisibility(key.getColumnVisibility()), key.getTimestamp());\n-        try {\n-          writer.addMutation(m);\n-        } catch (MutationsRejectedException e) {\n-          log.error(e.toString());\n-          if (Shell.log.isTraceEnabled()) {\n-            for (ConstraintViolationSummary cvs : e.getConstraintViolationSummaries()) {\n-              log.trace(cvs.toString());\n-            }\n+      more = line != null;\n+      delete = line != null && (line.equalsIgnoreCase(\"y\") || line.equalsIgnoreCase(\"yes\"));", "originalCommit": "e4af962b245021735f31b96baccf744d7c67198f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njc0MzMwMA==", "url": "https://github.com/apache/accumulo/pull/1824#discussion_r566743300", "bodyText": "You are correct. I will add that in.", "author": "Manno15", "createdAt": "2021-01-29T11:02:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjQ1Mzk0Ng=="}], "type": "inlineReview"}, {"oid": "ea5b2ab6d6c375838da742148785767749826b0d", "url": "https://github.com/apache/accumulo/commit/ea5b2ab6d6c375838da742148785767749826b0d", "message": "add code suggestion", "committedDate": "2021-01-29T11:39:09Z", "type": "commit"}, {"oid": "a02bff9b84c6d347f07d8e0cdfa23a997680c93b", "url": "https://github.com/apache/accumulo/commit/a02bff9b84c6d347f07d8e0cdfa23a997680c93b", "message": "edit on CTRL-D, remove redundant if statement", "committedDate": "2021-01-29T12:44:06Z", "type": "commit"}, {"oid": "18fede4f7186b833155d586e0888b9ef3a951da6", "url": "https://github.com/apache/accumulo/commit/18fede4f7186b833155d586e0888b9ef3a951da6", "message": "update license", "committedDate": "2021-02-01T12:09:11Z", "type": "commit"}, {"oid": "79ecf8d5ba2074a65bb3ea832a60bad5ac0ef9e1", "url": "https://github.com/apache/accumulo/commit/79ecf8d5ba2074a65bb3ea832a60bad5ac0ef9e1", "message": "upgrade to 3.19.0", "committedDate": "2021-02-01T13:57:20Z", "type": "commit"}]}