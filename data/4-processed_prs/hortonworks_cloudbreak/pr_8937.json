{"pr_number": 8937, "pr_title": "CB-6644 Auditing environment", "pr_createdAt": "2020-09-07T13:19:13Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8937", "timeline": [{"oid": "f65556b01fbafb5134e0357e5093c5e965e4ef4f", "url": "https://github.com/hortonworks/cloudbreak/commit/f65556b01fbafb5134e0357e5093c5e965e4ef4f", "message": "iinit", "committedDate": "2020-09-10T11:38:39Z", "type": "forcePushed"}, {"oid": "7d48bea027fb3ca9afcc25f1d2db01d426770681", "url": "https://github.com/hortonworks/cloudbreak/commit/7d48bea027fb3ca9afcc25f1d2db01d426770681", "message": "The structured event moved to a different module, named as 'structuredevent-service-legacy'. In this modul the functionalities are untouched. For the CDP world, we created two new modules: 'structuredevent-api-cdp' and 'structuredevent-service-cdp'. We created a common endpoint, service and repository. Only one thing need to integrate: the domain SQL.", "committedDate": "2020-09-10T16:08:02Z", "type": "forcePushed"}, {"oid": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "url": "https://github.com/hortonworks/cloudbreak/commit/02641c35f6adb27fe60bed935aff3335cd3a69f2", "message": "The structured event moved to a different module, named as 'structuredevent-service-legacy'. In this modul the functionalities are untouched. For the CDP world, we created two new modules: 'structuredevent-api-cdp' and 'structuredevent-service-cdp'. We created a common endpoint, service and repository. Only one thing need to integrate: the domain SQL.", "committedDate": "2020-09-11T07:59:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk5Nzk0MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r486997941", "bodyText": "could you add an else branch or restructure the code so you won't have a return in the middle of the method?", "author": "lacikaaa", "createdAt": "2020-09-11T12:00:55Z", "path": "authorization-common/src/main/java/com/sequenceiq/authorization/service/ResourcePermissionChecker.java", "diffHunk": "@@ -15,6 +16,9 @@\n \n     protected Map<String, AuthorizationResourceAction> getAuthorizationActions(String resourceCrn, AuthorizationResourceAction action) {\n         ResourceBasedCrnProvider resourceBasedCrnProvider = commonPermissionCheckingUtils.getResourceBasedCrnProvider(action);\n+        if (resourceBasedCrnProvider == null) {\n+            return Collections.emptyMap();\n+        }", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg4NTgyNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487885826", "bodyText": "I think it is much clearer then if I create an if {} else {} structure. Otherwise, we have a lot of similar code style in the codebase.", "author": "topolyai5", "createdAt": "2020-09-14T12:50:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk5Nzk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk5ODI3Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r486998277", "bodyText": "object->array", "author": "lacikaaa", "createdAt": "2020-09-11T12:01:39Z", "path": "common/src/main/java/com/sequenceiq/cloudbreak/common/json/Json.java", "diffHunk": "@@ -170,4 +178,28 @@ public String toString() {\n         sb.append('}');\n         return sb.toString();\n     }\n+\n+    public boolean isObject() {\n+        try {\n+            JSONObject.fromObject(value);\n+            return true;\n+        } catch (JSONException e) {\n+            LOGGER.debug(\"This json is not an object: {}\", e.getMessage());\n+            return false;\n+        }\n+    }\n+\n+    public boolean isArray() {\n+        try {\n+            JSONArray.fromObject(value);\n+            return true;\n+        } catch (JSONException e) {\n+            LOGGER.debug(\"This json is not an object: {}\", e.getMessage());", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAwMDUwOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487000508", "bodyText": "could you check if we really need this transactional annotation?", "author": "lacikaaa", "createdAt": "2020-09-11T12:06:30Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/structuredevent/BaseLegacyStructuredFlowEventFactory.java", "diffHunk": "@@ -26,18 +26,18 @@\n import com.sequenceiq.cloudbreak.structuredevent.event.ClusterDetails;\n import com.sequenceiq.cloudbreak.structuredevent.event.FlowDetails;\n import com.sequenceiq.cloudbreak.structuredevent.event.NotificationDetails;\n-import com.sequenceiq.cloudbreak.structuredevent.event.OperationDetails;\n import com.sequenceiq.cloudbreak.structuredevent.event.StackDetails;\n import com.sequenceiq.cloudbreak.structuredevent.event.StructuredFlowEvent;\n import com.sequenceiq.cloudbreak.structuredevent.event.StructuredNotificationEvent;\n-import com.sequenceiq.cloudbreak.structuredevent.rest.StructuredFlowEventFactory;\n+import com.sequenceiq.cloudbreak.structuredevent.event.legacy.OperationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.rest.LegacyStructuredFlowEventFactory;\n import com.sequenceiq.flow.ha.NodeConfig;\n \n @Component\n @Transactional", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyNzA1Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487727057", "bodyText": "Yes, it is necessary.", "author": "topolyai5", "createdAt": "2020-09-14T08:08:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAwMDUwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyOTY4OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487729688", "bodyText": "LazyInit exception occurred during the event firing", "author": "topolyai5", "createdAt": "2020-09-14T08:13:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAwMDUwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAwMjg2Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487002867", "bodyText": "why null?", "author": "lacikaaa", "createdAt": "2020-09-11T12:11:15Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/domain/Environment.java", "diffHunk": "@@ -156,6 +157,11 @@ public void setAccountId(String accountId) {\n         this.accountId = accountId;\n     }\n \n+    @Override\n+    public String getResourceName() {\n+        return null;", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAxMjE3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487012172", "bodyText": "missing unit test, especially for pattern matching", "author": "lacikaaa", "createdAt": "2020-09-11T12:30:23Z", "path": "environment/src/main/java/com/sequenceiq/environment/events/CredentialUrlParser.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.sequenceiq.environment.events;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.structuredevent.event.CloudbreakEventService;\n+import com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser;\n+\n+@Component\n+public class CredentialUrlParser extends CDPRestUrlParser {", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAxNDQ3NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487014474", "bodyText": "I would prefer if you would add an getEnvironmentById method to the EnvironmentService and that could throw an exception as I see this kind of usage a lot in the code generally", "author": "lacikaaa", "createdAt": "2020-09-11T12:35:08Z", "path": "environment/src/main/java/com/sequenceiq/environment/events/EnvironmentStructuredFlowEventFactory.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.sequenceiq.environment.events;\n+\n+import static com.sequenceiq.cloudbreak.common.exception.NotFoundException.notFound;\n+import static com.sequenceiq.cloudbreak.structuredevent.event.StructuredEventType.FLOW;\n+\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.common.service.Clock;\n+import com.sequenceiq.cloudbreak.structuredevent.event.FlowDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPOperationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredFlowEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredNotificationEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.service.CDPStructuredFlowEventFactory;\n+import com.sequenceiq.environment.environment.domain.Environment;\n+import com.sequenceiq.environment.environment.service.EnvironmentService;\n+import com.sequenceiq.flow.ha.NodeConfig;\n+\n+@Component\n+public class EnvironmentStructuredFlowEventFactory implements CDPStructuredFlowEventFactory {\n+\n+    @Inject\n+    private Clock clock;\n+\n+    @Inject\n+    private EnvironmentService environmentService;\n+\n+    @Inject\n+    private NodeConfig nodeConfig;\n+\n+    @Value(\"${info.app.version:}\")\n+    private String serviceVersion;\n+\n+    @Override\n+    public CDPStructuredFlowEvent createStructuredFlowEvent(Long resourceId, FlowDetails flowDetails, Boolean detailed) {\n+        Optional<Environment> environmentOptional = environmentService.findEnvironmentById(resourceId);\n+        Environment environment = environmentOptional.orElseThrow(notFound(\"Environment\", resourceId));", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAxNjM2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487016360", "bodyText": "I see you have created CDPStructuredFlowEventFactory and this is the only implementation of that interface. And 2 of 3 methods return null. Why do we need these methods?", "author": "lacikaaa", "createdAt": "2020-09-11T12:38:53Z", "path": "environment/src/main/java/com/sequenceiq/environment/events/EnvironmentStructuredFlowEventFactory.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.sequenceiq.environment.events;\n+\n+import static com.sequenceiq.cloudbreak.common.exception.NotFoundException.notFound;\n+import static com.sequenceiq.cloudbreak.structuredevent.event.StructuredEventType.FLOW;\n+\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.common.service.Clock;\n+import com.sequenceiq.cloudbreak.structuredevent.event.FlowDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPOperationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredFlowEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredNotificationEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.service.CDPStructuredFlowEventFactory;\n+import com.sequenceiq.environment.environment.domain.Environment;\n+import com.sequenceiq.environment.environment.service.EnvironmentService;\n+import com.sequenceiq.flow.ha.NodeConfig;\n+\n+@Component\n+public class EnvironmentStructuredFlowEventFactory implements CDPStructuredFlowEventFactory {\n+\n+    @Inject\n+    private Clock clock;\n+\n+    @Inject\n+    private EnvironmentService environmentService;\n+\n+    @Inject\n+    private NodeConfig nodeConfig;\n+\n+    @Value(\"${info.app.version:}\")\n+    private String serviceVersion;\n+\n+    @Override\n+    public CDPStructuredFlowEvent createStructuredFlowEvent(Long resourceId, FlowDetails flowDetails, Boolean detailed) {\n+        Optional<Environment> environmentOptional = environmentService.findEnvironmentById(resourceId);\n+        Environment environment = environmentOptional.orElseThrow(notFound(\"Environment\", resourceId));\n+        String resourceType = CDPStructuredFlowEvent.class.getSimpleName();\n+        CDPOperationDetails operationDetails = new CDPOperationDetails(clock.getCurrentTimeMillis(), FLOW, resourceType, environment.getId(),\n+                environment.getName(), nodeConfig.getId(), serviceVersion, environment.getAccountId(), environment.getResourceCrn(), environment.getCreator(),\n+                environment.getResourceCrn(), null);\n+        return new CDPStructuredFlowEvent(resourceType, operationDetails, flowDetails, null);\n+    }\n+\n+    @Override\n+    public CDPStructuredFlowEvent createStructuredFlowEvent(Long resourceId, FlowDetails flowDetails, Boolean detailed, Exception exception) {\n+        return null;\n+    }\n+\n+    @Override\n+    public CDPStructuredNotificationEvent createStructuredNotificationEvent(Long resourceId, String notificationType, String message, String groupName) {\n+        return null;\n+    }", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAyOTQxNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487029416", "bodyText": "I see no reason to introduce msg here, you could just use serializedPayload", "author": "lacikaaa", "createdAt": "2020-09-11T13:02:24Z", "path": "environment/src/main/java/com/sequenceiq/environment/events/EventSenderService.java", "diffHunk": "@@ -0,0 +1,124 @@\n+package com.sequenceiq.environment.events;\n+\n+import static com.sequenceiq.cloudbreak.structuredevent.event.StructuredEventType.NOTIFICATION;\n+\n+import org.jetbrains.annotations.NotNull;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+\n+import com.google.gson.Gson;\n+import com.sequenceiq.cloudbreak.event.ResourceEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPOperationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredNotificationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredNotificationEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.repository.AccountAwareResource;\n+import com.sequenceiq.cloudbreak.structuredevent.service.CDPDefaultStructuredEventClient;\n+import com.sequenceiq.environment.api.v1.environment.model.response.SimpleEnvironmentResponse;\n+import com.sequenceiq.environment.environment.dto.EnvironmentDto;\n+import com.sequenceiq.environment.environment.v1.converter.EnvironmentResponseConverter;\n+import com.sequenceiq.flow.ha.NodeConfig;\n+import com.sequenceiq.flow.reactor.api.event.BaseNamedFlowEvent;\n+import com.sequenceiq.notification.NotificationService;\n+\n+@Service\n+public class EventSenderService {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EventSenderService.class);\n+\n+    private final NotificationService notificationService;\n+\n+    private final EnvironmentResponseConverter environmentResponseConverter;\n+\n+    private final CDPDefaultStructuredEventClient cdpDefaultStructuredEventClient;\n+\n+    private final NodeConfig nodeConfig;\n+\n+    private final String serviceVersion;\n+\n+    public EventSenderService(NotificationService notificationService, EnvironmentResponseConverter environmentResponseConverter,\n+            CDPDefaultStructuredEventClient cdpDefaultStructuredEventClient, NodeConfig nodeConfig, @Value(\"${info.app.version:}\") String serviceVersion) {\n+        this.notificationService = notificationService;\n+        this.environmentResponseConverter = environmentResponseConverter;\n+        this.cdpDefaultStructuredEventClient = cdpDefaultStructuredEventClient;\n+        this.nodeConfig = nodeConfig;\n+        this.serviceVersion = serviceVersion;\n+    }\n+\n+    public void sendEventAndNotification(EnvironmentDto environmentDto, String userCrn, ResourceEvent resourceEvent) {\n+        SimpleEnvironmentResponse simpleResponse = environmentResponseConverter.dtoToSimpleResponse(environmentDto);\n+        sendEventAndNotificationWithPayload(environmentDto, userCrn, resourceEvent, simpleResponse);\n+    }\n+\n+    public void sendEventAndNotificationWithPayload(AccountAwareResource resource, String userCrn, ResourceEvent resourceEvent, Object payload) {\n+        CDPStructuredNotificationEvent cdpStructuredEvent = getStructuredEvent(resource, resourceEvent, payload);\n+        cdpDefaultStructuredEventClient.sendStructuredEvent(cdpStructuredEvent);\n+        notificationService.send(resourceEvent, payload, userCrn);\n+    }\n+\n+    public void sendEventAndNotificationForMissingEnv(BaseNamedFlowEvent payload, ResourceEvent resourceEvent, String userCrn) {\n+        CDPStructuredNotificationEvent cdpStructuredEvent = createStructureEventForMissingEnvironment(payload, resourceEvent, userCrn);\n+        cdpDefaultStructuredEventClient.sendStructuredEvent(cdpStructuredEvent);\n+        notificationService.send(resourceEvent, payload, userCrn);\n+    }\n+\n+    @NotNull\n+    private CDPStructuredNotificationEvent getStructuredEvent(AccountAwareResource resource, ResourceEvent resourceEvent, Object payload) {\n+        String resourceType = resource.getClass().getSimpleName().toLowerCase();\n+        String resourceCrn = resource.getResourceCrn();\n+        CDPOperationDetails operationDetails = new CDPOperationDetails(\n+                System.currentTimeMillis(),\n+                NOTIFICATION,\n+                resourceType,\n+                resource.getId(),\n+                resource.getName(),\n+                nodeConfig.getId(),\n+                serviceVersion,\n+                resource.getAccountId(),\n+                resourceCrn,\n+                resource.getCreator(),\n+                resourceCrn,\n+                resourceEvent.name());\n+        CDPStructuredNotificationDetails notificationDetails = getNotificationDetails(resourceEvent, resourceCrn, resourceType, payload);\n+\n+        return new CDPStructuredNotificationEvent(operationDetails, notificationDetails);\n+    }\n+\n+    @NotNull\n+    private CDPStructuredNotificationEvent createStructureEventForMissingEnvironment(BaseNamedFlowEvent payload, ResourceEvent resourceEvent, String userCrn) {\n+        String resourceType = payload.getClass().getSimpleName().toLowerCase();\n+        String resourceCrn = payload.getResourceCrn();\n+        CDPOperationDetails operationDetails = new CDPOperationDetails(\n+                System.currentTimeMillis(),\n+                NOTIFICATION,\n+                resourceType,\n+                payload.getResourceId(),\n+                payload.getResourceName(),\n+                nodeConfig.getId(),\n+                serviceVersion,\n+                null,\n+                resourceCrn,\n+                userCrn,\n+                resourceCrn,\n+                resourceEvent.name());\n+\n+        CDPStructuredNotificationDetails notificationDetails = getNotificationDetails(resourceEvent, resourceCrn, resourceType, payload);\n+        return new CDPStructuredNotificationEvent(operationDetails, notificationDetails);\n+    }\n+\n+    private CDPStructuredNotificationDetails getNotificationDetails(ResourceEvent resourceEvent, String resourceCrn, String resourceType,\n+            Object payload) {\n+        String serializedPayload;\n+        try {\n+            serializedPayload = new Gson().toJson(payload);\n+            LOGGER.debug(\"CDPStructuredNotificationDetails' payload has been serialized with ResourceEvent[{}], resource type[{}], CRN[{}]\",\n+                    resourceEvent.name(), resourceType, resourceCrn);\n+        } catch (RuntimeException re) {\n+            String msg = String.format(\"CDPStructuredNotificationDetails' payload couldn't be serialized with ResourceEvent[%s], resource type[%s], CRN[%s]\",", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA0NDAwMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487044000", "bodyText": "there is already a TransformGetterType in the codebase, is it possible to reuse that one? same applies for Immutable", "author": "lacikaaa", "createdAt": "2020-09-11T13:27:20Z", "path": "structuredevent-api-cdp/src/main/java/com/sequenceiq/cloudbreak/structuredevent/rest/annotation/TransformGetterType.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package com.sequenceiq.cloudbreak.structuredevent.rest.annotation;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Inherited;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+@Inherited\n+@Retention(RetentionPolicy.RUNTIME)\n+@Target(ElementType.FIELD)\n+public @interface TransformGetterType {", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA0NTU4NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487045585", "bodyText": "maybe add json ignore unknown annotation also", "author": "lacikaaa", "createdAt": "2020-09-11T13:29:52Z", "path": "structuredevent-api-cdp/src/main/java/com/sequenceiq/cloudbreak/structuredevent/rest/model/CDPEventV1Response.java", "diffHunk": "@@ -0,0 +1,183 @@\n+package com.sequenceiq.cloudbreak.structuredevent.rest.model;\n+\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n+import com.sequenceiq.cloudbreak.structuredevent.event.LdapDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.RdsDetails;\n+\n+import io.swagger.annotations.ApiModel;\n+\n+@ApiModel\n+@JsonInclude(Include.NON_NULL)\n+public class CDPEventV1Response extends CDPEventBaseV1 {", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1MzI3MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487053270", "bodyText": "this might worth a simple unit test", "author": "lacikaaa", "createdAt": "2020-09-11T13:42:31Z", "path": "structuredevent-model/src/main/java/com/sequenceiq/cloudbreak/structuredevent/event/cdp/CDPOperationDetails.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package com.sequenceiq.cloudbreak.structuredevent.event.cdp;\n+\n+import java.io.Serializable;\n+import java.time.Instant;\n+import java.time.ZoneOffset;\n+import java.time.ZonedDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.UUID;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.sequenceiq.cloudbreak.structuredevent.event.StructuredEventType;\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class CDPOperationDetails implements Serializable {\n+\n+    private static final DateTimeFormatter DATE_TIME_FORMATTER = DateTimeFormatter.ofPattern(\"MM/dd/yyyy HH:mm:ss Z\");\n+\n+    private StructuredEventType eventType;\n+\n+    private Long resourceId;\n+\n+    private String resourceCrn;\n+\n+    private String resourceName;\n+\n+    private String resourceType;\n+\n+    private Long timestamp;\n+\n+    private String cloudbreakId;\n+\n+    private String cloudbreakVersion;\n+\n+    private String accountId;\n+\n+    private String uuid;\n+\n+    private String userCrn;\n+\n+    private String environmentCrn;\n+\n+    private String resourceEvent;\n+\n+    public CDPOperationDetails() {\n+    }\n+\n+    public CDPOperationDetails(Long timestamp, StructuredEventType eventType, String resourceType, Long resourceId, String resourceName, String cloudbreakId,\n+        String cloudbreakVersion, String accountId, String resourceCrn, String userCrn, String environmentCrn, String resourceEvent) {\n+        this.timestamp = timestamp;\n+        this.eventType = eventType;\n+        this.resourceId = resourceId;\n+        this.resourceName = resourceName;\n+        this.resourceType = resourceType;\n+        this.cloudbreakId = cloudbreakId;\n+        this.cloudbreakVersion = cloudbreakVersion;\n+        this.resourceCrn = resourceCrn;\n+        this.userCrn = userCrn;\n+        this.accountId = accountId;\n+        this.environmentCrn = environmentCrn;\n+        this.resourceEvent = resourceEvent;\n+        uuid = UUID.randomUUID().toString();\n+    }\n+\n+    public StructuredEventType getEventType() {\n+        return eventType;\n+    }\n+\n+    public void setEventType(StructuredEventType eventType) {\n+        this.eventType = eventType;\n+    }\n+\n+    public String getResourceType() {\n+        return resourceType;\n+    }\n+\n+    public void setResourceType(String resourceType) {\n+        this.resourceType = resourceType;\n+    }\n+\n+    public Long getResourceId() {\n+        return resourceId;\n+    }\n+\n+    public void setResourceId(Long resourceId) {\n+        this.resourceId = resourceId;\n+    }\n+\n+    public String getResourceName() {\n+        return resourceName;\n+    }\n+\n+    public void setResourceName(String resourceName) {\n+        this.resourceName = resourceName;\n+    }\n+\n+    public Long getTimestamp() {\n+        return timestamp;\n+    }\n+\n+    public void setTimestamp(Long timestamp) {\n+        this.timestamp = timestamp;\n+    }\n+\n+    public String getUTCDateTime() {", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1NTg1NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487055854", "bodyText": "why not initialize the field with a Collections.emptyList() and then the getter won't have any logic. At least I think we usually handle this way. same applies to the others", "author": "lacikaaa", "createdAt": "2020-09-11T13:46:25Z", "path": "structuredevent-model/src/main/java/com/sequenceiq/cloudbreak/structuredevent/event/cdp/CDPStructuredEventContainer.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.sequenceiq.cloudbreak.structuredevent.event.cdp;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class CDPStructuredEventContainer {\n+\n+    private List<CDPStructuredFlowEvent> flow;\n+\n+    private List<CDPStructuredRestCallEvent> rest;\n+\n+    private List<CDPStructuredNotificationEvent> notification;\n+\n+    public CDPStructuredEventContainer() {\n+    }\n+\n+    public CDPStructuredEventContainer(\n+        List<CDPStructuredFlowEvent> flow,\n+        List<CDPStructuredRestCallEvent> rest,\n+        List<CDPStructuredNotificationEvent> notification) {\n+        this.flow = flow;\n+        this.rest = rest;\n+        this.notification = notification;\n+    }\n+\n+    public List<CDPStructuredFlowEvent> getFlow() {\n+        return flow != null ? flow : Collections.emptyList();", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1Njg1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487056850", "bodyText": "do we need these or could be deleted? if can be then you should return in the first line and you don't need the state variaable", "author": "lacikaaa", "createdAt": "2020-09-11T13:47:59Z", "path": "structuredevent-model/src/main/java/com/sequenceiq/cloudbreak/structuredevent/event/cdp/CDPStructuredFlowEvent.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package com.sequenceiq.cloudbreak.structuredevent.event.cdp;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import com.sequenceiq.cloudbreak.structuredevent.event.FlowDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.json.Base64Deserializer;\n+import com.sequenceiq.cloudbreak.structuredevent.json.Base64Serializer;\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class CDPStructuredFlowEvent<T> extends CDPStructuredEvent {\n+    private FlowDetails flow;\n+\n+    @JsonSerialize(using = Base64Serializer.class)\n+    @JsonDeserialize(using = Base64Deserializer.class)\n+    private String exception;\n+\n+    private T payload;\n+\n+    public CDPStructuredFlowEvent() {\n+        super(CDPStructuredFlowEvent.class.getSimpleName());\n+    }\n+\n+    public CDPStructuredFlowEvent(String type, CDPOperationDetails operation, FlowDetails flow, T payload) {\n+        super(type, operation);\n+        this.flow = flow;\n+        this.payload = payload;\n+    }\n+\n+    @Override\n+    public String getStatus() {\n+        String state = flow.getFlowState();\n+//        if (\"unknown\".equals(state)) {\n+//            state = getOperation().getResourceType().toUpperCase()\n+//            if (stack != null) {\n+//                state = \"STACK_\" + stack.getDetailedStatus();\n+//            }\n+//            if (cluster != null) {\n+//                state += \" | CLUSTER_\" + cluster.getStatus();\n+//            }\n+//        }", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1NzkyNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487057926", "bodyText": "I think T should be serializable", "author": "lacikaaa", "createdAt": "2020-09-11T13:49:45Z", "path": "structuredevent-model/src/main/java/com/sequenceiq/cloudbreak/structuredevent/event/cdp/CDPStructuredFlowEvent.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package com.sequenceiq.cloudbreak.structuredevent.event.cdp;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import com.sequenceiq.cloudbreak.structuredevent.event.FlowDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.json.Base64Deserializer;\n+import com.sequenceiq.cloudbreak.structuredevent.json.Base64Serializer;\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class CDPStructuredFlowEvent<T> extends CDPStructuredEvent {", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg3Nzk2Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487877962", "bodyText": "I don't want to add the Serializable to the generic type. Sometimes generate unnecessary changes/refactors.", "author": "topolyai5", "createdAt": "2020-09-14T12:37:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1NzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg4NjA2OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487886068", "bodyText": "but CDPStructuredEvent is serializable and a class is only serializable if all the fields are serializable or transient. In this case you don't have to modify anything else as I have checked and the constructor is used only at one place where payload is set to null", "author": "lacikaaa", "createdAt": "2020-09-14T12:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1NzkyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1ODc0Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487058743", "bodyText": "why do we need this max? duration can be negative?", "author": "lacikaaa", "createdAt": "2020-09-11T13:50:58Z", "path": "structuredevent-model/src/main/java/com/sequenceiq/cloudbreak/structuredevent/event/cdp/CDPStructuredFlowEvent.java", "diffHunk": "@@ -0,0 +1,73 @@\n+package com.sequenceiq.cloudbreak.structuredevent.event.cdp;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import com.sequenceiq.cloudbreak.structuredevent.event.FlowDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.json.Base64Deserializer;\n+import com.sequenceiq.cloudbreak.structuredevent.json.Base64Serializer;\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class CDPStructuredFlowEvent<T> extends CDPStructuredEvent {\n+    private FlowDetails flow;\n+\n+    @JsonSerialize(using = Base64Serializer.class)\n+    @JsonDeserialize(using = Base64Deserializer.class)\n+    private String exception;\n+\n+    private T payload;\n+\n+    public CDPStructuredFlowEvent() {\n+        super(CDPStructuredFlowEvent.class.getSimpleName());\n+    }\n+\n+    public CDPStructuredFlowEvent(String type, CDPOperationDetails operation, FlowDetails flow, T payload) {\n+        super(type, operation);\n+        this.flow = flow;\n+        this.payload = payload;\n+    }\n+\n+    @Override\n+    public String getStatus() {\n+        String state = flow.getFlowState();\n+//        if (\"unknown\".equals(state)) {\n+//            state = getOperation().getResourceType().toUpperCase()\n+//            if (stack != null) {\n+//                state = \"STACK_\" + stack.getDetailedStatus();\n+//            }\n+//            if (cluster != null) {\n+//                state += \" | CLUSTER_\" + cluster.getStatus();\n+//            }\n+//        }\n+        return state;\n+    }\n+\n+    @Override\n+    public Long getDuration() {\n+        return Math.max(0L, flow.getDuration());", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2MDE2NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487060165", "bodyText": "these 2 could be static final variable", "author": "lacikaaa", "createdAt": "2020-09-11T13:53:07Z", "path": "structuredevent-model/src/main/java/com/sequenceiq/cloudbreak/structuredevent/event/cdp/CDPStructuredNotificationEvent.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.sequenceiq.cloudbreak.structuredevent.event.cdp;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.sequenceiq.cloudbreak.structuredevent.event.LdapNotificationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.RdsNotificationDetails;\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class CDPStructuredNotificationEvent extends CDPStructuredEvent {\n+\n+    private LdapNotificationDetails ldapNotificationDetails;\n+\n+    private RdsNotificationDetails rdsNotificationDetails;\n+\n+    private CDPStructuredNotificationDetails notificationDetails;\n+\n+    public CDPStructuredNotificationEvent() {\n+        super(CDPStructuredNotificationEvent.class.getSimpleName());\n+    }\n+\n+    public CDPStructuredNotificationEvent(CDPOperationDetails operation, CDPStructuredNotificationDetails notificationDetails) {\n+        super(CDPStructuredNotificationEvent.class.getSimpleName(), operation);\n+        this.notificationDetails = notificationDetails;\n+        ldapNotificationDetails = null;\n+        rdsNotificationDetails = null;\n+    }\n+\n+    public CDPStructuredNotificationEvent(CDPOperationDetails operation, LdapNotificationDetails ldapNotificationDetails) {\n+        super(CDPStructuredNotificationEvent.class.getSimpleName(), operation);\n+        this.ldapNotificationDetails = ldapNotificationDetails;\n+        rdsNotificationDetails = null;\n+    }\n+\n+    public CDPStructuredNotificationEvent(CDPOperationDetails operation, RdsNotificationDetails rdsNotificationDetails) {\n+        super(CDPStructuredNotificationEvent.class.getSimpleName(), operation);\n+        ldapNotificationDetails = null;\n+        this.rdsNotificationDetails = rdsNotificationDetails;\n+    }\n+\n+    @Override\n+    public String getStatus() {\n+        return \"SENT\";\n+    }\n+\n+    @Override\n+    public Long getDuration() {\n+        return 0L;\n+    }", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2MjcxNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487062716", "bodyText": "why these null initializations required? the same for those in the other constructors", "author": "lacikaaa", "createdAt": "2020-09-11T13:56:57Z", "path": "structuredevent-model/src/main/java/com/sequenceiq/cloudbreak/structuredevent/event/cdp/CDPStructuredNotificationEvent.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.sequenceiq.cloudbreak.structuredevent.event.cdp;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.sequenceiq.cloudbreak.structuredevent.event.LdapNotificationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.RdsNotificationDetails;\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class CDPStructuredNotificationEvent extends CDPStructuredEvent {\n+\n+    private LdapNotificationDetails ldapNotificationDetails;\n+\n+    private RdsNotificationDetails rdsNotificationDetails;\n+\n+    private CDPStructuredNotificationDetails notificationDetails;\n+\n+    public CDPStructuredNotificationEvent() {\n+        super(CDPStructuredNotificationEvent.class.getSimpleName());\n+    }\n+\n+    public CDPStructuredNotificationEvent(CDPOperationDetails operation, CDPStructuredNotificationDetails notificationDetails) {\n+        super(CDPStructuredNotificationEvent.class.getSimpleName(), operation);\n+        this.notificationDetails = notificationDetails;\n+        ldapNotificationDetails = null;\n+        rdsNotificationDetails = null;", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2NDcxMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487064712", "bodyText": "are we sure restcall has always a non null restresponse? I don't see anything in RestCallDetails what would ensure that", "author": "lacikaaa", "createdAt": "2020-09-11T14:00:06Z", "path": "structuredevent-model/src/main/java/com/sequenceiq/cloudbreak/structuredevent/event/cdp/CDPStructuredRestCallEvent.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package com.sequenceiq.cloudbreak.structuredevent.event.cdp;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestCallDetails;\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class CDPStructuredRestCallEvent extends CDPStructuredEvent {\n+    private RestCallDetails restCall;\n+\n+    public CDPStructuredRestCallEvent() {\n+        super(CDPStructuredRestCallEvent.class.getSimpleName());\n+    }\n+\n+    public CDPStructuredRestCallEvent(CDPOperationDetails operation, RestCallDetails restCall) {\n+        super(CDPStructuredRestCallEvent.class.getSimpleName(), operation);\n+        this.restCall = restCall;\n+    }\n+\n+    @Override\n+    public String getStatus() {\n+        return restCall.getRestResponse().getStatusText() != null", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc0ODc1Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487748756", "bodyText": "yes, it cannot be null: CDPStructuredEventFilter#326-335", "author": "topolyai5", "createdAt": "2020-09-14T08:44:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2NDcxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2NTc4Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487065782", "bodyText": "do we need this empty class?", "author": "lacikaaa", "createdAt": "2020-09-11T14:01:50Z", "path": "structuredevent-service-cdp/src/main/java/com/sequenceiq/cloudbreak/structuredevent/config/CDPStructuredEventConfig.java", "diffHunk": "@@ -0,0 +1,7 @@\n+package com.sequenceiq.cloudbreak.structuredevent.config;\n+\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class CDPStructuredEventConfig {", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA4ODM1NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487088354", "bodyText": "it's a bit hard to follow this method, similarly to getResourceId. Could you refactor this a bit to make it more readable?", "author": "lacikaaa", "createdAt": "2020-09-11T14:35:59Z", "path": "structuredevent-service-cdp/src/main/java/com/sequenceiq/cloudbreak/structuredevent/rest/CDPRestCommonService.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package com.sequenceiq.cloudbreak.structuredevent.rest;\n+\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.ID_TYPE;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.collections.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.common.anonymizer.AnonymizerUtil;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.cloudbreak.common.json.JsonUtil;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestCallDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestRequestDetails;\n+\n+@Component\n+public class CDPRestCommonService {\n+\n+    public static final String NAME_PATH = \"name\";\n+\n+    public static final String NAMES_PATH = \"names\";\n+\n+    public static final String RESOURCE_CRN_PATH = \"crn\";\n+\n+    public static final String CRNS_PATH = \"crns\";\n+\n+    public Map<String, String> addClusterCrnAndNameIfPresent(RestCallDetails restCallDetails, Map<String, String> restParams, String nameField,\n+            String crnField) {\n+        Map<String, String> params = new HashMap<>();\n+        RestRequestDetails restRequest = restCallDetails.getRestRequest();\n+        Json requestJson = getJson(restRequest.getBody());\n+        Json responseJson = getJson(restCallDetails.getRestResponse().getBody());\n+        String resourceCrn = getCrn(requestJson, responseJson, restRequest, restParams, crnField);\n+        String name = getName(requestJson, responseJson, restRequest, restParams, nameField);\n+\n+        checkNameOrCrnProvided(restRequest, resourceCrn, name);\n+\n+        if (StringUtils.isNotEmpty(name)) {\n+            params.put(nameField, name);\n+        }\n+\n+        if (StringUtils.isNotEmpty(resourceCrn)) {\n+            params.put(crnField, resourceCrn);\n+        }\n+        return params;\n+    }\n+\n+    private String getName(Json requestJson, Json responseJson, RestRequestDetails request, Map<String, String> restParams, String nameField) {\n+        if (StringUtils.isEmpty(restParams.get(nameField))) {\n+            return getResourceId(requestJson, responseJson, request, NAME_PATH, NAMES_PATH, restParams, \"name\");\n+        }\n+        return restParams.get(nameField);\n+    }\n+\n+    private String getCrn(Json requestJson, Json responseJson, RestRequestDetails request, Map<String, String> restParams, String crnField) {\n+        if (StringUtils.isEmpty(restParams.get(crnField))) {\n+            return getResourceId(requestJson, responseJson, request, RESOURCE_CRN_PATH, CRNS_PATH, restParams, \"crn\");\n+        }\n+        return restParams.get(crnField);\n+    }\n+\n+    private String getResourceId(Json requestJson, Json responseJson, RestRequestDetails request, String path, String pluralPath, Map<String, String> restParams,\n+            String idType) {\n+        String id = null;\n+        if (requestJson != null) {\n+            id = getValueFromJson(requestJson, path);\n+            if (StringUtils.isEmpty(id)) {\n+                id = getListValue(request, requestJson, pluralPath, restParams, idType);\n+            }\n+        }\n+        if (responseJson != null && StringUtils.isEmpty(id)) {\n+                id = Optional.ofNullable(getValueFromJson(responseJson, path))\n+                        .orElse(getListValue(request, responseJson, pluralPath, restParams, idType));\n+        }\n+        return id;\n+    }\n+\n+    private String getListValue(RestRequestDetails restRequest, Json json, String path, Map<String, String> restParams, String idType) {", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA4ODUwMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487088502", "bodyText": "please add unit tests", "author": "lacikaaa", "createdAt": "2020-09-11T14:36:11Z", "path": "structuredevent-service-cdp/src/main/java/com/sequenceiq/cloudbreak/structuredevent/rest/CDPRestCommonService.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package com.sequenceiq.cloudbreak.structuredevent.rest;\n+\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.ID_TYPE;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.collections.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.common.anonymizer.AnonymizerUtil;\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.cloudbreak.common.json.JsonUtil;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestCallDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestRequestDetails;\n+\n+@Component\n+public class CDPRestCommonService {", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA5MTY0OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487091649", "bodyText": "not used anywhere", "author": "lacikaaa", "createdAt": "2020-09-11T14:40:56Z", "path": "structuredevent-service-cdp/src/main/java/com/sequenceiq/cloudbreak/structuredevent/rest/filter/CDPStructuredEventFilter.java", "diffHunk": "@@ -0,0 +1,383 @@\n+package com.sequenceiq.cloudbreak.structuredevent.rest.filter;\n+\n+import static com.sequenceiq.cloudbreak.structuredevent.event.StructuredEventType.REST;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_CRN;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_EVENT;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_ID;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_NAME;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_TYPE;\n+\n+import java.io.BufferedInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.FilterOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.charset.Charset;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.Objects;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import javax.annotation.PostConstruct;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.WebApplicationException;\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.ContainerRequestFilter;\n+import javax.ws.rs.container.ContainerResponseContext;\n+import javax.ws.rs.container.ContainerResponseFilter;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.ext.WriterInterceptor;\n+import javax.ws.rs.ext.WriterInterceptorContext;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.lang3.BooleanUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.glassfish.jersey.message.MessageUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.ListableBeanFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.core.annotation.AnnotationUtils;\n+import org.springframework.stereotype.Component;\n+\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Maps;\n+import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n+import com.sequenceiq.cloudbreak.auth.security.authentication.AuthenticatedUserService;\n+import com.sequenceiq.cloudbreak.common.user.CloudbreakUser;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPOperationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredRestCallEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestCallDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestRequestDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestResponseDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.repository.AccountAwareResourceRepository;\n+import com.sequenceiq.cloudbreak.structuredevent.rest.CDPRestCommonService;\n+import com.sequenceiq.cloudbreak.structuredevent.rest.annotation.AccountEntityType;\n+import com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser;\n+import com.sequenceiq.cloudbreak.structuredevent.service.CDPBaseRestRequestThreadLocalService;\n+import com.sequenceiq.cloudbreak.structuredevent.service.CDPDefaultStructuredEventClient;\n+import com.sequenceiq.cloudbreak.structuredevent.service.lookup.CDPAccountAwareRepositoryLookupService;\n+import com.sequenceiq.flow.ha.NodeConfig;\n+\n+@Component\n+public class CDPStructuredEventFilter implements WriterInterceptor, ContainerRequestFilter, ContainerResponseFilter {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(CDPStructuredEventFilter.class);\n+\n+    private static final String LOGGING_ENABLED_PROPERTY = \"structuredevent.loggingEnabled\";\n+\n+    private static final String LOGGINGSTREAM_PROPERTY = \"structuredevent.entityLogger\";\n+\n+    private static final String REST_PARAMS = \"REST_PARAMS\";\n+\n+    private static final String REQUEST_TIME = \"REQUEST_TIME\";\n+\n+    private static final String REQUEST_DETAILS = \"REQUEST_DETAIS\";\n+\n+    private static final String RESPONSE_DETAILS = \"RESPONSE_DETAIS\";\n+\n+    private static final int MAX_CONTENT_LENGTH = 65535;\n+\n+    private static final String ID = \"id\";\n+\n+    private static final String CRN = \"crn\";\n+\n+    private final List<String> skippedHeadersList = Lists.newArrayList(\"authorization\");\n+\n+    private final Map<String, AccountAwareResourceRepository<?, ?>> pathRepositoryMap = new HashMap<>();\n+\n+    private final Pattern extractIdRestParamFromResponsePattern = Pattern.compile(\"\\\"\" + ID + \"\\\":([0-9]*)\");\n+\n+    private final Pattern extractCrnRestParamFromResponsePattern = Pattern.compile(\"\\\"\" + CRN + \"\\\":\\\"([0-9a-zA-Z:-]*)\\\"\");", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA5NzYwOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487097609", "bodyText": "could you break up this method? it too long and could be refactored", "author": "lacikaaa", "createdAt": "2020-09-11T14:49:36Z", "path": "structuredevent-service-cdp/src/main/java/com/sequenceiq/cloudbreak/structuredevent/rest/filter/CDPStructuredEventFilter.java", "diffHunk": "@@ -0,0 +1,383 @@\n+package com.sequenceiq.cloudbreak.structuredevent.rest.filter;\n+\n+import static com.sequenceiq.cloudbreak.structuredevent.event.StructuredEventType.REST;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_CRN;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_EVENT;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_ID;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_NAME;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_TYPE;\n+\n+import java.io.BufferedInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.FilterOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.charset.Charset;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.Objects;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import javax.annotation.PostConstruct;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.WebApplicationException;\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.ContainerRequestFilter;\n+import javax.ws.rs.container.ContainerResponseContext;\n+import javax.ws.rs.container.ContainerResponseFilter;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.ext.WriterInterceptor;\n+import javax.ws.rs.ext.WriterInterceptorContext;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.lang3.BooleanUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.glassfish.jersey.message.MessageUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.ListableBeanFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.core.annotation.AnnotationUtils;\n+import org.springframework.stereotype.Component;\n+\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Maps;\n+import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n+import com.sequenceiq.cloudbreak.auth.security.authentication.AuthenticatedUserService;\n+import com.sequenceiq.cloudbreak.common.user.CloudbreakUser;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPOperationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredRestCallEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestCallDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestRequestDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestResponseDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.repository.AccountAwareResourceRepository;\n+import com.sequenceiq.cloudbreak.structuredevent.rest.CDPRestCommonService;\n+import com.sequenceiq.cloudbreak.structuredevent.rest.annotation.AccountEntityType;\n+import com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser;\n+import com.sequenceiq.cloudbreak.structuredevent.service.CDPBaseRestRequestThreadLocalService;\n+import com.sequenceiq.cloudbreak.structuredevent.service.CDPDefaultStructuredEventClient;\n+import com.sequenceiq.cloudbreak.structuredevent.service.lookup.CDPAccountAwareRepositoryLookupService;\n+import com.sequenceiq.flow.ha.NodeConfig;\n+\n+@Component\n+public class CDPStructuredEventFilter implements WriterInterceptor, ContainerRequestFilter, ContainerResponseFilter {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(CDPStructuredEventFilter.class);\n+\n+    private static final String LOGGING_ENABLED_PROPERTY = \"structuredevent.loggingEnabled\";\n+\n+    private static final String LOGGINGSTREAM_PROPERTY = \"structuredevent.entityLogger\";\n+\n+    private static final String REST_PARAMS = \"REST_PARAMS\";\n+\n+    private static final String REQUEST_TIME = \"REQUEST_TIME\";\n+\n+    private static final String REQUEST_DETAILS = \"REQUEST_DETAIS\";\n+\n+    private static final String RESPONSE_DETAILS = \"RESPONSE_DETAIS\";\n+\n+    private static final int MAX_CONTENT_LENGTH = 65535;\n+\n+    private static final String ID = \"id\";\n+\n+    private static final String CRN = \"crn\";\n+\n+    private final List<String> skippedHeadersList = Lists.newArrayList(\"authorization\");\n+\n+    private final Map<String, AccountAwareResourceRepository<?, ?>> pathRepositoryMap = new HashMap<>();\n+\n+    private final Pattern extractIdRestParamFromResponsePattern = Pattern.compile(\"\\\"\" + ID + \"\\\":([0-9]*)\");\n+\n+    private final Pattern extractCrnRestParamFromResponsePattern = Pattern.compile(\"\\\"\" + CRN + \"\\\":\\\"([0-9a-zA-Z:-]*)\\\"\");\n+\n+    @Value(\"${info.app.version:}\")\n+    private String cbVersion;\n+\n+    @Value(\"${cdp.structuredevent.rest.contentlogging}\")\n+    private Boolean contentLogging;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private NodeConfig nodeConfig;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private CDPBaseRestRequestThreadLocalService cloudbreakRestRequestThreadLocalService;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private CDPDefaultStructuredEventClient structuredEventClient;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private AuthenticatedUserService authenticatedUserService;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private List<CDPRestUrlParser> cdpRestUrlParsers;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private ApplicationContext applicationContext;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private ListableBeanFactory listableBeanFactory;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private CDPAccountAwareRepositoryLookupService repositoryLookupService;\n+\n+    @Autowired\n+    private CDPRestCommonService restCommonService;\n+\n+    @PostConstruct\n+    public void initializePathRepositoryMap() {\n+        Map<String, Object> accountEntityTypes = listableBeanFactory.getBeansWithAnnotation(AccountEntityType.class);\n+        for (Object accountEntityType : accountEntityTypes.values()) {\n+            Path pathAnnotation = AnnotationUtils.findAnnotation(accountEntityType.getClass().getSuperclass(), Path.class);\n+            AccountEntityType entityTypeAnnotation = AnnotationUtils.findAnnotation(accountEntityType.getClass(), AccountEntityType.class);\n+            if (pathAnnotation != null) {\n+                String pathValue = pathAnnotation.value();\n+                Class<?> entityClass = entityTypeAnnotation.value();\n+                AccountAwareResourceRepository<?, ?> repository = repositoryLookupService.getRepositoryForEntity(entityClass);\n+                pathRepositoryMap.put(pathValue, repository);\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void filter(ContainerRequestContext requestContext) throws IOException {\n+        boolean loggingEnabled = isLoggingEnabled(requestContext);\n+        requestContext.setProperty(LOGGING_ENABLED_PROPERTY, loggingEnabled);\n+        if (loggingEnabled) {\n+            requestContext.setProperty(REQUEST_TIME, System.currentTimeMillis());\n+            StringBuilder body = new StringBuilder();\n+            requestContext.setEntityStream(logInboundEntity(body, requestContext.getEntityStream(), MessageUtils.getCharset(requestContext.getMediaType())));\n+            requestContext.setProperty(REST_PARAMS, getRequestUrlParameters(requestContext));\n+            requestContext.setProperty(REQUEST_DETAILS, createRequestDetails(requestContext, body.toString()));\n+        }\n+    }\n+\n+    @Override\n+    public void filter(ContainerRequestContext requestContext, ContainerResponseContext responseContext) {\n+        if (BooleanUtils.isTrue((Boolean) requestContext.getProperty(LOGGING_ENABLED_PROPERTY))) {\n+            RestResponseDetails restResponse = createResponseDetails(responseContext);\n+            if (responseContext.hasEntity()) {\n+                OutputStream stream = new LoggingStream(responseContext.getEntityStream());\n+                responseContext.setEntityStream(stream);\n+                requestContext.setProperty(LOGGINGSTREAM_PROPERTY, stream);\n+                requestContext.setProperty(RESPONSE_DETAILS, restResponse);\n+            } else {\n+                Long requestTime = (Long) requestContext.getProperty(REQUEST_TIME);\n+                RestRequestDetails restRequest = (RestRequestDetails) requestContext.getProperty(REQUEST_DETAILS);\n+                Map<String, String> restParams = (Map<String, String>) requestContext.getProperty(REST_PARAMS);\n+                sendStructuredEvent(restRequest, restResponse, restParams, requestTime, \"\");\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void aroundWriteTo(WriterInterceptorContext context) throws IOException, WebApplicationException {\n+        context.proceed();\n+        if (BooleanUtils.isTrue((Boolean) context.getProperty(LOGGING_ENABLED_PROPERTY))) {\n+            Long requestTime = (Long) context.getProperty(REQUEST_TIME);\n+            RestRequestDetails restRequest = (RestRequestDetails) context.getProperty(REQUEST_DETAILS);\n+            RestResponseDetails restResponse = (RestResponseDetails) context.getProperty(RESPONSE_DETAILS);\n+            String responseBody = ((LoggingStream) context.getProperty(LOGGINGSTREAM_PROPERTY)).getStringBuilder(\n+                    MessageUtils.getCharset(context.getMediaType())).toString();\n+            Map<String, String> restParams = (Map<String, String>) context.getProperty(REST_PARAMS);\n+            if (restParams == null) {\n+                restParams = new HashMap<>();\n+            }\n+            sendStructuredEvent(restRequest, restResponse, restParams, requestTime, responseBody);\n+        }\n+    }\n+\n+    private void sendStructuredEvent(RestRequestDetails restRequest, RestResponseDetails restResponse, Map<String, String> restParams, Long requestTime,", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg1NzkzNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487857934", "bodyText": "Here is the jira for tracking this: https://jira.cloudera.com/browse/CB-8777", "author": "topolyai5", "createdAt": "2020-09-14T12:02:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA5NzYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA5Nzk4OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487097989", "bodyText": "please don't return in the middle of the method, at least add an else branch", "author": "lacikaaa", "createdAt": "2020-09-11T14:50:09Z", "path": "structuredevent-service-cdp/src/main/java/com/sequenceiq/cloudbreak/structuredevent/rest/filter/CDPStructuredEventFilter.java", "diffHunk": "@@ -0,0 +1,383 @@\n+package com.sequenceiq.cloudbreak.structuredevent.rest.filter;\n+\n+import static com.sequenceiq.cloudbreak.structuredevent.event.StructuredEventType.REST;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_CRN;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_EVENT;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_ID;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_NAME;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_TYPE;\n+\n+import java.io.BufferedInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.FilterOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.charset.Charset;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.Objects;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import javax.annotation.PostConstruct;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.WebApplicationException;\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.ContainerRequestFilter;\n+import javax.ws.rs.container.ContainerResponseContext;\n+import javax.ws.rs.container.ContainerResponseFilter;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.ext.WriterInterceptor;\n+import javax.ws.rs.ext.WriterInterceptorContext;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.lang3.BooleanUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.glassfish.jersey.message.MessageUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.ListableBeanFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.core.annotation.AnnotationUtils;\n+import org.springframework.stereotype.Component;\n+\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Maps;\n+import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n+import com.sequenceiq.cloudbreak.auth.security.authentication.AuthenticatedUserService;\n+import com.sequenceiq.cloudbreak.common.user.CloudbreakUser;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPOperationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredRestCallEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestCallDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestRequestDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestResponseDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.repository.AccountAwareResourceRepository;\n+import com.sequenceiq.cloudbreak.structuredevent.rest.CDPRestCommonService;\n+import com.sequenceiq.cloudbreak.structuredevent.rest.annotation.AccountEntityType;\n+import com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser;\n+import com.sequenceiq.cloudbreak.structuredevent.service.CDPBaseRestRequestThreadLocalService;\n+import com.sequenceiq.cloudbreak.structuredevent.service.CDPDefaultStructuredEventClient;\n+import com.sequenceiq.cloudbreak.structuredevent.service.lookup.CDPAccountAwareRepositoryLookupService;\n+import com.sequenceiq.flow.ha.NodeConfig;\n+\n+@Component\n+public class CDPStructuredEventFilter implements WriterInterceptor, ContainerRequestFilter, ContainerResponseFilter {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(CDPStructuredEventFilter.class);\n+\n+    private static final String LOGGING_ENABLED_PROPERTY = \"structuredevent.loggingEnabled\";\n+\n+    private static final String LOGGINGSTREAM_PROPERTY = \"structuredevent.entityLogger\";\n+\n+    private static final String REST_PARAMS = \"REST_PARAMS\";\n+\n+    private static final String REQUEST_TIME = \"REQUEST_TIME\";\n+\n+    private static final String REQUEST_DETAILS = \"REQUEST_DETAIS\";\n+\n+    private static final String RESPONSE_DETAILS = \"RESPONSE_DETAIS\";\n+\n+    private static final int MAX_CONTENT_LENGTH = 65535;\n+\n+    private static final String ID = \"id\";\n+\n+    private static final String CRN = \"crn\";\n+\n+    private final List<String> skippedHeadersList = Lists.newArrayList(\"authorization\");\n+\n+    private final Map<String, AccountAwareResourceRepository<?, ?>> pathRepositoryMap = new HashMap<>();\n+\n+    private final Pattern extractIdRestParamFromResponsePattern = Pattern.compile(\"\\\"\" + ID + \"\\\":([0-9]*)\");\n+\n+    private final Pattern extractCrnRestParamFromResponsePattern = Pattern.compile(\"\\\"\" + CRN + \"\\\":\\\"([0-9a-zA-Z:-]*)\\\"\");\n+\n+    @Value(\"${info.app.version:}\")\n+    private String cbVersion;\n+\n+    @Value(\"${cdp.structuredevent.rest.contentlogging}\")\n+    private Boolean contentLogging;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private NodeConfig nodeConfig;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private CDPBaseRestRequestThreadLocalService cloudbreakRestRequestThreadLocalService;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private CDPDefaultStructuredEventClient structuredEventClient;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private AuthenticatedUserService authenticatedUserService;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private List<CDPRestUrlParser> cdpRestUrlParsers;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private ApplicationContext applicationContext;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private ListableBeanFactory listableBeanFactory;\n+\n+    //Do not remove the @Autowired annotation Jersey is able to inject dependencies that are instantiated by Spring this way only!\n+    @Autowired\n+    private CDPAccountAwareRepositoryLookupService repositoryLookupService;\n+\n+    @Autowired\n+    private CDPRestCommonService restCommonService;\n+\n+    @PostConstruct\n+    public void initializePathRepositoryMap() {\n+        Map<String, Object> accountEntityTypes = listableBeanFactory.getBeansWithAnnotation(AccountEntityType.class);\n+        for (Object accountEntityType : accountEntityTypes.values()) {\n+            Path pathAnnotation = AnnotationUtils.findAnnotation(accountEntityType.getClass().getSuperclass(), Path.class);\n+            AccountEntityType entityTypeAnnotation = AnnotationUtils.findAnnotation(accountEntityType.getClass(), AccountEntityType.class);\n+            if (pathAnnotation != null) {\n+                String pathValue = pathAnnotation.value();\n+                Class<?> entityClass = entityTypeAnnotation.value();\n+                AccountAwareResourceRepository<?, ?> repository = repositoryLookupService.getRepositoryForEntity(entityClass);\n+                pathRepositoryMap.put(pathValue, repository);\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void filter(ContainerRequestContext requestContext) throws IOException {\n+        boolean loggingEnabled = isLoggingEnabled(requestContext);\n+        requestContext.setProperty(LOGGING_ENABLED_PROPERTY, loggingEnabled);\n+        if (loggingEnabled) {\n+            requestContext.setProperty(REQUEST_TIME, System.currentTimeMillis());\n+            StringBuilder body = new StringBuilder();\n+            requestContext.setEntityStream(logInboundEntity(body, requestContext.getEntityStream(), MessageUtils.getCharset(requestContext.getMediaType())));\n+            requestContext.setProperty(REST_PARAMS, getRequestUrlParameters(requestContext));\n+            requestContext.setProperty(REQUEST_DETAILS, createRequestDetails(requestContext, body.toString()));\n+        }\n+    }\n+\n+    @Override\n+    public void filter(ContainerRequestContext requestContext, ContainerResponseContext responseContext) {\n+        if (BooleanUtils.isTrue((Boolean) requestContext.getProperty(LOGGING_ENABLED_PROPERTY))) {\n+            RestResponseDetails restResponse = createResponseDetails(responseContext);\n+            if (responseContext.hasEntity()) {\n+                OutputStream stream = new LoggingStream(responseContext.getEntityStream());\n+                responseContext.setEntityStream(stream);\n+                requestContext.setProperty(LOGGINGSTREAM_PROPERTY, stream);\n+                requestContext.setProperty(RESPONSE_DETAILS, restResponse);\n+            } else {\n+                Long requestTime = (Long) requestContext.getProperty(REQUEST_TIME);\n+                RestRequestDetails restRequest = (RestRequestDetails) requestContext.getProperty(REQUEST_DETAILS);\n+                Map<String, String> restParams = (Map<String, String>) requestContext.getProperty(REST_PARAMS);\n+                sendStructuredEvent(restRequest, restResponse, restParams, requestTime, \"\");\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void aroundWriteTo(WriterInterceptorContext context) throws IOException, WebApplicationException {\n+        context.proceed();\n+        if (BooleanUtils.isTrue((Boolean) context.getProperty(LOGGING_ENABLED_PROPERTY))) {\n+            Long requestTime = (Long) context.getProperty(REQUEST_TIME);\n+            RestRequestDetails restRequest = (RestRequestDetails) context.getProperty(REQUEST_DETAILS);\n+            RestResponseDetails restResponse = (RestResponseDetails) context.getProperty(RESPONSE_DETAILS);\n+            String responseBody = ((LoggingStream) context.getProperty(LOGGINGSTREAM_PROPERTY)).getStringBuilder(\n+                    MessageUtils.getCharset(context.getMediaType())).toString();\n+            Map<String, String> restParams = (Map<String, String>) context.getProperty(REST_PARAMS);\n+            if (restParams == null) {\n+                restParams = new HashMap<>();\n+            }\n+            sendStructuredEvent(restRequest, restResponse, restParams, requestTime, responseBody);\n+        }\n+    }\n+\n+    private void sendStructuredEvent(RestRequestDetails restRequest, RestResponseDetails restResponse, Map<String, String> restParams, Long requestTime,\n+            String responseBody) {\n+        boolean valid = checkRestParams(restParams);\n+        try {\n+            if (!valid) {\n+                LOGGER.debug(\"Cannot create structured event, because rest params are invalid.\");\n+                return;\n+            }", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg3Njg0Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487876843", "bodyText": "I will refactor this return; in the follow-up jira.", "author": "topolyai5", "createdAt": "2020-09-14T12:35:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA5Nzk4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA5OTYyNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487099625", "bodyText": "this is a bit complicated class with a lot of logic and hard to follow/understand. no one would dare to touch it if you don't cover this with unit tests pretty well.\nalso some refactor would be nice, the high number of Autowires indicate the same also that maybe the whole class could be refactored into smaller ones which is easier to understand, maintain and test", "author": "lacikaaa", "createdAt": "2020-09-11T14:52:46Z", "path": "structuredevent-service-cdp/src/main/java/com/sequenceiq/cloudbreak/structuredevent/rest/filter/CDPStructuredEventFilter.java", "diffHunk": "@@ -0,0 +1,383 @@\n+package com.sequenceiq.cloudbreak.structuredevent.rest.filter;\n+\n+import static com.sequenceiq.cloudbreak.structuredevent.event.StructuredEventType.REST;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_CRN;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_EVENT;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_ID;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_NAME;\n+import static com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser.RESOURCE_TYPE;\n+\n+import java.io.BufferedInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.FilterOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.charset.Charset;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.Objects;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+import javax.annotation.PostConstruct;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.WebApplicationException;\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.ContainerRequestFilter;\n+import javax.ws.rs.container.ContainerResponseContext;\n+import javax.ws.rs.container.ContainerResponseFilter;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.ext.WriterInterceptor;\n+import javax.ws.rs.ext.WriterInterceptorContext;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.apache.commons.lang3.BooleanUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.glassfish.jersey.message.MessageUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.ListableBeanFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.ApplicationContext;\n+import org.springframework.core.annotation.AnnotationUtils;\n+import org.springframework.stereotype.Component;\n+\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Maps;\n+import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n+import com.sequenceiq.cloudbreak.auth.security.authentication.AuthenticatedUserService;\n+import com.sequenceiq.cloudbreak.common.user.CloudbreakUser;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPOperationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredRestCallEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestCallDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestRequestDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.rest.RestResponseDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.repository.AccountAwareResourceRepository;\n+import com.sequenceiq.cloudbreak.structuredevent.rest.CDPRestCommonService;\n+import com.sequenceiq.cloudbreak.structuredevent.rest.annotation.AccountEntityType;\n+import com.sequenceiq.cloudbreak.structuredevent.rest.urlparser.CDPRestUrlParser;\n+import com.sequenceiq.cloudbreak.structuredevent.service.CDPBaseRestRequestThreadLocalService;\n+import com.sequenceiq.cloudbreak.structuredevent.service.CDPDefaultStructuredEventClient;\n+import com.sequenceiq.cloudbreak.structuredevent.service.lookup.CDPAccountAwareRepositoryLookupService;\n+import com.sequenceiq.flow.ha.NodeConfig;\n+\n+@Component\n+public class CDPStructuredEventFilter implements WriterInterceptor, ContainerRequestFilter, ContainerResponseFilter {", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzExMjY2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487112660", "bodyText": "Hi, yes, it makes sense, but this logic came from the core module. Good idea to refactor it, but it could be a separated task/improvement. Also my experience with this class that dependencies could not be injected into Jersey managed filters with Inject annotation and the only way that worked for me leave the Autowires. I only could dig in a little bit, but in case of Inject Jersey tries to use it's own dependency management mechanism to resolve dependencies which are configured in Spring related configurations and managed by Spring.", "author": "biharitomi", "createdAt": "2020-09-11T15:13:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA5OTYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE0MDg2NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487140864", "bodyText": "I don't have any issues with Autowire :)\nI'm fine with fixing this in a followup pr, just please create a jira for that, otherwise I'm afraid this will stay the same way", "author": "lacikaaa", "createdAt": "2020-09-11T16:00:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA5OTYyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEwNTAyMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487105021", "bodyText": "maybe @NotEmpty would fit better. Should we add this to the other public methods definition also?", "author": "lacikaaa", "createdAt": "2020-09-11T15:01:09Z", "path": "structuredevent-service-cdp/src/main/java/com/sequenceiq/cloudbreak/structuredevent/service/AbstractAccountAwareResourceService.java", "diffHunk": "@@ -0,0 +1,156 @@\n+package com.sequenceiq.cloudbreak.structuredevent.service;\n+\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import javax.annotation.Nonnull;\n+import javax.ws.rs.BadRequestException;\n+import javax.ws.rs.NotFoundException;\n+\n+import org.hibernate.exception.ConstraintViolationException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.dao.DataIntegrityViolationException;\n+\n+import com.google.common.collect.Sets;\n+import com.sequenceiq.cloudbreak.logger.MDCBuilder;\n+import com.sequenceiq.cloudbreak.structuredevent.repository.AccountAwareResource;\n+import com.sequenceiq.cloudbreak.structuredevent.repository.AccountAwareResourceRepository;\n+\n+public abstract class AbstractAccountAwareResourceService<T extends AccountAwareResource>\n+        implements AccountAwareResourceService<T> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AbstractAccountAwareResourceService.class);\n+\n+    @Override\n+    public T create(T resource, @Nonnull String accountId) {", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzExNzg4NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487117884", "bodyText": "please add unit tests", "author": "lacikaaa", "createdAt": "2020-09-11T15:22:03Z", "path": "structuredevent-service-cdp/src/main/java/com/sequenceiq/cloudbreak/structuredevent/service/CDPFlowStructuredEventHandler.java", "diffHunk": "@@ -0,0 +1,133 @@\n+package com.sequenceiq.cloudbreak.structuredevent.service;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.context.annotation.Primary;\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.messaging.Message;\n+import org.springframework.statemachine.StateMachine;\n+import org.springframework.statemachine.listener.StateMachineListenerAdapter;\n+import org.springframework.statemachine.state.State;\n+import org.springframework.statemachine.transition.Transition;\n+import org.springframework.statemachine.trigger.Trigger;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.structuredevent.event.FlowDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredEvent;\n+import com.sequenceiq.flow.core.FlowEventListener;\n+\n+@Primary\n+@Component\n+@Scope(\"prototype\")\n+public class CDPFlowStructuredEventHandler<S, E> extends StateMachineListenerAdapter<S, E> implements FlowEventListener<S, E> {", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkyNTI4OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487925289", "bodyText": "Hm, I tried to write any useful test, but I cannot. Could you please give me any suggestion?", "author": "topolyai5", "createdAt": "2020-09-14T13:41:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzExNzg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk1MTg0Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487951847", "bodyText": "in public void transition(Transition<S, E> transition) a CDPStructuredEvent is sent. in this meethod there are a lot of ternary operator and an if also. depending on the transition parameter one of the cdpStructuredFlowEventFactory.createStructuredFlowEvent is called with different values which could be asserted.\nyou can even check the in case an error like nullpointer it is caught, so this would ensure no one removes the try catch by mistake.\nin public void stateMachineStopped(StateMachine<S, E> stateMachine) you could test it has only  effect if it's not complete. it also has some ternary operator, those effects could be tested also.\n\nIn the meanwhile: why do we have try-catch in transition and not in stateMachineStopped?", "author": "lacikaaa", "createdAt": "2020-09-14T14:06:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzExNzg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk2NDI3Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487964273", "bodyText": "In the meanwhile: why do we have try-catch in transition and not in stateMachineStopped?\nGood questions, these codes are 2-3 years old.", "author": "topolyai5", "createdAt": "2020-09-14T14:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzExNzg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk3MDkyMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487970920", "bodyText": "I don't agree with you. These tests could not catch any error. I cannot validate the content of the payload. It would be much useful than verifying the methods.\nBut I will write these tests, maybe", "author": "topolyai5", "createdAt": "2020-09-14T14:22:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzExNzg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzExODk1OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487118959", "bodyText": "unit test", "author": "lacikaaa", "createdAt": "2020-09-11T15:23:48Z", "path": "structuredevent-service-cdp/src/main/java/com/sequenceiq/cloudbreak/structuredevent/service/converter/CDPStructuredEventEntityToCDPStructuredEventConverter.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package com.sequenceiq.cloudbreak.structuredevent.service.converter;\n+\n+import java.util.Map;\n+\n+import javax.annotation.PostConstruct;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.google.common.collect.Maps;\n+import com.sequenceiq.cloudbreak.common.exception.CloudbreakServiceException;\n+import com.sequenceiq.cloudbreak.common.json.JsonUtil;\n+import com.sequenceiq.cloudbreak.converter.AbstractConversionServiceAwareConverter;\n+import com.sequenceiq.cloudbreak.structuredevent.domain.CDPStructuredEventEntity;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredFlowEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredNotificationEvent;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredRestCallEvent;\n+\n+@Component\n+public class CDPStructuredEventEntityToCDPStructuredEventConverter", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzExOTcwMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487119703", "bodyText": "shall we log the source to know what we can't convert?", "author": "lacikaaa", "createdAt": "2020-09-11T15:24:59Z", "path": "structuredevent-service-cdp/src/main/java/com/sequenceiq/cloudbreak/structuredevent/service/converter/CDPStructuredEventToCDPStructuredEventEntityConverter.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package com.sequenceiq.cloudbreak.structuredevent.service.converter;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.cloudbreak.converter.AbstractConversionServiceAwareConverter;\n+import com.sequenceiq.cloudbreak.structuredevent.domain.CDPStructuredEventEntity;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPOperationDetails;\n+import com.sequenceiq.cloudbreak.structuredevent.event.cdp.CDPStructuredEvent;\n+\n+@Component\n+public class CDPStructuredEventToCDPStructuredEventEntityConverter\n+        extends AbstractConversionServiceAwareConverter<CDPStructuredEvent, CDPStructuredEventEntity> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(CDPStructuredEventToCDPStructuredEventEntityConverter.class);\n+\n+    @Override\n+    public CDPStructuredEventEntity convert(CDPStructuredEvent source) {\n+        try {\n+            CDPStructuredEventEntity structuredEventEntity = new CDPStructuredEventEntity();\n+            structuredEventEntity.setStructuredEventJson(new Json(source));\n+            CDPOperationDetails operationDetails = source.getOperation();\n+            structuredEventEntity.setEventType(operationDetails.getEventType());\n+            structuredEventEntity.setResourceType(operationDetails.getResourceType());\n+            structuredEventEntity.setResourceCrn(operationDetails.getResourceCrn());\n+            structuredEventEntity.setTimestamp(operationDetails.getTimestamp());\n+            structuredEventEntity.setAccountId(source.getOperation().getAccountId());\n+            return structuredEventEntity;\n+        } catch (IllegalArgumentException e) {\n+            LOGGER.error(\"Failed to parse structured event JSON\", e);", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEzMTQyMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487131422", "bodyText": "this field is unnecessary and misleading. could you remove this?", "author": "lacikaaa", "createdAt": "2020-09-11T15:44:08Z", "path": "structuredevent-service-cdp/src/main/java/com/sequenceiq/cloudbreak/structuredevent/service/lookup/CDPRepositoryLookupService.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.sequenceiq.cloudbreak.structuredevent.service.lookup;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.annotation.PostConstruct;\n+\n+import org.springframework.data.repository.CrudRepository;\n+import org.springframework.util.CollectionUtils;\n+\n+import com.sequenceiq.cloudbreak.workspace.repository.EntityType;\n+\n+public abstract class CDPRepositoryLookupService<T extends CrudRepository<?, ?>> {\n+\n+    private List<T> repositoryList;", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEzMjUwNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8937#discussion_r487132505", "bodyText": "do we need this class?", "author": "lacikaaa", "createdAt": "2020-09-11T15:45:58Z", "path": "structuredevent-service-legacy/src/main/java/com/sequenceiq/cloudbreak/structuredevent/config/LegacyStructuredEventConfig.java", "diffHunk": "@@ -0,0 +1,8 @@\n+package com.sequenceiq.cloudbreak.structuredevent.config;\n+\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class LegacyStructuredEventConfig {", "originalCommit": "02641c35f6adb27fe60bed935aff3335cd3a69f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f6443963846140b8767fd7769b3b31f1d9d8608c", "url": "https://github.com/hortonworks/cloudbreak/commit/f6443963846140b8767fd7769b3b31f1d9d8608c", "message": "The structured event moved to a different module, named as 'structuredevent-service-legacy'. In this modul the functionalities are untouched. For the CDP world, we created two new modules: 'structuredevent-api-cdp' and 'structuredevent-service-cdp'. We created a common endpoint, service and repository. Only one thing need to integrate: the domain SQL.", "committedDate": "2020-09-15T08:48:06Z", "type": "forcePushed"}, {"oid": "d488ce05cd7378b2abd61b136794ea450ac0deae", "url": "https://github.com/hortonworks/cloudbreak/commit/d488ce05cd7378b2abd61b136794ea450ac0deae", "message": "The structured event moved to a different module, named as 'structuredevent-service-legacy'. In this modul the functionalities are untouched. For the CDP world, we created two new modules: 'structuredevent-api-cdp' and 'structuredevent-service-cdp'. We created a common endpoint, service and repository. Only one thing need to integrate: the domain SQL.", "committedDate": "2020-09-16T10:35:34Z", "type": "commit"}, {"oid": "d488ce05cd7378b2abd61b136794ea450ac0deae", "url": "https://github.com/hortonworks/cloudbreak/commit/d488ce05cd7378b2abd61b136794ea450ac0deae", "message": "The structured event moved to a different module, named as 'structuredevent-service-legacy'. In this modul the functionalities are untouched. For the CDP world, we created two new modules: 'structuredevent-api-cdp' and 'structuredevent-service-cdp'. We created a common endpoint, service and repository. Only one thing need to integrate: the domain SQL.", "committedDate": "2020-09-16T10:35:34Z", "type": "forcePushed"}]}