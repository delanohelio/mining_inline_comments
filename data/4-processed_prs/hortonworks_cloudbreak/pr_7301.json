{"pr_number": 7301, "pr_title": "CB-5343 Resizing compute nodes does not work", "pr_createdAt": "2020-02-17T13:47:51Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7301", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIyNTk5OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7301#discussion_r380225998", "bodyText": "Why not CheckedFunction? Or ValidatedFunction? Would sound more correct.", "author": "attilapalfi92", "createdAt": "2020-02-17T14:53:25Z", "path": "common/src/main/java/com/sequenceiq/cloudbreak/validation/FunctionChecked.java", "diffHunk": "@@ -0,0 +1,7 @@\n+package com.sequenceiq.cloudbreak.validation;\n+\n+@FunctionalInterface\n+public interface FunctionChecked<T, R, E extends Exception> {", "originalCommit": "7b1b6628ab005b060f1f0862d4da61ea007afe33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIzMTYzMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7301#discussion_r380231633", "bodyText": "bad package, I would create in util. I prefer the function first because to find easily by another one", "author": "topolyai5", "createdAt": "2020-02-17T15:03:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIyNTk5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI1NTcwNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7301#discussion_r380255705", "bodyText": "But this name does not make sense. You can find it anyway.", "author": "attilapalfi92", "createdAt": "2020-02-17T15:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIyNTk5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIyNjk4Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/7301#discussion_r380226986", "bodyText": "I think optionalDeployClientConfigCommand is a leftover name from refactor and should be optionalApiCommand, isn't it?", "author": "attilapalfi92", "createdAt": "2020-02-17T14:55:09Z", "path": "cluster-cm/src/main/java/com/sequenceiq/cloudbreak/cm/ClouderaManagerModificationService.java", "diffHunk": "@@ -187,32 +187,40 @@ private Boolean isPrewarmed(Long clusterId) {\n     public void restartStaleServices(MgmtServiceResourceApi mgmtServiceResourceApi, ClustersResourceApi clustersResourceApi)\n             throws ApiException, CloudbreakException {\n         restartClouderaManagementServices(mgmtServiceResourceApi);\n-        restartCMStaleServices(clustersResourceApi);\n+        deployConfigAndRefreshCMStaleServices(clustersResourceApi);\n     }\n \n-    private void restartCMStaleServices(ClustersResourceApi clustersResourceApi) throws ApiException, CloudbreakException {\n+    private void deployConfigAndRefreshCMStaleServices(ClustersResourceApi clustersResourceApi) throws ApiException, CloudbreakException {\n         LOGGER.debug(\"Restarting stale services and redeploying client configurations in Cloudera Manager.\");\n         ServicesResourceApi servicesResourceApi = clouderaManagerApiFactory.getServicesResourceApi(apiClient);\n         List<ApiService> services = servicesResourceApi.readServices(stack.getName(), SUMMARY).getItems();\n         boolean configStale = services.stream().anyMatch(service -> !ApiConfigStalenessStatus.FRESH.equals(service.getConfigStalenessStatus()));\n-        if (configStale) {\n-            Optional<ApiCommand> optionalRestartCommand = clustersResourceApi.listActiveCommands(stack.getName(), SUMMARY).getItems().stream()\n-                    .filter(cmd -> \"RestartWaitingForStalenessSuccess\".equals(cmd.getName())).findFirst();\n-            ApiCommand restartServicesCommand;\n-            if (optionalRestartCommand.isPresent()) {\n-                restartServicesCommand = optionalRestartCommand.get();\n-                LOGGER.debug(\"Restart for stale services is already running with id: [{}]\", restartServicesCommand.getId());\n-            } else {\n-                restartServicesCommand = clustersResourceApi.restartCommand(stack.getName(),\n-                        new ApiRestartClusterArgs().redeployClientConfiguration(Boolean.TRUE).restartOnlyStaleServices(Boolean.TRUE));\n-            }\n-            pollRestart(restartServicesCommand);\n-            LOGGER.debug(\"Restarted stale services in Cloudera Manager.\");\n+        boolean clientConfigStale = services.stream().anyMatch(service -> !ApiConfigStalenessStatus.FRESH.equals(service.getClientConfigStalenessStatus()));\n+        if (configStale || clientConfigStale) {\n+            List<ApiCommand> commands = clustersResourceApi.listActiveCommands(stack.getName(), SUMMARY).getItems();\n+            ApiCommand deployClientConfigCmd = getApiCommand(commands, \"DeployClusterClientConfig\", stack.getName(), clustersResourceApi::deployClientConfig);\n+            pollDeployConfig(deployClientConfigCmd);\n+            ApiCommand refreshServicesCmd = getApiCommand(commands, \"RefreshCluster\", stack.getName(), clustersResourceApi::refresh);\n+            pollRefresh(refreshServicesCmd);\n+            LOGGER.debug(\"Config deployed and stale services are refreshed in Cloudera Manager.\");\n         } else {\n             LOGGER.debug(\"No stale services found in Cloudera Manager.\");\n         }\n     }\n \n+    private ApiCommand getApiCommand(List<ApiCommand> commands, String commandString, String clusterName, FunctionChecked<String, ApiCommand, ApiException> fn)\n+            throws ApiException {\n+        Optional<ApiCommand> optionalDeployClientConfigCommand = commands.stream().filter(cmd -> commandString.equals(cmd.getName())).findFirst();", "originalCommit": "7b1b6628ab005b060f1f0862d4da61ea007afe33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIzMTAyOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7301#discussion_r380231029", "bodyText": "yes, you are right, i will fix it", "author": "topolyai5", "createdAt": "2020-02-17T15:01:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIyNjk4Ng=="}], "type": "inlineReview"}, {"oid": "73584700bf13fc42f3a8e01d7ff72f165af7775d", "url": "https://github.com/hortonworks/cloudbreak/commit/73584700bf13fc42f3a8e01d7ff72f165af7775d", "message": "CB-5343 Resizing compute nodes does not work", "committedDate": "2020-02-17T15:08:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIzMzgyMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7301#discussion_r380233820", "bodyText": "what's behind the configStale and the clientConfigStale? the actual values come from a specific logic but the variable name does not reflect it. let's say something like serviceContainsStatusWithNotFreshStaleness.. or other.. it's much longer but a good variable name could make unnecessary to understand the stream-filter line(s) above.\nalso, do we have a unit-test for this logic somewhere? if not please make some.", "author": "gregito", "createdAt": "2020-02-17T15:07:29Z", "path": "cluster-cm/src/main/java/com/sequenceiq/cloudbreak/cm/ClouderaManagerModificationService.java", "diffHunk": "@@ -187,32 +187,40 @@ private Boolean isPrewarmed(Long clusterId) {\n     public void restartStaleServices(MgmtServiceResourceApi mgmtServiceResourceApi, ClustersResourceApi clustersResourceApi)\n             throws ApiException, CloudbreakException {\n         restartClouderaManagementServices(mgmtServiceResourceApi);\n-        restartCMStaleServices(clustersResourceApi);\n+        deployConfigAndRefreshCMStaleServices(clustersResourceApi);\n     }\n \n-    private void restartCMStaleServices(ClustersResourceApi clustersResourceApi) throws ApiException, CloudbreakException {\n+    private void deployConfigAndRefreshCMStaleServices(ClustersResourceApi clustersResourceApi) throws ApiException, CloudbreakException {\n         LOGGER.debug(\"Restarting stale services and redeploying client configurations in Cloudera Manager.\");\n         ServicesResourceApi servicesResourceApi = clouderaManagerApiFactory.getServicesResourceApi(apiClient);\n         List<ApiService> services = servicesResourceApi.readServices(stack.getName(), SUMMARY).getItems();\n         boolean configStale = services.stream().anyMatch(service -> !ApiConfigStalenessStatus.FRESH.equals(service.getConfigStalenessStatus()));\n-        if (configStale) {\n-            Optional<ApiCommand> optionalRestartCommand = clustersResourceApi.listActiveCommands(stack.getName(), SUMMARY).getItems().stream()\n-                    .filter(cmd -> \"RestartWaitingForStalenessSuccess\".equals(cmd.getName())).findFirst();\n-            ApiCommand restartServicesCommand;\n-            if (optionalRestartCommand.isPresent()) {\n-                restartServicesCommand = optionalRestartCommand.get();\n-                LOGGER.debug(\"Restart for stale services is already running with id: [{}]\", restartServicesCommand.getId());\n-            } else {\n-                restartServicesCommand = clustersResourceApi.restartCommand(stack.getName(),\n-                        new ApiRestartClusterArgs().redeployClientConfiguration(Boolean.TRUE).restartOnlyStaleServices(Boolean.TRUE));\n-            }\n-            pollRestart(restartServicesCommand);\n-            LOGGER.debug(\"Restarted stale services in Cloudera Manager.\");\n+        boolean clientConfigStale = services.stream().anyMatch(service -> !ApiConfigStalenessStatus.FRESH.equals(service.getClientConfigStalenessStatus()));\n+        if (configStale || clientConfigStale) {", "originalCommit": "7b1b6628ab005b060f1f0862d4da61ea007afe33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ5NzkxNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7301#discussion_r380497916", "bodyText": "I think this variable name too long. The other hand it just a boolean flag, not a list of services with not fresh staleness.", "author": "topolyai5", "createdAt": "2020-02-18T07:32:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIzMzgyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUxMTQwMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7301#discussion_r380511402", "bodyText": "surely it's too long, I didn't say that you have to use my suggestion, but if you read this condition for the first time you must read the assignation line to understand what the variable actually represents. that's why it's a bad choice of name.", "author": "gregito", "createdAt": "2020-02-18T08:09:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIzMzgyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIzOTMyNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7301#discussion_r380239326", "bodyText": "please cover this method with unit test(s)", "author": "gregito", "createdAt": "2020-02-17T15:17:26Z", "path": "cluster-cm/src/main/java/com/sequenceiq/cloudbreak/cm/ClouderaManagerModificationService.java", "diffHunk": "@@ -238,6 +246,26 @@ private void pollRestart(ApiCommand restartCommand) throws CloudbreakException {\n         }\n     }\n \n+    private void pollDeployConfig(ApiCommand restartCommand) throws CloudbreakException {", "originalCommit": "73584700bf13fc42f3a8e01d7ff72f165af7775d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIzOTM3NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7301#discussion_r380239374", "bodyText": "please cover this method with unit test(s)", "author": "gregito", "createdAt": "2020-02-17T15:17:31Z", "path": "cluster-cm/src/main/java/com/sequenceiq/cloudbreak/cm/ClouderaManagerModificationService.java", "diffHunk": "@@ -238,6 +246,26 @@ private void pollRestart(ApiCommand restartCommand) throws CloudbreakException {\n         }\n     }\n \n+    private void pollDeployConfig(ApiCommand restartCommand) throws CloudbreakException {\n+        PollingResult hostTemplatePollingResult = clouderaManagerPollingServiceProvider.startPollingCmClientConfigDeployment(\n+                stack, apiClient, restartCommand.getId());\n+        if (isExited(hostTemplatePollingResult)) {\n+            throw new CancellationException(\"Cluster was terminated while waiting for config deploy\");\n+        } else if (isTimeout(hostTemplatePollingResult)) {\n+            throw new CloudbreakException(\"Timeout while Cloudera Manager was config deploying services.\");\n+        }\n+    }\n+\n+    private void pollRefresh(ApiCommand restartCommand) throws CloudbreakException {", "originalCommit": "73584700bf13fc42f3a8e01d7ff72f165af7775d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9240db10d7fd05d707a8e0e7e021a8449e682409", "url": "https://github.com/hortonworks/cloudbreak/commit/9240db10d7fd05d707a8e0e7e021a8449e682409", "message": "CB-5343 Resizing compute nodes does not work", "committedDate": "2020-02-18T11:48:42Z", "type": "forcePushed"}, {"oid": "cfdfcf6595c5338e21ddfcc3a1f27f1366c3ddb8", "url": "https://github.com/hortonworks/cloudbreak/commit/cfdfcf6595c5338e21ddfcc3a1f27f1366c3ddb8", "message": "CB-5343 Resizing compute nodes does not work", "committedDate": "2020-02-18T12:56:23Z", "type": "forcePushed"}, {"oid": "9f8aaefba086d08e1990156ab1492cbb7d393468", "url": "https://github.com/hortonworks/cloudbreak/commit/9f8aaefba086d08e1990156ab1492cbb7d393468", "message": "CB-5343 Resizing compute nodes does not work", "committedDate": "2020-02-18T13:33:06Z", "type": "commit"}, {"oid": "9f8aaefba086d08e1990156ab1492cbb7d393468", "url": "https://github.com/hortonworks/cloudbreak/commit/9f8aaefba086d08e1990156ab1492cbb7d393468", "message": "CB-5343 Resizing compute nodes does not work", "committedDate": "2020-02-18T13:33:06Z", "type": "forcePushed"}]}