{"pr_number": 9600, "pr_title": "CB-10075 Upgrade image selection logic should not depend on image catalog URL", "pr_createdAt": "2020-12-08T11:07:50Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9600", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ4OTAyNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#discussion_r538489027", "bodyText": "Perhaps you could extend these branches with log messages why we are using a certain url.", "author": "keyki", "createdAt": "2020-12-08T15:19:44Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/ClusterUpgradeAvailabilityService.java", "diffHunk": "@@ -180,7 +185,14 @@ private Image getCurrentImageFromCatalog(String currentImageId, CloudbreakImageC\n         return imageService.getImage(stack.getId());\n     }\n \n-    private CloudbreakImageCatalogV3 getImagesFromCatalog(String imageCatalogUrl) throws CloudbreakImageCatalogException {\n+    private CloudbreakImageCatalogV3 getImagesFromCatalog(Workspace workspace,\n+            com.sequenceiq.cloudbreak.cloud.model.Image image) throws CloudbreakImageCatalogException {\n+        String imageCatalogUrl;\n+        try {", "originalCommit": "36b451f2bfe48187ac02459aa663015211f2e391", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODUwMzQ5Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#discussion_r538503497", "bodyText": "+1", "author": "pdarvasi", "createdAt": "2020-12-08T15:32:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ4OTAyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODUwMDU5NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#discussion_r538500595", "bodyText": "typo: returns -> return", "author": "pdarvasi", "createdAt": "2020-12-08T15:30:08Z", "path": "core/src/test/java/com/sequenceiq/cloudbreak/service/upgrade/ClusterUpgradeAvailabilityServiceTest.java", "diffHunk": "@@ -155,18 +167,56 @@ public void testCheckForUpgradesByNameShouldReturnsImagesWhenThereAreAvailableIm\n                 currentImage.getImageCatalogName());\n     }\n \n+    @Test\n+    public void testCheckForUpgradesByNameShouldReturnsImagesFromFallbackCatalogWhenThereAreAvailableImagesButImageCatalogByNameNotFound()", "originalCommit": "36b451f2bfe48187ac02459aa663015211f2e391", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODUwNTU2OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#discussion_r538505568", "bodyText": "omg", "author": "keyki", "createdAt": "2020-12-08T15:34:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODUwMDU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODUwMzA3NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#discussion_r538503075", "bodyText": "could you pls have a unit test to cover \"ImageCatalogByNameFound()\"", "author": "pdarvasi", "createdAt": "2020-12-08T15:32:15Z", "path": "core/src/test/java/com/sequenceiq/cloudbreak/service/upgrade/ClusterUpgradeAvailabilityServiceTest.java", "diffHunk": "@@ -155,18 +167,56 @@ public void testCheckForUpgradesByNameShouldReturnsImagesWhenThereAreAvailableIm\n                 currentImage.getImageCatalogName());\n     }\n \n+    @Test\n+    public void testCheckForUpgradesByNameShouldReturnsImagesFromFallbackCatalogWhenThereAreAvailableImagesButImageCatalogByNameNotFound()", "originalCommit": "36b451f2bfe48187ac02459aa663015211f2e391", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "abd27eb1ab854ed9bfadcc21753eaff970ad172e", "url": "https://github.com/hortonworks/cloudbreak/commit/abd27eb1ab854ed9bfadcc21753eaff970ad172e", "message": "CB-10075 Upgrade image selection logic should not depend on image catalog URL\n* First try to use imagecatalog by name given in the current image\n* if image catalog is not found by name, use the stored imagecatalog url instead", "committedDate": "2020-12-09T11:04:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI3NzEwOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9600#discussion_r539277109", "bodyText": "if you declare imageCatalogUrl on line 191 with this as a default value, then you can omit this", "author": "lacikaaa", "createdAt": "2020-12-09T12:46:21Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/ClusterUpgradeAvailabilityService.java", "diffHunk": "@@ -180,7 +185,18 @@ private Image getCurrentImageFromCatalog(String currentImageId, CloudbreakImageC\n         return imageService.getImage(stack.getId());\n     }\n \n-    private CloudbreakImageCatalogV3 getImagesFromCatalog(String imageCatalogUrl) throws CloudbreakImageCatalogException {\n+    private CloudbreakImageCatalogV3 getImagesFromCatalog(Workspace workspace,\n+            com.sequenceiq.cloudbreak.cloud.model.Image image) throws CloudbreakImageCatalogException {\n+        String imageCatalogName = image.getImageCatalogName();\n+        String imageCatalogUrl;\n+        try {\n+            imageCatalogUrl = imageCatalogService.get(workspace.getId(), imageCatalogName).getImageCatalogUrl();\n+            LOGGER.info(\"Image catalog with name {} and url {} is used for image filtering.\", imageCatalogName, imageCatalogUrl);\n+        } catch (NotFoundException ex) {\n+            imageCatalogUrl = image.getImageCatalogUrl();", "originalCommit": "abd27eb1ab854ed9bfadcc21753eaff970ad172e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2597e4e9596dcdf9931eac607c411d6b78e916d7", "url": "https://github.com/hortonworks/cloudbreak/commit/2597e4e9596dcdf9931eac607c411d6b78e916d7", "message": "CB-10075 Upgrade image selection logic should not depend on image catalog URL\n* First try to use imagecatalog by name given in the current image\n* if image catalog is not found by name, use the stored imagecatalog url instead", "committedDate": "2020-12-09T13:43:25Z", "type": "commit"}, {"oid": "2597e4e9596dcdf9931eac607c411d6b78e916d7", "url": "https://github.com/hortonworks/cloudbreak/commit/2597e4e9596dcdf9931eac607c411d6b78e916d7", "message": "CB-10075 Upgrade image selection logic should not depend on image catalog URL\n* First try to use imagecatalog by name given in the current image\n* if image catalog is not found by name, use the stored imagecatalog url instead", "committedDate": "2020-12-09T13:43:25Z", "type": "forcePushed"}]}