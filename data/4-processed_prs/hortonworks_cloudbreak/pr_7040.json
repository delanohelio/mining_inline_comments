{"pr_number": 7040, "pr_title": "CB-4952 Add last heartbeat check when waiting for agents", "pr_createdAt": "2020-01-09T15:07:18Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7040", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc5MjczNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7040#discussion_r364792734", "bodyText": "Instead of now I would call it start as it's kind of misleading.", "author": "keyki", "createdAt": "2020-01-09T15:12:52Z", "path": "cluster-cm/src/main/java/com/sequenceiq/cloudbreak/cm/polling/task/ClouderaManagerHostStatusChecker.java", "diffHunk": "@@ -48,6 +41,31 @@ protected boolean doStatusCheck(ClouderaManagerPollerObject pollerObject, Comman\n         }\n     }\n \n+    private List<InstanceMetaData> collectNotKnownInstancesByManager(ClouderaManagerPollerObject pollerObject, List<String> hostIpsFromManager) {\n+        return pollerObject.getStack().getInstanceMetaDataAsList().stream()\n+                    .filter(metaData -> metaData.getDiscoveryFQDN() != null)\n+                    .filter(metaData -> !metaData.isTerminated() && !metaData.isDeletedOnProvider())\n+                    .filter(metaData -> !hostIpsFromManager.contains(metaData.getPrivateIp()))\n+                    .collect(Collectors.toList());\n+    }\n+\n+    private List<String> fetchHeartbeatedHostIpsFromManager(ClouderaManagerPollerObject pollerObject) throws ApiException {\n+        HostsResourceApi hostsResourceApi = new HostsResourceApi(pollerObject.getApiClient());\n+        String viewType = \"FULL\";\n+        ApiHostList hostList = hostsResourceApi.readHosts(viewType);\n+        List<String> hostIpsFromManager = filterForHeartBeatedIps(hostList);\n+        LOGGER.debug(\"Hosts in the list from manager: \" + hostIpsFromManager);\n+        return hostIpsFromManager;\n+    }\n+\n+    private List<String> filterForHeartBeatedIps(ApiHostList hostList) {\n+        return hostList.getItems().stream()\n+                    .filter(item -> StringUtils.isNotBlank(item.getLastHeartbeat()))\n+                    .filter(item -> now.isBefore(Instant.parse(item.getLastHeartbeat())))", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc5NjQ5MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7040#discussion_r364796491", "bodyText": "sure, renamed", "author": "lacikaaa", "createdAt": "2020-01-09T15:19:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc5MjczNA=="}], "type": "inlineReview"}, {"oid": "febe1d35993cead833d1ddc95f1dd99d517757f0", "url": "https://github.com/hortonworks/cloudbreak/commit/febe1d35993cead833d1ddc95f1dd99d517757f0", "message": "CB-4952 Add last heartbeat check when waiting for agents", "committedDate": "2020-01-09T15:18:33Z", "type": "forcePushed"}, {"oid": "615a003b582bad268bc27adca50f8107285d0dac", "url": "https://github.com/hortonworks/cloudbreak/commit/615a003b582bad268bc27adca50f8107285d0dac", "message": "CB-4952 Add last heartbeat check when waiting for agents", "committedDate": "2020-01-10T11:19:52Z", "type": "forcePushed"}, {"oid": "31ea1d9f7d5cdfb7ae2041e260ab86e29c52cb69", "url": "https://github.com/hortonworks/cloudbreak/commit/31ea1d9f7d5cdfb7ae2041e260ab86e29c52cb69", "message": "CB-4952 Add last heartbeat check when waiting for agents", "committedDate": "2020-01-10T14:00:14Z", "type": "forcePushed"}, {"oid": "c16399e9caafe908ec4129e210e2c5195f6e4ac5", "url": "https://github.com/hortonworks/cloudbreak/commit/c16399e9caafe908ec4129e210e2c5195f6e4ac5", "message": "CB-4952 Add last heartbeat check when waiting for agents", "committedDate": "2020-01-10T18:10:55Z", "type": "commit"}, {"oid": "c16399e9caafe908ec4129e210e2c5195f6e4ac5", "url": "https://github.com/hortonworks/cloudbreak/commit/c16399e9caafe908ec4129e210e2c5195f6e4ac5", "message": "CB-4952 Add last heartbeat check when waiting for agents", "committedDate": "2020-01-10T18:10:55Z", "type": "forcePushed"}]}