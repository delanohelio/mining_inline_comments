{"pr_number": 9169, "pr_title": "CB-9209", "pr_createdAt": "2020-10-08T09:11:01Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9169", "timeline": [{"oid": "9c2ffe4cb25480c277128e186036aa1ee46050a2", "url": "https://github.com/hortonworks/cloudbreak/commit/9c2ffe4cb25480c277128e186036aa1ee46050a2", "message": "CB-9209 Do not update instancemetadatas or stack status if flow is running for a stack", "committedDate": "2020-10-08T09:15:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1MDEyNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501650125", "bodyText": "please use isEmpty()", "author": "lacikaaa", "createdAt": "2020-10-08T11:34:54Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -99,7 +99,9 @@ private void syncAStack(Stack stack) {\n                     if (!checkableInstances.isEmpty()) {\n                         SyncResult syncResult = freeipaChecker.getStatus(stack, checkableInstances);\n                         List<ProviderSyncResult> results = providerChecker.updateAndGetStatuses(stack, checkableInstances);\n-                        updateStackStatus(stack, syncResult, results, alreadyDeletedCount);\n+                        if (results.size() > 0) {", "originalCommit": "9c2ffe4cb25480c277128e186036aa1ee46050a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1MTM3NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501651375", "bodyText": "it's strange we need this. I think StackStatusCheckerJob already checks", "author": "lacikaaa", "createdAt": "2020-10-08T11:37:17Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/ProviderChecker.java", "diffHunk": "@@ -53,17 +57,23 @@\n             });\n             checkableInstances.forEach(instanceMetaData -> {\n                 if (statuses.stream().noneMatch(s -> s.getCloudInstance().getInstanceId().equals(instanceMetaData.getInstanceId()))) {\n-                    if (updateStatus) {\n-                        setStatusIfNotTheSame(instanceMetaData, InstanceStatus.DELETED_ON_PROVIDER_SIDE);\n-                        instanceMetaDataService.save(instanceMetaData);\n+                    if (!flowLogService.isOtherFlowRunning(stack.getId())) {", "originalCommit": "9c2ffe4cb25480c277128e186036aa1ee46050a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1NjMyNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501656326", "bodyText": "It can take long seconds to fetch provider side information. Meanwhile, flow can start in the background.", "author": "sodre90", "createdAt": "2020-10-08T11:46:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1MTM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY2NzUzMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501667530", "bodyText": "in that case it would make sense to throw an exception or similar to stop the whole sync. right now we will continue the sync just log an error.", "author": "lacikaaa", "createdAt": "2020-10-08T12:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1MTM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY2OTUxMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501669513", "bodyText": "also I don't know if it's a good idea to have this check in a loop. freeipa won't have many instances but I would move these checks out from loops to ease the load on the database", "author": "lacikaaa", "createdAt": "2020-10-08T12:10:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1MTM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4MzgyNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501683827", "bodyText": "you are right:\n\nI created a new exception (InterruptSyncingException)\ncheck is moved before loops but after provider query operation", "author": "sodre90", "createdAt": "2020-10-08T12:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1MTM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4OTY3OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501689678", "bodyText": "thanks for the changes!\nplease consider catching InterruptSyncingException in executeInternal method instead of letting it propagate to quartz. There is a try-finally block already", "author": "lacikaaa", "createdAt": "2020-10-08T12:43:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1MTM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMzU3Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501703577", "bodyText": "good idea!", "author": "sodre90", "createdAt": "2020-10-08T13:05:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1MTM3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1MTg3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501651872", "bodyText": "same here, code shouldn't reach this part if flow is running", "author": "lacikaaa", "createdAt": "2020-10-08T11:38:16Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -113,7 +115,11 @@ private void updateStackStatus(Stack stack, SyncResult result, List<ProviderSync\n         DetailedStackStatus status = getStackStatus(providerSyncResults, result, alreadyDeletedCount);\n         if (status != stack.getStackStatus().getDetailedStackStatus()) {\n             if (autoSyncConfig.isUpdateStatus()) {\n-                stackUpdater.updateStackStatus(stack, status, result.getMessage());\n+                if (!flowLogService.isOtherFlowRunning(stack.getId())) {", "originalCommit": "9c2ffe4cb25480c277128e186036aa1ee46050a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1NjQ2Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501656463", "bodyText": "same answer as previous", "author": "sodre90", "createdAt": "2020-10-08T11:46:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1MTg3Mg=="}], "type": "inlineReview"}, {"oid": "9534c4e07f10b37ac5f77ecfcea86ddb705ea483", "url": "https://github.com/hortonworks/cloudbreak/commit/9534c4e07f10b37ac5f77ecfcea86ddb705ea483", "message": "CB-9209 Do not update instancemetadatas or stack status if flow is running for a stack\n\nCB-9209 Do not update instancemetadatas or stack status if flow is running for a stack", "committedDate": "2020-10-08T12:20:31Z", "type": "forcePushed"}, {"oid": "27fd973b10741e5d17eb16c6cf086b28f8eaeb6a", "url": "https://github.com/hortonworks/cloudbreak/commit/27fd973b10741e5d17eb16c6cf086b28f8eaeb6a", "message": "CB-9209 Do not update instancemetadatas or stack status if flow is running for a stack\n\nCB-9209 Do not update instancemetadatas or stack status if flow is running for a stack", "committedDate": "2020-10-08T12:23:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4ODE4MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501688180", "bodyText": "this check has been removed: instanceMetaData.getInstanceStatus() != newStatus\nis it on purpose? I mean we will log here even no change happens in this case", "author": "lacikaaa", "createdAt": "2020-10-08T12:41:14Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/ProviderChecker.java", "diffHunk": "@@ -91,21 +101,25 @@ private InstanceStatus updateStatuses(CloudVmInstanceStatus vmInstanceStatus, In\n             default:\n                 LOGGER.info(\":::Auto sync::: the '{}' status is not converted\", vmInstanceStatus.getStatus());\n         }\n-        if (updateStatus) {\n-            instanceMetaDataService.save(instanceMetaData);\n+        if (!flowLogService.isOtherFlowRunning(stack.getId())) {\n+            if (updateStatus) {\n+                instanceMetaDataService.save(instanceMetaData);\n+            } else {\n+                LOGGER.debug(\"updateStatus flag is false, don't update status\");\n+            }\n+        } else {\n+            LOGGER.debug(\":::Auto sync::: do not update instance status to {} because flow is running for stack: {}\", status, stack.getName());\n         }\n         return status;\n     }\n \n     private void setStatusIfNotTheSame(InstanceMetaData instanceMetaData, InstanceStatus newStatus) {\n-        if (instanceMetaData.getInstanceStatus() != newStatus) {\n-            if (updateStatus) {\n-                instanceMetaData.setInstanceStatus(newStatus);\n-                LOGGER.info(\":::Auto sync::: The instance status updated from {} to {}\", instanceMetaData.getInstanceStatus(), newStatus);\n-            } else {\n-                LOGGER.info(\":::Auto sync::: The instance status would be had to update from {} to {}\",\n-                        instanceMetaData.getInstanceStatus(), newStatus);\n-            }\n+        if (updateStatus) {", "originalCommit": "27fd973b10741e5d17eb16c6cf086b28f8eaeb6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4OTQyOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501689428", "bodyText": "thanks! it was a mistake :)", "author": "sodre90", "createdAt": "2020-10-08T12:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4ODE4MA=="}], "type": "inlineReview"}, {"oid": "0ff0917545061a2d7615aaf5a4c5d03a4ce21256", "url": "https://github.com/hortonworks/cloudbreak/commit/0ff0917545061a2d7615aaf5a4c5d03a4ce21256", "message": "CB-9209 Do not update instancemetadatas or stack status if flow is running for a stack", "committedDate": "2020-10-08T12:42:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4ODE1Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501688156", "bodyText": "Don't need this here, we check this at the start", "author": "topolyai5", "createdAt": "2020-10-08T12:41:11Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/ProviderChecker.java", "diffHunk": "@@ -31,39 +32,48 @@\n     @Inject\n     private StackInstanceProviderChecker stackInstanceProviderChecker;\n \n+    @Inject\n+    private FlowLogService flowLogService;\n+\n     @Value(\"${freeipa.autosync.update.status:true}\")\n     private boolean updateStatus;\n \n     public List<ProviderSyncResult> updateAndGetStatuses(Stack stack, Set<InstanceMetaData> checkableInstances) {\n         return checkedMeasure(() -> {\n             List<ProviderSyncResult> results = new ArrayList<>();\n             List<CloudVmInstanceStatus> statuses = stackInstanceProviderChecker.checkStatus(stack, checkableInstances);\n-            statuses.forEach(s -> {\n-                Optional<InstanceMetaData> instanceMetaData = checkableInstances.stream()\n-                        .filter(i -> s.getCloudInstance().getInstanceId().equals(i.getInstanceId()))\n-                        .findFirst();\n-                if (instanceMetaData.isPresent()) {\n-                    InstanceStatus instanceStatus = updateStatuses(s, instanceMetaData.get());\n-                    if (instanceStatus != null) {\n-                        results.add(new ProviderSyncResult(\"\", instanceStatus, false, s.getCloudInstance().getInstanceId()));\n+            if (flowLogService.isOtherFlowRunning(stack.getId())) {", "originalCommit": "27fd973b10741e5d17eb16c6cf086b28f8eaeb6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5NDk5Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501694997", "bodyText": "please see the above comments", "author": "sodre90", "createdAt": "2020-10-08T12:52:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4ODE1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4OTYzNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501689635", "bodyText": "could you please add a more accurate message? where did happened or stuff like this", "author": "topolyai5", "createdAt": "2020-10-08T12:43:38Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -113,7 +115,11 @@ private void updateStackStatus(Stack stack, SyncResult result, List<ProviderSync\n         DetailedStackStatus status = getStackStatus(providerSyncResults, result, alreadyDeletedCount);\n         if (status != stack.getStackStatus().getDetailedStackStatus()) {\n             if (autoSyncConfig.isUpdateStatus()) {\n-                stackUpdater.updateStackStatus(stack, status, result.getMessage());\n+                if (flowLogService.isOtherFlowRunning(stack.getId())) {\n+                    throw new InterruptSyncingException(\":::Auto sync::: interrupt syncing, flow is running on freeipa stack \" + stack.getName());", "originalCommit": "0ff0917545061a2d7615aaf5a4c5d03a4ce21256", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5NTMyOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501695329", "bodyText": "you will see it from stack trace ;) but I will add some custom thing here", "author": "sodre90", "createdAt": "2020-10-08T12:52:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4OTYzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5MDA4NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501690085", "bodyText": "please add a log message, why you skip the update", "author": "topolyai5", "createdAt": "2020-10-08T12:44:23Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/StackStatusCheckerJob.java", "diffHunk": "@@ -99,7 +99,9 @@ private void syncAStack(Stack stack) {\n                     if (!checkableInstances.isEmpty()) {\n                         SyncResult syncResult = freeipaChecker.getStatus(stack, checkableInstances);\n                         List<ProviderSyncResult> results = providerChecker.updateAndGetStatuses(stack, checkableInstances);\n-                        updateStackStatus(stack, syncResult, results, alreadyDeletedCount);\n+                        if (!results.isEmpty()) {\n+                            updateStackStatus(stack, syncResult, results, alreadyDeletedCount);\n+                        }", "originalCommit": "0ff0917545061a2d7615aaf5a4c5d03a4ce21256", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5MTE4OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501691188", "bodyText": "if the flow is finished while you iterate over the list, what will happen?", "author": "topolyai5", "createdAt": "2020-10-08T12:46:00Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/sync/ProviderChecker.java", "diffHunk": "@@ -91,8 +101,14 @@ private InstanceStatus updateStatuses(CloudVmInstanceStatus vmInstanceStatus, In\n             default:\n                 LOGGER.info(\":::Auto sync::: the '{}' status is not converted\", vmInstanceStatus.getStatus());\n         }\n-        if (updateStatus) {\n-            instanceMetaDataService.save(instanceMetaData);\n+        if (!flowLogService.isOtherFlowRunning(stack.getId())) {", "originalCommit": "0ff0917545061a2d7615aaf5a4c5d03a4ce21256", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMTY5Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9169#discussion_r501701693", "bodyText": "true!", "author": "sodre90", "createdAt": "2020-10-08T13:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5MTE4OA=="}], "type": "inlineReview"}, {"oid": "687abbd5e8118eef065c1d18ee6c1f881ae70445", "url": "https://github.com/hortonworks/cloudbreak/commit/687abbd5e8118eef065c1d18ee6c1f881ae70445", "message": "CB-9209 do not put stack status to DELETED_ON_PROVIDER_SIDE if results is empty and do not update instancemetadatas or stack status if flow is running for a stack", "committedDate": "2020-10-08T12:59:02Z", "type": "forcePushed"}, {"oid": "7930c576bb24e5527c9590ebb5df51dc91f9fabb", "url": "https://github.com/hortonworks/cloudbreak/commit/7930c576bb24e5527c9590ebb5df51dc91f9fabb", "message": "CB-9209 do not put stack status to DELETED_ON_PROVIDER_SIDE if results is empty and do not update instancemetadatas or stack status if flow is running for a stack", "committedDate": "2020-10-08T13:01:30Z", "type": "forcePushed"}, {"oid": "d76bfbc60590fa0244e30f86f1cc017db149bd6f", "url": "https://github.com/hortonworks/cloudbreak/commit/d76bfbc60590fa0244e30f86f1cc017db149bd6f", "message": "CB-9209 do not put stack status to DELETED_ON_PROVIDER_SIDE if results is empty and do not update instancemetadatas or stack status if flow is running for a stack", "committedDate": "2020-10-08T13:04:11Z", "type": "forcePushed"}, {"oid": "9a83f3703b2f8c59f3fd3000213d879324c46745", "url": "https://github.com/hortonworks/cloudbreak/commit/9a83f3703b2f8c59f3fd3000213d879324c46745", "message": "CB-9209 do not put stack status to DELETED_ON_PROVIDER_SIDE if results is empty and do not update instancemetadatas or stack status if flow is running for a stack", "committedDate": "2020-10-08T13:27:43Z", "type": "forcePushed"}, {"oid": "88c0d1470556e930a5538a685e2eeea9045c5aad", "url": "https://github.com/hortonworks/cloudbreak/commit/88c0d1470556e930a5538a685e2eeea9045c5aad", "message": "CB-9209 do not put stack status to DELETED_ON_PROVIDER_SIDE if results is empty and do not update instancemetadatas or stack status if flow is running for a stack", "committedDate": "2020-10-08T14:27:31Z", "type": "commit"}, {"oid": "88c0d1470556e930a5538a685e2eeea9045c5aad", "url": "https://github.com/hortonworks/cloudbreak/commit/88c0d1470556e930a5538a685e2eeea9045c5aad", "message": "CB-9209 do not put stack status to DELETED_ON_PROVIDER_SIDE if results is empty and do not update instancemetadatas or stack status if flow is running for a stack", "committedDate": "2020-10-08T14:27:31Z", "type": "forcePushed"}]}