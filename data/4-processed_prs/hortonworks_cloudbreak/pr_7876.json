{"pr_number": 7876, "pr_title": "CB-6497: Update Nginx config and other setup for freeipa healthagent", "pr_createdAt": "2020-04-22T19:04:22Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7876", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUzMTAyMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7876#discussion_r413531021", "bodyText": "shouldn't this state have any onlyif/unless option, so we won't run it if not necessary?", "author": "lacikaaa", "createdAt": "2020-04-23T05:59:42Z", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/common-install.sls", "diffHunk": "@@ -65,3 +65,19 @@ restart_httpd:\n     - watch:\n       - file: /etc/httpd/conf.d/ipa-rewrite.conf\n \n+install-healthagent:", "originalCommit": "453867c1b31eb30d364d63d52cc9d01dedf2e6f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg0MjcxMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7876#discussion_r413842710", "bodyText": "There was an unless option before, but I think there was a timing problem between the unless call and the actual script because it should not have run based on the unless, but things were failing because it was.  I moved the unless check into the script itself so the script may be called but the actual action isn't performed unless it's necessary.", "author": "holleyism", "createdAt": "2020-04-23T14:26:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUzMTAyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg4NjYyNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7876#discussion_r413886625", "bodyText": "this will cause saltstack will always detect this as a change which is not ideal. we can still place a file somewhere from the script and check that from unless", "author": "lacikaaa", "createdAt": "2020-04-23T15:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUzMTAyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE0ODk2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7876#discussion_r414148960", "bodyText": "updated to a better check.", "author": "holleyism", "createdAt": "2020-04-23T21:52:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUzMTAyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkxOTQ1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7876#discussion_r415919450", "bodyText": "I think you should place the unless script in the require part too", "author": "lacikaaa", "createdAt": "2020-04-27T15:36:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUzMTAyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA2NDgzNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7876#discussion_r416064834", "bodyText": "added", "author": "holleyism", "createdAt": "2020-04-27T18:50:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUzMTAyMQ=="}], "type": "inlineReview"}, {"oid": "fa79344f8f011641252225b07f8080673c409fcf", "url": "https://github.com/hortonworks/cloudbreak/commit/fa79344f8f011641252225b07f8080673c409fcf", "message": "CB-6497: Update Nginx config and other setup for freeipa healthagent\n\nThis patch adds a new Nginx config, and several salt setup scripts\nto enable the new FreeIpa health agent to run.  The agent will\nbe installed as an RPM and will be a separate code review. CB-6399\n\n(cherry picked from commit afeb8f6cc2c695818a3335ae324bbb08688b8e9d)", "committedDate": "2020-04-23T21:51:48Z", "type": "forcePushed"}, {"oid": "eb2b0b3e05f18dceb2ba192adf6ca165bd1fb6d8", "url": "https://github.com/hortonworks/cloudbreak/commit/eb2b0b3e05f18dceb2ba192adf6ca165bd1fb6d8", "message": "CB-6497: Update Nginx config and other setup for freeipa healthagent\n\nThis patch adds a new Nginx config, and several salt setup scripts\nto enable the new FreeIpa health agent to run.  The agent will\nbe installed as an RPM and will be a separate code review. CB-6399\n\n(cherry picked from commit afeb8f6cc2c695818a3335ae324bbb08688b8e9d)", "committedDate": "2020-04-27T18:49:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ1NTgwMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7876#discussion_r416455803", "bodyText": "I just noticed that this duplicates the content of freeipa_check_replication.sh. could you update this to have it only in one place, eg. like a method and use that in both place?", "author": "lacikaaa", "createdAt": "2020-04-28T09:10:24Z", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_healthagent_setup.sh", "diffHunk": "@@ -0,0 +1,19 @@\n+#!/usr/bin/env bash\n+\n+#\n+# Add anonymous access only for replication agreements\n+#\n+\n+export HOSTCN=`hostname -d| sed -E 's/^|\\./,dc=/g' | sed 's/^,//g'`\n+\n+ldapsearch -x -h localhost -D \"cn=directory manager\" -w $FPW -b \"$HOSTCN\" -s base \"(objectclass=*)\"\n+status=$?", "originalCommit": "eb2b0b3e05f18dceb2ba192adf6ca165bd1fb6d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU4MzI2Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7876#discussion_r416583267", "bodyText": "changed.", "author": "holleyism", "createdAt": "2020-04-28T12:46:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ1NTgwMw=="}], "type": "inlineReview"}, {"oid": "b369d80174ff3381ac24ae2437d217800bcb63c4", "url": "https://github.com/hortonworks/cloudbreak/commit/b369d80174ff3381ac24ae2437d217800bcb63c4", "message": "CB-6497: Update Nginx config and other setup for freeipa healthagent\n\nThis patch adds a new Nginx config, and several salt setup scripts\nto enable the new FreeIpa health agent to run.  The agent will\nbe installed as an RPM and will be a separate code review. CB-6399\n\n(cherry picked from commit afeb8f6cc2c695818a3335ae324bbb08688b8e9d)", "committedDate": "2020-04-28T12:46:03Z", "type": "commit"}, {"oid": "b369d80174ff3381ac24ae2437d217800bcb63c4", "url": "https://github.com/hortonworks/cloudbreak/commit/b369d80174ff3381ac24ae2437d217800bcb63c4", "message": "CB-6497: Update Nginx config and other setup for freeipa healthagent\n\nThis patch adds a new Nginx config, and several salt setup scripts\nto enable the new FreeIpa health agent to run.  The agent will\nbe installed as an RPM and will be a separate code review. CB-6399\n\n(cherry picked from commit afeb8f6cc2c695818a3335ae324bbb08688b8e9d)", "committedDate": "2020-04-28T12:46:03Z", "type": "forcePushed"}]}