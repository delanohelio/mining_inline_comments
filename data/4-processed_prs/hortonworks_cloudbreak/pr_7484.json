{"pr_number": 7484, "pr_title": "CB-5099: FreeIPA changes to support AWS instance recovery", "pr_createdAt": "2020-03-06T06:05:38Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7484", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwMzkzNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r388803935", "bodyText": "could you drop this field in favor of adding only an entry to the parameter map? As it is very spi specific I think we should not include this as a field in CloudStack", "author": "lacikaaa", "createdAt": "2020-03-06T09:44:41Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java", "diffHunk": "@@ -33,8 +33,11 @@\n \n     private final Optional<SpiFileSystem> fileSystem;\n \n+    private final boolean createCloudWatchAlarm;", "originalCommit": "f363f4a5268821f31856be790a200a215ed875ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyOTU5Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r389229593", "bodyText": "fixed", "author": "holleyism", "createdAt": "2020-03-07T05:21:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwMzkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwNjk3MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r388806970", "bodyText": "could you move cloudwatch related code/methods to a separate component?\nthat way it would be easier to write some simple unit test for it also. maybe the condition could be moved there, so you can cover all the pieces of the logic related to it", "author": "lacikaaa", "createdAt": "2020-03-06T09:50:21Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsLaunchService.java", "diffHunk": "@@ -163,9 +176,35 @@\n \n         awsTaggingService.tagRootVolumes(ac, amazonEC2Client, instances, stack.getTags());\n \n+        if (stack.isCreateCloudWatchAlarm()) {\n+            addCloudWatchAlarmsForSystemFailures(instances, regionName, credentialView);\n+        }\n         return awsResourceConnector.check(ac, instances);\n     }\n \n+    private void addCloudWatchAlarmsForSystemFailures(List<CloudResource> instances, String regionName, AwsCredentialView credentialView) {", "originalCommit": "f363f4a5268821f31856be790a200a215ed875ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyOTYwMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r389229603", "bodyText": "moved", "author": "holleyism", "createdAt": "2020-03-07T05:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgwNjk3MA=="}], "type": "inlineReview"}, {"oid": "d48507630c9052a13eee22e0abe51b6db442736e", "url": "https://github.com/hortonworks/cloudbreak/commit/d48507630c9052a13eee22e0abe51b6db442736e", "message": "CB-5099: FreeIPA changes to support AWS instance recovery\n\nThis change adds an automatic cloudwatch alarm during\nthe instance creation for AWS and removes it during\ntermination. This is only necessary for AWS as Azure\nenables this by default. This enables an instance to\nautomatically recover when the underlying hardware,\nowned by AWS, is faulty.", "committedDate": "2020-03-07T05:19:14Z", "type": "forcePushed"}, {"oid": "cbb849b6c655ea008a44239ddc4515ced5a1627c", "url": "https://github.com/hortonworks/cloudbreak/commit/cbb849b6c655ea008a44239ddc4515ced5a1627c", "message": "CB-5099: FreeIPA changes to support AWS instance recovery\n\nThis change adds an automatic cloudwatch alarm during\nthe instance creation for AWS and removes it during\ntermination. This is only necessary for AWS as Azure\nenables this by default. This enables an instance to\nautomatically recover when the underlying hardware,\nowned by AWS, is faulty.", "committedDate": "2020-03-09T14:34:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MDg3Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390390877", "bodyText": "I think this would be better in PlatformParametersConsts", "author": "lacikaaa", "createdAt": "2020-03-10T15:14:59Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudStack.java", "diffHunk": "@@ -13,6 +13,8 @@\n  */\n public class CloudStack {\n \n+    public static final String CLOUDWATCH_CREATE_PARAMETER = \"createCloudWatchAlarm\";", "originalCommit": "cbb849b6c655ea008a44239ddc4515ced5a1627c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUwMDEyNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390500124", "bodyText": "moved", "author": "holleyism", "createdAt": "2020-03-10T17:49:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MDg3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MTYyMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390391622", "bodyText": "Could you move these to @Values so we can easily override them?", "author": "lacikaaa", "createdAt": "2020-03-10T15:15:56Z", "path": "cloud-aws/src/main/java/com/sequenceiq/cloudbreak/cloud/aws/connector/resource/AwsCloudWatchService.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.sequenceiq.cloudbreak.cloud.aws.connector.resource;\n+\n+import static com.sequenceiq.cloudbreak.cloud.model.CloudStack.CLOUDWATCH_CREATE_PARAMETER;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.amazonaws.services.cloudwatch.AmazonCloudWatchClient;\n+import com.amazonaws.services.cloudwatch.model.AmazonCloudWatchException;\n+import com.amazonaws.services.cloudwatch.model.DeleteAlarmsRequest;\n+import com.amazonaws.services.cloudwatch.model.Dimension;\n+import com.amazonaws.services.cloudwatch.model.PutMetricAlarmRequest;\n+import com.sequenceiq.cloudbreak.cloud.aws.AwsClient;\n+import com.sequenceiq.cloudbreak.cloud.aws.view.AwsCredentialView;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudInstance;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudResource;\n+import com.sequenceiq.cloudbreak.cloud.model.CloudStack;\n+\n+@Service\n+public class AwsCloudWatchService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(AwsCloudWatchService.class);\n+\n+    private  static final String ALARM_SUFFIX = \"-Status-Check-Failed-System\";\n+\n+    private static final int CLOUDWATCH_PERIOD = 60;\n+\n+    private static final int CLOUDWATCH_EVALUATION_PERIODS = 2;\n+\n+    private static final double CLOUDWATCH_THRESHOLD = 1.0;", "originalCommit": "cbb849b6c655ea008a44239ddc4515ced5a1627c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1MzIxMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390553213", "bodyText": "done", "author": "holleyism", "createdAt": "2020-03-10T19:17:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MTYyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MjkwNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390392904", "bodyText": "this should be also come from a @Value so we can turn it off/on as we wish", "author": "lacikaaa", "createdAt": "2020-03-10T15:17:37Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/converter/cloud/StackToCloudStackConverter.java", "diffHunk": "@@ -96,8 +97,9 @@ public CloudStack convert(Stack stack, Collection<String> deleteRequestedInstanc\n         Network network = buildNetwork(stack);\n         InstanceAuthentication instanceAuthentication = buildInstanceAuthentication(stack.getStackAuthentication());\n \n-        return new CloudStack(instanceGroups, network, image, Collections.emptyMap(), getUserDefinedTags(stack), stack.getTemplate(),\n-                instanceAuthentication, instanceAuthentication.getLoginUserName(), instanceAuthentication.getPublicKey(), null);\n+        return new CloudStack(instanceGroups, network, image, Map.of(CLOUDWATCH_CREATE_PARAMETER, Boolean.TRUE.toString()),", "originalCommit": "cbb849b6c655ea008a44239ddc4515ced5a1627c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU1MzI4MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7484#discussion_r390553281", "bodyText": "done", "author": "holleyism", "createdAt": "2020-03-10T19:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MjkwNA=="}], "type": "inlineReview"}, {"oid": "7fdccb6e8f1e3087ec53dbfc15a6494938afef0a", "url": "https://github.com/hortonworks/cloudbreak/commit/7fdccb6e8f1e3087ec53dbfc15a6494938afef0a", "message": "CB-5099: FreeIPA changes to support AWS instance recovery\n\nThis change adds an automatic cloudwatch alarm during\nthe instance creation for AWS and removes it during\ntermination. This is only necessary for AWS as Azure\nenables this by default. This enables an instance to\nautomatically recover when the underlying hardware,\nowned by AWS, is faulty.", "committedDate": "2020-03-10T19:34:51Z", "type": "commit"}, {"oid": "7fdccb6e8f1e3087ec53dbfc15a6494938afef0a", "url": "https://github.com/hortonworks/cloudbreak/commit/7fdccb6e8f1e3087ec53dbfc15a6494938afef0a", "message": "CB-5099: FreeIPA changes to support AWS instance recovery\n\nThis change adds an automatic cloudwatch alarm during\nthe instance creation for AWS and removes it during\ntermination. This is only necessary for AWS as Azure\nenables this by default. This enables an instance to\nautomatically recover when the underlying hardware,\nowned by AWS, is faulty.", "committedDate": "2020-03-10T19:34:51Z", "type": "forcePushed"}]}