{"pr_number": 7795, "pr_title": "CB-6497: Update Nginx config and other setup for freeipa healthagent", "pr_createdAt": "2020-04-15T03:35:14Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7795", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYyNzQ2OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r408627469", "bodyText": "I'm not sure it's a good idea to put a new folder under /. Couldn't we just put it under /opt somewhere?", "author": "lacikaaa", "createdAt": "2020-04-15T07:12:53Z", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/init.sls", "diffHunk": "@@ -18,6 +18,16 @@ net.ipv6.conf.lo.disable_ipv6:\n       - {{ host['fqdn'] }}\n {% endfor %}\n \n+{% if salt['pillar.get']('freeipa:hosts') > 1 %}\n+/cdp/ipahealthagent/freeipa_cluster_node:", "originalCommit": "7d61cf9f116c837b96033686672690f7ea95018a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg0NTc3Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r408845777", "bodyText": "/cdp already existed from cluster proxy so seemed like a reasonable place to put it.\nThese already exist:\n/cdp/bin/reverse-tunnel.sh\n/cdp/bin/reverse-tunnel-values.sh\n/cdp/bin/update-reverse-tunnel-values.sh", "author": "holleyism", "createdAt": "2020-04-15T13:35:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYyNzQ2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYzNjg4OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r408636889", "bodyText": "do we really need a separate file for this unless?", "author": "lacikaaa", "createdAt": "2020-04-15T07:30:57Z", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/common-install.sls", "diffHunk": "@@ -65,3 +65,20 @@ restart_httpd:\n     - watch:\n       - file: /etc/httpd/conf.d/ipa-rewrite.conf\n \n+install-healthagent:\n+  cmd.run:\n+    - name: /opt/salt/scripts/freeipa_healthagent_setup.sh\n+    - env:\n+        - FPW: {{salt['pillar.get']('freeipa:password')}}\n+    - failhard: True\n+    - unless: /opt/salt/scripts/freeipa_check_replication.sh", "originalCommit": "7d61cf9f116c837b96033686672690f7ea95018a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg0MzU2MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r408843561", "bodyText": "Yes.  Because of the '|', salt seems to have problems with it.  I tried several different permutations of escaping the character and using cmd.shell, but I kept receiving this error:Failed: Orchestrator component went failed in 4 min(s), message: Salt execution went wrong: Rendering SLS 'base:freeipa.common-install' failed: mapping values are not allowed here; line 60 --- [...] cmd.run: - name: /opt/salt/scripts/freeipa_healthagent_setup.sh - env: - FPW: gnM3.B3J3G3l+-55j?Fe6V7CzDbdmkE_ - failhard: True - unless: ldapsearch -x -h localhost -b cn=config '(objectclass=nsds5replicationagreement)' | grep \"^objectClass: nsds5replicationagreement\"", "author": "holleyism", "createdAt": "2020-04-15T13:32:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYzNjg4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1MTc3OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r409351778", "bodyText": "does it cause any issue on a system which doesn't have the agent installed?", "author": "lacikaaa", "createdAt": "2020-04-16T07:50:50Z", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_healthagent_setup.sh", "diffHunk": "@@ -0,0 +1,20 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+#\n+# Add anonymous access only for replication agreements\n+#\n+export HOSTCN=`hostname -f| sed -E 's/^|\\./,dc=/g' | sed 's/^,[^,]*,//g'`\n+\n+ldapmodify -x -D \"cn=directory manager\" -w $FPW  -h $HOSTNAME << EOF\n+dn: cn=\"$HOSTCN\",cn=mapping tree,cn=config\n+changetype: modify\n+add: aci\n+aci: (targetattr=*)(targetfilter=\"(|(objectclass=nsds5replicationagreement)(objectclass=nsDSWindowsReplicationAgreement))\")(version 3.0; aci \"permission:Read Replication Agreements\"; allow (read, search, compare) groupdn = \"ldap:///anyone\";)\n+EOF\n+\n+#\n+# Add the cert extraction to run when the certificate is updated\n+#\n+ipa-getcert start-tracking -n Server-Cert -d /etc/httpd/alias -C \"/usr/libexec/ipa/certmonger/restart_httpd;systemctl restart freeipa_healthagent\"", "originalCommit": "7d61cf9f116c837b96033686672690f7ea95018a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU5MTg4Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r409591887", "bodyText": "removed.  will make it part of the RPM", "author": "holleyism", "createdAt": "2020-04-16T14:16:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1MTc3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NDM0NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r409354344", "bodyText": "using hostname -d would simplify the sed a bit I think", "author": "lacikaaa", "createdAt": "2020-04-16T07:54:48Z", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_healthagent_setup.sh", "diffHunk": "@@ -0,0 +1,20 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+#\n+# Add anonymous access only for replication agreements\n+#\n+export HOSTCN=`hostname -f| sed -E 's/^|\\./,dc=/g' | sed 's/^,[^,]*,//g'`", "originalCommit": "7d61cf9f116c837b96033686672690f7ea95018a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU5MTczMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7795#discussion_r409591730", "bodyText": "changed.", "author": "holleyism", "createdAt": "2020-04-16T14:15:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NDM0NA=="}], "type": "inlineReview"}, {"oid": "cdc9d02274f7002f6c66bc9d48e6d6985cee398d", "url": "https://github.com/hortonworks/cloudbreak/commit/cdc9d02274f7002f6c66bc9d48e6d6985cee398d", "message": "CB-6497: Update Nginx config and other setup for freeipa healthagent\n\nThis patch adds a new Nginx config, and several salt setup scripts\nto enable the new FreeIpa health agent to run.  The agent will\nbe installed as an RPM and will be a separate code review. CB-6399", "committedDate": "2020-04-16T14:15:38Z", "type": "forcePushed"}, {"oid": "bf6e38f4fba74e26eccf1fd8a590c581c2f49050", "url": "https://github.com/hortonworks/cloudbreak/commit/bf6e38f4fba74e26eccf1fd8a590c581c2f49050", "message": "CB-6497: Update Nginx config and other setup for freeipa healthagent\n\nThis patch adds a new Nginx config, and several salt setup scripts\nto enable the new FreeIpa health agent to run.  The agent will\nbe installed as an RPM and will be a separate code review. CB-6399", "committedDate": "2020-04-20T14:03:24Z", "type": "commit"}, {"oid": "bf6e38f4fba74e26eccf1fd8a590c581c2f49050", "url": "https://github.com/hortonworks/cloudbreak/commit/bf6e38f4fba74e26eccf1fd8a590c581c2f49050", "message": "CB-6497: Update Nginx config and other setup for freeipa healthagent\n\nThis patch adds a new Nginx config, and several salt setup scripts\nto enable the new FreeIpa health agent to run.  The agent will\nbe installed as an RPM and will be a separate code review. CB-6399", "committedDate": "2020-04-20T14:03:24Z", "type": "forcePushed"}]}