{"pr_number": 9434, "pr_title": "CB-9554 recognize if salt highstate fails, because it is is running with another PID", "pr_createdAt": "2020-11-16T15:12:30Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9434", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAxNjY4Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9434#discussion_r525016686", "bodyText": "isEmpty() please", "author": "lacikaaa", "createdAt": "2020-11-17T09:44:10Z", "path": "flow/src/main/java/com/sequenceiq/flow/service/flowlog/FlowLogDBService.java", "diffHunk": "@@ -267,7 +268,11 @@ public FlowLog getLastFlowLogByResourceCrnOrName(String resource) {\n \n     public List<FlowLog> getFlowLogsByFlowIdsCreatedDesc(Set<String> flowIds) {\n         LOGGER.info(\"Getting flow logs by these flow ids: {}\", Joiner.on(\",\").join(flowIds));\n-        return flowLogRepository.findAllByFlowIdsCreatedDesc(flowIds);\n+        if (flowIds.size() > 0) {", "originalCommit": "bc7d01718418a0d6123dba1278918e76c28bcc94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAyMjY2MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9434#discussion_r525022661", "bodyText": "this seems to be ambiguous to me. I think it would be better to use pattern matching here to get the number, which should be a number if I remember it well.\nAlso there is no unit tests for this.\nthis branch the if could be moved to a method called sth like extractRunningHighstateJid or similar", "author": "lacikaaa", "createdAt": "2020-11-17T09:52:44Z", "path": "orchestrator-salt/src/main/java/com/sequenceiq/cloudbreak/orchestrator/salt/states/SaltStates.java", "diffHunk": "@@ -99,7 +99,18 @@ public static ApplyFullResponse showState(SaltConnector sc, String state) {\n \n     public static Multimap<String, Map<String, String>> jidInfo(SaltConnector sc, String jid, Target<String> target, StateType stateType) {\n         if (StateType.HIGH.equals(stateType)) {\n-            return highStateJidInfo(sc, jid);\n+            try {\n+                return highStateJidInfo(sc, jid);\n+            } catch (SaltExecutionWentWrongException e) {\n+                String errorMessage = e.getMessage();\n+                if (errorMessage != null && errorMessage.contains(\"The function \\\"state.highstate\\\" is running as PID\")) {\n+                    String runningHighStateJid = errorMessage.replaceAll(\".*The function \\\"state\\\\.highstate\\\" is running as PID.*with jid \", \"\");", "originalCommit": "bc7d01718418a0d6123dba1278918e76c28bcc94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAyMzIzMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9434#discussion_r525023233", "bodyText": "Unit test is missing for this logic.", "author": "lnardai", "createdAt": "2020-11-17T09:53:35Z", "path": "orchestrator-salt/src/main/java/com/sequenceiq/cloudbreak/orchestrator/salt/states/SaltStates.java", "diffHunk": "@@ -99,7 +99,18 @@ public static ApplyFullResponse showState(SaltConnector sc, String state) {\n \n     public static Multimap<String, Map<String, String>> jidInfo(SaltConnector sc, String jid, Target<String> target, StateType stateType) {\n         if (StateType.HIGH.equals(stateType)) {\n-            return highStateJidInfo(sc, jid);\n+            try {", "originalCommit": "bc7d01718418a0d6123dba1278918e76c28bcc94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "752cfa75bf427b7e62bf18bd9813b3ad6a2651ba", "url": "https://github.com/hortonworks/cloudbreak/commit/752cfa75bf427b7e62bf18bd9813b3ad6a2651ba", "message": "CB-9554 recognize if salt highstate fails, because it is is running with another PID", "committedDate": "2020-11-17T14:55:50Z", "type": "forcePushed"}, {"oid": "4f3df1d5069a767cc3d45db52f1c0d04b29e776e", "url": "https://github.com/hortonworks/cloudbreak/commit/4f3df1d5069a767cc3d45db52f1c0d04b29e776e", "message": "CB-9554 recognize if salt highstate fails, because it is is running with another PID", "committedDate": "2020-11-17T16:06:57Z", "type": "forcePushed"}, {"oid": "c6b4d590c5c8835abbf5767f7b181f208b962ecd", "url": "https://github.com/hortonworks/cloudbreak/commit/c6b4d590c5c8835abbf5767f7b181f208b962ecd", "message": "CB-9554 recognize if salt highstate fails, because it is is running with another PID", "committedDate": "2020-11-17T16:25:03Z", "type": "commit"}, {"oid": "c6b4d590c5c8835abbf5767f7b181f208b962ecd", "url": "https://github.com/hortonworks/cloudbreak/commit/c6b4d590c5c8835abbf5767f7b181f208b962ecd", "message": "CB-9554 recognize if salt highstate fails, because it is is running with another PID", "committedDate": "2020-11-17T16:25:03Z", "type": "forcePushed"}]}