{"pr_number": 9188, "pr_title": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates method", "pr_createdAt": "2020-10-09T12:43:38Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9188", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwOTA1OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#discussion_r502409059", "bodyText": "Should we call it rotateTlsCertDatalake instead? The reason I'm challenging this is that we will have other certs that need to be rotated as well. We already have the let's encrypt certs and soon we will have Database certs.", "author": "keyki", "createdAt": "2020-10-09T12:58:35Z", "path": "authorization-common-api/src/main/java/com/sequenceiq/authorization/resource/AuthorizationResourceAction.java", "diffHunk": "@@ -45,6 +45,7 @@\n     START_DATALAKE(\"datalake/startDatalake\", AuthorizationResourceType.DATALAKE),\n     STOP_DATALAKE(\"datalake/stopDatalake\", AuthorizationResourceType.DATALAKE),\n     UPGRADE_DATALAKE(\"datalake/upgradeDatalake\", AuthorizationResourceType.DATALAKE),\n+    ROTATE_CERT_DATALAKE(\"datalake/rotateCertDatalake\", AuthorizationResourceType.DATALAKE),", "originalCommit": "987d2cc4030f9173e1d8f6a909639ef007e5692f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyMTMwMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#discussion_r502421301", "bodyText": "renamed", "author": "lacikaaa", "createdAt": "2020-10-09T13:19:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwOTA1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQzNjA1NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#discussion_r502436055", "bodyText": "please update legacyRights.json also", "author": "sodre90", "createdAt": "2020-10-09T13:42:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwOTA1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ3ODk0MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#discussion_r502478941", "bodyText": "right, I will upload with the unit tests", "author": "lacikaaa", "createdAt": "2020-10-09T14:45:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwOTA1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU2MDk1OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#discussion_r502560958", "bodyText": "updated and unit test added", "author": "lacikaaa", "createdAt": "2020-10-09T17:01:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwOTA1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwOTUzMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#discussion_r502409530", "bodyText": "please add unit test for this", "author": "horadla23", "createdAt": "2020-10-09T12:59:24Z", "path": "datalake/src/main/java/com/sequenceiq/datalake/service/sdx/cert/CertRotationService.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package com.sequenceiq.datalake.service.sdx.cert;\n+\n+import static com.sequenceiq.datalake.service.sdx.CloudbreakFlowService.FlowState.FINISHED;\n+import static com.sequenceiq.datalake.service.sdx.CloudbreakFlowService.FlowState.RUNNING;\n+\n+import java.util.Collections;\n+\n+import javax.inject.Inject;\n+import javax.ws.rs.NotFoundException;\n+import javax.ws.rs.WebApplicationException;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+import com.dyngr.Polling;\n+import com.dyngr.core.AttemptResult;\n+import com.dyngr.core.AttemptResults;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.common.Status;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.StackV4Endpoint;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.request.CertificatesRotationV4Request;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.CertificatesRotationV4Response;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.StackV4Response;\n+import com.sequenceiq.cloudbreak.api.endpoint.v4.stacks.response.cluster.ClusterV4Response;\n+import com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider;\n+import com.sequenceiq.cloudbreak.cloud.scheduler.PollGroup;\n+import com.sequenceiq.cloudbreak.common.exception.WebApplicationExceptionMessageExtractor;\n+import com.sequenceiq.cloudbreak.common.json.JsonUtil;\n+import com.sequenceiq.cloudbreak.event.ResourceEvent;\n+import com.sequenceiq.cloudbreak.logger.MDCBuilder;\n+import com.sequenceiq.datalake.entity.DatalakeStatusEnum;\n+import com.sequenceiq.datalake.entity.SdxCluster;\n+import com.sequenceiq.datalake.flow.SdxReactorFlowManager;\n+import com.sequenceiq.datalake.flow.cert.rotation.event.SdxStartCertRotationEvent;\n+import com.sequenceiq.datalake.flow.statestore.DatalakeInMemoryStateStore;\n+import com.sequenceiq.datalake.service.sdx.CloudbreakFlowService;\n+import com.sequenceiq.datalake.service.sdx.CloudbreakFlowService.FlowState;\n+import com.sequenceiq.datalake.service.sdx.PollingConfig;\n+import com.sequenceiq.datalake.service.sdx.SdxService;\n+import com.sequenceiq.datalake.service.sdx.status.AvailabilityChecker;\n+import com.sequenceiq.datalake.service.sdx.status.SdxStatusService;\n+import com.sequenceiq.flow.api.model.FlowIdentifier;\n+\n+@Service\n+public class CertRotationService {", "originalCommit": "987d2cc4030f9173e1d8f6a909639ef007e5692f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU2MTExMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#discussion_r502561110", "bodyText": "I have added some unit tests", "author": "lacikaaa", "createdAt": "2020-10-09T17:01:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwOTUzMA=="}], "type": "inlineReview"}, {"oid": "c6217de680b3374efffb18cca31f5add2cb9c759", "url": "https://github.com/hortonworks/cloudbreak/commit/c6217de680b3374efffb18cca31f5add2cb9c759", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions.", "committedDate": "2020-10-09T13:15:26Z", "type": "forcePushed"}, {"oid": "18e485fdde8598e13174efea44fb1c4a9f0e332c", "url": "https://github.com/hortonworks/cloudbreak/commit/18e485fdde8598e13174efea44fb1c4a9f0e332c", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions.", "committedDate": "2020-10-09T15:54:41Z", "type": "forcePushed"}, {"oid": "ab2813cce637831f2f2676d9d2560169db1e6008", "url": "https://github.com/hortonworks/cloudbreak/commit/ab2813cce637831f2f2676d9d2560169db1e6008", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions.", "committedDate": "2020-10-09T16:39:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkzMzAxNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#discussion_r502933015", "bodyText": "Should we call it rotate_autotls_certificates similarly to the permissions?", "author": "keyki", "createdAt": "2020-10-11T15:52:44Z", "path": "core-api/src/main/java/com/sequenceiq/distrox/api/v1/distrox/endpoint/DistroXV1Endpoint.java", "diffHunk": "@@ -359,4 +362,16 @@ void setClusterMaintenanceModeByCrn(@PathParam(\"crn\") String crn,\n     @ApiOperation(value = RENEW_CERTIFICATE, produces = MediaType.APPLICATION_JSON, notes = Notes.RENEW_CERTIFICATE_NOTES,\n             nickname = \"renewDistroXCertificate\")\n     FlowIdentifier renewCertificate(@PathParam(\"crn\") String crn);\n+\n+    @PUT\n+    @Path(\"name/{name}/rotate_certificates\")", "originalCommit": "ab2813cce637831f2f2676d9d2560169db1e6008", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzA3NDE0Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#discussion_r503074142", "bodyText": "it's coming from StackV4Endpoint. I can change this, but then I think I would change in StackV4Endpoint too to keep them in sync. Shall I change them?", "author": "lacikaaa", "createdAt": "2020-10-12T06:54:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkzMzAxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzA3NDg1NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9188#discussion_r503074855", "bodyText": "yes, please.", "author": "keyki", "createdAt": "2020-10-12T06:55:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkzMzAxNQ=="}], "type": "inlineReview"}, {"oid": "cbd29fcba61a4dc583e5fef706d56528f6756ad2", "url": "https://github.com/hortonworks/cloudbreak/commit/cbd29fcba61a4dc583e5fef706d56528f6756ad2", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions.", "committedDate": "2020-10-12T08:42:44Z", "type": "forcePushed"}, {"oid": "d071568267b9a643c85979b7fd952462418a8c91", "url": "https://github.com/hortonworks/cloudbreak/commit/d071568267b9a643c85979b7fd952462418a8c91", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions.", "committedDate": "2020-10-12T08:48:14Z", "type": "forcePushed"}, {"oid": "7ff4db681fded88f67890e8e993f331d0e07f8eb", "url": "https://github.com/hortonworks/cloudbreak/commit/7ff4db681fded88f67890e8e993f331d0e07f8eb", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions.", "committedDate": "2020-10-12T09:19:41Z", "type": "commit"}, {"oid": "7ff4db681fded88f67890e8e993f331d0e07f8eb", "url": "https://github.com/hortonworks/cloudbreak/commit/7ff4db681fded88f67890e8e993f331d0e07f8eb", "message": "CB-8987 Extend Distrox and Sdx API endpoints with rotateCertificates() method\n\nThis commit adds the rotateCertificates to the distrox and sdx endpoints. Also creates a new flow\nin datalake service which initiates the flow in CB and wait until it finishes.\n`datahub/rotateCertDatahub` and `datalake/rotateCertDatalake` are introduced new authorization\nresource actions.", "committedDate": "2020-10-12T09:19:41Z", "type": "forcePushed"}]}