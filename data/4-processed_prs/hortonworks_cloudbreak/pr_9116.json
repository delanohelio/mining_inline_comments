{"pr_number": 9116, "pr_title": "CB-9055: Put NO HDFS feature under entitlement", "pr_createdAt": "2020-09-30T16:21:55Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9116", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxNzkxMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9116#discussion_r497717913", "bodyText": "I don't think the EntitlementService can be null.", "author": "keyki", "createdAt": "2020-09-30T18:31:34Z", "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/configproviders/hbase/HbaseCloudStorageServiceConfigProvider.java", "diffHunk": "@@ -48,9 +55,12 @@ public boolean isConfigurationNeeded(CmTemplateProcessor cmTemplateProcessor, Te\n                 .orElse(false);\n         String cdhVersion = getCdhVersion(source);\n         boolean is722OrNewer = isVersionNewerOrEqualThanLimited(cdhVersion, CLOUDERAMANAGER_VERSION_7_2_2);\n+        GeneralClusterConfigs generalClusterConfigs = source.getGeneralClusterConfigs();\n+        boolean sdxHbaseCloudStorageEnabled = entitlementService == null ? true :", "originalCommit": "7e00ad53fb5b66c175c7233dd1f5377f3af1ff66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc1NjQ2NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9116#discussion_r497756465", "bodyText": "In the test CentralCmTemplateUpdaterTest, I debug into the code, and it is null. That is why I put the condition there to let the test pass. I suspect in real end-to-end test, EntitlementService will not be null.\nWhat is alternative for CentralCmTemplateUpdaterTest to pass without allowing EntitlementService to be null?", "author": "LinaAtAustin", "createdAt": "2020-09-30T19:41:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxNzkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc1NzUzNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9116#discussion_r497757534", "bodyText": "You need to include the service in the test as well\n@Mock\nprivate EntitlementService entitlementService;\n\nand it won't be null", "author": "keyki", "createdAt": "2020-09-30T19:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxNzkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgxMjExMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9116#discussion_r497812111", "bodyText": "The code is updated based on your suggestion.", "author": "LinaAtAustin", "createdAt": "2020-09-30T21:30:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxNzkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcyMDA1NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9116#discussion_r497720055", "bodyText": "I don't think it will work with the environment crn. The stack has a creator crn instead, but I still recommend to use the com.sequenceiq.cloudbreak.auth.ThreadBasedUserCrnProvider.INTERNAL_ACTOR_CRN here and we don't need the usercrn then.", "author": "keyki", "createdAt": "2020-09-30T18:35:18Z", "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/general/GeneralClusterConfigsProvider.java", "diffHunk": "@@ -53,6 +54,9 @@ public GeneralClusterConfigs generalClusterConfigs(Stack stack, Cluster cluster)\n         generalClusterConfigs.setKnoxUserFacingCertConfigured(userFacingCertHasBeenGenerated);\n         generalClusterConfigs.setExternalFQDN(cluster.getFqdn());\n         generalClusterConfigs.setEnableRangerRaz(cluster.isRangerRazEnabled());\n+        generalClusterConfigs.setUserCrn(stack.getEnvironmentCrn());", "originalCommit": "7e00ad53fb5b66c175c7233dd1f5377f3af1ff66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgxNDEzNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9116#discussion_r497814136", "bodyText": "Now, I am using INTERNAL_ACTOR_CRN as crn and ThreadBasedUserCrnProvider.getAccountId() as account ID. This is how entitlement is checked at\nhttps://github.com/hortonworks/cloudbreak/blob/master/core/src/main/java/com/sequenceiq/cloudbreak/converter/v4/stacks/instancegroup/template/InstanceTemplateV4RequestToTemplateConverter.java#L66", "author": "LinaAtAustin", "createdAt": "2020-09-30T21:34:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcyMDA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA4MTA2Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9116#discussion_r498081062", "bodyText": "Hmm, nice trick! I was not aware of ThreadBasedUserCrnProvider.getAccountId(), but it is definitely smarter this way. \ud83d\ude03", "author": "lajosrodek", "createdAt": "2020-10-01T08:44:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcyMDA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA4NjU2Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9116#discussion_r498086567", "bodyText": "unless there is an issue and it contains the wrong account id :D", "author": "keyki", "createdAt": "2020-10-01T08:53:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcyMDA1NQ=="}], "type": "inlineReview"}, {"oid": "db23ea543839cdfb7c7c74907cc4cf1e25766574", "url": "https://github.com/hortonworks/cloudbreak/commit/db23ea543839cdfb7c7c74907cc4cf1e25766574", "message": "CB-9055: Put NO HDFS feature under entitlement", "committedDate": "2020-09-30T21:28:37Z", "type": "commit"}, {"oid": "db23ea543839cdfb7c7c74907cc4cf1e25766574", "url": "https://github.com/hortonworks/cloudbreak/commit/db23ea543839cdfb7c7c74907cc4cf1e25766574", "message": "CB-9055: Put NO HDFS feature under entitlement", "committedDate": "2020-09-30T21:28:37Z", "type": "forcePushed"}]}