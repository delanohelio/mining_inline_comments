{"pr_number": 9252, "pr_title": "CB-9392. Add default annymization rule for CDP hashed password & refactor default rule loading", "pr_createdAt": "2020-10-20T16:38:21Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9252", "timeline": [{"oid": "2f25a694ae9610bc79e20e212251a49a82c3e4b4", "url": "https://github.com/hortonworks/cloudbreak/commit/2f25a694ae9610bc79e20e212251a49a82c3e4b4", "message": "CB-9392. Hide CDP password hashes by default in ipa logs.", "committedDate": "2020-10-20T17:25:08Z", "type": "forcePushed"}, {"oid": "260282c2433a40c7065a9ca3b260c2f11a482e84", "url": "https://github.com/hortonworks/cloudbreak/commit/260282c2433a40c7065a9ca3b260c2f11a482e84", "message": "CB-9392. Add default annymization rule for CDP hashed password & refactor default rule loading", "committedDate": "2020-10-22T13:38:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg3NzA0MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9252#discussion_r511877040", "bodyText": "I think we won't notice this issue when something is wrong if we let the app start", "author": "lacikaaa", "createdAt": "2020-10-26T11:01:09Z", "path": "environment/src/main/java/com/sequenceiq/environment/telemetry/service/AccountTelemetryService.java", "diffHunk": "@@ -28,28 +38,25 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(AccountTelemetryService.class);\n \n-    private static final String EMAIL_PATTERN = \"\\\\b([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\\\\-\\\\._]\" +\n-            \"*[A-Za-z0-9])@(([A-Za-z0-9]|[A-Za-z][A-Za-z0-9\\\\-]*[A-Za-z0-9])\\\\.)+([A-Za-z0-9]\" +\n-            \"|[A-Za-z0-9][A-Za-z0-9\\\\-]*[A-Za-z0-9])\\\\b\";\n-\n-    private static final String EMAIL_REPLACEMENT = \"email@redacted.host\";\n-\n-    private static final String CREDIT_CARD_PATTERN = \"\\\\d{4}[^\\\\w]\\\\d{4}[^\\\\w]\\\\d{4}[^\\\\w]\\\\d{4}\";\n-\n-    private static final String CREDIT_CARD_REPLACEMENT = \"XXXX-XXXX-XXXX-XXXX\";\n-\n-    private static final String SSN_PATTERN = \"\\\\d{3}[^\\\\w]\\\\d{2}[^\\\\w]\\\\d{4}\";\n-\n-    private static final String SSN_REPLACEMENT = \"XXX-XX-XXXX\";\n-\n-    private static final String FREEIPA_PWD_PATTERN = \"FPW\\\\:\\\\s+[\\\\w|\\\\W].*\";\n+    private final AccountTelemetryRepository accountTelemetryRepository;\n \n-    private static final String FREEIPA_PWD_REPLACEMENT = \"FPW: [REDACTED]\";\n+    private final String rulesFileLocation;\n \n-    private final AccountTelemetryRepository accountTelemetryRepository;\n+    private List<AnonymizationRule> defaultRules = new ArrayList<>();\n \n-    public AccountTelemetryService(AccountTelemetryRepository accountTelemetryRepository) {\n+    public AccountTelemetryService(AccountTelemetryRepository accountTelemetryRepository,\n+            @Value(\"${environment.telemetry.default.rules.file:telemetry/default-anonymization-rules.yaml\") String rulesFileLocation) {\n         this.accountTelemetryRepository = accountTelemetryRepository;\n+        this.rulesFileLocation = rulesFileLocation;\n+    }\n+\n+    @PostConstruct\n+    public void init() {\n+        try {\n+            defaultRules = loadAnonymizationRules();\n+        } catch (IOException e) {\n+            LOGGER.error(\"Error during loading default anonymization rules.\", e);\n+        }", "originalCommit": "260282c2433a40c7065a9ca3b260c2f11a482e84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg3ODQ2Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9252#discussion_r511878462", "bodyText": "we should test the same file we use in prod, and not a different one.", "author": "lacikaaa", "createdAt": "2020-10-26T11:03:51Z", "path": "environment/src/test/resources/default-anonymization-rules.yaml", "diffHunk": "@@ -0,0 +1,10 @@\n+- pattern: \\b([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\\-\\._]*[A-Za-z0-9])@(([A-Za-z0-9]|[A-Za-z][A-Za-z0-9\\-]*[A-Za-z0-9])\\.)+([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\\-]*[A-Za-z0-9])\\b\n+  replacement: \"email@redacted.host\"\n+- pattern: \\d{4}[^\\w]\\d{4}[^\\w]\\d{4}[^\\w]\\d{4}\n+  replacement: \"XXXX-XXXX-XXXX-XXXX\"\n+- pattern: \\d{3}[^\\w]\\d{2}[^\\w]\\d{4}\n+  replacement: \"XXX-XX-XXXX\"\n+- pattern: FPW\\:\\s+[\\w|\\W].*\n+  replacement: \"FPW: [REDACTED]\"\n+- pattern: cdpHashedPassword=.*[']\n+  replacement: \"[CDP PWD ATTRS REDACTED]\"", "originalCommit": "260282c2433a40c7065a9ca3b260c2f11a482e84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc3ODE1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9252#discussion_r512778150", "bodyText": "now the objects are mocked as the tests are not about to parsing the files (as config read from application.yml)", "author": "oleewere", "createdAt": "2020-10-27T15:13:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg3ODQ2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg4MzMyNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9252#discussion_r511883327", "bodyText": "instead of reading the file manually, wouldn't be it better if we would use spring for this? like in InstanceMetadataUpdater we use it for reading the packages info.", "author": "lacikaaa", "createdAt": "2020-10-26T11:13:02Z", "path": "environment/src/main/java/com/sequenceiq/environment/telemetry/service/AccountTelemetryService.java", "diffHunk": "@@ -190,4 +178,26 @@ private String createCRN(String accountId) {\n                 .build()\n                 .toString();\n     }\n+\n+    private List<AnonymizationRule> loadAnonymizationRules() throws IOException {", "originalCommit": "260282c2433a40c7065a9ca3b260c2f11a482e84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg4Mzc1OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9252#discussion_r511883759", "bodyText": "unnecessary space as first char", "author": "lacikaaa", "createdAt": "2020-10-26T11:13:57Z", "path": "environment/src/main/resources/telemetry/default-anonymization-rules.yaml", "diffHunk": "@@ -0,0 +1,10 @@\n+- pattern: \\b([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\\-\\._]*[A-Za-z0-9])@(([A-Za-z0-9]|[A-Za-z][A-Za-z0-9\\-]*[A-Za-z0-9])\\.)+([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\\-]*[A-Za-z0-9])\\b\n+  replacement: \"email@redacted.host\"\n+- pattern: \\d{4}[^\\w]\\d{4}[^\\w]\\d{4}[^\\w]\\d{4}\n+  replacement: \"XXXX-XXXX-XXXX-XXXX\"\n+- pattern: \\d{3}[^\\w]\\d{2}[^\\w]\\d{4}\n+  replacement: \"XXX-XX-XXXX\"\n+- pattern: FPW\\:\\s+[\\w|\\W].*\n+  replacement: \"FPW: [REDACTED]\"\n+ - pattern: cdpHashedPassword=.*[']", "originalCommit": "260282c2433a40c7065a9ca3b260c2f11a482e84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "83bbde7a33a5aa8479394b51a4fd72ea958ba5d1", "url": "https://github.com/hortonworks/cloudbreak/commit/83bbde7a33a5aa8479394b51a4fd72ea958ba5d1", "message": "CB-9392. Add default annymization rule for CDP hashed password & refactor default rule loading\n- include rule definitions in environment application.yml", "committedDate": "2020-10-27T15:11:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI4MDMzOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9252#discussion_r513280338", "bodyText": "the main purpose of @Configuration is to indicate the class declares Beans\nI think here we should go with @Component", "author": "lacikaaa", "createdAt": "2020-10-28T09:05:53Z", "path": "environment/src/main/java/com/sequenceiq/environment/configuration/telemetry/AccountTelemetryConfig.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package com.sequenceiq.environment.configuration.telemetry;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.springframework.boot.context.properties.ConfigurationProperties;\n+import org.springframework.context.annotation.Configuration;\n+\n+import com.sequenceiq.common.api.telemetry.model.AnonymizationRule;\n+\n+@Configuration", "originalCommit": "83bbde7a33a5aa8479394b51a4fd72ea958ba5d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8613d8dd4ff1916749aa0ae10b3a9d290edbb75a", "url": "https://github.com/hortonworks/cloudbreak/commit/8613d8dd4ff1916749aa0ae10b3a9d290edbb75a", "message": "CB-9392. Add default annymization rule for CDP hashed password & refactor default rule loading\n- include rule definitions in environment application.yml", "committedDate": "2020-10-28T11:14:09Z", "type": "commit"}, {"oid": "8613d8dd4ff1916749aa0ae10b3a9d290edbb75a", "url": "https://github.com/hortonworks/cloudbreak/commit/8613d8dd4ff1916749aa0ae10b3a9d290edbb75a", "message": "CB-9392. Add default annymization rule for CDP hashed password & refactor default rule loading\n- include rule definitions in environment application.yml", "committedDate": "2020-10-28T11:14:09Z", "type": "forcePushed"}]}