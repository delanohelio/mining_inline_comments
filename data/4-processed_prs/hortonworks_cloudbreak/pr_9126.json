{"pr_number": 9126, "pr_title": "CB-9044 Flow handling race condition fix on flow redistribution", "pr_createdAt": "2020-10-01T12:05:28Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9126", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE5MzcwNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9126#discussion_r498193705", "bodyText": "are these fields not called at all in the tests ? I guess some verification should be useful", "author": "doktoric", "createdAt": "2020-10-01T12:09:17Z", "path": "flow/src/test/java/com/sequenceiq/flow/core/Flow2HandlerTest.java", "diffHunk": "@@ -150,6 +152,12 @@\n     @Mock\n     private SpanContext spanContext;\n \n+    @Mock", "originalCommit": "67b174ba50d2b64e12d219ae04a9c198a2c2caf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI1NTM2MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9126#discussion_r498255361", "bodyText": "wrote a test", "author": "bergerdenes", "createdAt": "2020-10-01T13:44:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE5MzcwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE5NDQxMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9126#discussion_r498194411", "bodyText": "this is the same with cancelFlowWithoutDbUpdate", "author": "topolyai5", "createdAt": "2020-10-01T12:10:27Z", "path": "flow/src/main/java/com/sequenceiq/flow/cleanup/InMemoryCleanup.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package com.sequenceiq.flow.cleanup;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.cloud.scheduler.PollGroup;\n+import com.sequenceiq.cloudbreak.cloud.store.InMemoryResourceStateStore;\n+import com.sequenceiq.flow.core.FlowRegister;\n+import com.sequenceiq.flow.core.chain.FlowChains;\n+\n+@Component\n+public class InMemoryCleanup {\n+\n+    @Inject\n+    private FlowRegister runningFlows;\n+\n+    @Inject\n+    private FlowChains flowChains;\n+\n+    public void cancelEveryFlowWithoutDbUpdate() {\n+        for (String resourceType : InMemoryResourceStateStore.getResourceTypes()) {\n+            for (Long resourceId : InMemoryResourceStateStore.getAllResourceId(resourceType)) {\n+                InMemoryResourceStateStore.putResource(resourceType, resourceId, PollGroup.CANCELLED);\n+            }\n+        }\n+        for (String id : runningFlows.getRunningFlowIds()) {\n+            String flowChainId = runningFlows.getFlowChainId(id);\n+            if (flowChainId != null) {\n+                flowChains.removeFullFlowChain(flowChainId);\n+            }\n+            runningFlows.remove(id);", "originalCommit": "67b174ba50d2b64e12d219ae04a9c198a2c2caf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIwNTY5Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9126#discussion_r498205697", "bodyText": "true, reused.", "author": "bergerdenes", "createdAt": "2020-10-01T12:30:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE5NDQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIwMDQ2Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9126#discussion_r498200466", "bodyText": "why don't you send this inside the lamda?", "author": "topolyai5", "createdAt": "2020-10-01T12:21:14Z", "path": "flow/src/main/java/com/sequenceiq/flow/core/Flow2Handler.java", "diffHunk": "@@ -184,11 +193,24 @@ private void handleFlowControlEvent(String key, Payload payload, FlowParameters\n         LOGGER.debug(\"flow control event arrived: key: {}, flowid: {}, usercrn: {}, payload: {}\", key, flowId, flowParameters.getFlowTriggerUserCrn(), payload);\n         Flow flow = runningFlows.get(flowId);\n         if (flow != null) {\n+            MutableBoolean isFlowCancelled = new MutableBoolean(false);\n             transactionService.required(() -> {\n                 Optional<FlowLog> lastFlowLog = flowLogService.getLastFlowLog(flow.getFlowId());\n-                lastFlowLog.ifPresent(flowLog -> updateFlowLogStatus(key, payload, flowChainId, flow, flowLog, flowParameters));\n+                lastFlowLog.ifPresent(flowLog -> {\n+                    String nodeId = nodeConfig.getId();\n+                    if (flowLog.getCloudbreakNodeId() == null || flowLog.getCloudbreakNodeId().equals(nodeId)) {\n+                        updateFlowLogStatus(key, payload, flowChainId, flow, flowLog, flowParameters);\n+                    } else {\n+                        LOGGER.warn(\"Flow {} was handled by another node {}, current node ID is {}, abandoning.\",\n+                                flow.getFlowId(), flowLog.getCloudbreakNodeId(), nodeId);\n+                        inMemoryCleanup.cancelFlowWithoutDbUpdate(flow.getFlowId());\n+                        isFlowCancelled.setTrue();\n+                    }\n+                });\n             });\n-            flow.sendEvent(key, flowParameters.getFlowTriggerUserCrn(), payload, flowParameters.getSpanContext());\n+            if (!isFlowCancelled.booleanValue()) {", "originalCommit": "67b174ba50d2b64e12d219ae04a9c198a2c2caf5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIwMjE1Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9126#discussion_r498202153", "bodyText": "it may take some time to consume events, and it shouldn't be in a transaction then", "author": "sodre90", "createdAt": "2020-10-01T12:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIwMDQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIwMzQzMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9126#discussion_r498203432", "bodyText": "I see, thanks", "author": "topolyai5", "createdAt": "2020-10-01T12:26:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIwMDQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIwNDU1NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9126#discussion_r498204554", "bodyText": "because that would change the logic: the sendEvent is necessary in the case lastFlowLog is not present", "author": "bergerdenes", "createdAt": "2020-10-01T12:28:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIwMDQ2Ng=="}], "type": "inlineReview"}, {"oid": "62043d6dbd674f0e56cb1a3b2d034e3e2fb48352", "url": "https://github.com/hortonworks/cloudbreak/commit/62043d6dbd674f0e56cb1a3b2d034e3e2fb48352", "message": "CB-9044 Flow handling race condition fix on flow redistribution\n\nThe issue was caused when a failed node resumes operation but in the\nmeantime another node picked up the same flow.\nThe fix is that the resumed node does not continue progressing the\nflow if the last operation is performed by another node, rather\nremoving the particular flow from the in-memory store and skipping\nflow continuation.", "committedDate": "2020-10-01T13:23:44Z", "type": "commit"}, {"oid": "62043d6dbd674f0e56cb1a3b2d034e3e2fb48352", "url": "https://github.com/hortonworks/cloudbreak/commit/62043d6dbd674f0e56cb1a3b2d034e3e2fb48352", "message": "CB-9044 Flow handling race condition fix on flow redistribution\n\nThe issue was caused when a failed node resumes operation but in the\nmeantime another node picked up the same flow.\nThe fix is that the resumed node does not continue progressing the\nflow if the last operation is performed by another node, rather\nremoving the particular flow from the in-memory store and skipping\nflow continuation.", "committedDate": "2020-10-01T13:23:44Z", "type": "forcePushed"}]}