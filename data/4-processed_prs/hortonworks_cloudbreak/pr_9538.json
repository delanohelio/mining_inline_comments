{"pr_number": 9538, "pr_title": "CB-10013 - added validation to ssh public key registration in environment service", "pr_createdAt": "2020-11-30T14:45:20Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9538", "timeline": [{"oid": "94abfd86c02a58436a7049edbcdd2a753d4beb72", "url": "https://github.com/hortonworks/cloudbreak/commit/94abfd86c02a58436a7049edbcdd2a753d4beb72", "message": "CB-10013 - added validation to ssh public key registration in environment service\n- Validating for all the supported algorithm for SSH public key and replacing the comment part with \"cloudbreak\".\n- We had multiple issues with invalid public keys, one particular customer had backslashes in the comment section\nwhich rendered the Azure ARM template invalid. This change will mitigate such errors.\n\nThe regex is based on this: https://gist.github.com/paranoiq/1932126#gistcomment-3211232", "committedDate": "2020-11-30T14:46:37Z", "type": "forcePushed"}, {"oid": "326f5ad2f486cdfe29d85e1178db7d116ce273d6", "url": "https://github.com/hortonworks/cloudbreak/commit/326f5ad2f486cdfe29d85e1178db7d116ce273d6", "message": "CB-10013 - added validation to ssh public key registration in environment service\n- Validating for all the supported algorithm for SSH public key and replacing the comment part with \"cloudbreak\".\n- We had multiple issues with invalid public keys, one particular customer had backslashes in the comment section\nwhich rendered the Azure ARM template invalid. This change will mitigate such errors.\n\nThe regex is based on this: https://gist.github.com/paranoiq/1932126#gistcomment-3211232", "committedDate": "2020-11-30T17:34:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4NzM1OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532887359", "bodyText": "I would like to see more use case here based on the regex", "author": "doktoric", "createdAt": "2020-11-30T20:36:13Z", "path": "environment/src/test/java/com/sequenceiq/environment/environment/dto/AuthenticationDtoConverterTest.java", "diffHunk": "@@ -59,4 +67,19 @@ void authenticationToDto() {\n                 .matches(m -> Objects.equals(m.getPublicKeyId(), environment.getPublicKeyId()))\n                 .matches(m -> Objects.equals(m.isManagedKey(), environment.isManagedKey()));\n     }\n+\n+    @Test\n+    void testSshKeyCreation() {", "originalCommit": "326f5ad2f486cdfe29d85e1178db7d116ce273d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2MzQ1NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532963455", "bodyText": "It's not the place to test it. It has it's tests in the PublicKeyValidatorTest", "author": "attilapalfi92", "createdAt": "2020-11-30T23:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4NzM1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzMyMDA5MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r533320091", "bodyText": "\ud83d\udc4d", "author": "doktoric", "createdAt": "2020-12-01T10:57:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4NzM1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4NzYzMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532887633", "bodyText": "verify would be great", "author": "doktoric", "createdAt": "2020-11-30T20:36:42Z", "path": "environment/src/test/java/com/sequenceiq/environment/environment/dto/AuthenticationDtoConverterTest.java", "diffHunk": "@@ -59,4 +67,19 @@ void authenticationToDto() {\n                 .matches(m -> Objects.equals(m.getPublicKeyId(), environment.getPublicKeyId()))\n                 .matches(m -> Objects.equals(m.isManagedKey(), environment.isManagedKey()));\n     }\n+\n+    @Test\n+    void testSshKeyCreation() {\n+        String testKey = \"ssh-rsa AAAASASFAS3532== banana@apple.com\";\n+        AuthenticationDto dto = AuthenticationDto.builder()\n+                .withLoginUserName(LOGIN)\n+                .withPublicKey(testKey)\n+                .withPublicKeyId(PUBLIC_KEY_ID)\n+                .withManagedKey(true)\n+                .build();\n+\n+        EnvironmentAuthentication environmentAuthentication = underTest.dtoToAuthentication(dto);\n+\n+        assertEquals(\"ssh-rsa AAAASASFAS3532== cloudbreak\", environmentAuthentication.getPublicKey());", "originalCommit": "326f5ad2f486cdfe29d85e1178db7d116ce273d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2NDU5MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532964590", "bodyText": "can you help me, what do you mean by verify?", "author": "attilapalfi92", "createdAt": "2020-11-30T23:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4NzYzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4NzgwNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532887806", "bodyText": "please add verify as well", "author": "doktoric", "createdAt": "2020-11-30T20:36:56Z", "path": "environment/src/test/java/com/sequenceiq/environment/environment/service/EnvironmentCreationServiceTest.java", "diffHunk": "@@ -94,6 +95,11 @@\n     @Inject\n     private EnvironmentCreationService environmentCreationServiceUnderTest;\n \n+    @BeforeEach\n+    void setup() {\n+        when(validatorService.validatePublicKey(any())).thenReturn(ValidationResult.empty());", "originalCommit": "326f5ad2f486cdfe29d85e1178db7d116ce273d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4ODIyMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532888221", "bodyText": "would be nice to see the result in test name", "author": "doktoric", "createdAt": "2020-11-30T20:37:43Z", "path": "environment/src/test/java/com/sequenceiq/environment/environment/validation/validators/PublicKeyValidatorTest.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package com.sequenceiq.environment.environment.validation.validators;\n+\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.sequenceiq.cloudbreak.validation.ValidationResult;\n+\n+class PublicKeyValidatorTest {\n+\n+    private final PublicKeyValidator underTest = new PublicKeyValidator();\n+\n+    @Test\n+    void testPublicKeyValidationWithValidKeyAndComment() {\n+        String validKey = \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDXF9paZtj6ibDgRGtw2jTls1fysxETxG/rbCN9vYlpDw6ROK90rjXnC0qi43kXbs5Z/Ny\" +\n+                \"FDDcYW4U1nUmJCIhQqNJv00ukTbS4McfeNYrZF78KNLtbUP57SfKzjcH1Txz9Zr3ILEADqMyNRzgSB2gw5XnfbbLUFQYcF3hT11gjEw99Qi9eCQ6nC\" +\n+                \"M37iy9tCIfMyB5CI24LECv+8UMFdYw+X9JQXgkAlcPi1zmVNckD6dDGGC2nY9mK7jw0dqZ2W/Q2HvGVgP7iSxnKIFIylifPMz0jmtzpjPi4czgr34\" +\n+                \"d4PFlQsv8LgwWEQMyTJGQmtF3GGa1o/qT07gePY2tl1sAzOLszfglmkBZS+POYi65fxYGepF5C0Rmc3427dLp+HPl8QSAuq0j92/3LGLOKTjn1qC2\" +\n+                \"MjBNhbkhFhDKnv0VQslmN/nkgDKUSHfQqfMwo4HXFIIydUWxT+5PxFCaS4axzGQ2HYylxqonnU3P0DJkh/omegI36HyxxlMNlpf/zn3/zrwSFvKN\" +\n+                \"CFvbQezJg8jdqq7VEHx4DH6WhYQ02TLsjmcA0EFp1HxTCbJojD/Ixev/Wc5duHotOBiS0CXdJwyzKSQttQS9NGn+/LvUyiD/Z/Rz2r3B0LpQsQu4\" +\n+                \"tI/8F5Jq+QiRgS9cQRnuLZuvAwbSNYI+g+zPdhaZq8fvumWarcQ== apalfi@hortonworks.com\\n\" +\n+                \"\\n\";\n+\n+        ValidationResult validationResult = underTest.validatePublicKey(validKey);\n+        assertFalse(validationResult.hasError());\n+    }\n+\n+    @Test\n+    void testPublicKeyValidationWithBackSlashesInComment() {", "originalCommit": "326f5ad2f486cdfe29d85e1178db7d116ce273d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4ODM1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532888350", "bodyText": "would be nice to see the result in test name", "author": "doktoric", "createdAt": "2020-11-30T20:37:58Z", "path": "environment/src/test/java/com/sequenceiq/environment/environment/validation/validators/PublicKeyValidatorTest.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package com.sequenceiq.environment.environment.validation.validators;\n+\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.sequenceiq.cloudbreak.validation.ValidationResult;\n+\n+class PublicKeyValidatorTest {\n+\n+    private final PublicKeyValidator underTest = new PublicKeyValidator();\n+\n+    @Test\n+    void testPublicKeyValidationWithValidKeyAndComment() {\n+        String validKey = \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDXF9paZtj6ibDgRGtw2jTls1fysxETxG/rbCN9vYlpDw6ROK90rjXnC0qi43kXbs5Z/Ny\" +\n+                \"FDDcYW4U1nUmJCIhQqNJv00ukTbS4McfeNYrZF78KNLtbUP57SfKzjcH1Txz9Zr3ILEADqMyNRzgSB2gw5XnfbbLUFQYcF3hT11gjEw99Qi9eCQ6nC\" +\n+                \"M37iy9tCIfMyB5CI24LECv+8UMFdYw+X9JQXgkAlcPi1zmVNckD6dDGGC2nY9mK7jw0dqZ2W/Q2HvGVgP7iSxnKIFIylifPMz0jmtzpjPi4czgr34\" +\n+                \"d4PFlQsv8LgwWEQMyTJGQmtF3GGa1o/qT07gePY2tl1sAzOLszfglmkBZS+POYi65fxYGepF5C0Rmc3427dLp+HPl8QSAuq0j92/3LGLOKTjn1qC2\" +\n+                \"MjBNhbkhFhDKnv0VQslmN/nkgDKUSHfQqfMwo4HXFIIydUWxT+5PxFCaS4axzGQ2HYylxqonnU3P0DJkh/omegI36HyxxlMNlpf/zn3/zrwSFvKN\" +\n+                \"CFvbQezJg8jdqq7VEHx4DH6WhYQ02TLsjmcA0EFp1HxTCbJojD/Ixev/Wc5duHotOBiS0CXdJwyzKSQttQS9NGn+/LvUyiD/Z/Rz2r3B0LpQsQu4\" +\n+                \"tI/8F5Jq+QiRgS9cQRnuLZuvAwbSNYI+g+zPdhaZq8fvumWarcQ== apalfi@hortonworks.com\\n\" +\n+                \"\\n\";\n+\n+        ValidationResult validationResult = underTest.validatePublicKey(validKey);\n+        assertFalse(validationResult.hasError());\n+    }\n+\n+    @Test\n+    void testPublicKeyValidationWithBackSlashesInComment() {\n+        String validKey = \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDXF9paZtj6ibDgRGtw2jTls1fysxETxG/rbCN9vYlpDw6ROK90rjXnC0qi43kXbs5Z/Ny\" +\n+                \"FDDcYW4U1nUmJCIhQqNJv00ukTbS4McfeNYrZF78KNLtbUP57SfKzjcH1Txz9Zr3ILEADqMyNRzgSB2gw5XnfbbLUFQYcF3hT11gjEw99Qi9eCQ6nC\" +\n+                \"M37iy9tCIfMyB5CI24LECv+8UMFdYw+X9JQXgkAlcPi1zmVNckD6dDGGC2nY9mK7jw0dqZ2W/Q2HvGVgP7iSxnKIFIylifPMz0jmtzpjPi4czgr34\" +\n+                \"d4PFlQsv8LgwWEQMyTJGQmtF3GGa1o/qT07gePY2tl1sAzOLszfglmkBZS+POYi65fxYGepF5C0Rmc3427dLp+HPl8QSAuq0j92/3LGLOKTjn1qC2\" +\n+                \"MjBNhbkhFhDKnv0VQslmN/nkgDKUSHfQqfMwo4HXFIIydUWxT+5PxFCaS4axzGQ2HYylxqonnU3P0DJkh/omegI36HyxxlMNlpf/zn3/zrwSFvKN\" +\n+                \"CFvbQezJg8jdqq7VEHx4DH6WhYQ02TLsjmcA0EFp1HxTCbJojD/Ixev/Wc5duHotOBiS0CXdJwyzKSQttQS9NGn+/LvUyiD/Z/Rz2r3B0LpQsQu4\" +\n+                \"tI/8F5Jq+QiRgS9cQRnuLZuvAwbSNYI+g+zPdhaZq8fvumWarcQ== office01\\\\\\\\en10022@PCL15925\\n\" +\n+                \"\\n\";\n+\n+        ValidationResult validationResult = underTest.validatePublicKey(validKey);\n+        assertFalse(validationResult.hasError());\n+    }\n+\n+    @Test\n+    void testPublicKeyValidationWithNoComment() {", "originalCommit": "326f5ad2f486cdfe29d85e1178db7d116ce273d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4ODM4OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532888388", "bodyText": "would be nice to see the result in test name", "author": "doktoric", "createdAt": "2020-11-30T20:38:02Z", "path": "environment/src/test/java/com/sequenceiq/environment/environment/validation/validators/PublicKeyValidatorTest.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package com.sequenceiq.environment.environment.validation.validators;\n+\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.sequenceiq.cloudbreak.validation.ValidationResult;\n+\n+class PublicKeyValidatorTest {\n+\n+    private final PublicKeyValidator underTest = new PublicKeyValidator();\n+\n+    @Test\n+    void testPublicKeyValidationWithValidKeyAndComment() {\n+        String validKey = \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDXF9paZtj6ibDgRGtw2jTls1fysxETxG/rbCN9vYlpDw6ROK90rjXnC0qi43kXbs5Z/Ny\" +\n+                \"FDDcYW4U1nUmJCIhQqNJv00ukTbS4McfeNYrZF78KNLtbUP57SfKzjcH1Txz9Zr3ILEADqMyNRzgSB2gw5XnfbbLUFQYcF3hT11gjEw99Qi9eCQ6nC\" +\n+                \"M37iy9tCIfMyB5CI24LECv+8UMFdYw+X9JQXgkAlcPi1zmVNckD6dDGGC2nY9mK7jw0dqZ2W/Q2HvGVgP7iSxnKIFIylifPMz0jmtzpjPi4czgr34\" +\n+                \"d4PFlQsv8LgwWEQMyTJGQmtF3GGa1o/qT07gePY2tl1sAzOLszfglmkBZS+POYi65fxYGepF5C0Rmc3427dLp+HPl8QSAuq0j92/3LGLOKTjn1qC2\" +\n+                \"MjBNhbkhFhDKnv0VQslmN/nkgDKUSHfQqfMwo4HXFIIydUWxT+5PxFCaS4axzGQ2HYylxqonnU3P0DJkh/omegI36HyxxlMNlpf/zn3/zrwSFvKN\" +\n+                \"CFvbQezJg8jdqq7VEHx4DH6WhYQ02TLsjmcA0EFp1HxTCbJojD/Ixev/Wc5duHotOBiS0CXdJwyzKSQttQS9NGn+/LvUyiD/Z/Rz2r3B0LpQsQu4\" +\n+                \"tI/8F5Jq+QiRgS9cQRnuLZuvAwbSNYI+g+zPdhaZq8fvumWarcQ== apalfi@hortonworks.com\\n\" +\n+                \"\\n\";\n+\n+        ValidationResult validationResult = underTest.validatePublicKey(validKey);\n+        assertFalse(validationResult.hasError());\n+    }\n+\n+    @Test\n+    void testPublicKeyValidationWithBackSlashesInComment() {\n+        String validKey = \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDXF9paZtj6ibDgRGtw2jTls1fysxETxG/rbCN9vYlpDw6ROK90rjXnC0qi43kXbs5Z/Ny\" +\n+                \"FDDcYW4U1nUmJCIhQqNJv00ukTbS4McfeNYrZF78KNLtbUP57SfKzjcH1Txz9Zr3ILEADqMyNRzgSB2gw5XnfbbLUFQYcF3hT11gjEw99Qi9eCQ6nC\" +\n+                \"M37iy9tCIfMyB5CI24LECv+8UMFdYw+X9JQXgkAlcPi1zmVNckD6dDGGC2nY9mK7jw0dqZ2W/Q2HvGVgP7iSxnKIFIylifPMz0jmtzpjPi4czgr34\" +\n+                \"d4PFlQsv8LgwWEQMyTJGQmtF3GGa1o/qT07gePY2tl1sAzOLszfglmkBZS+POYi65fxYGepF5C0Rmc3427dLp+HPl8QSAuq0j92/3LGLOKTjn1qC2\" +\n+                \"MjBNhbkhFhDKnv0VQslmN/nkgDKUSHfQqfMwo4HXFIIydUWxT+5PxFCaS4axzGQ2HYylxqonnU3P0DJkh/omegI36HyxxlMNlpf/zn3/zrwSFvKN\" +\n+                \"CFvbQezJg8jdqq7VEHx4DH6WhYQ02TLsjmcA0EFp1HxTCbJojD/Ixev/Wc5duHotOBiS0CXdJwyzKSQttQS9NGn+/LvUyiD/Z/Rz2r3B0LpQsQu4\" +\n+                \"tI/8F5Jq+QiRgS9cQRnuLZuvAwbSNYI+g+zPdhaZq8fvumWarcQ== office01\\\\\\\\en10022@PCL15925\\n\" +\n+                \"\\n\";\n+\n+        ValidationResult validationResult = underTest.validatePublicKey(validKey);\n+        assertFalse(validationResult.hasError());\n+    }\n+\n+    @Test\n+    void testPublicKeyValidationWithNoComment() {\n+        String validKey = \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDXF9paZtj6ibDgRGtw2jTls1fysxETxG/rbCN9vYlpDw6ROK90rjXnC0qi43kXbs5Z/Ny\" +\n+                \"FDDcYW4U1nUmJCIhQqNJv00ukTbS4McfeNYrZF78KNLtbUP57SfKzjcH1Txz9Zr3ILEADqMyNRzgSB2gw5XnfbbLUFQYcF3hT11gjEw99Qi9eCQ6nC\" +\n+                \"M37iy9tCIfMyB5CI24LECv+8UMFdYw+X9JQXgkAlcPi1zmVNckD6dDGGC2nY9mK7jw0dqZ2W/Q2HvGVgP7iSxnKIFIylifPMz0jmtzpjPi4czgr34\" +\n+                \"d4PFlQsv8LgwWEQMyTJGQmtF3GGa1o/qT07gePY2tl1sAzOLszfglmkBZS+POYi65fxYGepF5C0Rmc3427dLp+HPl8QSAuq0j92/3LGLOKTjn1qC2\" +\n+                \"MjBNhbkhFhDKnv0VQslmN/nkgDKUSHfQqfMwo4HXFIIydUWxT+5PxFCaS4axzGQ2HYylxqonnU3P0DJkh/omegI36HyxxlMNlpf/zn3/zrwSFvKN\" +\n+                \"CFvbQezJg8jdqq7VEHx4DH6WhYQ02TLsjmcA0EFp1HxTCbJojD/Ixev/Wc5duHotOBiS0CXdJwyzKSQttQS9NGn+/LvUyiD/Z/Rz2r3B0LpQsQu4\" +\n+                \"tI/8F5Jq+QiRgS9cQRnuLZuvAwbSNYI+g+zPdhaZq8fvumWarcQ==\";\n+\n+        ValidationResult validationResult = underTest.validatePublicKey(validKey);\n+        assertFalse(validationResult.hasError());\n+    }\n+\n+    @Test\n+    void testPublicKeyValidationWith45Parts() {", "originalCommit": "326f5ad2f486cdfe29d85e1178db7d116ce273d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4ODU5MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532888590", "bodyText": "based on the regex we should cover more scenario", "author": "doktoric", "createdAt": "2020-11-30T20:38:30Z", "path": "environment/src/test/java/com/sequenceiq/environment/environment/validation/validators/PublicKeyValidatorTest.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package com.sequenceiq.environment.environment.validation.validators;\n+\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.sequenceiq.cloudbreak.validation.ValidationResult;\n+\n+class PublicKeyValidatorTest {", "originalCommit": "326f5ad2f486cdfe29d85e1178db7d116ce273d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2MzgyNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532963827", "bodyText": "I'll create one for each algorithm", "author": "attilapalfi92", "createdAt": "2020-11-30T23:11:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4ODU5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzMxOTQ1NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r533319455", "bodyText": "I see these \"ssh-rsa\", \"ecdsa-sha2-nistp256\", \"ecdsa-sha2-nistp384\", \"ecdsa-sha2-nistp521\", \"ssh-ed25519\", \"ssh-dss\"", "author": "doktoric", "createdAt": "2020-12-01T10:56:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4ODU5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzMyNDA0OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r533324049", "bodyText": "those are the algorithms", "author": "attilapalfi92", "createdAt": "2020-12-01T11:04:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4ODU5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4ODgyMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532888822", "bodyText": "why space is here ?", "author": "doktoric", "createdAt": "2020-11-30T20:39:00Z", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/mock/EnvironmentEditTest.java", "diffHunk": "@@ -66,7 +73,7 @@ public void authenticationEditWhenSetExistingKeyAndDeleteManagedSuccessfully(Moc\n                 .then((tc, t, c) -> {\n                     String publicKeyId = t.getResponse().getAuthentication().getPublicKeyId();\n                     String publicKey = t.getResponse().getAuthentication().getPublicKey();\n-                    if (!\"existing-public-key\".equals(publicKeyId)) {\n+                    if (!\"existing-public-key\" .equals(publicKeyId)) {", "originalCommit": "326f5ad2f486cdfe29d85e1178db7d116ce273d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2MzkyMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532963921", "bodyText": "I guess its an error", "author": "attilapalfi92", "createdAt": "2020-11-30T23:12:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4ODgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4OTAwMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532889001", "bodyText": "do we need space here ?", "author": "doktoric", "createdAt": "2020-11-30T20:39:20Z", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/testcase/mock/EnvironmentEditTest.java", "diffHunk": "@@ -110,7 +117,7 @@ public void authenticationEditWhenSetManagedKeyAndNotDeleteExisted(MockedTestCon\n                 .then((tc, t, c) -> {\n                     String publicKeyId = t.getResponse().getAuthentication().getPublicKeyId();\n                     String publicKey = t.getResponse().getAuthentication().getPublicKey();\n-                    if (\"existing-public-key\".equals(publicKeyId)) {\n+                    if (\"existing-public-key\" .equals(publicKeyId)) {", "originalCommit": "326f5ad2f486cdfe29d85e1178db7d116ce273d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2NDAwMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532964000", "bodyText": "I don't know why the space is here", "author": "attilapalfi92", "createdAt": "2020-11-30T23:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4OTAwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4OTUyMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532889522", "bodyText": "do we need this?", "author": "doktoric", "createdAt": "2020-11-30T20:40:14Z", "path": "usage-collection/src/generated/main/java/com/cloudera/thunderhead/service/common/usage/UsageProto.java", "diffHunk": "@@ -42919,7 +42919,7 @@ private CDPEnvironmentsEnvironmentType(\n       YARN(4),\n       /**\n        * <pre>\n-       * YCloud", "originalCommit": "326f5ad2f486cdfe29d85e1178db7d116ce273d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2NDQyNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532964425", "bodyText": "interesting change. I rebased to the master and dont remember touching this", "author": "attilapalfi92", "createdAt": "2020-11-30T23:13:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4OTUyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg5MDcxMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532890710", "bodyText": "why cloudbreak at the end?", "author": "doktoric", "createdAt": "2020-11-30T20:42:33Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/dto/AuthenticationDtoConverter.java", "diffHunk": "@@ -1,16 +1,34 @@\n package com.sequenceiq.environment.environment.dto;\n \n+import java.util.Arrays;\n+import java.util.List;\n+\n+import org.apache.commons.lang3.StringUtils;\n import org.springframework.stereotype.Component;\n \n+import com.sequenceiq.cloudbreak.validation.ValidationResult;\n import com.sequenceiq.environment.environment.domain.EnvironmentAuthentication;\n+import com.sequenceiq.environment.environment.validation.validators.PublicKeyValidator;\n \n @Component\n public class AuthenticationDtoConverter {\n \n+    private final PublicKeyValidator publicKeyValidator;\n+\n+    public AuthenticationDtoConverter(PublicKeyValidator publicKeyValidator) {\n+        this.publicKeyValidator = publicKeyValidator;\n+    }\n+\n     public EnvironmentAuthentication dtoToAuthentication(AuthenticationDto authenticationDto) {\n         EnvironmentAuthentication environmentAuthentication = new EnvironmentAuthentication();\n+        if (StringUtils.isNotEmpty(authenticationDto.getPublicKey())) {\n+            ValidationResult validationResult = publicKeyValidator.validatePublicKey(authenticationDto.getPublicKey());\n+            if (!validationResult.hasError()) {\n+                List<String> parts = Arrays.asList(StringUtils.split(authenticationDto.getPublicKey(), \" \"));\n+                environmentAuthentication.setPublicKey(String.format(\"%s %s %s\", parts.get(0), parts.get(1), \"cloudbreak\"));", "originalCommit": "326f5ad2f486cdfe29d85e1178db7d116ce273d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2NDE5Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r532964196", "bodyText": "this is what we agreed in the support meeting", "author": "attilapalfi92", "createdAt": "2020-11-30T23:12:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg5MDcxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzMxODg5Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r533318897", "bodyText": "authenticationDto.loginUserName pls", "author": "doktoric", "createdAt": "2020-12-01T10:55:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg5MDcxMA=="}], "type": "inlineReview"}, {"oid": "01cacb51a78fb092b3aee35508d255643ec63ab9", "url": "https://github.com/hortonworks/cloudbreak/commit/01cacb51a78fb092b3aee35508d255643ec63ab9", "message": "CB-10013 - added validation to ssh public key registration in environment service\n- Validating for all the supported algorithm for SSH public key and replacing the comment part with the login user name which has the default value: \"cloudbreak\".\n- We had multiple issues with invalid public keys, one particular customer had backslashes in the comment section\nwhich rendered the Azure ARM template invalid. This change will mitigate such errors.\n\nThe regex is based on this: https://gist.github.com/paranoiq/1932126#gistcomment-3211232", "committedDate": "2020-12-01T11:38:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzMzMzY5Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r533333692", "bodyText": "what if we determine the non-matching character with e.g end() and give it back in the validation result? The methods start() and end() will give the indexes into the text where the found match starts and ends. Actually end() returns the index of the character just after the end of the matching section.", "author": "pdarvasi", "createdAt": "2020-12-01T11:21:36Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/validation/validators/PublicKeyValidator.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package com.sequenceiq.environment.environment.validation.validators;\n+\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.validation.ValidationResult;\n+\n+@Component\n+public class PublicKeyValidator {\n+\n+    private static final Set<String> SUPPORTED_ALGORITHMS\n+            = Set.of(\"ssh-rsa\", \"ecdsa-sha2-nistp256\", \"ecdsa-sha2-nistp384\", \"ecdsa-sha2-nistp521\", \"ssh-ed25519\", \"ssh-dss\");\n+\n+    private static final String ALGORITHM_TEXT_LIST = String.join(\", \", SUPPORTED_ALGORITHMS);\n+\n+    private static final Pattern SSH_PUBLIC_KEY_PATTERN = Pattern.compile(\"^(ssh-rsa AAAAB3NzaC1yc2|ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNT|\"\n+            + \"ecdsa-sha2-nistp384 AAAAE2VjZHNhLXNoYTItbmlzdHAzODQAAAAIbmlzdHAzOD|ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1Mj|\"\n+            + \"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5|ssh-dss AAAAB3NzaC1kc3)[0-9A-Za-z+\\\\/]+[=]{0,3}( .*)?$\");\n+\n+    public ValidationResult validatePublicKey(String publicKey) {\n+        ValidationResult.ValidationResultBuilder validationResultBuilder = ValidationResult.builder();\n+        if (StringUtils.isNotEmpty(publicKey)) {\n+            if (!SSH_PUBLIC_KEY_PATTERN.matcher(publicKey.trim()).matches()) {", "originalCommit": "326f5ad2f486cdfe29d85e1178db7d116ce273d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4OTM0Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9538#discussion_r533389346", "bodyText": "start and find throws illegalstateexception when there is no match and with this regex there are no partial matches / groups", "author": "attilapalfi92", "createdAt": "2020-12-01T13:00:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzMzMzY5Mg=="}], "type": "inlineReview"}, {"oid": "8ac33e98d6a3cfe03f78ae561d25ccc33765ad34", "url": "https://github.com/hortonworks/cloudbreak/commit/8ac33e98d6a3cfe03f78ae561d25ccc33765ad34", "message": "CB-10013 - added validation to ssh public key registration in environment service\n- Validating for all the supported algorithm for SSH public key and replacing the comment part with the login user name which has the default value: \"cloudbreak\".\n- We had multiple issues with invalid public keys, one particular customer had backslashes in the comment section\nwhich rendered the Azure ARM template invalid. This change will mitigate such errors.\n\nThe regex is based on this: https://gist.github.com/paranoiq/1932126#gistcomment-3211232", "committedDate": "2020-12-01T13:05:18Z", "type": "forcePushed"}, {"oid": "337e0c8834e2f1f2de722c449a9d7ba65ea47441", "url": "https://github.com/hortonworks/cloudbreak/commit/337e0c8834e2f1f2de722c449a9d7ba65ea47441", "message": "CB-10013 - added validation to ssh public key registration in environment service\n- Validating for all the supported algorithm for SSH public key and replacing the comment part with the login user name which has the default value: \"cloudbreak\".\n- We had multiple issues with invalid public keys, one particular customer had backslashes in the comment section\nwhich rendered the Azure ARM template invalid. This change will mitigate such errors.\n\nThe regex is based on this: https://gist.github.com/paranoiq/1932126#gistcomment-3211232", "committedDate": "2020-12-01T15:22:10Z", "type": "commit"}, {"oid": "337e0c8834e2f1f2de722c449a9d7ba65ea47441", "url": "https://github.com/hortonworks/cloudbreak/commit/337e0c8834e2f1f2de722c449a9d7ba65ea47441", "message": "CB-10013 - added validation to ssh public key registration in environment service\n- Validating for all the supported algorithm for SSH public key and replacing the comment part with the login user name which has the default value: \"cloudbreak\".\n- We had multiple issues with invalid public keys, one particular customer had backslashes in the comment section\nwhich rendered the Azure ARM template invalid. This change will mitigate such errors.\n\nThe regex is based on this: https://gist.github.com/paranoiq/1932126#gistcomment-3211232", "committedDate": "2020-12-01T15:22:10Z", "type": "forcePushed"}]}