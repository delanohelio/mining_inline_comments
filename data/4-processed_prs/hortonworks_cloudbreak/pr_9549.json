{"pr_number": 9549, "pr_title": "CDPSDX-1981: missing DNS a record in ipa", "pr_createdAt": "2020-12-01T17:41:56Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9549", "timeline": [{"oid": "2c1785349b4768ce08b23536c49425392f6176c5", "url": "https://github.com/hortonworks/cloudbreak/commit/2c1785349b4768ce08b23536c49425392f6176c5", "message": "CDPSDX-1981: missing DNS a record in ipa\n\nDuring datalake provisioning, an intermittent error of \"does not have corresponding DNS A/AAAA record\" happens. As we verified that dns a-record was first added and then went missing before adding service to kerbores later, we added 3 times retry with a random 10-15 seconds interval to remedy this. Also this will help to confirm how long the issue lasts and whether it comes back.", "committedDate": "2020-12-01T17:45:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE4OTg1MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9549#discussion_r534189850", "bodyText": "why random? I think we should stick with a fix value", "author": "lacikaaa", "createdAt": "2020-12-02T14:03:41Z", "path": "orchestrator-salt/src/main/resources/salt/salt/sssd/template/add_dns_record.j2", "diffHunk": "@@ -17,10 +17,15 @@ FQDN=$(hostname -f)\n IPADDR=$(hostname -i)\n REVERSE_IP=$(hostname -i | awk -F. '{print $4\".\"$3\".\" $2\".\"$1}')\n \n-# dnsrecord-add must either add the record or modify it\n-if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n-  ipa dnsrecord-add {{ pillar['sssd-ipa']['domain'] }}. \"${HOSTNAME}\" \"--a-rec=${IPADDR}\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}\n-fi\n+# add dns a-record 3 times with a random 10-15 seconds interval (see CDPSDX-1981)\n+for attempt in {1..3}\n+do\n+  echo \"add dns a-record hostname for ${HOSTNAME}, attempt ${attempt}\"\n+  if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n+    ipa dnsrecord-add {{ pillar['sssd-ipa']['domain'] }}. \"${HOSTNAME}\" \"--a-rec=${IPADDR}\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}\n+  fi\n+  sleep $(((RANDOM % 5) + 10))", "originalCommit": "2c1785349b4768ce08b23536c49425392f6176c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIyODA5Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9549#discussion_r534228093", "bodyText": "Thanks! I changed it to a fixed 10. It is more of a personal habit to put random or exponential in retry as learned from previous experience.", "author": "christmasferret", "createdAt": "2020-12-02T14:52:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE4OTg1MA=="}], "type": "inlineReview"}, {"oid": "b9f1353ec2e7893d01d3e4da432c8599bab9b54c", "url": "https://github.com/hortonworks/cloudbreak/commit/b9f1353ec2e7893d01d3e4da432c8599bab9b54c", "message": "CDPSDX-1981: missing DNS a record in ipa\n\nDuring datalake provisioning, an intermittent error of \"does not have corresponding DNS A/AAAA record\" happens. As we verified that dns a-record was first added and then went missing before adding service to kerbores later, we added 3 times retry with a random 10-15 seconds interval to remedy this. Also this will help to confirm how long the issue lasts and whether it comes back.", "committedDate": "2020-12-02T14:49:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM1NTE5Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9549#discussion_r534355197", "bodyText": "please adjust the comment to the code, as it's not random now. thanks", "author": "lacikaaa", "createdAt": "2020-12-02T17:36:23Z", "path": "orchestrator-salt/src/main/resources/salt/salt/sssd/template/add_dns_record.j2", "diffHunk": "@@ -17,10 +17,15 @@ FQDN=$(hostname -f)\n IPADDR=$(hostname -i)\n REVERSE_IP=$(hostname -i | awk -F. '{print $4\".\"$3\".\" $2\".\"$1}')\n \n-# dnsrecord-add must either add the record or modify it\n-if ! ipa dnsrecord-find {{ pillar['sssd-ipa']['domain'] }}. \"--name=${HOSTNAME}\" \"--a-rec=${IPADDR}\"  --ttl {{ pillar['sssd-ipa']['dns_ttl'] }} --all; then\n-  ipa dnsrecord-add {{ pillar['sssd-ipa']['domain'] }}. \"${HOSTNAME}\" \"--a-rec=${IPADDR}\" --ttl {{ pillar['sssd-ipa']['dns_ttl'] }}\n-fi\n+# add dns a-record 3 times with a random 10-15 seconds interval (see CDPSDX-1981)", "originalCommit": "b9f1353ec2e7893d01d3e4da432c8599bab9b54c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQzODI4MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9549#discussion_r534438281", "bodyText": "resolved", "author": "christmasferret", "createdAt": "2020-12-02T19:49:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM1NTE5Nw=="}], "type": "inlineReview"}, {"oid": "307977c070cdea2b22d19039091a1369347ad42e", "url": "https://github.com/hortonworks/cloudbreak/commit/307977c070cdea2b22d19039091a1369347ad42e", "message": "CDPSDX-1981: missing DNS a record in ipa\n\nDuring datalake provisioning, an intermittent error of \"does not have corresponding DNS A/AAAA record\" happens. As we verified that dns a-record was first added and then went missing before adding service to kerbores later, we added 3 times retry with a random 10-15 seconds interval to remedy this. Also this will help to confirm how long the issue lasts and whether it comes back.", "committedDate": "2020-12-02T18:10:58Z", "type": "commit"}, {"oid": "307977c070cdea2b22d19039091a1369347ad42e", "url": "https://github.com/hortonworks/cloudbreak/commit/307977c070cdea2b22d19039091a1369347ad42e", "message": "CDPSDX-1981: missing DNS a record in ipa\n\nDuring datalake provisioning, an intermittent error of \"does not have corresponding DNS A/AAAA record\" happens. As we verified that dns a-record was first added and then went missing before adding service to kerbores later, we added 3 times retry with a random 10-15 seconds interval to remedy this. Also this will help to confirm how long the issue lasts and whether it comes back.", "committedDate": "2020-12-02T18:10:58Z", "type": "forcePushed"}]}