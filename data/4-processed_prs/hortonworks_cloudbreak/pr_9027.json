{"pr_number": 9027, "pr_title": "CB-8825 MockUMS fixes for thunderhead DatalakeApi service custom DL", "pr_createdAt": "2020-09-16T18:52:39Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9027", "timeline": [{"oid": "b9ce7f08e41a32905ce918bd385d3675c096870d", "url": "https://github.com/hortonworks/cloudbreak/commit/b9ce7f08e41a32905ce918bd385d3675c096870d", "message": "CB-8825 MockUMS fixes for thunderhead DatalakeApi service custom DL\n\nContents:\n* Improve MockUserManagementService.getAccount():\n  * Grant entitlement CDP_CM_ADMIN_CREDENTIALS\n  * Set accountId in response (as per request)\n  * Set externalAccountId in response\n* Implement MockUserManagementService.listTerms()\n  (empty dummy response only)\n* Update existing unit tests & add some new cases", "committedDate": "2020-09-17T14:42:00Z", "type": "commit"}, {"oid": "b9ce7f08e41a32905ce918bd385d3675c096870d", "url": "https://github.com/hortonworks/cloudbreak/commit/b9ce7f08e41a32905ce918bd385d3675c096870d", "message": "CB-8825 MockUMS fixes for thunderhead DatalakeApi service custom DL\n\nContents:\n* Improve MockUserManagementService.getAccount():\n  * Grant entitlement CDP_CM_ADMIN_CREDENTIALS\n  * Set accountId in response (as per request)\n  * Set externalAccountId in response\n* Implement MockUserManagementService.listTerms()\n  (empty dummy response only)\n* Update existing unit tests & add some new cases", "committedDate": "2020-09-17T14:42:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0Nzc2OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9027#discussion_r490847768", "bodyText": "bit strange that the variable name is different from the value. would this mean CDP_CM_ADMIN_CREDENTIALS has the right to use/create custom templates?", "author": "lacikaaa", "createdAt": "2020-09-18T10:17:27Z", "path": "mock-thunderhead/src/main/java/com/sequenceiq/thunderhead/grpc/service/auth/MockUserManagementService.java", "diffHunk": "@@ -210,6 +212,9 @@\n \n     private static final String CDP_ALLOW_INTERNAL_REPOSITORY_FOR_UPGRADE = \"CDP_ALLOW_INTERNAL_REPOSITORY_FOR_UPGRADE\";\n \n+    // See com.cloudera.thunderhead.service.common.entitlements.CdpEntitlements.CDP_CP_CUSTOM_DL_TEMPLATE\n+    private static final String CDP_CP_CUSTOM_DL_TEMPLATE = \"CDP_CM_ADMIN_CREDENTIALS\";", "originalCommit": "b9ce7f08e41a32905ce918bd385d3675c096870d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1NTk1Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9027#discussion_r490855952", "bodyText": "Yes. The name is indeed totally confusing. I am not sure what the originally intended name was supposed to be, but wanted to keep the thunderhead constant name here for \"consistency\". For reference, the check in DatalakeApi svc is made here.", "author": "lajosrodek", "createdAt": "2020-09-18T10:33:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0Nzc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkxNjYzNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9027#discussion_r490916636", "bodyText": "Shall I rather rename the constant to match the actual entitlement name?", "author": "lajosrodek", "createdAt": "2020-09-18T12:32:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0Nzc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAzMTc0NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9027#discussion_r491031744", "bodyText": "I'm  fine with it, it just seemed interesting and could indicate some error. but @keyki should check this", "author": "lacikaaa", "createdAt": "2020-09-18T15:37:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0Nzc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0MDQxOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9027#discussion_r491040419", "bodyText": "It's fine with me. If we would rename it to CDP_CM_ADMIN_CREDENTIALS probably it would be totally misleading what is it supposed to guard. But, indeed I'm not sure what this entitlement supposed to do.  Seems like a bad copy-paste error: https://github.infra.cloudera.com/thunderhead/thunderhead/blob/4cf3cae30759e47df352b2b41bc8b9c30b2c43b8/services/libs/common/src/main/java/com/cloudera/thunderhead/service/common/entitlements/CdpEntitlements.java#L510.", "author": "keyki", "createdAt": "2020-09-18T15:51:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0Nzc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA3NzcyMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9027#discussion_r491077722", "bodyText": "Yeah. I fear it is too late to \"rename\" the entitlement as it might be already in use in several tenants. \ud83d\ude03", "author": "lajosrodek", "createdAt": "2020-09-18T16:59:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0Nzc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1MzkwOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9027#discussion_r490853909", "bodyText": "is this ok to using a fixed external name here?", "author": "doktoric", "createdAt": "2020-09-18T10:29:08Z", "path": "mock-thunderhead/src/main/java/com/sequenceiq/thunderhead/grpc/service/auth/MockUserManagementService.java", "diffHunk": "@@ -590,7 +595,10 @@ public void getAccount(GetAccountRequest request, StreamObserver<GetAccountRespo\n                                 .addEntitlements(createEntitlement(DATAHUB_AZURE_AUTOSCALING))\n                                 .addEntitlements(createEntitlement(DATAHUB_AWS_AUTOSCALING))\n                                 .addEntitlements(createEntitlement(LOCAL_DEV))\n+                                .addEntitlements(createEntitlement(CDP_CP_CUSTOM_DL_TEMPLATE))\n                                 .setPasswordPolicy(workloadPasswordPolicy)\n+                                .setAccountId(request.getAccountId())\n+                                .setExternalAccountId(\"external-\" + request.getAccountId())", "originalCommit": "b9ce7f08e41a32905ce918bd385d3675c096870d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkxNjE5MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9027#discussion_r490916190", "bodyText": "Honestly I do not know what this is supposed to be like. For most of the real UMS tenants, the externalAccountId is derived from the corresponding SalesForce (SFDC) account ID. For instance, mow-dev (accountId=9d74eee4-1cad-45d7-b645-7ccf9edbb73d) has externalAccountId=0018000000ik5epAAA. As far as I can tell, the 001 is a fixed prefix, while the last 3 characters are a sort-of checksum calculated from the rest of the string.\nThe relevant code in DatalakeApi svc making the check is located here. The underlying implementation currently only asserts that the account response contains both accountId and externalAccountId and they are non-empty.\nI could find a Java implementation for the calculation logic of \"real\" externalAccountId's based on the SFDC ID in thunderhead (SFDCUtils.java and SFDC.java), but did not feel it justified to duplicate the same behavior here until it is crucial. What is your preference?", "author": "lajosrodek", "createdAt": "2020-09-18T12:31:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1MzkwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1NDYyMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9027#discussion_r490854620", "bodyText": "the import order in your intellij is somehow different that ours please check", "author": "doktoric", "createdAt": "2020-09-18T10:30:37Z", "path": "mock-thunderhead/src/main/java/com/sequenceiq/thunderhead/grpc/service/auth/MockUserManagementService.java", "diffHunk": "@@ -85,10 +85,12 @@\n import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ListMachineUsersResponse;\n import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ListResourceAssigneesRequest;\n import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ListResourceAssigneesResponse;\n-import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ListServicePrincipalCloudIdentitiesRequest;\n-import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ListServicePrincipalCloudIdentitiesResponse;\n import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ListRolesRequest;\n import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ListRolesResponse;\n+import com.cloudera.thunderhead.service.usermanagement.UserManagementProto.ListServicePrincipalCloudIdentitiesRequest;", "originalCommit": "b9ce7f08e41a32905ce918bd385d3675c096870d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDkxOTY5Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9027#discussion_r490919692", "bodyText": "Pardon me but my ordering seems alright. All the imports are now in the correct lexicographical order. Why would ListServicePrincipalCloudIdentitiesResponse come before ListRolesRequest? Same below, com.sequenceiq.thunderhead.* seems to be greater than com.sequenceiq.cloudbreak.*, so the former ones shall probably come later in the import list. Could you please clarify what this should look like?", "author": "lajosrodek", "createdAt": "2020-09-18T12:38:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1NDYyMA=="}], "type": "inlineReview"}]}