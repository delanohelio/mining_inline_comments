{"pr_number": 9059, "pr_title": "CB-8714 Fix OCSP and CRL URL for CM CA", "pr_createdAt": "2020-09-22T11:23:29Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9059", "timeline": [{"oid": "2805a9ff563dc6ee9c89f83d0f641a2e245c7067", "url": "https://github.com/hortonworks/cloudbreak/commit/2805a9ff563dc6ee9c89f83d0f641a2e245c7067", "message": "CB-8714 Fix OCSP and CRL URL for CM CA\n\nWhen creating cloudera manager intermediate CA, it has a default\nprofile present. This has invalid settings for OCSP and CRL. In this\ncommit we are replacing those values with the right ones.\nOCSP and CRL are solutions for checking if the certificate is still\nvalid even if it's not expired. It makes possible to revoke a\ncertificate in cases like it has been compromised or in our case the\ncluster is deleted.", "committedDate": "2020-09-23T09:34:07Z", "type": "commit"}, {"oid": "2805a9ff563dc6ee9c89f83d0f641a2e245c7067", "url": "https://github.com/hortonworks/cloudbreak/commit/2805a9ff563dc6ee9c89f83d0f641a2e245c7067", "message": "CB-8714 Fix OCSP and CRL URL for CM CA\n\nWhen creating cloudera manager intermediate CA, it has a default\nprofile present. This has invalid settings for OCSP and CRL. In this\ncommit we are replacing those values with the right ones.\nOCSP and CRL are solutions for checking if the certificate is still\nvalid even if it's not expired. It makes possible to revoke a\ncertificate in cases like it has been compromised or in our case the\ncluster is deleted.", "committedDate": "2020-09-23T09:34:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzM5MTM2MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9059#discussion_r493391361", "bodyText": "Should we have an unless condition or it doesn't matter as replace wouldn't do anything anyway?", "author": "keyki", "createdAt": "2020-09-23T09:54:03Z", "path": "orchestrator-salt/src/main/resources/salt/salt/cloudera/manager/init.sls", "diffHunk": "@@ -88,6 +88,18 @@ cloudera_manager_set_parcel_validation:\n \n {% if cloudera_manager.communication.autotls_enabled == True %}\n \n+replace_crl_in_cmca_profile:\n+  file.replace:\n+    - name: /etc/cloudera-scm-server/cmSubCaCert.profile\n+    - pattern: \"policyset.cmSubCaCertSet.9.default.params.crlDistPointsPointName_0=http://changeme.com/ipa/crl/MasterCRL.bin\"\n+    - repl: \"policyset.cmSubCaCertSet.9.default.params.crlDistPointsPointName_0=http://ipa-ca.{{ metadata.cluster_domain }}/ipa/crl/MasterCRL.bin\"", "originalCommit": "2805a9ff563dc6ee9c89f83d0f641a2e245c7067", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzM5NzMyNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9059#discussion_r493397324", "bodyText": "AFAIK file.replace will only make a change if it has any effect. But I can test it", "author": "lacikaaa", "createdAt": "2020-09-23T10:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzM5MTM2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQyNDUzMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9059#discussion_r493424530", "bodyText": "----------\n          ID: cloudera_manager_set_parcel_validation\n    Function: file.replace\n        Name: /opt/cloudera/cm/bin/cm-server\n      Result: True\n     Comment: unless condition is true\n     Started: 10:26:57.457679\n    Duration: 20.731 ms\n     Changes:\n----------\n          ID: replace_crl_in_cmca_profile\n    Function: file.replace\n        Name: /etc/cloudera-scm-server/cmSubCaCert.profile\n      Result: True\n     Comment: No changes needed to be made\n     Started: 10:26:57.478883\n    Duration: 5.332 ms\n     Changes:\n----------\n          ID: replace_ocsp_in_cmca_profile\n    Function: file.replace\n        Name: /etc/cloudera-scm-server/cmSubCaCert.profile\n      Result: True\n     Comment: No changes needed to be made\n     Started: 10:26:57.484460\n    Duration: 4.205 ms\n     Changes:\n----------\n\nthe first state is with unless+grep, the other 2 is the new state. in result there is no difference, it's even faster this way", "author": "lacikaaa", "createdAt": "2020-09-23T10:29:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzM5MTM2MQ=="}], "type": "inlineReview"}]}