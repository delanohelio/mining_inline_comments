{"pr_number": 8195, "pr_title": "CB-7047 change the default kerberos encryption type to aes256-cte", "pr_createdAt": "2020-06-02T15:21:56Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8195", "timeline": [{"oid": "8ea460934678cd34cdcec3950128a3c07e7016f4", "url": "https://github.com/hortonworks/cloudbreak/commit/8ea460934678cd34cdcec3950128a3c07e7016f4", "message": "CB-7047 change the default kerberos encryption type to aes256-cte", "committedDate": "2020-06-02T15:19:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4MjYzMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8195#discussion_r433982630", "bodyText": "does it work with mixed deployments?\n\nold clusters e.g sdx have been deployed with old settings\nnew clusters e.g new DHs are deployed with the new settings", "author": "akanto", "createdAt": "2020-06-02T15:50:11Z", "path": "orchestrator-salt/src/main/resources/salt/salt/kerberos/config/cm-krb.j2", "diffHunk": "@@ -3,4 +3,7 @@ setsettings KRB_AUTH_ENABLE true\n setsettings SECURITY_REALM {{ salt['pillar.get']('kerberos:realm')|upper }}\n setsettings KDC_HOST {{ salt['pillar.get']('kerberos:url') }}\n setsettings KDC_ADMIN_HOST {{ salt['pillar.get']('kerberos:adminUrl') }}\n-setsettings KDC_TYPE \"Red Hat IPA\"\n\\ No newline at end of file\n+setsettings KDC_TYPE \"Red Hat IPA\"", "originalCommit": "8ea460934678cd34cdcec3950128a3c07e7016f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4NDI5Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8195#discussion_r433984297", "bodyText": "I haven't tested yet. I will do that, although I'm not sure how to confirm if it works or not.", "author": "keyki", "createdAt": "2020-06-02T15:51:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4MjYzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMzODM0Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8195#discussion_r434338342", "bodyText": "I launched a Data Lake with old encryption rc4-hmac. Keytab for Ranger:\nKeytab name: FILE:/var/run/cloudera-scm-agent/process/1546333866-ranger-RANGER_ADMIN/ranger.keytab\nKVNO Timestamp           Principal\n---- ------------------- ------------------------------------------------------\n   1 06/03/2020 05:26:38 HTTP/krisz-datalake-1-master0.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes256-cts-hmac-sha1-96)\n   1 06/03/2020 05:26:38 HTTP/krisz-datalake-1-master0.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes128-cts-hmac-sha1-96)\n   1 06/03/2020 05:26:38 HTTP/krisz-datalake-1-master0.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes256-cts-hmac-sha384-192)\n   1 06/03/2020 05:26:38 HTTP/krisz-datalake-1-master0.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes128-cts-hmac-sha256-128)\n   1 06/03/2020 05:26:38 HTTP/krisz-datalake-1-master0.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (des3-cbc-sha1)\n   1 06/03/2020 05:26:38 HTTP/krisz-datalake-1-master0.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (arcfour-hmac)\n   1 06/03/2020 05:26:38 rangeradmin/krisz-datalake-1-master0.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes256-cts-hmac-sha1-96)\n   1 06/03/2020 05:26:38 rangeradmin/krisz-datalake-1-master0.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes128-cts-hmac-sha1-96)\n   1 06/03/2020 05:26:38 rangeradmin/krisz-datalake-1-master0.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes256-cts-hmac-sha384-192)\n   1 06/03/2020 05:26:38 rangeradmin/krisz-datalake-1-master0.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes128-cts-hmac-sha256-128)\n   1 06/03/2020 05:26:38 rangeradmin/krisz-datalake-1-master0.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (des3-cbc-sha1)\n   1 06/03/2020 05:26:38 rangeradmin/krisz-datalake-1-master0.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (arcfour-hmac)\n\nData Hub with encryption aes256-cts. HDFS keytab\nKeytab name: FILE:/var/run/cloudera-scm-agent/process/1546334240-hdfs-NAMENODE/hdfs.keytab\nKVNO Timestamp           Principal\n---- ------------------- ------------------------------------------------------\n   1 06/03/2020 06:00:49 HTTP/krisz-de-1-master3.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes256-cts-hmac-sha1-96)\n   1 06/03/2020 06:00:49 HTTP/krisz-de-1-master3.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes128-cts-hmac-sha1-96)\n   1 06/03/2020 06:00:49 HTTP/krisz-de-1-master3.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes256-cts-hmac-sha384-192)\n   1 06/03/2020 06:00:49 HTTP/krisz-de-1-master3.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes128-cts-hmac-sha256-128)\n   1 06/03/2020 06:00:49 HTTP/krisz-de-1-master3.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (des3-cbc-sha1)\n   1 06/03/2020 06:00:49 HTTP/krisz-de-1-master3.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (arcfour-hmac)\n   1 06/03/2020 06:00:49 hdfs/krisz-de-1-master3.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes256-cts-hmac-sha1-96)\n   1 06/03/2020 06:00:49 hdfs/krisz-de-1-master3.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes128-cts-hmac-sha1-96)\n   1 06/03/2020 06:00:49 hdfs/krisz-de-1-master3.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes256-cts-hmac-sha384-192)\n   1 06/03/2020 06:00:49 hdfs/krisz-de-1-master3.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (aes128-cts-hmac-sha256-128)\n   1 06/03/2020 06:00:49 hdfs/krisz-de-1-master3.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (des3-cbc-sha1)\n   1 06/03/2020 06:00:49 hdfs/krisz-de-1-master3.wl.cloudera.site@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE (arcfour-hmac)\n\nIt seems that these keytabs use the same encryptions. Also tested HDFS access from Data Hub with env admin user and normal user. Env admin can access the cloud storage, but regular user cannot. Did the same with Hive where env admin user was able to create external table to S3\nCREATE EXTERNAL TABLE `inventory`(\n  `inv_item_sk` int,\n  `inv_warehouse_sk` int,\n  `inv_quantity_on_hand` int)\n  PARTITIONED BY (\n  `inv_date_sk` int) STORED AS ORC\n  LOCATION\n  's3a://cb-group/khorvath/tpcds_bin_partitioned2_orc_200.db/inventory';\n\nwhile normal user was not\nError: Error while compiling statement: FAILED: HiveAccessControlException Permission denied: user [jozsi] does not have [READ] privilege on [s3a://cb-group/khorvath/tpcds_bin_partitioned3_orc_200.db/inventory] (state=42000,code=40000)\n\nkinit khorvath seems to be using the aes256 encryption on Data Hub and Data Lake also!\n[10137] 1591166752.470884: Getting initial credentials for khorvath@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE\n[10137] 1591166752.470886: Sending unauthenticated request\n[10137] 1591166752.470887: Sending request (241 bytes) to KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE\n[10137] 1591166752.470888: Initiating TCP connection to stream 10.0.2.245:88\n[10137] 1591166752.470889: Sending TCP request to stream 10.0.2.245:88\n[10137] 1591166752.470890: Received answer (374 bytes) from stream 10.0.2.245:88\n[10137] 1591166752.470891: Terminating TCP connection to stream 10.0.2.245:88\n[10137] 1591166752.470892: Response was from master KDC\n[10137] 1591166752.470893: Received error from KDC: -1765328359/Additional pre-authentication required\n[10137] 1591166752.470896: Preauthenticating using KDC method data\n[10137] 1591166752.470897: Processing preauth types: PA-PK-AS-REQ (16), PA-PK-AS-REP_OLD (15), PA-PK-AS-REQ_OLD (14), PA-FX-FAST (136), PA-ETYPE-INFO2 (19), PA-PKINIT-KX (147), PA-ENC-TIMESTAMP (2), PA-FX-COOKIE (133)\n[10137] 1591166752.470898: Selected etype info: etype aes256-cts, salt \"RQj2zdMj1oQ9q6Am\", params \"\"\n[10137] 1591166752.470899: Received cookie: MIT\nPassword for khorvath@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE:\n[10137] 1591166756.964493: AS key obtained for encrypted timestamp: aes256-cts/82E8\n[10137] 1591166756.964495: Encrypted timestamp (for 1591166756.970367): plain 301AA011180F32303230303630333036343535365AA10502030ECE7F, encrypted 265CD66B9F98785EEF1BA05705D897F326A0913C21FD9C03EC0CDFFAEE0B5EE1B34EA8462E9199EA9A48362F1A075ABC8F543D9765B14447\n[10137] 1591166756.964496: Preauth module encrypted_timestamp (2) (real) returned: 0/Success\n[10137] 1591166756.964497: Produced preauth for next request: PA-FX-COOKIE (133), PA-ENC-TIMESTAMP (2)\n[10137] 1591166756.964498: Sending request (336 bytes) to KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE\n[10137] 1591166756.964499: Initiating TCP connection to stream 10.0.2.245:88\n[10137] 1591166756.964500: Sending TCP request to stream 10.0.2.245:88\n[10137] 1591166756.964501: Received answer (918 bytes) from stream 10.0.2.245:88\n[10137] 1591166756.964502: Terminating TCP connection to stream 10.0.2.245:88\n[10137] 1591166756.964503: Response was from master KDC\n[10137] 1591166756.964504: Processing preauth types: PA-ETYPE-INFO2 (19)\n[10137] 1591166756.964505: Selected etype info: etype aes256-cts, salt \"RQj2zdMj1oQ9q6Am\", params \"\"\n[10137] 1591166756.964506: Produced preauth for next request: (empty)\n[10137] 1591166756.964507: AS key determined by preauth: aes256-cts/82E8\n[10137] 1591166756.964508: Decrypted AS reply; session key is: aes256-cts/2C90\n[10137] 1591166756.964509: FAST negotiation: available\n[10137] 1591166756.964510: Initializing FILE:/tmp/krb5cc_888600023 with default princ khorvath@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE\n[10137] 1591166756.964511: Storing khorvath@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE -> krbtgt/KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE in FILE:/tmp/krb5cc_888600023\n[10137] 1591166756.964512: Storing config in FILE:/tmp/krb5cc_888600023 for krbtgt/KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE: fast_avail: yes\n[10137] 1591166756.964513: Storing khorvath@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE -> krb5_ccache_conf_data/fast_avail/krbtgt\\/KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE\\@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE@X-CACHECONF: in FILE:/tmp/krb5cc_888600023\n[10137] 1591166756.964514: Storing config in FILE:/tmp/krb5cc_888600023 for krbtgt/KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE: pa_type: 2\n[10137] 1591166756.964515: Storing khorvath@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE -> krb5_ccache_conf_data/pa_type/krbtgt\\/KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE\\@KRISZ-EN.XCU2-8Y8X.WL.CLOUDERA.SITE@X-CACHECONF: in FILE:/tmp/krb5cc_888600023", "author": "keyki", "createdAt": "2020-06-03T06:36:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4MjYzMA=="}], "type": "inlineReview"}]}