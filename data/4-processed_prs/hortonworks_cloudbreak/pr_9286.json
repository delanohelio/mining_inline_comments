{"pr_number": 9286, "pr_title": "Cb 9438 2", "pr_createdAt": "2020-10-26T13:11:56Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9286", "timeline": [{"oid": "35ea8e8e1f807d4aad6981609482ea9010fe8a0b", "url": "https://github.com/hortonworks/cloudbreak/commit/35ea8e8e1f807d4aad6981609482ea9010fe8a0b", "message": "CB-9438 Modify shared vpc support for SRE to enable it and QA team can start the rampup in their project. Now the subnet and network related info coming based on the shared account parameter.", "committedDate": "2020-10-26T13:35:58Z", "type": "commit"}, {"oid": "eb0f641d89155a5f59949dc5fcf0028480a42a77", "url": "https://github.com/hortonworks/cloudbreak/commit/eb0f641d89155a5f59949dc5fcf0028480a42a77", "message": "CB-9440 Creation of new GCP datahub clusters fail because of firewall tag limits in gcp-dev-cloudbreak. Changed the target tags for the type parameter and in this case we are able to only use 2 target tag on the firewall rules.", "committedDate": "2020-10-26T13:37:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwMzM5Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9286#discussion_r512003393", "bodyText": "Why should we query the subnetwor again from GCP's API?\nI assume it should be in the collect set as only the only content, shouldn't it?", "author": "biharitomi", "createdAt": "2020-10-26T14:29:43Z", "path": "cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpNetworkConnector.java", "diffHunk": "@@ -130,11 +132,23 @@ public void deleteNetworkWithSubnets(NetworkDeletionRequest networkDeletionReque\n     public NetworkCidr getNetworkCidr(Network network, CloudCredential credential) {\n         String subnetId = network.getStringParameter(GcpStackUtil.SUBNET_ID);\n         String region = network.getStringParameter(GcpStackUtil.REGION);\n+        String sharedProjectId = network.getStringParameter(GcpStackUtil.SHARED_PROJECT_ID);\n         LOGGER.debug(\"Getting network cidrs for subnet {} in region {}\", subnetId, region);\n         Compute compute = GcpStackUtil.buildCompute(credential);\n         String projectId = GcpStackUtil.getProjectId(credential);\n+        Subnetwork subnet = null;\n         try {\n-            String ipCidrRange = compute.subnetworks().get(projectId, region, subnetId).execute().getIpCidrRange();\n+            SubnetworkList ownProjectSubnets = compute.subnetworks().list(projectId, region).execute();\n+            Set<Subnetwork> collect = ownProjectSubnets.getItems()\n+                    .stream()\n+                    .filter(e -> e.getName().equals(subnetId))\n+                    .collect(Collectors.toSet());\n+            if (collect.isEmpty()) {\n+                subnet = compute.subnetworks().get(sharedProjectId, region, subnetId).execute();\n+            } else {\n+                subnet = compute.subnetworks().get(projectId, region, subnetId).execute();", "originalCommit": "eb0f641d89155a5f59949dc5fcf0028480a42a77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwNjYzOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9286#discussion_r512006639", "bodyText": "I think it's worth to check that the group.getSecurity() is not null here.", "author": "biharitomi", "createdAt": "2020-10-26T14:33:44Z", "path": "cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/group/GcpFirewallInResourceBuilder.java", "diffHunk": "@@ -60,8 +60,8 @@ public CloudResource build(GcpContext context, AuthenticatedContext auth, Group\n             throws Exception {\n         String projectId = context.getProjectId();\n \n-        ComputeRequest<Operation> firewallRequest = StringUtils.isNotBlank(security.getCloudSecurityId()) && isExistingNetwork(network)\n-                ? updateExistingFirewallForNewTargets(context, auth, group, security)\n+        ComputeRequest<Operation> firewallRequest = StringUtils.isNotBlank(group.getSecurity().getCloudSecurityId()) && isExistingNetwork(network)", "originalCommit": "eb0f641d89155a5f59949dc5fcf0028480a42a77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwODA4Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9286#discussion_r512008083", "bodyText": "Can we move the lambda expression into a separated method?", "author": "biharitomi", "createdAt": "2020-10-26T14:35:28Z", "path": "cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/group/GcpFirewallInResourceBuilder.java", "diffHunk": "@@ -74,25 +74,27 @@ public CloudResource build(GcpContext context, AuthenticatedContext auth, Group\n         }\n     }\n \n-    private Update updateExistingFirewallForNewTargets(GcpContext context, AuthenticatedContext auth, Group group, Security security)\n+    private Update updateExistingFirewallForNewTargets(GcpContext context, AuthenticatedContext auth, Group group)\n             throws java.io.IOException {\n-        Firewall firewall = context.getCompute().firewalls().get(context.getProjectId(), security.getCloudSecurityId()).execute();\n+        Firewall firewall = context.getCompute().firewalls().get(context.getProjectId(), group.getSecurity().getCloudSecurityId()).execute();\n+        String groupTypeTag = GcpStackUtil.getGroupTypeTag(group.getType());\n         if (firewall.getTargetTags() == null) {\n-            firewall.setTargetTags(Lists.newArrayListWithCapacity(1));\n+            firewall.setTargetTags(List.of(groupTypeTag));\n+        } else if (firewall.getTargetTags().stream().filter(e -> e.equals(groupTypeTag)).collect(Collectors.toSet()).isEmpty()) {", "originalCommit": "eb0f641d89155a5f59949dc5fcf0028480a42a77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxMDg0OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9286#discussion_r512010849", "bodyText": "Can we have a few unit tests for the replace logic?", "author": "biharitomi", "createdAt": "2020-10-26T14:38:55Z", "path": "cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/util/GcpStackUtil.java", "diffHunk": "@@ -416,6 +417,10 @@ public static String getGroupClusterTag(CloudContext cloudContext, Group group)\n         return group.getName().toLowerCase().replaceAll(\"[^A-Za-z0-9 ]\", \"\") + cloudContext.getId();\n     }\n \n+    public static String getGroupTypeTag(InstanceGroupType type) {\n+        return type.name().toLowerCase().replaceAll(\"[^A-Za-z0-9 ]\", \"\");", "originalCommit": "eb0f641d89155a5f59949dc5fcf0028480a42a77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b6c8717f337248f6b50bbeae4d0dba23e038cf20", "url": "https://github.com/hortonworks/cloudbreak/commit/b6c8717f337248f6b50bbeae4d0dba23e038cf20", "message": "CB-9440 Creation of new GCP datahub clusters fail because of firewall tag limits in gcp-dev-cloudbreak. Changed the target tags for the type parameter and in this case we are able to only use 2 target tag on the firewall rules.", "committedDate": "2020-10-26T15:02:54Z", "type": "forcePushed"}, {"oid": "2eac16b72c57aa66a691f55d41086e34ef02c363", "url": "https://github.com/hortonworks/cloudbreak/commit/2eac16b72c57aa66a691f55d41086e34ef02c363", "message": "CB-9440 Creation of new GCP datahub clusters fail because of firewall tag limits in gcp-dev-cloudbreak. Changed the target tags for the type parameter and in this case we are able to only use 2 target tag on the firewall rules.", "committedDate": "2020-10-26T15:05:05Z", "type": "forcePushed"}, {"oid": "8d934118878528abf07bb528217a865b0eebcfb1", "url": "https://github.com/hortonworks/cloudbreak/commit/8d934118878528abf07bb528217a865b0eebcfb1", "message": "CB-9440 Creation of new GCP datahub clusters fail because of firewall tag limits in gcp-dev-cloudbreak. Changed the target tags for the type parameter and in this case we are able to only use 2 target tag on the firewall rules.", "committedDate": "2020-10-26T15:21:52Z", "type": "commit"}, {"oid": "8d934118878528abf07bb528217a865b0eebcfb1", "url": "https://github.com/hortonworks/cloudbreak/commit/8d934118878528abf07bb528217a865b0eebcfb1", "message": "CB-9440 Creation of new GCP datahub clusters fail because of firewall tag limits in gcp-dev-cloudbreak. Changed the target tags for the type parameter and in this case we are able to only use 2 target tag on the firewall rules.", "committedDate": "2020-10-26T15:21:52Z", "type": "forcePushed"}]}