{"pr_number": 8649, "pr_title": "CB-8158-ForcedDownscale", "pr_createdAt": "2020-07-27T14:48:34Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8649", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk0ODYxMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8649#discussion_r460948611", "bodyText": "mandatoryDownScale Count will always be less than maxAllowedDownScale, but based on Yarn Workaround of passing downscaleNodeCount = clusterSize, forced downscaling should be limited to mandatoryDownScale.\nSo that hostGroup is not brought down to LoadAlertConfiguration:minNodeCount even though there is load on cluster.", "author": "smaniraju", "createdAt": "2020-07-27T14:51:02Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/monitor/evaluator/load/YarnResponseUtils.java", "diffHunk": "@@ -23,33 +21,15 @@\n \n     public List<String> getYarnRecommendedDecommissionHostsForHostGroup(String clusterCrn, YarnScalingServiceV1Response yarnResponse,\n             Map<String, String> hostFqdnsToInstanceId, int maxAllowedDownScale, Optional<Integer> mandatoryDownScaleCount) {", "originalCommit": "855dbbb6f0ade27f8c2a4aad63cbaa350bce3e93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk0OTI1NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8649#discussion_r460949255", "bodyText": "Based on YarnBased downscaling of downscale candidates = N (cluster size), this code has become dead block, so removing to avoid confusion.", "author": "smaniraju", "createdAt": "2020-07-27T14:51:50Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/monitor/evaluator/load/YarnResponseUtils.java", "diffHunk": "@@ -23,33 +21,15 @@\n \n     public List<String> getYarnRecommendedDecommissionHostsForHostGroup(String clusterCrn, YarnScalingServiceV1Response yarnResponse,\n             Map<String, String> hostFqdnsToInstanceId, int maxAllowedDownScale, Optional<Integer> mandatoryDownScaleCount) {\n-        Set<String> consideredNodeIds = new HashSet<>();\n-        Integer allowedDownscale = Math.max(maxAllowedDownScale, mandatoryDownScaleCount.orElse(0));\n+        Integer allowedDownscale = mandatoryDownScaleCount.orElse(maxAllowedDownScale);\n         List<String> decommissionNodes = yarnResponse.getScaleDownCandidates().orElse(List.of()).stream()\n                 .map(YarnScalingServiceV1Response.DecommissionCandidate::getNodeId)\n                 .map(nodeFqdn -> nodeFqdn.split(\":\")[0])\n                 .filter(s -> hostFqdnsToInstanceId.keySet().contains(s))\n                 .map(nodeFqdn -> hostFqdnsToInstanceId.get(nodeFqdn))\n                 .limit(allowedDownscale)\n-                .map(nodeId -> {\n-                    consideredNodeIds.add(nodeId);\n-                    return nodeId;\n-                })\n                 .collect(Collectors.toList());\n \n-        //HostGroup candidates if mandatoryDownScaleCount is not met based on yarnResponse.\n-        int forcedCandidatesCount = mandatoryDownScaleCount.orElse(0) - decommissionNodes.size();\n-        if (forcedCandidatesCount > 0) {\n-            List forcedCandidates = hostFqdnsToInstanceId.keySet().stream()\n-                    .filter(nodeId -> !consideredNodeIds.contains(nodeId))\n-                    .limit(forcedCandidatesCount).collect(Collectors.toList());\n-\n-            LOGGER.info(\"Forced downscaling candidates count '{}', candidates '{}' in cluster '{}' to achieve mandatory \" +\n-                            \"downscaletarget '{}'.\", forcedCandidates.size(), forcedCandidates, clusterCrn,\n-                    mandatoryDownScaleCount.orElse(0));\n-            decommissionNodes.addAll(forcedCandidates);\n-        }\n-", "originalCommit": "855dbbb6f0ade27f8c2a4aad63cbaa350bce3e93", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxNjE2OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8649#discussion_r461016168", "bodyText": "Looking at this independently, it would seem that if mandatoryDownscale is not present, we default to maxAllowedDownscale.\nThat isn't actually what happens with loadBased downscaling. If there's no mandatory downscale, the request to YARN would not have maxAllowedDownscale candidates. So reading this function independently can be quite confusing.\nI think it's worthwhile noting that \"yarnResponse\" passed to this function may or may not contain maxAllowedDownscale candidates.", "author": "sidseth", "createdAt": "2020-07-27T16:29:50Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/monitor/evaluator/load/YarnResponseUtils.java", "diffHunk": "@@ -23,33 +21,15 @@\n \n     public List<String> getYarnRecommendedDecommissionHostsForHostGroup(String clusterCrn, YarnScalingServiceV1Response yarnResponse,\n             Map<String, String> hostFqdnsToInstanceId, int maxAllowedDownScale, Optional<Integer> mandatoryDownScaleCount) {\n-        Set<String> consideredNodeIds = new HashSet<>();\n-        Integer allowedDownscale = Math.max(maxAllowedDownScale, mandatoryDownScaleCount.orElse(0));\n+        Integer allowedDownscale = mandatoryDownScaleCount.orElse(maxAllowedDownScale);", "originalCommit": "855dbbb6f0ade27f8c2a4aad63cbaa350bce3e93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxOTExNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8649#discussion_r461019117", "bodyText": "maxAllowedDownscale is always passed, even in loadBased downscaling without mandatory downscale that is within limit, maxAllowedDownScale is passed based on policy limit.", "author": "smaniraju", "createdAt": "2020-07-27T16:34:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxNjE2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAzNzczMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8649#discussion_r461037730", "bodyText": "Added comment regarding yarnResponse might not have maxAllowedDownscale candidates", "author": "smaniraju", "createdAt": "2020-07-27T17:04:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxNjE2OA=="}], "type": "inlineReview"}, {"oid": "77d715fa18a60f4f7901d229c42281bc7d15597b", "url": "https://github.com/hortonworks/cloudbreak/commit/77d715fa18a60f4f7901d229c42281bc7d15597b", "message": "CB-8158-ForcedDownscale\n\nForced Downscale should pass DOWNSCALE_FACTOR_IN_NODE_COUNT as QueryParam and not HeaderParam.\nForced Downscale should be limited to MandatoryDownscale NodeCount", "committedDate": "2020-07-27T16:59:38Z", "type": "commit"}, {"oid": "77d715fa18a60f4f7901d229c42281bc7d15597b", "url": "https://github.com/hortonworks/cloudbreak/commit/77d715fa18a60f4f7901d229c42281bc7d15597b", "message": "CB-8158-ForcedDownscale\n\nForced Downscale should pass DOWNSCALE_FACTOR_IN_NODE_COUNT as QueryParam and not HeaderParam.\nForced Downscale should be limited to MandatoryDownscale NodeCount", "committedDate": "2020-07-27T16:59:38Z", "type": "forcePushed"}]}