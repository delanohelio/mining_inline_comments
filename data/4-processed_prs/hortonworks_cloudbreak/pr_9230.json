{"pr_number": 9230, "pr_title": "CB-8403: Azure Postgres sql db through private endpoint", "pr_createdAt": "2020-10-16T09:16:47Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9230", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIxNjg5MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506216890", "bodyText": "what is the use of extending if you do not use \"parameters\" but \"properties\"?", "author": "pdarvasi", "createdAt": "2020-10-16T09:28:35Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudSubnet.java", "diffHunk": "@@ -1,15 +1,18 @@\n package com.sequenceiq.cloudbreak.cloud.model;\n \n import java.io.Serializable;\n+import java.util.HashMap;\n+import java.util.Map;\n import java.util.Objects;\n \n import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.sequenceiq.cloudbreak.cloud.model.generic.DynamicModel;\n import com.sequenceiq.cloudbreak.cloud.model.network.SubnetType;\n \n @JsonInclude(JsonInclude.Include.NON_NULL)\n @JsonIgnoreProperties(ignoreUnknown = true)\n-public class CloudSubnet implements Serializable {\n+public class CloudSubnet extends DynamicModel implements Serializable {", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI4MDQ0Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506280442", "bodyText": "The parameters are used, not the properties ... I started to add properties when I realized that there is the DynamicModel and that would be a better solution ...", "author": "gergopapi2", "createdAt": "2020-10-16T10:42:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIxNjg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI4MDU4Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506280582", "bodyText": "So I delete properties, thanks!", "author": "gergopapi2", "createdAt": "2020-10-16T10:42:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIxNjg5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIxNzQxNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506217417", "bodyText": "this could be final", "author": "pdarvasi", "createdAt": "2020-10-16T09:29:20Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudSubnet.java", "diffHunk": "@@ -27,6 +30,8 @@\n \n     private boolean igwAvailable;\n \n+    private Map<String, String> properties = new HashMap<>();", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyMjI5MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506222290", "bodyText": "This \"Disabled\" value could be the value of the constant in this class, therefore eliminating 1 magic string", "author": "pdarvasi", "createdAt": "2020-10-16T09:35:52Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureCloudSubnetParametersService.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.sequenceiq.cloudbreak.cloud.azure;\n+\n+import java.util.Optional;\n+\n+import org.springframework.stereotype.Service;\n+\n+import com.sequenceiq.cloudbreak.cloud.model.CloudSubnet;\n+\n+@Service\n+public class AzureCloudSubnetParametersService {\n+\n+    public static final String PRIVATE_ENDPOINT_NETWORK_POLICIES = \"privateEndpointNetworkPolicies\";\n+\n+    private static final String ENABLED = \"enabled\";\n+\n+    private static final String DISABLED = \"disabled\";\n+\n+    public void addPrivateEndpointNetworkPolicies(CloudSubnet cloudSubnet, String state) {\n+        cloudSubnet.putParameter(PRIVATE_ENDPOINT_NETWORK_POLICIES, \"Disabled\".equalsIgnoreCase(state) ? DISABLED : ENABLED);", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI4MTM5Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506281397", "bodyText": "I wanted to decouple what Azure sends back from our internal representation, that's why I did not merge the two.", "author": "gergopapi2", "createdAt": "2020-10-16T10:43:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyMjI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI4MTgyNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506281824", "bodyText": "I could add it as another constant to make it clear that this is the string we expect from Azure.", "author": "gergopapi2", "createdAt": "2020-10-16T10:44:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyMjI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU2NjY3MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506566671", "bodyText": "I am saying that the internal representation can be the same as the Azure value, it has no disadvantage in this case", "author": "pdarvasi", "createdAt": "2020-10-16T15:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyMjI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYxNzk0MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506617941", "bodyText": "Only thing that it is persisted in env service. If azure representation changes then it would be enough to decouple internal representation from the azure one but doing it now does not do any harm in my opinion, it helps future devs.", "author": "gergopapi2", "createdAt": "2020-10-16T17:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyMjI5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyODE4Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506228183", "bodyText": "an additional log line would be nice", "author": "pdarvasi", "createdAt": "2020-10-16T09:41:37Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzurePlatformResources.java", "diffHunk": "@@ -137,7 +140,9 @@ private void addToResultIfRegionsAreMatch(Region region, Map<String, Set<CloudNe\n     private CloudNetwork convertToCloudNetwork(Network network) {\n         Set<CloudSubnet> subnets = new HashSet<>();\n         for (Entry<String, Subnet> subnet : network.subnets().entrySet()) {\n-            subnets.add(new CloudSubnet(subnet.getKey(), subnet.getKey(), null, subnet.getValue().addressPrefix()));\n+            CloudSubnet cloudSubnet = new CloudSubnet(subnet.getKey(), subnet.getKey(), null, subnet.getValue().addressPrefix());\n+            azureCloudSubnetParametersService.addPrivateEndpointNetworkPolicies(cloudSubnet, subnet.getValue().inner().privateEndpointNetworkPolicies());", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjY4MzQ2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506683460", "bodyText": "Added a line that logs CloudSubnet after it was filled with data.", "author": "gergopapi2", "createdAt": "2020-10-16T19:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIyODE4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIzMDE1MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506230151", "bodyText": "do we want to use this ever?", "author": "pdarvasi", "createdAt": "2020-10-16T09:43:44Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureUtils.java", "diffHunk": "@@ -423,9 +423,34 @@ public void deleteImages(AzureClient azureClient, Collection<String> imageIds) {\n         }\n     }\n \n+    @Retryable(backoff = @Backoff(delay = 1000, multiplier = 2, maxDelay = 10000), maxAttempts = 5)\n+    public void deleteGenericResources(AzureClient azureClient, Collection<String> genericResourceIds) {\n+        LOGGER.info(\"Delete generic resources: {}\", genericResourceIds);\n+        List<Completable> deleteCompletables = new ArrayList<>();\n+        List<String> failedToDeleteGenericResources = new ArrayList<>();\n+        for (String resourceId : genericResourceIds) {\n+            deleteCompletables.add(azureClient.deleteGenericResourceByIdAsync(resourceId)\n+                    .doOnError(throwable -> {\n+                        LOGGER.error(\"Error happened on azure during generic delete: {}\", resourceId, throwable);\n+                        failedToDeleteGenericResources.add(resourceId);\n+                    })\n+                    .subscribeOn(Schedulers.io()));\n+        }\n+        Completable.mergeDelayError(deleteCompletables).await();\n+        if (!failedToDeleteGenericResources.isEmpty()) {\n+            LOGGER.error(\"Can't delete every resource: {}\", failedToDeleteGenericResources);\n+            throw new CloudbreakServiceException(\"Can't delete every generic resource: \" + failedToDeleteGenericResources);\n+        }\n+    }\n+\n     @Retryable(backoff = @Backoff(delay = 1000, multiplier = 2, maxDelay = 10000), maxAttempts = 5)\n     public Optional<String> deleteDatabaseServer(AzureClient azureClient, String databaseServerId, boolean cancelException) {\n-        return handleDeleteErrors(azureClient::deleteDatabaseServer, \"DatabaseServer\", databaseServerId, cancelException);\n+        return handleDeleteErrors(azureClient::deleteGenericResourceById, \"DatabaseServer\", databaseServerId, cancelException);\n+    }\n+\n+    @Retryable(backoff = @Backoff(delay = 1000, multiplier = 2, maxDelay = 10000), maxAttempts = 5)\n+    public Optional<String> deletePrivateDnsZone(AzureClient azureClient, String privateDnsZoneId, boolean cancelException) {", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM2MjgxNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506362814", "bodyText": "You are right, it is better to bury it well.", "author": "gergopapi2", "createdAt": "2020-10-16T12:27:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIzMDE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI0NDAwMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506244000", "bodyText": "does this delete dns zone groups, too?", "author": "pdarvasi", "createdAt": "2020-10-16T09:58:40Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/connector/resource/AzureDatabaseResourceService.java", "diffHunk": "@@ -150,24 +155,34 @@\n                 .build(), ResourceStatus.DELETED));\n     }\n \n-    private List<CloudResourceStatus> deleteDatabaseServer(List<CloudResource> resources, CloudContext cloudContext, boolean force,\n+    private List<CloudResourceStatus> deleteResources(List<CloudResource> resources, CloudContext cloudContext, boolean force,\n             AzureClient client, PersistenceNotifier persistenceNotifier) {\n-        LOGGER.debug(\"Deleting database server\");\n-        Optional<CloudResource> dbServerResourceOptional = resources.stream().filter(r -> AZURE_DATABASE.equals(r.getType())).findFirst();\n-        if (dbServerResourceOptional.isEmpty()) {\n-            LOGGER.warn(\"Azure database id not found in database, deleting nothing\");\n-            return List.of();\n-        }\n-        String databaseServerId = dbServerResourceOptional.get().getReference();\n-        Optional<String> errorMessage = azureUtils.deleteDatabaseServer(client, databaseServerId, force);\n-        if (errorMessage.isEmpty()) {\n-            deleteResources(resources, cloudContext, persistenceNotifier);\n-        }\n \n-        return Lists.newArrayList(new CloudResourceStatus(CloudResource.builder()\n+        // TODO simplify after final form of template is reached\n+\n+        List<CloudResource> azureGenericResources = findResources(resources, List.of(AZURE_PRIVATE_ENDPOINT));\n+        LOGGER.debug(\"Deleting dns zone groups and azure private endpoints {}\", azureGenericResources);", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI1MTEzNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506251137", "bodyText": "maybe it is worth adding: ...because of the network policy being enabled", "author": "pdarvasi", "createdAt": "2020-10-16T10:04:39Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/subnet/selector/AzureSubnetSelectorService.java", "diffHunk": "@@ -36,4 +44,18 @@ public SubnetSelectionResult select(Collection<CloudSubnet> subnetMetas, SubnetS\n         }\n         return Optional.empty();\n     }\n+\n+    public SubnetSelectionResult selectForPrivateEndpoint(Collection<CloudSubnet> subnetMetas, boolean existingNetwork) {\n+        List<CloudSubnet> suitableCloudSubnet;\n+        if (existingNetwork) {\n+            suitableCloudSubnet = subnetMetas.stream()\n+                    .filter(sn -> azureCloudSubnetParametersService.isPrivateEndpointNetworkPoliciesDisabled(sn))\n+                    .collect(Collectors.toList());\n+        } else {\n+            suitableCloudSubnet = new ArrayList<>(subnetMetas);\n+        }\n+        return suitableCloudSubnet.isEmpty() ?\n+                new SubnetSelectionResult(\"No suitable subnets found for placing a private endpoint\") :", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI1Mjc4Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506252787", "bodyText": "pls add new field to equals", "author": "pdarvasi", "createdAt": "2020-10-16T10:06:56Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/CloudSubnet.java", "diffHunk": "@@ -1,15 +1,18 @@\n package com.sequenceiq.cloudbreak.cloud.model;\n \n import java.io.Serializable;\n+import java.util.HashMap;\n+import java.util.Map;\n import java.util.Objects;\n \n import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.sequenceiq.cloudbreak.cloud.model.generic.DynamicModel;\n import com.sequenceiq.cloudbreak.cloud.model.network.SubnetType;\n \n @JsonInclude(JsonInclude.Include.NON_NULL)\n @JsonIgnoreProperties(ignoreUnknown = true)\n-public class CloudSubnet implements Serializable {\n+public class CloudSubnet extends DynamicModel implements Serializable {", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI1NDU0Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506254542", "bodyText": "does --> is", "author": "pdarvasi", "createdAt": "2020-10-16T10:09:43Z", "path": "cloud-gcp/src/main/java/com/sequenceiq/cloudbreak/cloud/gcp/GcpResourceConnector.java", "diffHunk": "@@ -60,8 +60,8 @@ public String getStackTemplate() throws TemplatingDoesNotSupportedException {\n     }\n \n     @Override\n-    public String getDBStackTemplate() {\n-        return  \"\";\n+    public String getDBStackTemplate() throws TemplatingDoesNotSupportedException {", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM3MTk2MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506371961", "bodyText": "renamed to TemplatingNotSupportedException", "author": "gergopapi2", "createdAt": "2020-10-16T12:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI1NDU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI1NTI0Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506255242", "bodyText": "we have UnsupportedOperationException, too", "author": "pdarvasi", "createdAt": "2020-10-16T10:10:51Z", "path": "cloud-openstack/src/main/java/com/sequenceiq/cloudbreak/cloud/openstack/heat/OpenStackHeatNetworkConnector.java", "diffHunk": "@@ -52,6 +52,11 @@ public void createProviderSpecificNetworkResources(NetworkResourcesCreationReque\n         throw new OpenStackResourceException(\"CDP does not support Openstack.\");\n     }\n \n+    @Override\n+    public SubnetSelectionResult chooseSubnetsForPrivateEndpoint(Collection<CloudSubnet> subnetMetas, boolean existingNetwork) {\n+        throw new OpenStackResourceException(\"CDP does not support Openstack.\");", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM3MzQ4Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506373486", "bodyText": "Yes, but since other methods do use that exception, I do not want to change the others.", "author": "gergopapi2", "createdAt": "2020-10-16T12:43:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI1NTI0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI1NTg1Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506255853", "bodyText": "shouldn't we map this to AWS private endpoints, too?", "author": "pdarvasi", "createdAt": "2020-10-16T10:11:52Z", "path": "common-model/src/main/java/com/sequenceiq/common/model/EndpointType.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package com.sequenceiq.common.model;\n+\n+public enum EndpointType {\n+    /*\n+    AWS:    do not use private endpoints\n+    AZURE:  invalid\n+     */\n+    NONE,\n+\n+    /*\n+    AWS:    use private endpoints\n+    AZURE:  use service endpoints\n+     */\n+    USE_SERVICE_ENDPOINT,\n+\n+    /*\n+    AWS:    invalid", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcwMjI2Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506702263", "bodyText": "I would not do it within the scope of this PR, I think this needs more thinking, together with validation for ServiceEndpointCreation. I will disable validation for ServiceEndpointCreation as well.", "author": "gergopapi2", "createdAt": "2020-10-16T20:19:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI1NTg1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI2MzcwMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506263700", "bodyText": "pls. add a log line", "author": "pdarvasi", "createdAt": "2020-10-16T10:22:30Z", "path": "redbeams/src/main/java/com/sequenceiq/redbeams/service/network/SubnetChooserService.java", "diffHunk": "@@ -40,4 +41,10 @@\n         }\n         return subnetSelectionResult.getResult();\n     }\n+\n+    public List<CloudSubnet> chooseSubnetForPrivateEndpoint(Collection<CloudSubnet> subnetMetas, DBStack dbStack, boolean existingNetwork) {\n+        NetworkConnector networkConnector = cloudPlatformConnectors.get(new CloudPlatformVariant(dbStack.getCloudPlatform(), dbStack.getPlatformVariant()))\n+                .networkConnector();\n+        return networkConnector.chooseSubnetsForPrivateEndpoint(subnetMetas, existingNetwork).getResult();", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcwNDQwNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506704406", "bodyText": "Added a log line that lists all subnets suitable for private endpoint.", "author": "gergopapi2", "createdAt": "2020-10-16T20:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI2MzcwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI2ODg4OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506268888", "bodyText": "if is handled if the return value is  \"null\"?", "author": "pdarvasi", "createdAt": "2020-10-16T10:28:17Z", "path": "redbeams/src/main/java/com/sequenceiq/redbeams/service/network/NetworkParameterAdder.java", "diffHunk": "@@ -74,4 +94,14 @@\n         }\n         return parameters;\n     }\n+\n+    private String getAzureSubnetToUseWithPrivateEndpoint(DetailedEnvironmentResponse detailedEnvironmentResponse, DBStack dbStack) {\n+        String subscriptionId = subnetListerService.getAzureSubscriptionId(detailedEnvironmentResponse.getCrn());\n+        return subnetChooserService.chooseSubnetForPrivateEndpoint(\n+                detailedEnvironmentResponse.getNetwork().getSubnetMetas().values(), dbStack, detailedEnvironmentResponse.getNetwork().isExistingNetwork())\n+                .stream()\n+                .findFirst()\n+                .map(csn -> subnetListerService.expandAzureResourceId(csn, detailedEnvironmentResponse, subscriptionId))\n+                .map(sn -> sn.getId()).orElse(null);", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM3NTU4Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506375587", "bodyText": "So if no private endpoint is requested, then it is not used.\nBut if the subnet was changed after environment registration but before the postgres was started, then it gives an error. So a validation is needed for that, true.", "author": "gergopapi2", "createdAt": "2020-10-16T12:46:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI2ODg4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQxMjI5Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506412296", "bodyText": "I rearranged it: value is only added if private endpoint is requested. And if in that case no network is found, then an exception is thrown. This is the case when between env registration and database creation the network policies have been changed on the network. Thanks for spotting it.", "author": "gergopapi2", "createdAt": "2020-10-16T13:22:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI2ODg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM5MzIzNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506393237", "bodyText": "accidental tabulator here", "author": "attilapalfi92", "createdAt": "2020-10-16T13:06:26Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/connector/resource/AzureDatabaseResourceService.java", "diffHunk": "@@ -81,7 +86,7 @@\n         Deployment deployment;\n         try {\n             String parametersMapAsString = new Json(Map.of()).getValue();\n-            client.createTemplateDeployment(resourceGroupName, stackName, template, parametersMapAsString);\n+                client.createTemplateDeployment(resourceGroupName, stackName, template, parametersMapAsString);", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQxMjg2OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506412869", "bodyText": "Thanks, changed.", "author": "gergopapi2", "createdAt": "2020-10-16T13:22:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM5MzIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM5NDcwNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506394704", "bodyText": "can you rename r to cloudResource? Not a big thing but helps reading it.", "author": "attilapalfi92", "createdAt": "2020-10-16T13:07:41Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/connector/resource/AzureDatabaseResourceService.java", "diffHunk": "@@ -150,24 +155,34 @@\n                 .build(), ResourceStatus.DELETED));\n     }\n \n-    private List<CloudResourceStatus> deleteDatabaseServer(List<CloudResource> resources, CloudContext cloudContext, boolean force,\n+    private List<CloudResourceStatus> deleteResources(List<CloudResource> resources, CloudContext cloudContext, boolean force,\n             AzureClient client, PersistenceNotifier persistenceNotifier) {\n-        LOGGER.debug(\"Deleting database server\");\n-        Optional<CloudResource> dbServerResourceOptional = resources.stream().filter(r -> AZURE_DATABASE.equals(r.getType())).findFirst();\n-        if (dbServerResourceOptional.isEmpty()) {\n-            LOGGER.warn(\"Azure database id not found in database, deleting nothing\");\n-            return List.of();\n-        }\n-        String databaseServerId = dbServerResourceOptional.get().getReference();\n-        Optional<String> errorMessage = azureUtils.deleteDatabaseServer(client, databaseServerId, force);\n-        if (errorMessage.isEmpty()) {\n-            deleteResources(resources, cloudContext, persistenceNotifier);\n-        }\n \n-        return Lists.newArrayList(new CloudResourceStatus(CloudResource.builder()\n+        // TODO simplify after final form of template is reached\n+\n+        List<CloudResource> azureGenericResources = findResources(resources, List.of(AZURE_PRIVATE_ENDPOINT));\n+        LOGGER.debug(\"Deleting dns zone groups and azure private endpoints {}\", azureGenericResources);\n+        azureUtils.deleteGenericResources(client, azureGenericResources.stream().map(CloudResource::getReference).collect(Collectors.toList()));\n+        azureGenericResources.forEach(cr -> persistenceNotifier.notifyDeletion(cr, cloudContext));\n+\n+        return findResources(resources, List.of(AZURE_DATABASE)).stream()\n+                .map(r -> deleteDatabaseServerAndNotify(r, cloudContext, client, persistenceNotifier, force))\n+                .collect(Collectors.toList());\n+    }\n+\n+    private CloudResourceStatus deleteDatabaseServerAndNotify(\n+            CloudResource r, CloudContext cloudContext, AzureClient client, PersistenceNotifier persistenceNotifier, boolean force) {", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQxMzY5Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506413692", "bodyText": "done", "author": "gergopapi2", "createdAt": "2020-10-16T13:23:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM5NDcwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM5NjA2NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506396065", "bodyText": "A log line here would be nice I think", "author": "attilapalfi92", "createdAt": "2020-10-16T13:08:52Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/subnet/selector/AzureSubnetSelectorService.java", "diffHunk": "@@ -36,4 +44,18 @@ public SubnetSelectionResult select(Collection<CloudSubnet> subnetMetas, SubnetS\n         }\n         return Optional.empty();\n     }\n+\n+    public SubnetSelectionResult selectForPrivateEndpoint(Collection<CloudSubnet> subnetMetas, boolean existingNetwork) {\n+        List<CloudSubnet> suitableCloudSubnet;\n+        if (existingNetwork) {\n+            suitableCloudSubnet = subnetMetas.stream()", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcxMTg2Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506711867", "bodyText": "I added a log line to show network registration type (existing / new). Result of selection is now logged in SubnetChooserService.", "author": "gergopapi2", "createdAt": "2020-10-16T20:43:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM5NjA2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM5OTkxOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506399919", "bodyText": "What happened to these?", "author": "attilapalfi92", "createdAt": "2020-10-16T13:11:59Z", "path": "cloud-azure/src/main/java/com/sequenceiq/cloudbreak/cloud/azure/AzureTemplateBuilder.java", "diffHunk": "@@ -43,23 +37,9 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(AzureTemplateBuilder.class);\n \n-    private static final String GENERAL_PURPOSE = \"GeneralPurpose\";\n-\n-    private static final String MEMORY_OPTIMIZED = \"MemoryOptimized\";\n-\n-    private static final Set<String> GENERAL_PURPOSE_INSTANCE_TYPES = Set.of(\"GP_Gen5_2\", \"GP_Gen5_4\", \"GP_Gen5_8\", \"GP_Gen5_16\", \"GP_Gen5_32\");", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcxMjk1NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506712954", "bodyText": "Those were extracted to AzureDatabaseTemplateBuilder, they were only used by database.", "author": "gergopapi2", "createdAt": "2020-10-16T20:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM5OTkxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQwNTUxMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9230#discussion_r506405513", "bodyText": "good amount of tests", "author": "attilapalfi92", "createdAt": "2020-10-16T13:16:58Z", "path": "environment/src/test/java/com/sequenceiq/environment/environment/validation/network/AzureEnvironmentNetworkValidatorTest.java", "diffHunk": "@@ -46,6 +57,106 @@ void testValidateDuringFlowWhenTheNetworkIsNull() {\n         assertTrue(validationResultBuilder.build().hasError());\n     }\n \n+    @Test", "originalCommit": "688cf9660f17ce8217776e67090ea47bdd108fcc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e9b2967bf67cad4a9dd3afdad310f17f9c85a701", "url": "https://github.com/hortonworks/cloudbreak/commit/e9b2967bf67cad4a9dd3afdad310f17f9c85a701", "message": "CB-8403: Azure Postgres sql db through private endpoint\n\nPostgreSql for datalake and datahubs can currently be reached over service endpoints on azure: it uses a public IP-address for the DB server. A new azure feature, private endpoints would achieve a connection between a subnet and a postgres via a private IP-address, giving higher security for the database. Here we implemented the private endpoint for one subnet in the environment - since every subnet can be reached from every other this means that the postgres is reachable from all subnets.\n\nOnly a subnet is usable that has private endpoint network policies turned off - e.g. network security groups cannot be attached to that subnet. An environment with existing network is expected to have at least one such subnet. For a new network all subnets will come with it turned off.\n\nThis feature requires a privateDnsZone deployed into the same RG where the postgres will also be deployed.\n\nThe customer will be able to choose whether to use the private endpoint or remain with the service endpoint.", "committedDate": "2020-10-18T19:42:56Z", "type": "commit"}, {"oid": "e9b2967bf67cad4a9dd3afdad310f17f9c85a701", "url": "https://github.com/hortonworks/cloudbreak/commit/e9b2967bf67cad4a9dd3afdad310f17f9c85a701", "message": "CB-8403: Azure Postgres sql db through private endpoint\n\nPostgreSql for datalake and datahubs can currently be reached over service endpoints on azure: it uses a public IP-address for the DB server. A new azure feature, private endpoints would achieve a connection between a subnet and a postgres via a private IP-address, giving higher security for the database. Here we implemented the private endpoint for one subnet in the environment - since every subnet can be reached from every other this means that the postgres is reachable from all subnets.\n\nOnly a subnet is usable that has private endpoint network policies turned off - e.g. network security groups cannot be attached to that subnet. An environment with existing network is expected to have at least one such subnet. For a new network all subnets will come with it turned off.\n\nThis feature requires a privateDnsZone deployed into the same RG where the postgres will also be deployed.\n\nThe customer will be able to choose whether to use the private endpoint or remain with the service endpoint.", "committedDate": "2020-10-18T19:42:56Z", "type": "forcePushed"}]}