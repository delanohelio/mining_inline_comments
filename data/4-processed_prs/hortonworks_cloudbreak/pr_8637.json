{"pr_number": 8637, "pr_title": "CB-8135 configure paywall credentials to CM yum repo file", "pr_createdAt": "2020-07-24T16:17:39Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8637", "timeline": [{"oid": "4e1864c2ad6905b22586fc953bf7a39155d535b6", "url": "https://github.com/hortonworks/cloudbreak/commit/4e1864c2ad6905b22586fc953bf7a39155d535b6", "message": "CB-8135 configure paywall credentials to CM yum repo file\nWhenever a cluster is installed from https://archive.cloudera.com\na basic credential must be provided. This credential can be generated\nfrom the CM license file that is provided by UMS. The test credential\ncan be used to authenticate to this paywall however, in production\neach customer gets its own license file. The username is the uuid field\nand the password is generated from sha256(name + uuid) and the first 12\ncharacters.", "committedDate": "2020-07-24T17:08:33Z", "type": "forcePushed"}, {"oid": "a84b423fae1dc1f960a4b6cddef20df9ad967338", "url": "https://github.com/hortonworks/cloudbreak/commit/a84b423fae1dc1f960a4b6cddef20df9ad967338", "message": "CB-8135 configure paywall credentials to CM yum repo file\nWhenever a cluster is installed from https://archive.cloudera.com\na basic credential must be provided. This credential can be generated\nfrom the CM license file that is provided by UMS. The test credential\ncan be used to authenticate to this paywall however, in production\neach customer gets its own license file. The username is the uuid field\nand the password is generated from sha256(name + uuid) and the first 12\ncharacters.", "committedDate": "2020-07-26T17:36:06Z", "type": "commit"}, {"oid": "a84b423fae1dc1f960a4b6cddef20df9ad967338", "url": "https://github.com/hortonworks/cloudbreak/commit/a84b423fae1dc1f960a4b6cddef20df9ad967338", "message": "CB-8135 configure paywall credentials to CM yum repo file\nWhenever a cluster is installed from https://archive.cloudera.com\na basic credential must be provided. This credential can be generated\nfrom the CM license file that is provided by UMS. The test credential\ncan be used to authenticate to this paywall however, in production\neach customer gets its own license file. The username is the uuid field\nand the password is generated from sha256(name + uuid) and the first 12\ncharacters.", "committedDate": "2020-07-26T17:36:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY4NDk3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8637#discussion_r460684972", "bodyText": "just mentioning, don't have to replace: StringUtils#isNoneEmpty could work also", "author": "lacikaaa", "createdAt": "2020-07-27T07:02:48Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/core/bootstrap/service/host/ClusterHostServiceRunner.java", "diffHunk": "@@ -414,32 +419,61 @@ private void decoratePillarWithClouderaManagerAutoTls(Cluster cluster, Map<Strin\n         }\n     }\n \n-    private void decoratePillarWithClouderaManagerLicense(Long stackId, Map<String, SaltPillarProperties> servicePillar) {\n+    private Optional<String> decoratePillarWithClouderaManagerLicense(Long stackId, Map<String, SaltPillarProperties> servicePillar) {\n         String userCrn = stackService.get(stackId).getCreator().getUserCrn();\n-\n         Account account = umsClient.getAccountDetails(userCrn, Crn.safeFromString(userCrn).getAccountId(), Optional.empty());\n-\n-        if (StringUtils.isNotEmpty(account.getClouderaManagerLicenseKey())) {\n-            LOGGER.debug(\"Got license key from UMS: {}\", account.getClouderaManagerLicenseKey());\n+        Optional<String> licenseOpt = Optional.ofNullable(account.getClouderaManagerLicenseKey());\n+        if (licenseOpt.isPresent() && isNotEmpty(licenseOpt.get())) {\n+            String license = licenseOpt.get();\n+            LOGGER.debug(\"Got license key from UMS: {}\", license);\n             servicePillar.put(\"cloudera-manager-license\",\n                     new SaltPillarProperties(\"/cloudera-manager/license.sls\",\n                             singletonMap(\"cloudera-manager\",\n-                                    singletonMap(\"license\", account.getClouderaManagerLicenseKey()))));\n+                                    singletonMap(\"license\", license))));\n         }\n+        return licenseOpt;\n     }\n \n-    private void decoratePillarWithClouderaManagerRepo(Long stackId, Long clusterId, Map<String, SaltPillarProperties> servicePillar)\n+    @VisibleForTesting\n+    void decoratePillarWithClouderaManagerRepo(Long clusterId, Map<String, SaltPillarProperties> servicePillar, Optional<String> license)\n             throws CloudbreakOrchestratorFailedException {\n-\n         ClouderaManagerRepo clouderaManagerRepo = clusterComponentConfigProvider.getClouderaManagerRepoDetails(clusterId);\n-\n         if (clouderaManagerRepo == null) {\n             throw new CloudbreakOrchestratorFailedException(\"Cloudera Manager repository details are missing.\");\n         }\n-\n         servicePillar.put(\"cloudera-manager-repo\", new SaltPillarProperties(\"/cloudera-manager/repo.sls\",\n-                singletonMap(\"cloudera-manager\", singletonMap(\"repo\", clouderaManagerRepo))));\n+                singletonMap(\"cloudera-manager\", createCMRepoPillar(clouderaManagerRepo, license))));\n+\n+    }\n \n+    private Map<String, Object> createCMRepoPillar(ClouderaManagerRepo clouderaManagerRepo, Optional<String> license) {\n+        Map<String, Object> pillarValues = new HashMap<>();\n+        pillarValues.put(\"repo\", clouderaManagerRepo);\n+        parseLicense(license).ifPresent(jsonLicense -> {\n+            String username = jsonLicense.getPaywallUsername();\n+            String password = jsonLicense.getPaywallPassword();\n+            if (isNotEmpty(username) && isNotEmpty(password)) {", "originalCommit": "a84b423fae1dc1f960a4b6cddef20df9ad967338", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}