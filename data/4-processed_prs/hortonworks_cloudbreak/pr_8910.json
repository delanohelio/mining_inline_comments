{"pr_number": 8910, "pr_title": "CB-8617 if the gw node has a valid hostname (called userfacingfqdn) t\u2026", "pr_createdAt": "2020-09-02T12:59:16Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8910", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA3OTA3NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8910#discussion_r482079074", "bodyText": "I think we can omit this one as start_server already contains it, no reason to duplicate the same setting", "author": "lacikaaa", "createdAt": "2020-09-02T13:43:34Z", "path": "orchestrator-salt/src/main/resources/salt/salt/cloudera/manager/start.sls", "diffHunk": "@@ -8,6 +9,27 @@ init-cloudera-manager-db:\n         - user: {{ cloudera_manager.cloudera_manager_database.connectionUserName }}\n         - pass: {{ cloudera_manager.cloudera_manager_database.connectionPassword }}\n \n+# We need to restart the CM if the fromtend URL has been changed\n+{% if salt['pillar.get']('gateway:userfacingfqdn') is defined and salt['pillar.get']('gateway:userfacingfqdn')|length > 1 %}\n+update_frontend_url_of_cm:\n+  file.replace:\n+      - name: /etc/cloudera-scm-server/cm.settings\n+      - pattern: 'setsettings FRONTEND_URL.*'\n+      - repl: 'setsettings FRONTEND_URL https://{{ salt['pillar.get']('gateway:userfacingfqdn') }}/'\n+      - unless: grep \"^setsettings FRONTEND_URL https://{{ salt['pillar.get']('gateway:userfacingfqdn') }}/$\" /etc/cloudera-scm-server/cm.settings\n+\n+restart_cm_after_fronted_url_change:\n+  service.running:\n+    - name: cloudera-scm-server\n+    - enable: True", "originalCommit": "7d95c51c71c0a2dcbeec5294d0f3be2304d41a23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA5ODY4Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8910#discussion_r482098686", "bodyText": "ok", "author": "akanto", "createdAt": "2020-09-02T14:09:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA3OTA3NA=="}], "type": "inlineReview"}, {"oid": "56351ac7d7535b1b1651841fec7ebd9ca308b8d8", "url": "https://github.com/hortonworks/cloudbreak/commit/56351ac7d7535b1b1651841fec7ebd9ca308b8d8", "message": "CB-8617 if the gw node has a valid hostname (called userfacingfqdn) then CB is trying configure and restart CM on every node where knox is present. This issue has been caused by CB-7917 Certificate renewal should be able to change the generated self-signed certificates to valid ones\n\nThis commits fixes the described problem with a simple refactor, that ensures:\n- CM is not started/restarted multiple times since all CM start command are after each other with properly defined watch conditions\n- CM reconfiguration should happen only when the certificate has changed and only on CM node\n- CM configuration is done only on those nodes where knox is present\n\nCode can be improved further by ensuring that the \"knox\" role is always appended to the node which contains knox instances, that improvemnt is not part of this commit, but I have added a comment message into the top.sls file to remind ourselves.", "committedDate": "2020-09-02T14:08:09Z", "type": "forcePushed"}, {"oid": "f8ced96accbc4079bb230f3bf53fa57a993369dd", "url": "https://github.com/hortonworks/cloudbreak/commit/f8ced96accbc4079bb230f3bf53fa57a993369dd", "message": "CB-8617 if the gw node has a valid hostname (called userfacingfqdn) then CB is trying configure and restart CM on every node where knox is present. This issue has been caused by CB-7917 Certificate renewal should be able to change the generated self-signed certificates to valid ones\n\nThis commits fixes the described problem with a simple refactor, that ensures:\n- CM is not started/restarted multiple times since all CM start command are after each other with properly defined watch conditions\n- CM reconfiguration should happen only when the certificate has changed and only on CM node\n- CM configuration is done only on those nodes where knox is present\n\nCode can be improved further by ensuring that the \"knox\" role is always appended to the node which contains knox instances, that improvemnt is not part of this commit, but I have added a comment message into the top.sls file to remind ourselves.", "committedDate": "2020-09-02T15:42:07Z", "type": "forcePushed"}, {"oid": "2212d07fcc7924ac94bfec18c04663fe80a6078c", "url": "https://github.com/hortonworks/cloudbreak/commit/2212d07fcc7924ac94bfec18c04663fe80a6078c", "message": "CB-8617 if the gw node has a valid hostname (called userfacingfqdn) then CB is trying configure and restart CM on every node where knox is present. This issue has been caused by CB-7917 Certificate renewal should be able to change the generated self-signed certificates to valid ones\n\nThis commits fixes the described problem with a simple refactor, that ensures:\n- CM is not started/restarted multiple times since all CM start command are after each other with properly defined watch conditions\n- CM reconfiguration should happen only when the certificate has changed and only on CM node\n- CM configuration is done only on those nodes where knox is present\n\nCode can be improved further by ensuring that the \"knox\" role is always appended to the node which contains knox instances, that improvemnt is not part of this commit, but I have added a comment message into the top.sls file to remind ourselves.", "committedDate": "2020-09-03T06:37:07Z", "type": "commit"}, {"oid": "2212d07fcc7924ac94bfec18c04663fe80a6078c", "url": "https://github.com/hortonworks/cloudbreak/commit/2212d07fcc7924ac94bfec18c04663fe80a6078c", "message": "CB-8617 if the gw node has a valid hostname (called userfacingfqdn) then CB is trying configure and restart CM on every node where knox is present. This issue has been caused by CB-7917 Certificate renewal should be able to change the generated self-signed certificates to valid ones\n\nThis commits fixes the described problem with a simple refactor, that ensures:\n- CM is not started/restarted multiple times since all CM start command are after each other with properly defined watch conditions\n- CM reconfiguration should happen only when the certificate has changed and only on CM node\n- CM configuration is done only on those nodes where knox is present\n\nCode can be improved further by ensuring that the \"knox\" role is always appended to the node which contains knox instances, that improvemnt is not part of this commit, but I have added a comment message into the top.sls file to remind ourselves.", "committedDate": "2020-09-03T06:37:07Z", "type": "forcePushed"}]}