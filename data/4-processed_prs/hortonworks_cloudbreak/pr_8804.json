{"pr_number": 8804, "pr_title": "DISTX-529 Autoscaling Notification", "pr_createdAt": "2020-08-13T10:21:13Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8804", "timeline": [{"oid": "91b1e6135231493c39eb106c7edc2e21b3b69fce", "url": "https://github.com/hortonworks/cloudbreak/commit/91b1e6135231493c39eb106c7edc2e21b3b69fce", "message": "DISTX-529 Autoscaling Notification\n\nPeriscope should send Autoscaling Config Update\\History Event update notifications to UI app.", "committedDate": "2020-08-13T10:25:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg1NjI3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8804#discussion_r469856272", "bodyText": "Defaulting to the same naming convention as in CB .", "author": "smaniraju", "createdAt": "2020-08-13T10:32:06Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/init/DefaultSubscriptionService.java", "diffHunk": "@@ -19,7 +19,7 @@\n \n     private static final String DEFAULT_CLIENT_ID = \"default\";\n \n-    @Value(\"${cb.default.subscription.address:}\")\n+    @Value(\"${cb.notification.endpoint:}\")\n     private String defaultSubscriptionAddress;\n ", "originalCommit": "91b1e6135231493c39eb106c7edc2e21b3b69fce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg2NTM4Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8804#discussion_r469865383", "bodyText": "This will also be initialized with pod specific environment value in dps-k8s repository as done in CB.", "author": "smaniraju", "createdAt": "2020-08-13T10:50:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg1NjI3Mg=="}], "type": "inlineReview"}, {"oid": "281daf11dcfddf3c4af2d8c03248f9a26edc36d2", "url": "https://github.com/hortonworks/cloudbreak/commit/281daf11dcfddf3c4af2d8c03248f9a26edc36d2", "message": "DISTX-529 Autoscaling Notification\n\nPeriscope should send Autoscaling Config Update\\History Event update notifications to UI app.", "committedDate": "2020-08-13T13:42:01Z", "type": "commit"}, {"oid": "281daf11dcfddf3c4af2d8c03248f9a26edc36d2", "url": "https://github.com/hortonworks/cloudbreak/commit/281daf11dcfddf3c4af2d8c03248f9a26edc36d2", "message": "DISTX-529 Autoscaling Notification\n\nPeriscope should send Autoscaling Config Update\\History Event update notifications to UI app.", "committedDate": "2020-08-13T13:42:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk2NzY0MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8804#discussion_r469967641", "bodyText": "Defaulting to same naming convention as in CB i.e periscope.notification.endpoint.\nThis will also be initialized with pod specific environment value in dps-k8s repository as done in CB.", "author": "smaniraju", "createdAt": "2020-08-13T13:52:50Z", "path": "autoscale/src/main/resources/application.yml", "diffHunk": "@@ -44,6 +44,8 @@ periscope:\n       addr: localhost\n       port: 5432\n   cloudbreak.url: http://localhost:9091\n+  notification:\n+    endpoint: http://localhost:3000/notifications\n   entitlementCheckEnabled: true", "originalCommit": "281daf11dcfddf3c4af2d8c03248f9a26edc36d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM4MjU0MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8804#discussion_r470382540", "bodyText": "How will this be rendered on the UI?\ni.e. Will the UI show the eventMessage, or the eventPayload?, and if the eventPayload - is AutoScaleClusterResponse too much information?\nSimilarly for sendConfigUpdateNotification", "author": "sidseth", "createdAt": "2020-08-14T02:57:58Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/notification/HttpNotificationSender.java", "diffHunk": "@@ -26,19 +32,43 @@\n     @Inject\n     private SubscriptionRepository subscriptionRepository;\n \n+    @Inject\n+    private CloudbreakMessagesService messagesService;\n+\n+    @Inject\n+    private HistoryConverter historyConverter;\n+\n+    @Inject\n+    private DistroXAutoscaleClusterResponseConverter autoscaleClusterResponseConverter;\n+\n     private final Client restClient = RestClientUtil.get(new ConfigKey(false, false, false));\n \n-    public void send(Cluster cluster, History history) {\n-        send(convertHistory(cluster, history));\n+    public void sendHistoryUpdateNotification(History historyUpdate, Cluster cluster) {\n+        Notification historyNotification = new Notification();\n+        historyNotification.setTenantName(cluster.getClusterPertain().getTenant());\n+        historyNotification.setEventType(NotificationType.AUTOSCALE_HISTORY_UPDATE.name());\n+        historyNotification.setEventTimestamp(historyUpdate.getTimestamp());\n+        historyNotification.setEventMessage(\n+                messagesService.getMessage(MessageCode.NOTIFICATION_HISTORY_UPDATE));\n+\n+        AutoscaleClusterHistoryResponse historyResponse = historyConverter.convert(historyUpdate);\n+        historyNotification.setPayload(historyResponse);", "originalCommit": "281daf11dcfddf3c4af2d8c03248f9a26edc36d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ0NDgxNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8804#discussion_r470444817", "bodyText": "the eventPayload will be used by the UI to update the tab, so to update the Autoscaling Configuration : AutoScaleClusterResponse would be required. Like if CLI updates config, UI updates config without page refresh.", "author": "smaniraju", "createdAt": "2020-08-14T06:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM4MjU0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ1MDU2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8804#discussion_r470450560", "bodyText": "What will the UI display? You had simplified the status message previously so that it could be the one line which is shown on the UI/CLI.", "author": "sidseth", "createdAt": "2020-08-14T07:13:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM4MjU0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ1NTY4Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8804#discussion_r470455682", "bodyText": "There are two use-cases here. One is Autoscaling-History Update, one is Autoscaling-Config Update. The payload for both of these notifications is same as DistroxAutoscaler API Response i.e (DistroXAutoscaleClusterResponse and AutoscaleClusterHistoryResponse) as suggested by UI team.", "author": "smaniraju", "createdAt": "2020-08-14T07:25:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM4MjU0MA=="}], "type": "inlineReview"}]}