{"pr_number": 9532, "pr_title": "CB-9762 Scheduled cleanup of CLOSE_WAIT autossh connections", "pr_createdAt": "2020-11-26T16:53:32Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9532", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTIwNTk3Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9532#discussion_r531205973", "bodyText": "what if an another service will do this (does not close connections properly), will this restart CCM service?\ncan we check that as well these sockets are all CCM related in the script (you should be able to match process id against the open connections)?", "author": "oleewere", "createdAt": "2020-11-26T19:52:11Z", "path": "freeipa/src/main/resources/freeipa-salt/salt/ccm/scripts/socket-wait-cleanup.sh", "diffHunk": "@@ -0,0 +1,11 @@\n+#!/usr/bin/env bash\n+\n+: \"${SOCKET_WAIT_LIMIT:=1000}\"\n+socket_wait_count=$(netstat -nat | egrep 'CLOSE_WAIT' | wc -l)", "originalCommit": "cfa3ac18305c41a48179a96582e53055c586e0a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ0NzMyMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9532#discussion_r532447321", "bodyText": "PR was updated, please check. Relevant part:\nsocket_wait_count=$(netstat -nat -p | grep ':9443|:443' | grep CLOSE_WAIT | wc -l)", "author": "sodre90", "createdAt": "2020-11-30T09:18:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTIwNTk3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM5MTAwMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9532#discussion_r532391000", "bodyText": "I think we should add the script only if CCM is enabled, so the state should be role dependent. Also only gateway nodes configured for CCM if I remember well, so we should not add this to every node", "author": "lacikaaa", "createdAt": "2020-11-30T07:28:11Z", "path": "orchestrator-salt/src/main/resources/salt/salt/top.sls", "diffHunk": "@@ -11,6 +11,7 @@ base:\n     - metering\n     - ntp\n     - postgresql.root-certs\n+    - ccm", "originalCommit": "cfa3ac18305c41a48179a96582e53055c586e0a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fcb973387e5323cd1b47afd3391accbd0bd22475", "url": "https://github.com/hortonworks/cloudbreak/commit/fcb973387e5323cd1b47afd3391accbd0bd22475", "message": "CB-9762 Scheduled cleanup of CLOSE_WAIT autossh connections\n\nThere may be multiple customers affected by the file descriptor leak.", "committedDate": "2020-11-30T08:44:10Z", "type": "commit"}, {"oid": "fcb973387e5323cd1b47afd3391accbd0bd22475", "url": "https://github.com/hortonworks/cloudbreak/commit/fcb973387e5323cd1b47afd3391accbd0bd22475", "message": "CB-9762 Scheduled cleanup of CLOSE_WAIT autossh connections\n\nThere may be multiple customers affected by the file descriptor leak.", "committedDate": "2020-11-30T08:44:10Z", "type": "forcePushed"}]}