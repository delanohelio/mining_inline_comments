{"pr_number": 8620, "pr_title": "Swagger check in a separated job", "pr_createdAt": "2020-07-23T09:10:12Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8620", "timeline": [{"oid": "45441324e1ef94be4b4c81ebd59e552fb6c1dbc7", "url": "https://github.com/hortonworks/cloudbreak/commit/45441324e1ef94be4b4c81ebd59e552fb6c1dbc7", "message": "check", "committedDate": "2020-07-24T10:18:46Z", "type": "forcePushed"}, {"oid": "1102d208ee46ab66f8a725ce8610da726bea0622", "url": "https://github.com/hortonworks/cloudbreak/commit/1102d208ee46ab66f8a725ce8610da726bea0622", "message": "check", "committedDate": "2020-07-24T21:10:37Z", "type": "forcePushed"}, {"oid": "01f199cb6ef8c7269cbea89c83f7b58e119ed27b", "url": "https://github.com/hortonworks/cloudbreak/commit/01f199cb6ef8c7269cbea89c83f7b58e119ed27b", "message": "CB-8057 swagger validation is now a different job\n\nseparate swagger related logics into separated scripts and run it iin pr time", "committedDate": "2020-07-24T21:39:17Z", "type": "forcePushed"}, {"oid": "84bdbb64087fc8c5b30a0310384095cf325ce2f2", "url": "https://github.com/hortonworks/cloudbreak/commit/84bdbb64087fc8c5b30a0310384095cf325ce2f2", "message": "CB-8057 swagger validation is now a different job\n\nseparate swagger related logics into separated scripts and run it iin pr time", "committedDate": "2020-07-24T22:10:11Z", "type": "forcePushed"}, {"oid": "6714fcf43c9bfcc5ef5c3d34358bb144d96cadb3", "url": "https://github.com/hortonworks/cloudbreak/commit/6714fcf43c9bfcc5ef5c3d34358bb144d96cadb3", "message": "CB-8057 swagger validation is now a different job\n\nseparate swagger related logics into separated scripts and run it iin pr time", "committedDate": "2020-07-27T06:46:49Z", "type": "forcePushed"}, {"oid": "622499d3e4116a1b53f5a0d6baac0a642291ae50", "url": "https://github.com/hortonworks/cloudbreak/commit/622499d3e4116a1b53f5a0d6baac0a642291ae50", "message": "CB-8057 swagger validation is now a different job\n\nseparate swagger related logics into separated scripts and run it iin pr time", "committedDate": "2020-07-27T08:43:28Z", "type": "forcePushed"}, {"oid": "4ca2df161fe41693ce981c834bc978dcf809e84c", "url": "https://github.com/hortonworks/cloudbreak/commit/4ca2df161fe41693ce981c834bc978dcf809e84c", "message": "CB-8057 swagger validation is now a different job\n\nseparate swagger related logics into separated scripts and run it iin pr time", "committedDate": "2020-07-27T09:15:21Z", "type": "forcePushed"}, {"oid": "f6b5fbf834c880ed4fa431bb4452f602e32bbd6d", "url": "https://github.com/hortonworks/cloudbreak/commit/f6b5fbf834c880ed4fa431bb4452f602e32bbd6d", "message": "CB-8057 swagger validation is now a different job\n\nseparate swagger related logics into separated scripts and run it iin pr time", "committedDate": "2020-07-27T09:33:47Z", "type": "forcePushed"}, {"oid": "94731c6f915cbf5cc8e11c5b36a5bb604d50bc0a", "url": "https://github.com/hortonworks/cloudbreak/commit/94731c6f915cbf5cc8e11c5b36a5bb604d50bc0a", "message": "CB-8057 swagger validation is now a different job\n\nseparate swagger related logics into separated scripts and run it iin pr time", "committedDate": "2020-07-27T10:16:18Z", "type": "forcePushed"}, {"oid": "6625e6f0b74cfa15d06d7dc894f0152fe11d5b95", "url": "https://github.com/hortonworks/cloudbreak/commit/6625e6f0b74cfa15d06d7dc894f0152fe11d5b95", "message": "CB-8057 swagger validation is now a different job\n\nseparate swagger related logics into separated scripts and run it iin pr time", "committedDate": "2020-07-27T10:28:14Z", "type": "forcePushed"}, {"oid": "0b3a77430cb785b625d79daba73cc2745701204c", "url": "https://github.com/hortonworks/cloudbreak/commit/0b3a77430cb785b625d79daba73cc2745701204c", "message": "CB-8057 swagger validation is now a different job\n\nseparate swagger related logics into separated scripts and run it iin pr time", "committedDate": "2020-07-27T11:02:33Z", "type": "forcePushed"}, {"oid": "687b1c2f3210edb159e4d7df7bf13b013dea6528", "url": "https://github.com/hortonworks/cloudbreak/commit/687b1c2f3210edb159e4d7df7bf13b013dea6528", "message": "CB-8057 swagger validation is now a different job\n\nseparate swagger related logics into separated scripts and run it iin pr time", "committedDate": "2020-07-27T11:32:12Z", "type": "forcePushed"}, {"oid": "a8fa9a92a40d02e23c01a77506ae0af6b351df3a", "url": "https://github.com/hortonworks/cloudbreak/commit/a8fa9a92a40d02e23c01a77506ae0af6b351df3a", "message": "CB-8057 swagger validation is now a different job\n\nseparate swagger related logics into separated scripts and run it iin pr time", "committedDate": "2020-07-27T12:09:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkwOTU5MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8620#discussion_r460909591", "bodyText": "it should be \"$f validation was successfull\" perhaps", "author": "afarsang", "createdAt": "2020-07-27T13:58:16Z", "path": "integration-test/apidefinitions/validate.sh", "diffHunk": "@@ -0,0 +1,28 @@\n+#!/bin/bash\n+\n+function check() {\n+  for f in /json/$1.json ; do\n+    [ -f \"$f\" ] || continue\n+    echo check to ${f}\n+    swagger validate /json/${1}.json\n+    status=$?\n+    [ $status -eq 0 ] && echo \"$f compatibility was successfull\" || cstatus=1", "originalCommit": "a8fa9a92a40d02e23c01a77506ae0af6b351df3a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkxMTcyMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8620#discussion_r460911721", "bodyText": "it might be\n[ $cstatus -eq 0 ] && echo \"swagger validation finished succesfully\" || echo \"swagger validation failed\"", "author": "afarsang", "createdAt": "2020-07-27T14:01:13Z", "path": "integration-test/apidefinitions/validate.sh", "diffHunk": "@@ -0,0 +1,28 @@\n+#!/bin/bash\n+\n+function check() {\n+  for f in /json/$1.json ; do\n+    [ -f \"$f\" ] || continue\n+    echo check to ${f}\n+    swagger validate /json/${1}.json\n+    status=$?\n+    [ $status -eq 0 ] && echo \"$f compatibility was successfull\" || cstatus=1\n+  done;\n+}\n+\n+cstatus=0\n+DataList=\"cloudbreak,freeipa,environment,datalake,redbeams,autoscale\"\n+Field_Separator=$IFS\n+\n+echo Cloudbreak swagger compatibility check\n+IFS=,\n+for val in $DataList; do\n+  check $val\n+done\n+IFS=$Field_Separator\n+\n+\n+[ $cstatus -eq 0 ] && echo \"swagger diff finished succesfully\" || echo \"swagger diff failed\"", "originalCommit": "a8fa9a92a40d02e23c01a77506ae0af6b351df3a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkxODAxNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8620#discussion_r460918016", "bodyText": "Previously the cloudbreak swagger was validated only, however now it is 5 different swagger yaml file will be validated, and this code will be successful when only one swagger validation is successful (expected to fail the job if ANY swagger diff is unsuccessful )\nAlso I am not sure, the 'status_code=1' is enough to fail the job, but I might have missed something.\ngrep \"swagger validation finished successfully\" swagger-validation-result.out\nswaggervalidationresult=$?\nexit $swaggerdiffresult && $swaggervalidationresult", "author": "afarsang", "createdAt": "2020-07-27T14:10:17Z", "path": "integration-test/scripts/swagger-check.sh", "diffHunk": "@@ -1 +1,74 @@\n-echo no swagger compare here\n\\ No newline at end of file\n+#!/usr/bin/env bash\n+\n+set -ex\n+\n+date\n+echo -e \"\\n\\033[1;96m--- Install cbd\\033[0m\\n\"\n+cd $INTEGCB_LOCATION\n+./cbd generate\n+cd ..\n+\n+date\n+echo -e \"\\n\\033[1;96m--- Create docker network\\033[0m\\n\"\n+docker network create cbreak_default || true\n+\n+env\n+\n+date\n+echo -e \"\\n\\033[1;96m--- Swagger check\\033[0m\\n\"\n+cp ../core/build/swagger/cb.json ./apidefinitions/cloudbreak.json\n+cp ../environment/build/swagger/environment.json ./apidefinitions/environment.json\n+cp ../freeipa/build/swagger/freeipa.json ./apidefinitions/freeipa.json\n+cp ../redbeams/build/swagger/redbeams.json ./apidefinitions/redbeams.json\n+cp ../datalake/build/swagger/datalake.json ./apidefinitions/datalake.json\n+cp ../autoscale/build/swagger/autoscale.json ./apidefinitions/autoscale.json\n+\n+\n+verlte() {\n+    [  \"$1\" = \"`echo -e \"$1\\n$2\" | sort -V | head -n1`\" ]\n+}\n+\n+VERSION=$(echo $CB_VERSION | cut -f 1 -d '-')\n+MAJOR_VERSION=$(echo $VERSION | cut -f 1 -d '.')\n+MINOR_VERSION=$(echo $VERSION | cut -f 2 -d '.')\n+PATCH_VERSION=$(echo $VERSION | cut -f 3 -d '.')\n+PREVIOUS_MINOR_VERSION=$MAJOR_VERSION.$(expr $MINOR_VERSION - 1).$PATCH_VERSION\n+PREVIOUS_MINOR_BUILD=$(curl \"http://release.infra.cloudera.com/hwre-api/listbuilds?stack=CB&release=${PREVIOUS_MINOR_VERSION}\" | jq -r '.latest_build_version')\n+PREVIOUS_BUILD=$(curl \"http://release.infra.cloudera.com/hwre-api/listbuilds?stack=CB&release=$VERSION\" | jq '.full_list_versions[1]' | tr -d '\"')\n+Services=\"cloudbreak,freeipa,environment,datalake,redbeams,autoscale\"\n+declare -A zone=( [\"cloudbreak\"]=\"eu-central-1\" [\"environment\"]=\"us-east-2\" [\"datalake\"]=\"us-east-2\" [\"redbeams\"]=\"us-east-2\" [\"autoscale\"]=\"us-east-2\" [\"freeipa\"]=\"us-east-2\")\n+Field_Separator=$IFS\n+IFS=,\n+set +e\n+for service in $Services; do\n+  if verlte 2.26.0-b50 $PREVIOUS_BUILD ; then\n+    echo Downloading ${service} ${PREVIOUS_BUILD} swagger definition, if possible\n+    STATUSCODE=$(curl -kfSs --write-out \"%{http_code}\" https://${service}-swagger.s3.${zone[$service]}.amazonaws.com/swagger-${PREVIOUS_BUILD}.json -o ./apidefinitions/${service}-swagger-${PREVIOUS_BUILD}.json)\n+    if [ $STATUSCODE -ne 200 ]; then\n+      echo download failed $STATUSCODE\n+      rm ./apidefinitions/${service}-swagger-${PREVIOUS_BUILD}.json\n+    fi\n+  fi\n+  if verlte 2.26.0-b50 $PREVIOUS_MINOR_BUILD ; then\n+    echo Downloading ${service} ${PREVIOUS_MINOR_BUILD} swagger definition, if possible\n+    STATUSCODE=$(curl -kfSs --write-out \"%{http_code}\" https://${service}-swagger.s3.${zone[$service]}.amazonaws.com/swagger-${PREVIOUS_MINOR_BUILD}.json -o ./apidefinitions/${service}-swagger-${PREVIOUS_MINOR_BUILD}.json)\n+    if [ $STATUSCODE -ne 200 ]; then\n+      echo download failed $STATUSCODE\n+      rm ./apidefinitions/${service}-swagger-${PREVIOUS_MINOR_BUILD}.json\n+    fi\n+  fi\n+done\n+set -e\n+IFS=$Field_Separator\n+$INTEGCB_LOCATION/.deps/bin/docker-compose up swagger-diff | tee swagger-diff.out\n+grep \"swagger diff finished succesfully\" swagger-diff.out\n+swaggerdiffresult=$?\n+\n+$INTEGCB_LOCATION/.deps/bin/docker-compose up swagger-validation | tee swagger-validation-result.out\n+\n+# Check swagger validation results", "originalCommit": "a8fa9a92a40d02e23c01a77506ae0af6b351df3a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a6f94d864dc230a870450da5569a09223036c8ff", "url": "https://github.com/hortonworks/cloudbreak/commit/a6f94d864dc230a870450da5569a09223036c8ff", "message": "CB-8057 swagger validation is now a different job\n\nseparate swagger related logics into separated scripts and run it iin pr time", "committedDate": "2020-07-27T14:28:58Z", "type": "commit"}, {"oid": "a6f94d864dc230a870450da5569a09223036c8ff", "url": "https://github.com/hortonworks/cloudbreak/commit/a6f94d864dc230a870450da5569a09223036c8ff", "message": "CB-8057 swagger validation is now a different job\n\nseparate swagger related logics into separated scripts and run it iin pr time", "committedDate": "2020-07-27T14:28:58Z", "type": "forcePushed"}]}