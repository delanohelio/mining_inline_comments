{"pr_number": 9372, "pr_title": "CB-9616: Have kinit code look for more HDFS node directories.", "pr_createdAt": "2020-11-03T21:26:43Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9372", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1NTIyOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r522355228", "bodyText": "This will work as long one of the service listed below are running in the gateway node where salt-master is running.\n\nJOURNALNODE\nDATANODE\nNAMENODE\n\nExtend this to use keytab's for Solr and Hbase services as well if the HDFS keytab's are not found.\nLater we could update the logic in CB to run this command on a host where Solr/Hbase services are running instead of always picking the gatewayFQDN node.", "author": "kkalvagadda1", "createdAt": "2020-11-12T19:18:13Z", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/backup_db.sh", "diffHunk": "@@ -56,7 +56,7 @@ errorExit() {\n kinit_as_hdfs() {\n   # Use a new Kerberos credential cache, to keep from clobbering the default.\n   export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n-  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep hdfs-NAMENODE$ | head -n 1)/hdfs.keytab\n+  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep \"hdfs-\\(JOURNALNODE\\|DATANODE\\|NAMENODE\\)$\" | head -n 1)/hdfs.keytab", "originalCommit": "09780909c0cbdb3dd505ab2ea08d5210ab396a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE5NzM3OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r523197379", "bodyText": "Changed this to use find and look for hbase and solr keytabs.", "author": "brycederriso", "createdAt": "2020-11-13T20:10:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1NTIyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNjIzMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r523236232", "bodyText": "Was this the reason why the error was not logged?", "author": "kkalvagadda1", "createdAt": "2020-11-13T21:15:48Z", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/restore_db.sh", "diffHunk": "@@ -3,7 +3,6 @@\n # This script uses the 'psql' cli to drop hive and ranger databases, create them, then read in a plain SQL file to restore data.\n # We retrieve the SQL files from a valid URL, which should be `s3a://` or `abfs://` for AWS or Azure clouds respectively.\n \n-set -o errexit", "originalCommit": "c0441cfca17d8d575c826b0cc30eb3e00ec6e5ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3OTIxMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r524279213", "bodyText": "Yes.", "author": "brycederriso", "createdAt": "2020-11-16T13:48:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNjIzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzODI4Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r523238286", "bodyText": "With the above change, you might use the key tab for hdfs/hbase/solr services but when you perform kinit you are always using hdfs as the principal name.", "author": "kkalvagadda1", "createdAt": "2020-11-13T21:20:25Z", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/backup_db.sh", "diffHunk": "@@ -56,9 +55,15 @@ errorExit() {\n kinit_as_hdfs() {\n   # Use a new Kerberos credential cache, to keep from clobbering the default.\n   export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n-  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep hdfs-NAMENODE$ | head -n 1)/hdfs.keytab\n-  doLog \"kinit as hdfs using Keytab: $HDFS_KEYTAB\"\n-  kinit -kt \"$HDFS_KEYTAB\" \"hdfs/$(hostname -f)\"\n+\n+  KEYTAB=$(find /run/cloudera-scm-agent/process/ -name \"*.keytab\" -path \"*hdfs*\" -o \\\n+   -path \"*hbase-REGIONSERVER\" -o \\\n+   -path \"*hbase-MASTER\" -o \\\n+   -path \"*solr-SOLRSERVER\" \\\n+   | head -n 1)\n+\n+  doLog \"kinit as hdfs using Keytab: $KEYTAB\"", "originalCommit": "c0441cfca17d8d575c826b0cc30eb3e00ec6e5ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYyMzQ0OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r524623448", "bodyText": "Thank you! This is definitely a bug. I've added handling for kiniting as different principals.", "author": "brycederriso", "createdAt": "2020-11-16T21:45:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzODI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzODM4Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r523238387", "bodyText": "With the above change, you might use the key tab for hdfs/hbase/solr services but when you perform kinit you are always using hdfs as the principal name.", "author": "kkalvagadda1", "createdAt": "2020-11-13T21:20:39Z", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/restore_db.sh", "diffHunk": "@@ -57,9 +56,15 @@ errorExit() {\n kinit_as_hdfs() {\n   # Use a new Kerberos credential cache, to keep from clobbering the default.\n   export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n-  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep hdfs-NAMENODE$ | head -n 1)/hdfs.keytab\n-  doLog \"kinit as hdfs using Keytab: $HDFS_KEYTAB\"\n-  kinit -kt \"$HDFS_KEYTAB\" \"hdfs/$(hostname -f)\"\n+\n+  KEYTAB=$(find /run/cloudera-scm-agent/process/ -name \"*.keytab\" -path \"*hdfs*\" -o \\\n+   -path \"*hbase-REGIONSERVER\" -o \\\n+   -path \"*hbase-MASTER\" -o \\\n+   -path \"*solr-SOLRSERVER\" \\\n+   | head -n 1)\n+\n+  doLog \"kinit as hdfs using Keytab: $KEYTAB\"\n+  kinit -kt \"$KEYTAB\" \"hdfs/$(hostname -f)\"", "originalCommit": "c0441cfca17d8d575c826b0cc30eb3e00ec6e5ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzODU3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r523238572", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              doLog \"kinit as hdfs using Keytab: $KEYTAB\"\n          \n          \n            \n              doLog \"kinit using Keytab: $KEYTAB\"", "author": "kkalvagadda1", "createdAt": "2020-11-13T21:21:07Z", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/restore_db.sh", "diffHunk": "@@ -57,9 +56,15 @@ errorExit() {\n kinit_as_hdfs() {\n   # Use a new Kerberos credential cache, to keep from clobbering the default.\n   export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n-  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep hdfs-NAMENODE$ | head -n 1)/hdfs.keytab\n-  doLog \"kinit as hdfs using Keytab: $HDFS_KEYTAB\"\n-  kinit -kt \"$HDFS_KEYTAB\" \"hdfs/$(hostname -f)\"\n+\n+  KEYTAB=$(find /run/cloudera-scm-agent/process/ -name \"*.keytab\" -path \"*hdfs*\" -o \\\n+   -path \"*hbase-REGIONSERVER\" -o \\\n+   -path \"*hbase-MASTER\" -o \\\n+   -path \"*solr-SOLRSERVER\" \\\n+   | head -n 1)\n+\n+  doLog \"kinit as hdfs using Keytab: $KEYTAB\"", "originalCommit": "c0441cfca17d8d575c826b0cc30eb3e00ec6e5ce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzODYzMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r523238633", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              doLog \"kinit as hdfs using Keytab: $KEYTAB\"\n          \n          \n            \n              doLog \"kinit using Keytab: $KEYTAB\"", "author": "kkalvagadda1", "createdAt": "2020-11-13T21:21:14Z", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/scripts/backup_db.sh", "diffHunk": "@@ -56,9 +55,15 @@ errorExit() {\n kinit_as_hdfs() {\n   # Use a new Kerberos credential cache, to keep from clobbering the default.\n   export KRB5CCNAME=/tmp/krb5cc_cloudbreak_$EUID\n-  HDFS_KEYTAB=/run/cloudera-scm-agent/process/$(ls -t /run/cloudera-scm-agent/process/ | grep hdfs-NAMENODE$ | head -n 1)/hdfs.keytab\n-  doLog \"kinit as hdfs using Keytab: $HDFS_KEYTAB\"\n-  kinit -kt \"$HDFS_KEYTAB\" \"hdfs/$(hostname -f)\"\n+\n+  KEYTAB=$(find /run/cloudera-scm-agent/process/ -name \"*.keytab\" -path \"*hdfs*\" -o \\\n+   -path \"*hbase-REGIONSERVER\" -o \\\n+   -path \"*hbase-MASTER\" -o \\\n+   -path \"*solr-SOLRSERVER\" \\\n+   | head -n 1)\n+\n+  doLog \"kinit as hdfs using Keytab: $KEYTAB\"", "originalCommit": "c0441cfca17d8d575c826b0cc30eb3e00ec6e5ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDYyMzgwOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9372#discussion_r524623808", "bodyText": "done", "author": "brycederriso", "createdAt": "2020-11-16T21:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzODYzMw=="}], "type": "inlineReview"}, {"oid": "7e85145fa6a70f900a2869735c8e7d885748c616", "url": "https://github.com/hortonworks/cloudbreak/commit/7e85145fa6a70f900a2869735c8e7d885748c616", "message": "Add handling for 3 different kinit branches.\n\nKinit as:\n* hbase\n* hdfs\n* solr", "committedDate": "2020-11-16T21:50:28Z", "type": "forcePushed"}, {"oid": "da5cec30c44b62f1f140c7d772fb1a19a4e04760", "url": "https://github.com/hortonworks/cloudbreak/commit/da5cec30c44b62f1f140c7d772fb1a19a4e04760", "message": "Have kinit code look for more HDFS node directories.\n\nDon't bail immediately on errors.\n\nI set `errexit` a while ago, which basically derails the `errorExit`\nfunction since we can't ever catch errors.\n\nRemoving that option should improve error messaging.\n\nUse find to locate a broad variety of keytabs.\n\nAdd handling for 3 different kinit branches.\n\nKinit as:\n* hbase\n* hdfs\n* solr", "committedDate": "2020-11-17T20:37:56Z", "type": "commit"}, {"oid": "da5cec30c44b62f1f140c7d772fb1a19a4e04760", "url": "https://github.com/hortonworks/cloudbreak/commit/da5cec30c44b62f1f140c7d772fb1a19a4e04760", "message": "Have kinit code look for more HDFS node directories.\n\nDon't bail immediately on errors.\n\nI set `errexit` a while ago, which basically derails the `errorExit`\nfunction since we can't ever catch errors.\n\nRemoving that option should improve error messaging.\n\nUse find to locate a broad variety of keytabs.\n\nAdd handling for 3 different kinit branches.\n\nKinit as:\n* hbase\n* hdfs\n* solr", "committedDate": "2020-11-17T20:37:56Z", "type": "forcePushed"}]}