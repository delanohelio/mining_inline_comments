{"pr_number": 9191, "pr_title": "CB-8930 - CM API tracing implemented", "pr_createdAt": "2020-10-09T20:21:52Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9191", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE3NjUzNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9191#discussion_r503176536", "bodyText": "could you remove jetbrains annotations?", "author": "lacikaaa", "createdAt": "2020-10-12T09:50:43Z", "path": "client-cm/src/main/java/com/sequenceiq/cloudbreak/cm/client/tracing/CmOkHttpTracingInterceptor.java", "diffHunk": "@@ -0,0 +1,61 @@\n+package com.sequenceiq.cloudbreak.cm.client.tracing;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.jetbrains.annotations.NotNull;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.cloudbreak.tracing.TracingUtil;\n+import com.squareup.okhttp.Interceptor;\n+import com.squareup.okhttp.Request;\n+import com.squareup.okhttp.Response;\n+\n+import io.opentracing.References;\n+import io.opentracing.Scope;\n+import io.opentracing.Span;\n+import io.opentracing.Tracer;\n+\n+@Component\n+public class CmOkHttpTracingInterceptor implements Interceptor {\n+\n+    private static final String CLOUDERA_MANAGER = \"Cloudera Manager\";\n+\n+    @Inject\n+    private Tracer tracer;\n+\n+    @Inject\n+    private StackTraceBasedCmApiNameExtractor stackTraceBasedCmApiNameExtractor;\n+\n+    @NotNull", "originalCommit": "f4097c263bf55b5281dd0311ac8209035cabedf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE5MzgxMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9191#discussion_r503193811", "bodyText": "yes", "author": "attilapalfi92", "createdAt": "2020-10-12T10:20:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE3NjUzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4MTA4NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9191#discussion_r503181085", "bodyText": "why not Arrays.asList(stackTrace)?", "author": "lacikaaa", "createdAt": "2020-10-12T09:58:15Z", "path": "client-cm/src/main/java/com/sequenceiq/cloudbreak/cm/client/tracing/StackTraceBasedCmApiNameExtractor.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package com.sequenceiq.cloudbreak.cm.client.tracing;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class StackTraceBasedCmApiNameExtractor {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(StackTraceBasedCmApiNameExtractor.class);\n+\n+    public Optional<String> getCmApiName(StackTraceElement[] stackTrace) {\n+        List<StackTraceElement> list = new ArrayList<>();\n+        Collections.addAll(list, stackTrace);", "originalCommit": "f4097c263bf55b5281dd0311ac8209035cabedf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE5NDAyOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9191#discussion_r503194029", "bodyText": "I got various exceptions with that", "author": "attilapalfi92", "createdAt": "2020-10-12T10:20:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4MTA4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4MzY1Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9191#discussion_r503183653", "bodyText": "this empty line indicates this method should be splitted into 2 separate at least", "author": "lacikaaa", "createdAt": "2020-10-12T10:02:26Z", "path": "client-cm/src/main/java/com/sequenceiq/cloudbreak/cm/client/tracing/StackTraceBasedCmApiNameExtractor.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package com.sequenceiq.cloudbreak.cm.client.tracing;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class StackTraceBasedCmApiNameExtractor {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(StackTraceBasedCmApiNameExtractor.class);\n+\n+    public Optional<String> getCmApiName(StackTraceElement[] stackTrace) {\n+        List<StackTraceElement> list = new ArrayList<>();\n+        Collections.addAll(list, stackTrace);\n+        Optional<StackTraceElement> first = list.stream()\n+                .filter(e -> e.getClassName().startsWith(\"com.cloudera.api.swagger\"))\n+                .filter(e -> !e.getClassName().startsWith(\"com.cloudera.api.swagger.client\"))\n+                .findFirst();\n+", "originalCommit": "f4097c263bf55b5281dd0311ac8209035cabedf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE5NTk5MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9191#discussion_r503195990", "bodyText": "I will rewrite this to use stack walker", "author": "attilapalfi92", "createdAt": "2020-10-12T10:24:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4MzY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4NDgwMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9191#discussion_r503184801", "bodyText": "what's the performance impact of this? We make a lot of call to CM, if we inspect every calls stacktrace, could it increase the load significantly?", "author": "lacikaaa", "createdAt": "2020-10-12T10:04:23Z", "path": "client-cm/src/main/java/com/sequenceiq/cloudbreak/cm/client/tracing/StackTraceBasedCmApiNameExtractor.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package com.sequenceiq.cloudbreak.cm.client.tracing;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class StackTraceBasedCmApiNameExtractor {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(StackTraceBasedCmApiNameExtractor.class);\n+\n+    public Optional<String> getCmApiName(StackTraceElement[] stackTrace) {", "originalCommit": "f4097c263bf55b5281dd0311ac8209035cabedf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE5NDU3Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9191#discussion_r503194577", "bodyText": "Let me check. My guess is not much.", "author": "attilapalfi92", "createdAt": "2020-10-12T10:21:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4NDgwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE5NTUyNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9191#discussion_r503195527", "bodyText": "I will rewrite to use StackWalker\nhttps://stackoverflow.com/a/49091729", "author": "attilapalfi92", "createdAt": "2020-10-12T10:23:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4NDgwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzE4NzU2Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9191#discussion_r503187562", "bodyText": "this could bre refactored into a separate method:\n    private Span createSpan(Chain chain) {\n        Request request = chain.request();\n        Optional<String> cmApiNameOptional = stackTraceBasedCmApiNameExtractor.getCmApiName(Thread.currentThread().getStackTrace());\n        String cmApiName = cmApiNameOptional.orElse(request.url().getPath());\n        Span span = tracer.buildSpan(\"CM - [\" + cmApiName + \"] \")\n                .addReference(References.FOLLOWS_FROM, tracer.activeSpan() != null ? tracer.activeSpan().context() : null)\n                .start();\n        span.setTag(TracingUtil.COMPONENT, CLOUDERA_MANAGER);\n        span.setTag(TracingUtil.URL, request.url().toString());\n        span.setTag(TracingUtil.HTTP_METHOD, request.method());\n        span.setTag(TracingUtil.HEADERS, Json.silent(request.headers().toMultimap()).getValue());\n        return span;\n    }", "author": "lacikaaa", "createdAt": "2020-10-12T10:09:12Z", "path": "client-cm/src/main/java/com/sequenceiq/cloudbreak/cm/client/tracing/CmOkHttpTracingInterceptor.java", "diffHunk": "@@ -0,0 +1,61 @@\n+package com.sequenceiq.cloudbreak.cm.client.tracing;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.jetbrains.annotations.NotNull;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.cloudbreak.common.json.Json;\n+import com.sequenceiq.cloudbreak.tracing.TracingUtil;\n+import com.squareup.okhttp.Interceptor;\n+import com.squareup.okhttp.Request;\n+import com.squareup.okhttp.Response;\n+\n+import io.opentracing.References;\n+import io.opentracing.Scope;\n+import io.opentracing.Span;\n+import io.opentracing.Tracer;\n+\n+@Component\n+public class CmOkHttpTracingInterceptor implements Interceptor {\n+\n+    private static final String CLOUDERA_MANAGER = \"Cloudera Manager\";\n+\n+    @Inject\n+    private Tracer tracer;\n+\n+    @Inject\n+    private StackTraceBasedCmApiNameExtractor stackTraceBasedCmApiNameExtractor;\n+\n+    @NotNull\n+    @Override\n+    public Response intercept(@NotNull Chain chain) throws IOException {\n+        Optional<String> cmApiNameOptional = stackTraceBasedCmApiNameExtractor.getCmApiName(Thread.currentThread().getStackTrace());\n+        Request request = chain.request();\n+        String cmApiName = cmApiNameOptional.orElse(request.url().getPath());\n+        Span span = tracer.buildSpan(\"CM - [\" + cmApiName + \"] \")\n+                .addReference(References.FOLLOWS_FROM, tracer.activeSpan() != null ? tracer.activeSpan().context() : null)\n+                .start();\n+        span.setTag(TracingUtil.COMPONENT, CLOUDERA_MANAGER);\n+        span.setTag(TracingUtil.URL, request.url().toString());\n+        span.setTag(TracingUtil.HTTP_METHOD, request.method());\n+        span.setTag(TracingUtil.HEADERS, Json.silent(chain.request().headers().toMultimap()).getValue());", "originalCommit": "f4097c263bf55b5281dd0311ac8209035cabedf1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7b6516210344257e658866f78f233df68d69c3ab", "url": "https://github.com/hortonworks/cloudbreak/commit/7b6516210344257e658866f78f233df68d69c3ab", "message": "CB-8930 - CM API tracing implemented\n- extracting cm api name from stack trace\nIf I were using the URL, it would contain cluster specific info, like cluster name.\nThis would cause the number of operations to be infinite and filtering for CM operations would be impossible.\nThis is why I'm using the CM API's class and method names.\nAdded unit test for the complicated logic.\nUsing StackWalker so it does not have a performance impact.", "committedDate": "2020-10-12T16:10:47Z", "type": "forcePushed"}, {"oid": "8070dd2c194cce967180b876bba9bdad3473f38e", "url": "https://github.com/hortonworks/cloudbreak/commit/8070dd2c194cce967180b876bba9bdad3473f38e", "message": "CB-8930 - CM API tracing implemented\n- extracting cm api name from stack trace\nIf I were using the URL, it would contain cluster specific info, like cluster name.\nThis would cause the number of operations to be infinite and filtering for CM operations would be impossible.\nThis is why I'm using the CM API's class and method names.\nAdded unit test for the complicated logic.\nUsing StackWalker so it does not have a performance impact.", "committedDate": "2020-10-12T16:22:14Z", "type": "forcePushed"}, {"oid": "e4af4cbbc30bd2becbed1567204e8a8cf68bd71c", "url": "https://github.com/hortonworks/cloudbreak/commit/e4af4cbbc30bd2becbed1567204e8a8cf68bd71c", "message": "CB-8930 - CM API tracing implemented\n- extracting cm api name from stack trace\nIf I were using the URL, it would contain cluster specific info, like cluster name.\nThis would cause the number of operations to be infinite and filtering for CM operations would be impossible.\nThis is why I'm using the CM API's class and method names.\nAdded unit test for the complicated logic.\nUsing StackWalker so it does not have a performance impact.", "committedDate": "2020-10-13T14:05:20Z", "type": "forcePushed"}, {"oid": "e9ac92ee1d1e8c9f6a0516b91c54eefd12e05e38", "url": "https://github.com/hortonworks/cloudbreak/commit/e9ac92ee1d1e8c9f6a0516b91c54eefd12e05e38", "message": "CB-8930 - CM API tracing implemented\n- extracting cm api name from stack trace\nIf I were using the URL, it would contain cluster specific info, like cluster name.\nThis would cause the number of operations to be infinite and filtering for CM operations would be impossible.\nThis is why I'm using the CM API's class and method names.\nAdded unit test for the complicated logic.\nUsing StackWalker so it does not have a performance impact.", "committedDate": "2020-10-13T14:22:59Z", "type": "commit"}, {"oid": "e9ac92ee1d1e8c9f6a0516b91c54eefd12e05e38", "url": "https://github.com/hortonworks/cloudbreak/commit/e9ac92ee1d1e8c9f6a0516b91c54eefd12e05e38", "message": "CB-8930 - CM API tracing implemented\n- extracting cm api name from stack trace\nIf I were using the URL, it would contain cluster specific info, like cluster name.\nThis would cause the number of operations to be infinite and filtering for CM operations would be impossible.\nThis is why I'm using the CM API's class and method names.\nAdded unit test for the complicated logic.\nUsing StackWalker so it does not have a performance impact.", "committedDate": "2020-10-13T14:22:59Z", "type": "forcePushed"}]}