{"pr_number": 8228, "pr_title": "CB-7217 Add necessary salt stack changes to invoke the database backup restore scripts.", "pr_createdAt": "2020-06-05T21:35:52Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8228", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU1MzAwOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#discussion_r436553009", "bodyText": "Please use 750 for these files.", "author": "keyki", "createdAt": "2020-06-08T09:03:29Z", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/init.sls", "diffHunk": "@@ -0,0 +1,27 @@\n+/opt/salt/scripts/backup_db.sh:\n+  file.managed:\n+    - makedirs: True\n+    - mode: 755", "originalCommit": "96269172387a21a55149ff4a3703b58b4b379e18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU1NTEwOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#discussion_r436555108", "bodyText": "I don't think we need to include it here. Whenever we invoke restore or backup it will include the init.sls and create the scripts.", "author": "keyki", "createdAt": "2020-06-08T09:07:08Z", "path": "orchestrator-salt/src/main/resources/salt/salt/top.sls", "diffHunk": "@@ -28,6 +28,7 @@ base:\n \n   'G@roles:manager_server':\n     - postgresql\n+    - postgresql.disaster_recovery", "originalCommit": "96269172387a21a55149ff4a3703b58b4b379e18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2MDE5NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#discussion_r436760195", "bodyText": "Ok, this top file controls what is initially moved to a minion then?\nWe'll still receive the states when we use Java to run the state.apply function, so we don't have to include it here?", "author": "brycederriso", "createdAt": "2020-06-08T14:39:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU1NTEwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc3NTg4Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#discussion_r436775887", "bodyText": "This top file describes what will run during highstate. We call highstate very frequently to make sure everything is in place. Backup and restore will be called occasionally so we don't have to include in the top file, it will just create the files so it's not much, but it adds some time to the execution.", "author": "keyki", "createdAt": "2020-06-08T14:59:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU1NTEwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU1NzA3MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#discussion_r436557071", "bodyText": "Not all of our clusters use external DB. Many tests use embedded DB where these pillar configs will be missing. We should add a condition to only execute this if it's external DB. See: example", "author": "keyki", "createdAt": "2020-06-08T09:10:33Z", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/restore.sls", "diffHunk": "@@ -0,0 +1,9 @@\n+include:\n+  - postgresql.disaster_recovery\n+\n+restore_postgresql_db:\n+  cmd.run:\n+    - name: /opt/salt/scripts/restore_db.sh {{salt['pillar.get']('platform')}} {{salt['pillar.get']('disaster_recovery:object_storage_url')}} {{salt['pillar.get']('postgres:remote_db_url')}} {{salt['pillar.get']('postgres:remote_db_port')}} {{salt['pillar.get']('postgres:remote_admin')}}", "originalCommit": "96269172387a21a55149ff4a3703b58b4b379e18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2NDQ4Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#discussion_r436764486", "bodyText": "Should we expect that customers will be running with clusters that are using embedded DBs?\nThis may be a question for @kkalvagadda1 as well.\nAre we performing DR with embedded DBs as well?", "author": "brycederriso", "createdAt": "2020-06-08T14:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU1NzA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU1OTY4MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#discussion_r436559680", "bodyText": "Similarily check if it's external DB, otherwise, this state should not do anything.", "author": "keyki", "createdAt": "2020-06-08T09:14:45Z", "path": "orchestrator-salt/src/main/resources/salt/salt/postgresql/disaster_recovery/backup.sls", "diffHunk": "@@ -0,0 +1,9 @@\n+include:\n+  - postgresql.disaster_recovery\n+", "originalCommit": "96269172387a21a55149ff4a3703b58b4b379e18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU2NTMwNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#discussion_r436565304", "bodyText": "The value of this variable will be passed in a later commit?", "author": "keyki", "createdAt": "2020-06-08T09:24:40Z", "path": "orchestrator-salt/src/main/resources/salt/pillar/postgresql/disaster_recovery.sls", "diffHunk": "@@ -0,0 +1,3 @@\n+disaster_recovery:\n+  object_storage_url:", "originalCommit": "96269172387a21a55149ff4a3703b58b4b379e18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc0NTIzNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8228#discussion_r436745235", "bodyText": "Yes, the intent is that we'll pass in a different value for the object_storage_url with each backup request. It was my impression that we could provide a different Pillar value per invocation, something like this", "author": "brycederriso", "createdAt": "2020-06-08T14:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU2NTMwNA=="}], "type": "inlineReview"}, {"oid": "1e8c9acedf3b28b595547bbfcbeeddbb584230b4", "url": "https://github.com/hortonworks/cloudbreak/commit/1e8c9acedf3b28b595547bbfcbeeddbb584230b4", "message": "CB-7217 Add Salt Stack changes to backup/restore postgres.\n\nChange salt stack and pillar to:\n* Create `.pgpass`\n* Copy backup script to minion\n* Copy restore script to minion\n* Be able to run backup script to a particular S3 location\n* Be able to run restore script from a particular S3 location", "committedDate": "2020-06-08T18:24:30Z", "type": "forcePushed"}, {"oid": "f24c03d4dfb65c9ddfbc6826ca0151483fd63fd8", "url": "https://github.com/hortonworks/cloudbreak/commit/f24c03d4dfb65c9ddfbc6826ca0151483fd63fd8", "message": "CB-7217 Add Salt Stack changes to backup/restore postgres.\n\nChange salt stack and pillar to:\n* Create `.pgpass`\n* Copy backup script to minion\n* Copy restore script to minion\n* Be able to run backup script to a particular S3 location\n* Be able to run restore script from a particular S3 location", "committedDate": "2020-06-09T15:40:48Z", "type": "commit"}, {"oid": "f24c03d4dfb65c9ddfbc6826ca0151483fd63fd8", "url": "https://github.com/hortonworks/cloudbreak/commit/f24c03d4dfb65c9ddfbc6826ca0151483fd63fd8", "message": "CB-7217 Add Salt Stack changes to backup/restore postgres.\n\nChange salt stack and pillar to:\n* Create `.pgpass`\n* Copy backup script to minion\n* Copy restore script to minion\n* Be able to run backup script to a particular S3 location\n* Be able to run restore script from a particular S3 location", "committedDate": "2020-06-09T15:40:48Z", "type": "forcePushed"}]}