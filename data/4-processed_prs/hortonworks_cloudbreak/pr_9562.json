{"pr_number": 9562, "pr_title": "CB-10072 Basic CRN resource type validation", "pr_createdAt": "2020-12-02T15:40:59Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9562", "timeline": [{"oid": "badc2994ef59cb66adcf85ac14b19d9e3a91316f", "url": "https://github.com/hortonworks/cloudbreak/commit/badc2994ef59cb66adcf85ac14b19d9e3a91316f", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.", "committedDate": "2020-12-02T15:58:13Z", "type": "forcePushed"}, {"oid": "f4ba49327103d40b0f07b8bbb0fbdc0205a4b8a2", "url": "https://github.com/hortonworks/cloudbreak/commit/f4ba49327103d40b0f07b8bbb0fbdc0205a4b8a2", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.", "committedDate": "2020-12-02T16:00:18Z", "type": "forcePushed"}, {"oid": "6d5e81f47db1677137f38d809ee5b175d616d84a", "url": "https://github.com/hortonworks/cloudbreak/commit/6d5e81f47db1677137f38d809ee5b175d616d84a", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.", "committedDate": "2020-12-02T16:50:55Z", "type": "forcePushed"}, {"oid": "d675dc883203b252084324f0fa87b059e99c421a", "url": "https://github.com/hortonworks/cloudbreak/commit/d675dc883203b252084324f0fa87b059e99c421a", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.", "committedDate": "2020-12-02T20:25:36Z", "type": "forcePushed"}, {"oid": "203801c82a64d55254246ba14eaece86357a8325", "url": "https://github.com/hortonworks/cloudbreak/commit/203801c82a64d55254246ba14eaece86357a8325", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.", "committedDate": "2020-12-03T05:16:07Z", "type": "forcePushed"}, {"oid": "39cbf20f5eebc7c85198e866346ec49f3c65ec46", "url": "https://github.com/hortonworks/cloudbreak/commit/39cbf20f5eebc7c85198e866346ec49f3c65ec46", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.", "committedDate": "2020-12-03T06:46:37Z", "type": "forcePushed"}, {"oid": "35e325eccc9ae09aa5a55b288e2201ec51416bc4", "url": "https://github.com/hortonworks/cloudbreak/commit/35e325eccc9ae09aa5a55b288e2201ec51416bc4", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.", "committedDate": "2020-12-03T11:03:25Z", "type": "forcePushed"}, {"oid": "7d562207417c71a2c50391c70ba709b251b119bd", "url": "https://github.com/hortonworks/cloudbreak/commit/7d562207417c71a2c50391c70ba709b251b119bd", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.", "committedDate": "2020-12-03T11:08:36Z", "type": "forcePushed"}, {"oid": "b186bc8d1a208dbe9c49b50fc60eb8c272a92182", "url": "https://github.com/hortonworks/cloudbreak/commit/b186bc8d1a208dbe9c49b50fc60eb8c272a92182", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.", "committedDate": "2020-12-03T11:23:55Z", "type": "forcePushed"}, {"oid": "cc20b10384a438d30598f22839b57f052509e1b6", "url": "https://github.com/hortonworks/cloudbreak/commit/cc20b10384a438d30598f22839b57f052509e1b6", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.\n- introduced new ValidCrnCollection annotation for crn collections in APIs\n- adding more restrictive ValidCrn/ValidCrncollection to some environment APIs calls and freeipa request objects", "committedDate": "2020-12-03T14:07:12Z", "type": "forcePushed"}, {"oid": "173b201499ddff0d65cc021dfee7d76563e22dcb", "url": "https://github.com/hortonworks/cloudbreak/commit/173b201499ddff0d65cc021dfee7d76563e22dcb", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.\n- introduced new ValidCrnCollection annotation for crn collections in APIs\n- adding more restrictive ValidCrn/ValidCrncollection to some environment APIs calls and freeipa request objects", "committedDate": "2020-12-03T17:25:40Z", "type": "forcePushed"}, {"oid": "9fc3e12fdac6b4833fc97a81be9e2cd72f4ff782", "url": "https://github.com/hortonworks/cloudbreak/commit/9fc3e12fdac6b4833fc97a81be9e2cd72f4ff782", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.\n- introduced new ValidCrnCollection annotation for crn collections in APIs\n- adding more restrictive ValidCrn/ValidCrncollection to some environment APIs calls and freeipa request objects", "committedDate": "2020-12-04T06:46:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAxMjA3Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r536012072", "bodyText": "looks dangerous :)", "author": "lnardai", "createdAt": "2020-12-04T10:53:17Z", "path": "auth-internal/src/main/java/com/sequenceiq/cloudbreak/auth/security/internal/InternalCrnModifier.java", "diffHunk": "@@ -63,12 +63,7 @@ public Object changeInternalCrn(ProceedingJoinPoint proceedingJoinPoint) {\n \n     private String getAccountIdModifiedCrn(String userCrnString, String accountId) {\n         Crn userCrn = Crn.fromString(userCrnString);\n-        Crn newUserCrn = Crn.builder()\n-                .setService(userCrn.getService())\n-                .setAccountId(accountId)\n-                .setResourceType(userCrn.getResourceType())\n-                .setResource(userCrn.getResource())\n-                .build();\n+        Crn newUserCrn = Crn.copyWithDifferentAccountId(userCrn, accountId);", "originalCommit": "9fc3e12fdac6b4833fc97a81be9e2cd72f4ff782", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAxNDM5NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r536014395", "bodyText": "what do you mean by that? it does the same as the current code", "author": "horadla23", "createdAt": "2020-12-04T10:57:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAxMjA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAxNjUyNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r536016526", "bodyText": "Yes, I know, but that logic was private to that InternalCrnModifier implementation, while the static Crn is used widely in the code. I'm just contemplating wether it's worth to expose that.", "author": "lnardai", "createdAt": "2020-12-04T11:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAxMjA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAyMzI1OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r536023258", "bodyText": "setAccountId in Crn.builder() was not private, I mean right now everyone can change accountId If he/she want to do so. one solution can be to make the method package private or something like that but InternalCrnModifier and Crn placed in different module. We can move one of them but it can cause other issues.", "author": "horadla23", "createdAt": "2020-12-04T11:12:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAxMjA3Mg=="}], "type": "inlineReview"}, {"oid": "f8f3e822b7e351c46bb18b2c6ea356f486160441", "url": "https://github.com/hortonworks/cloudbreak/commit/f8f3e822b7e351c46bb18b2c6ea356f486160441", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.\n- introduced new ValidCrnCollection annotation for crn collections in APIs\n- adding more restrictive ValidCrn/ValidCrncollection to some environment APIs calls and freeipa request objects", "committedDate": "2020-12-04T13:55:14Z", "type": "forcePushed"}, {"oid": "1c4d9f6468fb315bd8ec79766d94f710b45e1bf3", "url": "https://github.com/hortonworks/cloudbreak/commit/1c4d9f6468fb315bd8ec79766d94f710b45e1bf3", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.\n- introduced new ValidCrnCollection annotation for crn collections in APIs\n- adding more restrictive ValidCrn/ValidCrncollection to some environment APIs calls and freeipa request objects", "committedDate": "2020-12-04T14:17:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQxNDM3MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r537414370", "bodyText": "just a stupid idea: I think it would be easier to read through the list if it would be grouped by services and the items would be alphabetically ordered inside the groups.\nMore nice way would be if the items would be in separate file by service, but that maybe would cause more complexity than benefit.", "author": "lacikaaa", "createdAt": "2020-12-07T10:58:40Z", "path": "common/src/main/java/com/sequenceiq/cloudbreak/auth/altus/CrnResourceDescriptor.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package com.sequenceiq.cloudbreak.auth.altus;\n+\n+import org.apache.commons.lang3.tuple.Pair;\n+\n+public enum CrnResourceDescriptor {\n+    ENVIRONMENT(Crn.ResourceType.ENVIRONMENT, Crn.Service.ENVIRONMENTS),\n+    DATALAKE(Crn.ResourceType.DATALAKE, Crn.Service.DATALAKE),\n+    FREEIPA(Crn.ResourceType.FREEIPA, Crn.Service.FREEIPA),\n+    KERBEROS(Crn.ResourceType.KERBEROS, Crn.Service.FREEIPA),\n+    LDAP(Crn.ResourceType.LDAP, Crn.Service.FREEIPA),\n+    DATAHUB(Crn.ResourceType.CLUSTER, Crn.Service.DATAHUB),\n+    CLUSTER_DEF(Crn.ResourceType.CLUSTER_DEFINITION, Crn.Service.DATAHUB),\n+    CLUSTER_TEMPLATE(Crn.ResourceType.CLUSTER_TEMPLATE, Crn.Service.DATAHUB),\n+    CREDENTIAL(Crn.ResourceType.CREDENTIAL, Crn.Service.ENVIRONMENTS),\n+    IMAGE_CATALOG(Crn.ResourceType.IMAGE_CATALOG, Crn.Service.DATAHUB),\n+    RECIPE(Crn.ResourceType.RECIPE, Crn.Service.DATAHUB),\n+    PROXY(Crn.ResourceType.PROXY_CONIFG, Crn.Service.ENVIRONMENTS),\n+    ACCOUNT_TAG(Crn.ResourceType.ACCOUNT_TAG, Crn.Service.ACCOUNTTAG),\n+    ACCOUNT_TELEMETRY(Crn.ResourceType.ACCOUNT_TELEMETRY, Crn.Service.ACCOUNTTELEMETRY),\n+    NETWORK(Crn.ResourceType.NETWORK, Crn.Service.ENVIRONMENTS),\n+    ROLE(Crn.ResourceType.ROLE, Crn.Service.IAM),\n+    RESOURCE_ROLE(Crn.ResourceType.RESOURCE_ROLE, Crn.Service.IAM),\n+    ALERT(Crn.ResourceType.DATAHUB_AUTOSCALE_CONFIG, Crn.Service.AUTOSCALE),\n+    DATABASE(Crn.ResourceType.DATABASE, Crn.Service.REDBEAMS),\n+    DATABASE_SERVER(Crn.ResourceType.DATABASE_SERVER, Crn.Service.REDBEAMS),\n+    USER(Crn.ResourceType.USER, Crn.Service.IAM),\n+    PUBLIC_KEY(Crn.ResourceType.PUBLIC_KEY, Crn.Service.IAM),\n+    MACHINE_USER(Crn.ResourceType.MACHINE_USER, Crn.Service.IAM),\n+    GROUP(Crn.ResourceType.GROUP, Crn.Service.IAM),\n+    POLICY(Crn.ResourceType.POLICY, Crn.Service.IAM);", "originalCommit": "1c4d9f6468fb315bd8ec79766d94f710b45e1bf3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQyMDc2OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r537420768", "bodyText": "yes, grouping seems worth to implement, separate files can be problematic indeed, since services are referring to other services' crns", "author": "horadla23", "createdAt": "2020-12-07T11:09:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQxNDM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQxNjIyOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r537416229", "bodyText": "could you break this into smaller methods?", "author": "lacikaaa", "createdAt": "2020-12-07T11:01:33Z", "path": "common/src/main/java/com/sequenceiq/cloudbreak/validation/CrnCollectionValidator.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package com.sequenceiq.cloudbreak.validation;\n+\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import javax.validation.ConstraintValidator;\n+import javax.validation.ConstraintValidatorContext;\n+\n+import org.apache.commons.lang3.tuple.Pair;\n+\n+import com.google.common.base.Joiner;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.auth.altus.CrnResourceDescriptor;\n+\n+public class CrnCollectionValidator implements ConstraintValidator<ValidCrnCollection, Collection<String>> {\n+\n+    private CrnResourceDescriptor[] resourceDescriptors;\n+\n+    @Override\n+    public void initialize(ValidCrnCollection constraintAnnotation) {\n+        resourceDescriptors = constraintAnnotation.resource();\n+    }\n+\n+    @Override\n+    public boolean isValid(Collection<String> req, ConstraintValidatorContext constraintValidatorContext) {", "originalCommit": "1c4d9f6468fb315bd8ec79766d94f710b45e1bf3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQxNzUzNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r537417535", "bodyText": "I feel like there is a lot of code duplication here with CrnCollectionValidator. Could you move the common parts into a common class?", "author": "lacikaaa", "createdAt": "2020-12-07T11:03:41Z", "path": "common/src/main/java/com/sequenceiq/cloudbreak/validation/CrnValidator.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package com.sequenceiq.cloudbreak.validation;\n+\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import javax.validation.ConstraintValidator;\n+import javax.validation.ConstraintValidatorContext;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.commons.lang3.tuple.Pair;\n+\n+import com.google.common.base.Joiner;\n+import com.sequenceiq.cloudbreak.auth.altus.Crn;\n+import com.sequenceiq.cloudbreak.auth.altus.CrnResourceDescriptor;\n+\n+public class CrnValidator implements ConstraintValidator<ValidCrn, String> {", "originalCommit": "1c4d9f6468fb315bd8ec79766d94f710b45e1bf3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQxOTc3Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r537419773", "bodyText": "yes, makes sense", "author": "horadla23", "createdAt": "2020-12-07T11:07:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQxNzUzNQ=="}], "type": "inlineReview"}, {"oid": "baa8482136b6aea2db2c6fbd06cdefa5e26cc260", "url": "https://github.com/hortonworks/cloudbreak/commit/baa8482136b6aea2db2c6fbd06cdefa5e26cc260", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.\n- introduced new ValidCrnCollection annotation for crn collections in APIs\n- adding more restrictive ValidCrn/ValidCrncollection to some environment APIs calls and freeipa request objects", "committedDate": "2020-12-07T11:57:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MjEwMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r537462102", "bodyText": "Question: does the Crn validation work with a collection of Crns as well?", "author": "gergopapi2", "createdAt": "2020-12-07T12:17:56Z", "path": "redbeams-api/src/main/java/com/sequenceiq/redbeams/api/endpoint/v4/databaseserver/DatabaseServerV4Endpoint.java", "diffHunk": "@@ -138,7 +141,7 @@ DatabaseServerV4Response deleteByName(\n     @ApiOperation(value = DatabaseServerOpDescription.DELETE_MULTIPLE_BY_CRN, notes = DatabaseServerNotes.DELETE_MULTIPLE_BY_CRN,\n             consumes = MediaType.APPLICATION_JSON, nickname = \"deleteMultipleDatabaseServersByCrn\")\n     DatabaseServerV4Responses deleteMultiple(\n-            @ApiParam(DatabaseServerParamDescriptions.CRNS) Set<@ValidCrn String> crns,\n+            @ApiParam(DatabaseServerParamDescriptions.CRNS) @ValidCrn(resource = DATABASE_SERVER) Set<String> crns,", "originalCommit": "baa8482136b6aea2db2c6fbd06cdefa5e26cc260", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2ODM1MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r537468351", "bodyText": "have you checked the change? anyway there is a new mock test for this to make sure", "author": "horadla23", "createdAt": "2020-12-07T12:28:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MjEwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyNzIxNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r537527214", "bodyText": "sorry, so yes, it is also working with collection of crns", "author": "horadla23", "createdAt": "2020-12-07T14:00:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MjEwMg=="}], "type": "inlineReview"}, {"oid": "77695c193313eb0218512e05021307da2d7d7e04", "url": "https://github.com/hortonworks/cloudbreak/commit/77695c193313eb0218512e05021307da2d7d7e04", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.\n- introduced new ValidCrnCollection annotation for crn collections in APIs\n- adding more restrictive ValidCrn/ValidCrncollection to some environment APIs calls and freeipa request objects", "committedDate": "2020-12-07T13:53:22Z", "type": "forcePushed"}, {"oid": "05efbbb75dfa18ba1e5e154de144b8dae6e09c1e", "url": "https://github.com/hortonworks/cloudbreak/commit/05efbbb75dfa18ba1e5e154de144b8dae6e09c1e", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.\n- introduced new ValidCrnCollection annotation for crn collections in APIs\n- adding more restrictive ValidCrn/ValidCrncollection to some environment APIs calls and freeipa request objects", "committedDate": "2020-12-07T14:10:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE3NTQ5Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r538175493", "bodyText": "static import ? we used it in EnvironmentEndpoint.java", "author": "doktoric", "createdAt": "2020-12-08T09:29:01Z", "path": "environment/src/main/java/com/sequenceiq/environment/environment/v1/EnvironmentController.java", "diffHunk": "@@ -141,7 +143,7 @@ public EnvironmentCrnResponse getCrnByName(@ResourceName String environmentName)\n \n     @Override\n     @CheckPermissionByResourceCrn(action = AuthorizationResourceAction.DESCRIBE_ENVIRONMENT)\n-    public DetailedEnvironmentResponse getByCrn(@ResourceCrn @TenantAwareParam String crn) {\n+    public DetailedEnvironmentResponse getByCrn(@ValidCrn(resource = CrnResourceDescriptor.ENVIRONMENT) @ResourceCrn @TenantAwareParam String crn) {", "originalCommit": "05efbbb75dfa18ba1e5e154de144b8dae6e09c1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI4ODUzMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r538288530", "bodyText": "because there were conflicts between static imports (CrnResourceDescriptor.ENVIRONMENT vs CredentialType.ENVIRONMENT) i decided to not use static import in case of CrnResourceDescriptor", "author": "horadla23", "createdAt": "2020-12-08T12:01:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE3NTQ5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4NDczNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r538184734", "bodyText": "is the resourceDescriptor required or why do you add to the param list?", "author": "topolyai5", "createdAt": "2020-12-08T09:41:46Z", "path": "common/src/main/java/com/sequenceiq/cloudbreak/auth/altus/Crn.java", "diffHunk": "@@ -591,32 +600,45 @@ public static Builder builder() {\n \n         private String resource;\n \n-        public Builder setPartition(Partition partition) {\n-            this.partition = checkNotNull(partition);\n+        /**\n+         * @deprecated ALTUS was replaced by CDP and is kept here for backward compatibility reasons (e.g., dynamodb serialized CRNs).\n+         */\n+        @Deprecated\n+        public Builder setOldPartition() {\n+            this.partition = Partition.ALTUS;\n             return this;\n         }\n \n-        public Builder setService(Service service) {\n-            this.service = checkNotNull(service);\n+        public Builder setAccountId(String accountId) {\n+            this.accountId = checkNotNull(accountId);\n             return this;\n         }\n \n-        public Builder setAccountId(String accountId) {\n-            this.accountId = checkNotNull(accountId);\n+        public Builder setResource(String resource) {\n+            this.resource = checkNotNull(resource);\n             return this;\n         }\n \n-        public Builder setResourceType(ResourceType resourceType) {\n-            this.resourceType = checkNotNull(resourceType);\n+        public Crn build(CrnResourceDescriptor resourceDescriptor) {", "originalCommit": "05efbbb75dfa18ba1e5e154de144b8dae6e09c1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5NzE2MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r538197161", "bodyText": "yes, required", "author": "horadla23", "createdAt": "2020-12-08T09:57:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4NDczNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIwMzM5OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r538203399", "bodyText": "As I know, almost all of the fields are required in the crn. Is it a good pattern to add the required fields as a parameter to the build() method?", "author": "topolyai5", "createdAt": "2020-12-08T10:06:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4NDczNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxMDAzOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r538210038", "bodyText": "all fields are required, but some of them have 1 value always, some of them changed to package private in this change and alo crnresourcedescriptor is not part of the crn, so it is not a required field, but helps to fill in some fields of the crn, so it i decided to add to build() as parameter", "author": "horadla23", "createdAt": "2020-12-08T10:15:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4NDczNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxMDk4OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r538210989", "bodyText": "i can also add a new constructor for builder if it is better, instead of adding a parameter to build(), what do you think @topolyai5 ?", "author": "horadla23", "createdAt": "2020-12-08T10:17:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4NDczNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5MDY0Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r538190643", "bodyText": "could you please change for this: EnvironmentInternalGetAction or remove one of them?", "author": "topolyai5", "createdAt": "2020-12-08T09:49:12Z", "path": "integration-test/src/main/java/com/sequenceiq/it/cloudbreak/client/EnvironmentTestClient.java", "diffHunk": "@@ -36,6 +38,10 @@\n         return new EnvironmentGetAction();\n     }\n \n+    public Action<EnvironmentTestDto, EnvironmentClient> describeByCrn() {", "originalCommit": "05efbbb75dfa18ba1e5e154de144b8dae6e09c1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5Nzg5Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r538197893", "bodyText": "why internal? both of them are worth to test and both of them can be used by anyone", "author": "horadla23", "createdAt": "2020-12-08T09:58:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5MDY0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIwMDI3OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r538200278", "bodyText": "ohh, i see now, but my method is not using internalcrn, and that's the real use case in my test", "author": "horadla23", "createdAt": "2020-12-08T10:02:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5MDY0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIwOTgxMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9562#discussion_r538209812", "bodyText": "Yes, you are right. Ok, it will be ok", "author": "topolyai5", "createdAt": "2020-12-08T10:15:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5MDY0Mw=="}], "type": "inlineReview"}, {"oid": "a139d4743961194841c200e52d173685f5c2c354", "url": "https://github.com/hortonworks/cloudbreak/commit/a139d4743961194841c200e52d173685f5c2c354", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.\n- introduced new ValidCrnCollection annotation for crn collections in APIs\n- adding more restrictive ValidCrn/ValidCrncollection to some environment APIs calls and freeipa request objects", "committedDate": "2020-12-08T11:58:08Z", "type": "commit"}, {"oid": "a139d4743961194841c200e52d173685f5c2c354", "url": "https://github.com/hortonworks/cloudbreak/commit/a139d4743961194841c200e52d173685f5c2c354", "message": "CB-10072 Basic CRN resource type validation\n- this commit ensures that resources can be created with predefined resourcetype/servictype pair, also some parts of CRN should not be configurable (like partition, region).\n- checking for resourcetype/servicetype pair has been added to ValidCrn annotation to avoid situations like calling environment related endpoint with datalake crn.\n- introduced new ValidCrnCollection annotation for crn collections in APIs\n- adding more restrictive ValidCrn/ValidCrncollection to some environment APIs calls and freeipa request objects", "committedDate": "2020-12-08T11:58:08Z", "type": "forcePushed"}]}