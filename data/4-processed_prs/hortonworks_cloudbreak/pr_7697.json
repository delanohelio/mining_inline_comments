{"pr_number": 7697, "pr_title": "CB-6366 FreeIPA stacks are not deleted, they remain in DELETE_COMPLETED state", "pr_createdAt": "2020-03-31T13:09:22Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7697", "timeline": [{"oid": "65d269131303b05fe2a5251eab2ebda80310f664", "url": "https://github.com/hortonworks/cloudbreak/commit/65d269131303b05fe2a5251eab2ebda80310f664", "message": "CB-6366 FreeIPA stacks are not deleted, they remain in DELETE_COMPLETED state", "committedDate": "2020-03-31T12:50:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzNDkxNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7697#discussion_r401134916", "bodyText": "is this save necessary since the stackUpdater also saves the stack? If we need to save it again, shouldn't we use the Stack that is returned from updateStackStatus instead? By my understanding, this stack should be detached at this point.", "author": "handavid", "createdAt": "2020-03-31T18:44:40Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/flow/stack/termination/action/TerminationService.java", "diffHunk": "@@ -54,22 +54,22 @@\n     private KerberosMgmtV1Service kerberosMgmtV1Service;\n \n     public void finalizeTermination(Long stackId) {\n-        Stack stack = stackService.getByIdWithListsInTransaction(stackId);\n-        Date now = new Date();\n-        String terminatedName = stack.getName() + DELIMITER + now.getTime();\n+        long currentTimeMillis = clock.getCurrentTimeMillis();\n         try {\n             transactionService.required(() -> {\n+                Stack stack = stackService.getByIdWithListsInTransaction(stackId);\n+                String terminatedName = stack.getName() + DELIMITER + currentTimeMillis;\n                 stack.setName(terminatedName);\n-                stack.setTerminated(clock.getCurrentTimeMillis());\n+                stack.setTerminated(currentTimeMillis);\n                 terminateInstanceGroups(stack);\n                 terminateMetaDataInstances(stack);\n                 cleanupVault(stack);\n+                stackUpdater.updateStackStatus(stack, DetailedStackStatus.DELETE_COMPLETED, \"Stack was terminated successfully.\");\n                 stackService.save(stack);", "originalCommit": "65d269131303b05fe2a5251eab2ebda80310f664", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwMDYxNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7697#discussion_r401400616", "bodyText": "you are right, I was thinking about it, but as it went into rc-2.19 I wanted to minimize the change. My issue is if updateStackStatus change and don't save the stack only saves a new StackStatus, then we don't save here. But yeah, the returned value should be saved.", "author": "lacikaaa", "createdAt": "2020-04-01T07:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzNDkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzNzAyOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7697#discussion_r401137028", "bodyText": "nit: do we refer to freeipa stacks as \"cluster\" elsewhere? I think it would be clearer to refer to this as \"freeipa infrastructure\"\nstackId is still available as a method parameter if you want to continue logging it.", "author": "handavid", "createdAt": "2020-03-31T18:48:05Z", "path": "freeipa/src/main/java/com/sequenceiq/freeipa/flow/stack/termination/action/TerminationService.java", "diffHunk": "@@ -54,22 +54,22 @@\n     private KerberosMgmtV1Service kerberosMgmtV1Service;\n \n     public void finalizeTermination(Long stackId) {\n-        Stack stack = stackService.getByIdWithListsInTransaction(stackId);\n-        Date now = new Date();\n-        String terminatedName = stack.getName() + DELIMITER + now.getTime();\n+        long currentTimeMillis = clock.getCurrentTimeMillis();\n         try {\n             transactionService.required(() -> {\n+                Stack stack = stackService.getByIdWithListsInTransaction(stackId);\n+                String terminatedName = stack.getName() + DELIMITER + currentTimeMillis;\n                 stack.setName(terminatedName);\n-                stack.setTerminated(clock.getCurrentTimeMillis());\n+                stack.setTerminated(currentTimeMillis);\n                 terminateInstanceGroups(stack);\n                 terminateMetaDataInstances(stack);\n                 cleanupVault(stack);\n+                stackUpdater.updateStackStatus(stack, DetailedStackStatus.DELETE_COMPLETED, \"Stack was terminated successfully.\");\n                 stackService.save(stack);\n-                stackUpdater.updateStackStatus(stackId, DetailedStackStatus.DELETE_COMPLETED, \"Stack was terminated successfully.\");\n                 return null;\n             });\n-        } catch (TransactionService.TransactionExecutionException ex) {\n-            LOGGER.info(\"Failed to terminate cluster infrastructure. Stack id {}\", stack.getId());\n+        } catch (TransactionExecutionException ex) {\n+            LOGGER.info(\"Failed to terminate cluster infrastructure.\");", "originalCommit": "65d269131303b05fe2a5251eab2ebda80310f664", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQwMTIyMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7697#discussion_r401401220", "bodyText": "it's a copy-paste error. yeah I could have added it, but hopefully the logcontext already contains that information, so I didn't think much about deleting it", "author": "lacikaaa", "createdAt": "2020-04-01T07:13:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzNzAyOA=="}], "type": "inlineReview"}]}