{"pr_number": 7957, "pr_title": "CB-6879: Redundant full backup created on Azure FreeIPA HA hosts", "pr_createdAt": "2020-05-03T22:53:30Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7957", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0NzQ0OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7957#discussion_r419347449", "bodyText": "could you rename this state and move the command into the name parameter?\nalso this would be called every time a highstate is called, so I think you should place a file somewhere so it wouldn't run again", "author": "lacikaaa", "createdAt": "2020-05-04T10:38:07Z", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/backups.sls", "diffHunk": "@@ -15,6 +15,10 @@\n     - mode: 640\n \n {% if salt['pillar.get']('freeipa:backup:monthly_full_enabled') %}\n+'/sbin/anacron -u cron.monthly':", "originalCommit": "5c52f6e9c9537619f134893e1615756a5e72ed70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM5NjcyMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7957#discussion_r419396723", "bodyText": "It will not be run again because of the onlyif.  The anacron state files (in /var/spool/anacron) start out as a zero byte file until it is run once.  From then on they are updated to a datestamp of when they were last run.   The anacron -u forces the update of the datestamp file without running the commands.", "author": "wonderslug", "createdAt": "2020-05-04T12:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0NzQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQwNTg1Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7957#discussion_r419405857", "bodyText": "thanks for the explanation!", "author": "lacikaaa", "createdAt": "2020-05-04T12:42:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0NzQ0OQ=="}], "type": "inlineReview"}, {"oid": "5c52f6e9c9537619f134893e1615756a5e72ed70", "url": "https://github.com/hortonworks/cloudbreak/commit/5c52f6e9c9537619f134893e1615756a5e72ed70", "message": "CB-6879: Redundant full backup created on Azure FreeIPA HA hosts\n\nThis prevents monthly backup from running when enabled until the next month.  This is the first step to fixing CB-6717 across multiple FreeIPA HA nodes.", "committedDate": "2020-05-03T22:48:59Z", "type": "forcePushed"}, {"oid": "2d2c3a7462469344badcf4baa90010926c5d92ef", "url": "https://github.com/hortonworks/cloudbreak/commit/2d2c3a7462469344badcf4baa90010926c5d92ef", "message": "CB-6879: Redundant full backup created on Azure FreeIPA HA hosts\n\nThis prevents monthly backup from running when enabled until the next month.  This is the first step to fixing CB-6717 across multiple FreeIPA HA nodes.\n\nCB-6879: Redundant full backup created on Azure FreeIPA HA hosts", "committedDate": "2020-05-04T12:38:39Z", "type": "commit"}, {"oid": "2d2c3a7462469344badcf4baa90010926c5d92ef", "url": "https://github.com/hortonworks/cloudbreak/commit/2d2c3a7462469344badcf4baa90010926c5d92ef", "message": "CB-6879: Redundant full backup created on Azure FreeIPA HA hosts\n\nThis prevents monthly backup from running when enabled until the next month.  This is the first step to fixing CB-6717 across multiple FreeIPA HA nodes.\n\nCB-6879: Redundant full backup created on Azure FreeIPA HA hosts", "committedDate": "2020-05-04T12:38:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ2NzUzOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/7957#discussion_r419467538", "bodyText": "Is it possible that the anacron monthly backup runs once before the FreeIPA backup is added to it? If so, then this file would exist but the backup would not.", "author": "jamisonbennett", "createdAt": "2020-05-04T14:13:11Z", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/backups.sls", "diffHunk": "@@ -15,6 +15,11 @@\n     - mode: 640\n \n {% if salt['pillar.get']('freeipa:backup:monthly_full_enabled') %}\n+freeipa_backoff_monthly_full:\n+  cmd.run:\n+    - name: /sbin/anacron -u cron.monthly\n+    - onlyif: test ! -s /var/spool/anacron/cron.monthly", "originalCommit": "2d2c3a7462469344badcf4baa90010926c5d92ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ3MDQ0MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7957#discussion_r419470441", "bodyText": "initial backup is a different state. also -u is for skipping the actual run", "author": "lacikaaa", "createdAt": "2020-05-04T14:17:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ2NzUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ4ODQzNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7957#discussion_r419488436", "bodyText": "no the anacron is not going to run the cron.monthly until at least 45 minutes after the initial instance creation and then have an up to 45 minute random delay added onto that.  Unless the instance creation is taking longer than that to reach that point it will be fine.  We can force this to not run by disabling anacron completely during the salt process and explicitly turn it on at the end of the salt run.  We can do this by putting 0anacron in the /etc/cron.hourly/jobs.deny file until we want to explicitly remove it.", "author": "wonderslug", "createdAt": "2020-05-04T14:41:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ2NzUzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU0NzI3Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7957#discussion_r419547277", "bodyText": "And actually on thinking about this.  In this case if the cron.monthly does get run prior to this that's fine, means it wont run the monthly till next month which is what we want anyways.", "author": "wonderslug", "createdAt": "2020-05-04T16:03:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ2NzUzOA=="}], "type": "inlineReview"}]}