{"pr_number": 8545, "pr_title": "CB-7741: Allow upgrade with same runtime and different GBN", "pr_createdAt": "2020-07-14T06:59:34Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8545", "timeline": [{"oid": "a3371c42292c1a89011901621c8e7b04ad4e02a8", "url": "https://github.com/hortonworks/cloudbreak/commit/a3371c42292c1a89011901621c8e7b04ad4e02a8", "message": "CB-7741: Allow upgrade with same runtime and different GBN", "committedDate": "2020-07-14T18:51:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3NjAwOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8545#discussion_r454976008", "bodyText": "pls do this in an NPE safe way", "author": "pdarvasi", "createdAt": "2020-07-15T11:16:34Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/ClusterUpgradeImageFilter.java", "diffHunk": "@@ -109,9 +116,11 @@ private boolean permitLockedComponentsUpgrade(Image currentImage, Image image) {\n         return currentImagePackageVersions.equals(imagePackageVersions);\n     }\n \n-    private boolean permitCmAndStackUpgrade(Image currentImage, Image image, String key) {\n-        return upgradePermissionProvider.permitCmAndStackUpgrade(currentImage.getPackageVersions().get(key),\n-                image.getPackageVersions().get(key));\n+    private boolean permitCmAndStackUpgrade(Image currentImage, Image image, String versionKey, String buildNumberKey) {\n+        String currentVersion = currentImage.getPackageVersions().get(versionKey);", "originalCommit": "a3371c42292c1a89011901621c8e7b04ad4e02a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk3NjI2MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8545#discussion_r454976261", "bodyText": "pls do this in an NPE safe way", "author": "pdarvasi", "createdAt": "2020-07-15T11:17:08Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/ClusterUpgradeImageFilter.java", "diffHunk": "@@ -109,9 +116,11 @@ private boolean permitLockedComponentsUpgrade(Image currentImage, Image image) {\n         return currentImagePackageVersions.equals(imagePackageVersions);\n     }\n \n-    private boolean permitCmAndStackUpgrade(Image currentImage, Image image, String key) {\n-        return upgradePermissionProvider.permitCmAndStackUpgrade(currentImage.getPackageVersions().get(key),\n-                image.getPackageVersions().get(key));\n+    private boolean permitCmAndStackUpgrade(Image currentImage, Image image, String versionKey, String buildNumberKey) {\n+        String currentVersion = currentImage.getPackageVersions().get(versionKey);\n+        String newVersion = image.getPackageVersions().get(versionKey);", "originalCommit": "a3371c42292c1a89011901621c8e7b04ad4e02a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk4MTc2NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8545#discussion_r454981764", "bodyText": "logically, this should be part of permitCmAndStackUpgrade method otherwise, it might be misleading, couldn't it?", "author": "pdarvasi", "createdAt": "2020-07-15T11:28:46Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/upgrade/ClusterUpgradeImageFilter.java", "diffHunk": "@@ -109,9 +116,11 @@ private boolean permitLockedComponentsUpgrade(Image currentImage, Image image) {\n         return currentImagePackageVersions.equals(imagePackageVersions);\n     }\n \n-    private boolean permitCmAndStackUpgrade(Image currentImage, Image image, String key) {\n-        return upgradePermissionProvider.permitCmAndStackUpgrade(currentImage.getPackageVersions().get(key),\n-                image.getPackageVersions().get(key));\n+    private boolean permitCmAndStackUpgrade(Image currentImage, Image image, String versionKey, String buildNumberKey) {\n+        String currentVersion = currentImage.getPackageVersions().get(versionKey);\n+        String newVersion = image.getPackageVersions().get(versionKey);\n+        return upgradePermissionProvider.permitCmAndStackUpgrade(currentVersion, newVersion)\n+                || (currentVersion.equals(newVersion) && componentBuildNumberComparator.compare(currentImage, image, buildNumberKey));", "originalCommit": "a3371c42292c1a89011901621c8e7b04ad4e02a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dca7652530d006b32d03dc71d2e8efdbcc8ed33b", "url": "https://github.com/hortonworks/cloudbreak/commit/dca7652530d006b32d03dc71d2e8efdbcc8ed33b", "message": "CB-7741: Allow upgrade with same runtime and different GBN", "committedDate": "2020-07-17T08:22:45Z", "type": "forcePushed"}, {"oid": "cb4786a9167697cc9d6432a5fdf508454827995d", "url": "https://github.com/hortonworks/cloudbreak/commit/cb4786a9167697cc9d6432a5fdf508454827995d", "message": "CB-7741: Allow upgrade with same runtime and different GBN", "committedDate": "2020-07-17T14:45:24Z", "type": "forcePushed"}, {"oid": "82a588d5127bb8b91ea457c3540e2805e4694b92", "url": "https://github.com/hortonworks/cloudbreak/commit/82a588d5127bb8b91ea457c3540e2805e4694b92", "message": "CB-7741: Allow upgrade with same runtime and different GBN", "committedDate": "2020-07-17T15:19:43Z", "type": "commit"}, {"oid": "82a588d5127bb8b91ea457c3540e2805e4694b92", "url": "https://github.com/hortonworks/cloudbreak/commit/82a588d5127bb8b91ea457c3540e2805e4694b92", "message": "CB-7741: Allow upgrade with same runtime and different GBN", "committedDate": "2020-07-17T15:19:43Z", "type": "forcePushed"}]}