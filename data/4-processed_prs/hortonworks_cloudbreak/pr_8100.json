{"pr_number": 8100, "pr_title": "DISTX-421 DISTX-427 Recommendation for host groups' scalability", "pr_createdAt": "2020-05-19T20:14:36Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8100", "timeline": [{"oid": "fd9e74b9be22955e108ab9df21a1800b5964c3d0", "url": "https://github.com/hortonworks/cloudbreak/commit/fd9e74b9be22955e108ab9df21a1800b5964c3d0", "message": "DISTX-421 DISTX-427 Recommendation for host groups' scalability\n\n1. Added recommendations for auto-scalability and manual scalability.\n2. Implemented CM service based recommendations.", "committedDate": "2020-05-20T05:45:08Z", "type": "forcePushed"}, {"oid": "5b07e74f8115a6232c571a3397d497694025b00a", "url": "https://github.com/hortonworks/cloudbreak/commit/5b07e74f8115a6232c571a3397d497694025b00a", "message": "DISTX-421 DISTX-427 Recommendation for host groups' scalability\n\n1. Fixed a bug with respect to HA template. Added a fix and unit test.", "committedDate": "2020-05-21T02:01:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ4MzMyNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428483327", "bodyText": "Splitting this into loadBasedScaling \\ timeBasedScaling will be good.", "author": "smaniraju", "createdAt": "2020-05-21T07:08:39Z", "path": "cloud-api/src/main/java/com/sequenceiq/cloudbreak/cloud/model/AutoscaleRecommendation.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.sequenceiq.cloudbreak.cloud.model;\n+\n+import java.util.Objects;\n+import java.util.Set;\n+\n+public class AutoscaleRecommendation {\n+\n+    private final Set<String> hostGroups;", "originalCommit": "5b07e74f8115a6232c571a3397d497694025b00a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5NTUzNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428495535", "bodyText": "Also will AutoscaleRecommendation be exposed as top level api BlueprintUtilV4Endpoint::getAutoscaleRecommendation(workspaceId,blueprintName) for validation in periscope against Autoscale CLI requests?  Something similar to BlueprintUtilV4Endpoint::getServicesByBlueprint. BlueprintUtilV4Endpoint::createRecommendation will not be usable from periscope since parameters like credentialName, region are not available.", "author": "smaniraju", "createdAt": "2020-05-21T07:39:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ4MzMyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk1MzU5Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428953596", "bodyText": "Split is done.", "author": "cegganesh84", "createdAt": "2020-05-21T22:40:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ4MzMyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4NjgyNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428986826", "bodyText": "This returns,\n\"autoscaleRecommendation\":{\"timeBasedHostGroups\":[\"compute\",\"gateway\"],\"loadBasedHostGroups\":[\"compute\"]},\"resizeRecommendation\":{\"scaleUpHostGroups\":[\"worker\",\"gateway\",\"compute\"],\"scaleDownHostGroups\":[\"worker\",\"gateway\",\"compute\"]}}\n\nI will check the generated swagger definition and see what apis to add.", "author": "cegganesh84", "createdAt": "2020-05-22T00:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ4MzMyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA5ODkxNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r429098917", "bodyText": "Yes this response looks good. All autoscaling related CB API  are accessed  via AutoscaleV4Endpoint. It would be nice if this is also exposed in that.", "author": "smaniraju", "createdAt": "2020-05-22T07:56:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ4MzMyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE5NDYzMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r432194630", "bodyText": "I will add the endpoint via a new PR.", "author": "cegganesh84", "createdAt": "2020-05-29T00:28:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ4MzMyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMzQzMA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428503430", "bodyText": "please include only compute.", "author": "smaniraju", "createdAt": "2020-05-21T07:57:48Z", "path": "core/src/main/java/com/sequenceiq/cloudbreak/service/stack/CloudResourceAdvisor.java", "diffHunk": "@@ -166,6 +177,56 @@ private boolean fallbackGatewayFilter(String hostGroupName) {\n                 || lowerName.contains(\"services\");\n     }\n \n+    private ResizeRecommendation recommendResize(BlueprintTextProcessor blueprintTextProcessor) {\n+        ResizeRecommendation resizeRecommendation = blueprintTextProcessor.recommendResize();\n+\n+        if (resizeRecommendation.getScaleUpHostGroups().isEmpty()) {\n+            Set<String> scaleUpHostGroups = filterHostGroupByPredicate(blueprintTextProcessor, this::fallbackScaleUpFilter);\n+            if (!scaleUpHostGroups.isEmpty()) {\n+                resizeRecommendation.setScaleUpHostGroups(scaleUpHostGroups);\n+            }\n+        }\n+        if (resizeRecommendation.getScaleDownHostGroups().isEmpty()) {\n+            Set<String> scaleDownHostGroups = filterHostGroupByPredicate(blueprintTextProcessor, this::fallbackScaleDownFilter);\n+            if (!scaleDownHostGroups.isEmpty()) {\n+                resizeRecommendation.setScaleDownHostGroups(scaleDownHostGroups);\n+            }\n+        }\n+\n+        return resizeRecommendation;\n+    }\n+\n+    private boolean fallbackScaleUpFilter(String hostGroupName) {\n+        String lowerCaseName = hostGroupName.toLowerCase();\n+        return !lowerCaseName.contains(\"master\")\n+                && !lowerCaseName.contains(\"manager\");\n+    }\n+\n+    private boolean fallbackScaleDownFilter(String hostGroupName) {\n+        String lowerCaseName = hostGroupName.toLowerCase();\n+        return !lowerCaseName.contains(\"master\")\n+                && !lowerCaseName.contains(\"manager\");\n+    }\n+\n+    private AutoscaleRecommendation recommendAutoscale(BlueprintTextProcessor blueprintTextProcessor) {\n+        AutoscaleRecommendation autoscaleRecommendation = blueprintTextProcessor.recommendAutoscale();\n+\n+        if (autoscaleRecommendation.getHostGroups().isEmpty()) {\n+            Set<String> autoscaleGroups = filterHostGroupByPredicate(blueprintTextProcessor, this::fallbackAutoscaleFilter);\n+            if (!autoscaleGroups.isEmpty()) {\n+                autoscaleRecommendation = new AutoscaleRecommendation(autoscaleGroups);\n+            }\n+        }\n+\n+        return autoscaleRecommendation;\n+    }\n+\n+    private boolean fallbackAutoscaleFilter(String hostGroupName) {\n+        String lowerCaseName = hostGroupName.toLowerCase();\n+        return lowerCaseName.contains(\"compute\")\n+                || lowerCaseName.contains(\"gateway\");\n+    }", "originalCommit": "5b07e74f8115a6232c571a3397d497694025b00a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk1MzcwNQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428953705", "bodyText": "Split it into time and load. Included only compute for load.", "author": "cegganesh84", "createdAt": "2020-05-21T22:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMzQzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA5OTI1NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r429099254", "bodyText": "\ud83d\udc4d", "author": "smaniraju", "createdAt": "2020-05-22T07:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwMzQzMA=="}], "type": "inlineReview"}, {"oid": "ec21277bfa4a6a628228de47979c328d757d0a38", "url": "https://github.com/hortonworks/cloudbreak/commit/ec21277bfa4a6a628228de47979c328d757d0a38", "message": "DISTX-421 DISTX-427 Recommendation for host groups' scalability\n\n1. Added recommendations for auto-scalability and manual scalability.\n2. Implemented both fallback recommendations and CM service based recommendations.\n3. Tested in private stack.", "committedDate": "2020-05-21T22:11:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NzQ2MQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428977461", "bodyText": "All of these will likely need to be qualified as ServiceName.RoleName at some point.\ne.g. Both HDFS and YARN have a Role called 'GATEWAY' - and I'm guessing other services do as well.", "author": "sidseth", "createdAt": "2020-05-22T00:05:43Z", "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/BlackListedLoadBasedAutoscaleRole.java", "diffHunk": "@@ -0,0 +1,12 @@\n+package com.sequenceiq.cloudbreak.cmtemplate;\n+\n+public enum BlackListedLoadBasedAutoscaleRole {\n+    DATANODE,\n+    ZEPPELIN_SERVER,\n+    KAFKA_BROKER,\n+    NIFI_NODE,\n+    NAMENODE,\n+    // This is counter intuitive. Gateway and compute host groups have identical GATEWAY roles. So compute host group will be blacklisted initially.\n+    // The fallback filter will add only compute host group for load based auto-scale role.\n+    GATEWAY", "originalCommit": "ec21277bfa4a6a628228de47979c328d757d0a38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4MzgwNg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428983806", "bodyText": "Yup, GATEWAY wipes off everything from the slate, rendering the service-based logic meaningless.", "author": "cegganesh84", "createdAt": "2020-05-22T00:30:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk3NzQ2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4MDA2Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428980067", "bodyText": "Using a blacklist will need all services from CM to be added in here; or make a new release of CB when we add new services.\nIf I'm not mistaken, with this set of services - the OperationDB (HBase) clusters will qualify for both Time and Load based AutoScaling.\nA Whitelist is an alternate, which comes with its own set of problems. i.e. if \"NODEMANAGER\" is the only role there, the GATEWAY roles that go along with the NODEMANAGER in a hostgroup will cause trouble.\nMaybe the GATEWAYs just need to be removed from processing. i.e. A GATEWAY (unless it is special) does not block a whitelisted role from being scaled, or in case of BLACKLISTING - GATEWAY roles are just filtered out. If that leads to no roles left for a hostGroup - the hostGroup is not scalable (but maybe we should allow this to be time scalable).\nI had a slightly different take on how this would work - based more on a 'Role' -> Capability mechanism - with all roles on a hostGroup combined together. A separate enum per capability (this patch) works as well.", "author": "sidseth", "createdAt": "2020-05-22T00:15:28Z", "path": "template-manager-cmtemplate/src/main/java/com/sequenceiq/cloudbreak/cmtemplate/BlackListedLoadBasedAutoscaleRole.java", "diffHunk": "@@ -0,0 +1,12 @@\n+package com.sequenceiq.cloudbreak.cmtemplate;\n+\n+public enum BlackListedLoadBasedAutoscaleRole {", "originalCommit": "ec21277bfa4a6a628228de47979c328d757d0a38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MTE1OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428991158", "bodyText": "Regarding OpDB\n[Gateway, Master, Leader, Worker] of these,\nTime based -> [Gateway, Leader] # Master has NAMENODE and Worker has DATANODE\nLoad based -> [] # Gateway and Leader has GATEWAY\nGeneral problem\nI was thinking of Blacklist filtering, followed by forceful whitelisting. Which is kind of acheived now using the fallback filter, just that it is counter-intuitive.\nWe have two fields in the CM template, roleType, refName. We see the problems with roleType. This is existing implementation for Nifi cluster, which works. However when force fitted into other templates, it struggles. RefName is interesting and what you asked for in the previous comment. NODEMANAGER for worker gets yarn-NODEMANAGER-WORKER and compute gets yarn-NODEMANAGER-COMPUTE. I am not sure if we can rely on this naming, and how it will change for custom templates.", "author": "cegganesh84", "createdAt": "2020-05-22T01:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4MDA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5NDgwOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r428994809", "bodyText": "roleType is what I was referring to. Service.RoleType fully qualifies an entity.\nYARN.NODEMANAGER\nYARN.GATEWAY\nHDFS.GATEWAY\nYup, OpDB will be handled because of the presence of the DataNode. Think it is easier to reason with 'Scaling supported only for NodeManager'.\nIAC, this works. The API for the UI, and whatever will be added for Periscope, remains unchanged irrespective of blacklist vs whitelist.\nAny thoughts on ignoring GATEWAYs in the processing?\nAlso, do we want to allow schedule policies to be defined for GATEWAY nodes? (What if Hue is running on one of these nodes - is that safe?. Should Hue be in the blacklist?)", "author": "sidseth", "createdAt": "2020-05-22T01:16:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4MDA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA3NDAyMQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r429074021", "bodyText": "Service.RoleType fully qualifies an entity.\nYARN.NODEMANAGER\n\nFor me it did not. I want to whitelist YARN.NODEMANAGER-COMPUTE. Here compute is placement. If I whitelist YARN.NODEMANAGER then worker is also whitelisted. We can over come that with first blacklist and then whitelist. Remove the ones with DATANODE then add the ones with NODEMANAGER.\nI chose DATANODE over NODEMANAGER for this reason.\n\nAny thoughts on ignoring GATEWAYs in the processing?\n\nYes, it depends on GATEWAY node support.\nWe can ignore GATEWAY nodes if it simplifies things. Hue is not a blocker, it can scale well. The Knox topology does not change. Hue sits behind CM controlled load-balancer. DAS, and Livy could be added as blacklists. Since we have not thought through this, we can ignore it for now.", "author": "cegganesh84", "createdAt": "2020-05-22T06:54:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4MDA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1MDE1Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r429450152", "bodyText": "YARN.NODEMANAGER-COMPUTE is a dynamic name, and can be renamed to anything in a custom template. Think you mentioned that further up as well. YARN.NODEMANAGER, however, is determined by CM.\nWe are not going to be testing gateway node auto-scaling. Also, I don't think we're allowing more than one autoScaling policy for a cluster at the moment. Think it is better to make sure the GATEWAY is not auto-scalable for the moment. There's also limited value in this, since the hostnames will change each time a scale operation is run.\nSo - we're going with a BLACKLIST for now, and trying to put enough in there to ensure that only the compute group can be automatically scaled.", "author": "sidseth", "createdAt": "2020-05-22T21:02:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4MDA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYzMTQ2OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r431631468", "bodyText": "Does it make sense to disable 'gateway' hosts from AutoScaling?, since we are not testing them.", "author": "sidseth", "createdAt": "2020-05-28T07:21:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4MDA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE5NDUwNA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r432194504", "bodyText": "Yep, I will remove both gateway role and gateway node group.", "author": "cegganesh84", "createdAt": "2020-05-29T00:27:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4MDA2Nw=="}], "type": "inlineReview"}, {"oid": "f01e264abe83b6922f2c38af61ec565f91715dd0", "url": "https://github.com/hortonworks/cloudbreak/commit/f01e264abe83b6922f2c38af61ec565f91715dd0", "message": "DISTX-421 DISTX-427 Recommendation for host groups' scalability\n\n1. Added recommendations for auto-scalability and manual scalability.\n2. Implemented both fallback recommendations and CM service based recommendations.\n3. Tested in private stack.", "committedDate": "2020-05-29T01:16:47Z", "type": "commit"}, {"oid": "f01e264abe83b6922f2c38af61ec565f91715dd0", "url": "https://github.com/hortonworks/cloudbreak/commit/f01e264abe83b6922f2c38af61ec565f91715dd0", "message": "DISTX-421 DISTX-427 Recommendation for host groups' scalability\n\n1. Added recommendations for auto-scalability and manual scalability.\n2. Implemented both fallback recommendations and CM service based recommendations.\n3. Tested in private stack.", "committedDate": "2020-05-29T01:16:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc5ODI2Ng==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r433798266", "bodyText": "Set.copyOf, below line as well please", "author": "bergerdenes", "createdAt": "2020-06-02T11:13:23Z", "path": "core-api/src/main/java/com/sequenceiq/cloudbreak/api/endpoint/v4/connector/responses/AutoscaleRecommendationV4Response.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.sequenceiq.cloudbreak.api.endpoint.v4.connector.responses;\n+\n+import java.util.Set;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.sequenceiq.common.model.JsonEntity;\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class AutoscaleRecommendationV4Response implements JsonEntity {\n+\n+    private final Set<String> timeBasedHostGroups;\n+\n+    private final Set<String> loadBasedHostGroups;\n+\n+    public AutoscaleRecommendationV4Response(Set<String> timeBasedHostGroups, Set<String> loadBasedHostGroups) {\n+        this.timeBasedHostGroups = timeBasedHostGroups;", "originalCommit": "f01e264abe83b6922f2c38af61ec565f91715dd0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc5ODUwOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8100#discussion_r433798508", "bodyText": "Set.copyOf, below line as well please", "author": "bergerdenes", "createdAt": "2020-06-02T11:13:54Z", "path": "core-api/src/main/java/com/sequenceiq/cloudbreak/api/endpoint/v4/connector/responses/ResizeRecommendationV4Response.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package com.sequenceiq.cloudbreak.api.endpoint.v4.connector.responses;\n+\n+import java.util.Set;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.sequenceiq.common.model.JsonEntity;\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class ResizeRecommendationV4Response implements JsonEntity {\n+\n+    private final Set<String> scaleUpHostGroups;\n+\n+    private final Set<String> scaleDownHostGroups;\n+\n+    public ResizeRecommendationV4Response(Set<String> scaleUpHostGroups, Set<String> scaleDownHostGroups) {\n+        this.scaleUpHostGroups = scaleUpHostGroups;", "originalCommit": "f01e264abe83b6922f2c38af61ec565f91715dd0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "70fa74b1ed16e26cf32ecd91de1de87b6a57c54b", "url": "https://github.com/hortonworks/cloudbreak/commit/70fa74b1ed16e26cf32ecd91de1de87b6a57c54b", "message": "Address review comments from Denes", "committedDate": "2020-06-03T22:47:38Z", "type": "commit"}]}