{"pr_number": 8379, "pr_title": "CB-7608: Modify FreeIPA backup to check if azure backup location host resolves", "pr_createdAt": "2020-06-23T13:30:05Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8379", "timeline": [{"oid": "9c810ab749f06907288b6516abb051904ddbe31a", "url": "https://github.com/hortonworks/cloudbreak/commit/9c810ab749f06907288b6516abb051904ddbe31a", "message": "CB-7608: Modify FreeIPA backup to check if azure backup location host resolves\n\nThis modifies the FreeIPA backup script to check if the backup location\nhost is valid. This is for azure only because the storage location\nis a customer provided hostname based on the storage account being used.\n\nCloses #CB-7608", "committedDate": "2020-06-23T18:15:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2MDEwOA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8379#discussion_r444460108", "bodyText": "Is there a reason to have double quotes nextto each other? echo \"$(date \"+%Y-%m-%dT%H:%M:%SZ\") $type_of_msg $msg\" > \"${STATUSFILEPREFIX}${BACKUP_SCHEDULE}\".log might be a little cleaner.", "author": "jamisonbennett", "createdAt": "2020-06-23T19:34:33Z", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_backup", "diffHunk": "@@ -93,25 +111,25 @@ elif [[ \"$TYPE\" = \"DATA\" ]]; then\n fi\n \n doLog(){\n-    type_of_msg=$(echo $*|cut -d\" \" -f1)\n+    type_of_msg=$(echo \"$*\"|cut -d\" \" -f1)\n     msg=$(echo \"$*\"|cut -d\" \" -f2-)\n-    [[ $type_of_msg == DEBUG ]] && [[ $do_print_debug_msgs -ne 1 ]] && return\n+    [[ $type_of_msg == DEBUG ]] && [[ ${PRINT_DEBUG_MSGS} -ne 1 ]] && return\n     [[ $type_of_msg == INFO ]] && type_of_msg=\"INFO \" # one space for aligning\n     [[ $type_of_msg == WARN ]] && type_of_msg=\"WARN \" # as well\n \n     # print to the terminal if we have one\n-    test -t 1 && echo \"`date \"+%Y-%m-%dT%H:%M:%SZ\"` $type_of_msg \"\"$msg\"\n-    echo \"`date \"+%Y-%m-%dT%H:%M:%SZ\"` $type_of_msg \"\"$msg\" >> $LOGFILE\n+    test -t 1 && echo \"$(date \"+%Y-%m-%dT%H:%M:%SZ\") $type_of_msg \"\"$msg\"\n+    echo \"$(date \"+%Y-%m-%dT%H:%M:%SZ\") $type_of_msg \"\"$msg\" >> \"${LOGFILE}\"\n }\n \n doStatus(){\n     if [[ -n \"$BACKUP_SCHEDULE\" ]]\n     then\n-        type_of_msg=$(echo $*|cut -d\" \" -f1)\n+        type_of_msg=$(echo \"$*\"|cut -d\" \" -f1)\n         msg=$(echo \"$*\"|cut -d\" \" -f2-)\n         [[ $type_of_msg == INFO ]] && type_of_msg=\"INFO \" # one space for aligning\n \n-        echo \"`date \"+%Y-%m-%dT%H:%M:%SZ\"` $type_of_msg $msg\" > $STATUSFILEPREFIX$BACKUP_SCHEDULE.log\n+        echo \"$(date \"+%Y-%m-%dT%H:%M:%SZ\") $type_of_msg $msg\" > \"${STATUSFILEPREFIX}\"\"${BACKUP_SCHEDULE}\".log", "originalCommit": "9c810ab749f06907288b6516abb051904ddbe31a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ5MDI2MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8379#discussion_r444490260", "bodyText": "fixed", "author": "wonderslug", "createdAt": "2020-06-23T20:33:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2MDEwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2MTM3MA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8379#discussion_r444461370", "bodyText": "Is there a reason the double quotes are back to back?\nWouldn't BACKUPDIR=$(basename \"$(ls -td \"${config[backup_path]}/ipa-*\" | head -1)\") be simpler?", "author": "jamisonbennett", "createdAt": "2020-06-23T19:37:14Z", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_backup", "diffHunk": "@@ -158,8 +176,12 @@ exlock_now || error_exit \"A backup seems to be currently running. Lock file is a\n #set -x\n \n # Perform a backup\n-/sbin/ipa-backup $BACKUP_OPTIONS >> $LOGFILE 2>&1 || error_exit \"ipa-backup failed! Aborting!\"\n-BACKUPDIR=$(basename $(ls -td ${config[backup_path]}/ipa-* | head -1))\n+\n+# shellcheck disable=SC2086\n+/sbin/ipa-backup ${BACKUP_OPTIONS} >> \"${LOGFILE}\" 2>&1 || error_exit \"ipa-backup failed! Aborting!\"\n+\n+# shellcheck disable=SC2012\n+BACKUPDIR=$(basename \"$(ls -td \"${config[backup_path]}\"\"/ipa-*\" | head -1)\")", "originalCommit": "9c810ab749f06907288b6516abb051904ddbe31a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ5MDIxNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8379#discussion_r444490217", "bodyText": "fixed", "author": "wonderslug", "createdAt": "2020-06-23T20:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2MTM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2MjM0Nw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8379#discussion_r444462347", "bodyText": "Same thing with double quoting here on these two lines.", "author": "jamisonbennett", "createdAt": "2020-06-23T19:39:15Z", "path": "freeipa/src/main/resources/freeipa-salt/salt/freeipa/scripts/freeipa_backup", "diffHunk": "@@ -93,25 +111,25 @@ elif [[ \"$TYPE\" = \"DATA\" ]]; then\n fi\n \n doLog(){\n-    type_of_msg=$(echo $*|cut -d\" \" -f1)\n+    type_of_msg=$(echo \"$*\"|cut -d\" \" -f1)\n     msg=$(echo \"$*\"|cut -d\" \" -f2-)\n-    [[ $type_of_msg == DEBUG ]] && [[ $do_print_debug_msgs -ne 1 ]] && return\n+    [[ $type_of_msg == DEBUG ]] && [[ ${PRINT_DEBUG_MSGS} -ne 1 ]] && return\n     [[ $type_of_msg == INFO ]] && type_of_msg=\"INFO \" # one space for aligning\n     [[ $type_of_msg == WARN ]] && type_of_msg=\"WARN \" # as well\n \n     # print to the terminal if we have one\n-    test -t 1 && echo \"`date \"+%Y-%m-%dT%H:%M:%SZ\"` $type_of_msg \"\"$msg\"\n-    echo \"`date \"+%Y-%m-%dT%H:%M:%SZ\"` $type_of_msg \"\"$msg\" >> $LOGFILE\n+    test -t 1 && echo \"$(date \"+%Y-%m-%dT%H:%M:%SZ\") $type_of_msg \"\"$msg\"\n+    echo \"$(date \"+%Y-%m-%dT%H:%M:%SZ\") $type_of_msg \"\"$msg\" >> \"${LOGFILE}\"", "originalCommit": "9c810ab749f06907288b6516abb051904ddbe31a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ5MDE4NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8379#discussion_r444490184", "bodyText": "fixed", "author": "wonderslug", "createdAt": "2020-06-23T20:33:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2MjM0Nw=="}], "type": "inlineReview"}, {"oid": "dbb4a80efbec9f3715367686aee70c414f0b9971", "url": "https://github.com/hortonworks/cloudbreak/commit/dbb4a80efbec9f3715367686aee70c414f0b9971", "message": "CB-7608: Modify FreeIPA backup to check if azure backup location host resolves\n\nThis modifies the FreeIPA backup script to check if the backup location\nhost is valid. This is for azure only because the storage location\nis a customer provided hostname based on the storage account being used.\n\nCloses #CB-7608", "committedDate": "2020-06-23T20:31:53Z", "type": "commit"}, {"oid": "dbb4a80efbec9f3715367686aee70c414f0b9971", "url": "https://github.com/hortonworks/cloudbreak/commit/dbb4a80efbec9f3715367686aee70c414f0b9971", "message": "CB-7608: Modify FreeIPA backup to check if azure backup location host resolves\n\nThis modifies the FreeIPA backup script to check if the backup location\nhost is valid. This is for azure only because the storage location\nis a customer provided hostname based on the storage account being used.\n\nCloses #CB-7608", "committedDate": "2020-06-23T20:31:53Z", "type": "forcePushed"}]}