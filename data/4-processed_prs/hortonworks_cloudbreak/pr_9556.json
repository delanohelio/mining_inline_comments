{"pr_number": 9556, "pr_title": "CB-10085", "pr_createdAt": "2020-12-02T11:53:17Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/9556", "timeline": [{"oid": "28f710d7c0dbbb96b08b964c809659a368d52278", "url": "https://github.com/hortonworks/cloudbreak/commit/28f710d7c0dbbb96b08b964c809659a368d52278", "message": "CB-10085 adding AccountIdAwareResource as the base class of AccountAwareResource. Secret aspect will be able to read the account information from any object with this change. Currently secret ascpect try to use AccountIdAwareResource which iswas removed eas part of the structured event effort. Vault pathes will be fixed and we will not point to undefined path. As a followup I will remove the 'undefined' logic from secret aspect because it is risky and hiding potential problems.", "committedDate": "2020-12-02T11:52:23Z", "type": "commit"}, {"oid": "ed8abaed5d7e8a5c9b5fa137f0cc1f249b0ee94a", "url": "https://github.com/hortonworks/cloudbreak/commit/ed8abaed5d7e8a5c9b5fa137f0cc1f249b0ee94a", "message": "CB-10085 update SecretAspectService with a necessary exception to catch every object write where we dont have account id. It should not happen that an object which has secret value do not have account id.", "committedDate": "2020-12-02T11:56:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE2MjM2Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9556#discussion_r534162362", "bodyText": "Nit: Perhaps replace the hardwired class name with AccountIdAwareResource.class.getSimpleName() like a few lines below in findAccountId().", "author": "lajosrodek", "createdAt": "2020-12-02T13:22:50Z", "path": "secret-engine/src/main/java/com/sequenceiq/cloudbreak/service/secret/service/SecretAspectService.java", "diffHunk": "@@ -52,7 +52,7 @@ public Object proceedSave(ProceedingJoinPoint proceedingJoinPoint) {\n                     }\n                 }\n             } catch (IllegalArgumentException e) {\n-                LOGGER.error(\"Given entity isn't instance of TenantAwareResource. Secret is not deleted!\", e);\n+                LOGGER.error(\"Given entity isn't instance of AccountIdAwareResource. Secret is not deleted!\", e);", "originalCommit": "ed8abaed5d7e8a5c9b5fa137f0cc1f249b0ee94a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE2MjY0Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9556#discussion_r534162642", "bodyText": "Same here.", "author": "lajosrodek", "createdAt": "2020-12-02T13:23:16Z", "path": "secret-engine/src/main/java/com/sequenceiq/cloudbreak/service/secret/service/SecretAspectService.java", "diffHunk": "@@ -92,7 +92,7 @@ public Object proceedDelete(ProceedingJoinPoint proceedingJoinPoint) {\n                     }\n                 }\n             } catch (IllegalArgumentException e) {\n-                LOGGER.error(\"Given entity isn't instance of TenantAwareResource. Secret is not deleted!\", e);\n+                LOGGER.error(\"Given entity isn't instance of AccountIdAwareResource. Secret is not deleted!\", e);", "originalCommit": "ed8abaed5d7e8a5c9b5fa137f0cc1f249b0ee94a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0099086670f95381377a8d7e760d9420d1bbb51b", "url": "https://github.com/hortonworks/cloudbreak/commit/0099086670f95381377a8d7e760d9420d1bbb51b", "message": " CB-10085 update SecretAspectService with a necessary exception to catch every object write where we dont have account id. It should not happen that an object which has secret value do not have account id.", "committedDate": "2020-12-02T18:58:22Z", "type": "forcePushed"}, {"oid": "f9f8772bc36876dfbe361c426115b5b71ab671a0", "url": "https://github.com/hortonworks/cloudbreak/commit/f9f8772bc36876dfbe361c426115b5b71ab671a0", "message": " CB-10085 update SecretAspectService with a necessary exception to catch every object write where we dont have account id. It should not happen that an object which has secret value do not have account id.", "committedDate": "2020-12-02T19:22:43Z", "type": "forcePushed"}, {"oid": "8b77619afb54390e8b495e6605dc8a069732500e", "url": "https://github.com/hortonworks/cloudbreak/commit/8b77619afb54390e8b495e6605dc8a069732500e", "message": " CB-10085 update SecretAspectService with a necessary exception to catch every object write where we dont have account id. It should not happen that an object which has secret value do not have account id.", "committedDate": "2020-12-02T20:51:22Z", "type": "commit"}, {"oid": "8b77619afb54390e8b495e6605dc8a069732500e", "url": "https://github.com/hortonworks/cloudbreak/commit/8b77619afb54390e8b495e6605dc8a069732500e", "message": " CB-10085 update SecretAspectService with a necessary exception to catch every object write where we dont have account id. It should not happen that an object which has secret value do not have account id.", "committedDate": "2020-12-02T20:51:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE1NDEwMg==", "url": "https://github.com/hortonworks/cloudbreak/pull/9556#discussion_r535154102", "bodyText": "Default value shouldn't be added like this. It will block the whole table.\nSee https://dba.stackexchange.com/questions/60965/does-postgresql-optimize-adding-columns-with-non-null-defaults/216153#216153\nExample: https://github.com/hortonworks/cloudbreak/blob/master/core/src/main/resources/schema/app/20201130155647_CB-9580_new_field_on_cluster:_embedded_db_is_configured_on_attached_disk_or_not.sql\nAlso I think we should set it to null.", "author": "keyki", "createdAt": "2020-12-03T11:49:27Z", "path": "freeipa/src/main/resources/schema/app/20201203102940_CB-10140_add_accountId_to_freeipa_SaltSecurityConfig.sql", "diffHunk": "@@ -0,0 +1,11 @@\n+-- // CB-10140 add accountId to freeipa SaltSecurityConfig\n+-- Migration SQL that makes the change goes here.\n+\n+ALTER TABLE saltsecurityconfig ADD COLUMN IF NOT EXISTS accountid VARCHAR(255) DEFAULT 'undefined';", "originalCommit": "89c6d9b330ad1a2f43184e1d72eea522fe2b4263", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE1OTI0OQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/9556#discussion_r535159249", "bodyText": "done", "author": "doktoric", "createdAt": "2020-12-03T11:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE1NDEwMg=="}], "type": "inlineReview"}, {"oid": "14b757bba995f47f55aa8ae252c93b35a2e7b49a", "url": "https://github.com/hortonworks/cloudbreak/commit/14b757bba995f47f55aa8ae252c93b35a2e7b49a", "message": "CB-10140 adding saltsecurityconfig accountid to the current domain to be able to write into vault", "committedDate": "2020-12-03T11:52:47Z", "type": "forcePushed"}, {"oid": "d123c52c07ed7a5458bda91b604957aaf112b828", "url": "https://github.com/hortonworks/cloudbreak/commit/d123c52c07ed7a5458bda91b604957aaf112b828", "message": "CB-10140 adding saltsecurityconfig accountid to the current domain to be able to write into vault", "committedDate": "2020-12-03T11:54:41Z", "type": "commit"}, {"oid": "d123c52c07ed7a5458bda91b604957aaf112b828", "url": "https://github.com/hortonworks/cloudbreak/commit/d123c52c07ed7a5458bda91b604957aaf112b828", "message": "CB-10140 adding saltsecurityconfig accountid to the current domain to be able to write into vault", "committedDate": "2020-12-03T11:54:41Z", "type": "forcePushed"}]}