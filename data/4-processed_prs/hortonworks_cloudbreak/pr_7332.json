{"pr_number": 7332, "pr_title": "CB-5636. E2E tests: ABFS logs are missing from idbroker host.", "pr_createdAt": "2020-02-19T22:07:06Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/7332", "timeline": [{"oid": "e5df958b69422a6896e095cf75aa3c165bb3ed8c", "url": "https://github.com/hortonworks/cloudbreak/commit/e5df958b69422a6896e095cf75aa3c165bb3ed8c", "message": "CB-5636. ABFS logs are missing from idbroker host.", "committedDate": "2020-02-19T23:58:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg1NTczOQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/7332#discussion_r381855739", "bodyText": "Hmm, this is certainly wrong as it overwrites the value just retrieved in the previous line. \ud83d\ude04", "author": "lajosrodek", "createdAt": "2020-02-20T08:47:24Z", "path": "orchestrator-salt/src/main/resources/salt-common/salt/fluent/settings.sls", "diffHunk": "@@ -36,6 +36,8 @@\n {% set s3_log_bucket = salt['pillar.get']('fluent:s3LogArchiveBucketName') %}\n {% set azure_container = salt['pillar.get']('fluent:azureContainer') %}\n {% set azure_storage_instance_msi = salt['pillar.get']('fluent:azureInstanceMsi') %}\n+{% set azure_storage_instance_msi = salt['pillar.get']('fluent:azureIdBrokerInstanceMsi') %}", "originalCommit": "e5df958b69422a6896e095cf75aa3c165bb3ed8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg1ODgzNw==", "url": "https://github.com/hortonworks/cloudbreak/pull/7332#discussion_r381858837", "bodyText": "At first sight this did not make sense to me as log shipping normally does not work on the IDBroker node (see CB-5107). I guess this setting only works in case of internal E2E testing when the IDBroker VM MSI (i.e. the assumer identity) also contains the necessary role assignment for accessing the log storage account location. And similarly for AWS, the IDBroker EC2 instance profile role should have a policy for accessing the log S3 bucket.", "author": "lajosrodek", "createdAt": "2020-02-20T08:53:17Z", "path": "orchestrator-salt/src/main/resources/salt-common/salt/fluent/template/output.conf.j2", "diffHunk": "@@ -56,7 +56,11 @@\n     azure_storage_account    {{fluent.azureStorageAccount}}\n     azure_container          {{fluent.azureContainer}}\n {% if fluent.azureInstanceMsi is defined and fluent.azureInstanceMsi is not none and fluent.azureInstanceMsi %}\n+    {% if grains['hostgroup'] == \"idbroker\" %}\n+    azure_instance_msi       {{fluent.azureIdBrokerInstanceMsi}}", "originalCommit": "e5df958b69422a6896e095cf75aa3c165bb3ed8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg5MjM0Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/7332#discussion_r381892342", "bodyText": "just to answer that here as well, it's better now to fail during log shipping (because of the lack of proper contributor roles), then fail during obtaining the azure access token (because of wrong vm identity). some would happen for AWS if idbroker instance profile does not have the right policies", "author": "oleewere", "createdAt": "2020-02-20T09:53:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg1ODgzNw=="}], "type": "inlineReview"}, {"oid": "53c48869632de35844bcaa800bd2a8d7ce1f8b84", "url": "https://github.com/hortonworks/cloudbreak/commit/53c48869632de35844bcaa800bd2a8d7ce1f8b84", "message": "CB-5636. ABFS logs are missing from idbroker host.", "committedDate": "2020-02-20T09:10:34Z", "type": "forcePushed"}, {"oid": "c18511889815f7ec36412120e5f38e209f7d9ae3", "url": "https://github.com/hortonworks/cloudbreak/commit/c18511889815f7ec36412120e5f38e209f7d9ae3", "message": "CB-5636. ABFS logs are missing from idbroker host.", "committedDate": "2020-02-20T11:17:06Z", "type": "forcePushed"}, {"oid": "241431a8aaff1d6f5108e813c41d6318f74e9005", "url": "https://github.com/hortonworks/cloudbreak/commit/241431a8aaff1d6f5108e813c41d6318f74e9005", "message": "CB-5636. ABFS logs are missing from idbroker host.", "committedDate": "2020-02-20T12:09:52Z", "type": "forcePushed"}, {"oid": "9df689ca9707059e327aab34c1edaffde033c449", "url": "https://github.com/hortonworks/cloudbreak/commit/9df689ca9707059e327aab34c1edaffde033c449", "message": "CB-5636. ABFS logs are missing from idbroker host.", "committedDate": "2020-02-20T12:15:01Z", "type": "forcePushed"}, {"oid": "ebf0963e5aca90eaecb30c3aefef19b0d504fdbd", "url": "https://github.com/hortonworks/cloudbreak/commit/ebf0963e5aca90eaecb30c3aefef19b0d504fdbd", "message": "CB-5636. ABFS logs are missing from idbroker host.", "committedDate": "2020-02-20T12:59:39Z", "type": "forcePushed"}, {"oid": "7e4253ff52601a13bdeb54ccbb9a0d840de66369", "url": "https://github.com/hortonworks/cloudbreak/commit/7e4253ff52601a13bdeb54ccbb9a0d840de66369", "message": "CB-5636. ABFS logs are missing from idbroker host.", "committedDate": "2020-02-20T13:13:21Z", "type": "commit"}, {"oid": "7e4253ff52601a13bdeb54ccbb9a0d840de66369", "url": "https://github.com/hortonworks/cloudbreak/commit/7e4253ff52601a13bdeb54ccbb9a0d840de66369", "message": "CB-5636. ABFS logs are missing from idbroker host.", "committedDate": "2020-02-20T13:13:21Z", "type": "forcePushed"}]}