{"pr_number": 8149, "pr_title": "DISTX-471 Periscope Entitlement Service Integration", "pr_createdAt": "2020-05-23T09:01:59Z", "pr_url": "https://github.com/hortonworks/cloudbreak/pull/8149", "timeline": [{"oid": "1e0acc8d2678d3e2dcbd3d535d2c770621efc690", "url": "https://github.com/hortonworks/cloudbreak/commit/1e0acc8d2678d3e2dcbd3d535d2c770621efc690", "message": "DISTX-399 Service Endpoint Tests", "committedDate": "2020-05-23T10:50:33Z", "type": "forcePushed"}, {"oid": "03f0a153aa7bd1856f3e256b7efdbedbfb68628d", "url": "https://github.com/hortonworks/cloudbreak/commit/03f0a153aa7bd1856f3e256b7efdbedbfb68628d", "message": "DISTX-399 Service Endpoint Tests", "committedDate": "2020-05-23T16:22:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3OTQ0NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8149#discussion_r429579444", "bodyText": "The handler for this ends up putting a cluster in the SUSPENDED state even if it already in the SUSPENDED state, which will end up being an unnecessary DB operation every minute for STOPPED clusters. Would be useful to avoid that.\nAlso, this will result in all known clusters being polled every minute from Cloudbreak. I think we should introduce a more light weigh API than the on that returns all Stack details (obviously a different PR for this).", "author": "sidseth", "createdAt": "2020-05-23T21:25:04Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/monitor/evaluator/ClusterStateEvaluator.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package com.sequenceiq.periscope.monitor.evaluator;\n+\n+import javax.annotation.Nonnull;\n+import javax.inject.Inject;\n+\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.stereotype.Component;\n+\n+import com.sequenceiq.periscope.monitor.context.ClusterIdEvaluatorContext;\n+import com.sequenceiq.periscope.monitor.context.EvaluatorContext;\n+import com.sequenceiq.periscope.monitor.event.UpdateFailedEvent;\n+\n+@Component(\"ClusterStateEvaluator\")\n+@Scope(\"prototype\")\n+public class ClusterStateEvaluator extends EvaluatorExecutor {\n+\n+    private static final String EVALUATOR_NAME = ClusterStateEvaluator.class.getName();\n+\n+    @Inject\n+    private EventPublisher eventPublisher;\n+\n+    private long clusterId;\n+\n+    @Override\n+    public void setContext(EvaluatorContext context) {\n+        clusterId = (long) context.getData();\n+    }\n+\n+    @Override\n+    @Nonnull\n+    public EvaluatorContext getContext() {\n+        return new ClusterIdEvaluatorContext(clusterId);\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return EVALUATOR_NAME;\n+    }\n+\n+    @Override\n+    public void execute() {\n+        eventPublisher.publishEvent(new UpdateFailedEvent(clusterId));", "originalCommit": "03f0a153aa7bd1856f3e256b7efdbedbfb68628d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3NjU5NA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8149#discussion_r429776594", "bodyText": "Removed DB Hit. For CB Sync optimization I have already created this jira. https://jira.cloudera.com/browse/CB-6619", "author": "smaniraju", "createdAt": "2020-05-25T07:33:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3OTQ0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3OTUwMw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8149#discussion_r429579503", "bodyText": "Accidental change? or should this be test. Also other places where this change is made.", "author": "sidseth", "createdAt": "2020-05-23T21:26:04Z", "path": "autoscale/src/test/java/com/sequenceiq/periscope/modul/rejected/RejectedThreadContext.java", "diffHunk": "@@ -59,6 +60,7 @@\n     @MockBean({Clock.class, ClusterService.class, CloudbreakClientConfiguration.class,\n             MetricUtils.class, InternalCrnBuilder.class, FailedNodeRepository.class})\n     @EnableAsync\n+    @Profile(\"dev\")", "originalCommit": "03f0a153aa7bd1856f3e256b7efdbedbfb68628d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3NTk3Mw==", "url": "https://github.com/hortonworks/cloudbreak/pull/8149#discussion_r429775973", "bodyText": "This is correct, this context is used to setup specific thread pool size for dev mode testing.", "author": "smaniraju", "createdAt": "2020-05-25T07:31:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3OTUwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3OTU0OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8149#discussion_r429579548", "bodyText": "What should this be?", "author": "sidseth", "createdAt": "2020-05-23T21:27:13Z", "path": "autoscale/src/test/java/com/sequenceiq/periscope/testcontext/EndpointTestContext.java", "diffHunk": "@@ -0,0 +1,16 @@\n+package com.sequenceiq.periscope.testcontext;\n+\n+import org.springframework.boot.autoconfigure.domain.EntityScan;\n+import org.springframework.boot.test.context.TestConfiguration;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.context.annotation.Profile;\n+\n+import com.sequenceiq.cloudbreak.service.secret.service.SecretService;\n+\n+@TestConfiguration\n+@EntityScan(basePackages = {\"com.sequenceiq.periscope\"})\n+@Profile(\"test\")", "originalCommit": "03f0a153aa7bd1856f3e256b7efdbedbfb68628d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3NDI4Mg==", "url": "https://github.com/hortonworks/cloudbreak/pull/8149#discussion_r429774282", "bodyText": "It is test and runs in unit test cycle.", "author": "smaniraju", "createdAt": "2020-05-25T07:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3OTU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3OTU2NQ==", "url": "https://github.com/hortonworks/cloudbreak/pull/8149#discussion_r429579565", "bodyText": "Names changes to DATAHUB_ instead of CDP_", "author": "sidseth", "createdAt": "2020-05-23T21:27:31Z", "path": "autoscale/src/main/java/com/sequenceiq/periscope/service/EntitlementValidationService.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package com.sequenceiq.periscope.service;\n+\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.cache.annotation.Cacheable;\n+import org.springframework.stereotype.Service;\n+\n+import com.sequenceiq.cloudbreak.auth.altus.EntitlementService;\n+\n+@Service\n+public class EntitlementValidationService {\n+\n+    private static final String ALLOWED = \"ALLOWED_PLATFORM\";\n+\n+    private static final Map<String, String> PLATFORM_ENTITLEMENTS = Map.of(\n+            \"AWS\", \"CDP_AWS_AUTOSCALING\",", "originalCommit": "03f0a153aa7bd1856f3e256b7efdbedbfb68628d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3Mzk0OA==", "url": "https://github.com/hortonworks/cloudbreak/pull/8149#discussion_r429773948", "bodyText": "ack", "author": "smaniraju", "createdAt": "2020-05-25T07:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3OTU2NQ=="}], "type": "inlineReview"}, {"oid": "bcbc0eb1bcea351df8c41b3e8709fa5fedcea5a8", "url": "https://github.com/hortonworks/cloudbreak/commit/bcbc0eb1bcea351df8c41b3e8709fa5fedcea5a8", "message": "DISTX-399 Service Endpoint Tests", "committedDate": "2020-05-25T08:34:40Z", "type": "commit"}, {"oid": "bcbc0eb1bcea351df8c41b3e8709fa5fedcea5a8", "url": "https://github.com/hortonworks/cloudbreak/commit/bcbc0eb1bcea351df8c41b3e8709fa5fedcea5a8", "message": "DISTX-399 Service Endpoint Tests", "committedDate": "2020-05-25T08:34:40Z", "type": "forcePushed"}]}