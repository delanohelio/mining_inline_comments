{"pr_number": 1151, "pr_title": "IntelliJ: Format on save when using PJF", "pr_createdAt": "2020-01-08T17:58:20Z", "pr_url": "https://github.com/palantir/gradle-baseline/pull/1151", "timeline": [{"oid": "88d61484b16d15720090138236b3d262b7b972d5", "url": "https://github.com/palantir/gradle-baseline/commit/88d61484b16d15720090138236b3d262b7b972d5", "message": "Suggest and preconfigure save-actions if PJF is enabled", "committedDate": "2020-01-08T15:23:43Z", "type": "commit"}, {"oid": "b01f17a39c1e5e895377103eb23808ca86f5f165", "url": "https://github.com/palantir/gradle-baseline/commit/b01f17a39c1e5e895377103eb23808ca86f5f165", "message": "rename", "committedDate": "2020-01-08T15:28:28Z", "type": "commit"}, {"oid": "9058c1bf889829901d42a3a9765e233702f79e51", "url": "https://github.com/palantir/gradle-baseline/commit/9058c1bf889829901d42a3a9765e233702f79e51", "message": "Separate groovy and java because sigh", "committedDate": "2020-01-08T15:33:23Z", "type": "commit"}, {"oid": "6859e2529297c7b8174e34a6c44814cd9c6565d1", "url": "https://github.com/palantir/gradle-baseline/commit/6859e2529297c7b8174e34a6c44814cd9c6565d1", "message": "fix", "committedDate": "2020-01-08T15:36:31Z", "type": "commit"}, {"oid": "f8461cdb5c21aed1ec6357678a67a95a085ab9f7", "url": "https://github.com/palantir/gradle-baseline/commit/f8461cdb5c21aed1ec6357678a67a95a085ab9f7", "message": "fix", "committedDate": "2020-01-08T15:58:04Z", "type": "commit"}, {"oid": "9a5618d9643a9f88ec4765004aff80b3e34fba38", "url": "https://github.com/palantir/gradle-baseline/commit/9a5618d9643a9f88ec4765004aff80b3e34fba38", "message": "verify that IPR is configured", "committedDate": "2020-01-08T15:58:23Z", "type": "commit"}, {"oid": "092f321eb0e4bfe7fafd0a89419275ca95623904", "url": "https://github.com/palantir/gradle-baseline/commit/092f321eb0e4bfe7fafd0a89419275ca95623904", "message": "add no-op test as well, rename for clarity", "committedDate": "2020-01-08T16:01:15Z", "type": "commit"}, {"oid": "7eaae0a4799a85480e1f372bf4f39b2e84231d49", "url": "https://github.com/palantir/gradle-baseline/commit/7eaae0a4799a85480e1f372bf4f39b2e84231d49", "message": "Move stuff to BaselineIdea and only apply on root!!!", "committedDate": "2020-01-08T17:15:14Z", "type": "commit"}, {"oid": "ce47937a3f3c0fac42ae9c5be261bfbe5fb6a3f7", "url": "https://github.com/palantir/gradle-baseline/commit/ce47937a3f3c0fac42ae9c5be261bfbe5fb6a3f7", "message": "use the right id... WOT", "committedDate": "2020-01-08T17:39:06Z", "type": "commit"}, {"oid": "905a038734b12beee23fb4d57fff291737250b67", "url": "https://github.com/palantir/gradle-baseline/commit/905a038734b12beee23fb4d57fff291737250b67", "message": "Add generated changelog entries", "committedDate": "2020-01-08T17:38:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM2OTQwMQ==", "url": "https://github.com/palantir/gradle-baseline/pull/1151#discussion_r364369401", "bodyText": "nice", "author": "ferozco", "createdAt": "2020-01-08T18:09:19Z", "path": "gradle-baseline-java/src/main/groovy/com/palantir/baseline/plugins/BaselineIdea.groovy", "diffHunk": "@@ -311,4 +329,31 @@ class BaselineIdea extends AbstractBaselinePlugin {\n             module.dependencies.addAll(projectRefs)\n         }\n     }\n+\n+    /**\n+     * Configures some defaults on the save-actions plugin, but only if it hasn't been configured before.\n+     */\n+    private static void configureSaveActions(Node rootNode) {\n+        GroovyXmlUtils.matchOrCreateChild(rootNode, 'component', [name: 'SaveActionSettings'], [:]) {\n+            // Configure defaults if this plugin is configured for the first time only\n+            appendNode('option', [name: 'actions']).appendNode('set').with {\n+                appendNode('option', [value: 'activate'])\n+                appendNode('option', [value: 'noActionIfCompileErrors'])\n+                appendNode('option', [value: 'organizeImports'])\n+                appendNode('option', [value: 'reformat'])\n+            }\n+            appendNode('option', [name: 'configurationPath', value: ''])\n+            appendNode('inclusions').appendNode('set').with {\n+                appendNode('option', [value: 'src/.*\\\\.java'])", "originalCommit": "905a038734b12beee23fb4d57fff291737250b67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY5NDAzNA==", "url": "https://github.com/palantir/gradle-baseline/pull/1151#discussion_r364694034", "bodyText": "Yep, so it's a bit tricky as if people already use this plugin (and have configured it for a project) then we do nothing.. but in the majority of cases, this is probably what people want.\nAn unsolved problem I will add to the description is how to deal with changing flags / how do we know what's safe to update because we set it up that way vs the user set it up that way.", "author": "dansanduleac", "createdAt": "2020-01-09T11:39:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM2OTQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc3NjU2MA==", "url": "https://github.com/palantir/gradle-baseline/pull/1151#discussion_r364776560", "bodyText": "I'd have to look into what other options the plugin exposes, but we may want to narrow what users can configure to a very narrow set of flags", "author": "ferozco", "createdAt": "2020-01-09T14:45:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM2OTQwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM3Mjc5NQ==", "url": "https://github.com/palantir/gradle-baseline/pull/1151#discussion_r364372795", "bodyText": "spacing on this is weird", "author": "ferozco", "createdAt": "2020-01-08T18:17:44Z", "path": "gradle-baseline-java/src/main/groovy/com/palantir/baseline/plugins/GroovyXmlUtils.groovy", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.baseline.plugins\n+\n+final class GroovyXmlUtils {\n+    static Node matchOrCreateChild(Node base, String name, Map attributes = [:], Map defaults = [:],", "originalCommit": "905a038734b12beee23fb4d57fff291737250b67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc3MTE5NQ==", "url": "https://github.com/palantir/gradle-baseline/pull/1151#discussion_r364771195", "bodyText": "fixed", "author": "dansanduleac", "createdAt": "2020-01-09T14:36:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM3Mjc5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM3Mzg2NQ==", "url": "https://github.com/palantir/gradle-baseline/pull/1151#discussion_r364373865", "bodyText": "we already have the ideaRootModel above", "author": "ferozco", "createdAt": "2020-01-08T18:20:16Z", "path": "gradle-baseline-java/src/main/groovy/com/palantir/baseline/plugins/BaselineIdea.groovy", "diffHunk": "@@ -68,6 +68,21 @@ class BaselineIdea extends AbstractBaselinePlugin {\n             moveProjectReferencesToEnd(ideaModuleModel)\n         }\n \n+        // Suggest and configure the \"save actions\" plugin if Palantir Java Format is turned on.\n+        if (project == project.rootProject) {\n+            IdeaModel ideaRootModel = project.extensions.findByType(IdeaModel)", "originalCommit": "905a038734b12beee23fb4d57fff291737250b67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY5NTAwMQ==", "url": "https://github.com/palantir/gradle-baseline/pull/1151#discussion_r364695001", "bodyText": "yeah but it's needlessly trapped inside afterEvaluate. Basically I think the code above is beyond gross (it reapplies the same steps to the root model from every single subproject) and so will not touch it, with an eye to refactor it in another PR.", "author": "dansanduleac", "createdAt": "2020-01-09T11:41:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM3Mzg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM3NTA3Ng==", "url": "https://github.com/palantir/gradle-baseline/pull/1151#discussion_r364375076", "bodyText": "it seems like nearly the whole plugin should be a no-op if not applied to the root. perhaps we can restructure this so its a little more clear", "author": "ferozco", "createdAt": "2020-01-08T18:23:03Z", "path": "gradle-baseline-java/src/main/groovy/com/palantir/baseline/plugins/BaselineIdea.groovy", "diffHunk": "@@ -68,6 +68,21 @@ class BaselineIdea extends AbstractBaselinePlugin {\n             moveProjectReferencesToEnd(ideaModuleModel)\n         }\n \n+        // Suggest and configure the \"save actions\" plugin if Palantir Java Format is turned on.\n+        if (project == project.rootProject) {", "originalCommit": "905a038734b12beee23fb4d57fff291737250b67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc2NTg3NA==", "url": "https://github.com/palantir/gradle-baseline/pull/1151#discussion_r364765874", "bodyText": "restructured", "author": "dansanduleac", "createdAt": "2020-01-09T14:26:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM3NTA3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM3NTQwNQ==", "url": "https://github.com/palantir/gradle-baseline/pull/1151#discussion_r364375405", "bodyText": "is this to allow users to override the configuration?", "author": "ferozco", "createdAt": "2020-01-08T18:23:51Z", "path": "gradle-baseline-java/src/main/groovy/com/palantir/baseline/plugins/BaselineIdea.groovy", "diffHunk": "@@ -311,4 +329,31 @@ class BaselineIdea extends AbstractBaselinePlugin {\n             module.dependencies.addAll(projectRefs)\n         }\n     }\n+\n+    /**\n+     * Configures some defaults on the save-actions plugin, but only if it hasn't been configured before.\n+     */\n+    private static void configureSaveActions(Node rootNode) {\n+        GroovyXmlUtils.matchOrCreateChild(rootNode, 'component', [name: 'SaveActionSettings'], [:]) {\n+            // Configure defaults if this plugin is configured for the first time only", "originalCommit": "905a038734b12beee23fb4d57fff291737250b67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc1NjUxOA==", "url": "https://github.com/palantir/gradle-baseline/pull/1151#discussion_r364756518", "bodyText": "yes, or they might have configured this plugin already for this project and then we don't want to override their configuration", "author": "dansanduleac", "createdAt": "2020-01-09T14:08:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM3NTQwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM3NTczOA==", "url": "https://github.com/palantir/gradle-baseline/pull/1151#discussion_r364375738", "bodyText": "might want to pull out the version so its more visible/easier to upgrade", "author": "ferozco", "createdAt": "2020-01-08T18:24:40Z", "path": "gradle-baseline-java/src/main/groovy/com/palantir/baseline/plugins/BaselineIdea.groovy", "diffHunk": "@@ -311,4 +329,31 @@ class BaselineIdea extends AbstractBaselinePlugin {\n             module.dependencies.addAll(projectRefs)\n         }\n     }\n+\n+    /**\n+     * Configures some defaults on the save-actions plugin, but only if it hasn't been configured before.\n+     */\n+    private static void configureSaveActions(Node rootNode) {\n+        GroovyXmlUtils.matchOrCreateChild(rootNode, 'component', [name: 'SaveActionSettings'], [:]) {\n+            // Configure defaults if this plugin is configured for the first time only\n+            appendNode('option', [name: 'actions']).appendNode('set').with {\n+                appendNode('option', [value: 'activate'])\n+                appendNode('option', [value: 'noActionIfCompileErrors'])\n+                appendNode('option', [value: 'organizeImports'])\n+                appendNode('option', [value: 'reformat'])\n+            }\n+            appendNode('option', [name: 'configurationPath', value: ''])\n+            appendNode('inclusions').appendNode('set').with {\n+                appendNode('option', [value: 'src/.*\\\\.java'])\n+            }\n+        }\n+    }\n+\n+    private static void configureExternalDependencies(Node rootNode) {\n+        def externalDependencies = GroovyXmlUtils.matchOrCreateChild(rootNode, 'component', [name: 'ExternalDependencies'])\n+        // I kid you not, this is the id for the save actions plugin:\n+        // https://github.com/dubreuia/intellij-plugin-save-actions/blob/v1.9.0/src/main/resources/META-INF/plugin.xml#L5\n+        // https://plugins.jetbrains.com/plugin/7642-save-actions/\n+        GroovyXmlUtils.matchOrCreateChild(externalDependencies, 'plugin', [id: 'com.dubreuia'], ['min-version': '1.9.0'])", "originalCommit": "905a038734b12beee23fb4d57fff291737250b67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc3MTA1Nw==", "url": "https://github.com/palantir/gradle-baseline/pull/1151#discussion_r364771057", "bodyText": "done", "author": "dansanduleac", "createdAt": "2020-01-09T14:35:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDM3NTczOA=="}], "type": "inlineReview"}, {"oid": "3cfdc273f003e57d1694eefff64de580c5d91126", "url": "https://github.com/palantir/gradle-baseline/commit/3cfdc273f003e57d1694eefff64de580c5d91126", "message": "fix root project configuration being applied for each subproject", "committedDate": "2020-01-09T14:20:56Z", "type": "commit"}, {"oid": "40d6bb861cc043f4514bb69c087a398146fee6b4", "url": "https://github.com/palantir/gradle-baseline/commit/40d6bb861cc043f4514bb69c087a398146fee6b4", "message": "be more defensive", "committedDate": "2020-01-09T14:20:56Z", "type": "commit"}, {"oid": "1aaef47d5b2d62e84bf8175d3e1e00096cb66762", "url": "https://github.com/palantir/gradle-baseline/commit/1aaef47d5b2d62e84bf8175d3e1e00096cb66762", "message": "chomp down arguments", "committedDate": "2020-01-09T14:26:09Z", "type": "commit"}, {"oid": "06581c9f481ed0f246e8a110d0e19144927719e3", "url": "https://github.com/palantir/gradle-baseline/commit/06581c9f481ed0f246e8a110d0e19144927719e3", "message": "lol", "committedDate": "2020-01-09T14:27:05Z", "type": "commit"}, {"oid": "43e13378e7a75e1fca51fcd67acccf31a252fc1c", "url": "https://github.com/palantir/gradle-baseline/commit/43e13378e7a75e1fca51fcd67acccf31a252fc1c", "message": "fix style, pull out constant", "committedDate": "2020-01-09T14:35:18Z", "type": "commit"}, {"oid": "ab105c2da7b2c5de03ef4d1b7b8d0379426b81e6", "url": "https://github.com/palantir/gradle-baseline/commit/ab105c2da7b2c5de03ef4d1b7b8d0379426b81e6", "message": "workspace stuff still needs to be in afterEvaluate", "committedDate": "2020-01-09T14:40:10Z", "type": "commit"}]}