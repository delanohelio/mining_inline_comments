{"pr_number": 1565, "pr_title": "Fix unit tests on java 15", "pr_createdAt": "2020-11-25T11:36:06Z", "pr_url": "https://github.com/palantir/gradle-baseline/pull/1565", "timeline": [{"oid": "61b3009d0b0278ce1803a354462317eb329c3415", "url": "https://github.com/palantir/gradle-baseline/commit/61b3009d0b0278ce1803a354462317eb329c3415", "message": "Increase release version in tests", "committedDate": "2020-11-25T11:01:12Z", "type": "commit"}, {"oid": "3b234d37aa83cb4135ed9614b9f82c83cf1a5716", "url": "https://github.com/palantir/gradle-baseline/commit/3b234d37aa83cb4135ed9614b9f82c83cf1a5716", "message": "Fix enable preview test", "committedDate": "2020-11-25T11:29:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMwOTEzNQ==", "url": "https://github.com/palantir/gradle-baseline/pull/1565#discussion_r530309135", "bodyText": ":compileJava was failing here with (ref):\nerror: cannot find symbol\n|            public record Coordinate(int x, int y) {}\n|                   ^\n|        symbol:   class record\n\nwhich makes sense to me as we are running with sourceCompatibility = 8. I think the output has changed from java 14 to java 15 and no longer contains the use --enable-preview to enable records line.\nChanged the test to explicitly print the compiler args and check that --enable-preview is not set when running with sourceCompatibility=8.", "author": "fawind", "createdAt": "2020-11-25T11:38:44Z", "path": "gradle-baseline-java/src/test/groovy/com/palantir/baseline/plugins/BaselineEnablePreviewFlagTest.groovy", "diffHunk": "@@ -156,19 +156,38 @@ class BaselineEnablePreviewFlagTest extends IntegrationSpec {\n \n     def 'does not always apply'() {\n         when:\n-        File java8Dir = addSubproject('my-java-8-api', \"sourceCompatibility = 8\")\n+        File java8Dir = addSubproject('my-java-8-api', \"\"\"\n+        sourceCompatibility = 8\n+\n+        tasks.withType(JavaCompile) {\n+           doFirst {\n+              println \"Args for for \\$name are \\$options.allCompilerArgs\"\n+           }\n+        } \n+        \"\"\".stripIndent())\n+\n         buildFile << '''\n         subprojects {\n             apply plugin: 'java-library'\n             apply plugin: 'com.palantir.baseline-enable-preview-flag'\n         }\n         '''\n-        writeSourceFileContainingRecord(java8Dir)", "originalCommit": "3b234d37aa83cb4135ed9614b9f82c83cf1a5716", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxMDQ3OA==", "url": "https://github.com/palantir/gradle-baseline/pull/1565#discussion_r530310478", "bodyText": "This is to fix this error (ref):\ninvalid source release 14 with --enable-preview\n    (preview language features are only supported for release 15)\n\nI think that's a restriction by the java-compiler that enable-preview has to be used with the latest release but could not find good documentation on this.", "author": "fawind", "createdAt": "2020-11-25T11:40:59Z", "path": "baseline-error-prone/src/test/java/com/palantir/baseline/errorprone/UnnecessaryParenthesesTest.java", "diffHunk": "@@ -29,7 +29,7 @@\n     public void testSwitchExpression() {\n         CompilationTestHelper compilationHelper = CompilationTestHelper.newInstance(\n                         UnnecessaryParentheses.class, getClass())\n-                .setArgs(ImmutableList.of(\"--enable-preview\", \"--release\", \"14\"));\n+                .setArgs(ImmutableList.of(\"--enable-preview\", \"--release\", \"15\"));", "originalCommit": "3b234d37aa83cb4135ed9614b9f82c83cf1a5716", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM2MjM1Mw==", "url": "https://github.com/palantir/gradle-baseline/pull/1565#discussion_r530362353", "bodyText": "Yep I stumbled across this restriction too when writing #1549\n\njavac in JDK $N accepts the --enable-preview flag only in combination with --release $N or -source $N. (For brevity, only --release is mentioned in the rest of this JEP.)\n\nhttps://openjdk.java.net/jeps/12", "author": "iamdanfox", "createdAt": "2020-11-25T13:10:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxMDQ3OA=="}], "type": "inlineReview"}]}