{"pr_number": 1552, "pr_title": "Fix semantic tokens offset due to document updates", "pr_createdAt": "2020-09-21T19:11:03Z", "pr_url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1552", "timeline": [{"oid": "d8e75339ac1d9343926b6bdb75efc971b05bd9e1", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/d8e75339ac1d9343926b6bdb75efc971b05bd9e1", "message": "Fix semantic tokens offset due to document updates\n\nSigned-off-by: 0dinD <zerodind@gmail.com>", "committedDate": "2020-09-21T19:07:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3MDc3Mg==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1552#discussion_r492470772", "bodyText": "Looks good. But not sure whether it can fix the problem completely.\nAs my understanding, both document and CompilationUnit are a snapshot of the document at some point. The difference is CompilationUnit is the AST tree parsed from the document at some point. I'm curious how the fix can guarantee it's not out-of-sync.", "author": "testforstephen", "createdAt": "2020-09-22T04:42:02Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/commands/SemanticTokensCommand.java", "diffHunk": "@@ -38,22 +34,17 @@ public static SemanticTokens provide(String uri) {\n \t}\n \n \tprivate static SemanticTokens doProvide(String uri) {\n-\t\tIDocument document = null;\n-\n \t\tITypeRoot typeRoot = JDTUtils.resolveTypeRoot(uri);\n-\t\tif (typeRoot != null) {\n-\t\t\ttry {\n-\t\t\t\tdocument = JsonRpcHelpers.toDocument(typeRoot.getBuffer());\n-\t\t\t} catch (JavaModelException e) {\n-\t\t\t\tJavaLanguageServerPlugin.logException(\"Failed to provide semantic tokens for \" + uri, e);\n-\t\t\t}\n-\t\t}\n-\t\tif (document == null) {\n+\t\tif (typeRoot == null) {\n \t\t\treturn new SemanticTokens(Collections.emptyList());\n \t\t}\n \n-\t\tSemanticTokensVisitor collector = new SemanticTokensVisitor(document, SemanticTokenManager.getInstance());\n \t\tCompilationUnit root = CoreASTProvider.getInstance().getAST(typeRoot, CoreASTProvider.WAIT_YES, new NullProgressMonitor());\n+\t\tif (root == null) {\n+\t\t\treturn new SemanticTokens(Collections.emptyList());\n+\t\t}\n+\n+\t\tSemanticTokensVisitor collector = new SemanticTokensVisitor(root, SemanticTokenManager.getInstance());", "originalCommit": "d8e75339ac1d9343926b6bdb75efc971b05bd9e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3NTYwMw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1552#discussion_r492475603", "bodyText": "Yes, the compilation unit might get out-of-sync with the real document at some points. But the problem before this change was that the semantic token visitor used both a document and AST nodes from the compilation unit, and the document was not in sync with the compilation unit.", "author": "0dinD", "createdAt": "2020-09-22T05:04:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3MDc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY0NjI0OQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1552#discussion_r492646249", "bodyText": "Actually I just submitted redhat-developer/vscode-java#1632, which should fix the problem that you've pointed out. It turns out that there were two separate issues causing the offset, see my comment.", "author": "0dinD", "createdAt": "2020-09-22T11:00:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ3MDc3Mg=="}], "type": "inlineReview"}]}