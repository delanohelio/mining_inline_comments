{"pr_number": 1579, "pr_title": "Link .settings directory to 'invisible project'", "pr_createdAt": "2020-10-21T15:45:46Z", "pr_url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1579", "timeline": [{"oid": "a94936c8e8e19d71091f9ba68184e0f1bfd04793", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/a94936c8e8e19d71091f9ba68184e0f1bfd04793", "message": "Link .settings directory to 'invisible project'\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2021-03-24T22:27:26Z", "type": "forcePushed"}, {"oid": "36375f7c44485c3aa399978fd53f3099158193ad", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/36375f7c44485c3aa399978fd53f3099158193ad", "message": "Link .settings directory to 'invisible project'\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2021-03-25T02:15:04Z", "type": "forcePushed"}, {"oid": "d983694b4e5fb36915805d0e8704482cfac890de", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/d983694b4e5fb36915805d0e8704482cfac890de", "message": "Link .settings directory to 'invisible project'\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2021-03-25T17:27:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjU4NzgxMQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1579#discussion_r602587811", "bodyText": "I  noticed here that the uri coming from the client had the form file:///.... while the settingsUri was file:/.... I wasn't able to delete the global settings file because of another issue but I would check if this equals gets satisfied when needed.", "author": "rgrunber", "createdAt": "2021-03-26T21:10:45Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/StandardProjectsManager.java", "diffHunk": "@@ -215,6 +220,16 @@ public void fileChanged(String uriString, CHANGE_TYPE changeType) {\n \t\tif (resource == null) {\n \t\t\treturn;\n \t\t}\n+\t\tURI settingsUri = preferenceManager.getPreferences().getSettingsAsURI();\n+\t\tif (settingsUri != null) {\n+\t\t\tURI uri = JDTUtils.toURI(uriString);\n+\t\t\tif (uri != null && uri.equals(settingsUri) && JavaLanguageServerPlugin.getInstance().getProtocol() != null) {", "originalCommit": "d983694b4e5fb36915805d0e8704482cfac890de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjYyNTU0Ng==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1579#discussion_r602625546", "bodyText": "You can try the following test:\n@Test\npublic void testUri() throws URISyntaxException {\n  URI uri1 = new URI(\"file:/test\");\n  URI uri2 = new URI(\"file:///test\");\n  assertTrue(uri1.equals(uri2));\n}", "author": "snjeza", "createdAt": "2021-03-26T23:06:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjU4NzgxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjY0Nzk0Mg==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1579#discussion_r602647942", "bodyText": "You're right. It works :)", "author": "rgrunber", "createdAt": "2021-03-27T01:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjU4NzgxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjU5NTU5Nw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1579#discussion_r602595597", "bodyText": "If sources from above has something like /home/rgrunber/Scripts/org.eclipse.jdt.core.prefs in the list then toGlobPattern seems to produce /home/rgrunber/Scripts/org.eclipse.jdt.core.prefs/** which I'm guessing means the file doesn't get watched.", "author": "rgrunber", "createdAt": "2021-03-26T21:29:55Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/StandardProjectsManager.java", "diffHunk": "@@ -358,15 +409,9 @@ public void registerWatchers(boolean runInJob) {\n \t\t\t}\n \t\t\tList<FileSystemWatcher> fileWatchers = new ArrayList<>();\n \t\t\tURI formatter = preferenceManager.getPreferences().getFormatterAsURI();\n-\t\t\tif (formatter != null && \"file\".equals(formatter.getScheme())) {\n-\t\t\t\tFile file = new File(formatter);\n-\t\t\t\tif (file != null && file.isFile()) {\n-\t\t\t\t\tIPath formatterPath = new Path(file.getAbsolutePath());\n-\t\t\t\t\tif (!isContainedIn(formatterPath, sources)) {\n-\t\t\t\t\t\tsources.add(formatterPath);\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t}\n+\t\t\taddWatcher(formatter, sources);\n+\t\t\tURI settings = preferenceManager.getPreferences().getSettingsAsURI();\n+\t\t\taddWatcher(settings, sources);\n \t\t\tpatterns.addAll(sources.stream().map(ResourceUtils::toGlobPattern).collect(Collectors.toList()));", "originalCommit": "d983694b4e5fb36915805d0e8704482cfac890de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjYyNTY0OA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1579#discussion_r602625648", "bodyText": "Fixed.", "author": "snjeza", "createdAt": "2021-03-26T23:07:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjU5NTU5Nw=="}], "type": "inlineReview"}, {"oid": "e3ff31d8bcdddced176f4651e8fcf447eb4e2419", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/e3ff31d8bcdddced176f4651e8fcf447eb4e2419", "message": "Link .settings directory to 'invisible project'\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2021-03-26T23:05:45Z", "type": "forcePushed"}, {"oid": "a447bf556f3a0dab0494f653efbaf02ac1258a27", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/a447bf556f3a0dab0494f653efbaf02ac1258a27", "message": "Link .settings directory to 'invisible project'\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2021-03-30T22:52:27Z", "type": "forcePushed"}, {"oid": "470933d105f65fec6a0f3a4ef2274ea7fcd74e53", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/470933d105f65fec6a0f3a4ef2274ea7fcd74e53", "message": "Link .settings directory to 'invisible project'\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2021-04-01T20:58:09Z", "type": "forcePushed"}, {"oid": "733e4e1946f211306ed1c5eba8bcf1a2ce048aa7", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/733e4e1946f211306ed1c5eba8bcf1a2ce048aa7", "message": "Link .settings directory to 'invisible project'\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2021-04-06T21:48:32Z", "type": "commit"}, {"oid": "733e4e1946f211306ed1c5eba8bcf1a2ce048aa7", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/733e4e1946f211306ed1c5eba8bcf1a2ce048aa7", "message": "Link .settings directory to 'invisible project'\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2021-04-06T21:48:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTExOTE1Mg==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1579#discussion_r609119152", "bodyText": "Do you have an example where this is needed ? The closest I could find in a properties file was instance/org.eclipse.core.net/org.eclipse.core.net.hasMigrated=true .", "author": "rgrunber", "createdAt": "2021-04-07T22:49:14Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/StandardProjectsManager.java", "diffHunk": "@@ -257,6 +293,57 @@ public void fileChanged(String uriString, CHANGE_TYPE changeType) {\n \t\t}\n \t}\n \n+\tpublic static void configureSettings(Preferences preferences) {\n+\t\tURI settingsUri = preferences.getSettingsAsURI();\n+\t\tProperties properties = null;\n+\t\tif (settingsUri != null) {\n+\t\t\ttry (InputStream inputStream = settingsUri.toURL().openStream()) {\n+\t\t\t\tproperties = new Properties();\n+\t\t\t\tproperties.load(inputStream);\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\treturn;\n+\t\t\t}\n+\t\t}\n+\t\tinitializeDefaultOptions(preferences);\n+\t\tHashtable<String, String> javaOptions = JavaCore.getOptions();\n+\t\tif (properties != null && !properties.isEmpty()) {\n+\t\t\tproperties.forEach((k, v) -> {\n+\t\t\t\tif (k instanceof String && v instanceof String) {\n+\t\t\t\t\tk = ((String) k).replace(\"/instance/\", \"\");", "originalCommit": "733e4e1946f211306ed1c5eba8bcf1a2ce048aa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTEzODYxNQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1579#discussion_r609138615", "bodyText": "You can try File>Export>General>Preference in eclipse.", "author": "snjeza", "createdAt": "2021-04-07T23:29:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTExOTE1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMDA4NDcxMg==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1579#discussion_r610084712", "bodyText": "Right. I guess we can partially support .epf files. This is fine then.", "author": "rgrunber", "createdAt": "2021-04-08T20:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTExOTE1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTEyNzIxMw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1579#discussion_r609127213", "bodyText": "Just curious if you know why we also set them in https://github.com/eclipse/eclipse.jdt.ls/blob/master/org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/JavaLanguageServerPlugin.java#L254", "author": "rgrunber", "createdAt": "2021-04-07T23:04:14Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/PreferenceManager.java", "diffHunk": "@@ -88,6 +89,7 @@ public static void initialize() {\n \t\tdefEclipsePrefs.put(\"org.eclipse.jdt.ui.typefilter.enabled\", \"\");\n \t\tdefEclipsePrefs.put(CodeStyleConfiguration.ORGIMPORTS_IMPORTORDER, String.join(\";\", Preferences.JAVA_IMPORT_ORDER_DEFAULT));\n \t\tdefEclipsePrefs.put(MembersOrderPreferenceCacheCommon.APPEARANCE_MEMBER_SORT_ORDER, \"T,SF,SI,SM,F,I,C,M\"); //$NON-NLS-1$\n+\t\tdefEclipsePrefs.put(CodeGenerationSettingsConstants.CODEGEN_USE_OVERRIDE_ANNOTATION, Boolean.TRUE.toString());", "originalCommit": "733e4e1946f211306ed1c5eba8bcf1a2ce048aa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTEzOTc1MQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1579#discussion_r609139751", "bodyText": "I'm not sure. The tests fail without it.", "author": "snjeza", "createdAt": "2021-04-07T23:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTEyNzIxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMDE1MjMwMA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1579#discussion_r610152300", "bodyText": "I'm noticing some test failures but never in the same one, and occasionally the full suite succeeds. Either way, I guess we can look into it a later time as this change itself makes sense.", "author": "rgrunber", "createdAt": "2021-04-08T22:13:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTEyNzIxMw=="}], "type": "inlineReview"}]}