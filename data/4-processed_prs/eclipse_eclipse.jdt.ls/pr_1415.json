{"pr_number": 1415, "pr_title": "Organize Imports should resolve static imports as well", "pr_createdAt": "2020-04-21T22:31:30Z", "pr_url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1415", "timeline": [{"oid": "f7b1ec4dda7b41d1e9ba13626a73a187693333bf", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/f7b1ec4dda7b41d1e9ba13626a73a187693333bf", "message": "Organize Imports should resolve static imports as well\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-04-25T18:48:27Z", "type": "forcePushed"}, {"oid": "90be5e5fd7e371a6a0f53958f672ba396d967405", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/90be5e5fd7e371a6a0f53958f672ba396d967405", "message": "Organize Imports should resolve static imports as well\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-04-27T15:03:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk4NzM3Mw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1415#discussion_r415987373", "bodyText": "JobHelpers.waitForJobs(DocumentLifeCycleHandler.DOCUMENT_LIFE_CYCLE_JOBS, monitor);", "author": "fbricon", "createdAt": "2020-04-27T17:00:36Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/BaseDocumentLifeCycleHandler.java", "diffHunk": "@@ -272,6 +274,11 @@ public void run(IProgressMonitor monitor) throws CoreException {\n \n \tpublic void didSave(DidSaveTextDocumentParams params) {\n \t\ttry {", "originalCommit": "90be5e5fd7e371a6a0f53958f672ba396d967405", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA0MjY0MA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1415#discussion_r416042640", "bodyText": "Fixed.", "author": "snjeza", "createdAt": "2020-04-27T18:17:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk4NzM3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk4ODgzNw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1415#discussion_r415988837", "bodyText": "JobHelpers.waitForJobs(DocumentLifeCycleHandler.DOCUMENT_LIFE_CYCLE_JOBS, monitor);", "author": "fbricon", "createdAt": "2020-04-27T17:02:40Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/OrganizeImportsHandler.java", "diffHunk": "@@ -78,16 +95,97 @@ public static TextEdit organizeImports(ICompilationUnit unit, Function<ImportSel\n \t\t\t});\r\n \t\t\treturn Stream.of(chosens).filter(chosen -> chosen != null && typeMaps.containsKey(chosen.id)).map(chosen -> typeMaps.get(chosen.id)).toArray(TypeNameMatch[]::new);\r\n \t\t});\r\n-\r\n \t\ttry {\r\n-\t\t\treturn op.createTextEdit(null);\r\n-\t\t} catch (OperationCanceledException | CoreException e) {\r\n+\t\t\tJob.getJobManager().join(BaseDocumentLifeCycleHandler.DOCUMENT_LIFE_CYCLE_JOBS, new NullProgressMonitor());\r", "originalCommit": "90be5e5fd7e371a6a0f53958f672ba396d967405", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA0Mjc2MQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1415#discussion_r416042761", "bodyText": "Fixed.", "author": "snjeza", "createdAt": "2020-04-27T18:17:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk4ODgzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk4OTIxMA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1415#discussion_r415989210", "bodyText": "areEqual", "author": "fbricon", "createdAt": "2020-04-27T17:03:10Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/OrganizeImportsHandler.java", "diffHunk": "@@ -78,16 +95,97 @@ public static TextEdit organizeImports(ICompilationUnit unit, Function<ImportSel\n \t\t\t});\r\n \t\t\treturn Stream.of(chosens).filter(chosen -> chosen != null && typeMaps.containsKey(chosen.id)).map(chosen -> typeMaps.get(chosen.id)).toArray(TypeNameMatch[]::new);\r\n \t\t});\r\n-\r\n \t\ttry {\r\n-\t\t\treturn op.createTextEdit(null);\r\n-\t\t} catch (OperationCanceledException | CoreException e) {\r\n+\t\t\tJob.getJobManager().join(BaseDocumentLifeCycleHandler.DOCUMENT_LIFE_CYCLE_JOBS, new NullProgressMonitor());\r\n+\t\t\tTextEdit edit = op.createTextEdit(null);\r\n+\t\t\t// See https://bugs.eclipse.org/bugs/show_bug.cgi?id=283287\r\n+\t\t\tTextEdit staticEdit = wrapStaticImports(edit, astRoot, unit);\r\n+\t\t\tif (staticEdit.getChildrenSize() == 0) {\r\n+\t\t\t\treturn null;\r\n+\t\t\t}\r\n+\t\t\treturn staticEdit;\r\n+\t\t} catch (OperationCanceledException | CoreException | InterruptedException e) {\r\n \t\t\tJavaLanguageServerPlugin.logException(\"Failed to resolve organize imports source action\", e);\r\n \t\t}\r\n-\r\n \t\treturn null;\r\n \t}\r\n \r\n+\tprivate static TextEdit wrapStaticImports(TextEdit edit, CompilationUnit root, ICompilationUnit unit) throws MalformedTreeException, CoreException {\r\n+\t\tString[] favourites = PreferenceManager.getPrefs(unit.getResource()).getJavaCompletionFavoriteMembers();\r\n+\t\tif (favourites.length == 0) {\r\n+\t\t\treturn edit;\r\n+\t\t}\r\n+\t\tIJavaProject project = unit.getJavaProject();\r\n+\t\tif (JavaModelUtil.is50OrHigher(project)) {\r\n+\t\t\tList<SimpleName> typeReferences = new ArrayList<>();\r\n+\t\t\tList<SimpleName> staticReferences = new ArrayList<>();\r\n+\t\t\tImportReferencesCollector.collect(root, project, null, typeReferences, staticReferences);\r\n+\t\t\tif (staticReferences.isEmpty()) {\r\n+\t\t\t\treturn edit;\r\n+\t\t\t}\r\n+\t\t\tImportRewrite importRewrite = CodeStyleConfiguration.createImportRewrite(root, true);\r\n+\t\t\tAST ast = root.getAST();\r\n+\t\t\tASTRewrite astRewrite = ASTRewrite.create(ast);\r\n+\t\t\tfor (SimpleName node : staticReferences) {\r\n+\t\t\t\taddImports(root, unit, favourites, importRewrite, ast, astRewrite, node, true);\r\n+\t\t\t\taddImports(root, unit, favourites, importRewrite, ast, astRewrite, node, false);\r\n+\t\t\t}\r\n+\t\t\tTextEdit staticEdit = importRewrite.rewriteImports(null);\r\n+\t\t\tif (staticEdit != null && staticEdit.getChildrenSize() > 0) {\r\n+\t\t\t\tTextEdit lastStatic = staticEdit.getChildren()[staticEdit.getChildrenSize() - 1];\r\n+\t\t\t\tif (lastStatic instanceof DeleteEdit) {\r\n+\t\t\t\t\tif (edit.getChildrenSize() > 0) {\r\n+\t\t\t\t\t\tTextEdit last = edit.getChildren()[edit.getChildrenSize() - 1];\r\n+\t\t\t\t\t\tif (last instanceof DeleteEdit && lastStatic.getOffset() == last.getOffset() && lastStatic.getLength() == last.getLength()) {\r\n+\t\t\t\t\t\t\tedit.removeChild(last);\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t\tTextEdit firstStatic = staticEdit.getChildren()[0];\r\n+\t\t\t\tif (firstStatic instanceof InsertEdit) {\r\n+\t\t\t\t\tif (edit.getChildrenSize() > 0) {\r\n+\t\t\t\t\t\tTextEdit firstEdit = edit.getChildren()[0];\r\n+\t\t\t\t\t\tif (firstEdit instanceof InsertEdit) {\r\n+\t\t\t\t\t\t\tif (isEquals((InsertEdit) firstEdit, (InsertEdit) firstStatic)) {\r\n+\t\t\t\t\t\t\t\tedit.removeChild(firstEdit);\r\n+\t\t\t\t\t\t\t}\r\n+\t\t\t\t\t\t}\r\n+\t\t\t\t\t}\r\n+\t\t\t\t}\r\n+\t\t\t\ttry {\r\n+\t\t\t\t\tstaticEdit.addChild(edit);\r\n+\t\t\t\t\treturn staticEdit;\r\n+\t\t\t\t} catch (MalformedTreeException e) {\r\n+\t\t\t\t\tJavaLanguageServerPlugin.logException(\"Failed to resolve static organize imports source action\", e);\r\n+\t\t\t\t}\r\n+\t\t\t}\r\n+\t\t}\r\n+\t\treturn edit;\r\n+\t}\r\n+\r\n+\tprivate static boolean isEquals(InsertEdit edit1, InsertEdit edit2) {\r", "originalCommit": "90be5e5fd7e371a6a0f53958f672ba396d967405", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA0Mjg5NA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1415#discussion_r416042894", "bodyText": "Fixed.", "author": "snjeza", "createdAt": "2020-04-27T18:18:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk4OTIxMA=="}], "type": "inlineReview"}, {"oid": "eb71e28a548c14591562b65aefa633fe968e4630", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/eb71e28a548c14591562b65aefa633fe968e4630", "message": "Organize Imports should resolve static imports as well\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-04-27T18:17:09Z", "type": "commit"}, {"oid": "eb71e28a548c14591562b65aefa633fe968e4630", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/eb71e28a548c14591562b65aefa633fe968e4630", "message": "Organize Imports should resolve static imports as well\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-04-27T18:17:09Z", "type": "forcePushed"}]}