{"pr_number": 1395, "pr_title": "Add record snippet", "pr_createdAt": "2020-03-26T14:00:43Z", "pr_url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1395", "timeline": [{"oid": "e1fc9d16b3b54572278e827e42df481a2c04707f", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/e1fc9d16b3b54572278e827e42df481a2c04707f", "message": "Add record snippet\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>", "committedDate": "2020-03-26T14:06:51Z", "type": "forcePushed"}, {"oid": "a3a2e4e252199e757d76e759818e63bb7c286278", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/a3a2e4e252199e757d76e759818e63bb7c286278", "message": "Add record snippet\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>", "committedDate": "2020-03-26T14:19:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYxMTcyMg==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1395#discussion_r398611722", "bodyText": "@snjeza for some reason the tests with inner records fail, do you mind taking a look at them?", "author": "fbricon", "createdAt": "2020-03-26T14:22:56Z", "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/handlers/CompletionHandlerTest.java", "diffHunk": "@@ -1343,6 +1344,108 @@ public void testSnippet_nested_inner_class() throws JavaModelException {\n \t\tassertEquals(\"/**\\n * ${1:InnerTest_1}\\n */\\npublic class ${1:InnerTest_1} {\\n\\n\\t${0}\\n}\", te);\n \t}\n \n+\t@Test\n+\tpublic void testSnippet_record() throws JavaModelException {\n+\t\tICompilationUnit unit = getWorkingCopy(\"src/org/sample/Test.java\", \"\");\n+\t\tint[] loc = findCompletionLocation(unit, \"\");\n+\t\tCompletionList list = server.completion(JsonMessageHelper.getParams(createCompletionRequest(unit, loc[0], loc[1]))).join().getRight();\n+\n+\t\tassertNotNull(list);\n+\t\tList<CompletionItem> items = new ArrayList<>(list.getItems());\n+\t\tassertFalse(items.isEmpty());\n+\t\titems.sort((i1, i2) -> (i1.getSortText().compareTo(i2.getSortText())));\n+\n+\t\tCompletionItem item = items.get(10);\n+\t\tassertEquals(\"record\", item.getLabel());\n+\t\tString te = item.getInsertText();\n+\t\tassertEquals(\"package org.sample;\\n\\n/**\\n * Test\\n */\\npublic record Test(${0}) {\\n}\", te);\n+\n+\t\t//check resolution doesn't blow up (https://github.com/eclipse/eclipse.jdt.ls/issues/675)\n+\t\tassertSame(item, server.resolveCompletionItem(item).join());\n+\t}\n+\n+\t@Test\n+\tpublic void testSnippet_record_with_package() throws JavaModelException {\n+\t\tICompilationUnit unit = getWorkingCopy(\"src/org/sample/Test.java\", \"package org.sample;\\n\");\n+\t\tint[] loc = findCompletionLocation(unit, \"package org.sample;\\n\");\n+\t\tCompletionList list = server.completion(JsonMessageHelper.getParams(createCompletionRequest(unit, loc[0], loc[1]))).join().getRight();\n+\n+\t\tassertNotNull(list);\n+\t\tList<CompletionItem> items = new ArrayList<>(list.getItems());\n+\t\tassertFalse(items.isEmpty());\n+\t\titems.sort((i1, i2) -> (i1.getSortText().compareTo(i2.getSortText())));\n+\n+\t\tCompletionItem item = items.get(9);\n+\t\tassertEquals(\"record\", item.getLabel());\n+\t\tString te = item.getInsertText();\n+\t\tassertEquals(\"/**\\n * Test\\n */\\npublic record Test(${0}) {\\n}\", te);\n+\t}\n+\n+\t@Ignore(value = \"When running tests, in SnippetCompletionProposal.getSnippetContent(), cu.getAllTypes() returns en empty array, so inner record name is not computed\")", "originalCommit": "a3a2e4e252199e757d76e759818e63bb7c286278", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY0Mjk4Ng==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1395#discussion_r398642986", "bodyText": "the tests passed.", "author": "snjeza", "createdAt": "2020-03-26T15:02:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYxMTcyMg=="}], "type": "inlineReview"}, {"oid": "fc36bb8e11ffd065c2fe0a599196249d1520fe76", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/fc36bb8e11ffd065c2fe0a599196249d1520fe76", "message": "Add record snippet\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>", "committedDate": "2020-03-29T14:28:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgwNTg0NA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1395#discussion_r399805844", "bodyText": "@snjeza lemme know if there's a better way to do this", "author": "fbricon", "createdAt": "2020-03-29T14:31:17Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/contentassist/SnippetCompletionProposal.java", "diffHunk": "@@ -311,6 +367,39 @@ private static CompletionItem getInterfaceSnippet(ICompilationUnit cu, Completio\n \t\treturn interfaceSnippetItem;\n \t}\n \n+\tprivate static CompletionItem getRecordSnippet(SnippetCompletionContext scc, IProgressMonitor monitor) {\n+\t\tICompilationUnit cu = scc.getCompilationUnit();\n+\t\tIJavaProject javaProject = cu.getJavaProject();\n+\t\tif (javaProject == null) {\n+\t\t\treturn null;\n+\t\t}\n+\t\tAST ast = AST.newAST(javaProject.getOptions(true));\n+\t\tif (ast.apiLevel() < AST.JLS14) {//TODO is there a better way to check JDK version?\n+\t\t\t//not checking if preview features are enabled, as Java 14+ might support records without preview flag\n+\t\t\treturn null;\n+\t\t}", "originalCommit": "fc36bb8e11ffd065c2fe0a599196249d1520fe76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgxNDEzNw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1395#discussion_r399814137", "bodyText": "javaProject.getOption(JavaCore.COMPILER_COMPLIANCE, true)", "author": "snjeza", "createdAt": "2020-03-29T15:36:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgwNTg0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgyNDQ0Ng==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1395#discussion_r399824446", "bodyText": "mmyeah. But it returns a String, that needs to be converted using internal JDT code to properly handle it", "author": "fbricon", "createdAt": "2020-03-29T16:58:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgwNTg0NA=="}], "type": "inlineReview"}, {"oid": "efc8bc09c4529a07264a065266ed061a3a15878c", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/efc8bc09c4529a07264a065266ed061a3a15878c", "message": "Add record snippet\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>", "committedDate": "2020-03-29T17:47:26Z", "type": "forcePushed"}, {"oid": "1bef7deeacb28ef3e9aaaa66c19fe98fc05aaf77", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/1bef7deeacb28ef3e9aaaa66c19fe98fc05aaf77", "message": "Add record snippet\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>", "committedDate": "2020-03-29T17:49:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTgzMDgxOQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1395#discussion_r399830819", "bodyText": "at least the version comparison is more consistent with the rest of the codebase", "author": "fbricon", "createdAt": "2020-03-29T17:52:03Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/contentassist/SnippetCompletionProposal.java", "diffHunk": "@@ -311,6 +367,39 @@ private static CompletionItem getInterfaceSnippet(ICompilationUnit cu, Completio\n \t\treturn interfaceSnippetItem;\n \t}\n \n+\tprivate static CompletionItem getRecordSnippet(SnippetCompletionContext scc, IProgressMonitor monitor) {\n+\t\tICompilationUnit cu = scc.getCompilationUnit();\n+\t\tIJavaProject javaProject = cu.getJavaProject();\n+\t\tif (javaProject == null) {\n+\t\t\treturn null;\n+\t\t}\n+\t\tString version = javaProject.getOption(JavaCore.COMPILER_COMPLIANCE, true);\n+\t\tif (JavaModelUtil.isVersionLessThan(version, JavaCore.VERSION_14)) {", "originalCommit": "1bef7deeacb28ef3e9aaaa66c19fe98fc05aaf77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1beae12fa77cce9497c5db5bc1319ae655bcd30f", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/1beae12fa77cce9497c5db5bc1319ae655bcd30f", "message": "Add record snippet\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>", "committedDate": "2020-03-30T09:19:18Z", "type": "forcePushed"}, {"oid": "1415524ba90c4e13ffa0e86f1c8434a3fff4e834", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/1415524ba90c4e13ffa0e86f1c8434a3fff4e834", "message": "Add record snippet\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>", "committedDate": "2020-03-30T09:50:40Z", "type": "commit"}, {"oid": "1415524ba90c4e13ffa0e86f1c8434a3fff4e834", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/1415524ba90c4e13ffa0e86f1c8434a3fff4e834", "message": "Add record snippet\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>", "committedDate": "2020-03-30T09:50:40Z", "type": "forcePushed"}]}