{"pr_number": 1451, "pr_title": "JDT LS tests fail randomly", "pr_createdAt": "2020-05-19T20:26:21Z", "pr_url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1451", "timeline": [{"oid": "3e7261d6dff771ede4058ac28f08b3fd5ca860e3", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/3e7261d6dff771ede4058ac28f08b3fd5ca860e3", "message": "JDT LS tests fail randomly\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-05-19T20:37:54Z", "type": "forcePushed"}, {"oid": "07f4be2d9593ce9c693f7b8a31784b614d449f70", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/07f4be2d9593ce9c693f7b8a31784b614d449f70", "message": "JDT LS tests fail randomly\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-05-19T20:48:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MTQ0Nw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1451#discussion_r427591447", "bodyText": "I'd rather prefer we kept those temporary files under the target/ dir", "author": "fbricon", "createdAt": "2020-05-19T20:50:16Z", "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/managers/WrapperValidatorTest.java", "diffHunk": "@@ -43,12 +45,13 @@\n \n \t@Before\n \tpublic void setProperty() throws Exception {\n-\t\tSystem.setProperty(\"gradle.checksum.cacheDir\", \"target/gradle/checksums\");\n+\t\tSystem.setProperty(\"gradle.checksum.cacheDir\", \"gradle/checksums\");", "originalCommit": "07f4be2d9593ce9c693f7b8a31784b614d449f70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYwMDk4Nw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1451#discussion_r427600987", "bodyText": "Fixed.", "author": "snjeza", "createdAt": "2020-05-19T21:08:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MTQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MzYyNA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1451#discussion_r427593624", "bodyText": "I'd like to know why exactly this is happening. Is it expected we get multiple calls?", "author": "fbricon", "createdAt": "2020-05-19T20:54:11Z", "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/handlers/ClasspathUpdateHandlerTest.java", "diffHunk": "@@ -73,7 +74,7 @@ public void testClasspathUpdateForMaven() throws Exception {\n \t\twaitForBackgroundJobs();\n \n \t\tArgumentCaptor<ActionableNotification> argument = ArgumentCaptor.forClass(ActionableNotification.class);\n-\t\tverify(connection, times(1)).sendActionableNotification(argument.capture());\n+\t\tverify(connection, atLeastOnce()).sendActionableNotification(argument.capture());", "originalCommit": "07f4be2d9593ce9c693f7b8a31784b614d449f70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYwMTEyNw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1451#discussion_r427601127", "bodyText": "checking...", "author": "snjeza", "createdAt": "2020-05-19T21:08:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MzYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzcwMDM3NQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1451#discussion_r427700375", "bodyText": "I tried to run org.eclipse.jdt.ls.core.internal.handlers.ClasspathUpdateHandlerTest.testClasspathUpdateForMaven locally(on Mac and Windows) and the invocation times is always one. wired... \ud83e\udd14", "author": "jdneo", "createdAt": "2020-05-20T02:04:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MzYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIxMDM3Mw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1451#discussion_r428210373", "bodyText": "You can try the following:\n$ rm -rf ~/.m2/repository/org/apache/commons/commons-lang3\n$ mvn clean verify", "author": "snjeza", "createdAt": "2020-05-20T18:10:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MzYyNA=="}], "type": "inlineReview"}, {"oid": "1e78569fbf3139bc955d03ddcfb4f26887f00684", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/1e78569fbf3139bc955d03ddcfb4f26887f00684", "message": "JDT LS tests fail randomly\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-05-19T21:05:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYyNzAzNw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1451#discussion_r427627037", "bodyText": "WrapperValidator.clear() might help", "author": "fbricon", "createdAt": "2020-05-19T22:04:10Z", "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/managers/WrapperValidatorTest.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-2.0/\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.core.internal.managers;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.io.File;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.jdt.ls.core.internal.JavaLanguageServerPlugin;\n+import org.eclipse.jdt.ls.core.internal.preferences.Preferences;\n+import org.eclipse.jdt.ls.internal.gradle.checksums.ValidationResult;\n+import org.eclipse.jdt.ls.internal.gradle.checksums.WrapperValidator;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.runners.MockitoJUnitRunner;\n+\n+/**\n+ * @author snjeza\n+ *\n+ */\n+@RunWith(MockitoJUnitRunner.class)\n+public class WrapperValidatorTest extends AbstractGradleBasedTest{\n+\n+\t@Before\n+\tpublic void setProperty() throws Exception {\n+\t\tSystem.setProperty(\"gradle.checksum.cacheDir\", \"target/gradle/checksums\");\n+\t}\n+\n+\t@After\n+\tpublic void clearProperty() {\n+\t\tSystem.clearProperty(\"gradle.checksum.cacheDir\");\n+\t}\n+\n+\t@Test\n+\tpublic void testGradleWrapper() throws Exception {\n+\t\tFile file = new File(getSourceProjectDirectory(), \"gradle/simple-gradle\");\n+\t\tassertTrue(file.isDirectory());\n+\t\tValidationResult result = new WrapperValidator().checkWrapper(file.getAbsolutePath());\n+\t\tassertTrue(result.isValid());\n+\t\tFile sha256Directory = WrapperValidator.getSha256CacheFile();\n+\t\t// test cache\n+\t\tfile = new File(sha256Directory, \"gradle-6.4-wrapper.jar.sha256\");\n+\t\tString sha256 = Files.lines(Paths.get(file.getAbsolutePath()), StandardCharsets.UTF_8).findFirst().get();\n+\t\tassertEquals(\"70239e6ca1f0d5e3b2808ef6d82390cf9ad58d3a3a0d271677a51d1b89475857\", sha256);\n+\t}\n+\n+\t@Test\n+\tpublic void testMissingSha256() throws Exception {", "originalCommit": "3d89de8c6afdb17ccc671030bdb31c84dced2336", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYzMjIxNg==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1451#discussion_r427632216", "bodyText": "I have tried it - 72261c5", "author": "snjeza", "createdAt": "2020-05-19T22:17:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYyNzAzNw=="}], "type": "inlineReview"}, {"oid": "72261c57aa7f6ba2d3ed5e5230ddc2685026753e", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/72261c57aa7f6ba2d3ed5e5230ddc2685026753e", "message": "JDT LS tests fail randomly\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-05-19T22:13:45Z", "type": "forcePushed"}, {"oid": "8abbdf5b47d7269e3357c2fc42dad9d39943111f", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/8abbdf5b47d7269e3357c2fc42dad9d39943111f", "message": "JDT LS tests fail randomly\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-05-19T23:21:33Z", "type": "forcePushed"}, {"oid": "fd279e1690d5a94d07b0460deed84914cda06565", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/fd279e1690d5a94d07b0460deed84914cda06565", "message": "JDT LS tests fail randomly\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-05-20T00:26:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg3OTg1Mg==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1451#discussion_r427879852", "bodyText": "need to also call WrapperValidator.clear() in setProperty(), as previous Gradle tests might have mutated  WrapperValidator's state", "author": "fbricon", "createdAt": "2020-05-20T09:44:46Z", "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/managers/WrapperValidatorTest.java", "diffHunk": "@@ -47,21 +49,26 @@ public void setProperty() throws Exception {\n \t}\n \n \t@After\n-\tpublic void clearProperty() {\n+\tpublic void clearProperty() throws IOException {\n \t\tSystem.clearProperty(\"gradle.checksum.cacheDir\");\n+\t\tWrapperValidator.clear();", "originalCommit": "fd279e1690d5a94d07b0460deed84914cda06565", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg4MDQ0NA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1451#discussion_r427880444", "bodyText": "I saw this fail if WrapperValidator.clear() is not set in setProperty()", "author": "fbricon", "createdAt": "2020-05-20T09:45:47Z", "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/managers/WrapperValidatorTest.java", "diffHunk": "@@ -47,21 +49,26 @@ public void setProperty() throws Exception {\n \t}\n \n \t@After\n-\tpublic void clearProperty() {\n+\tpublic void clearProperty() throws IOException {\n \t\tSystem.clearProperty(\"gradle.checksum.cacheDir\");\n+\t\tWrapperValidator.clear();\n \t}\n \n \t@Test\n \tpublic void testGradleWrapper() throws Exception {\n \t\tFile file = new File(getSourceProjectDirectory(), \"gradle/simple-gradle\");\n \t\tassertTrue(file.isDirectory());\n+\t\tFile sha256Directory = WrapperValidator.getSha256CacheFile();\n+\t\tassertTrue(sha256Directory.isDirectory());\n \t\tValidationResult result = new WrapperValidator().checkWrapper(file.getAbsolutePath());\n \t\tassertTrue(result.isValid());\n-\t\tFile sha256Directory = WrapperValidator.getSha256CacheFile();\n \t\t// test cache\n-\t\tfile = new File(sha256Directory, \"gradle-6.4-wrapper.jar.sha256\");\n+\t\tassertTrue(sha256Directory.isDirectory());\n+\t\tString message = Files.list(Paths.get(sha256Directory.getAbsolutePath())).collect(Collectors.toList()).toString();\n+\t\tfile = new File(sha256Directory, \"gradle-6.3-wrapper.jar.sha256\");\n+\t\tassertTrue(message, file.isFile());", "originalCommit": "fd279e1690d5a94d07b0460deed84914cda06565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk0NjAzMA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1451#discussion_r427946030", "bodyText": "checking...", "author": "snjeza", "createdAt": "2020-05-20T11:48:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg4MDQ0NA=="}], "type": "inlineReview"}, {"oid": "5b614854c1eb7c37f76509d09508301422edaca8", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/5b614854c1eb7c37f76509d09508301422edaca8", "message": "JDT LS tests fail randomly\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-05-20T13:04:40Z", "type": "forcePushed"}, {"oid": "0a6c6ddc84f5ad40ad43257173a3e6c2604b3455", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/0a6c6ddc84f5ad40ad43257173a3e6c2604b3455", "message": "JDT LS tests fail randomly\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-05-20T15:26:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIwNDEzMw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1451#discussion_r428204133", "bodyText": "needs some comments to explain why this is necessary", "author": "fbricon", "createdAt": "2020-05-20T17:59:49Z", "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/handlers/ClasspathUpdateHandlerTest.java", "diffHunk": "@@ -47,6 +54,14 @@\n \n \tprivate ClasspathUpdateHandler handler;\n \n+\t@BeforeClass\n+\tpublic static void download() throws FileNotFoundException, CoreException {", "originalCommit": "0a6c6ddc84f5ad40ad43257173a3e6c2604b3455", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIxMTE1Nw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1451#discussion_r428211157", "bodyText": "m2e updates a classpath when downloading a source artifact. Jenkins starts with an empty maven repository.", "author": "snjeza", "createdAt": "2020-05-20T18:11:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIwNDEzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIzNjEyMQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1451#discussion_r428236121", "bodyText": "the comments should be added to the code", "author": "fbricon", "createdAt": "2020-05-20T18:50:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIwNDEzMw=="}], "type": "inlineReview"}, {"oid": "9b91b5c5a03b34c6b76603ba9755b27712ed5ca9", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/9b91b5c5a03b34c6b76603ba9755b27712ed5ca9", "message": "JDT LS tests fail randomly\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-05-20T18:21:05Z", "type": "commit"}, {"oid": "9b91b5c5a03b34c6b76603ba9755b27712ed5ca9", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/9b91b5c5a03b34c6b76603ba9755b27712ed5ca9", "message": "JDT LS tests fail randomly\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-05-20T18:21:05Z", "type": "forcePushed"}]}