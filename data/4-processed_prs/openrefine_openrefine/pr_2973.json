{"pr_number": 2973, "pr_title": "Faster rendering of rows and cells", "pr_createdAt": "2020-07-21T20:26:30Z", "pr_url": "https://github.com/OpenRefine/OpenRefine/pull/2973", "timeline": [{"oid": "abc93d6cb978e9752fe71619bb3f6ded56fe8055", "url": "https://github.com/OpenRefine/OpenRefine/commit/abc93d6cb978e9752fe71619bb3f6ded56fe8055", "message": "changes to rendering of rows", "committedDate": "2020-07-21T19:42:32Z", "type": "commit"}, {"oid": "a98f4eea749c5ecae407d3de661510cc88cd3c28", "url": "https://github.com/OpenRefine/OpenRefine/commit/a98f4eea749c5ecae407d3de661510cc88cd3c28", "message": "some cell rendering improvements", "committedDate": "2020-07-21T19:59:28Z", "type": "commit"}, {"oid": "28272bdfccb62d884f69c8084a1a49370f254d6a", "url": "https://github.com/OpenRefine/OpenRefine/commit/28272bdfccb62d884f69c8084a1a49370f254d6a", "message": "more render row improvements", "committedDate": "2020-07-21T20:07:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyNTY2Mw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2973#discussion_r459825663", "bodyText": "I haven't investigated in detail, so I may be completely off base, but is there an opportunity to use a single global function here which knows how to find the relevant element and visible/hidden status based on information from the event so that we don't have to create N*2 functions?", "author": "tfmorris", "createdAt": "2020-07-24T02:33:39Z", "path": "main/webapp/modules/core/scripts/views/data-table/cell-ui.js", "diffHunk": "@@ -62,43 +62,50 @@ DataTableCellUI.prototype._render = function() {\n   var self = this;\n   var cell = this._cell;\n \n-  var divContent = $('<div/>')\n-  .addClass(\"data-table-cell-content\");\n+  var divContent = document.createElement('div');\n+  divContent.className = 'data-table-cell-content';\n \n-  var editLink = $('<a href=\"javascript:{}\">&nbsp;</a>')\n-  .addClass(\"data-table-cell-edit\")\n-  .attr(\"title\", $.i18n('core-views/edit-cell'))\n-  .appendTo(divContent)\n-  .click(function() { self._startEdit(this); });\n+  var editLink = document.createElement('a');\n+  editLink.className = 'data-table-cell-edit';\n+  editLink.setAttribute('title', $.i18n('core-views/edit-cell'));\n+  editLink.href = 'javascript:{}';\n+  divContent.appendChild(editLink).appendChild(document.createTextNode('\\u00A0'));\n+  editLink.addEventListener('click', function() { self._startEdit(this); });\n \n   $(this._td).empty()\n   .unbind()\n-  .mouseenter(function() { editLink.css(\"visibility\", \"visible\"); })\n-  .mouseleave(function() { editLink.css(\"visibility\", \"hidden\"); });\n+  .mouseenter(function() { editLink.style.visibility = \"visible\" })", "originalCommit": "28272bdfccb62d884f69c8084a1a49370f254d6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzNTQ0Mw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2973#discussion_r460535443", "bodyText": "That should be possible, I will take a look it.", "author": "lisa761", "createdAt": "2020-07-26T14:37:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyNTY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk1MzYwMg==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2973#discussion_r460953602", "bodyText": "So I checked it, and passing arguments to an event handler is not possible unless we create a function to do it, which would make it's removal redundant. The other possible way would be to use event.currentTarget instead of passing editLink, or declaring it as a global variable. But since it's jQuery the event is a jQuery object, and we'd end up using jQuery to style the element.", "author": "lisa761", "createdAt": "2020-07-27T14:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyNTY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTExMzMyMw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2973#discussion_r461113323", "bodyText": "OK, thanks for investigating. Sorry to send you on a wild goose chase!", "author": "tfmorris", "createdAt": "2020-07-27T19:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyNTY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyNTg2NA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2973#discussion_r459825864", "bodyText": "Is this duplication correct? (I know it has nothing to do with your change)", "author": "tfmorris", "createdAt": "2020-07-24T02:34:48Z", "path": "main/webapp/modules/core/scripts/views/data-table/cell-ui.js", "diffHunk": "@@ -62,43 +62,50 @@ DataTableCellUI.prototype._render = function() {\n   var self = this;\n   var cell = this._cell;\n \n-  var divContent = $('<div/>')\n-  .addClass(\"data-table-cell-content\");\n+  var divContent = document.createElement('div');\n+  divContent.className = 'data-table-cell-content';\n \n-  var editLink = $('<a href=\"javascript:{}\">&nbsp;</a>')\n-  .addClass(\"data-table-cell-edit\")\n-  .attr(\"title\", $.i18n('core-views/edit-cell'))\n-  .appendTo(divContent)\n-  .click(function() { self._startEdit(this); });\n+  var editLink = document.createElement('a');\n+  editLink.className = 'data-table-cell-edit';\n+  editLink.setAttribute('title', $.i18n('core-views/edit-cell'));\n+  editLink.href = 'javascript:{}';\n+  divContent.appendChild(editLink).appendChild(document.createTextNode('\\u00A0'));\n+  editLink.addEventListener('click', function() { self._startEdit(this); });\n \n   $(this._td).empty()\n   .unbind()\n-  .mouseenter(function() { editLink.css(\"visibility\", \"visible\"); })\n-  .mouseleave(function() { editLink.css(\"visibility\", \"hidden\"); });\n+  .mouseenter(function() { editLink.style.visibility = \"visible\" })\n+  .mouseleave(function() { editLink.style.visibility = \"hidden\" });\n \n   if (!cell || (\"v\" in cell && cell.v === null)) {\n-    $('<span>').addClass(\"data-table-null\").html('null').appendTo(divContent);\n+    var nullSpan = document.createElement('span');\n+    nullSpan.className = 'data-table-null';\n+    nullSpan.innerHTML = 'null';\n+    divContent.appendChild(nullSpan);\n   } else if (\"e\" in cell) {\n-    $('<span>').addClass(\"data-table-error\").text(cell.e).appendTo(divContent);\n+    var errorSpan = document.createElement('span');\n+    errorSpan.className = 'data-table-error';\n+    errorSpan.textContent = cell.e;\n+    divContent.appendChild(errorSpan);\n   } else if (!(\"r\" in cell) || !cell.r) {\n     if (typeof cell.v !== \"string\" || \"t\" in cell) {\n       if (typeof cell.v == \"number\") {\n         divContent.addClass(\"data-table-cell-content-numeric\");\n       }\n-      $('<span>')\n-      .addClass(\"data-table-value-nonstring\")\n-      .text(cell.v)\n-      .appendTo(divContent);\n+      var nonstringSpan = document.createElement('span');\n+      nonstringSpan.className = 'data-table-value-nonstring';\n+      nonstringSpan.textContent = cell.v;\n+      divContent.appendChild(nonstringSpan);\n     } else if (URL.looksLikeUrl(cell.v)) {\n-      $('<a>')\n-      .text(cell.v)\n-      .attr(\"href\", cell.v)\n-      .attr(\"target\", \"_blank\")\n-      .appendTo(divContent);\n+      var url = document.createElement('a');\n+      url.textContent = cell.v;\n+      url.setAttribute('href', cell.v);", "originalCommit": "28272bdfccb62d884f69c8084a1a49370f254d6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUyOTE0NA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2973#discussion_r460529144", "bodyText": "This is used in cases of url so that what's displayed within the cell is the same url as the hyperlink for the <a> tag. So for cells that have a url, the displayed value is the said url.", "author": "lisa761", "createdAt": "2020-07-26T13:39:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyNTg2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyNjQ3OQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2973#discussion_r459826479", "bodyText": "I don't recognize the \\u00A0 text node idiom. What is it doing? If it's uncommon, as opposed to just my Javascript na\u00efvet\u00e9, perhaps a comment on first appearance is in order.", "author": "tfmorris", "createdAt": "2020-07-24T02:38:16Z", "path": "main/webapp/modules/core/scripts/views/data-table/data-table-view.js", "diffHunk": "@@ -397,11 +397,12 @@ DataTableView.prototype._renderDataTables = function(table, tableHeader) {\n     $(tr).empty();\n     var cells = row.cells;\n     var tdStar = tr.insertCell(tr.cells.length);\n-    var star = $('<a href=\"javascript:{}\">&nbsp;</a>')\n-    .addClass(row.starred ? \"data-table-star-on\" : \"data-table-star-off\")\n-    .appendTo(tdStar)\n-    .click(function() {\n-      var newStarred = !row.starred;\n+    var star = document.createElement('a');\n+    star.href = \"javascript:{}\";\n+    star.classList.add(row.starred ? \"data-table-star-on\" : \"data-table-star-off\");\n+    tdStar.appendChild(star).appendChild(document.createTextNode('\\u00A0'));", "originalCommit": "28272bdfccb62d884f69c8084a1a49370f254d6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUzMDA5OQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2973#discussion_r460530099", "bodyText": "\\u00A0 is actually the unicode character for nbsp, I used it here to insert nbsp text nodes within the tags. I am not sure how common it is though. But as far as I checked this seems to be one of the easier ways to insert nbsp text using javascript. Here is the Stack Overflow answer about it: https://stackoverflow.com/a/10951405/11943496", "author": "lisa761", "createdAt": "2020-07-26T13:49:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyNjQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTExNDc1OA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2973#discussion_r461114758", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                tdStar.appendChild(star).appendChild(document.createTextNode('\\u00A0'));\n          \n          \n            \n                tdStar.appendChild(star).appendChild(document.createTextNode('\\u00A0')); // NBSP\n          \n      \n    \n    \n  \n\nGot it. Perhaps just add a brief comment on the first use to help out readers who don't have their Unicode code points memorized.", "author": "tfmorris", "createdAt": "2020-07-27T19:21:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyNjQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE1MjM5Nw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2973#discussion_r461152397", "bodyText": "Okay, I will add it!", "author": "lisa761", "createdAt": "2020-07-27T20:32:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyNjQ3OQ=="}], "type": "inlineReview"}, {"oid": "94e5e7b4330d9bd6c996ca6d7bef0249b8f35b0e", "url": "https://github.com/OpenRefine/OpenRefine/commit/94e5e7b4330d9bd6c996ca6d7bef0249b8f35b0e", "message": "fixed jQuery methods on js elements", "committedDate": "2020-07-27T12:52:43Z", "type": "commit"}, {"oid": "f090797e958ab5187c5bf910dc5fa4ca3e21af05", "url": "https://github.com/OpenRefine/OpenRefine/commit/f090797e958ab5187c5bf910dc5fa4ca3e21af05", "message": "added comment for nbsp", "committedDate": "2020-07-27T21:05:53Z", "type": "commit"}]}