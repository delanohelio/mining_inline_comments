{"pr_number": 2925, "pr_title": "Add Citation needed Scrutinizer", "pr_createdAt": "2020-07-13T05:44:51Z", "pr_url": "https://github.com/OpenRefine/OpenRefine/pull/2925", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYyNjM0Mg==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2925#discussion_r457626342", "bodyText": "Why should the severity be\"critical\" for new items and \"info\" otherwise? \"critical\" is really high, it will prevent people from uploading anything with the tool. I do not think we should take into account whether the item is new or not here: there is no point uploading statements if we are sure that they already exist and are sourced in Wikidata.\nCurrently, we have the \"warning\" level for all unsourced statements. When there is an explicit \"citation needed\" constraint, we could perhaps just raise the severity by one level (\"important\")?", "author": "wetneb", "createdAt": "2020-07-20T19:00:03Z", "path": "extensions/wikidata/src/org/openrefine/wikidata/qa/scrutinizers/UnsourcedScrutinizer.java", "diffHunk": "@@ -23,23 +23,44 @@\n  ******************************************************************************/\n package org.openrefine.wikidata.qa.scrutinizers;\n \n-import org.wikidata.wdtk.datamodel.interfaces.EntityIdValue;\n+import org.openrefine.wikidata.qa.QAWarning;\n+import org.openrefine.wikidata.updates.ItemUpdate;\n+import org.wikidata.wdtk.datamodel.interfaces.PropertyIdValue;\n+import org.wikidata.wdtk.datamodel.interfaces.Reference;\n import org.wikidata.wdtk.datamodel.interfaces.Statement;\n \n+import java.util.List;\n+\n /**\n  * A scrutinizer checking for unsourced statements\n  * \n  * @author Antonin Delpeuch\n  *\n  */\n-public class UnsourcedScrutinizer extends StatementScrutinizer {\n+public class UnsourcedScrutinizer extends EditScrutinizer {\n \n-    public static final String type = \"unsourced-statements\";\n+    public static final String CITATION_NEEDED_QID = \"Q54554025\";\n+    public static final String generalType = \"unsourced-statements\";\n+    public static final String existingItemType = \"no-references-provided\";\n+    public static final String newItemType = \"no-references-found\";\n \n     @Override\n-    public void scrutinize(Statement statement, EntityIdValue entityId, boolean added) {\n-        if (statement.getReferences().isEmpty() && added) {\n-            warning(type);\n+    public void scrutinize(ItemUpdate update) {\n+        for (Statement statement : update.getAddedStatements()) {\n+            PropertyIdValue pid = statement.getClaim().getMainSnak().getPropertyId();\n+            List<Statement> constraintDefinitions = _fetcher.getConstraintsByType(pid, CITATION_NEEDED_QID);\n+            List<Reference> referenceList = statement.getReferences();\n+\n+            if (referenceList.isEmpty()) {\n+                if (!constraintDefinitions.isEmpty()) {\n+                    QAWarning issue = new QAWarning(update.isNew() ? newItemType : existingItemType, pid.getId(), update.isNew() ? QAWarning.Severity.CRITICAL : QAWarning.Severity.INFO, 1);", "originalCommit": "897087007a6ec88bc4f6a9052f5d3ba14f2dd208", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzYzMDAzMQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2925#discussion_r457630031", "bodyText": "I think we can have only one issue type (whether the item is new or not should not matter, see below). The issue body is not very fluid in my opinion, how about this: The property {property_entity} specifically requires at least one reference for its statements.", "author": "wetneb", "createdAt": "2020-07-20T19:06:52Z", "path": "extensions/wikidata/module/langs/translation-en.json", "diffHunk": "@@ -148,6 +148,10 @@\n     \"warnings-messages/multi-valued-property-is-required-for-new-item/body\": \"This property is expected to have more than one statement on each item but it has single statement, for instance on {example_entity}.\",\n     \"warnings-messages/multi-valued-property-is-required-for-existing-item/title\": \"{property_entity} should have more than one statement on existing items.\",\n     \"warnings-messages/multi-valued-property-is-required-for-existing-item/body\": \"This property is expected to have more than one statement on each item but it has single statement, for instance on {example_entity}. If the item already has statements with this property in Wikidata, then this warning can be ignored.\",\n+    \"warnings-messages/no-references-found/title\": \"{property_entity} requires at least one reference.\",\n+    \"warnings-messages/no-references-found/body\": \"Statements with property {property_entity} violating citation-needed constraint, it should have at least one reference\",", "originalCommit": "897087007a6ec88bc4f6a9052f5d3ba14f2dd208", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4cf0fd1f5f5d6c2a465864e28468028c85b518ee", "url": "https://github.com/OpenRefine/OpenRefine/commit/4cf0fd1f5f5d6c2a465864e28468028c85b518ee", "message": "Add Citation needed scrutinizer\n\nImplemented Citation needed Cconstraint as part of #2354\n\nTest class added with appropriate testc cases\n\nUpdated severity level to critical as well as the messages\n\nmerged unsourced and citation-needed scrutinizer\n\nupdated severity levels and warning messages", "committedDate": "2020-07-21T05:49:40Z", "type": "commit"}]}