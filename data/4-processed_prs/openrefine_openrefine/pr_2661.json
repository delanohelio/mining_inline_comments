{"pr_number": 2661, "pr_title": "OAuth support for Wikidata extension", "pr_createdAt": "2020-06-01T01:07:55Z", "pr_url": "https://github.com/OpenRefine/OpenRefine/pull/2661", "timeline": [{"oid": "f719f667c4d0682333541501aefa261fe5e753a4", "url": "https://github.com/OpenRefine/OpenRefine/commit/f719f667c4d0682333541501aefa261fe5e753a4", "message": "initial commit", "committedDate": "2020-06-02T14:18:54Z", "type": "forcePushed"}, {"oid": "29a757dc57d0cc4b246eac004f9edf2729a26881", "url": "https://github.com/OpenRefine/OpenRefine/commit/29a757dc57d0cc4b246eac004f9edf2729a26881", "message": "Added support for Multi-value Constraint in Wikidata extension (#2629)", "committedDate": "2020-05-31T13:24:51Z", "type": "forcePushed"}, {"oid": "0aee0954d1b4e5dfb4d166e82781c1f2d7ee5bbe", "url": "https://github.com/OpenRefine/OpenRefine/commit/0aee0954d1b4e5dfb4d166e82781c1f2d7ee5bbe", "message": "finish the prototype", "committedDate": "2020-06-02T15:12:36Z", "type": "commit"}, {"oid": "de080e60e804dd98189551e31c973b5a84bf1ec7", "url": "https://github.com/OpenRefine/OpenRefine/commit/de080e60e804dd98189551e31c973b5a84bf1ec7", "message": "improve the prototype & add tests", "committedDate": "2020-06-03T14:59:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4MDY2Mw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r434180663", "bodyText": "This module already has a Logger defined, so you can use something like logger.debug() here and then you can turn it on/off via the logging levels rather than have to worry about continually added and removing println()s", "author": "tfmorris", "createdAt": "2020-06-02T21:17:28Z", "path": "extensions/wikidata/src/org/openrefine/wikidata/editing/ConnectionManager.java", "diffHunk": "@@ -168,4 +203,12 @@ protected BasicApiConnection createNewConnection() {\n         conn.setReadTimeout(READ_TIMEOUT);\n         return conn;\n     }\n+\n+    public String getAuthorizationUrl() throws InterruptedException, ExecutionException, IOException {\n+        System.out.println(\"Fetching the Request Token...\");", "originalCommit": "0aee0954d1b4e5dfb4d166e82781c1f2d7ee5bbe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0NjA2Nw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r435746067", "bodyText": "Thanks for the review. I'll try using logger.debug() in later developing.", "author": "afkbrb", "createdAt": "2020-06-05T07:44:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4MDY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4MjMyMw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r434182323", "bodyText": "The control flow will probably be a little cleaner here if you use a single IF, ANDing both conditions, to conditionalize your SET. That will save using a label and multiple GOTOs (which we generally try to avoid, if possible).", "author": "tfmorris", "createdAt": "2020-06-02T21:20:49Z", "path": "refine.bat", "diffHunk": "@@ -188,6 +188,11 @@ if \"%GDATA_CLIENT_SECRET%\" == \"\" goto skipGDataCredentials\n set OPTS=%OPTS% -Dext.gdata.clientid=%GDATA_CLIENT_ID% -Dext.gdata.clientsecret=%GDATA_CLIENT_SECRET%\n :skipGDataCredentials\n \n+if \"%WIKIDATA_CLIENT_ID%\" == \"\" goto skipWikidataCredentials\n+if \"%WIKIDATA_CLIENT_SECRET%\" == \"\" goto skipWikidataCredentials", "originalCommit": "0aee0954d1b4e5dfb4d166e82781c1f2d7ee5bbe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxNTUzMQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r436315531", "bodyText": "Emm, the if statement doesn't support logical operators (https://stackoverflow.com/a/2143203/10464202), but we can rewrite it like\nif not \"%WIKIDATA_CLIENT_ID%\" == \"\" if not \"%WIKIDATA_CLIENT_SECRET%\" == \"\" set OPTS=%OPTS% -Dext.wikidata.clientid=%WIKIDATA_CLIENT_ID% -Dext.wikidata.clientsecret=%WIKIDATA_CLIENT_SECRET%\n\nBut that line will be too long.", "author": "afkbrb", "createdAt": "2020-06-07T01:34:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4MjMyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxNjkwNA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r436316904", "bodyText": "Oops, sorry! I was thinking of shell scripts and totally missed the fact that it's the Windows .bat file.\nIt's been so long since I've written Windows batch files that I'm not an expert at all, but if something like this would do the trick:\nif not \"%WIKIDATA_CLIENT_ID%\" == \"\" (\n  if not \"%WIKIDATA_CLIENT_SECRET%\" == \"\" (\n    set OPTS=%OPTS% -Dext.wikidata.clientid=%WIKIDATA_CLIENT_ID% -Dext.wikidata.clientsecret=%WIKIDATA_CLIENT_SECRET%\n  )\n)\n\nI think it would be slightly cleaner control flow, but don't spend more than 5 minutes on it.", "author": "tfmorris", "createdAt": "2020-06-07T02:04:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4MjMyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxNzIwNw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r436317207", "bodyText": "Terrific! I didn't notice that we can use parentheses here...", "author": "afkbrb", "createdAt": "2020-06-07T02:11:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE4MjMyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3NjUyNg==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r435676526", "bodyText": "Missing close newline at end of file.", "author": "tfmorris", "createdAt": "2020-06-05T03:55:21Z", "path": "refine.ini", "diffHunk": "@@ -34,3 +34,7 @@ REFINE_MIN_MEMORY=1400M\n # After getting the client_id and client_secret, put them below\n #GDATA_CLIENT_ID=your_client_id\n #GDATA_CLIENT_SECRET=your_client_secret\n+\n+# OAuth credentials configurations for Wikidata\n+#WIKIDATA_CLIENT_ID=your_client_id\n+#WIKIDATA_CLIENT_SECRET=your_client_secret", "originalCommit": "de080e60e804dd98189551e31c973b5a84bf1ec7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3Nzk1Ng==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r435677956", "bodyText": "User visible strings need to be internationalized using $.i18n()", "author": "tfmorris", "createdAt": "2020-06-05T04:02:26Z", "path": "extensions/wikidata/module/scripts/dialogs/manage-account-dialog.js", "diffHunk": "@@ -33,89 +45,135 @@ ManageAccountDialog.display = function(logged_in_username, saved_credentials, ca\n   this._elmts.loginButton.val($.i18n('wikidata-account/log-in'));\n \n   if (logged_in_username != null) {\n-      elmts.loginArea.remove();\n+    elmts.loginArea.remove();\n   } else {\n-      elmts.logoutArea.remove();\n+    elmts.logoutArea.remove();\n   }\n \n   this._level = DialogSystem.showDialog(frame);\n-  this._elmts.usernameInput.focus();\n+  if (!support_oauth) {\n+    this._elmts.usernameInput.focus();\n+  }\n \n-  var dismiss = function() {\n+  var dismiss = function () {\n     DialogSystem.dismissUntil(self._level - 1);\n   };\n \n   elmts.loggedInUsername\n-     .text(logged_in_username)\n-     .attr('href', 'https://www.wikidata.org/wiki/User:'+logged_in_username);\n+      .text(logged_in_username)\n+      .attr('href', 'https://www.wikidata.org/wiki/User:' + logged_in_username);\n \n-  elmts.cancelButton1.click(function(e) {\n-     dismiss();\n-     callback(null);\n+  elmts.cancelButton1.click(function (e) {\n+    dismiss();\n+    callback(null);\n   });\n-  elmts.cancelButton2.click(function(e) {\n-     dismiss();\n-     callback(null);\n+  elmts.cancelButton2.click(function (e) {\n+    dismiss();\n+    callback(null);\n   });\n \n-  elmts.loginForm.submit(function(e) {\n-      frame.hide();\n-      Refine.postCSRF(\n+  elmts.loginForm.submit(function (e) {\n+        frame.hide();\n+        if (support_oauth) {\n+          ManageAccountDialog.oauth(\n+              \"command/wikidata/authorize?remember-credentials=\" + elmts.rememberCredentials.val(),\n+              function () {\n+                $.get(\n+                    \"command/wikidata/login\",\n+                    function (data) {\n+                      if (data.logged_in) {\n+                        dismiss();\n+                        callback(data.username);\n+                      } else {\n+                        frame.show();\n+                        elmts.invalidCredentials.text(\"Invalid credentials.\");", "originalCommit": "de080e60e804dd98189551e31c973b5a84bf1ec7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3ODY2MQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r435678661", "bodyText": "Is this an OpenRefine bug or Wikidata Toolkit bug?", "author": "tfmorris", "createdAt": "2020-06-05T04:05:30Z", "path": "extensions/wikidata/src/org/openrefine/wikidata/commands/AuthorizeCommand.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package org.openrefine.wikidata.commands;\n+\n+import com.google.refine.commands.Command;\n+import org.openrefine.wikidata.editing.ConnectionManager;\n+\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.io.Writer;\n+\n+/**\n+ * Command for redirecting the user to the authorization page.\n+ */\n+public class AuthorizeCommand extends Command {\n+\n+    @Override\n+    public void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {\n+        ConnectionManager manager = ConnectionManager.getInstance();\n+        try {\n+            if (manager.supportOAuth()) {\n+                String remember = request.getParameter(\"remember-credentials\");\n+                manager.setRememberCredentials(\"on\".equals(remember));\n+                String authorizationUrl = manager.getAuthorizationUrl();\n+                response.sendRedirect(authorizationUrl);\n+            } else {\n+                throw new IllegalStateException(\"You must configure Wikidata OAuth client id/secret in refine.ini \" +\n+                        \"in order to use OAuth to login\");\n+            }\n+        } catch (Exception e) {\n+            // TODO: use respondWithErrorPage after fixing its relative path bug", "originalCommit": "de080e60e804dd98189551e31c973b5a84bf1ec7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc0NTE4NA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r435745184", "bodyText": "OpenRefine bug. Reported at #2678", "author": "afkbrb", "createdAt": "2020-06-05T07:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3ODY2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3ODg1Mw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r435678853", "bodyText": "This probably should be an error code or something which gets interpretted on the front end so that we can take advantage of the i18n support there.", "author": "tfmorris", "createdAt": "2020-06-05T04:06:24Z", "path": "extensions/wikidata/src/org/openrefine/wikidata/commands/AuthorizeCommand.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package org.openrefine.wikidata.commands;\n+\n+import com.google.refine.commands.Command;\n+import org.openrefine.wikidata.editing.ConnectionManager;\n+\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.io.Writer;\n+\n+/**\n+ * Command for redirecting the user to the authorization page.\n+ */\n+public class AuthorizeCommand extends Command {\n+\n+    @Override\n+    public void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {\n+        ConnectionManager manager = ConnectionManager.getInstance();\n+        try {\n+            if (manager.supportOAuth()) {\n+                String remember = request.getParameter(\"remember-credentials\");\n+                manager.setRememberCredentials(\"on\".equals(remember));\n+                String authorizationUrl = manager.getAuthorizationUrl();\n+                response.sendRedirect(authorizationUrl);\n+            } else {\n+                throw new IllegalStateException(\"You must configure Wikidata OAuth client id/secret in refine.ini \" +", "originalCommit": "de080e60e804dd98189551e31c973b5a84bf1ec7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "de080e60e804dd98189551e31c973b5a84bf1ec7", "url": "https://github.com/OpenRefine/OpenRefine/commit/de080e60e804dd98189551e31c973b5a84bf1ec7", "message": "improve the prototype & add tests", "committedDate": "2020-06-03T14:59:03Z", "type": "forcePushed"}, {"oid": "9b74c5de8825bf569a9c7e759a556e36a11aed11", "url": "https://github.com/OpenRefine/OpenRefine/commit/9b74c5de8825bf569a9c7e759a556e36a11aed11", "message": "finish the prototype", "committedDate": "2020-06-07T01:06:15Z", "type": "commit"}, {"oid": "2c1ccad08904bc5c0d1167f0a16c9d51b9398d61", "url": "https://github.com/OpenRefine/OpenRefine/commit/2c1ccad08904bc5c0d1167f0a16c9d51b9398d61", "message": "improve the prototype & add tests", "committedDate": "2020-06-07T01:06:15Z", "type": "commit"}, {"oid": "0e285af4d21f92a253caa8e5f26af1fddf548543", "url": "https://github.com/OpenRefine/OpenRefine/commit/0e285af4d21f92a253caa8e5f26af1fddf548543", "message": "Merge branch 'wikidata-extension-oauth' of github.com:afkbrb/OpenRefine into wikidata-extension-oauth", "committedDate": "2020-06-07T01:07:02Z", "type": "commit"}, {"oid": "fe9350aa6ae629e857523f6791e48d0fb9ea1748", "url": "https://github.com/OpenRefine/OpenRefine/commit/fe9350aa6ae629e857523f6791e48d0fb9ea1748", "message": "finish owner-only consumer support", "committedDate": "2020-06-12T07:16:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwNjI4Nw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r439806287", "bodyText": "Should the final period of the two messages above be included in the link? I would normally do </a>. instead.", "author": "wetneb", "createdAt": "2020-06-14T08:44:57Z", "path": "extensions/wikidata/module/langs/translation-en.json", "diffHunk": "@@ -65,11 +65,24 @@\n     \"wikidata-preview/new-id\": \"new item\",\n     \"wikidata-account/dialog-header\": \"Wikidata account\",\n     \"wikidata-account/explain-log-in\": \"Logging in to <a href=\\\"https://www.wikidata.org/\\\" target=\\\"_blank\\\">Wikidata</a> lets you to upload edits directly from OpenRefine.\",\n+    \"wikidata-account/explain-owner-only-consumer-wiki\": \"See this <a href=\\\"https://github.com/OpenRefine/OpenRefine/wiki/Wikidata-owner-only-consumer\\\" target=\\\"_blank\\\">wiki</a> to get your owner-only consumer if you don't have one.\",\n+    \"wikidata-account/explain-password-login\": \"You can also <a href=\\\"javascript:void(0)\\\">login with your username/password.</a>\",\n+    \"wikidata-account/explain-owner-only-consumer-login\": \"You can also <a href=\\\"javascript:void(0)\\\">login with your owner-only consumer.</a>\",", "originalCommit": "fe9350aa6ae629e857523f6791e48d0fb9ea1748", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0MTA3OQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r439841079", "bodyText": "I'll update the code tomorrow (my local time).", "author": "afkbrb", "createdAt": "2020-06-14T15:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwNjI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0MDMwMQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r439840301", "bodyText": "For people upgrading from previous versions, should we try to delete any existing preference setting stored at this key? That would ensure we clean up credentials stored in plain text there.", "author": "wetneb", "createdAt": "2020-06-14T15:21:39Z", "path": "extensions/wikidata/src/org/openrefine/wikidata/editing/ConnectionManager.java", "diffHunk": "@@ -23,114 +23,100 @@\n  ******************************************************************************/\n package org.openrefine.wikidata.editing;\n \n-import java.io.IOException;\n-\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.wikidata.wdtk.wikibaseapi.ApiConnection;\n import org.wikidata.wdtk.wikibaseapi.BasicApiConnection;\n import org.wikidata.wdtk.wikibaseapi.LoginFailedException;\n+import org.wikidata.wdtk.wikibaseapi.OAuthApiConnection;\n import org.wikidata.wdtk.wikibaseapi.apierrors.MediaWikiApiErrorException;\n \n-import com.fasterxml.jackson.databind.node.ArrayNode;\n-import com.fasterxml.jackson.databind.node.ObjectNode;\n-import com.google.refine.ProjectManager;\n-import com.google.refine.preference.PreferenceStore;\n-import com.google.refine.util.ParsingUtilities;\n+import java.io.IOException;\n \n /**\n- * Manages a connection to Wikidata, with login credentials stored in the\n- * preferences.\n- * \n- * Ideally, we should store only the cookies and not the password. But\n- * Wikidata-Toolkit does not allow for that as cookies are kept private.\n- * \n- * This class is also hard-coded for Wikidata: generalization to other Wikibase\n- * instances should be feasible though.\n- * \n+ * Manages a connection to Wikidata.\n+ * <p>\n+ * The connection can be either {@link BasicApiConnection} or {@link OAuthApiConnection}.\n+ * <p>\n+ * This class is also hard-coded for Wikidata,\n+ * it will be generalized to other Wikibase instances soon.\n+ *\n  * @author Antonin Delpeuch\n+ * @author Lu Liu\n  */\n \n public class ConnectionManager {\n-    \n-    final static Logger logger = LoggerFactory.getLogger(\"connection_mananger\");\n \n-    public static final String PREFERENCE_STORE_KEY = \"wikidata_credentials\";", "originalCommit": "fe9350aa6ae629e857523f6791e48d0fb9ea1748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0MDU0OQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r439840549", "bodyText": "Instead of storing the password as cookie, could we store Wikidata's cookie as a cookie ourselves? That should let us restore the connection later on, without storing the user's password at all.", "author": "wetneb", "createdAt": "2020-06-14T15:24:17Z", "path": "extensions/wikidata/src/org/openrefine/wikidata/commands/LoginCommand.java", "diffHunk": "@@ -23,61 +23,177 @@\n  ******************************************************************************/\n package org.openrefine.wikidata.commands;\n \n-import java.io.IOException;\n-import java.io.Writer;\n+import com.google.refine.commands.Command;\n+import org.openrefine.wikidata.editing.ConnectionManager;\n \n import javax.servlet.ServletException;\n+import javax.servlet.http.Cookie;\n import javax.servlet.http.HttpServletRequest;\n import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Map;\n \n-import org.openrefine.wikidata.editing.ConnectionManager;\n-\n-import com.fasterxml.jackson.core.JsonGenerator;\n-import com.google.refine.commands.Command;\n-import com.google.refine.util.ParsingUtilities;\n+import static org.apache.commons.lang.StringUtils.isBlank;\n+import static org.apache.commons.lang.StringUtils.isNotBlank;\n \n+/**\n+ * Handles login.\n+ * <p>\n+ * Both logging in with username/password or owner-only consumer are supported.\n+ * <p>\n+ * This command also manages cookies of login credentials.\n+ */\n public class LoginCommand extends Command {\n \n+    static final String USERNAME = \"wb-username\";\n+    static final String PASSWORD = \"wb-password\";\n+\n+    static final String CONSUMER_TOKEN = \"wb-consumer-token\";\n+    static final String CONSUMER_SECRET = \"wb-consumer-secret\";\n+    static final String ACCESS_TOKEN = \"wb-access-token\";\n+    static final String ACCESS_SECRET = \"wb-access-secret\";\n+\n     @Override\n     public void doPost(HttpServletRequest request, HttpServletResponse response)\n             throws ServletException, IOException {\n-    \tif(!hasValidCSRFToken(request)) {\n-    \t\trespondCSRFError(response);\n-    \t\treturn;\n-    \t}\n-    \trespond(request, response);\n-    }\n-    \n-    protected void respond(HttpServletRequest request, HttpServletResponse response)\n-    \tthrows ServletException, IOException {\n-        String username = request.getParameter(\"wb-username\");\n-        String password = request.getParameter(\"wb-password\");\n-        String remember = request.getParameter(\"remember-credentials\");\n+        if (!hasValidCSRFToken(request)) {\n+            respondCSRFError(response);\n+            return;\n+        }\n+\n         ConnectionManager manager = ConnectionManager.getInstance();\n-        if (username != null && password != null) {\n-            manager.login(username, password, \"on\".equals(remember));\n-        } else if (\"true\".equals(request.getParameter(\"logout\"))) {\n+\n+        if (\"true\".equals(request.getParameter(\"logout\"))) {\n             manager.logout();\n+            removeUsernamePasswordCookies(response);\n+            removeOwnOnlyConsumerCookies(response);\n+            respond(request, response);\n+            return; // return directly\n+        }\n+\n+        boolean remember = \"on\".equals(request.getParameter(\"remember-credentials\"));\n+\n+        Cookie[] cookies = request.getCookies();\n+\n+        // Credentials from parameters have higher priority than those from cookies.\n+        String username = request.getParameter(USERNAME);\n+        String password = request.getParameter(PASSWORD);\n+\n+        if (isBlank(username) || isBlank(password)) {\n+            for (Cookie cookie : cookies) {\n+                String value = cookie.getValue();\n+                switch (cookie.getName()) {\n+                    case USERNAME:\n+                        username = value;\n+                        break;\n+                    case PASSWORD:\n+                        password = value;\n+                        break;\n+                    default:\n+                        break;\n+                }\n+            }\n+            if (isNotBlank(username) && isNotBlank(password)) {\n+                // If the credentials are read from cookies, we must remember it.\n+                remember = true;\n+            }\n         }\n-        response.setCharacterEncoding(\"UTF-8\");\n-        response.setHeader(\"Content-Type\", \"application/json\");\n-\n-        Writer w = response.getWriter();\n-        JsonGenerator writer = ParsingUtilities.mapper.getFactory().createGenerator(w);\n-\n-        writer.writeStartObject();\n-        writer.writeBooleanField(\"logged_in\", manager.isLoggedIn());\n-        writer.writeStringField(\"username\", manager.getUsername());\n-        writer.writeEndObject();\n-        writer.flush();\n-        writer.close();\n-        w.flush();\n-        w.close();\n+\n+        String consumerToken = request.getParameter(CONSUMER_TOKEN);\n+        String consumerSecret = request.getParameter(CONSUMER_SECRET);\n+        String accessToken = request.getParameter(ACCESS_TOKEN);\n+        String accessSecret = request.getParameter(ACCESS_SECRET);\n+\n+        if (isBlank(consumerToken)|| isBlank(consumerSecret) || isBlank(accessToken) || isBlank(accessSecret)) {\n+            for (Cookie cookie : cookies) {\n+                String value = cookie.getValue();\n+                switch (cookie.getName()) {\n+                    case CONSUMER_TOKEN:\n+                        consumerToken = value;\n+                        break;\n+                    case CONSUMER_SECRET:\n+                        consumerSecret = value;\n+                        break;\n+                    case ACCESS_TOKEN:\n+                        accessToken = value;\n+                        break;\n+                    case ACCESS_SECRET:\n+                        accessSecret = value;\n+                        break;\n+                    default:\n+                        break;\n+                }\n+            }\n+            if (isNotBlank(consumerToken) && isNotBlank(consumerSecret) && isNotBlank(accessToken) && isNotBlank(accessSecret)) {\n+                remember = true;\n+            }\n+        }\n+\n+        if (isNotBlank(username) && isNotBlank(password)) {\n+            manager.login(username, password);\n+            // Once logged in with new credentials,\n+            // the old credentials in cookies should be cleared.\n+            if (manager.getConnection() != null && remember) {\n+                setCookie(response, USERNAME, username);\n+                setCookie(response, PASSWORD, password);", "originalCommit": "fe9350aa6ae629e857523f6791e48d0fb9ea1748", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg5ODI3Mw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r439898273", "bodyText": "Good idea! This is helpful for logging in with password, but for the owner-only consumer, we still need to store the credentials in cookies.", "author": "afkbrb", "createdAt": "2020-06-15T02:08:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0MDU0OQ=="}], "type": "inlineReview"}, {"oid": "da7e8370eeb515eb442226282c4b53b317cc429f", "url": "https://github.com/OpenRefine/OpenRefine/commit/da7e8370eeb515eb442226282c4b53b317cc429f", "message": "remove unnecessary 'href=\"javascript:void(0)\"' of <a> tags", "committedDate": "2020-06-15T02:02:32Z", "type": "commit"}, {"oid": "85d8337fd731f53fb156a8e2ffe82a7f9b4a680d", "url": "https://github.com/OpenRefine/OpenRefine/commit/85d8337fd731f53fb156a8e2ffe82a7f9b4a680d", "message": "swap explaining messages", "committedDate": "2020-06-15T02:03:22Z", "type": "commit"}, {"oid": "08f37a98c85bd120d79718511aa69dfb2ae384d7", "url": "https://github.com/OpenRefine/OpenRefine/commit/08f37a98c85bd120d79718511aa69dfb2ae384d7", "message": "store Wikidata's cookies instead of password in cookies", "committedDate": "2020-06-15T10:39:01Z", "type": "commit"}, {"oid": "c2a40a95786099585f701e6a2909a29e496bc862", "url": "https://github.com/OpenRefine/OpenRefine/commit/c2a40a95786099585f701e6a2909a29e496bc862", "message": "update \"Remember me\" titles", "committedDate": "2020-06-15T10:49:20Z", "type": "commit"}, {"oid": "9726ed1444992a04c3902c14bb97abe7a8884628", "url": "https://github.com/OpenRefine/OpenRefine/commit/9726ed1444992a04c3902c14bb97abe7a8884628", "message": "Switch to own WDTK snapshot", "committedDate": "2020-06-15T12:32:48Z", "type": "commit"}, {"oid": "cd76df0b293f5b27664d8641134efd96e86d8eb3", "url": "https://github.com/OpenRefine/OpenRefine/commit/cd76df0b293f5b27664d8641134efd96e86d8eb3", "message": "Enable snapshot repository explicitly in root pom", "committedDate": "2020-06-15T12:57:00Z", "type": "commit"}, {"oid": "8fd384f04410da02c12136b6f8a2d9e79770bdf2", "url": "https://github.com/OpenRefine/OpenRefine/commit/8fd384f04410da02c12136b6f8a2d9e79770bdf2", "message": "typo", "committedDate": "2020-06-15T14:59:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNTEwNA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r440535104", "bodyText": "Include the username parameter here so that the translators can use language specific ordering for the phrase:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \"wikidata-account/logged-in-as\": \"You are logged in as:\",\n          \n          \n            \n                \"wikidata-account/logged-in-as\": \"You are logged in as: $1\",\n          \n      \n    \n    \n  \n\nYou'll need to change the Javascript code with the $.i18n call too.", "author": "tfmorris", "createdAt": "2020-06-16T01:30:11Z", "path": "extensions/wikidata/module/langs/translation-en_GB.json", "diffHunk": "@@ -95,17 +95,31 @@\n     \"perform-wikidata-edits/review-your-edits\": \"You are about to upload {nb_edits} edits to Wikidata. Please check them carefully. Large edit batches should be submitted for <a href=\\\"https://www.wikidata.org/wiki/Wikidata:Requests_for_permissions/Bot\\\" target=\\\"_blank\\\">bot review</a> first.\",\n     \"perform-wikidata-edits/dialog-header\": \"Upload edits to Wikidata\",\n     \"wikidata-account/connecting-to-wikidata\": \"Connecting to Wikidata\u2026\",\n-    \"wikidata-account/log-out\": \"Log out\",\n-    \"wikidata-account/logged-in-as\": \"You are logged in as:\",\n-    \"wikidata-account/log-in\": \"Log in\",\n-    \"wikidata-account/close\": \"Close\",\n-    \"wikidata-account/remember-credentials-label\": \"Remember credentials (stored unencrypted in OpenRefine's preferences)\",\n-    \"wikidata-account/password-placeholder\": \"Enter your password\",\n-    \"wikidata-account/password-label\": \"Password:\",\n-    \"wikidata-account/username-placeholder\": \"Enter your username\",\n-    \"wikidata-account/username-label\": \"Username:\",\n-    \"wikidata-account/explain-log-in\": \"Logging in to <a href=\\\"https://www.wikidata.org/\\\" target=\\\"_blank\\\">Wikidata</a> lets you to upload edits directly from OpenRefine.\",\n     \"wikidata-account/dialog-header\": \"Wikidata account\",\n+    \"wikidata-account/explain-log-in\": \"Logging in to <a href=\\\"https://www.wikidata.org/\\\" target=\\\"_blank\\\">Wikidata</a> lets you to upload edits directly from OpenRefine.\",\n+    \"wikidata-account/explain-owner-only-consumer-wiki\": \"See this <a href=\\\"https://github.com/OpenRefine/OpenRefine/wiki/Wikidata-owner-only-consumer\\\" target=\\\"_blank\\\">wiki</a> to get your owner-only consumer if you don't have one.\",\n+    \"wikidata-account/explain-password-login\": \"You can also <a>login with your username/password.</a>\",\n+    \"wikidata-account/explain-owner-only-consumer-login\": \"You can also <a>login with your owner-only consumer.</a>\",\n+    \"wikidata-account/invalid-credentials\": \"Invalid credentials\",\n+    \"wikidata-account/username-label\": \"Username:\",\n+    \"wikidata-account/username-placeholder\": \"username\",\n+    \"wikidata-account/password-label\": \"Password:\",\n+    \"wikidata-account/password-placeholder\": \"password\",\n+    \"wikidata-account/consumer-token-label\": \"Consumer token:\",\n+    \"wikidata-account/consumer-token-placeholder\": \"consumer token\",\n+    \"wikidata-account/consumer-secret-label\": \"Consumer secret:\",\n+    \"wikidata-account/consumer-secret-placeholder\": \"consumer secret\",\n+    \"wikidata-account/access-token-label\": \"Access token:\",\n+    \"wikidata-account/access-token-placeholder\": \"access token\",\n+    \"wikidata-account/access-secret-label\": \"Access secret:\",\n+    \"wikidata-account/access-secret-placeholder\": \"access secret\",\n+    \"wikidata-account/remember-me\": \"Remember me\",\n+    \"wikidata-account/password-remember-me-title\": \"Your password won't be stored.\",\n+    \"wikidata-account/owner-only-consumer-remember-me-title\": \"Consumer credentials are stored encrypted in cookies.\",\n+    \"wikidata-account/close\": \"Close\",\n+    \"wikidata-account/log-in\": \"Log in\",\n+    \"wikidata-account/logged-in-as\": \"You are logged in as:\",", "originalCommit": "8fd384f04410da02c12136b6f8a2d9e79770bdf2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNTYxMw==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r440535613", "bodyText": "This should include the username as a parameter if it's not too complex to manage with the rest of the HTML.", "author": "tfmorris", "createdAt": "2020-06-16T01:32:15Z", "path": "extensions/wikidata/module/scripts/dialogs/manage-account-dialog.js", "diffHunk": "@@ -2,120 +2,210 @@ var ManageAccountDialog = {};\n \n ManageAccountDialog.firstLogin = true;\n \n-ManageAccountDialog.launch = function(logged_in_username, callback) {\n-   $.post(\n-      \"command/core/get-all-preferences\",\n-      null,\n-      function (preferences) {\n-         ManageAccountDialog.display(logged_in_username, preferences.wikidata_credentials, callback);\n-      },\n-      \"json\"\n-  );\n-};\n+ManageAccountDialog.display = function (logged_in_username, callback) {\n \n-ManageAccountDialog.display = function(logged_in_username, saved_credentials, callback) {\n-  var self = this;\n-  var frame = $(DOM.loadHTML(\"wikidata\", \"scripts/dialogs/manage-account-dialog.html\"));\n-  var elmts = this._elmts = DOM.bind(frame);\n-\n-  this._elmts.dialogHeader.text($.i18n('wikidata-account/dialog-header'));\n-  this._elmts.explainLogIn.html($.i18n('wikidata-account/explain-log-in'));\n-  this._elmts.usernameLabel.text($.i18n('wikidata-account/username-label'));\n-  this._elmts.usernameInput.attr(\"placeholder\", $.i18n('wikidata-account/username-placeholder'));\n-  this._elmts.passwordLabel.text($.i18n('wikidata-account/password-label'));\n-  this._elmts.passwordInput.attr(\"placeholder\", $.i18n('wikidata-account/password-placeholder'));\n-  this._elmts.rememberCredentialsLabel.text($.i18n('wikidata-account/remember-credentials-label'));\n-  this._elmts.dialogHeader.text($.i18n('wikidata-account/dialog-header'));\n-  this._elmts.cancelButton1.text($.i18n('wikidata-account/close'));\n-  this._elmts.cancelButton2.text($.i18n('wikidata-account/close'));\n-  this._elmts.loggedInAs.text($.i18n('wikidata-account/logged-in-as'));\n-  this._elmts.logoutButton.text($.i18n('wikidata-account/log-out'));\n-  this._elmts.loginButton.val($.i18n('wikidata-account/log-in'));\n+  if (logged_in_username == null) {\n+    logged_in_username = ManageAccountDialog.tryLoginWithCookies(callback);\n+  }\n \n   if (logged_in_username != null) {\n-      elmts.loginArea.remove();\n+    ManageAccountDialog.displayLoggedIn(logged_in_username, callback);\n   } else {\n-      elmts.logoutArea.remove();\n+    ManageAccountDialog.displayPasswordLogin(callback);\n   }\n+};\n+\n+ManageAccountDialog.tryLoginWithCookies = function (callback) {\n+  var logged_user_name = null;\n+  $.ajaxSetup({async: false});\n+  Refine.postCSRF(\n+      \"command/wikidata/login\",\n+      {},\n+      function (data) {\n+        if (data.logged_in) {\n+          callback(data.username);\n+          logged_user_name = data.username;\n+        } else {\n+          logged_user_name = null;\n+        }\n+      });\n+  $.ajaxSetup({async: true});\n+  return logged_user_name;\n+};\n \n-  this._level = DialogSystem.showDialog(frame);\n-  this._elmts.usernameInput.focus();\n+ManageAccountDialog.initCommon = function (elmts) {\n+  elmts.dialogHeader.text($.i18n('wikidata-account/dialog-header'));\n+  elmts.explainLogIn.html($.i18n('wikidata-account/explain-log-in'));\n+  elmts.cancelButton.text($.i18n('wikidata-account/close'));\n+};\n \n-  var dismiss = function() {\n-    DialogSystem.dismissUntil(self._level - 1);\n+ManageAccountDialog.displayLoggedIn = function (logged_in_username, callback) {\n+  var frame = $(DOM.loadHTML(\"wikidata\", \"scripts/dialogs/logged-in-dialog.html\"));\n+  var elmts = DOM.bind(frame);\n+  ManageAccountDialog.initCommon(elmts);\n+  elmts.loggedInAs.text($.i18n('wikidata-account/logged-in-as'));", "originalCommit": "8fd384f04410da02c12136b6f8a2d9e79770bdf2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNjAwOQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r440536009", "bodyText": "Missing newline at EOF", "author": "tfmorris", "createdAt": "2020-06-16T01:33:56Z", "path": "extensions/wikidata/module/styles/dialogs/manage-account-dialog.less", "diffHunk": "@@ -55,10 +56,39 @@ OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n }\n \n .wikidata-logo {\n+  height: 100%;\n   float: left;\n-  margin: -10px;\n+  margin-right: 50px;\n+  display:flex;\n+  flex-direction: column;\n+  justify-content: center;\n+}\n+\n+.wikidata-logo img {\n+  height: 120px;\n+}\n+\n+.wikibase-login-buttons {\n+  text-align: right;\n+  position: absolute;\n+  right: 12px;\n+  bottom: 12px;\n+}\n+\n+\n+.wikibase-perform-edits-buttons {\n+  text-align: right;\n }\n \n-.right-of-logo {\n-  margin-left: 110px;\n+.wikibase-import-schema-buttons {\n+  text-align: right;\n }\n+\n+\n+.wikibase-login-dialog-footer {\n+  text-align: center;\n+}\n+\n+.wikibase-login-dialog-footer span {\n+  cursor: pointer;\n+}", "originalCommit": "8fd384f04410da02c12136b6f8a2d9e79770bdf2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNjQyOA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r440536428", "bodyText": "Is this message displayed to the user? It looks like it just gets put into the server log.", "author": "tfmorris", "createdAt": "2020-06-16T01:35:36Z", "path": "extensions/wikidata/src/org/openrefine/wikidata/commands/ConnectionManager.java", "diffHunk": "@@ -0,0 +1,219 @@\n+/*******************************************************************************\n+ * MIT License\n+ *\n+ * Copyright (c) 2018 Antonin Delpeuch\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in all\n+ * copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ ******************************************************************************/\n+package org.openrefine.wikidata.commands;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.google.refine.ProjectManager;\n+import com.google.refine.preference.PreferenceStore;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.wikidata.wdtk.wikibaseapi.ApiConnection;\n+import org.wikidata.wdtk.wikibaseapi.BasicApiConnection;\n+import org.wikidata.wdtk.wikibaseapi.LoginFailedException;\n+import org.wikidata.wdtk.wikibaseapi.OAuthApiConnection;\n+import org.wikidata.wdtk.wikibaseapi.apierrors.MediaWikiApiErrorException;\n+\n+import javax.servlet.http.Cookie;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Manages a connection to Wikidata.\n+ * <p>\n+ * The connection can be either {@link BasicApiConnection} or {@link OAuthApiConnection}.\n+ * <p>\n+ * This class is also hard-coded for Wikidata,\n+ * it will be generalized to other Wikibase instances soon.\n+ *\n+ * @author Antonin Delpeuch\n+ * @author Lu Liu\n+ */\n+\n+public class ConnectionManager {\n+\n+    final static Logger logger = LoggerFactory.getLogger(\"connection_manager\");\n+\n+    /**\n+     * We used this key to read/write credentials from/to preferences in the past, which is insecure.\n+     * Now this key is kept only to delete those credentials in the preferences.\n+     */\n+    public static final String PREFERENCE_STORE_KEY = \"wikidata_credentials\";\n+\n+    public static final int CONNECT_TIMEOUT = 5000;\n+    public static final int READ_TIMEOUT = 10000;\n+\n+    /**\n+     * For now, this class is hard-coded for Wikidata.\n+     * <p>\n+     * It will be generalized to work against other Wikibase instances in the future.\n+     */\n+    private static final String WIKIBASE_API_ENDPOINT = ApiConnection.URL_WIKIDATA_API;\n+\n+    /**\n+     * The single {@link ApiConnection} instance managed by {@link ConnectionManager}.\n+     * <p>\n+     * Currently, only one connection is supported at the same time.\n+     */\n+    private ApiConnection connection;\n+\n+    private static final ConnectionManager instance = new ConnectionManager();\n+\n+    public static ConnectionManager getInstance() {\n+        return instance;\n+    }\n+\n+    private ConnectionManager() {\n+        PreferenceStore prefStore = ProjectManager.singleton.getPreferenceStore();\n+        // remove credentials stored in the preferences\n+        prefStore.put(PREFERENCE_STORE_KEY, null);\n+    }\n+\n+    /**\n+     * Logs in to the Wikibase instance, using username/password.\n+     * <p>\n+     * If failed to login, the connection will be set to null.\n+     *\n+     * @param username the username to log in with\n+     * @param password the password to log in with\n+     * @return true if logged in successfully, false otherwise\n+     */\n+    public boolean login(String username, String password) {\n+        connection = new BasicApiConnection(WIKIBASE_API_ENDPOINT);\n+        setupConnection(connection);\n+        try {\n+            ((BasicApiConnection) connection).login(username, password);\n+            return true;\n+        } catch (LoginFailedException e) {\n+            logger.error(e.getMessage());\n+            connection = null;\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Logs in to the Wikibase instance, using owner-only consumer.\n+     * <p>\n+     * If failed to login, the connection will be set to null.\n+     *\n+     * @param consumerToken  consumer token of an owner-only consumer\n+     * @param consumerSecret consumer secret of an owner-only consumer\n+     * @param accessToken    access token of an owner-only consumer\n+     * @param accessSecret   access secret of an owner-only consumer\n+     * @return true if logged in successfully, false otherwise\n+     */\n+    public boolean login(String consumerToken, String consumerSecret,\n+                         String accessToken, String accessSecret) {\n+        connection = new OAuthApiConnection(WIKIBASE_API_ENDPOINT,\n+                consumerToken, consumerSecret,\n+                accessToken, accessSecret);\n+        setupConnection(connection);\n+        try {\n+            // check if the credentials are valid\n+            connection.checkCredentials();\n+            return true;\n+        } catch (IOException | MediaWikiApiErrorException e) {\n+            logger.error(e.getMessage());", "originalCommit": "8fd384f04410da02c12136b6f8a2d9e79770bdf2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYwNTg2OQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r442605869", "bodyText": "Yes, only in server log. If the login fails, the frontend can know by checking the response and then asks the user to try again.", "author": "afkbrb", "createdAt": "2020-06-19T03:01:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzNjQyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzODM4Ng==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r440538386", "bodyText": "This is going to block all interactivity. Normally it should return quickly, but it would be better to do it asynchronously and allow the user to cancel the operation if it's taking too long.\nI know there are a bunch of other places that this is done in OpenRefine, so it's natural that you'd follow the pattern.\nSince this is new code, perhaps we should consider using Promises. They provide a much cleaner pattern.", "author": "tfmorris", "createdAt": "2020-06-16T01:42:34Z", "path": "extensions/wikidata/module/scripts/dialogs/manage-account-dialog.js", "diffHunk": "@@ -2,120 +2,210 @@ var ManageAccountDialog = {};\n \n ManageAccountDialog.firstLogin = true;\n \n-ManageAccountDialog.launch = function(logged_in_username, callback) {\n-   $.post(\n-      \"command/core/get-all-preferences\",\n-      null,\n-      function (preferences) {\n-         ManageAccountDialog.display(logged_in_username, preferences.wikidata_credentials, callback);\n-      },\n-      \"json\"\n-  );\n-};\n+ManageAccountDialog.display = function (logged_in_username, callback) {\n \n-ManageAccountDialog.display = function(logged_in_username, saved_credentials, callback) {\n-  var self = this;\n-  var frame = $(DOM.loadHTML(\"wikidata\", \"scripts/dialogs/manage-account-dialog.html\"));\n-  var elmts = this._elmts = DOM.bind(frame);\n-\n-  this._elmts.dialogHeader.text($.i18n('wikidata-account/dialog-header'));\n-  this._elmts.explainLogIn.html($.i18n('wikidata-account/explain-log-in'));\n-  this._elmts.usernameLabel.text($.i18n('wikidata-account/username-label'));\n-  this._elmts.usernameInput.attr(\"placeholder\", $.i18n('wikidata-account/username-placeholder'));\n-  this._elmts.passwordLabel.text($.i18n('wikidata-account/password-label'));\n-  this._elmts.passwordInput.attr(\"placeholder\", $.i18n('wikidata-account/password-placeholder'));\n-  this._elmts.rememberCredentialsLabel.text($.i18n('wikidata-account/remember-credentials-label'));\n-  this._elmts.dialogHeader.text($.i18n('wikidata-account/dialog-header'));\n-  this._elmts.cancelButton1.text($.i18n('wikidata-account/close'));\n-  this._elmts.cancelButton2.text($.i18n('wikidata-account/close'));\n-  this._elmts.loggedInAs.text($.i18n('wikidata-account/logged-in-as'));\n-  this._elmts.logoutButton.text($.i18n('wikidata-account/log-out'));\n-  this._elmts.loginButton.val($.i18n('wikidata-account/log-in'));\n+  if (logged_in_username == null) {\n+    logged_in_username = ManageAccountDialog.tryLoginWithCookies(callback);\n+  }\n \n   if (logged_in_username != null) {\n-      elmts.loginArea.remove();\n+    ManageAccountDialog.displayLoggedIn(logged_in_username, callback);\n   } else {\n-      elmts.logoutArea.remove();\n+    ManageAccountDialog.displayPasswordLogin(callback);\n   }\n+};\n+\n+ManageAccountDialog.tryLoginWithCookies = function (callback) {\n+  var logged_user_name = null;\n+  $.ajaxSetup({async: false});", "originalCommit": "8fd384f04410da02c12136b6f8a2d9e79770bdf2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYwNDg3Ng==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r442604876", "bodyText": "I fixed this directly in https://github.com/OpenRefine/OpenRefine/tree/wikidata-extension-oauth.", "author": "afkbrb", "createdAt": "2020-06-19T02:57:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzODM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjYwNTc1NA==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r442605754", "bodyText": "Thank you!", "author": "tfmorris", "createdAt": "2020-06-19T03:01:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzODM4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU0MTg4OQ==", "url": "https://github.com/OpenRefine/OpenRefine/pull/2661#discussion_r440541889", "bodyText": "This seems like it might be too short, but I guess we can find out when users test.", "author": "tfmorris", "createdAt": "2020-06-16T01:55:46Z", "path": "extensions/wikidata/src/org/openrefine/wikidata/commands/ConnectionManager.java", "diffHunk": "@@ -0,0 +1,219 @@\n+/*******************************************************************************\n+ * MIT License\n+ *\n+ * Copyright (c) 2018 Antonin Delpeuch\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in all\n+ * copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ ******************************************************************************/\n+package org.openrefine.wikidata.commands;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.google.refine.ProjectManager;\n+import com.google.refine.preference.PreferenceStore;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.wikidata.wdtk.wikibaseapi.ApiConnection;\n+import org.wikidata.wdtk.wikibaseapi.BasicApiConnection;\n+import org.wikidata.wdtk.wikibaseapi.LoginFailedException;\n+import org.wikidata.wdtk.wikibaseapi.OAuthApiConnection;\n+import org.wikidata.wdtk.wikibaseapi.apierrors.MediaWikiApiErrorException;\n+\n+import javax.servlet.http.Cookie;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Manages a connection to Wikidata.\n+ * <p>\n+ * The connection can be either {@link BasicApiConnection} or {@link OAuthApiConnection}.\n+ * <p>\n+ * This class is also hard-coded for Wikidata,\n+ * it will be generalized to other Wikibase instances soon.\n+ *\n+ * @author Antonin Delpeuch\n+ * @author Lu Liu\n+ */\n+\n+public class ConnectionManager {\n+\n+    final static Logger logger = LoggerFactory.getLogger(\"connection_manager\");\n+\n+    /**\n+     * We used this key to read/write credentials from/to preferences in the past, which is insecure.\n+     * Now this key is kept only to delete those credentials in the preferences.\n+     */\n+    public static final String PREFERENCE_STORE_KEY = \"wikidata_credentials\";\n+\n+    public static final int CONNECT_TIMEOUT = 5000;", "originalCommit": "8fd384f04410da02c12136b6f8a2d9e79770bdf2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}