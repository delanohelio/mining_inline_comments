{"pr_number": 33, "pr_title": "FM2-10: Initial implementation for encounter resource", "pr_createdAt": "2020-01-21T11:38:34Z", "pr_url": "https://github.com/openmrs/openmrs-module-fhir2/pull/33", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAwMDkyMw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/33#discussion_r369000923", "bodyText": "I tend to be in favour of the sessionFactory.getCurrentSession().createCriteria(Encounter.class).add(eq(\"uuid\", uuid)).uniqueResult() pattern.", "author": "ibacher", "createdAt": "2020-01-21T13:32:21Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirEncounterDaoImpl.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.api.dao.impl;\n+\n+import javax.inject.Inject;\n+\n+import lombok.AccessLevel;\n+import lombok.Setter;\n+import org.openmrs.Encounter;\n+import org.openmrs.api.EncounterService;\n+import org.openmrs.module.fhir2.api.dao.FhirEncounterDao;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Setter(AccessLevel.PACKAGE)\n+public class FhirEncounterDaoImpl implements FhirEncounterDao {\n+\t\n+\t@Inject\n+\tprivate EncounterService encounterService;\n+\t\n+\t@Override\n+\tpublic Encounter getEncounterByUuid(String uuid) {\n+\t\treturn encounterService.getEncounterByUuid(uuid);", "originalCommit": "313dbbe0445116d49493186f26e3cf5e9d831d96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAwMjc3NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/33#discussion_r369002775", "bodyText": "This should probably be addPersonReference, given its reliance on name. Also, shouldn't we just pass the UUID in here?", "author": "ibacher", "createdAt": "2020-01-21T13:35:46Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/util/FhirUtils.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.api.util;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import lombok.AccessLevel;\n+import lombok.NoArgsConstructor;\n+import org.apache.commons.lang.StringUtils;\n+import org.hl7.fhir.r4.model.Identifier;\n+import org.hl7.fhir.r4.model.Reference;\n+\n+@NoArgsConstructor(access = AccessLevel.PRIVATE)\n+public class FhirUtils {\n+\t\n+\tpublic static Reference addReference(@NotNull String uri, String givenName, String familyName, String identifier) {", "originalCommit": "313dbbe0445116d49493186f26e3cf5e9d831d96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyOTY3NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/33#discussion_r369029675", "bodyText": "Probably then should just have addPatientReference(org.openmrs.Patient patient)", "author": "corneliouzbett", "createdAt": "2020-01-21T14:24:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAwMjc3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA0MTMwMw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/33#discussion_r369041303", "bodyText": "That would also make sense!", "author": "ibacher", "createdAt": "2020-01-21T14:43:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAwMjc3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAwMzkwMw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/33#discussion_r369003903", "bodyText": "I don't think we should be populating the identifier field, as it's primarily intended for logical references, where as this is a proper resource reference.", "author": "ibacher", "createdAt": "2020-01-21T13:37:56Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/util/FhirUtils.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.api.util;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import lombok.AccessLevel;\n+import lombok.NoArgsConstructor;\n+import org.apache.commons.lang.StringUtils;\n+import org.hl7.fhir.r4.model.Identifier;\n+import org.hl7.fhir.r4.model.Reference;\n+\n+@NoArgsConstructor(access = AccessLevel.PRIVATE)\n+public class FhirUtils {\n+\t\n+\tpublic static Reference addReference(@NotNull String uri, String givenName, String familyName, String identifier) {\n+\t\tReference reference = new Reference();\n+\t\tIdentifier fhirIdentifier = new Identifier();", "originalCommit": "313dbbe0445116d49493186f26e3cf5e9d831d96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAwNDg4Mw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/33#discussion_r369004883", "bodyText": "Instead of doing the formatting here, we should just pass the result of PersonName#getFullName() into this method and use that as the display name.", "author": "ibacher", "createdAt": "2020-01-21T13:39:58Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/util/FhirUtils.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.api.util;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import lombok.AccessLevel;\n+import lombok.NoArgsConstructor;\n+import org.apache.commons.lang.StringUtils;\n+import org.hl7.fhir.r4.model.Identifier;\n+import org.hl7.fhir.r4.model.Reference;\n+\n+@NoArgsConstructor(access = AccessLevel.PRIVATE)\n+public class FhirUtils {\n+\t\n+\tpublic static Reference addReference(@NotNull String uri, String givenName, String familyName, String identifier) {\n+\t\tReference reference = new Reference();\n+\t\tIdentifier fhirIdentifier = new Identifier();\n+\t\tfhirIdentifier.setValue(identifier);\n+\t\t\n+\t\tStringBuilder displayName = new StringBuilder();", "originalCommit": "313dbbe0445116d49493186f26e3cf5e9d831d96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAwNTQ1OA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/33#discussion_r369005458", "bodyText": "The reference Id should be left unset, so that it's set at run-time. Conceptually, this UUID is specific to the Patient resource and the reference to the patient resource is an entirely different object.", "author": "ibacher", "createdAt": "2020-01-21T13:41:06Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/util/FhirUtils.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.api.util;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import lombok.AccessLevel;\n+import lombok.NoArgsConstructor;\n+import org.apache.commons.lang.StringUtils;\n+import org.hl7.fhir.r4.model.Identifier;\n+import org.hl7.fhir.r4.model.Reference;\n+\n+@NoArgsConstructor(access = AccessLevel.PRIVATE)\n+public class FhirUtils {\n+\t\n+\tpublic static Reference addReference(@NotNull String uri, String givenName, String familyName, String identifier) {\n+\t\tReference reference = new Reference();\n+\t\tIdentifier fhirIdentifier = new Identifier();\n+\t\tfhirIdentifier.setValue(identifier);\n+\t\t\n+\t\tStringBuilder displayName = new StringBuilder();\n+\t\tif (StringUtils.isNotBlank(givenName)) {\n+\t\t\tdisplayName.append(givenName);\n+\t\t\tdisplayName.append(\" \");\n+\t\t}\n+\t\tif (StringUtils.isNotBlank(familyName)) {\n+\t\t\tdisplayName.append(familyName);\n+\t\t}\n+\t\t\n+\t\treference.setReference(uri);\n+\t\treference.setDisplay(displayName.toString());\n+\t\treference.setIdentifier(fhirIdentifier);\n+\t\treference.setId(extractUuid(uri));", "originalCommit": "313dbbe0445116d49493186f26e3cf5e9d831d96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAwNTc3Mw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/33#discussion_r369005773", "bodyText": "I would move this to the FhirUtils class. We will need it in many places.", "author": "ibacher", "createdAt": "2020-01-21T13:41:41Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/EncounterTranslatorImpl.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.api.translators.impl;\n+\n+import javax.inject.Inject;\n+\n+import lombok.AccessLevel;\n+import lombok.Setter;\n+import org.hl7.fhir.r4.model.Encounter;\n+import org.hl7.fhir.r4.model.Reference;\n+import org.openmrs.Patient;\n+import org.openmrs.PersonName;\n+import org.openmrs.api.PatientService;\n+import org.openmrs.module.fhir2.FhirConstants;\n+import org.openmrs.module.fhir2.api.translators.EncounterTranslator;\n+import org.openmrs.module.fhir2.api.util.FhirUtils;\n+import org.springframework.stereotype.Component;\n+\n+import static org.apache.commons.lang.Validate.notNull;\n+\n+@Component\n+@Setter(AccessLevel.PACKAGE)\n+public class EncounterTranslatorImpl implements EncounterTranslator {\n+\t\n+\t@Inject\n+\tPatientService patientService;\n+\t\n+\t@Override\n+\tpublic Encounter toFhirResource(org.openmrs.Encounter openMrsEncounter) {\n+\t\tEncounter encounter = new Encounter();\n+\t\tencounter.setId(openMrsEncounter.getUuid());\n+\t\tencounter.setStatus(Encounter.EncounterStatus.UNKNOWN);\n+\t\t\n+\t\tencounter.setSubject(getPatientReference(openMrsEncounter.getPatient()));\n+\t\t\n+\t\treturn encounter;\n+\t}\n+\t\n+\t@Override\n+\tpublic org.openmrs.Encounter toOpenmrsType(Encounter fhirEncounter) {\n+\t\treturn this.toOpenmrsType(new org.openmrs.Encounter(), fhirEncounter);\n+\t}\n+\t\n+\t@Override\n+\tpublic org.openmrs.Encounter toOpenmrsType(org.openmrs.Encounter existingEncounter, Encounter encounter) {\n+\t\tnotNull(existingEncounter, \"Existing encounter cannot be null\");\n+\t\t\n+\t\tif (encounter == null) {\n+\t\t\treturn existingEncounter;\n+\t\t}\n+\t\texistingEncounter.setUuid(encounter.getId());\n+\t\tString patientUuid = FhirUtils.extractUuid(encounter.getSubject().getReference());\n+\t\texistingEncounter.setPatient(patientService.getPatientByUuid(patientUuid));\n+\t\t\n+\t\treturn existingEncounter;\n+\t}\n+\t\n+\tpublic Reference getPatientReference(Patient patient) {", "originalCommit": "313dbbe0445116d49493186f26e3cf5e9d831d96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAwNjUyMw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/33#discussion_r369006523", "bodyText": "Just use the value from FhirConstants. The purpose of FhirTestConstants is for some constants needed across tests that aren't constants in the application, e.g., the LOINC_SYSTEM_URL or CIEL_SYSTEM_URN are actually determined at runtime from the database, but for testing purposes, we can use fixed values.", "author": "ibacher", "createdAt": "2020-01-21T13:43:15Z", "path": "api/src/test/java/org/openmrs/module/fhir2/FhirTestConstants.java", "diffHunk": "@@ -14,4 +14,7 @@\n \tpublic static final String LOINC_SYSTEM_URL = \"http://loinc.org\";\n \t\n \tpublic static final String CIEL_SYSTEM_URN = \"urn:oid:2.16.840.1.113883.3.7201\";\n+\t\n+\tpublic static final String PATIENT = \"Patient\";", "originalCommit": "313dbbe0445116d49493186f26e3cf5e9d831d96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAxNjM0MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/33#discussion_r369016341", "bodyText": "\ud83d\udc4d\ud83c\udffd", "author": "corneliouzbett", "createdAt": "2020-01-21T14:01:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAwNjUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAwNzc1MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/33#discussion_r369007751", "bodyText": "We should probably consider renaming either this file to FhirReferenceUtils or the file in the omod to FhirServerUtils (I favour the second of these) just to avoid confusion.", "author": "ibacher", "createdAt": "2020-01-21T13:45:48Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/util/FhirUtils.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*", "originalCommit": "313dbbe0445116d49493186f26e3cf5e9d831d96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5be18c3d6ce15c9607147c8613e06acc0e4e6545", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/5be18c3d6ce15c9607147c8613e06acc0e4e6545", "message": "FM2-10: Initial implementation for encounter resource", "committedDate": "2020-01-21T14:26:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA0MzY3Mg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/33#discussion_r369043672", "bodyText": "I think instead of the IDENTIFIER constant, we should use patient.getPatientIdentifier().getIdentifier().getIdentifierType().getName(); the reason is, not all implementations use only a single identifier per patient.", "author": "ibacher", "createdAt": "2020-01-21T14:47:44Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/util/FhirReferenceUtils.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.api.util;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import lombok.AccessLevel;\n+import lombok.NoArgsConstructor;\n+import org.apache.commons.lang.StringUtils;\n+import org.hl7.fhir.r4.model.Identifier;\n+import org.hl7.fhir.r4.model.Reference;\n+import org.openmrs.Patient;\n+import org.openmrs.module.fhir2.FhirConstants;\n+\n+@NoArgsConstructor(access = AccessLevel.PRIVATE)\n+public class FhirReferenceUtils {\n+\n+\t\n+\tpublic static Reference addPatientReference(Patient patient) {\n+\t\tReference reference = new Reference();\n+\t\tString patientUri = FhirConstants.PATIENT +\"/\" +patient.getUuid();\n+\t\treference.setReference(patientUri);\n+\t\tString nameDisplay = patient.getPersonName().getFullName()\n+\t\t\t\t+ \"(\"\n+\t\t\t\t+ FhirConstants.IDENTIFIER", "originalCommit": "5be18c3d6ce15c9607147c8613e06acc0e4e6545", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA2NjUxMw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/33#discussion_r369066513", "bodyText": "You're right. Didn't thought of that.", "author": "corneliouzbett", "createdAt": "2020-01-21T15:24:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA0MzY3Mg=="}], "type": "inlineReview"}, {"oid": "8409f226b7e1c51c27328331382892818c822869", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/8409f226b7e1c51c27328331382892818c822869", "message": "Used identifierTypeName instead of identifier Constants", "committedDate": "2020-01-21T15:57:23Z", "type": "commit"}]}