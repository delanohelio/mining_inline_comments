{"pr_number": 257, "pr_title": "FM2-251: Add support for overriding default narratives", "pr_createdAt": "2020-07-15T16:26:54Z", "pr_url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257", "timeline": [{"oid": "5d7e5cbf551cae214fdfe3e21eaa8180ef856e1f", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/5d7e5cbf551cae214fdfe3e21eaa8180ef856e1f", "message": "FM2-251: Add support for overriding default narratives", "committedDate": "2020-07-15T16:06:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4MzUzOQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r455183539", "bodyText": "It now adds the file: prefix if there is no prefix in the path, since the loadResource() method requires either classpath: or file: prefix.", "author": "ShivanshRakesh", "createdAt": "2020-07-15T16:38:00Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/web/util/NarrativeUtils.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.web.util;\n+\n+import static org.slf4j.LoggerFactory.getLogger;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+\n+public class NarrativeUtils {\n+\t\n+\tprivate static final Logger LOGGER = getLogger(NarrativeUtils.class);\n+\t\n+\tprivate static boolean validatePropertiesFilePath(@NotNull String path) {\n+\t\t\n+\t\tif (path.startsWith(\"file:\")) {\n+\t\t\tString filepath = path.substring(\"file:\".length());\n+\t\t\t\n+\t\t\tif (filepath == null || filepath.trim().isEmpty()) {\n+\t\t\t\tLOGGER.error(\"Properties File path must not be empty\");\n+\t\t\t\treturn false;\n+\t\t\t}\n+\t\t\t\n+\t\t\tif (!filepath.endsWith(\".properties\")) {\n+\t\t\t\tLOGGER.error(\"Properties File must have extension '.properties'\");\n+\t\t\t\treturn false;\n+\t\t\t}\n+\t\t} else if (path.startsWith(\"classpath:\")) {\n+\t\t\tString classpath = path.substring(\"classpath:\".length());\n+\t\t\t\n+\t\t\tif (classpath == null || classpath.trim().isEmpty()) {\n+\t\t\t\tLOGGER.error(\"Properties File classpath must not be empty\");\n+\t\t\t\treturn false;\n+\t\t\t}\n+\t\t}\n+\t\t\n+\t\treturn true;\n+\t}\n+\t\n+\tpublic static String getValidatedPropertiesFilePath(String path) {\n+\t\tif (path == null || path.isEmpty()) {\n+\t\t\treturn null;\n+\t\t}\n+\t\t\n+\t\tif (!(path.startsWith(\"file:\") || path.startsWith(\"classpath:\"))) {", "originalCommit": "d695ba3c99b26d1afab6d65c69821a106fd3154a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxMTU5Mg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r456611592", "bodyText": "Two points on this:\n\nCould you add what you said above as a comment on this line of code.\nIsn't path = \"file:\" + path easier to read?", "author": "ibacher", "createdAt": "2020-07-17T18:38:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4MzUzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY2MzAyNQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r456663025", "bodyText": "Could you add what you said above as a comment on this line of code.\n\n\nOkay.\n\n\nIsn't path = \"file:\" + path easier to read?\n\n\nYeah, I'll change it to this.", "author": "ShivanshRakesh", "createdAt": "2020-07-17T20:37:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4MzUzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY2ODI0Mg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r456668242", "bodyText": "@ibacher I've made the changes. PTAL.", "author": "ShivanshRakesh", "createdAt": "2020-07-17T20:50:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4MzUzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NDA0Mg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r455184042", "bodyText": "I've added few checks for the properties file.", "author": "ShivanshRakesh", "createdAt": "2020-07-15T16:38:46Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/web/util/NarrativeUtils.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.web.util;\n+\n+import static org.slf4j.LoggerFactory.getLogger;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+\n+public class NarrativeUtils {\n+\t\n+\tprivate static final Logger LOGGER = getLogger(NarrativeUtils.class);\n+\t\n+\tprivate static boolean validatePropertiesFilePath(@NotNull String path) {", "originalCommit": "d695ba3c99b26d1afab6d65c69821a106fd3154a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NTA2NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r455185065", "bodyText": "I've restructured this the way suggested here.", "author": "ShivanshRakesh", "createdAt": "2020-07-15T16:40:30Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/web/servlet/FhirRestServlet.java", "diffHunk": "@@ -62,8 +63,19 @@ protected void initialize() {\n \t\tsetDefaultResponseEncoding(EncodingEnum.JSON);\n \t\tregisterInterceptor(loggingInterceptor);\n \t\t\n-\t\tgetFhirContext().setNarrativeGenerator(new CustomThymeleafNarrativeGenerator(\n-\t\t        FhirConstants.HAPI_NARRATIVES_PROPERTY_FILE, FhirConstants.OPENMRS_NARRATIVES_PROPERTY_FILE));\n+\t\tString narrativesOverridePropertyFile = NarrativeUtils.getValidatedPropertiesFilePath(\n+\t\t    globalPropertyService.getGlobalProperty(FhirConstants.NARRATIVES_OVERRIDE_PROPERTY_FILE, \"\"));\n+\t\t\n+\t\tString[] narrativePropertiesFiles;\n+\t\tif (narrativesOverridePropertyFile != null) {\n+\t\t\tnarrativePropertiesFiles = new String[] { narrativesOverridePropertyFile,\n+\t\t\t        FhirConstants.HAPI_NARRATIVES_PROPERTY_FILE, FhirConstants.OPENMRS_NARRATIVES_PROPERTY_FILE };\n+\t\t} else {\n+\t\t\tnarrativePropertiesFiles = new String[] { FhirConstants.HAPI_NARRATIVES_PROPERTY_FILE,\n+\t\t\t        FhirConstants.OPENMRS_NARRATIVES_PROPERTY_FILE };\n+\t\t}", "originalCommit": "d695ba3c99b26d1afab6d65c69821a106fd3154a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c47e916e9f807860a35fb1096ea890f9de9afc7a", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/c47e916e9f807860a35fb1096ea890f9de9afc7a", "message": "FM2-251: Add support for overriding default narratives", "committedDate": "2020-07-15T16:09:28Z", "type": "forcePushed"}, {"oid": "d695ba3c99b26d1afab6d65c69821a106fd3154a", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/d695ba3c99b26d1afab6d65c69821a106fd3154a", "message": "FM2-251: Add support for overriding default narratives", "committedDate": "2020-07-15T16:23:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzMDgzMA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r455530830", "bodyText": "You could use shouldReturnNullWhenClassPathIsEmpty as the name of that method", "author": "HerbertYiga", "createdAt": "2020-07-16T06:09:17Z", "path": "omod/src/test/java/org/openmrs/module/fhir2/web/util/NarrativeUtilTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.web.util;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.nullValue;\n+\n+import org.junit.Test;\n+\n+public class NarrativeUtilTest {\n+\t\n+\t@Test\n+\tpublic void shouldReturnNullWhenPathIsNull() {\n+\t\tString propFilePathGiven = null;\n+\t\t\n+\t\tString propFilePathResult = NarrativeUtils.getValidatedPropertiesFilePath(propFilePathGiven);\n+\t\t\n+\t\tassertThat(propFilePathResult, nullValue());\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldReturnNullWhenFilePathIsEmpty() {\n+\t\tString propFilePathGiven = \"file:\";\n+\t\t\n+\t\tString propFilePathResult = NarrativeUtils.getValidatedPropertiesFilePath(propFilePathGiven);\n+\t\t\n+\t\tassertThat(propFilePathResult, nullValue());\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldReturnNullWhenDoesNotEndWithProperties() {\n+\t\tString propFilePathGiven = \"file:somepath/which/does/not/end/with/properties/extension\";\n+\t\t\n+\t\tString propFilePathResult = NarrativeUtils.getValidatedPropertiesFilePath(propFilePathGiven);\n+\t\t\n+\t\tassertThat(propFilePathResult, nullValue());\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldReturnFilePrefixedPathIfPrefixNotPresent() {\n+\t\tString propFilePathGiven = \"somepath/which/does/not/have/file/prefix/filename.properties\";\n+\t\t\n+\t\tString propFilePathResult = NarrativeUtils.getValidatedPropertiesFilePath(propFilePathGiven);\n+\t\t\n+\t\tassertThat(propFilePathResult, equalTo(String.join(\":\", \"file\", propFilePathGiven)));\n+\t}\n+\t\n+\t@Test\n+\tpublic void shouldReturnNullWhenClasspathIsEmpty() {", "originalCommit": "d695ba3c99b26d1afab6d65c69821a106fd3154a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTU4NTI1NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r455585255", "bodyText": "Okay, will make the changes to this.", "author": "ShivanshRakesh", "createdAt": "2020-07-16T07:54:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzMDgzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzMTU5OA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r455531598", "bodyText": "how do you see if we used logger instead of LOGGER", "author": "HerbertYiga", "createdAt": "2020-07-16T06:11:31Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/web/util/NarrativeUtils.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.web.util;\n+\n+import static org.slf4j.LoggerFactory.getLogger;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+\n+public class NarrativeUtils {\n+\t\n+\tprivate static final Logger LOGGER = getLogger(NarrativeUtils.class);", "originalCommit": "d695ba3c99b26d1afab6d65c69821a106fd3154a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTU4NDg5MA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r455584890", "bodyText": "Yeah, it's not a constant so I guess using logger is better. I'll use logger instead.", "author": "ShivanshRakesh", "createdAt": "2020-07-16T07:54:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzMTU5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTU5MjcwNQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r455592705", "bodyText": "@HerbertYiga should I use log instead? I just saw that log has been used at other places in the repository.", "author": "ShivanshRakesh", "createdAt": "2020-07-16T08:02:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzMTU5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTU5NTYwMQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r455595601", "bodyText": "true,use log", "author": "HerbertYiga", "createdAt": "2020-07-16T08:05:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzMTU5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYyODEzOA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r455628138", "bodyText": "@HerbertYiga I've made the changes. PTAL.", "author": "ShivanshRakesh", "createdAt": "2020-07-16T08:50:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzMTU5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY2NTA0OA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r456665048", "bodyText": "Actually, if I can suggest, just annotate the class with the @Slf4j annotation, which will magically generate the log variable for you. See here.", "author": "ibacher", "createdAt": "2020-07-17T20:42:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzMTU5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY2ODg3Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r456668877", "bodyText": "Oh that's nice! Will do that.", "author": "ShivanshRakesh", "createdAt": "2020-07-17T20:52:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzMTU5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3MTUzNQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r456671535", "bodyText": "Have made the changes.", "author": "ShivanshRakesh", "createdAt": "2020-07-17T20:58:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzMTU5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUzMjMxNg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/257#discussion_r455532316", "bodyText": "hI @ibacher   How does this entire pr look to you?", "author": "HerbertYiga", "createdAt": "2020-07-16T06:13:36Z", "path": "omod/src/main/java/org/openmrs/module/fhir2/web/util/NarrativeUtils.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.web.util;\n+\n+import static org.slf4j.LoggerFactory.getLogger;\n+\n+import javax.validation.constraints.NotNull;\n+\n+import org.slf4j.Logger;\n+\n+public class NarrativeUtils {\n+\t\n+\tprivate static final Logger LOGGER = getLogger(NarrativeUtils.class);\n+\t\n+\tprivate static boolean validatePropertiesFilePath(@NotNull String path) {\n+\t\t\n+\t\tif (path.startsWith(\"file:\")) {", "originalCommit": "d695ba3c99b26d1afab6d65c69821a106fd3154a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9e347d019dc1b5752095dcc95040d7e7d72ea150", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/9e347d019dc1b5752095dcc95040d7e7d72ea150", "message": "FM2-251: Add support for overriding default narratives", "committedDate": "2020-07-16T07:58:53Z", "type": "forcePushed"}, {"oid": "d871c06a4a11622bd8b55bdc2b7202ac89730ff4", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/d871c06a4a11622bd8b55bdc2b7202ac89730ff4", "message": "FM2-251: Add support for overriding default narratives", "committedDate": "2020-07-16T08:48:18Z", "type": "forcePushed"}, {"oid": "6556f5b6f4bed258cc84b6e4798fd5f6f0e8e805", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/6556f5b6f4bed258cc84b6e4798fd5f6f0e8e805", "message": "FM2-251: Add support for overriding default narratives", "committedDate": "2020-07-17T20:49:02Z", "type": "forcePushed"}, {"oid": "77d7cbe85dd8246242482935897d0401d6ce0403", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/77d7cbe85dd8246242482935897d0401d6ce0403", "message": "FM2-251: Add support for overriding default narratives", "committedDate": "2020-07-17T20:57:58Z", "type": "commit"}, {"oid": "77d7cbe85dd8246242482935897d0401d6ce0403", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/77d7cbe85dd8246242482935897d0401d6ce0403", "message": "FM2-251: Add support for overriding default narratives", "committedDate": "2020-07-17T20:57:58Z", "type": "forcePushed"}]}