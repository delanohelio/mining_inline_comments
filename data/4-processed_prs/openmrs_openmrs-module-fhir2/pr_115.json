{"pr_number": 115, "pr_title": "FM2-92 Add support for AND / OR queries using References", "pr_createdAt": "2020-03-14T18:42:20Z", "pr_url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjEwOA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r392692108", "bodyText": "Please leave a line before the return statement.", "author": "varung-31", "createdAt": "2020-03-15T16:56:28Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java", "diffHunk": "@@ -455,70 +456,76 @@ protected boolean containsAlias(Iterator<CriteriaImpl.Subcriteria> subcriteriaIt\n \t\t});\n \t}\n \t\n-\tprotected void handleLocationReference(Criteria criteria, ReferenceParam locationReference) {\n+\tprotected void handleLocationReference(Criteria criteria, ReferenceAndListParam locationReference) {\n \t\tif (locationReference != null) {\n \t\t\tcriteria.createAlias(\"location\", \"l\");\n \t\t\t\n-\t\t\tif (locationReference.getChain() != null) {\n-\t\t\t\tswitch (locationReference.getChain()) {\n-\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n-\t\t\t\t\t\tpropertyLike(\"l.cityVillage\", locationReference.getValue()).ifPresent(criteria::add);\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n-\t\t\t\t\t\tpropertyLike(\"l.stateProvince\", locationReference.getValue()).ifPresent(criteria::add);\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n-\t\t\t\t\t\tpropertyLike(\"l.postalCode\", locationReference.getValue()).ifPresent(criteria::add);\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n-\t\t\t\t\t\tpropertyLike(\"l.country\", locationReference.getValue()).ifPresent(criteria::add);\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase \"\":\n-\t\t\t\t\t\tcriteria.add(eq(\"l.uuid\", locationReference.getValue()));\n-\t\t\t\t\t\tbreak;\n+\t\t\thandleAndListParam(locationReference, token -> {\n+\t\t\t\tif (token.getChain() != null) {\n+\t\t\t\t\tswitch (token.getChain()) {\n+\t\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n+\t\t\t\t\t\t\tpropertyLike(\"l.cityVillage\", token.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n+\t\t\t\t\t\t\tpropertyLike(\"l.stateProvince\", token.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n+\t\t\t\t\t\t\tpropertyLike(\"l.postalCode\", token.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n+\t\t\t\t\t\t\tpropertyLike(\"l.country\", token.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\tcase \"\":\n+\t\t\t\t\t\t\tcriteria.add(eq(\"l.uuid\", token.getValue()));\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t}\n \t\t\t\t}\n-\t\t\t}\n+\t\t\t\treturn Optional.empty();", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAxNzg0Ng==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r393017846", "bodyText": "Also, this is intended one time too many \ud83d\ude42", "author": "ibacher", "createdAt": "2020-03-16T13:22:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjEwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjE1MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r392692151", "bodyText": "Same as above", "author": "varung-31", "createdAt": "2020-03-15T16:56:51Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java", "diffHunk": "@@ -455,70 +456,76 @@ protected boolean containsAlias(Iterator<CriteriaImpl.Subcriteria> subcriteriaIt\n \t\t});\n \t}\n \t\n-\tprotected void handleLocationReference(Criteria criteria, ReferenceParam locationReference) {\n+\tprotected void handleLocationReference(Criteria criteria, ReferenceAndListParam locationReference) {\n \t\tif (locationReference != null) {\n \t\t\tcriteria.createAlias(\"location\", \"l\");\n \t\t\t\n-\t\t\tif (locationReference.getChain() != null) {\n-\t\t\t\tswitch (locationReference.getChain()) {\n-\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n-\t\t\t\t\t\tpropertyLike(\"l.cityVillage\", locationReference.getValue()).ifPresent(criteria::add);\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n-\t\t\t\t\t\tpropertyLike(\"l.stateProvince\", locationReference.getValue()).ifPresent(criteria::add);\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n-\t\t\t\t\t\tpropertyLike(\"l.postalCode\", locationReference.getValue()).ifPresent(criteria::add);\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n-\t\t\t\t\t\tpropertyLike(\"l.country\", locationReference.getValue()).ifPresent(criteria::add);\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase \"\":\n-\t\t\t\t\t\tcriteria.add(eq(\"l.uuid\", locationReference.getValue()));\n-\t\t\t\t\t\tbreak;\n+\t\t\thandleAndListParam(locationReference, token -> {\n+\t\t\t\tif (token.getChain() != null) {\n+\t\t\t\t\tswitch (token.getChain()) {\n+\t\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n+\t\t\t\t\t\t\tpropertyLike(\"l.cityVillage\", token.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n+\t\t\t\t\t\t\tpropertyLike(\"l.stateProvince\", token.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n+\t\t\t\t\t\t\tpropertyLike(\"l.postalCode\", token.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n+\t\t\t\t\t\t\tpropertyLike(\"l.country\", token.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\tcase \"\":\n+\t\t\t\t\t\t\tcriteria.add(eq(\"l.uuid\", token.getValue()));\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t}\n \t\t\t\t}\n-\t\t\t}\n+\t\t\t\treturn Optional.empty();\n+\t\t\t});\n \t\t}\n \t}\n \t\n-\tprotected void handleParticipantReference(Criteria criteria, ReferenceParam participantReference) {\n+\tprotected void handleParticipantReference(Criteria criteria, ReferenceAndListParam participantReference) {\n \t\tif (participantReference != null) {\n \t\t\tcriteria.createAlias(\"encounterProviders\", \"ep\");\n \t\t\t\n-\t\t\tif (participantReference.getChain() != null) {\n-\t\t\t\tswitch (participantReference.getChain()) {\n-\t\t\t\t\tcase Practitioner.SP_IDENTIFIER:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").add(ilike(\"p.identifier\", participantReference.getValue()));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Practitioner.SP_GIVEN:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"pro\").createAlias(\"pro.person\", \"ps\")\n-\t\t\t\t\t\t        .createAlias(\"ps.names\", \"pn\")\n-\t\t\t\t\t\t        .add(ilike(\"pn.givenName\", participantReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Practitioner.SP_FAMILY:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"pro\").createAlias(\"pro.person\", \"ps\")\n-\t\t\t\t\t\t        .createAlias(\"ps.names\", \"pn\")\n-\t\t\t\t\t\t        .add(ilike(\"pn.familyName\", participantReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Practitioner.SP_NAME:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"pro\").createAlias(\"pro.person\", \"ps\").createAlias(\"ps.names\",\n-\t\t\t\t\t\t    \"pn\");\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tList<Optional<Criterion>> criterionList = new ArrayList<>();\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tfor (String token : StringUtils.split(participantReference.getValue(), \" \\t,\")) {\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.givenName\", token));\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.middleName\", token));\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.familyName\", token));\n-\t\t\t\t\t\t}\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tcriteria.add(or(toCriteriaArray(criterionList)));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase \"\":\n-\t\t\t\t\t\tcriteria.add(eq(\"ep.uuid\", participantReference.getValue()));\n-\t\t\t\t\t\tbreak;\n+\t\t\thandleAndListParam(participantReference, participantToken -> {\n+\t\t\t\tif (participantToken.getChain() != null) {\n+\t\t\t\t\tswitch (participantToken.getChain()) {\n+\t\t\t\t\t\tcase Practitioner.SP_IDENTIFIER:\n+\t\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").add(ilike(\"p.identifier\", participantToken.getValue()));\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase Practitioner.SP_GIVEN:\n+\t\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"pro\").createAlias(\"pro.person\", \"ps\")\n+\t\t\t\t\t\t\t        .createAlias(\"ps.names\", \"pn\")\n+\t\t\t\t\t\t\t        .add(ilike(\"pn.givenName\", participantToken.getValue(), MatchMode.START));\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase Practitioner.SP_FAMILY:\n+\t\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"pro\").createAlias(\"pro.person\", \"ps\")\n+\t\t\t\t\t\t\t        .createAlias(\"ps.names\", \"pn\")\n+\t\t\t\t\t\t\t        .add(ilike(\"pn.familyName\", participantToken.getValue(), MatchMode.START));\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase Practitioner.SP_NAME:\n+\t\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"pro\").createAlias(\"pro.person\", \"ps\")\n+\t\t\t\t\t\t\t        .createAlias(\"ps.names\", \"pn\");\n+\t\t\t\t\t\t\t\n+\t\t\t\t\t\t\tList<Optional<Criterion>> criterionList = new ArrayList<>();\n+\t\t\t\t\t\t\t\n+\t\t\t\t\t\t\tfor (String token : StringUtils.split(participantToken.getValue(), \" \\t,\")) {\n+\t\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.givenName\", token));\n+\t\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.middleName\", token));\n+\t\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.familyName\", token));\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\n+\t\t\t\t\t\t\tcriteria.add(or(toCriteriaArray(criterionList)));\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase \"\":\n+\t\t\t\t\t\t\tcriteria.add(eq(\"ep.uuid\", participantToken.getValue()));\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t}\n \t\t\t\t}\n-\t\t\t}\n+\t\t\t\treturn Optional.empty();", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjE2NA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r392692164", "bodyText": "Same as above", "author": "varung-31", "createdAt": "2020-03-15T16:57:02Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java", "diffHunk": "@@ -569,45 +576,49 @@ protected void handleNames(Criteria criteria, StringOrListParam name, StringOrLi\n \t\t}\n \t}\n \t\n-\tprotected void handlePatientReference(Criteria criteria, ReferenceParam patientReference) {\n+\tprotected void handlePatientReference(Criteria criteria, ReferenceAndListParam patientReference) {\n \t\thandlePatientReference(criteria, patientReference, \"patient\");\n \t}\n \t\n-\tprotected void handlePatientReference(Criteria criteria, ReferenceParam patientReference, String associationPath) {\n+\tprotected void handlePatientReference(Criteria criteria, ReferenceAndListParam patientReference,\n+\t        String associationPath) {\n \t\tif (patientReference != null) {\n \t\t\tcriteria.createAlias(associationPath, \"p\");\n \t\t\t\n-\t\t\tif (patientReference.getChain() != null) {\n-\t\t\t\tswitch (patientReference.getChain()) {\n-\t\t\t\t\tcase Patient.SP_IDENTIFIER:\n-\t\t\t\t\t\tcriteria.createAlias(\"p.identifiers\", \"pi\").add(ilike(\"pi.identifier\", patientReference.getValue()));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Patient.SP_GIVEN:\n-\t\t\t\t\t\tcriteria.createAlias(\"p.names\", \"pn\")\n-\t\t\t\t\t\t        .add(ilike(\"pn.givenName\", patientReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Patient.SP_FAMILY:\n-\t\t\t\t\t\tcriteria.createAlias(\"p.names\", \"pn\")\n-\t\t\t\t\t\t        .add(ilike(\"pn.familyName\", patientReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Patient.SP_NAME:\n-\t\t\t\t\t\tcriteria.createAlias(\"p.names\", \"pn\");\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tList<Optional<Criterion>> criterionList = new ArrayList<>();\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tfor (String token : StringUtils.split(patientReference.getValue(), \" \\t,\")) {\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.givenName\", token));\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.middleName\", token));\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.familyName\", token));\n-\t\t\t\t\t\t}\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tcriteria.add(or(toCriteriaArray(criterionList)));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase \"\":\n-\t\t\t\t\t\tcriteria.add(eq(\"p.uuid\", patientReference.getValue()));\n-\t\t\t\t\t\tbreak;\n+\t\t\thandleAndListParam(patientReference, patientToken -> {\n+\t\t\t\tif (patientToken.getChain() != null) {\n+\t\t\t\t\tswitch (patientToken.getChain()) {\n+\t\t\t\t\t\tcase Patient.SP_IDENTIFIER:\n+\t\t\t\t\t\t\tcriteria.createAlias(\"p.identifiers\", \"pi\").add(ilike(\"pi.identifier\", patientToken.getValue()));\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase Patient.SP_GIVEN:\n+\t\t\t\t\t\t\tcriteria.createAlias(\"p.names\", \"pn\")\n+\t\t\t\t\t\t\t        .add(ilike(\"pn.givenName\", patientToken.getValue(), MatchMode.START));\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase Patient.SP_FAMILY:\n+\t\t\t\t\t\t\tcriteria.createAlias(\"p.names\", \"pn\")\n+\t\t\t\t\t\t\t        .add(ilike(\"pn.familyName\", patientToken.getValue(), MatchMode.START));\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase Patient.SP_NAME:\n+\t\t\t\t\t\t\tcriteria.createAlias(\"p.names\", \"pn\");\n+\t\t\t\t\t\t\t\n+\t\t\t\t\t\t\tList<Optional<Criterion>> criterionList = new ArrayList<>();\n+\t\t\t\t\t\t\t\n+\t\t\t\t\t\t\tfor (String token : StringUtils.split(patientToken.getValue(), \" \\t,\")) {\n+\t\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.givenName\", token));\n+\t\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.middleName\", token));\n+\t\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.familyName\", token));\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\n+\t\t\t\t\t\t\tcriteria.add(or(toCriteriaArray(criterionList)));\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase \"\":\n+\t\t\t\t\t\t\tcriteria.add(eq(\"p.uuid\", patientToken.getValue()));\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t}\n \t\t\t\t}\n-\t\t\t}\n+\t\t\t\treturn Optional.empty();\n+\t\t\t});", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjE5MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r392692191", "bodyText": "@VaishSiddharth  setValue() method resets the value of chain to null. Hence you must set the chain after you set the value.", "author": "varung-31", "createdAt": "2020-03-15T16:57:31Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImplTest.java", "diffHunk": "@@ -83,9 +85,13 @@ public void getAllergyIntoleranceByUuid_shouldReturnNullWhenCalledWithUnknownUui\n \t\n \t@Test\n \tpublic void searchForAllergies_shouldSearchForAllergiesByIdentifier() {\n-\t\tReferenceParam referenceParam = new ReferenceParam();\n-\t\treferenceParam.setChain(Patient.SP_IDENTIFIER);\n-\t\treferenceParam.setValue(\"M4001-1\");\n+\t\tReferenceAndListParam referenceParam = new ReferenceAndListParam();\n+\t\tReferenceParam allergyParam = new ReferenceParam();\n+\t\t\n+\t\tallergyParam.setChain(Patient.SP_IDENTIFIER);\n+\t\tallergyParam.setValue(\"M4001-1\");", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjE5NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r392692195", "bodyText": "Ditto", "author": "varung-31", "createdAt": "2020-03-15T16:57:40Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImplTest.java", "diffHunk": "@@ -96,9 +102,13 @@ public void searchForAllergies_shouldSearchForAllergiesByIdentifier() {\n \t\n \t@Test\n \tpublic void searchForAllergies_shouldSearchForAllergiesByPatientGivenName() {\n-\t\tReferenceParam referenceParam = new ReferenceParam();\n-\t\treferenceParam.setChain(Patient.SP_GIVEN);\n-\t\treferenceParam.setValue(\"John\");\n+\t\tReferenceAndListParam referenceParam = new ReferenceAndListParam();\n+\t\tReferenceParam allergyParam = new ReferenceParam();\n+\t\t\n+\t\tallergyParam.setChain(Patient.SP_GIVEN);\n+\t\tallergyParam.setValue(\"John\");", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjIwMw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r392692203", "bodyText": "Ditto", "author": "varung-31", "createdAt": "2020-03-15T16:57:48Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImplTest.java", "diffHunk": "@@ -108,9 +118,13 @@ public void searchForAllergies_shouldSearchForAllergiesByPatientGivenName() {\n \t\n \t@Test\n \tpublic void searchForAllergies_shouldSearchForAllergiesByPatientFamilyName() {\n-\t\tReferenceParam referenceParam = new ReferenceParam();\n-\t\treferenceParam.setChain(Patient.SP_FAMILY);\n-\t\treferenceParam.setValue(\"Doe\");\n+\t\tReferenceAndListParam referenceParam = new ReferenceAndListParam();\n+\t\tReferenceParam allergyParam = new ReferenceParam();\n+\t\t\n+\t\tallergyParam.setChain(Patient.SP_FAMILY);\n+\t\tallergyParam.setValue(\"Doe\");", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjIxMA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r392692210", "bodyText": "Ditto", "author": "varung-31", "createdAt": "2020-03-15T16:57:56Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirAllergyIntoleranceDaoImplTest.java", "diffHunk": "@@ -120,9 +134,13 @@ public void searchForAllergies_shouldSearchForAllergiesByPatientFamilyName() {\n \t\n \t@Test\n \tpublic void searchForAllergies_shouldSearchForAllergiesByPatientName() {\n-\t\tReferenceParam referenceParam = new ReferenceParam();\n-\t\treferenceParam.setChain(Patient.SP_NAME);\n-\t\treferenceParam.setValue(\"John Doe\");\n+\t\tReferenceAndListParam referenceParam = new ReferenceAndListParam();\n+\t\tReferenceParam allergyParam = new ReferenceParam();\n+\t\t\n+\t\tallergyParam.setChain(Patient.SP_NAME);\n+\t\tallergyParam.setValue(\"John Doe\");", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjI2OA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r392692268", "bodyText": "Ditto", "author": "varung-31", "createdAt": "2020-03-15T16:58:37Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirObservationDaoImplTest.java", "diffHunk": "@@ -219,9 +221,13 @@ public void searchForObs_shouldSupportMappedAndUnmappedConcepts() {\n \t\n \t@Test\n \tpublic void searchForObs_shouldReturnObsByPatientUuid() {\n-\t\tReferenceParam patientReference = new ReferenceParam();\n-\t\tpatientReference.setChain(\"\");\n-\t\tpatientReference.setValue(PATIENT_UUID);\n+\t\tReferenceAndListParam patientReference = new ReferenceAndListParam();\n+\t\tReferenceParam patient = new ReferenceParam();\n+\t\t\n+\t\tpatient.setChain(\"\");\n+\t\tpatient.setValue(PATIENT_UUID);", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjI4MA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r392692280", "bodyText": "Ditto", "author": "varung-31", "createdAt": "2020-03-15T16:58:46Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirObservationDaoImplTest.java", "diffHunk": "@@ -232,9 +238,13 @@ public void searchForObs_shouldReturnObsByPatientUuid() {\n \t\n \t@Test\n \tpublic void searchForObs_shouldReturnObsByPatientGivenName() {\n-\t\tReferenceParam patientReference = new ReferenceParam();\n-\t\tpatientReference.setChain(Patient.SP_GIVEN);\n-\t\tpatientReference.setValue(PATIENT_GIVEN_NAME);\n+\t\tReferenceAndListParam patientReference = new ReferenceAndListParam();\n+\t\tReferenceParam patient = new ReferenceParam();\n+\t\t\n+\t\tpatient.setChain(Patient.SP_GIVEN);\n+\t\tpatient.setValue(PATIENT_GIVEN_NAME);", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjI5MA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r392692290", "bodyText": "Ditto", "author": "varung-31", "createdAt": "2020-03-15T16:58:53Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirObservationDaoImplTest.java", "diffHunk": "@@ -245,9 +255,13 @@ public void searchForObs_shouldReturnObsByPatientGivenName() {\n \t\n \t@Test\n \tpublic void searchForObs_shouldReturnObsByPatientFamilyName() {\n-\t\tReferenceParam patientReference = new ReferenceParam();\n-\t\tpatientReference.setChain(Patient.SP_FAMILY);\n-\t\tpatientReference.setValue(PATIENT_FAMILY_NAME);\n+\t\tReferenceAndListParam patientReference = new ReferenceAndListParam();\n+\t\tReferenceParam patient = new ReferenceParam();\n+\t\t\n+\t\tpatient.setChain(Patient.SP_FAMILY);\n+\t\tpatient.setValue(PATIENT_FAMILY_NAME);", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjMwNg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r392692306", "bodyText": "Ditto", "author": "varung-31", "createdAt": "2020-03-15T16:59:01Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirObservationDaoImplTest.java", "diffHunk": "@@ -258,9 +272,13 @@ public void searchForObs_shouldReturnObsByPatientFamilyName() {\n \t\n \t@Test\n \tpublic void searchForObs_shouldReturnObsByPatientName() {\n-\t\tReferenceParam patientReference = new ReferenceParam();\n-\t\tpatientReference.setChain(Patient.SP_NAME);\n-\t\tpatientReference.setValue(PATIENT_GIVEN_NAME + \" \" + PATIENT_FAMILY_NAME);\n+\t\tReferenceAndListParam patientReference = new ReferenceAndListParam();\n+\t\tReferenceParam patient = new ReferenceParam();\n+\t\t\n+\t\tpatient.setChain(Patient.SP_NAME);\n+\t\tpatient.setValue(PATIENT_GIVEN_NAME + \" \" + PATIENT_FAMILY_NAME);", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjMxOA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r392692318", "bodyText": "Ditto", "author": "varung-31", "createdAt": "2020-03-15T16:59:10Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/dao/impl/FhirObservationDaoImplTest.java", "diffHunk": "@@ -271,9 +289,13 @@ public void searchForObs_shouldReturnObsByPatientName() {\n \t\n \t@Test\n \tpublic void searchForObs_shouldReturnObsByPatientIdentifier() {\n-\t\tReferenceParam patientReference = new ReferenceParam();\n-\t\tpatientReference.setChain(Patient.SP_IDENTIFIER);\n-\t\tpatientReference.setValue(PATIENT_IDENTIFIER);\n+\t\tReferenceAndListParam patientReference = new ReferenceAndListParam();\n+\t\tReferenceParam patient = new ReferenceParam();\n+\t\t\n+\t\tpatient.setChain(Patient.SP_IDENTIFIER);\n+\t\tpatient.setValue(PATIENT_IDENTIFIER);", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjM0NA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r392692344", "bodyText": "Ditto", "author": "varung-31", "createdAt": "2020-03-15T16:59:37Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirAllergyIntoleranceServiceImplTest.java", "diffHunk": "@@ -111,7 +119,13 @@ public void searchForAllergies_shouldSearchForAllergiesByIdentifier() {\n \tpublic void searchForAllergies_shouldSearchForAllergiesByPatientGivenName() {\n \t\tCollection<Allergy> allergies = new ArrayList<>();\n \t\tallergies.add(omrsAllergy);\n-\t\tReferenceParam patientParam = new ReferenceParam().setChain(Patient.SP_GIVEN).setValue(\"John\");\n+\t\tReferenceAndListParam patientParam = new ReferenceAndListParam();\n+\t\tReferenceParam referenceParam = new ReferenceParam();\n+\t\t\n+\t\treferenceParam.setChain(Patient.SP_GIVEN);\n+\t\treferenceParam.setValue(\"John\");", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjM1Mw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r392692353", "bodyText": "Ditto", "author": "varung-31", "createdAt": "2020-03-15T16:59:46Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirAllergyIntoleranceServiceImplTest.java", "diffHunk": "@@ -126,7 +140,13 @@ public void searchForAllergies_shouldSearchForAllergiesByPatientGivenName() {\n \tpublic void searchForAllergies_shouldSearchForAllergiesByPatientFamilyName() {\n \t\tCollection<Allergy> allergies = new ArrayList<>();\n \t\tallergies.add(omrsAllergy);\n-\t\tReferenceParam patientParam = new ReferenceParam().setChain(Patient.SP_FAMILY).setValue(\"John\");\n+\t\tReferenceAndListParam patientParam = new ReferenceAndListParam();\n+\t\tReferenceParam referenceParam = new ReferenceParam();\n+\t\t\n+\t\treferenceParam.setChain(Patient.SP_FAMILY);\n+\t\treferenceParam.setValue(\"John\");", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjM2Ng==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r392692366", "bodyText": "Ditto", "author": "varung-31", "createdAt": "2020-03-15T16:59:54Z", "path": "api/src/test/java/org/openmrs/module/fhir2/api/impl/FhirAllergyIntoleranceServiceImplTest.java", "diffHunk": "@@ -141,7 +161,13 @@ public void searchForAllergies_shouldSearchForAllergiesByPatientFamilyName() {\n \tpublic void searchForAllergies_shouldSearchForAllergiesByPatientName() {\n \t\tCollection<Allergy> allergies = new ArrayList<>();\n \t\tallergies.add(omrsAllergy);\n-\t\tReferenceParam patientParam = new ReferenceParam().setChain(Patient.SP_NAME).setValue(\"John Doe\");\n+\t\tReferenceAndListParam patientParam = new ReferenceAndListParam();\n+\t\tReferenceParam referenceParam = new ReferenceParam();\n+\t\t\n+\t\treferenceParam.setChain(Patient.SP_NAME);\n+\t\treferenceParam.setValue(\"John Doe\");", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAxOTMxMQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r393019311", "bodyText": "When we're doing this inside a handleAndListParam we do need to check that the alias doesn't already exist.", "author": "ibacher", "createdAt": "2020-03-16T13:24:38Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java", "diffHunk": "@@ -455,70 +456,76 @@ protected boolean containsAlias(Iterator<CriteriaImpl.Subcriteria> subcriteriaIt\n \t\t});\n \t}\n \t\n-\tprotected void handleLocationReference(Criteria criteria, ReferenceParam locationReference) {\n+\tprotected void handleLocationReference(Criteria criteria, ReferenceAndListParam locationReference) {\n \t\tif (locationReference != null) {\n \t\t\tcriteria.createAlias(\"location\", \"l\");\n \t\t\t\n-\t\t\tif (locationReference.getChain() != null) {\n-\t\t\t\tswitch (locationReference.getChain()) {\n-\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n-\t\t\t\t\t\tpropertyLike(\"l.cityVillage\", locationReference.getValue()).ifPresent(criteria::add);\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n-\t\t\t\t\t\tpropertyLike(\"l.stateProvince\", locationReference.getValue()).ifPresent(criteria::add);\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n-\t\t\t\t\t\tpropertyLike(\"l.postalCode\", locationReference.getValue()).ifPresent(criteria::add);\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n-\t\t\t\t\t\tpropertyLike(\"l.country\", locationReference.getValue()).ifPresent(criteria::add);\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase \"\":\n-\t\t\t\t\t\tcriteria.add(eq(\"l.uuid\", locationReference.getValue()));\n-\t\t\t\t\t\tbreak;\n+\t\t\thandleAndListParam(locationReference, token -> {\n+\t\t\t\tif (token.getChain() != null) {\n+\t\t\t\t\tswitch (token.getChain()) {\n+\t\t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n+\t\t\t\t\t\t\tpropertyLike(\"l.cityVillage\", token.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n+\t\t\t\t\t\t\tpropertyLike(\"l.stateProvince\", token.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n+\t\t\t\t\t\t\tpropertyLike(\"l.postalCode\", token.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n+\t\t\t\t\t\t\tpropertyLike(\"l.country\", token.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\tcase \"\":\n+\t\t\t\t\t\t\tcriteria.add(eq(\"l.uuid\", token.getValue()));\n+\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t}\n \t\t\t\t}\n-\t\t\t}\n+\t\t\t\treturn Optional.empty();\n+\t\t\t});\n \t\t}\n \t}\n \t\n-\tprotected void handleParticipantReference(Criteria criteria, ReferenceParam participantReference) {\n+\tprotected void handleParticipantReference(Criteria criteria, ReferenceAndListParam participantReference) {\n \t\tif (participantReference != null) {\n \t\t\tcriteria.createAlias(\"encounterProviders\", \"ep\");\n \t\t\t\n-\t\t\tif (participantReference.getChain() != null) {\n-\t\t\t\tswitch (participantReference.getChain()) {\n-\t\t\t\t\tcase Practitioner.SP_IDENTIFIER:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").add(ilike(\"p.identifier\", participantReference.getValue()));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Practitioner.SP_GIVEN:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"pro\").createAlias(\"pro.person\", \"ps\")\n-\t\t\t\t\t\t        .createAlias(\"ps.names\", \"pn\")\n-\t\t\t\t\t\t        .add(ilike(\"pn.givenName\", participantReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Practitioner.SP_FAMILY:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"pro\").createAlias(\"pro.person\", \"ps\")\n-\t\t\t\t\t\t        .createAlias(\"ps.names\", \"pn\")\n-\t\t\t\t\t\t        .add(ilike(\"pn.familyName\", participantReference.getValue(), MatchMode.START));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase Practitioner.SP_NAME:\n-\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"pro\").createAlias(\"pro.person\", \"ps\").createAlias(\"ps.names\",\n-\t\t\t\t\t\t    \"pn\");\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tList<Optional<Criterion>> criterionList = new ArrayList<>();\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tfor (String token : StringUtils.split(participantReference.getValue(), \" \\t,\")) {\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.givenName\", token));\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.middleName\", token));\n-\t\t\t\t\t\t\tcriterionList.add(propertyLike(\"pn.familyName\", token));\n-\t\t\t\t\t\t}\n-\t\t\t\t\t\t\n-\t\t\t\t\t\tcriteria.add(or(toCriteriaArray(criterionList)));\n-\t\t\t\t\t\tbreak;\n-\t\t\t\t\tcase \"\":\n-\t\t\t\t\t\tcriteria.add(eq(\"ep.uuid\", participantReference.getValue()));\n-\t\t\t\t\t\tbreak;\n+\t\t\thandleAndListParam(participantReference, participantToken -> {\n+\t\t\t\tif (participantToken.getChain() != null) {\n+\t\t\t\t\tswitch (participantToken.getChain()) {\n+\t\t\t\t\t\tcase Practitioner.SP_IDENTIFIER:\n+\t\t\t\t\t\t\tcriteria.createAlias(\"ep.provider\", \"p\").add(ilike(\"p.identifier\", participantToken.getValue()));", "originalCommit": "431a8cbd8e88c61ab131852881c0a26c16e0c85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIxODk0NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r393218945", "bodyText": "I would prefer that instead of creating the alias here, we just pass in what the alias is called as it was before.", "author": "ibacher", "createdAt": "2020-03-16T18:08:45Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java", "diffHunk": "@@ -418,13 +418,14 @@ protected boolean containsAlias(Iterator<CriteriaImpl.Subcriteria> subcriteriaIt\n \t\treturn Optional.empty();\n \t}\n \t\n-\tprotected Optional<Criterion> handleEncounterReference(@NotNull String encounterAlias,\n-\t        ReferenceParam encounterReference) {\n-\t\tif (encounterReference == null || encounterReference.getIdPart() == null) {\n-\t\t\treturn Optional.empty();\n+\tprotected void handleEncounterReference(Criteria criteria, ReferenceAndListParam encounterReference) {\n+\t\tif (encounterReference != null) {\n+\t\t\tcriteria.createAlias(\"encounter\", \"e\");\n+\t\t\thandleAndListParam(encounterReference, token -> {\n+\t\t\t\tcriteria.add(ilike(\"e.uuid\", token.getIdPart()));\n+\t\t\t\treturn Optional.empty();\n+\t\t\t});", "originalCommit": "af45acacfc21fddc1a4c9e444241882619df7276", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIyMDQ3Ng==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r393220476", "bodyText": "I'd prefer this method to be re-written along the lines I requested for handleEncounterReference above. We don't want to be passing around the Criteria object unless we absolutely need to.", "author": "ibacher", "createdAt": "2020-03-16T18:10:32Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java", "diffHunk": "@@ -455,58 +456,59 @@ protected boolean containsAlias(Iterator<CriteriaImpl.Subcriteria> subcriteriaIt\n \t\t});\n \t}\n \t\n-\tprotected void handleLocationReference(Criteria criteria, ReferenceParam locationReference) {\n+\tprotected void handleLocationReference(Criteria criteria, ReferenceAndListParam locationReference) {\n \t\tif (locationReference != null) {\n \t\t\tcriteria.createAlias(\"location\", \"l\");\n \t\t\t\n-\t\t\tif (locationReference.getChain() != null) {\n-\t\t\t\tswitch (locationReference.getChain()) {\n+\t\t\thandleAndListParam(locationReference, token -> {\n+\t\t\t\tswitch (token.getChain()) {\n \t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n-\t\t\t\t\t\tpropertyLike(\"l.cityVillage\", locationReference.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\tpropertyLike(\"l.cityVillage\", token.getValue()).ifPresent(criteria::add);\n \t\t\t\t\t\tbreak;\n \t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n-\t\t\t\t\t\tpropertyLike(\"l.stateProvince\", locationReference.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\tpropertyLike(\"l.stateProvince\", token.getValue()).ifPresent(criteria::add);\n \t\t\t\t\t\tbreak;\n \t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n-\t\t\t\t\t\tpropertyLike(\"l.postalCode\", locationReference.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\tpropertyLike(\"l.postalCode\", token.getValue()).ifPresent(criteria::add);\n \t\t\t\t\t\tbreak;\n \t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n-\t\t\t\t\t\tpropertyLike(\"l.country\", locationReference.getValue()).ifPresent(criteria::add);\n-\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tpropertyLike(\"l.country\", token.getValue()).ifPresent(criteria::add);\n \t\t\t\t\tcase \"\":\n-\t\t\t\t\t\tcriteria.add(eq(\"l.uuid\", locationReference.getValue()));\n+\t\t\t\t\t\tcriteria.add(eq(\"l.uuid\", token.getValue()));\n \t\t\t\t\t\tbreak;\n \t\t\t\t}\n-\t\t\t}\n+\t\t\t\t\n+\t\t\t\treturn Optional.empty();", "originalCommit": "af45acacfc21fddc1a4c9e444241882619df7276", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIyMTQ4Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r393221487", "bodyText": "We definitely need !containsAlias checks around these createAlias uses. This, however, seems like a legitimate place to pass in the criteria.", "author": "ibacher", "createdAt": "2020-03-16T18:12:19Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java", "diffHunk": "@@ -455,58 +456,59 @@ protected boolean containsAlias(Iterator<CriteriaImpl.Subcriteria> subcriteriaIt\n \t\t});\n \t}\n \t\n-\tprotected void handleLocationReference(Criteria criteria, ReferenceParam locationReference) {\n+\tprotected void handleLocationReference(Criteria criteria, ReferenceAndListParam locationReference) {\n \t\tif (locationReference != null) {\n \t\t\tcriteria.createAlias(\"location\", \"l\");\n \t\t\t\n-\t\t\tif (locationReference.getChain() != null) {\n-\t\t\t\tswitch (locationReference.getChain()) {\n+\t\t\thandleAndListParam(locationReference, token -> {\n+\t\t\t\tswitch (token.getChain()) {\n \t\t\t\t\tcase Location.SP_ADDRESS_CITY:\n-\t\t\t\t\t\tpropertyLike(\"l.cityVillage\", locationReference.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\tpropertyLike(\"l.cityVillage\", token.getValue()).ifPresent(criteria::add);\n \t\t\t\t\t\tbreak;\n \t\t\t\t\tcase Location.SP_ADDRESS_STATE:\n-\t\t\t\t\t\tpropertyLike(\"l.stateProvince\", locationReference.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\tpropertyLike(\"l.stateProvince\", token.getValue()).ifPresent(criteria::add);\n \t\t\t\t\t\tbreak;\n \t\t\t\t\tcase Location.SP_ADDRESS_POSTALCODE:\n-\t\t\t\t\t\tpropertyLike(\"l.postalCode\", locationReference.getValue()).ifPresent(criteria::add);\n+\t\t\t\t\t\tpropertyLike(\"l.postalCode\", token.getValue()).ifPresent(criteria::add);\n \t\t\t\t\t\tbreak;\n \t\t\t\t\tcase Location.SP_ADDRESS_COUNTRY:\n-\t\t\t\t\t\tpropertyLike(\"l.country\", locationReference.getValue()).ifPresent(criteria::add);\n-\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\tpropertyLike(\"l.country\", token.getValue()).ifPresent(criteria::add);\n \t\t\t\t\tcase \"\":\n-\t\t\t\t\t\tcriteria.add(eq(\"l.uuid\", locationReference.getValue()));\n+\t\t\t\t\t\tcriteria.add(eq(\"l.uuid\", token.getValue()));\n \t\t\t\t\t\tbreak;\n \t\t\t\t}\n-\t\t\t}\n+\t\t\t\t\n+\t\t\t\treturn Optional.empty();\n+\t\t\t});\n \t\t}\n \t}\n \t\n-\tprotected void handleParticipantReference(Criteria criteria, ReferenceParam participantReference) {\n+\tprotected void handleParticipantReference(Criteria criteria, ReferenceAndListParam participantReference) {\n \t\tif (participantReference != null) {\n \t\t\tcriteria.createAlias(\"encounterProviders\", \"ep\");", "originalCommit": "af45acacfc21fddc1a4c9e444241882619df7276", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIyMTc2NA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r393221764", "bodyText": "Again we should have !containsAlias check", "author": "ibacher", "createdAt": "2020-03-16T18:12:52Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java", "diffHunk": "@@ -569,33 +574,34 @@ protected void handleNames(Criteria criteria, StringOrListParam name, StringOrLi\n \t\t}\n \t}\n \t\n-\tprotected void handlePatientReference(Criteria criteria, ReferenceParam patientReference) {\n+\tprotected void handlePatientReference(Criteria criteria, ReferenceAndListParam patientReference) {\n \t\thandlePatientReference(criteria, patientReference, \"patient\");\n \t}\n \t\n-\tprotected void handlePatientReference(Criteria criteria, ReferenceParam patientReference, String associationPath) {\n+\tprotected void handlePatientReference(Criteria criteria, ReferenceAndListParam patientReference,\n+\t        String associationPath) {\n \t\tif (patientReference != null) {\n \t\t\tcriteria.createAlias(associationPath, \"p\");\n \t\t\t\n-\t\t\tif (patientReference.getChain() != null) {\n-\t\t\t\tswitch (patientReference.getChain()) {\n+\t\t\thandleAndListParam(patientReference, patientToken -> {\n+\t\t\t\tswitch (patientToken.getChain()) {\n \t\t\t\t\tcase Patient.SP_IDENTIFIER:\n-\t\t\t\t\t\tcriteria.createAlias(\"p.identifiers\", \"pi\").add(ilike(\"pi.identifier\", patientReference.getValue()));\n+\t\t\t\t\t\tcriteria.createAlias(\"p.identifiers\", \"pi\").add(ilike(\"pi.identifier\", patientToken.getValue()));", "originalCommit": "af45acacfc21fddc1a4c9e444241882619df7276", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e705d1e8ceb4049f59dd204086269bf56fbb9db2", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/e705d1e8ceb4049f59dd204086269bf56fbb9db2", "message": "improvements in BaseDao", "committedDate": "2020-03-18T18:02:59Z", "type": "forcePushed"}, {"oid": "c32eaa4cca6a796183c6096370175534a9cecac8", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/c32eaa4cca6a796183c6096370175534a9cecac8", "message": "Add support for AND / OR queries using References", "committedDate": "2020-03-19T14:15:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc1ODgyMw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r395758823", "bodyText": "So for these tests, rather than repurposing them for OR queries, we should leave the initial test as is, then test for OR and then add a separate test for AND (which looks like /Observation?subject.identifier=M4001-1&subject.identifier=IU230).\nAlso, it will be more readable if you save the ValueAsQueryTokens intermediate steps. Also note that unlike the results we sometimes use which are Collections the result of getValuesAsQueryTokens() are lists that can be indexed numerically.", "author": "ibacher", "createdAt": "2020-03-20T16:39:03Z", "path": "omod/src/test/java/org/openmrs/module/fhir2/providers/ObservationFhirResourceProviderWebTest.java", "diffHunk": "@@ -138,18 +140,29 @@ public void shouldGetObservationsByPatientUuid() throws Exception {\n \t\t\n \t\tverify(observationService).searchForObservations(isNull(), patientCaptor.capture(), isNull(), isNull());\n \t\tassertThat(patientCaptor.getValue(), notNullValue());\n-\t\tassertThat(patientCaptor.getValue().getIdPart(), equalTo(PATIENT_UUID));\n-\t\tassertThat(patientCaptor.getValue().getResourceType(), equalTo(\"Patient\"));\n+\t\tassertThat(patientCaptor.getAllValues().iterator().next().getValuesAsQueryTokens().iterator().next()\n+\t\t        .getValuesAsQueryTokens().iterator().next().getIdPart(),\n+\t\t    equalTo(PATIENT_UUID));\n+\t\tassertThat(patientCaptor.getAllValues().iterator().next().getValuesAsQueryTokens().iterator().next()\n+\t\t        .getValuesAsQueryTokens().iterator().next().getResourceType(),\n+\t\t    equalTo(\"Patient\"));\n \t}\n \t\n \t@Test\n \tpublic void shouldGetObservationsByPatientIdentifier() throws Exception {\n-\t\tverifyUri(\"/Observation?subject.identifier=M4001-1\");\n+\t\tverifyUri(\"/Observation?subject.identifier=M4001-1,ABS098,YT56RE,IU23O\");", "originalCommit": "c32eaa4cca6a796183c6096370175534a9cecac8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgxMTAwNg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r395811006", "bodyText": "(which looks like /Observation?subject.identifier=M4001-1&subject.identifier=IU230).\n\n@ibacher Can you explain what is this expected to give. I am asking this because when I was testing for /Observation?subject.identifier=M4001-1,IU230 I get size 2 of the list and when testing for /Observation?subject.identifier=M4001-1&subject.identifier=IU230 I get size equal to 1", "author": "VaishSiddharth", "createdAt": "2020-03-20T18:11:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc1ODgyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyNjM0NA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r395826344", "bodyText": "So it depends on where you're looking. Remember that the hierarchy for these types goes:\nEach AndParam contains 1 or more OrParams which contains 1 or more Params.\nThis means that if you search for /Observation?subject.identifier=M4001-1&subject.identifier=IU23, then the length of patientCaptor.getValue().getValueAsQueryTokens() should be 2, but the length of patientCaptor.getValue().getValueAsQueryTokens().get(0).getValueAsQueryTokens should be 1.", "author": "ibacher", "createdAt": "2020-03-20T18:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc1ODgyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg5ODQ1OQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/115#discussion_r395898459", "bodyText": "I know this isn't syntactically required but OpenMRS prefer curly braces around all if statements see our coding style guide. The reason for that is that while things might work well now, it's easier for maintenance if the if blocks are consistent.", "author": "ibacher", "createdAt": "2020-03-20T21:29:24Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/BaseDaoImpl.java", "diffHunk": "@@ -598,18 +598,22 @@ protected void handlePatientReference(Criteria criteria, ReferenceAndListParam p\n \t\t\thandleAndListParam(patientReference, patientToken -> {\n \t\t\t\tswitch (patientToken.getChain()) {\n \t\t\t\t\tcase Patient.SP_IDENTIFIER:\n-\t\t\t\t\t\tcriteria.createAlias(\"p.identifiers\", \"pi\").add(ilike(\"pi.identifier\", patientToken.getValue()));\n+\t\t\t\t\t\tif (!containsAlias(criteria, \"pi\"))", "originalCommit": "9ed3d0bf8a6836fa9b2c505be96e28f861ec1939", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7c8dfccb7e44be1d2260a338aec66e5e546e09ed", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/7c8dfccb7e44be1d2260a338aec66e5e546e09ed", "message": "Add support for AND / OR queries using References", "committedDate": "2020-03-23T12:46:55Z", "type": "commit"}, {"oid": "7c8dfccb7e44be1d2260a338aec66e5e546e09ed", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/7c8dfccb7e44be1d2260a338aec66e5e546e09ed", "message": "Add support for AND / OR queries using References", "committedDate": "2020-03-23T12:46:55Z", "type": "forcePushed"}, {"oid": "a70908571f505ac6810e7554a0218ce35074d758", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/a70908571f505ac6810e7554a0218ce35074d758", "message": "Merge branch 'master' into FM2-92", "committedDate": "2020-03-23T18:21:22Z", "type": "commit"}]}