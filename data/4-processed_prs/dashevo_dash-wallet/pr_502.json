{"pr_number": 502, "pr_title": "BIP70 | Broadcast Transaction After Server Ack", "pr_createdAt": "2020-09-02T15:57:58Z", "pr_url": "https://github.com/dashevo/dash-wallet/pull/502", "timeline": [{"oid": "f6ce2d6adebba2d040747dc096831c0760e033d1", "url": "https://github.com/dashevo/dash-wallet/commit/f6ce2d6adebba2d040747dc096831c0760e033d1", "message": "Removed obsolete test code.", "committedDate": "2020-09-02T11:37:10Z", "type": "commit"}, {"oid": "9eff79428068a436912b13f724086d61ef85a4f1", "url": "https://github.com/dashevo/dash-wallet/commit/9eff79428068a436912b13f724086d61ef85a4f1", "message": "Avoid broadcast BIP70 transaction is server did not acknowledge first", "committedDate": "2020-09-02T15:17:12Z", "type": "commit"}, {"oid": "214d78410f79dcdc4c788648c5e98f40c1fe43bd", "url": "https://github.com/dashevo/dash-wallet/commit/214d78410f79dcdc4c788648c5e98f40c1fe43bd", "message": "Changed the BIP70 payment error message", "committedDate": "2020-09-02T15:56:06Z", "type": "commit"}, {"oid": "af444fa05fec1e0f6e56b242a7f5394f0707b94a", "url": "https://github.com/dashevo/dash-wallet/commit/af444fa05fec1e0f6e56b242a7f5394f0707b94a", "message": "Fixed the issue with Electrum based BIP70 servers that doesn't provide PaymentUrl", "committedDate": "2020-09-02T16:12:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ0ODM1NA==", "url": "https://github.com/dashevo/dash-wallet/pull/502#discussion_r482448354", "bodyText": "I am not sure what txAlreadyCompleted means.  On line 126 above, txAlreadyCompleted is set to ensureMinRequiredFee which I thought was usually set to true.", "author": "HashEngineering", "createdAt": "2020-09-02T20:50:22Z", "path": "wallet/src/de/schildbach/wallet/ui/send/PaymentProtocolViewModel.kt", "diffHunk": "@@ -127,14 +126,22 @@ class PaymentProtocolViewModel(application: Application) : SendCoinsBaseViewMode\n         signAndSendPayment(finalPaymentIntent!!, baseSendRequest!!.ensureMinRequiredFee)\n     }\n \n-    fun directPay(transaction: Transaction) {\n+    override fun signAndSendPayment(sendRequest: SendRequest, txAlreadyCompleted: Boolean) {", "originalCommit": "af444fa05fec1e0f6e56b242a7f5394f0707b94a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjUwOTU2Mw==", "url": "https://github.com/dashevo/dash-wallet/pull/502#discussion_r482509563", "bodyText": "It is pretty tricky ;)\nBefore sending the transaction to server it has to be completed. Previously it was completed by the sendCoinsOffline method since we were broadcasting the transaction before sending to server. Now as we first want to send it to the server it has to be completed explicitly (and it is in https://github.com/dashevo/dash-wallet/pull/502/files/af444fa05fec1e0f6e56b242a7f5394f0707b94a#diff-6c4b3d3eb5b78806c89f5e5ffda4e1a1R131). On the other hand it cannot be completed again when we will be broadcasting the transaction. That is why I added this flag, but you probably already know that.\nThe tricky part is related to inheritance of payment related ViewModels. In the mentioned line 126, other version of this method is being called, it gets PaymentIntent as a first parameter, not the SendRequest.\nThe only place where the txAlreadyCompleted flag is true is here:\nfun commitAndBroadcast(sendRequest: SendRequest) {\n        super.signAndSendPayment(sendRequest, true)\n}\n\nhttps://github.com/dashevo/dash-wallet/pull/502/files/af444fa05fec1e0f6e56b242a7f5394f0707b94a#diff-6c4b3d3eb5b78806c89f5e5ffda4e1a1R168", "author": "tomasz-ludek", "createdAt": "2020-09-02T21:51:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ0ODM1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ1NjYxMA==", "url": "https://github.com/dashevo/dash-wallet/pull/502#discussion_r482456610", "bodyText": "Where does the value of txAlreadyComplete come from? The logic here seems to be that if the tx is completed (wallet.completeTx was called) then it only needs to be committed, otherwise wallet.sendCoinsOffline will complete and commit the transaction.  I suppose this makes sense, so this relates to a comment above about how the value of txAlreadyComplete is set.", "author": "HashEngineering", "createdAt": "2020-09-02T20:56:11Z", "path": "wallet/src/de/schildbach/wallet/ui/send/SendCoinsOfflineTask.java", "diffHunk": "@@ -51,14 +51,23 @@ public SendCoinsOfflineTask(final Wallet wallet, final Handler backgroundHandler\n     }\n \n     public final void sendCoinsOffline(final SendRequest sendRequest) {\n+        sendCoinsOffline(sendRequest, false);\n+    }\n+\n+    public final void sendCoinsOffline(final SendRequest sendRequest, final boolean txAlreadyCompleted) {\n         backgroundHandler.post(new Runnable() {\n             @Override\n             public void run() {\n                 org.bitcoinj.core.Context.propagate(Constants.CONTEXT);\n \n                 try {\n                     log.info(\"sending: {}\", sendRequest);\n-                    final Transaction transaction = wallet.sendCoinsOffline(sendRequest); // can take long\n+                    if (txAlreadyCompleted) {\n+                        wallet.commitTx(sendRequest.tx);\n+                    } else {\n+                        wallet.sendCoinsOffline(sendRequest);\n+                    }", "originalCommit": "af444fa05fec1e0f6e56b242a7f5394f0707b94a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "293ae42855fab56cccdbe1c703c28138dd535050", "url": "https://github.com/dashevo/dash-wallet/commit/293ae42855fab56cccdbe1c703c28138dd535050", "message": "Checking expiration date once again just before performing payment", "committedDate": "2020-09-08T17:23:15Z", "type": "commit"}]}