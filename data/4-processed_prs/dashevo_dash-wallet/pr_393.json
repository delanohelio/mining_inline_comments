{"pr_number": 393, "pr_title": "NMA-498: Connect UI to Backend, Part II - Create Username", "pr_createdAt": "2020-04-28T04:09:19Z", "pr_url": "https://github.com/dashevo/dash-wallet/pull/393", "timeline": [{"oid": "dafcc3247a2323d113657e5c6015d366dc974b34", "url": "https://github.com/dashevo/dash-wallet/commit/dafcc3247a2323d113657e5c6015d366dc974b34", "message": "Add Create Username: Part I", "committedDate": "2020-04-28T04:06:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQzMjc4Mg==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r416432782", "bodyText": "This line is redundant", "author": "tomasz-ludek", "createdAt": "2020-04-28T08:35:19Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -50,4 +59,68 @@ class PlatformRepo(walletApplication: WalletApplication) {\n             Resource.error(e.localizedMessage, null)\n         }\n     }\n+\n+    //\n+    // Step 1 is to upgrade the wallet to support AuthenticationKeyChains\n+    //\n+    fun addWalletAuthenticationKeys(seed: DeterministicSeed, keyParameter: KeyParameter?): RegistrationResource<Boolean> {\n+        val wallet = walletApplication.wallet\n+        val hasKeys = wallet.hasAuthenticationKeyChains()\n+        if(!hasKeys) {\n+            wallet.initializeAuthenticationKeyChains(seed, keyParameter)\n+            return RegistrationResource.success(RegistrationStep.UPGRADING_WALLET, hasKeys)", "originalCommit": "dafcc3247a2323d113657e5c6015d366dc974b34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjk3Mzg4Mg==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r416973882", "bodyText": "sure is", "author": "HashEngineering", "createdAt": "2020-04-28T22:59:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQzMjc4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQzNjA2MA==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r416436060", "bodyText": "We should probably use a wider scope for this operation, I need to think of it.", "author": "tomasz-ludek", "createdAt": "2020-04-28T08:40:17Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/DashPayViewModel.kt", "diffHunk": "@@ -56,4 +72,60 @@ class DashPayViewModel(application: Application) : AndroidViewModel(application)\n         emit(Resource.loading(null))\n         emit(platformRepo.isPlatformAvailable())\n     }\n+    // username registration functions\n+\n+    val createUsernameLiveData = Transformations.switchMap(registerUsernameLiveData) { usernameInfo ->\n+        val wallet = walletApplication.wallet\n+        liveData(Dispatchers.IO) {", "originalCommit": "dafcc3247a2323d113657e5c6015d366dc974b34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMxMDAxMg==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r418310012", "bodyText": "if we update the database with the identity creation status, then do we need to have the createUsernameLiveData in this view model?\nWhat if we created a thread or used a coroutine to run the createUserName process.  As the process proceeds through each step, we update the database with the current status.  Then views (such as the home screen or others) subscribe to that database.  As the database changes, the views are updated?\nIs that what you mean by scope?", "author": "HashEngineering", "createdAt": "2020-04-30T21:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQzNjA2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ3NDA5OQ==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r418474099", "bodyText": "Not exactly, I was rather referring to the coroutines scope (https://developer.android.com/topic/libraries/architecture/coroutines). In the current implementation we use livedata scope so the coroutine is only active as long as the createUsernameLiveData is observed by at least one observer (ie CreateUsernameActivity) if you for instance move to the to background before finishing the job it can be suspended or even canceled by the system.\nInitially I was thinking about using an GlobalScope.launch or something similar but finally I came to the conclusion that the identity creating should be treated as a long-running operation and managed by WorkManager (https://developer.android.com/topic/libraries/architecture/workmanager/basics).\nI'm preparing the patch transferring your code to the Worker.\nThe rest remains as you described: the process (managed by WorkManager) proceeds through each step, we update the database with the current status. Then views subscribe to that database. As the database changes, the views are updated.", "author": "tomasz-ludek", "createdAt": "2020-05-01T09:18:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQzNjA2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0MzM2Nw==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r418543367", "bodyText": "A perfect thing for our use case provided by WorkManager is chained tasks feature. We can define a chain of tasks that has to be completed in order to create identity and the WorkManager will take care of correct execution of each task handling loses oh connectivity etc https://developer.android.com/topic/libraries/architecture/workmanager/advanced", "author": "tomasz-ludek", "createdAt": "2020-05-01T13:36:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQzNjA2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU5NDUyNQ==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r418594525", "bodyText": "That sounds great.", "author": "HashEngineering", "createdAt": "2020-05-01T15:33:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQzNjA2MA=="}], "type": "inlineReview"}, {"oid": "0f5c841527dc066c86ba349beecf82fd145b7236", "url": "https://github.com/dashevo/dash-wallet/commit/0f5c841527dc066c86ba349beecf82fd145b7236", "message": "Initial implementation of CreateIdentityService", "committedDate": "2020-05-04T17:26:05Z", "type": "commit"}, {"oid": "3975aa4e5c3108ffe0d6dbfe4c1b16f72220e1d4", "url": "https://github.com/dashevo/dash-wallet/commit/3975aa4e5c3108ffe0d6dbfe4c1b16f72220e1d4", "message": "Handling new IdentityCreationState. Performing first operations directly from CreateIdentityService", "committedDate": "2020-05-04T19:15:45Z", "type": "commit"}, {"oid": "9d16a706a73a3e82d59ad788b64e58472a5f9608", "url": "https://github.com/dashevo/dash-wallet/commit/9d16a706a73a3e82d59ad788b64e58472a5f9608", "message": "Improved exception handling in CreateIdentityService.\nMoved notification related code to dedicated class CreateIdentityNotification.", "committedDate": "2020-05-05T10:36:36Z", "type": "commit"}, {"oid": "36ba8beeae80102da73129028b28d3076eb87673", "url": "https://github.com/dashevo/dash-wallet/commit/36ba8beeae80102da73129028b28d3076eb87673", "message": "Fixed database version", "committedDate": "2020-05-05T10:45:45Z", "type": "commit"}, {"oid": "e287fc5407f10646641d37a4c700148ee2c1c4b7", "url": "https://github.com/dashevo/dash-wallet/commit/e287fc5407f10646641d37a4c700148ee2c1c4b7", "message": "CreateIdentityService: Add remaining steps (with 2 second delay between steps)", "committedDate": "2020-05-05T16:20:36Z", "type": "commit"}, {"oid": "6e08cd6fb8bd50e39620768932705edf1626c60a", "url": "https://github.com/dashevo/dash-wallet/commit/6e08cd6fb8bd50e39620768932705edf1626c60a", "message": "CreateUserNameActivity: add observer to close activity", "committedDate": "2020-05-05T16:22:04Z", "type": "commit"}, {"oid": "69f562c290c9583662b3cc2b02f3d21bb9010ddf", "url": "https://github.com/dashevo/dash-wallet/commit/69f562c290c9583662b3cc2b02f3d21bb9010ddf", "message": "DashPayViewModel: fix compile issue", "committedDate": "2020-05-05T16:22:38Z", "type": "commit"}, {"oid": "bc2ea0856fc165b78cbcc784c75cfccb75c7c7f9", "url": "https://github.com/dashevo/dash-wallet/commit/bc2ea0856fc165b78cbcc784c75cfccb75c7c7f9", "message": "PlatformRepo:  add remaining steps", "committedDate": "2020-05-05T16:23:05Z", "type": "commit"}, {"oid": "29cfe2d0294c3cd9db2dbeeb2e7ee2ecf2f11a7c", "url": "https://github.com/dashevo/dash-wallet/commit/29cfe2d0294c3cd9db2dbeeb2e7ee2ecf2f11a7c", "message": "WalletActivity: change onClick to start create activity", "committedDate": "2020-05-05T16:23:43Z", "type": "commit"}, {"oid": "ad0a85db7f3bf97c5cfb32a5b578b590543c4eaa", "url": "https://github.com/dashevo/dash-wallet/commit/ad0a85db7f3bf97c5cfb32a5b578b590543c4eaa", "message": "Unify display of user validation on network (applied iOS styling) (#399)", "committedDate": "2020-05-05T22:09:53Z", "type": "commit"}, {"oid": "801a4497d924e630269ffec701033a4733da1ba2", "url": "https://github.com/dashevo/dash-wallet/commit/801a4497d924e630269ffec701033a4733da1ba2", "message": "Disable Register button when the username is not valid", "committedDate": "2020-05-05T22:24:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU4OTg1NA==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r420589854", "bodyText": "We can give the val exception a default null value, so we don't have to explicitly pass it as null on lines 25 and 33.", "author": "sambarboza", "createdAt": "2020-05-06T07:20:20Z", "path": "wallet/src/de/schildbach/wallet/livedata/RegistrationResource.kt", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Copyright 2020 Dash Core Group\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package de.schildbach.wallet.livedata\n+\n+import de.schildbach.wallet.livedata.Status.*\n+import java.lang.Exception\n+\n+data class RegistrationResource<out T>(val status: Status, val step: RegistrationStep, val data: T?, val exception: Exception?) {", "originalCommit": "ad0a85db7f3bf97c5cfb32a5b578b590543c4eaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE2NjY4Ng==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r421166686", "bodyText": "RegistrationResource has been removed", "author": "HashEngineering", "createdAt": "2020-05-07T00:21:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU4OTg1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU5MzIxNw==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r420593217", "bodyText": "Any reason to not use IdentityCreationState.State or replace it? Both seems to contain the same information.", "author": "sambarboza", "createdAt": "2020-05-06T07:27:18Z", "path": "wallet/src/de/schildbach/wallet/livedata/RegistrationStep.kt", "diffHunk": "@@ -0,0 +1,16 @@\n+package de.schildbach.wallet.livedata\n+\n+enum class RegistrationStep {", "originalCommit": "ad0a85db7f3bf97c5cfb32a5b578b590543c4eaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE2NjU3MA==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r421166570", "bodyText": "RegistrationStep has been removed.", "author": "HashEngineering", "createdAt": "2020-05-07T00:20:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU5MzIxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ2MzE2Nw==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r423463167", "bodyText": "Removed here: 1df4586", "author": "HashEngineering", "createdAt": "2020-05-12T05:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU5MzIxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNDY3MA==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r421104670", "bodyText": "Can we move the two observers below, or their setup, outside the onCreated method?", "author": "sambarboza", "createdAt": "2020-05-06T21:30:52Z", "path": "wallet/src/de/schildbach/wallet/ui/CreateUsernameActivity.kt", "diffHunk": "@@ -78,44 +85,100 @@ class CreateUsernameActivity : InteractionAwareActivity(), TextWatcher {\n             showCompleteState()\n         }\n \n+        walletApplication = application as WalletApplication", "originalCommit": "ad0a85db7f3bf97c5cfb32a5b578b590543c4eaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE2NjQ1MA==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r421166450", "bodyText": "yes", "author": "HashEngineering", "createdAt": "2020-05-07T00:20:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNDY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ2MzAzMg==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r423463032", "bodyText": "observers moved to initViewModel method here:  07f06f1", "author": "HashEngineering", "createdAt": "2020-05-12T05:01:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNDY3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNTg1MA==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r421105850", "bodyText": "We can use walletApplication.wallet, since walletApplication was already defined in line 88.", "author": "sambarboza", "createdAt": "2020-05-06T21:33:27Z", "path": "wallet/src/de/schildbach/wallet/ui/CreateUsernameActivity.kt", "diffHunk": "@@ -78,44 +85,100 @@ class CreateUsernameActivity : InteractionAwareActivity(), TextWatcher {\n             showCompleteState()\n         }\n \n+        walletApplication = application as WalletApplication\n+\n         val confirmTransactionSharedViewModel = ViewModelProviders.of(this)\n                 .get(SingleActionSharedViewModel::class.java)\n         confirmTransactionSharedViewModel.clickConfirmButtonEvent.observe(this, Observer {\n+            // setup the wallet\n+            val wallet = (application as WalletApplication).wallet", "originalCommit": "ad0a85db7f3bf97c5cfb32a5b578b590543c4eaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE2NjQwNg==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r421166406", "bodyText": "excellent", "author": "HashEngineering", "createdAt": "2020-05-07T00:20:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNTg1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ2Nzc4OQ==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r423467789", "bodyText": "I think that was changed here:  07f06f1", "author": "HashEngineering", "createdAt": "2020-05-12T05:19:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNTg1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNjY1Ng==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r421106656", "bodyText": "Will we still need this code?", "author": "sambarboza", "createdAt": "2020-05-06T21:35:13Z", "path": "wallet/src/de/schildbach/wallet/ui/CreateUsernameActivity.kt", "diffHunk": "@@ -78,44 +85,100 @@ class CreateUsernameActivity : InteractionAwareActivity(), TextWatcher {\n             showCompleteState()\n         }\n \n+        walletApplication = application as WalletApplication\n+\n         val confirmTransactionSharedViewModel = ViewModelProviders.of(this)\n                 .get(SingleActionSharedViewModel::class.java)\n         confirmTransactionSharedViewModel.clickConfirmButtonEvent.observe(this, Observer {\n+            // setup the wallet\n+            val wallet = (application as WalletApplication).wallet\n+\n+            //get key parameter\n+            val username = username.text.toString()\n+            if (wallet.isEncrypted) {\n+                ContextCompat.startForegroundService(this, createIntent(this, username))\n+\n+                // finish this activity on error or when registration is complete\n+                AppDatabase.getAppDatabase().identityCreationStateDao().load().observe(this, Observer {\n+                    if (it != null && it.error) {\n+                        finish()\n+                    } else when (it?.state) {\n+                        IdentityCreationState.State.USERNAME_REGISTERED -> {\n+                            finish()\n+                        }\n+                    }\n+                })\n+            } else {\n+                dashPayViewModel.createUsername(username, wallet.keyChainSeed, null)\n+            }\n             showProcessingState()\n         })\n \n         dashPayViewModel = ViewModelProvider(this).get(DashPayViewModel::class.java)\n \n         dashPayViewModel.getUsernameLiveData.observe(this, Observer {\n+            username_exists_req.visibility = View.VISIBLE\n+            username_exists_req_label.visibility = View.VISIBLE\n             when (it.status) {\n                 Status.LOADING -> {\n-                    register_btn.isEnabled = false\n-                    username_exists_req_label.visibility = View.GONE\n-                    username_exists_req_img.visibility = View.GONE\n+                    // this is delayed therefore the UI state is configured before calling checkUsernameNotExist(...)\n                 }\n                 Status.ERROR -> {\n-                    // Some error happened when communicating with Platform\n-                    // nothing is currently reported to the user\n+                    username_exists_req_progress.visibility = View.INVISIBLE\n+                    username_exists_req_img.visibility = View.VISIBLE\n+                    username_exists_req_img.setImageResource(R.drawable.ic_username_requirement_x)\n+                    username_exists_req_label.typeface = mediumTypeFace\n+                    username_exists_req_label.setTextColor(ResourcesCompat.getColor(resources, R.color.dash_red, null))\n+                    username_exists_req_label.setText(R.string.platform_communication_error)\n                     register_btn.isEnabled = false\n-                    username_exists_req_label.visibility = View.GONE\n-                    username_exists_req_img.visibility = View.GONE\n                 }\n                 Status.SUCCESS -> {\n                     if (it.data != null) {\n                         // This user name exists\n-                        register_btn.isEnabled = false\n-                        username_exists_req_label.visibility = View.VISIBLE\n+                        username_exists_req_progress.visibility = View.INVISIBLE\n                         username_exists_req_img.visibility = View.VISIBLE\n+                        username_exists_req_img.setImageResource(R.drawable.ic_username_requirement_x)\n+                        username_exists_req_label.typeface = mediumTypeFace\n+                        username_exists_req_label.setTextColor(ResourcesCompat.getColor(resources, R.color.dash_red, null))\n+                        username_exists_req_label.setText(R.string.identity_username_taken)\n+                        register_btn.isEnabled = false\n                     } else {\n+                        username_exists_req_progress.visibility = View.INVISIBLE\n+                        username_exists_req_img.visibility = View.VISIBLE\n+                        username_exists_req_img.setImageResource(R.drawable.ic_username_requirement_checkmark)\n+                        username_exists_req_label.typeface = mediumTypeFace\n+                        username_exists_req_label.setTextColor(ResourcesCompat.getColor(resources, R.color.dark_text, null))\n+                        username_exists_req_label.setText(R.string.identity__username_available)\n                         register_btn.isEnabled = true\n-                        username_exists_req_label.visibility = View.GONE\n-                        username_exists_req_img.visibility = View.GONE\n                     }\n                 }\n             }\n         })\n+\n+//        dashPayViewModel.createUsernameLiveData.observe(this, Observer {", "originalCommit": "ad0a85db7f3bf97c5cfb32a5b578b590543c4eaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE2NTM4MA==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r421165380", "bodyText": "This is not needed and will be removed", "author": "HashEngineering", "createdAt": "2020-05-07T00:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNjY1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNjk5OA==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r421106998", "bodyText": "Will we need this?", "author": "sambarboza", "createdAt": "2020-05-06T21:35:58Z", "path": "wallet/src/de/schildbach/wallet/ui/CreateUsernameActivity.kt", "diffHunk": "@@ -229,4 +299,33 @@ class CreateUsernameActivity : InteractionAwareActivity(), TextWatcher {\n     override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {\n     }\n \n+//    private fun handleDecryptPIN(password: String) {", "originalCommit": "ad0a85db7f3bf97c5cfb32a5b578b590543c4eaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE2NDkwNw==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r421164907", "bodyText": "we won't need this. the code was \"moved\" to the service", "author": "HashEngineering", "createdAt": "2020-05-07T00:15:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNjk5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE2NTE5OQ==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r421165199", "bodyText": "now this code has been removed", "author": "HashEngineering", "createdAt": "2020-05-07T00:16:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNjk5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ2NzY0OA==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r423467648", "bodyText": "removed:  1df4586", "author": "HashEngineering", "createdAt": "2020-05-12T05:18:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNjk5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNzM0OA==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r421107348", "bodyText": "It seems that these imports are not being used.", "author": "sambarboza", "createdAt": "2020-05-06T21:36:42Z", "path": "wallet/src/de/schildbach/wallet/ui/WalletActivity.java", "diffHunk": "@@ -65,6 +65,8 @@\n \n import de.schildbach.wallet.livedata.Resource;\n import de.schildbach.wallet.livedata.Status;\n+import de.schildbach.wallet.service.InactivityNotificationService;", "originalCommit": "ad0a85db7f3bf97c5cfb32a5b578b590543c4eaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ2NzM0NA==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r423467344", "bodyText": "Removed: a97121d", "author": "HashEngineering", "createdAt": "2020-05-12T05:17:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNzM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwODUzOQ==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r421108539", "bodyText": "Is the code below for testing purposes only?", "author": "sambarboza", "createdAt": "2020-05-06T21:39:22Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/CreateIdentityService.kt", "diffHunk": "@@ -0,0 +1,228 @@\n+package de.schildbach.wallet.ui.dashpay\n+\n+import android.content.Context\n+import android.content.Intent\n+import android.os.Handler\n+import androidx.lifecycle.LifecycleService\n+import de.schildbach.wallet.AppDatabase\n+import de.schildbach.wallet.WalletApplication\n+import de.schildbach.wallet.data.IdentityCreationState\n+import de.schildbach.wallet.ui.security.SecurityGuard\n+import de.schildbach.wallet.ui.send.DecryptSeedTask\n+import de.schildbach.wallet.ui.send.DeriveKeyTask\n+import kotlinx.coroutines.*\n+import org.bitcoinj.crypto.KeyCrypterException\n+import org.bitcoinj.wallet.DeterministicSeed\n+import org.bitcoinj.wallet.Wallet\n+import org.bouncycastle.crypto.params.KeyParameter\n+import org.dashevo.dashpay.BlockchainIdentity\n+import org.dashevo.dpp.identity.Identity\n+import org.slf4j.LoggerFactory\n+import java.io.IOException\n+import kotlin.coroutines.resume\n+import kotlin.coroutines.resumeWithException\n+import kotlin.coroutines.suspendCoroutine\n+import kotlin.random.Random\n+\n+\n+class CreateIdentityService : LifecycleService() {\n+\n+    companion object {\n+        private val log = LoggerFactory.getLogger(CreateIdentityService::class.java)\n+\n+        private const val ACTION_CREATE_IDENTITY = \"org.dash.dashpay.action.CREATE_IDENTITY\"\n+\n+        private const val EXTRA_USERNAME = \"org.dash.dashpay.extra.USERNAME\"\n+\n+        @JvmStatic\n+        fun createIntent(context: Context, username: String): Intent {\n+            return Intent(context, CreateIdentityService::class.java).apply {\n+                action = ACTION_CREATE_IDENTITY\n+                putExtra(EXTRA_USERNAME, username)\n+            }\n+        }\n+    }\n+\n+    private val walletApplication by lazy { application as WalletApplication }\n+    private val platformRepo by lazy { PlatformRepo(walletApplication) }\n+    private lateinit var securityGuard: SecurityGuard\n+\n+    private val identityCreationStateDaoAsync = AppDatabase.getAppDatabase().identityCreationStateDaoAsync()\n+\n+    private val createIdentityNotification by lazy { CreateIdentityNotification(this) }\n+\n+    private val serviceJob = Job()\n+    private val serviceScope = CoroutineScope(serviceJob + Dispatchers.Main)\n+\n+    lateinit var identityCreationState: IdentityCreationState\n+\n+    override fun onCreate() {\n+        super.onCreate()\n+        try {\n+            securityGuard = SecurityGuard()\n+        } catch (e: Exception) {\n+            log.error(\"Unable to instantiate SecurityGuard\", e)\n+            stopSelf()\n+            return\n+        }\n+        createIdentityNotification.startServiceForeground()\n+    }\n+\n+    override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {\n+        super.onStartCommand(intent, flags, startId)\n+\n+        if (intent != null) {\n+\n+            when (intent.action) {\n+                ACTION_CREATE_IDENTITY -> handleCreateIdentityAction(intent)\n+            }\n+        }\n+\n+        return START_NOT_STICKY\n+    }\n+\n+    private fun handleCreateIdentityAction(intent: Intent) {\n+        val username = intent.getStringExtra(EXTRA_USERNAME)\n+\n+        val exceptionHandler = CoroutineExceptionHandler { _, exception ->\n+            log.error(\"[${identityCreationState.state}(error)]\", exception)\n+            GlobalScope.launch {\n+                updateState(identityCreationState.state, true)\n+//                stopSelf()\n+            }\n+        }\n+\n+        serviceScope.launch(exceptionHandler) {\n+            createIdentity(username)\n+            stopSelf()\n+        }\n+    }\n+\n+    private suspend fun createIdentity(username: String) {\n+\n+        //identityCreationState = identityCreationStateDaoAsync.load()\n+        //        ?: IdentityCreationState(IdentityCreationState.State.UPGRADING_WALLET, false, username)\n+        identityCreationState = IdentityCreationState(IdentityCreationState.State.UPGRADING_WALLET, false, username)\n+        identityCreationStateDaoAsync.insert(identityCreationState)\n+\n+        if (identityCreationState.state != IdentityCreationState.State.UPGRADING_WALLET || identityCreationState.error) {\n+            log.info(\"resuming identity creation process [${identityCreationState.state}${if (identityCreationState.error) \"(error)\" else \"\"}]\")\n+        }\n+\n+        val handler = Handler()\n+        val wallet = walletApplication.wallet\n+        val password = securityGuard.retrievePassword()\n+\n+        val encryptionKey = deriveKey(handler, wallet, password)\n+        val seed = decryptSeed(handler, wallet, encryptionKey)\n+\n+//        val usernameInfo = CreateUsernameInfo(username, seed, encryptionKey)\n+\n+\n+        platformRepo.addWalletAuthenticationKeysAsync(seed, encryptionKey)\n+\n+        updateState(IdentityCreationState.State.CREDIT_FUNDING_TX_SENDING)\n+\n+        //create the Blockchain Identity object (this needs to be saved somewhere eventually)\n+        val blockchainIdentity = BlockchainIdentity(Identity.IdentityType.USER, 0, wallet)\n+\n+        platformRepo.createCreditFundingTransactionAsync(blockchainIdentity, encryptionKey)\n+\n+        walletApplication.broadcastTransaction(blockchainIdentity.creditFundingTransaction)\n+\n+        updateState(IdentityCreationState.State.CREDIT_FUNDING_TX_SENT)\n+", "originalCommit": "ad0a85db7f3bf97c5cfb32a5b578b590543c4eaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE0ODkwNQ==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r421148905", "bodyText": "Some of it is for testing purposes.\nThe 2 second delay between steps is for testing purposes (to watch process bars).\nCurrently there are several states for the Credit Funding Transaction (Create, Sending, Sent, Confirmed), but not all may be necessary to keep track of.  Also, this is still missing the code to determine that the transaction was sent and acknowledged by the network.\nThe remaining steps that handle registering the identity and username are working.", "author": "HashEngineering", "createdAt": "2020-05-06T23:24:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwODUzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ2NzQ2Ng==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r423467466", "bodyText": "Delays are removed: df09a47", "author": "HashEngineering", "createdAt": "2020-05-12T05:18:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwODUzOQ=="}], "type": "inlineReview"}, {"oid": "6d0cbd5e82c867691b1e57819c097720cb1fe2f4", "url": "https://github.com/dashevo/dash-wallet/commit/6d0cbd5e82c867691b1e57819c097720cb1fe2f4", "message": "Remove obsolete code", "committedDate": "2020-05-07T00:08:30Z", "type": "commit"}, {"oid": "a75d006a476d4cfbcc6ce4099bc8736d6bbebcd2", "url": "https://github.com/dashevo/dash-wallet/commit/a75d006a476d4cfbcc6ce4099bc8736d6bbebcd2", "message": "Add comments for steps", "committedDate": "2020-05-07T00:12:31Z", "type": "commit"}, {"oid": "5c1eab2641f3b8c61e62e2e267c582543bd6d09c", "url": "https://github.com/dashevo/dash-wallet/commit/5c1eab2641f3b8c61e62e2e267c582543bd6d09c", "message": "Use a suspendCoroutine to send a transaction and wait for feedback", "committedDate": "2020-05-07T00:13:45Z", "type": "commit"}, {"oid": "1df45863dd61ec1ce62105038f5247f9243a14a4", "url": "https://github.com/dashevo/dash-wallet/commit/1df45863dd61ec1ce62105038f5247f9243a14a4", "message": "CreateUsernameActivity: remove obsolete code", "committedDate": "2020-05-07T00:16:18Z", "type": "commit"}, {"oid": "07f06f10cd749c36d273323945784ef61d47cbae", "url": "https://github.com/dashevo/dash-wallet/commit/07f06f10cd749c36d273323945784ef61d47cbae", "message": "CreateUsernameActivity: Refactor initViewModel and wallet", "committedDate": "2020-05-07T00:22:07Z", "type": "commit"}, {"oid": "20dc2df50ba74e7b3d767f79537090a15dac38b7", "url": "https://github.com/dashevo/dash-wallet/commit/20dc2df50ba74e7b3d767f79537090a15dac38b7", "message": "Add BlockchainIdentity table to the app database", "committedDate": "2020-05-08T00:06:58Z", "type": "commit"}, {"oid": "9a2f16148d743e94485994dd208f8a852fad3baa", "url": "https://github.com/dashevo/dash-wallet/commit/9a2f16148d743e94485994dd208f8a852fad3baa", "message": "Save the BlockchainIdentity to the database along the way", "committedDate": "2020-05-08T00:08:01Z", "type": "commit"}, {"oid": "5a1da3425ac5fae24f0b6a2e3c110068b3de8045", "url": "https://github.com/dashevo/dash-wallet/commit/5a1da3425ac5fae24f0b6a2e3c110068b3de8045", "message": "Show the complete status at the end of the process", "committedDate": "2020-05-08T00:08:30Z", "type": "commit"}, {"oid": "193219fe36654003e7cf12b53aabefc480ca61df", "url": "https://github.com/dashevo/dash-wallet/commit/193219fe36654003e7cf12b53aabefc480ca61df", "message": "Don't show Join DashPay if an identity exists", "committedDate": "2020-05-08T00:09:13Z", "type": "commit"}, {"oid": "8fe43ed6e993ae8b3814de07f28909bbf96c9c3b", "url": "https://github.com/dashevo/dash-wallet/commit/8fe43ed6e993ae8b3814de07f28909bbf96c9c3b", "message": "Add possible error states (not used)", "committedDate": "2020-05-08T00:09:40Z", "type": "commit"}, {"oid": "a97121de3c2191f9550a247870638dcadf76b503", "url": "https://github.com/dashevo/dash-wallet/commit/a97121de3c2191f9550a247870638dcadf76b503", "message": "WalletActivity: Remove unused imports", "committedDate": "2020-05-12T05:07:02Z", "type": "commit"}, {"oid": "df09a470bc2902a7daa055eb72faffd22280083b", "url": "https://github.com/dashevo/dash-wallet/commit/df09a470bc2902a7daa055eb72faffd22280083b", "message": "CreateIdentityService: Remove delays and temp code, add comments, logs", "committedDate": "2020-05-12T05:15:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA2MTEwNg==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r424061106", "bodyText": "Can we please remove this line or add a //TODO?", "author": "sambarboza", "createdAt": "2020-05-12T22:05:26Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/CreateIdentityService.kt", "diffHunk": "@@ -0,0 +1,329 @@\n+package de.schildbach.wallet.ui.dashpay\n+\n+import android.content.Context\n+import android.content.Intent\n+import android.os.Handler\n+import androidx.lifecycle.LifecycleService\n+import de.schildbach.wallet.AppDatabase\n+import de.schildbach.wallet.Constants\n+import de.schildbach.wallet.WalletApplication\n+import de.schildbach.wallet.data.BlockchainIdentityData\n+import de.schildbach.wallet.data.IdentityCreationState\n+import de.schildbach.wallet.ui.security.SecurityGuard\n+import de.schildbach.wallet.ui.send.DecryptSeedTask\n+import de.schildbach.wallet.ui.send.DeriveKeyTask\n+import kotlinx.coroutines.*\n+import org.bitcoinj.core.RejectMessage\n+import org.bitcoinj.core.RejectedTransactionException\n+import org.bitcoinj.core.TransactionConfidence\n+import org.bitcoinj.crypto.KeyCrypterException\n+import org.bitcoinj.evolution.CreditFundingTransaction\n+import org.bitcoinj.wallet.DeterministicSeed\n+import org.bitcoinj.wallet.Wallet\n+import org.bouncycastle.crypto.params.KeyParameter\n+import org.dashevo.dashpay.BlockchainIdentity\n+import org.dashevo.dpp.identity.Identity\n+import org.dashevo.platform.Names\n+import org.slf4j.LoggerFactory\n+import java.io.IOException\n+import kotlin.coroutines.resume\n+import kotlin.coroutines.resumeWithException\n+import kotlin.coroutines.suspendCoroutine\n+\n+\n+class CreateIdentityService : LifecycleService() {\n+\n+    companion object {\n+        private val log = LoggerFactory.getLogger(CreateIdentityService::class.java)\n+\n+        private const val ACTION_CREATE_IDENTITY = \"org.dash.dashpay.action.CREATE_IDENTITY\"\n+\n+        private const val EXTRA_USERNAME = \"org.dash.dashpay.extra.USERNAME\"\n+\n+        @JvmStatic\n+        fun createIntent(context: Context, username: String): Intent {\n+            return Intent(context, CreateIdentityService::class.java).apply {\n+                action = ACTION_CREATE_IDENTITY\n+                putExtra(EXTRA_USERNAME, username)\n+            }\n+        }\n+    }\n+\n+    private val walletApplication by lazy { application as WalletApplication }\n+    private val platformRepo by lazy { PlatformRepo(walletApplication) }\n+    private lateinit var securityGuard: SecurityGuard\n+\n+    private val identityCreationStateDaoAsync = AppDatabase.getAppDatabase().identityCreationStateDaoAsync()\n+    private val blockchainIdentityDataDaoAsync = AppDatabase.getAppDatabase().blockchainIdentityDataDaoAsync()\n+\n+    private val createIdentityNotification by lazy { CreateIdentityNotification(this) }\n+\n+    private val serviceJob = Job()\n+    private val serviceScope = CoroutineScope(serviceJob + Dispatchers.Main)\n+\n+    lateinit var identityCreationState: IdentityCreationState\n+    lateinit var blockchainIdentityData: BlockchainIdentityData\n+\n+    override fun onCreate() {\n+        super.onCreate()\n+        try {\n+            securityGuard = SecurityGuard()\n+        } catch (e: Exception) {\n+            log.error(\"Unable to instantiate SecurityGuard\", e)\n+            stopSelf()\n+            return\n+        }\n+        createIdentityNotification.startServiceForeground()\n+    }\n+\n+    override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {\n+        super.onStartCommand(intent, flags, startId)\n+\n+        if (intent != null) {\n+\n+            when (intent.action) {\n+                ACTION_CREATE_IDENTITY -> handleCreateIdentityAction(intent)\n+            }\n+        }\n+\n+        return START_NOT_STICKY\n+    }\n+\n+    private fun handleCreateIdentityAction(intent: Intent) {\n+        val username = intent.getStringExtra(EXTRA_USERNAME)\n+\n+        val exceptionHandler = CoroutineExceptionHandler { _, exception ->\n+            log.error(\"[${identityCreationState.state}(error)]\", exception)\n+            GlobalScope.launch {\n+                updateState(identityCreationState.state, true)\n+//                stopSelf()", "originalCommit": "df09a470bc2902a7daa055eb72faffd22280083b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ5ODM1Nw==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r424498357", "bodyText": "Changed to a TODO.  I don't know if we need to call stopSelf() when an exception is caught.  Does stopSelf() get called implicitly?  @tomasz-ludek\n17fca77", "author": "HashEngineering", "createdAt": "2020-05-13T14:48:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA2MTEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyOTQ4Mg==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r425029482", "bodyText": "Let's not call the stopSelf() for now, it causes the notification informing about the error to be dismissed. I'll elaborate a better solution within https://dashpay.atlassian.net/browse/NMA-309.", "author": "tomasz-ludek", "createdAt": "2020-05-14T10:19:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA2MTEwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA2OTE2Mg==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r424069162", "bodyText": "Any reason we're jumping from version 5 to 7?", "author": "sambarboza", "createdAt": "2020-05-12T22:26:07Z", "path": "wallet/src/de/schildbach/wallet/AppDatabase.java", "diffHunk": "@@ -5,27 +5,38 @@\n import androidx.room.RoomDatabase;\n import androidx.room.TypeConverters;\n \n+import de.schildbach.wallet.data.BlockchainIdentityData;\n+import de.schildbach.wallet.data.BlockchainIdentityDataDao;\n+import de.schildbach.wallet.data.BlockchainIdentityDataDaoAsync;\n import de.schildbach.wallet.data.BlockchainState;\n import de.schildbach.wallet.data.BlockchainStateDao;\n import de.schildbach.wallet.data.IdentityCreationState;\n import de.schildbach.wallet.data.IdentityCreationStateDao;\n+import de.schildbach.wallet.data.IdentityCreationStateDaoAsync;\n import de.schildbach.wallet.data.RoomConverters;\n import de.schildbach.wallet.rates.ExchangeRate;\n import de.schildbach.wallet.rates.ExchangeRatesDao;\n \n /**\n  * @author Samuel Barbosa\n  */\n-@Database(entities = {ExchangeRate.class, BlockchainState.class, IdentityCreationState.class}, version = 5)\n+@Database(entities = {ExchangeRate.class, BlockchainState.class, IdentityCreationState.class, BlockchainIdentityData.class}, version = 7)", "originalCommit": "df09a470bc2902a7daa055eb72faffd22280083b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ4NDQ5NQ==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r424484495", "bodyText": "Version 6 was in a previous commit in this PR.  Since we are not releasing any of these apk's into production, is there need to keep incrementing the version number when we make changes.  The master branch is still on Version 2.  Couldn't we keep this version at 3?  or would we do that later? or does it not matter?", "author": "HashEngineering", "createdAt": "2020-05-13T14:31:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA2OTE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUwMDMwOQ==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r424500309", "bodyText": "Lowered to 6:  66c8716", "author": "HashEngineering", "createdAt": "2020-05-13T14:51:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA2OTE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUwMTQ1OQ==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r424501459", "bodyText": "Do we need to commit the 6.json file also?  It is not included in this PR.", "author": "HashEngineering", "createdAt": "2020-05-13T14:52:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA2OTE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAzMDk1NA==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r425030954", "bodyText": "No, it shouldn't be added to VCS it is generated automatically by Room.", "author": "tomasz-ludek", "createdAt": "2020-05-14T10:22:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA2OTE2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3ODk1MQ==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r424078951", "bodyText": "If we reorder BlockchainIdentityData constructor parameters and add some default values, we can call this as:\nBlockchainIdentityData(0, username).\nThe refactored constructor would look like this:\nclass BlockchainIdentityData(var index: Int?,\n                             var username: String?,\n                             var creditFundingTxId: Sha256Hash? = null,\n                             var lockedOutpoint: TransactionOutPoint? = null,\n                             var preorderSalt: ByteArray? = null,\n                             var registrationStatus: BlockchainIdentity.RegistrationStatus? = null,\n                             var usernameStatus: BlockchainIdentity.UsernameStatus? = null,\n                             var domain: String? = null) {", "author": "sambarboza", "createdAt": "2020-05-12T22:53:17Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/CreateIdentityService.kt", "diffHunk": "@@ -0,0 +1,329 @@\n+package de.schildbach.wallet.ui.dashpay\n+\n+import android.content.Context\n+import android.content.Intent\n+import android.os.Handler\n+import androidx.lifecycle.LifecycleService\n+import de.schildbach.wallet.AppDatabase\n+import de.schildbach.wallet.Constants\n+import de.schildbach.wallet.WalletApplication\n+import de.schildbach.wallet.data.BlockchainIdentityData\n+import de.schildbach.wallet.data.IdentityCreationState\n+import de.schildbach.wallet.ui.security.SecurityGuard\n+import de.schildbach.wallet.ui.send.DecryptSeedTask\n+import de.schildbach.wallet.ui.send.DeriveKeyTask\n+import kotlinx.coroutines.*\n+import org.bitcoinj.core.RejectMessage\n+import org.bitcoinj.core.RejectedTransactionException\n+import org.bitcoinj.core.TransactionConfidence\n+import org.bitcoinj.crypto.KeyCrypterException\n+import org.bitcoinj.evolution.CreditFundingTransaction\n+import org.bitcoinj.wallet.DeterministicSeed\n+import org.bitcoinj.wallet.Wallet\n+import org.bouncycastle.crypto.params.KeyParameter\n+import org.dashevo.dashpay.BlockchainIdentity\n+import org.dashevo.dpp.identity.Identity\n+import org.dashevo.platform.Names\n+import org.slf4j.LoggerFactory\n+import java.io.IOException\n+import kotlin.coroutines.resume\n+import kotlin.coroutines.resumeWithException\n+import kotlin.coroutines.suspendCoroutine\n+\n+\n+class CreateIdentityService : LifecycleService() {\n+\n+    companion object {\n+        private val log = LoggerFactory.getLogger(CreateIdentityService::class.java)\n+\n+        private const val ACTION_CREATE_IDENTITY = \"org.dash.dashpay.action.CREATE_IDENTITY\"\n+\n+        private const val EXTRA_USERNAME = \"org.dash.dashpay.extra.USERNAME\"\n+\n+        @JvmStatic\n+        fun createIntent(context: Context, username: String): Intent {\n+            return Intent(context, CreateIdentityService::class.java).apply {\n+                action = ACTION_CREATE_IDENTITY\n+                putExtra(EXTRA_USERNAME, username)\n+            }\n+        }\n+    }\n+\n+    private val walletApplication by lazy { application as WalletApplication }\n+    private val platformRepo by lazy { PlatformRepo(walletApplication) }\n+    private lateinit var securityGuard: SecurityGuard\n+\n+    private val identityCreationStateDaoAsync = AppDatabase.getAppDatabase().identityCreationStateDaoAsync()\n+    private val blockchainIdentityDataDaoAsync = AppDatabase.getAppDatabase().blockchainIdentityDataDaoAsync()\n+\n+    private val createIdentityNotification by lazy { CreateIdentityNotification(this) }\n+\n+    private val serviceJob = Job()\n+    private val serviceScope = CoroutineScope(serviceJob + Dispatchers.Main)\n+\n+    lateinit var identityCreationState: IdentityCreationState\n+    lateinit var blockchainIdentityData: BlockchainIdentityData\n+\n+    override fun onCreate() {\n+        super.onCreate()\n+        try {\n+            securityGuard = SecurityGuard()\n+        } catch (e: Exception) {\n+            log.error(\"Unable to instantiate SecurityGuard\", e)\n+            stopSelf()\n+            return\n+        }\n+        createIdentityNotification.startServiceForeground()\n+    }\n+\n+    override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {\n+        super.onStartCommand(intent, flags, startId)\n+\n+        if (intent != null) {\n+\n+            when (intent.action) {\n+                ACTION_CREATE_IDENTITY -> handleCreateIdentityAction(intent)\n+            }\n+        }\n+\n+        return START_NOT_STICKY\n+    }\n+\n+    private fun handleCreateIdentityAction(intent: Intent) {\n+        val username = intent.getStringExtra(EXTRA_USERNAME)\n+\n+        val exceptionHandler = CoroutineExceptionHandler { _, exception ->\n+            log.error(\"[${identityCreationState.state}(error)]\", exception)\n+            GlobalScope.launch {\n+                updateState(identityCreationState.state, true)\n+//                stopSelf()\n+            }\n+        }\n+\n+        serviceScope.launch(exceptionHandler) {\n+            createIdentity(username)\n+            stopSelf()\n+        }\n+    }\n+\n+    private suspend fun createIdentity(username: String) {\n+        log.info(\"Username registration starting\")\n+\n+        identityCreationState = identityCreationStateDaoAsync.load()\n+                ?: IdentityCreationState(IdentityCreationState.State.UPGRADING_WALLET, false, username)\n+        blockchainIdentityData = blockchainIdentityDataDaoAsync.load()\n+                ?: BlockchainIdentityData(0, null ,null, null, null, null, null, username)", "originalCommit": "df09a470bc2902a7daa055eb72faffd22280083b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ5ODc1OQ==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r424498759", "bodyText": "This was done here:  b0dba0d", "author": "HashEngineering", "createdAt": "2020-05-13T14:49:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3ODk1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3OTg5Mg==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r424079892", "bodyText": "Can we rename to toUsernameStatus to match the casing of the type?", "author": "sambarboza", "createdAt": "2020-05-12T22:56:08Z", "path": "wallet/src/de/schildbach/wallet/data/RoomConverters.kt", "diffHunk": "@@ -67,4 +72,43 @@ class RoomConverters {\n         return identityCreationState.ordinal\n     }\n \n+    @TypeConverter\n+    fun fromHash(hash: Sha256Hash?): ByteArray? {\n+        return hash?.reversedBytes\n+    }\n+\n+    @TypeConverter\n+    fun byteArrayToHash(bytes: ByteArray?): Sha256Hash? {\n+        return bytes?.let { Sha256Hash.wrapReversed(it) }\n+    }\n+\n+    @TypeConverter\n+    fun fromTransactionOutPoint(outpoint: TransactionOutPoint?): ByteArray? {\n+        return outpoint?.bitcoinSerialize()\n+    }\n+\n+    @TypeConverter\n+    fun toTransactionOutPoint(bytes: ByteArray?): TransactionOutPoint? {\n+        return bytes?.let { TransactionOutPoint(Constants.NETWORK_PARAMETERS, it, 0) }\n+    }\n+\n+    @TypeConverter\n+    fun toUserNameStatus(value: Int): BlockchainIdentity.UsernameStatus {", "originalCommit": "df09a470bc2902a7daa055eb72faffd22280083b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ5NzI2Nw==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r424497267", "bodyText": "Fixed here:  84472a5", "author": "HashEngineering", "createdAt": "2020-05-13T14:47:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3OTg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4MDE3NA==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r424080174", "bodyText": "Please remove or add a //TODO.", "author": "sambarboza", "createdAt": "2020-05-12T22:56:59Z", "path": "wallet/src/de/schildbach/wallet/ui/CreateUsernameActivity.kt", "diffHunk": "@@ -51,13 +54,17 @@ class CreateUsernameActivity : InteractionAwareActivity(), TextWatcher {\n     private val fadeOutAnimation by lazy { AnimationUtils.loadAnimation(this, R.anim.fade_out) }\n     private lateinit var completeUsername: String\n     private lateinit var dashPayViewModel: DashPayViewModel\n+    //    private lateinit var securityGuard: SecurityGuard", "originalCommit": "df09a470bc2902a7daa055eb72faffd22280083b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ5NzA1NQ==", "url": "https://github.com/dashevo/dash-wallet/pull/393#discussion_r424497055", "bodyText": "This line is no longer necessary.\nRemoved:\n458f7f6", "author": "HashEngineering", "createdAt": "2020-05-13T14:47:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4MDE3NA=="}], "type": "inlineReview"}, {"oid": "b0dba0d0d862e46d99111b8e00dafd1139e0863a", "url": "https://github.com/dashevo/dash-wallet/commit/b0dba0d0d862e46d99111b8e00dafd1139e0863a", "message": "BlockchainIdentityData: Refactor constructor to use default values", "committedDate": "2020-05-13T14:40:48Z", "type": "commit"}, {"oid": "17fca77c65ade7eb934521d2f0e9c35d93d04b22", "url": "https://github.com/dashevo/dash-wallet/commit/17fca77c65ade7eb934521d2f0e9c35d93d04b22", "message": "CreateIdentityService: Add TODO comment in the exception handler", "committedDate": "2020-05-13T14:43:52Z", "type": "commit"}, {"oid": "84472a5b082d1c4fec611f656fcad0b7de8a0d61", "url": "https://github.com/dashevo/dash-wallet/commit/84472a5b082d1c4fec611f656fcad0b7de8a0d61", "message": "Rename type converter (toUsernameStatus)", "committedDate": "2020-05-13T14:44:59Z", "type": "commit"}, {"oid": "458f7f65d2d74056f8784831ba4c90b2df8ae82b", "url": "https://github.com/dashevo/dash-wallet/commit/458f7f65d2d74056f8784831ba4c90b2df8ae82b", "message": "CreateUsernameActivity: Remove comment for obsolete item", "committedDate": "2020-05-13T14:46:07Z", "type": "commit"}, {"oid": "66c8716a0809b9c5bcd6d5c1315afa490d260416", "url": "https://github.com/dashevo/dash-wallet/commit/66c8716a0809b9c5bcd6d5c1315afa490d260416", "message": "AppDatabase: Lower version to 6, since previous version was 5.", "committedDate": "2020-05-13T14:50:40Z", "type": "commit"}]}