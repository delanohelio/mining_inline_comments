{"pr_number": 482, "pr_title": "Chain Sync Improvements (Phase 3)", "pr_createdAt": "2020-08-18T22:08:51Z", "pr_url": "https://github.com/dashevo/dash-wallet/pull/482", "timeline": [{"oid": "5ae889290abe16613e642b7b183762f40242a1f3", "url": "https://github.com/dashevo/dash-wallet/commit/5ae889290abe16613e642b7b183762f40242a1f3", "message": "PlatformRepo:  Fix issue that causes searchContacts to fail on null profiles", "committedDate": "2020-09-03T18:04:52Z", "type": "commit"}, {"oid": "6991270db6a99df070dd3bb4f60c12e81d555fbc", "url": "https://github.com/dashevo/dash-wallet/commit/6991270db6a99df070dd3bb4f60c12e81d555fbc", "message": "proguard: keep classes extended from Fragment", "committedDate": "2020-09-07T17:38:34Z", "type": "commit"}, {"oid": "d7ed9fd4ad99b798e3847b353786cb5919bb3a6d", "url": "https://github.com/dashevo/dash-wallet/commit/d7ed9fd4ad99b798e3847b353786cb5919bb3a6d", "message": "Add contact request keychain when sending a contact request", "committedDate": "2020-09-07T18:44:04Z", "type": "commit"}, {"oid": "03f76e3aa7a81d27df485fb7488fa91a7b30e324", "url": "https://github.com/dashevo/dash-wallet/commit/03f76e3aa7a81d27df485fb7488fa91a7b30e324", "message": "Constants: Add more parameters that depend on network\n\n* Supports Platform\n* Sync Logic (headers first, or not)", "committedDate": "2020-09-07T21:38:18Z", "type": "commit"}, {"oid": "9b94d84a936cbe3eb2d77f6d2d30f2248f378712", "url": "https://github.com/dashevo/dash-wallet/commit/9b94d84a936cbe3eb2d77f6d2d30f2248f378712", "message": "PlatformRepo: Improve Syncing\n\n* Support DashJ's header first sync system\n* Add a keychain to the wallet after contact request is confirmed, then update bloom filters\n* Don't update bloom filters", "committedDate": "2020-09-07T21:38:19Z", "type": "commit"}, {"oid": "09a2b22df40d194292611e27ca67c261b198029f", "url": "https://github.com/dashevo/dash-wallet/commit/09a2b22df40d194292611e27ca67c261b198029f", "message": "Use new Constants for initializing Dash.", "committedDate": "2020-09-07T21:38:19Z", "type": "commit"}, {"oid": "cae73e8dc8afaa75d34b106ae58be8816f3cf01c", "url": "https://github.com/dashevo/dash-wallet/commit/cae73e8dc8afaa75d34b106ae58be8816f3cf01c", "message": "BlockchainServiceImpl: Support headers first synchronization", "committedDate": "2020-09-07T21:38:20Z", "type": "commit"}, {"oid": "600edf7234f6419f4b9b62c3a79afc2b57771354", "url": "https://github.com/dashevo/dash-wallet/commit/600edf7234f6419f4b9b62c3a79afc2b57771354", "message": "BlockchainServiceImpl: Add header support (syncing, persistence)", "committedDate": "2020-09-07T21:38:20Z", "type": "commit"}, {"oid": "9ac30630b374343c06839d0e24b3e58532ffefd4", "url": "https://github.com/dashevo/dash-wallet/commit/9ac30630b374343c06839d0e24b3e58532ffefd4", "message": "PlatformRepo: Move everything in updateContactRequest inside a try block", "committedDate": "2020-09-07T21:38:20Z", "type": "commit"}, {"oid": "2875e5538c3136a3274826e361a195819f92797c", "url": "https://github.com/dashevo/dash-wallet/commit/2875e5538c3136a3274826e361a195819f92797c", "message": "Sync headers on mainnet and testnet", "committedDate": "2020-09-07T21:38:20Z", "type": "commit"}, {"oid": "4a1ec316360e9052bac2a94dfadfc86167242261", "url": "https://github.com/dashevo/dash-wallet/commit/4a1ec316360e9052bac2a94dfadfc86167242261", "message": "Close headers file on shutdown", "committedDate": "2020-09-07T21:38:20Z", "type": "commit"}, {"oid": "cfaf5620b203773f51a7a120729c18a3cc6a9675", "url": "https://github.com/dashevo/dash-wallet/commit/cfaf5620b203773f51a7a120729c18a3cc6a9675", "message": "Remove unused listener", "committedDate": "2020-09-07T21:38:20Z", "type": "commit"}, {"oid": "cfaf5620b203773f51a7a120729c18a3cc6a9675", "url": "https://github.com/dashevo/dash-wallet/commit/cfaf5620b203773f51a7a120729c18a3cc6a9675", "message": "Remove unused listener", "committedDate": "2020-09-07T21:38:20Z", "type": "forcePushed"}, {"oid": "9c93ed9b5f21c5c04de40a61a002ba5148bf7fd1", "url": "https://github.com/dashevo/dash-wallet/commit/9c93ed9b5f21c5c04de40a61a002ba5148bf7fd1", "message": "Merge branch 'fix-missing-profiles' of https://github.com/dashevo/dash-wallet into chain-sync-improvements-3\n\n# Conflicts:\n#\twallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "committedDate": "2020-09-07T21:59:27Z", "type": "commit"}, {"oid": "4f7d2275c0226696147d58d40e77e04f4622481f", "url": "https://github.com/dashevo/dash-wallet/commit/4f7d2275c0226696147d58d40e77e04f4622481f", "message": "BlockchainServiceImpl: Ensure that blockchain state is updated upon completion", "committedDate": "2020-09-09T16:40:25Z", "type": "commit"}, {"oid": "89ae0fe2964c58079ffa8dcb85d1da6b81d6ce82", "url": "https://github.com/dashevo/dash-wallet/commit/89ae0fe2964c58079ffa8dcb85d1da6b81d6ce82", "message": "Merge branch 'evonet-develop' of https://github.com/dashevo/dash-wallet into chain-sync-improvements-3", "committedDate": "2020-09-09T16:40:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk4NzcxOQ==", "url": "https://github.com/dashevo/dash-wallet/pull/482#discussion_r486987719", "bodyText": "This whole method is duplicated below.", "author": "tomasz-ludek", "createdAt": "2020-09-11T11:38:26Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -798,7 +801,66 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n             log.error(formatExceptionMessage(\"error updating contacts\", e))\n         } finally {\n             updatingContacts.set(false)\n+            if (preDownloadBlocks.get()) {\n+                log.info(\"PreDownloadBlocks: complete\")\n+                preDownloadBlocksFuture?.set(true)\n+                preDownloadBlocks.set(false)\n+            }\n+        }\n+    }\n+\n+    // This will check for missing profiles, download them and update the database\n+    private suspend fun checkDatabaseIntegrity() {\n+        val watch = Stopwatch.createStarted()\n+        log.info(\"check database integrity: starting\");\n+\n+        val userIdList = HashSet<String>()\n+        val missingProfiles = HashSet<String>()\n+        val userId = blockchainIdentity.uniqueIdString\n+\n+        var toContactDocuments = dashPayContactRequestDaoAsync.loadToOthers(userId)\n+        val toContactMap = HashMap<String, DashPayContactRequest>()\n+        toContactDocuments!!.forEach {\n+            userIdList.add(it.toUserId)\n+            toContactMap[it.toUserId] = it\n+        }\n+        // Get all contact requests where toUserId == userId, the users who have added me\n+        val fromContactDocuments = dashPayContactRequestDaoAsync.loadFromOthers(userId)\n+        val fromContactMap = HashMap<String, DashPayContactRequest>()\n+        fromContactDocuments!!.forEach {\n+            userIdList.add(it.userId)\n+            fromContactMap[it.userId] = it\n+        }\n+\n+        for (user in userIdList) {\n+            val profile = dashPayProfileDaoAsync.load(user)\n+            if (profile == null) {\n+                missingProfiles.add(user)\n+            }\n+        }\n+\n+        if (missingProfiles.isNotEmpty()) {\n+            val profileDocuments = Profiles(platform).getList(missingProfiles.toList()) //only handles 100 userIds\n+            val profileById = profileDocuments.associateBy({ it.ownerId }, { it })\n+\n+            val nameDocuments = platform.names.getList(missingProfiles.toList())\n+            val nameById = nameDocuments.associateBy({ getIdentityForName(it) }, { it })\n+\n+            for (id in missingProfiles) {\n+                val nameDocument = nameById[id] // what happens if there is no username for the identity? crash\n+                val username = nameDocument!!.data[\"normalizedLabel\"] as String\n+                val identityId = getIdentityForName(nameDocument)\n+\n+                val profileDocument = profileById[id] ?: profiles.createProfileDocument(\"\", \"\",\n+                        \"\", platform.identities.get(identityId)!!)\n+\n+                val profile = DashPayProfile.fromDocument(profileDocument, username)\n+                dashPayProfileDaoAsync.insert(profile!!)\n+                log.info(\"check database integrity: adding missing profile $username:$id\")\n+            }\n         }\n+\n+        log.info(\"check database integrity complete in $watch\")\n     }", "originalCommit": "89ae0fe2964c58079ffa8dcb85d1da6b81d6ce82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "38706a1dd284351f43d19cc11cde1e2540cc992b", "url": "https://github.com/dashevo/dash-wallet/commit/38706a1dd284351f43d19cc11cde1e2540cc992b", "message": "PlatformRepo: Remove duplicate method from merging", "committedDate": "2020-09-11T18:19:45Z", "type": "commit"}]}