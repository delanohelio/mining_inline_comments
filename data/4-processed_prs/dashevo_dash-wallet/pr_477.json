{"pr_number": 477, "pr_title": "NMA-378 User Profile | Transaction History", "pr_createdAt": "2020-08-10T20:33:32Z", "pr_url": "https://github.com/dashevo/dash-wallet/pull/477", "timeline": [{"oid": "ca44ad8d8c323a02057938cef079c3d6069ed6d8", "url": "https://github.com/dashevo/dash-wallet/commit/ca44ad8d8c323a02057938cef079c3d6069ed6d8", "message": "Refactored NotificationsAdapter, moved ViewHolder's to separate classes, optimised code", "committedDate": "2020-08-10T20:10:43Z", "type": "commit"}, {"oid": "bd7dfccaf81d12e4b0aeeca6db222e470d2b88f5", "url": "https://github.com/dashevo/dash-wallet/commit/bd7dfccaf81d12e4b0aeeca6db222e470d2b88f5", "message": "Further refactoring of NotificationAdapter, replaced ContactViewHolder and ContactRequestViewHolder with a single class NotificationViewHolder", "committedDate": "2020-08-12T00:06:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzMjEyNQ==", "url": "https://github.com/dashevo/dash-wallet/pull/477#discussion_r468932125", "bodyText": "Is it the right approach?\nI generate \"invitationItem\" for each established contacts so that it could be displayed in the history.", "author": "tomasz-ludek", "createdAt": "2020-08-12T00:08:58Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/NotificationsForUserLiveData.kt", "diffHunk": "@@ -13,13 +12,17 @@ class NotificationsForUserLiveData(walletApplication: WalletApplication, platfor\n         this.query = userId\n         GlobalScope.launch {\n             val results = arrayListOf<NotificationItem>()\n-            val contactRequests = platformRepo.searchContacts(\"\", UsernameSortOrderBy.DATE_ADDED)\n+            val contactRequests = platformRepo.searchContacts(\"\", UsernameSortOrderBy.DATE_ADDED, true)\n \n-            if(contactRequests.data != null) {\n-                contactRequests.data.filter {\n-                    cr -> cr.dashPayProfile.userId == userId\n+            if (contactRequests.data != null) {\n+                contactRequests.data.filter { cr ->\n+                    cr.dashPayProfile.userId == userId\n                 }.forEach {\n-                    results.add(NotificationItem(it))\n+                    results.add(NotificationItemContact(it))\n+                    if (it.type == UsernameSearchResult.Type.CONTACT_ESTABLISHED) {\n+                        val invitationItem = if (it.incoming) it.copy(toContactRequest = null) else it.copy(fromContactRequest = null)\n+                        results.add(NotificationItemContact(invitationItem, isInvitationOfEstablished = true))\n+                    }", "originalCommit": "bd7dfccaf81d12e4b0aeeca6db222e470d2b88f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk5MzA2Mw==", "url": "https://github.com/dashevo/dash-wallet/pull/477#discussion_r468993063", "bodyText": "very cool.  Splitting into two items seems like a good way to do it.  But I will need to review this more to get a better idea of how it will work.", "author": "HashEngineering", "createdAt": "2020-08-12T04:07:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkzMjEyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk5NTE4OA==", "url": "https://github.com/dashevo/dash-wallet/pull/477#discussion_r468995188", "bodyText": "Here, incoming appears to mean that we received a request first, then we sent our request later.\nOne issue here is that a UserSearchResult is also used for pending contact requests, in which cases toContactRequest will be null.  The NotificationActivity and ContactsFragment.  At this time, I don't think incoming will be used on either screen.\nFor the DashPayUserActivity screen, currently, or at least the way I wrote it, the history is only shown when there is a contact request going both ways (neither toContactRequest or fromContactRequest is null).\nAlso, I think the SearchUserActivity screen also uses UsernameSearchResult to hold a sent request where fromContactRequest is null.  While we don't use incoming in that activity, maybe it is better to make this getter null pointer exception proof.", "author": "HashEngineering", "createdAt": "2020-08-12T04:16:31Z", "path": "wallet/src/de/schildbach/wallet/data/UsernameSearchResult.kt", "diffHunk": "@@ -1,30 +1,45 @@\n package de.schildbach.wallet.data\n \n-import kotlin.math.max\n-\n data class UsernameSearchResult(val username: String,\n                                 val dashPayProfile: DashPayProfile,\n                                 var toContactRequest: DashPayContactRequest?,\n                                 var fromContactRequest: DashPayContactRequest?) {\n     val requestSent: Boolean\n-            get() = toContactRequest != null\n+        get() = toContactRequest != null\n     val requestReceived: Boolean\n-            get () = fromContactRequest != null\n+        get() = fromContactRequest != null\n     val isPendingRequest: Boolean\n-            get() = requestReceived && !requestSent\n+        get() = requestReceived && !requestSent\n+\n     val date: Long // milliseconds\n-            get() {\n-                return when (requestSent to requestReceived) {\n-                    true to true -> {\n-                        fromContactRequest!!.timestamp\n-                    }\n-                    true to false -> {\n-                        toContactRequest!!.timestamp\n-                    }\n-                    false to true -> {\n-                        fromContactRequest!!.timestamp\n-                    }\n-                    else -> 0.00\n-                }.toLong() * 1000\n-            }\n+        get() {\n+            return when (type) {\n+                Type.CONTACT_ESTABLISHED -> {\n+                    fromContactRequest!!.timestamp\n+                }\n+                Type.REQUEST_SENT -> {\n+                    toContactRequest!!.timestamp\n+                }\n+                Type.REQUEST_RECEIVED -> {\n+                    fromContactRequest!!.timestamp\n+                }\n+            }.toLong() * 1000\n+        }\n+\n+    val type: Type\n+        get() = when (requestSent to requestReceived) {\n+            true to true -> Type.CONTACT_ESTABLISHED\n+            false to true -> Type.REQUEST_RECEIVED\n+            true to false -> Type.REQUEST_SENT\n+            else -> throw IllegalStateException(\"toContactRequest and fromContactRequest can't both be null at the same time\")\n+        }\n+\n+    val incoming: Boolean\n+        get() = toContactRequest!!.timestamp > fromContactRequest!!.timestamp", "originalCommit": "bd7dfccaf81d12e4b0aeeca6db222e470d2b88f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE5ODY4Mg==", "url": "https://github.com/dashevo/dash-wallet/pull/477#discussion_r470198682", "bodyText": "I replaced it with a local variable inside NotificationsForUserLiveData.searchNotifications", "author": "tomasz-ludek", "createdAt": "2020-08-13T19:32:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk5NTE4OA=="}], "type": "inlineReview"}, {"oid": "ba0d599d340bc9a57b0cba9bfc392992880269ca", "url": "https://github.com/dashevo/dash-wallet/commit/ba0d599d340bc9a57b0cba9bfc392992880269ca", "message": "Final improvements of NotificationsAdapter and related data model", "committedDate": "2020-08-13T18:59:09Z", "type": "commit"}, {"oid": "c5a620c5c2e20b8cb0e0e221036701dac5614b2a", "url": "https://github.com/dashevo/dash-wallet/commit/c5a620c5c2e20b8cb0e0e221036701dac5614b2a", "message": "Changed the way of displaying TransactionDetailsDialogFragment", "committedDate": "2020-08-13T19:18:17Z", "type": "commit"}, {"oid": "5c9125288946d9b76ed2014017aac470731af40d", "url": "https://github.com/dashevo/dash-wallet/commit/5c9125288946d9b76ed2014017aac470731af40d", "message": "Code refactoring", "committedDate": "2020-08-13T19:32:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1NDI1OA==", "url": "https://github.com/dashevo/dash-wallet/pull/477#discussion_r470254258", "bodyText": "are these changes for debugging?", "author": "HashEngineering", "createdAt": "2020-08-13T21:18:05Z", "path": "wallet/src/de/schildbach/wallet/ui/WalletFragment.kt", "diffHunk": "@@ -86,9 +91,23 @@ class WalletFragment : Fragment() {\n         if (walletFragmentView == null) {\n             walletFragmentView = inflater.inflate(R.layout.home_content, container, false)\n         }\n+\n+        process()\n+\n         return walletFragmentView\n     }\n \n+    private fun process() {\n+        GlobalScope.launch {\n+            val contactRequests = PlatformRepo1.getInstance().searchContacts(\"\", UsernameSortOrderBy.DATE_ADDED, true)\n+            if(contactRequests.data != null) {\n+                contactRequests.data.forEach {\n+                    println(\"contactRequests:\\t$it\")\n+                }\n+            }\n+        }\n+    }\n+", "originalCommit": "5c9125288946d9b76ed2014017aac470731af40d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ5OTg1NQ==", "url": "https://github.com/dashevo/dash-wallet/pull/477#discussion_r470499855", "bodyText": "Yeap, I removed them. Good find! :)", "author": "tomasz-ludek", "createdAt": "2020-08-14T08:56:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1NDI1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUxMzg4OA==", "url": "https://github.com/dashevo/dash-wallet/pull/477#discussion_r470513888", "bodyText": "Removed", "author": "tomasz-ludek", "createdAt": "2020-08-14T09:25:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1NDI1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1NTY5NA==", "url": "https://github.com/dashevo/dash-wallet/pull/477#discussion_r470255694", "bodyText": "This is the only place that has a conflict with my PR #475, which is pretty impressive.  there are some imports, so the merge process will very easy.", "author": "HashEngineering", "createdAt": "2020-08-13T21:21:00Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/NotificationsAdapter.kt", "diffHunk": "@@ -115,321 +82,64 @@ class NotificationsAdapter(val context: Context, val wallet: Wallet, val onConta\n     }\n \n     override fun getItemId(position: Int): Long {\n-        return when (results[position].viewType) {\n-            NOTIFICATION_NEW_HEADER -> 1L\n-            NOTIFICATION_NEW_EMPTY -> 2L\n-            NOTIFICATION_CONTACT_REQUEST_RECEIVED -> getLongValue(results[position].notificationItem!!.id)\n-            NOTIFICATION_EARLIER_HEADER -> 3L\n-            NOTIFICATION_CONTACT_ADDED -> getLongValue(results[position].notificationItem!!.id)\n-            NOTIFICATION_PAYMENT -> getLongValue(results[position].notificationItem!!.id)\n-            else -> throw IllegalArgumentException(\"Invalid viewType ${results[position].viewType}\")\n-        }\n-    }\n-\n-    override fun onBindViewHolder(holder: ViewHolder, position: Int) {\n-        when (results[position].viewType) {\n-            NOTIFICATION_CONTACT_REQUEST_RECEIVED,\n-            NOTIFICATION_CONTACT_ADDED -> holder.bind(results[position].notificationItem!!.usernameSearchResult!!, results[position].isNew)\n-            NOTIFICATION_NEW_HEADER -> (holder as HeaderViewHolder).bind(R.string.notifications_new)\n-            NOTIFICATION_EARLIER_HEADER -> (holder as HeaderViewHolder).bind(R.string.notifications_earlier)\n-            NOTIFICATION_NEW_EMPTY -> (holder as ImageViewHolder).bind(R.drawable.ic_notification_new_empty, R.string.notifications_none_new)\n-            NOTIFICATION_PAYMENT -> (holder as TransactionViewHolder).bind(results[position].notificationItem!!.tx!!)\n-            else -> throw IllegalArgumentException(\"Invalid viewType ${results[position].viewType}\")\n+        return when (getItemViewType(position)) {\n+            NOTIFICATION_HEADER -> 1L\n+            NOTIFICATION_EMPTY -> 2L\n+            else -> getLongValue(getItem(position).notificationItem.getId())", "originalCommit": "5c9125288946d9b76ed2014017aac470731af40d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUxMzUwMg==", "url": "https://github.com/dashevo/dash-wallet/pull/477#discussion_r470513502", "bodyText": "New polymorphic data model allowed me to simplify this method even more :)\nAlso, I used UUID.randomUUID() for NOTIFICATION_HEADER ID instead of hardcoded number because in NotificationActivity we have two items of this type (New/Earlier) whereas ID should be unique as we as we use the setHasStableIds(true). Previously, when there was a separate type NOTIFICATION_EARLIER_HEADER the uniqueness was assured by hardcoded values. One of advantage of the new approach is that we can have as much header items as we want without the need of creating new item type for each.", "author": "tomasz-ludek", "createdAt": "2020-08-14T09:24:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1NTY5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1NjM4OA==", "url": "https://github.com/dashevo/dash-wallet/pull/477#discussion_r470256388", "bodyText": "very good!", "author": "HashEngineering", "createdAt": "2020-08-13T21:22:24Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -299,9 +299,7 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n                 val usernameSearchResult = UsernameSearchResult(profile.value!!.username,\n                         profile.value!!, toContact, fromContact)\n \n-                // only include contacts that have sent requests to us (we may have accepted them)\n-                // do not include contactRequest that we have sent but have not been accepted\n-                if (usernameSearchResult.requestReceived)\n+                if (usernameSearchResult.requestReceived || (includeSentPending && usernameSearchResult.requestSent))\n                     usernameSearchResults.add(usernameSearchResult)", "originalCommit": "5c9125288946d9b76ed2014017aac470731af40d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI2NTI5Ng==", "url": "https://github.com/dashevo/dash-wallet/pull/477#discussion_r470265296", "bodyText": "Very good! this gets the formatting to match the designs. I had no idea how make the display name bold.", "author": "HashEngineering", "createdAt": "2020-08-13T21:41:42Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/notification/ContactViewHolder.kt", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright 2020 Dash Core Group.\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package de.schildbach.wallet.ui.dashpay.notification\n+\n+import android.text.Html\n+import android.view.LayoutInflater\n+import android.view.View\n+import android.view.ViewGroup\n+import com.bumptech.glide.Glide\n+import de.schildbach.wallet.data.NotificationItem\n+import de.schildbach.wallet.data.NotificationItemContact\n+import de.schildbach.wallet.data.UsernameSearchResult\n+import de.schildbach.wallet.ui.UserAvatarPlaceholderDrawable\n+import de.schildbach.wallet_test.R\n+import kotlinx.android.synthetic.main.notification_contact_request_received_row.view.*\n+import java.text.SimpleDateFormat\n+import java.util.*\n+\n+open class ContactViewHolder(inflater: LayoutInflater, parent: ViewGroup) :\n+        NotificationViewHolder(R.layout.notification_contact_request_received_row, inflater, parent) {\n+\n+    private val dateFormat = SimpleDateFormat(\"MMM dd, yyyy KK:mm a\", Locale.getDefault())\n+\n+    private fun formatDate(timeStamp: Long): String {\n+        return dateFormat.format(timeStamp).replace(\"AM\", \"am\").replace(\"PM\",\"pm\")\n+    }\n+\n+    override fun bind(notificationItem: NotificationItem, vararg args: Any) {\n+        (notificationItem as NotificationItemContact).run {\n+            bind(usernameSearchResult, (args[0] as Boolean), isInvitationOfEstablished, (args[1] as Boolean), (args[2] as OnContactActionClickListener))\n+        }\n+    }\n+\n+    private fun bind(usernameSearchResult: UsernameSearchResult, isNew: Boolean, isInvitationOfEstablished: Boolean,\n+                     showAvatar: Boolean, onActionClickListener: OnContactActionClickListener? = null) {\n+\n+        val defaultAvatar = UserAvatarPlaceholderDrawable.getDrawable(itemView.context,\n+                usernameSearchResult.username[0])\n+\n+        itemView.apply {\n+            setBackgroundResource(if (isNew) R.drawable.selectable_round_corners else R.drawable.selectable_round_corners_dark)\n+            date.text = formatDate(usernameSearchResult.date)\n+\n+            val dashPayProfile = usernameSearchResult.dashPayProfile\n+            val name = if (dashPayProfile.displayName.isEmpty()) {\n+                dashPayProfile.username\n+            } else {\n+                dashPayProfile.displayName\n+            }\n+\n+            val displayNameResId = when (usernameSearchResult.type) {\n+                UsernameSearchResult.Type.CONTACT_ESTABLISHED -> {\n+                    contact_added.setImageResource(R.drawable.ic_contact_added)\n+                    val sentDate = usernameSearchResult.toContactRequest!!.timestamp\n+                    val receivedDate = usernameSearchResult.fromContactRequest!!.timestamp\n+                    if (sentDate > receivedDate) {\n+                        R.string.notifications_you_have_accepted\n+                    } else {\n+                        R.string.notifications_contact_has_accepted\n+                    }\n+                }\n+                UsernameSearchResult.Type.REQUEST_RECEIVED -> {\n+                    contact_added.setImageResource(R.drawable.ic_add_contact)\n+                    R.string.notifications_you_received\n+                }\n+                UsernameSearchResult.Type.REQUEST_SENT -> {\n+                    contact_added.setImageResource(R.drawable.ic_add_contact)\n+                    R.string.notifications_you_sent\n+                }\n+            }\n+\n+            @Suppress(\"DEPRECATION\")\n+            val displayNameText = context.getString(displayNameResId, \"<b>$name</b>\")\n+            displayName.text = Html.fromHtml(displayNameText)", "originalCommit": "5c9125288946d9b76ed2014017aac470731af40d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyMjMwNg==", "url": "https://github.com/dashevo/dash-wallet/pull/477#discussion_r470522306", "bodyText": "I had few ideas, but this one seems to be the best for different languages.", "author": "tomasz-ludek", "createdAt": "2020-08-14T09:42:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI2NTI5Ng=="}], "type": "inlineReview"}, {"oid": "72a16ef467b088bcfcbf528f4239da402fb835e9", "url": "https://github.com/dashevo/dash-wallet/commit/72a16ef467b088bcfcbf528f4239da402fb835e9", "message": "Added a missing comment from https://github.com/dashevo/dash-wallet/pull/473", "committedDate": "2020-08-14T08:26:34Z", "type": "commit"}, {"oid": "8c550ffae0add9944b9539e3add515877bf75a37", "url": "https://github.com/dashevo/dash-wallet/commit/8c550ffae0add9944b9539e3add515877bf75a37", "message": "Removed debugging code", "committedDate": "2020-08-14T08:33:36Z", "type": "commit"}, {"oid": "cc9bb62c1d139b4b6f282881641341469f055e01", "url": "https://github.com/dashevo/dash-wallet/commit/cc9bb62c1d139b4b6f282881641341469f055e01", "message": "Code refactoring", "committedDate": "2020-08-14T08:37:49Z", "type": "commit"}, {"oid": "3a2a8a828e8b6ab38e8c99302a6611a9facfef8c", "url": "https://github.com/dashevo/dash-wallet/commit/3a2a8a828e8b6ab38e8c99302a6611a9facfef8c", "message": "Merge branch 'evonet-develop' into user-profile-transaction-history-bis\n\n# Conflicts:\n#\twallet/res/layout/receive_info_view.xml", "committedDate": "2020-08-14T08:39:25Z", "type": "commit"}, {"oid": "fc3dc0b2bbb2b92c3707934dde81a70d604fdd17", "url": "https://github.com/dashevo/dash-wallet/commit/fc3dc0b2bbb2b92c3707934dde81a70d604fdd17", "message": "Improved id generation for HeaderViewItem and ImageViewItem", "committedDate": "2020-08-14T09:00:00Z", "type": "commit"}]}