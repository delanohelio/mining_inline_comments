{"pr_number": 460, "pr_title": "DashPay: Notifications fix -  NMA-551", "pr_createdAt": "2020-07-13T22:45:23Z", "pr_url": "https://github.com/dashevo/dash-wallet/pull/460", "timeline": [{"oid": "d124f0e39c818c65e0cf53f243faa0da5041d609", "url": "https://github.com/dashevo/dash-wallet/commit/d124f0e39c818c65e0cf53f243faa0da5041d609", "message": "BlockchainService: Set the DapiClient's masternode list", "committedDate": "2020-07-10T19:23:43Z", "type": "commit"}, {"oid": "7e24158770cc48441532eb3917d2905141d3e2ee", "url": "https://github.com/dashevo/dash-wallet/commit/7e24158770cc48441532eb3917d2905141d3e2ee", "message": "Fix BlockchainIdentity construction (use same platform object as the app)", "committedDate": "2020-07-10T19:23:44Z", "type": "commit"}, {"oid": "e73b2b36b333a6f1cdad0d4f0a30582a3ec4c040", "url": "https://github.com/dashevo/dash-wallet/commit/e73b2b36b333a6f1cdad0d4f0a30582a3ec4c040", "message": "PlatformRepo: If there are on contactRequests, skip searching profiles and names", "committedDate": "2020-07-10T19:23:44Z", "type": "commit"}, {"oid": "23bef1b651814f0ec36542a8a94c4752c44f15f1", "url": "https://github.com/dashevo/dash-wallet/commit/23bef1b651814f0ec36542a8a94c4752c44f15f1", "message": "PlatformRepo: change isPlatformAvailable", "committedDate": "2020-07-10T19:23:45Z", "type": "commit"}, {"oid": "1e3530ca70c1733e3d78bd8304fad0ddd884b035", "url": "https://github.com/dashevo/dash-wallet/commit/1e3530ca70c1733e3d78bd8304fad0ddd884b035", "message": "Refactor some liveData from DashPayViewModel to new classes\n\n* New classes NotificationsLiveData, NotificationCountLiveData\n* Listeners react to updating the contact database and then update data\n* The notifications screen is live", "committedDate": "2020-07-13T22:33:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk5MDk0MQ==", "url": "https://github.com/dashevo/dash-wallet/pull/460#discussion_r453990941", "bodyText": "i am not sure if the GlobalScope.launch is the best way to run a suspend method.", "author": "HashEngineering", "createdAt": "2020-07-13T22:49:13Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/NotificationsLiveData.kt", "diffHunk": "@@ -0,0 +1,55 @@\n+package de.schildbach.wallet.ui.dashpay\n+\n+import androidx.lifecycle.LiveData\n+import de.schildbach.wallet.WalletApplication\n+import de.schildbach.wallet.data.UsernameSearchResult\n+import de.schildbach.wallet.data.UsernameSortOrderBy\n+import de.schildbach.wallet.livedata.Resource\n+import kotlinx.coroutines.GlobalScope\n+import kotlinx.coroutines.launch\n+\n+class NotificationsLiveData(val walletApplication: WalletApplication, private val platformRepo: PlatformRepo) : LiveData<Resource<List<UsernameSearchResult>>>(), OnContactsUpdated {\n+    private var listening = false\n+    private var query = \"\"\n+\n+    override fun onActive() {\n+        maybeAddEventListener()\n+        searchNotifications(query)\n+    }\n+\n+    override fun onInactive() {\n+        maybeRemoveEventListener()\n+    }\n+\n+    private fun maybeAddEventListener() {\n+        if (!listening && hasActiveObservers()) {\n+            PlatformRepo.addContactsUpdatedListener(this)\n+            listening = true\n+        }\n+    }\n+\n+    private fun maybeRemoveEventListener() {\n+        if (listening) {\n+            PlatformRepo.removeContactsUpdatedListener(this)\n+            listening = false\n+        }\n+    }\n+\n+    override fun onContactsUpdated() {\n+        searchNotifications(query)\n+    }\n+\n+    fun searchNotifications(text: String = \"\") {\n+        query = text\n+        GlobalScope.launch {\n+            val contactRequests = platformRepo.searchContacts(query, UsernameSortOrderBy.LAST_ACTIVITY)\n+\n+            //TODO: gather other notification types\n+            // * invitations\n+            // * payments\n+            // * other\n+\n+            postValue(contactRequests)\n+        }", "originalCommit": "1e3530ca70c1733e3d78bd8304fad0ddd884b035", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwOTIzMQ==", "url": "https://github.com/dashevo/dash-wallet/pull/460#discussion_r454509231", "bodyText": "It is okey :)", "author": "tomasz-ludek", "createdAt": "2020-07-14T17:07:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk5MDk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk5MTUyOQ==", "url": "https://github.com/dashevo/dash-wallet/pull/460#discussion_r453991529", "bodyText": "This section of code was made \"static\" because there could be more than one instance of PlatformRepo running in the app.  DashPayViewModel has one instance.  The BlockchainServiceImpl creates a new instance every time the timer triggers an update of the DashPay state (currently only updates the contact requests and profiles)", "author": "HashEngineering", "createdAt": "2020-07-13T22:50:53Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -62,6 +68,24 @@ class PlatformRepo(val walletApplication: WalletApplication) {\n \n     companion object {\n         private val log = LoggerFactory.getLogger(PlatformRepo::class.java)\n+\n+        private val onContactsUpdatedListeners = arrayListOf<OnContactsUpdated>()\n+        private val updatingContacts = AtomicBoolean(false)\n+\n+        fun addContactsUpdatedListener(listener: OnContactsUpdated) {\n+            onContactsUpdatedListeners.add(listener)\n+        }\n+\n+        fun removeContactsUpdatedListener(listener: OnContactsUpdated?) {\n+            onContactsUpdatedListeners.remove(listener)\n+        }\n+\n+        fun queueContactsUpdatedListeners(updateBackgroundHandler: Handler) {\n+            updateBackgroundHandler.post {\n+                for (listener in onContactsUpdatedListeners)\n+                    listener.onContactsUpdated()\n+            }\n+        }", "originalCommit": "1e3530ca70c1733e3d78bd8304fad0ddd884b035", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ5MzYzMQ==", "url": "https://github.com/dashevo/dash-wallet/pull/460#discussion_r454493631", "bodyText": "@HashEngineering I think we should convert PlatformRepo to the Singleton.", "author": "tomasz-ludek", "createdAt": "2020-07-14T16:42:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk5MTUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk5MjE5MA==", "url": "https://github.com/dashevo/dash-wallet/pull/460#discussion_r453992190", "bodyText": "I would like to replace dependence on BlockchainServiceImpl for the timer that triggers DashPay related updates from Platform.  When the blockchain service is shutdown, the timer is also stopped and no further updates occur.  What is the best place to start a timer in the app that can be shut down when the app is closed?  This timer would only be active if the user has a username.", "author": "HashEngineering", "createdAt": "2020-07-13T22:52:53Z", "path": "wallet/src/de/schildbach/wallet/service/BlockchainServiceImpl.java", "diffHunk": "@@ -1072,20 +1072,18 @@ public void run() {\n         });\n     }\n \n-    boolean updatingDashPayState = false;\n     private void updateDashPayState() {\n-        if (blockchainIdentityData != null && !updatingDashPayState) {\n+        if (blockchainIdentityData != null) {", "originalCommit": "1e3530ca70c1733e3d78bd8304fad0ddd884b035", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ5NjAyMg==", "url": "https://github.com/dashevo/dash-wallet/pull/460#discussion_r454496022", "bodyText": "As I mentioned above, I think we should convert the PlatformRepo to a singleton. After that the periodic updates could be triggered by PlatformRepo itself. Also, I recommend the use of Handler instead of Timer, like this:\nHandler handler = new Handler();\n\nprivate Runnable runnableCode = new Runnable() {\n    @Override\n    public void run() {\n      // Do something here on the main thread\n      Log.d(\"Handlers\", \"Called on main thread\");\n      // Repeat this the same runnable code block again another 2 seconds\n      // 'this' is referencing the Runnable object\n      handler.postDelayed(this, timeInterval);\n    }\n};\n\n// Start the initial runnable task by posting through the handler\nhandler.post(runnableCode);\n\n// Removes pending code execution\nhandler.removeCallbacks(runnableCode);\n\nHere is more info about Handlers vs Timers on Android: https://stackoverflow.com/questions/20330355/timertask-or-handler#:~:text=3%20Answers&text=Handler%20is%20better%20than%20TimerTask,%2C%20here%2C%20and%20here).", "author": "tomasz-ludek", "createdAt": "2020-07-14T16:46:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk5MjE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY3NDE0Mg==", "url": "https://github.com/dashevo/dash-wallet/pull/460#discussion_r454674142", "bodyText": "Thanks.  I have implemented this except for the handler.removeCallbacks -- I wasn't sure where to put that so that it will be executed when the app is closed down.", "author": "HashEngineering", "createdAt": "2020-07-14T22:08:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk5MjE5MA=="}], "type": "inlineReview"}, {"oid": "b7b756b5d79bbf438bb0d3c6ba2b1945137eb8f0", "url": "https://github.com/dashevo/dash-wallet/commit/b7b756b5d79bbf438bb0d3c6ba2b1945137eb8f0", "message": "Fix sort order for notifications", "committedDate": "2020-07-14T14:24:15Z", "type": "commit"}, {"oid": "78d7597ec649ecf1537ed2ab2bef315ad18ca721", "url": "https://github.com/dashevo/dash-wallet/commit/78d7597ec649ecf1537ed2ab2bef315ad18ca721", "message": "Use the fromContactRequest date", "committedDate": "2020-07-14T14:25:07Z", "type": "commit"}, {"oid": "7145eb69351b0aa885ca4edeeef36b4b34a5c3cb", "url": "https://github.com/dashevo/dash-wallet/commit/7145eb69351b0aa885ca4edeeef36b4b34a5c3cb", "message": "PlatformRepo: Make Singleton, replace contact update timer\n\n* Remove timer code from BlockchainServiceImpl", "committedDate": "2020-07-14T21:07:10Z", "type": "commit"}, {"oid": "59f7c7a25c2c36d0166ad844acc0199f3392ad97", "url": "https://github.com/dashevo/dash-wallet/commit/59f7c7a25c2c36d0166ad844acc0199f3392ad97", "message": "Update home screen data when resumed", "committedDate": "2020-07-16T01:00:15Z", "type": "commit"}, {"oid": "a388068208679dbb34e6f9e582029a7ecc0a5665", "url": "https://github.com/dashevo/dash-wallet/commit/a388068208679dbb34e6f9e582029a7ecc0a5665", "message": "ContactsActivity: Update when the database is changed, trigger DB update on resume", "committedDate": "2020-07-16T01:01:05Z", "type": "commit"}, {"oid": "c87ef6a0d7e2355a7553a56b19f633618e127f5b", "url": "https://github.com/dashevo/dash-wallet/commit/c87ef6a0d7e2355a7553a56b19f633618e127f5b", "message": "PlatformRepo: Fix bug that prevented updating contacts", "committedDate": "2020-07-16T01:01:42Z", "type": "commit"}, {"oid": "8fe0129f8d24c0adc22e23d8b2fc09860ecb1c42", "url": "https://github.com/dashevo/dash-wallet/commit/8fe0129f8d24c0adc22e23d8b2fc09860ecb1c42", "message": "Remove check for 44 characters for an identity before sending a CR", "committedDate": "2020-07-17T21:44:20Z", "type": "commit"}, {"oid": "dd05d974d77c287a5d0c5de97108a155e216bbc6", "url": "https://github.com/dashevo/dash-wallet/commit/dd05d974d77c287a5d0c5de97108a155e216bbc6", "message": "Merge branch 'evonet-develop' of http://github.com/dashevo/dash-wallet into dashpay-notifications-fix\n\n# Conflicts:\n#\twallet/src/de/schildbach/wallet/service/BlockchainServiceImpl.java\n#\twallet/src/de/schildbach/wallet/ui/dashpay/CreateIdentityService.kt\n#\twallet/src/de/schildbach/wallet/ui/dashpay/NotificationsActivity.kt\n#\twallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "committedDate": "2020-07-23T14:34:00Z", "type": "commit"}, {"oid": "b0beb0381b64a215cdb910b1e75146f32a8045a2", "url": "https://github.com/dashevo/dash-wallet/commit/b0beb0381b64a215cdb910b1e75146f32a8045a2", "message": "Merge branch 'dashpay-notifications-fix' of http://github.com/dashevo/dash-wallet into dashpay-notifications-fix", "committedDate": "2020-07-23T14:37:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0OTc1OA==", "url": "https://github.com/dashevo/dash-wallet/pull/460#discussion_r459549758", "bodyText": "It looks like this and the comment below can be removed.", "author": "sambarboza", "createdAt": "2020-07-23T15:47:16Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -638,9 +666,58 @@ class PlatformRepo(val walletApplication: WalletApplication) {\n                     dashPayProfileDaoAsync.insert(profile!!)\n                 }\n             }\n+            queueContactsUpdatedListeners()\n             log.info(\"updating contacts and profiles took $watch\")\n         } catch (e: Exception) {\n-            log.error(\"error updating contacts ${e.message}\")\n+            log.error(formatExceptionMessage(\"error updating contacts\", e))\n+        } finally {\n+            updatingContacts.set(false)\n+        }\n+    }\n+\n+    // Create the Handler object (on the main thread by default)\n+    val timerHandler = Handler()\n+    var timerStarted = false\n+\n+    // Define the code block to be executed\n+    private val executeUpdateContacts = object : Runnable {\n+        override fun run() {\n+            // Do something here on the main thread", "originalCommit": "8fe0129f8d24c0adc22e23d8b2fc09860ecb1c42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MjYwMQ==", "url": "https://github.com/dashevo/dash-wallet/pull/460#discussion_r459582601", "bodyText": "929801e", "author": "HashEngineering", "createdAt": "2020-07-23T16:38:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0OTc1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU1MjAzOA==", "url": "https://github.com/dashevo/dash-wallet/pull/460#discussion_r459552038", "bodyText": "Are we going to use the date parameter in the future? If so, can we add a comment? Otherwise we should remove it.", "author": "sambarboza", "createdAt": "2020-07-23T15:50:38Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/DashPayViewModel.kt", "diffHunk": "@@ -109,16 +112,12 @@ class DashPayViewModel(application: Application) : AndroidViewModel(application)\n         emit(platformRepo.isPlatformAvailable())\n     }\n \n-    fun getNotificationCount(date: Long) {\n-        notificationCountLiveData.value = date\n+    fun searchNotifications(text: String) {\n+        notificationsLiveData.searchNotifications(text)\n     }\n \n-    val getNotificationCountLiveData = Transformations.switchMap(notificationCountLiveData) { date: Long ->\n-        liveData(Dispatchers.IO) {\n-            val count = platformRepo.getNotificationCount(date)\n-            if (count >= 0)\n-                emit(count)\n-        }\n+    fun getNotificationCount(date: Long) {", "originalCommit": "8fe0129f8d24c0adc22e23d8b2fc09860ecb1c42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MjUzMQ==", "url": "https://github.com/dashevo/dash-wallet/pull/460#discussion_r459582531", "bodyText": "date was once used, now the associated liveData retrieves this from the preferences directly\n929801e", "author": "HashEngineering", "createdAt": "2020-07-23T16:38:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU1MjAzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU2MjMyOQ==", "url": "https://github.com/dashevo/dash-wallet/pull/460#discussion_r459562329", "bodyText": "It doesn't look like we're queuing calls on this method, so I would rename to fireContactsUpdatedListeners or something similar. Also, this function can be private.", "author": "sambarboza", "createdAt": "2020-07-23T16:06:00Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -638,9 +666,58 @@ class PlatformRepo(val walletApplication: WalletApplication) {\n                     dashPayProfileDaoAsync.insert(profile!!)\n                 }\n             }\n+            queueContactsUpdatedListeners()\n             log.info(\"updating contacts and profiles took $watch\")\n         } catch (e: Exception) {\n-            log.error(\"error updating contacts ${e.message}\")\n+            log.error(formatExceptionMessage(\"error updating contacts\", e))\n+        } finally {\n+            updatingContacts.set(false)\n+        }\n+    }\n+\n+    // Create the Handler object (on the main thread by default)\n+    val timerHandler = Handler()\n+    var timerStarted = false\n+\n+    // Define the code block to be executed\n+    private val executeUpdateContacts = object : Runnable {\n+        override fun run() {\n+            // Do something here on the main thread\n+            log.info(\"Timer: Update contacts\")\n+            // Repeat this the same runnable code block again another 2 seconds\n+            GlobalScope.launch {\n+                updateContactRequests()\n+            }\n+            timerHandler.postDelayed(this, UPDATE_TIMER_DELAY)\n+        }\n+    }\n+\n+    // Start the initial runnable task by posting through the handler\n+    fun startUpdateTimer() {\n+        log.info(\"Starting timer for updating DashPay\")\n+        if (!timerStarted) {\n+            timerHandler.post(executeUpdateContacts)\n+            timerStarted = true\n+        }\n+    }\n+\n+    fun stopUpdateTimer() {\n+        timerStarted = false\n+        timerHandler.removeCallbacks(executeUpdateContacts)\n+    }\n+\n+    fun addContactsUpdatedListener(listener: OnContactsUpdated) {\n+        onContactsUpdatedListeners.add(listener)\n+    }\n+\n+    fun removeContactsUpdatedListener(listener: OnContactsUpdated?) {\n+        onContactsUpdatedListeners.remove(listener)\n+    }\n+\n+    fun queueContactsUpdatedListeners() {", "originalCommit": "8fe0129f8d24c0adc22e23d8b2fc09860ecb1c42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MjEwMg==", "url": "https://github.com/dashevo/dash-wallet/pull/460#discussion_r459582102", "bodyText": "Fixed here:\n929801e", "author": "HashEngineering", "createdAt": "2020-07-23T16:37:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU2MjMyOQ=="}], "type": "inlineReview"}, {"oid": "929801ebf4d37deb29e65188d61588f5ddc7c7f1", "url": "https://github.com/dashevo/dash-wallet/commit/929801ebf4d37deb29e65188d61588f5ddc7c7f1", "message": "Review fixes", "committedDate": "2020-07-23T16:36:22Z", "type": "commit"}]}