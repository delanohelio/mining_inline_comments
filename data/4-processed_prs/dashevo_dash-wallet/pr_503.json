{"pr_number": 503, "pr_title": "DashPay: Send Payment - Pending Contact (NMA-373)", "pr_createdAt": "2020-09-03T04:31:46Z", "pr_url": "https://github.com/dashevo/dash-wallet/pull/503", "timeline": [{"oid": "0698f10691401a2f64d22286107d2ef518ee5775", "url": "https://github.com/dashevo/dash-wallet/commit/0698f10691401a2f64d22286107d2ef518ee5775", "message": "Removing wallet fragment before recreating activity", "committedDate": "2020-07-29T03:29:45Z", "type": "commit"}, {"oid": "6f0887126c03331e63c5729290419fcbb5575141", "url": "https://github.com/dashevo/dash-wallet/commit/6f0887126c03331e63c5729290419fcbb5575141", "message": "Merge remote-tracking branch 'upstream/evonet-develop' into evonet-develop", "committedDate": "2020-07-30T13:41:11Z", "type": "commit"}, {"oid": "6bbb7598abab4ffc34bd3c578cda2496b50c0421", "url": "https://github.com/dashevo/dash-wallet/commit/6bbb7598abab4ffc34bd3c578cda2496b50c0421", "message": "Merge remote-tracking branch 'upstream/evonet-develop' into evonet-develop", "committedDate": "2020-08-05T17:08:30Z", "type": "commit"}, {"oid": "42c99c400b9faed66507cd112361e0eb460cd554", "url": "https://github.com/dashevo/dash-wallet/commit/42c99c400b9faed66507cd112361e0eb460cd554", "message": "Merge remote-tracking branch 'upstream/evonet-develop' into evonet-develop", "committedDate": "2020-08-06T18:55:08Z", "type": "commit"}, {"oid": "af16683d92f479f92f64fa02ef78592c37abbd44", "url": "https://github.com/dashevo/dash-wallet/commit/af16683d92f479f92f64fa02ef78592c37abbd44", "message": "Merge remote-tracking branch 'upstream/evonet-develop' into evonet-develop", "committedDate": "2020-08-18T00:28:48Z", "type": "commit"}, {"oid": "11ed7a0e3562c0b2d26850692b3ffd32037dca21", "url": "https://github.com/dashevo/dash-wallet/commit/11ed7a0e3562c0b2d26850692b3ffd32037dca21", "message": "Added contact suggestion layout", "committedDate": "2020-08-22T00:51:03Z", "type": "commit"}, {"oid": "9ea96ba737898f0d18ffd479b0285c96e8745c53", "url": "https://github.com/dashevo/dash-wallet/commit/9ea96ba737898f0d18ffd479b0285c96e8745c53", "message": "Showing User activity after paying to qr with username", "committedDate": "2020-08-27T08:14:05Z", "type": "commit"}, {"oid": "7cfeaf539db874cb820c3e8a2f7d2f8c40bfa1b5", "url": "https://github.com/dashevo/dash-wallet/commit/7cfeaf539db874cb820c3e8a2f7d2f8c40bfa1b5", "message": "Showing disclaimer when paying to non-contact", "committedDate": "2020-08-28T02:58:30Z", "type": "commit"}, {"oid": "de1e33d8000dfe1f5059ad5179377f6149bfd258", "url": "https://github.com/dashevo/dash-wallet/commit/de1e33d8000dfe1f5059ad5179377f6149bfd258", "message": "Layout adjustments", "committedDate": "2020-08-28T23:43:27Z", "type": "commit"}, {"oid": "0683ca6f9dcedeea68731ec3e4988b37036b04c3", "url": "https://github.com/dashevo/dash-wallet/commit/0683ca6f9dcedeea68731ec3e4988b37036b04c3", "message": "Notifications livedata trigger and layout fix", "committedDate": "2020-09-02T01:26:17Z", "type": "commit"}, {"oid": "821007f27568c7c560626e2ca4140f2dfe1429ef", "url": "https://github.com/dashevo/dash-wallet/commit/821007f27568c7c560626e2ca4140f2dfe1429ef", "message": "organize imports on PaymentIntent.java", "committedDate": "2020-09-02T02:16:51Z", "type": "commit"}, {"oid": "073eb7ab50fe8e7fa9bf1f49ed54744a70689c73", "url": "https://github.com/dashevo/dash-wallet/commit/073eb7ab50fe8e7fa9bf1f49ed54744a70689c73", "message": "Merge branch 'dashpay-pay-stranger' of https://github.com/sambarboza/dash-wallet into dashpay-pay-pending", "committedDate": "2020-09-02T21:28:32Z", "type": "commit"}, {"oid": "f37763e7c80842bf604e42ed686163eacd0d4788", "url": "https://github.com/dashevo/dash-wallet/commit/f37763e7c80842bf604e42ed686163eacd0d4788", "message": "Show Add New Contact if we have not received a request\n\nprevious code didn't show Add New Contact if we had sent a request, though we had no contacts.", "committedDate": "2020-09-03T03:42:52Z", "type": "commit"}, {"oid": "bcdb244aae5b2d925d4bbe8c598e88e94ea8a1fe", "url": "https://github.com/dashevo/dash-wallet/commit/bcdb244aae5b2d925d4bbe8c598e88e94ea8a1fe", "message": "Show received request notification on user screen without accept/x buttons", "committedDate": "2020-09-03T04:25:14Z", "type": "commit"}, {"oid": "85c48ccb4c3781f92e0b34e871adf984206dc4e9", "url": "https://github.com/dashevo/dash-wallet/commit/85c48ccb4c3781f92e0b34e871adf984206dc4e9", "message": "Do manual layout for user who has made a contact request", "committedDate": "2020-09-03T04:26:18Z", "type": "commit"}, {"oid": "fc661f280c24b0922f3b5be60e9c22dc8ac9cc9c", "url": "https://github.com/dashevo/dash-wallet/commit/fc661f280c24b0922f3b5be60e9c22dc8ac9cc9c", "message": "Update layouts with new avatar size and add Accept Contact Request", "committedDate": "2020-09-04T03:29:52Z", "type": "commit"}, {"oid": "5f512b1339b67ae5cb6768311cd3432550456092", "url": "https://github.com/dashevo/dash-wallet/commit/5f512b1339b67ae5cb6768311cd3432550456092", "message": "Change checkbox to a circle", "committedDate": "2020-09-04T05:14:18Z", "type": "commit"}, {"oid": "12d09d32cc13c183cbb2b9870510dc21db01f1a9", "url": "https://github.com/dashevo/dash-wallet/commit/12d09d32cc13c183cbb2b9870510dc21db01f1a9", "message": "DashPayProfileDao: add load profile from username methods", "committedDate": "2020-09-04T05:15:20Z", "type": "commit"}, {"oid": "d2184350e752fd8be681090fdef59c19ec190cdf", "url": "https://github.com/dashevo/dash-wallet/commit/d2184350e752fd8be681090fdef59c19ec190cdf", "message": "PlatformRepo: Add sendContactRequest(userid) method", "committedDate": "2020-09-04T05:19:53Z", "type": "commit"}, {"oid": "239df509a806e854178b86792c34582c3934b633", "url": "https://github.com/dashevo/dash-wallet/commit/239df509a806e854178b86792c34582c3934b633", "message": "Phase 1 of supporting scanning QR codes and paying pending contacts and current contacts", "committedDate": "2020-09-04T05:20:40Z", "type": "commit"}, {"oid": "e7f1fa393442497af7d0f44edc828755b317e9d3", "url": "https://github.com/dashevo/dash-wallet/commit/e7f1fa393442497af7d0f44edc828755b317e9d3", "message": "PaymentIntent: Add constructor that for address, identity and amount", "committedDate": "2020-09-08T14:41:29Z", "type": "commit"}, {"oid": "71a4fb7b9756048da76f4c862beda8896166b249", "url": "https://github.com/dashevo/dash-wallet/commit/71a4fb7b9756048da76f4c862beda8896166b249", "message": "SendCoinsFragment: handle payment intents codes with username that is a contact/pending contact", "committedDate": "2020-09-08T14:45:35Z", "type": "commit"}, {"oid": "b558d5d5055549449e249f55bae2badab4c4d480", "url": "https://github.com/dashevo/dash-wallet/commit/b558d5d5055549449e249f55bae2badab4c4d480", "message": "Merge branch 'evonet-develop' of https://github.com/dashevo/dash-wallet into dashpay-pay-pending", "committedDate": "2020-09-08T14:56:06Z", "type": "commit"}, {"oid": "09cd88d599a6401d3053166e571ce1a85b66ccb4", "url": "https://github.com/dashevo/dash-wallet/commit/09cd88d599a6401d3053166e571ce1a85b66ccb4", "message": "Use WorkManager for sending contact requests (#506)", "committedDate": "2020-09-09T15:18:47Z", "type": "commit"}, {"oid": "c5255c5ba26c7653d4ddb431f725d8a09528cd1a", "url": "https://github.com/dashevo/dash-wallet/commit/c5255c5ba26c7653d4ddb431f725d8a09528cd1a", "message": "Show enter amount screen if blockchain is not synced (replaying)", "committedDate": "2020-09-09T20:21:36Z", "type": "commit"}, {"oid": "7909f4e429b572f5ebe4ab0b3633e2fb3c7c36c1", "url": "https://github.com/dashevo/dash-wallet/commit/7909f4e429b572f5ebe4ab0b3633e2fb3c7c36c1", "message": "Merge branch 'evonet-develop' of https://github.com/dashevo/dash-wallet into dashpay-pay-pending", "committedDate": "2020-09-11T15:00:31Z", "type": "commit"}, {"oid": "a505a3c91e90d2d38ef79873f01d46387f1425f0", "url": "https://github.com/dashevo/dash-wallet/commit/a505a3c91e90d2d38ef79873f01d46387f1425f0", "message": "Tracking the progress of sending contact request", "committedDate": "2020-09-11T16:00:37Z", "type": "commit"}, {"oid": "d63e317b03437a984fd06cce49911a9501cb8eb2", "url": "https://github.com/dashevo/dash-wallet/commit/d63e317b03437a984fd06cce49911a9501cb8eb2", "message": "Fix a few crashes, compile issues", "committedDate": "2020-09-11T17:35:27Z", "type": "commit"}, {"oid": "535846b030e1c28cf2155d99b8e651f91e10ce01", "url": "https://github.com/dashevo/dash-wallet/commit/535846b030e1c28cf2155d99b8e651f91e10ce01", "message": "Simplified tracking of the progress of send contact request operation (#509)\n\n* Simplified tracking of the progress of send contact request operation\r\nRemoved some debug code\r\n\r\n* No need to derive encryption key one more time\r\n\r\n* Improved exception handling", "committedDate": "2020-09-21T15:52:04Z", "type": "commit"}, {"oid": "167342c8f6ea4dc11449b9c210dc89acf9040c0c", "url": "https://github.com/dashevo/dash-wallet/commit/167342c8f6ea4dc11449b9c210dc89acf9040c0c", "message": "Refactored the code of handling payments to pending contact.\nAdded tracking the progress after sending contact request.", "committedDate": "2020-09-21T18:25:56Z", "type": "commit"}, {"oid": "a3de22651a42905924b126a8ec96b01034aca986", "url": "https://github.com/dashevo/dash-wallet/commit/a3de22651a42905924b126a8ec96b01034aca986", "message": "Major refactoring of DashPayUserActivity and logic responsible for handling status of contact requests.\nFixed issues with sending payments to strangers.", "committedDate": "2020-09-24T17:47:35Z", "type": "commit"}, {"oid": "db464b1f2a43227670096381e71f05b8e8a7146b", "url": "https://github.com/dashevo/dash-wallet/commit/db464b1f2a43227670096381e71f05b8e8a7146b", "message": "Merge branch 'evonet-develop' into dashpay-pay-pending\n\n# Conflicts:\n#\twallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "committedDate": "2020-09-24T17:52:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyNDk2NA==", "url": "https://github.com/dashevo/dash-wallet/pull/503#discussion_r494624964", "bodyText": "This looks like my code.  It doesn't match that of DashPayProfileDaoAsync which has better names.\nThese methods should be called loadByUsername and loadByUsernameDistinct\nWe are missing a loadByUserId here compared to DashPayProfileDaoAsync, it is still called load.", "author": "HashEngineering", "createdAt": "2020-09-24T21:36:39Z", "path": "wallet/src/de/schildbach/wallet/data/DashPayProfileDao.kt", "diffHunk": "@@ -17,6 +17,12 @@ interface DashPayProfileDao {\n     fun loadDistinct(userId: String):\n             LiveData<DashPayProfile?> = load(userId).getDistinct()\n \n+    @Query(\"SELECT * FROM dashpay_profile where username = :username\")\n+    fun loadFromUsername(username: String): LiveData<DashPayProfile?>\n+\n+    fun loadFromUsernameDistinct(userId: String):\n+            LiveData<DashPayProfile?> = loadFromUsername(userId).getDistinct()\n+", "originalCommit": "db464b1f2a43227670096381e71f05b8e8a7146b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg5ODc1MQ==", "url": "https://github.com/dashevo/dash-wallet/pull/503#discussion_r495898751", "bodyText": "Missing loadByUserId added", "author": "tomasz-ludek", "createdAt": "2020-09-28T12:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyNDk2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyODczNA==", "url": "https://github.com/dashevo/dash-wallet/pull/503#discussion_r494628734", "bodyText": "Good idea to refactor this code out to a new class, rather than have duplicate code in many classes.", "author": "HashEngineering", "createdAt": "2020-09-24T21:45:51Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/ContactsBasedLiveData.kt", "diffHunk": "@@ -0,0 +1,35 @@\n+package de.schildbach.wallet.ui.dashpay\n+\n+import androidx.lifecycle.LiveData\n+import de.schildbach.wallet.WalletApplication\n+\n+abstract class ContactsBasedLiveData<T>(val walletApplication: WalletApplication,", "originalCommit": "db464b1f2a43227670096381e71f05b8e8a7146b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b122b099de169b713c88de3cf2019e8fd6975532", "url": "https://github.com/dashevo/dash-wallet/commit/b122b099de169b713c88de3cf2019e8fd6975532", "message": "Minor code refactoring.\nMostly changed the naming convention for Room DAOs (the `Async` suffix should not be used in coroutine based / suspended versions)", "committedDate": "2020-09-25T09:26:48Z", "type": "commit"}, {"oid": "f1612006a3a16d1303eba9e1aa7e4a45ebc799b8", "url": "https://github.com/dashevo/dash-wallet/commit/f1612006a3a16d1303eba9e1aa7e4a45ebc799b8", "message": "Improvements in tracking status of contact requests", "committedDate": "2020-09-25T15:14:48Z", "type": "commit"}, {"oid": "0858cc69d2b8f1bcad4275e65ba87a4dcc5a495f", "url": "https://github.com/dashevo/dash-wallet/commit/0858cc69d2b8f1bcad4275e65ba87a4dcc5a495f", "message": "Improvements in tracking status of contact requests for DashPayUserActivity and UsernameSearchResultsAdapter", "committedDate": "2020-09-28T08:39:24Z", "type": "commit"}, {"oid": "5b77a8edd2662997dea3f2ea1781ae0274904ddf", "url": "https://github.com/dashevo/dash-wallet/commit/5b77a8edd2662997dea3f2ea1781ae0274904ddf", "message": "Improvements in tracking status of contact requests for ContactSearchResultsAdapter and NotificationsAdapter", "committedDate": "2020-09-28T12:03:13Z", "type": "commit"}, {"oid": "ae75d7a7856ff1c22e6431f1478994ba35a4fc53", "url": "https://github.com/dashevo/dash-wallet/commit/ae75d7a7856ff1c22e6431f1478994ba35a4fc53", "message": "Minor refactoring", "committedDate": "2020-09-28T12:07:12Z", "type": "commit"}, {"oid": "c5335a02f79e8d8e3f0392bc64565f4cbba11c79", "url": "https://github.com/dashevo/dash-wallet/commit/c5335a02f79e8d8e3f0392bc64565f4cbba11c79", "message": "Merge branch 'evonet-develop' into dashpay-pay-pending\n\n# Conflicts:\n#\twallet/src/de/schildbach/wallet/ui/dashpay/ContactSearchResultsAdapter.kt\n#\twallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "committedDate": "2020-09-28T12:39:07Z", "type": "commit"}, {"oid": "9a30d01d2aef7bb9cadcb0d647a55d13d44e45fc", "url": "https://github.com/dashevo/dash-wallet/commit/9a30d01d2aef7bb9cadcb0d647a55d13d44e45fc", "message": "Remember the state of 'Accept contact request' checkbox user-wise", "committedDate": "2020-09-29T12:32:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc2NDQ0Mw==", "url": "https://github.com/dashevo/dash-wallet/pull/503#discussion_r496764443", "bodyText": "Can this be removed?", "author": "HashEngineering", "createdAt": "2020-09-29T14:28:43Z", "path": "wallet/src/de/schildbach/wallet/ui/DashPayUserActivityViewModel.kt", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright 2020 Dash Core Group.\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package de.schildbach.wallet.ui\n+\n+import android.app.Application\n+import androidx.lifecycle.*\n+import de.schildbach.wallet.AppDatabase\n+import de.schildbach.wallet.WalletApplication\n+import de.schildbach.wallet.data.UsernameSearchResult\n+import de.schildbach.wallet.ui.dashpay.NotificationsForUserLiveData\n+import de.schildbach.wallet.ui.dashpay.PlatformRepo\n+import de.schildbach.wallet.ui.dashpay.work.SendContactRequestOperation\n+import kotlinx.coroutines.Dispatchers\n+import org.slf4j.LoggerFactory\n+\n+class DashPayUserActivityViewModel(application: Application) : AndroidViewModel(application) {\n+\n+    companion object {\n+        val log = LoggerFactory.getLogger(DashPayUserActivityViewModel::class.java)\n+    }\n+\n+    private val platformRepo = PlatformRepo.getInstance()\n+    private val walletApplication = application as WalletApplication\n+\n+    lateinit var userData: UsernameSearchResult\n+\n+//    val userLiveData by lazy {\n+//        AppDatabase.getAppDatabase().dashPayProfileDaoAsync().loadByUserIdDistinct(userData.dashPayProfile.userId).switchMap {\n+//            return@switchMap liveData(Dispatchers.IO) {\n+//                userData = platformRepo.loadContactRequestsAndReturn(it)!!\n+//                emit(userData)\n+//            }\n+//        }\n+//    }", "originalCommit": "9a30d01d2aef7bb9cadcb0d647a55d13d44e45fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc5NTczOQ==", "url": "https://github.com/dashevo/dash-wallet/pull/503#discussion_r496795739", "bodyText": "Removed", "author": "tomasz-ludek", "createdAt": "2020-09-29T15:07:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc2NDQ0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc2NDcxOA==", "url": "https://github.com/dashevo/dash-wallet/pull/503#discussion_r496764718", "bodyText": "Can this be removed?", "author": "HashEngineering", "createdAt": "2020-09-29T14:29:04Z", "path": "wallet/src/de/schildbach/wallet/ui/DashPayUserActivityViewModel.kt", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright 2020 Dash Core Group.\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package de.schildbach.wallet.ui\n+\n+import android.app.Application\n+import androidx.lifecycle.*\n+import de.schildbach.wallet.AppDatabase\n+import de.schildbach.wallet.WalletApplication\n+import de.schildbach.wallet.data.UsernameSearchResult\n+import de.schildbach.wallet.ui.dashpay.NotificationsForUserLiveData\n+import de.schildbach.wallet.ui.dashpay.PlatformRepo\n+import de.schildbach.wallet.ui.dashpay.work.SendContactRequestOperation\n+import kotlinx.coroutines.Dispatchers\n+import org.slf4j.LoggerFactory\n+\n+class DashPayUserActivityViewModel(application: Application) : AndroidViewModel(application) {\n+\n+    companion object {\n+        val log = LoggerFactory.getLogger(DashPayUserActivityViewModel::class.java)\n+    }\n+\n+    private val platformRepo = PlatformRepo.getInstance()\n+    private val walletApplication = application as WalletApplication\n+\n+    lateinit var userData: UsernameSearchResult\n+\n+//    val userLiveData by lazy {\n+//        AppDatabase.getAppDatabase().dashPayProfileDaoAsync().loadByUserIdDistinct(userData.dashPayProfile.userId).switchMap {\n+//            return@switchMap liveData(Dispatchers.IO) {\n+//                userData = platformRepo.loadContactRequestsAndReturn(it)!!\n+//                emit(userData)\n+//            }\n+//        }\n+//    }\n+\n+    val userLiveData by lazy {\n+        liveData(Dispatchers.IO) {\n+            userData = platformRepo.getUser(userData.username).first()\n+            sendContactRequestState\n+            emit(userData)\n+        }\n+    }\n+\n+    val sendContactRequestState by lazy {\n+        SendContactRequestOperation.operationStatus(application, userData.dashPayProfile.userId)\n+    }\n+\n+//    val userLiveDataObservable by lazy {\n+//        AppDatabase.getAppDatabase().dashPayProfileDaoAsync().loadDistinct(userData.dashPayProfile.userId)\n+//    }", "originalCommit": "9a30d01d2aef7bb9cadcb0d647a55d13d44e45fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc5NTU5OA==", "url": "https://github.com/dashevo/dash-wallet/pull/503#discussion_r496795598", "bodyText": "Removed", "author": "tomasz-ludek", "createdAt": "2020-09-29T15:07:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc2NDcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc2NTIwMw==", "url": "https://github.com/dashevo/dash-wallet/pull/503#discussion_r496765203", "bodyText": "Can this be removed?", "author": "HashEngineering", "createdAt": "2020-09-29T14:29:39Z", "path": "wallet/src/de/schildbach/wallet/ui/DashPayUserActivityViewModel.kt", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright 2020 Dash Core Group.\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package de.schildbach.wallet.ui\n+\n+import android.app.Application\n+import androidx.lifecycle.*\n+import de.schildbach.wallet.AppDatabase\n+import de.schildbach.wallet.WalletApplication\n+import de.schildbach.wallet.data.UsernameSearchResult\n+import de.schildbach.wallet.ui.dashpay.NotificationsForUserLiveData\n+import de.schildbach.wallet.ui.dashpay.PlatformRepo\n+import de.schildbach.wallet.ui.dashpay.work.SendContactRequestOperation\n+import kotlinx.coroutines.Dispatchers\n+import org.slf4j.LoggerFactory\n+\n+class DashPayUserActivityViewModel(application: Application) : AndroidViewModel(application) {\n+\n+    companion object {\n+        val log = LoggerFactory.getLogger(DashPayUserActivityViewModel::class.java)\n+    }\n+\n+    private val platformRepo = PlatformRepo.getInstance()\n+    private val walletApplication = application as WalletApplication\n+\n+    lateinit var userData: UsernameSearchResult\n+\n+//    val userLiveData by lazy {\n+//        AppDatabase.getAppDatabase().dashPayProfileDaoAsync().loadByUserIdDistinct(userData.dashPayProfile.userId).switchMap {\n+//            return@switchMap liveData(Dispatchers.IO) {\n+//                userData = platformRepo.loadContactRequestsAndReturn(it)!!\n+//                emit(userData)\n+//            }\n+//        }\n+//    }\n+\n+    val userLiveData by lazy {\n+        liveData(Dispatchers.IO) {\n+            userData = platformRepo.getUser(userData.username).first()\n+            sendContactRequestState\n+            emit(userData)\n+        }\n+    }\n+\n+    val sendContactRequestState by lazy {\n+        SendContactRequestOperation.operationStatus(application, userData.dashPayProfile.userId)\n+    }\n+\n+//    val userLiveDataObservable by lazy {\n+//        AppDatabase.getAppDatabase().dashPayProfileDaoAsync().loadDistinct(userData.dashPayProfile.userId)\n+//    }\n+\n+    fun a() {\n+        val a = MediatorLiveData<UsernameSearchResult>()\n+        a.addSource(AppDatabase.getAppDatabase().dashPayProfileDaoAsync().loadByUserIdDistinct(userData.dashPayProfile.userId), Observer {\n+\n+        })\n+        a.addSource(AppDatabase.getAppDatabase().dashPayContactRequestDaoAsync().loadDistinctToOthers(userData.dashPayProfile.userId), Observer {\n+\n+        })\n+        a.addSource(AppDatabase.getAppDatabase().dashPayContactRequestDaoAsync().loadDistinctFromOthers(userData.dashPayProfile.userId), Observer {\n+\n+        })\n+    }\n+\n+\n+//    fun sendContactRequest(refreshUserData: Boolean) {\n+//        viewModelScope.launch(Dispatchers.IO) {\n+//            try {\n+//                val toUserId = userLiveData.value!!.dashPayProfile.userId\n+//                val username = userLiveData.value!!.username\n+//                val result = platformRepo.sendContactRequest(toUserId)\n+//                if (refreshUserData) {\n+//                    userLiveData.postValue(platformRepo.getUser(userData.username).first())\n+//                } else {\n+//                    userLiveData.value!!.toContactRequest = result\n+//                    userLiveData.postValue(userLiveData.value)  //notify observers\n+//                }\n+//            } catch (ex: Exception) {\n+//                log.error(ex.message, ex)\n+//                userLiveData.postValue(userLiveData.value)  //notify observers\n+//            }\n+//        }\n+//    }", "originalCommit": "9a30d01d2aef7bb9cadcb0d647a55d13d44e45fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc5NTQ2Nw==", "url": "https://github.com/dashevo/dash-wallet/pull/503#discussion_r496795467", "bodyText": "Removed", "author": "tomasz-ludek", "createdAt": "2020-09-29T15:07:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc2NTIwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc2NTU0Mw==", "url": "https://github.com/dashevo/dash-wallet/pull/503#discussion_r496765543", "bodyText": "is there a better name for this method?", "author": "HashEngineering", "createdAt": "2020-09-29T14:30:04Z", "path": "wallet/src/de/schildbach/wallet/ui/DashPayUserActivityViewModel.kt", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright 2020 Dash Core Group.\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package de.schildbach.wallet.ui\n+\n+import android.app.Application\n+import androidx.lifecycle.*\n+import de.schildbach.wallet.AppDatabase\n+import de.schildbach.wallet.WalletApplication\n+import de.schildbach.wallet.data.UsernameSearchResult\n+import de.schildbach.wallet.ui.dashpay.NotificationsForUserLiveData\n+import de.schildbach.wallet.ui.dashpay.PlatformRepo\n+import de.schildbach.wallet.ui.dashpay.work.SendContactRequestOperation\n+import kotlinx.coroutines.Dispatchers\n+import org.slf4j.LoggerFactory\n+\n+class DashPayUserActivityViewModel(application: Application) : AndroidViewModel(application) {\n+\n+    companion object {\n+        val log = LoggerFactory.getLogger(DashPayUserActivityViewModel::class.java)\n+    }\n+\n+    private val platformRepo = PlatformRepo.getInstance()\n+    private val walletApplication = application as WalletApplication\n+\n+    lateinit var userData: UsernameSearchResult\n+\n+//    val userLiveData by lazy {\n+//        AppDatabase.getAppDatabase().dashPayProfileDaoAsync().loadByUserIdDistinct(userData.dashPayProfile.userId).switchMap {\n+//            return@switchMap liveData(Dispatchers.IO) {\n+//                userData = platformRepo.loadContactRequestsAndReturn(it)!!\n+//                emit(userData)\n+//            }\n+//        }\n+//    }\n+\n+    val userLiveData by lazy {\n+        liveData(Dispatchers.IO) {\n+            userData = platformRepo.getUser(userData.username).first()\n+            sendContactRequestState\n+            emit(userData)\n+        }\n+    }\n+\n+    val sendContactRequestState by lazy {\n+        SendContactRequestOperation.operationStatus(application, userData.dashPayProfile.userId)\n+    }\n+\n+//    val userLiveDataObservable by lazy {\n+//        AppDatabase.getAppDatabase().dashPayProfileDaoAsync().loadDistinct(userData.dashPayProfile.userId)\n+//    }\n+\n+    fun a() {", "originalCommit": "9a30d01d2aef7bb9cadcb0d647a55d13d44e45fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc5NDcyMA==", "url": "https://github.com/dashevo/dash-wallet/pull/503#discussion_r496794720", "bodyText": "It was a test code.\nRemoved", "author": "tomasz-ludek", "createdAt": "2020-09-29T15:06:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc2NTU0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc2Nzg0OQ==", "url": "https://github.com/dashevo/dash-wallet/pull/503#discussion_r496767849", "bodyText": "This alternating background color code was removed in a merged PR from last week:\nhttps://github.com/dashevo/dash-wallet/pull/514/files", "author": "HashEngineering", "createdAt": "2020-09-29T14:32:55Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/ContactSearchResultsAdapter.kt", "diffHunk": "@@ -78,26 +71,59 @@ class ContactSearchResultsAdapter(private val listener: Listener,\n         return results.size\n     }\n \n+    var sendContactRequestWorkStateMap: Map<String, Resource<WorkInfo>> = mapOf()\n+        set(value) {\n+            field = value\n+            notifyDataSetChanged()\n+        }\n+\n     override fun getItemId(position: Int): Long {\n-        return when (results[position].viewType) {\n-            CONTACT -> PlatformUtils.longHashFromEncodedString(results[position].usernameSearchResult!!.toContactRequest!!.toUserId)\n-            CONTACT_REQUEST -> PlatformUtils.longHashFromEncodedString(results[position].usernameSearchResult!!.fromContactRequest!!.userId)\n+        val item = results[position]\n+        return when (item.viewType) {\n+            CONTACT -> {\n+                if (item.usernameSearchResult!!.type == UsernameSearchResult.Type.CONTACT_ESTABLISHED) {\n+                    PlatformUtils.longHashFromEncodedString(item.usernameSearchResult.toContactRequest!!.toUserId)\n+                } else {\n+                    PlatformUtils.longHashFromEncodedString(item.usernameSearchResult.fromContactRequest!!.userId)\n+                }\n+            }\n             CONTACT_REQUEST_HEADER -> 1L\n             CONTACT_HEADER -> 2L\n-            else -> throw IllegalArgumentException(\"Invalid viewType ${results[position].viewType}\")\n+            else -> throw IllegalArgumentException(\"Invalid viewType ${item.viewType}\")\n         }\n     }\n \n-    override fun onBindViewHolder(holder: ViewHolder, position: Int) {\n-        when (results[position].viewType) {\n-            CONTACT, CONTACT_REQUEST -> holder.bind(results[position].usernameSearchResult!!)\n+    override fun onBindViewHolder(holder: RecyclerView.ViewHolder, position: Int) {\n+        val item = results[position]\n+        when (item.viewType) {\n+            CONTACT -> {\n+                val sendContactRequestWorkState = sendContactRequestWorkStateMap[item.usernameSearchResult!!.dashPayProfile.userId]\n+                (holder as ContactViewHolder).apply {\n+                    bind(item.usernameSearchResult, sendContactRequestWorkState, itemClickListener, listener)\n+                    if (item.usernameSearchResult.isPendingRequest) {\n+                        setMarginsDp(20, 3, 20, 3)\n+                        setBackgroundResource(R.drawable.selectable_round_corners)\n+                    } else {\n+                        setMarginsDp(0, 0, 0, 0)\n+                        // background color alternates based on first letter\n+                        val colorResId = if (item.usernameSearchResult.dashPayProfile.username[0].toLowerCase().toInt() % 2 != 0) {\n+                            R.color.white\n+                        } else {\n+                            R.color.dash_lighter_gray\n+                        }\n+                        val color = ResourcesCompat.getColor(holder.itemView.resources, colorResId, null)\n+                        setBackgroundColor(color)", "originalCommit": "9a30d01d2aef7bb9cadcb0d647a55d13d44e45fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc5MjgxMg==", "url": "https://github.com/dashevo/dash-wallet/pull/503#discussion_r496792812", "bodyText": "This explains my confusion when merging evonet-develop into my code.\nFixed", "author": "tomasz-ludek", "createdAt": "2020-09-29T15:03:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc2Nzg0OQ=="}], "type": "inlineReview"}, {"oid": "ef526bbbabff90adb462b6b99dbb43838e30df97", "url": "https://github.com/dashevo/dash-wallet/commit/ef526bbbabff90adb462b6b99dbb43838e30df97", "message": "Revert temporary test changes", "committedDate": "2020-09-29T14:48:36Z", "type": "commit"}, {"oid": "fd46155c16015a75a33acaaebb86233ec35152de", "url": "https://github.com/dashevo/dash-wallet/commit/fd46155c16015a75a33acaaebb86233ec35152de", "message": "Minor code refactoring", "committedDate": "2020-09-29T15:09:14Z", "type": "commit"}]}