{"pr_number": 570, "pr_title": "DashPay: Only add new ContactRequests to the db/listeners", "pr_createdAt": "2020-12-07T01:17:24Z", "pr_url": "https://github.com/dashevo/dash-wallet/pull/570", "timeline": [{"oid": "8003b751dc590fbf13a9d38562918ad81f096af0", "url": "https://github.com/dashevo/dash-wallet/commit/8003b751dc590fbf13a9d38562918ad81f096af0", "message": "DashPayContactRequestDao: add exist method", "committedDate": "2020-12-07T01:10:27Z", "type": "commit"}, {"oid": "546fb06a853f005ee0980dc3a5819dd2a077663b", "url": "https://github.com/dashevo/dash-wallet/commit/546fb06a853f005ee0980dc3a5819dd2a077663b", "message": "PlatformRepo: Only add new contactRequests\n\nOnly fire the contactsUpdatedListeners if contact requests were added", "committedDate": "2020-12-07T01:11:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI1OTkxMQ==", "url": "https://github.com/dashevo/dash-wallet/pull/570#discussion_r543259911", "bodyText": "Nice!", "author": "tomasz-ludek", "createdAt": "2020-12-15T11:21:08Z", "path": "wallet/src/de/schildbach/wallet/data/DashPayContactRequestDao.kt", "diffHunk": "@@ -19,6 +19,9 @@ interface DashPayContactRequestDao {\n     @Query(\"SELECT * FROM dashpay_contact_request WHERE toUserId = :toUserId\")\n     suspend fun loadFromOthers(toUserId: String): List<DashPayContactRequest>?\n \n+    @Query(\"SELECT EXISTS (SELECT * FROM dashpay_contact_request WHERE userId = :userId AND toUserId = :toUserId)\")", "originalCommit": "546fb06a853f005ee0980dc3a5819dd2a077663b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI2MjM0OQ==", "url": "https://github.com/dashevo/dash-wallet/pull/570#discussion_r543262349", "bodyText": "I would prefer to use TimeUnit.MINUTES.toMillis(10) instead of DateUtils.MINUTE_IN_MILLIS * 10 but it isn't a part of this story so we can let well alone ;)", "author": "tomasz-ludek", "createdAt": "2020-12-15T11:25:18Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -810,8 +810,15 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n             Context.propagate(walletApplication.wallet.context)\n             var encryptionKey: KeyParameter? = null\n \n-            var lastContactRequestTime = if (dashPayContactRequestDao.countAllRequests() > 0)\n-                dashPayContactRequestDao.getLastTimestamp() - DateUtils.MINUTE_IN_MILLIS * 12\n+            var lastContactRequestTime = if (dashPayContactRequestDao.countAllRequests() > 0) {\n+                val lastTimeStamp = dashPayContactRequestDao.getLastTimestamp()\n+                // if the last contact request was received in the past 10 minutes, then query for\n+                // contact requests that are 10 minutes before it.  If the last contact request was\n+                // more than 10 minutes ago, then query all contact requests that came after it.\n+                if (lastTimeStamp < System.currentTimeMillis() - DateUtils.MINUTE_IN_MILLIS * 10)", "originalCommit": "546fb06a853f005ee0980dc3a5819dd2a077663b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU1MzQzNQ==", "url": "https://github.com/dashevo/dash-wallet/pull/570#discussion_r543553435", "bodyText": "Looks like our app is using both of these methods depending on the author.", "author": "HashEngineering", "createdAt": "2020-12-15T17:44:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI2MjM0OQ=="}], "type": "inlineReview"}]}