{"pr_number": 520, "pr_title": "DashPay: Add create/update profile support", "pr_createdAt": "2020-10-02T20:36:13Z", "pr_url": "https://github.com/dashevo/dash-wallet/pull/520", "timeline": [{"oid": "1ed67f2c962af60e092d0243babce2ce154bcdf0", "url": "https://github.com/dashevo/dash-wallet/commit/1ed67f2c962af60e092d0243babce2ce154bcdf0", "message": "Use 0.15-SNAPSHOT for dpp, dashpay, dapi-client", "committedDate": "2020-09-18T18:34:19Z", "type": "commit"}, {"oid": "1354fcad8fdb06104a5303fe84ce25ed9b42bd2a", "url": "https://github.com/dashevo/dash-wallet/commit/1354fcad8fdb06104a5303fe84ce25ed9b42bd2a", "message": "Update for DPP 0.15, new dpns/dashpay contracts, database tables", "committedDate": "2020-09-19T01:58:36Z", "type": "commit"}, {"oid": "f9d262ea38241110aca09e3b5d25206154fa6f46", "url": "https://github.com/dashevo/dash-wallet/commit/f9d262ea38241110aca09e3b5d25206154fa6f46", "message": "Set unique property on username", "committedDate": "2020-09-19T17:14:07Z", "type": "commit"}, {"oid": "1deafa3b404b19722ab479bda10ac489492ec1ff", "url": "https://github.com/dashevo/dash-wallet/commit/1deafa3b404b19722ab479bda10ac489492ec1ff", "message": "Handle updated profiles from Platform and refactor", "committedDate": "2020-09-22T22:19:02Z", "type": "commit"}, {"oid": "090df0b4bd6fb6d3964fa5c8404f63af66b27d87", "url": "https://github.com/dashevo/dash-wallet/commit/090df0b4bd6fb6d3964fa5c8404f63af66b27d87", "message": "BlockchainIdentityData:  Add userId field\n\nThis allows loading an identity before the credit funding\ntransaction is found.", "committedDate": "2020-09-24T15:58:49Z", "type": "commit"}, {"oid": "e5601c2525486b8b0ae8b2d07b29dc4a9c82af81", "url": "https://github.com/dashevo/dash-wallet/commit/e5601c2525486b8b0ae8b2d07b29dc4a9c82af81", "message": "BlockchainState: Notification shows sync percentage", "committedDate": "2020-09-24T15:58:50Z", "type": "commit"}, {"oid": "ff9b5a7e42de88a5a8197f874c80744b21490613", "url": "https://github.com/dashevo/dash-wallet/commit/ff9b5a7e42de88a5a8197f874c80744b21490613", "message": "BlockchainState: Notification shows sync percentage", "committedDate": "2020-09-24T15:58:50Z", "type": "commit"}, {"oid": "db91501fa06211eca89dc7e7bb9d7aa44cef3892", "url": "https://github.com/dashevo/dash-wallet/commit/db91501fa06211eca89dc7e7bb9d7aa44cef3892", "message": "Refactor database clear when restarting/wiping the app", "committedDate": "2020-09-24T15:58:50Z", "type": "commit"}, {"oid": "927595c9418a37bce0d6d6630224e2d1652de695", "url": "https://github.com/dashevo/dash-wallet/commit/927595c9418a37bce0d6d6630224e2d1652de695", "message": "Check for identity before syncing chain.", "committedDate": "2020-09-24T16:02:55Z", "type": "commit"}, {"oid": "289be3cf59ae3d4417b2b310b54256a87cd2cf68", "url": "https://github.com/dashevo/dash-wallet/commit/289be3cf59ae3d4417b2b310b54256a87cd2cf68", "message": "Add database json file and handle the cftx after the fact", "committedDate": "2020-09-24T16:03:45Z", "type": "commit"}, {"oid": "4b5b1c88f387dd4c2fc19d3e184806fdac8b923d", "url": "https://github.com/dashevo/dash-wallet/commit/4b5b1c88f387dd4c2fc19d3e184806fdac8b923d", "message": "catch profile fetching exception and fix getIdentityByPublicKey", "committedDate": "2020-09-25T18:33:47Z", "type": "commit"}, {"oid": "36b7be6b44b24a506783648c4eeeb58fb942c023", "url": "https://github.com/dashevo/dash-wallet/commit/36b7be6b44b24a506783648c4eeeb58fb942c023", "message": "Change method of submitting bloom filters", "committedDate": "2020-09-25T18:34:35Z", "type": "commit"}, {"oid": "c1a8d002665d6365f421b5b67cf29dd9cb7a3d69", "url": "https://github.com/dashevo/dash-wallet/commit/c1a8d002665d6365f421b5b67cf29dd9cb7a3d69", "message": "Fix recovery of passphrase", "committedDate": "2020-09-29T16:23:40Z", "type": "commit"}, {"oid": "cc9449946f8dfd05c38212706579e6d22a14952a", "url": "https://github.com/dashevo/dash-wallet/commit/cc9449946f8dfd05c38212706579e6d22a14952a", "message": "Refactor DashPayProfile", "committedDate": "2020-09-29T16:37:21Z", "type": "commit"}, {"oid": "5964f05eb56c7d42d01f1e1b5d4d084f4f6d1c50", "url": "https://github.com/dashevo/dash-wallet/commit/5964f05eb56c7d42d01f1e1b5d4d084f4f6d1c50", "message": "Merge branch 'evonet-develop' of https://github.com/dashevo/dash-wallet into dpp-0.15", "committedDate": "2020-09-29T18:21:39Z", "type": "commit"}, {"oid": "15f7ef210c3b2a4b710726c52c6f46a0350f60da", "url": "https://github.com/dashevo/dash-wallet/commit/15f7ef210c3b2a4b710726c52c6f46a0350f60da", "message": "Merge branch 'dpp-0.15' of https://github.com/dashevo/dash-wallet into chain-sync-phase-3a", "committedDate": "2020-09-29T18:45:40Z", "type": "commit"}, {"oid": "858f89f01c04abec252b520b13ffd642d7c7f46e", "url": "https://github.com/dashevo/dash-wallet/commit/858f89f01c04abec252b520b13ffd642d7c7f46e", "message": "CreateIdentityService: remove commented code", "committedDate": "2020-09-30T15:25:44Z", "type": "commit"}, {"oid": "5bbc6bf4fb3f25285938415403ae3386297e3658", "url": "https://github.com/dashevo/dash-wallet/commit/5bbc6bf4fb3f25285938415403ae3386297e3658", "message": "PlatformRepo: Fix loading of blockchainIdentity from Database", "committedDate": "2020-09-30T15:27:02Z", "type": "commit"}, {"oid": "66f955eca73ab75af529904f6b80e91a799994e5", "url": "https://github.com/dashevo/dash-wallet/commit/66f955eca73ab75af529904f6b80e91a799994e5", "message": "ReceiveInfoView: Use observer to get profile information\n\nFixes crash", "committedDate": "2020-09-30T15:27:56Z", "type": "commit"}, {"oid": "1b86ba48be297898cb5cee2e7d97971394f4fb20", "url": "https://github.com/dashevo/dash-wallet/commit/1b86ba48be297898cb5cee2e7d97971394f4fb20", "message": "MoreFragment: Show the user profile only if the user has registered on PlatformRepo.kt\n\nThis resolves a crash when accessing the More menu before registring a username", "committedDate": "2020-09-30T22:33:25Z", "type": "commit"}, {"oid": "67bc825f3c23af4148ea4a932cabcec43150b9cc", "url": "https://github.com/dashevo/dash-wallet/commit/67bc825f3c23af4148ea4a932cabcec43150b9cc", "message": "PlatformRepo: Modify blockchainIdentity creation depending user registration state", "committedDate": "2020-09-30T22:34:42Z", "type": "commit"}, {"oid": "983529e01a4381dc89932979bb018a948a197c03", "url": "https://github.com/dashevo/dash-wallet/commit/983529e01a4381dc89932979bb018a948a197c03", "message": "Merge branch 'evonet-develop' of https://github.com/dashevo/dash-wallet into chain-sync-phase-3a", "committedDate": "2020-09-30T22:47:04Z", "type": "commit"}, {"oid": "41e73aa7aab094f18c8abfe4e9f1f97bf57660f0", "url": "https://github.com/dashevo/dash-wallet/commit/41e73aa7aab094f18c8abfe4e9f1f97bf57660f0", "message": "Add create/update profile functionality to EditProfile and More", "committedDate": "2020-10-02T20:11:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2ODk1Mw==", "url": "https://github.com/dashevo/dash-wallet/pull/520#discussion_r499068953", "bodyText": "The purpose of this method is to support the updating the profile if it was changed on another device.\nHowever, one the user starts typing, then the observer is removed.\nOriginally, I had the observer turned back on after the update operation was successful and finished, but then the observer is called with the previous values in the profile and then the screen would change all the text fields back to the previous values.  Though, if one goes back to the More screen, then he newly changed Display Name would show up.\nFor now, after editing, then the View is no longer live.  This may actually be a bad idea to have the view being live.  It is perhaps unlikely that a user would update their profile on two devices at the same time.", "author": "HashEngineering", "createdAt": "2020-10-02T22:04:29Z", "path": "wallet/src/de/schildbach/wallet/ui/EditProfileActivity.kt", "diffHunk": "@@ -116,8 +161,25 @@ class EditProfileActivity : BaseMenuActivity() {\n             dashpayUserAvatar.setImageDrawable(defaultAvatar)\n         }\n \n-        aboutMe.setText(profile.publicMessage)\n-        displayName.setText(profile.displayName)\n+        about_me.setText(profile.publicMessage)\n+        display_name.setText(profile.displayName)\n+    }\n+\n+    // This method works well when it is called the first time,\n+    // but when it is called after updating the profile, `it` is the old profile\n+    private val dashPayProfileObserver = Observer<DashPayProfile?> {\n+        if (it != null) {\n+            dashPayProfile = it\n+            showProfileInfo(it)\n+        }\n+    }\n+\n+    private fun setEditingState(isEditing: Boolean) {\n+        if (!isEditing) {\n+            editProfileViewModel.dashPayProfileData.observe(this, dashPayProfileObserver)\n+        } else {\n+            editProfileViewModel.dashPayProfileData.removeObserver(dashPayProfileObserver)", "originalCommit": "41e73aa7aab094f18c8abfe4e9f1f97bf57660f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2OTc1NQ==", "url": "https://github.com/dashevo/dash-wallet/pull/520#discussion_r499069755", "bodyText": "This observer seems to be called after a update operation is finished in the EditProfileActivity and the user returns to the More Screen.", "author": "HashEngineering", "createdAt": "2020-10-02T22:07:15Z", "path": "wallet/src/de/schildbach/wallet/ui/MoreFragment.kt", "diffHunk": "@@ -66,14 +78,54 @@ class MoreFragment : Fragment(R.layout.activity_more) {\n                     WalletApplication.getInstance()).show()\n         }\n \n+        update_profile_status_container.visibility = View.GONE\n+\n         val blockchainIdentity = PlatformRepo.getInstance().getBlockchainIdentity()\n         if (blockchainIdentity != null && blockchainIdentity.registrationStatus == BlockchainIdentity.RegistrationStatus.REGISTERED) {\n-            AppDatabase.getAppDatabase().dashPayProfileDaoAsync().loadByUserIdDistinct(blockchainIdentity.uniqueIdString)\n+            editProfileViewModel.dashPayProfileData\n                     .observe(viewLifecycleOwner, Observer {\n                         if (it != null) {\n+                            dashPayProfile = it\n                             showProfileSection(it)\n                         }\n                     })\n+\n+            //show updating profile animation if necessary\n+\n+            editProfileViewModel.updateProfileRequestState.observe(context!!.lifecycleOwner()!!, Observer {\n+                if (it != null && it.containsKey(dashPayProfile.userId)) {\n+                    val state = it[dashPayProfile.userId]\n+                    when(state!!.status) {\n+                        Status.SUCCESS -> {\n+                            Toast.makeText(requireActivity(), \"Update successful\", Toast.LENGTH_LONG).show()\n+                            update_profile_status_container.visibility = View.GONE\n+                            editProfile.visibility = View.VISIBLE\n+                        }\n+                        Status.ERROR -> {\n+                            var msg = state.message\n+                            if (msg == null) {\n+                                msg = \"!!Error!!  ${state.exception!!.message}\"\n+                            }\n+                            Toast.makeText(requireActivity(), msg, Toast.LENGTH_LONG).show()\n+                            update_profile_status_container.visibility = View.VISIBLE\n+                            update_status_text.text = msg\n+                            editProfile.visibility = View.VISIBLE\n+                        }\n+                        Status.LOADING -> {\n+                            Toast.makeText(requireActivity(), \"Processing update\", Toast.LENGTH_LONG).show()\n+                            update_profile_status_container.visibility = View.VISIBLE\n+                            editProfile.visibility = View.GONE\n+                        }\n+                        Status.CANCELED -> {\n+                            update_profile_status_container.visibility = View.VISIBLE\n+                            update_status_text.text = \"Cancelled\" //hard coded text\n+                            editProfile.visibility = View.VISIBLE\n+                        }\n+                    }", "originalCommit": "41e73aa7aab094f18c8abfe4e9f1f97bf57660f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d4fb187aa9242eb6fc04d6da6f194e15a8d06023", "url": "https://github.com/dashevo/dash-wallet/commit/d4fb187aa9242eb6fc04d6da6f194e15a8d06023", "message": "Simplify Worker and Operation", "committedDate": "2020-10-05T18:04:58Z", "type": "commit"}, {"oid": "ee5a72d54be47197b7797b426b057b4a947987c8", "url": "https://github.com/dashevo/dash-wallet/commit/ee5a72d54be47197b7797b426b057b4a947987c8", "message": "Further simplifications and error handling", "committedDate": "2020-10-05T18:33:45Z", "type": "commit"}, {"oid": "693dec1e70184ffa1b608ad7b0bed82f90b2a02c", "url": "https://github.com/dashevo/dash-wallet/commit/693dec1e70184ffa1b608ad7b0bed82f90b2a02c", "message": "Rename UpdateProfileRequestWorker to UpdateProfileWorker", "committedDate": "2020-10-05T18:47:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgwNjE5Nw==", "url": "https://github.com/dashevo/dash-wallet/pull/520#discussion_r499806197", "bodyText": "This is where I thought we could turn the observer back ON, but it the data loaded was old.", "author": "HashEngineering", "createdAt": "2020-10-05T18:57:36Z", "path": "wallet/src/de/schildbach/wallet/ui/EditProfileActivity.kt", "diffHunk": "@@ -104,6 +113,41 @@ class EditProfileActivity : BaseMenuActivity() {\n             }\n \n         })\n+\n+        editProfileViewModel.updateProfileRequestState.observe(this, Observer {\n+            if (it != null) {\n+                when (it.status) {\n+                    Status.SUCCESS -> {\n+                        Toast.makeText(this@EditProfileActivity, \"Update successful\", Toast.LENGTH_LONG).show()\n+                        //setEditingState(false) // if this line is here, then the Profile changes to the previous value (crazy?)", "originalCommit": "ee5a72d54be47197b7797b426b057b4a947987c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "748c6b2948635c1513cf16ea6252ef16ed885fea", "url": "https://github.com/dashevo/dash-wallet/commit/748c6b2948635c1513cf16ea6252ef16ed885fea", "message": "Change method of not updating from the database when editing", "committedDate": "2020-10-06T14:20:33Z", "type": "commit"}, {"oid": "8109f74e02a7432dd1e4bac2904f378178d049e1", "url": "https://github.com/dashevo/dash-wallet/commit/8109f74e02a7432dd1e4bac2904f378178d049e1", "message": "Add space in the character count string", "committedDate": "2020-10-06T14:20:51Z", "type": "commit"}, {"oid": "e7f235e571d6452bc791db64c11407f65edf0b63", "url": "https://github.com/dashevo/dash-wallet/commit/e7f235e571d6452bc791db64c11407f65edf0b63", "message": "Make the observer \"inline\" since it is only used once", "committedDate": "2020-10-06T14:30:19Z", "type": "commit"}, {"oid": "9a0d022136d2ef8d171da78c3571a3e8f0678aab", "url": "https://github.com/dashevo/dash-wallet/commit/9a0d022136d2ef8d171da78c3571a3e8f0678aab", "message": "Merge branch 'evonet-develop' of https://github.com/dashevo/dash-wallet into dashpay-update-profile\n\n# Conflicts:\n#\twallet/src/de/schildbach/wallet/WalletApplication.java\n#\twallet/src/de/schildbach/wallet/data/DashPayProfile.kt\n#\twallet/src/de/schildbach/wallet/service/BlockchainServiceImpl.java\n#\twallet/src/de/schildbach/wallet/ui/MoreFragment.kt\n#\twallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt\n#\twallet/src/de/schildbach/wallet/ui/widget/ReceiveInfoView.kt", "committedDate": "2020-10-07T15:25:35Z", "type": "commit"}, {"oid": "e4302d9b498f9483fc47dc19f0ec2479c6085211", "url": "https://github.com/dashevo/dash-wallet/commit/e4302d9b498f9483fc47dc19f0ec2479c6085211", "message": "Fix a crash if the screen is changed while the operation is underway", "committedDate": "2020-10-07T15:45:08Z", "type": "commit"}, {"oid": "5c457892a1cec05531168c13516f2e6c5d6933d1", "url": "https://github.com/dashevo/dash-wallet/commit/5c457892a1cec05531168c13516f2e6c5d6933d1", "message": "Remove the 10 seconds of delays", "committedDate": "2020-10-07T15:45:34Z", "type": "commit"}, {"oid": "0299cbf61fe905c3fe7831aebf797ddd4418e61f", "url": "https://github.com/dashevo/dash-wallet/commit/0299cbf61fe905c3fe7831aebf797ddd4418e61f", "message": "Fix crash when accessing More menu without username", "committedDate": "2020-10-08T15:13:41Z", "type": "commit"}, {"oid": "c93fe4ff9e1cb51ed56666bbc4086fa8b3e5c048", "url": "https://github.com/dashevo/dash-wallet/commit/c93fe4ff9e1cb51ed56666bbc4086fa8b3e5c048", "message": "Merge branch 'evonet-develop' of https://github.com/dashevo/dash-wallet into dashpay-update-profile", "committedDate": "2020-10-08T17:04:43Z", "type": "commit"}, {"oid": "f5c6d85b1ccfc27a9522cde0a7f0d3c791e4da00", "url": "https://github.com/dashevo/dash-wallet/commit/f5c6d85b1ccfc27a9522cde0a7f0d3c791e4da00", "message": "Fixed crash reported by QA, minor code refactoring", "committedDate": "2020-10-08T19:25:43Z", "type": "commit"}, {"oid": "7a3fe3d7e9dde7296b3200011099c981c7ae8642", "url": "https://github.com/dashevo/dash-wallet/commit/7a3fe3d7e9dde7296b3200011099c981c7ae8642", "message": "Merge branch 'dashpay-update-profile' of https://github.com/dashevo/dash-wallet into dashpay-update-profile", "committedDate": "2020-10-08T21:25:02Z", "type": "commit"}, {"oid": "fd69f50101511150f40a1735fb2a6853659b29d5", "url": "https://github.com/dashevo/dash-wallet/commit/fd69f50101511150f40a1735fb2a6853659b29d5", "message": "Fix crash when accessing profile data and update an error message", "committedDate": "2020-10-08T22:19:51Z", "type": "commit"}, {"oid": "95220d76fa14d9f80a5cd8e848d2491164624c53", "url": "https://github.com/dashevo/dash-wallet/commit/95220d76fa14d9f80a5cd8e848d2491164624c53", "message": "After success, edit = false, after error edit = true", "committedDate": "2020-10-08T22:59:17Z", "type": "commit"}, {"oid": "5df8ad8f61b0292a1ff461486332ada37310610e", "url": "https://github.com/dashevo/dash-wallet/commit/5df8ad8f61b0292a1ff461486332ada37310610e", "message": "PlatformRepo: Fix exceptions when making profile or name (where in) queries\n\nRemove some comments", "committedDate": "2020-10-09T18:03:44Z", "type": "commit"}]}