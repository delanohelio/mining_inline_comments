{"pr_number": 527, "pr_title": "NMA-603 | (Contacts in) Transaction History | Home Screen", "pr_createdAt": "2020-10-09T08:33:38Z", "pr_url": "https://github.com/dashevo/dash-wallet/pull/527", "timeline": [{"oid": "700469f0ba68eb7a6a2fd71defe3d89ec15caef4", "url": "https://github.com/dashevo/dash-wallet/commit/700469f0ba68eb7a6a2fd71defe3d89ec15caef4", "message": "Created TransactionsViewModel and associated LiveDatas", "committedDate": "2020-10-08T00:41:29Z", "type": "commit"}, {"oid": "5dbe0c4de76a75fcf648033ce44b751e84dfb206", "url": "https://github.com/dashevo/dash-wallet/commit/5dbe0c4de76a75fcf648033ce44b751e84dfb206", "message": "Loading contacts into transactions adapter", "committedDate": "2020-10-09T08:31:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI3OTMwMA==", "url": "https://github.com/dashevo/dash-wallet/pull/527#discussion_r502279300", "bodyText": "Most of the below code should be handled by LiveData/ViewModel, however walletChangeReceiver part can be ignored since we do not use ACTION_WALLET_REFERENCE_CHANGED anymore (it is a legacy code).", "author": "tomasz-ludek", "createdAt": "2020-10-09T08:44:00Z", "path": "wallet/src/de/schildbach/wallet/ui/WalletTransactionsFragment.java", "diffHunk": "@@ -317,10 +272,8 @@ private void showEmptyView() {\n         recyclerView.setVisibility(View.INVISIBLE);\n     }\n \n-    @Override\n-    public void onLoaderReset(final Loader<List<Transaction>> loader) {\n-        // don't clear the adapter, because it will confuse users\n-    }\n+    //TODO: Do we need to handle this?", "originalCommit": "5dbe0c4de76a75fcf648033ce44b751e84dfb206", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMxMDEwOQ==", "url": "https://github.com/dashevo/dash-wallet/pull/527#discussion_r502310109", "bodyText": "As agreed with @tomasz-ludek , throttling will be implemented in #526.", "author": "sambarboza", "createdAt": "2020-10-09T09:38:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI3OTMwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI4MjkxOQ==", "url": "https://github.com/dashevo/dash-wallet/pull/527#discussion_r502282919", "bodyText": "the wallet val should be moved inside the method body", "author": "tomasz-ludek", "createdAt": "2020-10-09T08:50:04Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/TransactionsViewModel.kt", "diffHunk": "@@ -0,0 +1,95 @@\n+package de.schildbach.wallet.ui.dashpay\n+\n+import android.app.Application\n+import androidx.lifecycle.AndroidViewModel\n+import androidx.lifecycle.MediatorLiveData\n+import androidx.lifecycle.MutableLiveData\n+import androidx.lifecycle.viewModelScope\n+import de.schildbach.wallet.Constants\n+import de.schildbach.wallet.WalletApplication\n+import de.schildbach.wallet.data.DashPayProfile\n+import de.schildbach.wallet.data.UsernameSortOrderBy\n+import kotlinx.coroutines.launch\n+import org.bitcoinj.core.Context\n+import org.bitcoinj.core.Sha256Hash\n+import org.bitcoinj.core.Transaction\n+import org.bitcoinj.core.TransactionConfidence\n+import org.bitcoinj.wallet.Wallet\n+import java.util.*\n+import kotlin.collections.HashMap\n+\n+class TransactionsViewModel(application: Application) : AndroidViewModel(application) {\n+\n+    enum class Direction {\n+        RECEIVED, SENT\n+    }\n+\n+    val direction = MutableLiveData<Direction?>()\n+    val transactionsLiveData = MediatorLiveData<Pair<List<Transaction>,\n+            Map<Sha256Hash, DashPayProfile>>>()\n+    private val balanceLiveData = WalletBalanceLiveData()\n+\n+    init {\n+        load()\n+        transactionsLiveData.addSource(direction) {\n+            load()\n+        }\n+        transactionsLiveData.addSource(balanceLiveData) {\n+            load()\n+        }\n+    }\n+\n+    fun load(wallet: Wallet = WalletApplication.getInstance().wallet) {", "originalCommit": "5dbe0c4de76a75fcf648033ce44b751e84dfb206", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMxMDQ0Mg==", "url": "https://github.com/dashevo/dash-wallet/pull/527#discussion_r502310442", "bodyText": "Fixed in 55f7a80", "author": "sambarboza", "createdAt": "2020-10-09T09:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI4MjkxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI4Mzk1OA==", "url": "https://github.com/dashevo/dash-wallet/pull/527#discussion_r502283958", "bodyText": "This part will be changed by #526 but is ok for this PR", "author": "tomasz-ludek", "createdAt": "2020-10-09T08:52:01Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/TransactionsViewModel.kt", "diffHunk": "@@ -0,0 +1,95 @@\n+package de.schildbach.wallet.ui.dashpay\n+\n+import android.app.Application\n+import androidx.lifecycle.AndroidViewModel\n+import androidx.lifecycle.MediatorLiveData\n+import androidx.lifecycle.MutableLiveData\n+import androidx.lifecycle.viewModelScope\n+import de.schildbach.wallet.Constants\n+import de.schildbach.wallet.WalletApplication\n+import de.schildbach.wallet.data.DashPayProfile\n+import de.schildbach.wallet.data.UsernameSortOrderBy\n+import kotlinx.coroutines.launch\n+import org.bitcoinj.core.Context\n+import org.bitcoinj.core.Sha256Hash\n+import org.bitcoinj.core.Transaction\n+import org.bitcoinj.core.TransactionConfidence\n+import org.bitcoinj.wallet.Wallet\n+import java.util.*\n+import kotlin.collections.HashMap\n+\n+class TransactionsViewModel(application: Application) : AndroidViewModel(application) {\n+\n+    enum class Direction {\n+        RECEIVED, SENT\n+    }\n+\n+    val direction = MutableLiveData<Direction?>()\n+    val transactionsLiveData = MediatorLiveData<Pair<List<Transaction>,\n+            Map<Sha256Hash, DashPayProfile>>>()\n+    private val balanceLiveData = WalletBalanceLiveData()\n+\n+    init {\n+        load()\n+        transactionsLiveData.addSource(direction) {\n+            load()\n+        }\n+        transactionsLiveData.addSource(balanceLiveData) {\n+            load()\n+        }\n+    }\n+\n+    fun load(wallet: Wallet = WalletApplication.getInstance().wallet) {\n+        viewModelScope.launch {\n+            Context.propagate(Constants.CONTEXT)\n+\n+            val contactsTransactions: HashMap<Sha256Hash, DashPayProfile> = hashMapOf()\n+            val contactsByIdentity: HashMap<String, DashPayProfile> = hashMapOf()\n+            val platformRepo = PlatformRepo.getInstance()\n+            val userIdentity = platformRepo.getBlockchainIdentity()\n+            if (userIdentity != null) {\n+                val contacts = PlatformRepo.getInstance().searchContacts(\"\",\n+                        UsernameSortOrderBy.LAST_ACTIVITY, false)\n+                contacts.data?.forEach {\n+                    contactsByIdentity[it.dashPayProfile.userId] = it.dashPayProfile\n+                }\n+            }\n+\n+            val transactions = wallet.getTransactions(true)\n+            val filteredTransactions = arrayListOf<Transaction>()\n+            transactions.filterTo(filteredTransactions, {\n+                val sent = it.getValue(wallet).signum() < 0\n+                val isInternal = it.purpose == Transaction.Purpose.KEY_ROTATION\n+                direction.value == Direction.RECEIVED && !sent\n+                        && !isInternal || direction.value == null ||\n+                        direction.value == Direction.SENT && sent && !isInternal\n+            })", "originalCommit": "5dbe0c4de76a75fcf648033ce44b751e84dfb206", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2af9750b1af3890f7cbc5839affea3ceb3f2b884", "url": "https://github.com/dashevo/dash-wallet/commit/2af9750b1af3890f7cbc5839affea3ceb3f2b884", "message": "Tx row layout changes", "committedDate": "2020-10-09T09:31:38Z", "type": "commit"}, {"oid": "55f7a80c91caee8315f35c12b42582a5b52f9f00", "url": "https://github.com/dashevo/dash-wallet/commit/55f7a80c91caee8315f35c12b42582a5b52f9f00", "message": "Moved wallet reference inside method body", "committedDate": "2020-10-09T09:35:26Z", "type": "commit"}, {"oid": "2c26a50365f537849b313d8794685ff844465cf2", "url": "https://github.com/dashevo/dash-wallet/commit/2c26a50365f537849b313d8794685ff844465cf2", "message": "Removed commented code.", "committedDate": "2020-10-09T10:10:08Z", "type": "commit"}]}