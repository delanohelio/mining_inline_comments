{"pr_number": 566, "pr_title": "NMA-602 | Contacts | Show users suggestions", "pr_createdAt": "2020-12-03T15:53:57Z", "pr_url": "https://github.com/dashevo/dash-wallet/pull/566", "timeline": [{"oid": "c1f0a49b2c1951243bf5660a1da036004d614b21", "url": "https://github.com/dashevo/dash-wallet/commit/c1f0a49b2c1951243bf5660a1da036004d614b21", "message": "Initial Layout", "committedDate": "2020-11-28T20:50:21Z", "type": "commit"}, {"oid": "337e251199a197a92f518db7f1fcc4d0bb4bbb9d", "url": "https://github.com/dashevo/dash-wallet/commit/337e251199a197a92f518db7f1fcc4d0bb4bbb9d", "message": "Suggestions layout", "committedDate": "2020-12-01T00:45:35Z", "type": "commit"}, {"oid": "33a7e9eada7b8c9d57cdf88a90f8f9ead174fcfd", "url": "https://github.com/dashevo/dash-wallet/commit/33a7e9eada7b8c9d57cdf88a90f8f9ead174fcfd", "message": "Adding user rows", "committedDate": "2020-12-01T02:04:59Z", "type": "commit"}, {"oid": "10be7a1d835e69412137d6d7efbd3f67b08d2d78", "url": "https://github.com/dashevo/dash-wallet/commit/10be7a1d835e69412137d6d7efbd3f67b08d2d78", "message": "Showing username and avatar placeholder correctly", "committedDate": "2020-12-02T07:47:59Z", "type": "commit"}, {"oid": "69eef5a189b0add84a2b8ae003da65c0608ab12c", "url": "https://github.com/dashevo/dash-wallet/commit/69eef5a189b0add84a2b8ae003da65c0608ab12c", "message": "Limiting to 3 suggestions", "committedDate": "2020-12-02T09:51:22Z", "type": "commit"}, {"oid": "7215a54fe116b923c55fb84f61ee3cde2d70691a", "url": "https://github.com/dashevo/dash-wallet/commit/7215a54fe116b923c55fb84f61ee3cde2d70691a", "message": "Keep showing search bar", "committedDate": "2020-12-02T10:37:04Z", "type": "commit"}, {"oid": "98d7ab4d1818258028a437678b725c88089abf22", "url": "https://github.com/dashevo/dash-wallet/commit/98d7ab4d1818258028a437678b725c88089abf22", "message": "Empty suggestions layout.", "committedDate": "2020-12-03T15:35:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyNTU4MA==", "url": "https://github.com/dashevo/dash-wallet/pull/566#discussion_r535725580", "bodyText": "limit is set to 3 earlier in the process, but limit is supplied as the startAt argument of search\nCurrently, search does not support a limit parameter.\n    /**\n     * Searches for and returns a list of all name documents that match the given name based\n     * on these criteria: starts with.  Contains is not supported\n     * @param text String\n     * @param parentDomain String\n     * @param retrieveAll Boolean\n     * @param startAtIndex Int\n     * @return List<Documents>\n     */\n    fun search(text: String, parentDomain: String, retrieveAll: Boolean, startAtIndex: Int = 0): List<Document>", "author": "HashEngineering", "createdAt": "2020-12-03T23:36:59Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -195,13 +195,14 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n      */\n \n     @Throws(Exception::class)\n-    suspend fun searchUsernames(text: String, onlyExactUsername: Boolean = false): List<UsernameSearchResult> {\n+    suspend fun searchUsernames(text: String, onlyExactUsername: Boolean = false, limit: Int = -1): List<UsernameSearchResult> {\n         val userIdString = blockchainIdentity.uniqueIdString\n         val userId = blockchainIdentity.uniqueIdentifier\n \n         // Names.search does support retrieving 100 names at a time if retrieveAll = false\n         //TODO: Maybe add pagination later? Is very unlikely that a user will scroll past 100 search results\n-        val nameDocuments = platform.names.search(text, Names.DEFAULT_PARENT_DOMAIN, false)\n+        val nameDocuments = platform.names.search(text, Names.DEFAULT_PARENT_DOMAIN,\n+                false, limit)", "originalCommit": "98d7ab4d1818258028a437678b725c88089abf22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyNzQ3Mw==", "url": "https://github.com/dashevo/dash-wallet/pull/566#discussion_r535727473", "bodyText": "if startAtIndex is set to 3, then no results are returned if there are less than 3 items that match the search.\nOn the Search username screen, the limit is set to 100, so the first 100 usernames are ignored.", "author": "HashEngineering", "createdAt": "2020-12-03T23:41:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyNTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyODUxMQ==", "url": "https://github.com/dashevo/dash-wallet/pull/566#discussion_r535728511", "bodyText": "There are two solutions:\n\nPrune search results to match the limit\nadd a limit parameter in the dashpay/platform library for Names.search", "author": "HashEngineering", "createdAt": "2020-12-03T23:44:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyNTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwMDQ5NA==", "url": "https://github.com/dashevo/dash-wallet/pull/566#discussion_r538800494", "bodyText": "Since dashpay PR https://github.com/dashevo/android-dashpay/pull/30/files#diff-4aaba3784c9fd97aaa67d814745186f6d8fdd8c6e7faa8118eb398103bb73211R235 adds a limit parameter, shouldn't your code have a limit = limit, otherwise limit is the value used for startAtIndex?\nThough when I tested this PR, it did display three results, but not sure if they were the first three or the second three.", "author": "HashEngineering", "createdAt": "2020-12-08T20:55:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyNTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg0NzgyMg==", "url": "https://github.com/dashevo/dash-wallet/pull/566#discussion_r543847822", "bodyText": "Fixed on bb9ff71", "author": "sambarboza", "createdAt": "2020-12-16T02:38:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyNTU4MA=="}], "type": "inlineReview"}, {"oid": "87a1a1343c927948a2a81b99371353a5b3f36a2a", "url": "https://github.com/dashevo/dash-wallet/commit/87a1a1343c927948a2a81b99371353a5b3f36a2a", "message": "Fixed empty/initial state", "committedDate": "2020-12-04T01:12:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3MzA4Mg==", "url": "https://github.com/dashevo/dash-wallet/pull/566#discussion_r536373082", "bodyText": "if query is \"\" (empty) then we shouldn't execute the search.\nI/DapiClient: [DefaultDispatcher-worker-3] getDocuments(H9AxLAvgxEpq72pDg41nsqR3bY5Cv9hTT6yZdKzY3PaE, domain, {limit=3, orderBy=[[normalizedLabel, asc]], where=[[normalizedParentDomainName, ==, dash], [normalizedLabel, startsWith, ]], startAt=0})\n...\nW/DapiClient: [DefaultDispatcher-worker-3] RPC failed with 34.216.205.76: Status{code=INVALID_ARGUMENT, description=Invalid query: should be equal to one of the allowed values, cause=null}: Metadata(server=nginx/1.19.3,date=Fri, 04 Dec 2020 20:41:46 GMT,content-type=application/grpc,content-length=0,errors=[{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"enum\",\"dataPath\":\".where[1][1]\",\"schemaPath\":\"#/properties/where/items/oneOf/0/items/1/enum\",\"params\":{\"allowedValues\":[\"<\",\"<=\",\"==\",\">\",\">=\"]}},{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"enum\",\"dataPath\":\".where[1][0]\",\"schemaPath\":\"#/properties/where/items/oneOf/1/items/0/enum\",\"params\":{\"allowedValues\":[\"$createdAt\",\"$updatedAt\"]}},{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"const\",\"dataPath\":\".where[1][1]\",\"schemaPath\":\"#/properties/where/items/oneOf/2/items/1/const\",\"params\":{\"allowedValue\":\"in\"}},{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"minLength\",\"dataPath\":\".where[1][2]\",\"schemaPath\":\"#/properties/where/items/oneOf/3/items/2/minLength\",\"params\":{\"limit\":1}},{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"const\",\"dataPath\":\".where[1][1]\",\"schemaPath\":\"#/properties/where/items/oneOf/4/items/1/const\",\"params\":{\"allowedValue\":\"elementMatch\"}},{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"const\",\"dataPath\":\".where[1][1]\",\"schemaPath\":\"#/properties/where/items/oneOf/5/items/1/const\",\"params\":{\"allowedValue\":\"length\"}},{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"const\",\"dataPath\":\".where[1][1]\",\"schemaPath\":\"#/properties/where/items/oneOf/6/items/1/const\",\"params\":{\"allowedValue\":\"contains\"}},{\"name\":\"JsonSchemaValidationError\",\"keyword\":\"oneOf\",\"dataPath\":\".where[1]\",\"schemaPath\":\"#/properties/where/items/oneOf\",\"params\":{\"passingSchemas\":null}}])\n..\nE/Documents: [DefaultDispatcher-worker-3] Document creation: unable to get documents of H9AxLAvgxEpq72pDg41nsqR3bY5Cv9hTT6yZdKzY3PaE: io.grpc.StatusRuntimeException: INVALID_ARGUMENT: Invalid query: should be equal to one of the allowed values\nE/DashPayViewModel: [DefaultDispatcher-worker-3] search usernames: INVALID_ARGUMENT: Invalid query: should be equal to one of the allowed values", "author": "HashEngineering", "createdAt": "2020-12-04T20:52:59Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/ContactsFragment.kt", "diffHunk": "@@ -123,12 +136,18 @@ class ContactsFragment : Fragment(R.layout.fragment_contacts_root), TextWatcher,\n                 if (initialSearch && (mode != MODE_VIEW_REQUESTS)) {\n                     if (it.data == null || it.data.isEmpty() || it.data.find { u -> u.requestReceived } == null) {\n                         empty_state_pane.visibility = View.VISIBLE\n-                        contacts_pane.visibility = View.GONE\n+                        search.visibility = View.GONE\n+                        icon.visibility = View.GONE\n                     } else {\n+                        search.visibility = View.VISIBLE\n+                        icon.visibility = View.VISIBLE\n                         empty_state_pane.visibility = View.GONE\n-                        contacts_pane.visibility = View.VISIBLE\n                     }\n                     initialSearch = false\n+                } else {\n+                    if (it.data == null || it.data.isEmpty()) {\n+                        dashPayViewModel.searchUsernames(query, 3)", "originalCommit": "87a1a1343c927948a2a81b99371353a5b3f36a2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg3MTkyMg==", "url": "https://github.com/dashevo/dash-wallet/pull/566#discussion_r543871922", "bodyText": "Fixed in 1c633ae", "author": "sambarboza", "createdAt": "2020-12-16T03:09:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3MzA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA2NjAzMw==", "url": "https://github.com/dashevo/dash-wallet/pull/566#discussion_r544066033", "bodyText": "Excellent.", "author": "HashEngineering", "createdAt": "2020-12-16T07:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3MzA4Mg=="}], "type": "inlineReview"}, {"oid": "3ff044a6f3d124a8c1b947e7894d67d2bd8a26ec", "url": "https://github.com/dashevo/dash-wallet/commit/3ff044a6f3d124a8c1b947e7894d67d2bd8a26ec", "message": "Layout adjustments", "committedDate": "2020-12-11T08:32:35Z", "type": "commit"}, {"oid": "24d4bc68f441567bb21897566d78529aafcaee88", "url": "https://github.com/dashevo/dash-wallet/commit/24d4bc68f441567bb21897566d78529aafcaee88", "message": "resetting initalSearch flag  whwhen leaving contact fragments", "committedDate": "2020-12-15T22:35:20Z", "type": "commit"}, {"oid": "8df5ee4008d6e5824354aa13cc9b294e3cf55da9", "url": "https://github.com/dashevo/dash-wallet/commit/8df5ee4008d6e5824354aa13cc9b294e3cf55da9", "message": "Merge branch 'dashpay-user-suggestion-contact-search' of github.com:dashevo/dash-wallet into dashpay-user-suggestion-contact-search", "committedDate": "2020-12-15T22:35:31Z", "type": "commit"}, {"oid": "3f87ac53621983f58eb17303bf54556790789d34", "url": "https://github.com/dashevo/dash-wallet/commit/3f87ac53621983f58eb17303bf54556790789d34", "message": "Merge branch 'evonet-develop' into dashpay-user-suggestion-contact-search", "committedDate": "2020-12-15T23:02:53Z", "type": "commit"}, {"oid": "bb9ff717fb723cc2088b9acd8ab19245975db2c3", "url": "https://github.com/dashevo/dash-wallet/commit/bb9ff717fb723cc2088b9acd8ab19245975db2c3", "message": "fixed user search", "committedDate": "2020-12-16T02:34:20Z", "type": "commit"}, {"oid": "1c633ae301fccf67b410a4ded440bcc3c56485a2", "url": "https://github.com/dashevo/dash-wallet/commit/1c633ae301fccf67b410a4ded440bcc3c56485a2", "message": "Preventing search for empty string", "committedDate": "2020-12-16T03:07:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA2ODkyMw==", "url": "https://github.com/dashevo/dash-wallet/pull/566#discussion_r544068923", "bodyText": "This solution relies on https://github.com/dashevo/android-dashpay/pull/30/files which has merge conflicts due to parameter order differences with Names.search.  Either the merge conflicts on the previously mentioned android-dashpay PR must be resolved or the parameter order must be changed here.", "author": "HashEngineering", "createdAt": "2020-12-16T07:24:08Z", "path": "wallet/src/de/schildbach/wallet/ui/dashpay/PlatformRepo.kt", "diffHunk": "@@ -195,13 +195,14 @@ class PlatformRepo private constructor(val walletApplication: WalletApplication)\n      */\n \n     @Throws(Exception::class)\n-    suspend fun searchUsernames(text: String, onlyExactUsername: Boolean = false): List<UsernameSearchResult> {\n+    suspend fun searchUsernames(text: String, onlyExactUsername: Boolean = false, limit: Int = -1): List<UsernameSearchResult> {\n         val userIdString = blockchainIdentity.uniqueIdString\n         val userId = blockchainIdentity.uniqueIdentifier\n \n         // Names.search does support retrieving 100 names at a time if retrieveAll = false\n         //TODO: Maybe add pagination later? Is very unlikely that a user will scroll past 100 search results\n-        val nameDocuments = platform.names.search(text, Names.DEFAULT_PARENT_DOMAIN, false)\n+        val nameDocuments = platform.names.search(text, Names.DEFAULT_PARENT_DOMAIN,", "originalCommit": "1c633ae301fccf67b410a4ded440bcc3c56485a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc2NTE3OA==", "url": "https://github.com/dashevo/dash-wallet/pull/566#discussion_r544765178", "bodyText": "Well spotted!\nFixed on 8fa8341", "author": "sambarboza", "createdAt": "2020-12-17T02:30:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA2ODkyMw=="}], "type": "inlineReview"}, {"oid": "8fa83414a5a5a464b4055d4efd40d6d350efccbc", "url": "https://github.com/dashevo/dash-wallet/commit/8fa83414a5a5a464b4055d4efd40d6d350efccbc", "message": "fixed Names.search params", "committedDate": "2020-12-17T02:29:03Z", "type": "commit"}, {"oid": "cdfd7e045ad718c985c889ea400b46fbd8dc9e32", "url": "https://github.com/dashevo/dash-wallet/commit/cdfd7e045ad718c985c889ea400b46fbd8dc9e32", "message": "fixed crash on empty results.", "committedDate": "2020-12-17T23:15:11Z", "type": "commit"}, {"oid": "518f9f46217b2a716f7abd1c0d6cccba38104c01", "url": "https://github.com/dashevo/dash-wallet/commit/518f9f46217b2a716f7abd1c0d6cccba38104c01", "message": "resetting inital state after deleting query", "committedDate": "2020-12-24T01:49:32Z", "type": "commit"}]}