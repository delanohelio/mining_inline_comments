{"pr_number": 1021, "pr_title": "feat(ProjectTodo): Remove ProjectTodo and UI changes for Obligation and ProjectTodo ", "pr_createdAt": "2020-10-15T10:45:44Z", "pr_url": "https://github.com/eclipse/sw360/pull/1021", "timeline": [{"oid": "cb8902187ac84f536de2f32d62dac2e6a57654cf", "url": "https://github.com/eclipse/sw360/commit/cb8902187ac84f536de2f32d62dac2e6a57654cf", "message": "feat(ProjectTodo): Renamed type to obligationType ,Changed required licenseIds to optional , Added optional ObligationLevel obligationLevel in ObligationStatusInfo\n\nSigned-off-by: Jaideep Palit <jaideep.palit@siemens.com>", "committedDate": "2020-10-15T10:26:34Z", "type": "commit"}, {"oid": "45b5ecfdac48a05718e7cefa454a6a9496a6864b", "url": "https://github.com/eclipse/sw360/commit/45b5ecfdac48a05718e7cefa454a6a9496a6864b", "message": "feat(ProjectTodo): Remove ProjectTodo and UI changes for Obligation and ProjectTodo\n\nSigned-off-by: Jaideep Palit <jaideep.palit@siemens.com>", "committedDate": "2020-10-15T12:13:07Z", "type": "forcePushed"}, {"oid": "6752f728d65d12eb0c0d5d6b9cdb47fe4531a051", "url": "https://github.com/eclipse/sw360/commit/6752f728d65d12eb0c0d5d6b9cdb47fe4531a051", "message": "feat(ProjectTodo): Remove ProjectTodo and UI changes for Obligation and ProjectTodo\n\nSigned-off-by: Jaideep Palit <jaideep.palit@siemens.com>", "committedDate": "2020-10-16T08:41:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI0NzE0MQ==", "url": "https://github.com/eclipse/sw360/pull/1021#discussion_r506247141", "bodyText": "It would be good to have valid variable name in place of x", "author": "JaideepPalit", "createdAt": "2020-10-16T10:01:18Z", "path": "scripts/migrations/037_checkfor_project_todos_in_moderations.py", "diffHunk": "@@ -0,0 +1,152 @@\n+#!/usr/bin/python\n+# -----------------------------------------------------------------------------\n+# Copyright Siemens AG, 2020. Part of the SW360 Portal Project.\n+#\n+# This program and the accompanying materials are made\n+# available under the terms of the Eclipse Public License 2.0\n+# which is available at https://www.eclipse.org/legal/epl-2.0/\n+#\n+# SPDX-License-Identifier: EPL-2.0\n+#\n+# This is a manual database migration script. It is assumed that a\n+# dedicated framework for automatic migration will be written in the\n+# future. When that happens, this script should be refactored to conform\n+# to the framework's prerequisites to be run by the framework. For\n+# example, server address and db name should be parameterized, the code\n+# reorganized into a single class or function, etc.\n+#\n+# This script checks if any project moderation requests contains todos with data and show a warning message to work on the same\n+# before proceeding with further migration scriptsor else delete the empty todos field from the moderation request.\n+# ---------------------------------------------------------------------------------------------------------------------------\n+\n+import time\n+import couchdb\n+import json\n+from webbrowser import get\n+\n+# ---------------------------------------\n+# constants\n+# ---------------------------------------\n+\n+DRY_RUN = True\n+\n+COUCHSERVER = \"http://localhost:5984/\"\n+DBNAME = 'sw360db'\n+\n+couch = couchdb.Server(COUCHSERVER)\n+db = couch[DBNAME]\n+\n+# ----------------------------------------\n+# queries\n+# ----------------------------------------\n+\n+# get all project moderations with todos\n+all_project_moderations = {\"selector\": {\"type\": {\"$eq\": \"moderation\"},\"documentType\": {\"$eq\": \"PROJECT\"},\"$or\": [{\"projectAdditions\": {\"todos\":{\"$exists\":True}}},{\"projectDeletions\": {\"todos\": {\"$exists\": True}}}]},\"limit\": 20000}\n+\n+# ---------------------------------------\n+# functions\n+# ---------------------------------------\n+\n+def checkEmptyTodosAnddeleteFromModeration(logFile, all_moderations):\n+    log = {}\n+    count = {}\n+    count[\"total\"] = str(len(all_moderations))\n+    log['projectModerationRequestsHavingEmptyTodos'] = []\n+    log['projectModerationRequestsHavingEmptyTodos'].append(count)\n+    todo = \"todos\"\n+    \n+    for moderation in all_moderations:\n+\n+        projectAdditions = moderation.get(\"projectAdditions\")\n+        projectDeletions = moderation.get(\"projectDeletions\")\n+\n+        todoslenghtinprojAddn = None\n+        todoslenghtinprojDeln = None\n+\n+        if todo in projectAdditions:\n+            todoslenghtinprojAddn = len(projectAdditions[\"todos\"])\n+\n+        if todo in projectDeletions:\n+            todoslenghtinprojDeln = len(projectDeletions[\"todos\"])\n+\n+\n+        if todoslenghtinprojAddn == 0 and todoslenghtinprojDeln == 0:\n+            del(moderation[\"projectAdditions\"][\"todos\"])\n+            del(moderation[\"projectDeletions\"][\"todos\"])\n+        elif todoslenghtinprojAddn == 0 and todoslenghtinprojDeln is None:\n+            del(moderation[\"projectAdditions\"][\"todos\"])\n+        elif todoslenghtinprojAddn is None and todoslenghtinprojDeln == 0:\n+            del(moderation[\"projectDeletions\"][\"todos\"])\n+\n+        if not DRY_RUN:\n+            db.save(moderation)\n+\n+\n+        openModRequestList = {}\n+        openModRequestList['id'] = moderation.get('_id')\n+        log['projectModerationRequestsHavingEmptyTodos'].append(openModRequestList)\n+\n+    json.dump(log, logFile, indent = 4, sort_keys = True)\n+\n+def checkForFilledTodosInModeration(logFile, all_moderations):\n+    log = {}\n+    todo = \"todos\"\n+    log[\"moderation_requests_with_todos_having_data\"] = []\n+    moderationList = []\n+    mods = {}\n+    for moderation in all_moderations:\n+        projectAdditions = moderation.get(\"projectAdditions\")\n+        projectDeletions = moderation.get(\"projectDeletions\")\n+\n+        todoslenghtinprojAddn = None\n+        todoslenghtinprojDeln = None\n+\n+        if todo in projectAdditions:\n+            todoslenghtinprojAddn = len(projectAdditions[\"todos\"])\n+\n+        if todo in projectDeletions:\n+            todoslenghtinprojDeln = len(projectDeletions[\"todos\"])\n+\n+        if (todoslenghtinprojAddn is not None and todoslenghtinprojAddn > 0) or (todoslenghtinprojDeln is not None and todoslenghtinprojDeln > 0):\n+            moderationList.append(moderation.get(\"_id\"))\n+\n+    if len(moderationList) > 0:\n+        for x in moderationList:", "originalCommit": "15a4bf7e4be4628c6be160189d23f468ecc21e3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMwNzQ5NQ==", "url": "https://github.com/eclipse/sw360/pull/1021#discussion_r506307495", "bodyText": "refactored", "author": "smrutis1", "createdAt": "2020-10-16T11:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI0NzE0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI3MDY4Nw==", "url": "https://github.com/eclipse/sw360/pull/1021#discussion_r506270687", "bodyText": "(from discussion) - Id in obligationStatusInfo is for external id and not couch db doc id", "author": "JaideepPalit", "createdAt": "2020-10-16T10:30:16Z", "path": "scripts/migrations/039_projecttodo_to_obligationlist.py", "diffHunk": "@@ -0,0 +1,188 @@\n+#!/usr/bin/python\n+# -----------------------------------------------------------------------------\n+# Copyright Siemens AG, 2020. Part of the SW360 Portal Project.\n+#\n+# This program and the accompanying materials are made\n+# available under the terms of the Eclipse Public License 2.0\n+# which is available at https://www.eclipse.org/legal/epl-2.0/\n+#\n+# SPDX-License-Identifier: EPL-2.0\n+#\n+# This is a manual database migration script. It is assumed that a\n+# dedicated framework for automatic migration will be written in the\n+# future. When that happens, this script should be refactored to conform\n+# to the framework's prerequisites to be run by the framework. For\n+# example, server address and db name should be parameterized, the code\n+# reorganized into a single class or function, etc.\n+#\n+# This script merge copy todos from project to obligationList model and and removes the todos field from project\n+# -------------------------------------------------------------------------------------------------------------\n+\n+import time\n+import couchdb\n+import json\n+from webbrowser import get\n+\n+# ---------------------------------------\n+# constants\n+# ---------------------------------------\n+\n+DRY_RUN = True\n+\n+COUCHSERVER = \"http://localhost:5984/\"\n+DBNAME = 'sw360db'\n+USER_DBNAME = 'sw360users'\n+\n+couch = couchdb.Server(COUCHSERVER)\n+db = couch[DBNAME]\n+userdb = couch[USER_DBNAME]\n+\n+# ----------------------------------------\n+# queries\n+# ----------------------------------------\n+\n+# get all projects with todos\n+all_project_with_todos = {\"selector\": {\"type\": {\"$eq\": \"project\"}, \"todos\": {\"$exists\": True}}, \"limit\":20000}\n+\n+# ---------------------------------------\n+# functions\n+# ---------------------------------------\n+\n+def getOblTextNLevel(oblId):\n+    obltextNLevel = {}\n+    get_obligation_using_id = {\"selector\": {\"type\": {\"$eq\": \"obligation\"}, \"_id\": {\"$eq\": \"\"+oblId+\"\" }}}\n+    obligation = db.find(get_obligation_using_id)\n+    for obl in obligation:\n+        text = obl.get(\"text\")\n+        obllevel = obl.get(\"obligationLevel\")\n+        obltextNLevel[\"oblText\"] = text\n+        obltextNLevel[\"oblLevel\"] = obllevel\n+    \n+    return obltextNLevel\n+\n+def getDateOnly(dateWithTimes):\n+    return dateWithTimes.split()[0]\n+\n+def getEmailFromUserId(userid):\n+    emailId = \"\"\n+    get_user_by_id = {\"selector\": {\"type\": {\"$eq\": \"user\"}, \"_id\": {\"$eq\": \"\"+userid+\"\" }}}\n+    user = userdb.find(get_user_by_id)\n+    for usr in user:\n+        emailId = usr.get(\"email\")\n+\n+    return emailId\n+\n+def getLinkedObligationList(linkedOblId):\n+    oblList = []\n+    get_obligationList_by_id = {\"selector\": {\"type\": {\"$eq\": \"obligationList\"}, \"_id\": {\"$eq\": \"\"+linkedOblId+\"\" }}}\n+    obligationList = db.find(get_obligationList_by_id)\n+    for obList in obligationList:\n+        oblList = obList\n+    \n+    return oblList\n+\n+def mergeTodoWithObligationList(resultFile, all_projects):\n+    log = {}\n+    log['totalCount'] = len(all_projects)\n+    log['updatedProjectsWithobligationList'] = []\n+\n+    oblList = {}\n+    obligationStatusInfo = {}\n+    obligationStatusInfos = {}\n+\n+    for project in all_projects:\n+        linkedOblId = project.get(\"linkedObligationId\")\n+        todos = project.get(\"todos\")\n+        if len(todos) > 0:\n+            if linkedOblId is None:\n+                oblList[\"type\"] = 'obligationList'\n+                oblList[\"projectId\"] = project.get(\"_id\")\n+                for todo in todos:\n+                    todotext = getOblTextNLevel(todo.get(\"todoId\")).get(\"oblText\")\n+                    obligationLevel = getOblTextNLevel(todo.get(\"todoId\")).get(\"oblLevel\")\n+                    obligationStatusInfo[\"obligationLevel\"] = obligationLevel\n+                    obligationStatusInfo[\"text\"] = todotext\n+                    obligationStatusInfo[\"status\"] = 'FULFILLED' if todo.get(\"fulfilled\") == True else 'OPEN'\n+                    todocomment = todo.get(\"comments\")\n+                    obligationStatusInfo[\"comment\"] = todocomment if todocomment is not None else \"\"\n+                    obligationStatusInfo[\"modifiedOn\"] = getDateOnly(todo.get(\"updated\")) if todo.get(\"updated\") != \"\" else \"\"\n+                    obligationStatusInfo[\"modifiedBy\"] = getEmailFromUserId(todo.get(\"userId\"))\n+                    obligationStatusInfo[\"id\"] = todo.get(\"todoId\")", "originalCommit": "15a4bf7e4be4628c6be160189d23f468ecc21e3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMwNzIxMQ==", "url": "https://github.com/eclipse/sw360/pull/1021#discussion_r506307211", "bodyText": "removed it", "author": "smrutis1", "createdAt": "2020-10-16T11:15:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI3MDY4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI4MjIwMw==", "url": "https://github.com/eclipse/sw360/pull/1021#discussion_r506282203", "bodyText": "Please consider to remove commented methods from this file", "author": "smrutis1", "createdAt": "2020-10-16T10:44:35Z", "path": "backend/src/src-licenseinfo/src/main/java/org/eclipse/sw360/licenseinfo/outputGenerators/DocxGenerator.java", "diffHunk": "@@ -577,7 +576,7 @@ private void printSecondTableOnwards(XWPFDocument document, XmlCursor cursor, Ma\n             tableRow.getCell(4);\n \n         }\n-\n+/*", "originalCommit": "6752f728d65d12eb0c0d5d6b9cdb47fe4531a051", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI4MzUxOA==", "url": "https://github.com/eclipse/sw360/pull/1021#discussion_r506283518", "bodyText": "Only request.setAttribute(\"inProjectDetailsContext\", xxxx); statement seems to only difference in conditions", "author": "smrutis1", "createdAt": "2020-10-16T10:46:18Z", "path": "frontend/sw360-portlet/src/main/java/org/eclipse/sw360/portal/portlets/projects/ProjectPortlet.java", "diffHunk": "@@ -238,6 +241,20 @@ public void serveResource(ResourceRequest request, ResourceResponse response) th\n             JSONObject dataForChangeLogs = changeLogsPortletUtilsPortletUtils.serveResourceForChangeLogs(request,\n                     response, action);\n             writeJSON(request, response, dataForChangeLogs);\n+        } else if (PortalConstants.LOAD_OBLIGATIONS_VIEW.equals(action)", "originalCommit": "6752f728d65d12eb0c0d5d6b9cdb47fe4531a051", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI4ODgxMg==", "url": "https://github.com/eclipse/sw360/pull/1021#discussion_r506288812", "bodyText": "getProjectObligationToDisplay(-,-), getOrganisationObligationToDisplay(-,-), getComponentObligationToDisplay(-,-)  - These methods contains mostly duplicated codes. Would be good if can be moved to a single method", "author": "smrutis1", "createdAt": "2020-10-16T10:52:37Z", "path": "libraries/lib-datahandler/src/main/java/org/eclipse/sw360/datahandler/common/SW360Utils.java", "diffHunk": "@@ -699,4 +588,95 @@ public static Integer parseStringToNumber(String input) {\n             return 0;\n         }\n     }\n+\n+    public static Map<String, ObligationStatusInfo> getProjectObligationToDisplay(", "originalCommit": "6752f728d65d12eb0c0d5d6b9cdb47fe4531a051", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7b9b73a74b694d5807143b7319cf18d728ef6ae0", "url": "https://github.com/eclipse/sw360/commit/7b9b73a74b694d5807143b7319cf18d728ef6ae0", "message": "feat(projecttodo): Migration Scripts\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>", "committedDate": "2020-10-16T11:08:57Z", "type": "commit"}, {"oid": "4cdd1fb1e05ed21bae8dd2ab22c40ade3eda476f", "url": "https://github.com/eclipse/sw360/commit/4cdd1fb1e05ed21bae8dd2ab22c40ade3eda476f", "message": "feat(ProjectTodo): Remove ProjectTodo and UI changes for Obligation and ProjectTodo\n\nSigned-off-by: Jaideep Palit <jaideep.palit@siemens.com>", "committedDate": "2020-10-16T11:09:06Z", "type": "forcePushed"}, {"oid": "99b3f81692e987b34826919ce4d3408426b71699", "url": "https://github.com/eclipse/sw360/commit/99b3f81692e987b34826919ce4d3408426b71699", "message": "feat(ProjectTodo): Remove ProjectTodo and UI changes for Obligation and ProjectTodo\n\nSigned-off-by: Jaideep Palit <jaideep.palit@siemens.com>", "committedDate": "2020-10-16T11:30:18Z", "type": "commit"}, {"oid": "99b3f81692e987b34826919ce4d3408426b71699", "url": "https://github.com/eclipse/sw360/commit/99b3f81692e987b34826919ce4d3408426b71699", "message": "feat(ProjectTodo): Remove ProjectTodo and UI changes for Obligation and ProjectTodo\n\nSigned-off-by: Jaideep Palit <jaideep.palit@siemens.com>", "committedDate": "2020-10-16T11:30:18Z", "type": "forcePushed"}]}