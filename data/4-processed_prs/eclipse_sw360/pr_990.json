{"pr_number": 990, "pr_title": "feat(LicenseDataModel): Merge LiceneObligation with Obligation", "pr_createdAt": "2020-09-21T11:52:25Z", "pr_url": "https://github.com/eclipse/sw360/pull/990", "timeline": [{"oid": "a40cf71c8f103382e82c09e5e35aed3220ec51b3", "url": "https://github.com/eclipse/sw360/commit/a40cf71c8f103382e82c09e5e35aed3220ec51b3", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>", "committedDate": "2020-09-21T14:21:06Z", "type": "forcePushed"}, {"oid": "5851700c910a390b448554a5f227662f732d8ec5", "url": "https://github.com/eclipse/sw360/commit/5851700c910a390b448554a5f227662f732d8ec5", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>", "committedDate": "2020-09-22T05:16:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA0NjEwMQ==", "url": "https://github.com/eclipse/sw360/pull/990#discussion_r494046101", "bodyText": "Kindly remove unused imports.", "author": "JaideepPalit", "createdAt": "2020-09-24T05:25:29Z", "path": "backend/src/src-licenses/src/test/java/org/eclipse/sw360/licenses/TestLicenseClient.java", "diffHunk": "@@ -12,7 +12,7 @@\n import com.google.common.collect.ImmutableList;\n import org.eclipse.sw360.datahandler.thrift.licenses.License;\n import org.eclipse.sw360.datahandler.thrift.licenses.LicenseService;\n-import org.eclipse.sw360.datahandler.thrift.licenses.LicenseObligation;\n+/*import org.eclipse.sw360.datahandler.thrift.licenses.LicenseObligation;*/", "originalCommit": "5851700c910a390b448554a5f227662f732d8ec5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAxMDg2MA==", "url": "https://github.com/eclipse/sw360/pull/990#discussion_r495010860", "bodyText": "done", "author": "smrutis1", "createdAt": "2020-09-25T14:04:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA0NjEwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA0NzA3MQ==", "url": "https://github.com/eclipse/sw360/pull/990#discussion_r494047071", "bodyText": "Kindly consider removing commented lines from language properties", "author": "JaideepPalit", "createdAt": "2020-09-24T05:28:56Z", "path": "frontend/sw360-portlet/src/main/resources/content/Language.properties", "diffHunk": "@@ -1138,7 +1138,7 @@ to.be.replaced=To be replaced\n obligation=Obligation\n obligation.details=Obligation Details\n obligations=Obligations\n-obligations.and.obligations=Todos and Obligations\n+#obligations.and.obligations=Todos and Obligations", "originalCommit": "5851700c910a390b448554a5f227662f732d8ec5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAxMTQwOA==", "url": "https://github.com/eclipse/sw360/pull/990#discussion_r495011408", "bodyText": "done", "author": "smrutis1", "createdAt": "2020-09-25T14:05:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA0NzA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA1NjI2OA==", "url": "https://github.com/eclipse/sw360/pull/990#discussion_r494056268", "bodyText": "Remove commented code", "author": "JaideepPalit", "createdAt": "2020-09-24T05:58:31Z", "path": "libraries/lib-datahandler/src/main/java/org/eclipse/sw360/datahandler/thrift/ThriftUtils.java", "diffHunk": "@@ -55,7 +55,8 @@\n             .add(AttachmentContent.class) // Attachment service\n             .add(AttachmentUsage.class) // Attachment service\n             .add(Component.class).add(Release.class) // Component service\n-            .add(License.class).add(Obligation.class).add(LicenseObligation.class) // License service\n+            .add(License.class).add(Obligation.class)\n+//            .add(LicenseObligation.class) // License service", "originalCommit": "5851700c910a390b448554a5f227662f732d8ec5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAxMTk4NQ==", "url": "https://github.com/eclipse/sw360/pull/990#discussion_r495011985", "bodyText": "done", "author": "smrutis1", "createdAt": "2020-09-25T14:06:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA1NjI2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDEwNzk3OQ==", "url": "https://github.com/eclipse/sw360/pull/990#discussion_r494107979", "bodyText": "Maybe more info can be added to this statement like Id.\nCurrent O/P\nGetting all obligation with field obligationDatabaseIds\nfound 7 obligation with field obligationDatabaseIds in db!\nRemoving field name obligationDatabaseIds starts\nRemoving field name obligationDatabaseIds done\nRemoving field name obligationDatabaseIds done\nRemoving field name obligationDatabaseIds done\nRemoving field name obligationDatabaseIds done\nRemoving field name obligationDatabaseIds done\nRemoving field name obligationDatabaseIds done\nRemoving field name obligationDatabaseIds done", "author": "JaideepPalit", "createdAt": "2020-09-24T07:48:33Z", "path": "scripts/migrations/030_obligation_field_update.py", "diffHunk": "@@ -0,0 +1,86 @@\n+#!/usr/bin/python\n+# -----------------------------------------------------------------------------\n+# Copyright Siemens AG, 2020. Part of the SW360 Portal Project.\n+#\n+# This program and the accompanying materials are made\n+# available under the terms of the Eclipse Public License 2.0\n+# which is available at https://www.eclipse.org/legal/epl-2.0/\n+#\n+# SPDX-License-Identifier: EPL-2.0\n+#\n+# This is a manual database migration script. It is assumed that a\n+# dedicated framework for automatic migration will be written in the\n+# future. When that happens, this script should be refactored to conform\n+# to the framework's prerequisites to be run by the framework. For\n+# example, server address and db name should be parameterized, the code\n+# reorganized into a single class or function, etc.\n+#\n+# This script removes the \"obligationDatabaseIds\" from obligation\n+# ---------------------------------------------------------------------------------------------------------------------------------------------------------------\n+\n+import time\n+import couchdb\n+import json\n+from webbrowser import get\n+\n+# ---------------------------------------\n+# constants\n+# ---------------------------------------\n+\n+DRY_RUN = True\n+\n+COUCHSERVER = \"http://localhost:5984/\"\n+DBNAME = 'sw360db'\n+\n+couch=couchdb.Server(COUCHSERVER)\n+db = couch[DBNAME]\n+\n+# set fieldName\n+deleteFieldName = \"obligationDatabaseIds\"\n+\n+# ----------------------------------------\n+# queries\n+# ----------------------------------------\n+\n+# get all obligation with field \"obligationDatabaseIds\"\n+obligation_with_obligationDatabaseIds_query = {\"selector\": {\"type\": {\"$eq\": \"obligation\"},deleteFieldName: {\"$exists\": True}}}\n+\n+# ---------------------------------------\n+# functions\n+# ---------------------------------------\n+\n+def removeFieldName(qryResult, fieldToBeRemoved, log):\n+    print 'Removing field name '+fieldToBeRemoved+' starts'\n+    log['Updated obligation fields '+fieldToBeRemoved] = []\n+    for entity in qryResult:\n+        del entity[''+fieldToBeRemoved+'']\n+        if not DRY_RUN:\n+            db.save(entity)\n+            print 'Removing field name '+fieldToBeRemoved+' done'", "originalCommit": "5851700c910a390b448554a5f227662f732d8ec5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAxMzEzMw==", "url": "https://github.com/eclipse/sw360/pull/990#discussion_r495013133", "bodyText": "appended the id", "author": "smrutis1", "createdAt": "2020-09-25T14:08:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDEwNzk3OQ=="}], "type": "inlineReview"}, {"oid": "c1abe6a7680532c20a6128d00b76b3cd3d157640", "url": "https://github.com/eclipse/sw360/commit/c1abe6a7680532c20a6128d00b76b3cd3d157640", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>", "committedDate": "2020-09-25T14:01:30Z", "type": "forcePushed"}, {"oid": "014d288603b583b38d318f950001d466e2d8d752", "url": "https://github.com/eclipse/sw360/commit/014d288603b583b38d318f950001d466e2d8d752", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>", "committedDate": "2020-10-01T05:35:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3OTgzNw==", "url": "https://github.com/eclipse/sw360/pull/990#discussion_r498079837", "bodyText": "that seems to be the only relevant part for the if-else", "author": "mcjaeger", "createdAt": "2020-10-01T08:42:19Z", "path": "frontend/sw360-portlet/src/main/java/org/eclipse/sw360/portal/portlets/licenses/LicensesPortlet.java", "diffHunk": "@@ -405,46 +410,55 @@ public void addObligations(ActionRequest request, ActionResponse response) throw\n         String licenseID = request.getParameter(LICENSE_ID);\n         String[] obligationIds = request.getParameterValues(\"obligations\");\n         String obligsText = request.getParameter(\"obligText\");\n+        String obligTitle = request.getParameter(\"obligTitle\");\n         String[] bools = request.getParameterValues(\"bools\");\n \n-\n-        Obligation oblig = new Obligation();\n-        //add temporary id\n-        oblig.setId(TMP_TODO_ID_PREFIX + UUID.randomUUID().toString());\n-        if (obligationIds != null) {\n-            for (String obligationId : obligationIds) {\n-                if (obligationId != null && !obligationId.isEmpty()) {\n-                    oblig.addToObligationDatabaseIds(obligationId);\n-                }\n-            }\n-        } else {\n-            oblig.setObligationDatabaseIds(Collections.emptySet());\n-        }\n-        oblig.setText(obligsText);\n-        oblig.setTitle(StringUtils.EMPTY);\n-\n         User user = UserCacheHolder.getUserFromRequest(request);\n         String moderationComment = request.getParameter(PortalConstants.MODERATION_REQUEST_COMMENT);\n         if(moderationComment != null) {\n             user.setCommentMadeDuringModerationRequest(moderationComment);\n         }\n \n-        oblig.addToWhitelist(user.getDepartment());\n-\n-        if (bools != null) {\n-            List<String> theBools = Arrays.asList(bools);\n-            oblig.setDevelopment(theBools.contains(\"development\"));\n-            oblig.setDistribution(theBools.contains(\"distribution\"));\n-        } else {\n-            oblig.setDevelopment(false);\n-            oblig.setDistribution(false);\n-        }\n         try {\n             LicenseService.Iface client = thriftClients.makeLicenseClient();\n-            RequestStatus requestStatus = client.addObligationsToLicense(oblig, licenseID, user);\n-\n-            setSessionMessage(request, requestStatus, \"License\", \"update\");\n-\n+            if (null == obligationIds) {\n+                if (CommonUtils.isNotNullEmptyOrWhitespace(obligsText)) {\n+                    Obligation obl = new Obligation();\n+                    obl.setId(TMP_OBLIGATION_ID_PREFIX + UUID.randomUUID().toString());\n+                    obl.setText(obligsText);\n+                    obl.addToWhitelist(user.getDepartment());\n+                    obl.setTitle(obligTitle);\n+                    obl.setObligationLevel(ObligationLevel.LICENSE_OBLIGATION);\n+                    if (bools != null) {\n+                        List<String> theBools = Arrays.asList(bools);\n+                        obl.setDevelopment(theBools.contains(\"development\"));\n+                        obl.setDistribution(theBools.contains(\"distribution\"));\n+                    } else {\n+                        obl.setDevelopment(false);\n+                        obl.setDistribution(false);\n+                    }\n+                    RequestStatus requestStatus = client.addObligationsToLicense(obl, licenseID, user);\n+                    setSessionMessage(request, requestStatus, \"License\", \"update\");\n+                }\n+            } else {\n+                List<Obligation> obls = client.getObligationsByIds(Arrays.asList(obligationIds));\n+                obls.stream().filter(Objects::nonNull).forEach(obl -> wrapException(() -> {\n+                    Obligation oblCopy = obl.deepCopy();", "originalCommit": "014d288603b583b38d318f950001d466e2d8d752", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEyNjQ3MA==", "url": "https://github.com/eclipse/sw360/pull/990#discussion_r498126470", "bodyText": "refactored the code.", "author": "smrutis1", "createdAt": "2020-10-01T10:00:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3OTgzNw=="}], "type": "inlineReview"}, {"oid": "fcfec496e632f4c465f621ad9f30edcf21b85455", "url": "https://github.com/eclipse/sw360/commit/fcfec496e632f4c465f621ad9f30edcf21b85455", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>", "committedDate": "2020-10-01T09:51:32Z", "type": "commit"}, {"oid": "fcfec496e632f4c465f621ad9f30edcf21b85455", "url": "https://github.com/eclipse/sw360/commit/fcfec496e632f4c465f621ad9f30edcf21b85455", "message": "feat(LicenseDataModel): Merge LiceneObligation with Obligation\n\nSigned-off-by: Smruti Prakash Sahoo <smruti.sahoo@siemens.com>", "committedDate": "2020-10-01T09:51:32Z", "type": "forcePushed"}]}