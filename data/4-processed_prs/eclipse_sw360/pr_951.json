{"pr_number": 951, "pr_title": "fix(ui): Fixed download license disclosure error upon selection of missing attchmnt", "pr_createdAt": "2020-08-12T07:56:25Z", "pr_url": "https://github.com/eclipse/sw360/pull/951", "timeline": [{"oid": "7f47dc9bc30b9bca1904b0ef498882dd2a7b4538", "url": "https://github.com/eclipse/sw360/commit/7f47dc9bc30b9bca1904b0ef498882dd2a7b4538", "message": "fix(ui): Fixed download license disclosure error upon selection of corrupted attachment\n\nIssue: #950\n\nSigned-off-by: Smruti Sahoo <smruti.sahoo@siemens.com>", "committedDate": "2020-08-19T06:42:48Z", "type": "forcePushed"}, {"oid": "ce286ec9bb032c48e7ab349eecbbde78d5ac1b7c", "url": "https://github.com/eclipse/sw360/commit/ce286ec9bb032c48e7ab349eecbbde78d5ac1b7c", "message": "fix(ui): Fixed download license disclosure error upon selection of corrupted attachment\n\nIssue: #950\n\nSigned-off-by: Smruti Sahoo <smruti.sahoo@siemens.com>", "committedDate": "2020-08-19T07:27:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYyNDUwNA==", "url": "https://github.com/eclipse/sw360/pull/951#discussion_r473624504", "bodyText": "Can it be written as if(data.attachmentNames)  same for line 218 and 183", "author": "JaideepPalit", "createdAt": "2020-08-20T05:57:15Z", "path": "frontend/sw360-portlet/src/main/resources/META-INF/resources/html/projects/licenseInfo.jsp", "diffHunk": "@@ -138,74 +147,148 @@\n <script>\n require(['jquery', 'modules/dialog'], function($, dialog) {\n     let onlyClearingReport = '${onlyClearingReport}';\n+    let downloadEmptyTemplate = '${showSessionError}';\n+    let outputFormat = '${licInfoSelectedOutputFormat}';\n     $('#selectVariantAndDownload').on('click', selectVariantAndSubmit);\n     function selectVariantAndSubmit(){\n         dialog.open('#downloadLicenseInfoDialog','',function(submit, callback) {\n             callback(true);\n         });\n     }\n-    if(onlyClearingReport == 'true') {\n-        $('#downloadFileModal').on('click', downloadClearingReportOnly);\n-    } else {\n-        $('#downloadFileModal').on('click', downloadFile);\n+\n+    if(downloadEmptyTemplate) {\n+        if(onlyClearingReport == 'true') {\n+            downloadClearingReportOnly(true);\n+        } else {\n+            downloadFile(true, outputFormat);\n+        }\n     }\n \n-    function downloadFile(){\n-        var licenseInfoSelectedOutputFormat = $('input[name=\"outputFormat\"]:checked').val();\n-        var externalIds = [];\n-        var releaseRelations = [];\n-        var selectedProjectRelations = [];\n-        $.each($(\"input[name='externalIdsSelection']:checked\"), function(){\n-            externalIds.push($(this).val());\n+    $('#downloadFileModal').on('click', function() {\n+        checkIfSelectedAttachmentsExist().done(function(data){\n+            if(typeof data.attachmentNames !== 'undefined' && data.attachmentNames) {", "originalCommit": "ce286ec9bb032c48e7ab349eecbbde78d5ac1b7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYyODczMQ==", "url": "https://github.com/eclipse/sw360/pull/951#discussion_r473628731", "bodyText": "It would be good to have all methods related to ajax in one place like done()", "author": "JaideepPalit", "createdAt": "2020-08-20T06:03:41Z", "path": "frontend/sw360-portlet/src/main/resources/META-INF/resources/html/projects/licenseInfo.jsp", "diffHunk": "@@ -138,74 +147,148 @@\n <script>\n require(['jquery', 'modules/dialog'], function($, dialog) {\n     let onlyClearingReport = '${onlyClearingReport}';\n+    let downloadEmptyTemplate = '${showSessionError}';\n+    let outputFormat = '${licInfoSelectedOutputFormat}';\n     $('#selectVariantAndDownload').on('click', selectVariantAndSubmit);\n     function selectVariantAndSubmit(){\n         dialog.open('#downloadLicenseInfoDialog','',function(submit, callback) {\n             callback(true);\n         });\n     }\n-    if(onlyClearingReport == 'true') {\n-        $('#downloadFileModal').on('click', downloadClearingReportOnly);\n-    } else {\n-        $('#downloadFileModal').on('click', downloadFile);\n+\n+    if(downloadEmptyTemplate) {\n+        if(onlyClearingReport == 'true') {\n+            downloadClearingReportOnly(true);\n+        } else {\n+            downloadFile(true, outputFormat);\n+        }\n     }\n \n-    function downloadFile(){\n-        var licenseInfoSelectedOutputFormat = $('input[name=\"outputFormat\"]:checked').val();\n-        var externalIds = [];\n-        var releaseRelations = [];\n-        var selectedProjectRelations = [];\n-        $.each($(\"input[name='externalIdsSelection']:checked\"), function(){\n-            externalIds.push($(this).val());\n+    $('#downloadFileModal').on('click', function() {\n+        checkIfSelectedAttachmentsExist().done(function(data){\n+            if(typeof data.attachmentNames !== 'undefined' && data.attachmentNames) {\n+                downloadLicenseInfo(data.attachmentNames);\n+            } else {\n+                if(onlyClearingReport == 'true') {\n+                    downloadClearingReportOnly(false);\n+                } else {\n+                    downloadFile(false);\n+                }\n+            }\n         });\n-        var extIdsHidden = externalIds.join(',');\n+    });\n \n-        $.each($(\"input[name='releaseRelationSelection']:checked\"), function(){\n-            releaseRelations.push($(this).val());\n-        });\n-        var releaseRelationsHidden = releaseRelations.join();\n+    function downloadFile(isEmptyFile, outputFormat){\n+        var licenseInfoSelectedOutputFormat = $('input[name=\"outputFormat\"]:checked').val();\n+        if(isEmptyFile === \"undefined\" || !isEmptyFile){\n+            var externalIds = [];\n+            var releaseRelations = [];\n+            var selectedProjectRelations = [];\n+            $.each($(\"input[name='externalIdsSelection']:checked\"), function(){\n+                externalIds.push($(this).val());\n+            });\n+            var extIdsHidden = externalIds.join(',');\n \n-        $.each($(\"input[name='projectRelationSelection']:checked\"), function(){\n-            selectedProjectRelations.push($(this).val());\n-        });\n-        var selectedProjectRelationsHidden = selectedProjectRelations.join();\n+            $.each($(\"input[name='releaseRelationSelection']:checked\"), function(){\n+                releaseRelations.push($(this).val());\n+            });\n+            var releaseRelationsHidden = releaseRelations.join();\n+\n+            $.each($(\"input[name='projectRelationSelection']:checked\"), function(){\n+                selectedProjectRelations.push($(this).val());\n+            });\n+            var selectedProjectRelationsHidden = selectedProjectRelations.join();\n \n-        $('#downloadLicenseInfoForm').append('<input id=\"extIdHidden\" type=\"hidden\" name=\"<portlet:namespace/><%=PortalConstants.EXTERNAL_ID_SELECTED_KEYS%>\"/>');\n-        $('#downloadLicenseInfoForm').append('<input id=\"licensInfoFileFormat\" type=\"hidden\" name=\"<portlet:namespace/><%=PortalConstants.LICENSE_INFO_SELECTED_OUTPUT_FORMAT%>\"/>');\n-        $('#downloadLicenseInfoForm').append('<input id=\"releaseRelationship\" type=\"hidden\" name=\"<portlet:namespace/><%=PortalConstants.SELECTED_PROJECT_RELEASE_RELATIONS%>\"/>');\n-        $('#downloadLicenseInfoForm').append('<input id=\"selectedProjectRelations\" type=\"hidden\" name=\"<portlet:namespace/><%=PortalConstants.SELECTED_PROJECT_RELATIONS%>\"/>');\n-        $('#downloadLicenseInfoForm').append('<input id=\"isSubProjPresent\" type=\"hidden\" name=\"<portlet:namespace/><%=PortalConstants.IS_LINKED_PROJECT_PRESENT%>\"/>');\n+            $('#downloadLicenseInfoForm').append('<input id=\"extIdHidden\" type=\"hidden\" name=\"<portlet:namespace/><%=PortalConstants.EXTERNAL_ID_SELECTED_KEYS%>\"/>');\n+            $('#downloadLicenseInfoForm').append('<input id=\"licensInfoFileFormat\" type=\"hidden\" name=\"<portlet:namespace/><%=PortalConstants.LICENSE_INFO_SELECTED_OUTPUT_FORMAT%>\"/>');\n+            $('#downloadLicenseInfoForm').append('<input id=\"releaseRelationship\" type=\"hidden\" name=\"<portlet:namespace/><%=PortalConstants.SELECTED_PROJECT_RELEASE_RELATIONS%>\"/>');\n+            $('#downloadLicenseInfoForm').append('<input id=\"selectedProjectRelations\" type=\"hidden\" name=\"<portlet:namespace/><%=PortalConstants.SELECTED_PROJECT_RELATIONS%>\"/>');\n+            $('#downloadLicenseInfoForm').append('<input id=\"isSubProjPresent\" type=\"hidden\" name=\"<portlet:namespace/><%=PortalConstants.IS_LINKED_PROJECT_PRESENT%>\"/>');\n \n+            $(\"#extIdHidden\").val(extIdsHidden);\n+            $(\"#licensInfoFileFormat\").val(licenseInfoSelectedOutputFormat);\n+            $(\"#releaseRelationship\").val(releaseRelationsHidden);\n+            $(\"#selectedProjectRelations\").val(selectedProjectRelationsHidden);\n+            $(\"#isSubProjPresent\").val(${not empty linkedProjectRelation});\n \n-        $(\"#extIdHidden\").val(extIdsHidden);\n-        $(\"#licensInfoFileFormat\").val(licenseInfoSelectedOutputFormat);\n-        $(\"#releaseRelationship\").val(releaseRelationsHidden);\n-        $(\"#selectedProjectRelations\").val(selectedProjectRelationsHidden);\n-        $(\"#isSubProjPresent\").val(${not empty linkedProjectRelation});\n+            $('#downloadLicenseInfoForm').submit();\n+        } else {\n+            $('#downloadLicenseInfoForm').append('<input id=\"licensInfoFileFormat\" type=\"hidden\" name=\"<portlet:namespace/><%=PortalConstants.LICENSE_INFO_SELECTED_OUTPUT_FORMAT%>\"/>');\n+            $('#downloadLicenseInfoForm').append('<input id=\"isEmptyFile\" type=\"hidden\" value=\"Yes\" name=\"<portlet:namespace/><%=PortalConstants.LICENSE_INFO_EMPTY_FILE%>\" />');\n+            if(outputFormat !== 'undefined' && outputFormat) {\n+                $(\"#licensInfoFileFormat\").val(outputFormat);\n+            } else {\n+                $(\"#licensInfoFileFormat\").val(licenseInfoSelectedOutputFormat);\n+            }\n+            $('#downloadLicenseInfoForm').submit();\n+        }\n+    }\n+\n+    function downloadClearingReportOnly(isEmptyFile) {\n+        if(isEmptyFile === \"undefined\" || !isEmptyFile) {\n+            let releaseRelations = [];\n+            let selectedProjectRelations = [];\n+            $.each($(\"input[name='releaseRelationSelection']:checked\"), function(){\n+                releaseRelations.push($(this).val());\n+            });\n+            let releaseRelationsHidden = releaseRelations.join();\n \n-        $('#downloadLicenseInfoForm').submit();\n+            $.each($(\"input[name='projectRelationSelection']:checked\"), function(){\n+                selectedProjectRelations.push($(this).val());\n+            });\n+            var selectedProjectRelationsHidden = selectedProjectRelations.join();\n+            $('#downloadLicenseInfoForm').append('<input id=\"licensInfoFileFormat\" type=\"hidden\" value=\"DocxGenerator::REPORT\" name=\"<portlet:namespace/><%=PortalConstants.LICENSE_INFO_SELECTED_OUTPUT_FORMAT%>\" />');\n+            $('#downloadLicenseInfoForm').append('<input id=\"isSubProjPresent\" type=\"hidden\" name=\"<portlet:namespace/><%=PortalConstants.IS_LINKED_PROJECT_PRESENT%>\"/>');\n+            $('#downloadLicenseInfoForm').append('<input id=\"releaseRelationship\" type=\"hidden\" name=\"<portlet:namespace/><%=PortalConstants.SELECTED_PROJECT_RELEASE_RELATIONS%>\"/>');\n+            $('#downloadLicenseInfoForm').append('<input id=\"selectedProjectRelations\" type=\"hidden\" name=\"<portlet:namespace/><%=PortalConstants.SELECTED_PROJECT_RELATIONS%>\"/>');\n+            $(\"#isSubProjPresent\").val(${not empty linkedProjectRelation});\n+            $(\"#releaseRelationship\").val(releaseRelationsHidden);\n+            $(\"#selectedProjectRelations\").val(selectedProjectRelationsHidden);\n+            $('#downloadLicenseInfoForm').submit();\n+        } else {\n+            $('#downloadLicenseInfoForm').append('<input id=\"licensInfoFileFormat\" type=\"hidden\" value=\"DocxGenerator::REPORT\" name=\"<portlet:namespace/><%=PortalConstants.LICENSE_INFO_SELECTED_OUTPUT_FORMAT%>\" />');\n+            $('#downloadLicenseInfoForm').append('<input id=\"isEmptyFile\" type=\"hidden\" value=\"Yes\" name=\"<portlet:namespace/><%=PortalConstants.LICENSE_INFO_EMPTY_FILE%>\" />');\n+            $('#downloadLicenseInfoForm').submit();\n+        }\n     }\n \n-    function downloadClearingReportOnly() {\n-        let releaseRelations = [];\n-        let selectedProjectRelations = [];\n-        $.each($(\"input[name='releaseRelationSelection']:checked\"), function(){\n-            releaseRelations.push($(this).val());\n+    function checkIfSelectedAttachmentsExist() {\n+        var attchmntIdToFilename = [];\n+\n+        $.each($(\"input[name='<portlet:namespace/><%=PortalConstants.LICENSE_INFO_RELEASE_TO_ATTACHMENT%>']:checked\"), function() {\n+            let selectedAttachmentIdsWithPath = $(this).val();\n+            let fileName = $(this).closest('td').next('td').next('td').text();\n+            let selectedAttachmentIdsWithPathArray = selectedAttachmentIdsWithPath.split(\":\");\n+            let attchmntId = selectedAttachmentIdsWithPathArray[selectedAttachmentIdsWithPathArray.length - 1];\n+\n+            let attchIdToFname = fileName+\":\"+attchmntId;\n+            attchmntIdToFilename.push(attchIdToFname);\n         });\n-        let releaseRelationsHidden = releaseRelations.join();\n \n-        $.each($(\"input[name='projectRelationSelection']:checked\"), function(){\n-            selectedProjectRelations.push($(this).val());\n+        return jQuery.ajax({\n+            type: 'POST',\n+            url: '<%=checkIfAttachmentExists%>',\n+            async: false,\n+            data: {\n+                \"<portlet:namespace/><%=PortalConstants.ATTACHMENT_ID_TO_FILENAMES%>\": attchmntIdToFilename\n+            },\n+            success: function (data) {\n+\n+            }", "originalCommit": "ce286ec9bb032c48e7ab349eecbbde78d5ac1b7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkxMTc1Nw==", "url": "https://github.com/eclipse/sw360/pull/951#discussion_r479911757", "bodyText": "I think it's okay to keep it as it is for readability purpose.", "author": "smrutis1", "createdAt": "2020-08-31T06:04:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYyODczMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzMDcwNg==", "url": "https://github.com/eclipse/sw360/pull/951#discussion_r473630706", "bodyText": "Define yes as a constant and reuse in Line 451 as well", "author": "JaideepPalit", "createdAt": "2020-08-20T06:06:36Z", "path": "frontend/sw360-portlet/src/main/java/org/eclipse/sw360/portal/portlets/projects/ProjectPortlet.java", "diffHunk": "@@ -1223,13 +1277,27 @@ private void prepareLicenseInfo(RenderRequest request, RenderResponse response)\n \n                 storePathsMapInRequest(request, mappedProjectLinks);\n                 storeAttachmentUsageCountInRequest(request, mappedProjectLinks, UsageData.licenseInfo(new LicenseInfoUsage(Sets.newHashSet())));\n+                if (showAttchmntSessionError != null && \"yes\".equals(showAttchmntSessionError)) {", "originalCommit": "ce286ec9bb032c48e7ab349eecbbde78d5ac1b7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzMTk2NQ==", "url": "https://github.com/eclipse/sw360/pull/951#discussion_r473631965", "bodyText": "Since thriftClient wont be changing between request. It would be good to have a method which return a singleton thrift client wherever possible.", "author": "JaideepPalit", "createdAt": "2020-08-20T06:08:26Z", "path": "frontend/sw360-portlet/src/main/java/org/eclipse/sw360/portal/portlets/projects/ProjectPortlet.java", "diffHunk": "@@ -529,6 +544,41 @@ private void downloadLicenseInfo(ResourceRequest request, ResourceResponse respo\n         }\n     }\n \n+    private void downloadEmptyLicenseInfo(ResourceRequest request, ResourceResponse response, Project project, User user, String outputGenerator) throws TException, IOException {\n+        final LicenseInfoService.Iface licenseInfoClient = thriftClients.makeLicenseInfoClient();\n+        LicenseInfoFile licenseInfoFile = licenseInfoClient.getLicenseInfoFile(project, user, outputGenerator,\n+                Collections.emptyMap(), Collections.emptyMap(), \"\");\n+        sendLicenseInfoResponse(request, response, project, licenseInfoFile);\n+    }\n+\n+    private void verifyIfAttachmentsExists(ResourceRequest request, ResourceResponse response) throws IOException {\n+        String attachmentIdToFnames[] = request.getParameterValues(PortalConstants.ATTACHMENT_ID_TO_FILENAMES);\n+        AttachmentService.Iface attachmentClient = thriftClients.makeAttachmentClient();", "originalCommit": "ce286ec9bb032c48e7ab349eecbbde78d5ac1b7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkxMjUwMQ==", "url": "https://github.com/eclipse/sw360/pull/951#discussion_r479912501", "bodyText": "I hope it's not in the context of this PR. would look good to do it in a independent PR as it might touch many files.?", "author": "smrutis1", "createdAt": "2020-08-31T06:06:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzMTk2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzMjQxMQ==", "url": "https://github.com/eclipse/sw360/pull/951#discussion_r473632411", "bodyText": "Some typo in error msg", "author": "JaideepPalit", "createdAt": "2020-08-20T06:09:04Z", "path": "frontend/sw360-portlet/src/main/java/org/eclipse/sw360/portal/portlets/projects/ProjectPortlet.java", "diffHunk": "@@ -118,6 +120,7 @@\n     private static final String LICENSE_NAME_WITH_TEXT_ERROR = \"error\";\n     private static final String LICENSE_NAME_WITH_TEXT_FILE = \"file\";\n     private static final String CYCLIC_LINKED_PROJECT = \"Project cannot be created/updated due to cyclic linked project present. Cyclic Hierarchy : \";\n+    private static final String ATTCHMENTS_ERROR_MSG = \"Warning!! Attchments could not be opened-->\";", "originalCommit": "ce286ec9bb032c48e7ab349eecbbde78d5ac1b7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2f26c113731f321e08bc43e1be48fedb88a3c2ad", "url": "https://github.com/eclipse/sw360/commit/2f26c113731f321e08bc43e1be48fedb88a3c2ad", "message": "fix(ui): Fixed download license disclosure error upon selection of corrupted attachment\n\nIssue: #950\n\nSigned-off-by: Smruti Sahoo <smruti.sahoo@siemens.com>", "committedDate": "2020-08-31T06:00:41Z", "type": "forcePushed"}, {"oid": "c3016e70d858176044761a09f76e312faee15dbf", "url": "https://github.com/eclipse/sw360/commit/c3016e70d858176044761a09f76e312faee15dbf", "message": "fix(ui): Fixed download license disclosure error upon selection of corrupted attachment\n\nIssue: #950\n\nSigned-off-by: Smruti Sahoo <smruti.sahoo@siemens.com>", "committedDate": "2020-08-31T12:57:04Z", "type": "forcePushed"}, {"oid": "a33dd7426f209bcb8dccd37565a87fbed6ec9b7c", "url": "https://github.com/eclipse/sw360/commit/a33dd7426f209bcb8dccd37565a87fbed6ec9b7c", "message": "fix(ui): Fixed download license disclosure error upon selection of corrupted attachment\n\nIssue: #950\n\nSigned-off-by: Smruti Sahoo <smruti.sahoo@siemens.com>", "committedDate": "2020-09-06T07:08:07Z", "type": "forcePushed"}, {"oid": "6b484677af2e168e1dfa2d89bd3500d50fa08003", "url": "https://github.com/eclipse/sw360/commit/6b484677af2e168e1dfa2d89bd3500d50fa08003", "message": "fix(ui): Fixed download license disclosure error upon selection of corrupted attachment\n\nIssue: #950\n\nSigned-off-by: Smruti Sahoo <smruti.sahoo@siemens.com>", "committedDate": "2020-09-07T05:49:01Z", "type": "commit"}, {"oid": "6b484677af2e168e1dfa2d89bd3500d50fa08003", "url": "https://github.com/eclipse/sw360/commit/6b484677af2e168e1dfa2d89bd3500d50fa08003", "message": "fix(ui): Fixed download license disclosure error upon selection of corrupted attachment\n\nIssue: #950\n\nSigned-off-by: Smruti Sahoo <smruti.sahoo@siemens.com>", "committedDate": "2020-09-07T05:49:01Z", "type": "forcePushed"}]}