{"pr_number": 845, "pr_title": "Move Aggregator and implementation to aggregators package", "pr_createdAt": "2020-02-11T17:35:54Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/845", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5NTAwNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/845#discussion_r377795006", "bodyText": "we had added this to avoid the instanceOf checks in the merge methods. Why remove it now?", "author": "jkwatson", "createdAt": "2020-02-11T17:46:30Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregators/Aggregator.java", "diffHunk": "@@ -14,20 +14,21 @@\n  * limitations under the License.\n  */\n \n-package io.opentelemetry.sdk.metrics;\n+package io.opentelemetry.sdk.metrics.aggregators;\n \n import javax.annotation.concurrent.ThreadSafe;\n \n /** Aggregator represents the interface for all the available aggregations. */\n @ThreadSafe\n-interface Aggregator<T extends Aggregator<?>> {", "originalCommit": "9c69d6a72079cbb401dda45943acc0b6dc692e0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxNDgxMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/845#discussion_r377814811", "bodyText": "With generics it becomes very hard to encapsulate this class in another class. For example to use this in AbstractBoundInstrument I have to use generics there as well (maybe I am too new in generics in Java).", "author": "bogdandrutu", "createdAt": "2020-02-11T18:24:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5NTAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxNTE2MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/845#discussion_r377815161", "bodyText": "Also I commented in the description why I changed this.", "author": "bogdandrutu", "createdAt": "2020-02-11T18:24:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5NTAwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgyMDAwMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/845#discussion_r377820001", "bodyText": "I'm not sure I follow the reasoning yet. Hard to see in isolation in this PR, rather that in the context of where you want to use it. I'd be ok if you wanted to get things working, then I could go back and see if I could clean up the overall structure, so we don't have to be doing instanceof all the time.", "author": "jkwatson", "createdAt": "2020-02-11T18:33:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5NTAwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5NjA4Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/845#discussion_r377796083", "bodyText": "hmm. this smells like we might not have the right class/interface structure. Can we make the recordable type a parameter of the aggregator type?", "author": "jkwatson", "createdAt": "2020-02-11T17:48:10Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregators/DoubleSumAggregator.java", "diffHunk": "@@ -14,26 +14,31 @@\n  * limitations under the License.\n  */\n \n-package io.opentelemetry.sdk.metrics;\n+package io.opentelemetry.sdk.metrics.aggregators;\n \n import com.google.common.util.concurrent.AtomicDouble;\n \n-final class DoubleSumAggregator implements Aggregator<DoubleSumAggregator> {\n+public final class DoubleSumAggregator implements Aggregator {\n   // TODO: Change to use DoubleAdder when changed to java8.\n   private final AtomicDouble current;\n \n-  DoubleSumAggregator() {\n+  public DoubleSumAggregator() {\n     current = new AtomicDouble(0.0);\n   }\n \n   @Override\n-  public void merge(DoubleSumAggregator other) {\n-    this.current.getAndAdd(other.current.get());\n+  public void mergeAndReset(Aggregator aggregator) {\n+    if (!(aggregator instanceof DoubleSumAggregator)) {\n+      return;\n+    }\n+\n+    DoubleSumAggregator other = (DoubleSumAggregator) aggregator;\n+    other.current.getAndAdd(this.current.getAndSet(0));\n   }\n \n   @Override\n   public void recordLong(long value) {\n-    throw new UnsupportedOperationException(\"This Aggregator does not support long values\");\n+    throw new UnsupportedOperationException(\"This is a DoubleSumAggregator\");", "originalCommit": "9c69d6a72079cbb401dda45943acc0b6dc692e0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxMzgyNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/845#discussion_r377813825", "bodyText": "not sure I understand the proposal, can you clarify a bit, maybe add a small example.", "author": "bogdandrutu", "createdAt": "2020-02-11T18:22:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5NjA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxOTU0Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/845#discussion_r377819546", "bodyText": "If all the aggegrators need both methods on them, and all of them throw an UOE with one of them, that seems like the interface isn't really helping us out.\nIf we had an Aggregator<T>, then you could just have a record(T value) on that interface, and each implementation would only have to have one record method, rather than two.\nDoubleSumAggregator implements Aggregator<Double> then.", "author": "jkwatson", "createdAt": "2020-02-11T18:32:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5NjA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkyMTQzMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/845#discussion_r377921430", "bodyText": "I do wonder if the interface ends up being some extra baggage to carry around, though. I'll keep an eye on this as things evolve.", "author": "jkwatson", "createdAt": "2020-02-11T21:51:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5NjA4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5NjMxNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/845#discussion_r377796315", "bodyText": "please import", "author": "jkwatson", "createdAt": "2020-02-11T17:48:38Z", "path": "sdk/src/test/java/io/opentelemetry/sdk/metrics/aggregators/DoubleSumAggregatorTest.java", "diffHunk": "@@ -14,13 +14,13 @@\n  * limitations under the License.\n  */\n \n-package io.opentelemetry.sdk.metrics;\n+package io.opentelemetry.sdk.metrics.aggregators;\n \n import org.junit.Test;\n import org.junit.runner.RunWith;\n import org.junit.runners.JUnit4;\n \n-/** Unit tests for {@link DoubleSumAggregator}. */\n+/** Unit tests for {@link io.opentelemetry.sdk.metrics.aggregators.DoubleSumAggregator}. */", "originalCommit": "9c69d6a72079cbb401dda45943acc0b6dc692e0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxMzM2Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/845#discussion_r377813366", "bodyText": "The IDE did this, fixed.", "author": "bogdandrutu", "createdAt": "2020-02-11T18:21:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5NjMxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5NjUwNw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/845#discussion_r377796507", "bodyText": "import or leave out the package, since we're in the same package.", "author": "jkwatson", "createdAt": "2020-02-11T17:48:59Z", "path": "sdk/src/test/java/io/opentelemetry/sdk/metrics/aggregators/LongSumAggregatorTest.java", "diffHunk": "@@ -14,13 +14,13 @@\n  * limitations under the License.\n  */\n \n-package io.opentelemetry.sdk.metrics;\n+package io.opentelemetry.sdk.metrics.aggregators;\n \n import org.junit.Test;\n import org.junit.runner.RunWith;\n import org.junit.runners.JUnit4;\n \n-/** Unit tests for {@link LongSumAggregator}. */\n+/** Unit tests for {@link io.opentelemetry.sdk.metrics.aggregators.LongSumAggregator}. */", "originalCommit": "9c69d6a72079cbb401dda45943acc0b6dc692e0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxMzMxNw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/845#discussion_r377813317", "bodyText": "The IDE did this, fixed.", "author": "bogdandrutu", "createdAt": "2020-02-11T18:21:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5NjUwNw=="}], "type": "inlineReview"}, {"oid": "e71a16e296d57dbda8cced1c3d79ee406a319705", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/e71a16e296d57dbda8cced1c3d79ee406a319705", "message": "Move Aggregator and implementation to aggregators package\n\nSigned-off-by: Bogdan Cristian Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-02-12T16:41:29Z", "type": "commit"}, {"oid": "840e764b5b8a992a5a610fe6d3f431772bb9ff1d", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/840e764b5b8a992a5a610fe6d3f431772bb9ff1d", "message": "Fix comment imports\n\nSigned-off-by: Bogdan Cristian Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-02-12T16:41:29Z", "type": "commit"}, {"oid": "fe5317f9287be25fd23d1034768ebd495771bed5", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/fe5317f9287be25fd23d1034768ebd495771bed5", "message": "aggregators -> aggregator\n\nSigned-off-by: Bogdan Cristian Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-02-12T16:42:29Z", "type": "commit"}, {"oid": "fe5317f9287be25fd23d1034768ebd495771bed5", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/fe5317f9287be25fd23d1034768ebd495771bed5", "message": "aggregators -> aggregator\n\nSigned-off-by: Bogdan Cristian Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-02-12T16:42:29Z", "type": "forcePushed"}]}