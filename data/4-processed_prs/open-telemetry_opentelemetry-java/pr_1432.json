{"pr_number": 1432, "pr_title": "Reuse char[] when constructing trace context header for injection.", "pr_createdAt": "2020-07-19T06:01:06Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1432", "timeline": [{"oid": "689ec6f71358bfe2e31712dc2eb8461d203a591b", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/689ec6f71358bfe2e31712dc2eb8461d203a591b", "message": "Reuse char[] when constructing trace context header for injection.", "committedDate": "2020-07-19T05:55:44Z", "type": "commit"}, {"oid": "583c1cc5244c5e82dc6f6028c62368cd602ce719", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/583c1cc5244c5e82dc6f6028c62368cd602ce719", "message": "Spotless", "committedDate": "2020-07-19T05:57:24Z", "type": "commit"}, {"oid": "3781498d153724d38712a1b24cffe5e06faddb7c", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/3781498d153724d38712a1b24cffe5e06faddb7c", "message": "License", "committedDate": "2020-07-19T06:06:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA3MTE2MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1432#discussion_r457071161", "bodyText": "This seems to not be thread safe. if the framework consumes the string set in the setter on a different thread it looks like we may have a problem", "author": "bogdandrutu", "createdAt": "2020-07-20T05:43:27Z", "path": "api/src/main/java/io/opentelemetry/trace/propagation/HttpTraceContext.java", "diffHunk": "@@ -98,7 +99,7 @@\n     spanContext.getSpanId().copyLowerBase16To(chars, SPAN_ID_OFFSET);\n     chars[TRACE_OPTION_OFFSET - 1] = TRACEPARENT_DELIMITER;\n     spanContext.getTraceFlags().copyLowerBase16To(chars, TRACE_OPTION_OFFSET);\n-    setter.set(carrier, TRACE_PARENT, new String(chars));\n+    setter.set(carrier, TRACE_PARENT, new String(chars, 0, TRACEPARENT_HEADER_SIZE));", "originalCommit": "3781498d153724d38712a1b24cffe5e06faddb7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQxNjkwNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1432#discussion_r457416906", "bodyText": "String constructor always copies input arrays so it should be ok. The extra copy is why recyclable buffers is a popular pattern.", "author": "anuraaga", "createdAt": "2020-07-20T14:05:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA3MTE2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2NDcxMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1432#discussion_r457464710", "bodyText": "Makes sense, didn't see the extra copy but makes sense.", "author": "bogdandrutu", "createdAt": "2020-07-20T14:56:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA3MTE2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzODMzNA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1432#discussion_r457538334", "bodyText": "I'm not in love with this name, but it's fine for now. :)", "author": "jkwatson", "createdAt": "2020-07-20T16:26:37Z", "path": "api/src/main/java/io/opentelemetry/internal/TemporaryBuffers.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 2020, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.internal;\n+\n+/**\n+ * {@link ThreadLocal} buffers for use when creating new derived objects such as {@link String}s.\n+ * These buffers are reused within a single thread - it is _not safe_ to use the buffer to generate\n+ * multiple derived objects at the same time because the same memory will be used. In general, you\n+ * should get a temporary buffer, fill it with data, and finish by converting into the derived\n+ * object within the same method to avoid multiple usages of the same buffer.\n+ */\n+public final class TemporaryBuffers {", "originalCommit": "3781498d153724d38712a1b24cffe5e06faddb7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzODY5Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1432#discussion_r457538693", "bodyText": "Any thoughts to an optional boolean to zero-out the buffer before handing it out?", "author": "jkwatson", "createdAt": "2020-07-20T16:27:09Z", "path": "api/src/main/java/io/opentelemetry/internal/TemporaryBuffers.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 2020, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.internal;\n+\n+/**\n+ * {@link ThreadLocal} buffers for use when creating new derived objects such as {@link String}s.\n+ * These buffers are reused within a single thread - it is _not safe_ to use the buffer to generate\n+ * multiple derived objects at the same time because the same memory will be used. In general, you\n+ * should get a temporary buffer, fill it with data, and finish by converting into the derived\n+ * object within the same method to avoid multiple usages of the same buffer.\n+ */\n+public final class TemporaryBuffers {\n+\n+  private static final ThreadLocal<char[]> CHAR_ARRAY = new ThreadLocal<>();\n+\n+  /**\n+   * A {@link ThreadLocal} {@code char[]} of size {@code len}. Take care when using a large value of\n+   * {@code len} as this buffer will remain for the lifetime of the thread. The returned buffer will\n+   * not be zeroed and may be larger than the requested size, you must make sure to fill the entire\n+   * content to the desired value and set the length explicitly when converting to a {@link String}.\n+   */\n+  public static char[] chars(int len) {", "originalCommit": "3781498d153724d38712a1b24cffe5e06faddb7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczNTYwMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1432#discussion_r457735601", "bodyText": "I think in general that will remove the majority of the performance benefit. The intention of the temporary buffers is to only use in cases where the filling is complete or controlled. If we come up with a use case for the Boolean though let's add later", "author": "anuraaga", "createdAt": "2020-07-20T22:50:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzODY5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc0MTM0OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1432#discussion_r457741349", "bodyText": "fair enough. I was just thinking that in cases where the zeroing out was required, this class could do it more optimally in the initial request, since it knows it's a new char[] being created. No need for it now, though!", "author": "jkwatson", "createdAt": "2020-07-20T23:07:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzODY5Mw=="}], "type": "inlineReview"}]}