{"pr_number": 1339, "pr_title": "MultiTracePropagator implementation", "pr_createdAt": "2020-06-17T16:30:49Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339", "timeline": [{"oid": "960063ea63301f5bb2ec6e84c88927bbfdef65b1", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/960063ea63301f5bb2ec6e84c88927bbfdef65b1", "message": "Initial prototype of StackPropagator for multiple formats support.", "committedDate": "2020-06-17T16:16:50Z", "type": "commit"}, {"oid": "84a61f79f421c2c094f31dda994b3b29012053a8", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/84a61f79f421c2c094f31dda994b3b29012053a8", "message": "Merge branch 'master' into stackpropagator_prototype", "committedDate": "2020-06-17T16:19:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NzU0Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r441747546", "bodyText": "This call is a bit opaque. Is there a more readable way to do this work? Even just a method in this class called something like \"isContextUsable\" would help a lot.", "author": "jkwatson", "createdAt": "2020-06-17T18:33:36Z", "path": "extensions/trace_propagators/src/main/java/io/opentelemetry/extensions/trace/propagation/StackPropagator.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 2020, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.contrib.trace.propagation;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.ArrayList;\n+import javax.annotation.concurrent.Immutable;\n+\n+/**\n+ * Implementation of a composite propagator for trace.\n+ */\n+@Immutable\n+public class StackPropagator implements HttpTextFormat {\n+  private final HttpTextFormat[] propagators;\n+  private final List<String> propagatorsFields;\n+\n+  public StackPropagator(HttpTextFormat... propagators) {\n+    this.propagators = propagators;\n+\n+    List<String> fields = new ArrayList<>();\n+    for (HttpTextFormat propagator : propagators) {\n+      fields.addAll(propagator.fields());\n+    }\n+    this.propagatorsFields = Collections.unmodifiableList(fields);\n+  }\n+\n+  @Override\n+  public List<String> fields() {\n+    return propagatorsFields;\n+  }\n+\n+  @Override\n+  public <C> void inject(Context context, C carrier, Setter<C> setter) {\n+    for (int i = 0; i < propagators.length; i++) {\n+      propagators[i].inject(context, carrier, setter);\n+    }\n+  }\n+\n+  @Override\n+  public <C> Context extract(Context context, C carrier, Getter<C> getter) {\n+    for (int i = 0; i < propagators.length; i++) {\n+      context = propagators[i].extract(context, carrier, getter);\n+      if (TracingContextUtils.getSpanWithoutDefault(context) != null) {", "originalCommit": "84a61f79f421c2c094f31dda994b3b29012053a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc1MTU3Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r441751573", "bodyText": "We should document that, in general, in absence of any extracted SpanContext in Context we will try the next Propagator, and that should be enough IMO.\nAlso, TracingContextUtils and its getSpanWithoutDefault() are rather well known methods.", "author": "carlosalberto", "createdAt": "2020-06-17T18:40:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NzU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc1ODk4MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r441758980", "bodyText": "Well, it took my brain a couple of careful looks at it to understand what you were doing. So, having a clearly named method that explains that would help reduce the cognitive overhead of reading the code. :)", "author": "jkwatson", "createdAt": "2020-06-17T18:50:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NzU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg4NTc4NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r441885785", "bodyText": "Fair enough, lets do that.", "author": "carlosalberto", "createdAt": "2020-06-17T23:23:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NzU0Ng=="}], "type": "inlineReview"}, {"oid": "6c5d159b606bfca0318dc228f9de5c7189676dde", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/6c5d159b606bfca0318dc228f9de5c7189676dde", "message": "Merge branch 'master' into stackpropagator_prototype", "committedDate": "2020-06-24T15:34:26Z", "type": "commit"}, {"oid": "385f44e419508823dbc1fbc7538916e92f50f95d", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/385f44e419508823dbc1fbc7538916e92f50f95d", "message": "Add a builder.", "committedDate": "2020-06-24T16:14:54Z", "type": "commit"}, {"oid": "a76efd5b2049e3019943df8d8268e6f79a3e789b", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/a76efd5b2049e3019943df8d8268e6f79a3e789b", "message": "Polish the implementation.", "committedDate": "2020-06-25T13:24:54Z", "type": "commit"}, {"oid": "8d8e197e82e0e5170ae303ce786480aead28664f", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/8d8e197e82e0e5170ae303ce786480aead28664f", "message": "Rename.", "committedDate": "2020-06-25T13:29:10Z", "type": "commit"}, {"oid": "f98f8800e6768e85b2a7652f5496e0682bdb30ca", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/f98f8800e6768e85b2a7652f5496e0682bdb30ca", "message": "Add a method to signal the Context's state.", "committedDate": "2020-06-25T13:39:04Z", "type": "commit"}, {"oid": "c3d866a4b1ed957a2f4c9dde7d35b1dc6927117f", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/c3d866a4b1ed957a2f4c9dde7d35b1dc6927117f", "message": "Remove the multiple-extractions sample.", "committedDate": "2020-06-25T13:46:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyNDI3MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445624271", "bodyText": "I think calling this stack trace will confuse many people. How about StackedTracePropagator, or TraceMultiPropagator or CompoundPropagator?", "author": "jkwatson", "createdAt": "2020-06-25T14:59:06Z", "path": "extensions/trace_propagators/src/main/java/io/opentelemetry/extensions/trace/propagation/StackTracePropagator.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*\n+ * Copyright 2020, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.extensions.trace.propagation;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import javax.annotation.concurrent.Immutable;\n+\n+/**\n+ * A propagator designed to inject and extract multiple trace {@code HttpTextFormat} propagators,\n+ * intendended for backwards compatibility with existing services using different formats. It works\n+ * in a stack-fashion, starting with the last registered propagator, to the first one.\n+ *\n+ * <p>Upon injection, this propagator invokes {@code HttpTextFormat#inject()} for every registered\n+ * trace propagator. This will result in the carrier containing all the registered formats.\n+ *\n+ * <p>Upon extraction, this propagator invokes {@code HttpTextFormat#extract()} for every registered\n+ * trace propagator, returning immediately when a successful extraction happened.\n+ *\n+ * <pre>{@code\n+ * HttpTextFormat traceFormats = StackTracePropagator.builder()\n+ *   .addPropagator(new MyCustomTracePropagator())\n+ *   .addPropagator(new JaegerPropagator())\n+ *   .addPropagator(new HttpTraceContext())\n+ *   .build();\n+ * // Register it in the global propagators:\n+ * OpenTelemetry.setPropagators(\n+ *     DefaultContextPropagators.builder()\n+ *       .addHttpTextFormat(traceFormats)\n+ *       .build());\n+ * ...\n+ * // Extraction will be performed in reverse  order, i.e. starting with the last\n+ * // registered propagator (HttpTraceContext in this example).\n+ * Context context = OpenTelemetry.getPropagators().getHttpTextFormat()\n+ *   .extract(context, carrier, carrierGetter);\n+ * }</pre>\n+ *\n+ * @since 0.6.0\n+ */\n+@Immutable\n+public class StackTracePropagator implements HttpTextFormat {", "originalCommit": "c3d866a4b1ed957a2f4c9dde7d35b1dc6927117f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyNzU0MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445627540", "bodyText": "Yup :P Composite is pretty common I think too. Either way, I think the options open up if we don't go in reverse order, which from what I can tell doesn't seem to be that important.", "author": "anuraaga", "createdAt": "2020-06-25T15:03:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyNDI3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYzNzA0MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445637041", "bodyText": "Ah also remembered we have multispanprocessor. So MultiPropagator would be consistent for this codebase.", "author": "anuraaga", "createdAt": "2020-06-25T15:16:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyNDI3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY1OTkyMw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445659923", "bodyText": "CompoundPropagator is too generic. StackedTracePropagator sounds great to me if we keep the stack-alike behavior, but TraceMultiPropagator would work if we go the simple-linear behavior.\nMultiPropagator is not a good name IMHO as we don't really work on all propagators for extraction (we stop as soon as one properly extracts a SpanContext).", "author": "carlosalberto", "createdAt": "2020-06-25T15:49:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyNDI3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNDQ0Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445614443", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * intendended for backwards compatibility with existing services using different formats. It works\n          \n          \n            \n             * intended for compatibility with existing services using different formats. It works\n          \n      \n    \n    \n  \n\nDon't see any reason for a propagator to pick sides in what's backwards or forwards compatibility.", "author": "anuraaga", "createdAt": "2020-06-25T14:46:03Z", "path": "extensions/trace_propagators/src/main/java/io/opentelemetry/extensions/trace/propagation/StackTracePropagator.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*\n+ * Copyright 2020, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.extensions.trace.propagation;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import javax.annotation.concurrent.Immutable;\n+\n+/**\n+ * A propagator designed to inject and extract multiple trace {@code HttpTextFormat} propagators,\n+ * intendended for backwards compatibility with existing services using different formats. It works", "originalCommit": "c3d866a4b1ed957a2f4c9dde7d35b1dc6927117f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY2MDYwMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445660600", "bodyText": "It's the rationale on why this can propagator can be used. I'd rather leave it in place.", "author": "carlosalberto", "createdAt": "2020-06-25T15:50:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNDQ0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY2MTA3Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445661072", "bodyText": "Oh never mind, I thought you wanted to remove the compatibility word ;)", "author": "carlosalberto", "createdAt": "2020-06-25T15:51:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNDQ0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNjIzMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445616231", "bodyText": "Why start from the last instead of the first? Seems more intuitive to just go in order.", "author": "anuraaga", "createdAt": "2020-06-25T14:48:24Z", "path": "extensions/trace_propagators/src/main/java/io/opentelemetry/extensions/trace/propagation/StackTracePropagator.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*\n+ * Copyright 2020, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.extensions.trace.propagation;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import javax.annotation.concurrent.Immutable;\n+\n+/**\n+ * A propagator designed to inject and extract multiple trace {@code HttpTextFormat} propagators,\n+ * intendended for backwards compatibility with existing services using different formats. It works\n+ * in a stack-fashion, starting with the last registered propagator, to the first one.", "originalCommit": "c3d866a4b1ed957a2f4c9dde7d35b1dc6927117f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNzI4Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445617287", "bodyText": "In particular, I think it's a huge problem that this class is called \"StackTrace Propagator\" :P I'd take the easiest way out of removing this conflict with a common programming term and just go in order.", "author": "anuraaga", "createdAt": "2020-06-25T14:49:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNjIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyOTcyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445629720", "bodyText": "Agree with this. I don't see any reason to go in a stack-like order; it'll be much clearer is just to go in order, like @anuraaga suggests.", "author": "jkwatson", "createdAt": "2020-06-25T15:06:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNjIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY2NTIxNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445665216", "bodyText": "This is based on prior art (also, see #1273 ) but I'm free to change that if we all agree that we want simple linear usage.\ncc @pavolloffay", "author": "carlosalberto", "createdAt": "2020-06-25T15:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNjIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkyODY1NA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445928654", "bodyText": "+1 to simple linear order", "author": "anuraaga", "createdAt": "2020-06-26T01:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNjIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk1NjAyOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445956029", "bodyText": "One observation is this is about how to set propagation order for a Java developer. It seems like this doesn't really need a spec but could be left up to the language? FIFO, LIFO, it may be idiomatic one way or another in different languages. In Java, I think going in-order is idiomatic, we have some famous examples like servlet filter chain. But I can also imagine a function language may use something like b3(w3c) which could be an idiomatic way of expressing the w3c, then b3, order in that language. Environment variables, being a non-programming concept, do make more sense for a spec though.\nJust a thought.", "author": "anuraaga", "createdAt": "2020-06-26T04:04:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNjIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjEzMDM3Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r446130373", "bodyText": "Actually I'd like this to be in the spec, but it might take a little bit of time before we can have it there (if we actually manage to have it there).\nI'm not familiar with servlet filter, but is it something that traverses all components, or can it stop right away upon a successful operation? If that's latter, that can help us go forward with this approach (always, we can go linear and change it later on).\nFor the sake of this PR, I will change to name to TraceMultiPropagator now, while we wait for feedback.", "author": "carlosalberto", "createdAt": "2020-06-26T11:35:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNjIzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyNTYwNw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445625607", "bodyText": "Can we change it so propagator work on SpanContext? Is there a reason we use Context and copy all this logic into every propagator?", "author": "anuraaga", "createdAt": "2020-06-25T15:00:47Z", "path": "api/src/main/java/io/opentelemetry/trace/propagation/HttpTraceContext.java", "diffHunk": "@@ -125,6 +125,10 @@\n     checkNotNull(getter, \"getter\");\n \n     SpanContext spanContext = extractImpl(carrier, getter);\n+    if (!spanContext.isValid()) {", "originalCommit": "c3d866a4b1ed957a2f4c9dde7d35b1dc6927117f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYzMDk3MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445630971", "bodyText": "I think this arose from the desire to keep context propagation as a separate concern from tracing. I think, looking back on it now, that this might have been a goal that's more academic than useful for end users.", "author": "jkwatson", "createdAt": "2020-06-25T15:08:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyNTYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY2MTg1NA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445661854", "bodyText": "I think this arose from the desire to keep context propagation as a separate concern from tracing.\n\nThis is the case.", "author": "carlosalberto", "createdAt": "2020-06-25T15:52:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyNTYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY2ODU4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445668586", "bodyText": "Doesn't have to be this PR but recommend revisit this. The propagators are in a package called trace so decoupling from tracing doesn't seem to make much sense, or otherwise the package is wrong.", "author": "anuraaga", "createdAt": "2020-06-25T16:02:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyNTYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3MzIwNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445673206", "bodyText": "Please open an issue if you think this is important and the reasons. Personally I think there's no problem, but I might be losing some angle ;) (also, see the linked issue).", "author": "carlosalberto", "createdAt": "2020-06-25T16:09:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyNTYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkyNTUwNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r445925506", "bodyText": "Thanks will discuss this separately, you're right it doesn't need to be taken care of here.", "author": "anuraaga", "createdAt": "2020-06-26T01:43:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyNTYwNw=="}], "type": "inlineReview"}, {"oid": "00bfcacc82e9670185cecd107d8729fb5e2bc952", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/00bfcacc82e9670185cecd107d8729fb5e2bc952", "message": "Rename to TraceMultiPropagator.", "committedDate": "2020-06-30T18:15:49Z", "type": "commit"}, {"oid": "00bfcacc82e9670185cecd107d8729fb5e2bc952", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/00bfcacc82e9670185cecd107d8729fb5e2bc952", "message": "Rename to TraceMultiPropagator.", "committedDate": "2020-06-30T18:15:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk0MjI1Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r447942253", "bodyText": "can you add unit test cases for this new behavior, for each of the propagators that's changed?", "author": "jkwatson", "createdAt": "2020-06-30T19:55:53Z", "path": "extensions/trace_propagators/src/main/java/io/opentelemetry/extensions/trace/propagation/JaegerPropagator.java", "diffHunk": "@@ -110,6 +110,9 @@\n     Objects.requireNonNull(getter, \"getter\");\n \n     SpanContext spanContext = getSpanContextFromHeader(carrier, getter);\n+    if (!spanContext.isValid()) {", "originalCommit": "00bfcacc82e9670185cecd107d8729fb5e2bc952", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA2NTcyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r448065720", "bodyText": "Oh my, didn't realize I hadn't written those ones yet. Will do super early tomorrow.", "author": "carlosalberto", "createdAt": "2020-07-01T01:26:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk0MjI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA0MjM3OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r448042379", "bodyText": "Should we validate if fields are duped? Or does it not matter? Mainly wondering whether it's ok for this list to have dupes.", "author": "anuraaga", "createdAt": "2020-06-30T23:56:36Z", "path": "extensions/trace_propagators/src/main/java/io/opentelemetry/extensions/trace/propagation/TraceMultiPropagator.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*\n+ * Copyright 2020, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.extensions.trace.propagation;\n+\n+import io.grpc.Context;\n+import io.opentelemetry.context.propagation.HttpTextFormat;\n+import io.opentelemetry.trace.TracingContextUtils;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import javax.annotation.concurrent.Immutable;\n+\n+/**\n+ * A propagator designed to inject and extract multiple trace {@code HttpTextFormat} propagators,\n+ * intendended for backwards compatibility with existing services using different formats. It works\n+ * in a stack-fashion, starting with the last registered propagator, to the first one.\n+ *\n+ * <p>Upon injection, this propagator invokes {@code HttpTextFormat#inject()} for every registered\n+ * trace propagator. This will result in the carrier containing all the registered formats.\n+ *\n+ * <p>Upon extraction, this propagator invokes {@code HttpTextFormat#extract()} for every registered\n+ * trace propagator, returning immediately when a successful extraction happened.\n+ *\n+ * <pre>{@code\n+ * HttpTextFormat traceFormats = TraceMultiPropagator.builder()\n+ *   .addPropagator(new MyCustomTracePropagator())\n+ *   .addPropagator(new JaegerPropagator())\n+ *   .addPropagator(new HttpTraceContext())\n+ *   .build();\n+ * // Register it in the global propagators:\n+ * OpenTelemetry.setPropagators(\n+ *     DefaultContextPropagators.builder()\n+ *       .addHttpTextFormat(traceFormats)\n+ *       .build());\n+ * ...\n+ * // Extraction will be performed in reverse  order, i.e. starting with the last\n+ * // registered propagator (HttpTraceContext in this example).\n+ * Context context = OpenTelemetry.getPropagators().getHttpTextFormat()\n+ *   .extract(context, carrier, carrierGetter);\n+ * }</pre>\n+ *\n+ * @since 0.6.0\n+ */\n+@Immutable\n+public class TraceMultiPropagator implements HttpTextFormat {\n+  private final HttpTextFormat[] propagators;\n+  private final List<String> propagatorsFields;\n+\n+  private TraceMultiPropagator(List<HttpTextFormat> propagatorList) {\n+    this.propagators = new HttpTextFormat[propagatorList.size()];\n+    propagatorList.toArray(this.propagators);\n+\n+    List<String> fields = new ArrayList<>();", "originalCommit": "00bfcacc82e9670185cecd107d8729fb5e2bc952", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1NzYyOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r448057629", "bodyText": "Still not clear how to proceed here (we have a similar case for the base CompositePropagator in context-prop). I will fill an issue for that before merging this PR.\n(My gut feeling is that we should de-dup them at ctor time).", "author": "carlosalberto", "createdAt": "2020-07-01T00:54:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA0MjM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQzMTMxNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r448431316", "bodyText": "If you can add a TODO to the issue here would be nice", "author": "anuraaga", "createdAt": "2020-07-01T15:09:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA0MjM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ0MDMwNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r448440306", "bodyText": "An issue is even better ;) #1388", "author": "carlosalberto", "createdAt": "2020-07-01T15:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA0MjM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1NjkwOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1339#discussion_r448656909", "bodyText": "Meant it'd be good to link to that issue here with a code TODO - reduces chance of the issue just sitting in the backlog if it distracts in the code ;)", "author": "anuraaga", "createdAt": "2020-07-01T22:54:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA0MjM3OQ=="}], "type": "inlineReview"}, {"oid": "8dbc0070243db3c58963449acd43a2ccaec1bf35", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/8dbc0070243db3c58963449acd43a2ccaec1bf35", "message": "Add tests for extracting nothing.", "committedDate": "2020-07-01T13:46:44Z", "type": "commit"}]}