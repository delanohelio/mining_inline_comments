{"pr_number": 1233, "pr_title": "Cleanup samplers.", "pr_createdAt": "2020-05-16T17:18:46Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233", "timeline": [{"oid": "efae69c5901e0957a4806bf34b3fd1cb35f80849", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/efae69c5901e0957a4806bf34b3fd1cb35f80849", "message": "Add alwaysParent sampler, cleanup samplers.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-05-16T17:23:17Z", "type": "forcePushed"}, {"oid": "c158f5d9a9aaca19d4ff0f9b26b17cbb80e4f817", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/c158f5d9a9aaca19d4ff0f9b26b17cbb80e4f817", "message": "Add alwaysParent sampler, cleanup samplers.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-05-16T17:46:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyNjQ2NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r426726465", "bodyText": "this javadoc needs to be corrected.", "author": "jkwatson", "createdAt": "2020-05-18T15:51:23Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "diffHunk": "@@ -68,7 +80,17 @@ public static Sampler alwaysOn() {\n    * @since 0.1.0\n    */\n   public static Sampler alwaysOff() {\n-    return ALWAYS_OFF;\n+    return AlwaysOffSampler.INSTANCE;\n+  }\n+\n+  /**\n+   * Returns a {@link Sampler} that always makes a \"no\" decision on {@link Span} sampling.", "originalCommit": "c158f5d9a9aaca19d4ff0f9b26b17cbb80e4f817", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA2ODYyNw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r428068627", "bodyText": "Obsolete, decided to split into just the cleanup for the moment.", "author": "bogdandrutu", "createdAt": "2020-05-20T14:41:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyNjQ2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyODI3Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r426728277", "bodyText": "Now that this is used for something other than the always-on sampler, I think we should rename this to just SIMPLE_ON_DECISION or maybe even just ON_DECISION", "author": "jkwatson", "createdAt": "2020-05-18T15:53:55Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "diffHunk": "@@ -43,10 +43,22 @@\n @Immutable\n public final class Samplers {\n \n-  private static final Sampler ALWAYS_ON = new AlwaysOnSampler();\n-  private static final Sampler ALWAYS_OFF = new AlwaysOffSampler();\n-  private static final Decision ALWAYS_ON_DECISION = new SimpleDecision(/* decision= */ true);\n-  private static final Decision ALWAYS_OFF_DECISION = new SimpleDecision(/* decision= */ false);\n+  private static final Decision ALWAYS_ON_DECISION =", "originalCommit": "c158f5d9a9aaca19d4ff0f9b26b17cbb80e4f817", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg3MTYyOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r427871628", "bodyText": "Related: #1256. Maybe EMPTY_(NOT_)SAMPLED_DECISION?", "author": "Oberon00", "createdAt": "2020-05-20T09:31:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyODI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA3MjE1OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r428072159", "bodyText": "Done.", "author": "bogdandrutu", "createdAt": "2020-05-20T14:46:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyODI3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyOTMxOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r426729318", "bodyText": "javadoc on this class isn't correct any more.", "author": "jkwatson", "createdAt": "2020-05-18T15:55:26Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "diffHunk": "@@ -223,57 +261,27 @@ public final String getDescription() {\n \n   /** Sampling decision without attributes. */\n   @Immutable\n-  private static final class SimpleDecision implements Decision {\n-\n-    private final boolean decision;\n-\n+  @AutoValue\n+  abstract static class DecisionImpl implements Decision {", "originalCommit": "c158f5d9a9aaca19d4ff0f9b26b17cbb80e4f817", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA2OTA2OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r428069068", "bodyText": "Done. Not necessary to have a javadoc for this class.", "author": "bogdandrutu", "createdAt": "2020-05-20T14:42:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcyOTMxOA=="}], "type": "inlineReview"}, {"oid": "5322621835639f7c3e4e5badbdbc24eb2a6f6066", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/5322621835639f7c3e4e5badbdbc24eb2a6f6066", "message": "Cleanup Samplers\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-05-20T14:45:58Z", "type": "commit"}, {"oid": "5322621835639f7c3e4e5badbdbc24eb2a6f6066", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/5322621835639f7c3e4e5badbdbc24eb2a6f6066", "message": "Cleanup Samplers\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-05-20T14:45:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEwNjQyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r428106420", "bodyText": "Why change these to enums? This is a non-idiomatic usage of an enum.", "author": "jkwatson", "createdAt": "2020-05-20T15:30:24Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "diffHunk": "@@ -84,8 +96,8 @@ public static Sampler probability(double probability) {\n   }\n \n   @Immutable\n-  private static final class AlwaysOnSampler implements Sampler {\n-    AlwaysOnSampler() {}\n+  private enum AlwaysOnSampler implements Sampler {", "originalCommit": "5322621835639f7c3e4e5badbdbc24eb2a6f6066", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODExNDk2NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r428114965", "bodyText": "It is a better solution for singleton classes, read https://dzone.com/articles/java-singletons-using-enum", "author": "bogdandrutu", "createdAt": "2020-05-20T15:41:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEwNjQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODExOTE3MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r428119171", "bodyText": "I'm not sure one graduate student's opinion on DZone should sway us away from more idiomatic solutions. :)\nI don't about the Serialization issue... if anyone is using default Java serialization these days, they are asking for all sorts of troubles.  The reflection issue doesn't matter at all for this case. If someone wanted to create a million sampler instances, they would only be hurting themselves, not the correctness of the code.", "author": "jkwatson", "createdAt": "2020-05-20T15:47:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEwNjQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEyMTk4OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r428121988", "bodyText": "Also, it's worth reading the comments on that article. :)", "author": "jkwatson", "createdAt": "2020-05-20T15:51:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEwNjQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEzNjc4MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r428136780", "bodyText": "That was just an example, there are a lot more articles about this problem and they propose this solution as being using enums.\nAs for being idiomatic I think it is (Joshua Bloch says this in Effective Java):\nhttps://www.informit.com/articles/article.aspx?p=1216151&seqNum=3\n\nThis approach is functionally equivalent to the public field approach, except that it is more concise, provides the serialization machinery for free, and provides an ironclad guarantee against multiple instantiation, even in the face of sophisticated serialization or reflection attacks. While this approach has yet to be widely adopted, a single-element enum type is the best way to implement a singleton.", "author": "bogdandrutu", "createdAt": "2020-05-20T16:13:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEwNjQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE0MDU4OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r428140589", "bodyText": "I also vow to not use enums, at least for now. Honestly I don't think it's truly idiomatic, even if it's relatively common (which I'm not happy about, as honestly it feels like a hack around the singleton pattern - and this is probably the second time I've seen it in my life ;) ).\nLet's consider changing this in another PR (as this might apply to HttpTraceContext, B3Propagator, etc). If we agree, we go and apply this pattern everywhere.", "author": "carlosalberto", "createdAt": "2020-05-20T16:18:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEwNjQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE0MTk1Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r428141953", "bodyText": "@carlosalberto this is not a public class. So I don't see any problem. We also use this pattern already, and as I said I would trust Joshua Bloch more than almost any other java developer :)", "author": "bogdandrutu", "createdAt": "2020-05-20T16:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEwNjQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE0MzQ5NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r428143495", "bodyText": "this is not a public class\n\nFair enough. As long as we do this only for private classes I'm cool with it.", "author": "carlosalberto", "createdAt": "2020-05-20T16:23:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEwNjQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE1MjIyOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r428152228", "bodyText": "@carlosalberto also publicly I would not expose a variable for a singleton, instead I would go with a static method to retrieve the singleton. That allows us to actually change to not be a singleton if we want, or do other expensive operations (if we want in the future) that should not be part of the static initialization. In other words it gives us more flexibility in the future.", "author": "bogdandrutu", "createdAt": "2020-05-20T16:35:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEwNjQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE2NDg5NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r428164895", "bodyText": "I had completely forgotten that Josh has recommended this approach (probably because I've never actually seen it used in projects I've worked on). Let's go with it, especially as it's a private usage.", "author": "jkwatson", "createdAt": "2020-05-20T16:54:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEwNjQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE2NTY0MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1233#discussion_r428165640", "bodyText": "@jkwatson please press the magic button to approve this.", "author": "bogdandrutu", "createdAt": "2020-05-20T16:55:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEwNjQyMA=="}], "type": "inlineReview"}]}