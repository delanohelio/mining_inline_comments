{"pr_number": 1688, "pr_title": "validate version from traceparent according to spec", "pr_createdAt": "2020-09-23T14:47:16Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688", "timeline": [{"oid": "118e87e8b3d9f3ff34342dbb13857b0c87be69c1", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/118e87e8b3d9f3ff34342dbb13857b0c87be69c1", "message": "#1674 validate version from traceparent according to spec\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>", "committedDate": "2020-09-23T14:46:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY2NzI0OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r493667249", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class TraceVersion {\n          \n          \n            \n            final class TraceVersion {", "author": "Oberon00", "createdAt": "2020-09-23T15:03:11Z", "path": "api/src/main/java/io/opentelemetry/trace/TraceVersion.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.trace;\n+\n+public class TraceVersion {", "originalCommit": "118e87e8b3d9f3ff34342dbb13857b0c87be69c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY3MjExNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r493672116", "bodyText": "it cannot be package private because accessed outside of package", "author": "malafeev", "createdAt": "2020-09-23T15:09:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY2NzI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY3NDMyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r493674320", "bodyText": "You can move it to the right package though. Or just make it a member function of HttpTraceContext", "author": "Oberon00", "createdAt": "2020-09-23T15:12:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY2NzI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4OTk1Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r493689956", "bodyText": "no, problem that I want to call BigendianEncoding.isValidBase16String(...) method, but class BigendianEncoding is package private in io.opentelemetry.trace.\nbut HttpTraceContext class in package io.opentelemetry.trace.propagation.\nSo I need to make TraceVersion public class in package io.opentelemetry.trace.\nOr move class  HttpTraceContext to package io.opentelemetry.trace.", "author": "malafeev", "createdAt": "2020-09-23T15:32:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY2NzI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0Mjc2Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r493742763", "bodyText": "I think I'd prefer a 3rd option, which is to create a public utility class (called maybe something like \"WireFormatUtils\"?) that will provide these needed methods for any propagator that needs them. This could then delegate to the BigEndianEncoding implementation, as appropriate, or maybe we move methods in there, as appropriate.", "author": "jkwatson", "createdAt": "2020-09-23T16:50:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY2NzI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI3MTIxMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r494271210", "bodyText": "renamed TraceVersion to WireFormatUtils with method", "author": "malafeev", "createdAt": "2020-09-24T12:24:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY2NzI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ2OTM0OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r494469348", "bodyText": "removed", "author": "malafeev", "createdAt": "2020-09-24T16:54:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY2NzI0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY2Nzc1OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r493667759", "bodyText": "Shouldn't we check whether there is a trailing - too? What does W3C say?", "author": "Oberon00", "createdAt": "2020-09-23T15:03:51Z", "path": "api/src/main/java/io/opentelemetry/trace/propagation/HttpTraceContext.java", "diffHunk": "@@ -198,6 +199,11 @@ private static SpanContext extractContextFromTraceParent(String traceparent) {\n     }\n \n     try {\n+      String version = traceparent.substring(0, 2);", "originalCommit": "118e87e8b3d9f3ff34342dbb13857b0c87be69c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4MTU0OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r493681548", "bodyText": "it's already checked above:\ntraceparent.charAt(TRACE_ID_OFFSET - 1) == TRACEPARENT_DELIMITER", "author": "malafeev", "createdAt": "2020-09-23T15:21:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY2Nzc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY3NTAxMw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r493675013", "bodyText": "I'm not sure we need a whole class just for one method. Could this just be a method on the HttpTraceContext itself?", "author": "jkwatson", "createdAt": "2020-09-23T15:13:14Z", "path": "api/src/main/java/io/opentelemetry/trace/TraceVersion.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.trace;\n+\n+public class TraceVersion {", "originalCommit": "118e87e8b3d9f3ff34342dbb13857b0c87be69c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4MjM5Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r493682392", "bodyText": "because BigendianEncoding class is package private and I cannot call it.\nHttpTraceContext class cannot access BigendianEncoding class methods.", "author": "malafeev", "createdAt": "2020-09-23T15:22:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY3NTAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA2NDA2Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r494064063", "bodyText": "It's just two bytes - I think I would just generate a Set of all possible versions as a private in HttpTraceContext (255 elements only) and use that for validation, seems like it could be faster anyways and don't need to worry about this visibility issue for now", "author": "anuraaga", "createdAt": "2020-09-24T06:20:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY3NTAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ2OTUzOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r494469538", "bodyText": "done", "author": "malafeev", "createdAt": "2020-09-24T16:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY3NTAxMw=="}], "type": "inlineReview"}, {"oid": "fa6be04b6dc45144db89d5a3f0c8d832cab45a4f", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/fa6be04b6dc45144db89d5a3f0c8d832cab45a4f", "message": "add test\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>", "committedDate": "2020-09-23T15:24:07Z", "type": "commit"}, {"oid": "534e85c1ac34576c3e1d3cdd588b9d28b80fff1a", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/534e85c1ac34576c3e1d3cdd588b9d28b80fff1a", "message": "add test\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>", "committedDate": "2020-09-23T15:41:10Z", "type": "commit"}, {"oid": "e886d45291717b061cc00f7afac3fd29eaa024e2", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/e886d45291717b061cc00f7afac3fd29eaa024e2", "message": "rename TraceVersion to WireFormatUtils\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>", "committedDate": "2020-09-24T12:23:11Z", "type": "commit"}, {"oid": "0a839709e562f80f767f25195a7664b96c71c8c9", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/0a839709e562f80f767f25195a7664b96c71c8c9", "message": "rename test method\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>", "committedDate": "2020-09-24T12:23:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM2NzA0OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r494367048", "bodyText": "This is a sort of strange public API - not clear what wire format or version this is referring to, and pretty narrow use case. I think this was added because of the visibility of BigEndianEncoding but how about my suggestion of just precomputing the possible valid values and comparing to avoid needing this?", "author": "anuraaga", "createdAt": "2020-09-24T14:30:16Z", "path": "api/src/main/java/io/opentelemetry/trace/WireFormatUtils.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.trace;\n+\n+public class WireFormatUtils {", "originalCommit": "0a839709e562f80f767f25195a7664b96c71c8c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3MTc4NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r494371785", "bodyText": "set of 255 strings is not tiny. how I can compute all 255 values to insert into set? I suppose I will need to call BigEndianEncoding.byteToBase16String(...) method which is in BigEndianEncoding class.", "author": "malafeev", "createdAt": "2020-09-24T14:36:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM2NzA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQwMTE3MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r494401170", "bodyText": "Well since this is on the slow path (static initializer), we don't quite need the performance of BigEndianEncoding and could just use Long.toHexString.\nSet<String> VALID_VERSIONS = new HashSet<>();\nfor (int i = 0; i < 255; i++) {\n  String version = Long.toHexString(i);\n  if (version.length() < 2)\n    version = '0' + version;\n  VALID_VERSIONS.add(version);\n}\n\nIt's not so bad I guess. We need to be careful with public API, for this I would probably copy rather than expose if we need to in worst case.", "author": "anuraaga", "createdAt": "2020-09-24T15:14:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM2NzA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQwMTM2Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r494401363", "bodyText": "I think the suggestion is to write some quick code to generate all the possibilities, and then just put that into a static Set field. Is that what you were thinking, @anuraaga ?", "author": "jkwatson", "createdAt": "2020-09-24T15:14:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM2NzA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQzMDY4Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r494430682", "bodyText": "done", "author": "malafeev", "createdAt": "2020-09-24T15:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM2NzA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQzNDUyMg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r494434522", "bodyText": "I added initialization to static block, can move to method if it's better", "author": "malafeev", "createdAt": "2020-09-24T16:00:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM2NzA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUxNjkxNw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1688#discussion_r494516917", "bodyText": "The other option would be to pre-generate the set and hard-code it into the code itself, but I think this is fine; a few extra microseconds at startup shouldn't be an issue, and we can change it to a hard-coded set later if we want.", "author": "jkwatson", "createdAt": "2020-09-24T18:15:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM2NzA0OA=="}], "type": "inlineReview"}, {"oid": "01cec21e2ecd3edde3d3ee856e11863f9b341a29", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/01cec21e2ecd3edde3d3ee856e11863f9b341a29", "message": "use precalculated versions\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>", "committedDate": "2020-09-24T15:52:45Z", "type": "commit"}, {"oid": "5d33d18ce74de49f7dcd23fab8303cae173b3d7c", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/5d33d18ce74de49f7dcd23fab8303cae173b3d7c", "message": "get rid of unneded class\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>", "committedDate": "2020-09-24T15:53:23Z", "type": "commit"}, {"oid": "26cf783d6571bbe61a889a3e3c7ea5e849f991a4", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/26cf783d6571bbe61a889a3e3c7ea5e849f991a4", "message": "get rid of empty lines\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>", "committedDate": "2020-09-24T15:54:06Z", "type": "commit"}, {"oid": "0ff024d65996dc8704e44ab6da6e7ffe0c8f4e32", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/0ff024d65996dc8704e44ab6da6e7ffe0c8f4e32", "message": "fix style\n\nSigned-off-by: Sergei Malafeev <sergei@malafeev.org>", "committedDate": "2020-09-24T16:04:27Z", "type": "commit"}]}