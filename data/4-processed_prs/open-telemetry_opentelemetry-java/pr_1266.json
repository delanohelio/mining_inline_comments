{"pr_number": 1266, "pr_title": "Do not allow adding attributes, links after startSpan.", "pr_createdAt": "2020-05-22T14:20:51Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266", "timeline": [{"oid": "35b806dbd9b38e80a36477e46b171f51a8d31d93", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/35b806dbd9b38e80a36477e46b171f51a8d31d93", "message": "Do not allow adding attributes, links after startSpan.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-05-22T14:22:03Z", "type": "forcePushed"}, {"oid": "336a4dcb3505563d5424692c68111fbf840b6041", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/336a4dcb3505563d5424692c68111fbf840b6041", "message": "Do not allow adding attributes, links after startSpan.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-05-22T14:25:54Z", "type": "forcePushed"}, {"oid": "ee8a6f3d324975e338345a2fa1c36add0c186dd3", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/ee8a6f3d324975e338345a2fa1c36add0c186dd3", "message": "Add tests for edge cases\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-05-22T14:57:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4Mjk4Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r429982987", "bodyText": "Could be simplified to if null { remove } return;", "author": "arminru", "createdAt": "2020-05-25T15:10:07Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java", "diffHunk": "@@ -176,10 +173,16 @@\n     Objects.requireNonNull(key, \"key\");\n     if (value == null\n         || (value.getType() == AttributeValue.Type.STRING && value.getStringValue() == null)) {\n+      if (attributes == null) {\n+        return this;\n+      }\n       attributes.remove(key);\n-    } else {\n-      attributes.put(key, value);\n+      return this;", "originalCommit": "ee8a6f3d324975e338345a2fa1c36add0c186dd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyMDUyOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r430120528", "bodyText": "Done.", "author": "bogdandrutu", "createdAt": "2020-05-26T01:59:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4Mjk4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4NTk4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r429985986", "bodyText": "Why are attributes nullable but links aren't?", "author": "arminru", "createdAt": "2020-05-25T15:16:59Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/RecordEventsReadableSpan.java", "diffHunk": "@@ -84,7 +84,8 @@\n   private final long startEpochNanos;\n   // Set of recorded attributes. DO NOT CALL any other method that changes the ordering of events.\n   @GuardedBy(\"lock\")\n-  private final AttributesMap attributes;\n+  @Nullable\n+  private AttributesMap attributes;", "originalCommit": "ee8a6f3d324975e338345a2fa1c36add0c186dd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyMDA0MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r430120040", "bodyText": "Links is a final argument because the Span does not have an API to add links (only the builder) so it is fine to just use emptyList (which is immutable) if no links were added to avoid all null checks. In the case of attributes if I use emptyMap does not give me any benefit because that is immutable so I still need to have all checks before adding elements to the map.", "author": "bogdandrutu", "createdAt": "2020-05-26T01:57:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4NTk4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0MTAzMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r430241030", "bodyText": "Thanks for clarifying!", "author": "arminru", "createdAt": "2020-05-26T08:26:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4NTk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4Nzc3MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r429987770", "bodyText": "You might want to use a different SpanContext here, otherwise the missing effect could also come from a check that links are not duplicated (or a set being used internally).", "author": "arminru", "createdAt": "2020-05-25T15:21:21Z", "path": "sdk/src/test/java/io/opentelemetry/sdk/trace/SpanBuilderSdkTest.java", "diffHunk": "@@ -177,6 +177,24 @@ public void changingAttributes_NoEffectAfterAddLink() {\n     }\n   }\n \n+  @Test\n+  public void addLink_NoEffectAfterStartSpan() {\n+    Span.Builder spanBuilder = tracerSdk.spanBuilder(SPAN_NAME);\n+    spanBuilder.addLink(sampledSpanContext);\n+    RecordEventsReadableSpan span = (RecordEventsReadableSpan) spanBuilder.startSpan();\n+    try {\n+      assertThat(span.toSpanData().getLinks())\n+          .containsExactly(\n+              Link.create(sampledSpanContext, Collections.<String, AttributeValue>emptyMap()));\n+      spanBuilder.addLink(sampledSpanContext);", "originalCommit": "ee8a6f3d324975e338345a2fa1c36add0c186dd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyMTA4Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r430121087", "bodyText": "Done, also added a comment to explain.", "author": "bogdandrutu", "createdAt": "2020-05-26T02:02:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4Nzc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4ODI1OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r429988259", "bodyText": "\ud83d\udc4d for covering this!", "author": "arminru", "createdAt": "2020-05-25T15:22:28Z", "path": "sdk/src/test/java/io/opentelemetry/sdk/trace/SpanBuilderSdkTest.java", "diffHunk": "@@ -384,6 +431,27 @@ public void droppingAttributes() {\n     }\n   }\n \n+  @Test\n+  public void addAttributes_OnlyViaSampler() {", "originalCommit": "ee8a6f3d324975e338345a2fa1c36add0c186dd3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyMDYzMw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r430120633", "bodyText": "You are welcome :)", "author": "bogdandrutu", "createdAt": "2020-05-26T02:00:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4ODI1OQ=="}], "type": "inlineReview"}, {"oid": "4ae9b80bd928f7893d0e84d8a59f8d8260468e5a", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/4ae9b80bd928f7893d0e84d8a59f8d8260468e5a", "message": "Do not allow adding attributes, links after startSpan.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-05-26T01:58:54Z", "type": "commit"}, {"oid": "7bf91e5e4a626c2ba1aa30972d6a97988b3d393c", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/7bf91e5e4a626c2ba1aa30972d6a97988b3d393c", "message": "Add tests for edge cases\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-05-26T01:59:47Z", "type": "forcePushed"}, {"oid": "9da479559eec77071abdb428ae8dab7925eeb1ad", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/9da479559eec77071abdb428ae8dab7925eeb1ad", "message": "Add tests for edge cases\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-05-26T02:02:29Z", "type": "commit"}, {"oid": "9da479559eec77071abdb428ae8dab7925eeb1ad", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/9da479559eec77071abdb428ae8dab7925eeb1ad", "message": "Add tests for edge cases\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-05-26T02:02:29Z", "type": "forcePushed"}]}