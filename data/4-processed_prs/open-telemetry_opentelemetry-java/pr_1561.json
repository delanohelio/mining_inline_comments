{"pr_number": 1561, "pr_title": "Update the TraceState key validations to more closely match the w3c spec", "pr_createdAt": "2020-08-19T18:30:42Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561", "timeline": [{"oid": "d4ac2eaf9395973f70ecb793ee0fb8ea5332c879", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/d4ac2eaf9395973f70ecb793ee0fb8ea5332c879", "message": "Update the TraceState key validations to more closely match the w3c spec.", "committedDate": "2020-08-19T18:22:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNDkxMw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r473634913", "bodyText": "I'm having trouble grokking this code.", "author": "anuraaga", "createdAt": "2020-08-20T06:12:53Z", "path": "api/src/main/java/io/opentelemetry/trace/TraceState.java", "diffHunk": "@@ -235,26 +235,53 @@ public static Entry create(String key, String value) {\n   // Key is opaque string up to 256 characters printable. It MUST begin with a lowercase letter, and\n   // can only contain lowercase letters a-z, digits 0-9, underscores _, dashes -, asterisks *, and\n   // forward slashes /.  For multi-tenant vendor scenarios, an at sign (@) can be used to prefix the\n-  // vendor name.\n+  // vendor name. The tenant id (before the '@') is limited to 240 characters and the vendor id is\n+  // limited to 13 characters. If in the multi-tenant vendor format, then the first character\n+  // may additionally be digit.\n+  //\n   // todo: benchmark this implementation\n   private static boolean validateKey(String key) {\n-    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isNumberOrDigit(key.charAt(0))) {\n+    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isLowercaseLetterOrDigit(key.charAt(0))) {\n       return false;\n     }\n     int atSeenCount = 0;\n     for (int i = 1; i < key.length(); i++) {\n       char c = key.charAt(i);\n-      if (!isNumberOrDigit(c) && c != '_' && c != '-' && c != '@' && c != '*' && c != '/') {\n+      if (!isLowercaseLetterOrDigit(c)\n+          && c != '_'\n+          && c != '-'\n+          && c != '@'\n+          && c != '*'\n+          && c != '/') {\n         return false;\n       }\n-      if ((c == '@') && (++atSeenCount > 1)) {\n-        return false;\n+      int atPosition = 0;", "originalCommit": "d4ac2eaf9395973f70ecb793ee0fb8ea5332c879", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNTEzMw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r473635133", "bodyText": "Sorry accidentally hit Add single comment, continuing below", "author": "anuraaga", "createdAt": "2020-08-20T06:13:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNDkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNTkzMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r473635930", "bodyText": "Instead of having atPosition is it ok to do something like this in this branch?\n// remaining is vendor id, must be 13 characters or less\nif (key.length() - i > 13) {\n  return false;\n}", "author": "anuraaga", "createdAt": "2020-08-20T06:14:31Z", "path": "api/src/main/java/io/opentelemetry/trace/TraceState.java", "diffHunk": "@@ -235,26 +235,53 @@ public static Entry create(String key, String value) {\n   // Key is opaque string up to 256 characters printable. It MUST begin with a lowercase letter, and\n   // can only contain lowercase letters a-z, digits 0-9, underscores _, dashes -, asterisks *, and\n   // forward slashes /.  For multi-tenant vendor scenarios, an at sign (@) can be used to prefix the\n-  // vendor name.\n+  // vendor name. The tenant id (before the '@') is limited to 240 characters and the vendor id is\n+  // limited to 13 characters. If in the multi-tenant vendor format, then the first character\n+  // may additionally be digit.\n+  //\n   // todo: benchmark this implementation\n   private static boolean validateKey(String key) {\n-    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isNumberOrDigit(key.charAt(0))) {\n+    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isLowercaseLetterOrDigit(key.charAt(0))) {\n       return false;\n     }\n     int atSeenCount = 0;\n     for (int i = 1; i < key.length(); i++) {\n       char c = key.charAt(i);\n-      if (!isNumberOrDigit(c) && c != '_' && c != '-' && c != '@' && c != '*' && c != '/') {\n+      if (!isLowercaseLetterOrDigit(c)\n+          && c != '_'\n+          && c != '-'\n+          && c != '@'\n+          && c != '*'\n+          && c != '/') {\n         return false;\n       }\n-      if ((c == '@') && (++atSeenCount > 1)) {\n-        return false;\n+      int atPosition = 0;\n+      if (c == '@') {\n+        atPosition = i;\n+        // tenant id must be 240 characters or less\n+        if (i > 240) {\n+          return false;\n+        }\n+        atSeenCount++;\n+        if (atSeenCount > 1) {\n+          return false;\n+        }", "originalCommit": "d4ac2eaf9395973f70ecb793ee0fb8ea5332c879", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNjQ5OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r473636498", "bodyText": "I may just be misgrokking, but isn't atPosition 0 for most of the loop rather than the actual atPosition? If my reading is right, my above suggestion would probably solve it but it also means there's a unit test missing for the current buggy state.", "author": "anuraaga", "createdAt": "2020-08-20T06:15:15Z", "path": "api/src/main/java/io/opentelemetry/trace/TraceState.java", "diffHunk": "@@ -235,26 +235,53 @@ public static Entry create(String key, String value) {\n   // Key is opaque string up to 256 characters printable. It MUST begin with a lowercase letter, and\n   // can only contain lowercase letters a-z, digits 0-9, underscores _, dashes -, asterisks *, and\n   // forward slashes /.  For multi-tenant vendor scenarios, an at sign (@) can be used to prefix the\n-  // vendor name.\n+  // vendor name. The tenant id (before the '@') is limited to 240 characters and the vendor id is\n+  // limited to 13 characters. If in the multi-tenant vendor format, then the first character\n+  // may additionally be digit.\n+  //\n   // todo: benchmark this implementation\n   private static boolean validateKey(String key) {\n-    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isNumberOrDigit(key.charAt(0))) {\n+    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isLowercaseLetterOrDigit(key.charAt(0))) {\n       return false;\n     }\n     int atSeenCount = 0;\n     for (int i = 1; i < key.length(); i++) {\n       char c = key.charAt(i);\n-      if (!isNumberOrDigit(c) && c != '_' && c != '-' && c != '@' && c != '*' && c != '/') {\n+      if (!isLowercaseLetterOrDigit(c)\n+          && c != '_'\n+          && c != '-'\n+          && c != '@'\n+          && c != '*'\n+          && c != '/') {\n         return false;\n       }\n-      if ((c == '@') && (++atSeenCount > 1)) {\n-        return false;\n+      int atPosition = 0;\n+      if (c == '@') {\n+        atPosition = i;\n+        // tenant id must be 240 characters or less\n+        if (i > 240) {\n+          return false;\n+        }\n+        atSeenCount++;\n+        if (atSeenCount > 1) {\n+          return false;\n+        }\n       }\n+      if (atSeenCount == 1) {\n+        // vendor id must be 13 characters or less\n+        if ((i - atPosition) > 13) {", "originalCommit": "d4ac2eaf9395973f70ecb793ee0fb8ea5332c879", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzODQyMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r473638421", "bodyText": "atSeenCount is incremented only when atPosition changes to i. This way, this if is checked only for atPosition > 0.", "author": "thisthat", "createdAt": "2020-08-20T06:18:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNjQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY0MDI4NA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r473640284", "bodyText": "Yeah but atPosition is declared inside the loop, which I think is the original bug. So except for when key[i] == '@', atPosition == 0 for the remainder of the loop since it's initialized to 0. Sorry if I'm missing it though I've tried to stare long and this is what I came up with.", "author": "anuraaga", "createdAt": "2020-08-20T06:20:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNjQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY0NzYzMw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r473647633", "bodyText": "Oh! You are totally right! I miss that bit! We are indeed missing a test here!", "author": "thisthat", "createdAt": "2020-08-20T06:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNjQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzMTUzMw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r474131533", "bodyText": "I'm not following the problem. Can you give me a key that we're not handling correctly, so I can add a unit test for the issue?", "author": "jkwatson", "createdAt": "2020-08-20T16:46:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNjQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0MjczNw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r474142737", "bodyText": "Note, I'm rewriting this chunk of code to make it clearer. But, having an example key that we're not handling correctly would be very useful (because I don't see the issue).", "author": "jkwatson", "createdAt": "2020-08-20T17:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNjQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE5MTIxNA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r474191214", "bodyText": "I've pushed the rewrite. Let me know if that helps at all with understanding what's going on in here.\nAnd, please give me a concrete key example case we're not handling correctly if there is one.  :)", "author": "jkwatson", "createdAt": "2020-08-20T18:34:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNjQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM4NjU1Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r474386557", "bodyText": "I'm pretty sure 12345678901234567890@nr is valid but fails when I added this to your branch. Basically any time the tenant id is longer than 13 characters, since the current logic is resetting the atPosition to the beinning of the string.\nMy suggestion of not bothering with atPosition still stands :)\n\n\n  @Test\n  void testValidLongVendorKey() {\n    TraceState result = EMPTY.toBuilder().set(\"12345678901234567890@nr\", FIRST_VALUE).build();\n    assertThat(result.get(\"12345678901234567890@nr\")).isEqualTo(FIRST_VALUE);\n  }", "author": "anuraaga", "createdAt": "2020-08-21T03:21:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNjQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgwMzYzMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r474803631", "bodyText": "doh! I know you said it like 5 times, but I totally missed that we were resetting the atPosition inside the loop.  \ud83e\udd26", "author": "jkwatson", "createdAt": "2020-08-21T16:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNjQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg1MDMyNA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r474850324", "bodyText": "fixed and pushed.", "author": "jkwatson", "createdAt": "2020-08-21T18:07:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNjQ5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNzk5NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r473637995", "bodyText": "Also, guess we should avoid unicode comparisons like this and stick with simple ones we implement", "author": "anuraaga", "createdAt": "2020-08-20T06:17:33Z", "path": "api/src/main/java/io/opentelemetry/trace/TraceState.java", "diffHunk": "@@ -235,26 +235,53 @@ public static Entry create(String key, String value) {\n   // Key is opaque string up to 256 characters printable. It MUST begin with a lowercase letter, and\n   // can only contain lowercase letters a-z, digits 0-9, underscores _, dashes -, asterisks *, and\n   // forward slashes /.  For multi-tenant vendor scenarios, an at sign (@) can be used to prefix the\n-  // vendor name.\n+  // vendor name. The tenant id (before the '@') is limited to 240 characters and the vendor id is\n+  // limited to 13 characters. If in the multi-tenant vendor format, then the first character\n+  // may additionally be digit.\n+  //\n   // todo: benchmark this implementation\n   private static boolean validateKey(String key) {\n-    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isNumberOrDigit(key.charAt(0))) {\n+    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isLowercaseLetterOrDigit(key.charAt(0))) {\n       return false;\n     }\n     int atSeenCount = 0;\n     for (int i = 1; i < key.length(); i++) {\n       char c = key.charAt(i);\n-      if (!isNumberOrDigit(c) && c != '_' && c != '-' && c != '@' && c != '*' && c != '/') {\n+      if (!isLowercaseLetterOrDigit(c)\n+          && c != '_'\n+          && c != '-'\n+          && c != '@'\n+          && c != '*'\n+          && c != '/') {\n         return false;\n       }\n-      if ((c == '@') && (++atSeenCount > 1)) {\n-        return false;\n+      int atPosition = 0;\n+      if (c == '@') {\n+        atPosition = i;\n+        // tenant id must be 240 characters or less\n+        if (i > 240) {\n+          return false;\n+        }\n+        atSeenCount++;\n+        if (atSeenCount > 1) {\n+          return false;\n+        }\n       }\n+      if (atSeenCount == 1) {\n+        // vendor id must be 13 characters or less\n+        if ((i - atPosition) > 13) {\n+          return false;\n+        }\n+      }\n+    }\n+    if (atSeenCount == 0) {\n+      // if it's not the vendor format (with an '@' sign), the key must start with a letter.\n+      return !Character.isDigit(key.charAt(0));", "originalCommit": "d4ac2eaf9395973f70ecb793ee0fb8ea5332c879", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEzMjA4Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r474132082", "bodyText": "that's fair. I'll extract the digit logic into a separate method and us that.", "author": "jkwatson", "createdAt": "2020-08-20T16:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNzk5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg1MDI3MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r474850270", "bodyText": "done", "author": "jkwatson", "createdAt": "2020-08-21T18:07:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNzk5NQ=="}], "type": "inlineReview"}, {"oid": "18f20313e4bf259c4da5dca857bbf5055901fd20", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/18f20313e4bf259c4da5dca857bbf5055901fd20", "message": "rework method and variable names for more clarity", "committedDate": "2020-08-20T18:32:45Z", "type": "commit"}, {"oid": "585922d441ee0556ffb28dd78e37562bb362473b", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/585922d441ee0556ffb28dd78e37562bb362473b", "message": "Add some tests and fix a bug", "committedDate": "2020-08-21T18:06:04Z", "type": "commit"}]}