{"pr_number": 273, "pr_title": "248 observe source reference", "pr_createdAt": "2020-09-13T07:45:18Z", "pr_url": "https://github.com/dedica-team/nivio/pull/273", "timeline": [{"oid": "f4daabc4b9402cd4057d9a43d26585d523f70a9e", "url": "https://github.com/dedica-team/nivio/commit/f4daabc4b9402cd4057d9a43d26585d523f70a9e", "message": "[#248] source reference based observers", "committedDate": "2020-09-12T19:00:34Z", "type": "commit"}, {"oid": "699b54243a41339ff49eadff4c7d89a668e42e05", "url": "https://github.com/dedica-team/nivio/commit/699b54243a41339ff49eadff4c7d89a668e42e05", "message": "[#248] source reference based observers", "committedDate": "2020-09-13T06:26:47Z", "type": "commit"}, {"oid": "dfd37c9c22b0676fe1f88ce2ee45eceb1c82033b", "url": "https://github.com/dedica-team/nivio/commit/dfd37c9c22b0676fe1f88ce2ee45eceb1c82033b", "message": "[#248] refactored URLHelper to use Optional", "committedDate": "2020-09-13T06:59:20Z", "type": "commit"}, {"oid": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "url": "https://github.com/dedica-team/nivio/commit/25d1610efc8aa74a44b8fbe67d566251e07bbf89", "message": "[#248] added test", "committedDate": "2020-09-13T07:43:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1Nzg4NQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487557885", "bodyText": "You could write this in an Optional way. Something like:\nreturn url\n    .map(url -> process(landscapeDescriptionFactory.from(url.get())))\n    .orElseGet(() -> process(LandscapeDescriptionFactory.fromString(landscape.getSource(), landscape.getIdentifier() + \" source\")));", "author": "Matthimatiker", "createdAt": "2020-09-13T17:54:13Z", "path": "src/main/java/de/bonndan/nivio/api/ApiController.java", "diffHunk": "@@ -223,9 +222,9 @@ private ProcessLog process(Landscape landscape) {\n             return indexer.reIndex(Objects.requireNonNull(landscapeDescription));\n         }\n \n-        URL url = URLHelper.getURL(landscape.getSource());\n-        if (url != null) {\n-            return process(landscapeDescriptionFactory.from(url));\n+        Optional<URL> url = URLHelper.getURL(landscape.getSource());\n+        if (url.isPresent()) {\n+            return process(landscapeDescriptionFactory.from(url.get()));\n         }\n \n         return process(LandscapeDescriptionFactory.fromString(landscape.getSource(), landscape.getIdentifier() + \" source\"));", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1ODAyNw==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487558027", "bodyText": "Could env be renamed to landscape here?\nNot seeing the unchanged code above, I thought this is related to some kind of system environment variables.", "author": "Matthimatiker", "createdAt": "2020-09-13T17:55:39Z", "path": "src/main/java/de/bonndan/nivio/api/ApiController.java", "diffHunk": "@@ -142,10 +141,10 @@ public ProcessLog indexLandscape(\n         SourceReference sourceReference = new SourceReference(null, format);\n         sourceReference.setContent(body);\n \n-        ItemDescriptionFactory factory = formatFactory.getFactory(sourceReference, env);\n-        URL baseUrl = URLHelper.getParentPath(env.getSource());\n+        InputFormatHandler factory = formatFactory.getInputFormatHandler(sourceReference, env);", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1ODE1OA==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487558158", "bodyText": "For readability, you could add a constructor that does not accept null.\nIf the content is required, it could also be added to a constructor.", "author": "Matthimatiker", "createdAt": "2020-09-13T17:57:10Z", "path": "src/main/java/de/bonndan/nivio/api/ApiController.java", "diffHunk": "@@ -142,10 +141,10 @@ public ProcessLog indexLandscape(\n         SourceReference sourceReference = new SourceReference(null, format);\n         sourceReference.setContent(body);", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1ODMwMQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487558301", "bodyText": "Nice idea, to inject this optional feature \ud83d\udc4d\nYou could also make this a default method that returns null. That way, non-observable handlers do not even have to mention that method.", "author": "Matthimatiker", "createdAt": "2020-09-13T17:58:56Z", "path": "src/main/java/de/bonndan/nivio/input/InputFormatHandler.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package de.bonndan.nivio.input;\n+\n+import de.bonndan.nivio.input.dto.ItemDescription;\n+import de.bonndan.nivio.input.dto.SourceReference;\n+import de.bonndan.nivio.observation.InputFormatObserver;\n+import org.springframework.lang.Nullable;\n+\n+import java.net.URL;\n+import java.util.List;\n+\n+/**\n+ * Processors of input sources must implement this interface.\n+ */\n+public interface InputFormatHandler {\n+\n+    /**\n+     * Returns the supported format.\n+     *\n+     * @return string representing input formats (nivio, k8s, docker...)\n+     */\n+    List<String> getFormats();\n+\n+    /**\n+     * Returns item descriptions generated from the source.\n+     *\n+     * @param reference the input source\n+     * @param baseUrl   parent config url\n+     * @return list of generated items (needs to be merged with existing items)\n+     */\n+    List<ItemDescription> getDescriptions(SourceReference reference, @Nullable URL baseUrl);\n+\n+    /**\n+     * Returns an observer for the source reference.\n+     *\n+     * @param reference the source reference with a format\n+     * @param baseUrl   the url of the landscape description\n+     * @return observer that can handle the format or null if no observer is available\n+     */\n+    @Nullable\n+    InputFormatObserver getObserver(SourceReference reference, @Nullable URL baseUrl);", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3MDU0Mw==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487570543", "bodyText": "Returning null is OK for now since we don't have k8s/rancher  (see #275 ) observers. Later, however, we should have observers for every input type and returning null should be a rare edge case.", "author": "bonndan", "createdAt": "2020-09-13T19:56:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1ODMwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1ODY0NA==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487558644", "bodyText": "I guess the parameter should be named something lik formatHandler now.\nI like the factory method \ud83d\udc4d", "author": "Matthimatiker", "createdAt": "2020-09-13T18:02:24Z", "path": "src/main/java/de/bonndan/nivio/input/InputFormatHandlerFactory.java", "diffHunk": "@@ -3,22 +3,23 @@\n import de.bonndan.nivio.ProcessingException;\n import de.bonndan.nivio.input.dto.LandscapeDescription;\n import de.bonndan.nivio.input.dto.SourceReference;\n+import org.springframework.lang.NonNull;\n import org.springframework.stereotype.Service;\n import org.springframework.util.StringUtils;\n \n import java.util.*;\n import java.util.concurrent.ConcurrentHashMap;\n \n @Service\n-public class ItemDescriptionFormatFactory {\n+public class InputFormatHandlerFactory {\n \n-    private final Map<ItemDescriptionFactory, List<String>> factoryListMap = new ConcurrentHashMap<>();\n+    private final Map<InputFormatHandler, List<String>> factoryListMap = new ConcurrentHashMap<>();\n \n-    public static ItemDescriptionFormatFactory with(ItemDescriptionFactory factory) {\n-        return new ItemDescriptionFormatFactory(new ArrayList<>(Collections.singletonList(factory)));\n+    public static InputFormatHandlerFactory with(InputFormatHandler factory) {", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3MTQ2NQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487571465", "bodyText": "\ud83d\udc4d", "author": "bonndan", "createdAt": "2020-09-13T20:05:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1ODY0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1ODc5Mw==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487558793", "bodyText": "What is s?", "author": "Matthimatiker", "createdAt": "2020-09-13T18:04:20Z", "path": "src/main/java/de/bonndan/nivio/input/InputFormatHandlerFactory.java", "diffHunk": "@@ -29,9 +30,10 @@ public ItemDescriptionFormatFactory(List<ItemDescriptionFactory> factories) {\n      * @param landscapeDescription landscape, may contain a base url\n      * @return the factory\n      */\n-    public ItemDescriptionFactory getFactory(SourceReference reference, LandscapeDescription landscapeDescription) {\n+    @NonNull\n+    public InputFormatHandler getInputFormatHandler(SourceReference reference, LandscapeDescription landscapeDescription) {\n \n-        List<ItemDescriptionFactory> factories = new ArrayList<>();\n+        List<InputFormatHandler> factories = new ArrayList<>();\n         factoryListMap.entrySet().stream()\n                 .filter(entry -> entry.getValue().stream().map(s -> {", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1OTczNA==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487559734", "bodyText": "Why are the handlers stored in a Map?\nIsn't this just a complex way to write the following?\nreturn handlers.stream()\n     // Check simplified a bit in this example.\n    .filter(handler -> handler.getFormats().contains(reference.getFormat()))\n    .findAny()\n    .orElseThrow(// [...]);\n\nAt the bottom, the last factory wins. But most Maps do not guarantee an order.", "author": "Matthimatiker", "createdAt": "2020-09-13T18:14:00Z", "path": "src/main/java/de/bonndan/nivio/input/InputFormatHandlerFactory.java", "diffHunk": "@@ -29,9 +30,10 @@ public ItemDescriptionFormatFactory(List<ItemDescriptionFactory> factories) {\n      * @param landscapeDescription landscape, may contain a base url\n      * @return the factory\n      */\n-    public ItemDescriptionFactory getFactory(SourceReference reference, LandscapeDescription landscapeDescription) {\n+    @NonNull\n+    public InputFormatHandler getInputFormatHandler(SourceReference reference, LandscapeDescription landscapeDescription) {\n \n-        List<ItemDescriptionFactory> factories = new ArrayList<>();\n+        List<InputFormatHandler> factories = new ArrayList<>();\n         factoryListMap.entrySet().stream()\n                 .filter(entry -> entry.getValue().stream().map(s -> {", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU1OTkwOQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487559909", "bodyText": "Perhaps merge would be a better method name here.\nMaybe the merge method could then be moved to ItemDescription .", "author": "Matthimatiker", "createdAt": "2020-09-13T18:15:31Z", "path": "src/main/java/de/bonndan/nivio/input/ItemDescriptionValues.java", "diffHunk": "@@ -1,32 +1,18 @@\n package de.bonndan.nivio.input;\n \n import de.bonndan.nivio.input.dto.ItemDescription;\n-import de.bonndan.nivio.input.dto.SourceReference;\n-\n-import java.net.URL;\n-import java.util.List;\n \n import static de.bonndan.nivio.util.SafeAssign.assignSafe;\n \n-/**\n- * Processors of input sources must implement this interface.\n- *\n- *\n- */\n-public interface ItemDescriptionFactory {\n-\n-    List<String> getFormats();\n-\n-    List<ItemDescription> getDescriptions(SourceReference reference, URL baseUrl);\n-\n+public class ItemDescriptionValues {\n     /**\n      * Overwrites and fields on the existing with values of the increment unless the increment value is null.\n      *\n-     * @param existing current description present in the landscape\n+     * @param existing  current description present in the landscape\n      * @param increment new values\n      */\n-    static void assignNotNull(ItemDescription existing, ItemDescription increment) {\n-        \n+    public static void assignNotNull(ItemDescription existing, ItemDescription increment) {", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2MDMwNA==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487560304", "bodyText": "Was this added intenionally? Or should the logger from the class be used?", "author": "Matthimatiker", "createdAt": "2020-09-13T18:19:57Z", "path": "src/main/java/de/bonndan/nivio/input/compose2/InputFormatHandlerCompose2.java", "diffHunk": "@@ -6,24 +6,31 @@\n import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n \n import de.bonndan.nivio.input.FileFetcher;\n-import de.bonndan.nivio.input.ItemDescriptionFactory;\n+import de.bonndan.nivio.input.InputFormatHandler;\n import de.bonndan.nivio.input.dto.ItemDescription;\n import de.bonndan.nivio.input.dto.SourceReference;\n import de.bonndan.nivio.input.http.HttpService;\n+import de.bonndan.nivio.observation.InputFormatObserver;\n+import de.bonndan.nivio.observation.URLObserver;\n+import de.bonndan.nivio.util.URLHelper;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n+import org.springframework.lang.Nullable;\n import org.springframework.stereotype.Service;\n \n import java.io.IOException;\n+import java.net.MalformedURLException;\n import java.net.URL;\n import java.util.ArrayList;\n-import java.util.Arrays;\n+import java.util.Collections;\n import java.util.List;\n \n+import static io.swagger.v3.oas.integration.StringOpenApiConfigurationLoader.LOGGER;", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2MDk0MQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487560941", "bodyText": "It's at least unconventional to pass an Optional here.\nI guess the nullable client was ok here.\nMaybe it would be an even better idea to make the client not nullable. The coede in getClient() looks as if it depends on global state.  Most probably not the concern of this class.", "author": "Matthimatiker", "createdAt": "2020-09-13T18:26:16Z", "path": "src/main/java/de/bonndan/nivio/input/kubernetes/InputFormatHandlerKubernetes.java", "diffHunk": "@@ -43,12 +44,8 @@\n     private String groupLabel = null;\n     private KubernetesClient client;\n \n-    public ItemDescriptionFactoryKubernetes() {\n-\n-    }\n-\n-    public ItemDescriptionFactoryKubernetes(KubernetesClient client) {\n-        this.client = client;\n+    public InputFormatHandlerKubernetes(Optional<KubernetesClient> client) {", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2MTM2MQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487561361", "bodyText": "The new name is a huge improvement \ud83d\udc4d", "author": "Matthimatiker", "createdAt": "2020-09-13T18:30:17Z", "path": "src/main/java/de/bonndan/nivio/observation/InputFormatObserver.java", "diffHunk": "@@ -7,10 +7,11 @@\n  *\n  * URL observer is implemented, but others like k8s observer to be done\n  */\n-interface Observer {\n+public interface InputFormatObserver {", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2MTY3MQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487561671", "bodyText": "What are the benefits of returning a future here? What problem is solved?\nMaybe a short note regarding the design could be added here.\nAdditionally, I would have expected CompletableFuture, because of the method name.", "author": "Matthimatiker", "createdAt": "2020-09-13T18:32:46Z", "path": "src/main/java/de/bonndan/nivio/observation/InputFormatObserver.java", "diffHunk": "@@ -7,10 +7,11 @@\n  *\n  * URL observer is implemented, but others like k8s observer to be done\n  */\n-interface Observer {\n+public interface InputFormatObserver {\n \n     /**\n      * @return a future of the observed whether it had a change\n+     * @throws de.bonndan.nivio.ProcessingException on error\n      */\n     CompletableFuture<String> hasChange();", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2MjQ3MQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487562471", "bodyText": "Can the error even occur here?\nDoesn't hasChange() just start an synchronous process? You would encounter the error when trying to access the result, usually via Future.get().\nBut I did not get yet where this happens. Most probably somewhere below in thenApply().", "author": "Matthimatiker", "createdAt": "2020-09-13T18:40:49Z", "path": "src/main/java/de/bonndan/nivio/observation/LandscapeObserverPool.java", "diffHunk": "@@ -1,42 +1,50 @@\n package de.bonndan.nivio.observation;\n \n+import de.bonndan.nivio.ProcessingException;\n import de.bonndan.nivio.model.Landscape;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-import org.springframework.util.StringUtils;\n \n import java.util.List;\n import java.util.Objects;\n-import java.util.Optional;\n import java.util.concurrent.CompletableFuture;\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n \n /**\n  * A wrapper around observers to reduce the async results to a single boolean.\n- *\n- *\n  */\n public class LandscapeObserverPool {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(LandscapeObserverPool.class);\n-    public static final String DELIM = \";\";\n \n     private final Landscape landscape;\n-    private final List<URLObserver> observers;\n+    private final List<InputFormatObserver> observers;\n \n-    public LandscapeObserverPool(Landscape landscape, List<URLObserver> observers) {\n+    public LandscapeObserverPool(Landscape landscape, List<InputFormatObserver> observers) {\n         this.landscape = landscape;\n         this.observers = observers;\n     }\n \n     /**\n      * @return the change\n      */\n-    public Optional<String> hasChange() {\n+    public ObservedChange getChange() {\n+\n         LOGGER.info(\"Detecting changes in {} observers for landscape {}.\", observers.size(), landscape.getIdentifier());\n \n-        CompletableFuture<String>[] futures = observers.stream().map(URLObserver::hasChange).toArray(CompletableFuture[]::new);\n+        ObservedChange change = new ObservedChange();\n+        CompletableFuture<String>[] futures = observers.stream().map(observer -> {\n+            try {\n+                return observer.hasChange();", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2MjU0Ng==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487562546", "bodyText": "\ud83d\udc4d", "author": "Matthimatiker", "createdAt": "2020-09-13T18:41:41Z", "path": "src/main/java/de/bonndan/nivio/observation/LandscapeObserverPoolFactory.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package de.bonndan.nivio.observation;\n+\n+import de.bonndan.nivio.input.FileFetcher;\n+import de.bonndan.nivio.input.InputFormatHandler;\n+import de.bonndan.nivio.input.InputFormatHandlerFactory;\n+import de.bonndan.nivio.input.dto.LandscapeDescription;\n+import de.bonndan.nivio.input.dto.SourceReference;\n+import de.bonndan.nivio.model.Landscape;\n+import de.bonndan.nivio.util.URLHelper;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.lang.NonNull;\n+import org.springframework.stereotype.Service;\n+\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+\n+\n+/**\n+ * This factory is responsible to create {@link LandscapeObserverPool}s.\n+ * <p>\n+ * Since each landscape can consist of different sources ({@link SourceReference}s) of different formats, each of them\n+ * can require a different type of observer ({@link InputFormatObserver}).", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2MjgzOA==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487562838", "bodyText": "Somehow the error handling regarding URLs crawls into the calling code.\nI saw similar stuff in that context several time in this pull request. Might be a chance for improvement in the future.", "author": "Matthimatiker", "createdAt": "2020-09-13T18:44:21Z", "path": "src/main/java/de/bonndan/nivio/observation/LandscapeObserverPoolFactory.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package de.bonndan.nivio.observation;\n+\n+import de.bonndan.nivio.input.FileFetcher;\n+import de.bonndan.nivio.input.InputFormatHandler;\n+import de.bonndan.nivio.input.InputFormatHandlerFactory;\n+import de.bonndan.nivio.input.dto.LandscapeDescription;\n+import de.bonndan.nivio.input.dto.SourceReference;\n+import de.bonndan.nivio.model.Landscape;\n+import de.bonndan.nivio.util.URLHelper;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.lang.NonNull;\n+import org.springframework.stereotype.Service;\n+\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+\n+\n+/**\n+ * This factory is responsible to create {@link LandscapeObserverPool}s.\n+ * <p>\n+ * Since each landscape can consist of different sources ({@link SourceReference}s) of different formats, each of them\n+ * can require a different type of observer ({@link InputFormatObserver}).\n+ */\n+@Service\n+public class LandscapeObserverPoolFactory {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(LandscapeObserverPoolFactory.class);\n+    private final InputFormatHandlerFactory inputFormatHandlerFactory;\n+    private final FileFetcher fileFetcher;\n+\n+    public LandscapeObserverPoolFactory(InputFormatHandlerFactory inputFormatHandlerFactory, FileFetcher fileFetcher) {\n+        this.inputFormatHandlerFactory = inputFormatHandlerFactory;\n+        this.fileFetcher = fileFetcher;\n+    }\n+\n+    public LandscapeObserverPool getPoolFor(Landscape landscape, @NonNull LandscapeDescription description) {\n+\n+        List<InputFormatObserver> observers = new ArrayList<>();\n+        Optional<URL> baseUrl = URLHelper.getParentPath(description.getSource());\n+        if (baseUrl.isEmpty()) {\n+            LOGGER.info(\"Landscape {} does not seem to have a valid source ('\" + description.getSource() + \"')\", description.getIdentifier());\n+        } else {", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2MzEzNQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487563135", "bodyText": "I am surprised that this flag is not connected to the list of ProcessingExceptions.", "author": "Matthimatiker", "createdAt": "2020-09-13T18:46:52Z", "path": "src/main/java/de/bonndan/nivio/observation/ObservedChange.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package de.bonndan.nivio.observation;\n+\n+import de.bonndan.nivio.ProcessingException;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Result containing changes sources and errors while scanning.\n+ */\n+class ObservedChange {\n+\n+    private final List<ProcessingException> errors = new ArrayList<>();\n+    private List<String> changes;\n+    private boolean error;\n+\n+    public void setChanges(List<String> changes) {\n+        this.changes = changes;\n+    }\n+\n+    public void setHasError() {\n+        this.error = true;", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2MzE1OQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487563159", "bodyText": "\ud83d\udc4d", "author": "Matthimatiker", "createdAt": "2020-09-13T18:47:10Z", "path": "src/main/java/de/bonndan/nivio/observation/ObservedChange.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package de.bonndan.nivio.observation;\n+\n+import de.bonndan.nivio.ProcessingException;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Result containing changes sources and errors while scanning.\n+ */\n+class ObservedChange {\n+\n+    private final List<ProcessingException> errors = new ArrayList<>();\n+    private List<String> changes;\n+    private boolean error;\n+\n+    public void setChanges(List<String> changes) {\n+        this.changes = changes;\n+    }\n+\n+    public void setHasError() {\n+        this.error = true;\n+    }\n+\n+    public boolean hasError() {\n+        return error;\n+    }\n+\n+    public void addError(ProcessingException e) {\n+        this.errors.add(e);\n+    }\n+\n+    public List<ProcessingException> getErrors() {\n+        return Collections.unmodifiableList(errors);", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2MzMyNA==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487563324", "bodyText": "The list from getErrors() was protected, but here an external list reference is accepted.\nMight be a consequent to add the same level of protection to changes.", "author": "Matthimatiker", "createdAt": "2020-09-13T18:48:53Z", "path": "src/main/java/de/bonndan/nivio/observation/ObservedChange.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package de.bonndan.nivio.observation;\n+\n+import de.bonndan.nivio.ProcessingException;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Result containing changes sources and errors while scanning.\n+ */\n+class ObservedChange {\n+\n+    private final List<ProcessingException> errors = new ArrayList<>();\n+    private List<String> changes;\n+    private boolean error;\n+\n+    public void setChanges(List<String> changes) {\n+        this.changes = changes;", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2MzU0Nw==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487563547", "bodyText": "Is the cast necessary? I think getPoolFor() below also accepts a Landscape.\nThe non-null behavior should perhaps be guaranteed by the ProcessingFinishedEvent.", "author": "Matthimatiker", "createdAt": "2020-09-13T18:50:43Z", "path": "src/main/java/de/bonndan/nivio/observation/ObserverRegistry.java", "diffHunk": "@@ -52,49 +52,18 @@ public ObserverRegistry(URLObserverFactory urlObserverFactory,\n      */\n     @Override\n     public void onApplicationEvent(ProcessingFinishedEvent event) {\n-        LandscapeDescription from = (LandscapeDescription) event.getSource();\n-        LandscapeImpl landscape = (LandscapeImpl) event.getLandscape();\n+        LandscapeDescription landscapeDescription = (LandscapeDescription) event.getSource();\n+        LandscapeImpl landscape = Objects.requireNonNull((LandscapeImpl) event.getLandscape());", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2MzU5MA==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487563590", "bodyText": "\ud83c\udf89", "author": "Matthimatiker", "createdAt": "2020-09-13T18:51:04Z", "path": "src/main/java/de/bonndan/nivio/observation/ObserverRegistry.java", "diffHunk": "@@ -52,49 +52,18 @@ public ObserverRegistry(URLObserverFactory urlObserverFactory,\n      */\n     @Override\n     public void onApplicationEvent(ProcessingFinishedEvent event) {\n-        LandscapeDescription from = (LandscapeDescription) event.getSource();\n-        LandscapeImpl landscape = (LandscapeImpl) event.getLandscape();\n+        LandscapeDescription landscapeDescription = (LandscapeDescription) event.getSource();\n+        LandscapeImpl landscape = Objects.requireNonNull((LandscapeImpl) event.getLandscape());\n \n-        if (from == null) {\n+        if (landscapeDescription == null) {\n             String msg = \"No landscape description (input) available. Landscape \" + landscape.getIdentifier() + \"could not be registered for observation\";\n             landscape.getLog().warn(msg);\n             LOGGER.warn(msg);\n             return;\n         }\n \n-        URL sourceUrl = URLHelper.getURL(from.getSource());\n-        if (sourceUrl == null) {\n-            LOGGER.info(\"Landscape {} does not seem to have a valid source ('\" + from.getSource() + \"')\", from.getIdentifier());\n-        }\n-\n-        List<URL> landscapeSourceLocations = getLandscapeSourceLocations(from, sourceUrl);\n-        setLandscapeUrls(from, landscapeSourceLocations);\n-        LOGGER.info(\"Registered landscape {} for observation with {} urls.\", from, landscapeSourceLocations.size());\n-    }\n-\n-    /**\n-     * Returns all URLs of a landscape description.\n-     *\n-     * @param env description\n-     * @param url config file url\n-     * @return urls: config file and source references.\n-     */\n-    private List<URL> getLandscapeSourceLocations(@NonNull LandscapeDescription env, @Nullable URL url) {\n-        List<URL> urls = new ArrayList<>();\n-        if (url != null) {\n-            urls.add(url);\n-        }\n-\n-        URL baseUrl = URLHelper.getParentPath(env.getSource());\n-        for (SourceReference sourceReference : env.getSourceReferences()) {\n-            try {\n-                urls.add(new URL(URLHelper.combine(baseUrl, sourceReference.getUrl())));\n-            } catch (MalformedURLException e) {\n-                LOGGER.error(\"Failed to handle url {}\", sourceReference.getUrl(), e);\n-            }\n-        }\n-\n-        return urls;", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2MzgyNg==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487563826", "bodyText": "Shouldn't this be at least a warning?", "author": "Matthimatiker", "createdAt": "2020-09-13T18:53:17Z", "path": "src/main/java/de/bonndan/nivio/observation/ObserverRegistry.java", "diffHunk": "@@ -109,29 +78,28 @@ public void poll() {\n     /**\n      * @return the currently observed landscapes.\n      */\n-    public Set<String> getObservedLandscapes() {\n+    Set<String> getObservedLandscapes() {\n         return observerMap.keySet();\n     }\n \n-    private void setLandscapeUrls(Landscape landscape, List<URL> urls) {\n-        observerMap.put(\n-                landscape.getIdentifier(),\n-                new LandscapeObserverPool(\n-                        landscape,\n-                        urls.stream().map(urlObserverFactory::getObserver).collect(Collectors.toList())\n-                )\n-        );\n-    }\n-\n     private void check(LandscapeObserverPool observerPool) {\n-        Optional<String> change = observerPool.hasChange();\n-        change.ifPresent(s -> {\n-            Landscape stored = observerPool.getLandscape();\n+        ObservedChange change = observerPool.getChange();\n+        if (change.getErrors().size() > 0) {\n+            String errors = change.getErrors().stream().map(ProcessingException::getMessage).collect(Collectors.joining(\";\"));\n+            LOGGER.info(\"Errors occurred while scanning landscape {} for changes:  {}\", observerPool.getLandscape(), errors);", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2NDIzNQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487564235", "bodyText": "Looks as if the exception stack traces are not passed on and lost here.\nThe error could also be passed to a regular logger, to keep that information.", "author": "Matthimatiker", "createdAt": "2020-09-13T18:56:32Z", "path": "src/main/java/de/bonndan/nivio/output/map/svg/MapStyleSheetFactory.java", "diffHunk": "@@ -27,23 +27,23 @@ public MapStyleSheetFactory(FileFetcher fileFetcher) {\n      * Returns the content of the stylesheet referenced in the config.\n      *\n      * @param landscapeConfig config containing the stylesheet reference\n-     * @param processLog current process log\n+     * @param processLog      current process log\n      * @return css or empty string\n      */\n+    @NonNull\n     public String getMapStylesheet(LandscapeConfig landscapeConfig, @NonNull ProcessLog processLog) {\n \n         String mapStylesheet = landscapeConfig.getBranding().getMapStylesheet();\n         if (StringUtils.isEmpty(mapStylesheet)) {\n             return \"\";\n         }\n \n-        String mapCss = \"\";\n-        processLog.debug(\"Loading customer stylesheet: \" + mapStylesheet);\n         try {\n-            mapCss = fileFetcher.get(URLHelper.getURL(mapStylesheet));\n-        } catch (ReadingException e ) {\n+            processLog.debug(\"Loading customer stylesheet: \" + mapStylesheet);\n+            return URLHelper.getURL(mapStylesheet).map(url -> fileFetcher.get(url)).orElse(\"\");\n+        } catch (ReadingException e) {\n             processLog.warn(\"Failed to load customer stylesheet \" + mapStylesheet + \": \" + e.getMessage());\n+            return \"\";", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2NDY5OQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487564699", "bodyText": "What does this mean? Can be a file but must not be a file:// URL?", "author": "Matthimatiker", "createdAt": "2020-09-13T19:00:40Z", "path": "src/main/java/de/bonndan/nivio/util/URLHelper.java", "diffHunk": "@@ -23,40 +25,40 @@ public static boolean isLocal(URL url) {\n      * Tries to create an URL if a path is given.\n      *\n      * @param url string url or local path to file\n-     * @return an URL or null\n+     * @return an Optional of URL (empty on malformed urls)\n      */\n-    @Nullable\n-    public static URL getURL(String url) {\n+    public static Optional<URL> getURL(String url) {\n         if (url == null) {\n-            return null;\n+            return Optional.empty();\n         }\n         try {\n-            return new URL(url);\n+            return Optional.of(new URL(url));\n         } catch (MalformedURLException e) {\n             File file = new File(url);\n             if (file.exists() && !url.startsWith(\"file:\")) {", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2NDkwOQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487564909", "bodyText": "Could also be:\nurl1.map(url -> url.toURI().resolve(\".\").toURL());\n\nThat would make the previous empty check unnecessary.", "author": "Matthimatiker", "createdAt": "2020-09-13T19:02:41Z", "path": "src/main/java/de/bonndan/nivio/util/URLHelper.java", "diffHunk": "@@ -23,40 +25,40 @@ public static boolean isLocal(URL url) {\n      * Tries to create an URL if a path is given.\n      *\n      * @param url string url or local path to file\n-     * @return an URL or null\n+     * @return an Optional of URL (empty on malformed urls)\n      */\n-    @Nullable\n-    public static URL getURL(String url) {\n+    public static Optional<URL> getURL(String url) {\n         if (url == null) {\n-            return null;\n+            return Optional.empty();\n         }\n         try {\n-            return new URL(url);\n+            return Optional.of(new URL(url));\n         } catch (MalformedURLException e) {\n             File file = new File(url);\n             if (file.exists() && !url.startsWith(\"file:\")) {\n                 try {\n-                    return file.toURI().toURL();\n+                    return Optional.of(file.toURI().toURL());\n                 } catch (MalformedURLException ignored) {\n-                    return null;\n                 }\n             }\n         }\n-        return null;\n+        return Optional.empty();\n     }\n \n     /**\n      * Returns the path of a file as URL or null\n      */\n-    public static URL getParentPath(String url) {\n-        URL url1 = getURL(url);\n-        if (url1 == null) {\n-            return null;\n+    public static Optional<URL> getParentPath(String url) {\n+\n+        Optional<URL> url1 = getURL(url);\n+        if (url1.isEmpty()) {\n+            return Optional.empty();\n         }\n+\n         try {\n-            return url1.toURI().resolve(\".\").toURL();\n+            return Optional.of(url1.get().toURI().resolve(\".\").toURL());", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3MTk2NQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487571965", "bodyText": "\ud83d\udc4d", "author": "bonndan", "createdAt": "2020-09-13T20:10:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2NDkwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2NTIxOA==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487565218", "bodyText": "Already using AssertJ?\nUsing\n assertThat(factory).isInstanceOf(InputFormatHandlerCompose2.class)\n\nwould provide a way better message in case of failure.", "author": "Matthimatiker", "createdAt": "2020-09-13T19:04:53Z", "path": "src/test/java/de/bonndan/nivio/input/InputFormatHandlerFactoryTest.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package de.bonndan.nivio.input;\n+\n+import de.bonndan.nivio.ProcessingException;\n+import de.bonndan.nivio.input.compose2.InputFormatHandlerCompose2;\n+import de.bonndan.nivio.input.dto.LandscapeDescription;\n+import de.bonndan.nivio.input.dto.SourceReference;\n+import de.bonndan.nivio.input.nivio.InputFormatHandlerNivio;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.mockito.Mockito.mock;\n+\n+public class InputFormatHandlerFactoryTest {\n+\n+    InputFormatHandlerFactory formatFactory;\n+\n+    @BeforeEach\n+    public void setup() {\n+        List<InputFormatHandler> factories = new ArrayList<>();\n+        factories.add(new InputFormatHandlerCompose2(mock(FileFetcher.class)));\n+        factories.add(new InputFormatHandlerNivio(mock(FileFetcher.class)));\n+\n+        formatFactory = new InputFormatHandlerFactory(factories);\n+    }\n+\n+    @Test\n+    public void defaultIfNull() {\n+        InputFormatHandler factory = formatFactory.getInputFormatHandler(\n+                new SourceReference(),\n+                new LandscapeDescription()\n+        );\n+\n+        assertTrue(factory instanceof InputFormatHandler);\n+        assertTrue(factory instanceof InputFormatHandlerNivio);\n+    }\n+\n+    @Test\n+    public void defaultIfOther() {\n+        assertThrows(ProcessingException.class,() -> {\n+           formatFactory.getInputFormatHandler(new SourceReference(null, \"abc\"), new LandscapeDescription());\n+        });\n+    }\n+\n+    @Test\n+    public void compose2() {\n+\n+        InputFormatHandler factory = formatFactory.getInputFormatHandler(\n+                new SourceReference(null, \"docker-compose-v2\"),\n+                new LandscapeDescription()\n+        );\n+\n+        assertTrue(factory instanceof InputFormatHandler);\n+        assertTrue(factory instanceof InputFormatHandlerCompose2);", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3MTUzOA==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487571538", "bodyText": "\ud83d\ude01", "author": "bonndan", "createdAt": "2020-09-13T20:06:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2NTIxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2NTU1NA==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487565554", "bodyText": "Isn't there the risk that creating HttpService in this test makes real HTTP requests or spins up a connection pool?\nThe HttpService or FileFetcher could be mocked to ensure that this does not happen.", "author": "Matthimatiker", "createdAt": "2020-09-13T19:08:09Z", "path": "src/test/java/de/bonndan/nivio/input/SourceReferencesResolverTest.java", "diffHunk": "@@ -35,8 +34,11 @@\n     public void setup() {\n         log = new ProcessLog(LoggerFactory.getLogger(SourceReferencesResolver.class));\n         sourceReferencesResolver = new SourceReferencesResolver(\n-                new ItemDescriptionFormatFactory(\n-                        new ArrayList<ItemDescriptionFactory>(Arrays.asList(ItemDescriptionFactoryNivio.forTesting(), ItemDescriptionFactoryCompose2.forTesting()))\n+                new InputFormatHandlerFactory(\n+                        new ArrayList<>(Arrays.asList(\n+                                new InputFormatHandlerNivio(new FileFetcher(new HttpService())),", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3Mzc5NA==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487573794", "bodyText": "I've replaced everything with mocks but one.", "author": "bonndan", "createdAt": "2020-09-13T20:29:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2NTU1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2NjAxMw==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487566013", "bodyText": "Avoiding random numbers would make this test more deterministic.\nDoesn't this test fail when the same number is generated 2 times in a row?", "author": "Matthimatiker", "createdAt": "2020-09-13T19:12:12Z", "path": "src/test/java/de/bonndan/nivio/observation/FileSourceReferenceObserverTest.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package de.bonndan.nivio.observation;\n+\n+import de.bonndan.nivio.input.FileFetcher;\n+import de.bonndan.nivio.input.LandscapeDescriptionFactory;\n+import de.bonndan.nivio.input.dto.LandscapeDescription;\n+import de.bonndan.nivio.input.dto.SourceReference;\n+import de.bonndan.nivio.input.http.HttpService;\n+import de.bonndan.nivio.util.URLHelper;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import retrofit2.http.Url;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.concurrent.ExecutionException;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+class FileSourceReferenceObserverTest {\n+\n+    private FileFetcher fileFetcher;\n+    private LandscapeDescriptionFactory landscapeDescriptionFactory;\n+\n+    @BeforeEach\n+    public void setup() {\n+        fileFetcher = new FileFetcher(new HttpService());\n+        landscapeDescriptionFactory = new LandscapeDescriptionFactory(fileFetcher);\n+    }\n+\n+    @Test\n+    public void canHandleCombinedPath() throws IOException, ExecutionException, InterruptedException {\n+\n+        String realpath = getRootPath() + \"/src/test/resources/example/services/wordpress.yml\";\n+        File realfile = new File(realpath);\n+\n+        String source = getRootPath() + \"/src/test/resources/example/example_env.yml\";\n+        File file = new File(source);\n+\n+        LandscapeDescription description = landscapeDescriptionFactory.fromYaml(file);\n+\n+        SourceReference reference = description.getSourceReferences().get(0);\n+        reference.setUrl(\"./services/wordpress.yml\");\n+\n+        FileFetcher mocked = mock(FileFetcher.class);\n+        when(mocked.get(any(SourceReference.class), any(URL.class))).thenAnswer(invocationOnMock -> String.valueOf(Math.random()));", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU3MjIwMQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487572201", "bodyText": "I've been too lazy to look up this simple code:\nwhen(mocked.get(any(SourceReference.class), any(URL.class))).thenReturn(\"foo\", \"bar\")", "author": "bonndan", "createdAt": "2020-09-13T20:13:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2NjAxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU2NjE4NQ==", "url": "https://github.com/dedica-team/nivio/pull/273#discussion_r487566185", "bodyText": "A more descriptive test name would be helpful here.", "author": "Matthimatiker", "createdAt": "2020-09-13T19:14:14Z", "path": "src/test/java/de/bonndan/nivio/observation/ObserverRegistryTest.java", "diffHunk": "@@ -4,77 +4,54 @@\n import de.bonndan.nivio.input.FileFetcher;\n import de.bonndan.nivio.input.LandscapeDescriptionFactory;\n import de.bonndan.nivio.input.dto.LandscapeDescription;\n-import de.bonndan.nivio.input.dto.SourceReference;\n import de.bonndan.nivio.input.http.HttpService;\n import de.bonndan.nivio.model.LandscapeFactory;\n import de.bonndan.nivio.model.LandscapeImpl;\n import org.junit.jupiter.api.BeforeEach;\n-import org.junit.jupiter.api.DisplayName;\n import org.junit.jupiter.api.Test;\n import org.springframework.context.ApplicationEventPublisher;\n \n import java.io.File;\n-import java.net.URL;\n import java.nio.file.Path;\n import java.nio.file.Paths;\n+import java.util.ArrayList;\n import java.util.Set;\n \n-import static org.junit.jupiter.api.Assertions.*;\n-import static org.mockito.ArgumentMatchers.any;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n import static org.mockito.Mockito.*;\n \n class ObserverRegistryTest {\n \n-    private ObserverRegistry observerRegistry;\n     private LandscapeDescriptionFactory landscapeDescriptionFactory;\n     private ApplicationEventPublisher publisher;\n-    private URLObserverFactory urlObserverFactory;\n+    private LandscapeObserverPoolFactory observerPoolFactory;\n+    private ObserverRegistry observerRegistry;\n     private LandscapeImpl landscape;\n \n     @BeforeEach\n     public void setup() {\n         landscapeDescriptionFactory = mock(LandscapeDescriptionFactory.class);\n         publisher = mock(ApplicationEventPublisher.class);\n-        urlObserverFactory = mock(URLObserverFactory.class);\n-        observerRegistry = new ObserverRegistry(urlObserverFactory, landscapeDescriptionFactory, publisher);\n-\n-        landscape = LandscapeFactory.create(\"test\");\n-    }\n-\n-    @Test\n-    public void register() {\n-        LandscapeDescription description = new LandscapeDescription();\n-        ProcessingFinishedEvent event = new ProcessingFinishedEvent(description, landscape);\n-        description.setIdentifier(\"test\");\n-        description.setSource(\"https://dedica.team\");\n-        when(landscapeDescriptionFactory.from(landscape)).thenReturn(description);\n-        when(urlObserverFactory.getObserver(any(URL.class))).thenReturn(mock(URLObserver.class));\n-\n-        //when\n-        observerRegistry.onApplicationEvent(event);\n-\n-        //then\n-        Set<String> observedLandscapes = observerRegistry.getObservedLandscapes();\n-        assertNotNull(observedLandscapes);\n-        assertEquals(1, observedLandscapes.size());\n-        assertEquals(landscape.getIdentifier(), observedLandscapes.iterator().next());\n-\n-        verify(urlObserverFactory).getObserver(any(URL.class));\n+        observerPoolFactory = mock(LandscapeObserverPoolFactory.class);\n+        observerRegistry = new ObserverRegistry(observerPoolFactory, landscapeDescriptionFactory, publisher);\n     }\n \n     @Test\n-    public void willRegardRelativePaths() {\n+    public void onApplicationEvent() {", "originalCommit": "25d1610efc8aa74a44b8fbe67d566251e07bbf89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8416e6e49ec68c0433502636bd9c234f688f5dc6", "url": "https://github.com/dedica-team/nivio/commit/8416e6e49ec68c0433502636bd9c234f688f5dc6", "message": "[#248] removed obsolete param", "committedDate": "2020-09-13T20:05:17Z", "type": "commit"}, {"oid": "9d1d4a175d32e3a7698b1fd21740a9533a99a645", "url": "https://github.com/dedica-team/nivio/commit/9d1d4a175d32e3a7698b1fd21740a9533a99a645", "message": "[#248] url helper refactoring", "committedDate": "2020-09-13T20:10:27Z", "type": "commit"}, {"oid": "d780b384730a93f5cea8acced9ef7e317157d5bb", "url": "https://github.com/dedica-team/nivio/commit/d780b384730a93f5cea8acced9ef7e317157d5bb", "message": "[#248] test cleanup", "committedDate": "2020-09-13T20:14:05Z", "type": "commit"}, {"oid": "0a80c9537d50e7f065c489cb03607dbb5fe9d881", "url": "https://github.com/dedica-team/nivio/commit/0a80c9537d50e7f065c489cb03607dbb5fe9d881", "message": "[#248] cleanup", "committedDate": "2020-09-13T20:15:03Z", "type": "commit"}, {"oid": "3cd130af3fd746e5e3d6bcbad53fa7eb2887d373", "url": "https://github.com/dedica-team/nivio/commit/3cd130af3fd746e5e3d6bcbad53fa7eb2887d373", "message": "[#248] cleanup", "committedDate": "2020-09-13T20:29:23Z", "type": "commit"}, {"oid": "66c7d724ddbf8ee4eb3f771e460d62c966af0ed4", "url": "https://github.com/dedica-team/nivio/commit/66c7d724ddbf8ee4eb3f771e460d62c966af0ed4", "message": "[#248] cleanup", "committedDate": "2020-09-13T20:46:16Z", "type": "commit"}]}