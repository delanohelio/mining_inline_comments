{"pr_number": 345, "pr_title": "Trigger event instead of direct use of Indexer an API #309", "pr_createdAt": "2020-12-28T19:14:29Z", "pr_url": "https://github.com/dedica-team/nivio/pull/345", "timeline": [{"oid": "e938c43d5da6cf4ffabfc0b7c3b0c632a0ec3da2", "url": "https://github.com/dedica-team/nivio/commit/e938c43d5da6cf4ffabfc0b7c3b0c632a0ec3da2", "message": "Merge pull request #1 from dedica-team/develop\n\nupdate forked repo", "committedDate": "2020-12-28T18:18:19Z", "type": "commit"}, {"oid": "10d61e3284ba79358fbf80dc4c73a0a0cd3ed399", "url": "https://github.com/dedica-team/nivio/commit/10d61e3284ba79358fbf80dc4c73a0a0cd3ed399", "message": "initial commit", "committedDate": "2020-12-28T18:53:30Z", "type": "commit"}, {"oid": "ea8fa9b464ab862208572c8da5521c03d5f238a2", "url": "https://github.com/dedica-team/nivio/commit/ea8fa9b464ab862208572c8da5521c03d5f238a2", "message": "updated controller", "committedDate": "2020-12-28T19:04:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA1NTg1Mw==", "url": "https://github.com/dedica-team/nivio/pull/345#discussion_r551055853", "bodyText": "This looks fine, we can remove line 131 tough! \ud83d\ude04", "author": "mfbieber", "createdAt": "2021-01-03T21:22:15Z", "path": "src/main/java/de/bonndan/nivio/api/ApiController.java", "diffHunk": "@@ -124,7 +128,11 @@ public Index index() {\n     @RequestMapping(path = \"/landscape\", method = RequestMethod.POST)\n     public ProcessLog create(@RequestBody String body) {\n         LandscapeDescription env = LandscapeDescriptionFactory.fromString(body, \"request body\");\n-        return indexer.index(env);\n+        //return indexer.index(env);\n+        IndexEvent event = new IndexEvent(this, env, \"create landscape\");\n+        publisher.publishEvent(event);\n+        return event.getProcessLog();\n+", "originalCommit": "ea8fa9b464ab862208572c8da5521c03d5f238a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA1NTg4OQ==", "url": "https://github.com/dedica-team/nivio/pull/345#discussion_r551055889", "bodyText": "Also the indexer is not needed anymore. We can remove line 46 and line 33!", "author": "mfbieber", "createdAt": "2021-01-03T21:22:56Z", "path": "src/main/java/de/bonndan/nivio/api/ApiController.java", "diffHunk": "@@ -30,18 +32,20 @@\n     private final InputFormatHandlerFactory formatFactory;\n     private final Indexer indexer;\n     private final LinkFactory linkFactory;\n+    private final ApplicationEventPublisher publisher;\n \n     public ApiController(LandscapeRepository landscapeRepository,\n                          LandscapeDescriptionFactory landscapeDescriptionFactory,\n                          InputFormatHandlerFactory formatFactory,\n                          Indexer indexer,\n-                         LinkFactory linkFactory\n-    ) {\n+                         LinkFactory linkFactory,\n+                         ApplicationEventPublisher publisher) {\n         this.landscapeRepository = landscapeRepository;\n         this.landscapeDescriptionFactory = landscapeDescriptionFactory;\n         this.formatFactory = formatFactory;\n         this.indexer = indexer;", "originalCommit": "ea8fa9b464ab862208572c8da5521c03d5f238a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYzNjEwMQ==", "url": "https://github.com/dedica-team/nivio/pull/345#discussion_r549636101", "bodyText": "Your solution is correct and fulfills the current API contract. \ud83d\udc4d\nHowever, @mfbieber is working on #212 to introduce reduce immutability everywhere. I suggest to change the API and return a simple json/hateoas response containing the link to the log (and the landscape) in every controller method. What also has changed in the meantime is that we do more async stuff (fetching external links) and can't (should not) wait for indexing completion anymore.\nWhat do you think @Ruchika8 @mfbieber ?", "author": "bonndan", "createdAt": "2020-12-29T09:36:38Z", "path": "src/main/java/de/bonndan/nivio/IndexEvent.java", "diffHunk": "@@ -15,6 +16,7 @@\n \n     private final String message;\n     private final LandscapeDescription landscapeDescription;\n+    private ProcessLog processLog;", "originalCommit": "ea8fa9b464ab862208572c8da5521c03d5f238a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI5Mjg2MA==", "url": "https://github.com/dedica-team/nivio/pull/345#discussion_r552292860", "bodyText": "I don't fully understand how it should work.\nThat the ApiController should return a JSON response containing the link to the log and to the landscape is fine. So this would be for indexLandscape() and create(), correct?\nWhat needs to change because of the async stuff would be this method in IndexEventListener, right?\n@Override\npublic void onApplicationEvent(IndexEvent event) {\n    LandscapeDescription description = event.getLandscape();\n    LOGGER.debug(\"Received index event for landscape {}\", description.getIdentifier());\n    event.setProcessLog(indexer.index(description)); \n}\n\nHow do we get a link to the ProcessLog and to the Landscape from there? And also before indexer.index(description) has been completed?\nRegarding the inmutability: I had a look at that and did not really know how to implement an inmutable IndexEvent. The ProcessLog is only available after the processing has been completed, so we must set it through the setter. An option would be to not locate the ProcessLog to the event. But then, to what should it belong then?", "author": "mfbieber", "createdAt": "2021-01-06T00:47:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYzNjEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM3ODIwMA==", "url": "https://github.com/dedica-team/nivio/pull/345#discussion_r552378200", "bodyText": "You got that right \ud83d\udc4d\nThe link to the process log is always available, e.g. https://nivio-demo.herokuapp.com/api/landscape/nivio:example/log and also already documented in hateoas (https://nivio-demo.herokuapp.com/api/nivio:example). So just sending back a hateoas response is consistent and easy to implement.\nHopefully the events are already immutable (implicitly) and we should keep them this way.", "author": "bonndan", "createdAt": "2021-01-06T05:32:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYzNjEwMQ=="}], "type": "inlineReview"}]}