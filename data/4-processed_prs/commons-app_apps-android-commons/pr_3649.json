{"pr_number": 3649, "pr_title": "Fixed logout problem #3547", "pr_createdAt": "2020-04-13T12:07:54Z", "pr_url": "https://github.com/commons-app/apps-android-commons/pull/3649", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ2MjM2OQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r407462369", "bodyText": "We should not do this, a) threads are expensive and b) Rx gives us the ability to switch threads easily\nYou can use andThen to execute another completable and keep the logoutListener on the main thread.\nIf you have any questions about Rx then please ask me", "author": "macgills", "createdAt": "2020-04-13T12:49:58Z", "path": "app/src/main/java/fr/free/nrw/commons/CommonsApplication.java", "diffHunk": "@@ -275,7 +275,7 @@ public void clearApplicationData(Context context, LogoutListener logoutListener)\n                     //TODO: fix preference manager\n                     defaultPrefs.clearAll();\n                     defaultPrefs.putBoolean(\"firstrun\", false);\n-                    updateAllDatabases();\n+                    new Thread(this::updateAllDatabases).start();", "originalCommit": "c36206d74ee25222dc752ce5fc30b7cf660bb19b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4OTUwOQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r407489509", "bodyText": "@macgills I never used andThen operator can you give some suggestions? Thanks!", "author": "gouri-panda", "createdAt": "2020-04-13T13:54:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ2MjM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5ODcxMw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r407498713", "bodyText": "example:\nCompletable.fromCallable{\nwriteSomeValuesToADatabase()\n}\n.subscribeOn(Schedlers.io())\n.andThen{\n Completable.fromCallable{\n  writeSomeValuesToAnotherDatabase() \n  }\n}\n.observeOn(AndroidSchedulers.mainThread())\n.subscribe {\n  updateTheUIBecauseWeAreOnTheUiThread()\n}\n\n\nthat is kinda of kotlin-y but that is what my pseudocode tends to look like nowadays", "author": "macgills", "createdAt": "2020-04-13T14:13:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ2MjM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyODYzMA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r407528630", "bodyText": "@macgills Should I use Completable.fromCallable or Completable.differ Thanks!", "author": "gouri-panda", "createdAt": "2020-04-13T15:10:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ2MjM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkzMTk3Nw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r407931977", "bodyText": "Generally you should use fromCallable.\nFromCallable can basically be written as\nCompletable.defer{\n  Completable.just(something)\n}\n\nif Completable had .just which it doesn't because that would be a little silly because a completable doesn't represent any values but a unit of work to be done.\nThis is more relevant to Flowable/Observable/Single/Maybe. Essentially it allows you to supply a factory for an Observable so that whenever it gets subscribed to it creates a new one", "author": "macgills", "createdAt": "2020-04-14T07:45:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ2MjM2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0MzE5MA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r407943190", "bodyText": "I would move everything but logoutListener to the new callable to preserve the original ordering, juuuust in case that actually matters", "author": "macgills", "createdAt": "2020-04-14T08:05:08Z", "path": "app/src/main/java/fr/free/nrw/commons/CommonsApplication.java", "diffHunk": "@@ -275,7 +280,6 @@ public void clearApplicationData(Context context, LogoutListener logoutListener)\n                     //TODO: fix preference manager\n                     defaultPrefs.clearAll();\n                     defaultPrefs.putBoolean(\"firstrun\", false);\n-                    updateAllDatabases();", "originalCommit": "209e590b417cf3ccc0830bf6d63b1bcf6390950e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk2MzkwMg==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r407963902", "bodyText": "Done:)", "author": "gouri-panda", "createdAt": "2020-04-14T08:39:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0MzE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk4MDE2OQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r407980169", "bodyText": "There has been a misunderstanding.\nOnly logoutListener should be in the subscribe/mainThread", "author": "macgills", "createdAt": "2020-04-14T09:04:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0MzE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk5NTQ4MA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r407995480", "bodyText": "preserve the original ordering\n\nThis has not been done, if we move code we shouldn't shuffle the lines up", "author": "macgills", "createdAt": "2020-04-14T09:28:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0MzE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk5NjY2Nw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r407996667", "bodyText": "Also please add some logging to the error emission of the Completable subscription, this is what was making this error difficult to detect", "author": "macgills", "createdAt": "2020-04-14T09:30:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0MzE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAwNTkwNA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r408005904", "bodyText": "This has not been done, if we move code we shouldn't shuffle the lines up\n\n@macgills should I do this  in order?\n sessionManager.logout()\n            .andThen(Completable.fromAction(() ->{\n                Timber.d(\"All accounts have been removed\");\n                clearImageCache();\n                //TODO: fix preference manager\n                defaultPrefs.clearAll();\n                defaultPrefs.putBoolean(\"firstrun\", false);\n                updateAllDatabases();\n\n                }\n            ))\n                .subscribeOn(Schedulers.io())\n                .observeOn(AndroidSchedulers.mainThread())\n                .subscribe(() -> {\n                    logoutListener.onLogoutComplete();\n                });", "author": "gouri-panda", "createdAt": "2020-04-14T09:44:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0MzE5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAwODA5Nw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r408008097", "bodyText": "Yes, as it originally appeared", "author": "macgills", "createdAt": "2020-04-14T09:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0MzE5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0NTAyNw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r407945027", "bodyText": "It is annoying we have to return null here, in kotlin the void return types analogue is Unit. You don't have to do any changes here I am pretty sure but be careful about null and Rx, it causes a crash in Single/Flowable/Observable since RxJava 2.0 with the introduction of Maybe to handle potentially null things", "author": "macgills", "createdAt": "2020-04-14T08:08:23Z", "path": "app/src/main/java/fr/free/nrw/commons/CommonsApplication.java", "diffHunk": "@@ -267,6 +268,10 @@ public void clearApplicationData(Context context, LogoutListener logoutListener)\n         }\n \n         sessionManager.logout()\n+            .andThen(Completable.fromCallable(() -> {\n+                updateAllDatabases();\n+                return null;", "originalCommit": "209e590b417cf3ccc0830bf6d63b1bcf6390950e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0NTg2Nw==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r407945867", "bodyText": "Actually we can get rid of the null, d'oh. Use Callable.fromAction", "author": "macgills", "createdAt": "2020-04-14T08:09:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0NTAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk2NDA2MQ==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r407964061", "bodyText": "Done:)", "author": "gouri-panda", "createdAt": "2020-04-14T08:39:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0NTAyNw=="}], "type": "inlineReview"}, {"oid": "4721e663981e9e4b4d3a3894c59a73eeb04b0817", "url": "https://github.com/commons-app/apps-android-commons/commit/4721e663981e9e4b4d3a3894c59a73eeb04b0817", "message": "fixed logout problem\n\nfixed logout problem\n\nfixed logout problem\n\nfixed logout problem\n\nfixed logout problem", "committedDate": "2020-04-14T09:56:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAyMDIxMg==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r408020212", "bodyText": "instead of doOnError you can use the 2 param version of subscribe", "author": "macgills", "createdAt": "2020-04-14T10:07:46Z", "path": "app/src/main/java/fr/free/nrw/commons/CommonsApplication.java", "diffHunk": "@@ -267,15 +268,19 @@ public void clearApplicationData(Context context, LogoutListener logoutListener)\n         }\n \n         sessionManager.logout()\n+            .andThen(Completable.fromAction(() ->{\n+                Timber.d(\"All accounts have been removed\");\n+                clearImageCache();\n+                //TODO: fix preference manager\n+                defaultPrefs.clearAll();\n+                defaultPrefs.putBoolean(\"firstrun\", false);\n+                updateAllDatabases();\n+\n+                }\n+            )).doOnError(Timber::e)", "originalCommit": "4721e663981e9e4b4d3a3894c59a73eeb04b0817", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAyMDUzNA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r408020534", "bodyText": "don't need this space", "author": "macgills", "createdAt": "2020-04-14T10:08:15Z", "path": "app/src/main/java/fr/free/nrw/commons/CommonsApplication.java", "diffHunk": "@@ -267,15 +268,19 @@ public void clearApplicationData(Context context, LogoutListener logoutListener)\n         }\n \n         sessionManager.logout()\n+            .andThen(Completable.fromAction(() ->{\n+                Timber.d(\"All accounts have been removed\");\n+                clearImageCache();\n+                //TODO: fix preference manager\n+                defaultPrefs.clearAll();\n+                defaultPrefs.putBoolean(\"firstrun\", false);\n+                updateAllDatabases();\n+", "originalCommit": "4721e663981e9e4b4d3a3894c59a73eeb04b0817", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "57a5cde9af858e1b675e67ac18bfdeeec07df39e", "url": "https://github.com/commons-app/apps-android-commons/commit/57a5cde9af858e1b675e67ac18bfdeeec07df39e", "message": "added error handling on logout", "committedDate": "2020-04-14T10:12:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAzMjM3MA==", "url": "https://github.com/commons-app/apps-android-commons/pull/3649#discussion_r408032370", "bodyText": "ahhh pretty pretty method references", "author": "macgills", "createdAt": "2020-04-14T10:28:34Z", "path": "app/src/main/java/fr/free/nrw/commons/CommonsApplication.java", "diffHunk": "@@ -275,14 +275,11 @@ public void clearApplicationData(Context context, LogoutListener logoutListener)\n                 defaultPrefs.clearAll();\n                 defaultPrefs.putBoolean(\"firstrun\", false);\n                 updateAllDatabases();\n-\n                 }\n-            )).doOnError(Timber::e)\n-                .subscribeOn(Schedulers.io())\n-                .observeOn(AndroidSchedulers.mainThread())\n-                .subscribe(() -> {\n-                    logoutListener.onLogoutComplete();\n-                });\n+            ))\n+            .subscribeOn(Schedulers.io())\n+            .observeOn(AndroidSchedulers.mainThread())\n+            .subscribe(logoutListener::onLogoutComplete, Timber::e);", "originalCommit": "57a5cde9af858e1b675e67ac18bfdeeec07df39e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}