{"pr_number": 181, "pr_title": "fix: stop preparing session on most errors", "pr_createdAt": "2020-04-25T07:12:18Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/181", "timeline": [{"oid": "3cfe1062db7cfd06cc0890558132f1b0f40c1620", "url": "https://github.com/googleapis/java-spanner/commit/3cfe1062db7cfd06cc0890558132f1b0f40c1620", "message": "fix: stop preparing session on most errors\n\nMost errors that occur during preparing a session for a read/write\ntransaction should be considered permanent, and should stop the\nautomatic preparing of sessions. Any subsequent call to get a read/write\nsession will cause an in-process BeginTransaction RPC to be executed. If\nthe problem has been fixed in the meantime, the RPC will succeed and the\nautomatic prepare of sessions will start again. Otherwise, the error is\npropagated to the user.\n\nFixes #177", "committedDate": "2020-04-26T20:59:29Z", "type": "commit"}, {"oid": "3cfe1062db7cfd06cc0890558132f1b0f40c1620", "url": "https://github.com/googleapis/java-spanner/commit/3cfe1062db7cfd06cc0890558132f1b0f40c1620", "message": "fix: stop preparing session on most errors\n\nMost errors that occur during preparing a session for a read/write\ntransaction should be considered permanent, and should stop the\nautomatic preparing of sessions. Any subsequent call to get a read/write\nsession will cause an in-process BeginTransaction RPC to be executed. If\nthe problem has been fixed in the meantime, the RPC will succeed and the\nautomatic prepare of sessions will start again. Otherwise, the error is\npropagated to the user.\n\nFixes #177", "committedDate": "2020-04-26T20:59:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ4ODcxOQ==", "url": "https://github.com/googleapis/java-spanner/pull/181#discussion_r415488719", "bodyText": "In the previous logic, we executed this logic also for PERMISSION_DENIED errors. It doesn't anymore. Is this a problem?", "author": "skuruppu", "createdAt": "2020-04-27T03:42:38Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java", "diffHunk": "@@ -1696,25 +1716,30 @@ private void handlePrepareSessionFailure(\n     synchronized (lock) {\n       if (isSessionNotFound(e)) {\n         invalidateSession(session);\n-      } else if (isDatabaseOrInstanceNotFound(e) || isPermissionDenied(e)) {\n-        // Database has been deleted or the user has no permission to write to this database. We\n-        // should stop trying to prepare any transactions. Also propagate the error to all waiters,\n-        // as any further waiting is pointless.\n+      } else if (shouldStopPrepareSessions(e)) {\n+        // Database has been deleted or the user has no permission to write to this database, or\n+        // there is some other semi-permanent error. We should stop trying to prepare any\n+        // transactions. Also propagate the error to all waiters if the database or instance has\n+        // been deleted, as any further waiting is pointless.\n+        stopAutomaticPrepare = true;\n         while (readWriteWaiters.size() > 0) {\n           readWriteWaiters.poll().put(e);\n         }\n         while (readWaiters.size() > 0) {\n           readWaiters.poll().put(e);\n         }\n-        // Remove the session from the pool.\n-        allSessions.remove(session);\n-        if (isClosed()) {\n-          decrementPendingClosures(1);\n+        if (isDatabaseOrInstanceNotFound(e)) {\n+          // Remove the session from the pool.\n+          if (isClosed()) {\n+            decrementPendingClosures(1);\n+          }\n+          allSessions.remove(session);\n+          this.resourceNotFoundException =\n+              MoreObjects.firstNonNull(\n+                  this.resourceNotFoundException, (ResourceNotFoundException) e);", "originalCommit": "3cfe1062db7cfd06cc0890558132f1b0f40c1620", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2NDk5NA==", "url": "https://github.com/googleapis/java-spanner/pull/181#discussion_r415564994", "bodyText": "No, it is still executed for PERMISSION_DENIED errors, but that is now covered by the general error handling that also handles other types of errors. The specific errors DatabaseNotFound and InstanceNotFound are handled specifically, as these should not allow the normal operation of the session pool to be restarted once the error does no longer occur. The reasoning behind that is that a DatabaseNotFound exception can only be fixed by creating a new database with the same name as the old one, but that is still a new database.\nThe other errors, such as PERMISSION_DENIED and now also for examle FAILED_PRECONDITION, should allow the session pool to restart the automatic preparing of sessions once the error has been fixed. This could be granting the user the necessary permissions or changing the state of database to fulfill all requirements.", "author": "olavloite", "createdAt": "2020-04-27T07:10:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQ4ODcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU2NTIyNw==", "url": "https://github.com/googleapis/java-spanner/pull/181#discussion_r415565227", "bodyText": "This test case covers the PERMISSION_DENIED case discussed above.", "author": "olavloite", "createdAt": "2020-04-27T07:11:22Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/DatabaseClientImplTest.java", "diffHunk": "@@ -469,12 +469,25 @@ public void testDatabaseOrInstanceDoesNotExistOnReplenish() throws Exception {\n \n   @Test\n   public void testPermissionDeniedOnPrepareSession() throws Exception {", "originalCommit": "3cfe1062db7cfd06cc0890558132f1b0f40c1620", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}