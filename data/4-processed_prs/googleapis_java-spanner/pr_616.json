{"pr_number": 616, "pr_title": "fix: session retry could cause infinite wait", "pr_createdAt": "2020-11-11T13:15:14Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/616", "timeline": [{"oid": "730d678ea400f4f8ae5c1cb8b428a688b166ab90", "url": "https://github.com/googleapis/java-spanner/commit/730d678ea400f4f8ae5c1cb8b428a688b166ab90", "message": "fix: session retry could cause infinite wait\n\nA \"Session not found\" when using an AsyncTransactionManager could cause an\ninfinite wait for an ApiFuture that would never be done.\n\nFixes #605", "committedDate": "2020-11-11T13:12:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM1MDYwMw==", "url": "https://github.com/googleapis/java-spanner/pull/616#discussion_r521350603", "bodyText": "This missing statement was what could cause the infinite wait. The result of this specific statement would never be done if the previous statement (input) would fail.", "author": "olavloite", "createdAt": "2020-11-11T13:16:49Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/TransactionContextFutureImpl.java", "diffHunk": "@@ -109,6 +109,7 @@ public Timestamp get(long timeout, TimeUnit unit)\n             @Override\n             public void onFailure(Throwable t) {\n               mgr.onError(t);\n+              statementResult.setException(t);", "originalCommit": "730d678ea400f4f8ae5c1cb8b428a688b166ab90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM1MTAzNQ==", "url": "https://github.com/googleapis/java-spanner/pull/616#discussion_r521351035", "bodyText": "This check is no longer needed here as it is checked in the SessionPoolAsyncTransactionManager.", "author": "olavloite", "createdAt": "2020-11-11T13:17:34Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/AsyncTransactionManagerImpl.java", "diffHunk": "@@ -174,10 +176,6 @@ public void onSuccess(Timestamp result) {\n \n   @Override\n   public TransactionContextFuture resetForRetryAsync() {\n-    if (txn == null || (!txn.isAborted() && txnState != TransactionState.ABORTED)) {", "originalCommit": "730d678ea400f4f8ae5c1cb8b428a688b166ab90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM1MzA4MA==", "url": "https://github.com/googleapis/java-spanner/pull/616#discussion_r521353080", "bodyText": "This makes sure that the AsyncTransactionManager will return an ApiFuture with exception Aborted if the transaction has already been aborted by an asynchronous statement that has not yet been checked by the application, e.g. (simplified):\ntxn.updateAsync(...); // This aborts the transaction, but the status of the returned ApiFuture is not checked by the application.\n...\ntxn.commitAsync();", "author": "olavloite", "createdAt": "2020-11-11T13:21:04Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPoolAsyncTransactionManager.java", "diffHunk": "@@ -167,9 +171,12 @@ public void onError(Throwable t) {\n   public ApiFuture<Timestamp> commitAsync() {\n     synchronized (lock) {\n       Preconditions.checkState(\n-          txnState == TransactionState.STARTED,\n+          txnState == TransactionState.STARTED || txnState == TransactionState.ABORTED,\n           \"commit can only be invoked if the transaction is in progress. Current state: \"\n               + txnState);\n+      if (txnState == TransactionState.ABORTED) {", "originalCommit": "730d678ea400f4f8ae5c1cb8b428a688b166ab90", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}