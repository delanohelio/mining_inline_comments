{"pr_number": 203, "pr_title": "fix: Partitioned DML timeout was not always respected", "pr_createdAt": "2020-05-13T13:52:09Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/203", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3MzY2MA==", "url": "https://github.com/googleapis/java-spanner/pull/203#discussion_r424873660", "bodyText": "Are PDML requests not meant to be retried? I'm just curious why the initial and max timeouts are the same.", "author": "skuruppu", "createdAt": "2020-05-14T05:08:50Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java", "diffHunk": "@@ -326,6 +330,22 @@ public GapicSpannerRpc(final SpannerOptions options) {\n                   .setCredentialsProvider(credentialsProvider)\n                   .setStreamWatchdogProvider(watchdogProvider)\n                   .build());\n+      SpannerStubSettings.Builder pdmlSettings = options.getSpannerStubSettings().toBuilder();\n+      pdmlSettings\n+          .setTransportChannelProvider(channelProvider)\n+          .setCredentialsProvider(credentialsProvider)\n+          .setStreamWatchdogProvider(watchdogProvider)\n+          .executeSqlSettings()\n+          .setRetrySettings(\n+              options\n+                  .getSpannerStubSettings()\n+                  .executeSqlSettings()\n+                  .getRetrySettings()\n+                  .toBuilder()\n+                  .setInitialRpcTimeout(options.getPartitionedDmlTimeout())\n+                  .setMaxRpcTimeout(options.getPartitionedDmlTimeout())", "originalCommit": "2ceb59164d6f4ee1740a37e61741bd6a5a5d8004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NTY1Nw==", "url": "https://github.com/googleapis/java-spanner/pull/203#discussion_r424885657", "bodyText": "Good question.\nI would say it's a a matter of probabilities and a little bit opinion:\n\nPDML is designed to accept long running update statements. That means that we should not automatically retry the statement if it takes longer than X time, as it would be impossible to find a good global value for X, as we don't know whether the statement is taking a long time because of a network problem or because the statement itself is taking a long time. Re-sending a long-running statement that is still running on the server would only hurt performance. My opinion is that for a PDML statement the chance that the statement is actually taking a long time is more probable than a network problem.\nThe PDML documentation also clearly states that the update statement should be idempotent. This means that we should automatically retry it if the server is unavailable.\n\nI think we should consider adding an additional method to the public API which would allow the users to specify a lower timeout for a specific statement, in addition to the current global setting. That would give the user more control over the timeout setting for statements that are known to take less time than the global setting.", "author": "olavloite", "createdAt": "2020-05-14T05:52:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3MzY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5NTAzNQ==", "url": "https://github.com/googleapis/java-spanner/pull/203#discussion_r424895035", "bodyText": "I've added an extra test case to ensure that PDML is retried on UNAVAILABLE.", "author": "olavloite", "createdAt": "2020-05-14T06:20:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3MzY2MA=="}], "type": "inlineReview"}, {"oid": "1bcbf5ed69f0ed736a910ce4f9476e6b790b469e", "url": "https://github.com/googleapis/java-spanner/commit/1bcbf5ed69f0ed736a910ce4f9476e6b790b469e", "message": "fix: Partitioned DML timeout was not always respected\n\nSetting a timeout value for Partitioned DML would not be respected if the timeout\nvalue was higher than the timeout value set for the ExecuteSql RPC on the SpannerStub.\nLower timeout values would be respected.\n\nFixes #199", "committedDate": "2020-05-14T06:20:00Z", "type": "commit"}, {"oid": "afbb2c4dbd667a2dd74f63f4babf1c8904475a6c", "url": "https://github.com/googleapis/java-spanner/commit/afbb2c4dbd667a2dd74f63f4babf1c8904475a6c", "message": "fix: add ignored changes + InternalApi", "committedDate": "2020-05-14T06:20:00Z", "type": "commit"}, {"oid": "aac7cf76218f75f6f55ef18426438b9a8d9ba6d4", "url": "https://github.com/googleapis/java-spanner/commit/aac7cf76218f75f6f55ef18426438b9a8d9ba6d4", "message": "tests: add test for retry on UNAVAILABLE", "committedDate": "2020-05-14T06:20:00Z", "type": "commit"}, {"oid": "aac7cf76218f75f6f55ef18426438b9a8d9ba6d4", "url": "https://github.com/googleapis/java-spanner/commit/aac7cf76218f75f6f55ef18426438b9a8d9ba6d4", "message": "tests: add test for retry on UNAVAILABLE", "committedDate": "2020-05-14T06:20:00Z", "type": "forcePushed"}]}