{"pr_number": 608, "pr_title": "feat!: add CommitStats to Connection API", "pr_createdAt": "2020-11-06T19:34:07Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/608", "timeline": [{"oid": "38721994a0dd1589723b4a572de9c492a75337b6", "url": "https://github.com/googleapis/java-spanner/commit/38721994a0dd1589723b4a572de9c492a75337b6", "message": "feat!: add support for CommitStats\n\nAdds support for returning CommitStats from read/write transactions.", "committedDate": "2020-10-24T10:57:36Z", "type": "commit"}, {"oid": "def876854f2dad9fe1568cd419f439f2b28fd1e6", "url": "https://github.com/googleapis/java-spanner/commit/def876854f2dad9fe1568cd419f439f2b28fd1e6", "message": "fix: add clirr ignored differences", "committedDate": "2020-10-24T11:47:42Z", "type": "commit"}, {"oid": "5372dae4e6470401cbfcd2db1e071ab9db7ca7c8", "url": "https://github.com/googleapis/java-spanner/commit/5372dae4e6470401cbfcd2db1e071ab9db7ca7c8", "message": "Merge branch 'master' into commit-stats2", "committedDate": "2020-10-31T07:26:51Z", "type": "commit"}, {"oid": "34fbda64201c9690b6a5b5619050c86cdb32d897", "url": "https://github.com/googleapis/java-spanner/commit/34fbda64201c9690b6a5b5619050c86cdb32d897", "message": "fix: error message should start with getCommitResponse\n\nCo-authored-by: skuruppu <skuruppu@google.com>", "committedDate": "2020-10-31T07:30:04Z", "type": "commit"}, {"oid": "8f61c2ab991eec6c028e31f65e27dcc1295e17e9", "url": "https://github.com/googleapis/java-spanner/commit/8f61c2ab991eec6c028e31f65e27dcc1295e17e9", "message": "Merge branch 'master' into commit-stats2", "committedDate": "2020-11-06T12:06:33Z", "type": "commit"}, {"oid": "47b57ea6427a00c5826af6797607b3b06fba58e7", "url": "https://github.com/googleapis/java-spanner/commit/47b57ea6427a00c5826af6797607b3b06fba58e7", "message": "feat: add CommitStats to Connection API", "committedDate": "2020-11-06T19:32:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2MjA4MA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r518962080", "bodyText": "This was a missing piece of configuration that was still in the JDBC repository, but that belongs in the Connection API. It is a Maven profile for automatically generating tests for new client side SQL statements.", "author": "olavloite", "createdAt": "2020-11-06T19:34:53Z", "path": "google-cloud-spanner/pom.xml", "diffHunk": "@@ -377,5 +377,38 @@\n         </plugins>\n       </build>\n     </profile>\n+    <profile>", "originalCommit": "47b57ea6427a00c5826af6797607b3b06fba58e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ4OTc5NQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r519489795", "bodyText": "Could we add this as a separate PR? Otherwise we won't have this until the commit stats is merged into master.", "author": "thiagotnunes", "createdAt": "2020-11-08T23:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2MjA4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU5NjAyMQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r519596021", "bodyText": "Good point, I've added #611 for that, and I'll remove it from this PR.", "author": "olavloite", "createdAt": "2020-11-09T07:22:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2MjA4MA=="}], "type": "inlineReview"}, {"oid": "a9014bcb4ed381e3a62c297cdaa429e65236d4a0", "url": "https://github.com/googleapis/java-spanner/commit/a9014bcb4ed381e3a62c297cdaa429e65236d4a0", "message": "fix: combine commit timestamp and response methods", "committedDate": "2020-11-06T19:41:48Z", "type": "commit"}, {"oid": "1063ced85f2ae88d1e6270eeaf95785f324a79ed", "url": "https://github.com/googleapis/java-spanner/commit/1063ced85f2ae88d1e6270eeaf95785f324a79ed", "message": "fix: clirr-diff and add some tests", "committedDate": "2020-11-07T07:00:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ4OTY1NQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r519489655", "bodyText": "Is this part of this PR? Maybe we forgot to do something in the query stats (optimizer_version) feature?", "author": "thiagotnunes", "createdAt": "2020-11-08T22:59:42Z", "path": "google-cloud-spanner/src/test/resources/com/google/cloud/spanner/connection/ClientSideStatementsTest.sql", "diffHunk": "@@ -1931,9148 +1931,11005 @@ NEW_CONNECTION;\n @EXPECT EXCEPTION INVALID_ARGUMENT\n show variable/-read_only_staleness;\n NEW_CONNECTION;\n-begin;\n+show variable optimizer_version;", "originalCommit": "1063ced85f2ae88d1e6270eeaf95785f324a79ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU5MTkzNw==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r519591937", "bodyText": "I forgot to regenerate the test sql files for the optimizer_version feature, so that's why that is included here. The generator does not support generating tests for only some features, so it's impossible to keep that change separate from the changes for CommitStats without completely rewriting the generator.", "author": "olavloite", "createdAt": "2020-11-09T07:16:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ4OTY1NQ=="}], "type": "inlineReview"}, {"oid": "2f56c29506bb0611c98729ae9916519e358179b4", "url": "https://github.com/googleapis/java-spanner/commit/2f56c29506bb0611c98729ae9916519e358179b4", "message": "fix: remove profile change from this PR", "committedDate": "2020-11-09T07:22:52Z", "type": "commit"}, {"oid": "041b34de0ba334d01dc70052712fec17fa049b7c", "url": "https://github.com/googleapis/java-spanner/commit/041b34de0ba334d01dc70052712fec17fa049b7c", "message": "Merge branch 'master' into commit-stats2", "committedDate": "2020-12-05T09:27:25Z", "type": "commit"}, {"oid": "df7273a59f1766a941dd43ef8afb24f9698f75ec", "url": "https://github.com/googleapis/java-spanner/commit/df7273a59f1766a941dd43ef8afb24f9698f75ec", "message": "Merge branch 'master' into connection-api-commit-stats", "committedDate": "2020-12-05T09:36:34Z", "type": "commit"}, {"oid": "82990542eef1c43d58b50ace3e54c36406ef9d9a", "url": "https://github.com/googleapis/java-spanner/commit/82990542eef1c43d58b50ace3e54c36406ef9d9a", "message": "fix: remove overload delay", "committedDate": "2020-12-10T19:12:11Z", "type": "commit"}, {"oid": "9b710a76f3cf947a2df5576f0c1c5eda3b43b9ff", "url": "https://github.com/googleapis/java-spanner/commit/9b710a76f3cf947a2df5576f0c1c5eda3b43b9ff", "message": "Merge branch 'master' into commit-stats2", "committedDate": "2020-12-10T19:12:16Z", "type": "commit"}, {"oid": "9a2e55557678fd5345bb411282db4d7b8d00512d", "url": "https://github.com/googleapis/java-spanner/commit/9a2e55557678fd5345bb411282db4d7b8d00512d", "message": "Merge branch 'master' into connection-api-commit-stats", "committedDate": "2020-12-11T17:13:14Z", "type": "commit"}, {"oid": "57a10a8c52a50ac749077de6b05f7132cc4027fa", "url": "https://github.com/googleapis/java-spanner/commit/57a10a8c52a50ac749077de6b05f7132cc4027fa", "message": "fix: remove overload delay", "committedDate": "2020-12-11T17:20:23Z", "type": "commit"}, {"oid": "88c2d838f0d789fb4a15f08c897195304bc18114", "url": "https://github.com/googleapis/java-spanner/commit/88c2d838f0d789fb4a15f08c897195304bc18114", "message": "Merge branch 'commit-stats2' into connection-api-commit-stats", "committedDate": "2020-12-11T17:21:02Z", "type": "commit"}, {"oid": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "url": "https://github.com/googleapis/java-spanner/commit/043555d3a2ea76755c5e8a7725edaa65ed0418cc", "message": "fix: fix test failure", "committedDate": "2020-12-11T17:35:19Z", "type": "commit"}, {"oid": "8c15641f07c55dea211aa714f45d9f7da8201aaa", "url": "https://github.com/googleapis/java-spanner/commit/8c15641f07c55dea211aa714f45d9f7da8201aaa", "message": "Merge branch 'master' into commit-stats2", "committedDate": "2021-01-23T13:51:09Z", "type": "commit"}, {"oid": "919cf028377a3dc224c5c870b8129aae52d1f911", "url": "https://github.com/googleapis/java-spanner/commit/919cf028377a3dc224c5c870b8129aae52d1f911", "message": "chore: cleanup after merge", "committedDate": "2021-01-23T13:51:34Z", "type": "commit"}, {"oid": "97ec9175bee38ba64aadb960d6efdf57a5ad2b20", "url": "https://github.com/googleapis/java-spanner/commit/97ec9175bee38ba64aadb960d6efdf57a5ad2b20", "message": "fix: update copyright years of new files", "committedDate": "2021-01-23T14:01:16Z", "type": "commit"}, {"oid": "afeb0fd86a8248a244a5b52cbf4e2065db65bf30", "url": "https://github.com/googleapis/java-spanner/commit/afeb0fd86a8248a244a5b52cbf4e2065db65bf30", "message": "test: fix flaky test", "committedDate": "2021-01-23T14:25:16Z", "type": "commit"}, {"oid": "8524526a0588ae7d942199a2f831473b70d4a0d1", "url": "https://github.com/googleapis/java-spanner/commit/8524526a0588ae7d942199a2f831473b70d4a0d1", "message": "test: skip commit stats tests on emulator", "committedDate": "2021-01-23T15:20:09Z", "type": "commit"}, {"oid": "06b3e22760a5d5a968717250f0f260cc2d7ecf11", "url": "https://github.com/googleapis/java-spanner/commit/06b3e22760a5d5a968717250f0f260cc2d7ecf11", "message": "test: missed one commit stats tests against emulator", "committedDate": "2021-01-23T15:32:35Z", "type": "commit"}, {"oid": "1c17d16efddb1839884376c6066faadce8181684", "url": "https://github.com/googleapis/java-spanner/commit/1c17d16efddb1839884376c6066faadce8181684", "message": "test: skip another emulator test", "committedDate": "2021-01-23T15:47:36Z", "type": "commit"}, {"oid": "664b87daf36668699cbc54dfc544ef64616f6da2", "url": "https://github.com/googleapis/java-spanner/commit/664b87daf36668699cbc54dfc544ef64616f6da2", "message": "test: add missing test cases", "committedDate": "2021-01-23T19:45:21Z", "type": "commit"}, {"oid": "6573a0f7fe07f75ab9ed8e0e1d474540b5cb6b70", "url": "https://github.com/googleapis/java-spanner/commit/6573a0f7fe07f75ab9ed8e0e1d474540b5cb6b70", "message": "fix: address review comments", "committedDate": "2021-01-30T16:10:03Z", "type": "commit"}, {"oid": "0b448c3824eedc617647aa599be346a3b754b6fe", "url": "https://github.com/googleapis/java-spanner/commit/0b448c3824eedc617647aa599be346a3b754b6fe", "message": "Merge branch 'master' into commit-stats2", "committedDate": "2021-02-01T09:34:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ1NjM5NQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569456395", "bodyText": "worth a test", "author": "elharo", "createdAt": "2021-02-03T14:26:22Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/CommitResponse.java", "diffHunk": "@@ -34,6 +34,11 @@ public Timestamp getCommitTimestamp() {\n     return Timestamp.fromProto(proto.getCommitTimestamp());\n   }\n \n+  /** @return true if the {@link CommitResponse} includes {@link CommitStats}. */\n+  public boolean hasCommitStats() {", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTYyNzY5Ng==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569627696", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T17:58:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ1NjM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ1Nzk5Nw==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569457997", "bodyText": "This is a little too complex to read as a ternary. Consider using if blocks.", "author": "elharo", "createdAt": "2021-02-03T14:28:18Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionStatementExecutorImpl.java", "diffHunk": "@@ -170,6 +181,26 @@ public StatementResult statementShowCommitTimestamp() {\n         \"COMMIT_TIMESTAMP\", getConnection().getCommitTimestampOrNull(), SHOW_COMMIT_TIMESTAMP);\n   }\n \n+  @Override\n+  public StatementResult statementShowCommitResponse() {\n+    CommitResponse response = getConnection().getCommitResponseOrNull();\n+    CommitStats stats =\n+        response == null || !response.hasCommitStats() ? null : response.getCommitStats();", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTYyODg4Mg==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569628882", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T17:59:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ1Nzk5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ1ODIwNA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569458204", "bodyText": "rs --> resultSet per google style", "author": "elharo", "createdAt": "2021-02-03T14:28:33Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionStatementExecutorImpl.java", "diffHunk": "@@ -170,6 +181,26 @@ public StatementResult statementShowCommitTimestamp() {\n         \"COMMIT_TIMESTAMP\", getConnection().getCommitTimestampOrNull(), SHOW_COMMIT_TIMESTAMP);\n   }\n \n+  @Override\n+  public StatementResult statementShowCommitResponse() {\n+    CommitResponse response = getConnection().getCommitResponseOrNull();\n+    CommitStats stats =\n+        response == null || !response.hasCommitStats() ? null : response.getCommitStats();\n+    ResultSet rs =", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTYzMTAyOA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569631028", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T18:03:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ1ODIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ1ODc5Mg==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569458792", "bodyText": "needs a test", "author": "elharo", "createdAt": "2021-02-03T14:29:16Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/DdlBatch.java", "diffHunk": "@@ -168,6 +169,17 @@ public Timestamp getCommitTimestampOrNull() {\n     return null;\n   }\n \n+  @Override\n+  public CommitResponse getCommitResponse() {\n+    throw SpannerExceptionFactory.newSpannerException(\n+        ErrorCode.FAILED_PRECONDITION, \"There is no commit response available for DDL batches.\");\n+  }\n+\n+  @Override\n+  public CommitResponse getCommitResponseOrNull() {", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTY3MTI2OA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569671268", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T19:04:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ1ODc5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ1OTk3Nw==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569459977", "bodyText": "This is a code smell suggests that perhaps getCommitResponse does not belong in the superclass/interface in the first place since it doesn't apply to all subclasses.", "author": "elharo", "createdAt": "2021-02-03T14:30:44Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/DdlBatch.java", "diffHunk": "@@ -168,6 +169,17 @@ public Timestamp getCommitTimestampOrNull() {\n     return null;\n   }\n \n+  @Override\n+  public CommitResponse getCommitResponse() {\n+    throw SpannerExceptionFactory.newSpannerException(\n+        ErrorCode.FAILED_PRECONDITION, \"There is no commit response available for DDL batches.\");", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTY4OTM3NA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569689374", "bodyText": "This is a package private class (extending from a package private interface), so it is not something that client applications will deal with. Client applications only interact with the Connection interface. (And client applications in this case is only intended to be frameworks /drivers that implement a declarative connection-type interface, such as JDBC.)\nThese declarative style APIs often mean that certain methods are only applicable in certain states, and this is what is also reflected in these classes. The method that client applications will interact with is Connection#getCommitResponse(). This method will delegate the actual response to the at that moment active UnitOfWork on the Connection. The different UnitOfWork implementations will respond based on what they support, which may also be that they do not support it.", "author": "olavloite", "createdAt": "2021-02-03T19:29:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ1OTk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTk4Njg0OQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r581986849", "bodyText": "Have you considered returning an empty object or null instead?\nIf clients really won't see this, fine. However it's not enough that this class is non-public. They could still invoke this method if they get an instance of it, even while only knowing its supertype.", "author": "elharo", "createdAt": "2021-02-24T14:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ1OTk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjE5MjcyOA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r582192728", "bodyText": "Returning null or an empty object here would only move the logic to the ConnectionImpl class, which should throw an exception if it is not in a valid state to return CommitStats at that moment (for example because a DDL batch is active). This logic is therefore delegated to the concrete implementations of UnitOfWork.\nThis class and its super types are all package private and or not accessible from outside the library.", "author": "olavloite", "createdAt": "2021-02-24T18:18:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ1OTk3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2MDUyNw==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569460527", "bodyText": "Doubles my suspicion that this doesn't belong in the superclass.", "author": "elharo", "createdAt": "2021-02-03T14:31:25Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/DmlBatch.java", "diffHunk": "@@ -119,6 +120,17 @@ public Timestamp getCommitTimestampOrNull() {\n     return null;\n   }\n \n+  @Override\n+  public CommitResponse getCommitResponse() {", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTY4OTQzNQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569689435", "bodyText": "See above.", "author": "olavloite", "createdAt": "2021-02-03T19:29:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2MDUyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2MDkxNQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569460915", "bodyText": "Now there are three instances where this method doesn't make sense.\nMaybe you can construct a commit response for these cases where the server doesn't return one, but maybe the API isn't in the right place.", "author": "elharo", "createdAt": "2021-02-03T14:31:57Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ReadOnlyTransaction.java", "diffHunk": "@@ -136,6 +137,18 @@ public Timestamp getCommitTimestampOrNull() {\n     return null;\n   }\n \n+  @Override\n+  public CommitResponse getCommitResponse() {", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTY4OTU1MA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569689550", "bodyText": "See above.", "author": "olavloite", "createdAt": "2021-02-03T19:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2MDkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2MzQyMQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569463421", "bodyText": "I originally thought this meant the response wasn't available yet, but if it means this object doesn't support commit responses, then I'm again suspecting the API needs some further thought.", "author": "elharo", "createdAt": "2021-02-03T14:35:06Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ReadWriteTransaction.java", "diffHunk": "@@ -254,19 +265,30 @@ public Timestamp getReadTimestampOrNull() {\n     return null;\n   }\n \n-  private boolean hasCommitTimestamp() {\n-    return commitTimestampFuture != null;\n+  private boolean hasCommitResponse() {", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTY3NTY4Nw==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569675687", "bodyText": "For this class your initial thought is correct. This indicates that the commit response is not yet available, because the transaction has not yet committed. Once the transaction has been committed, a commit response will be available.", "author": "olavloite", "createdAt": "2021-02-03T19:08:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2MzQyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NDEyMg==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569464122", "bodyText": "Will throw --> Throws", "author": "elharo", "createdAt": "2021-02-03T14:35:55Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/UnitOfWork.java", "diffHunk": "@@ -142,6 +143,18 @@ public boolean isActive() {\n   /** @return the commit timestamp of this transaction or null if there is no commit timestamp. */\n   Timestamp getCommitTimestampOrNull();\n \n+  /**\n+   * @return the {@link CommitResponse} of this transaction. Will throw a {@link SpannerException}", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTY4OTg5MA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569689890", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T19:30:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NDEyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NDI5MQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569464291", "bodyText": "no period", "author": "elharo", "createdAt": "2021-02-03T14:36:06Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/UnitOfWork.java", "diffHunk": "@@ -142,6 +143,18 @@ public boolean isActive() {\n   /** @return the commit timestamp of this transaction or null if there is no commit timestamp. */\n   Timestamp getCommitTimestampOrNull();\n \n+  /**\n+   * @return the {@link CommitResponse} of this transaction. Will throw a {@link SpannerException}\n+   *     if there is no {@link CommitResponse}.\n+   */\n+  CommitResponse getCommitResponse();\n+\n+  /**\n+   * @return the {@link CommitResponse} of this transaction or null if there is no {@link\n+   *     CommitResponse}.", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTY5MDEyMw==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569690123", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T19:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NDI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NTI3Ng==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569465276", "bodyText": "You don't need both these methods. Even if these methods are left here, all we need is a single getCommitResponse method that returns a commit response or null.", "author": "elharo", "createdAt": "2021-02-03T14:37:20Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/UnitOfWork.java", "diffHunk": "@@ -142,6 +143,18 @@ public boolean isActive() {\n   /** @return the commit timestamp of this transaction or null if there is no commit timestamp. */\n   Timestamp getCommitTimestampOrNull();\n \n+  /**\n+   * @return the {@link CommitResponse} of this transaction. Will throw a {@link SpannerException}\n+   *     if there is no {@link CommitResponse}.\n+   */\n+  CommitResponse getCommitResponse();\n+\n+  /**\n+   * @return the {@link CommitResponse} of this transaction or null if there is no {@link\n+   *     CommitResponse}.\n+   */\n+  CommitResponse getCommitResponseOrNull();", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTY5NzE1MA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569697150", "bodyText": "This is not intended for public use (it's a package private interface). The reason that there are two different versions is that some APIs require a method to throw an error if the connection / transaction is not in a valid state for a specific method call, and in other cases it expects it to return null.", "author": "olavloite", "createdAt": "2021-02-03T19:41:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NTI3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE5MDg5Nw==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570190897", "bodyText": "Which APIs? It sounds like the responsibility for interpreting and handling a null return or an exception belongs in those methods.", "author": "elharo", "createdAt": "2021-02-04T12:39:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NTI3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDg4Mzk0NA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r580883944", "bodyText": "The two APIs being served are:\n\nThe Connection interface with its getCommitResponse() and other similar methods. These all throw an exception if they are called while the Connection is in an invalid state for the method.\nThe interpreted SQL interface which will return a ResultSet with a null value if there is no commit response available at that moment.\n\nThe Connection interface could use the getCommitResponseOrNull() method, check for a null value and then throw an exception. The disadvantage of that would be that the Connection does not know why the value is null, and can therefore only throw an exception with a generic message. By delegating the exception that should be thrown to the UnitOfWork, the UnitOfWork can throw an exception with a more specific message indicating why there is no commit response.", "author": "olavloite", "createdAt": "2021-02-23T09:30:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NTI3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NjExOQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569466119", "bodyText": "if blocks in tests are code smells. Only one path is taken and tested. Does isGetCommitTimestampAllowed() return true or false here?", "author": "elharo", "createdAt": "2021-02-03T14:38:19Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/AbstractConnectionImplTest.java", "diffHunk": "@@ -735,6 +735,22 @@ public void testGetCommitTimestamp() {\n     }\n   }\n \n+  @Test\n+  public void testGetCommitResponse() {\n+    try (Connection connection = getConnection()) {\n+      if (isGetCommitTimestampAllowed()) {", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcyMTAyNA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569721024", "bodyText": "This and the other methods in this abstract test class are used to test that a Connection responds correctly in all possible states that it can be. The specific state of a Connection is implemented in a concrete subclass, and that determines whether isGetCommitTimestampAllowed() will return true or false.\nExample 1: ConnectionImplAutocommitReadWriteNoActionsTest verifies that a connection that is in autocommit read/write mode and has not yet executed any statements, responds correctly to the state-dependent methods. isGetCommitTimestampAllowed() returns false, as the connection has not executed a commit. getCommitResponse() should therefore not return a result / throw an exception.\nExample 2: ConnectionImplAutocommitReadWriteAfterTemporaryTransactionTest verifies that a connection in autocommit read/write mode that has just successfully executed an ad-hoc transaction does return a commit response. isGetCommitTimestampAllowed() therefore returns true for this implementation.\nThis set of test classes is used to generate a SQL script that can also be used for the same Connection API in other client languages.", "author": "olavloite", "createdAt": "2021-02-03T20:19:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NjExOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2Njc1NQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569466755", "bodyText": "assertTrue is simpler", "author": "elharo", "createdAt": "2021-02-03T14:39:03Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/ConnectionImplTest.java", "diffHunk": "@@ -620,6 +630,68 @@ public void testExecuteGetOptimizerVersion() {\n     }\n   }\n \n+  @Test\n+  public void testExecuteSetReturnCommitStats() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      StatementResult res = subject.execute(Statement.of(\"set return_commit_stats=true\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.NO_RESULT)));\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(true)));\n+\n+      res = subject.execute(Statement.of(\"set return_commit_stats=false\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.NO_RESULT)));\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+    }\n+  }\n+\n+  @Test\n+  public void testExecuteSetReturnCommitStatsInvalidValue() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      try {\n+        subject.execute(Statement.of(\"set return_commit_stats=yes\"));\n+        fail(\"Missing expected exception\");\n+      } catch (SpannerException e) {\n+        assertThat(e.getErrorCode(), is(equalTo(ErrorCode.INVALID_ARGUMENT)));\n+      }\n+    }\n+  }\n+\n+  @Test\n+  public void testExecuteGetReturnCommitStats() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      StatementResult res = subject.execute(Statement.of(\"show variable return_commit_stats\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.RESULT_SET)));\n+      assertThat(res.getResultSet().next(), is(true));\n+      assertThat(res.getResultSet().getBoolean(\"RETURN_COMMIT_STATS\"), is(equalTo(false)));\n+\n+      subject.execute(Statement.of(\"set return_commit_stats=true\"));\n+      res = subject.execute(Statement.of(\"show variable return_commit_stats\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.RESULT_SET)));\n+      assertThat(res.getResultSet().next(), is(true));", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcwMTM1Ng==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569701356", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T19:48:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2Njc1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NjkyNQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569466925", "bodyText": "assertFalse", "author": "elharo", "createdAt": "2021-02-03T14:39:16Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/ConnectionImplTest.java", "diffHunk": "@@ -620,6 +630,68 @@ public void testExecuteGetOptimizerVersion() {\n     }\n   }\n \n+  @Test\n+  public void testExecuteSetReturnCommitStats() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      StatementResult res = subject.execute(Statement.of(\"set return_commit_stats=true\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.NO_RESULT)));\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(true)));\n+\n+      res = subject.execute(Statement.of(\"set return_commit_stats=false\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.NO_RESULT)));\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+    }\n+  }\n+\n+  @Test\n+  public void testExecuteSetReturnCommitStatsInvalidValue() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      try {\n+        subject.execute(Statement.of(\"set return_commit_stats=yes\"));\n+        fail(\"Missing expected exception\");\n+      } catch (SpannerException e) {\n+        assertThat(e.getErrorCode(), is(equalTo(ErrorCode.INVALID_ARGUMENT)));\n+      }\n+    }\n+  }\n+\n+  @Test\n+  public void testExecuteGetReturnCommitStats() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcwMTQwNw==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569701407", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T19:48:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NjkyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NzEwNQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569467105", "bodyText": "res --> result", "author": "elharo", "createdAt": "2021-02-03T14:39:29Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/ConnectionImplTest.java", "diffHunk": "@@ -620,6 +630,68 @@ public void testExecuteGetOptimizerVersion() {\n     }\n   }\n \n+  @Test\n+  public void testExecuteSetReturnCommitStats() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      StatementResult res = subject.execute(Statement.of(\"set return_commit_stats=true\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.NO_RESULT)));\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(true)));\n+\n+      res = subject.execute(Statement.of(\"set return_commit_stats=false\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.NO_RESULT)));\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+    }\n+  }\n+\n+  @Test\n+  public void testExecuteSetReturnCommitStatsInvalidValue() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      try {\n+        subject.execute(Statement.of(\"set return_commit_stats=yes\"));\n+        fail(\"Missing expected exception\");\n+      } catch (SpannerException e) {\n+        assertThat(e.getErrorCode(), is(equalTo(ErrorCode.INVALID_ARGUMENT)));\n+      }\n+    }\n+  }\n+\n+  @Test\n+  public void testExecuteGetReturnCommitStats() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      StatementResult res = subject.execute(Statement.of(\"show variable return_commit_stats\"));", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcwMTY4OA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569701688", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T19:48:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NzEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NzQyOA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569467428", "bodyText": "avoid reassigning local variables", "author": "elharo", "createdAt": "2021-02-03T14:39:54Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/ConnectionImplTest.java", "diffHunk": "@@ -620,6 +630,68 @@ public void testExecuteGetOptimizerVersion() {\n     }\n   }\n \n+  @Test\n+  public void testExecuteSetReturnCommitStats() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      StatementResult res = subject.execute(Statement.of(\"set return_commit_stats=true\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.NO_RESULT)));\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(true)));\n+\n+      res = subject.execute(Statement.of(\"set return_commit_stats=false\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.NO_RESULT)));\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+    }\n+  }\n+\n+  @Test\n+  public void testExecuteSetReturnCommitStatsInvalidValue() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      try {\n+        subject.execute(Statement.of(\"set return_commit_stats=yes\"));\n+        fail(\"Missing expected exception\");\n+      } catch (SpannerException e) {\n+        assertThat(e.getErrorCode(), is(equalTo(ErrorCode.INVALID_ARGUMENT)));\n+      }\n+    }\n+  }\n+\n+  @Test\n+  public void testExecuteGetReturnCommitStats() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      StatementResult res = subject.execute(Statement.of(\"show variable return_commit_stats\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.RESULT_SET)));\n+      assertThat(res.getResultSet().next(), is(true));\n+      assertThat(res.getResultSet().getBoolean(\"RETURN_COMMIT_STATS\"), is(equalTo(false)));\n+\n+      subject.execute(Statement.of(\"set return_commit_stats=true\"));\n+      res = subject.execute(Statement.of(\"show variable return_commit_stats\"));", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcwMzAyMg==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569703022", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T19:50:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NzQyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NzkyNQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569467925", "bodyText": "assertNotNull", "author": "elharo", "createdAt": "2021-02-03T14:40:30Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/ConnectionImplTest.java", "diffHunk": "@@ -749,6 +821,43 @@ public void testExecuteGetCommitTimestamp() {\n     }\n   }\n \n+  @Test\n+  public void testExecuteGetCommitResponse() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      subject.beginTransaction();\n+      subject.executeQuery(Statement.of(AbstractConnectionImplTest.SELECT)).next();\n+      subject.commit();\n+      StatementResult res = subject.execute(Statement.of(\"show variable commit_response\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.RESULT_SET)));\n+      assertThat(res.getResultSet().next(), is(true));\n+      assertThat(res.getResultSet().getTimestamp(\"COMMIT_TIMESTAMP\"), is(notNullValue()));", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcwMzkyNg==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569703926", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T19:52:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2NzkyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2ODA4Mg==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569468082", "bodyText": "result", "author": "elharo", "createdAt": "2021-02-03T14:40:41Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/ConnectionImplTest.java", "diffHunk": "@@ -749,6 +821,43 @@ public void testExecuteGetCommitTimestamp() {\n     }\n   }\n \n+  @Test\n+  public void testExecuteGetCommitResponse() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      subject.beginTransaction();\n+      subject.executeQuery(Statement.of(AbstractConnectionImplTest.SELECT)).next();\n+      subject.commit();\n+      StatementResult res = subject.execute(Statement.of(\"show variable commit_response\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.RESULT_SET)));\n+      assertThat(res.getResultSet().next(), is(true));\n+      assertThat(res.getResultSet().getTimestamp(\"COMMIT_TIMESTAMP\"), is(notNullValue()));\n+      assertThat(res.getResultSet().isNull(\"MUTATION_COUNT\"), is(true));\n+      assertThat(res.getResultSet().next(), is(false));\n+    }\n+\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI + \";returnCommitStats=true\")\n+                .build())) {\n+      subject.beginTransaction();\n+      subject.executeQuery(Statement.of(AbstractConnectionImplTest.SELECT)).next();\n+      subject.commit();\n+      StatementResult res = subject.execute(Statement.of(\"show variable commit_response\"));", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcwNDk5MQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569704991", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T19:54:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2ODA4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2ODIyNQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569468225", "bodyText": "assertNull", "author": "elharo", "createdAt": "2021-02-03T14:40:51Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/ConnectionImplTest.java", "diffHunk": "@@ -749,6 +821,43 @@ public void testExecuteGetCommitTimestamp() {\n     }\n   }\n \n+  @Test\n+  public void testExecuteGetCommitResponse() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      subject.beginTransaction();\n+      subject.executeQuery(Statement.of(AbstractConnectionImplTest.SELECT)).next();\n+      subject.commit();\n+      StatementResult res = subject.execute(Statement.of(\"show variable commit_response\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.RESULT_SET)));\n+      assertThat(res.getResultSet().next(), is(true));\n+      assertThat(res.getResultSet().getTimestamp(\"COMMIT_TIMESTAMP\"), is(notNullValue()));\n+      assertThat(res.getResultSet().isNull(\"MUTATION_COUNT\"), is(true));\n+      assertThat(res.getResultSet().next(), is(false));\n+    }\n+\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI + \";returnCommitStats=true\")\n+                .build())) {\n+      subject.beginTransaction();\n+      subject.executeQuery(Statement.of(AbstractConnectionImplTest.SELECT)).next();\n+      subject.commit();\n+      StatementResult res = subject.execute(Statement.of(\"show variable commit_response\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.RESULT_SET)));\n+      assertThat(res.getResultSet().next(), is(true));\n+      assertThat(res.getResultSet().getTimestamp(\"COMMIT_TIMESTAMP\"), is(notNullValue()));\n+      assertThat(res.getResultSet().isNull(\"MUTATION_COUNT\"), is(false));", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcwNTc3NA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569705774", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T19:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2ODIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2ODM0OA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569468348", "bodyText": "2021", "author": "elharo", "createdAt": "2021-02-03T14:41:00Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/it/ITCommitResponseTest.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * Copyright 2020 Google LLC", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcwNjAzNA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569706034", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T19:55:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2ODM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2ODYwMg==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569468602", "bodyText": "assertNotNull", "author": "elharo", "createdAt": "2021-02-03T14:41:20Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/it/ITCommitResponseTest.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.connection.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.cloud.spanner.KeySet;\n+import com.google.cloud.spanner.Mutation;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.ResultSet;\n+import com.google.cloud.spanner.Statement;\n+import com.google.cloud.spanner.connection.ITAbstractSpannerTest;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCommitResponseTest extends ITAbstractSpannerTest {\n+  @Override\n+  public void appendConnectionUri(StringBuilder uri) {\n+    uri.append(\";autocommit=false\");\n+  }\n+\n+  @Override\n+  public boolean doCreateDefaultTestTable() {\n+    return true;\n+  }\n+\n+  @Before\n+  public void clearTestData() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.bufferedWrite(Mutation.delete(\"TEST\", KeySet.all()));\n+      connection.commit();\n+    }\n+  }\n+\n+  @Test\n+  public void testDefaultNoCommitStats() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.bufferedWrite(\n+          Mutation.newInsertBuilder(\"TEST\").set(\"ID\").to(1L).set(\"NAME\").to(\"TEST\").build());\n+      connection.commit();\n+      assertThat(connection.getCommitResponse()).isNotNull();\n+      assertThat(connection.getCommitResponse().getCommitTimestamp()).isNotNull();", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcwODg3OA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569708878", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T20:00:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2ODYwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2ODg3MQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569468871", "bodyText": "rs --> resultSet", "author": "elharo", "createdAt": "2021-02-03T14:41:43Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/it/ITCommitResponseTest.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.connection.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.cloud.spanner.KeySet;\n+import com.google.cloud.spanner.Mutation;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.ResultSet;\n+import com.google.cloud.spanner.Statement;\n+import com.google.cloud.spanner.connection.ITAbstractSpannerTest;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCommitResponseTest extends ITAbstractSpannerTest {\n+  @Override\n+  public void appendConnectionUri(StringBuilder uri) {\n+    uri.append(\";autocommit=false\");\n+  }\n+\n+  @Override\n+  public boolean doCreateDefaultTestTable() {\n+    return true;\n+  }\n+\n+  @Before\n+  public void clearTestData() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.bufferedWrite(Mutation.delete(\"TEST\", KeySet.all()));\n+      connection.commit();\n+    }\n+  }\n+\n+  @Test\n+  public void testDefaultNoCommitStats() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.bufferedWrite(\n+          Mutation.newInsertBuilder(\"TEST\").set(\"ID\").to(1L).set(\"NAME\").to(\"TEST\").build());\n+      connection.commit();\n+      assertThat(connection.getCommitResponse()).isNotNull();\n+      assertThat(connection.getCommitResponse().getCommitTimestamp()).isNotNull();\n+      assertThat(connection.getCommitResponse().hasCommitStats()).isFalse();\n+    }\n+  }\n+\n+  @Test\n+  public void testReturnCommitStats() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.setReturnCommitStats(true);\n+      connection.bufferedWrite(\n+          Mutation.newInsertBuilder(\"TEST\").set(\"ID\").to(1L).set(\"NAME\").to(\"TEST\").build());\n+      connection.commit();\n+      assertThat(connection.getCommitResponse()).isNotNull();\n+      assertThat(connection.getCommitResponse().getCommitTimestamp()).isNotNull();\n+      assertThat(connection.getCommitResponse().hasCommitStats()).isTrue();\n+      assertThat(connection.getCommitResponse().getCommitStats().getMutationCount()).isEqualTo(2L);\n+    }\n+  }\n+\n+  @Test\n+  public void testReturnCommitStatsUsingSql() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.execute(Statement.of(\"SET RETURN_COMMIT_STATS=TRUE\"));\n+      connection.bufferedWrite(\n+          Mutation.newInsertBuilder(\"TEST\").set(\"ID\").to(1L).set(\"NAME\").to(\"TEST\").build());\n+      connection.commit();\n+      assertThat(connection.getCommitResponse()).isNotNull();\n+      assertThat(connection.getCommitResponse().getCommitTimestamp()).isNotNull();\n+      assertThat(connection.getCommitResponse().hasCommitStats()).isTrue();\n+      assertThat(connection.getCommitResponse().getCommitStats().getMutationCount()).isEqualTo(2L);\n+      try (ResultSet rs =\n+          connection.execute(Statement.of(\"SHOW VARIABLE COMMIT_RESPONSE\")).getResultSet()) {\n+        assertThat(rs.next()).isTrue();\n+        assertThat(rs.getTimestamp(\"COMMIT_TIMESTAMP\")).isNotNull();\n+        assertThat(rs.getLong(\"MUTATION_COUNT\")).isEqualTo(2L);\n+        assertThat(rs.getString(\"OVERLOAD_DELAY\")).isNotNull();\n+        assertThat(rs.next()).isFalse();\n+      }\n+    }\n+  }\n+\n+  @Test\n+  public void testAutocommitDefaultNoCommitStats() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.setAutocommit(true);\n+      connection.write(\n+          Mutation.newInsertBuilder(\"TEST\").set(\"ID\").to(1L).set(\"NAME\").to(\"TEST\").build());\n+      assertThat(connection.getCommitResponse()).isNotNull();\n+      assertThat(connection.getCommitResponse().getCommitTimestamp()).isNotNull();\n+      assertThat(connection.getCommitResponse().hasCommitStats()).isFalse();\n+    }\n+  }\n+\n+  @Test\n+  public void testAutocommitReturnCommitStats() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.setAutocommit(true);\n+      connection.setReturnCommitStats(true);\n+      connection.write(\n+          Mutation.newInsertBuilder(\"TEST\").set(\"ID\").to(1L).set(\"NAME\").to(\"TEST\").build());\n+      assertThat(connection.getCommitResponse()).isNotNull();\n+      assertThat(connection.getCommitResponse().getCommitTimestamp()).isNotNull();\n+      assertThat(connection.getCommitResponse().hasCommitStats()).isTrue();\n+      assertThat(connection.getCommitResponse().getCommitStats().getMutationCount()).isEqualTo(2L);\n+    }\n+  }\n+\n+  @Test\n+  public void testAutocommitReturnCommitStatsUsingSql() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.execute(Statement.of(\"SET AUTOCOMMIT=TRUE\"));\n+      connection.execute(Statement.of(\"SET RETURN_COMMIT_STATS=TRUE\"));\n+      connection.write(\n+          Mutation.newInsertBuilder(\"TEST\").set(\"ID\").to(1L).set(\"NAME\").to(\"TEST\").build());\n+      assertThat(connection.getCommitResponse()).isNotNull();\n+      assertThat(connection.getCommitResponse().getCommitTimestamp()).isNotNull();\n+      assertThat(connection.getCommitResponse().hasCommitStats()).isTrue();\n+      assertThat(connection.getCommitResponse().getCommitStats().getMutationCount()).isEqualTo(2L);\n+      try (ResultSet rs =", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcwOTI3MA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569709270", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-03T20:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2ODg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2OTI0MA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569469240", "bodyText": "in general, avoid Truth for assertions that are simpler in JUnit", "author": "elharo", "createdAt": "2021-02-03T14:42:11Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/it/ITCommitResponseTest.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.connection.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.cloud.spanner.KeySet;\n+import com.google.cloud.spanner.Mutation;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.ResultSet;\n+import com.google.cloud.spanner.Statement;\n+import com.google.cloud.spanner.connection.ITAbstractSpannerTest;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCommitResponseTest extends ITAbstractSpannerTest {\n+  @Override\n+  public void appendConnectionUri(StringBuilder uri) {\n+    uri.append(\";autocommit=false\");\n+  }\n+\n+  @Override\n+  public boolean doCreateDefaultTestTable() {\n+    return true;\n+  }\n+\n+  @Before\n+  public void clearTestData() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.bufferedWrite(Mutation.delete(\"TEST\", KeySet.all()));\n+      connection.commit();\n+    }\n+  }\n+\n+  @Test\n+  public void testDefaultNoCommitStats() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.bufferedWrite(\n+          Mutation.newInsertBuilder(\"TEST\").set(\"ID\").to(1L).set(\"NAME\").to(\"TEST\").build());\n+      connection.commit();\n+      assertThat(connection.getCommitResponse()).isNotNull();\n+      assertThat(connection.getCommitResponse().getCommitTimestamp()).isNotNull();\n+      assertThat(connection.getCommitResponse().hasCommitStats()).isFalse();\n+    }\n+  }\n+\n+  @Test\n+  public void testReturnCommitStats() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.setReturnCommitStats(true);\n+      connection.bufferedWrite(\n+          Mutation.newInsertBuilder(\"TEST\").set(\"ID\").to(1L).set(\"NAME\").to(\"TEST\").build());\n+      connection.commit();\n+      assertThat(connection.getCommitResponse()).isNotNull();\n+      assertThat(connection.getCommitResponse().getCommitTimestamp()).isNotNull();\n+      assertThat(connection.getCommitResponse().hasCommitStats()).isTrue();\n+      assertThat(connection.getCommitResponse().getCommitStats().getMutationCount()).isEqualTo(2L);\n+    }\n+  }\n+\n+  @Test\n+  public void testReturnCommitStatsUsingSql() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.execute(Statement.of(\"SET RETURN_COMMIT_STATS=TRUE\"));\n+      connection.bufferedWrite(\n+          Mutation.newInsertBuilder(\"TEST\").set(\"ID\").to(1L).set(\"NAME\").to(\"TEST\").build());\n+      connection.commit();\n+      assertThat(connection.getCommitResponse()).isNotNull();\n+      assertThat(connection.getCommitResponse().getCommitTimestamp()).isNotNull();\n+      assertThat(connection.getCommitResponse().hasCommitStats()).isTrue();\n+      assertThat(connection.getCommitResponse().getCommitStats().getMutationCount()).isEqualTo(2L);\n+      try (ResultSet rs =\n+          connection.execute(Statement.of(\"SHOW VARIABLE COMMIT_RESPONSE\")).getResultSet()) {\n+        assertThat(rs.next()).isTrue();\n+        assertThat(rs.getTimestamp(\"COMMIT_TIMESTAMP\")).isNotNull();\n+        assertThat(rs.getLong(\"MUTATION_COUNT\")).isEqualTo(2L);\n+        assertThat(rs.getString(\"OVERLOAD_DELAY\")).isNotNull();\n+        assertThat(rs.next()).isFalse();\n+      }\n+    }\n+  }\n+\n+  @Test\n+  public void testAutocommitDefaultNoCommitStats() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.setAutocommit(true);\n+      connection.write(\n+          Mutation.newInsertBuilder(\"TEST\").set(\"ID\").to(1L).set(\"NAME\").to(\"TEST\").build());\n+      assertThat(connection.getCommitResponse()).isNotNull();\n+      assertThat(connection.getCommitResponse().getCommitTimestamp()).isNotNull();\n+      assertThat(connection.getCommitResponse().hasCommitStats()).isFalse();\n+    }\n+  }\n+\n+  @Test\n+  public void testAutocommitReturnCommitStats() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.setAutocommit(true);\n+      connection.setReturnCommitStats(true);\n+      connection.write(\n+          Mutation.newInsertBuilder(\"TEST\").set(\"ID\").to(1L).set(\"NAME\").to(\"TEST\").build());\n+      assertThat(connection.getCommitResponse()).isNotNull();\n+      assertThat(connection.getCommitResponse().getCommitTimestamp()).isNotNull();\n+      assertThat(connection.getCommitResponse().hasCommitStats()).isTrue();\n+      assertThat(connection.getCommitResponse().getCommitStats().getMutationCount()).isEqualTo(2L);\n+    }\n+  }\n+\n+  @Test\n+  public void testAutocommitReturnCommitStatsUsingSql() {\n+    try (ITConnection connection = createConnection()) {\n+      connection.execute(Statement.of(\"SET AUTOCOMMIT=TRUE\"));\n+      connection.execute(Statement.of(\"SET RETURN_COMMIT_STATS=TRUE\"));\n+      connection.write(\n+          Mutation.newInsertBuilder(\"TEST\").set(\"ID\").to(1L).set(\"NAME\").to(\"TEST\").build());\n+      assertThat(connection.getCommitResponse()).isNotNull();\n+      assertThat(connection.getCommitResponse().getCommitTimestamp()).isNotNull();\n+      assertThat(connection.getCommitResponse().hasCommitStats()).isTrue();\n+      assertThat(connection.getCommitResponse().getCommitStats().getMutationCount()).isEqualTo(2L);\n+      try (ResultSet rs =\n+          connection.execute(Statement.of(\"SHOW VARIABLE COMMIT_RESPONSE\")).getResultSet()) {\n+        assertThat(rs.next()).isTrue();", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcwOTM0NQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569709345", "bodyText": "Replaced all in this file.", "author": "olavloite", "createdAt": "2021-02-03T20:01:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ2OTI0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ3MDE0NQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569470145", "bodyText": "Changes in this class don't immediately appear specific to this PR. Can you break this into a separate PR?", "author": "elharo", "createdAt": "2021-02-03T14:43:17Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITTransactionManagerAsyncTest.java", "diffHunk": "@@ -224,6 +222,8 @@ public void testRollback() throws InterruptedException {\n     }\n   }\n \n+  @Ignore(", "originalCommit": "043555d3a2ea76755c5e8a7725edaa65ed0418cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcyNzg0NA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r569727844", "bodyText": "It seems that that had already been done. I've brought this and the commit-stats2 up to date with the latest changes from master, and there is are differences anymore in this class between this branch and master.", "author": "olavloite", "createdAt": "2021-02-03T20:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ3MDE0NQ=="}], "type": "inlineReview"}, {"oid": "83039fbbc31d93d35ba0343c651bee3a872d6fd0", "url": "https://github.com/googleapis/java-spanner/commit/83039fbbc31d93d35ba0343c651bee3a872d6fd0", "message": "Merge branch 'master' into commit-stats2", "committedDate": "2021-02-03T17:07:45Z", "type": "commit"}, {"oid": "57ea714b5d5bae5a91178351efd98c8c6272037a", "url": "https://github.com/googleapis/java-spanner/commit/57ea714b5d5bae5a91178351efd98c8c6272037a", "message": "chore: use junit assertion instead of truth", "committedDate": "2021-02-03T17:20:16Z", "type": "commit"}, {"oid": "74f595192dea3e2462a176e3ddd17a9ad08d197d", "url": "https://github.com/googleapis/java-spanner/commit/74f595192dea3e2462a176e3ddd17a9ad08d197d", "message": "Merge branch 'master' into connection-api-commit-stats", "committedDate": "2021-02-03T17:38:58Z", "type": "commit"}, {"oid": "1b077e457d40dd1f64c20a9f7d897313f78ea4e9", "url": "https://github.com/googleapis/java-spanner/commit/1b077e457d40dd1f64c20a9f7d897313f78ea4e9", "message": "chore: cleanup after merge", "committedDate": "2021-02-03T17:47:23Z", "type": "commit"}, {"oid": "ea061f8750e4e7f4058b885cd72f3ca25576b0c6", "url": "https://github.com/googleapis/java-spanner/commit/ea061f8750e4e7f4058b885cd72f3ca25576b0c6", "message": "Merge branch 'commit-stats2' into connection-api-commit-stats", "committedDate": "2021-02-03T17:52:55Z", "type": "commit"}, {"oid": "51fb048de3aa12c5a1775eb339a1c3a6304d3864", "url": "https://github.com/googleapis/java-spanner/commit/51fb048de3aa12c5a1775eb339a1c3a6304d3864", "message": "fix: address review comments", "committedDate": "2021-02-03T20:21:48Z", "type": "commit"}, {"oid": "66c5f88b55836abf4912e1031e504ef5d2abe9c3", "url": "https://github.com/googleapis/java-spanner/commit/66c5f88b55836abf4912e1031e504ef5d2abe9c3", "message": "chore: replace truth asserts with junit asserts", "committedDate": "2021-02-04T07:41:12Z", "type": "commit"}, {"oid": "bd9bf114a284b0ece16f3275c6777218aaa8ab11", "url": "https://github.com/googleapis/java-spanner/commit/bd9bf114a284b0ece16f3275c6777218aaa8ab11", "message": "Merge branch 'commit-stats2' into connection-api-commit-stats", "committedDate": "2021-02-04T07:46:43Z", "type": "commit"}, {"oid": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "url": "https://github.com/googleapis/java-spanner/commit/b351d08d7567bc2a84213f1106b7e7f7fa56886e", "message": "test: skip CommitStats integration tests on emulator", "committedDate": "2021-02-04T08:00:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE3OTI0NQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570179245", "bodyText": "nit: no period", "author": "elharo", "createdAt": "2021-02-04T12:19:18Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/CommitResponse.java", "diffHunk": "@@ -41,6 +41,11 @@ public Timestamp getCommitTimestamp() {\n     return Timestamp.fromProto(proto.getCommitTimestamp());\n   }\n \n+  /** @return true if the {@link CommitResponse} includes {@link CommitStats}. */", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDQwMzUyNQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570403525", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-04T17:20:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE3OTI0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE3OTQ4NQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570179485", "bodyText": "nit: no period", "author": "elharo", "createdAt": "2021-02-04T12:19:46Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/Connection.java", "diffHunk": "@@ -438,6 +439,15 @@\n    */\n   String getOptimizerVersion();\n \n+  /**\n+   * Sets whether this connection should request commit statistics from Cloud Spanner for read/write\n+   * transactions and DML statements in autocommit mode.\n+   */\n+  void setReturnCommitStats(boolean returnCommitStats);\n+\n+  /** @return true if this connection requests commit statistics from Cloud Spanner. */", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDQwMzQ2MQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570403461", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-04T17:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE3OTQ4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE3OTY3Ng==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570179676", "bodyText": "will throw --> throws", "author": "elharo", "createdAt": "2021-02-04T12:20:04Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/Connection.java", "diffHunk": "@@ -632,6 +642,17 @@\n    */\n   Timestamp getCommitTimestamp();\n \n+  /**\n+   * @return the {@link CommitResponse} of the last {@link TransactionMode#READ_WRITE_TRANSACTION}\n+   *     transaction. This method will throw a {@link SpannerException} if there is no last {@link", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDQwMzM1Ng==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570403356", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-04T17:20:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE3OTY3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4MDMwMQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570180301", "bodyText": "per google style avoid Latin i.e. Perhaps rewrite as\nTransactionMode#READ_WRITE_TRANSACTION} transaction. That is, if the last transaction was a {@link", "author": "elharo", "createdAt": "2021-02-04T12:21:11Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/Connection.java", "diffHunk": "@@ -632,6 +642,17 @@\n    */\n   Timestamp getCommitTimestamp();\n \n+  /**\n+   * @return the {@link CommitResponse} of the last {@link TransactionMode#READ_WRITE_TRANSACTION}\n+   *     transaction. This method will throw a {@link SpannerException} if there is no last {@link\n+   *     TransactionMode#READ_WRITE_TRANSACTION} transaction (i.e. the last transaction was a {@link", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDQwMzI4NA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570403284", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-04T17:19:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4MDMwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4NDE0Nw==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570184147", "bodyText": "I still don't see why both getCommitResponseOrNull and getCommitResponse exist. Why not just getCommitResponse that returns null if there's no unit of work?", "author": "elharo", "createdAt": "2021-02-04T12:27:40Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java", "diffHunk": "@@ -574,6 +578,31 @@ Timestamp getCommitTimestampOrNull() {\n         : this.currentUnitOfWork.getCommitTimestampOrNull();\n   }\n \n+  @Override\n+  public CommitResponse getCommitResponse() {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n+    ConnectionPreconditions.checkState(\n+        this.currentUnitOfWork != null, \"There is no transaction on this connection\");\n+    return this.currentUnitOfWork.getCommitResponse();\n+  }\n+\n+  CommitResponse getCommitResponseOrNull() {", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM3MDY2OA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570370668", "bodyText": "These two methods serve two different APIs that behave differently:\n\nThe Connection interface contains several methods that return the current state of the connection or of the last statement. The chosen pattern for that API is to throw an exception if the Connection is not in a valid state for the method to be called. I don't think we should deviate from that pattern for one method. This also somewhat reflects the standard in JDBC, where most methods also throw an exception if the Connection is not in a valid state for the method. See for example the commit() method. (Although this is not 100% true in all cases, as some other JDBC methods have a different contract, and allows you to call it in what seems to be an illogical state. Calling setAutoCommit is for example allowed during a transaction, and will automatically commit the transaction if the auto commit mode).\nThe Connection API also contains a simple SQL parser that can be used to get and set the state of a connection. This 'API' is lenient, and will return null when a value is requested that is not available at that moment. This SQL parser uses the getCommitResponseOrNull and other similar methods.", "author": "olavloite", "createdAt": "2021-02-04T16:37:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4NDE0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4NDYwNw==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570184607", "bodyText": "Is it useful to check the connection state here? What breaks if this field is set or read on a closed connection?", "author": "elharo", "createdAt": "2021-02-04T12:28:24Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java", "diffHunk": "@@ -574,6 +578,31 @@ Timestamp getCommitTimestampOrNull() {\n         : this.currentUnitOfWork.getCommitTimestampOrNull();\n   }\n \n+  @Override\n+  public CommitResponse getCommitResponse() {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n+    ConnectionPreconditions.checkState(\n+        this.currentUnitOfWork != null, \"There is no transaction on this connection\");\n+    return this.currentUnitOfWork.getCommitResponse();\n+  }\n+\n+  CommitResponse getCommitResponseOrNull() {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n+    return this.currentUnitOfWork == null ? null : this.currentUnitOfWork.getCommitResponseOrNull();\n+  }\n+\n+  @Override\n+  public void setReturnCommitStats(boolean returnCommitStats) {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM3MzQwMQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570373401", "bodyText": "This also follows the standard of the other methods in this class, as well as the default behavior in JDBC, where all methods throw an exception if it is called on a closed connection. See for example getAutoCommit().", "author": "olavloite", "createdAt": "2021-02-04T16:40:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4NDYwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4NTU1OQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570185559", "bodyText": "The constant is less clear than the string itself and doesn't help. It's only used in one obvious place.", "author": "elharo", "createdAt": "2021-02-04T12:29:56Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionOptions.java", "diffHunk": "@@ -184,6 +185,8 @@ public String getDefaultValue() {\n   private static final String USER_AGENT_PROPERTY_NAME = \"userAgent\";\n   /** Query optimizer version to use for a connection. */\n   private static final String OPTIMIZER_VERSION_PROPERTY_NAME = \"optimizerVersion\";\n+  /** Query optimizer version to use for a connection. */\n+  private static final String RETURN_COMMIT_STATS_PROPERTY_NAME = \"returnCommitStats\";", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM5Njg0MQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570396841", "bodyText": "It's used in two places (in the parseReturnCommitStats and to create the set of valid properties). But it's not something that can change in the future, as it would break existing connection URLs. I would prefer to change this in a separate PR, so the entire list of constants can be changed at once, instead of having one parameter that is handled differently from the rest.", "author": "olavloite", "createdAt": "2021-02-04T17:10:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4NTU1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTk4MDAxOA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r581980018", "bodyText": "Generally, this is not how Google handles this situation. You don't have to, and probably shouldn't, change the existing code in this PR. However all new code should be as clean as possible, even when that introduces inconsistencies with existing code. If that means one parameter is handled differently than the rest, so be it. Otherwise initial problems simply replicate across the code base over time.", "author": "elharo", "createdAt": "2021-02-24T13:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4NTU1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjE4ODMwMQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r582188301", "bodyText": "Done", "author": "olavloite", "createdAt": "2021-02-24T18:11:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4NTU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4NTYxMA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570185610", "bodyText": "copy pasta", "author": "elharo", "createdAt": "2021-02-04T12:30:02Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionOptions.java", "diffHunk": "@@ -184,6 +185,8 @@ public String getDefaultValue() {\n   private static final String USER_AGENT_PROPERTY_NAME = \"userAgent\";\n   /** Query optimizer version to use for a connection. */\n   private static final String OPTIMIZER_VERSION_PROPERTY_NAME = \"optimizerVersion\";\n+  /** Query optimizer version to use for a connection. */", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM5NjkzNQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570396935", "bodyText": "Fixed.", "author": "olavloite", "createdAt": "2021-02-04T17:11:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4NTYxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4NjUzNg==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570186536", "bodyText": "false is clearer than a constant whose value is 600 lines up.", "author": "elharo", "createdAt": "2021-02-04T12:31:37Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionOptions.java", "diffHunk": "@@ -634,6 +641,12 @@ static String parseOptimizerVersion(String uri) {\n     return value != null ? value : DEFAULT_OPTIMIZER_VERSION;\n   }\n \n+  @VisibleForTesting\n+  static boolean parseReturnCommitStats(String uri) {\n+    String value = parseUriProperty(uri, RETURN_COMMIT_STATS_PROPERTY_NAME);\n+    return value != null ? Boolean.valueOf(value) : DEFAULT_RETURN_COMMIT_STATS;", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDQwMzk3OQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570403979", "bodyText": "While it would make it clearer here, it also makes it harder to get an overview of what the all the default values of a new connection is, as you would have to scroll through the different parse methods. Now the default values for all connection properties are grouped in one place.", "author": "olavloite", "createdAt": "2021-02-04T17:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4NjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTk4MTQzOA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r581981438", "bodyText": "That sounds like a good case for docs or comments.", "author": "elharo", "createdAt": "2021-02-24T14:00:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4NjUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjE4ODQwNA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r582188404", "bodyText": "Done", "author": "olavloite", "createdAt": "2021-02-24T18:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE4NjUzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE5MzkwMg==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570193902", "bodyText": "Isn't this just a value class? You don't need to mock it.", "author": "elharo", "createdAt": "2021-02-04T12:44:32Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/ConnectionImplTest.java", "diffHunk": "@@ -103,6 +110,12 @@ public void commit() {\n       Timestamp commitTimestamp = Timestamp.now();\n       commitResponse = mock(CommitResponse.class);\n       when(commitResponse.getCommitTimestamp()).thenReturn(commitTimestamp);\n+      if (returnCommitStats) {\n+        CommitStats stats = mock(CommitStats.class);", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDQwNjgwNg==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570406806", "bodyText": "True, it is just a value class, but its constructor and static create method are not accessible from here. This test class is in the .connection sub-package, while CommitStats is in com.google.cloud.spanner.", "author": "olavloite", "createdAt": "2021-02-04T17:25:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE5MzkwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE5NDI3Ng==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570194276", "bodyText": "assertFalse is simpler and easier to read", "author": "elharo", "createdAt": "2021-02-04T12:45:10Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/ConnectionImplTest.java", "diffHunk": "@@ -620,6 +633,70 @@ public void testExecuteGetOptimizerVersion() {\n     }\n   }\n \n+  @Test\n+  public void testExecuteSetReturnCommitStats() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDQwNzU1Nw==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570407557", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-04T17:26:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE5NDI3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE5NDQ0Ng==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570194446", "bodyText": "assertTrue", "author": "elharo", "createdAt": "2021-02-04T12:45:26Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/ConnectionImplTest.java", "diffHunk": "@@ -620,6 +633,70 @@ public void testExecuteGetOptimizerVersion() {\n     }\n   }\n \n+  @Test\n+  public void testExecuteSetReturnCommitStats() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      StatementResult res = subject.execute(Statement.of(\"set return_commit_stats=true\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.NO_RESULT)));\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(true)));", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDQwNzk0MA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570407940", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-04T17:26:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE5NDQ0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE5NDU0NA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570194544", "bodyText": "assertFalse is simpler and easier to read", "author": "elharo", "createdAt": "2021-02-04T12:45:33Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/ConnectionImplTest.java", "diffHunk": "@@ -620,6 +633,70 @@ public void testExecuteGetOptimizerVersion() {\n     }\n   }\n \n+  @Test\n+  public void testExecuteSetReturnCommitStats() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      StatementResult res = subject.execute(Statement.of(\"set return_commit_stats=true\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.NO_RESULT)));\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(true)));\n+\n+      res = subject.execute(Statement.of(\"set return_commit_stats=false\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.NO_RESULT)));\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDQwODEzMQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570408131", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-04T17:26:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE5NDU0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE5NDY4OQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570194689", "bodyText": "res --> result", "author": "elharo", "createdAt": "2021-02-04T12:45:47Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/ConnectionImplTest.java", "diffHunk": "@@ -620,6 +633,70 @@ public void testExecuteGetOptimizerVersion() {\n     }\n   }\n \n+  @Test\n+  public void testExecuteSetReturnCommitStats() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      StatementResult res = subject.execute(Statement.of(\"set return_commit_stats=true\"));", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDQwODM1NA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570408354", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-04T17:27:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE5NDY4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE5NDc3OA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570194778", "bodyText": "assertFalse is simpler and easier to read", "author": "elharo", "createdAt": "2021-02-04T12:45:56Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/ConnectionImplTest.java", "diffHunk": "@@ -620,6 +633,70 @@ public void testExecuteGetOptimizerVersion() {\n     }\n   }\n \n+  @Test\n+  public void testExecuteSetReturnCommitStats() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      StatementResult res = subject.execute(Statement.of(\"set return_commit_stats=true\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.NO_RESULT)));\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(true)));\n+\n+      res = subject.execute(Statement.of(\"set return_commit_stats=false\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.NO_RESULT)));\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+    }\n+  }\n+\n+  @Test\n+  public void testExecuteSetReturnCommitStatsInvalidValue() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDQwODcyNw==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570408727", "bodyText": "Done.", "author": "olavloite", "createdAt": "2021-02-04T17:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE5NDc3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE5Nzk2MQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570197961", "bodyText": "If you muse use Truth, then the way to write this is\nassertThat(e.getErrorCode()).isEqualTo(ErrorCode.INVALID_ARGUMENT)\n\nbut frankly you're better off not even using truth for basic equality, same as, null, non-null, and true and false comparisons. Truth is better reserved for more complex comparisons that JUnit doesn't natively support.", "author": "elharo", "createdAt": "2021-02-04T12:50:59Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/ConnectionImplTest.java", "diffHunk": "@@ -620,6 +633,70 @@ public void testExecuteGetOptimizerVersion() {\n     }\n   }\n \n+  @Test\n+  public void testExecuteSetReturnCommitStats() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      StatementResult res = subject.execute(Statement.of(\"set return_commit_stats=true\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.NO_RESULT)));\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(true)));\n+\n+      res = subject.execute(Statement.of(\"set return_commit_stats=false\"));\n+      assertThat(res.getResultType(), is(equalTo(ResultType.NO_RESULT)));\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+    }\n+  }\n+\n+  @Test\n+  public void testExecuteSetReturnCommitStatsInvalidValue() {\n+    try (ConnectionImpl subject =\n+        createConnection(\n+            ConnectionOptions.newBuilder()\n+                .setCredentials(NoCredentials.getInstance())\n+                .setUri(URI)\n+                .build())) {\n+      assertThat(subject.isReturnCommitStats(), is(equalTo(false)));\n+\n+      try {\n+        subject.execute(Statement.of(\"set return_commit_stats=yes\"));\n+        fail(\"Missing expected exception\");\n+      } catch (SpannerException e) {\n+        assertThat(e.getErrorCode(), is(equalTo(ErrorCode.INVALID_ARGUMENT)));", "originalCommit": "b351d08d7567bc2a84213f1106b7e7f7fa56886e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDQxNTA1Mg==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r570415052", "bodyText": "This is actually not Truth, but Hamcrest. That was what this entire client library initially used, and most classes have gradually been migrated to Truth. This class has not.\nI'll stick to JUnit for the simpler comparisons from now on.\n(And changed this specific one to JUnit)", "author": "olavloite", "createdAt": "2021-02-04T17:36:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDE5Nzk2MQ=="}], "type": "inlineReview"}, {"oid": "da0e434392ce03abb9f5a9317f544c59f11cbe8d", "url": "https://github.com/googleapis/java-spanner/commit/da0e434392ce03abb9f5a9317f544c59f11cbe8d", "message": "fix: address review comments", "committedDate": "2021-02-04T17:38:43Z", "type": "commit"}, {"oid": "1d17973b81e2903cbab466b7a3bb6e577f707c8b", "url": "https://github.com/googleapis/java-spanner/commit/1d17973b81e2903cbab466b7a3bb6e577f707c8b", "message": "chore: replace truth assertions with junit", "committedDate": "2021-02-05T14:49:22Z", "type": "commit"}, {"oid": "a2531cbcd0c243f27b7d750982bc3ab6e6e9ec6a", "url": "https://github.com/googleapis/java-spanner/commit/a2531cbcd0c243f27b7d750982bc3ab6e6e9ec6a", "message": "Merge branch 'commit-stats2' into connection-api-commit-stats", "committedDate": "2021-02-05T14:53:33Z", "type": "commit"}, {"oid": "c01152d9a25c590a13928bb60495ce245c437921", "url": "https://github.com/googleapis/java-spanner/commit/c01152d9a25c590a13928bb60495ce245c437921", "message": "test: add additional tests + replace truth with junit assertions", "committedDate": "2021-02-05T15:10:07Z", "type": "commit"}, {"oid": "bf0a7bddeb0f7cfadb6139570192a35ecd1570c9", "url": "https://github.com/googleapis/java-spanner/commit/bf0a7bddeb0f7cfadb6139570192a35ecd1570c9", "message": "fix: fix wrong error code", "committedDate": "2021-02-05T15:55:45Z", "type": "commit"}, {"oid": "48ef21be5bcf41f8cacfa1eaceaab5726624240c", "url": "https://github.com/googleapis/java-spanner/commit/48ef21be5bcf41f8cacfa1eaceaab5726624240c", "message": "chore: cleanup test and variable names", "committedDate": "2021-02-08T17:51:11Z", "type": "commit"}, {"oid": "1f33c42743920b21a8b70cf008f55f8983d49620", "url": "https://github.com/googleapis/java-spanner/commit/1f33c42743920b21a8b70cf008f55f8983d49620", "message": "fix: rename test method and variables", "committedDate": "2021-02-09T10:45:43Z", "type": "commit"}, {"oid": "7d45ace4c1af0c4691b1fdfc2a1a74b88e4f53f8", "url": "https://github.com/googleapis/java-spanner/commit/7d45ace4c1af0c4691b1fdfc2a1a74b88e4f53f8", "message": "fix: address review comments", "committedDate": "2021-02-16T14:14:24Z", "type": "commit"}, {"oid": "fcb9eda98da9027a0afeb4df948b4533140a216f", "url": "https://github.com/googleapis/java-spanner/commit/fcb9eda98da9027a0afeb4df948b4533140a216f", "message": "Merge branch 'commit-stats2' into connection-api-commit-stats", "committedDate": "2021-02-16T15:13:45Z", "type": "commit"}, {"oid": "682b84984490b4b252e7cf69a0f7eebfab9a6ff6", "url": "https://github.com/googleapis/java-spanner/commit/682b84984490b4b252e7cf69a0f7eebfab9a6ff6", "message": "Merge branch 'master' into connection-api-commit-stats", "committedDate": "2021-02-23T08:54:38Z", "type": "commit"}, {"oid": "0e341a9148742279ac68a2b49e70fad9e1d196e8", "url": "https://github.com/googleapis/java-spanner/commit/0e341a9148742279ac68a2b49e70fad9e1d196e8", "message": "chore: remove unnecessary changes + JUnit assertions", "committedDate": "2021-02-23T09:37:47Z", "type": "commit"}, {"oid": "7540c3194bb412710bbbe4d2cc677c1d2c6f41fb", "url": "https://github.com/googleapis/java-spanner/commit/7540c3194bb412710bbbe4d2cc677c1d2c6f41fb", "message": "fix: remove reference to overload_delay", "committedDate": "2021-02-23T13:34:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTk4MjIzOA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r581982238", "bodyText": "Only the initial value? If it changes, this still returns the initial value? That's surprising. Hmm, looks like it's final so no need to say initial. probably rewrite as, \"whether connections created by this {@link ConnectionOptions} return commit stats\"", "author": "elharo", "createdAt": "2021-02-24T14:01:25Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionOptions.java", "diffHunk": "@@ -823,6 +836,13 @@ QueryOptions getQueryOptions() {\n     return queryOptions;\n   }\n \n+  /**\n+   * The initial returnCommitStats value for connections created by this {@link ConnectionOptions}", "originalCommit": "7540c3194bb412710bbbe4d2cc677c1d2c6f41fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjE3NjE2NA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r582176164", "bodyText": "Changed to Whether connections created by this {@link ConnectionOptions} return commit stats\nThe 'initial' part reflects that fact that while this value is final for the ConnectionOptions, it can still be changed on any Connection that is created from this ConnectionOptions through the Connection#setReturnCommitStats(boolean) method, or by executing the SET RETURN_COMMIT_STATS = TRUE|FALSE sql statement.", "author": "olavloite", "createdAt": "2021-02-24T17:55:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTk4MjIzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTk4NzcwOA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r581987708", "bodyText": "not been committed", "author": "elharo", "createdAt": "2021-02-24T14:08:25Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ReadWriteTransaction.java", "diffHunk": "@@ -254,19 +265,30 @@ public Timestamp getReadTimestampOrNull() {\n     return null;\n   }\n \n-  private boolean hasCommitTimestamp() {\n-    return commitTimestampFuture != null;\n+  private boolean hasCommitResponse() {\n+    return commitResponseFuture != null;\n   }\n \n   @Override\n   public Timestamp getCommitTimestamp() {\n-    ConnectionPreconditions.checkState(hasCommitTimestamp(), \"This transaction has not committed.\");\n-    return get(commitTimestampFuture);\n+    ConnectionPreconditions.checkState(hasCommitResponse(), \"This transaction has not committed.\");", "originalCommit": "7540c3194bb412710bbbe4d2cc677c1d2c6f41fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjE5MzM4MA==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r582193380", "bodyText": "done", "author": "olavloite", "createdAt": "2021-02-24T18:19:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTk4NzcwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTk4Nzc5Ng==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r581987796", "bodyText": "not been committed", "author": "elharo", "createdAt": "2021-02-24T14:08:33Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ReadWriteTransaction.java", "diffHunk": "@@ -254,19 +265,30 @@ public Timestamp getReadTimestampOrNull() {\n     return null;\n   }\n \n-  private boolean hasCommitTimestamp() {\n-    return commitTimestampFuture != null;\n+  private boolean hasCommitResponse() {\n+    return commitResponseFuture != null;\n   }\n \n   @Override\n   public Timestamp getCommitTimestamp() {\n-    ConnectionPreconditions.checkState(hasCommitTimestamp(), \"This transaction has not committed.\");\n-    return get(commitTimestampFuture);\n+    ConnectionPreconditions.checkState(hasCommitResponse(), \"This transaction has not committed.\");\n+    return get(commitResponseFuture).getCommitTimestamp();\n   }\n \n   @Override\n   public Timestamp getCommitTimestampOrNull() {\n-    return hasCommitTimestamp() ? get(commitTimestampFuture) : null;\n+    return hasCommitResponse() ? get(commitResponseFuture).getCommitTimestamp() : null;\n+  }\n+\n+  @Override\n+  public CommitResponse getCommitResponse() {\n+    ConnectionPreconditions.checkState(hasCommitResponse(), \"This transaction has not committed.\");", "originalCommit": "7540c3194bb412710bbbe4d2cc677c1d2c6f41fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MjE5MzQxNQ==", "url": "https://github.com/googleapis/java-spanner/pull/608#discussion_r582193415", "bodyText": "done", "author": "olavloite", "createdAt": "2021-02-24T18:19:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTk4Nzc5Ng=="}], "type": "inlineReview"}, {"oid": "f86255e690d20229f0b3825b3c353bd6e9e61dda", "url": "https://github.com/googleapis/java-spanner/commit/f86255e690d20229f0b3825b3c353bd6e9e61dda", "message": "chore: address review comments", "committedDate": "2021-02-24T18:22:28Z", "type": "commit"}]}