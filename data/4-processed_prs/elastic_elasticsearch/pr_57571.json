{"pr_number": 57571, "pr_title": "Remove the 'array value parser' marker interface.", "pr_createdAt": "2020-06-02T23:47:41Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57571", "timeline": [{"oid": "2932918c3acb347bd5c68e442310fc2d11ee1e88", "url": "https://github.com/elastic/elasticsearch/commit/2932918c3acb347bd5c68e442310fc2d11ee1e88", "message": "Remove the 'array value parser' marker interface.\n\nThis PR replaces the marker interface with the method\nFieldMapper#parsesArrayValue. I find this cleaner and it will help with the\nfields retrieval work (#55363).\n\nThe refactor also ensures that only field mappers can declare they parse array\nvalues. Previously other types like ObjectMapper could implement the marker\ninterface and be passed array values, which doesn't make sense.", "committedDate": "2020-06-02T23:51:23Z", "type": "commit"}, {"oid": "2932918c3acb347bd5c68e442310fc2d11ee1e88", "url": "https://github.com/elastic/elasticsearch/commit/2932918c3acb347bd5c68e442310fc2d11ee1e88", "message": "Remove the 'array value parser' marker interface.\n\nThis PR replaces the marker interface with the method\nFieldMapper#parsesArrayValue. I find this cleaner and it will help with the\nfields retrieval work (#55363).\n\nThe refactor also ensures that only field mappers can declare they parse array\nvalues. Previously other types like ObjectMapper could implement the marker\ninterface and be passed array values, which doesn't make sense.", "committedDate": "2020-06-02T23:51:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIzNjEwMg==", "url": "https://github.com/elastic/elasticsearch/pull/57571#discussion_r434236102", "bodyText": "Unfortunately this refactor didn't actually cut down on the number of instanceof checks. But I feel better about this one, because it's very common for us to check instanceof against FieldMapper or ObjectMapper -- it's just part of how mappings + document parsing currently work.", "author": "jtibshirani", "createdAt": "2020-06-02T23:53:43Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentParser.java", "diffHunk": "@@ -562,6 +562,10 @@ private static void parseArray(ParseContext context, ObjectMapper parentMapper,\n         }\n     }\n \n+    private static boolean parsesArrayValue(Mapper mapper) {\n+        return mapper instanceof FieldMapper && ((FieldMapper) mapper).parsesArrayValue();", "originalCommit": "2932918c3acb347bd5c68e442310fc2d11ee1e88", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwNDA2OA==", "url": "https://github.com/elastic/elasticsearch/pull/57571#discussion_r434704068", "bodyText": "Should this be final, like AbstractGeometryFieldMapper does?", "author": "markharwood", "createdAt": "2020-06-03T16:35:55Z", "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/DenseVectorFieldMapper.java", "diffHunk": "@@ -173,6 +172,11 @@ public DenseVectorFieldType fieldType() {\n         return (DenseVectorFieldType) super.fieldType();\n     }\n \n+    @Override\n+    public boolean parsesArrayValue() {", "originalCommit": "2932918c3acb347bd5c68e442310fc2d11ee1e88", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDczOTg0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/57571#discussion_r434739847", "bodyText": "To me this could be a bit confusing, because no other methods on DenseVectorFieldType are final and it wasn't designed for extension.", "author": "jtibshirani", "createdAt": "2020-06-03T17:35:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwNDA2OA=="}], "type": "inlineReview"}]}