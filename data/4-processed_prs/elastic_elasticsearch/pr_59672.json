{"pr_number": 59672, "pr_title": "Scripted keyword field type: update family type and test field caps output", "pr_createdAt": "2020-07-15T21:07:29Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59672", "timeline": [{"oid": "69340e758e59a6c0994e4175eee1dc8d8d1f77fe", "url": "https://github.com/elastic/elasticsearch/commit/69340e758e59a6c0994e4175eee1dc8d8d1f77fe", "message": "Scripted keyword field type: update family type and test field caps output", "committedDate": "2020-07-15T21:06:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI5NjUwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/59672#discussion_r456296501", "bodyText": "I think that I will remove this assertion. I initially assumed that calling this would make us load doc_values for a runtime field which is expensive, but it will only make us instantiate the classes and doc_values will not be advanced, hence no script is going to be executed.", "author": "javanna", "createdAt": "2020-07-17T08:25:42Z", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/RuntimeKeywordMappedFieldType.java", "diffHunk": "@@ -62,13 +63,27 @@ public Object valueForDisplay(Object value) {\n \n     @Override\n     public String typeName() {\n-        // TODO not sure what we should return here: the runtime type or the field type?\n-        // why is the same string returned from three different methods?\n         return ScriptFieldMapper.CONTENT_TYPE;\n     }\n \n+    @Override\n+    public String familyTypeName() {\n+        return KeywordFieldMapper.CONTENT_TYPE;\n+    }\n+\n+    @Override\n+    public boolean isSearchable() {\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean isAggregatable() {\n+        return true;\n+    }\n+\n     @Override\n     public ScriptBinaryFieldData.Builder fielddataBuilder(String fullyQualifiedIndexName) {\n+        assert fullyQualifiedIndexName.length() > 0 : \"index name must not be empty\";", "originalCommit": "69340e758e59a6c0994e4175eee1dc8d8d1f77fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0OTIyOA==", "url": "https://github.com/elastic/elasticsearch/pull/59672#discussion_r456449228", "bodyText": "\ud83d\udc4d", "author": "nik9000", "createdAt": "2020-07-17T13:40:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI5NjUwMQ=="}], "type": "inlineReview"}, {"oid": "37e44f21bfef73af94d9ab27fd94ecfe96dc3215", "url": "https://github.com/elastic/elasticsearch/commit/37e44f21bfef73af94d9ab27fd94ecfe96dc3215", "message": "Merge branch 'feature/runtime_fields' into enhancement/scripted_fields_test_field_caps", "committedDate": "2020-07-17T08:27:39Z", "type": "commit"}, {"oid": "aa771b2a47920194bff6a3b5c42a0692a62c091b", "url": "https://github.com/elastic/elasticsearch/commit/aa771b2a47920194bff6a3b5c42a0692a62c091b", "message": "remove assertion", "committedDate": "2020-07-17T08:32:36Z", "type": "commit"}, {"oid": "1ac336ccd2b8d0665befd400e25451b8cfa4b9d0", "url": "https://github.com/elastic/elasticsearch/commit/1ac336ccd2b8d0665befd400e25451b8cfa4b9d0", "message": "Merge branch 'feature/runtime_fields' into enhancement/scripted_fields_test_field_caps", "committedDate": "2020-07-17T09:21:09Z", "type": "commit"}, {"oid": "da24f124adb6792789569d649331494176268111", "url": "https://github.com/elastic/elasticsearch/commit/da24f124adb6792789569d649331494176268111", "message": "Merge branch 'feature/runtime_fields' into enhancement/scripted_fields_test_field_caps", "committedDate": "2020-07-17T09:41:54Z", "type": "commit"}, {"oid": "b586ca072bd7553b7d51a953f77d0588c7f24469", "url": "https://github.com/elastic/elasticsearch/commit/b586ca072bd7553b7d51a953f77d0588c7f24469", "message": "expand field caps testing", "committedDate": "2020-07-17T10:09:41Z", "type": "commit"}, {"oid": "06875dc0eea5079a3b0ae1683710cfa7be98e037", "url": "https://github.com/elastic/elasticsearch/commit/06875dc0eea5079a3b0ae1683710cfa7be98e037", "message": "spotless", "committedDate": "2020-07-17T11:02:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQxOTkwMA==", "url": "https://github.com/elastic/elasticsearch/pull/59672#discussion_r456419900", "bodyText": "@nik9000 you may have opinions on this. I added it because I did not want to have tests to maintain a list of supported runtime types and rather rely on the truth which cannot get outdated. Downside is we have no if but rather a map with a bifunction, maybe a bit cryptic.", "author": "javanna", "createdAt": "2020-07-17T12:47:47Z", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptFieldMapper.java", "diffHunk": "@@ -112,13 +130,13 @@ protected Builder(String name, ScriptCompiler scriptCompiler) {\n \n         @Override\n         public ScriptFieldMapper build(BuilderContext context) {\n-            MappedFieldType mappedFieldType;\n-            if (runtimeType.getValue().equals(\"keyword\")) {\n-                StringScriptFieldScript.Factory factory = scriptCompiler.compile(script.getValue(), StringScriptFieldScript.CONTEXT);\n-                mappedFieldType = new RuntimeKeywordMappedFieldType(buildFullName(context), script.getValue(), factory, meta.getValue());\n-            } else {\n+            BiFunction<Builder, BuilderContext, MappedFieldType> fieldTypeResolver = Builder.FIELD_TYPE_RESOLVER.get(", "originalCommit": "06875dc0eea5079a3b0ae1683710cfa7be98e037", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ1MTEzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/59672#discussion_r456451135", "bodyText": "I'm pretty used to maps to functions at this point. I'm happy with this. I'm not 100% this is better than the switch statement that I had in #59721, but it does the job just as well. If you like it, I'm happy with it.", "author": "nik9000", "createdAt": "2020-07-17T13:44:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQxOTkwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ1MjAxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/59672#discussion_r456452015", "bodyText": "it does not do a better job than the switch, but it allows to expose all the keys for testing :)", "author": "javanna", "createdAt": "2020-07-17T13:45:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQxOTkwMA=="}], "type": "inlineReview"}]}