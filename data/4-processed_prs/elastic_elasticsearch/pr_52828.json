{"pr_number": 52828, "pr_title": "EQL: Hook engine to Elasticsearch", "pr_createdAt": "2020-02-26T15:39:07Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52828", "timeline": [{"oid": "827cf1371d2aafd2ec76fbadf0b37f56e01021e0", "url": "https://github.com/elastic/elasticsearch/commit/827cf1371d2aafd2ec76fbadf0b37f56e01021e0", "message": "EQL: Hook engine to Elasticsearch\n\nAdd query execution and return actual results returned from\nElasticsearch inside the tests", "committedDate": "2020-02-26T15:22:44Z", "type": "commit"}, {"oid": "e96f91ab4b54e46a760332b3dcf9c20600ceb5e5", "url": "https://github.com/elastic/elasticsearch/commit/e96f91ab4b54e46a760332b3dcf9c20600ceb5e5", "message": "Update EQL doc sample", "committedDate": "2020-02-26T16:11:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDYwOTAwNA==", "url": "https://github.com/elastic/elasticsearch/pull/52828#discussion_r384609004", "bodyText": "nit: can remove the comment above", "author": "aleksmaus", "createdAt": "2020-02-26T16:26:56Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/plugin/TransportEqlSearchAction.java", "diffHunk": "@@ -68,23 +66,17 @@ public static void operation(PlanExecutor planExecutor, EqlSearchRequest request\n             .fieldTimestamp(request.timestampField())\n             .implicitJoinKey(request.implicitJoinKeyField());\n \n-        Configuration cfg = new Configuration(request.indices(), zoneId, username, clusterName, filter, timeout, includeFrozen, clientId);\n-        //planExecutor.eql(cfg, request.rule(), params, wrap(r -> listener.onResponse(createResponse(r)), listener::onFailure));\n-        listener.onResponse(createResponse(null));\n+        Configuration cfg = new Configuration(request.indices(), zoneId, username, clusterName, filter, timeout, request.fetchSize(),\n+                includeFrozen, clientId);\n+        planExecutor.eql(cfg, request.rule(), params, wrap(r -> listener.onResponse(createResponse(r)), listener::onFailure));\n     }\n \n     static EqlSearchResponse createResponse(Results results) {\n-        // Stubbed search response\n-        // TODO: implement actual search response processing once the parser/executor is in place\n         // Updated for stubbed response to: process where serial_event_id = 1", "originalCommit": "827cf1371d2aafd2ec76fbadf0b37f56e01021e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY0MjAzNg==", "url": "https://github.com/elastic/elasticsearch/pull/52828#discussion_r384642036", "bodyText": "Github wont' let me comment on the snippet above, but it should be updated to something like:\n[source,console]\n----\nGET sec_logs/_eql/search\n{\n \"event_type_field\": \"event.category\",\n \"rule\": \"\"\"\n    process where process.name == \"cmd.exe\"\n  \"\"\"\n}\n----\n\nI would leave event.category as the event_type_field as it conforms to ECS.", "author": "jrodewig", "createdAt": "2020-02-26T17:18:05Z", "path": "docs/reference/eql/search.asciidoc", "diffHunk": "@@ -42,5 +42,5 @@ GET sec_logs/_eql/search\n // TEST[continued]", "originalCommit": "e96f91ab4b54e46a760332b3dcf9c20600ceb5e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY0OTkyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/52828#discussion_r384649929", "bodyText": "Thanks @jrodewig - I'll follow-up with a different PR to fix the default event_type_field to event.category not just in docs, but in the tests as well.", "author": "costin", "createdAt": "2020-02-26T17:31:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY0MjAzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY1MDE2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52828#discussion_r384650167", "bodyText": "That works for me. Thanks!", "author": "jrodewig", "createdAt": "2020-02-26T17:32:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY0MjAzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY1MzY3OA==", "url": "https://github.com/elastic/elasticsearch/pull/52828#discussion_r384653678", "bodyText": "Looked at the code and figured that the event_type_field is actually implemented and your suggestions worked flawlessly.\nThanks!", "author": "costin", "createdAt": "2020-02-26T17:38:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY0MjAzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY0MjM1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52828#discussion_r384642356", "bodyText": "I would leave this as-is and just update the EQL search snippet below.", "author": "jrodewig", "createdAt": "2020-02-26T17:18:40Z", "path": "docs/reference/eql/search.asciidoc", "diffHunk": "@@ -17,18 +17,18 @@ The following <<docs-bulk,bulk API>> request adds some example log data to the\n ----\n PUT sec_logs/_bulk?refresh\n {\"index\":{\"_index\" : \"sec_logs\"}}\n-{ \"@timestamp\": \"2020-12-07T11:06:07.000Z\", \"agent\": { \"id\": \"8a4f500d\" }, \"event\": { \"category\": \"process\" }, \"process\": { \"name\": \"cmd.exe\", \"path\": \"C:\\\\Windows\\\\System32\\\\cmd.exe\" } }\n+{ \"@timestamp\": \"2020-12-07T11:06:07.000Z\", \"agent\": { \"id\": \"8a4f500d\" }, \"event_type\": \"process\" , \"process\": { \"name\": \"cmd.exe\", \"path\": \"C:\\\\Windows\\\\System32\\\\cmd.exe\" } }\n {\"index\":{\"_index\" : \"sec_logs\"}}\n-{ \"@timestamp\": \"2020-12-07T11:07:08.000Z\", \"agent\": { \"id\": \"8a4f500d\" }, \"event\": { \"category\": \"image_load\" }, \"file\": { \"name\": \"cmd.exe\", \"path\": \"C:\\\\Windows\\\\System32\\\\cmd.exe\" }, \"process\": { \"name\": \"cmd.exe\", \"path\": \"C:\\\\Windows\\\\System32\\\\cmd.exe\" } }\n+{ \"@timestamp\": \"2020-12-07T11:07:08.000Z\", \"agent\": { \"id\": \"8a4f500d\" }, \"event_type\": \"image_load\" , \"file\": { \"name\": \"cmd.exe\", \"path\": \"C:\\\\Windows\\\\System32\\\\cmd.exe\" }, \"process\": { \"name\": \"cmd.exe\", \"path\": \"C:\\\\Windows\\\\System32\\\\cmd.exe\" } }\n {\"index\":{\"_index\" : \"sec_logs\"}}\n-{ \"@timestamp\": \"2020-12-07T11:07:09.000Z\", \"agent\": { \"id\": \"8a4f500d\" }, \"event\": { \"category\": \"process\" }, \"process\": { \"name\": \"regsvr32.exe\", \"path\": \"C:\\\\Windows\\\\System32\\\\regsvr32.exe\" } }\n+{ \"@timestamp\": \"2020-12-07T11:07:09.000Z\", \"agent\": { \"id\": \"8a4f500d\" }, \"event_type\": \"process\" , \"process\": { \"name\": \"regsvr32.exe\", \"path\": \"C:\\\\Windows\\\\System32\\\\regsvr32.exe\" } }", "originalCommit": "e96f91ab4b54e46a760332b3dcf9c20600ceb5e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "478437b36bd5a80b99afdddb2263465b1f033236", "url": "https://github.com/elastic/elasticsearch/commit/478437b36bd5a80b99afdddb2263465b1f033236", "message": "Adjust EQL rest client test", "committedDate": "2020-02-26T17:30:14Z", "type": "commit"}, {"oid": "587a80ae866c5fffba88f3d862230d1f149d7296", "url": "https://github.com/elastic/elasticsearch/commit/587a80ae866c5fffba88f3d862230d1f149d7296", "message": "Update docs", "committedDate": "2020-02-26T17:35:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc2NDM0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52828#discussion_r384764347", "bodyText": "Is time the amount of time it took to return the results (judging by the execTime() method) ? If so, wouldn't be more descriptive to have this named took or duration or execTime?", "author": "astefan", "createdAt": "2020-02-26T21:04:41Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/session/Results.java", "diffHunk": "@@ -8,28 +8,76 @@\n \n import org.apache.lucene.search.TotalHits;\n import org.apache.lucene.search.TotalHits.Relation;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.xpack.eql.action.EqlSearchResponse.Count;\n+import org.elasticsearch.xpack.eql.action.EqlSearchResponse.Sequence;\n \n import java.util.List;\n \n import static java.util.Collections.emptyList;\n \n public class Results {\n \n-    public static final Results EMPTY = new Results(new TotalHits(0, Relation.EQUAL_TO), emptyList());\n+    private enum Type {\n+        SEARCH_HIT,\n+        SEQUENCE,\n+        COUNT;\n+    }\n+    \n+    public static final Results EMPTY = new Results(new TotalHits(0, Relation.EQUAL_TO), TimeValue.MINUS_ONE, false, emptyList());\n \n     private final TotalHits totalHits;\n-    private final List<Object> results;\n+    private final List<?> results;\n+    private final boolean timedOut;\n+    private final TimeValue time;", "originalCommit": "587a80ae866c5fffba88f3d862230d1f149d7296", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8e354043477aab1868109f866b430a5f5ab99c5f", "url": "https://github.com/elastic/elasticsearch/commit/8e354043477aab1868109f866b430a5f5ab99c5f", "message": "Minor renaming", "committedDate": "2020-02-27T09:16:00Z", "type": "commit"}]}