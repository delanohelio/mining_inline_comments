{"pr_number": 57254, "pr_title": "[ML] add max_model_memory parameter to forecast request", "pr_createdAt": "2020-05-27T20:31:52Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57254", "timeline": [{"oid": "fa22b8dbf854446efcc5ff819477d69b5d88df5d", "url": "https://github.com/elastic/elasticsearch/commit/fa22b8dbf854446efcc5ff819477d69b5d88df5d", "message": "[ML] add max_model_memory parameter to forecast request", "committedDate": "2020-05-27T20:27:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY5ODE0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431698145", "bodyText": "I know we do it like this in other places, however: There is a XContentParseException which I think fits better (its a specialization of IAE).", "author": "hendrikmuhs", "createdAt": "2020-05-28T09:20:01Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/ml/ForecastJobRequest.java", "diffHunk": "@@ -47,11 +51,20 @@\n             (request, val) -> request.setDuration(TimeValue.parseTimeValue(val, DURATION.getPreferredName())), DURATION);\n         PARSER.declareString(\n             (request, val) -> request.setExpiresIn(TimeValue.parseTimeValue(val, EXPIRES_IN.getPreferredName())), EXPIRES_IN);\n+        PARSER.declareField(ForecastJobRequest::setMaxModelMemory, (p, c) -> {\n+            if (p.currentToken() == XContentParser.Token.VALUE_STRING) {\n+                return ByteSizeValue.parseBytesSizeValue(p.text(), MAX_MODEL_MEMORY.getPreferredName());\n+            } else if (p.currentToken() == XContentParser.Token.VALUE_NUMBER) {\n+                return new ByteSizeValue(p.longValue());\n+            }\n+            throw new IllegalArgumentException(\"Unsupported token [\" + p.currentToken() + \"]\");", "originalCommit": "fa22b8dbf854446efcc5ff819477d69b5d88df5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY5OTEzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431699131", "bodyText": "XContentParseException maybe?", "author": "hendrikmuhs", "createdAt": "2020-05-28T09:21:47Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/action/ForecastJobAction.java", "diffHunk": "@@ -47,6 +50,14 @@ private ForecastJobAction() {\n             PARSER.declareString((request, jobId) -> request.jobId = jobId, Job.ID);\n             PARSER.declareString(Request::setDuration, DURATION);\n             PARSER.declareString(Request::setExpiresIn, EXPIRES_IN);\n+            PARSER.declareField(Request::setMaxModelMemory, (p, c) -> {\n+                if (p.currentToken() == XContentParser.Token.VALUE_STRING) {\n+                    return ByteSizeValue.parseBytesSizeValue(p.text(), MAX_MODEL_MEMORY.getPreferredName()).getBytes();\n+                } else if (p.currentToken() == XContentParser.Token.VALUE_NUMBER) {\n+                    return p.longValue();\n+                }\n+                throw new IllegalArgumentException(\"Unsupported token [\" + p.currentToken() + \"]\");", "originalCommit": "fa22b8dbf854446efcc5ff819477d69b5d88df5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY5OTgwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431699801", "bodyText": "should we have minimum? A limit of 1 byte doesn't make sense.", "author": "hendrikmuhs", "createdAt": "2020-05-28T09:22:53Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/action/ForecastJobAction.java", "diffHunk": "@@ -116,9 +134,20 @@ public void setExpiresIn(TimeValue expiresIn) {\n             }\n         }\n \n+        public void setMaxModelMemory(long numBytes) {\n+            if (numBytes <= 0) {", "originalCommit": "fa22b8dbf854446efcc5ff819477d69b5d88df5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcwMjQzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431702431", "bodyText": "nit: you used the constant in the if, so it makes sense to use it here, too", "author": "hendrikmuhs", "createdAt": "2020-05-28T09:27:28Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportForecastJobAction.java", "diffHunk": "@@ -140,5 +175,14 @@ static void validate(Job job, ForecastJobAction.Request request) {\n                                 + duration.getStringRep() + \"/\" + bucketSpan.getStringRep() + \"]\");\n             }\n         }\n+\n+        if (request.getMaxModelMemory() != null) {\n+            if (request.getMaxModelMemory() >= FORECAST_LOCAL_STORAGE_LIMIT.getBytes()) {\n+                throw ExceptionsHelper.badRequestException(\n+                    \"[{}] must be less than 500MB\",", "originalCommit": "fa22b8dbf854446efcc5ff819477d69b5d88df5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc4Mzg1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431783857", "bodyText": "@hendrikmuhs possibly? I am not sure if the stringRep for this value will be 500mb. I just wanted to guarantee a readable error message.", "author": "benwtrent", "createdAt": "2020-05-28T12:03:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcwMjQzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcxODU4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431718586", "bodyText": "This should be PRE_6_1_DEFAULT_MODEL_MEMORY_LIMIT_MB.  After 6.1 we don't let the model memory limit be null, so the post-6.1 limit is always explicitly set.  (We had to do this to achieve BWC when we changed the default in 6.1.)", "author": "droberts195", "createdAt": "2020-05-28T09:55:40Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportForecastJobAction.java", "diffHunk": "@@ -124,6 +139,26 @@ private void getForecastRequestStats(String jobId, String forecastId, ActionList\n         jobResultsProvider.getForecastRequestStats(jobId, forecastId, forecastRequestStatsHandler, listener::onFailure);\n     }\n \n+    static Long getAdjustedMemoryLimit(Job job, Long requestedLimit, AbstractAuditor<? extends AbstractAuditMessage> auditor) {\n+        if (requestedLimit == null || requestedLimit == DEFAULT_MAX_MODEL_MEMORY.getBytes()) {\n+            return null;\n+        }\n+        long jobLimitMegaBytes = job.getAnalysisLimits() == null || job.getAnalysisLimits().getModelMemoryLimit() == null ?\n+            AnalysisLimits.DEFAULT_MODEL_MEMORY_LIMIT_MB :", "originalCommit": "fa22b8dbf854446efcc5ff819477d69b5d88df5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyMTg5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431721891", "bodyText": "I think we should just make the default null.  Doing it the way it's currently done means there's a weird situation where an explicitly configured forecast memory of 20mb works without capping for a job with a 10mb model_memory_limit, but an explicitly configured forecast memory of 19mb is capped and generates an audit message.", "author": "droberts195", "createdAt": "2020-05-28T10:01:23Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportForecastJobAction.java", "diffHunk": "@@ -124,6 +139,26 @@ private void getForecastRequestStats(String jobId, String forecastId, ActionList\n         jobResultsProvider.getForecastRequestStats(jobId, forecastId, forecastRequestStatsHandler, listener::onFailure);\n     }\n \n+    static Long getAdjustedMemoryLimit(Job job, Long requestedLimit, AbstractAuditor<? extends AbstractAuditMessage> auditor) {\n+        if (requestedLimit == null || requestedLimit == DEFAULT_MAX_MODEL_MEMORY.getBytes()) {", "originalCommit": "fa22b8dbf854446efcc5ff819477d69b5d88df5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyMjYyMw==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431722623", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        String msg = \"requested forecast limit [\" +\n          \n          \n            \n                        String msg = \"requested forecast memory limit [\" +", "author": "droberts195", "createdAt": "2020-05-28T10:02:40Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportForecastJobAction.java", "diffHunk": "@@ -124,6 +139,26 @@ private void getForecastRequestStats(String jobId, String forecastId, ActionList\n         jobResultsProvider.getForecastRequestStats(jobId, forecastId, forecastRequestStatsHandler, listener::onFailure);\n     }\n \n+    static Long getAdjustedMemoryLimit(Job job, Long requestedLimit, AbstractAuditor<? extends AbstractAuditMessage> auditor) {\n+        if (requestedLimit == null || requestedLimit == DEFAULT_MAX_MODEL_MEMORY.getBytes()) {\n+            return null;\n+        }\n+        long jobLimitMegaBytes = job.getAnalysisLimits() == null || job.getAnalysisLimits().getModelMemoryLimit() == null ?\n+            AnalysisLimits.DEFAULT_MODEL_MEMORY_LIMIT_MB :\n+            job.getAnalysisLimits().getModelMemoryLimit();\n+        long allowedMax = (long)(new ByteSizeValue(jobLimitMegaBytes, ByteSizeUnit.MB).getBytes() * 0.40);\n+        long adjustedMax = Math.min(requestedLimit, allowedMax - 1);\n+        if (adjustedMax != requestedLimit) {\n+            String msg = \"requested forecast limit [\" +", "originalCommit": "fa22b8dbf854446efcc5ff819477d69b5d88df5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyMzM2MA==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431723360", "bodyText": "Why subtract 1 from allowedMax?", "author": "droberts195", "createdAt": "2020-05-28T10:04:00Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportForecastJobAction.java", "diffHunk": "@@ -124,6 +139,26 @@ private void getForecastRequestStats(String jobId, String forecastId, ActionList\n         jobResultsProvider.getForecastRequestStats(jobId, forecastId, forecastRequestStatsHandler, listener::onFailure);\n     }\n \n+    static Long getAdjustedMemoryLimit(Job job, Long requestedLimit, AbstractAuditor<? extends AbstractAuditMessage> auditor) {\n+        if (requestedLimit == null || requestedLimit == DEFAULT_MAX_MODEL_MEMORY.getBytes()) {\n+            return null;\n+        }\n+        long jobLimitMegaBytes = job.getAnalysisLimits() == null || job.getAnalysisLimits().getModelMemoryLimit() == null ?\n+            AnalysisLimits.DEFAULT_MODEL_MEMORY_LIMIT_MB :\n+            job.getAnalysisLimits().getModelMemoryLimit();\n+        long allowedMax = (long)(new ByteSizeValue(jobLimitMegaBytes, ByteSizeUnit.MB).getBytes() * 0.40);\n+        long adjustedMax = Math.min(requestedLimit, allowedMax - 1);", "originalCommit": "fa22b8dbf854446efcc5ff819477d69b5d88df5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc0NjM0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431746341", "bodyText": "@droberts195 the check on the c++ side is >=. This is to make it strictly less than.", "author": "benwtrent", "createdAt": "2020-05-28T10:48:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyMzM2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc1ODg1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431758855", "bodyText": "This is going to lead to confusion when the numbers are on the boundary.  For example, suppose the job model memory limit is 200MB, and somebody configures 80MB for a forecast.  Then we'll create an audit message saying the requested amount exceeded 40% of the job model memory limit.  But it doesn't - it's exactly 40%.\nProbably the best way around this would be to change the check on the C++ side to be > so that round numbers work out nicely.  Or alternatively change the error message below to say \"must be less than 40%\".", "author": "droberts195", "createdAt": "2020-05-28T11:12:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyMzM2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyOTE2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431729169", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"] exceeded [\" + allowedMax +\n          \n          \n            \n                            \"] bytes exceeded [\" + allowedMax +", "author": "droberts195", "createdAt": "2020-05-28T10:14:38Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportForecastJobAction.java", "diffHunk": "@@ -124,6 +139,26 @@ private void getForecastRequestStats(String jobId, String forecastId, ActionList\n         jobResultsProvider.getForecastRequestStats(jobId, forecastId, forecastRequestStatsHandler, listener::onFailure);\n     }\n \n+    static Long getAdjustedMemoryLimit(Job job, Long requestedLimit, AbstractAuditor<? extends AbstractAuditMessage> auditor) {\n+        if (requestedLimit == null || requestedLimit == DEFAULT_MAX_MODEL_MEMORY.getBytes()) {\n+            return null;\n+        }\n+        long jobLimitMegaBytes = job.getAnalysisLimits() == null || job.getAnalysisLimits().getModelMemoryLimit() == null ?\n+            AnalysisLimits.DEFAULT_MODEL_MEMORY_LIMIT_MB :\n+            job.getAnalysisLimits().getModelMemoryLimit();\n+        long allowedMax = (long)(new ByteSizeValue(jobLimitMegaBytes, ByteSizeUnit.MB).getBytes() * 0.40);\n+        long adjustedMax = Math.min(requestedLimit, allowedMax - 1);\n+        if (adjustedMax != requestedLimit) {\n+            String msg = \"requested forecast limit [\" +\n+                requestedLimit +\n+                \"] exceeded [\" + allowedMax +", "originalCommit": "fa22b8dbf854446efcc5ff819477d69b5d88df5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyOTMwNA==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431729304", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"] (40% of the anomaly job memory limit). Reducing to allowed maximum before running forecast.\";\n          \n          \n            \n                            \"] bytes (40% of the job memory limit). Reducing to allowed maximum before running forecast.\";", "author": "droberts195", "createdAt": "2020-05-28T10:14:51Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportForecastJobAction.java", "diffHunk": "@@ -124,6 +139,26 @@ private void getForecastRequestStats(String jobId, String forecastId, ActionList\n         jobResultsProvider.getForecastRequestStats(jobId, forecastId, forecastRequestStatsHandler, listener::onFailure);\n     }\n \n+    static Long getAdjustedMemoryLimit(Job job, Long requestedLimit, AbstractAuditor<? extends AbstractAuditMessage> auditor) {\n+        if (requestedLimit == null || requestedLimit == DEFAULT_MAX_MODEL_MEMORY.getBytes()) {\n+            return null;\n+        }\n+        long jobLimitMegaBytes = job.getAnalysisLimits() == null || job.getAnalysisLimits().getModelMemoryLimit() == null ?\n+            AnalysisLimits.DEFAULT_MODEL_MEMORY_LIMIT_MB :\n+            job.getAnalysisLimits().getModelMemoryLimit();\n+        long allowedMax = (long)(new ByteSizeValue(jobLimitMegaBytes, ByteSizeUnit.MB).getBytes() * 0.40);\n+        long adjustedMax = Math.min(requestedLimit, allowedMax - 1);\n+        if (adjustedMax != requestedLimit) {\n+            String msg = \"requested forecast limit [\" +\n+                requestedLimit +\n+                \"] exceeded [\" + allowedMax +\n+                \"] (40% of the anomaly job memory limit). Reducing to allowed maximum before running forecast.\";", "originalCommit": "fa22b8dbf854446efcc5ff819477d69b5d88df5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTczMTc1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431731752", "bodyText": "There is probably a docs file where this information needs adding too.", "author": "droberts195", "createdAt": "2020-05-28T10:19:40Z", "path": "x-pack/plugin/src/test/resources/rest-api-spec/api/ml.forecast.json", "diffHunk": "@@ -31,6 +31,11 @@\n         \"type\":\"time\",\n         \"required\":false,\n         \"description\":\"The time interval after which the forecast expires. Expired forecasts will be deleted at the first opportunity.\"\n+      },\n+      \"max_model_memory\":{\n+        \"type\":\"string\",\n+        \"required\":false,\n+        \"description\":\"The max memory able to be used by the forecast. Default is 20mb.\"", "originalCommit": "fa22b8dbf854446efcc5ff819477d69b5d88df5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ea859dd1472443107a5c1ba1066e92a07eb34c8e", "url": "https://github.com/elastic/elasticsearch/commit/ea859dd1472443107a5c1ba1066e92a07eb34c8e", "message": "Merge remote-tracking branch 'upstream/master' into feature/ml-add-forecast-max-memory-setting", "committedDate": "2020-05-28T11:54:04Z", "type": "commit"}, {"oid": "ca717c74816231a7c0cd1bbe87535da416c0de2a", "url": "https://github.com/elastic/elasticsearch/commit/ca717c74816231a7c0cd1bbe87535da416c0de2a", "message": "addressing PR comments, fixing tests", "committedDate": "2020-05-28T13:21:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg1OTk5NA==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431859994", "bodyText": "sorry, me again: should we use 0 as default?", "author": "hendrikmuhs", "createdAt": "2020-05-28T14:03:45Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/action/ForecastJobAction.java", "diffHunk": "@@ -116,9 +140,26 @@ public void setExpiresIn(TimeValue expiresIn) {\n             }\n         }\n \n+        public void setMaxModelMemory(long numBytes) {\n+            if (numBytes < MIN_MODEL_MEMORY) {", "originalCommit": "ca717c74816231a7c0cd1bbe87535da416c0de2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg2NzAzNg==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431867036", "bodyText": "@hendrikmuhs I am not sure what you mean 0. I think allowing it to not be set at all covers the default value handling.", "author": "benwtrent", "createdAt": "2020-05-28T14:13:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg1OTk5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4MjI4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57254#discussion_r431882286", "bodyText": "true, as said its convenience: if you fire the API with a script which is reading the value from somewhere, you would not need to handle this special case in the script.\nNot important, this is does not seem to be consistently used in the stack, or at least only for those parameters that change state.", "author": "hendrikmuhs", "createdAt": "2020-05-28T14:32:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg1OTk5NA=="}], "type": "inlineReview"}]}