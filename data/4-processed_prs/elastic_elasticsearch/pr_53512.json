{"pr_number": 53512, "pr_title": "Mask wildcard query special characters on keyword queries (#53127)", "pr_createdAt": "2020-03-12T19:46:34Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53512", "timeline": [{"oid": "dfe1a10ac4361832eb793d3d222593452506c117", "url": "https://github.com/elastic/elasticsearch/commit/dfe1a10ac4361832eb793d3d222593452506c117", "message": "Mask wildcard query special characters on keyword queries (#53127)\n\nWildcard queries on keyword fields get normalized, however this normalization\nstep should exclude the two special characters * and ? in order to keep the\nwildcard query itself intact.\n\nCloses #46300", "committedDate": "2020-03-12T19:40:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg1MzE2MA==", "url": "https://github.com/elastic/elasticsearch/pull/53512#discussion_r391853160", "bodyText": "I left this test and added this special case in ConstantFieldType#termQuery because we might still need to support it on 7.x? Happy to remove if its safe but I'm not too familiar with this area.", "author": "cbuescher", "createdAt": "2020-03-12T19:48:13Z", "path": "server/src/test/java/org/elasticsearch/index/mapper/TypeFieldTypeTests.java", "diffHunk": "@@ -53,26 +53,25 @@ public void testTermsQuery() throws Exception {\n         MapperService mapperService = Mockito.mock(MapperService.class);\n         Mockito.when(mapperService.documentMapper()).thenReturn(null);\n         Mockito.when(context.getMapperService()).thenReturn(mapperService);\n+        DocumentMapper mapper = Mockito.mock(DocumentMapper.class);\n+        Mockito.when(mapper.type()).thenReturn(\"_doc\");\n+        Mockito.when(mapperService.documentMapper()).thenReturn(mapper);\n \n         TypeFieldMapper.TypeFieldType ft = new TypeFieldMapper.TypeFieldType();\n         ft.setName(TypeFieldMapper.NAME);\n-        Query query = ft.termQuery(\"my_type\", context);\n+\n+        Query query = ft.termQuery(\"_doc\", context);\n+        assertEquals(new MatchAllDocsQuery(), query);\n+\n+        query = ft.termQuery(\"other_type\", context);\n         assertEquals(new MatchNoDocsQuery(), query);\n \n-        DocumentMapper mapper = Mockito.mock(DocumentMapper.class);\n-        Mockito.when(mapper.type()).thenReturn(\"my_type\");\n-        Mockito.when(mapperService.documentMapper()).thenReturn(mapper);\n-        query = ft.termQuery(\"my_type\", context);\n+        Mockito.when(mapper.type()).thenReturn(\"other_type\");\n+        query = ft.termQuery(\"other_type\", context);\n         assertEquals(new MatchAllDocsQuery(), query);\n \n         Mockito.when(mapperService.hasNested()).thenReturn(true);\n-        query = ft.termQuery(\"my_type\", context);\n+        query = ft.termQuery(\"other_type\", context);\n         assertEquals(Queries.newNonNestedFilter(context.indexVersionCreated()), query);", "originalCommit": "dfe1a10ac4361832eb793d3d222593452506c117", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg1MzM5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53512#discussion_r391853397", "bodyText": "See comment in tests below, I wasn't sure if on 7.x we still need this so left it here for discussion.", "author": "cbuescher", "createdAt": "2020-03-12T19:48:45Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/ConstantFieldType.java", "diffHunk": "@@ -79,6 +79,10 @@ private static String valueToString(Object value) {\n     public final Query termQuery(Object value, QueryShardContext context) {\n         String pattern = valueToString(value);\n         if (matches(pattern, context)) {\n+            if (context != null && context.getMapperService().hasNested()) {\n+                // type filters are expected not to match nested docs\n+                return Queries.newNonNestedFilter(context.indexVersionCreated());", "originalCommit": "dfe1a10ac4361832eb793d3d222593452506c117", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0b8e6628b2aacc701cd01419e7615ca1eb640c1a", "url": "https://github.com/elastic/elasticsearch/commit/0b8e6628b2aacc701cd01419e7615ca1eb640c1a", "message": "Changing TypeFieldType back to extend StringFieldType on 7.x", "committedDate": "2020-03-13T10:57:05Z", "type": "commit"}, {"oid": "0b8e6628b2aacc701cd01419e7615ca1eb640c1a", "url": "https://github.com/elastic/elasticsearch/commit/0b8e6628b2aacc701cd01419e7615ca1eb640c1a", "message": "Changing TypeFieldType back to extend StringFieldType on 7.x", "committedDate": "2020-03-13T10:57:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIwOTE4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53512#discussion_r392209182", "bodyText": "I removed this test for wildcard queries on \"_type\" fields. These don't return anything useful at the moment already, however before the change in this PR we still got an empty response while now we get an error because \"_type\" is not indexed. I don't know if we can tolerate this, otherwise I need to add a very simple wildcard implementation to TypeFieldType again.", "author": "cbuescher", "createdAt": "2020-03-13T12:54:35Z", "path": "server/src/test/java/org/elasticsearch/index/query/WildcardQueryBuilderTests.java", "diffHunk": "@@ -133,19 +136,13 @@ public void testParseFailsWithMultipleFields() throws IOException {\n         assertEquals(\"[wildcard] query doesn't support multiple fields, found [user1] and [user2]\", e.getMessage());\n     }\n \n-    public void testTypeField() throws IOException {\n-        WildcardQueryBuilder builder = QueryBuilders.wildcardQuery(\"_type\", \"doc*\");\n-        builder.doToQuery(createShardContext());\n-        assertWarnings(QueryShardContext.TYPES_DEPRECATION_MESSAGE);\n-    }", "originalCommit": "0b8e6628b2aacc701cd01419e7615ca1eb640c1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIyODczMQ==", "url": "https://github.com/elastic/elasticsearch/pull/53512#discussion_r392228731", "bodyText": "I'm not following, _type should still be indexed in 7x?  It's only in 8x that it will be gone as a field.", "author": "romseygeek", "createdAt": "2020-03-13T13:32:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIwOTE4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE5NDkxNA==", "url": "https://github.com/elastic/elasticsearch/pull/53512#discussion_r397194914", "bodyText": "_type should still be indexed in 7x\n\nThats true, the test above only checks for the deprecation message though. Currently if you do a wildcard query on a \"_type\" field, it returns no hits (even for exact values like \"value\": \"_doc\"). Thats why I think nobody should really do that kind of query on a \"_type\" field. With the changes in this PR we would error in those cases though. If you want I can try to work around that.", "author": "cbuescher", "createdAt": "2020-03-24T14:28:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIwOTE4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIxMDU2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53512#discussion_r397210569", "bodyText": "Erroring is better than silent weirdness, let's leave it as is.", "author": "romseygeek", "createdAt": "2020-03-24T14:47:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIwOTE4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIxNTQzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/53512#discussion_r397215439", "bodyText": "Sorry, I meant to write \"except for exact values like \"_doc\" above. So that works on 7.x, but I hardly believe anybody relies on that? If you change your mind after this clarification let me know.", "author": "cbuescher", "createdAt": "2020-03-24T14:53:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIwOTE4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIyMzA2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53512#discussion_r397223066", "bodyText": "\u2026 starting to think better safe than sorry, I think its a small addition that will keep the existing (weird) behaviour\nI\u2019ll look into that for a bit, leave it if it gets too ugly", "author": "cbuescher", "createdAt": "2020-03-24T15:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIwOTE4Mg=="}], "type": "inlineReview"}, {"oid": "f4ee30cb900ad8b4de29a6fd9c40e7ec5c968e1d", "url": "https://github.com/elastic/elasticsearch/commit/f4ee30cb900ad8b4de29a6fd9c40e7ec5c968e1d", "message": "Merge branch '7.x' of github.com:elastic/elasticsearch into backport-53127", "committedDate": "2020-03-24T15:07:41Z", "type": "commit"}, {"oid": "f8355a2a094f625b37aca4ccda7aabe2b21f066e", "url": "https://github.com/elastic/elasticsearch/commit/f8355a2a094f625b37aca4ccda7aabe2b21f066e", "message": "Move old wildcardQuery impl from StringFieldType to TypeFieldType for bwc", "committedDate": "2020-03-24T15:16:20Z", "type": "commit"}]}