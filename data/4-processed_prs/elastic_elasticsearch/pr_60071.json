{"pr_number": 60071, "pr_title": "Replace immediate task creations by using task avoidance api", "pr_createdAt": "2020-07-22T17:21:34Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60071", "timeline": [{"oid": "6ff3ee43aa1e13eb5fe2196ff1bbe01826b7f06a", "url": "https://github.com/elastic/elasticsearch/commit/6ff3ee43aa1e13eb5fe2196ff1bbe01826b7f06a", "message": "Revert Antfixture handling in discovery-ec2", "committedDate": "2020-07-27T09:12:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA4ODYxOA==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463088618", "bodyText": "TaskProvider", "author": "mark-vieira", "createdAt": "2020-07-30T15:39:00Z", "path": "plugins/discovery-azure-classic/build.gradle", "diffHunk": "@@ -72,7 +72,7 @@ String host = InetAddress.getLoopbackAddress().getHostAddress()\n File keystore = new File(project.buildDir, 'keystore/test-node.jks')\n \n // generate the keystore\n-task createKey(type: LoggedExec) {\n+def createKey = tasks.register(\"createKey\", LoggedExec) {", "originalCommit": "8517df7ca62489657abe4aea4059a5b5dfb8b972", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA4ODk2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463088966", "bodyText": "Should this also be tasks.named(\"test\").configure {?", "author": "mark-vieira", "createdAt": "2020-07-30T15:39:32Z", "path": "plugins/discovery-ec2/build.gradle", "diffHunk": "@@ -98,7 +98,7 @@ task writeTestJavaPolicy {\n }\n \n test {", "originalCommit": "8517df7ca62489657abe4aea4059a5b5dfb8b972", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMjI0MA==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463232240", "bodyText": "after rebasing today I ran into some issues and have just not touched those yet after they've been changed. will revisit after I got the PR builds green again :(", "author": "breskeby", "createdAt": "2020-07-30T19:48:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA4ODk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA4OTc2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463089766", "bodyText": "Why was this dependency changed?", "author": "mark-vieira", "createdAt": "2020-07-30T15:40:35Z", "path": "plugins/discovery-gce/qa/gce/build.gradle", "diffHunk": "@@ -39,8 +39,8 @@ restResources {\n }\n \n /** A task to start the GCEFixture which emulates a GCE service **/\n-task gceFixture(type: AntFixture) {\n-  dependsOn project.sourceSets.yamlRestTest.runtimeClasspath\n+tasks.register(\"gceFixture\", AntFixture) {\n+  dependsOn \"compileTestJava\"", "originalCommit": "8517df7ca62489657abe4aea4059a5b5dfb8b972", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMTc4NA==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463231784", "bodyText": "shouldn't be there, probably a merge issue I ran into today", "author": "breskeby", "createdAt": "2020-07-30T19:47:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA4OTc2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2NDM3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463464377", "bodyText": "fixed", "author": "breskeby", "createdAt": "2020-07-31T08:02:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA4OTc2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5MDUwOA==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463090508", "bodyText": "TaskProvider", "author": "mark-vieira", "createdAt": "2020-07-30T15:41:37Z", "path": "qa/full-cluster-restart/build.gradle", "diffHunk": "@@ -77,7 +77,7 @@ configurations {\n   testArtifacts.extendsFrom testImplementation\n }\n \n-task testJar(type: Jar) {\n+def testJar = tasks.register(\"testJar\", Jar) {", "originalCommit": "8517df7ca62489657abe4aea4059a5b5dfb8b972", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5MDgxMg==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463090812", "bodyText": "TaskProvider", "author": "mark-vieira", "createdAt": "2020-07-30T15:42:04Z", "path": "qa/repository-multi-version/build.gradle", "diffHunk": "@@ -92,7 +92,7 @@ configurations {\n   testArtifacts.extendsFrom testImplementation\n }\n \n-task testJar(type: Jar) {\n+def testJar = tasks.register(\"testJar\", Jar) {", "originalCommit": "8517df7ca62489657abe4aea4059a5b5dfb8b972", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMTIzMw==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463231233", "bodyText": "you mean we should used typed variables here? testJar is of type TaskProvider", "author": "breskeby", "createdAt": "2020-07-30T19:46:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5MDgxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5MTYxMw==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463091613", "bodyText": "Can we ditch the .class here?", "author": "mark-vieira", "createdAt": "2020-07-30T15:43:12Z", "path": "x-pack/build.gradle", "diffHunk": "@@ -31,7 +31,7 @@ subprojects {\n     project.esplugin.noticeFile = xpackRootProject.file('NOTICE.txt')\n   }\n \n-  tasks.withType(LicenseHeadersTask.class) {\n+  tasks.withType(LicenseHeadersTask.class).configureEach {", "originalCommit": "8517df7ca62489657abe4aea4059a5b5dfb8b972", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5MjE0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463092141", "bodyText": "Is this necessary? Shouldn't this be inferred from the copyspec below?", "author": "mark-vieira", "createdAt": "2020-07-30T15:44:02Z", "path": "x-pack/license-tools/build.gradle", "diffHunk": "@@ -12,7 +12,8 @@ project.forbiddenPatterns {\n \n tasks.named(\"dependencyLicenses\").configure { it.enabled = false }\n \n-task buildZip(type: Zip, dependsOn: jar) {\n+tasks.register(\"buildZip\", Zip) {\n+  dependsOn \"jar\"", "originalCommit": "8517df7ca62489657abe4aea4059a5b5dfb8b972", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5NjU3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463096577", "bodyText": "should we also do tasks.named(\"testJar\")?", "author": "mark-vieira", "createdAt": "2020-07-30T15:50:25Z", "path": "x-pack/plugin/ml/build.gradle", "diffHunk": "@@ -69,17 +69,18 @@ configurations {\n   testArtifacts.extendsFrom testRuntime\n   testArtifacts.extendsFrom testImplementation\n }\n-task testJar(type: Jar) {\n+def testJar = tasks.register(\"testJar\", Jar) {\n   appendix 'test'\n   from sourceSets.test.output\n }\n+\n artifacts {\n   // normal es plugins do not publish the jar but we need to since users need it for extensions\n-  archives jar\n+  archives tasks.named(\"jar\")\n   testArtifacts testJar", "originalCommit": "8517df7ca62489657abe4aea4059a5b5dfb8b972", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5NzQzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463097431", "bodyText": "Since lazy task configuration technically defers this until task graph calculation time, could we safely remove the afterEvaluate here?", "author": "mark-vieira", "createdAt": "2020-07-30T15:51:40Z", "path": "x-pack/plugin/ml/build.gradle", "diffHunk": "@@ -89,23 +90,28 @@ task extractNativeLicenses(type: Copy) {\n }\n project.afterEvaluate {", "originalCommit": "8517df7ca62489657abe4aea4059a5b5dfb8b972", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2NDI5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463464296", "bodyText": "the taskProvider also doesn't exist yet. its creation must is deferred.", "author": "breskeby", "createdAt": "2020-07-31T08:02:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5NzQzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5ODQxMg==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463098412", "bodyText": "Same as above, shouldn't we use a task provider for testJar as well?", "author": "mark-vieira", "createdAt": "2020-07-30T15:53:00Z", "path": "x-pack/plugin/monitoring/build.gradle", "diffHunk": "@@ -28,13 +28,13 @@ configurations {\n   testArtifacts.extendsFrom testRuntime\n   testArtifacts.extendsFrom testImplementation\n }\n-task testJar(type: Jar) {\n+def testJar = tasks.register(\"testJar\", Jar) {\n   appendix 'test'\n   from sourceSets.test.output\n }\n artifacts {\n   // normal es plugins do not publish the jar but we need to since users need it for extensions\n-  archives jar\n+  archives tasks.named(\"jar\")\n   testArtifacts testJar", "originalCommit": "8517df7ca62489657abe4aea4059a5b5dfb8b972", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1ODg0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463458849", "bodyText": "it is the task provider. I made the variable typed so its more clear", "author": "breskeby", "createdAt": "2020-07-31T07:50:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5ODQxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5ODQ5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463098497", "bodyText": "Taskprovider for testJar?", "author": "mark-vieira", "createdAt": "2020-07-30T15:53:09Z", "path": "x-pack/plugin/ql/build.gradle", "diffHunk": "@@ -21,17 +21,18 @@ configurations {\n   testArtifacts.extendsFrom testImplementation\n }\n \n-task testJar(type: Jar) {\n+def testJar = tasks.register(\"testJar\", Jar) {\n   appendix 'test'\n   from sourceSets.test.output\n }\n \n artifacts {\n   // normal es plugins do not publish the jar but we need to since users need it for extensions\n-  archives jar\n+  archives tasks.named(\"jar\")\n   testArtifacts testJar", "originalCommit": "8517df7ca62489657abe4aea4059a5b5dfb8b972", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2Mzk2MA==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463463960", "bodyText": "see above", "author": "breskeby", "createdAt": "2020-07-31T08:01:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5ODQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5ODcxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463098711", "bodyText": "Taskprovider for testJar?", "author": "mark-vieira", "createdAt": "2020-07-30T15:53:27Z", "path": "x-pack/plugin/security/build.gradle", "diffHunk": "@@ -143,13 +143,13 @@ configurations {\n   testArtifacts.extendsFrom testRuntime\n   testArtifacts.extendsFrom testImplementation\n }\n-task testJar(type: Jar) {\n+def testJar = tasks.register(\"testJar\", Jar) {\n   appendix 'test'\n   from sourceSets.test.output\n }\n artifacts {\n   // normal es plugins do not publish the jar but we need to since users need it for extensions\n-  archives jar\n+  archives tasks.named(\"jar\")\n   testArtifacts testJar", "originalCommit": "8517df7ca62489657abe4aea4059a5b5dfb8b972", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2MzkxMA==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463463910", "bodyText": "we do as explained above", "author": "breskeby", "createdAt": "2020-07-31T08:01:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5ODcxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5OTQyNg==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463099426", "bodyText": "Should we defer the creation of processTestResources here?", "author": "mark-vieira", "createdAt": "2020-07-30T15:54:32Z", "path": "x-pack/plugin/transform/qa/multi-node-tests/build.gradle", "diffHunk": "@@ -13,17 +13,17 @@ File keystoreDir = new File(project.buildDir, 'keystore')\n File nodeKey = file(\"$keystoreDir/testnode.pem\")\n File nodeCert = file(\"$keystoreDir/testnode.crt\")\n // Add key and certs to test classpath: it expects it there\n-task copyKeyCerts(type: Copy) {\n+tasks.register(\"copyKeyCerts\", Copy) {\n   from(project(':x-pack:plugin:core').file('src/test/resources/org/elasticsearch/xpack/security/transport/ssl/certs/simple/')) {\n     include 'testnode.crt', 'testnode.pem'\n   }\n   into keystoreDir\n }\n // Add keys and cets to test classpath: it expects it there\n sourceSets.test.resources.srcDir(keystoreDir)\n-processTestResources.dependsOn(copyKeyCerts)\n+processTestResources.dependsOn(\"copyKeyCerts\")", "originalCommit": "8517df7ca62489657abe4aea4059a5b5dfb8b972", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2MzgxNg==", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463463816", "bodyText": "done", "author": "breskeby", "createdAt": "2020-07-31T08:01:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5OTQyNg=="}], "type": "inlineReview"}, {"oid": "d4af4a33e53437a73a93046d7ad52adae64f1052", "url": "https://github.com/elastic/elasticsearch/commit/d4af4a33e53437a73a93046d7ad52adae64f1052", "message": "Replace immediate task creations by using task avoidance api\n\n- One step closer to #56610\n- Still many tasks are created during configuration phase. Tackled in separate steps", "committedDate": "2020-07-30T19:58:34Z", "type": "commit"}, {"oid": "d4af4a33e53437a73a93046d7ad52adae64f1052", "url": "https://github.com/elastic/elasticsearch/commit/d4af4a33e53437a73a93046d7ad52adae64f1052", "message": "Replace immediate task creations by using task avoidance api\n\n- One step closer to #56610\n- Still many tasks are created during configuration phase. Tackled in separate steps", "committedDate": "2020-07-30T19:58:34Z", "type": "forcePushed"}, {"oid": "5bb3ecb8caf58cbc423403c94ace3c48608df11d", "url": "https://github.com/elastic/elasticsearch/commit/5bb3ecb8caf58cbc423403c94ace3c48608df11d", "message": "Apply review feedback and polishing", "committedDate": "2020-07-31T08:01:10Z", "type": "commit"}]}