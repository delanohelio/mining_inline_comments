{"pr_number": 54729, "pr_title": "Trigger explicit loading of blob container and snapshot in the pre-recovery hook", "pr_createdAt": "2020-04-03T16:13:41Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54729", "timeline": [{"oid": "1ce45d6ae376d417ffbfcb6ab7f558fa3f2a8714", "url": "https://github.com/elastic/elasticsearch/commit/1ce45d6ae376d417ffbfcb6ab7f558fa3f2a8714", "message": "Load snapshot in pre-recovery", "committedDate": "2020-04-03T15:59:53Z", "type": "commit"}, {"oid": "9ee6ab2c8a6a09d7dbb70f251b18052dcc5b1ffa", "url": "https://github.com/elastic/elasticsearch/commit/9ee6ab2c8a6a09d7dbb70f251b18052dcc5b1ffa", "message": "Merge branch 'feature/searchable-snapshots' into load-snapshot", "committedDate": "2020-04-06T07:56:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkyODI0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/54729#discussion_r403928241", "bodyText": "Technically ok, but I think a logical XOR is clearer than a bitwise XOR:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assert loaded ^ snapshot == null;\n          \n          \n            \n                    assert loaded != (snapshot == null);", "author": "DaveCTurner", "createdAt": "2020-04-06T08:51:43Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotDirectory.java", "diffHunk": "@@ -109,20 +117,72 @@ public SearchableSnapshotDirectory(\n         this.useCache = SNAPSHOT_CACHE_ENABLED_SETTING.get(indexSettings);\n         this.excludedFileTypes = new HashSet<>(SNAPSHOT_CACHE_EXCLUDED_FILE_TYPES_SETTING.get(indexSettings));\n         this.uncachedChunkSize = SNAPSHOT_UNCACHED_CHUNK_SIZE_SETTING.get(indexSettings).getBytes();\n+        this.loaded = false;\n+        assert invariant();\n+    }\n+\n+    private synchronized boolean invariant() {\n+        assert loaded ^ snapshot == null;", "originalCommit": "9ee6ab2c8a6a09d7dbb70f251b18052dcc5b1ffa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk1MDQ0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54729#discussion_r403950443", "bodyText": "Sure!", "author": "tlrx", "createdAt": "2020-04-06T09:27:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkyODI0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkyODQxMw==", "url": "https://github.com/elastic/elasticsearch/pull/54729#discussion_r403928413", "bodyText": "Technically ok, but I think a logical XOR is clearer than a bitwise XOR:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assert loaded ^ blobContainer == null;\n          \n          \n            \n                    assert loaded != (blobContainer == null);", "author": "DaveCTurner", "createdAt": "2020-04-06T08:51:58Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotDirectory.java", "diffHunk": "@@ -109,20 +117,72 @@ public SearchableSnapshotDirectory(\n         this.useCache = SNAPSHOT_CACHE_ENABLED_SETTING.get(indexSettings);\n         this.excludedFileTypes = new HashSet<>(SNAPSHOT_CACHE_EXCLUDED_FILE_TYPES_SETTING.get(indexSettings));\n         this.uncachedChunkSize = SNAPSHOT_UNCACHED_CHUNK_SIZE_SETTING.get(indexSettings).getBytes();\n+        this.loaded = false;\n+        assert invariant();\n+    }\n+\n+    private synchronized boolean invariant() {\n+        assert loaded ^ snapshot == null;\n+        assert loaded ^ blobContainer == null;", "originalCommit": "9ee6ab2c8a6a09d7dbb70f251b18052dcc5b1ffa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkzMDcwOA==", "url": "https://github.com/elastic/elasticsearch/pull/54729#discussion_r403930708", "bodyText": "Can we keep this assertion, and instead only call this method after checking loaded?", "author": "DaveCTurner", "createdAt": "2020-04-06T08:55:35Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotDirectory.java", "diffHunk": "@@ -109,20 +117,72 @@ public SearchableSnapshotDirectory(\n         this.useCache = SNAPSHOT_CACHE_ENABLED_SETTING.get(indexSettings);\n         this.excludedFileTypes = new HashSet<>(SNAPSHOT_CACHE_EXCLUDED_FILE_TYPES_SETTING.get(indexSettings));\n         this.uncachedChunkSize = SNAPSHOT_UNCACHED_CHUNK_SIZE_SETTING.get(indexSettings).getBytes();\n+        this.loaded = false;\n+        assert invariant();\n+    }\n+\n+    private synchronized boolean invariant() {\n+        assert loaded ^ snapshot == null;\n+        assert loaded ^ blobContainer == null;\n+        return true;\n+    }\n+\n+    protected final boolean assertCurrentThreadMayLoadSnapshot() {\n+        final String threadName = Thread.currentThread().getName();\n+        assert threadName.contains('[' + ThreadPool.Names.GENERIC + ']')\n+            // Unit tests access the blob store on the main test thread; simplest just to permit this rather than have them override this\n+            // method somehow.\n+            || threadName.startsWith(\"TEST-\") : \"current thread [\" + Thread.currentThread() + \"] may not load \" + snapshotId;\n+        return true;\n+    }\n+\n+    /**\n+     * Loads the snapshot if and only if it the snapshot is not loaded yet.\n+     *\n+     * @return true if the snapshot was loaded by executing this method, false otherwise\n+     */\n+    public boolean loadSnapshot() {\n+        boolean alreadyLoaded = this.loaded;\n+        if (alreadyLoaded == false) {\n+            synchronized (this) {\n+                alreadyLoaded = this.loaded;\n+                if (alreadyLoaded == false) {\n+                    this.blobContainer = blobContainerSupplier.get();\n+                    this.snapshot = snapshotSupplier.get();\n+                    this.loaded = true;\n+                }\n+            }\n+        }\n+        assert assertCurrentThreadMayLoadSnapshot();\n+        assert invariant();\n+        return alreadyLoaded == false;\n     }\n \n+    @Nullable\n     public BlobContainer blobContainer() {\n-        final BlobContainer blobContainer = this.blobContainer.get();\n-        assert blobContainer != null;", "originalCommit": "9ee6ab2c8a6a09d7dbb70f251b18052dcc5b1ffa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk1OTI2MA==", "url": "https://github.com/elastic/elasticsearch/pull/54729#discussion_r403959260", "bodyText": "I reverted this change. blobContainer() and snapshot() should only be used after loadSnapshot() has been called, so restoring the previous assertion and not checking for loaded will help to catch any future places where blobContainer()/snapshot() is used before the snapshot is explicitely loaded. WDYT?", "author": "tlrx", "createdAt": "2020-04-06T09:41:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkzMDcwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk3MzY4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54729#discussion_r403973687", "bodyText": "\ud83d\udc4d yes, I meant that callers should be careful only to call this if loaded. This is good.", "author": "DaveCTurner", "createdAt": "2020-04-06T10:05:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkzMDcwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkzMDc2NA==", "url": "https://github.com/elastic/elasticsearch/pull/54729#discussion_r403930764", "bodyText": "Can we keep this assertion, and instead only call this method after checking loaded?", "author": "DaveCTurner", "createdAt": "2020-04-06T08:55:39Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotDirectory.java", "diffHunk": "@@ -109,20 +117,72 @@ public SearchableSnapshotDirectory(\n         this.useCache = SNAPSHOT_CACHE_ENABLED_SETTING.get(indexSettings);\n         this.excludedFileTypes = new HashSet<>(SNAPSHOT_CACHE_EXCLUDED_FILE_TYPES_SETTING.get(indexSettings));\n         this.uncachedChunkSize = SNAPSHOT_UNCACHED_CHUNK_SIZE_SETTING.get(indexSettings).getBytes();\n+        this.loaded = false;\n+        assert invariant();\n+    }\n+\n+    private synchronized boolean invariant() {\n+        assert loaded ^ snapshot == null;\n+        assert loaded ^ blobContainer == null;\n+        return true;\n+    }\n+\n+    protected final boolean assertCurrentThreadMayLoadSnapshot() {\n+        final String threadName = Thread.currentThread().getName();\n+        assert threadName.contains('[' + ThreadPool.Names.GENERIC + ']')\n+            // Unit tests access the blob store on the main test thread; simplest just to permit this rather than have them override this\n+            // method somehow.\n+            || threadName.startsWith(\"TEST-\") : \"current thread [\" + Thread.currentThread() + \"] may not load \" + snapshotId;\n+        return true;\n+    }\n+\n+    /**\n+     * Loads the snapshot if and only if it the snapshot is not loaded yet.\n+     *\n+     * @return true if the snapshot was loaded by executing this method, false otherwise\n+     */\n+    public boolean loadSnapshot() {\n+        boolean alreadyLoaded = this.loaded;\n+        if (alreadyLoaded == false) {\n+            synchronized (this) {\n+                alreadyLoaded = this.loaded;\n+                if (alreadyLoaded == false) {\n+                    this.blobContainer = blobContainerSupplier.get();\n+                    this.snapshot = snapshotSupplier.get();\n+                    this.loaded = true;\n+                }\n+            }\n+        }\n+        assert assertCurrentThreadMayLoadSnapshot();\n+        assert invariant();\n+        return alreadyLoaded == false;\n     }\n \n+    @Nullable\n     public BlobContainer blobContainer() {\n-        final BlobContainer blobContainer = this.blobContainer.get();\n-        assert blobContainer != null;\n+        final BlobContainer blobContainer = this.blobContainer;\n+        assert invariant();\n         return blobContainer;\n     }\n \n+    @Nullable\n     public BlobStoreIndexShardSnapshot snapshot() {\n-        final BlobStoreIndexShardSnapshot snapshot = this.snapshot.get();\n-        assert snapshot != null;", "originalCommit": "9ee6ab2c8a6a09d7dbb70f251b18052dcc5b1ffa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkzMTE3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/54729#discussion_r403931179", "bodyText": "I don't think we need to assert this here since we're not changing any state?", "author": "DaveCTurner", "createdAt": "2020-04-06T08:56:19Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotDirectory.java", "diffHunk": "@@ -109,20 +117,72 @@ public SearchableSnapshotDirectory(\n         this.useCache = SNAPSHOT_CACHE_ENABLED_SETTING.get(indexSettings);\n         this.excludedFileTypes = new HashSet<>(SNAPSHOT_CACHE_EXCLUDED_FILE_TYPES_SETTING.get(indexSettings));\n         this.uncachedChunkSize = SNAPSHOT_UNCACHED_CHUNK_SIZE_SETTING.get(indexSettings).getBytes();\n+        this.loaded = false;\n+        assert invariant();\n+    }\n+\n+    private synchronized boolean invariant() {\n+        assert loaded ^ snapshot == null;\n+        assert loaded ^ blobContainer == null;\n+        return true;\n+    }\n+\n+    protected final boolean assertCurrentThreadMayLoadSnapshot() {\n+        final String threadName = Thread.currentThread().getName();\n+        assert threadName.contains('[' + ThreadPool.Names.GENERIC + ']')\n+            // Unit tests access the blob store on the main test thread; simplest just to permit this rather than have them override this\n+            // method somehow.\n+            || threadName.startsWith(\"TEST-\") : \"current thread [\" + Thread.currentThread() + \"] may not load \" + snapshotId;\n+        return true;\n+    }\n+\n+    /**\n+     * Loads the snapshot if and only if it the snapshot is not loaded yet.\n+     *\n+     * @return true if the snapshot was loaded by executing this method, false otherwise\n+     */\n+    public boolean loadSnapshot() {\n+        boolean alreadyLoaded = this.loaded;\n+        if (alreadyLoaded == false) {\n+            synchronized (this) {\n+                alreadyLoaded = this.loaded;\n+                if (alreadyLoaded == false) {\n+                    this.blobContainer = blobContainerSupplier.get();\n+                    this.snapshot = snapshotSupplier.get();\n+                    this.loaded = true;\n+                }\n+            }\n+        }\n+        assert assertCurrentThreadMayLoadSnapshot();\n+        assert invariant();\n+        return alreadyLoaded == false;\n     }\n \n+    @Nullable\n     public BlobContainer blobContainer() {\n-        final BlobContainer blobContainer = this.blobContainer.get();\n-        assert blobContainer != null;\n+        final BlobContainer blobContainer = this.blobContainer;\n+        assert invariant();", "originalCommit": "9ee6ab2c8a6a09d7dbb70f251b18052dcc5b1ffa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk1NTE5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/54729#discussion_r403955196", "bodyText": "Right", "author": "tlrx", "createdAt": "2020-04-06T09:35:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkzMTE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkzMTIyNw==", "url": "https://github.com/elastic/elasticsearch/pull/54729#discussion_r403931227", "bodyText": "I don't think we need to assert this here since we're not changing any state?", "author": "DaveCTurner", "createdAt": "2020-04-06T08:56:24Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotDirectory.java", "diffHunk": "@@ -109,20 +117,72 @@ public SearchableSnapshotDirectory(\n         this.useCache = SNAPSHOT_CACHE_ENABLED_SETTING.get(indexSettings);\n         this.excludedFileTypes = new HashSet<>(SNAPSHOT_CACHE_EXCLUDED_FILE_TYPES_SETTING.get(indexSettings));\n         this.uncachedChunkSize = SNAPSHOT_UNCACHED_CHUNK_SIZE_SETTING.get(indexSettings).getBytes();\n+        this.loaded = false;\n+        assert invariant();\n+    }\n+\n+    private synchronized boolean invariant() {\n+        assert loaded ^ snapshot == null;\n+        assert loaded ^ blobContainer == null;\n+        return true;\n+    }\n+\n+    protected final boolean assertCurrentThreadMayLoadSnapshot() {\n+        final String threadName = Thread.currentThread().getName();\n+        assert threadName.contains('[' + ThreadPool.Names.GENERIC + ']')\n+            // Unit tests access the blob store on the main test thread; simplest just to permit this rather than have them override this\n+            // method somehow.\n+            || threadName.startsWith(\"TEST-\") : \"current thread [\" + Thread.currentThread() + \"] may not load \" + snapshotId;\n+        return true;\n+    }\n+\n+    /**\n+     * Loads the snapshot if and only if it the snapshot is not loaded yet.\n+     *\n+     * @return true if the snapshot was loaded by executing this method, false otherwise\n+     */\n+    public boolean loadSnapshot() {\n+        boolean alreadyLoaded = this.loaded;\n+        if (alreadyLoaded == false) {\n+            synchronized (this) {\n+                alreadyLoaded = this.loaded;\n+                if (alreadyLoaded == false) {\n+                    this.blobContainer = blobContainerSupplier.get();\n+                    this.snapshot = snapshotSupplier.get();\n+                    this.loaded = true;\n+                }\n+            }\n+        }\n+        assert assertCurrentThreadMayLoadSnapshot();\n+        assert invariant();\n+        return alreadyLoaded == false;\n     }\n \n+    @Nullable\n     public BlobContainer blobContainer() {\n-        final BlobContainer blobContainer = this.blobContainer.get();\n-        assert blobContainer != null;\n+        final BlobContainer blobContainer = this.blobContainer;\n+        assert invariant();\n         return blobContainer;\n     }\n \n+    @Nullable\n     public BlobStoreIndexShardSnapshot snapshot() {\n-        final BlobStoreIndexShardSnapshot snapshot = this.snapshot.get();\n-        assert snapshot != null;\n+        final BlobStoreIndexShardSnapshot snapshot = this.snapshot;\n+        assert invariant();", "originalCommit": "9ee6ab2c8a6a09d7dbb70f251b18052dcc5b1ffa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk1NTI2MA==", "url": "https://github.com/elastic/elasticsearch/pull/54729#discussion_r403955260", "bodyText": "Right", "author": "tlrx", "createdAt": "2020-04-06T09:35:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkzMTIyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkzMTU4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54729#discussion_r403931583", "bodyText": "Relates my earlier comment - let's return an empty list if loaded == false, then we can be sure that snapshot() will return non-null.", "author": "DaveCTurner", "createdAt": "2020-04-06T08:56:58Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotDirectory.java", "diffHunk": "@@ -109,20 +117,72 @@ public SearchableSnapshotDirectory(\n         this.useCache = SNAPSHOT_CACHE_ENABLED_SETTING.get(indexSettings);\n         this.excludedFileTypes = new HashSet<>(SNAPSHOT_CACHE_EXCLUDED_FILE_TYPES_SETTING.get(indexSettings));\n         this.uncachedChunkSize = SNAPSHOT_UNCACHED_CHUNK_SIZE_SETTING.get(indexSettings).getBytes();\n+        this.loaded = false;\n+        assert invariant();\n+    }\n+\n+    private synchronized boolean invariant() {\n+        assert loaded ^ snapshot == null;\n+        assert loaded ^ blobContainer == null;\n+        return true;\n+    }\n+\n+    protected final boolean assertCurrentThreadMayLoadSnapshot() {\n+        final String threadName = Thread.currentThread().getName();\n+        assert threadName.contains('[' + ThreadPool.Names.GENERIC + ']')\n+            // Unit tests access the blob store on the main test thread; simplest just to permit this rather than have them override this\n+            // method somehow.\n+            || threadName.startsWith(\"TEST-\") : \"current thread [\" + Thread.currentThread() + \"] may not load \" + snapshotId;\n+        return true;\n+    }\n+\n+    /**\n+     * Loads the snapshot if and only if it the snapshot is not loaded yet.\n+     *\n+     * @return true if the snapshot was loaded by executing this method, false otherwise\n+     */\n+    public boolean loadSnapshot() {\n+        boolean alreadyLoaded = this.loaded;\n+        if (alreadyLoaded == false) {\n+            synchronized (this) {\n+                alreadyLoaded = this.loaded;\n+                if (alreadyLoaded == false) {\n+                    this.blobContainer = blobContainerSupplier.get();\n+                    this.snapshot = snapshotSupplier.get();\n+                    this.loaded = true;\n+                }\n+            }\n+        }\n+        assert assertCurrentThreadMayLoadSnapshot();\n+        assert invariant();\n+        return alreadyLoaded == false;\n     }\n \n+    @Nullable\n     public BlobContainer blobContainer() {\n-        final BlobContainer blobContainer = this.blobContainer.get();\n-        assert blobContainer != null;\n+        final BlobContainer blobContainer = this.blobContainer;\n+        assert invariant();\n         return blobContainer;\n     }\n \n+    @Nullable\n     public BlobStoreIndexShardSnapshot snapshot() {\n-        final BlobStoreIndexShardSnapshot snapshot = this.snapshot.get();\n-        assert snapshot != null;\n+        final BlobStoreIndexShardSnapshot snapshot = this.snapshot;\n+        assert invariant();\n         return snapshot;\n     }\n \n+    private List<BlobStoreIndexShardSnapshot.FileInfo> files() {\n+        final BlobStoreIndexShardSnapshot snapshot = snapshot();", "originalCommit": "9ee6ab2c8a6a09d7dbb70f251b18052dcc5b1ffa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk1MjQ3OA==", "url": "https://github.com/elastic/elasticsearch/pull/54729#discussion_r403952478", "bodyText": "Sure. I must admit I find this code confusing today :/", "author": "tlrx", "createdAt": "2020-04-06T09:30:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkzMTU4Mw=="}], "type": "inlineReview"}, {"oid": "6c788c20e416898feefc51c90f4075ef194c5bf2", "url": "https://github.com/elastic/elasticsearch/commit/6c788c20e416898feefc51c90f4075ef194c5bf2", "message": "apply feedback", "committedDate": "2020-04-06T09:38:52Z", "type": "commit"}]}