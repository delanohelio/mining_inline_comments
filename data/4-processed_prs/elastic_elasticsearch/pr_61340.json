{"pr_number": 61340, "pr_title": "[ML] Update ML mappings upgrade test and extend to config index", "pr_createdAt": "2020-08-19T16:23:07Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61340", "timeline": [{"oid": "8a6ec37484d26e55993f96fdcc3ca8324f5f526c", "url": "https://github.com/elastic/elasticsearch/commit/8a6ec37484d26e55993f96fdcc3ca8324f5f526c", "message": "[ML] Update ML mappings upgrade test and extend to config index\n\nThe ML mappings upgrade test had become useless as it was\nchecking a field that has been the same since 6.5. This\ncommit switches to a field that was changed in 7.9.\n\nAdditionally, the test only used to check the results index\nmappings.  This commit also adds checking for the config\nindex.\n\nRelates #61157", "committedDate": "2020-08-19T16:18:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc1NTEyMg==", "url": "https://github.com/elastic/elasticsearch/pull/61340#discussion_r473755122", "bodyText": "Could using XContentMapValues::extractValue method make this more concise?", "author": "przemekwitek", "createdAt": "2020-08-20T08:24:12Z", "path": "x-pack/qa/rolling-upgrade/src/test/java/org/elasticsearch/upgrades/MlMappingsUpgradeIT.java", "diffHunk": "@@ -105,8 +120,40 @@ private void assertUpgradedMappings() throws Exception {\n             assertNotNull(propertiesLevel);\n             // TODO: as the years go by, the field we assert on here should be changed\n             // to the most recent field we've added that is NOT of type \"keyword\"\n-            Map<String, Object> fieldLevel = (Map<String, Object>) propertiesLevel.get(\"multi_bucket_impact\");\n-            assertEquals(Collections.singletonMap(\"type\", \"double\"), fieldLevel);\n+            Map<String, Object> objectLevel = (Map<String, Object>) propertiesLevel.get(\"model_size_stats\");", "originalCommit": "8a6ec37484d26e55993f96fdcc3ca8324f5f526c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA3NTQ0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/61340#discussion_r481075445", "bodyText": "Yes, good point.  I switched over to that.", "author": "droberts195", "createdAt": "2020-09-01T11:44:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc1NTEyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc1NjA2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/61340#discussion_r473756067", "bodyText": "The same here, could XContentMapValues::extractValue be used instead of this sequence of gets and casts?", "author": "przemekwitek", "createdAt": "2020-08-20T08:25:13Z", "path": "x-pack/qa/rolling-upgrade/src/test/java/org/elasticsearch/upgrades/MlMappingsUpgradeIT.java", "diffHunk": "@@ -105,8 +120,40 @@ private void assertUpgradedMappings() throws Exception {\n             assertNotNull(propertiesLevel);\n             // TODO: as the years go by, the field we assert on here should be changed\n             // to the most recent field we've added that is NOT of type \"keyword\"\n-            Map<String, Object> fieldLevel = (Map<String, Object>) propertiesLevel.get(\"multi_bucket_impact\");\n-            assertEquals(Collections.singletonMap(\"type\", \"double\"), fieldLevel);\n+            Map<String, Object> objectLevel = (Map<String, Object>) propertiesLevel.get(\"model_size_stats\");\n+            assertNotNull(objectLevel);\n+            Map<String, Object> propertiesLevel2 = (Map<String, Object>) objectLevel.get(\"properties\");\n+            assertNotNull(propertiesLevel2);\n+            Map<String, Object> fieldLevel = (Map<String, Object>) propertiesLevel2.get(\"peak_model_bytes\");\n+            assertEquals(Collections.singletonMap(\"type\", \"long\"), fieldLevel);\n+        });\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private void assertUpgradedConfigMappings() throws Exception {\n+\n+        assertBusy(() -> {\n+            Request getMappings = new Request(\"GET\", \".ml-config/_mappings\");\n+            Response response = client().performRequest(getMappings);\n+\n+            Map<String, Object> responseLevel = entityAsMap(response);\n+            assertNotNull(responseLevel);\n+            Map<String, Object> indexLevel = (Map<String, Object>) responseLevel.get(\".ml-config\");", "originalCommit": "8a6ec37484d26e55993f96fdcc3ca8324f5f526c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c946272eb0ddb2c7aac814dcd652775520c62833", "url": "https://github.com/elastic/elasticsearch/commit/c946272eb0ddb2c7aac814dcd652775520c62833", "message": "Merge remote-tracking branch 'origin/master' into validate_mappings_after_upgrade", "committedDate": "2020-09-01T09:51:00Z", "type": "commit"}, {"oid": "fa55e0c1ce0615c4a007664412c7c95c03fa3837", "url": "https://github.com/elastic/elasticsearch/commit/fa55e0c1ce0615c4a007664412c7c95c03fa3837", "message": "Address review comments", "committedDate": "2020-09-01T11:32:20Z", "type": "commit"}]}