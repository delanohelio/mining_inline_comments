{"pr_number": 57870, "pr_title": "Add data stream support to the reindex api.", "pr_createdAt": "2020-06-09T10:36:07Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57870", "timeline": [{"oid": "c741472f0d68996a6a0f70469167eb38c23a65d2", "url": "https://github.com/elastic/elasticsearch/commit/c741472f0d68996a6a0f70469167eb38c23a65d2", "message": "Add data stream support to the reindex api.\n\nRelates to #53100 and #57788", "committedDate": "2020-06-09T10:30:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMxMTM3OA==", "url": "https://github.com/elastic/elasticsearch/pull/57870#discussion_r437311378", "bodyText": "According to the reindex docs, op_type is a valid argument. However it was currently not supported, as the op_type wasn't copied over from the destination index request template to the actual index requests that reindex api generates.", "author": "martijnvg", "createdAt": "2020-06-09T10:37:35Z", "path": "modules/reindex/src/main/java/org/elasticsearch/index/reindex/Reindexer.java", "diffHunk": "@@ -265,7 +266,11 @@ protected void finishHim(Exception failure, List<BulkItemResponse.Failure> index\n              */\n             index.routing(mainRequest.getDestination().routing());\n             index.setPipeline(mainRequest.getDestination().getPipeline());\n-            // OpType is synthesized from version so it is handled when we copy version above.\n+            // Only copy the op_type if it has been set to CREATE.\n+            // (INDEX is the default and UPDATE and DELETE are invalid values)\n+            if (mainRequest.getDestination().opType() == DocWriteRequest.OpType.CREATE) {", "originalCommit": "c741472f0d68996a6a0f70469167eb38c23a65d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA3OTYwOA==", "url": "https://github.com/elastic/elasticsearch/pull/57870#discussion_r438079608", "bodyText": "My previous comment is incorrect. While the op_type isn't copied over, this wasn't needed, because it was only used for enforcing that only new docs were indexed (no updates). This works, because when the version is copied over then the version() method is invoked (mainRequest.getDestination().version()), which delegates to resolveVersionDefaults(), that returns Versions.MATCH_DELETED if op_type was set to create.\nHowever with changes in the pr, the op_type is now also used to ensure that reindex can index into a data stream, so there is a reason to copy over the op_type.", "author": "martijnvg", "createdAt": "2020-06-10T12:23:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMxMTM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM0NTQ4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/57870#discussion_r438345487", "bodyText": "I would be inclined to remove the comment. It seems quite natural to copy the op-type and the comment mostly explains history I think.", "author": "henningandersen", "createdAt": "2020-06-10T19:02:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMxMTM3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1NTIwOA==", "url": "https://github.com/elastic/elasticsearch/pull/57870#discussion_r438555208", "bodyText": "That is true. I will remove it and include the it in the commit message.", "author": "martijnvg", "createdAt": "2020-06-11T05:46:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMxMTM3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMxMTY5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/57870#discussion_r437311695", "bodyText": "This change is required for #57788, but in order to that all other changes in this pr are needed.", "author": "martijnvg", "createdAt": "2020-06-09T10:38:11Z", "path": "docs/reference/indices/rollover-index.asciidoc", "diffHunk": "@@ -254,7 +254,7 @@ POST /my-data-stream/_rollover <2>\n --------------------------------------------------\n // TEST[continued]\n // TEST[setup:huge_twitter]\n-// TEST[s/# Add > 1000 documents to my-data-stream/POST _reindex?refresh\\n{\"source\":{\"index\":\"twitter\"},\"dest\":{\"index\":\".ds-my-data-stream-000001\"}}/]\n+// TEST[s/# Add > 1000 documents to my-data-stream/POST _reindex?refresh\\n{\"source\":{\"index\":\"twitter\"},\"dest\":{\"index\":\"my-data-stream\",\"op_type\":\"create\"}}/]", "originalCommit": "c741472f0d68996a6a0f70469167eb38c23a65d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1fd430c78e070ad9d7cf9e6e08eeee4c3fa8fdfa", "url": "https://github.com/elastic/elasticsearch/commit/1fd430c78e070ad9d7cf9e6e08eeee4c3fa8fdfa", "message": "adjusted comment", "committedDate": "2020-06-10T13:07:10Z", "type": "commit"}, {"oid": "8906504e2e2cb5b8d1bd8842fc17e0c35b95a1ee", "url": "https://github.com/elastic/elasticsearch/commit/8906504e2e2cb5b8d1bd8842fc17e0c35b95a1ee", "message": "add this comment to final commit message:\n\n// (For ensuring no document exists, the op_type create doesn't need to be copied, since Versions.MATCH_DELETED\n            //  will copied from the 'mainRequest.getDestination().version()' a few lines back)\n            // (In order to be able to index into a data stream, the op_type must be create. So in order to support that\n            //  the op_type must be copied)", "committedDate": "2020-06-11T05:48:36Z", "type": "commit"}, {"oid": "c2162b8089bbfd19533bed6502021a04cf6fffb8", "url": "https://github.com/elastic/elasticsearch/commit/c2162b8089bbfd19533bed6502021a04cf6fffb8", "message": "Merge remote-tracking branch 'es/master' into add_data_stream_support_to_reindex", "committedDate": "2020-06-11T05:48:52Z", "type": "commit"}]}