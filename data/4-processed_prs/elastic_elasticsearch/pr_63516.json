{"pr_number": 63516, "pr_title": "Add precommit check for the layout pattern for security auditing", "pr_createdAt": "2020-10-08T22:52:06Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63516", "timeline": [{"oid": "4dea032b85bc51f0446823e6cb0d1febb455cbac", "url": "https://github.com/elastic/elasticsearch/commit/4dea032b85bc51f0446823e6cb0d1febb455cbac", "message": "Done", "committedDate": "2020-10-08T22:27:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA2MTE2MA==", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r502061160", "bodyText": "I wonder if we should wire this to precommit so it fails early. Otherwise this will only fail when we actually go to build these docker images.", "author": "mark-vieira", "createdAt": "2020-10-08T23:01:58Z", "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +168,30 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"ensureLog4jConfigurationSync\") {", "originalCommit": "4dea032b85bc51f0446823e6cb0d1febb455cbac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA2MTg3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r502061873", "bodyText": "We should give some indication as to where \"this task's declaration\" lives. Perhaps provide the relative path to this build.gradle file in the exception message? Or instead externalize the checksum in a file (like we do for dependency artifacts) and just point to that so folks don't actually have to change build scripts.", "author": "mark-vieira", "createdAt": "2020-10-08T23:03:13Z", "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +168,30 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"ensureLog4jConfigurationSync\") {\n+  /*\n+   * Whenever the x-pack/plugin/core/src/main/config/log4j2.properties is changed it might be that the\n+   * distribution/docker/src/docker/config/log4j2.properties file needs changing as well.\n+   *\n+   * This task fails if the x-pack/plugin/core/src/main/config/log4j2.properties file\n+   * has been modified. Please ensure that the distribution/docker/src/docker/config/log4j2.properties\n+   * file is also modified such that it reflects the same changes.\n+   *\n+   * SET THIS to the value of checksumOriginalLog4j after the two files have been confirmed as equivalent\n+   */\n+  def validatedChecksumOriginalLog4j = \"+GJ/QjaApSAiejScjiwFEg==\"\n+  doLast {\n+    def originalLog4j = project(\":x-pack:plugin:core\").file('src/main/config/log4j2.properties').getBytes()\n+    def checksumOriginalLog4j = Base64.getEncoder().encodeToString(MessageDigest.getInstance(\"MD5\").digest(originalLog4j))\n+    if (false == validatedChecksumOriginalLog4j.equals(checksumOriginalLog4j)) {\n+      throw new GradleException(\"The src/main/config/log4j2.properties file from the x-pack:plugin:core has been changed. \" +", "originalCommit": "4dea032b85bc51f0446823e6cb0d1febb455cbac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a46ca0f1e03c6d2ee1c206c90bf05218f14768ed", "url": "https://github.com/elastic/elasticsearch/commit/a46ca0f1e03c6d2ee1c206c90bf05218f14768ed", "message": "Merge branch 'master' into audit_log4j_configuration_sync_up", "committedDate": "2020-10-13T13:59:31Z", "type": "commit"}, {"oid": "74cfcff4d434b10f786ec4026391f889ce35bb42", "url": "https://github.com/elastic/elasticsearch/commit/74cfcff4d434b10f786ec4026391f889ce35bb42", "message": "check by property name", "committedDate": "2020-10-13T15:41:16Z", "type": "commit"}, {"oid": "584a59060e7f196a25f460dccde7b750b1601f25", "url": "https://github.com/elastic/elasticsearch/commit/584a59060e7f196a25f460dccde7b750b1601f25", "message": "Revert prev", "committedDate": "2020-10-13T15:43:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4NjAwNw==", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504286007", "bodyText": "We should define the properties files as inputs so that this task can be UP-TO-DATE when nothing changes.", "author": "mark-vieira", "createdAt": "2020-10-13T22:06:45Z", "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +165,41 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"checkSecurityAuditLayoutPatternIdentical\") {", "originalCommit": "584a59060e7f196a25f460dccde7b750b1601f25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUxMTQ3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504511479", "bodyText": "Thanks Mark.", "author": "albertzaharovits", "createdAt": "2020-10-14T08:52:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4NjAwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4NjQ4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504286486", "bodyText": "This is Groovy, so need to do string concatination, just use groovy string interpolation (ex: \"The [${originalLog4j.path}] file...\").", "author": "mark-vieira", "createdAt": "2020-10-13T22:08:04Z", "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +165,41 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"checkSecurityAuditLayoutPatternIdentical\") {\n+  def patternPropertyKey = \"appender.audit_rolling.layout.pattern\"\n+  doLast {\n+    def coreLog4jProperties = new Properties()\n+    def originalLog4j = project(\":x-pack:plugin:core\").file('src/main/config/log4j2.properties')\n+    originalLog4j.withInputStream { input ->\n+      coreLog4jProperties.load(input)\n+    }\n+\n+    if (false == coreLog4jProperties.containsKey(patternPropertyKey)) {\n+      throw new GradleException(\"The [\" + originalLog4j.getPath() + \"] file changed such that the layout pattern is not \" +", "originalCommit": "584a59060e7f196a25f460dccde7b750b1601f25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2cf6ceaa7e68fb3b1b183c105204c9d808efd3c4", "url": "https://github.com/elastic/elasticsearch/commit/2cf6ceaa7e68fb3b1b183c105204c9d808efd3c4", "message": "Merge branch 'master' into audit_log4j_configuration_sync_up", "committedDate": "2020-10-14T08:09:16Z", "type": "commit"}, {"oid": "c1af98251bc87bc934691f221ce71bc2a8020c47", "url": "https://github.com/elastic/elasticsearch/commit/c1af98251bc87bc934691f221ce71bc2a8020c47", "message": "Inputs to task as per Mark's review", "committedDate": "2020-10-14T08:50:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NDQ0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504544446", "bodyText": "you can just do project.file(\"src/docker/config/log4j2.properties\")", "author": "breskeby", "createdAt": "2020-10-14T09:44:25Z", "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +165,43 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"checkSecurityAuditLayoutPatternIdentical\") {\n+  // the two log4j2.properties files containing security audit configuration for archive and docker builds respectively\n+  def originalLog4j = project(\":x-pack:plugin:core\").file('src/main/config/log4j2.properties')\n+  def dockerLog4j = project.projectDir.toPath().resolve(\"src/docker/config/log4j2.properties\").toFile()", "originalCommit": "c1af98251bc87bc934691f221ce71bc2a8020c47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU5MTAxOA==", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504591018", "bodyText": "Thanks \ud83e\udd26", "author": "albertzaharovits", "createdAt": "2020-10-14T11:06:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NDQ0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NDQ4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504544489", "bodyText": "Please use tasks.named(\"precommit\").configure { it.dependsOn('checkSecurityAuditLayoutPatternIdentical') } to make use of gradles \"task avoidance api\" to avoid creating tasks early. see https://docs.gradle.org/current/userguide/task_configuration_avoidance.html for further information", "author": "breskeby", "createdAt": "2020-10-14T09:44:30Z", "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +165,43 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"checkSecurityAuditLayoutPatternIdentical\") {\n+  // the two log4j2.properties files containing security audit configuration for archive and docker builds respectively\n+  def originalLog4j = project(\":x-pack:plugin:core\").file('src/main/config/log4j2.properties')\n+  def dockerLog4j = project.projectDir.toPath().resolve(\"src/docker/config/log4j2.properties\").toFile()\n+  inputs.files(originalLog4j, dockerLog4j)\n+  def patternPropertyKey = \"appender.audit_rolling.layout.pattern\"\n+  doLast {\n+    def coreLog4jProperties = new Properties()\n+    originalLog4j.withInputStream { input ->\n+      coreLog4jProperties.load(input)\n+    }\n+\n+    if (false == coreLog4jProperties.containsKey(patternPropertyKey)) {\n+      throw new GradleException(\"The [${originalLog4j.getPath()}] file changed such that the layout pattern is not \" +\n+              \"referred to by the property named [${patternPropertyKey}]. Please update the task [${name}] \" +\n+              \"definition from project [${path}] to reflect the new name for the layout pattern property.\")\n+    }\n+\n+    def dockerLog4jProperties = new Properties()\n+    dockerLog4j.withInputStream { input ->\n+      dockerLog4jProperties.load(input)\n+    }\n+\n+    if (false == dockerLog4jProperties.containsKey(patternPropertyKey)) {\n+      throw new GradleException(\"The [${dockerLog4j.getPath()}] file changed such that the layout pattern is not \" +\n+              \"referred to by the property named [${patternPropertyKey}]. Please update the task [${name}] \" +\n+              \"definition from project [${path}] to reflect the new name for the layout pattern property.\")\n+    }\n+\n+    if (false == coreLog4jProperties.getProperty(patternPropertyKey).equals(dockerLog4jProperties.getProperty(patternPropertyKey))) {\n+      throw new GradleException(\"The property value for the layout pattern [${patternPropertyKey}] is NOT identical \" +\n+              \"between the [${originalLog4j.getPath()}] and the [${dockerLog4j.getPath()}] files.\")\n+    }\n+  }\n+}\n+precommit.dependsOn 'checkSecurityAuditLayoutPatternIdentical'", "originalCommit": "c1af98251bc87bc934691f221ce71bc2a8020c47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU5OTkzOA==", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504599938", "bodyText": "Ha, I was wondering what's up with the register methods, thanks for the link!\nI've changed it to:\ntasks.named(\"precommit\").configure {\n  dependsOn 'checkSecurityAuditLayoutPatternIdentical'\n}", "author": "albertzaharovits", "createdAt": "2020-10-14T11:24:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NDQ4OQ=="}], "type": "inlineReview"}, {"oid": "b978af324a2e224769e7e88fdc3c686add0c213a", "url": "https://github.com/elastic/elasticsearch/commit/b978af324a2e224769e7e88fdc3c686add0c213a", "message": "rene's review", "committedDate": "2020-10-14T11:21:51Z", "type": "commit"}, {"oid": "2d77aa38c4805bb3f5fd31c7a473f906b3298f86", "url": "https://github.com/elastic/elasticsearch/commit/2d77aa38c4805bb3f5fd31c7a473f906b3298f86", "message": "Merge branch 'master' into audit_log4j_configuration_sync_up", "committedDate": "2020-10-14T11:22:00Z", "type": "commit"}]}