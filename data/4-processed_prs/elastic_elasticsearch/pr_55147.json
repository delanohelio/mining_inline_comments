{"pr_number": 55147, "pr_title": "Fix testCreateAndRestoreSearchableSnapshot", "pr_createdAt": "2020-04-14T09:59:58Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55147", "timeline": [{"oid": "57f914f293fbd901c726324bad2e496a07f50b99", "url": "https://github.com/elastic/elasticsearch/commit/57f914f293fbd901c726324bad2e496a07f50b99", "message": "Allow cache skipping when cache is too small", "committedDate": "2020-04-14T09:20:12Z", "type": "commit"}, {"oid": "523012cc74d9081e537dee15ec2f4b0c1c699b7e", "url": "https://github.com/elastic/elasticsearch/commit/523012cc74d9081e537dee15ec2f4b0c1c699b7e", "message": "Include shard ID in stats JSON", "committedDate": "2020-04-14T09:20:13Z", "type": "commit"}, {"oid": "af9ac6b5b7b168e8f40755d22d0d71746cb48f83", "url": "https://github.com/elastic/elasticsearch/commit/af9ac6b5b7b168e8f40755d22d0d71746cb48f83", "message": "More small cache tests", "committedDate": "2020-04-14T09:21:58Z", "type": "commit"}, {"oid": "898532814ebc268e8aa0fd95c61b74f4a9fbed7b", "url": "https://github.com/elastic/elasticsearch/commit/898532814ebc268e8aa0fd95c61b74f4a9fbed7b", "message": "Permit empty shards", "committedDate": "2020-04-14T09:48:38Z", "type": "commit"}, {"oid": "27e7076f666d9fed2772173c832b8a8aefc10eb3", "url": "https://github.com/elastic/elasticsearch/commit/27e7076f666d9fed2772173c832b8a8aefc10eb3", "message": "Remove AwaitsFix", "committedDate": "2020-04-14T09:48:39Z", "type": "commit"}, {"oid": "ad34e21a6e0fed5f92368e30fc59cbe2d40d6738", "url": "https://github.com/elastic/elasticsearch/commit/ad34e21a6e0fed5f92368e30fc59cbe2d40d6738", "message": "Fix testCreateAndRestoreSearchableSnapshot\n\nFixes a couple of related failures in SearchableSnapshotsIntegTests.\n\nFirstly, we were not correctly accounting for the case where the cache was so\nsmall that some/all files were read directly; fixed this by only asserting that\nthe cache is definitely used if the corresponding node has a cache that's large\nenough to hold the whole index.\n\nSecondly, we were not permitting shards to be completely empty, which might be\nthe case (rarely) if there were not many documents indexed and the distribution\nof IDs was a bit unlucky; fixed this by asserting that we get stats for at\nleast one file for the whole index, rather than for each shard separately.\n\nCloses #55126", "committedDate": "2020-04-14T09:54:54Z", "type": "commit"}, {"oid": "88aa9c5d9baa93da8c20858db1e216d136070bd9", "url": "https://github.com/elastic/elasticsearch/commit/88aa9c5d9baa93da8c20858db1e216d136070bd9", "message": "Imports", "committedDate": "2020-04-14T10:00:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAxNjA1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55147#discussion_r408016056", "bodyText": "Kinda unrelated change, but this was useful for debugging.", "author": "DaveCTurner", "createdAt": "2020-04-14T10:00:51Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/searchablesnapshots/SearchableSnapshotShardStats.java", "diffHunk": "@@ -77,6 +77,7 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n             builder.field(\"index_uuid\", getIndexId().getId());\n             builder.startObject(\"shard\");\n             {\n+                builder.field(\"id\", shardRouting.shardId());", "originalCommit": "ad34e21a6e0fed5f92368e30fc59cbe2d40d6738", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAxNjU4NA==", "url": "https://github.com/elastic/elasticsearch/pull/55147#discussion_r408016584", "bodyText": "Prior to this change the smallest nonzero cache size was 1kB which was typically larger than many of the files seen in this test, so I thought this might improve coverage a bit.", "author": "DaveCTurner", "createdAt": "2020-04-14T10:01:48Z", "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/BaseSearchableSnapshotsIntegTestCase.java", "diffHunk": "@@ -55,7 +55,9 @@ protected Settings nodeSettings(int nodeOrdinal) {\n             builder.put(\n                 CacheService.SNAPSHOT_CACHE_SIZE_SETTING.getKey(),\n                 rarely()\n-                    ? new ByteSizeValue(randomIntBetween(0, 10), ByteSizeUnit.KB)\n+                    ? randomBoolean()\n+                        ? new ByteSizeValue(randomIntBetween(0, 10), ByteSizeUnit.KB)\n+                        : new ByteSizeValue(randomIntBetween(0, 1000), ByteSizeUnit.BYTES)", "originalCommit": "ad34e21a6e0fed5f92368e30fc59cbe2d40d6738", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "951cdfaebd4b97db50f23c093c13d329c773c736", "url": "https://github.com/elastic/elasticsearch/commit/951cdfaebd4b97db50f23c093c13d329c773c736", "message": "Whitespace", "committedDate": "2020-04-14T10:05:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAzMTUwOA==", "url": "https://github.com/elastic/elasticsearch/pull/55147#discussion_r408031508", "bodyText": "\ud83d\ude37", "author": "tlrx", "createdAt": "2020-04-14T10:27:01Z", "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -261,11 +265,33 @@ private void assertSearchableSnapshotStats(String indexName, boolean cacheEnable\n         final NumShards restoredNumShards = getNumShards(indexName);\n         assertThat(statsResponse.getStats(), hasSize(restoredNumShards.totalNumShards));\n \n+        final long totalSize = statsResponse.getStats()\n+            .stream()\n+            .flatMap(s -> s.getStats().stream())\n+            .mapToLong(SearchableSnapshotShardStats.CacheIndexInputStats::getFileLength)\n+            .sum();\n+        final Set<String> nodeIdsWithLargeEnoughCache = new HashSet<>();\n+        for (ObjectCursor<DiscoveryNode> nodeCursor : client().admin()\n+            .cluster()\n+            .prepareState()\n+            .clear()\n+            .setNodes(true)\n+            .get()\n+            .getState()\n+            .nodes()\n+            .getDataNodes()\n+            .values()) {", "originalCommit": "951cdfaebd4b97db50f23c093c13d329c773c736", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}