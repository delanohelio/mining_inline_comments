{"pr_number": 58818, "pr_title": "Cleanup Duplication in Snapshot ITs", "pr_createdAt": "2020-07-01T10:09:29Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58818", "timeline": [{"oid": "e057bdfd043c8649c3cf59c925965c889fc5be17", "url": "https://github.com/elastic/elasticsearch/commit/e057bdfd043c8649c3cf59c925965c889fc5be17", "message": "Cleanup Duplication in Snapshot ITs\n\nJust a few obvious static cleanups of duplication to push back against the ever increasing complexity of these tests.", "committedDate": "2020-07-01T10:08:00Z", "type": "commit"}, {"oid": "57a340c4a1822d29797cdaa49660101790a99110", "url": "https://github.com/elastic/elasticsearch/commit/57a340c4a1822d29797cdaa49660101790a99110", "message": "Merge remote-tracking branch 'elastic/master' into dry-up-snapshot-tests", "committedDate": "2020-07-01T10:59:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg3NDI5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/58818#discussion_r448874291", "bodyText": "I think it deserves a createFsRepository(); I'd also rarely set a random chunk size", "author": "tlrx", "createdAt": "2020-07-02T09:32:21Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/repositories/blobstore/BlobStoreRepositoryCleanupIT.java", "diffHunk": "@@ -116,11 +112,8 @@ public void testCleanupOldIndexN() throws ExecutionException, InterruptedExcepti\n         internalCluster().startNodes(Settings.EMPTY);\n \n         final String repoName = \"test-repo\";\n-        logger.info(\"-->  creating repository\");\n-        assertAcked(client().admin().cluster().preparePutRepository(repoName).setType(\"fs\").setSettings(Settings.builder()\n-            .put(\"location\", randomRepoPath())\n-            .put(\"compress\", randomBoolean())\n-            .put(\"chunk_size\", randomIntBetween(100, 1000), ByteSizeUnit.BYTES)));\n+        createRepository(repoName, \"fs\", Settings.builder().put(\"location\", randomRepoPath()).put(\"compress\", randomBoolean())", "originalCommit": "57a340c4a1822d29797cdaa49660101790a99110", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2ODQ3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/58818#discussion_r448968475", "bodyText": "Let's do this in a follow up since it's so many spots to change? I was thinking about unifying the various random settings we use as much as possible anyway. Currently there's so many different kinds of random which aren't really needed in most cases. There's just a handful of tests where things like compression -> false are actually necessary and the rest could all just use the same randomness. Just figured that's probably best done separately since it's a logical change to the tests?", "author": "original-brownbear", "createdAt": "2020-07-02T12:35:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg3NDI5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3NjQwNg==", "url": "https://github.com/elastic/elasticsearch/pull/58818#discussion_r448976406", "bodyText": "Sure", "author": "tlrx", "createdAt": "2020-07-02T12:49:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg3NDI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg3NjI1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/58818#discussion_r448876251", "bodyText": "Is it overriden somewhere? If not it can be static.", "author": "tlrx", "createdAt": "2020-07-02T09:35:50Z", "path": "server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java", "diffHunk": "@@ -264,11 +264,14 @@ public static void unblockNode(final String repository, final String node) {\n         ((MockRepository)internalCluster().getInstance(RepositoriesService.class, node).repository(repository)).unblock();\n     }\n \n-    protected void createRepository(String repoName, String type, Path location) {\n-        logger.info(\"-->  creating repository\");\n+    protected void createRepository(String repoName, String type, Settings.Builder settings) {", "originalCommit": "57a340c4a1822d29797cdaa49660101790a99110", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2NzEzMg==", "url": "https://github.com/elastic/elasticsearch/pull/58818#discussion_r448967132", "bodyText": "It uses the logger instance which is not static in the tests (can't be because we want the test suit in the logger name).", "author": "original-brownbear", "createdAt": "2020-07-02T12:32:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg3NjI1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3NjE0OA==", "url": "https://github.com/elastic/elasticsearch/pull/58818#discussion_r448976148", "bodyText": "Right - did not spot that. Sorry for the noise.", "author": "tlrx", "createdAt": "2020-07-02T12:48:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg3NjI1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg3NjM3OA==", "url": "https://github.com/elastic/elasticsearch/pull/58818#discussion_r448876378", "bodyText": "Maybe static?", "author": "tlrx", "createdAt": "2020-07-02T09:36:06Z", "path": "server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java", "diffHunk": "@@ -307,4 +310,16 @@ protected String initWithSnapshotVersion(String repoName, Path repoPath, Version\n                 StandardOpenOption.TRUNCATE_EXISTING);\n         return oldVersionSnapshot;\n     }\n+\n+    protected SnapshotInfo createFullSnapshot(String repoName, String snapshotName) {", "originalCommit": "57a340c4a1822d29797cdaa49660101790a99110", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2NzM5NA==", "url": "https://github.com/elastic/elasticsearch/pull/58818#discussion_r448967394", "bodyText": "Same explanation as above, the logger this thing uses isn't static.", "author": "original-brownbear", "createdAt": "2020-07-02T12:33:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg3NjM3OA=="}], "type": "inlineReview"}]}