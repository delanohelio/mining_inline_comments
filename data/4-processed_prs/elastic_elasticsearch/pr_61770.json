{"pr_number": 61770, "pr_title": "Fix Concurrent Snapshot Create+Delete + Delete Index", "pr_createdAt": "2020-09-01T08:41:14Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61770", "timeline": [{"oid": "ef9e508536cb2e66f39f5848319b7578a2a6ae47", "url": "https://github.com/elastic/elasticsearch/commit/ef9e508536cb2e66f39f5848319b7578a2a6ae47", "message": "Fix Concurrent Snapshot Create+Delete + Delete Index\n\nWe had a bug here were we put a `null` value into the shard\nassignment mapping when reassigning work after a snapshot delete\nhad gone through. This only affects partial snaphots but essentially\ndead-locks the snapshot process.\n\nCloses #61762", "committedDate": "2020-09-01T08:38:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk4MTUyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/61770#discussion_r480981525", "bodyText": "Before concurrent snapshots this spot would cover all possible scenarios because we'd only be dealing with shard ids for indices that still exist in the repo ever beyond this point. If an index was deleted after assignment then it would just fail in the SnapshotShardsService and things would work out that way.\nBut with concurrent snapshots where we could have indices deleted from under a queued up shard snapshot we have to explicitly deal with this situation.", "author": "original-brownbear", "createdAt": "2020-09-01T08:57:31Z", "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -1715,8 +1723,7 @@ public static ClusterState updateWithSnapshots(ClusterState state,\n             IndexMetadata indexMetadata = metadata.index(indexName);\n             if (indexMetadata == null) {\n                 // The index was deleted before we managed to start the snapshot - mark it as missing.\n-                builder.put(new ShardId(indexName, IndexMetadata.INDEX_UUID_NA_VALUE, 0),\n-                    new SnapshotsInProgress.ShardSnapshotStatus(null, ShardState.MISSING, \"missing index\", null));\n+                builder.put(new ShardId(indexName, IndexMetadata.INDEX_UUID_NA_VALUE, 0), ShardSnapshotStatus.MISSING);", "originalCommit": "ef9e508536cb2e66f39f5848319b7578a2a6ae47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}