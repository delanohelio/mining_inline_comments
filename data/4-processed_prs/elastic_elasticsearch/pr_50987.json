{"pr_number": 50987, "pr_title": "Fix Infinite Retry Loop in loading RepositoryData", "pr_createdAt": "2020-01-14T16:09:20Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50987", "timeline": [{"oid": "425253868b0159f9e5691f883f090aae2f7115e0", "url": "https://github.com/elastic/elasticsearch/commit/425253868b0159f9e5691f883f090aae2f7115e0", "message": "Fix Infinite Retry Loop in loading RepositoryData\n\nWe were running into an infinite loop when trying to load corrupted (or otherwise un-loadable)\nrepository data for a repo that uses best effort consistency (e.g. that was just freshly mounted\nas done in the test) because we kepy resetting to `-1` on `IOException`, listing and finding the broken\ngeneration `N` and then interpreted the subsequent reset to `-1` as a concurrent change to the repository.", "committedDate": "2020-01-14T16:05:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQyOTg2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/50987#discussion_r366429866", "bodyText": "Fixed these spots because a.) it's just the right thing to not mix listener and throwing :) but also so that the exception properly bubbles up the listener chain in the test infrastructure that has to run this method off the test thread (because we assert that it only runs on the generic or snapshot pool)", "author": "original-brownbear", "createdAt": "2020-01-14T16:11:21Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1058,7 +1061,9 @@ public void getRepositoryData(ActionListener<RepositoryData> listener) {\n                 try {\n                     generation = latestIndexBlobId();\n                 } catch (IOException ioe) {\n-                    throw new RepositoryException(metadata.name(), \"Could not determine repository generation from root blobs\", ioe);\n+                    listener.onFailure(", "originalCommit": "425253868b0159f9e5691f883f090aae2f7115e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "48c979b6912c052c447cffd2ac0f37d1236a13c7", "url": "https://github.com/elastic/elasticsearch/commit/48c979b6912c052c447cffd2ac0f37d1236a13c7", "message": "Merge remote-tracking branch 'elastic/master' into fix-broken-repo-retry", "committedDate": "2020-01-14T16:22:17Z", "type": "commit"}, {"oid": "bca82f4e29f22d7f3d1827c8808b381d0d8bb3f2", "url": "https://github.com/elastic/elasticsearch/commit/bca82f4e29f22d7f3d1827c8808b381d0d8bb3f2", "message": "add logging", "committedDate": "2020-01-14T16:35:43Z", "type": "commit"}]}