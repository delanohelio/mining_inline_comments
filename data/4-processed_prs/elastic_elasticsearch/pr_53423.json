{"pr_number": 53423, "pr_title": "Stop using round-tripped PipelineAggregators", "pr_createdAt": "2020-03-11T17:28:08Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53423", "timeline": [{"oid": "205cbe2dfcfcc4f06f94ceba7d4f7a55f64ca570", "url": "https://github.com/elastic/elasticsearch/commit/205cbe2dfcfcc4f06f94ceba7d4f7a55f64ca570", "message": "Stop using round-tripped PipelineAggregators\n\nThis begins to clean up how `PipelineAggregator`s and executed.\nPreviously, we would create the `PipelineAggregator`s on the data nodes\nand embed them in the aggregation tree. When it came time to execute the\npipeline aggregation we'd use the `PipelineAggregator`s that were on the\nfirst shard's results. This is inefficient because:\n1. The data node needs to make the `PipelineAggregator` only to\n   serialize it and then throw it away.\n2. The coordinating node needs to deserialize all of the\n   `PipelineAggregator`s even though it only needs one of them.\n3. You end up with many `PipelineAggregator` instances when you only\n   really *need* one per pipeline.\n4. `PipelineAggregator` needs to implement serialization.\n\nThis begins to undo these by building the `PipelineAggregator`s directly\non the coordinating node and using those instead of the\n`PipelineAggregator`s in the aggregtion tree. In a follow up change\nwe'll stop serializing the `PipelineAggregator`s to node versions that\nsupport this behavior. And, one day, we'll be able to remove\n`PipelineAggregator` from the aggregation result tree entirely.\n\nImportantly, this doesn't change how pipeline aggregations are declared\nor parsed or requested. They are still part of the `AggregationBuilder`\ntree because *that* makes sense.", "committedDate": "2020-03-11T17:26:04Z", "type": "commit"}, {"oid": "229c479a4940b1842b9c509663a827d22e154412", "url": "https://github.com/elastic/elasticsearch/commit/229c479a4940b1842b9c509663a827d22e154412", "message": "Merge branch 'master' into no_round_pipelines", "committedDate": "2020-03-11T17:41:10Z", "type": "commit"}, {"oid": "63045b8c1a8ca4cd19de85313951de914aa5783f", "url": "https://github.com/elastic/elasticsearch/commit/63045b8c1a8ca4cd19de85313951de914aa5783f", "message": "Javadoc", "committedDate": "2020-03-11T18:17:23Z", "type": "commit"}, {"oid": "5b8ba7803c189c848ebcc70dd07104862ec058fc", "url": "https://github.com/elastic/elasticsearch/commit/5b8ba7803c189c848ebcc70dd07104862ec058fc", "message": "WIP", "committedDate": "2020-03-11T20:42:52Z", "type": "commit"}, {"oid": "04fac9b63eca7fddad3464a49824523f5ffa5962", "url": "https://github.com/elastic/elasticsearch/commit/04fac9b63eca7fddad3464a49824523f5ffa5962", "message": "Merge branch 'master' into no_round_pipelines", "committedDate": "2020-03-11T23:26:31Z", "type": "commit"}, {"oid": "8f429776fd20e4cdf508c5ed1022608db3e61971", "url": "https://github.com/elastic/elasticsearch/commit/8f429776fd20e4cdf508c5ed1022608db3e61971", "message": "Sneaky sneaky", "committedDate": "2020-03-12T19:49:55Z", "type": "commit"}, {"oid": "abf6fc10a0cd56e55c1215249bae9ed130a6ffc0", "url": "https://github.com/elastic/elasticsearch/commit/abf6fc10a0cd56e55c1215249bae9ed130a6ffc0", "message": "Merge branch 'master' into no_round_pipelines", "committedDate": "2020-03-12T21:18:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwOTU3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53423#discussion_r391909575", "bodyText": "@jimczi, I remember us trying not to hold on to references to the SearchRequest because it could be big. Or something like that. Is that still a thing? It looks like we keep the SearchRequest around for a while during the search right now.", "author": "nik9000", "createdAt": "2020-03-12T21:33:40Z", "path": "server/src/main/java/org/elasticsearch/search/SearchService.java", "diffHunk": "@@ -1200,9 +1203,31 @@ public IndicesService getIndicesService() {\n         return indicesService;\n     }\n \n-    public InternalAggregation.ReduceContext createReduceContext(boolean finalReduce) {\n-        return new InternalAggregation.ReduceContext(bigArrays, scriptService,\n-            finalReduce ? multiBucketConsumerService.create() : bucketCount -> {}, finalReduce);\n+    /**\n+     * Returns a builder for {@link InternalAggregation.ReduceContext}. This\n+     * builder retains a reference to the provided {@link SearchRequest}.\n+     */", "originalCommit": "abf6fc10a0cd56e55c1215249bae9ed130a6ffc0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkyNzUyNw==", "url": "https://github.com/elastic/elasticsearch/pull/53423#discussion_r391927527", "bodyText": "That's totally ok since you refer to the original request which is unique per search. You also build the pipeline tree lazily which seems like a nice win to me.", "author": "jimczi", "createdAt": "2020-03-12T21:57:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkwOTU3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkxOTYwMw==", "url": "https://github.com/elastic/elasticsearch/pull/53423#discussion_r391919603", "bodyText": "\u2764\ufe0f", "author": "jimczi", "createdAt": "2020-03-12T21:47:00Z", "path": "server/src/main/java/org/elasticsearch/action/search/SearchPhaseController.java", "diffHunk": "@@ -394,17 +391,30 @@ private SearchHits getHits(ReducedQueryPhase reducedQueryPhase, boolean ignoreFr\n      * @param queryResults a list of non-null query shard results\n      */\n     ReducedQueryPhase reducedScrollQueryPhase(Collection<? extends SearchPhaseResult> queryResults) {\n-        return reducedQueryPhase(queryResults, true, SearchContext.TRACK_TOTAL_HITS_ACCURATE, true);\n+        InternalAggregation.ReduceContextBuilder aggReduceContextBuilder = new InternalAggregation.ReduceContextBuilder() {\n+            @Override\n+            public ReduceContext forPartialReduction() {\n+                throw new UnsupportedOperationException(\"Scroll requests don't have aggs\");", "originalCommit": "abf6fc10a0cd56e55c1215249bae9ed130a6ffc0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkyOTQwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/53423#discussion_r391929409", "bodyText": "Good catch, let's open an issue since it seems easy to fix rather than a TODO ?", "author": "jimczi", "createdAt": "2020-03-12T22:00:16Z", "path": "x-pack/plugin/rollup/src/main/java/org/elasticsearch/xpack/rollup/RollupResponseTranslator.java", "diffHunk": "@@ -289,14 +292,14 @@ private static SearchResponse doCombineResponse(SearchResponse liveResponse, Lis\n             // Iteratively merge in each new set of unrolled aggs, so that we can identify/fix overlapping doc_counts\n             // in the next round of unrolling\n             InternalAggregations finalUnrolledAggs = new InternalAggregations(unrolledAggs);\n-            currentTree = InternalAggregations.reduce(Arrays.asList(currentTree, finalUnrolledAggs),\n-                    new InternalAggregation.ReduceContext(reduceContext.bigArrays(), reduceContext.scriptService(), true));\n+            currentTree = InternalAggregations.reduce(Arrays.asList(currentTree, finalUnrolledAggs), finalReduceContext);\n         }\n \n         // Add in the live aggregations if they exist\n         if (liveAggs.asList().size() != 0) {\n-            currentTree = InternalAggregations.reduce(Arrays.asList(currentTree, liveAggs),\n-                    new InternalAggregation.ReduceContext(reduceContext.bigArrays(), reduceContext.scriptService(), true));\n+            // TODO it looks like this passes the \"final\" reduce context more than once.\n+            // Once here and once in the for above. That is bound to cause trouble.\n+            currentTree = InternalAggregations.reduce(Arrays.asList(currentTree, liveAggs), finalReduceContext);", "originalCommit": "abf6fc10a0cd56e55c1215249bae9ed130a6ffc0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkzMzYyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/53423#discussion_r391933621", "bodyText": "++", "author": "nik9000", "createdAt": "2020-03-12T22:11:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkyOTQwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk0NjUzMA==", "url": "https://github.com/elastic/elasticsearch/pull/53423#discussion_r391946530", "bodyText": "#53524", "author": "nik9000", "createdAt": "2020-03-12T22:51:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkyOTQwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk3MTg0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53423#discussion_r391971842", "bodyText": "\ud83d\udc4d", "author": "jimczi", "createdAt": "2020-03-13T00:27:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkyOTQwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM3Nzc2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53423#discussion_r392377762", "bodyText": "\ud83d\udc4d indeed.  Rollup doesn't work with pipelines anyhow (mostly due to the serialization issue, with different aggs being sent to rollup vs live indices, it messes up how pipelines operate).... but I could see multiple final reductions potentially hurting accuracy on certain aggs that care like terms", "author": "polyfractal", "createdAt": "2020-03-13T17:42:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkyOTQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM3MjY4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53423#discussion_r392372686", "bodyText": "While we're here, is it possible to nuke skipResolveOrder too?  I believe it's only used by BasePipelineAggregationTestCase, and that doesn't even invoke build() so this is basically \"dead\" testing code.  I think.\nNot a problem to leave if there's a complication... I just particularly dislike this little tidbit and wouldn't mind seeing it go if we're already touching this :)", "author": "polyfractal", "createdAt": "2020-03-13T17:32:22Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregatorFactories.java", "diffHunk": "@@ -311,8 +315,10 @@ public AggregatorFactories build(QueryShardContext queryShardContext, Aggregator\n             if (skipResolveOrder) {", "originalCommit": "abf6fc10a0cd56e55c1215249bae9ed130a6ffc0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9e5025612bc5a33515eca21593d8a70b583c1056", "url": "https://github.com/elastic/elasticsearch/commit/9e5025612bc5a33515eca21593d8a70b583c1056", "message": "Merge branch 'master' into no_round_pipelines", "committedDate": "2020-03-16T17:25:09Z", "type": "commit"}, {"oid": "fed6af65ab772c8aa34302dd1731e7a4cbeda3c2", "url": "https://github.com/elastic/elasticsearch/commit/fed6af65ab772c8aa34302dd1731e7a4cbeda3c2", "message": "Drop skip resolve order", "committedDate": "2020-03-16T17:46:41Z", "type": "commit"}]}