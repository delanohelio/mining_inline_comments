{"pr_number": 54936, "pr_title": "Add method to check if object is generically writeable in stream", "pr_createdAt": "2020-04-08T06:51:28Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54936", "timeline": [{"oid": "c0921afa81308f0191f0315a6024601b5fdeb26a", "url": "https://github.com/elastic/elasticsearch/commit/c0921afa81308f0191f0315a6024601b5fdeb26a", "message": "Add method to check if object is generically writeable in stream\n\nWhen calling scripts in metric aggregation, the returned metric state is\npassed along to the coordinating node to do the final reduce. However,\nit is possible the object could contain nested state which is unknown to\nStreamOutput/StreamInput. This would then result in the node crashing as\nexceptions are not expected in the middle of serialization.\n\nThis commit adds a method to StreamOutput that can determine if an\nobject is writeable by the stream. It uses the same logic\nwriteGenericValue, special casing each of the supported collection types\nto recursively determine if each contained value is itself writeable.\n\nrelates #54708", "committedDate": "2020-04-08T06:44:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMzMTAyMw==", "url": "https://github.com/elastic/elasticsearch/pull/54936#discussion_r405331023", "bodyText": "I wonder if we could/should combine this with org.elasticsearch.common.util.CollectionUtils#ensureNoSelfReferences(java.lang.Object, java.lang.String) somehow? It seems like technically we would want to use this in all the spots that we currently also use that method to validate script returns (maybe I'm missing some detail and we wouldn't need to do this kind of validation in other script return spots and only need the no-self-references there for some reason?). That way we'd save iterating through the object to validate twice?", "author": "original-brownbear", "createdAt": "2020-04-08T08:00:14Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/ScriptedMetricAggregator.java", "diffHunk": "@@ -90,6 +91,7 @@ public InternalAggregation buildAggregation(long owningBucketOrdinal) {\n         } else {\n             aggregation = aggState;\n         }\n+        StreamOutput.checkWriteable(aggregation);", "originalCommit": "c0921afa81308f0191f0315a6024601b5fdeb26a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4MjA2OA==", "url": "https://github.com/elastic/elasticsearch/pull/54936#discussion_r405682068", "bodyText": "I'm not sure we need both in all cases. ensureNoSelfReferences guarantees we can do any operation on the object in question (not resulting in an infinite loop). Checking if the object is writeable is only needed when we plan to write the object to transfer to another node. For example, with scripted metric aggs, we don't every write the node local results from init or map scripts, only the output of combine here that would be transferred to the coordinating node for the final reduce.", "author": "rjernst", "createdAt": "2020-04-08T17:10:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMzMTAyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4NzA3NA==", "url": "https://github.com/elastic/elasticsearch/pull/54936#discussion_r405687074", "bodyText": "Ok makes sense then :) => I think the approach is fine.", "author": "original-brownbear", "createdAt": "2020-04-08T17:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMzMTAyMw=="}], "type": "inlineReview"}, {"oid": "bd05bfe105e8c38fcb42a6f6ff2cfe640a7872da", "url": "https://github.com/elastic/elasticsearch/commit/bd05bfe105e8c38fcb42a6f6ff2cfe640a7872da", "message": "Merge branch 'master' into stream_iswriteable", "committedDate": "2020-04-20T18:37:33Z", "type": "commit"}, {"oid": "de5fd366753d20304aca42df09443106f347b23c", "url": "https://github.com/elastic/elasticsearch/commit/de5fd366753d20304aca42df09443106f347b23c", "message": "add tests", "committedDate": "2020-04-20T18:37:39Z", "type": "commit"}]}