{"pr_number": 61189, "pr_title": "EQL: make stringContains function use a wildcard ES query wherever possible", "pr_createdAt": "2020-08-17T09:12:12Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61189", "timeline": [{"oid": "0204b5c65d8f22187737e7287553c3eb576b7f56", "url": "https://github.com/elastic/elasticsearch/commit/0204b5c65d8f22187737e7287553c3eb576b7f56", "message": "Make stringContains function use a \"wildcard\" query for case sensitive\nsearches", "committedDate": "2020-08-17T09:05:08Z", "type": "commit"}, {"oid": "d48d589e04de1114bc394818a0d754ff364b595c", "url": "https://github.com/elastic/elasticsearch/commit/d48d589e04de1114bc394818a0d754ff364b595c", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 58922__impl", "committedDate": "2020-08-17T09:07:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzNTM4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/61189#discussion_r471435382", "bodyText": "Wouldn't this work better in ExpressionTranslators#Scalars where StartsWith is handled?", "author": "costin", "createdAt": "2020-08-17T12:10:29Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/planner/QueryTranslator.java", "diffHunk": "@@ -108,6 +110,15 @@ public static Query doTranslate(ScalarFunction f, TranslatorHandler handler) {\n                     return new TermsQuery(f.source(), targetFieldName, set);\n                 }\n             }\n+            if (f instanceof StringContains) {\n+                StringContains sc = (StringContains) f;\n+                if (sc.isCaseSensitive() && sc.string() instanceof FieldAttribute && sc.substring().foldable()) {\n+                    String targetFieldName = handler.nameOf(((FieldAttribute) sc.string()).exactAttribute());\n+                    String substring = (String) sc.substring().fold();\n+\n+                    return new WildcardQuery(f.source(), targetFieldName, \"*\" + substring + \"*\");\n+                }\n+            }", "originalCommit": "d48d589e04de1114bc394818a0d754ff364b595c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzNTk0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/61189#discussion_r471435945", "bodyText": "Speaking of, having a rule for CaseSensitiveScalarFunction might work better since it handle the `if (isCaseSensitive && FieldAttribute && foldable) so subclasses would only look at the name and the query while reusing the infrastructure.", "author": "costin", "createdAt": "2020-08-17T12:11:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzNTM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1MzA4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/61189#discussion_r472053082", "bodyText": "StartsWith is special because is common to SQL and EQL while stringContains, endsWith belong only to EQL. Agree with a separate rule, though.", "author": "astefan", "createdAt": "2020-08-18T09:44:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzNTM4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzNjA4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/61189#discussion_r471436089", "bodyText": "I thought we can't tell whether something is a wildcard or keyword.", "author": "costin", "createdAt": "2020-08-17T12:11:54Z", "path": "x-pack/plugin/eql/src/test/resources/mapping-default.json", "diffHunk": "@@ -56,7 +56,7 @@\n             \"type\" : \"text\",\n             \"fields\" : {\n                 \"keyword\" : {\n-                    \"type\" : \"keyword\",\n+                    \"type\" : \"wildcard\",", "originalCommit": "d48d589e04de1114bc394818a0d754ff364b595c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA2MzQ0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/61189#discussion_r472063447", "bodyText": "We cannot, but this doesn't mean we shouldn't test different field types.", "author": "astefan", "createdAt": "2020-08-18T10:02:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzNjA4OQ=="}], "type": "inlineReview"}, {"oid": "4d0f00653e52428646874f0b19e5c57b95da8ca4", "url": "https://github.com/elastic/elasticsearch/commit/4d0f00653e52428646874f0b19e5c57b95da8ca4", "message": "Address review", "committedDate": "2020-08-18T09:57:40Z", "type": "commit"}, {"oid": "d9306ba0bce5fe304bf9b8bfcc57e28fc48a8d13", "url": "https://github.com/elastic/elasticsearch/commit/d9306ba0bce5fe304bf9b8bfcc57e28fc48a8d13", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 58922__impl", "committedDate": "2020-08-18T09:57:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjExMDQ5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/61189#discussion_r472110492", "bodyText": "This looks wrong - in the case in particular - if the function is StringContains do something, otherwise return null?\nWhy not make the ExpressionTranslator for StringContains only instead of CaseSensitiveScalarFunction?", "author": "costin", "createdAt": "2020-08-18T11:35:04Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/planner/QueryTranslator.java", "diffHunk": "@@ -112,4 +116,34 @@ public static Query doTranslate(ScalarFunction f, TranslatorHandler handler) {\n             return handler.wrapFunctionQuery(f, f, new ScriptQuery(f.source(), f.asScript()));\n         }\n     }\n+\n+    public static class CaseSensitiveScalarFunctions extends ExpressionTranslator<CaseSensitiveScalarFunction> {\n+\n+        @Override\n+        protected Query asQuery(CaseSensitiveScalarFunction f, TranslatorHandler handler) {\n+            return f.isCaseSensitive() ? doTranslate(f, handler) : null;\n+        }\n+\n+        public static Query doTranslate(CaseSensitiveScalarFunction f, TranslatorHandler handler) {\n+            Expression field = null;\n+            Expression constant = null;\n+\n+            if (f instanceof StringContains) {\n+                StringContains sc = (StringContains) f;\n+                field = sc.string();\n+                constant = sc.substring();\n+            } else {\n+                return null;\n+            }", "originalCommit": "d9306ba0bce5fe304bf9b8bfcc57e28fc48a8d13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI0NDYzNw==", "url": "https://github.com/elastic/elasticsearch/pull/61189#discussion_r472244637", "bodyText": "After this PR is merged, the follow up one (#61160 endsWith) will make this condition look like:\nif (f instanceof StringContains) {\n} else if (f instanceof EndsWith) {\n} else {\nreturn null;\n}", "author": "astefan", "createdAt": "2020-08-18T14:34:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjExMDQ5Mg=="}], "type": "inlineReview"}]}