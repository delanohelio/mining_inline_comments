{"pr_number": 61113, "pr_title": "Borrow more tests for runtime fields", "pr_createdAt": "2020-08-13T19:04:40Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61113", "timeline": [{"oid": "509385cd33f20754a8b1f2a7b79206337164855f", "url": "https://github.com/elastic/elasticsearch/commit/509385cd33f20754a8b1f2a7b79206337164855f", "message": "Borrow more tests for runtime fields\n\nThis \"borrows\" 150 more tests from core for runtime fields, extending\nthe work done in #60931. More precisely, it adds a template to every\ntest that forces dynamic mapping updates to build runtime fields where\npossible. In particular, `long` and `double` field are created as\nruntime fields. `string`-typed fields are mimick the out of the box\nbehavior and create a top level `text` field with a `.keyword`\nmulti-field, but this `keyword` multi-field executes a script and loads\nfrom source.", "committedDate": "2020-08-13T18:58:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUwMjg5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/61113#discussion_r470502897", "bodyText": "what is string here? Is it the old field type string from before we had text and keyword?", "author": "javanna", "createdAt": "2020-08-14T09:02:59Z", "path": "x-pack/plugin/runtime-fields/qa/rest/src/yamlRestTest/java/org/elasticsearch/xpack/runtimefields/rest/CoreTestsWithRuntimeFieldsIT.java", "diffHunk": "@@ -173,4 +195,54 @@ private static String painlessToLoadFromSource(String name, String type) {\n         )\n     );\n \n+    private static final ExecutableSection ADD_TEMPLATE = new ExecutableSection() {\n+        @Override\n+        public XContentLocation getLocation() {\n+            return new XContentLocation(-1, -1);\n+        }\n+\n+        @Override\n+        public void execute(ClientYamlTestExecutionContext executionContext) throws IOException {\n+            Map<String, String> params = Map.of(\"name\", \"convert_to_source_only\", \"create\", \"true\");\n+            List<Map<String, Object>> dynamicTemplates = new ArrayList<>();\n+            for (String type : PAINLESS_TO_EMIT.keySet()) {\n+                if (type.equals(\"ip\")) {\n+                    // There isn't a dynamic template to pick up ips. They'll just look like strings.\n+                    continue;\n+                }\n+                Map<String, Object> mapping = Map.ofEntries(\n+                    Map.entry(\"type\", \"runtime_script\"),\n+                    Map.entry(\"runtime_type\", type),\n+                    Map.entry(\"script\", painlessToLoadFromSource(\"{name}\", type))\n+                );\n+                Map<String, Object> body = Map.ofEntries(\n+                    Map.entry(\"match_mapping_type\", type.equals(\"keyword\") ? \"string\" : type),", "originalCommit": "509385cd33f20754a8b1f2a7b79206337164855f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUxMDQzMg==", "url": "https://github.com/elastic/elasticsearch/pull/61113#discussion_r471510432", "bodyText": "I think it is! Dynamic templates mostly uses the types that we use but it uses string instead of text or keyword.", "author": "nik9000", "createdAt": "2020-08-17T14:17:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUwMjg5Nw=="}], "type": "inlineReview"}, {"oid": "2726de211564bb67d26215e589580fad322c7b14", "url": "https://github.com/elastic/elasticsearch/commit/2726de211564bb67d26215e589580fad322c7b14", "message": "Merge branch 'feature/runtime_fields' into runtime_fields_moar_tests", "committedDate": "2020-08-17T14:19:46Z", "type": "commit"}, {"oid": "4a3e3f4d68e832240f3e91c8638c02d4e93d27cf", "url": "https://github.com/elastic/elasticsearch/commit/4a3e3f4d68e832240f3e91c8638c02d4e93d27cf", "message": "Skip broken tests", "committedDate": "2020-08-17T14:33:23Z", "type": "commit"}]}