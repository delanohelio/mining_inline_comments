{"pr_number": 58848, "pr_title": "Data stream support for rank eval API", "pr_createdAt": "2020-07-01T14:44:21Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58848", "timeline": [{"oid": "4bf4f59b2fed86f0ab4ca6e3c8a18c8effd3c580", "url": "https://github.com/elastic/elasticsearch/commit/4bf4f59b2fed86f0ab4ca6e3c8a18c8effd3c580", "message": "Data stream support for rank eval API", "committedDate": "2020-07-01T14:35:22Z", "type": "commit"}, {"oid": "77db055c86a1743e1373aa4a5c95cc6a8b90382f", "url": "https://github.com/elastic/elasticsearch/commit/77db055c86a1743e1373aa4a5c95cc6a8b90382f", "message": "fix test", "committedDate": "2020-07-01T15:06:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQzMjc1OA==", "url": "https://github.com/elastic/elasticsearch/pull/58848#discussion_r448432758", "bodyText": "It's not clear to me how this can be changed so that the backing indices do not have to be specified.", "author": "danhermann", "createdAt": "2020-07-01T15:11:47Z", "path": "modules/rank-eval/src/test/resources/rest-api-spec/test/rank_eval/50_data_streams.yml", "diffHunk": "@@ -0,0 +1,100 @@\n+\"Verify rank eval with data streams\":\n+  - skip:\n+      version: \" - 7.99.99\"\n+      reason: \"change to 7.8.99 after backport\"\n+      features: allowed_warnings\n+\n+  - do:\n+      allowed_warnings:\n+        - \"index template [my-template] has index patterns [logs-*] matching patterns from existing older templates [global] with patterns (global => [*]); this template [my-template] will take precedence during new index creation\"\n+      indices.put_index_template:\n+        name: my-template\n+        body:\n+          index_patterns: [logs-*]\n+          template:\n+            mappings:\n+              properties:\n+                '@timestamp':\n+                  type: date\n+          data_stream:\n+            timestamp_field: '@timestamp'\n+\n+  - do:\n+      indices.create_data_stream:\n+        name: logs-foobar\n+  - is_true: acknowledged\n+\n+  - do:\n+      index:\n+        index:   logs-foobar\n+        id:      doc1\n+        op_type: create\n+        body:    { \"text\": \"berlin\" }\n+\n+  - do:\n+      index:\n+        index:   logs-foobar\n+        id:      doc2\n+        op_type: create\n+        body:    { \"text\": \"amsterdam\" }\n+\n+  # rollover data stream to split documents across multiple backing indices\n+  - do:\n+      indices.rollover:\n+        alias: \"logs-foobar\"\n+\n+  - match: { old_index: .ds-logs-foobar-000001 }\n+  - match: { new_index: .ds-logs-foobar-000002 }\n+  - match: { rolled_over: true }\n+  - match: { dry_run: false }\n+\n+  - do:\n+      index:\n+        index:   logs-foobar\n+        id:      doc3\n+        op_type: create\n+        body:    { \"text\": \"amsterdam\" }\n+\n+  - do:\n+      index:\n+        index:   logs-foobar\n+        id:      doc4\n+        op_type: create\n+        body:    { \"text\": \"something about amsterdam and berlin\" }\n+\n+  - do:\n+      indices.refresh:\n+        index: logs-foobar\n+\n+  - do:\n+      rank_eval:\n+        index: logs-foobar\n+        search_type: query_then_fetch\n+        body: {\n+          \"requests\" : [\n+          {\n+            \"id\": \"amsterdam_query\",\n+            \"request\": { \"query\": { \"match\" : {\"text\" : \"amsterdam\" }}},\n+            \"ratings\": [\n+            {\"_index\": \".ds-logs-foobar-000001\", \"_id\": \"doc1\", \"rating\": 0},\n+            {\"_index\": \".ds-logs-foobar-000001\", \"_id\": \"doc2\", \"rating\": 1},\n+            {\"_index\": \".ds-logs-foobar-000002\", \"_id\": \"doc3\", \"rating\": 1}]\n+          },\n+          {\n+            \"id\" : \"berlin_query\",\n+            \"request\": { \"query\": { \"match\" : { \"text\" : \"berlin\" } }, \"size\" : 10 },\n+            \"ratings\": [{\"_index\": \".ds-logs-foobar-000001\", \"_id\": \"doc1\", \"rating\": 1}]", "originalCommit": "77db055c86a1743e1373aa4a5c95cc6a8b90382f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk4OTE5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/58848#discussion_r448989191", "bodyText": "I think this ok. For the same reason why search hits return backing index name instead of data stream name.\nThe index and id are used to get match hits from the search response this api internally processed.\nWe keep returning the concrete index in the response and so therefor index names used in this request should also be concrete indices.", "author": "martijnvg", "createdAt": "2020-07-02T13:09:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQzMjc1OA=="}], "type": "inlineReview"}]}