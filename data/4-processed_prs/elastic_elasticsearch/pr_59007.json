{"pr_number": 59007, "pr_title": "Skip unnecessary directory iteration", "pr_createdAt": "2020-07-03T11:16:54Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59007", "timeline": [{"oid": "9bfb0e8d306f90b8b6a9fea0efd19222282efc02", "url": "https://github.com/elastic/elasticsearch/commit/9bfb0e8d306f90b8b6a9fea0efd19222282efc02", "message": "Skip unnecessary directory iteration\n\nToday `NodeEnvironment#findAllShardIds` enumerates the index directories\nin each data path in order to find one with a specific name. Since we\nalready know the name of the folder we seek we can construct the path\ndirectly and avoid this directory listing. This commit does that.", "committedDate": "2020-07-03T11:16:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3MTgwMg==", "url": "https://github.com/elastic/elasticsearch/pull/59007#discussion_r451171802", "bodyText": "Shouldn't this be checking nodePath.indicesPath.resolve(indexUniquePathId)?", "author": "rjernst", "createdAt": "2020-07-07T22:08:36Z", "path": "server/src/main/java/org/elasticsearch/env/NodeEnvironment.java", "diffHunk": "@@ -1044,15 +1044,8 @@ public String nodeId() {\n         final Set<ShardId> shardIds = new HashSet<>();\n         final String indexUniquePathId = index.getUUID();\n         for (final NodePath nodePath : nodePaths) {\n-            Path location = nodePath.indicesPath;\n-            if (Files.isDirectory(location)) {\n-                try (DirectoryStream<Path> indexStream = Files.newDirectoryStream(location)) {\n-                    for (Path indexPath : indexStream) {\n-                        if (indexUniquePathId.equals(indexPath.getFileName().toString())) {\n-                            shardIds.addAll(findAllShardsForIndex(indexPath, index));\n-                        }\n-                    }\n-                }\n+            if (Files.isDirectory(nodePath.indicesPath)) {", "originalCommit": "9bfb0e8d306f90b8b6a9fea0efd19222282efc02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQwNzI0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59007#discussion_r451407246", "bodyText": "This preserves the check in the original code; we already check Files.isDirectory(nodePath.indicesPath.resolve(indexUniquePathId)) within findAllShardsForIndex. Maybe we should just remove this check entirely?", "author": "DaveCTurner", "createdAt": "2020-07-08T09:25:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3MTgwMg=="}], "type": "inlineReview"}, {"oid": "43a12399c73e00c4b782e07e1ae81072b33d189f", "url": "https://github.com/elastic/elasticsearch/commit/43a12399c73e00c4b782e07e1ae81072b33d189f", "message": "Merge branch 'master' into 2020-07-03-skip-unnecessary-directory-iteration", "committedDate": "2020-07-08T13:00:28Z", "type": "commit"}, {"oid": "29a9b59f7f53495036d2887b928dfcd1512673aa", "url": "https://github.com/elastic/elasticsearch/commit/29a9b59f7f53495036d2887b928dfcd1512673aa", "message": "Remove unnecessary guard", "committedDate": "2020-07-08T13:01:08Z", "type": "commit"}]}