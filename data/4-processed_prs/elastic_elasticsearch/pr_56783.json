{"pr_number": 56783, "pr_title": "[ML] Ensure class is represented when its cardinality is low", "pr_createdAt": "2020-05-14T16:48:02Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56783", "timeline": [{"oid": "e5acbedd08f50e6462c5d5a1620d82906ddd70aa", "url": "https://github.com/elastic/elasticsearch/commit/e5acbedd08f50e6462c5d5a1620d82906ddd70aa", "message": "[ML] Ensure class is represented when its cardinality is low\n\nIn DF analytics classification, it is possible to use no samples\nof a class if its cardinality is too low.\n\nThis commit fixes this by ensuring the target sample count can never be zero.", "committedDate": "2020-05-14T16:45:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw==", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425350713", "bodyText": "Is it guaranteed that sample.cardinality is at least 1? If it was 0, then targetSampleCount would be 1 but maybe that's not what we'd wanted?", "author": "przemekwitek", "createdAt": "2020-05-14T18:36:09Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitter.java", "diffHunk": "@@ -57,9 +57,13 @@ public void process(String[] row, Runnable incrementTrainingDocs, Runnable incre\n             throw new IllegalStateException(\"Unknown class [\" + classValue + \"]; expected one of \" + classSamples.keySet());\n         }\n \n+        // We use ensure the target sample count is at least 1 as if the cardinality\n+        // is too low we might get a target of zero and, thus, no samples of the whole class\n+        double targetSampleCount = Math.max(1.0, samplingRatio * sample.cardinality);", "originalCommit": "e5acbedd08f50e6462c5d5a1620d82906ddd70aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1NDA5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425354091", "bodyText": "Wouldn't it be easier to just take the first value found?\nboolean isTraining = random.nextDouble() <= p || sample.observed == 0;", "author": "benwtrent", "createdAt": "2020-05-14T18:42:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYzMjY5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425632693", "bodyText": "@przemekwitek If cardinality was zero then we'd never encounter a doc with that class.\nHowever, @benwtrent 's suggestion also works. I'll change it to that as it seems simpler indeed.", "author": "dimitris-athanasiou", "createdAt": "2020-05-15T08:01:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY2MzgyMg==", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425663822", "bodyText": "Actually, as soon as I made that change the unit test we have for checking we uniformly pick samples failed. As this solution means we always pick the first value we see, we introduce a bias towards that. I'll stick to my original solution as it prevents that bias.", "author": "dimitris-athanasiou", "createdAt": "2020-05-15T08:59:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTczNTA1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425735052", "bodyText": "@dimitris-athanasiou I thought it was not possible to even run a classification job if cardinality was < 2. The test talks about a cardinality of 1.", "author": "benwtrent", "createdAt": "2020-05-15T11:19:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc1Njg2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425756865", "bodyText": "It makes no difference from the perspective of the code but I'll update to use cardinality of 2 for the sake of reflecting actual conditions.", "author": "dimitris-athanasiou", "createdAt": "2020-05-15T12:07:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc2MzE5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425763192", "bodyText": "Also, note these are different cardinalities we're talking about. The requirement of 2 refers to \"there should be at least 2 classes\". Whereas the addressed problem arises when the cardinality of the docs belonging to a certain class is low.", "author": "dimitris-athanasiou", "createdAt": "2020-05-15T12:20:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc2NDc3NA==", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425764774", "bodyText": "Whereas the addressed problem arises when the cardinality of the docs belonging to a certain class is low.\n\nAH! This is confusing \ud83e\udd14 . The solution as posed makes sense.", "author": "benwtrent", "createdAt": "2020-05-15T12:23:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc2NTE5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425765191", "bodyText": "I have pushed a commit that should make the unit test clearer and more realistic.", "author": "dimitris-athanasiou", "createdAt": "2020-05-15T12:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}], "type": "inlineReview"}, {"oid": "ab73e42fc9441432d7f81f08f2c11e1859b3d73c", "url": "https://github.com/elastic/elasticsearch/commit/ab73e42fc9441432d7f81f08f2c11e1859b3d73c", "message": "Improve unit test", "committedDate": "2020-05-15T12:24:14Z", "type": "commit"}, {"oid": "9300543b50143ec1ff26cb5fea3821fb7f1627c3", "url": "https://github.com/elastic/elasticsearch/commit/9300543b50143ec1ff26cb5fea3821fb7f1627c3", "message": "Merge branch 'master' into ensure-class-is-represented-when-its-cardinality-is-low", "committedDate": "2020-05-15T12:40:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgyMDg5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425820891", "bodyText": "\"We use ensure\"\nSomething is wrong with this sentence.", "author": "przemekwitek", "createdAt": "2020-05-15T13:58:43Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitter.java", "diffHunk": "@@ -57,9 +57,13 @@ public void process(String[] row, Runnable incrementTrainingDocs, Runnable incre\n             throw new IllegalStateException(\"Unknown class [\" + classValue + \"]; expected one of \" + classSamples.keySet());\n         }\n \n+        // We use ensure the target sample count is at least 1 as if the cardinality", "originalCommit": "9300543b50143ec1ff26cb5fea3821fb7f1627c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}