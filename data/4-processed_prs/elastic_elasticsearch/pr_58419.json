{"pr_number": 58419, "pr_title": "Introduce new put mapping action for dynamic mapping updates.", "pr_createdAt": "2020-06-23T10:32:07Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58419", "timeline": [{"oid": "9b054d3bdfd5431d9cbac5c44d16b192c305b0a1", "url": "https://github.com/elastic/elasticsearch/commit/9b054d3bdfd5431d9cbac5c44d16b192c305b0a1", "message": "Introduce new put mapping action for dynamic mapping updates.\n\nMapping updates that originate from indexing a document with unmapped fields will use this new action\ninstead of the current put mapping action. This way on the security side, authorization logic\ncan easily determine whether a mapping update is automatically generated or a mapping update originates\nfrom the put mapping api.", "committedDate": "2020-06-23T10:29:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyNjAzNw==", "url": "https://github.com/elastic/elasticsearch/pull/58419#discussion_r444126037", "bodyText": "This is a bug fix. Invoking this method directly caused a NPE.", "author": "martijnvg", "createdAt": "2020-06-23T10:33:30Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/mapping/put/PutMappingRequest.java", "diffHunk": "@@ -129,7 +129,7 @@ public PutMappingRequest indices(String... indices) {\n      * Sets a concrete index for this put mapping request.\n      */\n     public PutMappingRequest setConcreteIndex(Index index) {\n-        Objects.requireNonNull(indices, \"index must not be null\");\n+        Objects.requireNonNull(index, \"index must not be null\");", "originalCommit": "9b054d3bdfd5431d9cbac5c44d16b192c305b0a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyNjM4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/58419#discussion_r444126385", "bodyText": "Extracted the common logic that both regular put mapping api calls and a dynamic mapping update reuse.", "author": "martijnvg", "createdAt": "2020-06-23T10:34:14Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/mapping/put/TransportPutMappingAction.java", "diffHunk": "@@ -106,29 +106,36 @@ protected void masterOperation(Task task, final PutMappingRequest request, final\n                 listener.onFailure(maybeValidationException.get());\n                 return;\n             }\n-            PutMappingClusterStateUpdateRequest updateRequest = new PutMappingClusterStateUpdateRequest(request.source())\n-                .indices(concreteIndices)\n-                .ackTimeout(request.timeout()).masterNodeTimeout(request.masterNodeTimeout());\n-\n-            metadataMappingService.putMapping(updateRequest, new ActionListener<ClusterStateUpdateResponse>() {\n-\n-                @Override\n-                public void onResponse(ClusterStateUpdateResponse response) {\n-                    listener.onResponse(new AcknowledgedResponse(response.isAcknowledged()));\n-                }\n-\n-                @Override\n-                public void onFailure(Exception t) {\n-                    logger.debug(() -> new ParameterizedMessage(\"failed to put mappings on indices [{}]\",\n-                        Arrays.asList(concreteIndices)), t);\n-                    listener.onFailure(t);\n-                }\n-            });\n+            performMappingUpdate(concreteIndices, request, listener, metadataMappingService);\n         } catch (IndexNotFoundException ex) {\n             logger.debug(() -> new ParameterizedMessage(\"failed to put mappings on indices [{}]\",\n                 Arrays.asList(request.indices())), ex);\n             throw ex;\n         }\n     }\n \n+    static void performMappingUpdate(Index[] concreteIndices,", "originalCommit": "9b054d3bdfd5431d9cbac5c44d16b192c305b0a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3275eea6d2501c1ddd8410094cbdcd86eb371b94", "url": "https://github.com/elastic/elasticsearch/commit/3275eea6d2501c1ddd8410094cbdcd86eb371b94", "message": "Merge remote-tracking branch 'es/master' into auto_put_mapping_action", "committedDate": "2020-06-24T14:18:50Z", "type": "commit"}, {"oid": "74a32f915f37c0fc695f31b149ebb5764a34d9ab", "url": "https://github.com/elastic/elasticsearch/commit/74a32f915f37c0fc695f31b149ebb5764a34d9ab", "message": "Only use the new auto put mapping action if all nodes are on the version that supports it.", "committedDate": "2020-06-24T14:39:44Z", "type": "commit"}, {"oid": "35b345d2dab57b1583ee2f0b2139b52a27b7a0fb", "url": "https://github.com/elastic/elasticsearch/commit/35b345d2dab57b1583ee2f0b2139b52a27b7a0fb", "message": "added unit test", "committedDate": "2020-06-24T15:18:14Z", "type": "commit"}, {"oid": "4b281a3b22aefed7c42d3df5bcb2348715733c39", "url": "https://github.com/elastic/elasticsearch/commit/4b281a3b22aefed7c42d3df5bcb2348715733c39", "message": "Merge remote-tracking branch 'es/master' into auto_put_mapping_action", "committedDate": "2020-06-30T06:52:53Z", "type": "commit"}, {"oid": "ee0a01a50458557a3bb3207ee2ba6fcf44f16c9c", "url": "https://github.com/elastic/elasticsearch/commit/ee0a01a50458557a3bb3207ee2ba6fcf44f16c9c", "message": "Merge remote-tracking branch 'es/master' into auto_put_mapping_action", "committedDate": "2020-06-30T08:41:33Z", "type": "commit"}]}