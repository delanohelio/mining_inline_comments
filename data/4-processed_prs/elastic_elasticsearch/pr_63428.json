{"pr_number": 63428, "pr_title": "SQL: Escaped wildcard (*) not accepted in LIKE", "pr_createdAt": "2020-10-07T16:53:45Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63428", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3NjAxNg==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501176016", "bodyText": "@costin Did I miss anything, is there a reason to keep this check here?", "author": "palesz", "createdAt": "2020-10-07T17:10:35Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/parser/ExpressionBuilder.java", "diffHunk": "@@ -270,12 +270,6 @@ public LikePattern visitPattern(PatternContext ctx) {\n         if (pattern == null) {\n             throw new ParsingException(source(ctx.value), \"Pattern must not be [null]\");\n         }\n-        int pos = pattern.indexOf('*');\n-        if (pos >= 0) {\n-            throw new ParsingException(source(ctx.value),\n-                    \"Invalid char [*] found in pattern [{}] at position {}; use [%] or [_] instead\",\n-                    pattern, pos);\n-        }", "originalCommit": "50fc9d52097cab6ac8b55625fc8b8f387688de13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3NzI2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501177265", "bodyText": "To prevent folks from using * instead of %. Whether that's still a concern I don't know.", "author": "costin", "createdAt": "2020-10-07T17:12:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3NjAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5MDc2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501190762", "bodyText": "We don't have anything in the docs regarding the * and we list only the % and _\n* should be interpreted as a normal char for SQL:\npostgres=# create table mytable (str varchar(10));\nCREATE TABLE\n\npostgres=# insert into mytable values('*test*'), ('as*test*fd');\nINSERT 0 2\n\npostgres=# select * from mytable where str like ('%*test*%');\n    str\n------------\n *test*\n as*test*fd\n(2 rows)\n\npostgres=# select * from mytable where str like ('*test*');\n  str\n--------\n *test*\n(1 row)\n\nHow about adding a NOTE in the docs to explicitly specify that *, ? and the usual regex chars are interpreted as normal chars?", "author": "matriv", "createdAt": "2020-10-07T17:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3NjAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIwODIzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501208239", "bodyText": "AFAIK it is only the MS Access SQL flavour that treats * as a wildcard in a LIKE pattern, so SQL folks should be fairly used to * not being a wildcard. ES customers with less SQL knowledge might not. I think adding a NOTE to the docs does not hurt.", "author": "palesz", "createdAt": "2020-10-07T18:03:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3NjAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIxMTQxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501211411", "bodyText": "I am also thinking about removing the restriction on not being able to use * as an ESCAPE character from here. Do you see any good reason to keep that restriction?\nAs a user * would not be my first choice as an ESCAPE character, but the parser can handle it since * is just a normal character.", "author": "palesz", "createdAt": "2020-10-07T18:08:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3NjAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI4OTQ3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501289475", "bodyText": "On PostgreSQL, MySQL, SQLite any character can be used as ESCAPE (even wildchars) and any character can be escaped, not just wildcards. PostgreSQL treats the '%%' ESCAPE '%' as a non-wildcard % character (just as another escaped character), while MySQL and SQLite treat it as a wildcard (special escaping case). I assume it was intentional to behave differently and only allow escaping of the wildchars.", "author": "palesz", "createdAt": "2020-10-07T20:28:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3NjAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU4MjU4OA==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501582588", "bodyText": "As I see it, since only % and _ are wildcards for LIKE I would only allow escaping of those, but if we go on with this change it shouldn't be part of the bugfix that would be backported, but for next minor release since it's a minor \"breaking\" change.", "author": "matriv", "createdAt": "2020-10-08T09:37:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3NjAxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc3ODIzNA==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501778234", "bodyText": "Agree @matriv that allowing escaping any characters should be a separate PR and likely should be in the next minor release only, although technically it is less of a breaking change unless someone depends on the exceptions around escaping non-wildchars. Anyways, this is off topic for this PR.\nTo clarify: in this current PR I am only removing the special treatment of * and the restriction on using *as an ESCAPE character (wildchars are still not allowed as ESCAPE characters). Does this sound good to you?", "author": "palesz", "createdAt": "2020-10-08T14:43:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3NjAxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3Mzk4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501173981", "bodyText": "Please revert.", "author": "costin", "createdAt": "2020-10-07T17:07:11Z", "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/parser/LikeEscapingParsingTests.java", "diffHunk": "@@ -29,7 +29,7 @@ private String error(String pattern) {\n     }\n \n     private LikePattern like(String pattern) {\n-        Expression exp = null;\n+        Expression exp;", "originalCommit": "50fc9d52097cab6ac8b55625fc8b8f387688de13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3ODQ0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501178447", "bodyText": "Will do. I was wondering what is your convention.", "author": "palesz", "createdAt": "2020-10-07T17:14:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3Mzk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5MzMwMw==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501193303", "bodyText": "Generally speaking, I don't have a strong preference for explicitly initialising as null but some times it helps for readability. In this case we have a clear if/else statement that assigns a value, so imho is not so important.", "author": "matriv", "createdAt": "2020-10-07T17:38:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3Mzk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3NjAyMw==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501176023", "bodyText": "Should we maybe improve the error message by listing the wildcard chars for LIKE: % and _ ?", "author": "matriv", "createdAt": "2020-10-07T17:10:35Z", "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/parser/LikeEscapingParsingTests.java", "diffHunk": "@@ -63,8 +63,15 @@ public void testInvalidChar() {\n                 is(\"line 1:28: Char [%] cannot be used for escaping\"));\n     }\n \n-    public void testCannotUseStar() {\n+    public void testCanUseStarWithoutEscaping() {\n+        LikePattern like = like(\"%string*\");\n+        assertThat(like.pattern(), is(\"%string*\"));\n+        assertThat(like.asJavaRegex(), is(\"^.*string\\\\*$\"));\n+        assertThat(like.asLuceneWildcard(), is(\"*string\\\\*\"));\n+    }\n+\n+    public void testCannotUseStarWithEscaping() {\n         assertThat(error(\"'|*string' ESCAPE '|'\"),\n-                is(\"line 1:11: Invalid char [*] found in pattern [|*string] at position 1; use [%] or [_] instead\"));\n+            is(\"line 1:11: Pattern [|*string] is invalid as escape char [|] at position 0 can only escape wildcard chars; found [*]\"));", "originalCommit": "50fc9d52097cab6ac8b55625fc8b8f387688de13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5OTY2MA==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501199660", "bodyText": "Looks good, Maybe add one more test with a more complicated string, something like:\n*%*_string*_**%. Left one more comment about the error message.\n\nWill add a new test case, but I will add it to the LikeConversionTests, since I think that has less to do with ESCAPEing.", "author": "palesz", "createdAt": "2020-10-07T17:49:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3NjAyMw=="}], "type": "inlineReview"}, {"oid": "c368506f911d36da392142be06ca289cf9b4a8ce", "url": "https://github.com/elastic/elasticsearch/commit/c368506f911d36da392142be06ca289cf9b4a8ce", "message": "SQL: Escaped wildcard (*) not accepted in LIKE\n\nFor a query like `SELECT name FROM test WHERE name LIKE ''%c*'` ES SQL\ngenerates an error. `*` is not a special character in a `LIKE` construct\nand it's expected to not needing to be escaped, so the previous query\nshould work as is.\nIn the LIKE pattern any `*` character was treated as invalid character\nand the usage of `%` or `_` was suggested instead. But `*` is a valid,\nacceptable non-wildcard on the right side of the `LIKE` operator.\n\nFix: #55108", "committedDate": "2020-10-07T20:51:08Z", "type": "commit"}, {"oid": "c368506f911d36da392142be06ca289cf9b4a8ce", "url": "https://github.com/elastic/elasticsearch/commit/c368506f911d36da392142be06ca289cf9b4a8ce", "message": "SQL: Escaped wildcard (*) not accepted in LIKE\n\nFor a query like `SELECT name FROM test WHERE name LIKE ''%c*'` ES SQL\ngenerates an error. `*` is not a special character in a `LIKE` construct\nand it's expected to not needing to be escaped, so the previous query\nshould work as is.\nIn the LIKE pattern any `*` character was treated as invalid character\nand the usage of `%` or `_` was suggested instead. But `*` is a valid,\nacceptable non-wildcard on the right side of the `LIKE` operator.\n\nFix: #55108", "committedDate": "2020-10-07T20:51:08Z", "type": "forcePushed"}, {"oid": "5c97c9d4259fb263e1278605f068e6d6943a962c", "url": "https://github.com/elastic/elasticsearch/commit/5c97c9d4259fb263e1278605f068e6d6943a962c", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/55108", "committedDate": "2020-10-07T21:06:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU4MDQzMg==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501580432", "bodyText": "Personally I'd add it as a [NOTE] below the existing sentence, so that it stands out.", "author": "matriv", "createdAt": "2020-10-08T09:33:46Z", "path": "docs/reference/sql/functions/like-rlike.asciidoc", "diffHunk": "@@ -33,8 +33,8 @@ with the `LIKE` operator:\n * The percent sign (%)\n * The underscore (_)\n \n-The percent sign represents zero, one or multiple characters. The underscore represents a single number or character. These symbols can be\n-used in combinations.\n+No other characters have special meaning or act as wildcard. The percent sign represents zero, one or multiple characters.", "originalCommit": "5c97c9d4259fb263e1278605f068e6d6943a962c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYwNzc4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501607782", "bodyText": "nit: It might be worth providing first the explanation of the above chars, then add a clarification; i.e. reposition the first sentence at the end.", "author": "bpintea", "createdAt": "2020-10-08T10:17:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU4MDQzMg=="}], "type": "inlineReview"}, {"oid": "f089b47203bb2388b46ec634d8a75e56deab903a", "url": "https://github.com/elastic/elasticsearch/commit/f089b47203bb2388b46ec634d8a75e56deab903a", "message": "Merge remote-tracking branch 'origin/master' into fix/55108", "committedDate": "2020-10-08T15:58:26Z", "type": "commit"}, {"oid": "5e6bc1cbd29fa2fff695e287f29eb0b780a32422", "url": "https://github.com/elastic/elasticsearch/commit/5e6bc1cbd29fa2fff695e287f29eb0b780a32422", "message": "Documentation changes for SQL `LIKE` as per PR\n\nAdded a NOTE explaining that only `%` and `_` treated as wildcards\nand other characters (even `*` or `?`) are just treated as normal\ncharacters in the `LIKE` pattern.", "committedDate": "2020-10-08T16:12:00Z", "type": "commit"}, {"oid": "ff5ee1890ab2d794050c99d22f983c96685d6de0", "url": "https://github.com/elastic/elasticsearch/commit/ff5ee1890ab2d794050c99d22f983c96685d6de0", "message": "Fixed the checkstyle errors", "committedDate": "2020-10-08T16:21:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk1ODYzNA==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r503958634", "bodyText": "On the same idea (which I like) of actually mentioning the wildcard chars in the error message itself (for the lazy user who doesn't read the docs and asking \"why % char cannot be used for escaping?\"), what about adapting this error message to include the reason? Something like Char [%] cannot be used for escaping as it's one of the wildcard chars [%_].", "author": "astefan", "createdAt": "2020-10-13T13:38:04Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/parser/ExpressionBuilder.java", "diffHunk": "@@ -288,7 +282,7 @@ public LikePattern visitPattern(PatternContext ctx) {\n             } else if (escapeString.length() == 1) {\n                 escape = escapeString.charAt(0);\n                 // these chars already have a meaning\n-                if (escape == '*' || escape == '%' || escape == '_') {\n+                if (escape == '%' || escape == '_') {\n                     throw new ParsingException(source(escapeCtx.escape), \"Char [{}] cannot be used for escaping\", escape);", "originalCommit": "ff5ee1890ab2d794050c99d22f983c96685d6de0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk2ODU3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r503968577", "bodyText": "Thanks, good suggestion. I'll add this cosmetic fix.", "author": "palesz", "createdAt": "2020-10-13T13:50:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk1ODYzNA=="}], "type": "inlineReview"}]}