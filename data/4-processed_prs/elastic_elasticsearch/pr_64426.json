{"pr_number": 64426, "pr_title": "[DOCS] Updating doc level security limitations", "pr_createdAt": "2020-10-30T16:17:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64426", "timeline": [{"oid": "ffeb95f390608494037955c5acf47f04655e3783", "url": "https://github.com/elastic/elasticsearch/commit/ffeb95f390608494037955c5acf47f04655e3783", "message": "Updating doc level security limitations.", "committedDate": "2020-10-30T16:15:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY5Mjk0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r515692941", "bodyText": "It accepts both string and nested JSON, e.g. following synatx also works:\nPOST _security/role/click_role\n{\n  \"indices\": [\n    {\n      \"names\": [\n        \"events-*\"\n      ],\n      \"privileges\": [\n        \"read\"\n      ],\n      \"query\": {\n        \"match\": {\n          \"category\": \"click\"\n        }\n      }\n    }\n  ]\n}\nThe second example of this page shows an example of using nested JSON format as well.", "author": "ywangd", "createdAt": "2020-11-02T00:16:40Z", "path": "x-pack/docs/en/security/authorization/document-level-security.asciidoc", "diffHunk": "@@ -3,14 +3,24 @@\n === Document level security\n \n Document level security restricts the documents that users have read access to.\n-In particular, it restricts which documents can be accessed from document-based \n-read APIs. \n+In particular, it restricts which documents can be accessed from document-based\n+read APIs.\n \n To enable document level security, you use a query to specify the documents that\n-each role can access. The document query is associated with a particular data\n+each role can access. The document `query` is associated with a particular data\n stream, index, or wildcard (`*`) pattern and operates in conjunction with the\n privileges specified for the data streams and indices.\n \n+The specified `query`:\n+\n+* Expects the same format as if it was defined in the search request\n+* Accepts queries written as string values", "originalCommit": "ffeb95f390608494037955c5acf47f04655e3783", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA1NTYyNA==", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r516055624", "bodyText": "I'll change that bullet to read:\n\nAccepts queries written as either string values or nested JSON\n\nI'll also add your example to show users the string and JSON examples in tandem.", "author": "lockewritesdocs", "createdAt": "2020-11-02T15:34:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY5Mjk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY5MzI0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r515693245", "bodyText": "This is mostly true except it can also use a templated query. However this feature is not documented on this page, but on the other page of \"Setting up field and document level security\". It is cross-linked at the end of this page.", "author": "ywangd", "createdAt": "2020-11-02T00:19:22Z", "path": "x-pack/docs/en/security/authorization/document-level-security.asciidoc", "diffHunk": "@@ -3,14 +3,24 @@\n === Document level security\n \n Document level security restricts the documents that users have read access to.\n-In particular, it restricts which documents can be accessed from document-based \n-read APIs. \n+In particular, it restricts which documents can be accessed from document-based\n+read APIs.\n \n To enable document level security, you use a query to specify the documents that\n-each role can access. The document query is associated with a particular data\n+each role can access. The document `query` is associated with a particular data\n stream, index, or wildcard (`*`) pattern and operates in conjunction with the\n privileges specified for the data streams and indices.\n \n+The specified `query`:\n+\n+* Expects the same format as if it was defined in the search request", "originalCommit": "ffeb95f390608494037955c5acf47f04655e3783", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA2NjMyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r516066329", "bodyText": "\ud83d\udc4d I'll add a separate bullet with a link to the templating section of that page.", "author": "lockewritesdocs", "createdAt": "2020-11-02T15:49:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY5MzI0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY5MzUxMg==", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r515693512", "bodyText": "\ud83d\udc4d I think we can also cross link to Field Level Security in the previous paragraph.", "author": "ywangd", "createdAt": "2020-11-02T00:21:24Z", "path": "x-pack/docs/en/security/limitations.asciidoc", "diffHunk": "@@ -51,7 +52,7 @@ When a user's role enables document or field level security for a data stream or\n ** Update requests included in bulk requests aren't supported.\n * The request cache is disabled for search requests.\n \n-When a user's role enables document level security for a data stream or index:\n+When a user's role enables <<document-level-security,document level security>> for a data stream or index:", "originalCommit": "ffeb95f390608494037955c5acf47f04655e3783", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY5NDQ4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r515694486", "bodyText": "Date math does not make remote calls. So it should not be nested under the title of \"query that makes remote calls\". Also I don't think we have an official name of \"date_math_expr range query\". The relevant doc page describes it as \"using the range query with date fields. So maybe we could say something like:\nDate math expressions cannot contain now in range query with date fields.", "author": "ywangd", "createdAt": "2020-11-02T00:29:44Z", "path": "x-pack/docs/en/security/limitations.asciidoc", "diffHunk": "@@ -62,11 +63,12 @@ When a user's role enables document level security for a data stream or index:\n * The `has_child` and `has_parent` queries aren't supported as query in the\n   role definition. The `has_child` and `has_parent` queries can be used in the\n   search API with document level security enabled.\n-* Any query that makes remote calls to fetch data to query by isn't supported.\n-  The following queries aren't supported:\n-** The `terms` query with terms lookup isn't supported.\n-** The `geo_shape` query with indexed shapes isn't supported.\n-** The `percolate` query isn't supported.\n+* Any query that makes remote calls to fetch query data isn't supported,\n+including the following queries:\n+** `terms` query with terms lookup\n+** `geo_shape` query with indexed shapes\n+** `percolate` query\n+** `date_math_expr` range query that includes `now`", "originalCommit": "ffeb95f390608494037955c5acf47f04655e3783", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEzNTMxNw==", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r516135317", "bodyText": "@ywangd, the field stats API was deprecated in 5.4.0. Should we instead list the field capabilities API as an example?", "author": "lockewritesdocs", "createdAt": "2020-11-02T17:23:45Z", "path": "x-pack/docs/en/security/limitations.asciidoc", "diffHunk": "@@ -51,7 +52,7 @@ When a user's role enables document or field level security for a data stream or\n ** Update requests included in bulk requests aren't supported.\n * The request cache is disabled for search requests.\n \n-When a user's role enables document level security for a data stream or index:\n+When a user's role enables <<document-level-security,document level security>> for a data stream or index:\n \n * Document level security isn't applied for APIs that aren't document based.\n   An example is the field stats API.", "originalCommit": "ffeb95f390608494037955c5acf47f04655e3783", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYyOTIwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r516629205", "bodyText": "This is a good catch. I am actually not entirely sure what this statement means. If it means field stats API does not respect document level security (DLS) and could leak field information, I don't know whether we still have another example similar to this. For example, the field capabilities API does respect DLS. Given DLS/FLS is implemented at a level close to Lucene, I doubt we have another example similar to the now-removed field stats API (if there is, it should be a bug). So I think we might want to remove this sentence. @tvernum Could you please comment on this in case I am missing something? Thanks!", "author": "ywangd", "createdAt": "2020-11-03T12:26:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEzNTMxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc3NDAyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r516774029", "bodyText": "Agreed @ywangd that this statement seems outdated and should probably be removed. Will wait for @tvernum to respond.", "author": "lockewritesdocs", "createdAt": "2020-11-03T15:56:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEzNTMxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU2MDUxMw==", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r517560513", "bodyText": "I removed the statement referencing the stats API. It just didn't seem to make sense anymore since it was deprecated, and we don't seem to have another API that doesn't respect DSL.", "author": "lockewritesdocs", "createdAt": "2020-11-04T18:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEzNTMxNw=="}], "type": "inlineReview"}, {"oid": "159acfa7c6afaf545668b4902d6a6a010bc7d58d", "url": "https://github.com/elastic/elasticsearch/commit/159acfa7c6afaf545668b4902d6a6a010bc7d58d", "message": "Incorporating review feedback.", "committedDate": "2020-11-02T17:37:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYzMTE2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r516631166", "bodyText": "Nit: Sorry I know this snippet is copied from my previous comment, but I think it would look better and easier to spot the difference if we keep this part consistent to the previous example, i.e.:\n      ...\n      \"names\": [ \"events-* ],\n      \"privileges\": [ \"read\" ],\n      ...\nThe content of the query field looks fine as it signifies the nested structure.", "author": "ywangd", "createdAt": "2020-11-03T12:30:24Z", "path": "x-pack/docs/en/security/authorization/document-level-security.asciidoc", "diffHunk": "@@ -26,19 +37,37 @@ POST /_security/role/click_role\n     }\n   ]\n }\n---------------------------------------------------\n+----\n \n-NOTE: Omitting the `query` entry entirely disables document level security for\n-      the respective indices permission entry.\n+You can write this same query using nested JSON syntax:\n \n-The specified `query` expects the same format as if it was defined in the\n-search request and supports the full {es} <<query-dsl,query DSL>>.\n+[source,console]\n+----\n+POST _security/role/click_role\n+{\n+  \"indices\": [\n+    {\n+      \"names\": [\n+        \"events-*\"\n+      ],\n+      \"privileges\": [\n+        \"read\"\n+      ],", "originalCommit": "159acfa7c6afaf545668b4902d6a6a010bc7d58d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYzNTU4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r516635587", "bodyText": "We could talk about the actual info that can be accessed instead of just giving out a variable name, something like:\n* Supports <<templating-role-query,templating>> that can access the details of the current authenticated user", "author": "ywangd", "createdAt": "2020-11-03T12:38:28Z", "path": "x-pack/docs/en/security/authorization/document-level-security.asciidoc", "diffHunk": "@@ -3,19 +3,30 @@\n === Document level security\n \n Document level security restricts the documents that users have read access to.\n-In particular, it restricts which documents can be accessed from document-based \n-read APIs. \n+In particular, it restricts which documents can be accessed from document-based\n+read APIs.\n \n To enable document level security, you use a query to specify the documents that\n-each role can access. The document query is associated with a particular data\n+each role can access. The document `query` is associated with a particular data\n stream, index, or wildcard (`*`) pattern and operates in conjunction with the\n privileges specified for the data streams and indices.\n \n+The specified document `query`:\n+\n+* Expects the same format as if it was defined in the search request\n+* Supports <<templating-role-query,templating>> for `_user` variables", "originalCommit": "159acfa7c6afaf545668b4902d6a6a010bc7d58d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8348f9c034c9c83826f708741ad70fbbec124642", "url": "https://github.com/elastic/elasticsearch/commit/8348f9c034c9c83826f708741ad70fbbec124642", "message": "Changes from review feedback.", "committedDate": "2020-11-03T17:17:44Z", "type": "commit"}, {"oid": "d9523f43eaf63029821eb847dc38f3759b706e85", "url": "https://github.com/elastic/elasticsearch/commit/d9523f43eaf63029821eb847dc38f3759b706e85", "message": "Merge branch 'master' into docs__update-doc-level-security", "committedDate": "2020-11-04T15:57:45Z", "type": "commit"}, {"oid": "9edf0403de1f006f67aaf3148277375d9c5aec8e", "url": "https://github.com/elastic/elasticsearch/commit/9edf0403de1f006f67aaf3148277375d9c5aec8e", "message": "Remove statement about the stats API.", "committedDate": "2020-11-04T18:50:21Z", "type": "commit"}, {"oid": "0782370a13d5f31f8e29e7dbde93038f6c6c29e3", "url": "https://github.com/elastic/elasticsearch/commit/0782370a13d5f31f8e29e7dbde93038f6c6c29e3", "message": "Merge branch 'docs__update-doc-level-security' of github.com:lockewritesdocs/elasticsearch into docs__update-doc-level-security", "committedDate": "2020-11-04T18:50:50Z", "type": "commit"}]}