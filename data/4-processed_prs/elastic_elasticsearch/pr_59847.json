{"pr_number": 59847, "pr_title": "Make MetadataFieldMapper extend ParametrizedFieldMapper", "pr_createdAt": "2020-07-20T08:47:44Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59847", "timeline": [{"oid": "0e6c8697def5e2f365b28dcb2d75161fd85cf15e", "url": "https://github.com/elastic/elasticsearch/commit/0e6c8697def5e2f365b28dcb2d75161fd85cf15e", "message": "Make MetadataFieldMapper extend ParametrizedFieldMapper", "committedDate": "2020-07-17T14:23:05Z", "type": "commit"}, {"oid": "db400c18d228352eec21c32877d281595e3f122a", "url": "https://github.com/elastic/elasticsearch/commit/db400c18d228352eec21c32877d281595e3f122a", "message": "Merge remote-tracking branch 'origin/master' into mapper/metadata-params", "committedDate": "2020-07-20T08:33:22Z", "type": "commit"}, {"oid": "7c72af8d88bb9476a319f24ca16af0bf6aa45c56", "url": "https://github.com/elastic/elasticsearch/commit/7c72af8d88bb9476a319f24ca16af0bf6aa45c56", "message": "Merge remote-tracking branch 'origin/master' into mapper/metadata-params", "committedDate": "2020-07-20T08:35:17Z", "type": "commit"}, {"oid": "399e48c0a78698d93bed9d66332e36815f63dea3", "url": "https://github.com/elastic/elasticsearch/commit/399e48c0a78698d93bed9d66332e36815f63dea3", "message": "precommit", "committedDate": "2020-07-20T09:00:54Z", "type": "commit"}, {"oid": "f1c12dd661aabd3df4a261549db9bbfea16364a8", "url": "https://github.com/elastic/elasticsearch/commit/f1c12dd661aabd3df4a261549db9bbfea16364a8", "message": "tests", "committedDate": "2020-07-20T09:56:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM0NjcyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/59847#discussion_r457346729", "bodyText": "this seems unrelated?", "author": "javanna", "createdAt": "2020-07-20T12:41:56Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java", "diffHunk": "@@ -138,7 +138,7 @@ private static CompletionFieldMapper toType(FieldMapper in) {\n                 b.startArray(n);\n                 c.toXContent(b, ToXContent.EMPTY_PARAMS);\n                 b.endArray();\n-            });\n+            }, ContextMappings::toString);", "originalCommit": "f1c12dd661aabd3df4a261549db9bbfea16364a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAxNzQ5MA==", "url": "https://github.com/elastic/elasticsearch/pull/59847#discussion_r458017490", "bodyText": "It's a change in the signature of setSerializer - we need to serialize things to string as well, for conflict reporting.  I should add some specific tests to ParametrizedMapperTests for this as well though.", "author": "romseygeek", "createdAt": "2020-07-21T11:10:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM0NjcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU5MzEzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/59847#discussion_r465593139", "bodyText": "I've added a specific test here", "author": "romseygeek", "createdAt": "2020-08-05T09:24:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM0NjcyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM0Nzk5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/59847#discussion_r457347992", "bodyText": "seems like EnabledAttributeMapper is no longer needed, we may be able to remove the class also.", "author": "javanna", "createdAt": "2020-07-20T12:43:30Z", "path": "plugins/mapper-size/src/main/java/org/elasticsearch/index/mapper/size/SizeFieldMapper.java", "diffHunk": "@@ -19,88 +19,71 @@\n \n package org.elasticsearch.index.mapper.size;\n \n-import org.apache.lucene.document.FieldType;\n-import org.elasticsearch.common.xcontent.XContentBuilder;\n-import org.elasticsearch.common.xcontent.support.XContentMapValues;\n-import org.elasticsearch.index.mapper.EnabledAttributeMapper;\n import org.elasticsearch.index.mapper.FieldMapper;\n import org.elasticsearch.index.mapper.MappedFieldType;\n import org.elasticsearch.index.mapper.MapperParsingException;\n import org.elasticsearch.index.mapper.MetadataFieldMapper;\n import org.elasticsearch.index.mapper.NumberFieldMapper;\n+import org.elasticsearch.index.mapper.ParametrizedFieldMapper;\n import org.elasticsearch.index.mapper.ParseContext;\n \n import java.io.IOException;\n-import java.util.Iterator;\n import java.util.List;\n import java.util.Map;\n \n public class SizeFieldMapper extends MetadataFieldMapper {\n     public static final String NAME = \"_size\";\n \n     public static class Defaults  {\n-        public static final EnabledAttributeMapper ENABLED_STATE = EnabledAttributeMapper.UNSET_DISABLED;\n-\n-        public static final FieldType SIZE_FIELD_TYPE = new FieldType();\n+        public static final boolean ENABLED = false;\n+    }\n \n-        static {\n-            SIZE_FIELD_TYPE.setStored(true);\n-            SIZE_FIELD_TYPE.freeze();\n-        }\n+    private static SizeFieldMapper toType(FieldMapper in) {\n+        return (SizeFieldMapper) in;\n     }\n \n-    public static class Builder extends MetadataFieldMapper.Builder<Builder> {\n+    public static class Builder extends MetadataFieldMapper.Builder {\n \n-        protected EnabledAttributeMapper enabledState = EnabledAttributeMapper.UNSET_DISABLED;\n+        // TODO should this really be updateable?\n+        private final Parameter<Boolean> enabled = Parameter.boolParam(\"enabled\", true, m -> toType(m).enabled(), false);\n \n         private Builder() {\n-            super(NAME, Defaults.SIZE_FIELD_TYPE);\n-            builder = this;\n+            super(NAME);\n         }\n \n-        public Builder enabled(EnabledAttributeMapper enabled) {\n-            this.enabledState = enabled;\n-            return builder;\n+        @Override\n+        protected List<Parameter<?>> getParameters() {\n+            return List.of(enabled);\n         }\n \n         @Override\n         public SizeFieldMapper build(BuilderContext context) {\n-            return new SizeFieldMapper(fieldType, enabledState,\n+            return new SizeFieldMapper(enabled.getValue(),\n                 new NumberFieldMapper.NumberFieldType(NAME, NumberFieldMapper.NumberType.INTEGER));\n         }\n     }\n \n     public static class TypeParser implements MetadataFieldMapper.TypeParser {\n         @Override\n-        public MetadataFieldMapper.Builder<?> parse(String name, Map<String, Object> node,\n+        public MetadataFieldMapper.Builder parse(String name, Map<String, Object> node,\n                                                        ParserContext parserContext) throws MapperParsingException {\n             Builder builder = new Builder();\n-            for (Iterator<Map.Entry<String, Object>> iterator = node.entrySet().iterator(); iterator.hasNext();) {\n-                Map.Entry<String, Object> entry = iterator.next();\n-                String fieldName = entry.getKey();\n-                Object fieldNode = entry.getValue();\n-                if (fieldName.equals(\"enabled\")) {\n-                    boolean enabled = XContentMapValues.nodeBooleanValue(fieldNode, name + \".enabled\");\n-                    builder.enabled(enabled ? EnabledAttributeMapper.ENABLED : EnabledAttributeMapper.DISABLED);\n-                    iterator.remove();\n-                }\n-            }\n+            builder.parse(name, parserContext, node);\n             return builder;\n         }\n \n         @Override\n         public MetadataFieldMapper getDefault(ParserContext context) {\n-            return new SizeFieldMapper(Defaults.SIZE_FIELD_TYPE, Defaults.ENABLED_STATE,\n+            return new SizeFieldMapper(Defaults.ENABLED,\n                 new NumberFieldMapper.NumberFieldType(NAME, NumberFieldMapper.NumberType.INTEGER));\n         }\n     }\n \n-    private EnabledAttributeMapper enabledState;", "originalCommit": "f1c12dd661aabd3df4a261549db9bbfea16364a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ4MDU5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/59847#discussion_r457480592", "bodyText": "\ud83d\udc4d", "author": "nik9000", "createdAt": "2020-07-20T15:13:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM0Nzk5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ3ODUyNg==", "url": "https://github.com/elastic/elasticsearch/pull/59847#discussion_r457478526", "bodyText": "Do we need the Defaults object at all any more?", "author": "nik9000", "createdAt": "2020-07-20T15:11:50Z", "path": "plugins/mapper-size/src/main/java/org/elasticsearch/index/mapper/size/SizeFieldMapper.java", "diffHunk": "@@ -19,88 +19,71 @@\n \n package org.elasticsearch.index.mapper.size;\n \n-import org.apache.lucene.document.FieldType;\n-import org.elasticsearch.common.xcontent.XContentBuilder;\n-import org.elasticsearch.common.xcontent.support.XContentMapValues;\n-import org.elasticsearch.index.mapper.EnabledAttributeMapper;\n import org.elasticsearch.index.mapper.FieldMapper;\n import org.elasticsearch.index.mapper.MappedFieldType;\n import org.elasticsearch.index.mapper.MapperParsingException;\n import org.elasticsearch.index.mapper.MetadataFieldMapper;\n import org.elasticsearch.index.mapper.NumberFieldMapper;\n+import org.elasticsearch.index.mapper.ParametrizedFieldMapper;\n import org.elasticsearch.index.mapper.ParseContext;\n \n import java.io.IOException;\n-import java.util.Iterator;\n import java.util.List;\n import java.util.Map;\n \n public class SizeFieldMapper extends MetadataFieldMapper {\n     public static final String NAME = \"_size\";\n \n     public static class Defaults  {\n-        public static final EnabledAttributeMapper ENABLED_STATE = EnabledAttributeMapper.UNSET_DISABLED;\n-\n-        public static final FieldType SIZE_FIELD_TYPE = new FieldType();\n+        public static final boolean ENABLED = false;", "originalCommit": "f1c12dd661aabd3df4a261549db9bbfea16364a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ4MDk4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59847#discussion_r457480986", "bodyText": "\ud83d\udc4d", "author": "nik9000", "createdAt": "2020-07-20T15:14:14Z", "path": "plugins/mapper-size/src/main/java/org/elasticsearch/index/mapper/size/SizeFieldMapper.java", "diffHunk": "@@ -129,37 +112,15 @@ public void parse(ParseContext context) {\n \n     @Override\n     protected void parseCreateField(ParseContext context) {\n-        if (!enabledState.enabled) {\n+        if (enabled == false) {", "originalCommit": "f1c12dd661aabd3df4a261549db9bbfea16364a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ4NzU5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59847#discussion_r457487595", "bodyText": "I wonder if ever allowed disabling indexing the id! Oh well, \ud83d\udc4d", "author": "nik9000", "createdAt": "2020-07-20T15:20:51Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/IdFieldMapper.java", "diffHunk": "@@ -277,19 +263,13 @@ public void preParse(ParseContext context) throws IOException {\n \n     @Override\n     protected void parseCreateField(ParseContext context) throws IOException {\n-        if (fieldType.indexOptions() != IndexOptions.NONE || fieldType.stored()) {\n-            BytesRef id = Uid.encodeId(context.sourceToParse().id());\n-            context.doc().add(new Field(NAME, id, fieldType));\n-        }\n+        BytesRef id = Uid.encodeId(context.sourceToParse().id());", "originalCommit": "f1c12dd661aabd3df4a261549db9bbfea16364a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ4OTgxNg==", "url": "https://github.com/elastic/elasticsearch/pull/59847#discussion_r457489816", "bodyText": "Can add javadoc?", "author": "nik9000", "createdAt": "2020-07-20T15:23:11Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MetadataFieldMapper.java", "diffHunk": "@@ -45,25 +45,63 @@\n         MetadataFieldMapper getDefault(ParserContext parserContext);\n     }\n \n-    @SuppressWarnings(\"rawtypes\")\n-    public abstract static class Builder<T extends Builder<T>> extends FieldMapper.Builder<T> {\n-        public Builder(String name, FieldType fieldType) {\n-            super(name, fieldType);\n+    public static class FixedTypeParser implements TypeParser {", "originalCommit": "f1c12dd661aabd3df4a261549db9bbfea16364a8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f7e04ff5cdda5daa42ab81a9fc48055b8949c730", "url": "https://github.com/elastic/elasticsearch/commit/f7e04ff5cdda5daa42ab81a9fc48055b8949c730", "message": "Merge remote-tracking branch 'origin/master' into mapper/metadata-params", "committedDate": "2020-07-20T16:28:32Z", "type": "commit"}, {"oid": "11388ca6f1fa64b05bfdfd6f01bca1f8030afa08", "url": "https://github.com/elastic/elasticsearch/commit/11388ca6f1fa64b05bfdfd6f01bca1f8030afa08", "message": "sizemapper enabled param needs to use Explicit; feedback", "committedDate": "2020-07-21T11:09:20Z", "type": "commit"}, {"oid": "7a94e565888174226a6d3e7511977f943929bdc1", "url": "https://github.com/elastic/elasticsearch/commit/7a94e565888174226a6d3e7511977f943929bdc1", "message": "ConfigurableTypeParser; Explicit needs equals/hashcode", "committedDate": "2020-07-21T13:14:21Z", "type": "commit"}, {"oid": "e1eae9227e0c0ab06ce4836e272518a48d3ae04c", "url": "https://github.com/elastic/elasticsearch/commit/e1eae9227e0c0ab06ce4836e272518a48d3ae04c", "message": "Merge remote-tracking branch 'origin/master' into mapper/metadata-params", "committedDate": "2020-07-21T13:17:28Z", "type": "commit"}, {"oid": "efe31fa9c0df94d0b97fc0d077a0421baad24da7", "url": "https://github.com/elastic/elasticsearch/commit/efe31fa9c0df94d0b97fc0d077a0421baad24da7", "message": "spotless", "committedDate": "2020-07-21T13:21:09Z", "type": "commit"}, {"oid": "7b23820dcbbbea0611119a9f35b26edc35a5b589", "url": "https://github.com/elastic/elasticsearch/commit/7b23820dcbbbea0611119a9f35b26edc35a5b589", "message": "imports", "committedDate": "2020-07-21T13:23:08Z", "type": "commit"}, {"oid": "4747d0075b57d76f195bbd0667f3d1238bd9e90e", "url": "https://github.com/elastic/elasticsearch/commit/4747d0075b57d76f195bbd0667f3d1238bd9e90e", "message": "Merge remote-tracking branch 'origin/master' into mapper/metadata-params", "committedDate": "2020-08-03T07:47:33Z", "type": "commit"}, {"oid": "046717d784c0098c121a36989e1cc4d1534ed116", "url": "https://github.com/elastic/elasticsearch/commit/046717d784c0098c121a36989e1cc4d1534ed116", "message": "Merge remote-tracking branch 'origin/master' into mapper/metadata-params", "committedDate": "2020-08-05T08:55:17Z", "type": "commit"}, {"oid": "a7ab5c2633537234921b2a23b10221f37b989452", "url": "https://github.com/elastic/elasticsearch/commit/a7ab5c2633537234921b2a23b10221f37b989452", "message": "add specific tests for conflict serialization", "committedDate": "2020-08-05T09:23:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM5MDUzNw==", "url": "https://github.com/elastic/elasticsearch/pull/59847#discussion_r464390537", "bodyText": "I think you only override this here to make it final, right? Do you need this method definition at all now?", "author": "nik9000", "createdAt": "2020-08-03T12:47:33Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/ParametrizedFieldMapper.java", "diffHunk": "@@ -105,7 +108,7 @@ protected final void mergeOptions(FieldMapper other, List<String> conflicts) {\n     }\n \n     @Override\n-    public final XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n+    public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {", "originalCommit": "4747d0075b57d76f195bbd0667f3d1238bd9e90e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI0MjU5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/59847#discussion_r466242592", "bodyText": "++, it's gone now", "author": "romseygeek", "createdAt": "2020-08-06T08:42:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM5MDUzNw=="}], "type": "inlineReview"}, {"oid": "79e6dce3af23f45fee6e5e0651c9fd1b1462c77e", "url": "https://github.com/elastic/elasticsearch/commit/79e6dce3af23f45fee6e5e0651c9fd1b1462c77e", "message": "remove unused method", "committedDate": "2020-08-06T08:41:28Z", "type": "commit"}, {"oid": "ad1e2a1cb07120a3ba6b8b96f58c4eb4318a6c41", "url": "https://github.com/elastic/elasticsearch/commit/ad1e2a1cb07120a3ba6b8b96f58c4eb4318a6c41", "message": "Merge remote-tracking branch 'origin/master' into mapper/metadata-params", "committedDate": "2020-08-06T08:41:52Z", "type": "commit"}, {"oid": "87a57c80f7e58b298ccc5e49953c547f6fe913d4", "url": "https://github.com/elastic/elasticsearch/commit/87a57c80f7e58b298ccc5e49953c547f6fe913d4", "message": "Merge remote-tracking branch 'origin/master' into mapper/metadata-params", "committedDate": "2020-08-10T11:31:20Z", "type": "commit"}]}