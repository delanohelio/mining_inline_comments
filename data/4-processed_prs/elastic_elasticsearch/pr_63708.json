{"pr_number": 63708, "pr_title": "Add new audit handler method for action responses", "pr_createdAt": "2020-10-14T22:26:40Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63708", "timeline": [{"oid": "c710726a9e15e51a3525a52e5c01f8d7891183c9", "url": "https://github.com/elastic/elasticsearch/commit/c710726a9e15e51a3525a52e5c01f8d7891183c9", "message": "Remove redundant IOException", "committedDate": "2020-10-14T10:41:23Z", "type": "commit"}, {"oid": "e9f2866f26767e9a520a6a3af4dc922d92b497bc", "url": "https://github.com/elastic/elasticsearch/commit/e9f2866f26767e9a520a6a3af4dc922d92b497bc", "message": "Merge branch 'master' into post_authz_audit_event", "committedDate": "2020-10-14T11:45:37Z", "type": "commit"}, {"oid": "48d647eee633e193a6f2059dbee18188606039f4", "url": "https://github.com/elastic/elasticsearch/commit/48d647eee633e193a6f2059dbee18188606039f4", "message": "WIP", "committedDate": "2020-10-14T22:20:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI1NzU5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r505257593", "bodyText": "the new audit method.", "author": "albertzaharovits", "createdAt": "2020-10-15T07:23:03Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/AuditTrail.java", "diffHunk": "@@ -47,6 +48,10 @@ void accessGranted(String requestId, Authentication authentication, String actio\n     void accessDenied(String requestId, Authentication authentication, String action, TransportRequest transportRequest,\n                       AuthorizationInfo authorizationInfo);\n \n+    // this is the only audit method that is called *after* the action executed, when the response is available\n+    void actionResponse(String requestId, Authentication authentication, String action, TransportRequest transportRequest,\n+                        TransportResponse transportResponse);", "originalCommit": "48d647eee633e193a6f2059dbee18188606039f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMzODI0MA==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r505338240", "bodyText": "This intercepts the response for the action that is executed inside the rest handler (that do NOT go to other cluster nodes).", "author": "albertzaharovits", "createdAt": "2020-10-15T08:31:08Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java", "diffHunk": "@@ -83,25 +86,24 @@ public SecurityActionFilter(AuthenticationService authcService, AuthorizationSer\n         if (licenseState.isSecurityEnabled()) {\n             final ActionListener<Response> contextPreservingListener =\n                     ContextPreservingActionListener.wrapPreservingContext(listener, threadContext);\n+            final ActionListener<Response> postActionExecutionListener = ActionListener.delegateFailure(contextPreservingListener,\n+                    (ignore, response) -> {\n+                        String requestId = AuditUtil.extractRequestId(threadContext);\n+                        Authentication authentication = securityContext.getAuthentication();\n+                        auditTrailService.get().actionResponse(requestId, authentication, action, request, response);\n+                        contextPreservingListener.onResponse(response);\n+                    });", "originalCommit": "48d647eee633e193a6f2059dbee18188606039f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM0MTYwNw==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r505341607", "bodyText": "This intercepts the response for actions executed on other cluster nodes (when an action on the coordinating node submits requests to other nodes - or even the same node)", "author": "albertzaharovits", "createdAt": "2020-10-15T08:34:56Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/transport/SecurityServerTransportInterceptor.java", "diffHunk": "@@ -225,7 +237,36 @@ public void onFailure(Exception e) {\n \n                 @Override\n                 protected void doRun() throws Exception {\n-                    handler.messageReceived(request, channel, task);\n+                    handler.messageReceived(request, new TransportChannel() {\n+\n+                        @Override\n+                        public String getProfileName() {\n+                            return channel.getProfileName();\n+                        }\n+\n+                        @Override\n+                        public String getChannelType() {\n+                            return channel.getChannelType();\n+                        }\n+\n+                        @Override\n+                        public Version getVersion() {\n+                            return channel.getVersion();\n+                        }\n+\n+                        @Override\n+                        public void sendResponse(TransportResponse response) throws IOException {\n+                            String requestId = AuditUtil.extractRequestId(threadContext);\n+                            Authentication authentication = securityContext.getAuthentication();\n+                            auditTrailService.get().actionResponse(requestId, authentication, action, request, response);\n+                            channel.sendResponse(response);\n+                        }\n+\n+                        @Override\n+                        public void sendResponse(Exception exception) throws IOException {\n+                            channel.sendResponse(exception);\n+                        }\n+                    }, task);", "originalCommit": "48d647eee633e193a6f2059dbee18188606039f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ2Mjk2NA==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r505462964", "bodyText": "I haven't mentioned this as a drawback when we discussed it. I think I wasn't fully confident in my ability to clearly explain it. But this is part of the complexity and maintenance burden that I've mentioned, so I'll try to explain it here:\nIn order to pass the requestId and authentication as arguments to the new audit method, they need to be pulled from the thread context. Currently the requestId and authentication ARE present in the thread context when the listener is called with the response. But to ensure this forward we'll have to introduce an assertion (probably at this very place in the code). Even then, we cannot guarantee it because tests don't cover all the paths in an action handler: it could be that some handler stashes the thread context and calls the listener with a response (without calling another transport action, which is the usual course of action when stashing the context).\nAlternatively, we could enforce it more stringently. Instead of an assert we could hard fail (reroute the call to listener.onResponse to listener.onFailure) if we detect that the thread context has been altered.\nI favour the latter, but maybe this is overdoing it since the \"danger\" is inaccurate (missing requestId and authentication) audit logging for action responses (for which there is not concrete use case atm, but think of auditing creating API keys as an example).\nWe could also opt for assets in the minor and hard fail in the major release, similar to what we've discussed for indices privileges.\nThis is no longer true because the requestId and the authentication are now pulled from the threadContext after authorization, but before action execution, and are stored to be used as arguments to the new audit method, after the action executes.", "author": "albertzaharovits", "createdAt": "2020-10-15T11:21:16Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java", "diffHunk": "@@ -83,25 +86,24 @@ public SecurityActionFilter(AuthenticationService authcService, AuthorizationSer\n         if (licenseState.isSecurityEnabled()) {\n             final ActionListener<Response> contextPreservingListener =\n                     ContextPreservingActionListener.wrapPreservingContext(listener, threadContext);\n+            final ActionListener<Response> postActionExecutionListener = ActionListener.delegateFailure(contextPreservingListener,\n+                    (ignore, response) -> {\n+                        String requestId = AuditUtil.extractRequestId(threadContext);\n+                        Authentication authentication = securityContext.getAuthentication();", "originalCommit": "48d647eee633e193a6f2059dbee18188606039f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUwOTQ0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r505509446", "bodyText": "Alternatively, we could enforce it more stringently. Instead of an assert we could hard fail (reroute the call to listener.onResponse to listener.onFailure) if we detect that the thread context has been altered.\n\nI've pushed 2f5e546\nto better illustrate what I mean.", "author": "albertzaharovits", "createdAt": "2020-10-15T12:42:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ2Mjk2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyMzQ5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r514623499", "bodyText": "I've iterated on the issue, this is no longer a problem.", "author": "albertzaharovits", "createdAt": "2020-10-29T23:25:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ2Mjk2NA=="}], "type": "inlineReview"}, {"oid": "e3c5c3f1ff6e3f3d8cdd43d9255f12fc461cc169", "url": "https://github.com/elastic/elasticsearch/commit/e3c5c3f1ff6e3f3d8cdd43d9255f12fc461cc169", "message": "Merge branch 'master' into post_authz_audit_event", "committedDate": "2020-10-15T12:16:46Z", "type": "commit"}, {"oid": "946912741446d0017d52b7392c87a1063a29e211", "url": "https://github.com/elastic/elasticsearch/commit/946912741446d0017d52b7392c87a1063a29e211", "message": "SecurityActionFilterTests", "committedDate": "2020-10-15T12:30:30Z", "type": "commit"}, {"oid": "2f5e54682ab7abfb8f8e4c47d9b1dd5f70ab8503", "url": "https://github.com/elastic/elasticsearch/commit/2f5e54682ab7abfb8f8e4c47d9b1dd5f70ab8503", "message": "Strict!", "committedDate": "2020-10-15T12:40:46Z", "type": "commit"}, {"oid": "d88969b0c2e0454b987a5479c9080c343a289c30", "url": "https://github.com/elastic/elasticsearch/commit/d88969b0c2e0454b987a5479c9080c343a289c30", "message": "Merge branch 'master' into post_authz_audit_event", "committedDate": "2020-10-26T16:13:28Z", "type": "commit"}, {"oid": "0ebadb9c29daf47abdbd77a2427376037286607c", "url": "https://github.com/elastic/elasticsearch/commit/0ebadb9c29daf47abdbd77a2427376037286607c", "message": "Trash test", "committedDate": "2020-10-26T18:25:54Z", "type": "commit"}, {"oid": "f6ff433397a48346da425cd55fa9d08f656aea87", "url": "https://github.com/elastic/elasticsearch/commit/f6ff433397a48346da425cd55fa9d08f656aea87", "message": "SecurityActionFilter", "committedDate": "2020-10-26T21:26:35Z", "type": "commit"}, {"oid": "9f5623880cb6eb786b70949822e67182209b6ca9", "url": "https://github.com/elastic/elasticsearch/commit/9f5623880cb6eb786b70949822e67182209b6ca9", "message": "extract requestId and authentication before running the action", "committedDate": "2020-10-26T22:48:53Z", "type": "commit"}, {"oid": "765493f319444bb477fd9d089361a3407524656a", "url": "https://github.com/elastic/elasticsearch/commit/765493f319444bb477fd9d089361a3407524656a", "message": "remove thrash", "committedDate": "2020-10-26T22:52:04Z", "type": "commit"}, {"oid": "cf172b8f62bf93613f6848b92c4c97b78dcf5c94", "url": "https://github.com/elastic/elasticsearch/commit/cf172b8f62bf93613f6848b92c4c97b78dcf5c94", "message": "Merge branch 'master' into post_authz_audit_event", "committedDate": "2020-10-26T22:52:34Z", "type": "commit"}, {"oid": "71790f9d14cd74bc461c4fa46b822541f7d37478", "url": "https://github.com/elastic/elasticsearch/commit/71790f9d14cd74bc461c4fa46b822541f7d37478", "message": "Security enabled guard in SecurityServerTransport", "committedDate": "2020-10-26T23:11:45Z", "type": "commit"}, {"oid": "e25903e8670d157e6bfb7fd979a5f8e703d8e9d9", "url": "https://github.com/elastic/elasticsearch/commit/e25903e8670d157e6bfb7fd979a5f8e703d8e9d9", "message": "AuthenticationServiceTests", "committedDate": "2020-10-27T16:22:41Z", "type": "commit"}, {"oid": "6e229a88512026dcc802a6576b4ae87ede9f2369", "url": "https://github.com/elastic/elasticsearch/commit/6e229a88512026dcc802a6576b4ae87ede9f2369", "message": "AuthorizationServiceTests", "committedDate": "2020-10-29T12:24:09Z", "type": "commit"}, {"oid": "43f3644da4020c794f202ddfb5df74bfd6c1a99b", "url": "https://github.com/elastic/elasticsearch/commit/43f3644da4020c794f202ddfb5df74bfd6c1a99b", "message": "ServerTransportFilterTests", "committedDate": "2020-10-29T12:52:20Z", "type": "commit"}, {"oid": "a922aa862bd70eb0137e2e2eabc375f5dfb066ce", "url": "https://github.com/elastic/elasticsearch/commit/a922aa862bd70eb0137e2e2eabc375f5dfb066ce", "message": "SecurityActionFilterTests", "committedDate": "2020-10-29T14:38:35Z", "type": "commit"}, {"oid": "aada0ae266c3d2f893b581395d528e39ac1d109c", "url": "https://github.com/elastic/elasticsearch/commit/aada0ae266c3d2f893b581395d528e39ac1d109c", "message": "Merge branch 'master' into post_authz_audit_event", "committedDate": "2020-10-29T14:39:09Z", "type": "commit"}, {"oid": "655bba92ee760cdd9878808c15ef4062e91aca1f", "url": "https://github.com/elastic/elasticsearch/commit/655bba92ee760cdd9878808c15ef4062e91aca1f", "message": "More tests", "committedDate": "2020-10-29T23:09:59Z", "type": "commit"}, {"oid": "8c031671e2aeb5fcd0fc3870792bfe120faeb845", "url": "https://github.com/elastic/elasticsearch/commit/8c031671e2aeb5fcd0fc3870792bfe120faeb845", "message": "Checkstyle", "committedDate": "2020-10-29T23:23:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyNDUyOA==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r514624528", "bodyText": "Tests in this class have been modified to ensure that a requestId is set when done.", "author": "albertzaharovits", "createdAt": "2020-10-29T23:28:23Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/AuthenticationServiceTests.java", "diffHunk": "@@ -297,17 +299,26 @@ public void testTokenMissing() throws Exception {\n \n             Mockito.doReturn(List.of(secondRealm)).when(realms).getUnlicensedRealms();\n             Mockito.doReturn(List.of(firstRealm)).when(realms).asList();\n-            final String reqId = AuditUtil.getOrGenerateRequestId(threadContext);\n+            boolean requestIdAlreadyPresent = randomBoolean();\n+            SetOnce<String> reqId = new SetOnce<>();\n+            if (requestIdAlreadyPresent) {\n+                reqId.set(AuditUtil.getOrGenerateRequestId(threadContext));\n+            }", "originalCommit": "8c031671e2aeb5fcd0fc3870792bfe120faeb845", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyNTAyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r514625021", "bodyText": "Similarly to the changes in the AuthenticationServiceTests, the tests in this class have been modified to assert that the requestId is set following a successful authz.", "author": "albertzaharovits", "createdAt": "2020-10-29T23:30:00Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/AuthorizationServiceTests.java", "diffHunk": "@@ -274,7 +276,8 @@ public void setup() {\n             null, Collections.emptySet(), licenseState, new IndexNameExpressionResolver(new ThreadContext(Settings.EMPTY)));\n     }\n \n-    private void authorize(Authentication authentication, String action, TransportRequest request) {\n+    private void authorize(Authentication authentication, String action, TransportRequest request,", "originalCommit": "8c031671e2aeb5fcd0fc3870792bfe120faeb845", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxNTc1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r515715757", "bodyText": "Nit (kinda of): By the contract of ActionListener#delegateFailure, I'd prefer to not ignore the delegated listener. For this particular usage, it does not make any functional difference, but it feels abit strange to have (ignore, aVoid). I am also not entirely sure (this could be nothing) whether there could be any low level optimisation concerns, e.g. code compliation/rewriting, JIT, inlining etc (because one is captured in the form of method argument and the other is captured as scope variable)\nAlternatively, we could just use ActionListener#wrap if we do wanna ignore the delegated listener.", "author": "ywangd", "createdAt": "2020-11-02T02:46:04Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java", "diffHunk": "@@ -83,29 +88,38 @@ public SecurityActionFilter(AuthenticationService authcService, AuthorizationSer\n         if (licenseState.isSecurityEnabled()) {\n             final ActionListener<Response> contextPreservingListener =\n                     ContextPreservingActionListener.wrapPreservingContext(listener, threadContext);\n-            ActionListener<Void> authenticatedListener = ActionListener.wrap(\n-                    (aVoid) -> chain.proceed(task, action, request, contextPreservingListener), contextPreservingListener::onFailure);\n+            final ActionListener<Void> postAuthzListener = ActionListener.delegateFailure(contextPreservingListener,\n+                    (ignore, aVoid) -> {", "originalCommit": "8c031671e2aeb5fcd0fc3870792bfe120faeb845", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM1MTEyOA==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r516351128", "bodyText": "it feels abit strange to have (ignore, aVoid)\n\nSure, but the alternative of having variables similarly named pointing to the same thing is not preferable IMO.\n\nAlternatively, we could just use ActionListener#wrap if we do wanna ignore the delegated listener.\n\nI don't know about this either. I think that If I were to come up with the ActionListener#wrap in the first place, I might be getting the converse suggestion (no flame).", "author": "albertzaharovits", "createdAt": "2020-11-03T00:09:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxNTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE1NTMwNg==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r537155306", "bodyText": "This is not a big issue. So I am happy to let it slide.", "author": "ywangd", "createdAt": "2020-12-07T00:02:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxNTc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxNjI2OA==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r515716268", "bodyText": "Similar ignored delegate listener here. See above also.", "author": "ywangd", "createdAt": "2020-11-02T02:49:05Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java", "diffHunk": "@@ -83,29 +88,38 @@ public SecurityActionFilter(AuthenticationService authcService, AuthorizationSer\n         if (licenseState.isSecurityEnabled()) {\n             final ActionListener<Response> contextPreservingListener =\n                     ContextPreservingActionListener.wrapPreservingContext(listener, threadContext);\n-            ActionListener<Void> authenticatedListener = ActionListener.wrap(\n-                    (aVoid) -> chain.proceed(task, action, request, contextPreservingListener), contextPreservingListener::onFailure);\n+            final ActionListener<Void> postAuthzListener = ActionListener.delegateFailure(contextPreservingListener,\n+                    (ignore, aVoid) -> {\n+                        // extract the requestId and the authentication from the threadContext before executing the action\n+                        final String requestId = AuditUtil.extractRequestId(threadContext);\n+                        if (requestId == null) {\n+                            contextPreservingListener.onFailure(new ElasticsearchSecurityException(\"requestId is unexpectedly missing\"));\n+                            return;\n+                        }\n+                        final Authentication authentication = securityContext.getAuthentication();\n+                        if (authentication == null) {\n+                            contextPreservingListener.onFailure(new ElasticsearchSecurityException(\"authn is unexpectedly missing\"));\n+                            return;\n+                        }\n+                        chain.proceed(task, action, request, ActionListener.delegateFailure(contextPreservingListener,\n+                                (ignore2, response) -> {", "originalCommit": "8c031671e2aeb5fcd0fc3870792bfe120faeb845", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxODQzOA==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r515718438", "bodyText": "Good catch! Is this technically a bug?", "author": "ywangd", "createdAt": "2020-11-02T02:59:51Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/AuthorizationService.java", "diffHunk": "@@ -188,14 +188,15 @@ public void authorize(final Authentication authentication, final String action,\n             if (auditId == null) {\n                 // We would like to assert that there is an existing request-id, but if this is a system action, then that might not be\n                 // true because the request-id is generated during authentication\n-                if (isInternalUser(authentication.getUser()) != false) {\n+                if (isInternalUser(authentication.getUser())) {\n                     auditId = AuditUtil.getOrGenerateRequestId(threadContext);\n                 } else {\n                     auditTrailService.get().tamperedRequest(null, authentication, action, originalRequest);\n                     final String message = \"Attempt to authorize action [\" + action + \"] for [\" + authentication.getUser().principal()\n                             + \"] without an existing request-id\";\n                     assert false : message;\n                     listener.onFailure(new ElasticsearchSecurityException(message));\n+                    return;", "originalCommit": "8c031671e2aeb5fcd0fc3870792bfe120faeb845", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM0NDE1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r516344155", "bodyText": "yes", "author": "albertzaharovits", "createdAt": "2020-11-02T23:55:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxODQzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxODQ4MA==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r515718480", "bodyText": "Why do we flip the logic here?", "author": "ywangd", "createdAt": "2020-11-02T03:00:02Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/AuthorizationService.java", "diffHunk": "@@ -188,14 +188,15 @@ public void authorize(final Authentication authentication, final String action,\n             if (auditId == null) {\n                 // We would like to assert that there is an existing request-id, but if this is a system action, then that might not be\n                 // true because the request-id is generated during authentication\n-                if (isInternalUser(authentication.getUser()) != false) {\n+                if (isInternalUser(authentication.getUser())) {", "originalCommit": "8c031671e2aeb5fcd0fc3870792bfe120faeb845", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM0Mzk5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r516343993", "bodyText": "We don't ;)", "author": "albertzaharovits", "createdAt": "2020-11-02T23:55:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxODQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE4Njg4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r517186881", "bodyText": "Right, sorry I thought it was ==.", "author": "ywangd", "createdAt": "2020-11-04T08:58:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxODQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxODgzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r515718839", "bodyText": "We have User#isInternal which does the same and I think this method here can be dropped.", "author": "ywangd", "createdAt": "2020-11-02T03:01:53Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/AuthorizationService.java", "diffHunk": "@@ -436,7 +437,8 @@ private TransportRequest maybeUnwrapRequest(Authentication authentication, Trans\n         return request;\n     }\n \n-    private boolean isInternalUser(User user) {\n+    // protected for tests\n+    protected static boolean isInternalUser(User user) {\n         return SystemUser.is(user) || XPackUser.is(user) || XPackSecurityUser.is(user) || AsyncSearchUser.is(user);\n     }", "originalCommit": "8c031671e2aeb5fcd0fc3870792bfe120faeb845", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b514c0c9f048fc1a886748a57ffdc741f02e4584", "url": "https://github.com/elastic/elasticsearch/commit/b514c0c9f048fc1a886748a57ffdc741f02e4584", "message": "Merge branch 'master' into post_authz_audit_event", "committedDate": "2020-11-04T09:17:35Z", "type": "commit"}, {"oid": "67069934306f5de51924eb1eff4bf6877b191247", "url": "https://github.com/elastic/elasticsearch/commit/67069934306f5de51924eb1eff4bf6877b191247", "message": "Reuse the `User#isInternal` method in the authorization service", "committedDate": "2020-11-04T12:19:16Z", "type": "commit"}, {"oid": "ec226116a40c9daaab98bb8746b0c0bc6fbe3ded", "url": "https://github.com/elastic/elasticsearch/commit/ec226116a40c9daaab98bb8746b0c0bc6fbe3ded", "message": "Merge branch 'master' into post_authz_audit_event", "committedDate": "2020-12-07T21:43:37Z", "type": "commit"}, {"oid": "1b5b65ebc207be85640024017564e01c4e9ba9b6", "url": "https://github.com/elastic/elasticsearch/commit/1b5b65ebc207be85640024017564e01c4e9ba9b6", "message": "tests afte merge conflict", "committedDate": "2020-12-07T22:04:48Z", "type": "commit"}, {"oid": "e7383c50698e949ca1ac92b603b85220f864776a", "url": "https://github.com/elastic/elasticsearch/commit/e7383c50698e949ca1ac92b603b85220f864776a", "message": "wrong merge choice", "committedDate": "2020-12-07T22:27:48Z", "type": "commit"}, {"oid": "14425d56c999750b2ef08942af4532dc459c154c", "url": "https://github.com/elastic/elasticsearch/commit/14425d56c999750b2ef08942af4532dc459c154c", "message": "Good merge choice", "committedDate": "2020-12-07T22:35:09Z", "type": "commit"}, {"oid": "a730658647ddcaaad3f3159f127e9b37312be40d", "url": "https://github.com/elastic/elasticsearch/commit/a730658647ddcaaad3f3159f127e9b37312be40d", "message": "Move chain.proceed down", "committedDate": "2020-12-07T23:14:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODExMTAzMw==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r538111033", "bodyText": "I wonder whether it would be better to create a different Runnable depending on whether security is enabled instead of testing securityEnabled inside the Runnable.", "author": "ywangd", "createdAt": "2020-12-08T07:51:55Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/transport/SecurityServerTransportInterceptor.java", "diffHunk": "@@ -241,9 +296,10 @@ public String toString() {\n \n         @Override\n         public void messageReceived(T request, TransportChannel channel, Task task) throws Exception {\n-            final AbstractRunnable receiveMessage = getReceiveRunnable(request, channel, task);\n+            final boolean securityEnabled = licenseState.isSecurityEnabled();\n+            final AbstractRunnable receiveMessage = getReceiveRunnable(request, channel, task, securityEnabled);", "originalCommit": "a730658647ddcaaad3f3159f127e9b37312be40d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c6d1a74aaab1ab9fc47f930a302fda8f30aae18d", "url": "https://github.com/elastic/elasticsearch/commit/c6d1a74aaab1ab9fc47f930a302fda8f30aae18d", "message": "Remove line", "committedDate": "2020-12-08T11:21:11Z", "type": "commit"}, {"oid": "93299a36dd5ddc42feae7ad2a57ef8ea7a27fb33", "url": "https://github.com/elastic/elasticsearch/commit/93299a36dd5ddc42feae7ad2a57ef8ea7a27fb33", "message": "Merge branch 'master' into post_authz_audit_event", "committedDate": "2020-12-09T18:35:21Z", "type": "commit"}, {"oid": "3926adac4a1439a728778ae37b9e453f1b7e37f5", "url": "https://github.com/elastic/elasticsearch/commit/3926adac4a1439a728778ae37b9e453f1b7e37f5", "message": "Checkstyle", "committedDate": "2020-12-09T19:01:13Z", "type": "commit"}, {"oid": "4d579d79a60fabbed21d7ce90d2f3c0e77862584", "url": "https://github.com/elastic/elasticsearch/commit/4d579d79a60fabbed21d7ce90d2f3c0e77862584", "message": "Merge branch 'master' into post_authz_audit_event", "committedDate": "2020-12-14T19:07:02Z", "type": "commit"}, {"oid": "e5ddb6e2313d840c12e35e1b08ab961bc3049cf1", "url": "https://github.com/elastic/elasticsearch/commit/e5ddb6e2313d840c12e35e1b08ab961bc3049cf1", "message": "Only intercept the action filter", "committedDate": "2020-12-15T09:04:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE3MDIyNA==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r543170224", "bodyText": "This is not technically true, some actions' (TransportMasterNodeAction) responses are intercepted on the coordinating node, as well as on the master node.\nThe naming and descriptions are difficult to write to convey the subset of actions that are covered.\nWe could also bleed some internals in here and mention the SecurityActionFilter.\nOpen to suggestions.", "author": "albertzaharovits", "createdAt": "2020-12-15T09:12:19Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/AuditTrail.java", "diffHunk": "@@ -81,4 +82,9 @@ void runAsDenied(String requestId, Authentication authentication, RestRequest re\n     void explicitIndexAccessEvent(String requestId, AuditLevel eventType, Authentication authentication, String action, String indices,\n                                   String requestName, TransportAddress remoteAddress, AuthorizationInfo authorizationInfo);\n \n+    // this is the only audit method that is called *after* the action executed, when the response is available\n+    // it is however *only called for coordinating actions*, which are the actions that a client invokes as opposed to\n+    // the actions that a node invokes in order to service a client request\n+    void coordinatingActionResponse(String requestId, Authentication authentication, String action, TransportRequest transportRequest,\n+                                    TransportResponse transportResponse);", "originalCommit": "e5ddb6e2313d840c12e35e1b08ab961bc3049cf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMyMjk0NA==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r543322944", "bodyText": "I think we could keep the previous name, i.e. actionResponse. Please let me explain: When I suggested pulling out the code from SecurityServerTransportInterceptor, it was in the context of getting auditing for API key ID in for v7.11.0. The reasons are:\n\nThe response in SecurityServerTransportInterceptor is a fairly low level indexing response and does not really provide extra valuable information than the one in the coordinating node. Therefore auditing on just the coordinating node is sufficient.\nCreating API key is underlyingly a TransportReplicationAction. Unlike TransportMasterNodeAction, it does not go through the SecurityActionFilter (on the remote node). This means: on the remote node, we will not get another auditing entry from SecurityActionFilter, i.e. there will only be a single auditing entry about API key creation and it is on the coordinating node.\n\nSo my motivation was rather narrowly focused on the particular use case. The agreement, as I understand it, is to defer the auditing code in SecurityServerTransportInterceptor until the next release. Because it is not necessary for API key auditing in this release and if it is not in use, it's better to be left out. But we also agreed that it could still be useful when we expand the usage scenario and this is subject to further discussion.\nIIUC, your intention of changing the method name is for the possibility to have two different audit event types. I should have been clear that it was not my proposal. I consider whether auditing inside SecurityServerTransportInterceptor an implementation detail, which we chose to opt out for initial release, but could choose to add it later as an enhancement. For verbosity and duplication control, I'd prefer to solve it in a different way other than splitting it into different audit event types. I hope this makes sense.", "author": "ywangd", "createdAt": "2020-12-15T13:02:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE3MDIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM4NzA0MA==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r543387040", "bodyText": "Thanks for the detailed explanation Yang, but I would like to focus the conversation on the scope of this PR only. We should consider the broader picture, as you describe, but ultimately this PR is what gets merged as a unit, and what we merge in the future is subject to debate still.\nIf we merge this PR, which adds the audit hook for the responses of actions intercepted by the SecurityActionFilter only, we add to the interface of the LoggingAuditTrail .\nWhen we later merge the code to allow intercepting the responses of the other actions, we have the options to:\n\nreuse the same LoggingAuditTrail hook method\nrename the existing hook method, or\nadd a new audit response hook method.\n(or any mix of them, really, if we feel wild)\n\nBecause this is a private interface, I don't believe we have to name it in anticipation of its use. We should name it for the purpose that it serves right now, as we can always tinker with it later. For this reason, I would not favor the actionResponse name.", "author": "albertzaharovits", "createdAt": "2020-12-15T14:21:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE3MDIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzk5MTAwNA==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r543991004", "bodyText": "Just trying to brainstorm here: How about calling this one actionResponse and the other one transportResponse?\nAs you said, this is a private interface, so we don't have to struggle too much with its name now. So please feel free to use whatever works for you.", "author": "ywangd", "createdAt": "2020-12-16T05:47:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE3MDIyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDIwOTc4NA==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r544209784", "bodyText": "Yeah, this could work. I'll keep this in mind when we'll iterate on the interface.", "author": "albertzaharovits", "createdAt": "2020-12-16T11:08:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE3MDIyNA=="}], "type": "inlineReview"}, {"oid": "cf59a6095a84d0d22732e6ad1437a3b11c03c8eb", "url": "https://github.com/elastic/elasticsearch/commit/cf59a6095a84d0d22732e6ad1437a3b11c03c8eb", "message": "Checkstyle test", "committedDate": "2020-12-15T09:13:57Z", "type": "commit"}, {"oid": "7851883f7bb0b770c3f2b0319c6482f13fda5c38", "url": "https://github.com/elastic/elasticsearch/commit/7851883f7bb0b770c3f2b0319c6482f13fda5c38", "message": "Merge branch 'master' into post_authz_audit_event", "committedDate": "2020-12-15T10:47:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM0NDYxMw==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r543344613", "bodyText": "Nit: now there is no actual change to this constructor, probably wanna get rid of the unnecessary format change as well.", "author": "ywangd", "createdAt": "2020-12-15T13:34:29Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/Security.java", "diffHunk": "@@ -519,9 +519,10 @@ protected Clock getClock() {\n         components.add(ipFilter.get());\n         DestructiveOperations destructiveOperations = new DestructiveOperations(settings, clusterService.getClusterSettings());\n         securityInterceptor.set(new SecurityServerTransportInterceptor(settings, threadPool, authcService.get(),\n-                authzService, getLicenseState(), getSslService(), securityContext.get(), destructiveOperations, clusterService));\n+                authzService, getLicenseState(), getSslService(), securityContext.get(), destructiveOperations,\n+                clusterService));", "originalCommit": "7851883f7bb0b770c3f2b0319c6482f13fda5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM2NDI1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r543364257", "bodyText": "Nit: this assertion of reqId.get() being non-null does not exist in other places. Do we need it here?", "author": "ywangd", "createdAt": "2020-12-15T14:00:49Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/AuthenticationServiceTests.java", "diffHunk": "@@ -331,10 +342,20 @@ public void testAuthenticateBothSupportSecondSucceeds() throws Exception {\n         } else {\n             when(secondRealm.token(threadContext)).thenReturn(token);\n         }\n-        final String reqId = AuditUtil.getOrGenerateRequestId(threadContext);\n+        boolean requestIdAlreadyPresent = randomBoolean();\n+        SetOnce<String> reqId = new SetOnce<>();\n+        if (requestIdAlreadyPresent) {\n+            reqId.set(AuditUtil.getOrGenerateRequestId(threadContext));\n+            assertThat(reqId.get(), not(nullValue()));", "originalCommit": "7851883f7bb0b770c3f2b0319c6482f13fda5c38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "375377123b15b86896a894625edc72772506ad34", "url": "https://github.com/elastic/elasticsearch/commit/375377123b15b86896a894625edc72772506ad34", "message": "Merge branch 'master' into post_authz_audit_event", "committedDate": "2020-12-15T14:44:35Z", "type": "commit"}, {"oid": "49a2852b85fa33da2d36446c6a6d0f859cb73d1a", "url": "https://github.com/elastic/elasticsearch/commit/49a2852b85fa33da2d36446c6a6d0f859cb73d1a", "message": "Nits", "committedDate": "2020-12-15T14:48:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzk2Mjg0NA==", "url": "https://github.com/elastic/elasticsearch/pull/63708#discussion_r543962844", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private <Request extends ActionRequest, Response extends ActionResponse> void applyInternal(Task task, ActionFilterChain<Request,\n          \n          \n            \n                        Response> chain, String action, Request request, ActionListener<Response> listener) {\n          \n          \n            \n                private <Request extends ActionRequest, Response extends ActionResponse> void applyInternal(Task task,\n          \n          \n            \n                        ActionFilterChain<Request, Response> chain, String action, Request request, ActionListener<Response> listener) {", "author": "tvernum", "createdAt": "2020-12-16T05:10:26Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java", "diffHunk": "@@ -130,13 +124,13 @@ public int order() {\n         return Integer.MIN_VALUE;\n     }\n \n-    private <Request extends ActionRequest> void applyInternal(String action, Request request,\n-                                                               ActionListener<Void> listener) throws IOException {\n+    private <Request extends ActionRequest, Response extends ActionResponse> void applyInternal(Task task, ActionFilterChain<Request,\n+            Response> chain, String action, Request request, ActionListener<Response> listener) {", "originalCommit": "49a2852b85fa33da2d36446c6a6d0f859cb73d1a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6e2e8829c59242d5b956074abc2a8b3575d74c58", "url": "https://github.com/elastic/elasticsearch/commit/6e2e8829c59242d5b956074abc2a8b3575d74c58", "message": "Update x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java\n\nCo-authored-by: Tim Vernum <tim@adjective.org>", "committedDate": "2020-12-16T09:38:16Z", "type": "commit"}, {"oid": "b81f644560852a4a6de6fae4193ad9e8d662e919", "url": "https://github.com/elastic/elasticsearch/commit/b81f644560852a4a6de6fae4193ad9e8d662e919", "message": "Merge branch 'master' into post_authz_audit_event", "committedDate": "2020-12-16T10:17:38Z", "type": "commit"}]}