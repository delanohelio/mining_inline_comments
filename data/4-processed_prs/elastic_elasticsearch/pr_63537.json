{"pr_number": 63537, "pr_title": "Recycle buffers used for cluster state publication", "pr_createdAt": "2020-10-12T08:42:01Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63537", "timeline": [{"oid": "8dae5f5851120eaaac67c1a1fa2424eedd5866ca", "url": "https://github.com/elastic/elasticsearch/commit/8dae5f5851120eaaac67c1a1fa2424eedd5866ca", "message": "Recycle buffers used for cluster state publication\n\nUses a `ReleasableBytesStreamOutput` to serialize the cluster state (or\ndiff) and releases it on completion of the publication.", "committedDate": "2020-10-12T08:40:28Z", "type": "commit"}, {"oid": "10e44ce2585077ace98fdb1724b5a942f0ce1e2e", "url": "https://github.com/elastic/elasticsearch/commit/10e44ce2585077ace98fdb1724b5a942f0ce1e2e", "message": "flushOnCloseStream", "committedDate": "2020-10-12T09:34:04Z", "type": "commit"}, {"oid": "35e4bbfcb7cd0c4c4102e65f16a4105ec533dd33", "url": "https://github.com/elastic/elasticsearch/commit/35e4bbfcb7cd0c4c4102e65f16a4105ec533dd33", "message": "Permit local exception", "committedDate": "2020-10-12T09:57:25Z", "type": "commit"}, {"oid": "284092d403b69a51997032ffb8b2e6acb5970206", "url": "https://github.com/elastic/elasticsearch/commit/284092d403b69a51997032ffb8b2e6acb5970206", "message": "Release serialized states on exception in buildDiffAndSerializeStates", "committedDate": "2020-10-12T12:49:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMxNTg5NA==", "url": "https://github.com/elastic/elasticsearch/pull/63537#discussion_r503315894", "bodyText": "Shouldn't we resolve the listener outside the mutex?", "author": "original-brownbear", "createdAt": "2020-10-12T13:59:24Z", "path": "server/src/main/java/org/elasticsearch/cluster/coordination/PublicationTransportHandler.java", "diffHunk": "@@ -350,30 +393,73 @@ public String executor() {\n                 });\n         }\n \n+        private boolean failIfAlreadyReleased(ActionListener<PublishWithJoinResponse> listener) {\n+            assert Thread.holdsLock(mutex);\n+            if (serializedStatesReleased) {\n+                listener.onFailure(", "originalCommit": "284092d403b69a51997032ffb8b2e6acb5970206", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM0MzQxMg==", "url": "https://github.com/elastic/elasticsearch/pull/63537#discussion_r503343412", "bodyText": "Good catch. I don't think it's terrible not to, it'll only hold up a few generic threads and should be pretty rare, but yeah let's do it right. Shame it messes up the control flow even more, but see f1b9a9e.", "author": "DaveCTurner", "createdAt": "2020-10-12T14:41:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMxNTg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUwNzMxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/63537#discussion_r503507315", "bodyText": "Yea I was mainly worried about stupid test failures where we leak the listener in some corner case when the generic pool shuts down too quickly and swallows the response handler. We should be good here (and even better with this change) because we shut down the connections first (which should fail the listeners) and then give it 10s for the listener actions to run before we kill the thread-pool :)", "author": "original-brownbear", "createdAt": "2020-10-12T20:05:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMxNTg5NA=="}], "type": "inlineReview"}, {"oid": "f1b9a9efc81f2e50399747d03ca2ec7599d08bb1", "url": "https://github.com/elastic/elasticsearch/commit/f1b9a9efc81f2e50399747d03ca2ec7599d08bb1", "message": "Notify listener outside mutex", "committedDate": "2020-10-12T14:37:42Z", "type": "commit"}]}