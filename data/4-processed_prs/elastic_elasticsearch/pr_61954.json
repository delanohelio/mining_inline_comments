{"pr_number": 61954, "pr_title": "Add snapshot only test modules", "pr_createdAt": "2020-09-04T02:47:11Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61954", "timeline": [{"oid": "851a2f851205f7327557bc89d3643617522696a5", "url": "https://github.com/elastic/elasticsearch/commit/851a2f851205f7327557bc89d3643617522696a5", "message": "Add snapshot only test modules\n\nThis commit adds external test modules. These are modules meant for\nexternal systems to test edge cases in elasticsearch, but only within\nsnapshots. They are not meant to be used in production, so protections\nare also added from their accidental inclusion in release builds.\n\nNote that this commit does not actually add any new modules, it only\nadds the infrastructure for the new modules, under\n`test/external-modules`.", "committedDate": "2020-09-04T02:44:22Z", "type": "commit"}, {"oid": "7806f87ed510e6c81437217298c733e4196fb4b7", "url": "https://github.com/elastic/elasticsearch/commit/7806f87ed510e6c81437217298c733e4196fb4b7", "message": "cleanup", "committedDate": "2020-09-04T02:56:00Z", "type": "commit"}, {"oid": "ceb46cc19aec20b740407068c29f955696d69446", "url": "https://github.com/elastic/elasticsearch/commit/ceb46cc19aec20b740407068c29f955696d69446", "message": "fix brokenness", "committedDate": "2020-09-04T03:13:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY5NjM0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/61954#discussion_r483696345", "bodyText": "Why is this no longer needed?", "author": "mark-vieira", "createdAt": "2020-09-04T15:35:20Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/RestTestUtil.java", "diffHunk": "@@ -55,32 +53,6 @@ static RestIntegTestTask setupTask(Project project, String sourceSetName) {\n     static void setupRunnerTask(Project project, RestIntegTestTask testTask, SourceSet sourceSet) {\n         testTask.setTestClassesDirs(sourceSet.getOutput().getClassesDirs());\n         testTask.setClasspath(sourceSet.getRuntimeClasspath());\n-", "originalCommit": "ceb46cc19aec20b740407068c29f955696d69446", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc2NDAwNg==", "url": "https://github.com/elastic/elasticsearch/pull/61954#discussion_r483764006", "bodyText": "The test task depending on the module is handled within testclusters now. The plugin extension dependsOn is handled inside PluginBuildPlugin.", "author": "rjernst", "createdAt": "2020-09-04T17:36:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY5NjM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY5ODc3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/61954#discussion_r483698775", "bodyText": "We should open an issue to use artifact transforms for this stuff as well so we don't have to keep doing this zipTree and singleFile nonsense. This is the same as the stuff @breskeby is working on to avoid a lot of unnecessary packing/unpacking in build processes.", "author": "mark-vieira", "createdAt": "2020-09-04T15:38:00Z", "path": "distribution/build.gradle", "diffHunk": "@@ -139,11 +145,22 @@ tasks.register(\"buildTransportModules\") {\n   dependsOn \"processTransportOutputs\"\n   outputs.dir \"${transportOutputs}/modules\"\n }\n+tasks.register(\"buildExternalTestModules\") {\n+  dependsOn \"processExternalTestOutputs\"\n+  outputs.dir \"${externalTestOutputs}/modules\"\n+}\n+\n+Configuration moduleZip(Project module) {\n+  Dependency dep = project.dependencies.project(path: module.path, configuration: 'zip')\n+  Configuration config = project.configurations.detachedConfiguration(dep)\n+  return config\n+}\n \n void copyModule(Sync copyTask, Project module) {\n+  Configuration moduleConfig = moduleZip(module)\n   copyTask.configure {\n-    dependsOn \"${module.path}:bundlePlugin\"\n-    from({ zipTree(module.bundlePlugin.outputs.files.singleFile) }) {\n+    dependsOn moduleConfig\n+    from({ zipTree(moduleConfig.singleFile) }) {", "originalCommit": "ceb46cc19aec20b740407068c29f955696d69446", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcwMTg3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/61954#discussion_r483701871", "bodyText": "Seems basing this on name is a little brittle. Is there no way to add arbitrary metadata to modules?", "author": "mark-vieira", "createdAt": "2020-09-04T15:41:20Z", "path": "server/src/main/java/org/elasticsearch/plugins/PluginsService.java", "diffHunk": "@@ -367,6 +368,9 @@ private static Bundle readPluginBundle(final Set<Bundle> bundles, final Path plu\n         if (bundles.add(bundle) == false) {\n             throw new IllegalStateException(\"duplicate \" + type + \": \" + info);\n         }\n+        if (type.equals(\"module\") && info.getName().startsWith(\"test-\") && Build.CURRENT.isSnapshot() == false) {", "originalCommit": "ceb46cc19aec20b740407068c29f955696d69446", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcyNzUwMg==", "url": "https://github.com/elastic/elasticsearch/pull/61954#discussion_r483727502", "bodyText": "There is not. We can add to the plugin properties, but I did not want to add an \"official\" property here, as it is really only about modules, yet the properties apply to all plugins and modules. I think the name checking is fine for now, since we completely own the namespace of modules.", "author": "rjernst", "createdAt": "2020-09-04T16:26:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcwMTg3MQ=="}], "type": "inlineReview"}, {"oid": "a0245722a34959bfbf5c9fd326fc4aa901e64792", "url": "https://github.com/elastic/elasticsearch/commit/a0245722a34959bfbf5c9fd326fc4aa901e64792", "message": "Merge branch 'master' into build_test_modules", "committedDate": "2020-09-04T18:28:22Z", "type": "commit"}, {"oid": "bec0040048b96b92276af24645f1ec1a9669059a", "url": "https://github.com/elastic/elasticsearch/commit/bec0040048b96b92276af24645f1ec1a9669059a", "message": "add back", "committedDate": "2020-09-04T19:23:39Z", "type": "commit"}, {"oid": "8d9334faaa095c3bd3e2caeb2a91e3ed8770b0f9", "url": "https://github.com/elastic/elasticsearch/commit/8d9334faaa095c3bd3e2caeb2a91e3ed8770b0f9", "message": "checkstyle", "committedDate": "2020-09-04T19:32:21Z", "type": "commit"}]}