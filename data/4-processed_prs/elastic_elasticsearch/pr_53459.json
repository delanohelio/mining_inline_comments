{"pr_number": 53459, "pr_title": "Associate translog with Lucene index commit for searchable snapshots shards", "pr_createdAt": "2020-03-12T09:25:17Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53459", "timeline": [{"oid": "406d4def86c752d664c0bf8b7f64d14e50f0ddd6", "url": "https://github.com/elastic/elasticsearch/commit/406d4def86c752d664c0bf8b7f64d14e50f0ddd6", "message": "Associate translog with Lucene index commit", "committedDate": "2020-03-12T08:44:52Z", "type": "commit"}, {"oid": "32df1c4e79ae27eb47fbca05a8d8fb43b0fe04ca", "url": "https://github.com/elastic/elasticsearch/commit/32df1c4e79ae27eb47fbca05a8d8fb43b0fe04ca", "message": "Partial revert \"Associate translog with Lucene index commit\"\n\nThis partially reverts commit 406d4def", "committedDate": "2020-03-12T13:29:57Z", "type": "commit"}, {"oid": "4ab94ce30de70f4b95a6daa67538bb07ab926129", "url": "https://github.com/elastic/elasticsearch/commit/4ab94ce30de70f4b95a6daa67538bb07ab926129", "message": "Add pre recovery hook", "committedDate": "2020-03-12T15:57:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTczMTcxMw==", "url": "https://github.com/elastic/elasticsearch/pull/53459#discussion_r391731713", "bodyText": "I think this might need to remain within the try block, as indexShard() can throw an exception.", "author": "ywelsch", "createdAt": "2020-03-12T16:14:30Z", "path": "server/src/main/java/org/elasticsearch/indices/recovery/PeerRecoveryTargetService.java", "diffHunk": "@@ -171,11 +171,13 @@ private void doRecovery(final long recoveryId) {\n             final RecoveryTarget recoveryTarget = recoveryRef.target();\n             timer = recoveryTarget.state().getTimer();\n             cancellableThreads = recoveryTarget.cancellableThreads();\n+            final IndexShard indexShard = recoveryTarget.indexShard();", "originalCommit": "4ab94ce30de70f4b95a6daa67538bb07ab926129", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA4ODI4OA==", "url": "https://github.com/elastic/elasticsearch/pull/53459#discussion_r392088288", "bodyText": "Good catch - I should not have moved that", "author": "tlrx", "createdAt": "2020-03-13T08:29:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTczMTcxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc2NzM3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53459#discussion_r391767376", "bodyText": "More for my curiosity than something that needs changing: why can we not assert state == IndexShardState.RECOVERING here? The lifecycle of an IndexShard is still a bit opaque to me.", "author": "DaveCTurner", "createdAt": "2020-03-12T17:09:37Z", "path": "server/src/main/java/org/elasticsearch/index/shard/IndexShard.java", "diffHunk": "@@ -1313,6 +1313,13 @@ public void close(String reason, boolean flushEngine) throws IOException {\n         }\n     }\n \n+    public void preRecovery() {\n+        if (state != IndexShardState.RECOVERING) {", "originalCommit": "4ab94ce30de70f4b95a6daa67538bb07ab926129", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA5MDAwMw==", "url": "https://github.com/elastic/elasticsearch/pull/53459#discussion_r392090003", "bodyText": "I think it makes more sense to assert here, there's no reason to not do it.", "author": "tlrx", "createdAt": "2020-03-13T08:33:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc2NzM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc2OTY5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53459#discussion_r391769695", "bodyText": "Suggest adding a big warning in a comment here saying how dangerous it is to specify the translog UUID and that it should only be used for shards that will see no indexing.\nI'm also idly wondering about how hard it would be to make this Translog read-only when it's not been created with a fresh UUID. Probably too hard to be worth doing, but thought I'd mention it anyway.", "author": "DaveCTurner", "createdAt": "2020-03-12T17:13:27Z", "path": "server/src/main/java/org/elasticsearch/index/translog/Translog.java", "diffHunk": "@@ -1838,20 +1840,41 @@ public static String createEmptyTranslog(final Path location, final long initial\n \n     static String createEmptyTranslog(Path location, long initialGlobalCheckpoint, ShardId shardId,\n                                       ChannelFactory channelFactory, long primaryTerm) throws IOException {\n+        return createEmptyTranslog(location, shardId, initialGlobalCheckpoint, primaryTerm, null, channelFactory);\n+    }\n+\n+    public static String createEmptyTranslog(final Path location,", "originalCommit": "4ab94ce30de70f4b95a6daa67538bb07ab926129", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwODc3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53459#discussion_r392108775", "bodyText": "Suggest adding a big warning in a comment here saying how dangerous it is to specify the translog UUID and that it should only be used for shards that will see no indexing.\n\nSure, I added some doc in 557d924\n\nI'm also idly wondering about how hard it would be to make this Translog read-only when it's not been created with a fresh UUID. Probably too hard to be worth doing, but thought I'd mention it anyway.\n\nI find the idea interesting but I'm not sure if it worths it; I'd prefer to not create translogs at all if they were not to be used.", "author": "tlrx", "createdAt": "2020-03-13T09:14:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc2OTY5NQ=="}], "type": "inlineReview"}, {"oid": "557d924f02ea84cbd084734a132277706bfead62", "url": "https://github.com/elastic/elasticsearch/commit/557d924f02ea84cbd084734a132277706bfead62", "message": "Feedback", "committedDate": "2020-03-13T09:04:35Z", "type": "commit"}, {"oid": "f3fc1632e1ca1fde561d602276fb57f4387bf962", "url": "https://github.com/elastic/elasticsearch/commit/f3fc1632e1ca1fde561d602276fb57f4387bf962", "message": "Merge branch 'feature/searchable-snapshots' into associate-translog-with-lucene-index", "committedDate": "2020-03-13T09:56:00Z", "type": "commit"}]}