{"pr_number": 50841, "pr_title": "[ML] Reuse SourceDestValidator for data frame analytics", "pr_createdAt": "2020-01-10T08:46:10Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50841", "timeline": [{"oid": "928d24bffbd40643b1d77ec4e3bf2ed5aa992f80", "url": "https://github.com/elastic/elasticsearch/commit/928d24bffbd40643b1d77ec4e3bf2ed5aa992f80", "message": "[ML] Reuse SourceDestValidator for data frame analytics\n\nThis commit removes validation logic of source and dest indices\nfor data frame analytics and replaces it with using the common\n`SourceDestValidator` class which is already used by transforms.\nThis way the validations and their messages become consistent\nwhile we reduce code.\n\nThis means that where these validations fail the error messages\nwill be slightly different for data frame analytics.", "committedDate": "2020-01-10T08:42:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEyNDkyMg==", "url": "https://github.com/elastic/elasticsearch/pull/50841#discussion_r365124922", "bodyText": "This was unused.", "author": "dimitris-athanasiou", "createdAt": "2020-01-10T08:46:34Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/common/validation/SourceDestValidator.java", "diffHunk": "@@ -46,7 +46,6 @@\n \n     // messages\n     public static final String SOURCE_INDEX_MISSING = \"Source index [{0}] does not exist\";\n-    public static final String SOURCE_LOWERCASE = \"Source index [{0}] must be lowercase\";", "originalCommit": "928d24bffbd40643b1d77ec4e3bf2ed5aa992f80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d21d9f02688fb11e1d9ec6e3e31876abe075131a", "url": "https://github.com/elastic/elasticsearch/commit/d21d9f02688fb11e1d9ec6e3e31876abe075131a", "message": "Add missing file and extract message into constant", "committedDate": "2020-01-10T08:49:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE0MTk0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/50841#discussion_r365141946", "bodyText": "nice spot!", "author": "hendrikmuhs", "createdAt": "2020-01-10T09:29:43Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/common/validation/SourceDestValidator.java", "diffHunk": "@@ -427,13 +417,13 @@ public void validate(Context context, ActionListener<Context> listener) {\n                 return;\n             }\n \n-            if (context.resolvedSource.contains(destIndex)) {\n+            if (context.resolveSource().contains(destIndex)) {", "originalCommit": "d21d9f02688fb11e1d9ec6e3e31876abe075131a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE0NTA1MA==", "url": "https://github.com/elastic/elasticsearch/pull/50841#discussion_r365145050", "bodyText": "^ needs re-activation or should be removed", "author": "hendrikmuhs", "createdAt": "2020-01-10T09:36:36Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/common/validation/SourceDestValidatorTests.java", "diffHunk": "@@ -260,17 +274,17 @@ public void testCheck_GivenMixedMissingAndExistingConcreteSourceIndex() throws I\n             }\n         );\n \n-        assertValidation(\n-            listener -> simpleNonRemoteValidator.validate(\n-                CLUSTER_STATE,\n-                new String[] { SOURCE_1, \"missing\" },\n-                \"dest\",\n-                SourceDestValidator.NON_DEFERABLE_VALIDATIONS,\n-                listener\n-            ),\n-            true,\n-            null\n-        );\n+//        assertValidation(\n+//            listener -> simpleNonRemoteValidator.validate(\n+//                CLUSTER_STATE,\n+//                new String[] { SOURCE_1, \"missing\" },\n+//                \"dest\",\n+//                Collections.emptyList(),\n+//                listener\n+//            ),\n+//            true,\n+//            null\n+//        );", "originalCommit": "d21d9f02688fb11e1d9ec6e3e31876abe075131a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE2NjI0OA==", "url": "https://github.com/elastic/elasticsearch/pull/50841#discussion_r365166248", "bodyText": "Reactivated it. Good catch.", "author": "dimitris-athanasiou", "createdAt": "2020-01-10T10:23:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE0NTA1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE0NzQyNg==", "url": "https://github.com/elastic/elasticsearch/pull/50841#discussion_r365147426", "bodyText": "not getting this change, should the test be removed?", "author": "hendrikmuhs", "createdAt": "2020-01-10T09:41:20Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/common/validation/SourceDestValidatorTests.java", "diffHunk": "@@ -464,21 +478,11 @@ public void testCheck_GivenDestIndexIsAliasThatMatchesMultipleIndices() throws I\n                 CLUSTER_STATE,\n                 new String[] { SOURCE_1 },\n                 DEST_ALIAS,\n-                SourceDestValidator.NON_DEFERABLE_VALIDATIONS,\n+                Collections.emptyList(),", "originalCommit": "d21d9f02688fb11e1d9ec6e3e31876abe075131a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE2NTk0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/50841#discussion_r365165947", "bodyText": "These second assertions in those tests seem to be testing that when the validation is not present then the error does not occur. Previously the NON_DEFERABLE_VALIDATIONS set was passed around but I could not see what the difference was compared to passing an empty list. Does this make sense?", "author": "dimitris-athanasiou", "createdAt": "2020-01-10T10:22:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE0NzQyNg=="}], "type": "inlineReview"}, {"oid": "2f2fbccef092d659270e6e3c709016e7c816040a", "url": "https://github.com/elastic/elasticsearch/commit/2f2fbccef092d659270e6e3c709016e7c816040a", "message": "Reactivate commented out part of test", "committedDate": "2020-01-10T10:24:05Z", "type": "commit"}]}