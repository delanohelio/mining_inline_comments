{"pr_number": 65791, "pr_title": "Allow more legit cases in Metadata.Builder.validateDataStreams", "pr_createdAt": "2020-12-02T23:19:34Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65791", "timeline": [{"oid": "3b373f5e88dc0782803dfb1f84cca0433b85a40f", "url": "https://github.com/elastic/elasticsearch/commit/3b373f5e88dc0782803dfb1f84cca0433b85a40f", "message": "Allow more legit cases in Metadata.Builder.validateDataStreams", "committedDate": "2020-12-02T23:12:02Z", "type": "commit"}, {"oid": "fe6b7d0df481987e9e0352d0d8cf1e4cfe4548f0", "url": "https://github.com/elastic/elasticsearch/commit/fe6b7d0df481987e9e0352d0d8cf1e4cfe4548f0", "message": "formatting", "committedDate": "2020-12-02T23:19:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkxMjgzNA==", "url": "https://github.com/elastic/elasticsearch/pull/65791#discussion_r534912834", "bodyText": "Should the pattern be [0-9]+$ instead?  (so that it only matches if the generation is at the end of the index name)\nAlso maybe turn the pattern into a static pattern?", "author": "martijnvg", "createdAt": "2020-12-03T08:29:47Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java", "diffHunk": "@@ -1481,29 +1481,18 @@ public Metadata build() {\n         static void validateDataStreams(SortedMap<String, IndexAbstraction> indicesLookup, @Nullable DataStreamMetadata dsMetadata) {\n             if (dsMetadata != null) {\n                 for (DataStream ds : dsMetadata.dataStreams().values()) {\n-                    Map<String, IndexAbstraction> conflicts =\n-                        indicesLookup.subMap(DataStream.BACKING_INDEX_PREFIX + ds.getName() + \"-\",\n-                            DataStream.BACKING_INDEX_PREFIX + ds.getName() + \".\") // '.' is the char after '-'\n-                            .entrySet().stream()\n-                            .filter(entry -> {\n-                                if (entry.getValue().getType() != IndexAbstraction.Type.CONCRETE_INDEX) {\n-                                    return true;\n-                                } else {\n-                                    int indexNameCounter;\n-                                    try {\n-                                        indexNameCounter = IndexMetadata.parseIndexNameCounter(entry.getKey());\n-                                    } catch (IllegalArgumentException e) {\n-                                        // index name is not in the %s-%d+ format so it will not crash with backing indices\n-                                        return false;\n-                                    }\n-                                    return indexNameCounter > ds.getGeneration();\n-                                }\n-                            }).collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));\n+                    String prefix = DataStream.BACKING_INDEX_PREFIX + ds.getName() + \"-\";\n+                    Set<String> conflicts =\n+                        indicesLookup.subMap(prefix, DataStream.BACKING_INDEX_PREFIX + ds.getName() + \".\") // '.' is the char after '-'\n+                            .keySet().stream()\n+                            .filter(s -> s.substring(prefix.length()).matches(\"[0-9]+\"))", "originalCommit": "fe6b7d0df481987e9e0352d0d8cf1e4cfe4548f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE3OTkyMw==", "url": "https://github.com/elastic/elasticsearch/pull/65791#discussion_r535179923", "bodyText": "$ is not needed (matches return true only if whole region matches), but it won't hurt, I've added it.\nStatic pattern is good idea, I've added it as well.", "author": "probakowski", "createdAt": "2020-12-03T12:16:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkxMjgzNA=="}], "type": "inlineReview"}, {"oid": "69eab07e52a40ebab861f0be286030ec3606cd00", "url": "https://github.com/elastic/elasticsearch/commit/69eab07e52a40ebab861f0be286030ec3606cd00", "message": "review comments", "committedDate": "2020-12-03T12:15:41Z", "type": "commit"}, {"oid": "40e6cd9d8a1c5193ac2466ef98e1dc05f3ac0036", "url": "https://github.com/elastic/elasticsearch/commit/40e6cd9d8a1c5193ac2466ef98e1dc05f3ac0036", "message": "Merge branch 'master' into validate-datastream-name", "committedDate": "2020-12-07T11:05:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQxMDU1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/65791#discussion_r537410552", "bodyText": "nit: this needs formatting", "author": "andreidan", "createdAt": "2020-12-07T10:52:44Z", "path": "server/src/test/java/org/elasticsearch/cluster/metadata/MetadataTests.java", "diffHunk": "@@ -1148,11 +1148,25 @@ public void testValidateDataStreamsIgnoresIndicesWithoutCounter() {\n \n             )\n             .build();\n-        // don't expect any exception when validating against non-backing indinces that don't conform to the backing indices naming\n+        // don't expect any exception when validating against non-backing indices that don't conform to the backing indices naming\n         // convention\n         validateDataStreams(metadata.getIndicesLookup(), (DataStreamMetadata) metadata.customs().get(DataStreamMetadata.TYPE));\n     }\n \n+    public void testValidateDataStreamsAllowsNamesThatStartsWithPrefix() {\n+        String dataStreamName = \"foo-datastream\";\n+        Metadata metadata = Metadata.builder(createIndices(10, 10, dataStreamName).metadata)\n+            .put(\n+                new IndexMetadata.Builder(DataStream.BACKING_INDEX_PREFIX+dataStreamName + \"-something-000012\")", "originalCommit": "69eab07e52a40ebab861f0be286030ec3606cd00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQyNDEzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/65791#discussion_r537424135", "bodyText": "I don't think I understand this fix. Can you please document it a bit? I see we don't check the non concrete index anymore, but what else has changed?\nI also ported the testValidateDataStreamsAllowsNamesThatStartsWithPrefix on master and the test passes. Maybe this is supported already?", "author": "andreidan", "createdAt": "2020-12-07T11:14:16Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java", "diffHunk": "@@ -1481,29 +1483,18 @@ public Metadata build() {\n         static void validateDataStreams(SortedMap<String, IndexAbstraction> indicesLookup, @Nullable DataStreamMetadata dsMetadata) {\n             if (dsMetadata != null) {\n                 for (DataStream ds : dsMetadata.dataStreams().values()) {\n-                    Map<String, IndexAbstraction> conflicts =\n-                        indicesLookup.subMap(DataStream.BACKING_INDEX_PREFIX + ds.getName() + \"-\",\n-                            DataStream.BACKING_INDEX_PREFIX + ds.getName() + \".\") // '.' is the char after '-'\n-                            .entrySet().stream()\n-                            .filter(entry -> {\n-                                if (entry.getValue().getType() != IndexAbstraction.Type.CONCRETE_INDEX) {\n-                                    return true;\n-                                } else {\n-                                    int indexNameCounter;\n-                                    try {\n-                                        indexNameCounter = IndexMetadata.parseIndexNameCounter(entry.getKey());\n-                                    } catch (IllegalArgumentException e) {\n-                                        // index name is not in the %s-%d+ format so it will not crash with backing indices\n-                                        return false;\n-                                    }\n-                                    return indexNameCounter > ds.getGeneration();\n-                                }\n-                            }).collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));\n+                    String prefix = DataStream.BACKING_INDEX_PREFIX + ds.getName() + \"-\";\n+                    Set<String> conflicts =\n+                        indicesLookup.subMap(prefix, DataStream.BACKING_INDEX_PREFIX + ds.getName() + \".\") // '.' is the char after '-'\n+                            .keySet().stream()\n+                            .filter(s -> NUMBER_PATTERN.matcher(s.substring(prefix.length())).matches())\n+                            .filter(s -> IndexMetadata.parseIndexNameCounter(s) > ds.getGeneration())\n+                            .collect(Collectors.toSet());", "originalCommit": "40e6cd9d8a1c5193ac2466ef98e1dc05f3ac0036", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MTY0OA==", "url": "https://github.com/elastic/elasticsearch/pull/65791#discussion_r537461648", "bodyText": "test worked on master because generation number used in it was too small, it's fixed now so it should always pass with changes from this PR and always fail on current master", "author": "probakowski", "createdAt": "2020-12-07T12:17:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQyNDEzNQ=="}], "type": "inlineReview"}, {"oid": "16796ca618759e54568ea7d4dd1d4db57ff766c2", "url": "https://github.com/elastic/elasticsearch/commit/16796ca618759e54568ea7d4dd1d4db57ff766c2", "message": "make test actually testing anything", "committedDate": "2020-12-07T11:38:19Z", "type": "commit"}, {"oid": "50a8d701f506337ba55d479a70070479f3ee13ea", "url": "https://github.com/elastic/elasticsearch/commit/50a8d701f506337ba55d479a70070479f3ee13ea", "message": "formatting", "committedDate": "2020-12-07T11:43:48Z", "type": "commit"}]}