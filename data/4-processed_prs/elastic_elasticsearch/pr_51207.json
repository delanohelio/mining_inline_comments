{"pr_number": 51207, "pr_title": "Short circuited to MatchNone for non-participating  slice", "pr_createdAt": "2020-01-20T05:34:38Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51207", "timeline": [{"oid": "ede23e028a848f13b88416ce8addb305154e7c48", "url": "https://github.com/elastic/elasticsearch/commit/ede23e028a848f13b88416ce8addb305154e7c48", "message": "Short circuited to MatchNone for non-participating  slice\n\nIn case of numSlices = numShards , use a MatchNone query instead of\nboolean with a MatchNone - MUST clause", "committedDate": "2020-01-20T05:37:41Z", "type": "commit"}, {"oid": "ede23e028a848f13b88416ce8addb305154e7c48", "url": "https://github.com/elastic/elasticsearch/commit/ede23e028a848f13b88416ce8addb305154e7c48", "message": "Short circuited to MatchNone for non-participating  slice\n\nIn case of numSlices = numShards , use a MatchNone query instead of\nboolean with a MatchNone - MUST clause", "committedDate": "2020-01-20T05:37:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3NzQ5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/51207#discussion_r368977497", "bodyText": "nit: space before else", "author": "mayya-sharipova", "createdAt": "2020-01-21T12:41:32Z", "path": "server/src/main/java/org/elasticsearch/search/DefaultSearchContext.java", "diffHunk": "@@ -274,7 +275,12 @@ public Query buildFilteredQuery(Query query) {\n         }\n \n         if (sliceBuilder != null) {\n-            filters.add(sliceBuilder.toFilter(clusterService, request, queryShardContext));\n+            Query slicedQuery = sliceBuilder.toFilter(clusterService, request, queryShardContext);\n+            if ( slicedQuery instanceof MatchNoDocsQuery){\n+                return slicedQuery;\n+            }else {", "originalCommit": "ede23e028a848f13b88416ce8addb305154e7c48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3Nzc4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51207#discussion_r368977785", "bodyText": "extra space after (", "author": "mayya-sharipova", "createdAt": "2020-01-21T12:42:15Z", "path": "server/src/main/java/org/elasticsearch/search/DefaultSearchContext.java", "diffHunk": "@@ -274,7 +275,12 @@ public Query buildFilteredQuery(Query query) {\n         }\n \n         if (sliceBuilder != null) {\n-            filters.add(sliceBuilder.toFilter(clusterService, request, queryShardContext));\n+            Query slicedQuery = sliceBuilder.toFilter(clusterService, request, queryShardContext);\n+            if ( slicedQuery instanceof MatchNoDocsQuery){", "originalCommit": "ede23e028a848f13b88416ce8addb305154e7c48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3OTE3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/51207#discussion_r368979173", "bodyText": "nit: new DefaultSearchContext(3L, =>  new DefaultSearchContext(4L,", "author": "mayya-sharipova", "createdAt": "2020-01-21T12:45:33Z", "path": "server/src/test/java/org/elasticsearch/search/DefaultSearchContextTests.java", "diffHunk": "@@ -178,6 +182,20 @@ public void testPreProcess() throws Exception {\n             ParsedQuery parsedQuery = ParsedQuery.parsedMatchAllQuery();\n             context3.sliceBuilder(null).parsedQuery(parsedQuery).preProcess(false);\n             assertEquals(context3.query(), context3.buildFilteredQuery(parsedQuery.query()));\n+\n+            when(queryShardContext.getIndexSettings()).thenReturn(indexSettings);\n+            when(indexService.newQueryShardContext(anyInt(),anyObject(),anyObject(),anyString())).thenReturn(queryShardContext);\n+            when(queryShardContext.fieldMapper(anyString())).thenReturn(mock(MappedFieldType.class));\n+            when(shardSearchRequest.indexRoutings()).thenReturn(new String[0]);\n+\n+            DefaultSearchContext context4 = new DefaultSearchContext(3L, shardSearchRequest, target, searcher, null,", "originalCommit": "ede23e028a848f13b88416ce8addb305154e7c48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3OTQ2MA==", "url": "https://github.com/elastic/elasticsearch/pull/51207#discussion_r368979460", "bodyText": "Looks like, line 187 in not necessary", "author": "mayya-sharipova", "createdAt": "2020-01-21T12:46:14Z", "path": "server/src/test/java/org/elasticsearch/search/DefaultSearchContextTests.java", "diffHunk": "@@ -178,6 +182,20 @@ public void testPreProcess() throws Exception {\n             ParsedQuery parsedQuery = ParsedQuery.parsedMatchAllQuery();\n             context3.sliceBuilder(null).parsedQuery(parsedQuery).preProcess(false);\n             assertEquals(context3.query(), context3.buildFilteredQuery(parsedQuery.query()));\n+\n+            when(queryShardContext.getIndexSettings()).thenReturn(indexSettings);\n+            when(indexService.newQueryShardContext(anyInt(),anyObject(),anyObject(),anyString())).thenReturn(queryShardContext);", "originalCommit": "ede23e028a848f13b88416ce8addb305154e7c48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyMjkyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/51207#discussion_r369022929", "bodyText": "Thanks for review , it is not necessary. I think i added in my first attempt to include use-case with routings in test. I've reformatted code with intelliJ   - sorry for formatting issues.", "author": "nirmalc", "createdAt": "2020-01-21T14:13:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3OTQ2MA=="}], "type": "inlineReview"}, {"oid": "d3c838cc6dda37cb3828bb9d7b36ecc48eb87eb8", "url": "https://github.com/elastic/elasticsearch/commit/d3c838cc6dda37cb3828bb9d7b36ecc48eb87eb8", "message": "code review changes", "committedDate": "2020-01-21T14:09:19Z", "type": "commit"}, {"oid": "9f0ce3d9d012b8f699da46cc5a5ea502935ba6c0", "url": "https://github.com/elastic/elasticsearch/commit/9f0ce3d9d012b8f699da46cc5a5ea502935ba6c0", "message": "Removed unused namespace", "committedDate": "2020-01-21T15:23:47Z", "type": "commit"}, {"oid": "c9aba71e31053f23a66ad8490ccc8786d2a97af5", "url": "https://github.com/elastic/elasticsearch/commit/c9aba71e31053f23a66ad8490ccc8786d2a97af5", "message": "Merge branch 'master' into slicefix", "committedDate": "2020-01-22T16:45:47Z", "type": "commit"}]}