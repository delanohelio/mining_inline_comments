{"pr_number": 60533, "pr_title": "Implement runtime script ips", "pr_createdAt": "2020-07-31T16:27:06Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60533", "timeline": [{"oid": "3df2071517fc2aa3b2041bd9be0c37efb17c8ef7", "url": "https://github.com/elastic/elasticsearch/commit/3df2071517fc2aa3b2041bd9be0c37efb17c8ef7", "message": "Implement runtime script ips\n\nThis implements the `ip` typed runtime fields. They share a fair bit\nwith `string` runtime fields but we represent them as a `BytesRef`\ncontaining 128 bits so that the comparisons all happen in the same way\nas Lucene's `InetAddressPoint`.", "committedDate": "2020-07-31T16:26:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzcwOTU1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/60533#discussion_r463709552", "bodyText": "I'd like to grab this in a follow up because it is going to take some hacking to pass.", "author": "nik9000", "createdAt": "2020-07-31T16:27:53Z", "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/runtime_fields/50_ip.yml", "diffHunk": "@@ -0,0 +1,126 @@\n+---\n+setup:\n+  - do:\n+      indices.create:\n+        index: http_logs\n+        body:\n+          settings:\n+            number_of_shards: 1\n+            number_of_replicas: 0\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date\n+              message:\n+                type: keyword\n+              ip:\n+                type: runtime_script\n+                runtime_type: ip\n+                script:\n+                  source: |\n+                    String m = doc[\"message\"].value;\n+                    int end = m.indexOf(\" \");\n+                    stringValue(m.substring(0, end));\n+              # Test fetching from _source\n+              ip_from_source:\n+                type: runtime_script\n+                runtime_type: ip\n+                script:\n+                  source: |\n+                    String m = source[\"message\"];\n+                    int end = m.indexOf(\" \");\n+                    stringValue(m.substring(0, end));\n+              # Test emitting many values\n+              ip_many:\n+                type: runtime_script\n+                runtime_type: ip\n+                script:\n+                  source: |\n+                    String m = doc[\"message\"].value;\n+                    int end = m.indexOf(\" \");\n+                    end = m.lastIndexOf(\".\", end);\n+                    String stem = m.substring(0, end + 1);\n+                    for (int i = 0; i < 5; i++) {\n+                      stringValue(stem + i);\n+                    }\n+  - do:\n+      bulk:\n+        index: http_logs\n+        refresh: true\n+        body: |\n+          {\"index\":{}}\n+          {\"timestamp\": \"1998-04-30T14:30:17-05:00\", \"message\" : \"40.135.0.0 - - [1998-04-30T14:30:17-05:00] \\\"GET /images/hm_bg.jpg HTTP/1.0\\\" 200 24736\"}\n+          {\"index\":{}}\n+          {\"timestamp\": \"1998-04-30T14:30:53-05:00\", \"message\" : \"232.0.0.0 - - [1998-04-30T14:30:53-05:00] \\\"GET /images/hm_bg.jpg HTTP/1.0\\\" 200 24736\"}\n+          {\"index\":{}}\n+          {\"timestamp\": \"1998-04-30T14:31:12-05:00\", \"message\" : \"26.1.0.0 - - [1998-04-30T14:31:12-05:00] \\\"GET /images/hm_bg.jpg HTTP/1.0\\\" 200 24736\"}\n+          {\"index\":{}}\n+          {\"timestamp\": \"1998-04-30T14:31:19-05:00\", \"message\" : \"247.37.0.0 - - [1998-04-30T14:31:19-05:00] \\\"GET /french/splash_inet.html HTTP/1.0\\\" 200 3781\"}\n+          {\"index\":{}}\n+          {\"timestamp\": \"1998-04-30T14:31:22-05:00\", \"message\" : \"247.37.0.0 - - [1998-04-30T14:31:22-05:00] \\\"GET /images/hm_nbg.jpg HTTP/1.0\\\" 304 0\"}\n+          {\"index\":{}}\n+          {\"timestamp\": \"1998-04-30T14:31:27-05:00\", \"message\" : \"252.0.0.0 - - [1998-04-30T14:31:27-05:00] \\\"GET /images/hm_bg.jpg HTTP/1.0\\\" 200 24736\"}\n+\n+\n+---\n+\"get mapping\":\n+  - do:\n+      indices.get_mapping:\n+        index: http_logs\n+  - match: {http_logs.mappings.properties.ip.type: runtime_script }\n+  - match: {http_logs.mappings.properties.ip.runtime_type: ip }\n+  - match:\n+      http_logs.mappings.properties.ip.script.source: |\n+        String m = doc[\"message\"].value;\n+        int end = m.indexOf(\" \");\n+        stringValue(m.substring(0, end));\n+  - match: {http_logs.mappings.properties.ip.script.lang: painless }\n+\n+---\n+\"docvalue_fields\":\n+  - do:\n+      search:\n+        index: http_logs\n+        body:\n+          sort: timestamp\n+          docvalue_fields: [ip, ip_from_source, ip_many]\n+  - match: {hits.total.value: 6}\n+  - match: {hits.hits.0.fields.ip: [\"40.135.0.0\"] }\n+  - match: {hits.hits.0.fields.ip_from_source: [\"40.135.0.0\"] }\n+  - match:\n+      hits.hits.0.fields.ip_many:\n+        - 40.135.0.0\n+        - 40.135.0.1\n+        - 40.135.0.2\n+        - 40.135.0.3\n+        - 40.135.0.4\n+\n+---\n+\"terms agg\":\n+  - do:\n+      search:\n+        index: http_logs\n+        body:\n+          aggs:\n+            ip:\n+              terms:\n+                field: ip\n+  - match: {hits.total.value: 6}\n+  - match: {aggregations.ip.buckets.0.key: 247.37.0.0}\n+  - match: {aggregations.ip.buckets.0.doc_count: 2}\n+  - match: {aggregations.ip.buckets.1.key: 26.1.0.0}\n+  - match: {aggregations.ip.buckets.1.doc_count: 1}\n+\n+---\n+\"term query\":\n+  - do:\n+      search:\n+        index: http_logs\n+        body:\n+          query:\n+            term:\n+              ip: 252.0.0.0\n+  - match: {hits.total.value: 1}\n+  - match: {hits.hits.0._source.timestamp: 1998-04-30T14:31:27-05:00}\n+\n+# TODO tests for using the ip in a script. there is almost certainly whitelist \"fun\" here.", "originalCommit": "3df2071517fc2aa3b2041bd9be0c37efb17c8ef7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0ODYyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/60533#discussion_r464648621", "bodyText": "been thinking about these static methods that we are sharing here and there: should we have a better way to formalize the fact that runtime fields share some bits with their corresponding concrete field? e.g. should they share some base class or something along those lines? Or would it make any sense for runtime field type to extend its corresponding concrete field type? probably both are bad ideas, but probably good to look into what the alternatives are.", "author": "javanna", "createdAt": "2020-08-03T20:36:55Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/IpFieldMapper.java", "diffHunk": "@@ -221,6 +222,26 @@ public Query termsQuery(List<?> values, QueryShardContext context) {\n         @Override\n         public Query rangeQuery(Object lowerTerm, Object upperTerm, boolean includeLower, boolean includeUpper, QueryShardContext context) {\n             failIfNotIndexed();\n+            return rangeQuery(\n+                lowerTerm,\n+                upperTerm,\n+                includeLower,\n+                includeUpper,\n+                (lower, upper) -> InetAddressPoint.newRangeQuery(name(), lower, upper)\n+            );\n+        }\n+\n+        /**\n+         * Processes query bounds into {@code long}s and delegates the\n+         * provided {@code builder} to build a range query.\n+         */\n+        public static Query rangeQuery(", "originalCommit": "3df2071517fc2aa3b2041bd9be0c37efb17c8ef7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1MDE3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/60533#discussion_r465950171", "bodyText": "I talked with @javanna and we decided that we should keep this in mind, but we don't really have a cleaner way to do it for now. There are certainly other ways, but they aren't obviously cleaner.", "author": "nik9000", "createdAt": "2020-08-05T19:22:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0ODYyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0ODkyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/60533#discussion_r464648925", "bodyText": "s/most/must ?", "author": "javanna", "createdAt": "2020-08-03T20:37:35Z", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/IpScriptFieldScript.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields;\n+\n+import org.apache.lucene.document.InetAddressPoint;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.ArrayUtil;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.common.network.InetAddresses;\n+import org.elasticsearch.index.mapper.IpFieldMapper;\n+import org.elasticsearch.painless.spi.Whitelist;\n+import org.elasticsearch.painless.spi.WhitelistLoader;\n+import org.elasticsearch.script.ScriptContext;\n+import org.elasticsearch.script.ScriptFactory;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.IOException;\n+import java.net.Inet4Address;\n+import java.net.Inet6Address;\n+import java.net.InetAddress;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Script producing IP addresses. Unlike the other {@linkplain AbstractScriptFieldScript}s\n+ * which deal with their native java objects this converts its values to the same format\n+ * that Lucene uses to store its fields, {@link InetAddressPoint}. There are a few compelling\n+ * reasons to do this:\n+ * <ul>\n+ * <li>{@link Inet4Address}es and {@link Inet6Address} are not comparable with one another.\n+ * That is correct in some contexts, but not for our queries. Our queries most consider the", "originalCommit": "3df2071517fc2aa3b2041bd9be0c37efb17c8ef7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1NTQwNw==", "url": "https://github.com/elastic/elasticsearch/pull/60533#discussion_r465955407", "bodyText": "\ud83d\udc4d", "author": "nik9000", "createdAt": "2020-08-05T19:32:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0ODkyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY1MDMzOA==", "url": "https://github.com/elastic/elasticsearch/pull/60533#discussion_r464650338", "bodyText": "double checking that this is the name you meant to use. I struggle to see what this class does", "author": "javanna", "createdAt": "2020-08-03T20:40:36Z", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/fielddata/ScriptIpScriptDocValues.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.fielddata;\n+\n+import org.apache.lucene.document.InetAddressPoint;\n+import org.elasticsearch.common.bytes.BytesArray;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.network.InetAddresses;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+import org.elasticsearch.xpack.runtimefields.IpScriptFieldScript;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+\n+public class ScriptIpScriptDocValues extends ScriptDocValues<String> {", "originalCommit": "3df2071517fc2aa3b2041bd9be0c37efb17c8ef7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1MDUyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/60533#discussion_r465950525", "bodyText": "It is a pretty terrible name! I talked with @javanna and it will think it over some more. Or more it so it is a bit more obvious.", "author": "nik9000", "createdAt": "2020-08-05T19:22:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY1MDMzOA=="}], "type": "inlineReview"}, {"oid": "fad406b7624a60d3cbfd441bdfb223ba744b887c", "url": "https://github.com/elastic/elasticsearch/commit/fad406b7624a60d3cbfd441bdfb223ba744b887c", "message": "Merge branch 'feature/runtime_fields' into script_field_ip", "committedDate": "2020-08-05T19:29:48Z", "type": "commit"}, {"oid": "563bf0139d84032fabcfc7b50305ddf846e13923", "url": "https://github.com/elastic/elasticsearch/commit/563bf0139d84032fabcfc7b50305ddf846e13923", "message": "words are hard", "committedDate": "2020-08-05T19:32:14Z", "type": "commit"}, {"oid": "81733cd638110162883abe037f624749920ee2f4", "url": "https://github.com/elastic/elasticsearch/commit/81733cd638110162883abe037f624749920ee2f4", "message": "Update", "committedDate": "2020-08-05T19:52:08Z", "type": "commit"}, {"oid": "22bdb5cc07e2bcc19372d12d85abd237ba168025", "url": "https://github.com/elastic/elasticsearch/commit/22bdb5cc07e2bcc19372d12d85abd237ba168025", "message": "Test", "committedDate": "2020-08-05T19:54:26Z", "type": "commit"}]}