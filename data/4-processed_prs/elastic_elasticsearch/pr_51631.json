{"pr_number": 51631, "pr_title": "Stop policy on last PhaseCompleteStep instead of TerminalPolic\u2026", "pr_createdAt": "2020-01-29T17:05:40Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51631", "timeline": [{"oid": "3adf3c783643dc906fb585f2852a6b1e822ab9b7", "url": "https://github.com/elastic/elasticsearch/commit/3adf3c783643dc906fb585f2852a6b1e822ab9b7", "message": "Stop policy on last PhaseCompleteStep instead of TerminalPolicyStep\n\nCurrently when an ILM policy finishes its execution, the index moves into the `TerminalPolicyStep`,\ndenoted by a completed/completed/completed phase/action/step lifecycle execution state.\n\nThis commit changes the behavior so that the index lifecycle execution state halts at the last\nconfigured phase's `PhaseCompleteStep`, so for instance, if an index were configured with a policy\ncontaining a `hot` and `cold` phase, the index would stop at the `cold/complete/complete`\n`PhaseCompleteStep`. This allows an ILM user to update the policy to add any later phases and have\nindices configured to use that policy pick up execution at the newly added \"later\" phase. For\nexample, if a `delete` phase were added to the policy specified about, the index would then move\nfrom `cold/complete/complete` into the `delete` phase.\n\nRelates to #48431", "committedDate": "2020-01-29T17:01:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg1NDI3NA==", "url": "https://github.com/elastic/elasticsearch/pull/51631#discussion_r372854274", "bodyText": "nice catch", "author": "andreidan", "createdAt": "2020-01-30T09:58:23Z", "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/ExecuteStepsUpdateTask.java", "diffHunk": "@@ -140,7 +140,7 @@ public ClusterState execute(final ClusterState currentState) throws IOException\n                         if (logger.isTraceEnabled()) {\n                             logger.trace(\"[{}] condition not met ({}) [{}], returning existing state (info: {})\",\n                                 index.getName(), currentStep.getClass().getSimpleName(), currentStep.getKey(),\n-                                Strings.toString(stepInfo));\n+                                stepInfo == null ? \"null\" : Strings.toString(stepInfo));", "originalCommit": "3adf3c783643dc906fb585f2852a6b1e822ab9b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NjE5OA==", "url": "https://github.com/elastic/elasticsearch/pull/51631#discussion_r372886198", "bodyText": "I'm probably missing something, but why is the phase null in these CCR cases? Should this be the name of the phase that was completed? (ie. warm)", "author": "andreidan", "createdAt": "2020-01-30T11:04:09Z", "path": "x-pack/plugin/ilm/qa/multi-cluster/src/test/java/org/elasticsearch/xpack/ilm/CCRIndexLifecycleIT.java", "diffHunk": "@@ -341,7 +342,7 @@ public void testAliasReplicatedOnShrink() throws Exception {\n             assertBusy(() -> assertOK(client().performRequest(new Request(\"HEAD\", \"/\" + shrunkenIndexName + \"/_alias/\" + indexName))));\n \n             // Wait for the index to complete its policy\n-            assertBusy(() -> assertILMPolicy(client(), shrunkenIndexName, policyName, \"completed\", \"completed\", \"completed\"));\n+            assertBusy(() -> assertILMPolicy(client(), shrunkenIndexName, policyName, null, \"complete\", \"complete\"));", "originalCommit": "3adf3c783643dc906fb585f2852a6b1e822ab9b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEwOTM3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/51631#discussion_r373109373", "bodyText": "null just means that the matcher should not try to match the phase. The reason for that is that in these tests there is a randomBoolean() check that randomly uses either a lone warm phase or adds a cold phase, so we don't assert whether it's always cold or warm (it's only important that it reaches the complete step)", "author": "dakrone", "createdAt": "2020-01-30T18:11:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NjE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQxMDM4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/51631#discussion_r373410383", "bodyText": "Ah gotcha, the implementation skips that assertion if the phase is null. Thanks for the clarification, this makes sense", "author": "andreidan", "createdAt": "2020-01-31T10:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NjE5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NzAwOA==", "url": "https://github.com/elastic/elasticsearch/pull/51631#discussion_r372887008", "bodyText": "should we document this as it seems like a behavioural change for the move-to-step api?", "author": "andreidan", "createdAt": "2020-01-30T11:06:00Z", "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycleTransition.java", "diffHunk": "@@ -78,7 +78,8 @@ public static void validateTransition(IndexMetaData idxMeta, Step.StepKey curren\n                 \"], currently: [\" + realKey + \"]\");\n         }\n \n-        if (stepRegistry.stepExists(indexPolicySetting, newStepKey) == false) {\n+        // Always allow moving to the terminal step, even if it doesn't exist in the policy", "originalCommit": "3adf3c783643dc906fb585f2852a6b1e822ab9b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEwOTkyNA==", "url": "https://github.com/elastic/elasticsearch/pull/51631#discussion_r373109924", "bodyText": "I looked through the documentation and didn't see any actual documentation about the terminal step already, so I'm not sure we want to get into that deep of technical behavior in our docs? What do you think?", "author": "dakrone", "createdAt": "2020-01-30T18:12:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NzAwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQxMzY3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/51631#discussion_r373413671", "bodyText": "Ah, sure, let's not mention it then", "author": "andreidan", "createdAt": "2020-01-31T10:33:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NzAwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg5MTQyMA==", "url": "https://github.com/elastic/elasticsearch/pull/51631#discussion_r372891420", "bodyText": "was the deletion of this test intentional? if so shall we do it in a different commit so we have some semantics as to why it was removed?", "author": "andreidan", "createdAt": "2020-01-30T11:16:17Z", "path": "x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/ilm/IndexLifecycleInitialisationTests.java", "diffHunk": "@@ -374,80 +374,7 @@ public void testMasterDedicatedDataDedicated() throws Exception {\n         assertBusy(() -> {\n             LifecycleExecutionState lifecycleState = LifecycleExecutionState.fromIndexMetadata(client().admin().cluster()\n                 .prepareState().execute().actionGet().getState().getMetaData().index(\"test\"));\n-            assertThat(lifecycleState.getStep(), equalTo(TerminalPolicyStep.KEY.getName()));\n-        });\n-    }\n-\n-    public void testMasterFailover() throws Exception {", "originalCommit": "3adf3c783643dc906fb585f2852a6b1e822ab9b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzExMDYyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/51631#discussion_r373110621", "bodyText": "This was a test that didn't really do much outside of what we already have tested elsewhere, in addition, it was using a fake step that was near impossible to make work with the way that phases now operate, so I removed it.\nI don't think a separate commit is that useful, since this ends up squashed into a single commit anyway?", "author": "dakrone", "createdAt": "2020-01-30T18:14:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg5MTQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQxNDk3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/51631#discussion_r373414971", "bodyText": "Ah, yeah, you're right (not sure how should we signal the reasoning behind these changes for future reference - commit message?)", "author": "andreidan", "createdAt": "2020-01-31T10:36:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg5MTQyMA=="}], "type": "inlineReview"}]}