{"pr_number": 51776, "pr_title": "Remove custom \"execute\" method from SClass user node in Painless", "pr_createdAt": "2020-01-31T21:25:25Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51776", "timeline": [{"oid": "e42292c8b92c1c5bc16d0265dfaf5911e580d642", "url": "https://github.com/elastic/elasticsearch/commit/e42292c8b92c1c5bc16d0265dfaf5911e580d642", "message": "add data to functions required to move execute method out of class", "committedDate": "2020-01-31T20:09:18Z", "type": "commit"}, {"oid": "27f21d01c0f96ab005f50e5a99fe517c5b803b99", "url": "https://github.com/elastic/elasticsearch/commit/27f21d01c0f96ab005f50e5a99fe517c5b803b99", "message": "fix tests", "committedDate": "2020-01-31T20:53:27Z", "type": "commit"}, {"oid": "111edd4f4c9568d48c25438a526733545aab1ac5", "url": "https://github.com/elastic/elasticsearch/commit/111edd4f4c9568d48c25438a526733545aab1ac5", "message": "remove dead code", "committedDate": "2020-01-31T21:11:05Z", "type": "commit"}, {"oid": "eb03654550088c0e1b524abebb6288deed4286ea", "url": "https://github.com/elastic/elasticsearch/commit/eb03654550088c0e1b524abebb6288deed4286ea", "message": "fixes", "committedDate": "2020-01-31T21:11:22Z", "type": "commit"}, {"oid": "53217b661b2064f49f1aa43b58788e82844c259e", "url": "https://github.com/elastic/elasticsearch/commit/53217b661b2064f49f1aa43b58788e82844c259e", "message": "fixes", "committedDate": "2020-01-31T21:13:05Z", "type": "commit"}, {"oid": "b12215f7e148551246196c6a3b419273d8147aea", "url": "https://github.com/elastic/elasticsearch/commit/b12215f7e148551246196c6a3b419273d8147aea", "message": "add another todo", "committedDate": "2020-01-31T21:27:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MjYyOA==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374362628", "bodyText": "Consider cutting an issue for TODOs like this so they don't get lost, then ref the issue in the comment.", "author": "stu-elastic", "createdAt": "2020-02-03T21:53:55Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/MethodWriter.java", "diffHunk": "@@ -125,7 +125,8 @@ public void writeStatementOffset(Location location) {\n         int offset = location.getOffset();\n         // ensure we don't have duplicate stuff going in here. can catch bugs\n         // (e.g. nodes get assigned wrong offsets by antlr walker)\n-        assert statements.get(offset) == false;\n+        // TODO: introduce a way to ignore internal statements so this assert is not triggered", "originalCommit": "b12215f7e148551246196c6a3b419273d8147aea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM4NzI5MA==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374387290", "bodyText": "Done: #51836", "author": "jdconrad", "createdAt": "2020-02-03T22:52:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MjYyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc4MDM3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374780372", "bodyText": "Pls reference from TODO.", "author": "stu-elastic", "createdAt": "2020-02-04T16:29:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MjYyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MzI1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374363255", "bodyText": "Consider adding a comment here \"handle execute\" or something similar.", "author": "stu-elastic", "createdAt": "2020-02-03T21:55:22Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/antlr/Walker.java", "diffHunk": "@@ -251,7 +252,20 @@ public ANode visitSource(SourceContext ctx) {\n             statements.add((AStatement)visit(statement));\n         }\n \n-        return new SClass(scriptClassInfo, sourceName, sourceText, debugStream, location(ctx), functions, statements);\n+        String returnCanonicalTypeName = PainlessLookupUtility.typeToCanonicalTypeName(scriptClassInfo.getExecuteMethodReturnType());\n+        List<String> paramTypes = new ArrayList<>();", "originalCommit": "b12215f7e148551246196c6a3b419273d8147aea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM4OTMwNw==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374389307", "bodyText": "Added.", "author": "jdconrad", "createdAt": "2020-02-03T22:57:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MzI1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MzYyNg==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374363626", "bodyText": "true, false, false, true\n\nugh.", "author": "stu-elastic", "createdAt": "2020-02-03T21:56:11Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/antlr/Walker.java", "diffHunk": "@@ -251,7 +252,20 @@ public ANode visitSource(SourceContext ctx) {\n             statements.add((AStatement)visit(statement));\n         }\n \n-        return new SClass(scriptClassInfo, sourceName, sourceText, debugStream, location(ctx), functions, statements);\n+        String returnCanonicalTypeName = PainlessLookupUtility.typeToCanonicalTypeName(scriptClassInfo.getExecuteMethodReturnType());\n+        List<String> paramTypes = new ArrayList<>();\n+        List<String> paramNames = new ArrayList<>();\n+\n+        for (ScriptClassInfo.MethodArgument argument : scriptClassInfo.getExecuteArguments()) {\n+            paramTypes.add(PainlessLookupUtility.typeToCanonicalTypeName(argument.getClazz()));\n+            paramNames.add(argument.getName());\n+        }\n+\n+        SFunction execute = new SFunction(location(ctx), returnCanonicalTypeName, \"execute\", paramTypes, paramNames, new SBlock(\n+                location(ctx), statements), true, false, false, true);", "originalCommit": "b12215f7e148551246196c6a3b419273d8147aea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM4OTQ5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374389495", "bodyText": "Agreed. I would like to change these to an enum in a future PR.", "author": "jdconrad", "createdAt": "2020-02-03T22:57:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2MzYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2NDgyNA==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374364824", "bodyText": "?", "author": "stu-elastic", "createdAt": "2020-02-03T21:58:38Z", "path": "modules/lang-painless/src/test/java/org/elasticsearch/painless/node/NodeToStringTests.java", "diffHunk": "@@ -19,39 +19,16 @@\n \n package org.elasticsearch.painless.node;\n \n-import org.elasticsearch.painless.CompilerSettings;\n-import org.elasticsearch.painless.FeatureTestObject;\n-import org.elasticsearch.painless.Scope.Variable;\n-import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.Operation;\n-import org.elasticsearch.painless.ScriptClassInfo;\n-import org.elasticsearch.painless.action.PainlessExecuteAction.PainlessTestScript;\n-import org.elasticsearch.painless.antlr.Walker;\n-import org.elasticsearch.painless.lookup.PainlessCast;\n-import org.elasticsearch.painless.lookup.PainlessClass;\n-import org.elasticsearch.painless.lookup.PainlessField;\n-import org.elasticsearch.painless.lookup.PainlessLookup;\n-import org.elasticsearch.painless.lookup.PainlessLookupBuilder;\n-import org.elasticsearch.painless.lookup.PainlessLookupUtility;\n-import org.elasticsearch.painless.lookup.PainlessMethod;\n-import org.elasticsearch.painless.spi.Whitelist;\n-import org.elasticsearch.painless.spi.WhitelistLoader;\n import org.elasticsearch.test.ESTestCase;\n \n-import java.util.ArrayList;\n-import java.util.Arrays;\n-import java.util.List;\n-import java.util.Map;\n-\n-import static java.util.Collections.emptyList;\n-import static java.util.Collections.singletonList;\n+// TODO: fix these tests to match new node structure\n \n /**\n  * Tests {@link Object#toString} implementations on all extensions of {@link ANode}.\n  */\n public class NodeToStringTests extends ESTestCase {\n \n-    public void testEAssignment() {\n+    /*public void testEAssignment() {", "originalCommit": "b12215f7e148551246196c6a3b419273d8147aea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2ODg4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374368889", "bodyText": "Can you do Test.skip(\"ignoring rapidly changing tests until quiescent, see issue #XXXX\")", "author": "stu-elastic", "createdAt": "2020-02-03T22:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2NDgyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxNzE1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374417156", "bodyText": "Done: #51842", "author": "jdconrad", "createdAt": "2020-02-04T00:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM2NDgyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3Mjg2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374372866", "bodyText": "doAutoReturn implies an action, perhaps autoReturnEnabled?", "author": "stu-elastic", "createdAt": "2020-02-03T22:16:45Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/node/SFunction.java", "diffHunk": "@@ -56,19 +59,23 @@\n \n     org.objectweb.asm.commons.Method method;\n \n+    private ScriptRoot scriptRoot;\n     private boolean methodEscape;\n \n     public SFunction(Location location, String rtnType, String name,\n             List<String> paramTypes, List<String> paramNames,\n-            SBlock block, boolean synthetic) {\n+            SBlock block, boolean isInternal, boolean isStatic, boolean synthetic, boolean doAutoReturn) {", "originalCommit": "b12215f7e148551246196c6a3b419273d8147aea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwNTk1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374405957", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-02-03T23:47:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3Mjg2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3NTc2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374375766", "bodyText": "Even with the name change, a comment on the semantics of this var would be useful since it's a non-standard extension.", "author": "stu-elastic", "createdAt": "2020-02-03T22:23:33Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/FunctionNode.java", "diffHunk": "@@ -47,14 +63,25 @@ public BlockNode getBlockNode() {\n \n     /* ---- end tree structure, begin node data ---- */\n \n+    private ScriptRoot scriptRoot;\n     private String name;\n     private Class<?> returnType;\n     private List<Class<?>> typeParameters = new ArrayList<>();\n     private List<String> parameterNames = new ArrayList<>();\n+    private boolean isStatic;\n     private boolean isSynthetic;\n+    private boolean doAutoReturn;", "originalCommit": "b12215f7e148551246196c6a3b419273d8147aea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQwNTk4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374405985", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-02-03T23:48:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3NTc2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3ODU5NA==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374378594", "bodyText": "Can you do something like:\ntry {\n\n} catch (XXX) {\n\n}", "author": "stu-elastic", "createdAt": "2020-02-03T22:30:18Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/FunctionNode.java", "diffHunk": "@@ -136,6 +185,34 @@ protected void write(ClassWriter classWriter, MethodWriter methodWriter, Globals\n         methodWriter = classWriter.newMethodWriter(access, method);\n         methodWriter.visitCode();\n \n+        // TODO: do not specialize for execute\n+        Label startTry = new Label();", "originalCommit": "b12215f7e148551246196c6a3b419273d8147aea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3ODc5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374378792", "bodyText": "It's hard to understand what's going here without some clarity.", "author": "stu-elastic", "createdAt": "2020-02-03T22:30:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3ODU5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3OTE4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374379187", "bodyText": "Just a sign-post here would be fine.  \"Start handling try\"", "author": "stu-elastic", "createdAt": "2020-02-03T22:31:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3ODU5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxMDQxNw==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374410417", "bodyText": "Added several comments to clarify what's happening in this code", "author": "jdconrad", "createdAt": "2020-02-04T00:03:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM3ODU5NA=="}], "type": "inlineReview"}, {"oid": "b724725d53d16c3f9bc067d3ddbb8470018caa57", "url": "https://github.com/elastic/elasticsearch/commit/b724725d53d16c3f9bc067d3ddbb8470018caa57", "message": "Merge branch 'master' into trees5", "committedDate": "2020-02-03T22:49:30Z", "type": "commit"}, {"oid": "3479ef0f3c3b19a33e39bdb7828b1e01373f589a", "url": "https://github.com/elastic/elasticsearch/commit/3479ef0f3c3b19a33e39bdb7828b1e01373f589a", "message": "response to PR comments.", "committedDate": "2020-02-04T00:27:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc4MTQ1MA==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374781450", "bodyText": "no need to change, but I usually do something like\n// TODO: do not specialize for execute, see #51841", "author": "stu-elastic", "createdAt": "2020-02-04T16:31:22Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/node/SFunction.java", "diffHunk": "@@ -122,9 +149,17 @@ void analyze(ScriptRoot scriptRoot) {\n         block.analyze(scriptRoot, functionScope.newLocalScope());\n         methodEscape = block.methodEscape;\n \n-        if (!methodEscape && returnType != void.class) {\n-            throw createError(new IllegalArgumentException(\"Not all paths provide a return value for method [\" + name + \"].\"));\n+        if (methodEscape == false && isAutoReturnEnabled == false && returnType != void.class) {\n+            throw createError(new IllegalArgumentException(\"not all paths provide a return value \" +\n+                    \"for function [\" + name + \"] with [\" + typeParameters.size() + \"] parameters\"));\n+        }\n+\n+        // TODO: do not specialize for execute", "originalCommit": "3479ef0f3c3b19a33e39bdb7828b1e01373f589a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgwMDc4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51776#discussion_r374800789", "bodyText": "Got it. Will do for the next instance.", "author": "jdconrad", "createdAt": "2020-02-04T17:03:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc4MTQ1MA=="}], "type": "inlineReview"}]}