{"pr_number": 52494, "pr_title": "Make DeleteStep retryable", "pr_createdAt": "2020-02-18T21:47:50Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52494", "timeline": [{"oid": "d819b0e26af4d4e0ba4a065d447dc7843d7bb74e", "url": "https://github.com/elastic/elasticsearch/commit/d819b0e26af4d4e0ba4a065d447dc7843d7bb74e", "message": "Make DeleteStep retryable\n\nThis change marks `DeleteStep` as retryable and adds test to make sure we really can invoke it again.", "committedDate": "2020-02-18T21:44:21Z", "type": "commit"}, {"oid": "34dfafdae1f7ef572d7738abd00b426d342e5079", "url": "https://github.com/elastic/elasticsearch/commit/34dfafdae1f7ef572d7738abd00b426d342e5079", "message": "Fix unused import", "committedDate": "2020-02-18T21:53:38Z", "type": "commit"}, {"oid": "c3b765f8aebe1427aa6d12c8ad0ad9cec4fb5de8", "url": "https://github.com/elastic/elasticsearch/commit/c3b765f8aebe1427aa6d12c8ad0ad9cec4fb5de8", "message": "revert unneeded changes", "committedDate": "2020-02-18T22:35:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE4NjYzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/52494#discussion_r381186635", "bodyText": "as this scenario would be fairly straightforward to create in an integration test I propose we convert this to one. What do you think?", "author": "andreidan", "createdAt": "2020-02-19T09:57:00Z", "path": "x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/ilm/DeleteStepTests.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.ilm;\n+\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.ClusterStateObserver;\n+import org.elasticsearch.cluster.metadata.IndexMetaData;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.test.ESSingleNodeTestCase;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.xpack.core.ilm.AsyncActionStep;\n+import org.elasticsearch.xpack.core.ilm.DeleteStep;\n+import org.elasticsearch.xpack.core.ilm.Step.StepKey;\n+\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import static org.elasticsearch.cluster.metadata.IndexMetaData.SETTING_READ_ONLY;\n+import static org.elasticsearch.cluster.metadata.IndexMetaData.SETTING_READ_ONLY_ALLOW_DELETE;\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+import static org.hamcrest.Matchers.is;\n+\n+public class DeleteStepTests extends ESSingleNodeTestCase {\n+\n+    public void testDeleteStepRetriesOnError() throws Exception {\n+        assertAcked(client().admin().indices().prepareCreate(\"test\")\n+            .setSettings(Settings.builder().put(SETTING_READ_ONLY_ALLOW_DELETE, false).put(SETTING_READ_ONLY, true))", "originalCommit": "c3b765f8aebe1427aa6d12c8ad0ad9cec4fb5de8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7fda67b3528484da7e24548db5b02043d807cd09", "url": "https://github.com/elastic/elasticsearch/commit/7fda67b3528484da7e24548db5b02043d807cd09", "message": "test reworked", "committedDate": "2020-02-19T13:16:00Z", "type": "commit"}]}