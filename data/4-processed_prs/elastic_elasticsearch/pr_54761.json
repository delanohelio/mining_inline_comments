{"pr_number": 54761, "pr_title": "Fix transport serialization of AsyncSearchUser", "pr_createdAt": "2020-04-04T08:49:31Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54761", "timeline": [{"oid": "a646e42a7c7129d7d7638d253b0bf0b6cdc38af9", "url": "https://github.com/elastic/elasticsearch/commit/a646e42a7c7129d7d7638d253b0bf0b6cdc38af9", "message": "Fix transport serialization of AsyncSearchUser\n\nThis change ensures that the AsyncSearchUser is correctly (de)serialized when\nan action executed by this user is sent to a remote node internally (via transport client).", "committedDate": "2020-04-04T08:46:11Z", "type": "commit"}, {"oid": "9ddb7ae633a04e0829e3323c9b8af95c7431a070", "url": "https://github.com/elastic/elasticsearch/commit/9ddb7ae633a04e0829e3323c9b8af95c7431a070", "message": "Merge branch 'master' into async_search_syer_serialization", "committedDate": "2020-04-04T19:31:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc3ODY3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/54761#discussion_r403778679", "bodyText": "Is this a concern for bwc? I think, in a mixed cluster environment, writing and reading this information from different versions would fail. But current failures don't seem to be releavant. I don't know the details about async search work. Is it 8.0 only?", "author": "ywangd", "createdAt": "2020-04-06T00:17:18Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/user/InternalUserSerializationHelper.java", "diffHunk": "@@ -36,6 +38,9 @@ public static void writeTo(User user, StreamOutput output) throws IOException {\n         } else if (XPackSecurityUser.is(user)) {\n             output.writeBoolean(true);\n             output.writeString(XPackSecurityUser.NAME);\n+        } else if (AsyncSearchUser.is(user)) {", "originalCommit": "9ddb7ae633a04e0829e3323c9b8af95c7431a070", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg5NzUxMw==", "url": "https://github.com/elastic/elasticsearch/pull/54761#discussion_r403897513", "bodyText": "It's a 7.7 feature so nodes in this version will be able to run _async_search and to create the new .async-search index. For the few cases where an older node could be  picked, the IllegalStateException thrown by readFrom should be enough to handle failures gracefully ?", "author": "jimczi", "createdAt": "2020-04-06T07:59:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc3ODY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA5MzE1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/54761#discussion_r404093156", "bodyText": "This is indeed a problem, but I don't see an easy way around it.\nWith the proposed changes, async search won't work until the master node is also upgraded, even if the coordinating node is. Does this sound reasonable to you @jimczi ? Are there other issues that would prevent the async search feature to work in a mixed cluster (assuming no, but maybe there is :) )?", "author": "albertzaharovits", "createdAt": "2020-04-06T13:33:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc3ODY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA5OTc5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54761#discussion_r404099795", "bodyText": "That's fine IMO. We expect users to upgrade clusters entirely before using new features . Also, Kibana will use _async_search internally so the ES cluster must be fully upgraded before upgrading Kibana.", "author": "jimczi", "createdAt": "2020-04-06T13:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc3ODY3OQ=="}], "type": "inlineReview"}, {"oid": "c64d8b5fc35f07ea11e23f5312bd6f1453cecdbb", "url": "https://github.com/elastic/elasticsearch/commit/c64d8b5fc35f07ea11e23f5312bd6f1453cecdbb", "message": "Merge branch 'master' into async_search_syer_serialization", "committedDate": "2020-04-06T13:44:34Z", "type": "commit"}, {"oid": "82f9222ca553c1d60b6bb298accc630b538e0687", "url": "https://github.com/elastic/elasticsearch/commit/82f9222ca553c1d60b6bb298accc630b538e0687", "message": "run the security rest tests with 2 nodes", "committedDate": "2020-04-06T15:57:13Z", "type": "commit"}]}