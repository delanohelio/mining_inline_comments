{"pr_number": 65415, "pr_title": "Fix AbstractClient#execute Listener Leak", "pr_createdAt": "2020-11-24T11:57:36Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65415", "timeline": [{"oid": "73680151651361aa9340678cba5d9d4ffcc00998", "url": "https://github.com/elastic/elasticsearch/commit/73680151651361aa9340678cba5d9d4ffcc00998", "message": "Fix AbstractClient#execute Listener Leak\n\nThis was observed in #65405 due to trying to locally execute a\ntask whose parent was already cancelled but is a general issue.\n\nWe should not throw from APIs that consume a listener as this may\nlike in this case leak the listener in that case.\nRather than fixing the specific case of #65405 this fixes the\nabstract client overall to avoid other such leaks.\n\nCloses #65405", "committedDate": "2020-11-24T11:26:18Z", "type": "commit"}, {"oid": "50f96d9260300f01ed26d7a764f18aebf14b5531", "url": "https://github.com/elastic/elasticsearch/commit/50f96d9260300f01ed26d7a764f18aebf14b5531", "message": "Merge remote-tracking branch 'elastic/master' into 65405", "committedDate": "2020-11-25T10:46:21Z", "type": "commit"}, {"oid": "4df3eb004b0e3df8a350332bb01d78c41d275d90", "url": "https://github.com/elastic/elasticsearch/commit/4df3eb004b0e3df8a350332bb01d78c41d275d90", "message": "handle exception downstream", "committedDate": "2020-11-25T11:32:43Z", "type": "commit"}, {"oid": "ac68d1a6ccff6c4440cbef6d97cf99ed135606c4", "url": "https://github.com/elastic/elasticsearch/commit/ac68d1a6ccff6c4440cbef6d97cf99ed135606c4", "message": "stricter assertions and fix tests", "committedDate": "2020-11-25T11:56:17Z", "type": "commit"}, {"oid": "62da102dd80cd591ef891e44f2128c463e4f37f5", "url": "https://github.com/elastic/elasticsearch/commit/62da102dd80cd591ef891e44f2128c463e4f37f5", "message": "moar fixes", "committedDate": "2020-11-25T12:14:46Z", "type": "commit"}, {"oid": "0765ada6016b1bbfbec1aaee7a7654e9dbf5231b", "url": "https://github.com/elastic/elasticsearch/commit/0765ada6016b1bbfbec1aaee7a7654e9dbf5231b", "message": "moar test weirdness", "committedDate": "2020-11-25T12:32:03Z", "type": "commit"}, {"oid": "c84e1a09d04e813ceaa3e3096b87b029ef11b52b", "url": "https://github.com/elastic/elasticsearch/commit/c84e1a09d04e813ceaa3e3096b87b029ef11b52b", "message": "fix", "committedDate": "2020-11-25T13:40:21Z", "type": "commit"}, {"oid": "d99f75c941cd69c0c6c67d8ebb75c502348c9c0a", "url": "https://github.com/elastic/elasticsearch/commit/d99f75c941cd69c0c6c67d8ebb75c502348c9c0a", "message": "noise", "committedDate": "2020-11-25T14:33:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQzMjAxOA==", "url": "https://github.com/elastic/elasticsearch/pull/65415#discussion_r530432018", "bodyText": "At least in tests, this ensures no double invocation of the listener with the new try-catch\nI suppose technically speaking it would be nice to do the same for the override below that uses a TaskListener but I chose not to for now since as you can see this already required fixing up a number of spots that relied on the listener's onResponse throwing and handling exceptions upstream.", "author": "original-brownbear", "createdAt": "2020-11-25T14:53:22Z", "path": "server/src/main/java/org/elasticsearch/client/node/NodeClient.java", "diffHunk": "@@ -91,7 +97,22 @@ void doExecute(ActionType<Response> action, Request request, ActionListener<Resp\n                 Response extends ActionResponse\n             > Task executeLocally(ActionType<Response> action, Request request, ActionListener<Response> listener) {\n         return taskManager.registerAndExecute(\"transport\", transportAction(action), request,\n-            (t, r) -> listener.onResponse(r), (t, e) -> listener.onFailure(e));\n+                (t, r) -> {", "originalCommit": "d99f75c941cd69c0c6c67d8ebb75c502348c9c0a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQzMzA4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/65415#discussion_r530433086", "bodyText": "I think without further refactoring of the signature of registerAndExecute and this is about as low as we can go on the stack in terms of passing these exceptions to the listener directly. Otherwise we'll have to adjust a non-trivial number of spots that make use of the returned Task from that method.", "author": "original-brownbear", "createdAt": "2020-11-25T14:54:44Z", "path": "server/src/main/java/org/elasticsearch/client/node/NodeClient.java", "diffHunk": "@@ -79,7 +79,13 @@ public void close() {\n     public <Request extends ActionRequest, Response extends ActionResponse>\n     void doExecute(ActionType<Response> action, Request request, ActionListener<Response> listener) {\n         // Discard the task because the Client interface doesn't use it.\n-        executeLocally(action, request, listener);\n+        try {\n+            executeLocally(action, request, listener);\n+        } catch (Exception e) {", "originalCommit": "d99f75c941cd69c0c6c67d8ebb75c502348c9c0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM3OTM5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/65415#discussion_r532379396", "bodyText": "Yeah, I agree that it will be a non-trivial change. We would have to always return a task I think and then fail it immediately. Or change the signature.\nI think we could possibly catch TaskCancelledException here instead to make it specific that the \"hack\" is for this case only?", "author": "henningandersen", "createdAt": "2020-11-30T06:53:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQzMzA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM4NjgwMA==", "url": "https://github.com/elastic/elasticsearch/pull/65415#discussion_r532386800", "bodyText": "I think we can't just catch that exception here since we also have the case of org.elasticsearch.tasks.TaskManager#register throwing IllegalArgumentException at least (that actually does reproduce in a test even). Also, technically speaking the in-line task cancellation in org.elasticsearch.tasks.TaskManager#registerCancellableTask could throw any exception if the parent is banned already so I figured I'd just catch all the things here for now?", "author": "original-brownbear", "createdAt": "2020-11-30T07:15:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQzMzA4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQzNTY0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/65415#discussion_r530435641", "bodyText": "Obvious spot where we have a non-wrap listener and this would just bubble up all the way if the request is executed locally on SAME.", "author": "original-brownbear", "createdAt": "2020-11-25T14:58:02Z", "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/EnrichPolicyRunner.java", "diffHunk": "@@ -124,7 +124,12 @@ public void run() {\n         client.admin().indices().getIndex(getIndexRequest, new ActionListener<>() {\n             @Override\n             public void onResponse(GetIndexResponse getIndexResponse) {\n-                validateMappings(getIndexResponse);\n+                try {\n+                    validateMappings(getIndexResponse);", "originalCommit": "d99f75c941cd69c0c6c67d8ebb75c502348c9c0a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQzNzExNQ==", "url": "https://github.com/elastic/elasticsearch/pull/65415#discussion_r530437115", "bodyText": "Failing the listener on a missing index isn't strictly necessary here because I added the try-catch around prepareCreateIndexRequest anyway but I figured it more nicely motivates this TODO and follow-up cleanup to the logic here that previously relied on the exceptions just bubbling up all the way.", "author": "original-brownbear", "createdAt": "2020-11-25T15:00:02Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/shrink/TransportResizeAction.java", "diffHunk": "@@ -88,32 +88,43 @@ protected void masterOperation(Task task, final ResizeRequest resizeRequest, fin\n         // there is no need to fetch docs stats for split but we keep it simple and do it anyway for simplicity of the code\n         final String sourceIndex = indexNameExpressionResolver.resolveDateMathExpression(resizeRequest.getSourceIndex());\n         final String targetIndex = indexNameExpressionResolver.resolveDateMathExpression(resizeRequest.getTargetIndexRequest().index());\n+\n+        final IndexMetadata sourceMetadata = state.metadata().index(sourceIndex);\n+        if (sourceMetadata == null) {\n+            listener.onFailure(new IndexNotFoundException(sourceIndex));\n+            return;\n+        }\n+\n         IndicesStatsRequestBuilder statsRequestBuilder = client.admin().indices().prepareStats(sourceIndex).clear().setDocs(true);\n         IndicesStatsRequest statsRequest = statsRequestBuilder.request();\n         statsRequest.setParentTask(clusterService.localNode().getId(), task.getId());\n+        // TODO: only fetch indices stats for shrink type resize requests and move request validation (outside of doc counts) to before", "originalCommit": "d99f75c941cd69c0c6c67d8ebb75c502348c9c0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM3ODIxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/65415#discussion_r532378219", "bodyText": "Not sure moving out the validation is the right move, I would probably rather move it in to the cluster state update to avoid surprising effects (like soft deletes being changed right after us checking it). Did not look deeply into this, but I think I would prefer to not add the todo here.", "author": "henningandersen", "createdAt": "2020-11-30T06:49:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQzNzExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM4ODgxNw==", "url": "https://github.com/elastic/elasticsearch/pull/65415#discussion_r532388817", "bodyText": "Fair point this is slightly broken to begin with I guess. I'll drop that part of the TODO, I still think it'd be valid to avoid fetching the shard stats needlessly.", "author": "original-brownbear", "createdAt": "2020-11-30T07:21:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQzNzExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ0NTkyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/65415#discussion_r530445929", "bodyText": "This was pretty dirty to begin with. Without this change and the change in the test verifying client we would always throw an NPE in the background (form trying to serialize a null response)  but that would never fail any tests.\nWith the new assertions that wasn't possible anymore so I had to fix this up here.", "author": "original-brownbear", "createdAt": "2020-11-25T15:12:01Z", "path": "x-pack/plugin/async-search/src/test/java/org/elasticsearch/xpack/search/RestSubmitAsyncSearchActionTests.java", "diffHunk": "@@ -88,7 +89,7 @@ public void testParameters() throws Exception {\n             assertThat(request, instanceOf(SubmitAsyncSearchRequest.class));\n             assertThat(valueAccessor.apply((SubmitAsyncSearchRequest) request), equalTo(expectedValue));\n             executeCalled.set(true);\n-            return null;\n+            return new AsyncSearchResponse(\"\", randomBoolean(), randomBoolean(), 0L, 0L);", "originalCommit": "d99f75c941cd69c0c6c67d8ebb75c502348c9c0a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM4MjE0OA==", "url": "https://github.com/elastic/elasticsearch/pull/65415#discussion_r532382148", "bodyText": "I think we should add a comment to javadoc here and in the other executeLocally that they can throw TaskCancelledException?", "author": "henningandersen", "createdAt": "2020-11-30T07:02:04Z", "path": "server/src/main/java/org/elasticsearch/client/node/NodeClient.java", "diffHunk": "@@ -79,7 +79,13 @@ public void close() {\n     public <Request extends ActionRequest, Response extends ActionResponse>\n     void doExecute(ActionType<Response> action, Request request, ActionListener<Response> listener) {\n         // Discard the task because the Client interface doesn't use it.\n-        executeLocally(action, request, listener);\n+        try {\n+            executeLocally(action, request, listener);\n+        } catch (Exception e) {\n+            // #executeLocally returns the task and throws RuntimeException if it fails to register the task so we forward them to listener\n+            // since this API does not concern itself with the specifics of the task handling\n+            listener.onFailure(e);\n+        }\n     }\n \n     /**", "originalCommit": "d99f75c941cd69c0c6c67d8ebb75c502348c9c0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM5MDI3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/65415#discussion_r532390277", "bodyText": "++", "author": "original-brownbear", "createdAt": "2020-11-30T07:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM4MjE0OA=="}], "type": "inlineReview"}, {"oid": "e37d7c1fa83ccffaf527bedd4414ba3a06ef0e48", "url": "https://github.com/elastic/elasticsearch/commit/e37d7c1fa83ccffaf527bedd4414ba3a06ef0e48", "message": "Merge remote-tracking branch 'elastic/master' into 65405", "committedDate": "2020-11-30T07:12:30Z", "type": "commit"}, {"oid": "074c29fe1bbe8fcd56f0600314f44cbf1a1fc018", "url": "https://github.com/elastic/elasticsearch/commit/074c29fe1bbe8fcd56f0600314f44cbf1a1fc018", "message": "cut back on TODO", "committedDate": "2020-11-30T07:24:28Z", "type": "commit"}, {"oid": "4568132e8edb868f2f6c6400ea3b1fa58a30fbb6", "url": "https://github.com/elastic/elasticsearch/commit/4568132e8edb868f2f6c6400ea3b1fa58a30fbb6", "message": "docs and try stricter catch", "committedDate": "2020-11-30T07:44:23Z", "type": "commit"}, {"oid": "7be5d1c445dd62a1f2282f49cd738c42b97dc2b2", "url": "https://github.com/elastic/elasticsearch/commit/7be5d1c445dd62a1f2282f49cd738c42b97dc2b2", "message": "fix another spot", "committedDate": "2020-11-30T08:49:00Z", "type": "commit"}, {"oid": "c440ef07f57aaa2f5badb0e500686221dd58dfae", "url": "https://github.com/elastic/elasticsearch/commit/c440ef07f57aaa2f5badb0e500686221dd58dfae", "message": "another fix", "committedDate": "2020-11-30T08:52:13Z", "type": "commit"}, {"oid": "adf535de770cf3519fbc04ceed522f48ed628138", "url": "https://github.com/elastic/elasticsearch/commit/adf535de770cf3519fbc04ceed522f48ed628138", "message": "gotta fix watcher", "committedDate": "2020-11-30T09:47:36Z", "type": "commit"}, {"oid": "526777087b04ec4a63ead3accdefb2178f224deb", "url": "https://github.com/elastic/elasticsearch/commit/526777087b04ec4a63ead3accdefb2178f224deb", "message": "cleaner", "committedDate": "2020-11-30T10:28:40Z", "type": "commit"}]}