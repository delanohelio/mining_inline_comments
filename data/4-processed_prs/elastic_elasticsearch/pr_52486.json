{"pr_number": 52486, "pr_title": "Generalize how queries on `_index` are handled at rewrite time", "pr_createdAt": "2020-02-18T17:51:05Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52486", "timeline": [{"oid": "db1a07982bd6cddcc0fbc0c0d6583d0d3a374c76", "url": "https://github.com/elastic/elasticsearch/commit/db1a07982bd6cddcc0fbc0c0d6583d0d3a374c76", "message": "Introduce a `singleton_keyword` field.\n\nThis field is a specialization of the `keyword` field for the case when all\ndocuments have the same value. It typically performs more efficiently than\nkeywords at query time by figuring out whether all or none of the documents\nmatch at rewrite time, like `term` queries on `_index`.\n\nThe name is up for discussion. I liked including `keyword` in it, so that we\nstill have room for a `singleton_numeric` in the future. However I'm unsure\nwhether to call it `singleton`, `constant` or something else, any opinions?\n\nFor this field there is a choice between\n 1. accepting values in `_source` when they are equal to the value configured\n    in mappings, but rejecting mapping updates\n 2. rejecting values in `_source` but then allowing updates to the value that\n    is configured in the mapping\nThis commit implements option 1, so that it is possible to reindex from/to an\nindex that has the field mapped as a keyword with no changes to the source.", "committedDate": "2019-11-29T10:11:35Z", "type": "commit"}, {"oid": "c253ce758841a9561b4a002bca95bfce2d3aa078", "url": "https://github.com/elastic/elasticsearch/commit/c253ce758841a9561b4a002bca95bfce2d3aa078", "message": "iter", "committedDate": "2019-11-29T15:19:19Z", "type": "commit"}, {"oid": "abf27f1e4d558e6919491b77cb6505636c7499ab", "url": "https://github.com/elastic/elasticsearch/commit/abf27f1e4d558e6919491b77cb6505636c7499ab", "message": "Rename to `constant_keyword`.", "committedDate": "2019-11-29T15:24:52Z", "type": "commit"}, {"oid": "002fe968f83805672d52a749616942ec446a5519", "url": "https://github.com/elastic/elasticsearch/commit/002fe968f83805672d52a749616942ec446a5519", "message": "iter", "committedDate": "2019-11-29T15:40:10Z", "type": "commit"}, {"oid": "c6738d80cd2287d80f39924b2e3f10bdd6373be5", "url": "https://github.com/elastic/elasticsearch/commit/c6738d80cd2287d80f39924b2e3f10bdd6373be5", "message": "iter", "committedDate": "2019-11-29T15:58:28Z", "type": "commit"}, {"oid": "b7b894e01025bd1cf94fe15be68d122eb663c47c", "url": "https://github.com/elastic/elasticsearch/commit/b7b894e01025bd1cf94fe15be68d122eb663c47c", "message": "iter", "committedDate": "2019-11-29T16:25:08Z", "type": "commit"}, {"oid": "f5f288e748a891e2e95f57b95dffc4fbfeb1ab93", "url": "https://github.com/elastic/elasticsearch/commit/f5f288e748a891e2e95f57b95dffc4fbfeb1ab93", "message": "Merge branch 'master' into feature/singleton_keyword_field", "committedDate": "2019-11-29T16:25:31Z", "type": "commit"}, {"oid": "a86ad8a82c0d67e440dcf0f9b5eb0cf7c7255ef9", "url": "https://github.com/elastic/elasticsearch/commit/a86ad8a82c0d67e440dcf0f9b5eb0cf7c7255ef9", "message": "iter", "committedDate": "2019-11-29T17:08:20Z", "type": "commit"}, {"oid": "a5949d6f38479875ef7594ecdaa07516a096f593", "url": "https://github.com/elastic/elasticsearch/commit/a5949d6f38479875ef7594ecdaa07516a096f593", "message": "iter", "committedDate": "2019-12-02T09:25:40Z", "type": "commit"}, {"oid": "c9c43aa038e76d893a25538bc6d7ea98eeae51ac", "url": "https://github.com/elastic/elasticsearch/commit/c9c43aa038e76d893a25538bc6d7ea98eeae51ac", "message": "iter", "committedDate": "2019-12-02T09:56:38Z", "type": "commit"}, {"oid": "6b907c25df8f04c8cfeb8fc0fef1f2a36bdc8585", "url": "https://github.com/elastic/elasticsearch/commit/6b907c25df8f04c8cfeb8fc0fef1f2a36bdc8585", "message": "iter", "committedDate": "2019-12-02T12:57:44Z", "type": "commit"}, {"oid": "779d128d8198cf50b4cb9447e709b7a582ac1071", "url": "https://github.com/elastic/elasticsearch/commit/779d128d8198cf50b4cb9447e709b7a582ac1071", "message": "unused imports", "committedDate": "2019-12-02T13:30:25Z", "type": "commit"}, {"oid": "51dc11889ea74d3b267633456e046d70354ebe68", "url": "https://github.com/elastic/elasticsearch/commit/51dc11889ea74d3b267633456e046d70354ebe68", "message": "add javadocs", "committedDate": "2019-12-02T13:36:45Z", "type": "commit"}, {"oid": "8da5b6c4a43ca5edc100d47edbf4a05bbbaac4cb", "url": "https://github.com/elastic/elasticsearch/commit/8da5b6c4a43ca5edc100d47edbf4a05bbbaac4cb", "message": "iter", "committedDate": "2019-12-02T15:24:22Z", "type": "commit"}, {"oid": "af4a55a32a0f029ce35a7ebe3252ddf458ac8d88", "url": "https://github.com/elastic/elasticsearch/commit/af4a55a32a0f029ce35a7ebe3252ddf458ac8d88", "message": "Merge branch 'master' into feature/singleton_keyword_field", "committedDate": "2019-12-03T17:31:20Z", "type": "commit"}, {"oid": "d1b71f4e96c2f8cd533c116c483acf9a33eefee1", "url": "https://github.com/elastic/elasticsearch/commit/d1b71f4e96c2f8cd533c116c483acf9a33eefee1", "message": "More docs.", "committedDate": "2019-12-03T19:31:30Z", "type": "commit"}, {"oid": "f8ddbf7182b3540d79a1b97794a0d4c6ca728089", "url": "https://github.com/elastic/elasticsearch/commit/f8ddbf7182b3540d79a1b97794a0d4c6ca728089", "message": "Merge branch 'master' into feature/singleton_keyword_field", "committedDate": "2020-01-08T14:41:58Z", "type": "commit"}, {"oid": "d34630320d23b1269ec2270c229c13450f92ead8", "url": "https://github.com/elastic/elasticsearch/commit/d34630320d23b1269ec2270c229c13450f92ead8", "message": "address review comments", "committedDate": "2020-01-10T13:57:46Z", "type": "commit"}, {"oid": "c378cdf35c386d03da63875e301728386cd734fd", "url": "https://github.com/elastic/elasticsearch/commit/c378cdf35c386d03da63875e301728386cd734fd", "message": "Fix failures.", "committedDate": "2020-01-10T17:46:32Z", "type": "commit"}, {"oid": "59fd6b094ef7ebdc8be50b54e52459d0a1f32a86", "url": "https://github.com/elastic/elasticsearch/commit/59fd6b094ef7ebdc8be50b54e52459d0a1f32a86", "message": "Merge branch 'master' into feature/singleton_keyword_field", "committedDate": "2020-02-14T17:55:15Z", "type": "commit"}, {"oid": "4592af2c57a7438d7a6afe3605cf535bd01e244f", "url": "https://github.com/elastic/elasticsearch/commit/4592af2c57a7438d7a6afe3605cf535bd01e244f", "message": "Merge branch 'master' into enhancement/simplify_in_rewrite", "committedDate": "2020-02-14T17:57:26Z", "type": "commit"}, {"oid": "ab70f103fc67f38b5b90ebc05d76ed7d58ddfc69", "url": "https://github.com/elastic/elasticsearch/commit/ab70f103fc67f38b5b90ebc05d76ed7d58ddfc69", "message": "iter", "committedDate": "2020-02-14T18:03:47Z", "type": "commit"}, {"oid": "0b29a433cab7142cb75d0c902d4329214da77a65", "url": "https://github.com/elastic/elasticsearch/commit/0b29a433cab7142cb75d0c902d4329214da77a65", "message": "iter", "committedDate": "2020-02-14T18:05:45Z", "type": "commit"}, {"oid": "936f8831e113c542687f42adf3e6c8e06e30cb2c", "url": "https://github.com/elastic/elasticsearch/commit/936f8831e113c542687f42adf3e6c8e06e30cb2c", "message": "iter", "committedDate": "2020-02-18T07:59:58Z", "type": "commit"}, {"oid": "44a71703789c090b77bb7d7675f818df19239c77", "url": "https://github.com/elastic/elasticsearch/commit/44a71703789c090b77bb7d7675f818df19239c77", "message": "Undo renames.", "committedDate": "2020-02-18T12:50:13Z", "type": "commit"}, {"oid": "7639d34f200676817906e3e3b24fec202b7e1d4d", "url": "https://github.com/elastic/elasticsearch/commit/7639d34f200676817906e3e3b24fec202b7e1d4d", "message": "iter", "committedDate": "2020-02-18T16:25:00Z", "type": "commit"}, {"oid": "fba9ca3b4bb966d123afaaeddd0dbce7584950c6", "url": "https://github.com/elastic/elasticsearch/commit/fba9ca3b4bb966d123afaaeddd0dbce7584950c6", "message": "iter", "committedDate": "2020-02-18T17:40:55Z", "type": "commit"}, {"oid": "a284be94000e0e8857679295454a6f0f4d04f6db", "url": "https://github.com/elastic/elasticsearch/commit/a284be94000e0e8857679295454a6f0f4d04f6db", "message": "Merge branch 'master' into enhancement/simplify_in_rewrite", "committedDate": "2020-02-19T07:47:48Z", "type": "commit"}, {"oid": "f9a23e2c77adb3c1d0089b8bb36234d5e226d6cc", "url": "https://github.com/elastic/elasticsearch/commit/f9a23e2c77adb3c1d0089b8bb36234d5e226d6cc", "message": "iter", "committedDate": "2020-02-21T08:55:26Z", "type": "commit"}, {"oid": "b312407b918f4a86e54f2567076f0932caac2024", "url": "https://github.com/elastic/elasticsearch/commit/b312407b918f4a86e54f2567076f0932caac2024", "message": "iter", "committedDate": "2020-02-21T10:20:33Z", "type": "commit"}, {"oid": "437315da0de41ac00abe5df78bfb82264355c51d", "url": "https://github.com/elastic/elasticsearch/commit/437315da0de41ac00abe5df78bfb82264355c51d", "message": "Merge branch 'master' into enhancement/simplify_in_rewrite", "committedDate": "2020-02-21T10:21:53Z", "type": "commit"}, {"oid": "3f9493019d5c7d9aeaa7db3c73c4c21ce21e2a33", "url": "https://github.com/elastic/elasticsearch/commit/3f9493019d5c7d9aeaa7db3c73c4c21ce21e2a33", "message": "iter", "committedDate": "2020-02-21T11:03:39Z", "type": "commit"}, {"oid": "7cd5c6dad42c579e11c26f08f910caa27889d5e4", "url": "https://github.com/elastic/elasticsearch/commit/7cd5c6dad42c579e11c26f08f910caa27889d5e4", "message": "iter", "committedDate": "2020-02-21T12:47:43Z", "type": "commit"}, {"oid": "51f7b3c453ed6e3d234e20ce71c06fbef93b3585", "url": "https://github.com/elastic/elasticsearch/commit/51f7b3c453ed6e3d234e20ce71c06fbef93b3585", "message": "iter", "committedDate": "2020-02-21T13:28:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQyOTE3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/52486#discussion_r382429175", "bodyText": "Small comment, could just be if (context != null && context.fieldMapper(...)) { ... }", "author": "jtibshirani", "createdAt": "2020-02-21T07:19:05Z", "path": "server/src/main/java/org/elasticsearch/index/query/IdsQueryBuilder.java", "diffHunk": "@@ -136,17 +134,28 @@ public String getWriteableName() {\n         return NAME;\n     }\n \n+    @Override\n+    protected QueryBuilder doRewrite(QueryRewriteContext queryRewriteContext) throws IOException {\n+        if (ids.isEmpty()) {\n+            return new MatchNoneQueryBuilder();\n+        }\n+        QueryShardContext context = queryRewriteContext.convertToShardContext();\n+        if (context != null) {", "originalCommit": "a284be94000e0e8857679295454a6f0f4d04f6db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc5MzE5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/52486#discussion_r382793195", "bodyText": "This looks unused, I think it can just be deleted?", "author": "jtibshirani", "createdAt": "2020-02-21T20:35:15Z", "path": "modules/percolator/src/main/java/org/elasticsearch/percolator/PercolatorFieldMapper.java", "diffHunk": "@@ -491,7 +488,13 @@ static Query toQuery(QueryShardContext context, boolean mapUnmappedFieldsAsStrin\n         // as an analyzed string.\n         context.setAllowUnmappedFields(false);\n         context.setMapUnmappedFieldAsString(mapUnmappedFieldsAsString);\n-        return queryBuilder.toQuery(context);\n+    }\n+\n+    static Query parseQuery(QueryShardContext context, boolean mapUnmappedFieldsAsString, XContentParser parser) throws IOException {", "originalCommit": "51f7b3c453ed6e3d234e20ce71c06fbef93b3585", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc5ODk4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52486#discussion_r382798987", "bodyText": "For my knowledge, I'm wondering why this change (and the ones to AbstractQueryTestCase) were necessary.", "author": "jtibshirani", "createdAt": "2020-02-21T20:49:32Z", "path": "server/src/main/java/org/elasticsearch/index/query/AbstractQueryBuilder.java", "diffHunk": "@@ -103,7 +104,7 @@ public final Query toQuery(QueryShardContext context) throws IOException {\n             if (boost != DEFAULT_BOOST) {\n                 if (query instanceof SpanQuery) {\n                     query = new SpanBoostQuery((SpanQuery) query, boost);\n-                } else {", "originalCommit": "51f7b3c453ed6e3d234e20ce71c06fbef93b3585", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzczNzcwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/52486#discussion_r383737709", "bodyText": "I made this change as a way to keep tests simple. For instance here is what ConstantScoreQueryBuilderTests#doAssertLuceneQuery looks like in master today.\n    @Override\n    protected void doAssertLuceneQuery(ConstantScoreQueryBuilder queryBuilder, Query query, QueryShardContext context) throws IOException {\n        Query innerQuery = queryBuilder.innerQuery().toQuery(context);\n        if (innerQuery == null) {\n            assertThat(query, nullValue());\n        } else {\n            assertThat(query, instanceOf(ConstantScoreQuery.class));\n            ConstantScoreQuery constantScoreQuery = (ConstantScoreQuery) query;\n            assertThat(constantScoreQuery.getQuery(), instanceOf(innerQuery.getClass()));\n        }\n    }\n\nThis test only worked because most queries on unmapped fields would create the same query as on a keyword field. But with this change, queries on unmapped fields get rewritten as a MatchNoneQueryBuilder. And when its inner query rewrites to a MatchNoneQueryBuilder, ConstantScoreQueryBuilder itself rewrites to a MatchNoneQueryBuilder. So I updated the logic this way:\n    @Override\n    protected void doAssertLuceneQuery(ConstantScoreQueryBuilder queryBuilder, Query query, QueryShardContext context) throws IOException {\n        Query innerQuery = queryBuilder.innerQuery().rewrite(context).toQuery(context);\n        if (innerQuery == null) {\n            assertThat(query, nullValue());\n        } else if (innerQuery instanceof MatchNoDocsQuery) {\n            assertThat(query, instanceOf(MatchNoDocsQuery.class));\n        } else {\n            assertThat(query, instanceOf(ConstantScoreQuery.class));\n            ConstantScoreQuery constantScoreQuery = (ConstantScoreQuery) query;\n            assertThat(constantScoreQuery.getQuery(), instanceOf(innerQuery.getClass()));\n        }\n    }\n\nBut this fails if the inner query is wrapped in a BoostQuery. So I had to either change AbstractQueryBuilder to no longer wrap MatchNoDocsQuery with a boost, or change this test (and a couple other ones IIRC) to check whether the inner query might be wrapped inside a BoostQuery. I chose the former, which sounded simpler to me.", "author": "jpountz", "createdAt": "2020-02-25T08:58:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc5ODk4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA1MDg2OA==", "url": "https://github.com/elastic/elasticsearch/pull/52486#discussion_r384050868", "bodyText": "Thanks for the clear explanation!", "author": "jtibshirani", "createdAt": "2020-02-25T18:40:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc5ODk4Nw=="}], "type": "inlineReview"}, {"oid": "dc0bf444f4180bd25e6a923dea8ba702c712c1bd", "url": "https://github.com/elastic/elasticsearch/commit/dc0bf444f4180bd25e6a923dea8ba702c712c1bd", "message": "Merge branch 'master' into enhancement/simplify_in_rewrite", "committedDate": "2020-02-25T07:58:40Z", "type": "commit"}, {"oid": "15af22f2e23925ee42090cd005201f9a00d8124f", "url": "https://github.com/elastic/elasticsearch/commit/15af22f2e23925ee42090cd005201f9a00d8124f", "message": "Review comments.", "committedDate": "2020-02-25T08:41:14Z", "type": "commit"}, {"oid": "2b00751f5454cf89bc4b3eed6b39e9aeba19a7fc", "url": "https://github.com/elastic/elasticsearch/commit/2b00751f5454cf89bc4b3eed6b39e9aeba19a7fc", "message": "Merge branch 'master' into enhancement/simplify_in_rewrite", "committedDate": "2020-02-26T08:22:50Z", "type": "commit"}]}