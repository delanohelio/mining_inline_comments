{"pr_number": 50621, "pr_title": "Fix open/close race in ConnectionManagerTests", "pr_createdAt": "2020-01-03T17:58:11Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50621", "timeline": [{"oid": "cca1456a47e5e98dbad741824d83756689dbe559", "url": "https://github.com/elastic/elasticsearch/commit/cca1456a47e5e98dbad741824d83756689dbe559", "message": "Fix open/close race in ConnectionManagerTests\n\nCurrently we reuse the same test connection for all connection attempts\nin the testConcurrentConnectsAndDisconnects test. This means that if the\nconnection fails due to a pre-existing connection, the connection will\nbe closed impacting the state of all conenction attempts. This commit\nfixes the test, by returning a unique connection for each attempt.", "committedDate": "2020-01-03T17:51:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3MjY1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/50621#discussion_r362972651", "bodyText": "Should we rename this to just testConcurrentConnects? It doesn't obviously do any disconnecting.", "author": "DaveCTurner", "createdAt": "2020-01-03T21:49:33Z", "path": "server/src/test/java/org/elasticsearch/transport/ConnectionManagerTests.java", "diffHunk": "@@ -124,11 +124,10 @@ public void onNodeDisconnected(DiscoveryNode node, Transport.Connection connecti\n         assertEquals(1, nodeDisconnectedCount.get());\n     }\n \n-    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/49903\")\n     public void testConcurrentConnectsAndDisconnects() throws BrokenBarrierException, InterruptedException {", "originalCommit": "cca1456a47e5e98dbad741824d83756689dbe559", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3Mjc4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/50621#discussion_r362972789", "bodyText": "Could we keep track of all of these connections and assert that all but one of them has been closed when the dust has settled?", "author": "DaveCTurner", "createdAt": "2020-01-03T21:50:12Z", "path": "server/src/test/java/org/elasticsearch/transport/ConnectionManagerTests.java", "diffHunk": "@@ -124,11 +124,10 @@ public void onNodeDisconnected(DiscoveryNode node, Transport.Connection connecti\n         assertEquals(1, nodeDisconnectedCount.get());\n     }\n \n-    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/49903\")\n     public void testConcurrentConnectsAndDisconnects() throws BrokenBarrierException, InterruptedException {\n         DiscoveryNode node = new DiscoveryNode(\"\", new TransportAddress(InetAddress.getLoopbackAddress(), 0), Version.CURRENT);\n-        Transport.Connection connection = new TestConnect(node);\n         doAnswer(invocationOnMock -> {\n+            Transport.Connection connection = new TestConnect(node);", "originalCommit": "cca1456a47e5e98dbad741824d83756689dbe559", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3Mzc3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/50621#discussion_r362973777", "bodyText": "I think it would be good to have these three branches chosen with more equal probabilities (and similarly for the connection validator lambda). As it is, we only complete both listeners on the same thread one in every 10,000 runs I think.", "author": "DaveCTurner", "createdAt": "2020-01-03T21:54:04Z", "path": "server/src/test/java/org/elasticsearch/transport/ConnectionManagerTests.java", "diffHunk": "@@ -124,11 +124,10 @@ public void onNodeDisconnected(DiscoveryNode node, Transport.Connection connecti\n         assertEquals(1, nodeDisconnectedCount.get());\n     }\n \n-    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/49903\")\n     public void testConcurrentConnectsAndDisconnects() throws BrokenBarrierException, InterruptedException {\n         DiscoveryNode node = new DiscoveryNode(\"\", new TransportAddress(InetAddress.getLoopbackAddress(), 0), Version.CURRENT);\n-        Transport.Connection connection = new TestConnect(node);\n         doAnswer(invocationOnMock -> {\n+            Transport.Connection connection = new TestConnect(node);\n             ActionListener<Transport.Connection> listener = (ActionListener<Transport.Connection>) invocationOnMock.getArguments()[2];\n             if (rarely()) {", "originalCommit": "cca1456a47e5e98dbad741824d83756689dbe559", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2f8c7a50f411b0ffab4688a4ca95df17898918e7", "url": "https://github.com/elastic/elasticsearch/commit/2f8c7a50f411b0ffab4688a4ca95df17898918e7", "message": "Changes", "committedDate": "2020-01-07T16:11:08Z", "type": "commit"}, {"oid": "f08d6fff9611c493febf2e03cce5645450acdb00", "url": "https://github.com/elastic/elasticsearch/commit/f08d6fff9611c493febf2e03cce5645450acdb00", "message": "Merge remote-tracking branch 'upstream/master' into fix_connection_manager_test", "committedDate": "2020-01-07T16:27:14Z", "type": "commit"}, {"oid": "ffb4cf03904b0563976e9c58db5e5a0dbed5bce5", "url": "https://github.com/elastic/elasticsearch/commit/ffb4cf03904b0563976e9c58db5e5a0dbed5bce5", "message": "Fix", "committedDate": "2020-01-07T17:51:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg4Njk1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/50621#discussion_r363886956", "bodyText": "Sorry, I misled you, this can be zero if all 10 connection attempts fail.", "author": "DaveCTurner", "createdAt": "2020-01-07T18:28:54Z", "path": "server/src/test/java/org/elasticsearch/transport/ConnectionManagerTests.java", "diffHunk": "@@ -198,6 +207,16 @@ public void testConcurrentConnectsAndDisconnects() throws BrokenBarrierException\n         });\n \n         assertEquals(10, nodeConnectedCount.get() + nodeFailureCount.get());\n+\n+        // Only a single connection attempt should be open.\n+        long size = connections.stream().filter(c -> !c.isClosed()).count();\n+        assertEquals(1, size);", "originalCommit": "ffb4cf03904b0563976e9c58db5e5a0dbed5bce5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg4NzEyMw==", "url": "https://github.com/elastic/elasticsearch/pull/50621#discussion_r363887123", "bodyText": "== false \u2620\ufe0f", "author": "DaveCTurner", "createdAt": "2020-01-07T18:29:16Z", "path": "server/src/test/java/org/elasticsearch/transport/ConnectionManagerTests.java", "diffHunk": "@@ -198,6 +207,16 @@ public void testConcurrentConnectsAndDisconnects() throws BrokenBarrierException\n         });\n \n         assertEquals(10, nodeConnectedCount.get() + nodeFailureCount.get());\n+\n+        // Only a single connection attempt should be open.\n+        long size = connections.stream().filter(c -> !c.isClosed()).count();", "originalCommit": "ffb4cf03904b0563976e9c58db5e5a0dbed5bce5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9fc47e5fc73ed1c00bcd72178af7ca33b9dc1584", "url": "https://github.com/elastic/elasticsearch/commit/9fc47e5fc73ed1c00bcd72178af7ca33b9dc1584", "message": "Changes", "committedDate": "2020-01-08T17:14:48Z", "type": "commit"}, {"oid": "e30de267a7c635b27d9f7393280180e7c03430e3", "url": "https://github.com/elastic/elasticsearch/commit/e30de267a7c635b27d9f7393280180e7c03430e3", "message": "Merge remote-tracking branch 'upstream/master' into fix_connection_manager_test", "committedDate": "2020-01-08T17:56:20Z", "type": "commit"}]}