{"pr_number": 55422, "pr_title": "Test: MockScoreScript can be cacheable", "pr_createdAt": "2020-04-17T22:05:43Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55422", "timeline": [{"oid": "bbb1b44d8d17d1ed92c29a5c57d4f95babe83f2a", "url": "https://github.com/elastic/elasticsearch/commit/bbb1b44d8d17d1ed92c29a5c57d4f95babe83f2a", "message": "Test: MockScoreScript can be cacheable", "committedDate": "2020-04-17T22:04:03Z", "type": "commit"}, {"oid": "700334acf7508a8ce2bc19c64c5a00c0a6ac6bad", "url": "https://github.com/elastic/elasticsearch/commit/700334acf7508a8ce2bc19c64c5a00c0a6ac6bad", "message": "Update MockPainlessScriptEngine's MockScoreScript construction", "committedDate": "2020-04-17T22:12:08Z", "type": "commit"}, {"oid": "06b06e1560bddff0677fffa0a7a08161e49238f0", "url": "https://github.com/elastic/elasticsearch/commit/06b06e1560bddff0677fffa0a7a08161e49238f0", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into test/score-script-cacheable", "committedDate": "2020-04-17T22:12:32Z", "type": "commit"}, {"oid": "452bae2f6c9c557fc4c778fb486d25e2ad86d9f1", "url": "https://github.com/elastic/elasticsearch/commit/452bae2f6c9c557fc4c778fb486d25e2ad86d9f1", "message": "Update ScriptScoreQuery cacheability test", "committedDate": "2020-04-17T22:41:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5MTY3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/55422#discussion_r411591679", "bodyText": "\"script should query should be cacheable: \"  -> \"function script query should be cacheable\"", "author": "mayya-sharipova", "createdAt": "2020-04-20T18:18:54Z", "path": "server/src/test/java/org/elasticsearch/index/query/functionscore/FunctionScoreQueryBuilderTests.java", "diffHunk": "@@ -837,21 +837,22 @@ public void testCacheability() throws IOException {\n         assertEquals(\"query should \" + (isCacheable ? \"\" : \"not\") + \" be cacheable: \" + queryBuilder.toString(), isCacheable,\n                 context.isCacheable());\n \n-        // check the two non-cacheable cases explicitly\n         ScoreFunctionBuilder<?> scriptScoreFunction = new ScriptScoreFunctionBuilder(\n                 new Script(ScriptType.INLINE, MockScriptEngine.NAME, \"1\", Collections.emptyMap()));\n-        RandomScoreFunctionBuilder randomScoreFunctionBuilder = new RandomScoreFunctionBuilderWithFixedSeed();\n-\n-        for (ScoreFunctionBuilder<?> scoreFunction : List.of(scriptScoreFunction, randomScoreFunctionBuilder)) {\n-            FilterFunctionBuilder[] functions = new FilterFunctionBuilder[] {\n-                    new FilterFunctionBuilder(RandomQueryBuilder.createQuery(random()), scoreFunction) };\n-            queryBuilder = new FunctionScoreQueryBuilder(functions);\n+        queryBuilder = new FunctionScoreQueryBuilder(new FilterFunctionBuilder[] {\n+            new FilterFunctionBuilder(RandomQueryBuilder.createQuery(random()), scriptScoreFunction) });\n+        context = createShardContext();\n+        rewriteQuery = rewriteQuery(queryBuilder, new QueryShardContext(context));\n+        assertNotNull(rewriteQuery.toQuery(context));\n+        assertTrue(\"script should query should be cacheable: \" + queryBuilder.toString(), context.isCacheable());", "originalCommit": "452bae2f6c9c557fc4c778fb486d25e2ad86d9f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYxODE2OA==", "url": "https://github.com/elastic/elasticsearch/pull/55422#discussion_r411618168", "bodyText": "Added.", "author": "stu-elastic", "createdAt": "2020-04-20T19:01:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5MTY3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5MTg4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55422#discussion_r411591885", "bodyText": "\"random score should query should not be cacheable: \"  -> \"function random query should not be cacheable: \"", "author": "mayya-sharipova", "createdAt": "2020-04-20T18:19:15Z", "path": "server/src/test/java/org/elasticsearch/index/query/functionscore/FunctionScoreQueryBuilderTests.java", "diffHunk": "@@ -837,21 +837,22 @@ public void testCacheability() throws IOException {\n         assertEquals(\"query should \" + (isCacheable ? \"\" : \"not\") + \" be cacheable: \" + queryBuilder.toString(), isCacheable,\n                 context.isCacheable());\n \n-        // check the two non-cacheable cases explicitly\n         ScoreFunctionBuilder<?> scriptScoreFunction = new ScriptScoreFunctionBuilder(\n                 new Script(ScriptType.INLINE, MockScriptEngine.NAME, \"1\", Collections.emptyMap()));\n-        RandomScoreFunctionBuilder randomScoreFunctionBuilder = new RandomScoreFunctionBuilderWithFixedSeed();\n-\n-        for (ScoreFunctionBuilder<?> scoreFunction : List.of(scriptScoreFunction, randomScoreFunctionBuilder)) {\n-            FilterFunctionBuilder[] functions = new FilterFunctionBuilder[] {\n-                    new FilterFunctionBuilder(RandomQueryBuilder.createQuery(random()), scoreFunction) };\n-            queryBuilder = new FunctionScoreQueryBuilder(functions);\n+        queryBuilder = new FunctionScoreQueryBuilder(new FilterFunctionBuilder[] {\n+            new FilterFunctionBuilder(RandomQueryBuilder.createQuery(random()), scriptScoreFunction) });\n+        context = createShardContext();\n+        rewriteQuery = rewriteQuery(queryBuilder, new QueryShardContext(context));\n+        assertNotNull(rewriteQuery.toQuery(context));\n+        assertTrue(\"script should query should be cacheable: \" + queryBuilder.toString(), context.isCacheable());\n \n-            context = createShardContext();\n-            rewriteQuery = rewriteQuery(queryBuilder, new QueryShardContext(context));\n-            assertNotNull(rewriteQuery.toQuery(context));\n-            assertFalse(\"query should not be cacheable: \" + queryBuilder.toString(), context.isCacheable());\n-        }\n+        RandomScoreFunctionBuilder randomScoreFunctionBuilder = new RandomScoreFunctionBuilderWithFixedSeed();\n+        queryBuilder = new FunctionScoreQueryBuilder(new FilterFunctionBuilder[] {\n+            new FilterFunctionBuilder(RandomQueryBuilder.createQuery(random()), randomScoreFunctionBuilder) });\n+        context = createShardContext();\n+        rewriteQuery = rewriteQuery(queryBuilder, new QueryShardContext(context));\n+        assertNotNull(rewriteQuery.toQuery(context));\n+        assertFalse(\"random score should query should not be cacheable: \" + queryBuilder.toString(), context.isCacheable());", "originalCommit": "452bae2f6c9c557fc4c778fb486d25e2ad86d9f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5MjkxMw==", "url": "https://github.com/elastic/elasticsearch/pull/55422#discussion_r411592913", "bodyText": "We also need to remove ScriptScoreFunctionBuilder as a condition for false in the isCacheable function (line 861-862), as for ScriptScoreFunctionBuilder case we want to return true.", "author": "mayya-sharipova", "createdAt": "2020-04-20T18:21:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5MTg4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYxODMyMw==", "url": "https://github.com/elastic/elasticsearch/pull/55422#discussion_r411618323", "bodyText": "Updated message and removed ScriptScoreFunctionBuilder.", "author": "stu-elastic", "createdAt": "2020-04-20T19:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5MTg4NQ=="}], "type": "inlineReview"}, {"oid": "e9d527ccbede9d1d9791a56c9f063f2ea35dfc18", "url": "https://github.com/elastic/elasticsearch/commit/e9d527ccbede9d1d9791a56c9f063f2ea35dfc18", "message": "Better assert messages, rm ScriptScoreFunctionBuilder from isCacheable", "committedDate": "2020-04-20T18:45:32Z", "type": "commit"}, {"oid": "2db357b7aa24877d9832c53387721cb1dbd053b8", "url": "https://github.com/elastic/elasticsearch/commit/2db357b7aa24877d9832c53387721cb1dbd053b8", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into test/score-script-cacheable", "committedDate": "2020-04-20T18:46:57Z", "type": "commit"}, {"oid": "0c3918f245f14c6bfaaf411eeb3deb82e2be3e2a", "url": "https://github.com/elastic/elasticsearch/commit/0c3918f245f14c6bfaaf411eeb3deb82e2be3e2a", "message": "Update MockScoreScript in MlNativeIntegTestCase", "committedDate": "2020-04-20T18:59:49Z", "type": "commit"}]}