{"pr_number": 60640, "pr_title": "Use the Index Access Control from the scroll search context", "pr_createdAt": "2020-08-04T08:30:00Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60640", "timeline": [{"oid": "a0a630408be3879d208ec0a31ce79bd8e2783dba", "url": "https://github.com/elastic/elasticsearch/commit/a0a630408be3879d208ec0a31ce79bd8e2783dba", "message": "Test is hard", "committedDate": "2020-07-30T21:12:39Z", "type": "commit"}, {"oid": "8b8e32027f3170df5a3958e14a33064b6066fe65", "url": "https://github.com/elastic/elasticsearch/commit/8b8e32027f3170df5a3958e14a33064b6066fe65", "message": "vallidate only internal scrolls", "committedDate": "2020-08-01T21:27:54Z", "type": "commit"}, {"oid": "04925d9c27a7823c4adca6f480b03ba2ebd78127", "url": "https://github.com/elastic/elasticsearch/commit/04925d9c27a7823c4adca6f480b03ba2ebd78127", "message": "Yep", "committedDate": "2020-08-02T16:53:16Z", "type": "commit"}, {"oid": "4303a564e6805596e44b1583d6eccbfc47f44fde", "url": "https://github.com/elastic/elasticsearch/commit/4303a564e6805596e44b1583d6eccbfc47f44fde", "message": "Only verify context on preQuery", "committedDate": "2020-08-03T06:53:13Z", "type": "commit"}, {"oid": "2fb7cf8e8c97d4f80d34cdaf2619e2bc62a18de6", "url": "https://github.com/elastic/elasticsearch/commit/2fb7cf8e8c97d4f80d34cdaf2619e2bc62a18de6", "message": "Reuse scrolls even if empty", "committedDate": "2020-08-03T07:44:52Z", "type": "commit"}, {"oid": "708feae205c8673ebaa557d815ec4ca7dc8aa3e4", "url": "https://github.com/elastic/elasticsearch/commit/708feae205c8673ebaa557d815ec4ca7dc8aa3e4", "message": "assert", "committedDate": "2020-08-03T11:20:20Z", "type": "commit"}, {"oid": "efecc2271b52f18e985fd52c05cfbb7b773bcc36", "url": "https://github.com/elastic/elasticsearch/commit/efecc2271b52f18e985fd52c05cfbb7b773bcc36", "message": "Assert index access control on fetch phase too", "committedDate": "2020-08-03T11:21:55Z", "type": "commit"}, {"oid": "e02f8a3069e2729a0491ff16f85611a29f580b7b", "url": "https://github.com/elastic/elasticsearch/commit/e02f8a3069e2729a0491ff16f85611a29f580b7b", "message": "Merge branch 'master' into index_access_control_on_scroll_search_thread_context", "committedDate": "2020-08-04T08:08:18Z", "type": "commit"}, {"oid": "4b964b83cfb56128ddf9a232f80a54baba8ce98b", "url": "https://github.com/elastic/elasticsearch/commit/4b964b83cfb56128ddf9a232f80a54baba8ce98b", "message": "Add assert about scroll index access control", "committedDate": "2020-08-04T08:25:16Z", "type": "commit"}, {"oid": "c643a55c1392d07a1f49d894f807642cbd60b167", "url": "https://github.com/elastic/elasticsearch/commit/c643a55c1392d07a1f49d894f807642cbd60b167", "message": "Unused import", "committedDate": "2020-08-04T08:39:28Z", "type": "commit"}, {"oid": "76bb773df5f220509a0082bf3af82d34eb7a3fcd", "url": "https://github.com/elastic/elasticsearch/commit/76bb773df5f220509a0082bf3af82d34eb7a3fcd", "message": "Unused imports", "committedDate": "2020-08-04T08:47:32Z", "type": "commit"}, {"oid": "f1bc719bc3cc34f8933a58f9e35fab19c13e7f71", "url": "https://github.com/elastic/elasticsearch/commit/f1bc719bc3cc34f8933a58f9e35fab19c13e7f71", "message": "Fix unit tests", "committedDate": "2020-08-04T11:50:26Z", "type": "commit"}, {"oid": "86be3fb37f578648bb1c4f78ac5647a27c513db2", "url": "https://github.com/elastic/elasticsearch/commit/86be3fb37f578648bb1c4f78ac5647a27c513db2", "message": "remove indicesAccessControl!=null assertion for internal searches", "committedDate": "2020-08-04T12:07:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxMDU2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/60640#discussion_r465510567", "bodyText": "Are there valid cases where searchContext.scrollContext() is null?", "author": "ywangd", "createdAt": "2020-08-05T06:51:01Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/SecuritySearchOperationListener.java", "diffHunk": "@@ -68,6 +77,39 @@ public void validateSearchContext(SearchContext searchContext, TransportRequest\n                 final String action = threadContext.getTransient(ORIGINATING_ACTION_KEY);\n                 ensureAuthenticatedUserIsSame(originalAuth, current, auditTrailService, searchContext.id(), action, request,\n                         AuditUtil.extractRequestId(threadContext), threadContext.getTransient(AUTHORIZATION_INFO_KEY));\n+                // piggyback on context validation to assert the DLS/FLS permissions on the thread context of the scroll search handler\n+                if (null == securityContext.getThreadContext().getTransient(AuthorizationServiceField.INDICES_PERMISSIONS_KEY)) {\n+                    // fill in the DLS and FLS permissions for the scroll search action from the scroll context\n+                    IndicesAccessControl scrollIndicesAccessControl =\n+                            searchContext.scrollContext().getFromContext(AuthorizationServiceField.INDICES_PERMISSIONS_KEY);\n+                    assert scrollIndicesAccessControl != null : \"scroll does not contain index access control\";\n+                    securityContext.getThreadContext().putTransient(AuthorizationServiceField.INDICES_PERMISSIONS_KEY,\n+                            scrollIndicesAccessControl);\n+                }\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void onPreFetchPhase(SearchContext searchContext) {\n+        ensureIndicesAccessControlForScrollThreadContext(searchContext);\n+    }\n+\n+    @Override\n+    public void onPreQueryPhase(SearchContext searchContext) {\n+        ensureIndicesAccessControlForScrollThreadContext(searchContext);\n+    }\n+\n+    void ensureIndicesAccessControlForScrollThreadContext(SearchContext searchContext) {\n+        if (licenseState.isSecurityEnabled() && searchContext.scrollContext() != null) {", "originalCommit": "86be3fb37f578648bb1c4f78ac5647a27c513db2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU4MzY2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/60640#discussion_r465583669", "bodyText": "I don't know the circumstances , but they are not important in this context because I can rely on the fact that validateSearchContext has the same validation.", "author": "albertzaharovits", "createdAt": "2020-08-05T09:07:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxMDU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU4NTMzOA==", "url": "https://github.com/elastic/elasticsearch/pull/60640#discussion_r465585338", "bodyText": "I mean, if you're asking informatively, I would expect that regular searches don't have a scroll context. If you're asking as a reviewer, I say I replicated the validation that the handler called just before onPreFetch/QueryPhase has.", "author": "albertzaharovits", "createdAt": "2020-08-05T09:10:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxMDU2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxMjg2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/60640#discussion_r465512865", "bodyText": "If what we are after is identity equality, I'd personally prefer to have scrollIndicesAccessControl != threadIndicesAccessControl to help with clarity and perphaps more future proof.", "author": "ywangd", "createdAt": "2020-08-05T06:56:16Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/SecuritySearchOperationListener.java", "diffHunk": "@@ -68,6 +77,39 @@ public void validateSearchContext(SearchContext searchContext, TransportRequest\n                 final String action = threadContext.getTransient(ORIGINATING_ACTION_KEY);\n                 ensureAuthenticatedUserIsSame(originalAuth, current, auditTrailService, searchContext.id(), action, request,\n                         AuditUtil.extractRequestId(threadContext), threadContext.getTransient(AUTHORIZATION_INFO_KEY));\n+                // piggyback on context validation to assert the DLS/FLS permissions on the thread context of the scroll search handler\n+                if (null == securityContext.getThreadContext().getTransient(AuthorizationServiceField.INDICES_PERMISSIONS_KEY)) {\n+                    // fill in the DLS and FLS permissions for the scroll search action from the scroll context\n+                    IndicesAccessControl scrollIndicesAccessControl =\n+                            searchContext.scrollContext().getFromContext(AuthorizationServiceField.INDICES_PERMISSIONS_KEY);\n+                    assert scrollIndicesAccessControl != null : \"scroll does not contain index access control\";\n+                    securityContext.getThreadContext().putTransient(AuthorizationServiceField.INDICES_PERMISSIONS_KEY,\n+                            scrollIndicesAccessControl);\n+                }\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void onPreFetchPhase(SearchContext searchContext) {\n+        ensureIndicesAccessControlForScrollThreadContext(searchContext);\n+    }\n+\n+    @Override\n+    public void onPreQueryPhase(SearchContext searchContext) {\n+        ensureIndicesAccessControlForScrollThreadContext(searchContext);\n+    }\n+\n+    void ensureIndicesAccessControlForScrollThreadContext(SearchContext searchContext) {\n+        if (licenseState.isSecurityEnabled() && searchContext.scrollContext() != null) {\n+            IndicesAccessControl scrollIndicesAccessControl =\n+                    searchContext.scrollContext().getFromContext(AuthorizationServiceField.INDICES_PERMISSIONS_KEY);\n+            IndicesAccessControl threadIndicesAccessControl =\n+                    securityContext.getThreadContext().getTransient(AuthorizationServiceField.INDICES_PERMISSIONS_KEY);\n+            if (false == scrollIndicesAccessControl.equals(threadIndicesAccessControl)) {", "originalCommit": "86be3fb37f578648bb1c4f78ac5647a27c513db2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU5NjU4NA==", "url": "https://github.com/elastic/elasticsearch/pull/60640#discussion_r465596584", "bodyText": "Okay, I suppose identity equality is what this check is all about. I've made the suggested change, thanks.", "author": "albertzaharovits", "createdAt": "2020-08-05T09:29:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxMjg2NQ=="}], "type": "inlineReview"}, {"oid": "67be17853737b634439be73cfa59637bafa3ab80", "url": "https://github.com/elastic/elasticsearch/commit/67be17853737b634439be73cfa59637bafa3ab80", "message": "equals -> !=", "committedDate": "2020-08-05T09:28:10Z", "type": "commit"}, {"oid": "e243982da97e39c1af3284d8d7f1dd4ddf1b30ae", "url": "https://github.com/elastic/elasticsearch/commit/e243982da97e39c1af3284d8d7f1dd4ddf1b30ae", "message": "Merge branch 'master' into index_access_control_on_scroll_search_thread_context", "committedDate": "2020-08-05T09:28:47Z", "type": "commit"}]}