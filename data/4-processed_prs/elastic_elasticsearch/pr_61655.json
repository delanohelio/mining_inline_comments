{"pr_number": 61655, "pr_title": "Dedicated threadpool for system index writes", "pr_createdAt": "2020-08-27T20:08:56Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61655", "timeline": [{"oid": "ad63f5a16548dd1dbb4d44d7121d886f8ecdbde2", "url": "https://github.com/elastic/elasticsearch/commit/ad63f5a16548dd1dbb4d44d7121d886f8ecdbde2", "message": "Dedicated threadpool for system index writes\n\nThis commit adds a dedicated threadpool for system index write\noperations. The dedicated resources for system index writes serves as\na means to ensure that user activity does not block important system\noperations from occurring such as the management of users and roles.", "committedDate": "2020-08-27T19:49:10Z", "type": "commit"}, {"oid": "55ca5574751c2a668f79e1f92d7d27b6dbecd01b", "url": "https://github.com/elastic/elasticsearch/commit/55ca5574751c2a668f79e1f92d7d27b6dbecd01b", "message": "indexing pressure", "committedDate": "2020-08-31T15:55:07Z", "type": "commit"}, {"oid": "b7460e0b570e407cbcf447b2552fa5569b35c4c8", "url": "https://github.com/elastic/elasticsearch/commit/b7460e0b570e407cbcf447b2552fa5569b35c4c8", "message": "Merge branch 'master' into system_index_write_threadpool", "committedDate": "2020-08-31T16:42:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3NTYwMg==", "url": "https://github.com/elastic/elasticsearch/pull/61655#discussion_r481475602", "bodyText": "Why can't this be simplified to just abstraction.isSystem()?", "author": "gwbrown", "createdAt": "2020-09-01T22:52:54Z", "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "diffHunk": "@@ -336,6 +345,18 @@ static void prohibitCustomRoutingOnDataStream(DocWriteRequest<?> writeRequest, M\n         }\n     }\n \n+    boolean isOnlySystem(BulkRequest request, SortedMap<String, IndexAbstraction> indicesLookup, SystemIndices systemIndices) {\n+        final boolean onlySystem = request.getIndices().stream().allMatch(indexName -> {\n+            final IndexAbstraction abstraction = indicesLookup.get(indexName);\n+            if (abstraction != null) {\n+                return abstraction.isSystem();\n+            } else {\n+                return systemIndices.isSystemIndex(indexName);", "originalCommit": "b7460e0b570e407cbcf447b2552fa5569b35c4c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAyNDk5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61655#discussion_r491024993", "bodyText": "At the point when we need to call this, we cannot guarantee that all system indices have been created :(", "author": "jaymode", "createdAt": "2020-09-18T15:25:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3NTYwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3ODEyNg==", "url": "https://github.com/elastic/elasticsearch/pull/61655#discussion_r481478126", "bodyText": "Nitpick: the name executor isn't really right now that it's actually a function to get an executor.", "author": "gwbrown", "createdAt": "2020-09-01T23:00:30Z", "path": "server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java", "diffHunk": "@@ -61,21 +62,25 @@\n         > extends TransportReplicationAction<Request, ReplicaRequest, Response> {\n \n     private final IndexingPressure indexingPressure;\n-    private final String executor;\n+    private final Function<IndexShard, String> executor;", "originalCommit": "b7460e0b570e407cbcf447b2552fa5569b35c4c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ4OTA4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61655#discussion_r481489083", "bodyText": "There are a number of instances where we now verify that we're using the WRITE threadpool here. Could we add a test here to check the logic that determines when to use SYSTEM_WRITE?", "author": "gwbrown", "createdAt": "2020-09-01T23:34:38Z", "path": "server/src/test/java/org/elasticsearch/action/bulk/TransportBulkActionIngestTests.java", "diffHunk": "@@ -274,7 +276,7 @@ public void testIngestLocal() throws Exception {\n         assertFalse(responseCalled.get());\n         assertFalse(failureCalled.get());\n         verify(ingestService).executeBulkRequest(eq(bulkRequest.numberOfActions()), bulkDocsItr.capture(),\n-            failureHandler.capture(), completionHandler.capture(), any());\n+            failureHandler.capture(), completionHandler.capture(), any(), eq(Names.WRITE));", "originalCommit": "b7460e0b570e407cbcf447b2552fa5569b35c4c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2ac0245a08b7e631c3fec9631f18e6f78551ff33", "url": "https://github.com/elastic/elasticsearch/commit/2ac0245a08b7e631c3fec9631f18e6f78551ff33", "message": "more places to force", "committedDate": "2020-09-02T14:32:04Z", "type": "commit"}, {"oid": "d132f1e0d6bcb96b674a40928e261c492d36c178", "url": "https://github.com/elastic/elasticsearch/commit/d132f1e0d6bcb96b674a40928e261c492d36c178", "message": "Merge branch 'master' into system_index_write_threadpool", "committedDate": "2020-09-18T15:09:49Z", "type": "commit"}, {"oid": "1f4a42e3b811361c79cc14c5da53b658cc67182a", "url": "https://github.com/elastic/elasticsearch/commit/1f4a42e3b811361c79cc14c5da53b658cc67182a", "message": "rename", "committedDate": "2020-09-18T15:35:59Z", "type": "commit"}, {"oid": "094a7bc54a8609f05d471deba5a0c446ed445a0d", "url": "https://github.com/elastic/elasticsearch/commit/094a7bc54a8609f05d471deba5a0c446ed445a0d", "message": "test only system", "committedDate": "2020-09-18T16:27:00Z", "type": "commit"}, {"oid": "7bd5b2f64146b70d5b2d5e23dc6261d23b5fcfb7", "url": "https://github.com/elastic/elasticsearch/commit/7bd5b2f64146b70d5b2d5e23dc6261d23b5fcfb7", "message": "verify name", "committedDate": "2020-09-18T16:34:26Z", "type": "commit"}, {"oid": "86dee58f7845d9532f9b5c3e05c5ae94871ca8b4", "url": "https://github.com/elastic/elasticsearch/commit/86dee58f7845d9532f9b5c3e05c5ae94871ca8b4", "message": "doc", "committedDate": "2020-09-18T16:38:49Z", "type": "commit"}, {"oid": "1ccf5eec86e8f80d8d8d1e77a02f9b9c21f64693", "url": "https://github.com/elastic/elasticsearch/commit/1ccf5eec86e8f80d8d8d1e77a02f9b9c21f64693", "message": "Merge branch 'master' into system_index_write_threadpool", "committedDate": "2020-09-22T14:03:33Z", "type": "commit"}, {"oid": "da85769b19622da3fa6f69817f14297b8de7f96d", "url": "https://github.com/elastic/elasticsearch/commit/da85769b19622da3fa6f69817f14297b8de7f96d", "message": "Merge branch 'master' into system_index_write_threadpool", "committedDate": "2020-09-22T17:11:16Z", "type": "commit"}]}