{"pr_number": 51830, "pr_title": "IDP-initiated sso REST handler", "pr_createdAt": "2020-02-03T21:29:15Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51830", "timeline": [{"oid": "57d2d76f3d864178fd2d6f3bf5f7f1131cf19155", "url": "https://github.com/elastic/elasticsearch/commit/57d2d76f3d864178fd2d6f3bf5f7f1131cf19155", "message": "Add IDP Configuration settings and related tests", "committedDate": "2020-01-30T14:35:28Z", "type": "commit"}, {"oid": "fcb2e8c28112e00dae8cb5a29d919a2772ba17ab", "url": "https://github.com/elastic/elasticsearch/commit/fcb2e8c28112e00dae8cb5a29d919a2772ba17ab", "message": "license and missing conf", "committedDate": "2020-01-30T14:40:33Z", "type": "commit"}, {"oid": "db7cb6719c4d60050183e5fc3ab0446228e837cf", "url": "https://github.com/elastic/elasticsearch/commit/db7cb6719c4d60050183e5fc3ab0446228e837cf", "message": "Add scope to settings", "committedDate": "2020-01-30T14:51:40Z", "type": "commit"}, {"oid": "8ed79cbab0a48778566813e4776750ae6cc5b031", "url": "https://github.com/elastic/elasticsearch/commit/8ed79cbab0a48778566813e4776750ae6cc5b031", "message": "address feedback", "committedDate": "2020-01-31T05:28:14Z", "type": "commit"}, {"oid": "a4136c7166685413ee1f9032c301310039e41ee4", "url": "https://github.com/elastic/elasticsearch/commit/a4136c7166685413ee1f9032c301310039e41ee4", "message": "add missing file", "committedDate": "2020-01-31T10:01:49Z", "type": "commit"}, {"oid": "5252c8bd7e4462999cc4fe82589c8fbb7aa7c730", "url": "https://github.com/elastic/elasticsearch/commit/5252c8bd7e4462999cc4fe82589c8fbb7aa7c730", "message": "address feedback", "committedDate": "2020-02-03T09:06:54Z", "type": "commit"}, {"oid": "39317701d00f4a40015caaf892ace494333ec99a", "url": "https://github.com/elastic/elasticsearch/commit/39317701d00f4a40015caaf892ace494333ec99a", "message": "Add handler for IDP initiated SSO\n\nNecessary rest handler and transport action for consuming an SP\nEntityID and producing a SAML response for the authenticating user.\nTransportSamlInitiateSingleSignOnAction needs to be adjusted to\ntake advantage of the secondary authentication handling logic once\nthis is available.\nTODO: add tests for TransportSamlInitiateSingleSignOnAction", "committedDate": "2020-02-03T21:03:20Z", "type": "commit"}, {"oid": "745c7d553c294f95dc68f4c2dbb852a9529229cb", "url": "https://github.com/elastic/elasticsearch/commit/745c7d553c294f95dc68f4c2dbb852a9529229cb", "message": "Merge branch 'feature-internal-idp' into idp-init-handlers", "committedDate": "2020-02-03T21:13:22Z", "type": "commit"}, {"oid": "de22cd618f796ef1c0c7ce42798835b01a09716c", "url": "https://github.com/elastic/elasticsearch/commit/de22cd618f796ef1c0c7ce42798835b01a09716c", "message": "checkstyle", "committedDate": "2020-02-03T21:25:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIxNDMxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r376214315", "bodyText": "Why is this repeated here?", "author": "tvernum", "createdAt": "2020-02-07T04:55:35Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/IdentityProviderPlugin.java", "diffHunk": "@@ -73,23 +87,47 @@\n \n     private final Logger logger = LogManager.getLogger();\n     private boolean enabled;\n+    private Settings settings;\n \n     @Override\n     public Collection<Object> createComponents(Client client, ClusterService clusterService, ThreadPool threadPool,\n                                                ResourceWatcherService resourceWatcherService, ScriptService scriptService,\n                                                NamedXContentRegistry xContentRegistry, Environment environment,\n                                                NodeEnvironment nodeEnvironment, NamedWriteableRegistry namedWriteableRegistry) {\n-        final Settings settings = environment.settings();\n+        settings = environment.settings();\n         enabled = ENABLED_SETTING.get(settings);\n         if (enabled == false) {\n             return List.of();\n         }\n \n-        SamlInit.initialize();\n+        SamlUtils.initialize();\n         CloudIdp idp = new CloudIdp(environment, settings);\n         return List.of();\n     }\n \n+    @Override\n+    public List<ActionHandler<? extends ActionRequest, ? extends ActionResponse>> getActions() {\n+\n+        enabled = ENABLED_SETTING.get(settings);", "originalCommit": "de22cd618f796ef1c0c7ce42798835b01a09716c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIxNDcyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r376214725", "bodyText": "I think we agreed that we wouldn't use xpack/ here, didn't we?", "author": "tvernum", "createdAt": "2020-02-07T04:57:38Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/SamlInitiateSingleSignOnAction.java", "diffHunk": "@@ -0,0 +1,21 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.idp.action;\n+\n+import org.elasticsearch.action.ActionType;\n+\n+/**\n+ * ActionType to create a SAML Response in the context of IDP initiated SSO for a given SP\n+ */\n+public class SamlInitiateSingleSignOnAction extends ActionType<SamlInitiateSingleSignOnResponse> {\n+\n+    public static final String NAME = \"cluster:admin/xpack/idp/saml/init\";", "originalCommit": "de22cd618f796ef1c0c7ce42798835b01a09716c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQzNDY4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r376434689", "bodyText": "We did, but it was a few hours after I opened the PR :)", "author": "jkakavas", "createdAt": "2020-02-07T14:59:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIxNDcyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIxNTI0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r376215242", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        validationException = addValidationError(\"sp_entity_id is missing\", null);\n          \n          \n            \n                        validationException = addValidationError(\"sp_entity_id is missing\", validationException);\n          \n      \n    \n    \n  \n\nThis way if we add new validations in the future, there's less chance of dropping (overwriting) an error.", "author": "tvernum", "createdAt": "2020-02-07T05:00:21Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/SamlInitiateSingleSignOnRequest.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.idp.action;\n+\n+\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.ActionRequestValidationException;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+\n+import static org.elasticsearch.action.ValidateActions.addValidationError;\n+\n+import java.io.IOException;\n+\n+public class SamlInitiateSingleSignOnRequest extends ActionRequest {\n+\n+    private String spEntityId;\n+\n+    public SamlInitiateSingleSignOnRequest(StreamInput in) throws IOException {\n+        super(in);\n+        spEntityId = in.readString();\n+    }\n+\n+    public SamlInitiateSingleSignOnRequest() {\n+    }\n+\n+    @Override\n+    public ActionRequestValidationException validate() {\n+        ActionRequestValidationException validationException = null;\n+        if (Strings.isNullOrEmpty(spEntityId)) {\n+            validationException = addValidationError(\"sp_entity_id is missing\", null);", "originalCommit": "de22cd618f796ef1c0c7ce42798835b01a09716c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIxNTk4MA==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r376215980", "bodyText": "I'd prefer this to be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    SamlServiceProvider sp = idp.getRegisteredServiceProviders().get(request.getSpEntityId());\n          \n          \n            \n                    SamlServiceProvider sp = idp.getRegisteredServiceProvider(request.getSpEntityId());\n          \n      \n    \n    \n  \n\nI don't think we want to rely on the IdP object always representing the SPs as a Map.\nThere may be millions of SPs and we don't want to have to load all of them into memory.\nEventually we'll probably need to make that method async, but for now separating this code from the underlying implentation is a start.", "author": "tvernum", "createdAt": "2020-02-07T05:04:25Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.idp.action;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.support.ActionFilters;\n+import org.elasticsearch.action.support.HandledTransportAction;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.tasks.Task;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.transport.TransportService;\n+import org.elasticsearch.xpack.core.security.authc.Authentication;\n+import org.elasticsearch.xpack.core.security.user.User;\n+import org.elasticsearch.xpack.idp.saml.authn.SuccessfulAuthenticationResponseMessageBuilder;\n+import org.elasticsearch.xpack.idp.saml.authn.UserServiceAuthentication;\n+import org.elasticsearch.xpack.idp.saml.idp.CloudIdp;\n+import org.elasticsearch.xpack.idp.saml.idp.SamlIdentityProvider;\n+import org.elasticsearch.xpack.idp.saml.sp.SamlServiceProvider;\n+import org.elasticsearch.xpack.idp.saml.support.SamlFactory;\n+import org.elasticsearch.xpack.idp.saml.support.SamlUtils;\n+import org.opensaml.saml.saml2.core.Response;\n+\n+import java.time.Clock;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+public class TransportSamlInitiateSingleSignOnAction\n+    extends HandledTransportAction<SamlInitiateSingleSignOnRequest, SamlInitiateSingleSignOnResponse> {\n+\n+    private final ThreadPool threadPool;\n+    private final Environment env;\n+    private final Logger logger = LogManager.getLogger(TransportSamlInitiateSingleSignOnAction.class);\n+\n+    @Inject\n+    public TransportSamlInitiateSingleSignOnAction(ThreadPool threadPool, TransportService transportService,\n+                                                   ActionFilters actionFilters, Environment environment) {\n+        super(SamlInitiateSingleSignOnAction.NAME, transportService, actionFilters, SamlInitiateSingleSignOnRequest::new);\n+        this.threadPool = threadPool;\n+        this.env = environment;\n+    }\n+\n+    @Override\n+    protected void doExecute(Task task, SamlInitiateSingleSignOnRequest request,\n+                             ActionListener<SamlInitiateSingleSignOnResponse> listener) {\n+        final ThreadContext threadContext = threadPool.getThreadContext();\n+        final SamlFactory samlFactory = new SamlFactory();\n+        final SamlIdentityProvider idp = new CloudIdp(env, env.settings());\n+        Authentication serviceAccountAuthentication = Authentication.getAuthentication(threadContext);\n+        // TODO: Adjust this once secondary auth code is merged in master and use the authentication object of the user\n+        // Authentication authentication = authenticationService.getSecondaryAuth();\n+\n+        SamlServiceProvider sp = idp.getRegisteredServiceProviders().get(request.getSpEntityId());", "originalCommit": "de22cd618f796ef1c0c7ce42798835b01a09716c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyMzQzNg==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r376223436", "bodyText": "Can we make the service provider an object?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    builder.field(\"sp_entity_id\", response.getSpEntityId());\n          \n          \n            \n                                    builder.startObject(\"service_provider\");\n          \n          \n            \n                                    builder.field(\"entity_id\", response.getSpEntityId());\n          \n          \n            \n                                    builder.endObject();\n          \n      \n    \n    \n  \n\nI suspect that we might (perhaps) want to return a name for the SP in the future so the UI can say \"Redirecting you to ...\" and that sort of change will be easier if this is an object from the start.", "author": "tvernum", "createdAt": "2020-02-07T05:46:10Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/rest/action/RestSamlInitiateSingleSignOnAction.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.idp.rest.action;\n+\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.xcontent.ObjectParser;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.rest.BaseRestHandler;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestRequest;\n+\n+import org.elasticsearch.rest.RestResponse;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.rest.action.RestBuilderListener;\n+import org.elasticsearch.xpack.idp.action.SamlInitiateSingleSignOnAction;\n+import org.elasticsearch.xpack.idp.action.SamlInitiateSingleSignOnRequest;\n+import org.elasticsearch.xpack.idp.action.SamlInitiateSingleSignOnResponse;\n+\n+import java.io.IOException;\n+\n+import static org.elasticsearch.rest.RestRequest.Method.POST;\n+\n+public class RestSamlInitiateSingleSignOnAction extends BaseRestHandler {\n+    static final ObjectParser<SamlInitiateSingleSignOnRequest, Void> PARSER = new ObjectParser<>(\"idp_init_sso\",\n+        SamlInitiateSingleSignOnRequest::new);\n+\n+    static {\n+        PARSER.declareString(SamlInitiateSingleSignOnRequest::setSpEntityId, new ParseField(\"sp_entity_id\"));\n+    }\n+\n+    public RestSamlInitiateSingleSignOnAction(RestController controller) {\n+        controller.registerHandler(\n+            POST, \"/_idp/saml/init\", this\n+        );\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return \"idp_init_sso_action\";\n+    }\n+\n+    @Override\n+    protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient client) throws IOException {\n+        try (XContentParser parser = request.contentParser()) {\n+            final SamlInitiateSingleSignOnRequest initRequest = PARSER.parse(parser, null);\n+            return channel -> client.execute(SamlInitiateSingleSignOnAction.INSTANCE, initRequest,\n+                new RestBuilderListener<SamlInitiateSingleSignOnResponse>(channel) {\n+                    @Override\n+                    public RestResponse buildResponse(SamlInitiateSingleSignOnResponse response, XContentBuilder builder) throws Exception {\n+                        builder.startObject();\n+                        builder.field(\"redirect_url\", response.getRedirectUrl());\n+                        builder.field(\"response_body\", response.getResponseBody());\n+                        builder.field(\"sp_entity_id\", response.getSpEntityId());", "originalCommit": "de22cd618f796ef1c0c7ce42798835b01a09716c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyNDQ3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r376224472", "bodyText": "Per my comments above, I think we can replace this with a getRegisteredServiceProvider(String id) method.", "author": "tvernum", "createdAt": "2020-02-07T05:51:17Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/CloudIdp.java", "diffHunk": "@@ -73,6 +78,12 @@ public X509Credential getSigningCredential() {\n         return signingCredential;\n     }\n \n+    @Override\n+    public Map<String, SamlServiceProvider> getRegisteredServiceProviders() {\n+        return registeredServiceProviders;\n+    }", "originalCommit": "de22cd618f796ef1c0c7ce42798835b01a09716c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyNDY3NA==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r376224674", "bodyText": "I think can drop the Kibana part of the name. There's nothing here that's Kibana specific.", "author": "tvernum", "createdAt": "2020-02-07T05:52:15Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/CloudKibanaServiceProvider.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.idp.saml.sp;\n+\n+import org.elasticsearch.common.Strings;\n+import org.joda.time.Duration;\n+import org.joda.time.ReadableDuration;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+public class CloudKibanaServiceProvider implements SamlServiceProvider {", "originalCommit": "de22cd618f796ef1c0c7ce42798835b01a09716c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyNTU4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r376225581", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static String samlObjectToString(SAMLObject object) {\n          \n          \n            \n                public static String getXmlContent(SAMLObject object) {\n          \n      \n    \n    \n  \n\nI think we should be more explict that this is used to get the object in XML, not just for printing.", "author": "tvernum", "createdAt": "2020-02-07T05:56:57Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/support/SamlUtils.java", "diffHunk": "@@ -0,0 +1,166 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.idp.saml.support;\n+\n+import javax.xml.XMLConstants;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerConfigurationException;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.dom.DOMSource;\n+import javax.xml.transform.stream.StreamResult;\n+import java.io.StringWriter;\n+import java.io.Writer;\n+import java.security.AccessController;\n+import java.security.PrivilegedActionException;\n+import java.security.PrivilegedExceptionAction;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.LogManager;\n+import org.elasticsearch.ElasticsearchSecurityException;\n+import org.elasticsearch.SpecialPermission;\n+import org.elasticsearch.common.SuppressForbidden;\n+import org.elasticsearch.xpack.core.security.support.RestorableContextClassLoader;\n+import org.opensaml.core.config.InitializationService;\n+import org.opensaml.core.xml.io.MarshallingException;\n+import org.opensaml.core.xml.util.XMLObjectSupport;\n+import org.opensaml.saml.common.SAMLObject;\n+import org.opensaml.saml.saml2.core.Assertion;\n+import org.opensaml.saml.saml2.core.Response;\n+import org.slf4j.LoggerFactory;\n+import org.w3c.dom.Element;\n+\n+public class SamlUtils {\n+\n+    private static final String SAML_MARSHALLING_ERROR_STRING = \"_unserializable_\";\n+\n+    private static final AtomicBoolean INITIALISED = new AtomicBoolean(false);\n+\n+    private static final Logger LOGGER = LogManager.getLogger(SamlUtils.class);\n+\n+    /**\n+     * This is needed in order to initialize the underlying OpenSAML library.\n+     * It must be called before doing anything that potentially interacts with OpenSAML (whether in server code, or in tests).\n+     * The initialization happens within do privileged block as the underlying Apache XML security library has a permission check.\n+     * The initialization happens with a specific context classloader as OpenSAML loads resources from its jar file.\n+     */\n+    public static void initialize() {\n+        if (INITIALISED.compareAndSet(false, true)) {\n+            // We want to force these classes to be loaded _before_ we fiddle with the context classloader\n+            LoggerFactory.getLogger(InitializationService.class);\n+            SpecialPermission.check();\n+            try {\n+                AccessController.doPrivileged((PrivilegedExceptionAction<Void>) () -> {\n+                    LOGGER.debug(\"Initializing OpenSAML\");\n+                    try (RestorableContextClassLoader ignore = new RestorableContextClassLoader(InitializationService.class)) {\n+                        InitializationService.initialize();\n+                    }\n+                    LOGGER.debug(\"Initialized OpenSAML\");\n+                    return null;\n+                });\n+            } catch (PrivilegedActionException e) {\n+                throw new ElasticsearchSecurityException(\"failed to set context classloader for SAML IdP\", e);\n+            }\n+        }\n+    }\n+\n+    static String toString(Element element, boolean pretty) {\n+        try {\n+            StringWriter writer = new StringWriter();\n+            print(element, writer, pretty);\n+            return writer.toString();\n+        } catch (TransformerException e) {\n+            return \"[\" + element.getNamespaceURI() + \"]\" + element.getLocalName();\n+        }\n+    }\n+\n+    static void print(Element element, Writer writer, boolean pretty) throws TransformerException {\n+        final Transformer serializer = getHardenedXMLTransformer();\n+        if (pretty) {\n+            serializer.setOutputProperty(OutputKeys.INDENT, \"yes\");\n+        }\n+        serializer.transform(new DOMSource(element), new StreamResult(writer));\n+    }\n+\n+    public static String samlObjectToString(SAMLObject object) {", "originalCommit": "de22cd618f796ef1c0c7ce42798835b01a09716c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE1MDI3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r380150275", "bodyText": "This is marked resolved, but it doesn't seem to have changed.", "author": "tvernum", "createdAt": "2020-02-17T12:19:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyNTU4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyNTc2OA==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r376225768", "bodyText": "I think for the case where this is used (Rest response) we don't want to pretty print by default (maybe if the pretty parameter is set, but not otherwise).", "author": "tvernum", "createdAt": "2020-02-07T05:57:59Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/support/SamlUtils.java", "diffHunk": "@@ -0,0 +1,166 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.idp.saml.support;\n+\n+import javax.xml.XMLConstants;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerConfigurationException;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.dom.DOMSource;\n+import javax.xml.transform.stream.StreamResult;\n+import java.io.StringWriter;\n+import java.io.Writer;\n+import java.security.AccessController;\n+import java.security.PrivilegedActionException;\n+import java.security.PrivilegedExceptionAction;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.LogManager;\n+import org.elasticsearch.ElasticsearchSecurityException;\n+import org.elasticsearch.SpecialPermission;\n+import org.elasticsearch.common.SuppressForbidden;\n+import org.elasticsearch.xpack.core.security.support.RestorableContextClassLoader;\n+import org.opensaml.core.config.InitializationService;\n+import org.opensaml.core.xml.io.MarshallingException;\n+import org.opensaml.core.xml.util.XMLObjectSupport;\n+import org.opensaml.saml.common.SAMLObject;\n+import org.opensaml.saml.saml2.core.Assertion;\n+import org.opensaml.saml.saml2.core.Response;\n+import org.slf4j.LoggerFactory;\n+import org.w3c.dom.Element;\n+\n+public class SamlUtils {\n+\n+    private static final String SAML_MARSHALLING_ERROR_STRING = \"_unserializable_\";\n+\n+    private static final AtomicBoolean INITIALISED = new AtomicBoolean(false);\n+\n+    private static final Logger LOGGER = LogManager.getLogger(SamlUtils.class);\n+\n+    /**\n+     * This is needed in order to initialize the underlying OpenSAML library.\n+     * It must be called before doing anything that potentially interacts with OpenSAML (whether in server code, or in tests).\n+     * The initialization happens within do privileged block as the underlying Apache XML security library has a permission check.\n+     * The initialization happens with a specific context classloader as OpenSAML loads resources from its jar file.\n+     */\n+    public static void initialize() {\n+        if (INITIALISED.compareAndSet(false, true)) {\n+            // We want to force these classes to be loaded _before_ we fiddle with the context classloader\n+            LoggerFactory.getLogger(InitializationService.class);\n+            SpecialPermission.check();\n+            try {\n+                AccessController.doPrivileged((PrivilegedExceptionAction<Void>) () -> {\n+                    LOGGER.debug(\"Initializing OpenSAML\");\n+                    try (RestorableContextClassLoader ignore = new RestorableContextClassLoader(InitializationService.class)) {\n+                        InitializationService.initialize();\n+                    }\n+                    LOGGER.debug(\"Initialized OpenSAML\");\n+                    return null;\n+                });\n+            } catch (PrivilegedActionException e) {\n+                throw new ElasticsearchSecurityException(\"failed to set context classloader for SAML IdP\", e);\n+            }\n+        }\n+    }\n+\n+    static String toString(Element element, boolean pretty) {\n+        try {\n+            StringWriter writer = new StringWriter();\n+            print(element, writer, pretty);\n+            return writer.toString();\n+        } catch (TransformerException e) {\n+            return \"[\" + element.getNamespaceURI() + \"]\" + element.getLocalName();\n+        }\n+    }\n+\n+    static void print(Element element, Writer writer, boolean pretty) throws TransformerException {\n+        final Transformer serializer = getHardenedXMLTransformer();\n+        if (pretty) {\n+            serializer.setOutputProperty(OutputKeys.INDENT, \"yes\");\n+        }\n+        serializer.transform(new DOMSource(element), new StreamResult(writer));\n+    }\n+\n+    public static String samlObjectToString(SAMLObject object) {\n+        try {\n+            return toString(XMLObjectSupport.marshall(object), true);", "originalCommit": "de22cd618f796ef1c0c7ce42798835b01a09716c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE1MDU1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r380150559", "bodyText": "I don't think this has been resolved", "author": "tvernum", "createdAt": "2020-02-17T12:20:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyNTc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyNTgwNg==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r376225806", "bodyText": "I think we can delete some of the methods from the TestCase object now.", "author": "tvernum", "createdAt": "2020-02-07T05:58:06Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/support/SamlUtils.java", "diffHunk": "@@ -0,0 +1,166 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.idp.saml.support;\n+\n+import javax.xml.XMLConstants;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerConfigurationException;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.dom.DOMSource;\n+import javax.xml.transform.stream.StreamResult;\n+import java.io.StringWriter;\n+import java.io.Writer;\n+import java.security.AccessController;\n+import java.security.PrivilegedActionException;\n+import java.security.PrivilegedExceptionAction;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.LogManager;\n+import org.elasticsearch.ElasticsearchSecurityException;\n+import org.elasticsearch.SpecialPermission;\n+import org.elasticsearch.common.SuppressForbidden;\n+import org.elasticsearch.xpack.core.security.support.RestorableContextClassLoader;\n+import org.opensaml.core.config.InitializationService;\n+import org.opensaml.core.xml.io.MarshallingException;\n+import org.opensaml.core.xml.util.XMLObjectSupport;\n+import org.opensaml.saml.common.SAMLObject;\n+import org.opensaml.saml.saml2.core.Assertion;\n+import org.opensaml.saml.saml2.core.Response;\n+import org.slf4j.LoggerFactory;\n+import org.w3c.dom.Element;\n+\n+public class SamlUtils {\n+\n+    private static final String SAML_MARSHALLING_ERROR_STRING = \"_unserializable_\";\n+\n+    private static final AtomicBoolean INITIALISED = new AtomicBoolean(false);\n+\n+    private static final Logger LOGGER = LogManager.getLogger(SamlUtils.class);\n+\n+    /**\n+     * This is needed in order to initialize the underlying OpenSAML library.\n+     * It must be called before doing anything that potentially interacts with OpenSAML (whether in server code, or in tests).\n+     * The initialization happens within do privileged block as the underlying Apache XML security library has a permission check.\n+     * The initialization happens with a specific context classloader as OpenSAML loads resources from its jar file.\n+     */\n+    public static void initialize() {\n+        if (INITIALISED.compareAndSet(false, true)) {\n+            // We want to force these classes to be loaded _before_ we fiddle with the context classloader\n+            LoggerFactory.getLogger(InitializationService.class);\n+            SpecialPermission.check();\n+            try {\n+                AccessController.doPrivileged((PrivilegedExceptionAction<Void>) () -> {\n+                    LOGGER.debug(\"Initializing OpenSAML\");\n+                    try (RestorableContextClassLoader ignore = new RestorableContextClassLoader(InitializationService.class)) {\n+                        InitializationService.initialize();\n+                    }\n+                    LOGGER.debug(\"Initialized OpenSAML\");\n+                    return null;\n+                });\n+            } catch (PrivilegedActionException e) {\n+                throw new ElasticsearchSecurityException(\"failed to set context classloader for SAML IdP\", e);\n+            }\n+        }\n+    }\n+\n+    static String toString(Element element, boolean pretty) {\n+        try {\n+            StringWriter writer = new StringWriter();\n+            print(element, writer, pretty);\n+            return writer.toString();\n+        } catch (TransformerException e) {\n+            return \"[\" + element.getNamespaceURI() + \"]\" + element.getLocalName();\n+        }\n+    }\n+\n+    static void print(Element element, Writer writer, boolean pretty) throws TransformerException {\n+        final Transformer serializer = getHardenedXMLTransformer();\n+        if (pretty) {\n+            serializer.setOutputProperty(OutputKeys.INDENT, \"yes\");\n+        }\n+        serializer.transform(new DOMSource(element), new StreamResult(writer));\n+    }\n+\n+    public static String samlObjectToString(SAMLObject object) {\n+        try {\n+            return toString(XMLObjectSupport.marshall(object), true);\n+        } catch (MarshallingException e) {\n+            LOGGER.info(\"Error marshalling SAMLObject \", e);\n+            return SAML_MARSHALLING_ERROR_STRING;\n+        }\n+    }\n+\n+    static String describeSamlObject(SAMLObject object) {\n+        if (Response.class.isInstance(object)) {\n+            Response response = (Response) object;\n+            StringBuilder sb = new StringBuilder();\n+            sb.append(\"SAML Response: [\\n\");\n+            sb.append(\"    Destination: \").append(response.getDestination()).append(\"\\n\");\n+            sb.append(\"    Response ID: \").append(response.getID()).append(\"\\n\");\n+            sb.append(\"    In response to: \").append(response.getInResponseTo()).append(\"\\n\");\n+            sb.append(\"    Response issued at:\").append(response.getIssueInstant()).append(\"\\n\");\n+            if (response.getIssuer() != null) {\n+                sb.append(\"    Issuer: \").append(response.getIssuer().getValue()).append(\"\\n\");\n+            }\n+            sb.append(\"    Number of unencrypted Assertions: \").append(response.getAssertions().size()).append(\"\\n\");\n+            sb.append(\"    Number of encrypted Assertions: \").append(response.getEncryptedAssertions().size()).append(\"\\n\");\n+            sb.append(\"]\");\n+            return sb.toString();\n+\n+        } else if (Assertion.class.isInstance(object)) {\n+            Assertion assertion = (Assertion) object;\n+            StringBuilder sb = new StringBuilder();\n+            sb.append(\"SAML Assertion: [\\n\");\n+            sb.append(\"    Response ID: \").append(assertion.getID()).append(\"\\n\");\n+            sb.append(\"    Response issued at: \").append(assertion.getIssueInstant()).append(\"\\n\");\n+            if (assertion.getIssuer() != null) {\n+                sb.append(\"    Issuer: \").append(assertion.getIssuer().getValue()).append(\"\\n\");\n+            }\n+            sb.append(\"    Number of attribute statements: \").append(assertion.getAttributeStatements().size()).append(\"\\n\");\n+            sb.append(\"    Number of authentication statements: \").append(assertion.getAuthnStatements().size()).append(\"\\n\");\n+            sb.append(\"]\");\n+            return sb.toString();\n+        }\n+        return samlObjectToString(object);\n+    }\n+\n+    @SuppressForbidden(reason = \"This is the only allowed way to construct a Transformer\")\n+    public static Transformer getHardenedXMLTransformer() throws TransformerConfigurationException {", "originalCommit": "de22cd618f796ef1c0c7ce42798835b01a09716c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQzNjAzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r376436031", "bodyText": "I have consolidated things in the other PR, merging will be fun", "author": "jkakavas", "createdAt": "2020-02-07T15:01:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyNTgwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyODA3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r376228072", "bodyText": "I'd like a test for this class.\nIt doesn't do much yet, but we keep a better pace of development if we write the tests earlier, and build on them as needed.", "author": "tvernum", "createdAt": "2020-02-07T06:08:29Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.idp.action;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.support.ActionFilters;\n+import org.elasticsearch.action.support.HandledTransportAction;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.tasks.Task;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.transport.TransportService;\n+import org.elasticsearch.xpack.core.security.authc.Authentication;\n+import org.elasticsearch.xpack.core.security.user.User;\n+import org.elasticsearch.xpack.idp.saml.authn.SuccessfulAuthenticationResponseMessageBuilder;\n+import org.elasticsearch.xpack.idp.saml.authn.UserServiceAuthentication;\n+import org.elasticsearch.xpack.idp.saml.idp.CloudIdp;\n+import org.elasticsearch.xpack.idp.saml.idp.SamlIdentityProvider;\n+import org.elasticsearch.xpack.idp.saml.sp.SamlServiceProvider;\n+import org.elasticsearch.xpack.idp.saml.support.SamlFactory;\n+import org.elasticsearch.xpack.idp.saml.support.SamlUtils;\n+import org.opensaml.saml.saml2.core.Response;\n+\n+import java.time.Clock;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+public class TransportSamlInitiateSingleSignOnAction\n+    extends HandledTransportAction<SamlInitiateSingleSignOnRequest, SamlInitiateSingleSignOnResponse> {", "originalCommit": "de22cd618f796ef1c0c7ce42798835b01a09716c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQzNzU1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r376437551", "bodyText": "Agreed, I had a TODO in 3931770 description that didn't make it to the PR description", "author": "jkakavas", "createdAt": "2020-02-07T15:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyODA3Mg=="}], "type": "inlineReview"}, {"oid": "6809f592dac98fcebfd6b771795f0515bc1815a9", "url": "https://github.com/elastic/elasticsearch/commit/6809f592dac98fcebfd6b771795f0515bc1815a9", "message": "address feedback and add test", "committedDate": "2020-02-12T10:46:26Z", "type": "commit"}, {"oid": "e24dde75a912b941ad0bb66d57628b42dad3836a", "url": "https://github.com/elastic/elasticsearch/commit/e24dde75a912b941ad0bb66d57628b42dad3836a", "message": "Merge branch 'feature-internal-idp' into idp-init-handlers", "committedDate": "2020-02-12T10:46:57Z", "type": "commit"}, {"oid": "be53bf56aa317c0bf1783b7aaaaef453cd363126", "url": "https://github.com/elastic/elasticsearch/commit/be53bf56aa317c0bf1783b7aaaaef453cd363126", "message": "Adjust after merge", "committedDate": "2020-02-12T11:16:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE3NjEyMg==", "url": "https://github.com/elastic/elasticsearch/pull/51830#discussion_r380176122", "bodyText": "It's minor, but I think this name should reference SAML since it's a SAML specific endpoint.", "author": "tvernum", "createdAt": "2020-02-17T13:18:11Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/rest/action/RestSamlInitiateSingleSignOnAction.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.idp.rest.action;\n+\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.xcontent.ObjectParser;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.rest.BaseRestHandler;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestRequest;\n+\n+import org.elasticsearch.rest.RestResponse;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.rest.action.RestBuilderListener;\n+import org.elasticsearch.xpack.idp.action.SamlInitiateSingleSignOnAction;\n+import org.elasticsearch.xpack.idp.action.SamlInitiateSingleSignOnRequest;\n+import org.elasticsearch.xpack.idp.action.SamlInitiateSingleSignOnResponse;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.elasticsearch.rest.RestRequest.Method.POST;\n+\n+public class RestSamlInitiateSingleSignOnAction extends BaseRestHandler {\n+    static final ObjectParser<SamlInitiateSingleSignOnRequest, Void> PARSER = new ObjectParser<>(\"idp_init_sso\",\n+        SamlInitiateSingleSignOnRequest::new);\n+\n+    static {\n+        PARSER.declareString(SamlInitiateSingleSignOnRequest::setSpEntityId, new ParseField(\"sp_entity_id\"));\n+    }\n+\n+    @Override\n+    public List<Route> routes(){\n+        return Collections.singletonList(\n+            new Route(POST, \"/_idp/saml/init\")\n+        );\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return \"idp_init_sso_action\";", "originalCommit": "be53bf56aa317c0bf1783b7aaaaef453cd363126", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "27b3f58e7be51620cdec8818ecb0a5ccd0f2be8a", "url": "https://github.com/elastic/elasticsearch/commit/27b3f58e7be51620cdec8818ecb0a5ccd0f2be8a", "message": "address feedback", "committedDate": "2020-02-17T14:23:56Z", "type": "commit"}]}