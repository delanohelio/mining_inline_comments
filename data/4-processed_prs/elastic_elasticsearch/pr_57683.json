{"pr_number": 57683, "pr_title": "[ML] Add per-partition categorization option", "pr_createdAt": "2020-06-04T15:53:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57683", "timeline": [{"oid": "032f5b95c6696b59cdcdb4c226678b130ee4bacc", "url": "https://github.com/elastic/elasticsearch/commit/032f5b95c6696b59cdcdb4c226678b130ee4bacc", "message": "[ML] Add per-partition categorization option\n\nThis PR adds the initial Java side changes to enable\nuse of the per-partition categorization functionality\nadded in elastic/ml-cpp#1293.\n\nThere will be a followup change to complete the work,\nas there cannot be any end-to-end integration tests\nuntil elastic/ml-cpp#1293 is merged, and also\nelastic/ml-cpp#1293 does not implement some of the\nmore peripheral functionality, like stop_on_warn and\nper-partition stats documents.\n\nThe changes so far cover REST APIs, results object\nformats, HLRC and docs.", "committedDate": "2020-06-04T15:51:36Z", "type": "commit"}, {"oid": "86308acc58db5f7787e2cd46a2bcd72e1e7d0a8c", "url": "https://github.com/elastic/elasticsearch/commit/86308acc58db5f7787e2cd46a2bcd72e1e7d0a8c", "message": "[DOCS] Fixes nesting and minor edits", "committedDate": "2020-06-04T18:46:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4MDEzMw==", "url": "https://github.com/elastic/elasticsearch/pull/57683#discussion_r435480133", "bodyText": "This setting may only be true if...\n\nThis sentence makes me wonder about things like this:\n\nIs there a validation check that generates an error if this condition isn't met?\nDoes this mean that if you have a detector where the by_field_name or over_field_name contains mlcategory you must also specify a partition_field_name?  Or does this condition only apply if you already have a partition_field_name in that detector?\nDepending on the answers to those questions, it might be clearer like this:\n\n\nTo enable this setting, you must also set the partition_field_name property to the same value in every detector that uses the keyword mlcategory. Otherwise, job creation fails.", "author": "lcawl", "createdAt": "2020-06-04T18:51:50Z", "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -1113,6 +1113,27 @@ The field used to segment the analysis. When you use this property, you have\n completely independent baselines for each value of this field.\n end::partition-field-name[]\n \n+tag::per-partition-categorization[]\n+Settings related to how categorization interacts with partition fields.\n+end::per-partition-categorization[]\n+\n+tag::per-partition-categorization-enabled[]\n+If true, categorization is done separately for each value of the\n+`partition_field_name` field. The default value is false. This setting can be\n+set only when you create the job; it cannot be updated. This setting may only be", "originalCommit": "86308acc58db5f7787e2cd46a2bcd72e1e7d0a8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4MTAwNw==", "url": "https://github.com/elastic/elasticsearch/pull/57683#discussion_r435481007", "bodyText": "where the categorization status changes to warn...\n\nI don't think we talk anywhere else about when/why/where you'd see this status. Is this going to be added in a subsequent PR?", "author": "lcawl", "createdAt": "2020-06-04T18:53:25Z", "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -1113,6 +1113,27 @@ The field used to segment the analysis. When you use this property, you have\n completely independent baselines for each value of this field.\n end::partition-field-name[]\n \n+tag::per-partition-categorization[]\n+Settings related to how categorization interacts with partition fields.\n+end::per-partition-categorization[]\n+\n+tag::per-partition-categorization-enabled[]\n+If true, categorization is done separately for each value of the\n+`partition_field_name` field. The default value is false. This setting can be\n+set only when you create the job; it cannot be updated. This setting may only be\n+true if every detector in the job that refers to `mlcategory` (the\n+categorization output field) has the same value for `partition_field_name`.\n+end::per-partition-categorization-enabled[]\n+\n+tag::per-partition-categorization-stop-on-warn[]\n+This setting can be set to true only if per-partition categorization is enabled.\n+If true, both categorization and subsequent anomaly detection stops for\n+partitions where the categorization status changes to `warn`. This setting makes", "originalCommit": "86308acc58db5f7787e2cd46a2bcd72e1e7d0a8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc5ODUyOA==", "url": "https://github.com/elastic/elasticsearch/pull/57683#discussion_r435798528", "bodyText": "Is this going to be added in a subsequent PR?\n\nYes, for the per-partition aspect.\nIf you search for tag::categorization-status in https://github.com/elastic/elasticsearch/blob/master/docs/reference/ml/ml-shared.asciidoc you'll see it's currently a status that applies to the whole job.  Eventually, for jobs with per-partition categorization enabled there will be a separate categorization status per partition.  There will be subsequent PRs that implement this as the current ones are big enough already.  So I have slightly jumped the gun by mentioning it here.  The reason is because, as #57683 (review) alludes to, this PR already has to touch a huge number of files to make a very simple change.  If I had added the enabled and stop_on_warn settings in different PRs so that stop_on_warn actually worked then I would have needed two PRs that touched all these files.", "author": "droberts195", "createdAt": "2020-06-05T09:22:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4MTAwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4ODE3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/57683#discussion_r435488171", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return new PerPartitionCategorizationConfig(enabled, enabled && randomBoolean());\n          \n          \n            \n                    return new PerPartitionCategorizationConfig(enabled, randomBoolean() ? null : enabled && randomBoolean());", "author": "benwtrent", "createdAt": "2020-06-04T19:06:45Z", "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/ml/job/config/PerPartitionCategorizationConfigTests.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.client.ml.job.config;\n+\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.test.AbstractXContentTestCase;\n+\n+public class PerPartitionCategorizationConfigTests extends AbstractXContentTestCase<PerPartitionCategorizationConfig> {\n+\n+    @Override\n+    protected PerPartitionCategorizationConfig createTestInstance() {\n+        boolean enabled = randomBoolean();\n+        return new PerPartitionCategorizationConfig(enabled, enabled && randomBoolean());", "originalCommit": "86308acc58db5f7787e2cd46a2bcd72e1e7d0a8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NTA5OA==", "url": "https://github.com/elastic/elasticsearch/pull/57683#discussion_r435495098", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return new PerPartitionCategorizationConfig(enabled, enabled && randomBoolean());\n          \n          \n            \n                    return new PerPartitionCategorizationConfig(enabled, randomBoolean() ? null : enabled && randomBoolean());", "author": "benwtrent", "createdAt": "2020-06-04T19:20:03Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/job/config/PerPartitionCategorizationConfigTests.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.ml.job.config;\n+\n+import org.elasticsearch.ElasticsearchStatusException;\n+import org.elasticsearch.common.io.stream.Writeable;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.test.AbstractSerializingTestCase;\n+\n+import static org.hamcrest.Matchers.is;\n+\n+public class PerPartitionCategorizationConfigTests extends AbstractSerializingTestCase<PerPartitionCategorizationConfig> {\n+\n+    public void testConstructorDefaults() {\n+        assertThat(new PerPartitionCategorizationConfig().isEnabled(), is(false));\n+        assertThat(new PerPartitionCategorizationConfig().isStopOnWarn(), is(false));\n+    }\n+\n+    public void testValidation() {\n+        ElasticsearchStatusException e = expectThrows(ElasticsearchStatusException.class,\n+            () -> new PerPartitionCategorizationConfig(false, true));\n+\n+        assertThat(e.getMessage(), is(\"stop_on_warn cannot be true in per_partition_categorization when enabled is false\"));\n+    }\n+\n+    @Override\n+    protected PerPartitionCategorizationConfig createTestInstance() {\n+        boolean enabled = randomBoolean();\n+        return new PerPartitionCategorizationConfig(enabled, enabled && randomBoolean());", "originalCommit": "86308acc58db5f7787e2cd46a2bcd72e1e7d0a8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e7c34c6253115cc554a3a28f9ac69433dbf73bb6", "url": "https://github.com/elastic/elasticsearch/commit/e7c34c6253115cc554a3a28f9ac69433dbf73bb6", "message": "Apply suggestions from code review\n\nCo-authored-by: Benjamin Trent <ben.w.trent@gmail.com>", "committedDate": "2020-06-05T09:23:09Z", "type": "commit"}, {"oid": "5eac13c6f557bf656f344924ffd43798b9f51f6b", "url": "https://github.com/elastic/elasticsearch/commit/5eac13c6f557bf656f344924ffd43798b9f51f6b", "message": "Merge branch 'master' into per_partition_categorization", "committedDate": "2020-06-05T09:26:59Z", "type": "commit"}, {"oid": "7d8202c04fee07df7562b37b4852bc28d5ad7c6b", "url": "https://github.com/elastic/elasticsearch/commit/7d8202c04fee07df7562b37b4852bc28d5ad7c6b", "message": "Apply docs review comment", "committedDate": "2020-06-05T09:35:27Z", "type": "commit"}, {"oid": "5ab00ea99cdf9e76d73c0750d01cd8a886a3e00f", "url": "https://github.com/elastic/elasticsearch/commit/5ab00ea99cdf9e76d73c0750d01cd8a886a3e00f", "message": "Add new fields to config index mappings", "committedDate": "2020-06-05T10:12:10Z", "type": "commit"}]}