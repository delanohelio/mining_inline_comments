{"pr_number": 66846, "pr_title": "Support keystore tests on FIPS JVM", "pr_createdAt": "2020-12-29T07:27:46Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66846", "timeline": [{"oid": "56db35161fb19b68174242aa3ed7ca000d25b1d3", "url": "https://github.com/elastic/elasticsearch/commit/56db35161fb19b68174242aa3ed7ca000d25b1d3", "message": "Support keystore tests of FIPS JVM\n\nAs of #64024 we run FIPS CI on a true, FIPS approved only mode JVM.\nThis mandates that any passwords that are fed into PBKDF2 must have at\nleast 112 bits of entropy (that is, be 14 characters long).\n\nThis commit updates our Keystore CLI tests so that tests either:\n1. Use a 14+ character password when in FIPS mode, _or_\n2. Are skipped on FIPS mode (because they explicitly test empty\n   passwords)\n\nResolves: #66845", "committedDate": "2020-12-29T07:22:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU5OTM3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/66846#discussion_r549599379", "bodyText": "This actually never tested with the password, because it didn't pass --password on the command line.", "author": "tvernum", "createdAt": "2020-12-29T07:31:22Z", "path": "distribution/tools/keystore-cli/src/test/java/org/elasticsearch/common/settings/CreateKeyStoreCommandTests.java", "diffHunk": "@@ -53,48 +53,67 @@ public void testNotMatchingPasswords() throws Exception {\n     }\n \n     public void testDefaultNotPromptForPassword() throws Exception {\n+        assumeFalse(\"Cannot open unprotected keystore on FIPS JVM\", inFipsJvm());\n         execute();\n         Path configDir = env.configFile();\n         assertNotNull(KeyStoreWrapper.load(configDir));\n     }\n \n     public void testPosix() throws Exception {\n-        String password = randomFrom(\"\", \"keystorepassword\");\n-        terminal.addSecretInput(password);\n-        terminal.addSecretInput(password);\n-        execute();", "originalCommit": "56db35161fb19b68174242aa3ed7ca000d25b1d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a66940e62528232bb4626b4b469eb4301efcc35a", "url": "https://github.com/elastic/elasticsearch/commit/a66940e62528232bb4626b4b469eb4301efcc35a", "message": "Make sure wrong password is > 14 chars\n\nWhen testing with an incorrect password, make sure it is longer than\nthe original password so that we trigger \"incorrect password\"\nbehaviour rather than \"password too short\" behaviour.", "committedDate": "2020-12-29T07:34:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYzMjc3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/66846#discussion_r549632771", "bodyText": "Do we need to execute(randomFrom(\"-p\", \"--password\")) here as well?", "author": "BigPandaToo", "createdAt": "2020-12-29T09:26:08Z", "path": "distribution/tools/keystore-cli/src/test/java/org/elasticsearch/common/settings/ChangeKeyStorePasswordCommandTests.java", "diffHunk": "@@ -54,14 +55,15 @@ public void testChangeKeyStorePassword() throws Exception {\n         createKeystore(\"theoldpassword\");\n         loadKeystore(\"theoldpassword\");\n         terminal.addSecretInput(\"theoldpassword\");\n-        terminal.addSecretInput(\"thepassword\");\n-        terminal.addSecretInput(\"thepassword\");\n+        terminal.addSecretInput(\"the-better-password\");\n+        terminal.addSecretInput(\"the-better-password\");\n         // Prompted thrice: Once for the existing and twice for the new password\n         execute();", "originalCommit": "a66940e62528232bb4626b4b469eb4301efcc35a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg5MjkzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/66846#discussion_r549892931", "bodyText": "No, it's calling the ChangeKeyStorePasswordCommand (elasticsearch-keystore passwd) which doesn 't have a \"--password\" option (because it always deals with passwords).", "author": "tvernum", "createdAt": "2020-12-30T00:06:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYzMjc3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY1NzQ1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/66846#discussion_r549657455", "bodyText": "Ideally, when not firefighting, I think we should assert the behavior from the FIPS JVM in circumstances such as this one. For regular JVMs, the tests assert all kinds of behaviors, but since some are skipped in the FIPS JVM we condone unspecified behavior.\n@jkakavas Is #65464 supposed to handle some/all cases like this one?\nGranted, this assumes the FIPS provider implementation (different ones might fail differently), and maybe the JVMs as well. I see this as an argument for more clearly specifying and documenting the FIPS environments we test (and support).\nShould I open a separate GH issue regarding negative testing in the FIPS JVM?", "author": "albertzaharovits", "createdAt": "2020-12-29T10:43:52Z", "path": "distribution/tools/keystore-cli/src/test/java/org/elasticsearch/common/settings/CreateKeyStoreCommandTests.java", "diffHunk": "@@ -53,48 +53,67 @@ public void testNotMatchingPasswords() throws Exception {\n     }\n \n     public void testDefaultNotPromptForPassword() throws Exception {\n+        assumeFalse(\"Cannot open unprotected keystore on FIPS JVM\", inFipsJvm());", "originalCommit": "a66940e62528232bb4626b4b469eb4301efcc35a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY3NTYzNA==", "url": "https://github.com/elastic/elasticsearch/pull/66846#discussion_r549675634", "bodyText": "This is not covered in 65454. We can add tests for certain cases with assumeTrue in fips mode, but only for ones we can anticipate the behavior, i.e. short passwords. As you say its tricky.\n\nI see this as an argument for more clearly specifying and documenting the FIPS environments we test (and support).\n\nAgreed, there is an ongoing separate discussion around this", "author": "jkakavas", "createdAt": "2020-12-29T11:49:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY1NzQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg5MjQzNA==", "url": "https://github.com/elastic/elasticsearch/pull/66846#discussion_r549892434", "bodyText": "If there are specific cases in this PR where it feels like we're skipping a test for something that should work on FIPS, then definitely point it out because I tried hard to resolve all of those (which increased coverage on non-FIPS as well, since there were scenarios that we never tested with a password).\nHowever, in this case, this is simply something that is not supported on FIPS. The test is that we don't prompt for a password if there isn't one, and that's not a valid scenario to test of FIPS. We simply cannot read a keystore without a password.\nI could write a test to check that unprotected keystores fail on FIPS, except that's not really a requirement per se, it's just a consequence of the JVM being in FIPS mode.\nOne could make an argument that we should have a test testThatReadingUnprotectedKeystoreInFipsModeFailsWithUsefulMessageAndDoesntCorruptKeystore (maybe a shorter test name) but it's probably not a super high priority.", "author": "tvernum", "createdAt": "2020-12-30T00:04:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY1NzQ1NQ=="}], "type": "inlineReview"}]}