{"pr_number": 57490, "pr_title": "Make parent and child aggregator more obvious", "pr_createdAt": "2020-06-01T21:39:34Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57490", "timeline": [{"oid": "b795df644d1d4bf93b38df01ee7c650afb9ed8e4", "url": "https://github.com/elastic/elasticsearch/commit/b795df644d1d4bf93b38df01ee7c650afb9ed8e4", "message": "Make parent and child aggregator more obvious\n\nPulls the way that the `ParentJoinAggregator` collects global ordinals\ninto a strategy object so it is a little simpler to reason about and\nit'll be simpler to save memory by removing `asMultiBucketAggregator` in\nthe future.\n\nRelates to #56487", "committedDate": "2020-06-01T21:35:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyNDIzNw==", "url": "https://github.com/elastic/elasticsearch/pull/57490#discussion_r433524237", "bodyText": "needs updating?", "author": "talevy", "createdAt": "2020-06-01T22:31:45Z", "path": "modules/parent-join/src/main/java/org/elasticsearch/join/aggregations/ParentJoinAggregator.java", "diffHunk": "@@ -165,6 +150,81 @@ public int docID() {\n \n     @Override\n     protected void doClose() {\n-        Releasables.close(ordsBit, ordsHash);\n+        Releasables.close(collectionStrategy);\n+    }\n+\n+    /**\n+     * Strategy for collecting the global ordinals of the join field in for all\n+     * docs that match the {@code ParentJoinAggregator#inFilter} and then\n+     * checking if which of the docs in the\n+     * {@code ParentJoinAggregator#outFilter} also have the ordinal.\n+     */\n+    protected interface CollectionStrategy extends Releasable {\n+        void addGlobalOrdinal(int globalOrdinal);\n+        boolean existsGlobalOrdinal(int globalOrdinal);\n+    }\n+\n+    /**\n+     * Uses a dense, bit per ordinal representation of the join field in the\n+     * docs that match {@code ParentJoinAggregator#inFilter}. Its memory usage\n+     * is proportional to the maximum ordinal so it is only a good choice if\n+     * most docs match.\n+     */\n+    protected class DenseCollectionStrategy implements CollectionStrategy {\n+        /**\n+         * Otherwise we use a dense bit array to record the global ordinals.", "originalCommit": "b795df644d1d4bf93b38df01ee7c650afb9ed8e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9706f9eee63f2002dcd83e1e204e7bbe73343460", "url": "https://github.com/elastic/elasticsearch/commit/9706f9eee63f2002dcd83e1e204e7bbe73343460", "message": "Merge branch 'master' into parent_join_strategy", "committedDate": "2020-06-02T18:21:50Z", "type": "commit"}, {"oid": "15bf49e43710644ed74c770c64aa94c0f3ad4447", "url": "https://github.com/elastic/elasticsearch/commit/15bf49e43710644ed74c770c64aa94c0f3ad4447", "message": "Drop outdated comments", "committedDate": "2020-06-02T18:22:32Z", "type": "commit"}]}