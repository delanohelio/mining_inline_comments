{"pr_number": 57785, "pr_title": "Fix Bug With RepositoryData Caching", "pr_createdAt": "2020-06-07T09:23:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57785", "timeline": [{"oid": "2f22c5c507d6a0cff3672e59271d393c56d92da0", "url": "https://github.com/elastic/elasticsearch/commit/2f22c5c507d6a0cff3672e59271d393c56d92da0", "message": "Fix Bug With RepositoryData Caching\n\nThis fixes a really subtle bug with caching `RepositoryData`\nthat can corrupt a repository.\nWe were caching `RepositoryData` serialized in the newest\nmetadata format. This lead to a confusing situation where\nnumeric shard generations would be cached in `ShardGenerations`\nthat were not written to the repository because the repository\nor cluster did not yet support `ShardGenerations`.\nIn the case where shard generations are not actually supported yet,\nthese cached numeric generations are not safe and there's multiple\nscenarios where they would be incorrect, leading to the repository\ntrying to read shard level metadata from index-N that don't exist.\nThis commit makes it so that cached metadata is always in the same\nformat as the metadata in the repository.", "committedDate": "2020-06-07T09:19:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM0NjYxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/57785#discussion_r436346619", "bodyText": "There is an obvious and much cleaner fix here by simply caching the compressed form of the already serialized RepositoryData when writing/reading instead of re-serializing that would also improve efficiency. I just went with this approach now to have the smallest possible fix for a safe back-port.", "author": "original-brownbear", "createdAt": "2020-06-07T10:07:25Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1295,15 +1297,16 @@ private void doGetRepositoryData(ActionListener<RepositoryData> listener) {\n      * generation will always contain the same {@link RepositoryData}.\n      *\n      * @param updated RepositoryData to cache if newer than the cache contents\n+     * @param version version of the repository metadata that was cached\n      */\n-    private void cacheRepositoryData(RepositoryData updated) {\n+    private void cacheRepositoryData(RepositoryData updated, Version version) {", "originalCommit": "2f22c5c507d6a0cff3672e59271d393c56d92da0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "96e30e92e2a1fb9ece7e0e702875fef5c710f03f", "url": "https://github.com/elastic/elasticsearch/commit/96e30e92e2a1fb9ece7e0e702875fef5c710f03f", "message": "Merge remote-tracking branch 'elastic/master' into fix-broken-repo-data-cache", "committedDate": "2020-06-08T07:37:46Z", "type": "commit"}, {"oid": "f2292885b02ec38f2ed6ac7b3a2337796cfb7c4b", "url": "https://github.com/elastic/elasticsearch/commit/f2292885b02ec38f2ed6ac7b3a2337796cfb7c4b", "message": "CR: add test", "committedDate": "2020-06-08T08:32:11Z", "type": "commit"}]}