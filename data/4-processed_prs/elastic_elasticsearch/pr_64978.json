{"pr_number": 64978, "pr_title": "Better out-of-the-box mappings for logs, metrics and synthetics", "pr_createdAt": "2020-11-12T09:33:20Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64978", "timeline": [{"oid": "1100b95bf5d96830f15568dbba7d930412669e36", "url": "https://github.com/elastic/elasticsearch/commit/1100b95bf5d96830f15568dbba7d930412669e36", "message": "Proposal: Default templates: Path match for ip and message\n\nOne of the problems we have today with the default templates is that ip addresses and message fields are not mapped correct. Auto detection of ip addresses would be great: https://github.com/elastic/elasticsearch/issues/64400 But in the meantime, we could also match on the naming convention that all `*.ip` fields are of type ip address.\n\nDuring implementation I was not sure if I should use `match: ip` for `path_match: *.ip`. The main difference I would expect that the top level is not matched. Are there others?\n\nDo we have fields which are named `ip` or `message` which do not adhere to these rules?\n\nThis PR is not complete but is to share the idea. If we decide to move forward, also the other base templates need updating and it might be useful to add the same logic to all datasets created by Kibana.", "committedDate": "2020-11-12T09:29:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk4OTU2NA==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r521989564", "bodyText": "Not that it would save lots of space, but given that scoring doesn't help, we could disable norms.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          \"type\": \"text\"\n          \n          \n            \n                          \"type\": \"text\",\n          \n          \n            \n                          \"norms\": false", "author": "jpountz", "createdAt": "2020-11-12T10:12:46Z", "path": "x-pack/plugin/core/src/main/resources/logs-mappings.json", "diffHunk": "@@ -9,6 +9,20 @@\n               \"type\": \"keyword\"\n             },\n             \"match_mapping_type\": \"string\"\n+          },\n+          \"match_ip\": {\n+            \"match_mapping_type\": \"string\",\n+            \"path_match\":   \"*.ip\",\n+            \"mapping\": {\n+              \"type\": \"ip\"\n+            }\n+          },\n+          \"match_message\": {\n+            \"match_mapping_type\": \"string\",\n+            \"path_match\":   \"*.message\",\n+            \"mapping\": {\n+              \"type\": \"text\"", "originalCommit": "1100b95bf5d96830f15568dbba7d930412669e36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA1MTA3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r522051079", "bodyText": "Should we do the same for the top level message field?", "author": "ruflin", "createdAt": "2020-11-12T11:55:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk4OTU2NA=="}], "type": "inlineReview"}, {"oid": "dae84d6f1e0345e129f42d5ac92b70762467755e", "url": "https://github.com/elastic/elasticsearch/commit/dae84d6f1e0345e129f42d5ac92b70762467755e", "message": "Update x-pack/plugin/core/src/main/resources/logs-mappings.json\n\nCo-authored-by: Adrien Grand <jpountz@gmail.com>", "committedDate": "2020-11-12T11:55:36Z", "type": "commit"}, {"oid": "90ca4b1adfabc2a6578cb79e3093ce5594b6d9ee", "url": "https://github.com/elastic/elasticsearch/commit/90ca4b1adfabc2a6578cb79e3093ce5594b6d9ee", "message": "update mapping with discussion", "committedDate": "2020-11-20T11:52:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU2ODY0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r529568641", "bodyText": "keep a single space after the colon?", "author": "jpountz", "createdAt": "2020-11-24T14:04:13Z", "path": "x-pack/plugin/core/src/main/resources/logs-mappings.json", "diffHunk": "@@ -9,6 +9,21 @@\n               \"type\": \"keyword\"\n             },\n             \"match_mapping_type\": \"string\"\n+          },\n+          \"match_ip\": {\n+            \"match_mapping_type\": \"string\",\n+            \"match\":   \"ip\",", "originalCommit": "90ca4b1adfabc2a6578cb79e3093ce5594b6d9ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU2ODY3OA==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r529568678", "bodyText": "keep a single space after the colon?", "author": "jpountz", "createdAt": "2020-11-24T14:04:15Z", "path": "x-pack/plugin/core/src/main/resources/logs-mappings.json", "diffHunk": "@@ -9,6 +9,21 @@\n               \"type\": \"keyword\"\n             },\n             \"match_mapping_type\": \"string\"\n+          },\n+          \"match_ip\": {\n+            \"match_mapping_type\": \"string\",\n+            \"match\":   \"ip\",\n+            \"mapping\": {\n+              \"type\": \"ip\"\n+            }\n+          },\n+          \"match_message\": {\n+            \"match_mapping_type\": \"string\",\n+            \"match\":   \"message\",", "originalCommit": "90ca4b1adfabc2a6578cb79e3093ce5594b6d9ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ2NTA2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r530465066", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      },\n          \n          \n            \n                      }\n          \n          \n            \n                    },\n          \n          \n            \n                    {", "author": "jpountz", "createdAt": "2020-11-25T15:38:38Z", "path": "x-pack/plugin/core/src/main/resources/logs-mappings.json", "diffHunk": "@@ -9,6 +9,21 @@\n               \"type\": \"keyword\"\n             },\n             \"match_mapping_type\": \"string\"\n+          },", "originalCommit": "90ca4b1adfabc2a6578cb79e3093ce5594b6d9ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ2NTI0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r530465242", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      },\n          \n          \n            \n                      }\n          \n          \n            \n                    },\n          \n          \n            \n                    {", "author": "jpountz", "createdAt": "2020-11-25T15:38:55Z", "path": "x-pack/plugin/core/src/main/resources/logs-mappings.json", "diffHunk": "@@ -9,6 +9,21 @@\n               \"type\": \"keyword\"\n             },\n             \"match_mapping_type\": \"string\"\n+          },\n+          \"match_ip\": {\n+            \"match_mapping_type\": \"string\",\n+            \"match\":   \"ip\",\n+            \"mapping\": {\n+              \"type\": \"ip\"\n+            }\n+          },", "originalCommit": "90ca4b1adfabc2a6578cb79e3093ce5594b6d9ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "35d072765e9e9f0c3b07074d4de9d2597b4d31d3", "url": "https://github.com/elastic/elasticsearch/commit/35d072765e9e9f0c3b07074d4de9d2597b4d31d3", "message": "Update x-pack/plugin/core/src/main/resources/logs-mappings.json\n\nCo-authored-by: Adrien Grand <jpountz@gmail.com>", "committedDate": "2020-11-26T07:20:30Z", "type": "commit"}, {"oid": "ce72eefb9f4c4b170cb421a61d38e64149a69785", "url": "https://github.com/elastic/elasticsearch/commit/ce72eefb9f4c4b170cb421a61d38e64149a69785", "message": "Update x-pack/plugin/core/src/main/resources/logs-mappings.json\n\nCo-authored-by: Adrien Grand <jpountz@gmail.com>", "committedDate": "2020-11-26T07:20:36Z", "type": "commit"}, {"oid": "2e130a55db31051731ebf643567edd551e6a76ed", "url": "https://github.com/elastic/elasticsearch/commit/2e130a55db31051731ebf643567edd551e6a76ed", "message": "Put the most specific dynamic templates first.", "committedDate": "2020-11-26T10:22:05Z", "type": "commit"}, {"oid": "7497f294634d6440523addeded796edfd4a9ad09", "url": "https://github.com/elastic/elasticsearch/commit/7497f294634d6440523addeded796edfd4a9ad09", "message": "Add tests for dynamic templates.", "committedDate": "2020-11-26T10:29:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2NjgxMg==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r530966812", "bodyText": "Nice, good to know this is possible!", "author": "ruflin", "createdAt": "2020-11-26T11:35:17Z", "path": "x-pack/plugin/stack/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/stack/10_basic.yml", "diffHunk": "@@ -64,7 +66,9 @@ setup:\n   - is_true: \\.ds-logs-foo-bar-000001.settings\n   - is_true: \\.ds-logs-foo-bar-000001.mappings\n   - match: { \\.ds-logs-foo-bar-000001.settings.index.lifecycle.name: \"logs\" }\n-  - is_true: \\.ds-logs-foo-bar-000001.mappings.properties.message\n+  - match: { \\.ds-logs-foo-bar-000001.mappings.properties.message.type: \"text\" }", "originalCommit": "7497f294634d6440523addeded796edfd4a9ad09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ce711a7cbe7e213d81b14e6299244169cf7cc5ff", "url": "https://github.com/elastic/elasticsearch/commit/ce711a7cbe7e213d81b14e6299244169cf7cc5ff", "message": "add mappings to metrics and synthetics too", "committedDate": "2020-12-22T09:45:42Z", "type": "commit"}, {"oid": "30e97b3d45469a1f52b51cf6d114b978e3d6ddbb", "url": "https://github.com/elastic/elasticsearch/commit/30e97b3d45469a1f52b51cf6d114b978e3d6ddbb", "message": "Merge branch 'master' into path-match-ip-message", "committedDate": "2020-12-22T09:48:05Z", "type": "commit"}, {"oid": "74cb397c912909af326fed9934e2742c1612ee34", "url": "https://github.com/elastic/elasticsearch/commit/74cb397c912909af326fed9934e2742c1612ee34", "message": "add index renaming", "committedDate": "2020-12-22T09:49:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxODgzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r547218831", "bodyText": "@jpountz With the recent development in ES, I started to ask myself if these should actually all be dynamic mapping for runtime fields? It would change the PR a bit as I think in this case we should bring back the global message field but everything else should match as runtime.", "author": "ruflin", "createdAt": "2020-12-22T11:15:21Z", "path": "x-pack/plugin/core/src/main/resources/logs-mappings.json", "diffHunk": "@@ -2,6 +2,25 @@\n   \"template\": {\n     \"mappings\": {\n       \"dynamic_templates\": [\n+        {\n+          \"match_ip\": {", "originalCommit": "74cb397c912909af326fed9934e2742c1612ee34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxOTQwMw==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r547219403", "bodyText": "In addition, having runtime fields would allow us to potentially also have runtime fields for things like *_time or *_date so these would work and still not be indexed. It would also allow an \"easy\" fix in case the detection was not correct (I assume).", "author": "ruflin", "createdAt": "2020-12-22T11:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxODgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTA1MTc1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r571051756", "bodyText": "Dynamic mappings are going to be a security issue.  Are there other ways to do this?", "author": "scunningham", "createdAt": "2021-02-05T15:31:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxODgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjMwMTUzOA==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r612301538", "bodyText": "@ruflin Can you dig a bit more into why you're thinking about using runtime fields?\nIf you are worried of failing to index some documents, then maybe we should add ignore_malformed:true to these ip mappings?\nIf you would like to allow users to change their minds, then either runtime fields or concrete fields is fine since we allow runtime fields to shadow the definition of concrete fields, so users would have the leisure of configuring their field differently via a runtime field on existing indices if they wanted to regardless of the decision we would make here.\n@scunningham There is no other way to do it. My understanding of the parallel thread on #68414 is that we would still allow dynamic mappings for trusted endpoints, so I believe that fine-tuning dynamic templates in these base templates still provides value.", "author": "jpountz", "createdAt": "2021-04-13T09:52:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxODgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTQ0MTg1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r615441856", "bodyText": "Lets assume we have a document with several *.ip fields inside. By default currently these are mapped to keywords which is not correct. So if someone wants to query for the *.ip fields, the result is unexpected because of the wrong type. In the ideal case, these fields would not be indexed at all because my assumption is, in most cases these are not used. And if they are used, a more specific dataset with a template will likely exist and have the mappings for it.\nThe above goes further: We currently index all the things as keyword. Instead we should only index a few fields and not index all the others and instead use runtime fields.", "author": "ruflin", "createdAt": "2021-04-18T19:18:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxODgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTg0ODc0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r615848747", "bodyText": "And if they are used, a more specific dataset with a template will likely exist and have the mappings for it.\n\nI think this holds true for our integrations, but we also need to take care of users who are onboarding new sources of data, e.g. because it's custom or because we don't have an integration for it (yet)?\nMy understanding is that host.ip should generally not be used, so we could make this one runtime. But the source IP field of a nginx.access dataset should be indexed in order to allow users to run cardinality aggregations on this field (how many users per day) or compare IPv4 traffic vs IPv6 traffic? In general it feels hard to me to make the assumption about the data that because it is an IP field, then generally it is not useful, even if that's the case most of the time in ECS.\nWhat about mapping host.ip as a runtime field and keeping that template for other fields whose name ends with .ip and map them as indexed ip fields?", "author": "jpountz", "createdAt": "2021-04-19T13:29:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxODgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQ5MzgxNg==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r617493816", "bodyText": "I checked with @tsg and the Security solution leverages these IP fields in a dashboard, so we should keep them indexed, at least for now.", "author": "jpountz", "createdAt": "2021-04-21T12:38:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxODgzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTIyMDAwNw==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r619220007", "bodyText": "@tsg What we discuss here is the default. Are the queries you run in the context of installed packages? If yes, these could still have a more specific definition that makes it index. The part here is only the global default if no other template exists.", "author": "ruflin", "createdAt": "2021-04-23T13:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxODgzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjI5ODYwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r612298609", "bodyText": "Do we really messages for metrics?", "author": "jpountz", "createdAt": "2021-04-13T09:48:00Z", "path": "x-pack/plugin/core/src/main/resources/metrics-mappings.json", "diffHunk": "@@ -2,6 +2,25 @@\n   \"template\": {\n     \"mappings\": {\n       \"dynamic_templates\": [\n+        {\n+          \"match_ip\": {\n+            \"match_mapping_type\": \"string\",\n+            \"match\": \"ip\",\n+            \"mapping\": {\n+              \"type\": \"ip\"\n+            }\n+          }\n+        },\n+        {\n+          \"match_message\": {\n+            \"match_mapping_type\": \"string\",\n+            \"match\": \"message\",\n+            \"mapping\": {\n+              \"type\": \"text\",\n+              \"norms\": false\n+            }\n+          }\n+        },", "originalCommit": "74cb397c912909af326fed9934e2742c1612ee34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTQ0MTI5MA==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r615441290", "bodyText": "@exekias Do you know how often we use it?\nOne of the main reasons I kept it in is to make sure it is compatible with ECS and not accidentally becomes a keyword.", "author": "ruflin", "createdAt": "2021-04-18T19:13:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjI5ODYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQ5ODM3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r617498372", "bodyText": "I asked @exekias in a different channel, who told me that metrics datasets cannot have a message field.", "author": "jpountz", "createdAt": "2021-04-21T12:44:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjI5ODYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjI5ODczNw==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r612298737", "bodyText": "do we really need messages for synthetics?", "author": "jpountz", "createdAt": "2021-04-13T09:48:12Z", "path": "x-pack/plugin/core/src/main/resources/synthetics-mappings.json", "diffHunk": "@@ -2,6 +2,25 @@\n   \"template\": {\n     \"mappings\": {\n       \"dynamic_templates\": [\n+        {\n+          \"match_ip\": {\n+            \"match_mapping_type\": \"string\",\n+            \"match\": \"ip\",\n+            \"mapping\": {\n+              \"type\": \"ip\"\n+            }\n+          }\n+        },\n+        {\n+          \"match_message\": {\n+            \"match_mapping_type\": \"string\",\n+            \"match\": \"message\",\n+            \"mapping\": {\n+              \"type\": \"text\",\n+              \"norms\": false\n+            }\n+          }\n+        },", "originalCommit": "74cb397c912909af326fed9934e2742c1612ee34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTQ0MTMyOA==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r615441328", "bodyText": "@andrewvc Do we need it?", "author": "ruflin", "createdAt": "2021-04-18T19:14:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjI5ODczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzQ5ODU3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r617498577", "bodyText": "I asked @andrewvc  in a different channel, who told me that metrics datasets cannot have a message field.", "author": "jpountz", "createdAt": "2021-04-21T12:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjI5ODczNw=="}], "type": "inlineReview"}, {"oid": "67bed573b22318f2cc655c1337e688d059a1f140", "url": "https://github.com/elastic/elasticsearch/commit/67bed573b22318f2cc655c1337e688d059a1f140", "message": "Merge branch 'master' into path-match-ip-message", "committedDate": "2021-04-21T12:41:26Z", "type": "commit"}, {"oid": "863bae7820b9b7587f6f4c3565927429a36b0e39", "url": "https://github.com/elastic/elasticsearch/commit/863bae7820b9b7587f6f4c3565927429a36b0e39", "message": "Increment registry version.", "committedDate": "2021-04-21T12:41:38Z", "type": "commit"}, {"oid": "5dc16be0b1f4fd2008509553cd67ee46cff0b756", "url": "https://github.com/elastic/elasticsearch/commit/5dc16be0b1f4fd2008509553cd67ee46cff0b756", "message": "Trim message field from metrics and synthetics templates.", "committedDate": "2021-04-21T12:48:11Z", "type": "commit"}, {"oid": "9ea0a35bdeb8e2a57734640713dc1bd25a155d76", "url": "https://github.com/elastic/elasticsearch/commit/9ea0a35bdeb8e2a57734640713dc1bd25a155d76", "message": "Fix tests.", "committedDate": "2021-04-21T13:02:33Z", "type": "commit"}, {"oid": "4707606f09d81557b875fb7ccccaa61aee870f11", "url": "https://github.com/elastic/elasticsearch/commit/4707606f09d81557b875fb7ccccaa61aee870f11", "message": "Factor conventions that are the same for all types into a single file.", "committedDate": "2021-04-21T13:26:34Z", "type": "commit"}, {"oid": "d6eb0afce630f332dc63b61094662de7afcd469a", "url": "https://github.com/elastic/elasticsearch/commit/d6eb0afce630f332dc63b61094662de7afcd469a", "message": "Merge branch 'master' into path-match-ip-message", "committedDate": "2021-04-21T14:04:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzkwODQzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r617908435", "bodyText": "This template says it's for general mapping conventions, but this uses synthetics which means this can't be generalized for other types? I think we might need to remove this line since this is used by the logs and metrics templates which previously specified the value as a different value", "author": "dakrone", "createdAt": "2021-04-21T21:52:26Z", "path": "x-pack/plugin/core/src/main/resources/data-streams-mappings.json", "diffHunk": "@@ -0,0 +1,73 @@\n+{\n+  \"template\": {\n+    \"mappings\": {\n+      \"dynamic_templates\": [\n+        {\n+          \"match_ip\": {\n+            \"match_mapping_type\": \"string\",\n+            \"match\": \"ip\",\n+            \"mapping\": {\n+              \"type\": \"ip\"\n+            }\n+          }\n+        },\n+        {\n+          \"strings_as_keyword\": {\n+            \"mapping\": {\n+              \"ignore_above\": 1024,\n+              \"type\": \"keyword\"\n+            },\n+            \"match_mapping_type\": \"string\"\n+          }\n+        }\n+      ],\n+      \"date_detection\": false,\n+      \"properties\": {\n+        \"@timestamp\": {\n+          \"type\": \"date\"\n+        },\n+        \"data_stream\": {\n+          \"properties\": {\n+            \"type\": {\n+              \"type\": \"constant_keyword\",\n+              \"value\": \"synthetics\"", "originalCommit": "d6eb0afce630f332dc63b61094662de7afcd469a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4c04815ab12d57821189701ac87b47a2e58cd3fe", "url": "https://github.com/elastic/elasticsearch/commit/4c04815ab12d57821189701ac87b47a2e58cd3fe", "message": "Merge remote-tracking branch 'origin/master' into path-match-ip-message", "committedDate": "2021-04-22T07:10:56Z", "type": "commit"}, {"oid": "c9249b5d78d29bfb7f6e32ab214833e168fa392f", "url": "https://github.com/elastic/elasticsearch/commit/c9249b5d78d29bfb7f6e32ab214833e168fa392f", "message": "Fix data_stream type.\n\nAlso move from `text` to `match_only_text`.", "committedDate": "2021-04-22T07:37:50Z", "type": "commit"}, {"oid": "db58ab94f794aa4fa58b17128a951b499c1f8c0a", "url": "https://github.com/elastic/elasticsearch/commit/db58ab94f794aa4fa58b17128a951b499c1f8c0a", "message": "Simplify host and observer mappings.", "committedDate": "2021-04-22T07:40:44Z", "type": "commit"}, {"oid": "9950d8b53f7794d75efcb02a13754a8771e73911", "url": "https://github.com/elastic/elasticsearch/commit/9950d8b53f7794d75efcb02a13754a8771e73911", "message": "Fix indentation.", "committedDate": "2021-04-22T07:43:30Z", "type": "commit"}, {"oid": "c4cb7fd4137d46979a9256ffd3d18bc726cef04f", "url": "https://github.com/elastic/elasticsearch/commit/c4cb7fd4137d46979a9256ffd3d18bc726cef04f", "message": "Fix test failure.", "committedDate": "2021-04-22T16:31:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODc4MjUyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r618782529", "bodyText": "I think we should apply the data-streams-mappings settings first, so that any changes made to the logs-mappings component template always take precedence over the generic data stream mappings.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \"logs-mappings\",\n          \n          \n            \n                \"data-streams-mappings\",\n          \n          \n            \n                \"logs-settings\"\n          \n          \n            \n                \"data-streams-mappings\",\n          \n          \n            \n                \"logs-mappings\",\n          \n          \n            \n                \"logs-settings\"\n          \n      \n    \n    \n  \n\nWhat do you think?", "author": "dakrone", "createdAt": "2021-04-22T22:31:30Z", "path": "x-pack/plugin/core/src/main/resources/logs-template.json", "diffHunk": "@@ -4,6 +4,7 @@\n   \"data_stream\": {},\n   \"composed_of\": [\n     \"logs-mappings\",\n+    \"data-streams-mappings\",\n     \"logs-settings\"", "originalCommit": "c4cb7fd4137d46979a9256ffd3d18bc726cef04f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTY1NDY4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r619654686", "bodyText": "Actually this would break tests because then the dynamic template that maps strings as keywords would take precedence over the dynamic template that maps message fields as match_only_text. In order to change the order, we would also need to configure unmatch:message on the default dynamic template that maps strings as keywords. What is your preference?", "author": "jpountz", "createdAt": "2021-04-24T12:44:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODc4MjUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODc4Mjc4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r618782785", "bodyText": "Same here with:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \"metrics-mappings\",\n          \n          \n            \n                \"data-streams-mappings\",\n          \n          \n            \n                \"data-streams-mappings\",\n          \n          \n            \n                \"metrics-mappings\",", "author": "dakrone", "createdAt": "2021-04-22T22:31:50Z", "path": "x-pack/plugin/core/src/main/resources/metrics-template.json", "diffHunk": "@@ -4,6 +4,7 @@\n   \"data_stream\": {},\n   \"composed_of\": [\n     \"metrics-mappings\",\n+    \"data-streams-mappings\",", "originalCommit": "c4cb7fd4137d46979a9256ffd3d18bc726cef04f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxODc4Mjk2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r618782965", "bodyText": "And same here with:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \"synthetics-mappings\",\n          \n          \n            \n                \"data-streams-mappings\",\n          \n          \n            \n                \"data-streams-mappings\",\n          \n          \n            \n                \"synthetics-mappings\",", "author": "dakrone", "createdAt": "2021-04-22T22:32:05Z", "path": "x-pack/plugin/core/src/main/resources/synthetics-template.json", "diffHunk": "@@ -4,6 +4,7 @@\n   \"data_stream\": {},\n   \"composed_of\": [\n     \"synthetics-mappings\",\n+    \"data-streams-mappings\",", "originalCommit": "c4cb7fd4137d46979a9256ffd3d18bc726cef04f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTE0NTg0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r619145845", "bodyText": "I think we could leave this one out.", "author": "ruflin", "createdAt": "2021-04-23T11:26:39Z", "path": "x-pack/plugin/core/src/main/resources/data-streams-mappings.json", "diffHunk": "@@ -0,0 +1,61 @@\n+{\n+  \"template\": {\n+    \"mappings\": {\n+      \"dynamic_templates\": [\n+        {\n+          \"match_ip\": {\n+            \"match_mapping_type\": \"string\",\n+            \"match\": \"ip\",\n+            \"mapping\": {\n+              \"type\": \"ip\"\n+            }\n+          }\n+        },\n+        {\n+          \"strings_as_keyword\": {\n+            \"mapping\": {\n+              \"ignore_above\": 1024,\n+              \"type\": \"keyword\"\n+            },\n+            \"match_mapping_type\": \"string\"\n+          }\n+        }\n+      ],\n+      \"date_detection\": false,\n+      \"properties\": {\n+        \"@timestamp\": {\n+          \"type\": \"date\"\n+        },\n+        \"data_stream\": {\n+          \"properties\": {\n+            \"dataset\": {\n+              \"type\": \"constant_keyword\"\n+            },\n+            \"namespace\": {\n+              \"type\": \"constant_keyword\"\n+            }\n+          }\n+        },\n+        \"ecs\": {\n+          \"properties\": {\n+            \"version\": {\n+              \"ignore_above\": 1024,\n+              \"type\": \"keyword\"\n+            }\n+          }\n+        },\n+        \"host\": {\n+          \"type\": \"object\"\n+        },\n+        \"observer\": {", "originalCommit": "c4cb7fd4137d46979a9256ffd3d18bc726cef04f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTE0NjE0MA==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r619146140", "bodyText": "Is this a breaking change?", "author": "ruflin", "createdAt": "2021-04-23T11:27:12Z", "path": "x-pack/plugin/core/src/main/resources/logs-mappings.json", "diffHunk": "@@ -3,51 +3,23 @@\n     \"mappings\": {\n       \"dynamic_templates\": [\n         {\n-          \"strings_as_keyword\": {\n+          \"match_message\": {\n+            \"match_mapping_type\": \"string\",\n+            \"match\": \"message\",\n             \"mapping\": {\n-              \"ignore_above\": 1024,\n-              \"type\": \"keyword\"\n-            },\n-            \"match_mapping_type\": \"string\"\n+              \"type\": \"match_only_text\"", "originalCommit": "c4cb7fd4137d46979a9256ffd3d18bc726cef04f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTY1NDUyMw==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r619654523", "bodyText": "What aspect are you concerned with? I expect this to be transparent for the vast majority of our users, and I started discussions with the ECS team to make similar changes on ECS.", "author": "jpountz", "createdAt": "2021-04-24T12:42:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTE0NjE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDEwMDMyNw==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r620100327", "bodyText": "Read up on it by now a bit more. What happens if a user runs a non \"supported\" query across logs-* and some message fields are text and some are match_only_text. Is an error returned or the non supported fields are just skipped?", "author": "ruflin", "createdAt": "2021-04-26T08:53:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTE0NjE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNDg3MDUyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64978#discussion_r624870525", "bodyText": "The only unsupported queries are span queries. If a span query is run, then all shards that have the field mapped as match_only_text will be ignored from the search response and reported as \"failed\".", "author": "jpountz", "createdAt": "2021-05-03T04:37:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTE0NjE0MA=="}], "type": "inlineReview"}, {"oid": "f7376e504d8eeec4bcee2eb1f26faa5f99ae9852", "url": "https://github.com/elastic/elasticsearch/commit/f7376e504d8eeec4bcee2eb1f26faa5f99ae9852", "message": "Move `message` dynamic template to the shared mapping template.", "committedDate": "2021-05-03T09:34:20Z", "type": "commit"}, {"oid": "42c9f58cfe8bc02bf9d66383597bc54919a53245", "url": "https://github.com/elastic/elasticsearch/commit/42c9f58cfe8bc02bf9d66383597bc54919a53245", "message": "Remove `observer` field.", "committedDate": "2021-05-03T09:35:40Z", "type": "commit"}, {"oid": "89eb06d324a81c39d99cf43b976d6037e03c7a71", "url": "https://github.com/elastic/elasticsearch/commit/89eb06d324a81c39d99cf43b976d6037e03c7a71", "message": "Merge branch 'master' into path-match-ip-message", "committedDate": "2021-05-04T12:51:47Z", "type": "commit"}]}