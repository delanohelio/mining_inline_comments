{"pr_number": 61589, "pr_title": "[ML] Check and install the latest template in the DFA executor", "pr_createdAt": "2020-08-26T15:01:44Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61589", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQwNjIwNA==", "url": "https://github.com/elastic/elasticsearch/pull/61589#discussion_r477406204", "bodyText": "Is this sufficient to mark the task as failed? Is there any other clean up to do?", "author": "davidkyle", "createdAt": "2020-08-26T15:50:15Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java", "diffHunk": "@@ -698,6 +703,20 @@ protected void nodeOperation(AllocatedPersistentTask task, StartDataFrameAnalyti\n                 return;\n             }\n \n+            ActionListener<Boolean> templateCheckListener = ActionListener.wrap(\n+                ok -> executeTask(analyticsTaskState, task),\n+                error -> {\n+                    Throwable cause = ExceptionsHelper.unwrapCause(error);\n+                    String msg = \"Failed to create internal index template [\" + inferenceIndexTemplate.getTemplateName() + \"]\";\n+                    logger.error(msg, cause);\n+                    task.markAsFailed(error);", "originalCommit": "ede0537fc56642f0700887473aa48d086ab7053f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxNTA0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/61589#discussion_r477415047", "bodyText": "task.updatePersistentTaskState(startedState, ActionListener.wrap(\n                    response -> manager.execute((DataFrameAnalyticsTask) task, DataFrameAnalyticsState.STARTED, clusterState),\n                    task::markAsFailed));\n\nonly calls task.markAsFailed, so this should be adequate.\n@dimitris-athanasiou do you have a different opinion?", "author": "benwtrent", "createdAt": "2020-08-26T16:03:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQwNjIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI0OTcxMw==", "url": "https://github.com/elastic/elasticsearch/pull/61589#discussion_r478249713", "bodyText": "Yes, it should be enough", "author": "dimitris-athanasiou", "createdAt": "2020-08-27T08:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQwNjIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMzQ4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/61589#discussion_r477413485", "bodyText": "I am not sold on this. Since INFERENCE_TEMPLATE is public and static, I am wondering if TransportStartDataFrameAnalyticsAction.TaskExecutor.java has a static array that it creates of all the templates it cares about.", "author": "benwtrent", "createdAt": "2020-08-26T16:00:47Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java", "diffHunk": "@@ -599,21 +601,24 @@ public void onFailure(Exception e) {\n         private final DataFrameAnalyticsAuditor auditor;\n         private final MlMemoryTracker memoryTracker;\n         private final IndexNameExpressionResolver resolver;\n+        private final IndexTemplateConfig inferenceIndexTemplate;\n \n         private volatile int maxMachineMemoryPercent;\n         private volatile int maxLazyMLNodes;\n         private volatile int maxOpenJobs;\n         private volatile ClusterState clusterState;\n \n         public TaskExecutor(Settings settings, Client client, ClusterService clusterService, DataFrameAnalyticsManager manager,\n-                            DataFrameAnalyticsAuditor auditor, MlMemoryTracker memoryTracker, IndexNameExpressionResolver resolver) {\n+                            DataFrameAnalyticsAuditor auditor, MlMemoryTracker memoryTracker, IndexNameExpressionResolver resolver,\n+                            IndexTemplateConfig inferenceIndexTemplate) {", "originalCommit": "ede0537fc56642f0700887473aa48d086ab7053f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIzNjI5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/61589#discussion_r478236299", "bodyText": "TaskExecutor has just 1 template it cares about today. If I use an array I have to iterate that array using call backs in each put request this harms readability and is confusing as there is no requirement for that code today. If in future multiple templates need to be Put the change can be made then.\nUsing a static reference is fine but it would have to be initialised from the static member in MlIndexTemplateRegistry meaning this class would have to 'know' about the template registry as well as IndexTemplateConfig.", "author": "davidkyle", "createdAt": "2020-08-27T08:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMzQ4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM1NTA3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/61589#discussion_r478355071", "bodyText": "meaning this class would have to 'know' about the template registry as well as IndexTemplateConfig\n\nIts just a class path. If you would rather extract the template configs to another class, then thats fine too.\nThe complexity of multiple action listeners is assuaged by org.elasticsearch.action.support.GroupedActionListener.\nI won't \"die on this hill\", but I do think adding a parameter here doesn't really make sense.", "author": "benwtrent", "createdAt": "2020-08-27T11:45:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQxMzQ4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI1MDUyNA==", "url": "https://github.com/elastic/elasticsearch/pull/61589#discussion_r478250524", "bodyText": "nit: should this be hasIndexTemplate?", "author": "dimitris-athanasiou", "createdAt": "2020-08-27T08:34:52Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/utils/MlIndexAndAlias.java", "diffHunk": "@@ -215,4 +219,52 @@ private static void updateWriteAlias(Client client,\n                 listener::onFailure),\n             client.admin().indices()::aliases);\n     }\n+\n+    /**\n+     * Installs the index template specified by {@code templateConfig} if it is not in already\n+     * installed in {@code clusterState}.\n+     *\n+     * The check for presence is simple and will return the listener on\n+     * the calling thread if successful. If the template has to be installed\n+     * an async call will be made.\n+     *\n+     * @param clusterState The cluster state\n+     * @param client For putting the template\n+     * @param templateConfig The config\n+     * @param listener Async listener\n+     */\n+    public static void installIndexTemplateIfRequired(\n+        ClusterState clusterState,\n+        Client client,\n+        IndexTemplateConfig templateConfig,\n+        ActionListener<Boolean> listener\n+    ) {\n+        String templateName = templateConfig.getTemplateName();\n+\n+        // The check for existence of the template is against the cluster state, so very cheap\n+        if (haveIndexTemplate(clusterState, templateName)) {\n+            listener.onResponse(true);\n+            return;\n+        }\n+\n+        PutIndexTemplateRequest request = new PutIndexTemplateRequest(templateName)\n+            .source(templateConfig.loadBytes(), XContentType.JSON);\n+        request.masterNodeTimeout(TimeValue.timeValueMinutes(1));\n+\n+        ActionListener<AcknowledgedResponse> innerListener = ActionListener.wrap(\n+            response ->  {\n+                if (response.isAcknowledged() == false) {\n+                    logger.error(\"error adding legacy template [{}], request was not acknowledged\", templateName);\n+                }\n+                listener.onResponse(response.isAcknowledged());\n+            },\n+            listener::onFailure);\n+\n+        executeAsyncWithOrigin(client.threadPool().getThreadContext(), ML_ORIGIN, request, innerListener,\n+            client.admin().indices()::putTemplate);\n+    }\n+\n+    static boolean haveIndexTemplate(ClusterState state, String templateName) {", "originalCommit": "ede0537fc56642f0700887473aa48d086ab7053f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI1MTgzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/61589#discussion_r478251835", "bodyText": "Should we make this a warn? If it's an error I would expect it causes listener.onFailure to fire.", "author": "dimitris-athanasiou", "createdAt": "2020-08-27T08:37:03Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/utils/MlIndexAndAlias.java", "diffHunk": "@@ -215,4 +219,52 @@ private static void updateWriteAlias(Client client,\n                 listener::onFailure),\n             client.admin().indices()::aliases);\n     }\n+\n+    /**\n+     * Installs the index template specified by {@code templateConfig} if it is not in already\n+     * installed in {@code clusterState}.\n+     *\n+     * The check for presence is simple and will return the listener on\n+     * the calling thread if successful. If the template has to be installed\n+     * an async call will be made.\n+     *\n+     * @param clusterState The cluster state\n+     * @param client For putting the template\n+     * @param templateConfig The config\n+     * @param listener Async listener\n+     */\n+    public static void installIndexTemplateIfRequired(\n+        ClusterState clusterState,\n+        Client client,\n+        IndexTemplateConfig templateConfig,\n+        ActionListener<Boolean> listener\n+    ) {\n+        String templateName = templateConfig.getTemplateName();\n+\n+        // The check for existence of the template is against the cluster state, so very cheap\n+        if (haveIndexTemplate(clusterState, templateName)) {\n+            listener.onResponse(true);\n+            return;\n+        }\n+\n+        PutIndexTemplateRequest request = new PutIndexTemplateRequest(templateName)\n+            .source(templateConfig.loadBytes(), XContentType.JSON);\n+        request.masterNodeTimeout(TimeValue.timeValueMinutes(1));\n+\n+        ActionListener<AcknowledgedResponse> innerListener = ActionListener.wrap(\n+            response ->  {\n+                if (response.isAcknowledged() == false) {\n+                    logger.error(\"error adding legacy template [{}], request was not acknowledged\", templateName);", "originalCommit": "ede0537fc56642f0700887473aa48d086ab7053f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI4MjgxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/61589#discussion_r478282811", "bodyText": "It is consistent with IndexTemplateRegistry\n\n  \n    \n      elasticsearch/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/template/IndexTemplateRegistry.java\n    \n    \n         Line 303\n      in\n      3b68df2\n    \n    \n    \n    \n\n        \n          \n           logger.error(\"error adding legacy template [{}] for [{}], request was not acknowledged\", \n        \n    \n  \n\n\nTBH I wasn't sure what it would mean if isAcknowledged == false but I agree it makes more sense as a warning so I've changed it to warning.\nLooking at the put template code the response cannot be false but that might change\n\n  \n    \n      elasticsearch/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java\n    \n    \n         Line 763\n      in\n      261250d\n    \n    \n    \n    \n\n        \n          \n           listener.onResponse(new PutResponse(true));", "author": "davidkyle", "createdAt": "2020-08-27T09:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI1MTgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMyMzk4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/61589#discussion_r478323985", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void testInstallIndexTemplateIfRequired_TemplateExist() {\n          \n          \n            \n                public void testInstallIndexTemplateIfRequired_TemplateExists() {", "author": "przemekwitek", "createdAt": "2020-08-27T10:42:03Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/utils/MlIndexAndAliasTests.java", "diffHunk": "@@ -116,6 +120,34 @@ public void verifyNoMoreInteractionsWithMocks() {\n         verifyNoMoreInteractions(indicesAdminClient, listener);\n     }\n \n+    public void testInstallIndexTemplateIfRequired_TemplateExist() {", "originalCommit": "c1cbc38ee04108dc90ca74ef55975b449f351998", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMyNDQ4OA==", "url": "https://github.com/elastic/elasticsearch/pull/61589#discussion_r478324488", "bodyText": "Could add the following line here?\ninOrder.verifyNoMoreInteractions();", "author": "przemekwitek", "createdAt": "2020-08-27T10:43:11Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/utils/MlIndexAndAliasTests.java", "diffHunk": "@@ -116,6 +120,34 @@ public void verifyNoMoreInteractionsWithMocks() {\n         verifyNoMoreInteractions(indicesAdminClient, listener);\n     }\n \n+    public void testInstallIndexTemplateIfRequired_TemplateExist() {\n+        ClusterState clusterState = createClusterState(Collections.emptyMap(),\n+            Collections.singletonMap(InferenceIndexConstants.LATEST_INDEX_NAME,\n+                createIndexTemplateMetaData(InferenceIndexConstants.LATEST_INDEX_NAME,\n+                    Collections.singletonList(InferenceIndexConstants.LATEST_INDEX_NAME))));\n+\n+        IndexTemplateConfig inferenceTemplate = new IndexTemplateConfig(InferenceIndexConstants.LATEST_INDEX_NAME,\n+            \"not_a_real_file.json\", Version.CURRENT.id, \"xpack.ml.version\",\n+            Collections.singletonMap(\"xpack.ml.version.id\", String.valueOf(Version.CURRENT.id)));\n+\n+        MlIndexAndAlias.installIndexTemplateIfRequired(clusterState, client, inferenceTemplate, listener);\n+        verify(listener).onResponse(true);\n+        verifyNoMoreInteractions(client);\n+    }\n+\n+    public void testInstallIndexTemplateIfRequired() {\n+        ClusterState clusterState = createClusterState(Collections.emptyMap());\n+\n+        IndexTemplateConfig inferenceTemplate = new IndexTemplateConfig(InferenceIndexConstants.LATEST_INDEX_NAME,\n+            \"/org/elasticsearch/xpack/core/ml/inference_index_template.json\", Version.CURRENT.id, \"xpack.ml.version\",\n+            Collections.singletonMap(\"xpack.ml.version.id\", String.valueOf(Version.CURRENT.id)));\n+\n+        MlIndexAndAlias.installIndexTemplateIfRequired(clusterState, client, inferenceTemplate, listener);\n+        InOrder inOrder = inOrder(indicesAdminClient, listener);\n+        inOrder.verify(indicesAdminClient).putTemplate(any(), any());\n+        inOrder.verify(listener).onResponse(true);", "originalCommit": "c1cbc38ee04108dc90ca74ef55975b449f351998", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM0OTA3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61589#discussion_r478349073", "bodyText": "Good point. There is an After method which calls verifyNoMoreInteractions on the mocks but you couldn't have known that from the diff", "author": "davidkyle", "createdAt": "2020-08-27T11:34:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMyNDQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM1Mzk4OA==", "url": "https://github.com/elastic/elasticsearch/pull/61589#discussion_r478353988", "bodyText": "Actually, I should have known since I wrote the method ;) I just forgot about it :/", "author": "przemekwitek", "createdAt": "2020-08-27T11:43:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMyNDQ4OA=="}], "type": "inlineReview"}, {"oid": "730e10c9869383bf66dd15bb72f98be7905b3ecd", "url": "https://github.com/elastic/elasticsearch/commit/730e10c9869383bf66dd15bb72f98be7905b3ecd", "message": "Check and install the latest template in the DFA executor", "committedDate": "2020-09-01T09:20:36Z", "type": "commit"}, {"oid": "baa361291eb5ab6df976467255ebd32341ca0296", "url": "https://github.com/elastic/elasticsearch/commit/baa361291eb5ab6df976467255ebd32341ca0296", "message": "Add tests", "committedDate": "2020-09-01T09:20:36Z", "type": "commit"}, {"oid": "3d34786f87c5541bb997387e8bbeaa6cc4b9f4fa", "url": "https://github.com/elastic/elasticsearch/commit/3d34786f87c5541bb997387e8bbeaa6cc4b9f4fa", "message": "Mark as failed if put template fails", "committedDate": "2020-09-01T09:20:36Z", "type": "commit"}, {"oid": "fa6642f6b5852989bcca07f0ee04cfb20dfdaf10", "url": "https://github.com/elastic/elasticsearch/commit/fa6642f6b5852989bcca07f0ee04cfb20dfdaf10", "message": "Address review", "committedDate": "2020-09-01T09:20:36Z", "type": "commit"}, {"oid": "3d892f6ac55f15820b441a54ad4237d1c55f6f23", "url": "https://github.com/elastic/elasticsearch/commit/3d892f6ac55f15820b441a54ad4237d1c55f6f23", "message": "typo in test name", "committedDate": "2020-09-01T09:20:36Z", "type": "commit"}, {"oid": "3d892f6ac55f15820b441a54ad4237d1c55f6f23", "url": "https://github.com/elastic/elasticsearch/commit/3d892f6ac55f15820b441a54ad4237d1c55f6f23", "message": "typo in test name", "committedDate": "2020-09-01T09:20:36Z", "type": "forcePushed"}]}