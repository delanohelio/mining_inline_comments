{"pr_number": 56209, "pr_title": "Save Shard ID Serializations in Bulk Requests", "pr_createdAt": "2020-05-05T14:44:36Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56209", "timeline": [{"oid": "c59ea6c24b7196b5af7604821d1a853deb640d51", "url": "https://github.com/elastic/elasticsearch/commit/c59ea6c24b7196b5af7604821d1a853deb640d51", "message": "indices request IT missing", "committedDate": "2020-05-04T18:35:30Z", "type": "commit"}, {"oid": "60d83def8280136070f78c19030a3405886cbfa0", "url": "https://github.com/elastic/elasticsearch/commit/60d83def8280136070f78c19030a3405886cbfa0", "message": "works but not bwc", "committedDate": "2020-05-05T07:55:19Z", "type": "commit"}, {"oid": "6d12182c5b8f667b9bc6ce9c8992918e2059036d", "url": "https://github.com/elastic/elasticsearch/commit/6d12182c5b8f667b9bc6ce9c8992918e2059036d", "message": "works but not bwc", "committedDate": "2020-05-05T07:58:47Z", "type": "commit"}, {"oid": "3c8d01d3f57419dc6101966ae5dc68e5cf937e81", "url": "https://github.com/elastic/elasticsearch/commit/3c8d01d3f57419dc6101966ae5dc68e5cf937e81", "message": "bck", "committedDate": "2020-05-05T14:15:41Z", "type": "commit"}, {"oid": "3f4c66745fe866ed497e690acbca7c1ed6cf4d3f", "url": "https://github.com/elastic/elasticsearch/commit/3f4c66745fe866ed497e690acbca7c1ed6cf4d3f", "message": "Merge remote-tracking branch 'elastic/master' into save-shard-id-serialization", "committedDate": "2020-05-05T14:28:30Z", "type": "commit"}, {"oid": "a0d2b716130f16b9e51ebde4b3ecfff017890fdb", "url": "https://github.com/elastic/elasticsearch/commit/a0d2b716130f16b9e51ebde4b3ecfff017890fdb", "message": "nope", "committedDate": "2020-05-05T15:19:13Z", "type": "commit"}, {"oid": "9fc460a93607960e55cdd170009b9f79ee0ddbb7", "url": "https://github.com/elastic/elasticsearch/commit/9fc460a93607960e55cdd170009b9f79ee0ddbb7", "message": "Merge remote-tracking branch 'elastic/master' into save-shard-id-serialization", "committedDate": "2020-05-05T15:53:01Z", "type": "commit"}, {"oid": "e9fbff726a70d56b3aa8b0a3dffa397fbe6bdcfb", "url": "https://github.com/elastic/elasticsearch/commit/e9fbff726a70d56b3aa8b0a3dffa397fbe6bdcfb", "message": "shorter", "committedDate": "2020-05-05T16:01:13Z", "type": "commit"}, {"oid": "b6a7b2a57647d6ba31592f0f91ce1de29c3e7451", "url": "https://github.com/elastic/elasticsearch/commit/b6a7b2a57647d6ba31592f0f91ce1de29c3e7451", "message": "much shorter", "committedDate": "2020-05-05T16:10:19Z", "type": "commit"}, {"oid": "385d8cc3be5da7511848e1aa4e8d48f10ddc5b93", "url": "https://github.com/elastic/elasticsearch/commit/385d8cc3be5da7511848e1aa4e8d48f10ddc5b93", "message": "much shorter", "committedDate": "2020-05-05T16:18:45Z", "type": "commit"}, {"oid": "a9b61113e458326e1b7b1ac18bf9dcf10c27ef26", "url": "https://github.com/elastic/elasticsearch/commit/a9b61113e458326e1b7b1ac18bf9dcf10c27ef26", "message": "much shorter", "committedDate": "2020-05-05T16:22:09Z", "type": "commit"}, {"oid": "ad1d244782cb3e2563697cbc86177d94389aa1c0", "url": "https://github.com/elastic/elasticsearch/commit/ad1d244782cb3e2563697cbc86177d94389aa1c0", "message": "much shorter", "committedDate": "2020-05-05T16:25:17Z", "type": "commit"}, {"oid": "94663644610ccce658e8a45d5b2209392ceb6f7d", "url": "https://github.com/elastic/elasticsearch/commit/94663644610ccce658e8a45d5b2209392ceb6f7d", "message": "much shorter", "committedDate": "2020-05-05T16:29:23Z", "type": "commit"}, {"oid": "900e01364fc0d5d96e62c3bc39b7a62bb714570b", "url": "https://github.com/elastic/elasticsearch/commit/900e01364fc0d5d96e62c3bc39b7a62bb714570b", "message": "much shorter", "committedDate": "2020-05-05T16:30:40Z", "type": "commit"}, {"oid": "2c5b6eac71aeed886ccc38fd51f82aa935e99a66", "url": "https://github.com/elastic/elasticsearch/commit/2c5b6eac71aeed886ccc38fd51f82aa935e99a66", "message": "much shorter", "committedDate": "2020-05-05T16:32:05Z", "type": "commit"}, {"oid": "828da53fc5c0e14d5695d958664d43fd73eb6988", "url": "https://github.com/elastic/elasticsearch/commit/828da53fc5c0e14d5695d958664d43fd73eb6988", "message": "much shorter", "committedDate": "2020-05-05T16:32:53Z", "type": "commit"}, {"oid": "d1b5ef1589e6694d4627c0b2b55e8494632f653b", "url": "https://github.com/elastic/elasticsearch/commit/d1b5ef1589e6694d4627c0b2b55e8494632f653b", "message": "much shorter", "committedDate": "2020-05-05T16:38:13Z", "type": "commit"}, {"oid": "b145a7441be895fbd95fa0665801c0dcc9bb0548", "url": "https://github.com/elastic/elasticsearch/commit/b145a7441be895fbd95fa0665801c0dcc9bb0548", "message": "much shorter", "committedDate": "2020-05-05T16:39:11Z", "type": "commit"}, {"oid": "c1dd9c2aa81aa75209afdc96b2deced9e4f69f43", "url": "https://github.com/elastic/elasticsearch/commit/c1dd9c2aa81aa75209afdc96b2deced9e4f69f43", "message": "docs", "committedDate": "2020-05-05T19:06:32Z", "type": "commit"}, {"oid": "7e6aaea3bae3a9c44defe4145b26494644779539", "url": "https://github.com/elastic/elasticsearch/commit/7e6aaea3bae3a9c44defe4145b26494644779539", "message": "Merge remote-tracking branch 'elastic/master' into save-shard-id-serialization", "committedDate": "2020-05-05T19:06:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM0NDQ0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56209#discussion_r420344445", "bodyText": "Having to maintain the old format for 8.x (here and all throughout this change set pretty much) is quite annoying but I think unavoidable because we need to continue to support a 7.x TransportClient sending us a BulkRequest.", "author": "original-brownbear", "createdAt": "2020-05-05T19:11:57Z", "path": "server/src/main/java/org/elasticsearch/action/DocWriteRequest.java", "diffHunk": "@@ -195,16 +197,22 @@ public static OpType fromString(String sOpType) {\n         }\n     }\n \n-    /** read a document write (index/delete/update) request */\n-    static DocWriteRequest<?> readDocumentRequest(StreamInput in) throws IOException {\n+    /**\n+     * Read a document write (index/delete/update) request\n+     *\n+     * @param shardId shard id of the request. {@code null} when reading as part of a {@link org.elasticsearch.action.bulk.BulkRequest}", "originalCommit": "7e6aaea3bae3a9c44defe4145b26494644779539", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTAwODU0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56209#discussion_r431008542", "bodyText": "That sounds suspicious. The transport client is deprecated in 7.x, do we expect it to work at all against a cluster containing v8 nodes? Even if we do, do we expect it to work even if the client version is earlier than 7.last? Perhaps I'm missing something here...", "author": "DaveCTurner", "createdAt": "2020-05-27T10:13:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM0NDQ0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMzMzQ1MA==", "url": "https://github.com/elastic/elasticsearch/pull/56209#discussion_r431333450", "bodyText": "The transport client is deprecated in 7.x, do we expect it to work at all against a cluster containing v8 nodes?\n\nGood question. I guess as of today it will be able to connect to a v8 cluster at least with 7.last.\n\nEven if we do, do we expect it to work even if the client version is earlier than 7.last?\n\nNo I don't think so. Only 7.last should work, ES won't connect to anything older.\n=> still ... it would be my understanding that we have to support this request in 8.x unless we patch the transport client in 7.last to not connect to 8.x nodes. (I'd be all for that)\nNo matter what we do there, I'd keep this compatibility step here for this PR so I can backport it to 7.x as is. We can then look into if and how we want to go about removing over the wire serialization for BulkRequest in 8.x in a separate issue?", "author": "original-brownbear", "createdAt": "2020-05-27T17:52:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM0NDQ0NQ=="}], "type": "inlineReview"}, {"oid": "04c770b9661c0fdb0f80b3cfd2041cb1ae051f2e", "url": "https://github.com/elastic/elasticsearch/commit/04c770b9661c0fdb0f80b3cfd2041cb1ae051f2e", "message": "simpler", "committedDate": "2020-05-05T19:14:01Z", "type": "commit"}, {"oid": "84e3912f6930f26e2fd41b73a573402a35c4e423", "url": "https://github.com/elastic/elasticsearch/commit/84e3912f6930f26e2fd41b73a573402a35c4e423", "message": "cs", "committedDate": "2020-05-05T20:24:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3MzY4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56209#discussion_r420573689", "bodyText": "This null check is kind of annoying. In many cases we logically wouldn't need it (technically) because we are serializing a request instance that doesn't have the shard id set yet as part of a bulk request (but is known) on the coordinating node (when first sorting the various bulk request parts per shard). We can make a follow-up improvement here to make use of the known ShardId in these cases so that we don't needlessly serialize the index name if it isn't an alias.", "author": "original-brownbear", "createdAt": "2020-05-06T06:39:59Z", "path": "server/src/main/java/org/elasticsearch/action/support/replication/ReplicationRequest.java", "diffHunk": "@@ -197,6 +210,23 @@ public void writeTo(StreamOutput out) throws IOException {\n         out.writeVLong(routedBasedOnClusterVersion);\n     }\n \n+    /**\n+     * Thin serialization that does not write {@link #shardId} and will only write {@link #index} if it is different from the index name in\n+     * {@link #shardId}.\n+     */\n+    public void writeThin(StreamOutput out) throws IOException {\n+        super.writeTo(out);\n+        waitForActiveShards.writeTo(out);\n+        out.writeTimeValue(timeout);\n+        if (shardId != null && index.equals(shardId.getIndexName())) {", "originalCommit": "84e3912f6930f26e2fd41b73a573402a35c4e423", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3NDIyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56209#discussion_r420574221", "bodyText": "Same here, the ShardId is often known on the coordinating node, we can improve this situation to less often serialize the actual name.", "author": "original-brownbear", "createdAt": "2020-05-06T06:41:26Z", "path": "server/src/main/java/org/elasticsearch/action/support/single/instance/InstanceShardOperationRequest.java", "diffHunk": "@@ -130,5 +141,16 @@ public void writeTo(StreamOutput out) throws IOException {\n         out.writeOptionalString(concreteIndex);\n     }\n \n+    public void writeThin(StreamOutput out) throws IOException {\n+        super.writeTo(out);\n+        if (shardId != null && index.equals(shardId.getIndexName())) {", "originalCommit": "84e3912f6930f26e2fd41b73a573402a35c4e423", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d65a698652f6f7b441d02ae1fa6f760c106c9a18", "url": "https://github.com/elastic/elasticsearch/commit/d65a698652f6f7b441d02ae1fa6f760c106c9a18", "message": "Merge remote-tracking branch 'elastic/master' into save-shard-id-serialization", "committedDate": "2020-06-23T07:23:13Z", "type": "commit"}]}