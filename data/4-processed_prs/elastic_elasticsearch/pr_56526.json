{"pr_number": 56526, "pr_title": "Test adjustments for FIPS 140", "pr_createdAt": "2020-05-11T16:17:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56526", "timeline": [{"oid": "091d4255da7b0c07c0d912c80c58d608b37ca373", "url": "https://github.com/elastic/elasticsearch/commit/091d4255da7b0c07c0d912c80c58d608b37ca373", "message": "Test adjustments for FIPS 140\n\nThis change aims to fix our setup in CI so that we can run 7.x in\nFIPS 140 mode. The major issue that we have in 7.x and did not\nhave in master is that we can't use the diagnostic trust manager\nin FIPS mode in Java 8 with SunJSSE in FIPS approved mode as it\nexplicitly disallows the wrapping of X509TrustManager.\n\nPrevious attempts like #56427 and #52211 focused on disabling the\nsetting in all of our tests when creating a Settings object or\non setting fips_mode.enabled accordingly (which implicitly disables\nthe diagnostic trust manager). The attempts weren't future proof\nthough as nothing would forbid someone to add new tests without\nsetting the necessary setting and forcing this would be very\ninconvenient for any other case ( see\nhttps://github.com/elastic/elasticsearch/pull/56427#issue-415264309\nfor the full argumentation).\n\nThis change introduces a system property that effectively bypasses\nthe configuration value of xpack.security.ssl.diagnose.trust and\ndisables the diagnostic trust manager. We will then set this\nsystem property in our periodic CI jobs for Java 8.", "committedDate": "2020-05-11T16:06:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI0OTY1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56526#discussion_r423249651", "bodyText": "for consistency these should be indented 2 spaces", "author": "rjernst", "createdAt": "2020-05-11T18:54:24Z", "path": "plugins/discovery-ec2/build.gradle", "diffHunk": "@@ -64,12 +64,34 @@ task writeTestJavaPolicy {\n       throw new GradleException(\"failed to create temporary directory [${tmp}]\")\n     }\n     final File javaPolicy = file(\"${tmp}/java.policy\")\n-    javaPolicy.write(\n-      [\n-        \"grant {\",\n-        \"  permission java.util.PropertyPermission \\\"com.amazonaws.sdk.ec2MetadataServiceEndpointOverride\\\", \\\"write\\\";\",\n-        \"};\"\n-      ].join(\"\\n\"))\n+    if (BuildParams.inFipsJvm) {\n+      javaPolicy.write(\n+        [\n+          \"grant {\",\n+          \"permission java.security.SecurityPermission \\\"putProviderProperty.BCFIPS\\\";\",", "originalCommit": "091d4255da7b0c07c0d912c80c58d608b37ca373", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3Njg1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56526#discussion_r423276855", "bodyText": "Yeah my plugin preferences keep reverting to default every time I re-import the project, will fix", "author": "jkakavas", "createdAt": "2020-05-11T19:45:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI0OTY1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ4NzI3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56526#discussion_r423487272", "bodyText": "Oh, now I saw the actual line you were referring to. Still, will fix", "author": "jkakavas", "createdAt": "2020-05-12T06:21:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI0OTY1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MzEyNg==", "url": "https://github.com/elastic/elasticsearch/pull/56526#discussion_r423253126", "bodyText": "What does the prefixed = do here? I wasn't able to find documentation on that special syntax. We should add a comment explaining for future readers.", "author": "rjernst", "createdAt": "2020-05-11T19:00:17Z", "path": "plugins/discovery-ec2/build.gradle", "diffHunk": "@@ -80,7 +102,11 @@ test {\n \n   // this is needed to manipulate com.amazonaws.sdk.ec2MetadataServiceEndpointOverride system property\n   // it is better rather disable security manager at all with `systemProperty 'tests.security.manager', 'false'`\n-  systemProperty 'java.security.policy', \"file://${buildDir}/tmp/java.policy\"\n+  if (BuildParams.inFipsJvm){\n+    systemProperty 'java.security.policy', \"=file://${buildDir}/tmp/java.policy\"", "originalCommit": "091d4255da7b0c07c0d912c80c58d608b37ca373", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3OTc1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56526#discussion_r423279755", "bodyText": "I explain this here \n  \n    \n      elasticsearch/buildSrc/src/main/groovy/org/elasticsearch/gradle/BuildPlugin.groovy\n    \n    \n         Line 165\n      in\n      1fe5264\n    \n    \n    \n    \n\n        \n          \n           // Using the key==value format to override default JVM security settings and policy \n        \n    \n  \n\n, if you think we should copy the explanation in every use, happy to add it here too", "author": "jkakavas", "createdAt": "2020-05-11T19:50:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MzEyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MzkwMw==", "url": "https://github.com/elastic/elasticsearch/pull/56526#discussion_r423253903", "bodyText": "Why can't we pass in fips mode as disabled in our tests properties from BuildPlugin? I don't see the need for another property, and don't like this leaking into production code.", "author": "rjernst", "createdAt": "2020-05-11T19:01:48Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ssl/SSLService.java", "diffHunk": "@@ -829,7 +829,12 @@ private static String sslContextAlgorithm(List<String> supportedProtocols) {\n     }\n \n     private boolean shouldEnableDiagnoseTrust() {\n-        if (XPackSettings.FIPS_MODE_ENABLED.get(settings) && DIAGNOSE_TRUST_EXCEPTIONS_SETTING.exists(settings) == false ) {\n+        // We disable the DiagnosticTrustManager in tests in Java 8 in FIPS 140 mode, as we're not allowed to wrap X509TrustManager\n+        final boolean explicitlyDisable = Boolean.parseBoolean(System.getProperty(\"es.disable.diagnostic.trust.manager\", \"false\"));", "originalCommit": "091d4255da7b0c07c0d912c80c58d608b37ca373", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NDM4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56526#discussion_r423284381", "bodyText": "Because we need this to be set in all of our tests even when we ie build an SslService from an arbitrary settings object, and doing so in build plugin isn't enough, the previous two PRs contain much more detail, let me know if I should elaborate.\nI didn't reuse the tests.fips.enabled setting do that this can be selectively set when running in java 8 only. Leaking into production code wasnt my first option either but the alternatives were brittle for the reasons I explain in the description of the previous PR", "author": "jkakavas", "createdAt": "2020-05-11T19:59:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MzkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg5ODQxMA==", "url": "https://github.com/elastic/elasticsearch/pull/56526#discussion_r423898410", "bodyText": "If java 8 is the problem, shouldn't we always disable the diagnostic trust manager for that version? Why does this only apply to tests?", "author": "rjernst", "createdAt": "2020-05-12T17:11:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MzkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkyMDk1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56526#discussion_r423920955", "bodyText": "Its java 8 with with SunJSSE in fips mode that is problematic, I explain this in detail in the previous two PRs, in retrospect I should have carried that discussion over to this PR.\nWe don't want to arbitrarily assume that there is no other way to run in fips mode in java 8, even if the problematic one is one of the most popular, so we didn't want to disable the diagnostic trust manager for all cases.\nMaybe a short sync chat is worth to give you the whole context if you still have concerns about this ?", "author": "jkakavas", "createdAt": "2020-05-12T17:48:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MzkwMw=="}], "type": "inlineReview"}, {"oid": "c3c7af6b8332f7bd5514580cc2594ae4d2f7dadd", "url": "https://github.com/elastic/elasticsearch/commit/c3c7af6b8332f7bd5514580cc2594ae4d2f7dadd", "message": "address feedback", "committedDate": "2020-05-12T06:23:22Z", "type": "commit"}, {"oid": "58539f98786bdb994401df33b2fcc5f722cfdf0e", "url": "https://github.com/elastic/elasticsearch/commit/58539f98786bdb994401df33b2fcc5f722cfdf0e", "message": "remove pasted text", "committedDate": "2020-05-12T06:32:07Z", "type": "commit"}, {"oid": "ba92aeb4b6b7870fd48104e82b255186e439c5d7", "url": "https://github.com/elastic/elasticsearch/commit/ba92aeb4b6b7870fd48104e82b255186e439c5d7", "message": "Merge branch '7.x' into fips-ci-7.x-take2", "committedDate": "2020-05-12T07:10:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU2ODY2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56526#discussion_r423568665", "bodyText": "Is the null to test the store type can be auto-detected?", "author": "ywangd", "createdAt": "2020-05-12T08:48:58Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLServiceTests.java", "diffHunk": "@@ -90,14 +90,19 @@\n \n     @Before\n     public void setup() throws Exception {\n-        // Randomise the keystore type (jks/PKCS#12)\n-        if (randomBoolean()) {\n-            testnodeStore = getDataPath(\"/org/elasticsearch/xpack/security/transport/ssl/certs/simple/testnode.jks\");\n-            // The default is to use JKS. Randomly test with explicit and with the default value.\n-            testnodeStoreType = \"jks\";\n-        } else {\n+        // Randomise the keystore type (jks/PKCS#12) when possible\n+        if (inFipsJvm()) {\n             testnodeStore = getDataPath(\"/org/elasticsearch/xpack/security/transport/ssl/certs/simple/testnode.p12\");\n             testnodeStoreType = randomBoolean() ? \"PKCS12\" : null;", "originalCommit": "ba92aeb4b6b7870fd48104e82b255186e439c5d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU4MDQ2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56526#discussion_r423580461", "bodyText": "yes, it shouldn't make a difference as we should be able to auto detect. Arguably we don't need to test this here, but I believe it was originally there too and I didn't introduce this in this change", "author": "jkakavas", "createdAt": "2020-05-12T09:06:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU2ODY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU3Mzg1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56526#discussion_r423573851", "bodyText": "Is it possible to make this work if p12 file is used?", "author": "ywangd", "createdAt": "2020-05-12T08:56:43Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/ssl/SSLReloadDuringStartupIntegTests.java", "diffHunk": "@@ -28,6 +29,11 @@\n @ClusterScope(transportClientRatio = 0)\n public class SSLReloadDuringStartupIntegTests extends SecurityIntegTestCase {\n \n+    @BeforeClass\n+    public static void skipInFips() {\n+        assumeFalse(\"Can't use JKS keystores in FIPS JVM\", inFipsJvm());", "originalCommit": "ba92aeb4b6b7870fd48104e82b255186e439c5d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwODI0MA==", "url": "https://github.com/elastic/elasticsearch/pull/56526#discussion_r423608240", "bodyText": "Maybe? But we don't support PKCS12 nor JKS stores in FIPS mode so there is not much value in testing reloading such a keystore.", "author": "jkakavas", "createdAt": "2020-05-12T09:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU3Mzg1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYyMTczOA==", "url": "https://github.com/elastic/elasticsearch/pull/56526#discussion_r423621738", "bodyText": "You are right. Forgot about this again.", "author": "ywangd", "createdAt": "2020-05-12T10:14:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU3Mzg1MQ=="}], "type": "inlineReview"}, {"oid": "24a5306824c6eda13e96b3fe9ece6654eece052e", "url": "https://github.com/elastic/elasticsearch/commit/24a5306824c6eda13e96b3fe9ece6654eece052e", "message": "Remove system property and do a runtime detection of the security provider in use", "committedDate": "2020-05-13T09:16:45Z", "type": "commit"}]}