{"pr_number": 60092, "pr_title": "Add runtime_script date field", "pr_createdAt": "2020-07-22T21:00:28Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60092", "timeline": [{"oid": "c0329d874738fd7bb3f1fb985dc9445954d09f1c", "url": "https://github.com/elastic/elasticsearch/commit/c0329d874738fd7bb3f1fb985dc9445954d09f1c", "message": "Add runtime_script date field\n\nAdds support for `runtime_script` fields with `runtime_type: date`.\nDoesn't add support for the `format` parameter to the mapper but *does*\nsupport it on aggregations and the like. Its a start!", "committedDate": "2020-07-22T20:58:01Z", "type": "commit"}, {"oid": "578818c45e2e20eb9f8bbdece336fd722c46b608", "url": "https://github.com/elastic/elasticsearch/commit/578818c45e2e20eb9f8bbdece336fd722c46b608", "message": "Merge branch 'feature/runtime_fields' into script_field_date", "committedDate": "2020-07-23T13:18:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMzNzczMw==", "url": "https://github.com/elastic/elasticsearch/pull/60092#discussion_r462337733", "bodyText": "interesting scenario that I never though about: scoring based on runtime fields. You already added this to the runtime fields meta issue right?", "author": "javanna", "createdAt": "2020-07-29T14:21:52Z", "path": "server/src/main/java/org/elasticsearch/index/query/functionscore/DecayFunctionBuilder.java", "diffHunk": "@@ -210,6 +210,7 @@ private AbstractDistanceScoreFunction parseVariable(String fieldName, XContentPa\n \n         // dates and time and geo need special handling\n         parser.nextToken();\n+        // TODO these ain't gonna work with runtime fields", "originalCommit": "578818c45e2e20eb9f8bbdece336fd722c46b608", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyMTgxOA==", "url": "https://github.com/elastic/elasticsearch/pull/60092#discussion_r462521818", "bodyText": "Yeah, I added it.", "author": "nik9000", "createdAt": "2020-07-29T19:03:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMzNzczMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMzOTc0MA==", "url": "https://github.com/elastic/elasticsearch/pull/60092#discussion_r462339740", "bodyText": "interesting too, at least both of these are around parsing values, which you are making public so that we can reuse for runtime fields?", "author": "javanna", "createdAt": "2020-07-29T14:24:30Z", "path": "server/src/main/java/org/elasticsearch/index/query/DistanceFeatureQueryBuilder.java", "diffHunk": "@@ -120,6 +120,7 @@ protected Query doToQuery(QueryShardContext context) throws IOException {\n             return Queries.newMatchNoDocsQuery(\"Can't run [\" + NAME + \"] query on unmapped fields!\");\n         }\n         Object originObj = origin.origin();\n+        // TODO these ain't gonna work with runtime fields", "originalCommit": "578818c45e2e20eb9f8bbdece336fd722c46b608", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyMjYxNA==", "url": "https://github.com/elastic/elasticsearch/pull/60092#discussion_r462522614", "bodyText": "Yeah, we can handle this somehow.", "author": "nik9000", "createdAt": "2020-07-29T19:04:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMzOTc0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM2Mzc0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/60092#discussion_r462363741", "bodyText": "I get confused here on what has changed. why can't we return the long field script. given that we are in the long mapped field type?", "author": "javanna", "createdAt": "2020-07-29T14:55:15Z", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptLongMappedFieldType.java", "diffHunk": "@@ -51,8 +52,9 @@ public Object valueForDisplay(Object value) {\n         return new ScriptLongFieldData.Builder(name(), script, scriptFactory);\n     }\n \n-    private LongScriptFieldScript.LeafFactory leafFactory(QueryShardContext context) {\n-        return scriptFactory.newFactory(script.getParams(), context.lookup());\n+    private AbstractLongScriptFieldScript.LeafFactory leafFactory(QueryShardContext context) {\n+        LongScriptFieldScript.LeafFactory delegate = scriptFactory.newFactory(script.getParams(), context.lookup());\n+        return ctx -> delegate.newInstance(ctx);", "originalCommit": "578818c45e2e20eb9f8bbdece336fd722c46b608", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyMjgxMw==", "url": "https://github.com/elastic/elasticsearch/pull/60092#discussion_r462522813", "bodyText": "I don't remember! I'll check.", "author": "nik9000", "createdAt": "2020-07-29T19:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM2Mzc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUzODI1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/60092#discussion_r462538259", "bodyText": "It had to do with being able to share the queries. I've dropped it in favor of something a little more obvious.", "author": "nik9000", "createdAt": "2020-07-29T19:32:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM2Mzc0MQ=="}], "type": "inlineReview"}, {"oid": "a53dfcce7313569a45a86c3aa51eadd632eba38c", "url": "https://github.com/elastic/elasticsearch/commit/a53dfcce7313569a45a86c3aa51eadd632eba38c", "message": "Merge branch 'feature/runtime_fields' into script_field_date", "committedDate": "2020-07-29T19:32:13Z", "type": "commit"}]}