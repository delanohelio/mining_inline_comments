{"pr_number": 66109, "pr_title": "Generate an IDE-compatible checkstyle configuration", "pr_createdAt": "2020-12-09T14:10:08Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66109", "timeline": [{"oid": "c6ee3d4057302d0615cb5654879a65973370ce5c", "url": "https://github.com/elastic/elasticsearch/commit/c6ee3d4057302d0615cb5654879a65973370ce5c", "message": "Generate an IDE-compatible checkstyle configuration\n\nWith a few changes, our checkstyle config can be used by e.g. IntelliJ's\nCheckstyle plugin. Add a task to generate this file automatically, and\ncreate the necessary IntelliJ config to use it.\n\nAlso add a line-length setting to .editorconfig.", "committedDate": "2020-12-09T14:07:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE3NDU2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/66109#discussion_r541174567", "bodyText": "can we have proper up-to-date checking for this in case nothing changed?", "author": "breskeby", "createdAt": "2020-12-11T19:09:24Z", "path": "gradle/ide.gradle", "diffHunk": "@@ -21,6 +24,38 @@ allprojects {\n   }\n }\n \n+tasks.register('configureIdeCheckstyle') {", "originalCommit": "c6ee3d4057302d0615cb5654879a65973370ce5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI1ODUzMw==", "url": "https://github.com/elastic/elasticsearch/pull/66109#discussion_r542258533", "bodyText": "I've defined inputs and outputs, hopefully that's what you were looking for?", "author": "pugnascotia", "createdAt": "2020-12-14T10:04:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE3NDU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMxNTc1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/66109#discussion_r542315751", "bodyText": "yes. thx", "author": "breskeby", "createdAt": "2020-12-14T11:33:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE3NDU2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE5MTEwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/66109#discussion_r541191101", "bodyText": "generated files should live in the build folder in general. any particular reason its not", "author": "breskeby", "createdAt": "2020-12-11T19:23:23Z", "path": "gradle/ide.gradle", "diffHunk": "@@ -21,6 +24,38 @@ allprojects {\n   }\n }\n \n+tasks.register('configureIdeCheckstyle') {\n+  group = 'ide'\n+  description = 'Generated a suitable checkstyle config for IDEs'\n+\n+  doLast {\n+    // Create an IDE-specific checkstyle config by first copying the standard config\n+    Files.copy(\n+      Paths.get(project.file(\"buildSrc/src/main/resources/checkstyle.xml\").getPath()),\n+      Paths.get(project.file(\"buildSrc/src/main/resources/checkstyle_ide.xml\").getPath()),", "originalCommit": "c6ee3d4057302d0615cb5654879a65973370ce5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIwMTQxMA==", "url": "https://github.com/elastic/elasticsearch/pull/66109#discussion_r541201410", "bodyText": "Otherwise we tangle with the up-to-date check for the processResources task here as src/main/resources is considered its input", "author": "breskeby", "createdAt": "2020-12-11T19:34:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE5MTEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI1ODc2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/66109#discussion_r542258762", "bodyText": "I've moved the generated config to 'build'.", "author": "pugnascotia", "createdAt": "2020-12-14T10:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE5MTEwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE5OTQ2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/66109#discussion_r541199466", "bodyText": "the settings path is '... Other Settings > Eclipse Code Formatter'", "author": "breskeby", "createdAt": "2020-12-11T19:32:06Z", "path": "CONTRIBUTING.md", "diffHunk": "@@ -164,6 +164,47 @@ You can import the Elasticsearch project into IntelliJ IDEA via:\n  - In the subsequent dialog navigate to the root `build.gradle` file\n  - In the subsequent dialog select **Open as Project**\n \n+#### Checkstyle\n+\n+If you have the [Checkstyle] plugin installed, you can configure IntelliJ to\n+check the Elasticsearch code. However, the Checkstyle configuration file does\n+not work by default with the IntelliJ plugin, so instead a IDE-specific config\n+file is generated automatically after IntelliJ finishes syncing.\n+\n+   - Open **Preferences > Tools > Checkstyle**\n+   - Change the \"Scan Scope\" to \"Only Java sources (including tests)\"\n+   - Check the \"+\" under \"Configuration file\"\n+   - Set \"Description\" to \"Elasticsearch\" (or whatever you want)\n+   - Select \"Use a local Checkstyle file\"\n+   - For the \"File\", navigate to `buildSrc/src/main/resources/checkstyle_ide.xml`\n+   - Tick \"Store relative to project location\"\n+   - Click \"Next\"\n+   - The Checkstyle config file contains the variable `config_loc`, and\n+     IntelliJ will ask for a value. Fill in `buildSrc/src/main/resources`\n+   - Click \"Next\", then \"Finish\".\n+   - Click the box next to the new configuration to make it \"Active\". Without doing this,\n+     you'll have to explicitly choose the \"Elasticsearch\" configuration in the Checkstyle\n+     tool window and run the check manually. You can still do this with an active config,\n+     of course.\n+   - Click \"OK\" to apply the new preferences\n+\n+#### Formatting\n+\n+We are in the process of migrating towards automatic formatting Java file\n+using [spotless], backed by the Eclipse formatter. If you have the [Eclipse\n+Code Formatter] installed, you can apply formatting directly in IntelliJ.\n+\n+   - Open **Preferences > Other Settings > Checkstyle**", "originalCommit": "c6ee3d4057302d0615cb5654879a65973370ce5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI1ODkxMg==", "url": "https://github.com/elastic/elasticsearch/pull/66109#discussion_r542258912", "bodyText": "Ah, copy-paste error.", "author": "pugnascotia", "createdAt": "2020-12-14T10:04:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE5OTQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIwMDQ0MA==", "url": "https://github.com/elastic/elasticsearch/pull/66109#discussion_r541200440", "bodyText": "as said I think generated files should live in buildSrc/build instead. then we can remove this line again", "author": "breskeby", "createdAt": "2020-12-11T19:33:15Z", "path": ".gitignore", "diffHunk": "@@ -56,3 +56,6 @@ testfixtures_shared/\n \n # These are generated from .ci/jobs.t\n .ci/jobs/\n+\n+# Generated file\n+buildSrc/src/main/resources/checkstyle_ide.xml", "originalCommit": "c6ee3d4057302d0615cb5654879a65973370ce5c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "11912c291e21fd97f349f4eb8650db46b48ae72c", "url": "https://github.com/elastic/elasticsearch/commit/11912c291e21fd97f349f4eb8650db46b48ae72c", "message": "Apply review feedback", "committedDate": "2020-12-14T10:03:27Z", "type": "commit"}, {"oid": "8857706d0797eb497fa90dc5cb1fdc039eabd663", "url": "https://github.com/elastic/elasticsearch/commit/8857706d0797eb497fa90dc5cb1fdc039eabd663", "message": "Merge remote-tracking branch 'upstream/master' into checkstyle-ide", "committedDate": "2020-12-14T10:03:34Z", "type": "commit"}, {"oid": "6f058f07323cdc43103a4cfd422387d4cc0dd525", "url": "https://github.com/elastic/elasticsearch/commit/6f058f07323cdc43103a4cfd422387d4cc0dd525", "message": "Merge branch 'master' into checkstyle-ide", "committedDate": "2020-12-14T11:50:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI0NTIwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/66109#discussion_r551245205", "bodyText": "I wonder what this means in practice: if we configure the formatter, formatting will be applied everywhere which will cause noise within projects that are not yet automatically formatted? Been seeing this with imports order and I am wondering if this is what's causing it.", "author": "javanna", "createdAt": "2021-01-04T10:52:31Z", "path": "CONTRIBUTING.md", "diffHunk": "@@ -164,6 +164,47 @@ You can import the Elasticsearch project into IntelliJ IDEA via:\n  - In the subsequent dialog navigate to the root `build.gradle` file\n  - In the subsequent dialog select **Open as Project**\n \n+#### Checkstyle\n+\n+If you have the [Checkstyle] plugin installed, you can configure IntelliJ to\n+check the Elasticsearch code. However, the Checkstyle configuration file does\n+not work by default with the IntelliJ plugin, so instead an IDE-specific config\n+file is generated automatically after IntelliJ finishes syncing.\n+\n+   1. Open **Preferences > Tools > Checkstyle**\n+   2. Change the \"Scan Scope\" to \"Only Java sources (including tests)\"\n+   3. Check the \"+\" under \"Configuration file\"\n+   4. Set \"Description\" to \"Elasticsearch\" (or whatever you want)\n+   5. Select \"Use a local Checkstyle file\"\n+   6. For the \"File\", navigate to `build/checkstyle_ide.xml`\n+   7. Tick \"Store relative to project location\"\n+   8. Click \"Next\"\n+   9. The Checkstyle config file contains the variable `config_loc`, and\n+      IntelliJ will ask for a value. Fill in `buildSrc/src/main/resources`.\n+      This allows the config file to reference the exclusions file in that directory.\n+   10. Click \"Next\", then \"Finish\".\n+   11. Click the box next to the new configuration to make it \"Active\". Without doing this,\n+       you'll have to explicitly choose the \"Elasticsearch\" configuration in the Checkstyle\n+       tool window and run the check manually. You can still do this with an active config.\n+   12. Click \"OK\" to apply the new preferences\n+\n+#### Formatting\n+\n+We are in the process of migrating towards automatic formatting Java file\n+using [spotless], backed by the Eclipse formatter. If you have the [Eclipse\n+Code Formatter] installed, you can apply formatting directly in IntelliJ.\n+\n+   1. Open **Preferences > Other Settings > Eclipse Code Formatter**\n+   2. Click \"Use the Eclipse Code Formatter\"\n+   3. Under \"Eclipse formatter config\", select \"Eclipse workspace/project\n+      folder or config file\"\n+   4. Click \"Browse\", and navigate to the file `buildSrc/formatterConfig.xml`\n+   5. Click \"OK\"\n+\n+Note that only some sub-projects in the Elasticsearch project are currently\n+fully-formatted. You can see a list of project that **are not**\n+automatically formatted in [gradle/formatting.gradle](gradle/formatting.gradle).", "originalCommit": "6f058f07323cdc43103a4cfd422387d4cc0dd525", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI0Nzc1NA==", "url": "https://github.com/elastic/elasticsearch/pull/66109#discussion_r551247754", "bodyText": "The policy is that only new projects are opted-in to formatting. If you're seeing issues with imports in an project that is listed in gradle/formatting.gradle, then either that's a bug that I haven't seen before, or something else is messing with your imports. Let me know when this comes up next and we can look into it.", "author": "pugnascotia", "createdAt": "2021-01-04T10:57:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI0NTIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI0OTkwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/66109#discussion_r551249901", "bodyText": "I believe what happened is that once I enabled the Eclipse Code Formatter, I also had Optimize Imports on, which messes up imports order as I touch files. I don't recall if I enabled it explicitly, I disabled it now.", "author": "javanna", "createdAt": "2021-01-04T11:02:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI0NTIwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1MDUwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/66109#discussion_r551250509", "bodyText": "Aha, yes, I've run into that too. I disable the imports option in the Eclipse formatter plugin.", "author": "pugnascotia", "createdAt": "2021-01-04T11:03:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI0NTIwNQ=="}], "type": "inlineReview"}]}