{"pr_number": 61447, "pr_title": "Stop Needlessly Copying Bytes in XContent Parsing", "pr_createdAt": "2020-08-23T16:20:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61447", "timeline": [{"oid": "1a56e5e97b1f7af15b0c1fd8ce96b5ca735d2095", "url": "https://github.com/elastic/elasticsearch/commit/1a56e5e97b1f7af15b0c1fd8ce96b5ca735d2095", "message": "Stop Needlessly Copying Bytes in XContent Parsing\n\nWrapping a `BytesArray` in a `StreamInput` for deserialization is inefficient.\nThis forces Jackson to internally buffer (i.e. copy) all bytes from the `BytesArray`\nbefore deserializing, adding overhead for copying the bytes and managing the buffers.\n\nThis commit fixes a number of spots where `BytesArray` is the most common type of\n`BytesReference` to special case this type and parse it more efficiently.\nAlso improves parsing `String`s to use the more efficient direct `String` parsing APIs.", "committedDate": "2020-08-23T16:11:28Z", "type": "commit"}, {"oid": "9cc1d0e04f3640bd420bad085cd5580515bc0c3b", "url": "https://github.com/elastic/elasticsearch/commit/9cc1d0e04f3640bd420bad085cd5580515bc0c3b", "message": "math is hard ..", "committedDate": "2020-08-23T16:36:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0MzAyNg==", "url": "https://github.com/elastic/elasticsearch/pull/61447#discussion_r475243026", "bodyText": "This now throws with a slightly different text because we read straight from the byte[]", "author": "original-brownbear", "createdAt": "2020-08-23T17:13:51Z", "path": "server/src/test/java/org/elasticsearch/index/IndexingSlowLogTests.java", "diffHunk": "@@ -272,12 +272,12 @@ public void testSlowLogParsedDocumentPrinterSourceToLog() throws IOException {\n             () -> IndexingSlowLogMessage.of(index, doc, 10, true, 3));\n         assertThat(e, hasToString(containsString(\"_failed_to_convert_[Unrecognized token 'invalid':\"\n             + \" was expecting (JSON String, Number, Array, Object or token 'null', 'true' or 'false')\\\\n\"\n-            + \" at [Source: (org.elasticsearch.common.bytes.AbstractBytesReference$MarkSupportingStreamInputWrapper)\")));\n+            + \" at [Source: \")));", "originalCommit": "9cc1d0e04f3640bd420bad085cd5580515bc0c3b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQyNDY1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/61447#discussion_r475424652", "bodyText": "This comment looks to be out-of-date with this changes and can ben removed.", "author": "pugnascotia", "createdAt": "2020-08-24T08:27:48Z", "path": "server/src/main/java/org/elasticsearch/action/bulk/BulkRequestParser.java", "diffHunk": "@@ -133,9 +134,7 @@ public void parse(\n \n             // now parse the action\n             // EMPTY is safe here because we never call namedObject", "originalCommit": "9cc1d0e04f3640bd420bad085cd5580515bc0c3b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQyNDczMg==", "url": "https://github.com/elastic/elasticsearch/pull/61447#discussion_r475424732", "bodyText": "This comment looks to be out-of-date with this changes and can ben removed.", "author": "pugnascotia", "createdAt": "2020-08-24T08:27:54Z", "path": "server/src/main/java/org/elasticsearch/action/bulk/BulkRequestParser.java", "diffHunk": "@@ -277,9 +276,8 @@ public void parse(\n                                 .setRequireAlias(requireAlias)\n                                 .routing(routing);\n                         // EMPTY is safe here because we never call namedObject", "originalCommit": "9cc1d0e04f3640bd420bad085cd5580515bc0c3b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQyNTEzOA==", "url": "https://github.com/elastic/elasticsearch/pull/61447#discussion_r475425138", "bodyText": "Aha, here is where the EMPTY went. You could re-insert the comment about it here.", "author": "pugnascotia", "createdAt": "2020-08-24T08:28:33Z", "path": "server/src/main/java/org/elasticsearch/action/bulk/BulkRequestParser.java", "diffHunk": "@@ -299,4 +297,33 @@ public void parse(\n         }\n     }\n \n+    private static XContentParser createParser(BytesReference data, XContent xContent) throws IOException {\n+        if (data instanceof BytesArray) {\n+            return parseBytesArray(xContent, (BytesArray) data, 0, data.length());\n+        } else {\n+            return xContent.createParser(NamedXContentRegistry.EMPTY, LoggingDeprecationHandler.INSTANCE, data.streamInput());", "originalCommit": "9cc1d0e04f3640bd420bad085cd5580515bc0c3b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "81aaf4d1f0fe63ed639792d14d68ed4cabecb173", "url": "https://github.com/elastic/elasticsearch/commit/81aaf4d1f0fe63ed639792d14d68ed4cabecb173", "message": "Merge remote-tracking branch 'elastic/master' into stop-copying-x-content-bytes", "committedDate": "2020-08-24T12:03:54Z", "type": "commit"}, {"oid": "b9631de05d3fbaa6dfc9d48cbd28039e03ff3cc5", "url": "https://github.com/elastic/elasticsearch/commit/b9631de05d3fbaa6dfc9d48cbd28039e03ff3cc5", "message": "CR: move comments", "committedDate": "2020-08-24T12:06:05Z", "type": "commit"}]}