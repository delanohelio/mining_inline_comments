{"pr_number": 57930, "pr_title": "[ML] adding new inference model size estimate handling from native process", "pr_createdAt": "2020-06-10T12:23:38Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57930", "timeline": [{"oid": "c38fb52ec6e78d32752056fd2c38194f5a5daca7", "url": "https://github.com/elastic/elasticsearch/commit/c38fb52ec6e78d32752056fd2c38194f5a5daca7", "message": "[ML] adding new inference model size estimate handling from native process", "committedDate": "2020-06-10T12:21:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYxMjY4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/57930#discussion_r438612682", "bodyText": "This has changed from shallowSizeOf to normal sizeOf. Could you explain?", "author": "dimitris-athanasiou", "createdAt": "2020-06-11T08:04:39Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/inference/TreeInferenceModel.java", "diffHunk": "@@ -302,18 +303,16 @@ public void rewriteFeatureIndices(Map<String, Integer> newFeatureIndexMapping) {\n             treeNode.splitFeature = newSplitFeatureIndex;\n         }\n         this.featureNames = new String[0];\n+        // Since we are not top level, we no longer need local classification labels\n+        this.classificationLabels = null;\n     }\n \n     @Override\n     public long ramBytesUsed() {\n         long size = SHALLOW_SIZE;\n-        size += RamUsageEstimator.sizeOfCollection(classificationLabels);\n-        size += RamUsageEstimator.sizeOf(featureNames);\n-        size += RamUsageEstimator.shallowSizeOf(nodes);\n-        for (Node node : nodes) {\n-            size += node.ramBytesUsed();\n-        }\n-        size += RamUsageEstimator.sizeOfCollection(Arrays.asList(nodes));\n+        size += sizeOfCollection(classificationLabels);\n+        size += sizeOf(featureNames);\n+        size += sizeOf(nodes);", "originalCommit": "c38fb52ec6e78d32752056fd2c38194f5a5daca7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc2Nzk3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/57930#discussion_r438767971", "bodyText": "sizeOf in this context is accepting a Accountable[]. The underlying method will take care of shallow size + the size of each element in the accountable array.\nIt really should have been this way to begin with.", "author": "benwtrent", "createdAt": "2020-06-11T13:08:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYxMjY4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODczOTI2NA==", "url": "https://github.com/elastic/elasticsearch/pull/57930#discussion_r438739264", "bodyText": "nit: no need for qualifying with this", "author": "dimitris-athanasiou", "createdAt": "2020-06-11T12:15:15Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/modelsize/ModelSize.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.inference.modelsize;\n+\n+import org.apache.lucene.util.Accountable;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.xpack.core.ml.inference.trainedmodel.inference.InferenceDefinition;\n+import org.elasticsearch.xpack.core.ml.utils.NamedXContentObjectHelper;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static org.apache.lucene.util.RamUsageEstimator.alignObjectSize;\n+import static org.elasticsearch.common.xcontent.ConstructingObjectParser.constructorArg;\n+import static org.elasticsearch.common.xcontent.ConstructingObjectParser.optionalConstructorArg;\n+\n+public class ModelSize implements Accountable, ToXContentObject {\n+\n+    private static final ParseField PREPROCESSORS = new ParseField(\"preprocessors\");\n+    private static final ParseField TRAINED_MODEL_SIZE = new ParseField(\"trained_model_size\");\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public static ConstructingObjectParser<ModelSize, Void> PARSER = new ConstructingObjectParser<>(\n+        \"model_size\",\n+        false,\n+        a -> new ModelSize((EnsembleSize)a[0], (List<PreprocessorSize>)a[1])\n+    );\n+    static {\n+        PARSER.declareNamedObject(constructorArg(),\n+            (p, c, n) -> p.namedObject(TrainedModelSize.class, n, null),\n+            TRAINED_MODEL_SIZE);\n+        PARSER.declareNamedObjects(optionalConstructorArg(),\n+            (p, c, n) -> p.namedObject(PreprocessorSize.class, n, null),\n+            (val) -> {},\n+            PREPROCESSORS);\n+    }\n+\n+    private final EnsembleSize ensembleSize;\n+    private final List<PreprocessorSize> preprocessorSizes;\n+\n+    public ModelSize(EnsembleSize ensembleSize, List<PreprocessorSize> preprocessorSizes) {\n+        this.ensembleSize = ensembleSize;\n+        this.preprocessorSizes = preprocessorSizes == null ? Collections.emptyList() : preprocessorSizes;\n+    }\n+\n+    public int numOperations() {\n+        return this.preprocessorSizes.size() + this.ensembleSize.getNumOperations();\n+    }\n+\n+    @Override\n+    public long ramBytesUsed() {\n+        long size = InferenceDefinition.SHALLOW_SIZE;\n+        size += ensembleSize.ramBytesUsed();\n+        size += this.preprocessorSizes.stream().mapToLong(PreprocessorSize::ramBytesUsed).sum();", "originalCommit": "c38fb52ec6e78d32752056fd2c38194f5a5daca7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc0MDE3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/57930#discussion_r438740175", "bodyText": "I wonder if there's a good way to avoid the discrepancy: ModelSize VS. model_size_info. Could the java side by ModelSizeInfo? Or do we rather change the c++ to model_size?", "author": "dimitris-athanasiou", "createdAt": "2020-06-11T12:17:06Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/results/AnalyticsResult.java", "diffHunk": "@@ -56,6 +59,7 @@\n         PARSER.declareObject(optionalConstructorArg(), OutlierDetectionStats.STRICT_PARSER, OUTLIER_DETECTION_STATS);\n         PARSER.declareObject(optionalConstructorArg(), ClassificationStats.STRICT_PARSER, CLASSIFICATION_STATS);\n         PARSER.declareObject(optionalConstructorArg(), RegressionStats.STRICT_PARSER, REGRESSION_STATS);\n+        PARSER.declareObject(optionalConstructorArg(), ModelSize.PARSER, MODEL_SIZE_INFO);", "originalCommit": "c38fb52ec6e78d32752056fd2c38194f5a5daca7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc2ODA5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/57930#discussion_r438768092", "bodyText": "Sure, I will change the object name :)", "author": "benwtrent", "createdAt": "2020-06-11T13:08:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc0MDE3NQ=="}], "type": "inlineReview"}, {"oid": "9c0a7c7830d2e270904560178340aee29adcdcb7", "url": "https://github.com/elastic/elasticsearch/commit/9c0a7c7830d2e270904560178340aee29adcdcb7", "message": "addressing pr comments", "committedDate": "2020-06-11T13:30:35Z", "type": "commit"}, {"oid": "56835128f1a004dbd3ddc7e885116d1a67570f24", "url": "https://github.com/elastic/elasticsearch/commit/56835128f1a004dbd3ddc7e885116d1a67570f24", "message": "more renaming", "committedDate": "2020-06-11T14:45:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NDU3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/57930#discussion_r438884575", "bodyText": "Too much information! :-)", "author": "dimitris-athanasiou", "createdAt": "2020-06-11T15:43:03Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/modelsize/EnsembleSizeInfoInfo.java", "diffHunk": "@@ -25,7 +25,7 @@\n import static org.elasticsearch.xpack.ml.inference.modelsize.SizeEstimatorHelper.sizeOfDoubleArray;\n import static org.elasticsearch.xpack.ml.inference.modelsize.SizeEstimatorHelper.sizeOfStringCollection;\n \n-public class EnsembleSize implements TrainedModelSize {\n+public class EnsembleSizeInfoInfo implements TrainedModelSizeInfo {", "originalCommit": "56835128f1a004dbd3ddc7e885116d1a67570f24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkwNjUyNA==", "url": "https://github.com/elastic/elasticsearch/pull/57930#discussion_r438906524", "bodyText": "AGH", "author": "benwtrent", "createdAt": "2020-06-11T16:12:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NDU3NQ=="}], "type": "inlineReview"}, {"oid": "c1a56077fddad4824ad9f7c37d4cdb99547c0849", "url": "https://github.com/elastic/elasticsearch/commit/c1a56077fddad4824ad9f7c37d4cdb99547c0849", "message": "fixing name", "committedDate": "2020-06-11T16:14:06Z", "type": "commit"}]}