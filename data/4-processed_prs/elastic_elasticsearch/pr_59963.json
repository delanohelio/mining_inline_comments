{"pr_number": 59963, "pr_title": "[ML] Include same fields during test inference as in training", "pr_createdAt": "2020-07-21T11:22:29Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59963", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAyNjc2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/59963#discussion_r458026761", "bodyText": "I think this method could be turned to stream expression for brevity, sth like:\nreturn extractedFields.getDocValueFields().collect(toMap(ExtractedField::getSearchField, ExtractedField::docValueFormat));", "author": "przemekwitek", "createdAt": "2020-07-21T11:29:32Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/inference/TestDocsIterator.java", "diffHunk": "@@ -18,18 +18,32 @@\n import org.elasticsearch.xpack.core.ClientHelper;\n import org.elasticsearch.xpack.core.ml.dataframe.DataFrameAnalyticsConfig;\n import org.elasticsearch.xpack.ml.dataframe.DestinationIndex;\n+import org.elasticsearch.xpack.ml.extractor.ExtractedField;\n+import org.elasticsearch.xpack.ml.extractor.ExtractedFields;\n import org.elasticsearch.xpack.ml.utils.persistence.SearchAfterDocumentsIterator;\n \n+import java.util.HashMap;\n+import java.util.Map;\n import java.util.Objects;\n \n public class TestDocsIterator extends SearchAfterDocumentsIterator<SearchHit> {\n \n     private final DataFrameAnalyticsConfig config;\n     private String lastDocId;\n+    private final Map<String, String> docValueFieldAndFormatPairs;\n \n-    TestDocsIterator(OriginSettingClient client, DataFrameAnalyticsConfig config) {\n+    TestDocsIterator(OriginSettingClient client, DataFrameAnalyticsConfig config, ExtractedFields extractedFields) {\n         super(client, config.getDest().getIndex(), true);\n         this.config = Objects.requireNonNull(config);\n+        this.docValueFieldAndFormatPairs = buildDocValueFieldAndFormatPairs(extractedFields);\n+    }\n+\n+    private static Map<String, String> buildDocValueFieldAndFormatPairs(ExtractedFields extractedFields) {\n+        Map<String, String> docValueFieldAndFormatPairs = new HashMap<>();\n+        for (ExtractedField docValueField : extractedFields.getDocValueFields()) {", "originalCommit": "4aec0566eac70fb82b353da1abff6d17193808a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIyMzY2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/59963#discussion_r458223667", "bodyText": "I reverted this as it doesn't play well with nullable map values.", "author": "dimitris-athanasiou", "createdAt": "2020-07-21T16:19:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAyNjc2MQ=="}], "type": "inlineReview"}, {"oid": "8eea241b26da39e43010bd929c0255df4b143a48", "url": "https://github.com/elastic/elasticsearch/commit/8eea241b26da39e43010bd929c0255df4b143a48", "message": "[ML] Include same fields during test inference as in training\n\nIn #58877, when we switched test inference on java, we just\nuse the doc's `_source` as features. However, this could be\nmissing out on features that were used during training,\ne.g. alias fields, etc.\n\nThis commit addresses this by extracting fields to use as\nfeatures during inference the same way they are extracted\nin `DataFrameDataExtractor` when they are used for training.", "committedDate": "2020-07-21T12:21:47Z", "type": "commit"}, {"oid": "076997c1dc8d83a4fedfa4da0da09137834acb3a", "url": "https://github.com/elastic/elasticsearch/commit/076997c1dc8d83a4fedfa4da0da09137834acb3a", "message": "Use streams to simplify map creation", "committedDate": "2020-07-21T12:26:15Z", "type": "commit"}, {"oid": "076997c1dc8d83a4fedfa4da0da09137834acb3a", "url": "https://github.com/elastic/elasticsearch/commit/076997c1dc8d83a4fedfa4da0da09137834acb3a", "message": "Use streams to simplify map creation", "committedDate": "2020-07-21T12:26:15Z", "type": "forcePushed"}, {"oid": "5066697ba8957dad201398eff374716bac87bf25", "url": "https://github.com/elastic/elasticsearch/commit/5066697ba8957dad201398eff374716bac87bf25", "message": "Remove unused imports", "committedDate": "2020-07-21T14:08:30Z", "type": "commit"}, {"oid": "c580ce941ac209a253f0c13ef901067e7ae5ff79", "url": "https://github.com/elastic/elasticsearch/commit/c580ce941ac209a253f0c13ef901067e7ae5ff79", "message": "Revert \"Use streams to simplify map creation\"\n\nThis reverts commit 076997c1dc8d83a4fedfa4da0da09137834acb3a.", "committedDate": "2020-07-21T16:14:42Z", "type": "commit"}]}