{"pr_number": 60827, "pr_title": "Simplify Compressible Stream Handling", "pr_createdAt": "2020-08-06T15:12:14Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60827", "timeline": [{"oid": "dabd5ae9180adee299d6a85ead2fdeec351a4384", "url": "https://github.com/elastic/elasticsearch/commit/dabd5ae9180adee299d6a85ead2fdeec351a4384", "message": "Simplify Compressible Stream Handling\n\nTwo things that can be simplified here:\n1. Instantiating a `CompressibleBytesOutputStream` when not doing any compression\njust needlessly wastes a few objects and adds indirection. When doing compression\nit does not really simplify the code by much if at all.\n=> removing it to save some cycles on the IO threads\n2. The fact that the compressible stream closes the stream that it wraps is never used productively\nand we had to hack around it by wrapping the stream to disable close\n=> changed behavior here to save some more wrapping and complication.", "committedDate": "2020-08-06T15:12:55Z", "type": "commit"}, {"oid": "dabd5ae9180adee299d6a85ead2fdeec351a4384", "url": "https://github.com/elastic/elasticsearch/commit/dabd5ae9180adee299d6a85ead2fdeec351a4384", "message": "Simplify Compressible Stream Handling\n\nTwo things that can be simplified here:\n1. Instantiating a `CompressibleBytesOutputStream` when not doing any compression\njust needlessly wastes a few objects and adds indirection. When doing compression\nit does not really simplify the code by much if at all.\n=> removing it to save some cycles on the IO threads\n2. The fact that the compressible stream closes the stream that it wraps is never used productively\nand we had to hack around it by wrapping the stream to disable close\n=> changed behavior here to save some more wrapping and complication.", "committedDate": "2020-08-06T15:12:55Z", "type": "forcePushed"}, {"oid": "d8e070d0688df113b95f893176efaa33e912f56d", "url": "https://github.com/elastic/elasticsearch/commit/d8e070d0688df113b95f893176efaa33e912f56d", "message": "Merge remote-tracking branch 'elastic/master' into get-rid-of-redundant-stream-wrap", "committedDate": "2020-08-06T18:21:03Z", "type": "commit"}, {"oid": "7165bf94e92753b382fb7a20cef992d35ac4abd5", "url": "https://github.com/elastic/elasticsearch/commit/7165bf94e92753b382fb7a20cef992d35ac4abd5", "message": "Merge remote-tracking branch 'elastic/master' into get-rid-of-redundant-stream-wrap", "committedDate": "2021-04-29T06:21:51Z", "type": "commit"}, {"oid": "92896025b9d234031d52a36fc9297a7dfe2a0cb9", "url": "https://github.com/elastic/elasticsearch/commit/92896025b9d234031d52a36fc9297a7dfe2a0cb9", "message": "fix merge issue", "committedDate": "2021-04-29T06:43:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMjg3MTcwMA==", "url": "https://github.com/elastic/elasticsearch/pull/60827#discussion_r622871700", "bodyText": "For the record, InboundDecoderTests#testCompressedDecode and friends are enough to cover this code now. We rarely() enable compression in internal cluster tests but apparently never in real cluster tests, maybe we should?", "author": "DaveCTurner", "createdAt": "2021-04-29T09:13:02Z", "path": "server/src/test/java/org/elasticsearch/transport/CompressibleBytesOutputStreamTests.java", "diffHunk": "@@ -1,114 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the Elastic License\n- * 2.0 and the Server Side Public License, v 1; you may not use this file except\n- * in compliance with, at your election, the Elastic License 2.0 or the Server\n- * Side Public License, v 1.\n- */\n-\n-package org.elasticsearch.transport;\n-\n-import org.elasticsearch.common.bytes.BytesReference;\n-import org.elasticsearch.common.compress.CompressorFactory;\n-import org.elasticsearch.common.io.stream.BytesStream;\n-import org.elasticsearch.common.io.stream.BytesStreamOutput;\n-import org.elasticsearch.common.io.stream.InputStreamStreamInput;\n-import org.elasticsearch.common.io.stream.StreamInput;\n-import org.elasticsearch.test.ESTestCase;\n-\n-import java.io.EOFException;\n-import java.io.IOException;\n-\n-public class CompressibleBytesOutputStreamTests extends ESTestCase {", "originalCommit": "92896025b9d234031d52a36fc9297a7dfe2a0cb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMjkwODQ5NA==", "url": "https://github.com/elastic/elasticsearch/pull/60827#discussion_r622908494", "bodyText": "I once wanted to do this in the REST tests (~2 years ago) and was told we're already randomizing too much :) Maybe it's actually unnecessary since there is not practical difference between real and internal cluster tests here anyway. I'll leave it as is because of past discussions on randomizing more network settings in real cluster tests but I think I'd also be +0 on this. Maybe we can revisit this some other time :)", "author": "original-brownbear", "createdAt": "2021-04-29T10:05:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMjg3MTcwMA=="}], "type": "inlineReview"}]}