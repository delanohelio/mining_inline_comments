{"pr_number": 56627, "pr_title": "Improvement usage of gradle task avoidance api", "pr_createdAt": "2020-05-12T17:57:39Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56627", "timeline": [{"oid": "dd497ec6e610323c639ec78d30d66aef30ef2aa3", "url": "https://github.com/elastic/elasticsearch/commit/dd497ec6e610323c639ec78d30d66aef30ef2aa3", "message": "Use task avoidance api usage in root project and buildSrc", "committedDate": "2020-05-13T10:29:39Z", "type": "forcePushed"}, {"oid": "f3bf3473f6fc4047cada17522cd2d7736cb0b09f", "url": "https://github.com/elastic/elasticsearch/commit/f3bf3473f6fc4047cada17522cd2d7736cb0b09f", "message": "Use task avoidance api usage in root project and buildSrc", "committedDate": "2020-05-13T16:32:20Z", "type": "forcePushed"}, {"oid": "4cedb32cbae6f26de326530d616fb57646305689", "url": "https://github.com/elastic/elasticsearch/commit/4cedb32cbae6f26de326530d616fb57646305689", "message": "Move to task avoidance api in rest tests\n\nrequires revisit later to do some more refactoring to actually avoid creating those tasks", "committedDate": "2020-05-14T10:11:42Z", "type": "forcePushed"}, {"oid": "3b61b943546b8a647fe7de7a36ec549e7087a4b4", "url": "https://github.com/elastic/elasticsearch/commit/3b61b943546b8a647fe7de7a36ec549e7087a4b4", "message": "More task avoidance api usage in docs projects", "committedDate": "2020-05-14T11:23:33Z", "type": "forcePushed"}, {"oid": "30d4542889069d54ead5a3b90ac06815d353fb31", "url": "https://github.com/elastic/elasticsearch/commit/30d4542889069d54ead5a3b90ac06815d353fb31", "message": "Simplify ThirdPartyAuditTaskIT test a bit", "committedDate": "2020-05-13T18:43:32Z", "type": "forcePushed"}, {"oid": "d3112a4c200ce5d712b1408597644f81733acc8e", "url": "https://github.com/elastic/elasticsearch/commit/d3112a4c200ce5d712b1408597644f81733acc8e", "message": "More task avoidance api usages", "committedDate": "2020-05-15T08:39:01Z", "type": "forcePushed"}, {"oid": "7891b3ceac4b20cebfbfb7474633f70091b0b014", "url": "https://github.com/elastic/elasticsearch/commit/7891b3ceac4b20cebfbfb7474633f70091b0b014", "message": "Use task avoidance api in testkit samples", "committedDate": "2020-05-15T13:17:05Z", "type": "commit"}, {"oid": "460b9d82ae4176239a83ba16c879249ad0585dd7", "url": "https://github.com/elastic/elasticsearch/commit/460b9d82ae4176239a83ba16c879249ad0585dd7", "message": "Use task avoidance api usage in root project and buildSrc", "committedDate": "2020-05-15T13:17:05Z", "type": "commit"}, {"oid": "389e729dfa14cb901a01fe309e50485bd3ef7781", "url": "https://github.com/elastic/elasticsearch/commit/389e729dfa14cb901a01fe309e50485bd3ef7781", "message": "Simplify ThirdPartyAuditTaskIT test a bit", "committedDate": "2020-05-15T13:17:05Z", "type": "commit"}, {"oid": "ee40e99c45a01b4e8a3aadb828a3f0ac0d4c2f8e", "url": "https://github.com/elastic/elasticsearch/commit/ee40e99c45a01b4e8a3aadb828a3f0ac0d4c2f8e", "message": "More task avoidance api usages", "committedDate": "2020-05-15T13:17:05Z", "type": "commit"}, {"oid": "85ee4b9d230e98b05bc66f5e8dacbe89330814d0", "url": "https://github.com/elastic/elasticsearch/commit/85ee4b9d230e98b05bc66f5e8dacbe89330814d0", "message": "Workaround task configuration sideeffect", "committedDate": "2020-05-15T13:17:05Z", "type": "commit"}, {"oid": "85ee4b9d230e98b05bc66f5e8dacbe89330814d0", "url": "https://github.com/elastic/elasticsearch/commit/85ee4b9d230e98b05bc66f5e8dacbe89330814d0", "message": "Workaround task configuration sideeffect", "committedDate": "2020-05-15T13:17:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg5NjU5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56627#discussion_r425896592", "bodyText": "fix deprecation warning on the way", "author": "breskeby", "createdAt": "2020-05-15T15:57:13Z", "path": "buildSrc/reaper/build.gradle", "diffHunk": "@@ -1,5 +1,5 @@\n jar {\n-  archiveName = \"${project.name}.jar\"\n+  archiveFileName = \"${project.name}.jar\"", "originalCommit": "85ee4b9d230e98b05bc66f5e8dacbe89330814d0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fdacb18ad81a905b2dc49855e3a2aca26a7d2478", "url": "https://github.com/elastic/elasticsearch/commit/fdacb18ad81a905b2dc49855e3a2aca26a7d2478", "message": "Fix minor formatting", "committedDate": "2020-05-15T16:04:41Z", "type": "commit"}, {"oid": "0e9464182278e486e5aba4c41cfa461eade3e33c", "url": "https://github.com/elastic/elasticsearch/commit/0e9464182278e486e5aba4c41cfa461eade3e33c", "message": "Merge branch 'master' into improvement/use-gradle-task-avoidance-api", "committedDate": "2020-05-18T08:52:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNzI5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56627#discussion_r426907292", "bodyText": "Is this strictly beneficial since this task rule should only run when it finds a task matching this naming convention, right? Granted, it doesn't hurt, just wondering.", "author": "mark-vieira", "createdAt": "2020-05-18T21:38:33Z", "path": "build.gradle", "diffHunk": "@@ -485,7 +485,7 @@ allprojects {\n     if (realTask == null) {\n       return\n     }\n-    project.tasks.create(taskName) {\n+    project.tasks.register(taskName) {", "originalCommit": "0e9464182278e486e5aba4c41cfa461eade3e33c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA5NzAzOA==", "url": "https://github.com/elastic/elasticsearch/pull/56627#discussion_r427097038", "bodyText": "In general I think we just should use register over create where possible. In a later step we need to revisit the actual behaviour and when they got materialised anyhow, but more on a per case fashion I think as thinks get complex there.\nThere are use cases where tasks in a rule would not be created but registered. You can depend on tasks that are created by a rule, e.g. you could have `myTask.dependsOn tasks.named(\"cleanCompileJava\"). The rule would kick in so the task would be registered, but it doesn't need to be created.", "author": "breskeby", "createdAt": "2020-05-19T07:48:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNzI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNzkyMA==", "url": "https://github.com/elastic/elasticsearch/pull/56627#discussion_r426907920", "bodyText": "nit: missing space stop.configure {", "author": "mark-vieira", "createdAt": "2020-05-18T21:40:02Z", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/AntFixture.groovy", "diffHunk": "@@ -222,24 +224,29 @@ class AntFixture extends AntTask implements Fixture {\n     }\n \n     /** Adds a task to kill an elasticsearch node with the given pidfile */\n-    private Task createStopTask() {\n+    private TaskProvider createStopTask() {\n         final AntFixture fixture = this\n         final Object pid = \"${ -> fixture.pid }\"\n-        Exec stop = project.tasks.create(name: \"${name}#stop\", type: LoggedExec)\n-        stop.onlyIf { fixture.pidFile.exists() }\n-        stop.doFirst {\n-            logger.info(\"Shutting down ${fixture.name} with pid ${pid}\")\n-        }\n-        if (Os.isFamily(Os.FAMILY_WINDOWS)) {\n-            stop.executable = 'Taskkill'\n-            stop.args('/PID', pid, '/F')\n-        } else {\n-            stop.executable = 'kill'\n-            stop.args('-9', pid)\n-        }\n-        stop.doLast {\n-            project.delete(fixture.pidFile)\n+        TaskProvider<Exec> stop = project.tasks.register(\"${name}#stop\", LoggedExec)\n+        stop.configure{", "originalCommit": "0e9464182278e486e5aba4c41cfa461eade3e33c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMxODM0NA==", "url": "https://github.com/elastic/elasticsearch/pull/56627#discussion_r427318344", "bodyText": "fixed", "author": "breskeby", "createdAt": "2020-05-19T13:51:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNzkyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwOTIzOA==", "url": "https://github.com/elastic/elasticsearch/pull/56627#discussion_r426909238", "bodyText": "Should we just use create() then? This seems even more confusing.", "author": "mark-vieira", "createdAt": "2020-05-18T21:43:01Z", "path": "plugins/repository-hdfs/build.gradle", "diffHunk": "@@ -134,6 +134,10 @@ for (String fixtureName : ['hdfsFixture', 'haHdfsFixture', 'secureHdfsFixture',\n \n     args miniHDFSArgs.toArray()\n   }\n+\n+  // TODO: The task configuration block has side effects that require it currently to be always executed.\n+  // Otherwise tests start failing. Therefore we enforce the task creation for now.\n+  tsk.get()", "originalCommit": "0e9464182278e486e5aba4c41cfa461eade3e33c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA5NDExOQ==", "url": "https://github.com/elastic/elasticsearch/pull/56627#discussion_r427094119", "bodyText": "keeping create() might look like an oversight. I think this way makes it more explicit that there is something wrong with the task setup.", "author": "breskeby", "createdAt": "2020-05-19T07:42:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwOTIzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMwODYyMA==", "url": "https://github.com/elastic/elasticsearch/pull/56627#discussion_r427308620", "bodyText": "Cool, let's create an issue to look into what the task configuration block is doing that's required for test setup.", "author": "mark-vieira", "createdAt": "2020-05-19T13:38:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwOTIzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM1MTA2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56627#discussion_r427351069", "bodyText": "done here: #56948", "author": "breskeby", "createdAt": "2020-05-19T14:33:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwOTIzOA=="}], "type": "inlineReview"}, {"oid": "fc0c73b35b20e585984e41ab29e9d7e54aee9a6d", "url": "https://github.com/elastic/elasticsearch/commit/fc0c73b35b20e585984e41ab29e9d7e54aee9a6d", "message": "Fix tiny formatting issue", "committedDate": "2020-05-19T07:50:55Z", "type": "commit"}]}