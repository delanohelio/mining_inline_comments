{"pr_number": 54200, "pr_title": "HLRC: Don't send defaults for SubmitAsyncSearchRequest", "pr_createdAt": "2020-03-25T15:53:00Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54200", "timeline": [{"oid": "30d554d48fa1de866fdbb801905868fbf13b6a1c", "url": "https://github.com/elastic/elasticsearch/commit/30d554d48fa1de866fdbb801905868fbf13b6a1c", "message": "HLRC: Don't send defaults for SubmitAsyncSearchRequest\n\nCurrently we set the defaults for ccsMinimizeRoundtrips, preFilterShardSize and\nrequestCache on the HLRC SubmitAsyncSearchRequest in the constructor. This is no\nlonger needed since we now only send the parameters along with the rest request\nthat are supported (omitting e.g. ccsMinimizeRoundtrips) and the correct\ndefaults are set on the client side. This change removes setting and sending\nthese defaults where possible, leaving only the overwrite of batchedReduceSize\nwith a default value of 5, since the default used in the vanilla SearchRequest\nis 512. However, we don't need to send this value along as a request parameter\nif its the default since the correct one will be set on the receiving end if no\nvalue is specified.\nAlso adding tests for RestSubmitAsyncSearchAction that check the correct\ndefaults are set when parameters are missing on the server side.", "committedDate": "2020-03-25T15:57:44Z", "type": "commit"}, {"oid": "30d554d48fa1de866fdbb801905868fbf13b6a1c", "url": "https://github.com/elastic/elasticsearch/commit/30d554d48fa1de866fdbb801905868fbf13b6a1c", "message": "HLRC: Don't send defaults for SubmitAsyncSearchRequest\n\nCurrently we set the defaults for ccsMinimizeRoundtrips, preFilterShardSize and\nrequestCache on the HLRC SubmitAsyncSearchRequest in the constructor. This is no\nlonger needed since we now only send the parameters along with the rest request\nthat are supported (omitting e.g. ccsMinimizeRoundtrips) and the correct\ndefaults are set on the client side. This change removes setting and sending\nthese defaults where possible, leaving only the overwrite of batchedReduceSize\nwith a default value of 5, since the default used in the vanilla SearchRequest\nis 512. However, we don't need to send this value along as a request parameter\nif its the default since the correct one will be set on the receiving end if no\nvalue is specified.\nAlso adding tests for RestSubmitAsyncSearchAction that check the correct\ndefaults are set when parameters are missing on the server side.", "committedDate": "2020-03-25T15:57:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE1OTQ4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/54200#discussion_r398159482", "bodyText": "I would prefer if we found a way to not have the default value in the client too. Would it be an option to make this an Integer that is null by default, and only set it when it was explicitly set?", "author": "javanna", "createdAt": "2020-03-25T20:48:54Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/AsyncSearchRequestConverters.java", "diffHunk": "@@ -73,7 +73,9 @@ static void addSearchRequestParams(Params params, SubmitAsyncSearchRequest reque\n         if (request.getAllowPartialSearchResults() != null) {\n             params.withAllowPartialResults(request.getAllowPartialSearchResults());\n         }\n-        params.withBatchedReduceSize(request.getBatchedReduceSize());\n+        if (request.getBatchedReduceSize() != SubmitAsyncSearchRequest.DEFAULT_BATCHED_REDUCE_SIZE) {", "originalCommit": "30d554d48fa1de866fdbb801905868fbf13b6a1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1NDUxNA==", "url": "https://github.com/elastic/elasticsearch/pull/54200#discussion_r398454514", "bodyText": "That would be an Integer in the SubmitAsyncSearchRequest, masking the one in the wrapped SearchRequest, I think. I find that equally confusing from the code side tbh, we would keep most parameters set on the internal search request but only this in the async submit request? With the current defautl its at least clear when looking at the code what value is used when the user doesn't set this? wdyt?", "author": "cbuescher", "createdAt": "2020-03-26T10:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE1OTQ4Mg=="}], "type": "inlineReview"}, {"oid": "8d3ef0c9006d0de6cd61800f908d7922ecac8094", "url": "https://github.com/elastic/elasticsearch/commit/8d3ef0c9006d0de6cd61800f908d7922ecac8094", "message": "Merge branch 'master' into asyncsearch-hlrc-cleanup-defaults", "committedDate": "2020-03-26T10:15:06Z", "type": "commit"}, {"oid": "aa4ab12dd585b96cb797d278d0523a02702d075a", "url": "https://github.com/elastic/elasticsearch/commit/aa4ab12dd585b96cb797d278d0523a02702d075a", "message": "iter", "committedDate": "2020-03-26T10:20:50Z", "type": "commit"}, {"oid": "e594083ad7fd2bcc9c43e42bd1d83bb5ae121dbc", "url": "https://github.com/elastic/elasticsearch/commit/e594083ad7fd2bcc9c43e42bd1d83bb5ae121dbc", "message": "Hide batchedReducedSize from inner SearchRequest", "committedDate": "2020-03-26T10:36:02Z", "type": "commit"}, {"oid": "3b22491876ee530f81f3a37e7efdea4d3c7a8232", "url": "https://github.com/elastic/elasticsearch/commit/3b22491876ee530f81f3a37e7efdea4d3c7a8232", "message": "fix javadoc", "committedDate": "2020-03-26T10:51:49Z", "type": "commit"}]}