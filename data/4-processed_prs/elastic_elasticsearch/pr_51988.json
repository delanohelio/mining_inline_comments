{"pr_number": 51988, "pr_title": "Don't allow null User.principal", "pr_createdAt": "2020-02-06T10:14:42Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51988", "timeline": [{"oid": "5d433643a769d0948c8969b2bc78df278210863d", "url": "https://github.com/elastic/elasticsearch/commit/5d433643a769d0948c8969b2bc78df278210863d", "message": "Don't allow null User.principal\n\nSome parts of the User class (e.g. equals/hashCode) assumed that\nprincipal could never be null, but the constructor didn't enforce\nthat.\n\nThis adds a null check into the constructor and fixes a few tests that\nrelied on being able to pass in null usernames.", "committedDate": "2020-02-06T10:11:31Z", "type": "commit"}, {"oid": "4893d81dcd138b4b47f1015a0ab908e2c51efee5", "url": "https://github.com/elastic/elasticsearch/commit/4893d81dcd138b4b47f1015a0ab908e2c51efee5", "message": "Merge branch 'master' into null-principal-user", "committedDate": "2020-02-07T04:39:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyNDg4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/51988#discussion_r376224887", "bodyText": "(need a mock, because a real user cannot have a null username)\n\nCould we just remove this test case instead?", "author": "jkakavas", "createdAt": "2020-02-07T05:53:30Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/ingest/SetSecurityUserProcessorTests.java", "diffHunk": "@@ -42,15 +43,21 @@ public void testProcessor() throws Exception {\n         assertThat(result.get(\"email\"), equalTo(\"_email\"));\n         assertThat(((Map) result.get(\"metadata\")).size(), equalTo(1));\n         assertThat(((Map) result.get(\"metadata\")).get(\"key\"), equalTo(\"value\"));\n+    }\n \n-        // test when user holds no data:\n-        threadContext = new ThreadContext(Settings.EMPTY);\n-        user = new User(null, null, null);\n-        threadContext.putTransient(AuthenticationField.AUTHENTICATION_KEY, new Authentication(user, realmRef, null));\n-        ingestDocument = new IngestDocument(new HashMap<>(), new HashMap<>());\n-        processor = new SetSecurityUserProcessor(\"_tag\", threadContext, \"_field\", EnumSet.allOf(Property.class));\n+    public void testProcessorWithEmptyUserData() throws Exception {", "originalCommit": "4893d81dcd138b4b47f1015a0ab908e2c51efee5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyODc3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51988#discussion_r376228779", "bodyText": "Only if we also removed the code from the security processor that deals with nulls.\nWhich I considered, but I was already down a rabbit hole.\nWhat the processor is doing makes sense - it doesn't make any assumptions about whether a User can have a null principal (although it would also be fine for it to rely on it not being null), so I decided not to bite off even more right now, and just leave it.", "author": "tvernum", "createdAt": "2020-02-07T06:12:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyNDg4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyNTI4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/51988#discussion_r376225283", "bodyText": "nit: I hate when I get NPE in a line that has many calls and it's not quite obvious what threw it so I prefer to add a message to requireNotNull. Not sure if this is worth rerunning CI here though, just a suggestion", "author": "jkakavas", "createdAt": "2020-02-07T05:55:38Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/user/User.java", "diffHunk": "@@ -49,7 +50,7 @@ public User(String username, String[] roles, String fullName, String email, Map<\n \n     private User(String username, String[] roles, String fullName, String email, Map<String, Object> metadata, boolean enabled,\n                 User authenticatedUser) {\n-        this.username = username;\n+        this.username = Objects.requireNonNull(username);", "originalCommit": "4893d81dcd138b4b47f1015a0ab908e2c51efee5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyOTI4MA==", "url": "https://github.com/elastic/elasticsearch/pull/51988#discussion_r376229280", "bodyText": "But this line doesn't have many calls. As long as you can link the stacktrace to the code it's clear why this line throughs NPE.\nThat said, I'd be happy for the whole codebase to have a forbidden API on requireNonNull without a message, but we don't.", "author": "tvernum", "createdAt": "2020-02-07T06:14:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyNTI4Mw=="}], "type": "inlineReview"}]}