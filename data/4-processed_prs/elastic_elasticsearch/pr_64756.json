{"pr_number": 64756, "pr_title": "Fail force-merges on read-only engines", "pr_createdAt": "2020-11-09T06:31:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64756", "timeline": [{"oid": "2ab926bcc8ad2ee0fa43aa84da8861bbfe9b3048", "url": "https://github.com/elastic/elasticsearch/commit/2ab926bcc8ad2ee0fa43aa84da8861bbfe9b3048", "message": "Add low level log info to indicate read only index blocking operations.", "committedDate": "2020-11-09T06:19:28Z", "type": "commit"}, {"oid": "f66faa116428dabc861c144a157169981b4898db", "url": "https://github.com/elastic/elasticsearch/commit/f66faa116428dabc861c144a157169981b4898db", "message": "Support index write block for force merge.", "committedDate": "2020-11-09T15:33:20Z", "type": "commit"}, {"oid": "8ba6b7cbab55262c26c5db29e715c0a2ee53b4ff", "url": "https://github.com/elastic/elasticsearch/commit/8ba6b7cbab55262c26c5db29e715c0a2ee53b4ff", "message": "add test case.", "committedDate": "2020-11-09T15:52:22Z", "type": "commit"}, {"oid": "40ee1ef3a9ecd019eca53b985a10310b1c579324", "url": "https://github.com/elastic/elasticsearch/commit/40ee1ef3a9ecd019eca53b985a10310b1c579324", "message": "unsupport force merge for frozen index", "committedDate": "2020-11-11T02:38:07Z", "type": "commit"}, {"oid": "7b6ca7fe597958d9f740bbdb118cf6cb9d0b5399", "url": "https://github.com/elastic/elasticsearch/commit/7b6ca7fe597958d9f740bbdb118cf6cb9d0b5399", "message": "Merge branch 'master' into frozen_merge", "committedDate": "2020-11-13T01:08:42Z", "type": "commit"}, {"oid": "a0c3470b7184c3e23c2fd4d90cb646c67b945732", "url": "https://github.com/elastic/elasticsearch/commit/a0c3470b7184c3e23c2fd4d90cb646c67b945732", "message": "Reject force merge if it's going to do real merge.", "committedDate": "2020-11-13T08:10:58Z", "type": "commit"}, {"oid": "88674810e132a10793a172318d03411417f572a0", "url": "https://github.com/elastic/elasticsearch/commit/88674810e132a10793a172318d03411417f572a0", "message": "revert write block", "committedDate": "2020-11-13T08:14:02Z", "type": "commit"}, {"oid": "c3a6eb12c66e06080cf847ed7ad7e3abc4091302", "url": "https://github.com/elastic/elasticsearch/commit/c3a6eb12c66e06080cf847ed7ad7e3abc4091302", "message": "Merge master", "committedDate": "2020-12-12T13:15:06Z", "type": "commit"}, {"oid": "f41b425901d8cd6bae810c012c0ee7764181e1c0", "url": "https://github.com/elastic/elasticsearch/commit/f41b425901d8cd6bae810c012c0ee7764181e1c0", "message": "Remove unsued version", "committedDate": "2020-12-12T13:17:17Z", "type": "commit"}, {"oid": "c4a70a2e05e5cb5940d17fcba3b4fca4058ac21e", "url": "https://github.com/elastic/elasticsearch/commit/c4a70a2e05e5cb5940d17fcba3b4fca4058ac21e", "message": "Merge remote-tracking branch 'upstream/master' into frozen_merge", "committedDate": "2020-12-16T11:44:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI2MDc2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64756#discussion_r544260761", "bodyText": "This rejects force-merge requests that do not specify the maxNumSegments parameter at all, since that comes through to here as maxNumSegments == ForceMergeSegments.Defaults.MAX_NUM_SEGMENTS == -1. We should accept these requests too, it's ok for them to do nothing.", "author": "DaveCTurner", "createdAt": "2020-12-16T12:31:05Z", "path": "server/src/main/java/org/elasticsearch/index/engine/ReadOnlyEngine.java", "diffHunk": "@@ -375,6 +375,14 @@ public void flush(boolean force, boolean waitIfOngoing) throws EngineException {\n     @Override\n     public void forceMerge(boolean flush, int maxNumSegments, boolean onlyExpungeDeletes,\n                            boolean upgrade, boolean upgradeOnlyAncientSegments, String forceMergeUUID) {\n+        if (maxNumSegments < lastCommittedSegmentInfos.size()) {", "originalCommit": "c4a70a2e05e5cb5940d17fcba3b4fca4058ac21e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM3NjA1OA==", "url": "https://github.com/elastic/elasticsearch/pull/64756#discussion_r544376058", "bodyText": "That's right, I have updated the change.", "author": "howardhuanghua", "createdAt": "2020-12-16T15:10:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI2MDc2MQ=="}], "type": "inlineReview"}, {"oid": "971790f978c9ae2de685b6b4243d33d6ef7cb8ed", "url": "https://github.com/elastic/elasticsearch/commit/971790f978c9ae2de685b6b4243d33d6ef7cb8ed", "message": "Support default max num segments.", "committedDate": "2020-12-16T15:06:31Z", "type": "commit"}, {"oid": "f9327ba6f678c89b6db0119bfa5823fedc2ad008", "url": "https://github.com/elastic/elasticsearch/commit/f9327ba6f678c89b6db0119bfa5823fedc2ad008", "message": "Merge remote-tracking branch 'upstream/master' into frozen_merge", "committedDate": "2020-12-16T15:07:48Z", "type": "commit"}]}