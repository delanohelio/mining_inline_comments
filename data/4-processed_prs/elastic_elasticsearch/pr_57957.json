{"pr_number": 57957, "pr_title": "Disallow deletion of composable template if in use by data stream", "pr_createdAt": "2020-06-10T22:27:15Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57957", "timeline": [{"oid": "54a6f8ab26c64b5d0d0a9198660154bf4691830a", "url": "https://github.com/elastic/elasticsearch/commit/54a6f8ab26c64b5d0d0a9198660154bf4691830a", "message": "Disallow deletion of composable template if in use by data stream\n\nCurrently a data stream requires a component template in order to be created. This is so that the\nstream can be perpetuated when the index is automatically or manually rolled over. This commit\nensures that the composable index template used by the stream is not removed if the data stream\nstill exists.\n\nResolves #57004", "committedDate": "2020-06-10T22:26:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODQ3NDUxMg==", "url": "https://github.com/elastic/elasticsearch/pull/57957#discussion_r438474512", "bodyText": "pico-optimization: dataStreams not needed until after templateName is confirmed to exist", "author": "danhermann", "createdAt": "2020-06-11T00:14:26Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -617,6 +629,18 @@ static ClusterState innerRemoveIndexTemplateV2(ClusterState currentState, String\n         return ClusterState.builder(currentState).metadata(metadata).build();\n     }\n \n+    static Set<String> dataStreamsUsingTemplate(final ClusterState state, final String templateName) {\n+        final Set<String> dataStreams = state.metadata().dataStreams().keySet();", "originalCommit": "54a6f8ab26c64b5d0d0a9198660154bf4691830a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "feb7c7a653f8c962015945003636a529b736126e", "url": "https://github.com/elastic/elasticsearch/commit/feb7c7a653f8c962015945003636a529b736126e", "message": "Pico-optimize", "committedDate": "2020-06-11T14:06:10Z", "type": "commit"}, {"oid": "e729852b57e5cc434550be056ce73884d4a2f0d8", "url": "https://github.com/elastic/elasticsearch/commit/e729852b57e5cc434550be056ce73884d4a2f0d8", "message": "Merge branch 'master' into itv2-no-delete-if-data-stream", "committedDate": "2020-06-11T14:19:11Z", "type": "commit"}]}