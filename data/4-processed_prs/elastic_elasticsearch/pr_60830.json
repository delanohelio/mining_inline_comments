{"pr_number": 60830, "pr_title": "Add boolean values script fields", "pr_createdAt": "2020-08-06T16:10:48Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60830", "timeline": [{"oid": "f5d113a6d83958b28fe3412a31d447226e63fa10", "url": "https://github.com/elastic/elasticsearch/commit/f5d113a6d83958b28fe3412a31d447226e63fa10", "message": "Add boolean values script fields\n\nThis adds `boolean` values `runtime_script` fields.", "committedDate": "2020-08-06T16:09:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUyNTkzMg==", "url": "https://github.com/elastic/elasticsearch/pull/60830#discussion_r466525932", "bodyText": "I'm trying to mimic what we support in core. It works, so far as I can tell. It is kind of amazing we allow this at all, but we do!", "author": "nik9000", "createdAt": "2020-08-06T16:11:59Z", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptBooleanMappedFieldType.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.mapper;\n+\n+import org.apache.lucene.search.MatchNoDocsQuery;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.common.lucene.search.Queries;\n+import org.elasticsearch.common.time.DateMathParser;\n+import org.elasticsearch.index.mapper.BooleanFieldMapper;\n+import org.elasticsearch.index.query.QueryShardContext;\n+import org.elasticsearch.script.Script;\n+import org.elasticsearch.search.DocValueFormat;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+import org.elasticsearch.xpack.runtimefields.BooleanScriptFieldScript;\n+import org.elasticsearch.xpack.runtimefields.fielddata.ScriptBooleanFieldData;\n+import org.elasticsearch.xpack.runtimefields.query.BooleanScriptFieldExistsQuery;\n+import org.elasticsearch.xpack.runtimefields.query.BooleanScriptFieldTermQuery;\n+\n+import java.time.ZoneId;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+public class ScriptBooleanMappedFieldType extends AbstractScriptMappedFieldType {\n+    private final BooleanScriptFieldScript.Factory scriptFactory;\n+\n+    ScriptBooleanMappedFieldType(String name, Script script, BooleanScriptFieldScript.Factory scriptFactory, Map<String, String> meta) {\n+        super(name, script, meta);\n+        this.scriptFactory = scriptFactory;\n+    }\n+\n+    @Override\n+    protected String runtimeType() {\n+        return BooleanFieldMapper.CONTENT_TYPE;\n+    }\n+\n+    @Override\n+    public Object valueForDisplay(Object value) {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    public DocValueFormat docValueFormat(String format, ZoneId timeZone) {\n+        if (format != null) {\n+            throw new IllegalArgumentException(\"Field [\" + name() + \"] of type [\" + typeName() + \"] does not support custom formats\");\n+        }\n+        if (timeZone != null) {\n+            throw new IllegalArgumentException(\"Field [\" + name() + \"] of type [\" + typeName() + \"] does not support custom time zones\");\n+        }\n+        return DocValueFormat.BOOLEAN;\n+    }\n+\n+    @Override\n+    public ScriptBooleanFieldData.Builder fielddataBuilder(String fullyQualifiedIndexName, Supplier<SearchLookup> searchLookup) {\n+        return new ScriptBooleanFieldData.Builder(name(), leafFactory(searchLookup.get()));\n+    }\n+\n+    private BooleanScriptFieldScript.LeafFactory leafFactory(SearchLookup searchLookup) {\n+        return scriptFactory.newFactory(script.getParams(), searchLookup);\n+    }\n+\n+    @Override\n+    public Query existsQuery(QueryShardContext context) {\n+        checkAllowExpensiveQueries(context);\n+        return new BooleanScriptFieldExistsQuery(script, leafFactory(context.lookup()), name());\n+    }\n+\n+    @Override\n+    public Query rangeQuery(", "originalCommit": "f5d113a6d83958b28fe3412a31d447226e63fa10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyNTM2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/60830#discussion_r470525363", "bodyText": "oh boy :)", "author": "javanna", "createdAt": "2020-08-14T09:48:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUyNTkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyNDI5NA==", "url": "https://github.com/elastic/elasticsearch/pull/60830#discussion_r470524294", "bodyText": "I must say that multiple values for booleans look really weird, especially trying to summarize multiple values into one, and re-sorting them. Is this behaviour documented anywhere?", "author": "javanna", "createdAt": "2020-08-14T09:46:17Z", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/fielddata/ScriptBooleanDocValues.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.fielddata;\n+\n+import org.elasticsearch.index.fielddata.AbstractSortedNumericDocValues;\n+import org.elasticsearch.xpack.runtimefields.BooleanScriptFieldScript;\n+\n+import java.io.IOException;\n+\n+public final class ScriptBooleanDocValues extends AbstractSortedNumericDocValues {\n+    private final BooleanScriptFieldScript script;\n+    private int cursor;\n+\n+    ScriptBooleanDocValues(BooleanScriptFieldScript script) {\n+        this.script = script;\n+    }\n+\n+    @Override\n+    public boolean advanceExact(int docId) {\n+        script.runForDoc(docId);\n+        cursor = 0;\n+        return script.trues() > 0 || script.falses() > 0;\n+    }\n+\n+    @Override\n+    public long nextValue() throws IOException {\n+        // Emit all false values before all true values\n+        return cursor++ < script.falses() ? 0 : 1;", "originalCommit": "f5d113a6d83958b28fe3412a31d447226e63fa10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUyNjk0OA==", "url": "https://github.com/elastic/elasticsearch/pull/60830#discussion_r471526948", "bodyText": "I'm not sure it is, though it is what happens when you use doc values for out of the box booleans.", "author": "nik9000", "createdAt": "2020-08-17T14:41:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyNDI5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyNDU4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/60830#discussion_r470524586", "bodyText": "I never realized this either: booleans are double????", "author": "javanna", "createdAt": "2020-08-14T09:46:58Z", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/fielddata/ScriptBooleanFieldData.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.fielddata;\n+\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.index.SortedNumericDocValues;\n+import org.elasticsearch.ExceptionsHelper;\n+import org.elasticsearch.index.fielddata.IndexFieldData;\n+import org.elasticsearch.index.fielddata.IndexFieldDataCache;\n+import org.elasticsearch.index.fielddata.IndexNumericFieldData;\n+import org.elasticsearch.index.fielddata.plain.LeafLongFieldData;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.indices.breaker.CircuitBreakerService;\n+import org.elasticsearch.search.aggregations.support.CoreValuesSourceType;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceType;\n+import org.elasticsearch.xpack.runtimefields.BooleanScriptFieldScript;\n+\n+import java.io.IOException;\n+\n+public final class ScriptBooleanFieldData extends IndexNumericFieldData {\n+\n+    public static class Builder implements IndexFieldData.Builder {\n+        private final String name;\n+        private final BooleanScriptFieldScript.LeafFactory leafFactory;\n+\n+        public Builder(String name, BooleanScriptFieldScript.LeafFactory leafFactory) {\n+            this.name = name;\n+            this.leafFactory = leafFactory;\n+        }\n+\n+        @Override\n+        public ScriptBooleanFieldData build(IndexFieldDataCache cache, CircuitBreakerService breakerService, MapperService mapperService) {\n+            return new ScriptBooleanFieldData(name, leafFactory);\n+        }\n+    }\n+\n+    private final String fieldName;\n+    private final BooleanScriptFieldScript.LeafFactory leafFactory;\n+\n+    private ScriptBooleanFieldData(String fieldName, BooleanScriptFieldScript.LeafFactory leafFactory) {\n+        this.fieldName = fieldName;\n+        this.leafFactory = leafFactory;\n+    }\n+\n+    @Override\n+    public String getFieldName() {\n+        return fieldName;\n+    }\n+\n+    @Override\n+    public ValuesSourceType getValuesSourceType() {\n+        return CoreValuesSourceType.BOOLEAN;\n+    }\n+\n+    @Override\n+    public ScriptBooleanLeafFieldData load(LeafReaderContext context) {\n+        try {\n+            return loadDirect(context);\n+        } catch (Exception e) {\n+            throw ExceptionsHelper.convertToElastic(e);\n+        }\n+    }\n+\n+    @Override\n+    public ScriptBooleanLeafFieldData loadDirect(LeafReaderContext context) throws IOException {\n+        return new ScriptBooleanLeafFieldData(new ScriptBooleanDocValues(leafFactory.newInstance(context)));\n+    }\n+\n+    @Override\n+    public NumericType getNumericType() {\n+        return NumericType.DOUBLE;", "originalCommit": "f5d113a6d83958b28fe3412a31d447226e63fa10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzMTg0MA==", "url": "https://github.com/elastic/elasticsearch/pull/60830#discussion_r471531840", "bodyText": "Ooops, copy and paste error. Fixing.", "author": "nik9000", "createdAt": "2020-08-17T14:49:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyNDU4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyNTE5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/60830#discussion_r470525197", "bodyText": "why do we throw? Shouldn't we borrow the logic from https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/index/mapper/BooleanFieldMapper.java#L157 ?", "author": "javanna", "createdAt": "2020-08-14T09:48:12Z", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptBooleanMappedFieldType.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.mapper;\n+\n+import org.apache.lucene.search.MatchNoDocsQuery;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.common.lucene.search.Queries;\n+import org.elasticsearch.common.time.DateMathParser;\n+import org.elasticsearch.index.mapper.BooleanFieldMapper;\n+import org.elasticsearch.index.query.QueryShardContext;\n+import org.elasticsearch.script.Script;\n+import org.elasticsearch.search.DocValueFormat;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+import org.elasticsearch.xpack.runtimefields.BooleanScriptFieldScript;\n+import org.elasticsearch.xpack.runtimefields.fielddata.ScriptBooleanFieldData;\n+import org.elasticsearch.xpack.runtimefields.query.BooleanScriptFieldExistsQuery;\n+import org.elasticsearch.xpack.runtimefields.query.BooleanScriptFieldTermQuery;\n+\n+import java.time.ZoneId;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+public class ScriptBooleanMappedFieldType extends AbstractScriptMappedFieldType {\n+    private final BooleanScriptFieldScript.Factory scriptFactory;\n+\n+    ScriptBooleanMappedFieldType(String name, Script script, BooleanScriptFieldScript.Factory scriptFactory, Map<String, String> meta) {\n+        super(name, script, meta);\n+        this.scriptFactory = scriptFactory;\n+    }\n+\n+    @Override\n+    protected String runtimeType() {\n+        return BooleanFieldMapper.CONTENT_TYPE;\n+    }\n+\n+    @Override\n+    public Object valueForDisplay(Object value) {\n+        throw new UnsupportedOperationException();", "originalCommit": "f5d113a6d83958b28fe3412a31d447226e63fa10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1MTI1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/60830#discussion_r471551253", "bodyText": "I can do that, but I don't think it is ever called!", "author": "nik9000", "createdAt": "2020-08-17T15:18:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyNTE5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0ODg5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/60830#discussion_r472048893", "bodyText": "oh well I did not realize it was unused, in that case I am good with throwing, but add a comment?", "author": "javanna", "createdAt": "2020-08-18T09:36:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyNTE5Nw=="}], "type": "inlineReview"}, {"oid": "da4b24f70e7f7b77c0fac81386ebee9135ab63a4", "url": "https://github.com/elastic/elasticsearch/commit/da4b24f70e7f7b77c0fac81386ebee9135ab63a4", "message": "Merge branch 'feature/runtime_fields' into script_field_boolean", "committedDate": "2020-08-17T14:41:57Z", "type": "commit"}, {"oid": "97b51fbd42c92394fd599113697e8fbdd59f20d9", "url": "https://github.com/elastic/elasticsearch/commit/97b51fbd42c92394fd599113697e8fbdd59f20d9", "message": "Fixup", "committedDate": "2020-08-17T14:51:26Z", "type": "commit"}, {"oid": "9667b9c41d83845540b1f53a3c54d460915c67cf", "url": "https://github.com/elastic/elasticsearch/commit/9667b9c41d83845540b1f53a3c54d460915c67cf", "message": "Merge branch 'feature/runtime_fields' into script_field_boolean", "committedDate": "2020-08-17T14:57:32Z", "type": "commit"}, {"oid": "ce7b062d116414462c87d0af808b28b96595b73d", "url": "https://github.com/elastic/elasticsearch/commit/ce7b062d116414462c87d0af808b28b96595b73d", "message": "Fixup after merge", "committedDate": "2020-08-17T14:58:28Z", "type": "commit"}, {"oid": "7173f5bde110507ba878f02f73766dbbb489e2e1", "url": "https://github.com/elastic/elasticsearch/commit/7173f5bde110507ba878f02f73766dbbb489e2e1", "message": "Universal parsing", "committedDate": "2020-08-17T15:10:29Z", "type": "commit"}, {"oid": "21a810f868a41e496275090429c07da112f3e6d5", "url": "https://github.com/elastic/elasticsearch/commit/21a810f868a41e496275090429c07da112f3e6d5", "message": "Dualing queries", "committedDate": "2020-08-17T16:08:57Z", "type": "forcePushed"}, {"oid": "21a810f868a41e496275090429c07da112f3e6d5", "url": "https://github.com/elastic/elasticsearch/commit/21a810f868a41e496275090429c07da112f3e6d5", "message": "Dualing queries", "committedDate": "2020-08-17T16:08:57Z", "type": "commit"}]}