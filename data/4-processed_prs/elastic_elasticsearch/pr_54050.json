{"pr_number": 54050, "pr_title": "Use special XContent registry for node tool", "pr_createdAt": "2020-03-24T06:25:06Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54050", "timeline": [{"oid": "347c784258d8bc090587a2ed83db06483591ff35", "url": "https://github.com/elastic/elasticsearch/commit/347c784258d8bc090587a2ed83db06483591ff35", "message": "Use special XContent registry for node tool\n\nCloses #53549", "committedDate": "2020-03-24T06:21:50Z", "type": "commit"}, {"oid": "ca1b564231107c5baed263d6878455d96f822125", "url": "https://github.com/elastic/elasticsearch/commit/ca1b564231107c5baed263d6878455d96f822125", "message": "compile", "committedDate": "2020-03-24T06:36:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA4NjQ4MA==", "url": "https://github.com/elastic/elasticsearch/pull/54050#discussion_r397086480", "bodyText": "assert false here to be sure we're not calling this?", "author": "DaveCTurner", "createdAt": "2020-03-24T11:36:52Z", "path": "server/src/main/java/org/elasticsearch/cluster/coordination/ElasticsearchNodeCommand.java", "diffHunk": "@@ -168,4 +186,45 @@ protected abstract void processNodePaths(Terminal terminal, Path[] dataPaths, Op\n     OptionParser getParser() {\n         return parser;\n     }\n+\n+    public static class UnknownMetaDataCustom implements MetaData.Custom {\n+\n+        private final String name;\n+        private final Map<String, Object> contents;\n+\n+        public UnknownMetaDataCustom(String name, Map<String, Object> contents) {\n+            this.name = name;\n+            this.contents = contents;\n+        }\n+\n+        @Override\n+        public EnumSet<MetaData.XContentContext> context() {\n+            return EnumSet.of(MetaData.XContentContext.API, MetaData.XContentContext.GATEWAY);\n+        }\n+\n+        @Override\n+        public Diff<MetaData.Custom> diff(MetaData.Custom previousState) {\n+            throw new UnsupportedOperationException();", "originalCommit": "ca1b564231107c5baed263d6878455d96f822125", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA4NjUwNw==", "url": "https://github.com/elastic/elasticsearch/pull/54050#discussion_r397086507", "bodyText": "assert false here to be sure we're not calling this?", "author": "DaveCTurner", "createdAt": "2020-03-24T11:36:56Z", "path": "server/src/main/java/org/elasticsearch/cluster/coordination/ElasticsearchNodeCommand.java", "diffHunk": "@@ -168,4 +186,45 @@ protected abstract void processNodePaths(Terminal terminal, Path[] dataPaths, Op\n     OptionParser getParser() {\n         return parser;\n     }\n+\n+    public static class UnknownMetaDataCustom implements MetaData.Custom {\n+\n+        private final String name;\n+        private final Map<String, Object> contents;\n+\n+        public UnknownMetaDataCustom(String name, Map<String, Object> contents) {\n+            this.name = name;\n+            this.contents = contents;\n+        }\n+\n+        @Override\n+        public EnumSet<MetaData.XContentContext> context() {\n+            return EnumSet.of(MetaData.XContentContext.API, MetaData.XContentContext.GATEWAY);\n+        }\n+\n+        @Override\n+        public Diff<MetaData.Custom> diff(MetaData.Custom previousState) {\n+            throw new UnsupportedOperationException();\n+        }\n+\n+        @Override\n+        public String getWriteableName() {\n+            return name;\n+        }\n+\n+        @Override\n+        public Version getMinimalSupportedVersion() {\n+            throw new UnsupportedOperationException();", "originalCommit": "ca1b564231107c5baed263d6878455d96f822125", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA4NjUzMA==", "url": "https://github.com/elastic/elasticsearch/pull/54050#discussion_r397086530", "bodyText": "assert false here to be sure we're not calling this?", "author": "DaveCTurner", "createdAt": "2020-03-24T11:36:59Z", "path": "server/src/main/java/org/elasticsearch/cluster/coordination/ElasticsearchNodeCommand.java", "diffHunk": "@@ -168,4 +186,45 @@ protected abstract void processNodePaths(Terminal terminal, Path[] dataPaths, Op\n     OptionParser getParser() {\n         return parser;\n     }\n+\n+    public static class UnknownMetaDataCustom implements MetaData.Custom {\n+\n+        private final String name;\n+        private final Map<String, Object> contents;\n+\n+        public UnknownMetaDataCustom(String name, Map<String, Object> contents) {\n+            this.name = name;\n+            this.contents = contents;\n+        }\n+\n+        @Override\n+        public EnumSet<MetaData.XContentContext> context() {\n+            return EnumSet.of(MetaData.XContentContext.API, MetaData.XContentContext.GATEWAY);\n+        }\n+\n+        @Override\n+        public Diff<MetaData.Custom> diff(MetaData.Custom previousState) {\n+            throw new UnsupportedOperationException();\n+        }\n+\n+        @Override\n+        public String getWriteableName() {\n+            return name;\n+        }\n+\n+        @Override\n+        public Version getMinimalSupportedVersion() {\n+            throw new UnsupportedOperationException();\n+        }\n+\n+        @Override\n+        public void writeTo(StreamOutput out) throws IOException {\n+            throw new UnsupportedOperationException();", "originalCommit": "ca1b564231107c5baed263d6878455d96f822125", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA4ODc1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/54050#discussion_r397088752", "bodyText": "Why keep IndicesModule.getNamedXContents() but drop ClusterModule.getNamedXWriteables() here? Shouldn't we handle Condition named objects similarly to MetaData.Custom?\n\nEdit: we discussed this in another channel and it's kinda thorny because the Condition things are represented as JSON primitives (strings, numbers) rather than objects. Could you add a comment recording that in the source", "author": "DaveCTurner", "createdAt": "2020-03-24T11:41:14Z", "path": "server/src/main/java/org/elasticsearch/cluster/coordination/ElasticsearchNodeCommand.java", "diffHunk": "@@ -65,10 +70,23 @@\n     protected static final String CS_MISSING_MSG =\n         \"cluster state is empty, cluster has never been bootstrapped?\";\n \n-    protected static final NamedXContentRegistry namedXContentRegistry = new NamedXContentRegistry(\n-        Stream.of(ClusterModule.getNamedXWriteables().stream(), IndicesModule.getNamedXContents().stream())\n-            .flatMap(Function.identity())\n-            .collect(Collectors.toList()));\n+    // fake the registry here, as command-line tools are not loading plugins, and ensure that it preserves the parsed XContent\n+    public static final NamedXContentRegistry namedXContentRegistry = new NamedXContentRegistry(IndicesModule.getNamedXContents()) {", "originalCommit": "ca1b564231107c5baed263d6878455d96f822125", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2NDAzNw==", "url": "https://github.com/elastic/elasticsearch/pull/54050#discussion_r397164037", "bodyText": "I've made some adaptions in 89b0810 where the code (and comment) hopefully makes it easier to explain what's going on.", "author": "ywelsch", "createdAt": "2020-03-24T13:47:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA4ODc1Mg=="}], "type": "inlineReview"}, {"oid": "89b0810e5b910493449c5e9d73e05e097fdf418a", "url": "https://github.com/elastic/elasticsearch/commit/89b0810e5b910493449c5e9d73e05e097fdf418a", "message": "feedback", "committedDate": "2020-03-24T13:44:02Z", "type": "commit"}, {"oid": "f44bec8cc9eb8cd5f59fa2b7fe9f159be31e8aba", "url": "https://github.com/elastic/elasticsearch/commit/f44bec8cc9eb8cd5f59fa2b7fe9f159be31e8aba", "message": "Thanks for tests", "committedDate": "2020-03-24T15:06:19Z", "type": "commit"}]}