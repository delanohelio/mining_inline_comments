{"pr_number": 61603, "pr_title": "Add Lucene 8.6.0 memory leak as a known issue", "pr_createdAt": "2020-08-26T19:17:11Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61603", "timeline": [{"oid": "e282e2ddd017f268fe1921a90347b20ce81fca81", "url": "https://github.com/elastic/elasticsearch/commit/e282e2ddd017f268fe1921a90347b20ce81fca81", "message": "Add Lucene 8.6.0 memory leak as a known issue\n\nThis commit adds a note to the known issues docs that Lucene 8.6.0\ncontains a memory leak that manifests in Elasticsearch as a slow memory\nleak.", "committedDate": "2020-08-26T19:20:27Z", "type": "commit"}, {"oid": "e282e2ddd017f268fe1921a90347b20ce81fca81", "url": "https://github.com/elastic/elasticsearch/commit/e282e2ddd017f268fe1921a90347b20ce81fca81", "message": "Add Lucene 8.6.0 memory leak as a known issue\n\nThis commit adds a note to the known issues docs that Lucene 8.6.0\ncontains a memory leak that manifests in Elasticsearch as a slow memory\nleak.", "committedDate": "2020-08-26T19:20:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzNDU4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/61603#discussion_r477534587", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              forced refreshes, meaning that this memory manifests in Elasticsearch under\n          \n          \n            \n              forced refreshes, meaning that this memory leak manifests in Elasticsearch under", "author": "DaveCTurner", "createdAt": "2020-08-26T19:21:08Z", "path": "docs/reference/release-notes/7.9.asciidoc", "diffHunk": "@@ -29,6 +29,23 @@ find out about the issue after upgrading then reindexing is required to recover.\n Full details of the mitigations are in\n {ml-docs}/ml-troubleshooting.html#ml-troubleshooting-mappings[Upgrade to 7.9.0 causes incorrect mappings].\n \n+* Lucene 8.6.0, on which Elasticsearch 7.9.0 is based,\n+  https://issues.apache.org/jira/browse/LUCENE-9478[contains a memory\n+  leak]. This memory leak manifests in Elasticsearch when a single document is\n+  updated repeatedly with a forced refresh. The cluster state storage layer in\n+  Elasticsearch is based on Lucene and does use single-document updates with\n+  forced refreshes, meaning that this memory manifests in Elasticsearch under", "originalCommit": "e282e2ddd017f268fe1921a90347b20ce81fca81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzNDc3MA==", "url": "https://github.com/elastic/elasticsearch/pull/61603#discussion_r477534770", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              out of memory errors. A workaround is to restart any nodes exhibiting these\n          \n          \n            \n              out-of-memory errors. A workaround is to restart any nodes exhibiting these", "author": "DaveCTurner", "createdAt": "2020-08-26T19:21:32Z", "path": "docs/reference/release-notes/7.9.asciidoc", "diffHunk": "@@ -29,6 +29,23 @@ find out about the issue after upgrading then reindexing is required to recover.\n Full details of the mitigations are in\n {ml-docs}/ml-troubleshooting.html#ml-troubleshooting-mappings[Upgrade to 7.9.0 causes incorrect mappings].\n \n+* Lucene 8.6.0, on which Elasticsearch 7.9.0 is based,\n+  https://issues.apache.org/jira/browse/LUCENE-9478[contains a memory\n+  leak]. This memory leak manifests in Elasticsearch when a single document is\n+  updated repeatedly with a forced refresh. The cluster state storage layer in\n+  Elasticsearch is based on Lucene and does use single-document updates with\n+  forced refreshes, meaning that this memory manifests in Elasticsearch under\n+  normal conditions. It also manifests when user-controlled workloads update a\n+  single document in an index repeatedly with a forced refresh. In both cases,\n+  the memory leak is around 500 bytes per update, so it does take some time for\n+  the leak to show any meaningful impact on the system. Symptoms of this memory\n+  leak are the size of the used heap slowly rising over time, requests\n+  eventually being rejected by the real memory circuit breaker, and potentially\n+  out of memory errors. A workaround is to restart any nodes exhibiting these", "originalCommit": "e282e2ddd017f268fe1921a90347b20ce81fca81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1a9ef84694f352624234bdc2d4082fa46a4e4285", "url": "https://github.com/elastic/elasticsearch/commit/1a9ef84694f352624234bdc2d4082fa46a4e4285", "message": "Update docs/reference/release-notes/7.9.asciidoc\n\nCo-authored-by: David Turner <david.turner@elastic.co>", "committedDate": "2020-08-26T19:29:03Z", "type": "commit"}, {"oid": "a4873dade24095b2b9c3b901e44e548330fcd729", "url": "https://github.com/elastic/elasticsearch/commit/a4873dade24095b2b9c3b901e44e548330fcd729", "message": "Update docs/reference/release-notes/7.9.asciidoc\n\nCo-authored-by: David Turner <david.turner@elastic.co>", "committedDate": "2020-08-26T19:29:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0MTQxMA==", "url": "https://github.com/elastic/elasticsearch/pull/61603#discussion_r477541410", "bodyText": "We use flush not refresh in the cluster state storage. But I think it's okay to leave it as is.", "author": "dnhatn", "createdAt": "2020-08-26T19:34:18Z", "path": "docs/reference/release-notes/7.9.asciidoc", "diffHunk": "@@ -29,6 +29,23 @@ find out about the issue after upgrading then reindexing is required to recover.\n Full details of the mitigations are in\n {ml-docs}/ml-troubleshooting.html#ml-troubleshooting-mappings[Upgrade to 7.9.0 causes incorrect mappings].\n \n+* Lucene 8.6.0, on which Elasticsearch 7.9.0 is based,\n+  https://issues.apache.org/jira/browse/LUCENE-9478[contains a memory\n+  leak]. This memory leak manifests in Elasticsearch when a single document is\n+  updated repeatedly with a forced refresh. The cluster state storage layer in\n+  Elasticsearch is based on Lucene and does use single-document updates with\n+  forced refreshes, meaning that this memory leak manifests in Elasticsearch under", "originalCommit": "a4873dade24095b2b9c3b901e44e548330fcd729", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}