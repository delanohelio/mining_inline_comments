{"pr_number": 60107, "pr_title": "Stop Serializing RepositoryData Twice when Writing", "pr_createdAt": "2020-07-23T09:52:10Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60107", "timeline": [{"oid": "dc710ec19c613441288c4cf78ebaf899c57191c7", "url": "https://github.com/elastic/elasticsearch/commit/dc710ec19c613441288c4cf78ebaf899c57191c7", "message": "Stop Serializing RepositoryData Twice when Writing\n\nWe can save one round of serializing `RepositoryData` on the write path.\nThis also leads to somewhat better compression because we compress larger chunks\nin one go potentially when compared to serializing and compressing in one go.\nAlso, fixed the double wrapping of collections when copying the repository\ndata instance via the `withGenId`.", "committedDate": "2020-07-23T09:47:05Z", "type": "commit"}, {"oid": "52e0fc743a771726e4323c0caddf18d180222f9e", "url": "https://github.com/elastic/elasticsearch/commit/52e0fc743a771726e4323c0caddf18d180222f9e", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix-double-serialization-repository-data", "committedDate": "2020-07-23T09:52:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM1OTk1OA==", "url": "https://github.com/elastic/elasticsearch/pull/60107#discussion_r459359958", "bodyText": "Still kind of awkward to right away serialize what we just read but I didn't want to make the bigger changes required for not having to serialize here in this PR + it's a rare spot to get here anyway and only applies to the first load of repository data on a master node.", "author": "original-brownbear", "createdAt": "2020-07-23T10:39:25Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1250,9 +1249,11 @@ private void doGetRepositoryData(ActionListener<RepositoryData> listener) {\n                     loaded = repositoryDataFromCachedEntry(cached);\n                 } else {\n                     loaded = getRepositoryData(genToLoad);\n-                    // We can cache in the most recent version here without regard to the actual repository metadata version since we're\n-                    // only caching the information that we just wrote and thus won't accidentally cache any information that isn't safe\n-                    cacheRepositoryData(loaded, Version.CURRENT);\n+                    // We can cache serialized in the most recent version here without regard to the actual repository metadata version\n+                    // since we're only caching the information that we just wrote and thus won't accidentally cache any information that\n+                    // isn't safe\n+                    cacheRepositoryData(", "originalCommit": "dc710ec19c613441288c4cf78ebaf899c57191c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4Mzk4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/60107#discussion_r461383986", "bodyText": "I think it's a bit weird to set this only at the very end. I think we shuld set the new genId on the RepositoryData object as soon as we have final long newGen = setPendingStep.result();?", "author": "ywelsch", "createdAt": "2020-07-28T07:45:53Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1601,7 +1601,7 @@ public void clusterStateProcessed(String source, ClusterState oldState, ClusterS\n                             } catch (IOException e) {\n                                 logger.warn(() -> new ParameterizedMessage(\"Failed to clean up old index blobs {}\", oldIndexN), e);\n                             }\n-                            return writtenRepositoryData;\n+                            return filteredRepositoryData.withGenId(newGen);", "originalCommit": "dc710ec19c613441288c4cf78ebaf899c57191c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM5MzM0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/60107#discussion_r461393343", "bodyText": "Fair point, I pushed 602e32f to clean this up :)", "author": "original-brownbear", "createdAt": "2020-07-28T08:02:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4Mzk4Ng=="}], "type": "inlineReview"}, {"oid": "9f99d0cd84d0b7305aaef99e2e2bdbd0564a316e", "url": "https://github.com/elastic/elasticsearch/commit/9f99d0cd84d0b7305aaef99e2e2bdbd0564a316e", "message": "Merge remote-tracking branch 'elastic/master' into fix-double-serialization-repository-data", "committedDate": "2020-07-28T07:56:37Z", "type": "commit"}, {"oid": "602e32f413a3ce3ec17057eb2ae6e2998ebb07c1", "url": "https://github.com/elastic/elasticsearch/commit/602e32f413a3ce3ec17057eb2ae6e2998ebb07c1", "message": "CR: set repo gen asap", "committedDate": "2020-07-28T08:01:46Z", "type": "commit"}]}