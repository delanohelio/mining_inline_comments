{"pr_number": 59456, "pr_title": "Add indexing pressure documentation", "pr_createdAt": "2020-07-13T19:36:47Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59456", "timeline": [{"oid": "86971d431831dde0b18bfc339a6531a77707abfd", "url": "https://github.com/elastic/elasticsearch/commit/86971d431831dde0b18bfc339a6531a77707abfd", "message": "Add indexing pressure documentation\n\nThis commit adds documentation about the new indexing pressure memory\nlimit setting and exposure of this metrics in node stats.", "committedDate": "2020-07-13T19:33:28Z", "type": "commit"}, {"oid": "54bc0ffee857dab5c0fc0a1c4f51e54fb50914c6", "url": "https://github.com/elastic/elasticsearch/commit/54bc0ffee857dab5c0fc0a1c4f51e54fb50914c6", "message": "Changes", "committedDate": "2020-07-13T19:34:58Z", "type": "commit"}, {"oid": "e6a66373b1ec8d5a820ff05b33558f2db1aef005", "url": "https://github.com/elastic/elasticsearch/commit/e6a66373b1ec8d5a820ff05b33558f2db1aef005", "message": "Fixes", "committedDate": "2020-07-13T19:57:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI0NDQ1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r454244451", "bodyText": "I would swap it around: current and total indexing load", "author": "ywelsch", "createdAt": "2020-07-14T10:00:53Z", "path": "docs/reference/cluster/nodes-stats.asciidoc", "diffHunk": "@@ -58,6 +58,10 @@ using metrics.\n   `http`::\n       HTTP connection information.\n \n+  `indexing_pressure`::\n+        Indexing pressure statistics about total and current indexing load and", "originalCommit": "e6a66373b1ec8d5a820ff05b33558f2db1aef005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI0Nzc3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r454247779", "bodyText": "maybe cross-link to the indexing pressure section here (index-modules-indexing-pressure)", "author": "ywelsch", "createdAt": "2020-07-14T10:07:18Z", "path": "docs/reference/cluster/nodes-stats.asciidoc", "diffHunk": "@@ -2099,6 +2103,62 @@ Number of failed operations for the processor.\n =======\n ======\n \n+[[cluster-nodes-stats-api-response-body-indexing-pressure]]\n+`indexing_pressure`::\n+(object)\n+Contains indexing pressure statistics for the node.", "originalCommit": "e6a66373b1ec8d5a820ff05b33558f2db1aef005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI0OTkzMA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r454249930", "bodyText": "maybe add that it would adversely affect other parts of the system (e.g. searches, cluster coordination, ...)", "author": "ywelsch", "createdAt": "2020-07-14T10:11:22Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,56 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing Pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated.", "originalCommit": "e6a66373b1ec8d5a820ff05b33558f2db1aef005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1MDUzOA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r454250538", "bodyText": "or internally by mechanisms such recoveries and cross-cluster replication.", "author": "ywelsch", "createdAt": "2020-07-14T10:12:38Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,56 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing Pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or CCR follow tasks. However, there is some internal indexing pressure", "originalCommit": "e6a66373b1ec8d5a820ff05b33558f2db1aef005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1MDczMg==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r454250732", "bodyText": "I would leave out this sentence (and mention recoveries  in the above one)", "author": "ywelsch", "createdAt": "2020-07-14T10:12:59Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,56 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing Pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or CCR follow tasks. However, there is some internal indexing pressure\n+during a shard recovery or primary failover.", "originalCommit": "e6a66373b1ec8d5a820ff05b33558f2db1aef005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1MTUxOA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r454251518", "bodyText": "into Lucene and the translog (switch order)", "author": "ywelsch", "createdAt": "2020-07-14T10:14:34Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,56 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing Pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or CCR follow tasks. However, there is some internal indexing pressure\n+during a shard recovery or primary failover.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing Stages\n+\n+External indexing operations go through three stages. The node receiving the\n+indexing request is the coordinating node. In the coordinating stage the node\n+performs any configured ingest pipelines, separates the request into individual\n+shard requests, and dispatches the requests to the primary shards.\n+\n+In the primary stage, the primary shard node ensures that it is still the primary\n+(otherwise it reroutes the request to the new primary), waits on active shards,\n+indexes the documents into its <<index-modules-translog,Translog>> and Lucene, and", "originalCommit": "e6a66373b1ec8d5a820ff05b33558f2db1aef005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1MTU2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r454251565", "bodyText": "and replicates the writes to the replicas", "author": "ywelsch", "createdAt": "2020-07-14T10:14:39Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,56 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing Pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or CCR follow tasks. However, there is some internal indexing pressure\n+during a shard recovery or primary failover.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing Stages\n+\n+External indexing operations go through three stages. The node receiving the\n+indexing request is the coordinating node. In the coordinating stage the node\n+performs any configured ingest pipelines, separates the request into individual\n+shard requests, and dispatches the requests to the primary shards.\n+\n+In the primary stage, the primary shard node ensures that it is still the primary\n+(otherwise it reroutes the request to the new primary), waits on active shards,\n+indexes the documents into its <<index-modules-translog,Translog>> and Lucene, and\n+dispatches to the replicas.", "originalCommit": "e6a66373b1ec8d5a820ff05b33558f2db1aef005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1MTg2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r454251865", "bodyText": "switch Lucene and translog", "author": "ywelsch", "createdAt": "2020-07-14T10:15:07Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,56 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing Pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or CCR follow tasks. However, there is some internal indexing pressure\n+during a shard recovery or primary failover.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing Stages\n+\n+External indexing operations go through three stages. The node receiving the\n+indexing request is the coordinating node. In the coordinating stage the node\n+performs any configured ingest pipelines, separates the request into individual\n+shard requests, and dispatches the requests to the primary shards.\n+\n+In the primary stage, the primary shard node ensures that it is still the primary\n+(otherwise it reroutes the request to the new primary), waits on active shards,\n+indexes the documents into its <<index-modules-translog,Translog>> and Lucene, and\n+dispatches to the replicas.\n+\n+Finally, in the replica stage, every available replica node indexes the documents\n+into its <<index-modules-translog,Translog>> and Lucene.", "originalCommit": "e6a66373b1ec8d5a820ff05b33558f2db1aef005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1NDQyMA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r454254420", "bodyText": "This overlaps somewhat with the Basic write model section of data-replication.asciidoc ( which is mostly missing the coordinating bits). I wonder if we can extend that one and link to it here?", "author": "ywelsch", "createdAt": "2020-07-14T10:19:57Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,56 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing Pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or CCR follow tasks. However, there is some internal indexing pressure\n+during a shard recovery or primary failover.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing Stages", "originalCommit": "e6a66373b1ec8d5a820ff05b33558f2db1aef005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1NjU3NA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r454256574", "bodyText": "The stages are sequential (first coordination, then primary, then replica).\nWhat's missing in this doc is how the accounting works, i.e. that coordination accounting is only done once all subsequent stages are done, same for primary stage. This can be explained that ES internally retries operations and therefore keeps the operation in-memory until all subsequent stages have successfully completed.", "author": "ywelsch", "createdAt": "2020-07-14T10:24:08Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,56 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing Pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or CCR follow tasks. However, there is some internal indexing pressure\n+during a shard recovery or primary failover.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing Stages", "originalCommit": "e6a66373b1ec8d5a820ff05b33558f2db1aef005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1NzE0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r454257141", "bodyText": "I wonder if we should add here that this setting is already generously sized, and that increasing it too much will have adverse effects on the rest of the system?", "author": "ywelsch", "createdAt": "2020-07-14T10:25:07Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,56 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing Pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or CCR follow tasks. However, there is some internal indexing pressure\n+during a shard recovery or primary failover.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing Stages\n+\n+External indexing operations go through three stages. The node receiving the\n+indexing request is the coordinating node. In the coordinating stage the node\n+performs any configured ingest pipelines, separates the request into individual\n+shard requests, and dispatches the requests to the primary shards.\n+\n+In the primary stage, the primary shard node ensures that it is still the primary\n+(otherwise it reroutes the request to the new primary), waits on active shards,\n+indexes the documents into its <<index-modules-translog,Translog>> and Lucene, and\n+dispatches to the replicas.\n+\n+Finally, in the replica stage, every available replica node indexes the documents\n+into its <<index-modules-translog,Translog>> and Lucene.\n+\n+\n+[float]\n+=== Memory Limits\n+\n+Elasticsearch exposes a node setting `indexing_pressure.memory.limit` which\n+restricts the number of bytes for outstanding indexing requests. Be default,\n+this setting is configured to be 10% of the heap.", "originalCommit": "e6a66373b1ec8d5a820ff05b33558f2db1aef005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d0549eb35a78a8834e99d13ae9a7f3dc4f5dfc47", "url": "https://github.com/elastic/elasticsearch/commit/d0549eb35a78a8834e99d13ae9a7f3dc4f5dfc47", "message": "Merge remote-tracking branch 'upstream/master' into indexing_pressure_docs", "committedDate": "2020-07-15T17:33:24Z", "type": "commit"}, {"oid": "fdfa56fb773cbc99e23fa23d851d055b8ddb384b", "url": "https://github.com/elastic/elasticsearch/commit/fdfa56fb773cbc99e23fa23d851d055b8ddb384b", "message": "WIP", "committedDate": "2020-07-15T23:52:33Z", "type": "commit"}, {"oid": "eea17d421cdf20ae0a0f5ce7007edd830775e4c7", "url": "https://github.com/elastic/elasticsearch/commit/eea17d421cdf20ae0a0f5ce7007edd830775e4c7", "message": "Changes", "committedDate": "2020-07-16T23:42:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQyNDA5MA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456424090", "bodyText": "Perhaps phrase this as saying that the lifetime of each stage encompasses the lifetimes of all subsequent stages, in order to power internal retries.", "author": "ywelsch", "createdAt": "2020-07-17T12:55:54Z", "path": "docs/reference/docs/data-replication.asciidoc", "diffHunk": "@@ -42,6 +45,14 @@ The primary shard follows this basic flow:\n . Once all replicas have successfully performed the operation and responded to the primary, the primary acknowledges the successful\n    completion of the request to the client.\n \n+Each in-sync replica copy performs the indexing operation locally so that it has a copy. This stage of indexing is the replication\n+stage.\n+\n+These indexing stages (coordinating, primary, and replication) are sequential. However, each upstream stage is inclusive of the", "originalCommit": "eea17d421cdf20ae0a0f5ce7007edd830775e4c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQyNDYxMg==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456424612", "bodyText": "explained", "author": "ywelsch", "createdAt": "2020-07-17T12:56:51Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,60 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing Pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing Stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replication. This write model is explain <<basic-write-model,here>>.", "originalCommit": "eea17d421cdf20ae0a0f5ce7007edd830775e4c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQyNTE1MA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456425150", "bodyText": "By default", "author": "ywelsch", "createdAt": "2020-07-17T12:57:59Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,60 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing Pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing Stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replication. This write model is explain <<basic-write-model,here>>.\n+\n+[float]\n+=== Memory Limits\n+\n+Elasticsearch exposes a node setting `indexing_pressure.memory.limit` which\n+restricts the number of bytes for outstanding indexing requests. Be default,", "originalCommit": "eea17d421cdf20ae0a0f5ce7007edd830775e4c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQyNjgyOA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456426828", "bodyText": "mention here as well that the reason for this is to power internal retries.", "author": "ywelsch", "createdAt": "2020-07-17T13:01:17Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,60 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing Pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing Stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replication. This write model is explain <<basic-write-model,here>>.\n+\n+[float]\n+=== Memory Limits\n+\n+Elasticsearch exposes a node setting `indexing_pressure.memory.limit` which\n+restricts the number of bytes for outstanding indexing requests. Be default,\n+this setting is configured to be 10% of the heap.\n+\n+At the beginning of each <<indexing stage,here>>, Elasticsearch accounts for the\n+bytes consumed by an indexing request. This accounting is only released at the\n+end of the indexing stage. This means that upstream stages will account for the\n+request overheard until all downstream stages are complete. For example, the\n+coordinating request will remain accounted for until primary and replication\n+stages are complete. The primary request will remain accounted for until the\n+replication stage is complete.", "originalCommit": "eea17d421cdf20ae0a0f5ce7007edd830775e4c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQyODg2NA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456428864", "bodyText": "I think that talking about \"replication stage\" is confusing (instead of replica stage). For me, the lifetime of replication starts when a primary completes the local indexing work, and completes when the primary has received an answer from all replicas, certainly not what's meant here.\nNote that replication stage is used  confusingly throughout this doc", "author": "ywelsch", "createdAt": "2020-07-17T13:05:03Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,60 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing Pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing Stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replication. This write model is explain <<basic-write-model,here>>.\n+\n+[float]\n+=== Memory Limits\n+\n+Elasticsearch exposes a node setting `indexing_pressure.memory.limit` which\n+restricts the number of bytes for outstanding indexing requests. Be default,\n+this setting is configured to be 10% of the heap.\n+\n+At the beginning of each <<indexing stage,here>>, Elasticsearch accounts for the\n+bytes consumed by an indexing request. This accounting is only released at the\n+end of the indexing stage. This means that upstream stages will account for the\n+request overheard until all downstream stages are complete. For example, the\n+coordinating request will remain accounted for until primary and replication", "originalCommit": "eea17d421cdf20ae0a0f5ce7007edd830775e4c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "73cf1a97769f17f56b296b97800b517049441ee2", "url": "https://github.com/elastic/elasticsearch/commit/73cf1a97769f17f56b296b97800b517049441ee2", "message": "Changes", "committedDate": "2020-07-17T19:31:08Z", "type": "commit"}, {"oid": "8dfba6636906772f1e249db6bfd718994ea19833", "url": "https://github.com/elastic/elasticsearch/commit/8dfba6636906772f1e249db6bfd718994ea19833", "message": "Changes", "committedDate": "2020-07-17T20:04:03Z", "type": "commit"}, {"oid": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "url": "https://github.com/elastic/elasticsearch/commit/7dffca48516341c9bbf8a459f1a00088e0b15e9f", "message": "Fix", "committedDate": "2020-07-17T20:46:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3MTY5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456671691", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Indexing pressure statistics about current and total indexing load and\n          \n          \n            \n                    indexing rejections.\n          \n          \n            \n                    Statistics about the node's indexing load and related rejections.", "author": "jrodewig", "createdAt": "2020-07-17T20:59:21Z", "path": "docs/reference/cluster/nodes-stats.asciidoc", "diffHunk": "@@ -58,6 +58,10 @@ using metrics.\n   `http`::\n       HTTP connection information.\n \n+  `indexing_pressure`::\n+        Indexing pressure statistics about current and total indexing load and\n+        indexing rejections.", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3MjE0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456672149", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Contains statistics for cumulative indexing load since the node started.\n          \n          \n            \n            Contains statistics for the cumulative indexing load since the node started.", "author": "jrodewig", "createdAt": "2020-07-17T21:00:16Z", "path": "docs/reference/cluster/nodes-stats.asciidoc", "diffHunk": "@@ -2099,6 +2103,62 @@ Number of failed operations for the processor.\n =======\n ======\n \n+[[cluster-nodes-stats-api-response-body-indexing-pressure]]\n+`indexing_pressure`::\n+(object)\n+Contains <<index-modules-indexing-pressure,indexing pressure>> statistics for the node.\n++\n+.Properties of `indexing_pressure`\n+[%collapsible%open]\n+======\n+`total`::\n+(object)\n+Contains statistics for cumulative indexing load since the node started.", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3MjQ0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456672443", "bodyText": "Are human readable versions of these stats available?", "author": "jrodewig", "createdAt": "2020-07-17T21:01:08Z", "path": "docs/reference/cluster/nodes-stats.asciidoc", "diffHunk": "@@ -2099,6 +2103,62 @@ Number of failed operations for the processor.\n =======\n ======\n \n+[[cluster-nodes-stats-api-response-body-indexing-pressure]]\n+`indexing_pressure`::\n+(object)\n+Contains <<index-modules-indexing-pressure,indexing pressure>> statistics for the node.\n++\n+.Properties of `indexing_pressure`\n+[%collapsible%open]\n+======\n+`total`::\n+(object)\n+Contains statistics for cumulative indexing load since the node started.\n++\n+.Properties of `<total>`\n+[%collapsible%open]\n+=======\n+`coordinating_and_primary_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the coordinating or primary stage.\n+\n+`replica_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the replica stage.\n+\n+`all_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the coordinating, primary, or replica stage.", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3ODQzOA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r457678438", "bodyText": "There is not. My understanding is that human readable versions is disabled by default. So I think we can add human readable interpretations in 7.10? @ywelsch I assume it is too late to make this change after feature freeze since it is kind of a feature?", "author": "tbrooks8", "createdAt": "2020-07-20T20:40:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3MjQ0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3MjYxNA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456672614", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Rejections of indexing requests in the coordinating or primary stage.\n          \n          \n            \n            Number of indexing requests rejected in the coordinating or primary stage.", "author": "jrodewig", "createdAt": "2020-07-17T21:01:34Z", "path": "docs/reference/cluster/nodes-stats.asciidoc", "diffHunk": "@@ -2099,6 +2103,62 @@ Number of failed operations for the processor.\n =======\n ======\n \n+[[cluster-nodes-stats-api-response-body-indexing-pressure]]\n+`indexing_pressure`::\n+(object)\n+Contains <<index-modules-indexing-pressure,indexing pressure>> statistics for the node.\n++\n+.Properties of `indexing_pressure`\n+[%collapsible%open]\n+======\n+`total`::\n+(object)\n+Contains statistics for cumulative indexing load since the node started.\n++\n+.Properties of `<total>`\n+[%collapsible%open]\n+=======\n+`coordinating_and_primary_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the coordinating or primary stage.\n+\n+`replica_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the replica stage.\n+\n+`all_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the coordinating, primary, or replica stage.\n+\n+`coordinating_and_primary_memory_limit_rejections`::\n+(integer)\n+Rejections of indexing requests in the coordinating or primary stage.", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3MjczNw==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456672737", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            `replica_memory_limit_rejections`::\n          \n          \n            \n            (integer)\n          \n          \n            \n            Rejections of indexing requests in the replica stage.\n          \n          \n            \n            `replica_memory_limit_rejections`::\n          \n          \n            \n            (integer)\n          \n          \n            \n            Number of indexing requests rejected in the replica stage.", "author": "jrodewig", "createdAt": "2020-07-17T21:01:56Z", "path": "docs/reference/cluster/nodes-stats.asciidoc", "diffHunk": "@@ -2099,6 +2103,62 @@ Number of failed operations for the processor.\n =======\n ======\n \n+[[cluster-nodes-stats-api-response-body-indexing-pressure]]\n+`indexing_pressure`::\n+(object)\n+Contains <<index-modules-indexing-pressure,indexing pressure>> statistics for the node.\n++\n+.Properties of `indexing_pressure`\n+[%collapsible%open]\n+======\n+`total`::\n+(object)\n+Contains statistics for cumulative indexing load since the node started.\n++\n+.Properties of `<total>`\n+[%collapsible%open]\n+=======\n+`coordinating_and_primary_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the coordinating or primary stage.\n+\n+`replica_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the replica stage.\n+\n+`all_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the coordinating, primary, or replica stage.\n+\n+`coordinating_and_primary_memory_limit_rejections`::\n+(integer)\n+Rejections of indexing requests in the coordinating or primary stage.\n+\n+`replica_memory_limit_rejections`::\n+(integer)\n+Rejections of indexing requests in the replica stage.", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3Mjk0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456672945", "bodyText": "Same question re: human readable stats", "author": "jrodewig", "createdAt": "2020-07-17T21:02:28Z", "path": "docs/reference/cluster/nodes-stats.asciidoc", "diffHunk": "@@ -2099,6 +2103,62 @@ Number of failed operations for the processor.\n =======\n ======\n \n+[[cluster-nodes-stats-api-response-body-indexing-pressure]]\n+`indexing_pressure`::\n+(object)\n+Contains <<index-modules-indexing-pressure,indexing pressure>> statistics for the node.\n++\n+.Properties of `indexing_pressure`\n+[%collapsible%open]\n+======\n+`total`::\n+(object)\n+Contains statistics for cumulative indexing load since the node started.\n++\n+.Properties of `<total>`\n+[%collapsible%open]\n+=======\n+`coordinating_and_primary_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the coordinating or primary stage.\n+\n+`replica_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the replica stage.\n+\n+`all_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the coordinating, primary, or replica stage.\n+\n+`coordinating_and_primary_memory_limit_rejections`::\n+(integer)\n+Rejections of indexing requests in the coordinating or primary stage.\n+\n+`replica_memory_limit_rejections`::\n+(integer)\n+Rejections of indexing requests in the replica stage.\n+=======\n+`current`::\n+(object)\n+Contains statistics for current indexing load.\n++\n+.Properties of `<current>`\n+[%collapsible%open]\n+=======\n+`coordinating_and_primary_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the coordinating or primary stage.\n+\n+`replica_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the replica stage.\n+\n+`all_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the coordinating, primary, or replica stage.", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3MzE4OA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456673188", "bodyText": "Nit: this is more aligned with our style. What you have works as-is tho.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            [float,id=\"basic-write-model\"]\n          \n          \n            \n            [discrete]\n          \n          \n            \n            [[basic-write-model]]", "author": "jrodewig", "createdAt": "2020-07-17T21:03:09Z", "path": "docs/reference/docs/data-replication.asciidoc", "diffHunk": "@@ -20,12 +20,15 @@ responsible for replicating the operation to the other copies.\n This purpose of this section is to give a high level overview of the Elasticsearch replication model and discuss the implications\n it has for various interactions between write and read operations.\n \n-[float]\n+[float,id=\"basic-write-model\"]", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3Mzc5MA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456673790", "bodyText": "We typically try to emphasize new terms when they're introduced.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            internally to the current _primary shard_ of the group. This stage of indexing is referred to as the coordinating\n          \n          \n            \n            stage.\n          \n          \n            \n            internally to the current _primary shard_ of the group. This stage of indexing is referred to as the _coordinating stage_.", "author": "jrodewig", "createdAt": "2020-07-17T21:04:45Z", "path": "docs/reference/docs/data-replication.asciidoc", "diffHunk": "@@ -20,12 +20,15 @@ responsible for replicating the operation to the other copies.\n This purpose of this section is to give a high level overview of the Elasticsearch replication model and discuss the implications\n it has for various interactions between write and read operations.\n \n-[float]\n+[float,id=\"basic-write-model\"]\n ==== Basic write model\n \n Every indexing operation in Elasticsearch is first resolved to a replication group using <<index-routing,routing>>,\n-typically based on the document ID. Once the replication group has been determined,\n-the operation is forwarded internally to the current _primary shard_ of the group. The primary shard is responsible\n+typically based on the document ID. Once the replication group has been determined, the operation is forwarded\n+internally to the current _primary shard_ of the group. This stage of indexing is referred to as the coordinating\n+stage.", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3NDMyNw==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456674327", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The next stage of indexing is the primary stage which is performed on the primary shard. The primary shard is responsible\n          \n          \n            \n            The next stage of indexing is the _primary stage_, performed on the primary shard. The primary shard is responsible", "author": "jrodewig", "createdAt": "2020-07-17T21:05:56Z", "path": "docs/reference/docs/data-replication.asciidoc", "diffHunk": "@@ -20,12 +20,15 @@ responsible for replicating the operation to the other copies.\n This purpose of this section is to give a high level overview of the Elasticsearch replication model and discuss the implications\n it has for various interactions between write and read operations.\n \n-[float]\n+[float,id=\"basic-write-model\"]\n ==== Basic write model\n \n Every indexing operation in Elasticsearch is first resolved to a replication group using <<index-routing,routing>>,\n-typically based on the document ID. Once the replication group has been determined,\n-the operation is forwarded internally to the current _primary shard_ of the group. The primary shard is responsible\n+typically based on the document ID. Once the replication group has been determined, the operation is forwarded\n+internally to the current _primary shard_ of the group. This stage of indexing is referred to as the coordinating\n+stage.\n+\n+The next stage of indexing is the primary stage which is performed on the primary shard. The primary shard is responsible", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3NDQ0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456674445", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Each in-sync replica copy performs the indexing operation locally so that it has a copy. This stage of indexing is the replication\n          \n          \n            \n            stage.\n          \n          \n            \n            Each in-sync replica copy performs the indexing operation locally so that it has a copy. This stage of indexing is the _replica\n          \n          \n            \n            stage_.", "author": "jrodewig", "createdAt": "2020-07-17T21:06:16Z", "path": "docs/reference/docs/data-replication.asciidoc", "diffHunk": "@@ -42,6 +45,14 @@ The primary shard follows this basic flow:\n . Once all replicas have successfully performed the operation and responded to the primary, the primary acknowledges the successful\n    completion of the request to the client.\n \n+Each in-sync replica copy performs the indexing operation locally so that it has a copy. This stage of indexing is the replication\n+stage.", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3NTA4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456675082", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            These indexing stages (coordinating, primary, and replica) are sequential. However, the lifetime of each stage encompasses\n          \n          \n            \n            the lifetimes of subsequent stages in order to enable internal retries. The coordinating stage is not complete until each primary\n          \n          \n            \n            These indexing stages (coordinating, primary, and replica) are sequential. To enable internal retries, the lifetime of each stage encompasses\n          \n          \n            \n            the lifetime of each subsequent stage. For example, the coordinating stage is not complete until each primary", "author": "jrodewig", "createdAt": "2020-07-17T21:07:56Z", "path": "docs/reference/docs/data-replication.asciidoc", "diffHunk": "@@ -42,6 +45,14 @@ The primary shard follows this basic flow:\n . Once all replicas have successfully performed the operation and responded to the primary, the primary acknowledges the successful\n    completion of the request to the client.\n \n+Each in-sync replica copy performs the indexing operation locally so that it has a copy. This stage of indexing is the replication\n+stage.\n+\n+These indexing stages (coordinating, primary, and replica) are sequential. However, the lifetime of each stage encompasses\n+the lifetimes of subsequent stages in order to enable internal retries. The coordinating stage is not complete until each primary", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3NTQyMg==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456675422", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            stage (which might be spread out across different primary shards) has completed. Each primary stage will not complete until the\n          \n          \n            \n            stage, which maybe spread out across different primary shard, has completed. Each primary stage will not complete until the", "author": "jrodewig", "createdAt": "2020-07-17T21:08:53Z", "path": "docs/reference/docs/data-replication.asciidoc", "diffHunk": "@@ -42,6 +45,14 @@ The primary shard follows this basic flow:\n . Once all replicas have successfully performed the operation and responded to the primary, the primary acknowledges the successful\n    completion of the request to the client.\n \n+Each in-sync replica copy performs the indexing operation locally so that it has a copy. This stage of indexing is the replication\n+stage.\n+\n+These indexing stages (coordinating, primary, and replica) are sequential. However, the lifetime of each stage encompasses\n+the lifetimes of subsequent stages in order to enable internal retries. The coordinating stage is not complete until each primary\n+stage (which might be spread out across different primary shards) has completed. Each primary stage will not complete until the", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3NTY0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456675647", "bodyText": "Just for word variety so we don't repeat \"complete\" twice in the same sentence.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            in-sync replicas have completed indexing the docs locally and responded to the replica requests.\n          \n          \n            \n            in-sync replicas have finished indexing the docs locally and responded to the replica requests.", "author": "jrodewig", "createdAt": "2020-07-17T21:09:30Z", "path": "docs/reference/docs/data-replication.asciidoc", "diffHunk": "@@ -42,6 +45,14 @@ The primary shard follows this basic flow:\n . Once all replicas have successfully performed the operation and responded to the primary, the primary acknowledges the successful\n    completion of the request to the client.\n \n+Each in-sync replica copy performs the indexing operation locally so that it has a copy. This stage of indexing is the replication\n+stage.\n+\n+These indexing stages (coordinating, primary, and replica) are sequential. However, the lifetime of each stage encompasses\n+the lifetimes of subsequent stages in order to enable internal retries. The coordinating stage is not complete until each primary\n+stage (which might be spread out across different primary shards) has completed. Each primary stage will not complete until the\n+in-sync replicas have completed indexing the docs locally and responded to the replica requests.", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3OTQ1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456679457", "bodyText": "I re-ordered this to try to improve the flow.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Indexing documents into Elasticsearch introduces system load in the form of\n          \n          \n            \n            memory and CPU load. Each indexing operation includes coordinating, primary, and\n          \n          \n            \n            replica stages. These stages can be performed across multiple nodes in the\n          \n          \n            \n            cluster. If too much indexing work is introduced into the system, the cluster\n          \n          \n            \n            can become saturated. This can adversely impact other components of the system\n          \n          \n            \n            such as searches, cluster coordination, background processing, etc.\n          \n          \n            \n            \n          \n          \n            \n            Indexing pressure is primarily generated by external operations such as indexing\n          \n          \n            \n            requests or internally by mechanisms such recoveries and cross-cluster\n          \n          \n            \n            replication.\n          \n          \n            \n            \n          \n          \n            \n            Elasticsearch internally monitors indexing load. When the load exceeds\n          \n          \n            \n            certain limits, new indexing work will be rejected.\n          \n          \n            \n            Indexing documents into {es} introduces system load in the form of memory and\n          \n          \n            \n            CPU load. Each indexing operation includes coordinating, primary, and replica\n          \n          \n            \n            stages. These stages can be performed across multiple nodes in a cluster.\n          \n          \n            \n            \n          \n          \n            \n            Indexing pressure can build up through external operations, such as indexing\n          \n          \n            \n            requests, or internal mechanisms, such as recoveries and {ccr}. If too much\n          \n          \n            \n            indexing work is introduced into the system, the cluster can become saturated.\n          \n          \n            \n            This can adversely impact other operations, such as search, cluster\n          \n          \n            \n            coordination, and background processing.\n          \n          \n            \n            \n          \n          \n            \n            To prevent these issues, {es} internally monitors indexing load. When the load\n          \n          \n            \n            exceeds certain limits, new indexing work is rejected.", "author": "jrodewig", "createdAt": "2020-07-17T21:20:10Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,70 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3OTY1OA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456679658", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            [float]\n          \n          \n            \n            === Indexing stages\n          \n          \n            \n            [discrete]\n          \n          \n            \n            [[indexing-stages]]\n          \n          \n            \n            === Indexing stages", "author": "jrodewig", "createdAt": "2020-07-17T21:20:40Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,70 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing stages", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY3OTg4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456679885", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            replica. This write model is explained <<basic-write-model,here>>.\n          \n          \n            \n            replica. See <<basic-write-model>>.", "author": "jrodewig", "createdAt": "2020-07-17T21:21:22Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,70 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replica. This write model is explained <<basic-write-model,here>>.", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY4MDAzMA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456680030", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            [float]\n          \n          \n            \n            === Memory limits\n          \n          \n            \n            [discrete]\n          \n          \n            \n            [[memory-limits]]\n          \n          \n            \n            === Memory limits", "author": "jrodewig", "createdAt": "2020-07-17T21:21:48Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,70 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replica. This write model is explained <<basic-write-model,here>>.\n+\n+[float]\n+=== Memory limits", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY4MDQxNw==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456680417", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Elasticsearch exposes a node setting `.memory.limitindexing_pressure` which\n          \n          \n            \n            restricts the number of bytes for outstanding indexing requests. By default,\n          \n          \n            \n            this setting is configured to be 10% of the heap.\n          \n          \n            \n            The `.memory.limitindexing_pressure` node setting\n          \n          \n            \n            restricts the number of bytes available for outstanding indexing requests.\n          \n          \n            \n            This setting defaults to 10% of the heap.", "author": "jrodewig", "createdAt": "2020-07-17T21:22:54Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,70 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replica. This write model is explained <<basic-write-model,here>>.\n+\n+[float]\n+=== Memory limits\n+\n+Elasticsearch exposes a node setting `.memory.limitindexing_pressure` which\n+restricts the number of bytes for outstanding indexing requests. By default,\n+this setting is configured to be 10% of the heap.", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY4MDUwMA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456680500", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            At the beginning of each indexing stage, Elasticsearch accounts for the\n          \n          \n            \n            At the beginning of each indexing stage, {es} accounts for the", "author": "jrodewig", "createdAt": "2020-07-17T21:23:11Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,70 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replica. This write model is explained <<basic-write-model,here>>.\n+\n+[float]\n+=== Memory limits\n+\n+Elasticsearch exposes a node setting `.memory.limitindexing_pressure` which\n+restricts the number of bytes for outstanding indexing requests. By default,\n+this setting is configured to be 10% of the heap.\n+\n+At the beginning of each indexing stage, Elasticsearch accounts for the", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY4MTE2OA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456681168", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            A node will start rejecting new indexing work at the coordinating or primary\n          \n          \n            \n            stage when the number of outstanding coordinating, primary, and replica indexing\n          \n          \n            \n            bytes are greater than the configured limit.\n          \n          \n            \n            A node will start rejecting new indexing work at the coordinating or primary\n          \n          \n            \n            stage when the number of outstanding coordinating, primary, and replica indexing\n          \n          \n            \n            bytes exceeds the configured limit.", "author": "jrodewig", "createdAt": "2020-07-17T21:25:09Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,70 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replica. This write model is explained <<basic-write-model,here>>.\n+\n+[float]\n+=== Memory limits\n+\n+Elasticsearch exposes a node setting `.memory.limitindexing_pressure` which\n+restricts the number of bytes for outstanding indexing requests. By default,\n+this setting is configured to be 10% of the heap.\n+\n+At the beginning of each indexing stage, Elasticsearch accounts for the\n+bytes consumed by an indexing request. This accounting is only released at the\n+end of the indexing stage. This means that upstream stages will account for the\n+request overheard until all downstream stages are complete. For example, the\n+coordinating request will remain accounted for until primary and replica\n+stages are complete. The primary request will remain accounted for until each\n+in-sync replica has responded to enable replica retries if necessary.\n+\n+A node will start rejecting new indexing work at the coordinating or primary\n+stage when the number of outstanding coordinating, primary, and replica indexing\n+bytes are greater than the configured limit.", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY4MTM0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456681341", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            number of outstanding replica indexing bytes are greater than 1.5x the\n          \n          \n            \n            number of outstanding replica indexing bytes exceeds 1.5x the", "author": "jrodewig", "createdAt": "2020-07-17T21:25:43Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,70 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replica. This write model is explained <<basic-write-model,here>>.\n+\n+[float]\n+=== Memory limits\n+\n+Elasticsearch exposes a node setting `.memory.limitindexing_pressure` which\n+restricts the number of bytes for outstanding indexing requests. By default,\n+this setting is configured to be 10% of the heap.\n+\n+At the beginning of each indexing stage, Elasticsearch accounts for the\n+bytes consumed by an indexing request. This accounting is only released at the\n+end of the indexing stage. This means that upstream stages will account for the\n+request overheard until all downstream stages are complete. For example, the\n+coordinating request will remain accounted for until primary and replica\n+stages are complete. The primary request will remain accounted for until each\n+in-sync replica has responded to enable replica retries if necessary.\n+\n+A node will start rejecting new indexing work at the coordinating or primary\n+stage when the number of outstanding coordinating, primary, and replica indexing\n+bytes are greater than the configured limit.\n+\n+A node will start rejecting new indexing work at the replica stage when the\n+number of outstanding replica indexing bytes are greater than 1.5x the", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY4MjA1OA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456682058", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The default limit `indexing_pressure.memory.limit` (10%) is generously sized and\n          \n          \n            \n            should only be modified after careful consideration. Only indexing requests\n          \n          \n            \n            contribute to this limit meaning that there is additional indexing overhead\n          \n          \n            \n            (buffers, listeners, etc) which also require heap space. Finally, other\n          \n          \n            \n            components of Elasticsearch also require memory. Configuring this limit to be\n          \n          \n            \n            too high can starve other system components of operating memory.\n          \n          \n            \n            The `indexing_pressure.memory.limit` setting's 10% default limit is generously sized. You\n          \n          \n            \n            should only change it after careful consideration. Only indexing requests\n          \n          \n            \n            contribute to this limit. This means there is additional indexing overhead\n          \n          \n            \n            (buffers, listeners, etc) which also require heap space. Other\n          \n          \n            \n            components of {es} also require memory. Setting this limit \n          \n          \n            \n            too high can deny operating memory to other operations and components.", "author": "jrodewig", "createdAt": "2020-07-17T21:28:10Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,70 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replica. This write model is explained <<basic-write-model,here>>.\n+\n+[float]\n+=== Memory limits\n+\n+Elasticsearch exposes a node setting `.memory.limitindexing_pressure` which\n+restricts the number of bytes for outstanding indexing requests. By default,\n+this setting is configured to be 10% of the heap.\n+\n+At the beginning of each indexing stage, Elasticsearch accounts for the\n+bytes consumed by an indexing request. This accounting is only released at the\n+end of the indexing stage. This means that upstream stages will account for the\n+request overheard until all downstream stages are complete. For example, the\n+coordinating request will remain accounted for until primary and replica\n+stages are complete. The primary request will remain accounted for until each\n+in-sync replica has responded to enable replica retries if necessary.\n+\n+A node will start rejecting new indexing work at the coordinating or primary\n+stage when the number of outstanding coordinating, primary, and replica indexing\n+bytes are greater than the configured limit.\n+\n+A node will start rejecting new indexing work at the replica stage when the\n+number of outstanding replica indexing bytes are greater than 1.5x the\n+configured limit. This design means that as indexing pressure builds on nodes,\n+they will naturally stop accepting coordinating and primary work in favor of\n+outstanding replica work.\n+\n+The default limit `indexing_pressure.memory.limit` (10%) is generously sized and\n+should only be modified after careful consideration. Only indexing requests\n+contribute to this limit meaning that there is additional indexing overhead\n+(buffers, listeners, etc) which also require heap space. Finally, other\n+components of Elasticsearch also require memory. Configuring this limit to be\n+too high can starve other system components of operating memory.", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY4MjI1MA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456682250", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            [float]\n          \n          \n            \n            === Monitoring\n          \n          \n            \n            [discrete]\n          \n          \n            \n            [[indexing-pressure-monitoring]]\n          \n          \n            \n            === Monitoring", "author": "jrodewig", "createdAt": "2020-07-17T21:28:46Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,70 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replica. This write model is explained <<basic-write-model,here>>.\n+\n+[float]\n+=== Memory limits\n+\n+Elasticsearch exposes a node setting `.memory.limitindexing_pressure` which\n+restricts the number of bytes for outstanding indexing requests. By default,\n+this setting is configured to be 10% of the heap.\n+\n+At the beginning of each indexing stage, Elasticsearch accounts for the\n+bytes consumed by an indexing request. This accounting is only released at the\n+end of the indexing stage. This means that upstream stages will account for the\n+request overheard until all downstream stages are complete. For example, the\n+coordinating request will remain accounted for until primary and replica\n+stages are complete. The primary request will remain accounted for until each\n+in-sync replica has responded to enable replica retries if necessary.\n+\n+A node will start rejecting new indexing work at the coordinating or primary\n+stage when the number of outstanding coordinating, primary, and replica indexing\n+bytes are greater than the configured limit.\n+\n+A node will start rejecting new indexing work at the replica stage when the\n+number of outstanding replica indexing bytes are greater than 1.5x the\n+configured limit. This design means that as indexing pressure builds on nodes,\n+they will naturally stop accepting coordinating and primary work in favor of\n+outstanding replica work.\n+\n+The default limit `indexing_pressure.memory.limit` (10%) is generously sized and\n+should only be modified after careful consideration. Only indexing requests\n+contribute to this limit meaning that there is additional indexing overhead\n+(buffers, listeners, etc) which also require heap space. Finally, other\n+components of Elasticsearch also require memory. Configuring this limit to be\n+too high can starve other system components of operating memory.\n+\n+[float]\n+=== Monitoring", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY4MjQ2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456682463", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Indexing pressure metrics are exposed by the\n          \n          \n            \n            <<cluster-nodes-stats-api-response-body-indexing-pressure,Node Stats API>>.\n          \n          \n            \n            You can use the <<cluster-nodes-stats-api-response-body-indexing-pressure,node stats API>> to retrieve indexing pressure metrics.", "author": "jrodewig", "createdAt": "2020-07-17T21:29:31Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,70 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replica. This write model is explained <<basic-write-model,here>>.\n+\n+[float]\n+=== Memory limits\n+\n+Elasticsearch exposes a node setting `.memory.limitindexing_pressure` which\n+restricts the number of bytes for outstanding indexing requests. By default,\n+this setting is configured to be 10% of the heap.\n+\n+At the beginning of each indexing stage, Elasticsearch accounts for the\n+bytes consumed by an indexing request. This accounting is only released at the\n+end of the indexing stage. This means that upstream stages will account for the\n+request overheard until all downstream stages are complete. For example, the\n+coordinating request will remain accounted for until primary and replica\n+stages are complete. The primary request will remain accounted for until each\n+in-sync replica has responded to enable replica retries if necessary.\n+\n+A node will start rejecting new indexing work at the coordinating or primary\n+stage when the number of outstanding coordinating, primary, and replica indexing\n+bytes are greater than the configured limit.\n+\n+A node will start rejecting new indexing work at the replica stage when the\n+number of outstanding replica indexing bytes are greater than 1.5x the\n+configured limit. This design means that as indexing pressure builds on nodes,\n+they will naturally stop accepting coordinating and primary work in favor of\n+outstanding replica work.\n+\n+The default limit `indexing_pressure.memory.limit` (10%) is generously sized and\n+should only be modified after careful consideration. Only indexing requests\n+contribute to this limit meaning that there is additional indexing overhead\n+(buffers, listeners, etc) which also require heap space. Finally, other\n+components of Elasticsearch also require memory. Configuring this limit to be\n+too high can starve other system components of operating memory.\n+\n+[float]\n+=== Monitoring\n+\n+Indexing pressure metrics are exposed by the\n+<<cluster-nodes-stats-api-response-body-indexing-pressure,Node Stats API>>.", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY4MjYyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456682625", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            [float]\n          \n          \n            \n            === Indexing pressure settings\n          \n          \n            \n            [discrete]\n          \n          \n            \n            [[indexing-pressure-settings]]\n          \n          \n            \n            === Indexing pressure settings", "author": "jrodewig", "createdAt": "2020-07-17T21:30:06Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,70 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replica. This write model is explained <<basic-write-model,here>>.\n+\n+[float]\n+=== Memory limits\n+\n+Elasticsearch exposes a node setting `.memory.limitindexing_pressure` which\n+restricts the number of bytes for outstanding indexing requests. By default,\n+this setting is configured to be 10% of the heap.\n+\n+At the beginning of each indexing stage, Elasticsearch accounts for the\n+bytes consumed by an indexing request. This accounting is only released at the\n+end of the indexing stage. This means that upstream stages will account for the\n+request overheard until all downstream stages are complete. For example, the\n+coordinating request will remain accounted for until primary and replica\n+stages are complete. The primary request will remain accounted for until each\n+in-sync replica has responded to enable replica retries if necessary.\n+\n+A node will start rejecting new indexing work at the coordinating or primary\n+stage when the number of outstanding coordinating, primary, and replica indexing\n+bytes are greater than the configured limit.\n+\n+A node will start rejecting new indexing work at the replica stage when the\n+number of outstanding replica indexing bytes are greater than 1.5x the\n+configured limit. This design means that as indexing pressure builds on nodes,\n+they will naturally stop accepting coordinating and primary work in favor of\n+outstanding replica work.\n+\n+The default limit `indexing_pressure.memory.limit` (10%) is generously sized and\n+should only be modified after careful consideration. Only indexing requests\n+contribute to this limit meaning that there is additional indexing overhead\n+(buffers, listeners, etc) which also require heap space. Finally, other\n+components of Elasticsearch also require memory. Configuring this limit to be\n+too high can starve other system components of operating memory.\n+\n+[float]\n+=== Monitoring\n+\n+Indexing pressure metrics are exposed by the\n+<<cluster-nodes-stats-api-response-body-indexing-pressure,Node Stats API>>.\n+\n+[float]\n+=== Indexing pressure settings", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY4MzU0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r456683545", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              A configurable limit for the number of outstanding bytes consumed by indexing\n          \n          \n            \n              requests. New coordinating and primary operations will start being rejected\n          \n          \n            \n              once this limit is hit. New replica operations will start being rejected when\n          \n          \n            \n              replica operations consumed 1.5X this limit. Defaults to `10%` of the heap.\n          \n          \n            \n            (integer)\n          \n          \n            \n             Number of outstanding bytes that may be consumed by indexing requests. When\n          \n          \n            \n             this limit is reached or exceeded, the node will reject new coordinating and\n          \n          \n            \n             primary operations. When replica operations consume 1.5x this limit, the node\n          \n          \n            \n             will reject new replica operations. Defaults to 10% of the heap.", "author": "jrodewig", "createdAt": "2020-07-17T21:33:06Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,70 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[float]\n+=== Indexing stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replica. This write model is explained <<basic-write-model,here>>.\n+\n+[float]\n+=== Memory limits\n+\n+Elasticsearch exposes a node setting `.memory.limitindexing_pressure` which\n+restricts the number of bytes for outstanding indexing requests. By default,\n+this setting is configured to be 10% of the heap.\n+\n+At the beginning of each indexing stage, Elasticsearch accounts for the\n+bytes consumed by an indexing request. This accounting is only released at the\n+end of the indexing stage. This means that upstream stages will account for the\n+request overheard until all downstream stages are complete. For example, the\n+coordinating request will remain accounted for until primary and replica\n+stages are complete. The primary request will remain accounted for until each\n+in-sync replica has responded to enable replica retries if necessary.\n+\n+A node will start rejecting new indexing work at the coordinating or primary\n+stage when the number of outstanding coordinating, primary, and replica indexing\n+bytes are greater than the configured limit.\n+\n+A node will start rejecting new indexing work at the replica stage when the\n+number of outstanding replica indexing bytes are greater than 1.5x the\n+configured limit. This design means that as indexing pressure builds on nodes,\n+they will naturally stop accepting coordinating and primary work in favor of\n+outstanding replica work.\n+\n+The default limit `indexing_pressure.memory.limit` (10%) is generously sized and\n+should only be modified after careful consideration. Only indexing requests\n+contribute to this limit meaning that there is additional indexing overhead\n+(buffers, listeners, etc) which also require heap space. Finally, other\n+components of Elasticsearch also require memory. Configuring this limit to be\n+too high can starve other system components of operating memory.\n+\n+[float]\n+=== Monitoring\n+\n+Indexing pressure metrics are exposed by the\n+<<cluster-nodes-stats-api-response-body-indexing-pressure,Node Stats API>>.\n+\n+[float]\n+=== Indexing pressure settings\n+\n+`indexing_pressure`::\n+\n+  A configurable limit for the number of outstanding bytes consumed by indexing\n+  requests. New coordinating and primary operations will start being rejected\n+  once this limit is hit. New replica operations will start being rejected when\n+  replica operations consumed 1.5X this limit. Defaults to `10%` of the heap.", "originalCommit": "7dffca48516341c9bbf8a459f1a00088e0b15e9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "55d2d5e95bf79262d9554766ea62a37961d549f1", "url": "https://github.com/elastic/elasticsearch/commit/55d2d5e95bf79262d9554766ea62a37961d549f1", "message": "WIP", "committedDate": "2020-07-17T22:55:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE2NTEzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r457165131", "bodyText": "if the primary \"stage\" is executed locally", "author": "ywelsch", "createdAt": "2020-07-20T08:19:12Z", "path": "docs/reference/cluster/nodes-stats.asciidoc", "diffHunk": "@@ -2099,6 +2102,82 @@ Number of failed operations for the processor.\n =======\n ======\n \n+[[cluster-nodes-stats-api-response-body-indexing-pressure]]\n+`indexing_pressure`::\n+(object)\n+Contains <<index-modules-indexing-pressure,indexing pressure>> statistics for the node.\n++\n+.Properties of `indexing_pressure`\n+[%collapsible%open]\n+======\n+`total`::\n+(object)\n+Contains statistics for the cumulative indexing load since the node started.\n++\n+.Properties of `<total>`\n+[%collapsible%open]\n+=======\n+`combined_coordinating_and_primary_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the coordinating or primary stage. This\n+value is not the sum of coordinating_bytes and primary_bytes as a node can reuse\n+the coordinating bytes if the primary is executed locally.\n+\n+`coordinating_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the coordinating stage.\n+\n+`primary_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the primary stage.\n+\n+`all_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the coordinating, primary, or replica stage.\n+\n+`coordinating_rejections`::\n+(integer)\n+Number of indexing requests rejected in the coordinating stage.\n+\n+`primary_rejections`::\n+(integer)\n+Number of indexing requests rejected in the primary stage.\n+\n+`replica_rejections`::\n+(integer)\n+Number of indexing requests rejected in the replica stage.\n+=======\n+`current`::\n+(object)\n+Contains statistics for current indexing load.\n++\n+.Properties of `<current>`\n+[%collapsible%open]\n+=======\n+`combined_coordinating_and_primary_bytes`::\n+(integer)\n+Bytes consumed by indexing requests in the coordinating or primary stage. This\n+value is not the sum of coordinating_bytes and primary_bytes as a node can reuse\n+the coordinating bytes if the primary is executed locally.", "originalCommit": "55d2d5e95bf79262d9554766ea62a37961d549f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE2NzM1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r457167353", "bodyText": "does this link need fixing?  (<>)", "author": "ywelsch", "createdAt": "2020-07-20T08:22:11Z", "path": "docs/reference/index-modules/indexing-pressure.asciidoc", "diffHunk": "@@ -0,0 +1,75 @@\n+[[index-modules-indexing-pressure]]\n+== Indexing pressure\n+\n+Indexing documents into Elasticsearch introduces system load in the form of\n+memory and CPU load. Each indexing operation includes coordinating, primary, and\n+replica stages. These stages can be performed across multiple nodes in the\n+cluster. If too much indexing work is introduced into the system, the cluster\n+can become saturated. This can adversely impact other components of the system\n+such as searches, cluster coordination, background processing, etc.\n+\n+Indexing pressure is primarily generated by external operations such as indexing\n+requests or internally by mechanisms such recoveries and cross-cluster\n+replication.\n+\n+Elasticsearch internally monitors indexing load. When the load exceeds\n+certain limits, new indexing work will be rejected.\n+\n+[discrete]\n+[[indexing-stages]]\n+=== Indexing stages\n+\n+External indexing operations go through three stages: coordinating, primary, and\n+replica. See <<basic-write-model,here>>.", "originalCommit": "55d2d5e95bf79262d9554766ea62a37961d549f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM0MDQ3NA==", "url": "https://github.com/elastic/elasticsearch/pull/59456#discussion_r457340474", "bodyText": "I'd remove the here text:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            replica. See <<basic-write-model,here>>.\n          \n          \n            \n            replica. See <<basic-write-model>>.", "author": "jrodewig", "createdAt": "2020-07-20T12:33:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzE2NzM1Mw=="}], "type": "inlineReview"}, {"oid": "0daf58f57ba594a815771e362d7001b50e0152dd", "url": "https://github.com/elastic/elasticsearch/commit/0daf58f57ba594a815771e362d7001b50e0152dd", "message": "Changes", "committedDate": "2020-07-20T20:45:01Z", "type": "commit"}, {"oid": "692053a7e6a1edbcd7a5fb4c7add39b7f965ad51", "url": "https://github.com/elastic/elasticsearch/commit/692053a7e6a1edbcd7a5fb4c7add39b7f965ad51", "message": "Changes", "committedDate": "2020-07-20T22:48:00Z", "type": "commit"}]}