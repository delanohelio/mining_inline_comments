{"pr_number": 55598, "pr_title": "Make AsyncSearchIndexService reusable", "pr_createdAt": "2020-04-22T15:10:31Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55598", "timeline": [{"oid": "deaeae1a5a0aef218a019f956ee4682c7de955b9", "url": "https://github.com/elastic/elasticsearch/commit/deaeae1a5a0aef218a019f956ee4682c7de955b9", "message": "Make AsyncSearchIndexService reusable\n\nEQL will require very similar functionality to async search. This PR refactors\nAsyncSearchIndexService to make it reusable for EQL.\n\nSupersedes #55119\nRelates to #49638", "committedDate": "2020-04-22T15:06:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI2MDQyNg==", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413260426", "bodyText": "will expire? Can you add javadocs at the class level too?", "author": "javanna", "createdAt": "2020-04-22T19:30:06Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncResponse.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.async;\n+\n+import org.elasticsearch.common.io.stream.Writeable;\n+\n+public interface AsyncResponse extends Writeable {\n+    /**\n+     * When this response will expired as a timestamp in milliseconds since epoch.", "originalCommit": "deaeae1a5a0aef218a019f956ee4682c7de955b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI2MzYwOA==", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413263608", "bodyText": "given that it's not part of the interface, maybe storing results should not be mentioned?", "author": "javanna", "createdAt": "2020-04-22T19:33:50Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncTask.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.async;\n+\n+import java.util.Map;\n+\n+/**\n+ * A task that supports asynchronous execution and safe temporary storage of results", "originalCommit": "deaeae1a5a0aef218a019f956ee4682c7de955b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI2Nzg4NA==", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413267884", "bodyText": "does this need to be abstract and do we really need two implementers for it? Could we rather make it final and have two different instances of this same class, with a different underlying index service?", "author": "javanna", "createdAt": "2020-04-22T19:38:24Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncTaskMaintenanceService.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.async;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.cluster.ClusterChangedEvent;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.ClusterStateListener;\n+import org.elasticsearch.cluster.routing.IndexRoutingTable;\n+import org.elasticsearch.common.lease.Releasable;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.common.util.concurrent.EsRejectedExecutionException;\n+import org.elasticsearch.gateway.GatewayService;\n+import org.elasticsearch.index.query.QueryBuilders;\n+import org.elasticsearch.index.reindex.DeleteByQueryAction;\n+import org.elasticsearch.index.reindex.DeleteByQueryRequest;\n+import org.elasticsearch.threadpool.Scheduler;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import static org.elasticsearch.xpack.core.async.AsyncTaskIndexService.EXPIRATION_TIME_FIELD;\n+\n+/**\n+ * A service that runs a periodic cleanup over the async execution index.\n+ */\n+public abstract class AsyncTaskMaintenanceService implements Releasable, ClusterStateListener {", "originalCommit": "deaeae1a5a0aef218a019f956ee4682c7de955b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyNDg0NA==", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413824844", "bodyText": "Good catch. The reason I had to make it abstract is we inject objects of this class into Transports. So, we need to way to distinguish between EQL service and async search service. I could have used @ Named annotation, but we don't support that anymore in createComponents. I will leave a clarifying comment on this class.", "author": "imotov", "createdAt": "2020-04-23T14:06:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI2Nzg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI3Mjc4OA==", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413272788", "bodyText": "shall we make this final?", "author": "javanna", "createdAt": "2020-04-22T19:46:19Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncTaskIndexService.java", "diffHunk": "@@ -50,16 +51,13 @@\n \n import static org.elasticsearch.common.xcontent.XContentFactory.jsonBuilder;\n import static org.elasticsearch.index.mapper.MapperService.SINGLE_MAPPING_NAME;\n-import static org.elasticsearch.xpack.core.ClientHelper.ASYNC_SEARCH_ORIGIN;\n import static org.elasticsearch.xpack.core.security.authc.AuthenticationField.AUTHENTICATION_KEY;\n \n /**\n- * A service that exposes the CRUD operations for the async-search index.\n+ * A service that exposes the CRUD operations for the async task-specific index.\n  */\n-class AsyncSearchIndexService {\n-    private static final Logger logger = LogManager.getLogger(AsyncSearchIndexService.class);\n-\n-    public static final String INDEX = \".async-search\";\n+public class AsyncTaskIndexService<R extends AsyncResponse> {", "originalCommit": "deaeae1a5a0aef218a019f956ee4682c7de955b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI3MzAwNw==", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413273007", "bodyText": "make it final?", "author": "javanna", "createdAt": "2020-04-22T19:46:36Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncExecutionId.java", "diffHunk": "@@ -17,14 +17,14 @@\n import java.util.Objects;\n \n /**\n- * A class that contains all information related to a submitted async search.\n+ * A class that contains all information related to a submitted async execution.\n  */\n-class AsyncSearchId {\n+public class AsyncExecutionId {", "originalCommit": "deaeae1a5a0aef218a019f956ee4682c7de955b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI3NjczNw==", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413276737", "bodyText": "should it be the index service that provides that index name rather than having to provide it to both?", "author": "javanna", "createdAt": "2020-04-22T19:50:39Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncTaskMaintenanceService.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.async;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.cluster.ClusterChangedEvent;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.ClusterStateListener;\n+import org.elasticsearch.cluster.routing.IndexRoutingTable;\n+import org.elasticsearch.common.lease.Releasable;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.common.util.concurrent.EsRejectedExecutionException;\n+import org.elasticsearch.gateway.GatewayService;\n+import org.elasticsearch.index.query.QueryBuilders;\n+import org.elasticsearch.index.reindex.DeleteByQueryAction;\n+import org.elasticsearch.index.reindex.DeleteByQueryRequest;\n+import org.elasticsearch.threadpool.Scheduler;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import static org.elasticsearch.xpack.core.async.AsyncTaskIndexService.EXPIRATION_TIME_FIELD;\n+\n+/**\n+ * A service that runs a periodic cleanup over the async execution index.\n+ */\n+public abstract class AsyncTaskMaintenanceService implements Releasable, ClusterStateListener {\n+    private static final Logger logger = LogManager.getLogger(AsyncTaskMaintenanceService.class);\n+\n+    private final String index;\n+    private final String localNodeId;\n+    private final ThreadPool threadPool;\n+    private final AsyncTaskIndexService<?> indexService;\n+    private final TimeValue delay;\n+\n+    private boolean isCleanupRunning;\n+    private final AtomicBoolean isClosed = new AtomicBoolean(false);\n+    private volatile Scheduler.Cancellable cancellable;\n+\n+    public AsyncTaskMaintenanceService(String index,", "originalCommit": "deaeae1a5a0aef218a019f956ee4682c7de955b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI4MjkwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413282905", "bodyText": "funny that this is what Jim had in his original PR and I made him change the constructor to accept an additional expiration time.", "author": "javanna", "createdAt": "2020-04-22T19:56:31Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncTaskIndexService.java", "diffHunk": "@@ -273,7 +279,8 @@ void getResponse(AsyncSearchId searchId,\n \n                 long expirationTime = (long) get.getSource().get(EXPIRATION_TIME_FIELD);\n                 String encoded = (String) get.getSource().get(RESULT_FIELD);\n-                AsyncSearchResponse response = decodeResponse(encoded, expirationTime);\n+                R response = decodeResponse(encoded);\n+                response.setExpirationTime(expirationTime);", "originalCommit": "deaeae1a5a0aef218a019f956ee4682c7de955b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyNDk2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413824963", "bodyText": "It makes sense now. I was wondering why expirationTime was made not-final. I think I have a cleaner way of dealing with it. I also fixed a bug here that sneaked in during last update.", "author": "imotov", "createdAt": "2020-04-23T14:06:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI4MjkwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM4MzUyMA==", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r414383520", "bodyText": "For the record, I personally find the argument constructor cleaner, but because we need to provide a Reader when we pass around the response, it does become cleaner to make the field non-final and set it after creation. What bug do you mean, I may have missed it but you mean it sneaked in as part of this PR?", "author": "javanna", "createdAt": "2020-04-24T08:13:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI4MjkwNQ=="}], "type": "inlineReview"}, {"oid": "b803e0ef9340560b5acd216b87d82af40218049b", "url": "https://github.com/elastic/elasticsearch/commit/b803e0ef9340560b5acd216b87d82af40218049b", "message": "Address review comments", "committedDate": "2020-04-23T13:52:34Z", "type": "commit"}, {"oid": "059e7a784ce5933c5cbf808034ddb43d3966b3df", "url": "https://github.com/elastic/elasticsearch/commit/059e7a784ce5933c5cbf808034ddb43d3966b3df", "message": "Merge remote-tracking branch 'elastic/master' into make-async-index-service-reusable-again", "committedDate": "2020-04-23T13:53:19Z", "type": "commit"}]}