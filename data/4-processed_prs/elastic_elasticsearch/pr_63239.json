{"pr_number": 63239, "pr_title": "Replace some usages of QueryShardContext#getMapperService", "pr_createdAt": "2020-10-05T12:48:56Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63239", "timeline": [{"oid": "687ddb33f83d976e411f21240adf72ce79ada762", "url": "https://github.com/elastic/elasticsearch/commit/687ddb33f83d976e411f21240adf72ce79ada762", "message": "Replace some usages of QueryShardContext#getMapperService\n\nQueryShardContext a getter that allows to have access to the MapperService. In many cases, it is misused to lookup field types which QueryShardContext has a specific method for. This commit replaces those usages with a function String -> MappedFieldType .", "committedDate": "2020-10-05T12:47:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4OTUyNg==", "url": "https://github.com/elastic/elasticsearch/pull/63239#discussion_r499589526", "bodyText": "Maybe we should rename this fieldType rather than fieldMapper?", "author": "romseygeek", "createdAt": "2020-10-05T13:15:57Z", "path": "server/src/main/java/org/elasticsearch/index/query/functionscore/FieldValueFactorFunctionBuilder.java", "diffHunk": "@@ -144,7 +144,7 @@ protected int doHashCode() {\n \n     @Override\n     protected ScoreFunction doToFunction(QueryShardContext context) {\n-        MappedFieldType fieldType = context.getMapperService().fieldType(field);\n+        MappedFieldType fieldType = context.fieldMapper(field);", "originalCommit": "687ddb33f83d976e411f21240adf72ce79ada762", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU5OTgyNg==", "url": "https://github.com/elastic/elasticsearch/pull/63239#discussion_r499599826", "bodyText": "yes indeed, I planned to do it as a follow-up", "author": "javanna", "createdAt": "2020-10-05T13:30:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4OTUyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4OTU5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63239#discussion_r499589592", "bodyText": "I do wonder if we can remove this step entirely, or replace it with the ValueFetcher functionality somehow - for a followup though.", "author": "romseygeek", "createdAt": "2020-10-05T13:16:04Z", "path": "server/src/main/java/org/elasticsearch/index/fieldvisitor/FieldsVisitor.java", "diffHunk": "@@ -87,9 +87,9 @@ public Status needsField(FieldInfo fieldInfo) {\n                 : Status.NO;\n     }\n \n-    public void postProcess(MapperService mapperService) {\n+    public final void postProcess(Function<String, MappedFieldType> fieldTypeLookup) {", "originalCommit": "687ddb33f83d976e411f21240adf72ce79ada762", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU5MjQ5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63239#discussion_r499592497", "bodyText": "So this doesn't do anything to the _id, _source or _routing fields, so I think we can remove the call to it entirely from LuceneChangesSnapshot and possibly a few other places as well.", "author": "romseygeek", "createdAt": "2020-10-05T13:20:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4OTU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYwMDUxOA==", "url": "https://github.com/elastic/elasticsearch/pull/63239#discussion_r499600518", "bodyText": "ok I will look at it, possibly make this change in a separate PR then.", "author": "javanna", "createdAt": "2020-10-05T13:31:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4OTU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY3MjM1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63239#discussion_r499672351", "bodyText": "++", "author": "romseygeek", "createdAt": "2020-10-05T15:10:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4OTU5Mg=="}], "type": "inlineReview"}, {"oid": "fb8b9dadcb7f917006a7b30465875e38c5e7203e", "url": "https://github.com/elastic/elasticsearch/commit/fb8b9dadcb7f917006a7b30465875e38c5e7203e", "message": "iter", "committedDate": "2020-10-05T13:57:04Z", "type": "commit"}, {"oid": "8aee74d6bbdbf612921820bc90e52e2221b80016", "url": "https://github.com/elastic/elasticsearch/commit/8aee74d6bbdbf612921820bc90e52e2221b80016", "message": "iter", "committedDate": "2020-10-05T14:33:07Z", "type": "commit"}, {"oid": "ac58f01e2bf5caf0a5cb98a112a95276ca1f26af", "url": "https://github.com/elastic/elasticsearch/commit/ac58f01e2bf5caf0a5cb98a112a95276ca1f26af", "message": "mapper service may be null for closed indices", "committedDate": "2020-10-05T14:44:42Z", "type": "commit"}]}