{"pr_number": 57277, "pr_title": "Save memory when histogram agg is not on top", "pr_createdAt": "2020-05-28T12:27:38Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57277", "timeline": [{"oid": "0889efb9eba352d23a418f78f8731c4d38b42456", "url": "https://github.com/elastic/elasticsearch/commit/0889efb9eba352d23a418f78f8731c4d38b42456", "message": "Save memory when histogram agg is not on top\n\nThis saves some memory when the `histogram` aggregation is not a top\nlevel aggregation by dropping `asMultiBucketAggregator` in favor of\nnatively implementing multi-bucket storage in the aggregator. For the\nmost part this just uses the `LongKeyedBucketOrds` that we built the\nfirst time we did this.", "committedDate": "2020-05-28T12:25:05Z", "type": "commit"}, {"oid": "c50277985093c12914ffec06878aa26b43d0012e", "url": "https://github.com/elastic/elasticsearch/commit/c50277985093c12914ffec06878aa26b43d0012e", "message": "Test", "committedDate": "2020-05-28T13:03:01Z", "type": "commit"}, {"oid": "8898048e039d5cfee5abc1bde2ca90a4b278d12a", "url": "https://github.com/elastic/elasticsearch/commit/8898048e039d5cfee5abc1bde2ca90a4b278d12a", "message": "explain", "committedDate": "2020-05-28T13:07:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxNzgyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/57277#discussion_r431817825", "bodyText": "There was a TODO that the range and numeric version of the aggregator shared a ton of code. Now they share a superclass that provides all that code.", "author": "nik9000", "createdAt": "2020-05-28T13:03:44Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/AbstractHistogramAggregator.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.search.aggregations.bucket.histogram;\n+\n+import org.apache.lucene.util.CollectionUtil;\n+import org.elasticsearch.common.lease.Releasables;\n+import org.elasticsearch.search.DocValueFormat;\n+import org.elasticsearch.search.aggregations.Aggregator;\n+import org.elasticsearch.search.aggregations.AggregatorFactories;\n+import org.elasticsearch.search.aggregations.BucketOrder;\n+import org.elasticsearch.search.aggregations.InternalAggregation;\n+import org.elasticsearch.search.aggregations.bucket.BucketsAggregator;\n+import org.elasticsearch.search.aggregations.bucket.histogram.InternalHistogram.EmptyBucketInfo;\n+import org.elasticsearch.search.aggregations.bucket.terms.LongKeyedBucketOrds;\n+import org.elasticsearch.search.internal.SearchContext;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+\n+/**\n+ * Base class for functionality shared between aggregators for this\n+ * {@code histogram} aggregation.\n+ */\n+public abstract class AbstractHistogramAggregator extends BucketsAggregator {", "originalCommit": "0889efb9eba352d23a418f78f8731c4d38b42456", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxODA4NA==", "url": "https://github.com/elastic/elasticsearch/pull/57277#discussion_r431818084", "bodyText": "I moved this check into the ctor so I can use the ctor reference that we've been doing elsewhere.", "author": "nik9000", "createdAt": "2020-05-28T13:04:11Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/HistogramAggregatorFactory.java", "diffHunk": "@@ -52,36 +51,11 @@\n \n     static void registerAggregators(ValuesSourceRegistry.Builder builder) {\n         builder.register(HistogramAggregationBuilder.NAME, CoreValuesSourceType.RANGE,\n-            new HistogramAggregatorSupplier() {\n-                @Override\n-                public Aggregator build(String name, AggregatorFactories factories, double interval, double offset,\n-                                        BucketOrder order, boolean keyed, long minDocCount, double minBound, double maxBound,\n-                                        ValuesSource valuesSource, DocValueFormat formatter, SearchContext context,\n-                                        Aggregator parent, Map<String, Object> metadata) throws IOException {\n-                    ValuesSource.Range rangeValueSource = (ValuesSource.Range) valuesSource;\n-                    if (rangeValueSource.rangeType().isNumeric() == false) {", "originalCommit": "0889efb9eba352d23a418f78f8731c4d38b42456", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxODIyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/57277#discussion_r431818225", "bodyText": "this is the important line!", "author": "nik9000", "createdAt": "2020-05-28T13:04:24Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/HistogramAggregatorFactory.java", "diffHunk": "@@ -117,10 +91,6 @@ protected Aggregator doCreateInternal(ValuesSource valuesSource,\n                                             Aggregator parent,\n                                             boolean collectsFromSingleBucket,\n                                             Map<String, Object> metadata) throws IOException {\n-        if (collectsFromSingleBucket == false) {", "originalCommit": "0889efb9eba352d23a418f78f8731c4d38b42456", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxODgwMg==", "url": "https://github.com/elastic/elasticsearch/pull/57277#discussion_r431818802", "bodyText": "We do this kind of thing all over the place so I figured I'd make a utility method for it.", "author": "nik9000", "createdAt": "2020-05-28T13:05:18Z", "path": "server/src/test/java/org/elasticsearch/search/aggregations/bucket/histogram/NumericHistogramAggregatorTests.java", "diffHunk": "@@ -55,11 +64,9 @@ public void testLongs() throws Exception {\n             HistogramAggregationBuilder aggBuilder = new HistogramAggregationBuilder(\"my_agg\")\n                     .field(\"field\")\n                     .interval(5);\n-            MappedFieldType fieldType = new NumberFieldMapper.NumberFieldType(NumberFieldMapper.NumberType.LONG);\n-            fieldType.setName(\"field\");\n             try (IndexReader reader = w.getReader()) {\n                 IndexSearcher searcher = new IndexSearcher(reader);\n-                InternalHistogram histogram = search(searcher, new MatchAllDocsQuery(), aggBuilder, fieldType);", "originalCommit": "0889efb9eba352d23a418f78f8731c4d38b42456", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1efc38444e19a6f9adcac002055feb3f178ca252", "url": "https://github.com/elastic/elasticsearch/commit/1efc38444e19a6f9adcac002055feb3f178ca252", "message": "Merge branch 'master' into histo_no_multi", "committedDate": "2020-05-28T17:52:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyNzM3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/57277#discussion_r432127372", "bodyText": "nice touch. likely usable across many future tests", "author": "talevy", "createdAt": "2020-05-28T21:14:10Z", "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -864,4 +866,50 @@ private void cleanupReleasables() {\n         Releasables.close(releasables);\n         releasables.clear();\n     }\n+", "originalCommit": "1efc38444e19a6f9adcac002055feb3f178ca252", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}