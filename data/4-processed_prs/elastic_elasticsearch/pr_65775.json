{"pr_number": 65775, "pr_title": "[7.x] [ML] adding ml autoscaling integration test (#65638)", "pr_createdAt": "2020-12-02T20:18:22Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65775", "timeline": [{"oid": "588fff46d1dfc08f6a8b554653ebcfefef64c4f6", "url": "https://github.com/elastic/elasticsearch/commit/588fff46d1dfc08f6a8b554653ebcfefef64c4f6", "message": "[ML] adding ml autoscaling integration test (#65638)\n\nThis adds ml autoscaling integration tests.\n\nThe test verifies that the scaling requirements adjust according to the current real load\non the cluster given machine learning jobs of various sizes.\n\nAdditionally, there was a bug in the ml scaling service settings. This commit addresses the bug.", "committedDate": "2020-12-02T20:12:12Z", "type": "commit"}, {"oid": "e33ced7312a94822abcf2468d631263f1b9bc6bb", "url": "https://github.com/elastic/elasticsearch/commit/e33ced7312a94822abcf2468d631263f1b9bc6bb", "message": "attempting to fix test", "committedDate": "2020-12-03T12:14:11Z", "type": "commit"}, {"oid": "d4e990bc20a9137957dd48f0eb3b5c9b37d66db6", "url": "https://github.com/elastic/elasticsearch/commit/d4e990bc20a9137957dd48f0eb3b5c9b37d66db6", "message": "fixing tests", "committedDate": "2020-12-03T13:39:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI5NDQyNg==", "url": "https://github.com/elastic/elasticsearch/pull/65775#discussion_r539294426", "bodyText": "@benwtrent do you know why this did not work? It is preventing me from getting #66082 merged.", "author": "henningandersen", "createdAt": "2020-12-09T13:12:40Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/AutoscalingIT.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.integration;\n+\n+import org.elasticsearch.action.admin.cluster.node.info.NodeInfo;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.unit.ByteSizeValue;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.xpack.autoscaling.Autoscaling;\n+import org.elasticsearch.xpack.autoscaling.action.GetAutoscalingCapacityAction;\n+import org.elasticsearch.xpack.autoscaling.action.PutAutoscalingPolicyAction;\n+import org.elasticsearch.xpack.autoscaling.capacity.AutoscalingDeciderResult;\n+import org.elasticsearch.xpack.autoscaling.capacity.AutoscalingDeciderResults;\n+import org.elasticsearch.xpack.core.ml.job.config.AnalysisConfig;\n+import org.elasticsearch.xpack.core.ml.job.config.AnalysisLimits;\n+import org.elasticsearch.xpack.core.ml.job.config.DataDescription;\n+import org.elasticsearch.xpack.core.ml.job.config.Detector;\n+import org.elasticsearch.xpack.core.ml.job.config.Job;\n+import org.elasticsearch.xpack.ml.MachineLearning;\n+import org.elasticsearch.xpack.ml.autoscaling.MlAutoscalingDeciderService;\n+import org.elasticsearch.xpack.ml.autoscaling.NativeMemoryCapacity;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+import java.util.TreeSet;\n+import java.util.stream.Collectors;\n+\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+import static org.hamcrest.Matchers.containsString;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.hasKey;\n+\n+public class AutoscalingIT extends MlNativeAutodetectIntegTestCase {\n+\n+    private static final long BASIC_REQUIREMENT_MB = 10;\n+    private static final long NATIVE_PROCESS_OVERHEAD_MB = 30;\n+    private static final long BASELINE_OVERHEAD_MB = BASIC_REQUIREMENT_MB + NATIVE_PROCESS_OVERHEAD_MB;\n+\n+    // This test assumes that xpack.ml.max_machine_memory_percent is 30\n+    // and that xpack.ml.use_auto_machine_memory_percent is false\n+    public void testMLAutoscalingCapacity() {\n+        SortedMap<String, Settings> deciders = new TreeMap<>();\n+        deciders.put(MlAutoscalingDeciderService.NAME,\n+            Settings.builder().put(MlAutoscalingDeciderService.DOWN_SCALE_DELAY.getKey(), TimeValue.ZERO).build());\n+        final PutAutoscalingPolicyAction.Request request = new PutAutoscalingPolicyAction.Request(\n+            \"ml_test\",\n+            new TreeSet<>(),", "originalCommit": "d4e990bc20a9137957dd48f0eb3b5c9b37d66db6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMxMzAzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/65775#discussion_r539313035", "bodyText": "@henningandersen when I tried to supply \"ml\" it complained saying it was not really a valid node role. Now, this may have been due to the ML plugin not being loaded correctly? The easiest way to check is to simply put ml in there in 7.x and ry to run the test. I will double check", "author": "benwtrent", "createdAt": "2020-12-09T13:39:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI5NDQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMxNDA3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65775#discussion_r539314073", "bodyText": "Yeah, I did that and get the validation error. I only wanted to be sure I was not chasing something you already investigated deeply.", "author": "henningandersen", "createdAt": "2020-12-09T13:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI5NDQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMxOTIyNw==", "url": "https://github.com/elastic/elasticsearch/pull/65775#discussion_r539319227", "bodyText": "@henningandersen\n REPRODUCE WITH: ./gradlew ':x-pack:plugin:ml:qa:native-multi-node-tests:javaRestTest' --tests \"org.elasticsearch.xpack.ml.integration.AutoscalingIT.testMLAutoscalingCapacity\" -Dtests.seed=93A328B876AF5108 -Dtests.security.manager=true -Dtests.locale=pl -Dtests.timezone=Atlantic/Faroe -Druntime.java=11\n  2> org.elasticsearch.action.ActionRequestValidationException: Validation Failed: 1: ml;\n        at __randomizedtesting.SeedInfo.seed([93A328B876AF5108:D856B3907EB37506]:0)\n        at org.elasticsearch.xpack.autoscaling.action.PutAutoscalingPolicyAction$Request.validate(PutAutoscalingPolicyAction.java:150)\n        at org.elasticsearch.action.TransportActionNodeProxy.execute(TransportActionNodeProxy.java:42)\n        at org.elasticsearch.client.transport.TransportProxyClient.lambda$execute$0(TransportProxyClient.java:55)\n        at org.elasticsearch.client.transport.TransportClientNodesService.execute(TransportClientNodesService.java:253)\n        at org.elasticsearch.client.transport.TransportProxyClient.execute(TransportProxyClient.java:55)\n        at org.elasticsearch.client.transport.TransportClient.doExecute(TransportClient.java:391)\n        at org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:412)\n        at org.elasticsearch.client.FilterClient.doExecute(FilterClient.java:65)\n        at org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:412)\n        at org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:401)\n        at org.elasticsearch.xpack.ml.integration.AutoscalingIT.testMLAutoscalingCapacity(AutoscalingIT.java:57)\n\nI THINK the node role format has changed in master vs 7.x. Passing ml as the only role works fine in master.", "author": "benwtrent", "createdAt": "2020-12-09T13:47:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI5NDQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyNzUwOA==", "url": "https://github.com/elastic/elasticsearch/pull/65775#discussion_r539327508", "bodyText": "Ahhhh, the validation runs in the transport client and this causes the issue, since the client does not know about the ml plugin. Using a core role like master passes that validation (but fails the test with my PR due to validation).", "author": "henningandersen", "createdAt": "2020-12-09T13:58:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI5NDQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyODQyNw==", "url": "https://github.com/elastic/elasticsearch/pull/65775#discussion_r539328427", "bodyText": "Let me open a PR to move the validation out of the request in 7.x.", "author": "henningandersen", "createdAt": "2020-12-09T13:59:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI5NDQyNg=="}], "type": "inlineReview"}]}