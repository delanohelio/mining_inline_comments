{"pr_number": 65139, "pr_title": "add the ability to retrieve the fieldnames an aggregation creates from the builder", "pr_createdAt": "2020-11-17T14:39:27Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65139", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIwNzIxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r525207219", "bodyText": "this is not related to this PR, but fixes an issue I found. I can move this into a separate PR if you prefer.", "author": "hendrikmuhs", "createdAt": "2020-11-17T14:42:49Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/InternalExtendedStats.java", "diffHunk": "@@ -115,6 +120,11 @@ public double value(String name) {\n         return super.value(name);\n     }\n \n+    @Override\n+    public Iterable<String> valueNames() {\n+        return metricNames;", "originalCommit": "0c2837eafcdc42f70c02c7aff3e1d82691bdb544", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIzMTU3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r525231577", "bodyText": "Is it just the ..._as_string fields we ignore?  or are there other \"convenience\" fields?  I'm also worried this will make it hard to test.  I would think we should be able to just run the aggregation and compare the actual output to this field list.", "author": "not-napoleon", "createdAt": "2020-11-17T15:11:31Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregationBuilder.java", "diffHunk": "@@ -65,6 +67,18 @@ public String getName() {\n         return name;\n     }\n \n+    /**\n+     * Return the field names this aggregation creates.\n+     *\n+     * This method is a optional helper for clients that need to know the output field names.\n+     *\n+     * @return The set of output field names this aggregation produces without sub-aggregation and\n+     * convenience outputs (\"..._as_string\") or Optional.empty() if unknown or not implemented.", "originalCommit": "0c2837eafcdc42f70c02c7aff3e1d82691bdb544", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIzMzMzMg==", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r525233332", "bodyText": "This should probably not be mutable, and definitely not public mutable.  Same for other aggs.", "author": "not-napoleon", "createdAt": "2020-11-17T15:13:46Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/InternalExtendedStats.java", "diffHunk": "@@ -41,6 +44,8 @@ public static Metrics resolve(String name) {\n         }\n     }\n \n+    public static Set<String> metricNames = Stream.of(Metrics.values()).map(Metrics::name).collect(Collectors.toSet());", "originalCommit": "0c2837eafcdc42f70c02c7aff3e1d82691bdb544", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI0MTcxMg==", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r525241712", "bodyText": "or, wait, does that toSet() stream collector return an immutable set?  I don't remember.  I'd still be more comfortable if it was private at least.", "author": "not-napoleon", "createdAt": "2020-11-17T15:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIzMzMzMg=="}], "type": "inlineReview"}, {"oid": "dcd3afa2bf475449092e736ca7f5ca64d165b70a", "url": "https://github.com/elastic/elasticsearch/commit/dcd3afa2bf475449092e736ca7f5ca64d165b70a", "message": "add a (optional) getOutputFieldNames method to aggregationbuilder to\nretrieve the names of the fields the aggregation produces", "committedDate": "2020-12-22T14:24:37Z", "type": "commit"}, {"oid": "39849670620323b6f1ec1856716e378e68c24856", "url": "https://github.com/elastic/elasticsearch/commit/39849670620323b6f1ec1856716e378e68c24856", "message": "make metric names final where possible", "committedDate": "2020-12-22T14:24:37Z", "type": "commit"}, {"oid": "e357cf075f43a4988c22119870b4b56ab8dcb881", "url": "https://github.com/elastic/elasticsearch/commit/e357cf075f43a4988c22119870b4b56ab8dcb881", "message": "implement test to verify output field names", "committedDate": "2020-12-22T14:24:37Z", "type": "commit"}, {"oid": "e357cf075f43a4988c22119870b4b56ab8dcb881", "url": "https://github.com/elastic/elasticsearch/commit/e357cf075f43a4988c22119870b4b56ab8dcb881", "message": "implement test to verify output field names", "committedDate": "2020-12-22T14:24:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAxNTk0MA==", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r556015940", "bodyText": "@nik9000 did you want to distinguish between \"not implemented\" and \"we can't know the output fields\", using null for one of them?", "author": "not-napoleon", "createdAt": "2021-01-12T19:20:28Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregationBuilder.java", "diffHunk": "@@ -65,6 +67,17 @@ public String getName() {\n         return name;\n     }\n \n+    /**\n+     * Return the field names this aggregation creates.\n+     *\n+     * This method is a optional helper for clients that need to know the output field names.\n+     *\n+     * @return The set of output field names this aggregation produces or Optional.empty() if unknown or not implemented.", "originalCommit": "e357cf075f43a4988c22119870b4b56ab8dcb881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjEyOTEwNg==", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r556129106", "bodyText": "I want to make sure we can tell the difference between \"I didn't think about pipelines at all when implementing this agg\" and \"there are no fields exposed by this agg for pipelines\". I think Optional.empty can be \"I didn't think about it\" and \"Optional.of(emptySet())` can be \"there are no fields for pipelines here\".", "author": "nik9000", "createdAt": "2021-01-12T22:11:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAxNTk0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjY3ODc2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r556678769", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return The set of output field names this aggregation produces or Optional.empty() if unknown or not implemented.\n          \n          \n            \n                 * @return The set of output field names this aggregation produces or Optional.empty() if not implemented or Optional.of(emptySet()) if the fields are not known.\n          \n      \n    \n    \n  \n\nMaybe something like this then?", "author": "not-napoleon", "createdAt": "2021-01-13T16:54:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAxNTk0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAyMTk0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r556021943", "bodyText": "I'd feel better if we returned an immutable version or a copy here.  Or maybe just make METRIC_NAMES immutable to begin with.", "author": "not-napoleon", "createdAt": "2021-01-12T19:28:02Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/InternalExtendedStats.java", "diffHunk": "@@ -115,6 +120,11 @@ public double value(String name) {\n         return super.value(name);\n     }\n \n+    @Override\n+    public Iterable<String> valueNames() {\n+        return METRIC_NAMES;", "originalCommit": "e357cf075f43a4988c22119870b4b56ab8dcb881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjEzMTA0NA==", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r556131044", "bodyText": "I had thought toSet was immutable - looks like it isn't. Yeah, I'd make METRIC_NAMES immutable. Its generally confusing to me when something in CONSTANT_CASE isn't actually immutable.", "author": "nik9000", "createdAt": "2021-01-12T22:14:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAyMTk0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjY0Njg2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r556646866", "bodyText": "\ud83d\udc4d I wrapped them all using Collections.unmodifiableSet(...)", "author": "hendrikmuhs", "createdAt": "2021-01-13T16:12:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAyMTk0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjY4MTQ3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r556681479", "bodyText": "I had to double check it, and was pretty surprised to learn it wasn't specified to be immutable too.  Wrapping it seems like the right choice.", "author": "not-napoleon", "createdAt": "2021-01-13T16:58:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAyMTk0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAyNjY1OA==", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r556026658", "bodyText": "Why do we need this instanceof check?", "author": "not-napoleon", "createdAt": "2021-01-12T19:33:37Z", "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -496,6 +501,24 @@ protected void withAggregator(\n         }\n     }\n \n+    protected <T extends AggregationBuilder, V extends InternalAggregation> void verifyOutputFieldNames(T aggregationBuilder, V agg)\n+        throws IOException {\n+        if (aggregationBuilder.getOutputFieldNames().isEmpty()) {\n+            // aggregation does not support output field names yet\n+            return;\n+        }\n+\n+        if (agg instanceof NumericMetricsAggregation.MultiValue) {", "originalCommit": "e357cf075f43a4988c22119870b4b56ab8dcb881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjY0NjExNw==", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r556646117", "bodyText": "ok, I made it an assert, in future there might be implementations for agg types not based on multi value numeric aggs, but I agree the check was premature and did not force the implementation. In case someone implements getOutputFieldNames for another agg type the assert will force him/her to fix this test.", "author": "hendrikmuhs", "createdAt": "2021-01-13T16:11:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAyNjY1OA=="}], "type": "inlineReview"}, {"oid": "fe4efcd4ba4cfc55501b6897f9cc43e32e0c4a1d", "url": "https://github.com/elastic/elasticsearch/commit/fe4efcd4ba4cfc55501b6897f9cc43e32e0c4a1d", "message": "address review comments", "committedDate": "2021-01-13T13:57:30Z", "type": "commit"}, {"oid": "3096faeacde85e284e4861b0bf814277e93429b9", "url": "https://github.com/elastic/elasticsearch/commit/3096faeacde85e284e4861b0bf814277e93429b9", "message": "make more fieldname sets immutable", "committedDate": "2021-01-13T15:44:26Z", "type": "commit"}, {"oid": "7fad26d163ff6e56e880b96138470189371a4c9c", "url": "https://github.com/elastic/elasticsearch/commit/7fad26d163ff6e56e880b96138470189371a4c9c", "message": "Merge branch 'master' into aggs-output-fields-2", "committedDate": "2021-01-13T16:06:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjY3OTk1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r556679959", "bodyText": "Much better, thank you!", "author": "not-napoleon", "createdAt": "2021-01-13T16:56:05Z", "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -560,15 +560,15 @@ protected void withAggregator(\n             return;\n         }\n \n-        if (agg instanceof NumericMetricsAggregation.MultiValue) {\n-            NumericMetricsAggregation.MultiValue multiValueAgg = (NumericMetricsAggregation.MultiValue) agg;\n-            Set<String> valueNames = new HashSet<>();\n-            for (String name : multiValueAgg.valueNames()) {\n-                valueNames.add(name);\n-            }\n+        assert agg instanceof NumericMetricsAggregation.MultiValue : \"only multi value aggs are supported\";", "originalCommit": "7fad26d163ff6e56e880b96138470189371a4c9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1dabd4560affc0c8152e15befc6283b078aa2f75", "url": "https://github.com/elastic/elasticsearch/commit/1dabd4560affc0c8152e15befc6283b078aa2f75", "message": "Update server/src/main/java/org/elasticsearch/search/aggregations/AggregationBuilder.java\n\nCo-authored-by: Mark Tozzi <mark.tozzi@gmail.com>", "committedDate": "2021-01-13T18:45:39Z", "type": "commit"}, {"oid": "3e0762c991b85e8771b13cd5ac7f34b5d67eb612", "url": "https://github.com/elastic/elasticsearch/commit/3e0762c991b85e8771b13cd5ac7f34b5d67eb612", "message": "checkstyle", "committedDate": "2021-01-13T19:03:32Z", "type": "commit"}]}