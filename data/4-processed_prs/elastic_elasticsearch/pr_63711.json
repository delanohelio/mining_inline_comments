{"pr_number": 63711, "pr_title": "Prevent DocumentParser from relying on DocumentMapper at construction time", "pr_createdAt": "2020-10-15T05:41:57Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63711", "timeline": [{"oid": "0a8f5a07a04936f48e9fa6eb5996dfcb773efe41", "url": "https://github.com/elastic/elasticsearch/commit/0a8f5a07a04936f48e9fa6eb5996dfcb773efe41", "message": "Prevent DocumentParser from relying on DocumentMapper at construction time\n\nDocumentParser constructor accepts a reference to DocumentMapper. DocumentMapper provides `this` during its own initialization which could cause problems as it exposes its own state before initialization is complete.\n\nTo address this, we can simply have DocumentMapper pass this rather to the parse method, which is the only public method that DocumentParser exposes. While at it, DocumentParser does not need to hold on to references to IndexSettings and DocumentMapperParser as they can be exposed through DocumentMapper.", "committedDate": "2020-10-15T05:40:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE3NzE0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63711#discussion_r505177143", "bodyText": "I am considering making this class package private as a follow-up, its only public because its used in percolator tests.", "author": "javanna", "createdAt": "2020-10-15T05:43:00Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/ParseContext.java", "diffHunk": "@@ -319,11 +315,8 @@ public void addIgnoredField(String field) {\n \n         private final Set<String> ignoredFields = new HashSet<>();\n \n-        public InternalParseContext(IndexSettings indexSettings, DocumentMapperParser docMapperParser, DocumentMapper docMapper,\n-                                    SourceToParse source, XContentParser parser) {\n-            this.indexSettings = indexSettings;\n+        public InternalParseContext(DocumentMapper docMapper, SourceToParse source, XContentParser parser) {", "originalCommit": "0a8f5a07a04936f48e9fa6eb5996dfcb773efe41", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}