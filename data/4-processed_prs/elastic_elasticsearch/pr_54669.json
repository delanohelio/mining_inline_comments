{"pr_number": 54669, "pr_title": "Use V2 index templates during index creation", "pr_createdAt": "2020-04-02T17:48:10Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54669", "timeline": [{"oid": "d16fd3d8014fafcd2f742a756483f1d59d8f0fe5", "url": "https://github.com/elastic/elasticsearch/commit/d16fd3d8014fafcd2f742a756483f1d59d8f0fe5", "message": "Use V2 index templates during index creation\n\nThis commit changes our index creation code to use (and favor!) V2 index templates during index\ncreation. The creation precedence goes like so, in order of precedence:\n\n- Existing source `IndexMetadata` - for example, when recovering from a peer or a shrink/split/clone\n  where index templates should not be applied\n- A matching V2 index template, if one is found\n  - When a V2 template is found, all component templates (in the `composed_of` field) are applied\n    in the order that they appear, with the index template having the 2nd highest precedence (the\n    create index request always has the top priority when it comes to index settings)\n- All matching V1 templates (the old style)\n\nThis also adds index template validation when `PUT`-ing a new v2 index template (because this was\nrequired) and ensures that all index and component templates specify *no* top-level mapping type (it\nis automatically added when the template is added to the cluster state).\n\nThis does not yet implement fine-grained component template merging of mappings, where we favor\nmerging only a single field's configuration, that will be done in subsequent work.\n\nThis also keeps the existing hidden index behavior present for v1 templates, where a hidden index\nwill match v2 index templates unless they are global (`*`) templates.\n\nRelates to #53101", "committedDate": "2020-04-02T17:40:34Z", "type": "commit"}, {"oid": "180cd169afaf82f93973aa4562d3028f091f1c7e", "url": "https://github.com/elastic/elasticsearch/commit/180cd169afaf82f93973aa4562d3028f091f1c7e", "message": "Make test not use prefixed wildcards\n\nIt matches all templates otherwise, so causes warnings", "committedDate": "2020-04-02T19:32:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MjI1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54669#discussion_r402992257", "bodyText": "Should we also check v2 templates here, if default/final pipeline has been specified? If so then I think it is fine to do this in a follow up pr.", "author": "martijnvg", "createdAt": "2020-04-03T13:08:38Z", "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "diffHunk": "@@ -307,7 +307,7 @@ static boolean resolvePipelines(final DocWriteRequest<?> originalRequest, final\n                 }\n             } else if (indexRequest.index() != null) {\n                 // the index does not exist yet (and this is a valid request), so match index templates to look for pipelines\n-                List<IndexTemplateMetadata> templates = MetadataIndexTemplateService.findTemplates(metadata, indexRequest.index(), null);\n+                List<IndexTemplateMetadata> templates = MetadataIndexTemplateService.findV1Templates(metadata, indexRequest.index(), null);", "originalCommit": "180cd169afaf82f93973aa4562d3028f091f1c7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5Mjk0OA==", "url": "https://github.com/elastic/elasticsearch/pull/54669#discussion_r402992948", "bodyText": "Should we check v2 templates here too? If so, then I think it is ok to do this in a followup change as well.", "author": "martijnvg", "createdAt": "2020-04-03T13:09:41Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverService.java", "diffHunk": "@@ -161,10 +161,9 @@ static CreateIndexClusterStateUpdateRequest prepareCreateIndexRequest(final Stri\n      * the rollover alias will point to multiple indices. This causes indexing requests to be rejected.\n      * To avoid this, we make sure that there is no duplicated alias in index templates before creating a new index.\n      */\n-    static void checkNoDuplicatedAliasInIndexTemplate(\n-            Metadata metadata, String rolloverIndexName, String rolloverRequestAlias,\n-            @Nullable Boolean isHidden) {\n-        final List<IndexTemplateMetadata> matchedTemplates = findTemplates(metadata, rolloverIndexName, isHidden);\n+    static void checkNoDuplicatedAliasInIndexTemplate(Metadata metadata, String rolloverIndexName, String rolloverRequestAlias,\n+                                                      @Nullable Boolean isHidden) {\n+        final List<IndexTemplateMetadata> matchedTemplates = findV1Templates(metadata, rolloverIndexName, isHidden);", "originalCommit": "180cd169afaf82f93973aa4562d3028f091f1c7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA5MDkyOA==", "url": "https://github.com/elastic/elasticsearch/pull/54669#discussion_r403090928", "bodyText": "Definitely, I'll be addressing these in followups!", "author": "dakrone", "createdAt": "2020-04-03T15:34:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5Mjk0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5NTcwMA==", "url": "https://github.com/elastic/elasticsearch/pull/54669#discussion_r402995700", "bodyText": "Maybe leave the todo? I think we still need to validate whether templates with the same priority exist that have overlapping patterns?", "author": "martijnvg", "createdAt": "2020-04-03T13:14:11Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -295,12 +320,41 @@ static ClusterState addIndexTemplateV2(final ClusterState currentState, final bo\n             deprecationLogger.deprecated(warning);\n         }\n \n-        // TODO: validation of index template", "originalCommit": "180cd169afaf82f93973aa4562d3028f091f1c7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA5MDY5OA==", "url": "https://github.com/elastic/elasticsearch/pull/54669#discussion_r403090698", "bodyText": "This todo was for validating the mappings and settings in an index template (which this PR adds), we have a TODO item in the list on #53101 to make sure explicitly add the check for overlapping v2 template, so no need to worry!", "author": "dakrone", "createdAt": "2020-04-03T15:34:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5NTcwMA=="}], "type": "inlineReview"}]}