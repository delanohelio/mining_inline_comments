{"pr_number": 63811, "pr_title": "Fix broken parent and child aggregator", "pr_createdAt": "2020-10-16T14:34:43Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63811", "timeline": [{"oid": "609ecb628372bd955817fbaab85693131cba29c9", "url": "https://github.com/elastic/elasticsearch/commit/609ecb628372bd955817fbaab85693131cba29c9", "message": "Fix broken parent and child aggregator\n\nIn #57892 I broke *some* sub-aggregations inside of the `parent` and\n`child` aggregator, specifically any sub-aggregations that do work in\nthe `postCollect` phase. This fixes it by delaying the post collect\nphase of aggs under `parent` and `child` until `beforeBuildingBuckets`\nbecause, well, we haven't done *any* collection until after that phase.", "committedDate": "2020-10-16T14:31:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ5MjExMA==", "url": "https://github.com/elastic/elasticsearch/pull/63811#discussion_r506492110", "bodyText": "I was borrowing this test setup and wanted to clean it up a bit while I was here. bulk is ever so slightly quicker for this sort of thing. And it takes up a lot fewer lines!", "author": "nik9000", "createdAt": "2020-10-16T14:35:35Z", "path": "modules/parent-join/src/yamlRestTest/resources/rest-api-spec/test/20_parent_join.yml", "diffHunk": "@@ -3,53 +3,30 @@ setup:\n       indices.create:\n         index: test\n         body:\n+          settings:\n+            number_of_shards: 2 #Two shards proves that we route properly\n           mappings:\n             properties:\n               join_field: { \"type\": \"join\", \"relations\": { \"parent\": \"child\", \"child\": \"grand_child\" } }\n               id: { \"type\": \"keyword\" }\n \n   - do:\n-      index:", "originalCommit": "609ecb628372bd955817fbaab85693131cba29c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ5MjQ4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63811#discussion_r506492482", "bodyText": "I moved this into 40_aggregations.yml.", "author": "nik9000", "createdAt": "2020-10-16T14:35:57Z", "path": "modules/parent-join/src/test/resources/rest-api-spec/test/40_unconfigred.yml", "diffHunk": "@@ -1,24 +0,0 @@\n----\n-\"unconfigured\":\n-  - do:\n-      index:", "originalCommit": "609ecb628372bd955817fbaab85693131cba29c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ5MzU3NA==", "url": "https://github.com/elastic/elasticsearch/pull/63811#discussion_r506493574", "bodyText": "I think we'd be better off removing postCollection entirely and replacing it with beforeBuildingBuckets because it is very similar but it has access to the buckets we actually want.", "author": "nik9000", "createdAt": "2020-10-16T14:37:01Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregatorBase.java", "diffHunk": "@@ -250,9 +250,12 @@ public SearchContext context() {\n \n     /**\n      * Called after collection of all document is done.\n+     * <p>\n+     * Warning: this is not final only to allow the parent join aggregator\n+     * to delay this until building buckets.\n      */\n     @Override\n-    public final void postCollection() throws IOException {\n+    public void postCollection() throws IOException {", "originalCommit": "609ecb628372bd955817fbaab85693131cba29c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}