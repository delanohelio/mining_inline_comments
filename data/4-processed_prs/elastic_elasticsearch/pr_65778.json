{"pr_number": 65778, "pr_title": "Make it possible to use Stack logging in Docker", "pr_createdAt": "2020-12-02T21:15:47Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65778", "timeline": [{"oid": "f0b1243d9f592a9cd1a6461c5c93fdc0fe6f7f42", "url": "https://github.com/elastic/elasticsearch/commit/f0b1243d9f592a9cd1a6461c5c93fdc0fe6f7f42", "message": "Make it possible to use Stack logging in Docker\n\nCloses #62758.\n\nInclude the Stack log4j config in the Docker image, in order to make it\npossible to write logs in a container environment in the same way as for\nan archive or package deployment. This is useful in situations where the\nuser is bind-mounting the logs directory and has their own arrangements\nfor log shipping.", "committedDate": "2020-12-02T20:56:58Z", "type": "commit"}, {"oid": "a978be7a589bef7c98c7a77c681c7177dd18aafc", "url": "https://github.com/elastic/elasticsearch/commit/a978be7a589bef7c98c7a77c681c7177dd18aafc", "message": "Add a note about the ES_LOG_STYLE env var", "committedDate": "2020-12-02T21:12:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUzMDc0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/65778#discussion_r534530749", "bodyText": "I'm not in love with this name. It doesn't really mean anything from a user perspective. I'd be more inclined to call this file or disk.", "author": "mark-vieira", "createdAt": "2020-12-02T22:40:47Z", "path": "distribution/docker/src/docker/bin/docker-entrypoint.sh", "diffHunk": "@@ -57,6 +57,21 @@ if [[ -f bin/elasticsearch-users ]]; then\n   fi\n fi\n \n+if [[ -n \"$ES_LOG_STYLE\" ]]; then\n+  case \"$ES_LOG_STYLE\" in\n+    docker)\n+      # This is the default. Nothing to do.\n+      ;;\n+    stack)", "originalCommit": "a978be7a589bef7c98c7a77c681c7177dd18aafc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE2Nzk5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/65778#discussion_r535167996", "bodyText": "Agreed, I've swapped to console and `file.", "author": "pugnascotia", "createdAt": "2020-12-03T12:05:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUzMDc0OQ=="}], "type": "inlineReview"}, {"oid": "74ab2749984e497f269a7fcbbb37c5096d59af4f", "url": "https://github.com/elastic/elasticsearch/commit/74ab2749984e497f269a7fcbbb37c5096d59af4f", "message": "Generate a Docker log4j config from the default config\n\nRather than maintaining a separate log4j config specifically for\nDocker, we can generate a config by processing the ES distribtution's\ndefault configuration so that everything is emitted to the console.", "committedDate": "2020-12-03T12:01:51Z", "type": "commit"}, {"oid": "580bc0b656b32bee74dc9f0b07e9edacdf3aafe3", "url": "https://github.com/elastic/elasticsearch/commit/580bc0b656b32bee74dc9f0b07e9edacdf3aafe3", "message": "Strip out a redundant precommit check", "committedDate": "2020-12-03T12:21:40Z", "type": "commit"}, {"oid": "288ac14108e678d4f0cb07de81b89a8d25cdab3c", "url": "https://github.com/elastic/elasticsearch/commit/288ac14108e678d4f0cb07de81b89a8d25cdab3c", "message": "Merge remote-tracking branch 'upstream/master' into 62758-docker-stack-logging", "committedDate": "2020-12-03T14:55:19Z", "type": "commit"}, {"oid": "044929f650dcad5ec3f3ad1197add2ea3a06e898", "url": "https://github.com/elastic/elasticsearch/commit/044929f650dcad5ec3f3ad1197add2ea3a06e898", "message": "Merge remote-tracking branch 'upstream/master' into 62758-docker-stack-logging", "committedDate": "2020-12-03T15:35:01Z", "type": "commit"}, {"oid": "25207199706e39ac90e946774469e0982e104760", "url": "https://github.com/elastic/elasticsearch/commit/25207199706e39ac90e946774469e0982e104760", "message": "Convert jshell script to Java", "committedDate": "2020-12-04T19:45:06Z", "type": "commit"}, {"oid": "9f31d88492bb584cc215bca645c803db2198cfb1", "url": "https://github.com/elastic/elasticsearch/commit/9f31d88492bb584cc215bca645c803db2198cfb1", "message": "Add unit tests", "committedDate": "2020-12-07T15:44:39Z", "type": "commit"}, {"oid": "e2e9b4761591178ab004de35d8fbf39a922c5c89", "url": "https://github.com/elastic/elasticsearch/commit/e2e9b4761591178ab004de35d8fbf39a922c5c89", "message": "Merge remote-tracking branch 'upstream/master' into 62758-docker-stack-logging", "committedDate": "2020-12-07T15:44:58Z", "type": "commit"}, {"oid": "ab7385049f0358daffb68304f1447ce04e0aa6c2", "url": "https://github.com/elastic/elasticsearch/commit/ab7385049f0358daffb68304f1447ce04e0aa6c2", "message": "Checkstyle", "committedDate": "2020-12-08T13:29:29Z", "type": "commit"}, {"oid": "96536fd6c59412c22de981948142762ae735543c", "url": "https://github.com/elastic/elasticsearch/commit/96536fd6c59412c22de981948142762ae735543c", "message": "Fixes", "committedDate": "2020-12-09T15:25:44Z", "type": "commit"}, {"oid": "d1bb2427fb5a6bd62c7f0cde11ab486682e5e18d", "url": "https://github.com/elastic/elasticsearch/commit/d1bb2427fb5a6bd62c7f0cde11ab486682e5e18d", "message": "Tidy up", "committedDate": "2020-12-09T15:38:37Z", "type": "commit"}, {"oid": "6cff1aaf6b8bebe321014bff1d7551ad8ff0a373", "url": "https://github.com/elastic/elasticsearch/commit/6cff1aaf6b8bebe321014bff1d7551ad8ff0a373", "message": "More fixes", "committedDate": "2020-12-09T15:59:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ4OTE2OA==", "url": "https://github.com/elastic/elasticsearch/pull/65778#discussion_r539489168", "bodyText": "Can you elaborate what can't be cached here?", "author": "breskeby", "createdAt": "2020-12-09T17:10:50Z", "path": "distribution/docker/build.gradle", "diffHunk": "@@ -21,13 +21,33 @@ configurations {\n   dockerSource\n   aarch64OssDockerSource\n   ossDockerSource\n+  transformLog4jJar\n }\n \n dependencies {\n   aarch64DockerSource project(path: \":distribution:archives:linux-aarch64-tar\", configuration:\"default\")\n   dockerSource project(path: \":distribution:archives:linux-tar\", configuration:\"default\")\n   aarch64OssDockerSource project(path: \":distribution:archives:oss-linux-aarch64-tar\", configuration:\"default\")\n   ossDockerSource project(path: \":distribution:archives:oss-linux-tar\", configuration:\"default\")\n+  transformLog4jJar project(path: \":distribution:docker:transform-log4j-config\", configuration: \"default\")\n+}\n+\n+/**\n+ * Used in the Dockerfile template to wrap commands in a retry loop. It can't be\n+ * a closure because Gradle can't effectively cache those.", "originalCommit": "6cff1aaf6b8bebe321014bff1d7551ad8ff0a373", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ5MDE0NA==", "url": "https://github.com/elastic/elasticsearch/pull/65778#discussion_r539490144", "bodyText": "In general I'm in favour to have class definitions living in buildSrc somewhere no matter how small they are. To keep our build scripts a bit cleaner and smaller. Also these classes should change less often than the script itself.", "author": "breskeby", "createdAt": "2020-12-09T17:12:07Z", "path": "distribution/docker/build.gradle", "diffHunk": "@@ -21,13 +21,33 @@ configurations {\n   dockerSource\n   aarch64OssDockerSource\n   ossDockerSource\n+  transformLog4jJar\n }\n \n dependencies {\n   aarch64DockerSource project(path: \":distribution:archives:linux-aarch64-tar\", configuration:\"default\")\n   dockerSource project(path: \":distribution:archives:linux-tar\", configuration:\"default\")\n   aarch64OssDockerSource project(path: \":distribution:archives:oss-linux-aarch64-tar\", configuration:\"default\")\n   ossDockerSource project(path: \":distribution:archives:oss-linux-tar\", configuration:\"default\")\n+  transformLog4jJar project(path: \":distribution:docker:transform-log4j-config\", configuration: \"default\")\n+}\n+\n+/**\n+ * Used in the Dockerfile template to wrap commands in a retry loop. It can't be\n+ * a closure because Gradle can't effectively cache those.\n+ */\n+class Retry {", "originalCommit": "6cff1aaf6b8bebe321014bff1d7551ad8ff0a373", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ5MDU1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/65778#discussion_r539490551", "bodyText": "I think the , is too much here", "author": "breskeby", "createdAt": "2020-12-09T17:12:36Z", "path": "distribution/docker/build.gradle", "diffHunk": "@@ -100,7 +108,7 @@ ${indent}${exitKeyword} \\$exit_code\"\"\"\n     'docker_base'         : base.name().toLowerCase(),\n     'version'             : VersionProperties.elasticsearch,\n     'major_minor_version' : \"${major}.${minor}\",\n-    'retry_loop'          : retry_loop\n+    'retry'               : Retry,", "originalCommit": "6cff1aaf6b8bebe321014bff1d7551ad8ff0a373", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bfc4748902f9151d02e27bc44485b72e36558226", "url": "https://github.com/elastic/elasticsearch/commit/bfc4748902f9151d02e27bc44485b72e36558226", "message": "Move shell retry class to buildSrc", "committedDate": "2020-12-09T21:08:43Z", "type": "commit"}, {"oid": "b9c420a588e6b8c8e4bcab16eb19f29b7f69681e", "url": "https://github.com/elastic/elasticsearch/commit/b9c420a588e6b8c8e4bcab16eb19f29b7f69681e", "message": "Merge remote-tracking branch 'upstream/master' into 62758-docker-stack-logging", "committedDate": "2020-12-09T21:09:08Z", "type": "commit"}, {"oid": "199a550e8642bf48d668185229c69588d79a2950", "url": "https://github.com/elastic/elasticsearch/commit/199a550e8642bf48d668185229c69588d79a2950", "message": "I hate you, Checkstyle", "committedDate": "2020-12-09T21:20:50Z", "type": "commit"}, {"oid": "4d120f313b7ebe387c18d5870cb2bc777ae710d5", "url": "https://github.com/elastic/elasticsearch/commit/4d120f313b7ebe387c18d5870cb2bc777ae710d5", "message": "Merge branch 'master' into 62758-docker-stack-logging", "committedDate": "2020-12-10T11:25:18Z", "type": "commit"}]}