{"pr_number": 62179, "pr_title": "Release search context when scroll keep_alive is too large", "pr_createdAt": "2020-09-09T15:49:08Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62179", "timeline": [{"oid": "7af2fec66695b7407f82fe57ca58c8a96fcd077f", "url": "https://github.com/elastic/elasticsearch/commit/7af2fec66695b7407f82fe57ca58c8a96fcd077f", "message": "Fix testInvalidScrollKeepAlive", "committedDate": "2020-09-09T15:48:46Z", "type": "commit"}, {"oid": "118cd0e6e22816140d418a4555259bffba206435", "url": "https://github.com/elastic/elasticsearch/commit/118cd0e6e22816140d418a4555259bffba206435", "message": "Revert \"Fix testInvalidScrollKeepAlive\"\n\nThis reverts commit 7af2fec66695b7407f82fe57ca58c8a96fcd077f.", "committedDate": "2020-09-09T16:11:14Z", "type": "commit"}, {"oid": "ce109e513e33c8a7a014ac23824d1a060b1adcee", "url": "https://github.com/elastic/elasticsearch/commit/ce109e513e33c8a7a014ac23824d1a060b1adcee", "message": "Release scroll context", "committedDate": "2020-09-09T16:17:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc0NjE1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/62179#discussion_r485746152", "bodyText": "can you replace the call with freeReaderContext(context.id())?", "author": "jimczi", "createdAt": "2020-09-09T16:22:25Z", "path": "server/src/main/java/org/elasticsearch/search/SearchService.java", "diffHunk": "@@ -471,7 +471,14 @@ public void executeQueryPhase(InternalScrollSearchRequest request,\n                                   SearchShardTask task,\n                                   ActionListener<ScrollQuerySearchResult> listener) {\n         final LegacyReaderContext readerContext = (LegacyReaderContext) findReaderContext(request.contextId(), request);\n-        final Releasable markAsUsed = readerContext.markAsUsed(getScrollKeepAlive(request.scroll()));\n+        final Releasable markAsUsed;\n+        try {\n+            markAsUsed = readerContext.markAsUsed(getScrollKeepAlive(request.scroll()));\n+        } catch (Exception e) {\n+            // We need to release the reader context of the scroll when we hit any exception (here the keep_alive can be too large)\n+            processFailure(readerContext, e);", "originalCommit": "ce109e513e33c8a7a014ac23824d1a060b1adcee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc0OTAwMA==", "url": "https://github.com/elastic/elasticsearch/pull/62179#discussion_r485749000", "bodyText": "++. I pushed 3517cb5", "author": "dnhatn", "createdAt": "2020-09-09T16:25:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc0NjE1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc0Njg0OA==", "url": "https://github.com/elastic/elasticsearch/pull/62179#discussion_r485746848", "bodyText": "same here", "author": "jimczi", "createdAt": "2020-09-09T16:23:18Z", "path": "server/src/main/java/org/elasticsearch/search/SearchService.java", "diffHunk": "@@ -536,7 +543,14 @@ private Executor getExecutor(IndexShard indexShard) {\n     public void executeFetchPhase(InternalScrollSearchRequest request, SearchShardTask task,\n                                   ActionListener<ScrollQueryFetchSearchResult> listener) {\n         final LegacyReaderContext readerContext = (LegacyReaderContext) findReaderContext(request.contextId(), request);\n-        final Releasable markAsUsed = readerContext.markAsUsed(getScrollKeepAlive(request.scroll()));\n+        final Releasable markAsUsed;\n+        try {\n+            markAsUsed = readerContext.markAsUsed(getScrollKeepAlive(request.scroll()));\n+        } catch (Exception e) {\n+            // We need to release the reader context of the scroll when we hit any exception (here the keep_alive can be too large)\n+            processFailure(readerContext, e);", "originalCommit": "ce109e513e33c8a7a014ac23824d1a060b1adcee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3517cb56f1130288b92b9587e65e267fa6873626", "url": "https://github.com/elastic/elasticsearch/commit/3517cb56f1130288b92b9587e65e267fa6873626", "message": "feedback", "committedDate": "2020-09-09T16:25:27Z", "type": "commit"}]}