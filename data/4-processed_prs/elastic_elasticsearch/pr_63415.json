{"pr_number": 63415, "pr_title": "EQL: Avoid filtering on tiebreakers", "pr_createdAt": "2020-10-07T15:08:10Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63415", "timeline": [{"oid": "de295de23ce795a30162958f7ee1c4f38676f72a", "url": "https://github.com/elastic/elasticsearch/commit/de295de23ce795a30162958f7ee1c4f38676f72a", "message": "EQL: Avoid filtering on tiebreakers\n\nDo not filter by tiebreaker while searching sequence matches as\nit's not monotonic and thus can filter out valid data.\nAdd handling for data 'near' the boundary that has the same timestamp\nbut different tie-breaker and thus can be just outside the window.\n\nFix #62781\nRelates #63215", "committedDate": "2020-10-07T15:40:04Z", "type": "commit"}, {"oid": "de295de23ce795a30162958f7ee1c4f38676f72a", "url": "https://github.com/elastic/elasticsearch/commit/de295de23ce795a30162958f7ee1c4f38676f72a", "message": "EQL: Avoid filtering on tiebreakers\n\nDo not filter by tiebreaker while searching sequence matches as\nit's not monotonic and thus can filter out valid data.\nAdd handling for data 'near' the boundary that has the same timestamp\nbut different tie-breaker and thus can be just outside the window.\n\nFix #62781\nRelates #63215", "committedDate": "2020-10-07T15:40:04Z", "type": "forcePushed"}, {"oid": "1ff4fd125de499f05058a59a5026c3906908252c", "url": "https://github.com/elastic/elasticsearch/commit/1ff4fd125de499f05058a59a5026c3906908252c", "message": "Update test specs", "committedDate": "2020-10-07T16:57:28Z", "type": "commit"}, {"oid": "f7f8af6e6fc420dd63a5d236d646cd3d73662254", "url": "https://github.com/elastic/elasticsearch/commit/f7f8af6e6fc420dd63a5d236d646cd3d73662254", "message": "More docs", "committedDate": "2020-10-07T17:54:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMzMjIwNg==", "url": "https://github.com/elastic/elasticsearch/pull/63415#discussion_r501332206", "bodyText": "@astefan Here's the description on why X99 is needed.\nIt is not needed for the bug fix itself however since the algorithm now makes multiple calls and does extra filtering, the way the test is currently setup the data for each query is returned at once in the first go and then nothing else.\nThus specs that have more items at the tail miss those and thus fail to do matching and thus fail.\nX99 is essentially a late marker to force a large window and thus get all values inside for matching.\nNote the spec is about testing the way matching works, not pagination or filtering so having all the data at once or not is a separate detail.", "author": "costin", "createdAt": "2020-10-07T21:54:57Z", "path": "x-pack/plugin/eql/src/test/resources/sequences.series-spec", "diffHunk": "@@ -10,17 +10,19 @@\n // the number following the string is used as a timestamp/order\n // while the optional prefix followed by | indicates the key\n \n-// since the spec checks the way matching is done\n-// which is based on the runtime component that can make multiple requests\n-// use X99 as an token to force results from other lines to be read in\n+// since the spec checks only the way matching is done it returns\n+// all the results in the first call and then an empty list.\n+// Since the runtime component can make multiple requests and thus discard\n+// returned data, use X99 as an token to force results from other lines\n+// to be read in (as it makes a larger window for the runtime)\n \n // For example\n // A1 A2\n //       B3\n // fails because B3 should not be read in its first call as it goes beyond A1/A2 window.\n // however the testing infrastructure doesn't know this so it returns the item\n-// which is then discarded.\n-// To avoid the runtime filtering leaking in, adding an extra token at the end forces\n+// which is then discarded. On the next call, empty results are returned.\n+// To avoid the runtime behavior leaking in, adding an extra token at the end forces\n // the runtime window to be expanded and thus for all results to be properly read:", "originalCommit": "f7f8af6e6fc420dd63a5d236d646cd3d73662254", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUxNTQzOA==", "url": "https://github.com/elastic/elasticsearch/pull/63415#discussion_r501515438", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // however check if the window has been fully consumed consumed\n          \n          \n            \n                        // however check if the window has been fully consumed", "author": "matriv", "createdAt": "2020-10-08T07:49:56Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/TumblingWindow.java", "diffHunk": "@@ -245,7 +264,8 @@ private void secondaryCriterion(WindowInfo window, int currentStage, ActionListe\n             }\n \n             // keep running the query runs out of the results (essentially returns less than what we want)\n-            if (hits.size() == windowSize) {\n+            // however check if the window has been fully consumed consumed", "originalCommit": "f7f8af6e6fc420dd63a5d236d646cd3d73662254", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eaf18c2d9ead41604ef6dbb8dec782b40a97248a", "url": "https://github.com/elastic/elasticsearch/commit/eaf18c2d9ead41604ef6dbb8dec782b40a97248a", "message": "fix comment", "committedDate": "2020-10-08T09:16:30Z", "type": "commit"}]}