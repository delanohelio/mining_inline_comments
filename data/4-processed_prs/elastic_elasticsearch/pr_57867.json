{"pr_number": 57867, "pr_title": "Fix rounding composite aggs on sorted index", "pr_createdAt": "2020-06-09T09:06:39Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57867", "timeline": [{"oid": "824448636234405400305c969a3125319472d214", "url": "https://github.com/elastic/elasticsearch/commit/824448636234405400305c969a3125319472d214", "message": "Fix rounding composite aggs on sorted index\n\nThis commit fixes a bug on the composite aggregation when the index\nis sorted and the primary composite source needs to round values (date_histo).\nIn such case, we cannot take into account the subsequent sources even if they\nmatch the index sort because the rounding of the primary sort value may break\nthe original index order.\n\nFixes #57849", "committedDate": "2020-06-09T09:04:54Z", "type": "commit"}, {"oid": "05013ffc95b6ccedde9998f5ea8f45868ef6b5bc", "url": "https://github.com/elastic/elasticsearch/commit/05013ffc95b6ccedde9998f5ea8f45868ef6b5bc", "message": "fix hashcode", "committedDate": "2020-06-09T10:36:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxNTI2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57867#discussion_r437415263", "bodyText": "It's probably worth explaining why. I think it is because the rounding \"squashes\" many values together so we can't get the order of the sub-values by looking at any one key. We'd have to merge all the values that round to that key and get the sub-values from that. And that isn't the kind of this this index sorting optimization does.", "author": "nik9000", "createdAt": "2020-06-09T13:26:47Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/composite/CompositeAggregator.java", "diffHunk": "@@ -231,6 +235,10 @@ private Sort buildIndexSortPrefix(LeafReaderContext context) throws IOException\n                 break;\n             }\n             sortFields.add(indexSortField);\n+            if (sourceConfig.valuesSource() instanceof RoundingValuesSource) {\n+                // rounded values break the index sort", "originalCommit": "05013ffc95b6ccedde9998f5ea8f45868ef6b5bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUyMzk5MA==", "url": "https://github.com/elastic/elasticsearch/pull/57867#discussion_r437523990", "bodyText": "++, I pushed e486057", "author": "jimczi", "createdAt": "2020-06-09T15:31:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxNTI2Mw=="}], "type": "inlineReview"}, {"oid": "e48605775859aeb48d6f0eb1d7356ca434fdf6d2", "url": "https://github.com/elastic/elasticsearch/commit/e48605775859aeb48d6f0eb1d7356ca434fdf6d2", "message": "add comments", "committedDate": "2020-06-09T15:30:14Z", "type": "commit"}]}