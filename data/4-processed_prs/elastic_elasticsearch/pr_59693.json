{"pr_number": 59693, "pr_title": "Fix DLS/FLS permission for the submit async search action", "pr_createdAt": "2020-07-16T10:04:50Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59693", "timeline": [{"oid": "e919e5fc3adb3f185ec2263b598c1c0964506967", "url": "https://github.com/elastic/elasticsearch/commit/e919e5fc3adb3f185ec2263b598c1c0964506967", "message": "Main", "committedDate": "2020-07-16T07:46:48Z", "type": "commit"}, {"oid": "995f2fe7c6870c9c55358124e61330560d6d0f2c", "url": "https://github.com/elastic/elasticsearch/commit/995f2fe7c6870c9c55358124e61330560d6d0f2c", "message": "Integ Test", "committedDate": "2020-07-16T09:51:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI1MDkxNg==", "url": "https://github.com/elastic/elasticsearch/pull/59693#discussion_r456250916", "bodyText": "Speaking from personal preference, I think this is trying too hard to use a Matcher, and it would be more readable to use a different style.\nFor example, we know exactly what results are expected, so we can check the number of hits & then we can sort the hits and check that each element is what we expect it to be.\nAlso, I may be mistaken because all the casting of JSON is a bit hard to read, but I think you have a type mismatch here.\nIf hits is List<Map<String, Map<String, Object>>>\nthen each element is Map<String, Map<String, Object>>\nbut in the Matcher, you cast actual to Map<String, Object> and check that some of the values are strings.\nI think hits needs to be List<Map<String, ?>> or List<Map<String, Object>>", "author": "tvernum", "createdAt": "2020-07-17T06:47:00Z", "path": "x-pack/plugin/async-search/qa/security/src/test/java/org/elasticsearch/xpack/search/AsyncSearchSecurityIT.java", "diffHunk": "@@ -57,9 +63,64 @@ public void indexDocuments() throws IOException {\n \n         createIndex(\"index-user2\", Settings.EMPTY);\n         index(\"index-user2\", \"0\", \"foo\", \"bar\");\n+        index(\"index-user2\", \"1\", \"bar\", \"baz\");\n         refresh(\"index-user2\");\n     }\n \n+    public void testWithDlsAndFls() throws Exception {\n+        Response submitResp = submitAsyncSearch(\"*\", \"*\", TimeValue.timeValueSeconds(10), \"user_dls\");\n+        assertOK(submitResp);\n+        Map<String, Object> submitRespMap = toMap(submitResp);\n+        List<Map<String, Map<String, Object>>> hits = extractHits(submitRespMap);\n+        assertThat(hits, contains(new BaseMatcher<>() {\n+            @Override\n+            @SuppressWarnings(\"unchecked\")\n+            public boolean matches(Object actual) {\n+                if (actual instanceof Map) {\n+                    Map<String, Object> searchHit = (Map<String, Object>) actual;\n+                    return \"index\".equals(searchHit.get(\"_index\")) &&\n+                            \"1\".equals(searchHit.get(\"_id\")) &&\n+                            ((Map<String, Object>) searchHit.get(\"_source\")).isEmpty();\n+                }\n+                return false;\n+            }", "originalCommit": "995f2fe7c6870c9c55358124e61330560d6d0f2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQwMjA2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59693#discussion_r456402065", "bodyText": "Okay, I have polished the test code here.\nI've parsed the response to the actual AsyncSearchResponse so it doesn't deal with Maps and casts, but I've kept the collection matcher which now uses CustomMatcher elements which is simpler. I like this over sorting, because I don't know how to sort results across indices, and it feels contrived.", "author": "albertzaharovits", "createdAt": "2020-07-17T12:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI1MDkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI1MTQyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/59693#discussion_r456251425", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                // the same as the user that submitted the original request so we can skip security here.\n          \n          \n            \n                                // the same as the user that submitted the original request so no additional checks are needed here.", "author": "tvernum", "createdAt": "2020-07-17T06:48:20Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/RBACEngine.java", "diffHunk": "@@ -269,8 +269,14 @@ public void authorizeIndexAction(RequestInfo requestInfo, AuthorizationInfo auth\n                     listener.onResponse(new IndexAuthorizationResult(true, IndicesAccessControl.ALLOW_NO_INDICES));\n                 }\n             } else if (isAsyncRelatedAction(action)) {\n-                //index-level permissions are handled by the search action that is triggered internally by the submit API.\n-                listener.onResponse(new IndexAuthorizationResult(true, IndicesAccessControl.ALLOW_NO_INDICES));\n+                if (SubmitAsyncSearchAction.NAME.equals(action)) {\n+                    // authorize submit async search but don't fill in the DLS/FLS permissions\n+                    listener.onResponse(new IndexAuthorizationResult(true, null));\n+                } else {\n+                    // async-search actions other than submit have a custom security layer that checks if the current user is\n+                    // the same as the user that submitted the original request so we can skip security here.", "originalCommit": "995f2fe7c6870c9c55358124e61330560d6d0f2c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI1MjAyNw==", "url": "https://github.com/elastic/elasticsearch/pull/59693#discussion_r456252027", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                // authorize submit async search but don't fill in the DLS/FLS permissions\n          \n          \n            \n                                // authorize submit async search but don't fill in the DLS/FLS permissions\n          \n          \n            \n                                // the null IndicesAccessControl parameter indicates that this action has *not* determined \n          \n          \n            \n                                // which DLS/FLS controls should be applied to this action", "author": "tvernum", "createdAt": "2020-07-17T06:49:48Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/RBACEngine.java", "diffHunk": "@@ -269,8 +269,14 @@ public void authorizeIndexAction(RequestInfo requestInfo, AuthorizationInfo auth\n                     listener.onResponse(new IndexAuthorizationResult(true, IndicesAccessControl.ALLOW_NO_INDICES));\n                 }\n             } else if (isAsyncRelatedAction(action)) {\n-                //index-level permissions are handled by the search action that is triggered internally by the submit API.\n-                listener.onResponse(new IndexAuthorizationResult(true, IndicesAccessControl.ALLOW_NO_INDICES));\n+                if (SubmitAsyncSearchAction.NAME.equals(action)) {\n+                    // authorize submit async search but don't fill in the DLS/FLS permissions", "originalCommit": "995f2fe7c6870c9c55358124e61330560d6d0f2c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8a7f56240684f130e26f50f70bc9a0db260cd342", "url": "https://github.com/elastic/elasticsearch/commit/8a7f56240684f130e26f50f70bc9a0db260cd342", "message": "Merge branch 'master' into authz_submit_async_for_DLS", "committedDate": "2020-07-17T09:42:29Z", "type": "commit"}, {"oid": "2eb976bce4064b3becf6978344e122fce0305f78", "url": "https://github.com/elastic/elasticsearch/commit/2eb976bce4064b3becf6978344e122fce0305f78", "message": "Review", "committedDate": "2020-07-17T12:11:25Z", "type": "commit"}]}