{"pr_number": 64417, "pr_title": "Change deprecation indexing to use a custom template", "pr_createdAt": "2020-10-30T13:57:25Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64417", "timeline": [{"oid": "d1ae1f33134597123e3a1b2ad70fe14ec8177759", "url": "https://github.com/elastic/elasticsearch/commit/d1ae1f33134597123e3a1b2ad70fe14ec8177759", "message": "Change deprecation indexing to use its own templates, not the stack ones", "committedDate": "2020-10-28T13:26:37Z", "type": "commit"}, {"oid": "3f54368f3abc3207c6fb0d2401adb0750cae2828", "url": "https://github.com/elastic/elasticsearch/commit/3f54368f3abc3207c6fb0d2401adb0750cae2828", "message": "Merge remote-tracking branch 'upstream/master' into deprecation-indexing-custom-template", "committedDate": "2020-10-30T12:08:57Z", "type": "commit"}, {"oid": "64f4d292578728f3ff59815bdfc9b47cb5dea74e", "url": "https://github.com/elastic/elasticsearch/commit/64f4d292578728f3ff59815bdfc9b47cb5dea74e", "message": "Mark the deprecation logs data stream as hidden", "committedDate": "2020-10-30T13:53:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE1MzgxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64417#discussion_r515153815", "bodyText": "we create more fields from our logs. Do we have to define them in the mappings too?", "author": "pgomulka", "createdAt": "2020-10-30T14:51:08Z", "path": "x-pack/plugin/core/src/main/resources/org/elasticsearch/xpack/deprecation/deprecation-indexing-mappings.json", "diffHunk": "@@ -0,0 +1,60 @@\n+{\n+  \"template\": {\n+    \"mappings\": {\n+      \"dynamic_templates\": [\n+        {\n+          \"strings_as_keyword\": {\n+            \"mapping\": {\n+              \"ignore_above\": 1024,\n+              \"type\": \"keyword\"\n+            },\n+            \"match_mapping_type\": \"string\"\n+          }\n+        }\n+      ],\n+      \"date_detection\": false,\n+      \"properties\": {", "originalCommit": "64f4d292578728f3ff59815bdfc9b47cb5dea74e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI0MTQ0MA==", "url": "https://github.com/elastic/elasticsearch/pull/64417#discussion_r515241440", "bodyText": "The dynamic_templates part should take care of those.", "author": "pugnascotia", "createdAt": "2020-10-30T16:58:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE1MzgxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE3NDE5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64417#discussion_r515174191", "bodyText": "This should not be overridden to true, since in a rolling environment a 7.11 node could start logging deprecation messages that are indexed prior to the master node being upgraded (meaning that the templates would not be in place), so the messages could end up not being indexed correctly", "author": "dakrone", "createdAt": "2020-10-30T15:18:17Z", "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/logging/DeprecationIndexingTemplateRegistry.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.deprecation.logging;\n+\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.xpack.core.template.IndexTemplateConfig;\n+import org.elasticsearch.xpack.core.template.IndexTemplateRegistry;\n+import org.elasticsearch.xpack.core.template.LifecyclePolicyConfig;\n+\n+import java.util.List;\n+\n+import static org.elasticsearch.xpack.core.ClientHelper.DEPRECATION_ORIGIN;\n+\n+/**\n+ * Manages the index template and associated ILM policy for deprecation log indexing.\n+ */\n+public class DeprecationIndexingTemplateRegistry extends IndexTemplateRegistry {\n+    // history (please add a comment why you increased the version here)\n+    // version 1: initial\n+    public static final int INDEX_TEMPLATE_VERSION = 1;\n+\n+    public static final String DEPRECATION_INDEXING_TEMPLATE_VERSION_VARIABLE = \"xpack.deprecation.indexing.template.version\";\n+\n+    public static final String DEPRECATION_INDEXING_MAPPINGS_NAME = \".deprecation-indexing-mappings\";\n+    public static final String DEPRECATION_INDEXING_SETTINGS_NAME = \".deprecation-indexing-settings\";\n+    public static final String DEPRECATION_INDEXING_TEMPLATE_NAME = \".deprecation-indexing-template\";\n+    public static final String DEPRECATION_INDEXING_POLICY_NAME = \".deprecation-indexing-ilm-policy\";\n+\n+    @Override\n+    protected boolean requiresMasterNode() {\n+        return true;", "originalCommit": "64f4d292578728f3ff59815bdfc9b47cb5dea74e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a2ecfe1cbd2a9f80fbb3cd905c6f5a548fb7a780", "url": "https://github.com/elastic/elasticsearch/commit/a2ecfe1cbd2a9f80fbb3cd905c6f5a548fb7a780", "message": "Review feedback", "committedDate": "2020-10-30T16:57:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA2MzY0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64417#discussion_r516063649", "bodyText": "This is a breaking change now, since deprecation logging went into effect in 7.10, and we're changing the index name, are we sure we're okay with the breaking change in a minor release? I'm not sure we should?", "author": "dakrone", "createdAt": "2020-11-02T15:45:37Z", "path": "x-pack/plugin/core/src/main/resources/org/elasticsearch/xpack/deprecation/deprecation-indexing-template.json", "diffHunk": "@@ -0,0 +1,17 @@\n+{\n+  \"index_patterns\": [\".logs-deprecation-elasticsearch\"],", "originalCommit": "a2ecfe1cbd2a9f80fbb3cd905c6f5a548fb7a780", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4NTY2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64417#discussion_r516085667", "bodyText": "I yanked it from 7.10 so it hasn't been released yet. This will be the first release in 7.11.", "author": "pugnascotia", "createdAt": "2020-11-02T16:16:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA2MzY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA5ODkxNw==", "url": "https://github.com/elastic/elasticsearch/pull/64417#discussion_r516098917", "bodyText": "Sounds good, I was going based on the PRs but didn't realize it had been pulled, LGTM then.", "author": "dakrone", "createdAt": "2020-11-02T16:34:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA2MzY0OQ=="}], "type": "inlineReview"}]}