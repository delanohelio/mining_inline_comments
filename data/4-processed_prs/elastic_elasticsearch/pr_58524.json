{"pr_number": 58524, "pr_title": "Map only specific type of OIDC Claims", "pr_createdAt": "2020-06-25T05:55:22Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58524", "timeline": [{"oid": "e93302d0d1c05b90a80bf331c70a1ec1f560eeed", "url": "https://github.com/elastic/elasticsearch/commit/e93302d0d1c05b90a80bf331c70a1ec1f560eeed", "message": "Map only specific type of OIDC Claims\n\nThis commit changes our behavior in 2 ways:\n\n- When mapping claims to user properties ( principal, email, groups,\nname), we only handle string and array of string type. Previously\nwe would fail to recognize an array of other types and that would\ncause failures when trying to cast to String.\n- When adding unmapped claims to the user metadata, we only handle\nstring, number, boolean and arrays of these. Previously, we would\nfail to recognize an array of other types and that would cause\nfailures when attempting to process role mappings.\n\nFor user properties that are inherently single valued, like\nprincipal(username) we continue to support arrays of strings where\nwe select the first one in case this is being depended on by users\nbut we plan on removing this leniency in the next major release.", "committedDate": "2020-06-23T12:42:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMzNTc1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/58524#discussion_r445335757", "bodyText": "I think we probably want to ensure that these are homogenous collections. I don't know how we would make sense of [ \"1\", true, 1.0 ]", "author": "tvernum", "createdAt": "2020-06-25T06:33:48Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectRealm.java", "diffHunk": "@@ -385,6 +381,15 @@ public void close() {\n         openIdConnectAuthenticator.close();\n     }\n \n+    /*\n+     * We only map claims that are of Type String, Boolean, or Number, or arrays that contain only these types\n+     */\n+    private static boolean isAllowedTypeForClaim(Object o) {\n+        return (o instanceof String || o instanceof Boolean || o instanceof Number\n+            || (o instanceof Collection && ((Collection) o).stream()\n+            .allMatch(c -> c instanceof String || c instanceof Boolean || c instanceof Number)));", "originalCommit": "e93302d0d1c05b90a80bf331c70a1ec1f560eeed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk2MDY5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/58524#discussion_r445960697", "bodyText": "think we probably want to ensure that these are heterogenous collections.\n\nYou used Greek so I get to be pedantic \ud83c\udf89 s/heterogeneous/homogeneous/ :)\nIn all seriousness, I took a lenient stance here on purpose for metadata ( as opposed to user properties where I allowed only strings ).\n\nI don't know how we would make sense of [ \"1\", true, 1.0 ]\n\n\nMetadata can be used as metadata, for informational purposes so we do not necessarily need to make sense of the value of a given key.\nIt would work in a role mapping rule such as\n\n\"rules\" : { \"field\" : { \"groups\" : \"1\" } },\n\nhappy to reconsider if you think this would cause an issue somewhere else or that it is too lenient for the sake of being lenient but I don't see any specific problem with it as is", "author": "jkakavas", "createdAt": "2020-06-26T04:26:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMzNTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk3ODA4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/58524#discussion_r445978082", "bodyText": "My comment clearly says homogeneous \ud83d\ude08\nFair enough - as long as it's a considered position, I'm not worried.", "author": "tvernum", "createdAt": "2020-06-26T05:41:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMzNTc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMjc4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/58524#discussion_r445902787", "bodyText": "The new validateClaimType method does not assert claimValueObject is a List. In theory it could be a Set or a Number.", "author": "ywangd", "createdAt": "2020-06-26T00:07:18Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectRealm.java", "diffHunk": "@@ -461,18 +477,15 @@ static ClaimParser forSetting(Logger logger, OpenIdConnectRealmSettings.ClaimSet\n                         \"OpenID Connect Claim [\" + claimName + \"] for [\" + setting.name(realmConfig) + \"]\",\n                         claims -> {\n                             Object claimValueObject = claims.getClaim(claimName);\n+                            validateClaimType(claimValueObject, RealmSettings.getFullSettingKey(realmConfig, setting.getClaim()));\n                             if (claimValueObject == null) {\n                                 return List.of();\n                             } else if (claimValueObject instanceof String) {\n                                 return List.of((String) claimValueObject);\n-                            } else if (claimValueObject instanceof List == false) {\n-                                throw new SettingsException(\"Setting [\" + RealmSettings.getFullSettingKey(realmConfig, setting.getClaim())\n-                                    + \" expects a claim with String or a String Array value but found a \"\n-                                    + claimValueObject.getClass().getName());\n                             }\n                             return ((List<String>) claimValueObject).stream()", "originalCommit": "e93302d0d1c05b90a80bf331c70a1ec1f560eeed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk2MzE3NA==", "url": "https://github.com/elastic/elasticsearch/pull/58524#discussion_r445963174", "bodyText": "validateClaimType right above validates that is either a Collection or a String. Then, if this is not a String, it is a Collection. How could it get to be a Set or a Number ? Maybe I didn't get what you mean", "author": "jkakavas", "createdAt": "2020-06-26T04:38:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwMjc4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNDEzNw==", "url": "https://github.com/elastic/elasticsearch/pull/58524#discussion_r445904137", "bodyText": "I'd prefer a more descriptive method name if possible. The current feels like it will validate the claim value is a certain specified type. But it really just asserts the value is either:\n\nA String or\nIf it is a collection, it must be a collection of String\n\nNow I am not sure if this is what we really want? Is it OK if the value is a Number?", "author": "ywangd", "createdAt": "2020-06-26T00:12:39Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectRealm.java", "diffHunk": "@@ -412,6 +417,15 @@ public String toString() {\n             return name;\n         }\n \n+        private static void validateClaimType(Object claimValueObject, String settingKey) {\n+            if (claimValueObject instanceof String == false &&", "originalCommit": "e93302d0d1c05b90a80bf331c70a1ec1f560eeed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk1ODQ1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/58524#discussion_r445958452", "bodyText": "Hey can you elaborate on what you mean be \"descriptive\" here? The method does what it intends to do as described in the PR description:\n\nWhen mapping claims to user properties ( principal, email, groups,\nname), we only handle string and array of string type. Previously\nwe would fail to recognize an array of other types and that would\ncause failures when trying to cast to String.\n\nDoing so, seems to me to be \"Validating the type of the claim value\" and as such validateClaimType seems appropriate. What would be an alternative that you are more comfortable with ?", "author": "jkakavas", "createdAt": "2020-06-26T04:16:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNDEzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk2MDU4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/58524#discussion_r445960587", "bodyText": "What I mean is the name gave me the first impression that the signature would be something like:\nvoid validateCliamType(Object value, Class<?> type)\nBut instead the type is not specified but should always be String or collection of it. So I'd personally prefer something like validateParsableClaim.", "author": "ywangd", "createdAt": "2020-06-26T04:26:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNDEzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk2MjQyMA==", "url": "https://github.com/elastic/elasticsearch/pull/58524#discussion_r445962420", "bodyText": "Fair enough, I don't necessarily agree that validateClaimType is off :) but I don't dislike validateParsableClaim enough to fortify my hill :)", "author": "jkakavas", "createdAt": "2020-06-26T04:35:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNDEzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk2NDYyNA==", "url": "https://github.com/elastic/elasticsearch/pull/58524#discussion_r445964624", "bodyText": "Thanks Ioannis. The more important piece of my comment here is about the behaviour, i.e. the if check does not seem to do what we want to ensure, i.e. String or Collection<String>:\nclaimValueObject instanceof String == false && \nclaimValueObject instanceof Collection && \n((Collection) claimValueObject).stream().allMatch(c -> c instanceof String) == false\nIf the value is a Number, the if branch will not be executed, i.e. a Number will be considered as parsable.", "author": "ywangd", "createdAt": "2020-06-26T04:44:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNDEzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk2NjYxMA==", "url": "https://github.com/elastic/elasticsearch/pull/58524#discussion_r445966610", "bodyText": "Aha! Now I saw it , thanks, will address", "author": "jkakavas", "createdAt": "2020-06-26T04:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNDEzNw=="}], "type": "inlineReview"}, {"oid": "4274675db37b510adb9fe33dae1e403034c2059f", "url": "https://github.com/elastic/elasticsearch/commit/4274675db37b510adb9fe33dae1e403034c2059f", "message": "address feedback", "committedDate": "2020-06-29T14:59:33Z", "type": "commit"}, {"oid": "f1b35898cdbfb9f2cd233510fb4b79ff727b6d5f", "url": "https://github.com/elastic/elasticsearch/commit/f1b35898cdbfb9f2cd233510fb4b79ff727b6d5f", "message": "unused import", "committedDate": "2020-06-29T15:02:54Z", "type": "commit"}, {"oid": "1c02a7d9af48ceb1070ec57749802ea4bfb9d1d7", "url": "https://github.com/elastic/elasticsearch/commit/1c02a7d9af48ceb1070ec57749802ea4bfb9d1d7", "message": "Merge remote-tracking branch 'origin/master' into claims-mapping-changes", "committedDate": "2020-06-29T15:23:18Z", "type": "commit"}, {"oid": "fd030f04477ba244fb0ab193f3ffdcec8c35f3b5", "url": "https://github.com/elastic/elasticsearch/commit/fd030f04477ba244fb0ab193f3ffdcec8c35f3b5", "message": "Don't try to validate null claims", "committedDate": "2020-06-29T20:43:11Z", "type": "commit"}, {"oid": "cb9e3f2532e1af157432ed46f213b5bc57677350", "url": "https://github.com/elastic/elasticsearch/commit/cb9e3f2532e1af157432ed46f213b5bc57677350", "message": "fix parsing and validation logic", "committedDate": "2020-06-29T22:32:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYxNTUwOA==", "url": "https://github.com/elastic/elasticsearch/pull/58524#discussion_r447615508", "bodyText": "The check claimValueObject instanceof Collection is performed twice, which does not seem to be necessary\nThe if check only ensure it is a Collection<String>, not a List<String>. So there is a theoretical possibility for cast exception.\n\nI feel this part of code can be simplified to something like the follows:\n} else if (claimValueObject instanceof Collection && ((Collection) claimValueObject).stream().allMatch(c -> c instanceof String)) {\n    values = (Collection<String>) claimValueObject;\n} else {\n    throw new SettingsException(\"Setting [ \" + settingKey + \" expects a claim with String or a String Array value\");\n}\nWith above change, the return type of this method needs to be changed to Collection<String> as well.", "author": "ywangd", "createdAt": "2020-06-30T11:37:10Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectRealm.java", "diffHunk": "@@ -412,6 +417,25 @@ public String toString() {\n             return name;\n         }\n \n+        private static List<String> parseClaimValues(JWTClaimsSet claimsSet, String claimName, String settingKey) {\n+            List<String> values;\n+            final Object claimValueObject = claimsSet.getClaim(claimName);\n+            if (claimValueObject == null) {\n+                values = List.of();\n+            } else if (claimValueObject instanceof String) {\n+                values = List.of((String) claimValueObject);\n+            } else if (claimValueObject instanceof Collection) {\n+                if (claimValueObject instanceof Collection && ((Collection) claimValueObject).stream().allMatch(c -> c instanceof String)) {\n+                    values = (List<String>) claimValueObject;\n+                } else {\n+                    throw new SettingsException(\"Setting [ \" + settingKey + \" expects a claim with String or a String Array value\");\n+                }\n+            } else {\n+                throw new SettingsException(\"Setting [ \" + settingKey + \" expects a claim with String or a String Array value\");\n+            }", "originalCommit": "cb9e3f2532e1af157432ed46f213b5bc57677350", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzMDM3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/58524#discussion_r447630372", "bodyText": "Yeap you are right. In retrospect, I should have waited to fix this today and not last night. Thanks for calling me out !", "author": "jkakavas", "createdAt": "2020-06-30T12:05:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYxNTUwOA=="}], "type": "inlineReview"}, {"oid": "ee0b57b30743c15824a5d0623b846f439605a416", "url": "https://github.com/elastic/elasticsearch/commit/ee0b57b30743c15824a5d0623b846f439605a416", "message": "address feedback", "committedDate": "2020-06-30T12:10:10Z", "type": "commit"}, {"oid": "2499dc23447d9a2d244493004a1141e7aa51d43c", "url": "https://github.com/elastic/elasticsearch/commit/2499dc23447d9a2d244493004a1141e7aa51d43c", "message": "checkstyle", "committedDate": "2020-06-30T12:17:15Z", "type": "commit"}, {"oid": "41aeec604099efb3a0c4775f8d45f8cebf4192eb", "url": "https://github.com/elastic/elasticsearch/commit/41aeec604099efb3a0c4775f8d45f8cebf4192eb", "message": "Merge remote-tracking branch 'origin/master' into claims-mapping-changes", "committedDate": "2020-06-30T12:44:51Z", "type": "commit"}]}