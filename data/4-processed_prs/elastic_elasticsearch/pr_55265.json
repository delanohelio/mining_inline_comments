{"pr_number": 55265, "pr_title": "Add open reader contexts API", "pr_createdAt": "2020-04-15T19:33:29Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55265", "timeline": [{"oid": "5b7795456e5dc1e4a7140560ef7bb26444a891ef", "url": "https://github.com/elastic/elasticsearch/commit/5b7795456e5dc1e4a7140560ef7bb26444a891ef", "message": "Add open reader contexts API", "committedDate": "2020-04-15T19:31:11Z", "type": "commit"}, {"oid": "0e6ecf685e94695c75f0944a5cbcecbed42df0dc", "url": "https://github.com/elastic/elasticsearch/commit/0e6ecf685e94695c75f0944a5cbcecbed42df0dc", "message": "fix tests", "committedDate": "2020-04-15T21:27:11Z", "type": "commit"}, {"oid": "5a06793f84471f8fae8cc449c548d5805b207471", "url": "https://github.com/elastic/elasticsearch/commit/5a06793f84471f8fae8cc449c548d5805b207471", "message": "Merge branch 'feature/reader-context' into create-reader-contexts", "committedDate": "2020-04-15T21:47:17Z", "type": "commit"}, {"oid": "00b13d9fa148ab4cd978d3ef583aaee35c64b369", "url": "https://github.com/elastic/elasticsearch/commit/00b13d9fa148ab4cd978d3ef583aaee35c64b369", "message": "bypass shard_open_reader action", "committedDate": "2020-04-15T22:45:51Z", "type": "commit"}, {"oid": "295dfc432d04e0d607b7740212fd9a0f2c27b32a", "url": "https://github.com/elastic/elasticsearch/commit/295dfc432d04e0d607b7740212fd9a0f2c27b32a", "message": "Merge branch 'feature/reader-context' into create-reader-contexts", "committedDate": "2020-04-17T19:42:41Z", "type": "commit"}, {"oid": "52a6d15a5b523047c3f375e6e63110e1d1831194", "url": "https://github.com/elastic/elasticsearch/commit/52a6d15a5b523047c3f375e6e63110e1d1831194", "message": "stronger check", "committedDate": "2020-04-17T19:58:36Z", "type": "commit"}, {"oid": "7008ed6b3e95b7b25f02dbf203e261f586145beb", "url": "https://github.com/elastic/elasticsearch/commit/7008ed6b3e95b7b25f02dbf203e261f586145beb", "message": "fix single session", "committedDate": "2020-04-17T21:03:04Z", "type": "commit"}, {"oid": "cfa0881a806a83eab397f3443fe13dfb9c07648f", "url": "https://github.com/elastic/elasticsearch/commit/cfa0881a806a83eab397f3443fe13dfb9c07648f", "message": "request with reader ignore can_match phase", "committedDate": "2020-04-18T02:40:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAwMTE5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55265#discussion_r411001196", "bodyText": "I wonder if we should always throw an error if there is no concrete indices that match ?", "author": "jimczi", "createdAt": "2020-04-19T22:00:38Z", "path": "rest-api-spec/src/main/resources/rest-api-spec/api/open_reader.json", "diffHunk": "@@ -0,0 +1,65 @@\n+{\n+  \"open_reader\":{\n+    \"documentation\":{\n+      \"url\":\"https://www.elastic.co/guide/en/elasticsearch/reference/master/reader-context.html\",\n+      \"description\":\"Open and keep point-in-time readers that can be used in subsequent search requests\"\n+    },\n+    \"stability\":\"beta\",\n+    \"url\":{\n+      \"paths\":[\n+        {\n+          \"path\":\"/_open_reader\",\n+          \"methods\":[\n+            \"POST\"\n+          ]\n+        },\n+        {\n+          \"path\":\"/{index}/_open_reader\",\n+          \"methods\":[\n+            \"POST\"\n+          ],\n+          \"parts\":{\n+            \"index\":{\n+              \"type\":\"list\",\n+              \"description\":\"A comma-separated list of index names to search; use `_all` or empty string to perform the operation on all indices\"\n+            }\n+          }\n+        }\n+      ]\n+    },\n+    \"params\":{\n+      \"preference\":{\n+        \"type\":\"string\",\n+        \"description\":\"Specify the node or shard the operation should be performed on (default: random)\"\n+      },\n+      \"routing\":{\n+        \"type\":\"string\",\n+        \"description\":\"Specific routing value\"\n+      },\n+      \"ignore_unavailable\":{\n+        \"type\":\"boolean\",\n+        \"description\":\"Whether specified concrete indices should be ignored when unavailable (missing or closed)\"\n+      },\n+      \"allow_no_indices\":{", "originalCommit": "cfa0881a806a83eab397f3443fe13dfb9c07648f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5MzE4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/55265#discussion_r411493187", "bodyText": "Removed in 51ddf77", "author": "dnhatn", "createdAt": "2020-04-20T15:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAwMTE5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAwMTQ1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/55265#discussion_r411001452", "bodyText": "We should also check if scroll is not set ?", "author": "jimczi", "createdAt": "2020-04-19T22:02:12Z", "path": "server/src/main/java/org/elasticsearch/action/search/SearchRequest.java", "diffHunk": "@@ -283,9 +283,15 @@ public ActionRequestValidationException validate() {\n                 validationException = source.aggregations().validate(validationException);\n             }\n         }\n-        if (reader() != null && reader().getId() != null) {\n+        if (reader() != null) {\n             if (indices.length > 0) {\n-                validationException = addValidationError(\"[indices] cannot be used with reader contexts\", validationException);\n+                validationException = addValidationError(\"[index] cannot be used with reader contexts\", validationException);\n+            }\n+            if (routing() != null) {\n+                validationException = addValidationError(\"[routing] cannot be used with reader contexts\", validationException);\n+            }\n+            if (preference() != null) {\n+                validationException = addValidationError(\"[preference] cannot be used with reader contexts\", validationException);\n             }", "originalCommit": "cfa0881a806a83eab397f3443fe13dfb9c07648f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5Mjg5NA==", "url": "https://github.com/elastic/elasticsearch/pull/55265#discussion_r411492894", "bodyText": "addressed in b8e523d", "author": "dnhatn", "createdAt": "2020-04-20T15:54:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAwMTQ1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAwMTgxMw==", "url": "https://github.com/elastic/elasticsearch/pull/55265#discussion_r411001813", "bodyText": "We should force indices ?", "author": "jimczi", "createdAt": "2020-04-19T22:04:16Z", "path": "server/src/main/java/org/elasticsearch/rest/action/search/RestOpenReaderAction.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.action.search;\n+\n+import org.elasticsearch.action.search.OpenReaderRequest;\n+import org.elasticsearch.action.search.TransportOpenReaderAction;\n+import org.elasticsearch.action.support.IndicesOptions;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.rest.BaseRestHandler;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import static org.elasticsearch.rest.RestRequest.Method.POST;\n+\n+public class RestOpenReaderAction extends BaseRestHandler {\n+\n+    @Override\n+    public String getName() {\n+        return \"open_reader_action\";\n+    }\n+\n+    @Override\n+    public List<Route> routes() {\n+        return List.of(\n+            new Route(POST, \"/_open_reader\"),", "originalCommit": "cfa0881a806a83eab397f3443fe13dfb9c07648f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5MzQ0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55265#discussion_r411493445", "bodyText": "Adjusted in a74b984.", "author": "dnhatn", "createdAt": "2020-04-20T15:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAwMTgxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAwMjEzMA==", "url": "https://github.com/elastic/elasticsearch/pull/55265#discussion_r411002130", "bodyText": "Is it temporary ? We've said that it should be possible to run the can_match phase as long as we retrieve the reader and extend the keep alive if the request cannot match ?", "author": "jimczi", "createdAt": "2020-04-19T22:06:15Z", "path": "server/src/main/java/org/elasticsearch/search/SearchService.java", "diffHunk": "@@ -1085,6 +1120,7 @@ public AliasFilter buildAliasFilter(ClusterState state, String index, Set<String\n      */\n     public CanMatchResponse canMatch(ShardSearchRequest request) throws IOException {\n         assert request.searchType() == SearchType.QUERY_THEN_FETCH : \"unexpected search type: \" + request.searchType();\n+        assert request.readerId() == null : \"request with reader_id bypass can_match phase\";", "originalCommit": "cfa0881a806a83eab397f3443fe13dfb9c07648f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA1MTc1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55265#discussion_r411051755", "bodyText": "Yes. Once your PR is in, I will update this.", "author": "dnhatn", "createdAt": "2020-04-20T02:20:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAwMjEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQyODgwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/55265#discussion_r411428801", "bodyText": "ok, thanks for confirming", "author": "jimczi", "createdAt": "2020-04-20T14:34:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAwMjEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5MzkxMg==", "url": "https://github.com/elastic/elasticsearch/pull/55265#discussion_r411493912", "bodyText": "I added a TODO: ab7086b", "author": "dnhatn", "createdAt": "2020-04-20T15:56:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAwMjEzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAwMjk4OA==", "url": "https://github.com/elastic/elasticsearch/pull/55265#discussion_r411002988", "bodyText": "I don't think we should do this for ShardOpenReaderRequest. Can we implement IndicesRequest instead so that opening a reader also checks the index permissions ?", "author": "jimczi", "createdAt": "2020-04-19T22:12:15Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/RBACEngine.java", "diffHunk": "@@ -278,7 +278,7 @@ public void authorizeIndexAction(RequestInfo requestInfo, AuthorizationInfo auth\n                     // the same as the user that submitted the original request so we can skip security here.\n                     listener.onResponse(new IndexAuthorizationResult(true, IndicesAccessControl.ALLOW_NO_INDICES));\n                 }\n-            } else if (action.equals(ClearReaderAction.NAME)) {\n+            } else if (isReaderContextsRelatedAction(action)) {", "originalCommit": "cfa0881a806a83eab397f3443fe13dfb9c07648f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTA1MTc4MA==", "url": "https://github.com/elastic/elasticsearch/pull/55265#discussion_r411051780", "bodyText": "Good catch", "author": "dnhatn", "createdAt": "2020-04-20T02:20:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAwMjk4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5MzY0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/55265#discussion_r411493641", "bodyText": "Fixed in 7910087", "author": "dnhatn", "createdAt": "2020-04-20T15:55:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAwMjk4OA=="}], "type": "inlineReview"}, {"oid": "6c7d13c43580b8798977723d107329560cdf7201", "url": "https://github.com/elastic/elasticsearch/commit/6c7d13c43580b8798977723d107329560cdf7201", "message": "Merge branch 'feature/reader-context' into create-reader-contexts", "committedDate": "2020-04-20T15:12:31Z", "type": "commit"}, {"oid": "b8e523de874d57a0c9572c513e5915fda5b596ad", "url": "https://github.com/elastic/elasticsearch/commit/b8e523de874d57a0c9572c513e5915fda5b596ad", "message": "not allow scroll with reader context", "committedDate": "2020-04-20T15:32:22Z", "type": "commit"}, {"oid": "51ddf7759d11214fa602a84290414a5f5f0b3233", "url": "https://github.com/elastic/elasticsearch/commit/51ddf7759d11214fa602a84290414a5f5f0b3233", "message": "do not allow no_indices", "committedDate": "2020-04-20T15:44:38Z", "type": "commit"}, {"oid": "a74b98471a42da415744728821093bdbadee29e4", "url": "https://github.com/elastic/elasticsearch/commit/a74b98471a42da415744728821093bdbadee29e4", "message": "require index explicitly", "committedDate": "2020-04-20T15:46:58Z", "type": "commit"}, {"oid": "791008740df068447f5269ff05a126216eaad70b", "url": "https://github.com/elastic/elasticsearch/commit/791008740df068447f5269ff05a126216eaad70b", "message": "Make it IndicesRequest", "committedDate": "2020-04-20T15:49:13Z", "type": "commit"}, {"oid": "ab7086bd534c673e4b5e7945bee43cc87c0b71f4", "url": "https://github.com/elastic/elasticsearch/commit/ab7086bd534c673e4b5e7945bee43cc87c0b71f4", "message": "add TODO", "committedDate": "2020-04-20T15:53:10Z", "type": "commit"}]}