{"pr_number": 57151, "pr_title": "Remove Mapper.updateFieldType()", "pr_createdAt": "2020-05-26T14:43:28Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57151", "timeline": [{"oid": "7982cf7f3ecfac7336f645fc47f7836bd315afb3", "url": "https://github.com/elastic/elasticsearch/commit/7982cf7f3ecfac7336f645fc47f7836bd315afb3", "message": "Remove Mapper.updateFieldType() (#56986)\n\nWhen we had multiple mapping types, an update to a field in one type had to be\npropagated to the same field in all other types. This was done using the\nMapper.updateFieldType() method, called at the end of a merge. However, now\nthat we only have a single type per index, this method is unnecessary and can\nbe removed.\n\nRelates to #41059", "committedDate": "2020-05-26T14:37:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ2OTA0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57151#discussion_r430469046", "bodyText": "This was testing dead code - we would never update a mapping against a separate type, because the update mappings code already ensures that all updates use the same type name.", "author": "romseygeek", "createdAt": "2020-05-26T14:45:56Z", "path": "server/src/test/java/org/elasticsearch/index/mapper/DynamicMappingTests.java", "diffHunk": "@@ -436,106 +436,6 @@ public void testComplexArray() throws Exception {\n                 .endObject().endObject().endObject()), serialize(update));\n     }\n \n-    public void testReuseExistingMappings() throws IOException, Exception {", "originalCommit": "7982cf7f3ecfac7336f645fc47f7836bd315afb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU4ODgwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/57151#discussion_r430588801", "bodyText": "It would be good to match what we have on master (it's easier to reason about, and makes backport conflicts less likely). On master we've modified the test to focus on a single type -- we could apply the same change here.", "author": "jtibshirani", "createdAt": "2020-05-26T17:36:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ2OTA0Ng=="}], "type": "inlineReview"}, {"oid": "085ddb40790fec28975ba6ba35a2cc10c76fcf74", "url": "https://github.com/elastic/elasticsearch/commit/085ddb40790fec28975ba6ba35a2cc10c76fcf74", "message": "precommit", "committedDate": "2020-05-26T15:11:21Z", "type": "commit"}, {"oid": "a317831b9d1d20c5efc4d564555e690497cc08cb", "url": "https://github.com/elastic/elasticsearch/commit/a317831b9d1d20c5efc4d564555e690497cc08cb", "message": "aggregator test", "committedDate": "2020-05-26T16:03:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU4MjY4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/57151#discussion_r430582682", "bodyText": "Same question here about whether this change is important.", "author": "jtibshirani", "createdAt": "2020-05-26T17:25:43Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -559,29 +547,16 @@ static void validateTypeName(String type) {\n         }\n         if (newMapper != null) {\n             this.mapper = newMapper;\n+            this.fieldTypes = fieldTypes;", "originalCommit": "a317831b9d1d20c5efc4d564555e690497cc08cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU4Mzk0OA==", "url": "https://github.com/elastic/elasticsearch/pull/57151#discussion_r430583948", "bodyText": "I'm wondering if this change is important, where we no longer wrap in an unmodifiable map. If not we could restore it to make the PR more targeted/ precise.", "author": "jtibshirani", "createdAt": "2020-05-26T17:27:53Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -530,18 +530,6 @@ static void validateTypeName(String type) {\n         }\n         checkIndexSortCompatibility(indexSettings.getIndexSortConfig(), hasNested);\n \n-        if (newMapper != null) {\n-            DocumentMapper updatedDocumentMapper = newMapper.updateFieldType(fieldTypes.fullNameToFieldType);\n-            if (updatedDocumentMapper != newMapper) {\n-                // update both mappers and result\n-                newMapper = updatedDocumentMapper;\n-                results.put(updatedDocumentMapper.type(), updatedDocumentMapper);\n-            }\n-        }\n-\n-        // make structures immutable\n-        results = Collections.unmodifiableMap(results);", "originalCommit": "a317831b9d1d20c5efc4d564555e690497cc08cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f332d13c7af7243b19303b950f69eb72d0d69961", "url": "https://github.com/elastic/elasticsearch/commit/f332d13c7af7243b19303b950f69eb72d0d69961", "message": "feedback", "committedDate": "2020-05-26T19:59:36Z", "type": "commit"}]}