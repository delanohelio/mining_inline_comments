{"pr_number": 65668, "pr_title": "Expand docs on disk-based shard allocation", "pr_createdAt": "2020-12-01T11:11:39Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65668", "timeline": [{"oid": "d0e6946c53e0dd3cf382cb9574ef6f7ff96c802a", "url": "https://github.com/elastic/elasticsearch/commit/d0e6946c53e0dd3cf382cb9574ef6f7ff96c802a", "message": "Expand docs on disk-based shard allocation\n\nToday we document the settings used to control rebalancing and\ndisk-based shard allocation but there isn't really any discussion around\nwhat these processes do so it's hard to know what, if any, adjustments\nto make.\n\nThis commit adds some words to help folk understand this area better.", "committedDate": "2020-12-01T10:33:59Z", "type": "commit"}, {"oid": "8985fa1e32e8afd00e030a4e65a80020a47f44e2", "url": "https://github.com/elastic/elasticsearch/commit/8985fa1e32e8afd00e030a4e65a80020a47f44e2", "message": "Every damn time", "committedDate": "2020-12-01T11:23:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQzOTYyMg==", "url": "https://github.com/elastic/elasticsearch/pull/65668#discussion_r533439622", "bodyText": "I think exceed and overage are clearer than breach.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The disk-based shard allocator ensures that all nodes have enough disk space\n          \n          \n            \n            without performing more shard movements than necessary. It allocates shards\n          \n          \n            \n            based on a pair of thresholds known as the _low watermark_ and the _high\n          \n          \n            \n            watermark_. Its primary goal is to ensure that no node breaches the high\n          \n          \n            \n            watermark, or at least that any such breach is only temporary. If a node\n          \n          \n            \n            breaches the high watermark then {es} will solve this by moving some of its\n          \n          \n            \n            shards onto other nodes in the cluster.\n          \n          \n            \n            The disk-based shard allocator ensures that all nodes have enough disk space\n          \n          \n            \n            without performing more shard movements than necessary. It allocates shards\n          \n          \n            \n            based on a pair of thresholds known as the _low watermark_ and the _high\n          \n          \n            \n            watermark_. Its primary goal is to ensure that no node exceeds the high\n          \n          \n            \n            watermark, or at least that any such overage is only temporary. If a node\n          \n          \n            \n            exceeds the high watermark then {es} will solve this by moving some of its\n          \n          \n            \n            shards onto other nodes in the cluster.", "author": "jrodewig", "createdAt": "2020-12-01T14:16:49Z", "path": "docs/reference/modules/cluster/disk_allocator.asciidoc", "diffHunk": "@@ -2,9 +2,60 @@\n ==== Disk-based shard allocation settings\n [[disk-based-shard-allocation-description]]\n // tag::disk-based-shard-allocation-description-tag[]\n-{es} considers the available disk space on a node before deciding\n-whether to allocate new shards to that node or to actively relocate shards away\n-from that node.\n+\n+The <<shards-rebalancing-settings,balance>> of the cluster depends only on the\n+number of shards on each node and the indices to which those shards belong. It\n+considers neither the sizes of these shards nor the available disk space on\n+each node, for the following reasons:\n+\n+* Disk usage changes over time. Balancing the disk usage of individual nodes\n+would require a lot more shard movements, perhaps even wastefully undoing\n+earlier movements. Moving a shard consumes resources such as I/O and network\n+bandwidth and may evict data from the filesystem cache. These resources are\n+better spent handling your searches and indexing where possible.\n+\n+* A cluster with accurately-balanced disk usage typically performs no better\n+than one that has unequal disk usage across its nodes, as long as no disk is\n+too full.\n+\n+The disk-based shard allocator ensures that all nodes have enough disk space\n+without performing more shard movements than necessary. It allocates shards\n+based on a pair of thresholds known as the _low watermark_ and the _high\n+watermark_. Its primary goal is to ensure that no node breaches the high\n+watermark, or at least that any such breach is only temporary. If a node\n+breaches the high watermark then {es} will solve this by moving some of its\n+shards onto other nodes in the cluster.", "originalCommit": "8985fa1e32e8afd00e030a4e65a80020a47f44e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ5OTM5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/65668#discussion_r537499399", "bodyText": "overage yes that's the word I was looking for.", "author": "DaveCTurner", "createdAt": "2020-12-07T13:19:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQzOTYyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ0MjQ5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/65668#discussion_r533442499", "bodyText": "Clears up some language around breach.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            [[disk-based-shard-allocation-does-not-balance]]\n          \n          \n            \n            IMPORTANT: It is completely normal for the nodes in your cluster to be using\n          \n          \n            \n            very different amounts of disk space. As long as any breaches of the high\n          \n          \n            \n            watermark are only temporary, {es} is working as expected.\n          \n          \n            \n            [[disk-based-shard-allocation-does-not-balance]]\n          \n          \n            \n            IMPORTANT: It is normal for a cluster's nodes to use different amounts of disk\n          \n          \n            \n            space. As long as any high watermark overages are temporary, {es} is\n          \n          \n            \n            working as expected.", "author": "jrodewig", "createdAt": "2020-12-01T14:20:42Z", "path": "docs/reference/modules/cluster/disk_allocator.asciidoc", "diffHunk": "@@ -2,9 +2,60 @@\n ==== Disk-based shard allocation settings\n [[disk-based-shard-allocation-description]]\n // tag::disk-based-shard-allocation-description-tag[]\n-{es} considers the available disk space on a node before deciding\n-whether to allocate new shards to that node or to actively relocate shards away\n-from that node.\n+\n+The <<shards-rebalancing-settings,balance>> of the cluster depends only on the\n+number of shards on each node and the indices to which those shards belong. It\n+considers neither the sizes of these shards nor the available disk space on\n+each node, for the following reasons:\n+\n+* Disk usage changes over time. Balancing the disk usage of individual nodes\n+would require a lot more shard movements, perhaps even wastefully undoing\n+earlier movements. Moving a shard consumes resources such as I/O and network\n+bandwidth and may evict data from the filesystem cache. These resources are\n+better spent handling your searches and indexing where possible.\n+\n+* A cluster with accurately-balanced disk usage typically performs no better\n+than one that has unequal disk usage across its nodes, as long as no disk is\n+too full.\n+\n+The disk-based shard allocator ensures that all nodes have enough disk space\n+without performing more shard movements than necessary. It allocates shards\n+based on a pair of thresholds known as the _low watermark_ and the _high\n+watermark_. Its primary goal is to ensure that no node breaches the high\n+watermark, or at least that any such breach is only temporary. If a node\n+breaches the high watermark then {es} will solve this by moving some of its\n+shards onto other nodes in the cluster.\n+\n+NOTE: It is normal for nodes to temporarily exceed the high watermark from time\n+to time.\n+\n+The allocator also tries to keep nodes clear of the high watermark by\n+forbidding the allocation of more shards on a node that exceeds the low\n+watermark. Importantly, if all of your nodes have exceeded the low watermark\n+then no new shards can be allocated and {es} will not be able to move any\n+shards between nodes in order to keep the disk usage below the high watermark.\n+You must ensure that your cluster has enough disk space in total and that that\n+there are always some nodes that are below the low watermark.\n+\n+Shard movements triggered by the disk-based shard allocator must also satisfy\n+all other shard allocation rules such as\n+<<cluster-shard-allocation-filtering,allocation filtering>> and\n+<<forced-awareness,forced awareness>>. If these rules are too strict then they\n+can also prevent the shard movements needed to keep the nodes' disk usage under\n+control.\n+\n+If a node is filling up its disk faster than {es} can move shards elsewhere\n+then there is a risk that the disk will completely fill up. To prevent this, as\n+a last resort, once the disk usage reaches the _flood-stage_ watermark {es}\n+will block further writes to the indices which have a shard on the affected\n+node. It will also continue to move shards onto the other nodes in the cluster.\n+Once the disk usage on the affected node has dropped below the high watermark,\n+the write block will be removed automatically.\n+\n+[[disk-based-shard-allocation-does-not-balance]]\n+IMPORTANT: It is completely normal for the nodes in your cluster to be using\n+very different amounts of disk space. As long as any breaches of the high\n+watermark are only temporary, {es} is working as expected.", "originalCommit": "8985fa1e32e8afd00e030a4e65a80020a47f44e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ0ODk4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/65668#discussion_r533448985", "bodyText": "I wonder if mixing in the concept of balance here is more confusing. We may want to just start with your The disk-based shard allocator... paragraph. The gist of this text seems adequately covered there and in the later admon about unequal disk usage.", "author": "jrodewig", "createdAt": "2020-12-01T14:29:24Z", "path": "docs/reference/modules/cluster/disk_allocator.asciidoc", "diffHunk": "@@ -2,9 +2,60 @@\n ==== Disk-based shard allocation settings\n [[disk-based-shard-allocation-description]]\n // tag::disk-based-shard-allocation-description-tag[]\n-{es} considers the available disk space on a node before deciding\n-whether to allocate new shards to that node or to actively relocate shards away\n-from that node.\n+\n+The <<shards-rebalancing-settings,balance>> of the cluster depends only on the\n+number of shards on each node and the indices to which those shards belong. It\n+considers neither the sizes of these shards nor the available disk space on\n+each node, for the following reasons:", "originalCommit": "8985fa1e32e8afd00e030a4e65a80020a47f44e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUwMjgzNA==", "url": "https://github.com/elastic/elasticsearch/pull/65668#discussion_r537502834", "bodyText": "Hmm, good point about leading with the later paragraph. I'll think about removing this vs moving it elsewhere. It's a common source of confusion that \"balanced\" doesn't mean \"equal disk usage\", I think we need to spell out why that isn't the case. But there's no need to lead with this.", "author": "DaveCTurner", "createdAt": "2020-12-07T13:24:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ0ODk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ1ODE1OA==", "url": "https://github.com/elastic/elasticsearch/pull/65668#discussion_r533458158", "bodyText": "Feels like we should mention data tiers here. In many cases, I imagine the tiers, rather than the cluster, will be balanced.", "author": "jrodewig", "createdAt": "2020-12-01T14:40:36Z", "path": "docs/reference/modules/cluster/shards_allocation.asciidoc", "diffHunk": "@@ -97,9 +97,22 @@ Specify when shard rebalancing is allowed:\n [[shards-rebalancing-heuristics]]\n ==== Shard balancing heuristics settings\n \n-The following settings are used together to determine where to place each\n-shard.  The cluster is balanced when no allowed rebalancing operation can bring the weight\n-of any node closer to the weight of any other node by more than the `balance.threshold`.\n+A cluster is _balanced_ when it has an equal number of shards on each node\n+without having a concentration of shards from any index on any node. {es} runs\n+an automatic process called _rebalancing_ which moves shards between the nodes\n+in your cluster in order to improve its balance. Rebalancing obeys all other\n+shard allocation rules such as <<cluster-shard-allocation-filtering,allocation\n+filtering>> and <<forced-awareness,forced awareness>> which may prevent it from\n+completely balancing the cluster. In that case, rebalancing strives to acheve\n+the most balanced cluster possible within the rules you have configured.", "originalCommit": "8985fa1e32e8afd00e030a4e65a80020a47f44e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ2MTcxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/65668#discussion_r533461719", "bodyText": "Typo\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            You must ensure that your cluster has enough disk space in total and that that\n          \n          \n            \n            You must ensure that your cluster has enough disk space in total and that", "author": "jrodewig", "createdAt": "2020-12-01T14:43:14Z", "path": "docs/reference/modules/cluster/disk_allocator.asciidoc", "diffHunk": "@@ -2,9 +2,60 @@\n ==== Disk-based shard allocation settings\n [[disk-based-shard-allocation-description]]\n // tag::disk-based-shard-allocation-description-tag[]\n-{es} considers the available disk space on a node before deciding\n-whether to allocate new shards to that node or to actively relocate shards away\n-from that node.\n+\n+The <<shards-rebalancing-settings,balance>> of the cluster depends only on the\n+number of shards on each node and the indices to which those shards belong. It\n+considers neither the sizes of these shards nor the available disk space on\n+each node, for the following reasons:\n+\n+* Disk usage changes over time. Balancing the disk usage of individual nodes\n+would require a lot more shard movements, perhaps even wastefully undoing\n+earlier movements. Moving a shard consumes resources such as I/O and network\n+bandwidth and may evict data from the filesystem cache. These resources are\n+better spent handling your searches and indexing where possible.\n+\n+* A cluster with accurately-balanced disk usage typically performs no better\n+than one that has unequal disk usage across its nodes, as long as no disk is\n+too full.\n+\n+The disk-based shard allocator ensures that all nodes have enough disk space\n+without performing more shard movements than necessary. It allocates shards\n+based on a pair of thresholds known as the _low watermark_ and the _high\n+watermark_. Its primary goal is to ensure that no node breaches the high\n+watermark, or at least that any such breach is only temporary. If a node\n+breaches the high watermark then {es} will solve this by moving some of its\n+shards onto other nodes in the cluster.\n+\n+NOTE: It is normal for nodes to temporarily exceed the high watermark from time\n+to time.\n+\n+The allocator also tries to keep nodes clear of the high watermark by\n+forbidding the allocation of more shards on a node that exceeds the low\n+watermark. Importantly, if all of your nodes have exceeded the low watermark\n+then no new shards can be allocated and {es} will not be able to move any\n+shards between nodes in order to keep the disk usage below the high watermark.\n+You must ensure that your cluster has enough disk space in total and that that", "originalCommit": "8985fa1e32e8afd00e030a4e65a80020a47f44e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ2MTkxNA==", "url": "https://github.com/elastic/elasticsearch/pull/65668#discussion_r533461914", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            there are always some nodes that are below the low watermark.\n          \n          \n            \n            there are always some nodes below the low watermark.", "author": "jrodewig", "createdAt": "2020-12-01T14:43:23Z", "path": "docs/reference/modules/cluster/disk_allocator.asciidoc", "diffHunk": "@@ -2,9 +2,60 @@\n ==== Disk-based shard allocation settings\n [[disk-based-shard-allocation-description]]\n // tag::disk-based-shard-allocation-description-tag[]\n-{es} considers the available disk space on a node before deciding\n-whether to allocate new shards to that node or to actively relocate shards away\n-from that node.\n+\n+The <<shards-rebalancing-settings,balance>> of the cluster depends only on the\n+number of shards on each node and the indices to which those shards belong. It\n+considers neither the sizes of these shards nor the available disk space on\n+each node, for the following reasons:\n+\n+* Disk usage changes over time. Balancing the disk usage of individual nodes\n+would require a lot more shard movements, perhaps even wastefully undoing\n+earlier movements. Moving a shard consumes resources such as I/O and network\n+bandwidth and may evict data from the filesystem cache. These resources are\n+better spent handling your searches and indexing where possible.\n+\n+* A cluster with accurately-balanced disk usage typically performs no better\n+than one that has unequal disk usage across its nodes, as long as no disk is\n+too full.\n+\n+The disk-based shard allocator ensures that all nodes have enough disk space\n+without performing more shard movements than necessary. It allocates shards\n+based on a pair of thresholds known as the _low watermark_ and the _high\n+watermark_. Its primary goal is to ensure that no node breaches the high\n+watermark, or at least that any such breach is only temporary. If a node\n+breaches the high watermark then {es} will solve this by moving some of its\n+shards onto other nodes in the cluster.\n+\n+NOTE: It is normal for nodes to temporarily exceed the high watermark from time\n+to time.\n+\n+The allocator also tries to keep nodes clear of the high watermark by\n+forbidding the allocation of more shards on a node that exceeds the low\n+watermark. Importantly, if all of your nodes have exceeded the low watermark\n+then no new shards can be allocated and {es} will not be able to move any\n+shards between nodes in order to keep the disk usage below the high watermark.\n+You must ensure that your cluster has enough disk space in total and that that\n+there are always some nodes that are below the low watermark.", "originalCommit": "8985fa1e32e8afd00e030a4e65a80020a47f44e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ2NDExOQ==", "url": "https://github.com/elastic/elasticsearch/pull/65668#discussion_r533464119", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            will block further writes to the indices which have a shard on the affected\n          \n          \n            \n            will block writes to indices with a shard on the affected", "author": "jrodewig", "createdAt": "2020-12-01T14:44:59Z", "path": "docs/reference/modules/cluster/disk_allocator.asciidoc", "diffHunk": "@@ -2,9 +2,60 @@\n ==== Disk-based shard allocation settings\n [[disk-based-shard-allocation-description]]\n // tag::disk-based-shard-allocation-description-tag[]\n-{es} considers the available disk space on a node before deciding\n-whether to allocate new shards to that node or to actively relocate shards away\n-from that node.\n+\n+The <<shards-rebalancing-settings,balance>> of the cluster depends only on the\n+number of shards on each node and the indices to which those shards belong. It\n+considers neither the sizes of these shards nor the available disk space on\n+each node, for the following reasons:\n+\n+* Disk usage changes over time. Balancing the disk usage of individual nodes\n+would require a lot more shard movements, perhaps even wastefully undoing\n+earlier movements. Moving a shard consumes resources such as I/O and network\n+bandwidth and may evict data from the filesystem cache. These resources are\n+better spent handling your searches and indexing where possible.\n+\n+* A cluster with accurately-balanced disk usage typically performs no better\n+than one that has unequal disk usage across its nodes, as long as no disk is\n+too full.\n+\n+The disk-based shard allocator ensures that all nodes have enough disk space\n+without performing more shard movements than necessary. It allocates shards\n+based on a pair of thresholds known as the _low watermark_ and the _high\n+watermark_. Its primary goal is to ensure that no node breaches the high\n+watermark, or at least that any such breach is only temporary. If a node\n+breaches the high watermark then {es} will solve this by moving some of its\n+shards onto other nodes in the cluster.\n+\n+NOTE: It is normal for nodes to temporarily exceed the high watermark from time\n+to time.\n+\n+The allocator also tries to keep nodes clear of the high watermark by\n+forbidding the allocation of more shards on a node that exceeds the low\n+watermark. Importantly, if all of your nodes have exceeded the low watermark\n+then no new shards can be allocated and {es} will not be able to move any\n+shards between nodes in order to keep the disk usage below the high watermark.\n+You must ensure that your cluster has enough disk space in total and that that\n+there are always some nodes that are below the low watermark.\n+\n+Shard movements triggered by the disk-based shard allocator must also satisfy\n+all other shard allocation rules such as\n+<<cluster-shard-allocation-filtering,allocation filtering>> and\n+<<forced-awareness,forced awareness>>. If these rules are too strict then they\n+can also prevent the shard movements needed to keep the nodes' disk usage under\n+control.\n+\n+If a node is filling up its disk faster than {es} can move shards elsewhere\n+then there is a risk that the disk will completely fill up. To prevent this, as\n+a last resort, once the disk usage reaches the _flood-stage_ watermark {es}\n+will block further writes to the indices which have a shard on the affected", "originalCommit": "8985fa1e32e8afd00e030a4e65a80020a47f44e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ2NDU5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65668#discussion_r533464593", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            the write block will be removed automatically.\n          \n          \n            \n            {es} automatically removes the write block.", "author": "jrodewig", "createdAt": "2020-12-01T14:45:20Z", "path": "docs/reference/modules/cluster/disk_allocator.asciidoc", "diffHunk": "@@ -2,9 +2,60 @@\n ==== Disk-based shard allocation settings\n [[disk-based-shard-allocation-description]]\n // tag::disk-based-shard-allocation-description-tag[]\n-{es} considers the available disk space on a node before deciding\n-whether to allocate new shards to that node or to actively relocate shards away\n-from that node.\n+\n+The <<shards-rebalancing-settings,balance>> of the cluster depends only on the\n+number of shards on each node and the indices to which those shards belong. It\n+considers neither the sizes of these shards nor the available disk space on\n+each node, for the following reasons:\n+\n+* Disk usage changes over time. Balancing the disk usage of individual nodes\n+would require a lot more shard movements, perhaps even wastefully undoing\n+earlier movements. Moving a shard consumes resources such as I/O and network\n+bandwidth and may evict data from the filesystem cache. These resources are\n+better spent handling your searches and indexing where possible.\n+\n+* A cluster with accurately-balanced disk usage typically performs no better\n+than one that has unequal disk usage across its nodes, as long as no disk is\n+too full.\n+\n+The disk-based shard allocator ensures that all nodes have enough disk space\n+without performing more shard movements than necessary. It allocates shards\n+based on a pair of thresholds known as the _low watermark_ and the _high\n+watermark_. Its primary goal is to ensure that no node breaches the high\n+watermark, or at least that any such breach is only temporary. If a node\n+breaches the high watermark then {es} will solve this by moving some of its\n+shards onto other nodes in the cluster.\n+\n+NOTE: It is normal for nodes to temporarily exceed the high watermark from time\n+to time.\n+\n+The allocator also tries to keep nodes clear of the high watermark by\n+forbidding the allocation of more shards on a node that exceeds the low\n+watermark. Importantly, if all of your nodes have exceeded the low watermark\n+then no new shards can be allocated and {es} will not be able to move any\n+shards between nodes in order to keep the disk usage below the high watermark.\n+You must ensure that your cluster has enough disk space in total and that that\n+there are always some nodes that are below the low watermark.\n+\n+Shard movements triggered by the disk-based shard allocator must also satisfy\n+all other shard allocation rules such as\n+<<cluster-shard-allocation-filtering,allocation filtering>> and\n+<<forced-awareness,forced awareness>>. If these rules are too strict then they\n+can also prevent the shard movements needed to keep the nodes' disk usage under\n+control.\n+\n+If a node is filling up its disk faster than {es} can move shards elsewhere\n+then there is a risk that the disk will completely fill up. To prevent this, as\n+a last resort, once the disk usage reaches the _flood-stage_ watermark {es}\n+will block further writes to the indices which have a shard on the affected\n+node. It will also continue to move shards onto the other nodes in the cluster.\n+Once the disk usage on the affected node has dropped below the high watermark,\n+the write block will be removed automatically.", "originalCommit": "8985fa1e32e8afd00e030a4e65a80020a47f44e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ2NjYwMg==", "url": "https://github.com/elastic/elasticsearch/pull/65668#discussion_r533466602", "bodyText": "shards onto other nodes in the cluster.\n\nShould we replace cluster with data tier here?", "author": "jrodewig", "createdAt": "2020-12-01T14:46:49Z", "path": "docs/reference/modules/cluster/disk_allocator.asciidoc", "diffHunk": "@@ -2,9 +2,60 @@\n ==== Disk-based shard allocation settings\n [[disk-based-shard-allocation-description]]\n // tag::disk-based-shard-allocation-description-tag[]\n-{es} considers the available disk space on a node before deciding\n-whether to allocate new shards to that node or to actively relocate shards away\n-from that node.\n+\n+The <<shards-rebalancing-settings,balance>> of the cluster depends only on the\n+number of shards on each node and the indices to which those shards belong. It\n+considers neither the sizes of these shards nor the available disk space on\n+each node, for the following reasons:\n+\n+* Disk usage changes over time. Balancing the disk usage of individual nodes\n+would require a lot more shard movements, perhaps even wastefully undoing\n+earlier movements. Moving a shard consumes resources such as I/O and network\n+bandwidth and may evict data from the filesystem cache. These resources are\n+better spent handling your searches and indexing where possible.\n+\n+* A cluster with accurately-balanced disk usage typically performs no better\n+than one that has unequal disk usage across its nodes, as long as no disk is\n+too full.\n+\n+The disk-based shard allocator ensures that all nodes have enough disk space\n+without performing more shard movements than necessary. It allocates shards\n+based on a pair of thresholds known as the _low watermark_ and the _high\n+watermark_. Its primary goal is to ensure that no node breaches the high\n+watermark, or at least that any such breach is only temporary. If a node\n+breaches the high watermark then {es} will solve this by moving some of its\n+shards onto other nodes in the cluster.", "originalCommit": "8985fa1e32e8afd00e030a4e65a80020a47f44e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUwMDc4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65668#discussion_r537500783", "bodyText": "This all applies whether you're using data tiers or not (e.g. you're running an OSS build). However I agree that we can mention data tiers somewhere, and IMO it fits better into the section lower down about allocation filtering rules.", "author": "DaveCTurner", "createdAt": "2020-12-07T13:21:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ2NjYwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ2NzQxNg==", "url": "https://github.com/elastic/elasticsearch/pull/65668#discussion_r533467416", "bodyText": "Another opportunity to mention data tiers.", "author": "jrodewig", "createdAt": "2020-12-01T14:47:26Z", "path": "docs/reference/modules/cluster/disk_allocator.asciidoc", "diffHunk": "@@ -2,9 +2,60 @@\n ==== Disk-based shard allocation settings\n [[disk-based-shard-allocation-description]]\n // tag::disk-based-shard-allocation-description-tag[]\n-{es} considers the available disk space on a node before deciding\n-whether to allocate new shards to that node or to actively relocate shards away\n-from that node.\n+\n+The <<shards-rebalancing-settings,balance>> of the cluster depends only on the\n+number of shards on each node and the indices to which those shards belong. It\n+considers neither the sizes of these shards nor the available disk space on\n+each node, for the following reasons:\n+\n+* Disk usage changes over time. Balancing the disk usage of individual nodes\n+would require a lot more shard movements, perhaps even wastefully undoing\n+earlier movements. Moving a shard consumes resources such as I/O and network\n+bandwidth and may evict data from the filesystem cache. These resources are\n+better spent handling your searches and indexing where possible.\n+\n+* A cluster with accurately-balanced disk usage typically performs no better\n+than one that has unequal disk usage across its nodes, as long as no disk is\n+too full.\n+\n+The disk-based shard allocator ensures that all nodes have enough disk space\n+without performing more shard movements than necessary. It allocates shards\n+based on a pair of thresholds known as the _low watermark_ and the _high\n+watermark_. Its primary goal is to ensure that no node breaches the high\n+watermark, or at least that any such breach is only temporary. If a node\n+breaches the high watermark then {es} will solve this by moving some of its\n+shards onto other nodes in the cluster.\n+\n+NOTE: It is normal for nodes to temporarily exceed the high watermark from time\n+to time.\n+\n+The allocator also tries to keep nodes clear of the high watermark by\n+forbidding the allocation of more shards on a node that exceeds the low\n+watermark. Importantly, if all of your nodes have exceeded the low watermark\n+then no new shards can be allocated and {es} will not be able to move any\n+shards between nodes in order to keep the disk usage below the high watermark.\n+You must ensure that your cluster has enough disk space in total and that that\n+there are always some nodes that are below the low watermark.\n+\n+Shard movements triggered by the disk-based shard allocator must also satisfy\n+all other shard allocation rules such as\n+<<cluster-shard-allocation-filtering,allocation filtering>> and\n+<<forced-awareness,forced awareness>>. If these rules are too strict then they\n+can also prevent the shard movements needed to keep the nodes' disk usage under\n+control.", "originalCommit": "8985fa1e32e8afd00e030a4e65a80020a47f44e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ2ODI4OA==", "url": "https://github.com/elastic/elasticsearch/pull/65668#discussion_r533468288", "bodyText": "Nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            in your cluster in order to improve its balance. Rebalancing obeys all other\n          \n          \n            \n            in your cluster to improve its balance. Rebalancing obeys all other", "author": "jrodewig", "createdAt": "2020-12-01T14:48:07Z", "path": "docs/reference/modules/cluster/shards_allocation.asciidoc", "diffHunk": "@@ -97,9 +97,22 @@ Specify when shard rebalancing is allowed:\n [[shards-rebalancing-heuristics]]\n ==== Shard balancing heuristics settings\n \n-The following settings are used together to determine where to place each\n-shard.  The cluster is balanced when no allowed rebalancing operation can bring the weight\n-of any node closer to the weight of any other node by more than the `balance.threshold`.\n+A cluster is _balanced_ when it has an equal number of shards on each node\n+without having a concentration of shards from any index on any node. {es} runs\n+an automatic process called _rebalancing_ which moves shards between the nodes\n+in your cluster in order to improve its balance. Rebalancing obeys all other", "originalCommit": "8985fa1e32e8afd00e030a4e65a80020a47f44e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ3NjMyNw==", "url": "https://github.com/elastic/elasticsearch/pull/65668#discussion_r533476327", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Once the disk usage on the affected node has dropped below the high watermark,\n          \n          \n            \n            When disk usage on the affected node drops below the high watermark,", "author": "jrodewig", "createdAt": "2020-12-01T14:57:10Z", "path": "docs/reference/modules/cluster/disk_allocator.asciidoc", "diffHunk": "@@ -2,9 +2,60 @@\n ==== Disk-based shard allocation settings\n [[disk-based-shard-allocation-description]]\n // tag::disk-based-shard-allocation-description-tag[]\n-{es} considers the available disk space on a node before deciding\n-whether to allocate new shards to that node or to actively relocate shards away\n-from that node.\n+\n+The <<shards-rebalancing-settings,balance>> of the cluster depends only on the\n+number of shards on each node and the indices to which those shards belong. It\n+considers neither the sizes of these shards nor the available disk space on\n+each node, for the following reasons:\n+\n+* Disk usage changes over time. Balancing the disk usage of individual nodes\n+would require a lot more shard movements, perhaps even wastefully undoing\n+earlier movements. Moving a shard consumes resources such as I/O and network\n+bandwidth and may evict data from the filesystem cache. These resources are\n+better spent handling your searches and indexing where possible.\n+\n+* A cluster with accurately-balanced disk usage typically performs no better\n+than one that has unequal disk usage across its nodes, as long as no disk is\n+too full.\n+\n+The disk-based shard allocator ensures that all nodes have enough disk space\n+without performing more shard movements than necessary. It allocates shards\n+based on a pair of thresholds known as the _low watermark_ and the _high\n+watermark_. Its primary goal is to ensure that no node breaches the high\n+watermark, or at least that any such breach is only temporary. If a node\n+breaches the high watermark then {es} will solve this by moving some of its\n+shards onto other nodes in the cluster.\n+\n+NOTE: It is normal for nodes to temporarily exceed the high watermark from time\n+to time.\n+\n+The allocator also tries to keep nodes clear of the high watermark by\n+forbidding the allocation of more shards on a node that exceeds the low\n+watermark. Importantly, if all of your nodes have exceeded the low watermark\n+then no new shards can be allocated and {es} will not be able to move any\n+shards between nodes in order to keep the disk usage below the high watermark.\n+You must ensure that your cluster has enough disk space in total and that that\n+there are always some nodes that are below the low watermark.\n+\n+Shard movements triggered by the disk-based shard allocator must also satisfy\n+all other shard allocation rules such as\n+<<cluster-shard-allocation-filtering,allocation filtering>> and\n+<<forced-awareness,forced awareness>>. If these rules are too strict then they\n+can also prevent the shard movements needed to keep the nodes' disk usage under\n+control.\n+\n+If a node is filling up its disk faster than {es} can move shards elsewhere\n+then there is a risk that the disk will completely fill up. To prevent this, as\n+a last resort, once the disk usage reaches the _flood-stage_ watermark {es}\n+will block further writes to the indices which have a shard on the affected\n+node. It will also continue to move shards onto the other nodes in the cluster.\n+Once the disk usage on the affected node has dropped below the high watermark,", "originalCommit": "8985fa1e32e8afd00e030a4e65a80020a47f44e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "67a9e61585dce5833a2ce0d378022fe740d310bf", "url": "https://github.com/elastic/elasticsearch/commit/67a9e61585dce5833a2ce0d378022fe740d310bf", "message": "Apply suggestions from code review\n\nCo-authored-by: James Rodewig <40268737+jrodewig@users.noreply.github.com>", "committedDate": "2020-12-07T13:22:38Z", "type": "commit"}, {"oid": "b21fa1e7d001594fed8286633d25e70f72ae48ff", "url": "https://github.com/elastic/elasticsearch/commit/b21fa1e7d001594fed8286633d25e70f72ae48ff", "message": "Move balance-based intro lower down", "committedDate": "2020-12-07T13:44:47Z", "type": "commit"}, {"oid": "c3c38e493e3aae83ac894622f07fcb8b8b864c9b", "url": "https://github.com/elastic/elasticsearch/commit/c3c38e493e3aae83ac894622f07fcb8b8b864c9b", "message": "Mention data tiers w.r.t. disk allocation and balancing", "committedDate": "2020-12-07T13:52:58Z", "type": "commit"}, {"oid": "c59d8ae8237edce23a86e2964154e94f202045cf", "url": "https://github.com/elastic/elasticsearch/commit/c59d8ae8237edce23a86e2964154e94f202045cf", "message": "Better location for balancing intro", "committedDate": "2020-12-07T14:30:20Z", "type": "commit"}, {"oid": "331e9b6b386f8cb133ad07c74bfb1754152afa76", "url": "https://github.com/elastic/elasticsearch/commit/331e9b6b386f8cb133ad07c74bfb1754152afa76", "message": "on -> to; reformat", "committedDate": "2020-12-07T14:31:18Z", "type": "commit"}]}