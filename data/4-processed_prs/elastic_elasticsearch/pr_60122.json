{"pr_number": 60122, "pr_title": "Clean existing index folder when loading searchable snapshot", "pr_createdAt": "2020-07-23T13:46:07Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60122", "timeline": [{"oid": "be6004b0fdfe8b371c714cbdf298d51ddd06d199", "url": "https://github.com/elastic/elasticsearch/commit/be6004b0fdfe8b371c714cbdf298d51ddd06d199", "message": "Clean existing index folder when loading searchable snapshot", "committedDate": "2020-07-23T13:41:33Z", "type": "commit"}, {"oid": "7f50a36d6c9cca16d4e5481ffb4b3f3f4d1924ee", "url": "https://github.com/elastic/elasticsearch/commit/7f50a36d6c9cca16d4e5481ffb4b3f3f4d1924ee", "message": "Merge remote-tracking branch 'elastic/master' into clean-existing-index-files", "committedDate": "2020-07-28T07:58:41Z", "type": "commit"}, {"oid": "705f14613ed9c98548ff692445038f24d573c215", "url": "https://github.com/elastic/elasticsearch/commit/705f14613ed9c98548ff692445038f24d573c215", "message": "fix test", "committedDate": "2020-07-28T08:07:05Z", "type": "commit"}, {"oid": "e87fcb1888f482e9b1a50435c470a9cce4b662cf", "url": "https://github.com/elastic/elasticsearch/commit/e87fcb1888f482e9b1a50435c470a9cce4b662cf", "message": "one more test", "committedDate": "2020-07-28T08:16:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY3OTM4MA==", "url": "https://github.com/elastic/elasticsearch/pull/60122#discussion_r461679380", "bodyText": "Should this be randomBoolean() instead of false?", "author": "DaveCTurner", "createdAt": "2020-07-28T15:38:22Z", "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -126,7 +133,14 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n         assertThat(snapshotInfo.successfulShards(), greaterThan(0));\n         assertThat(snapshotInfo.successfulShards(), equalTo(snapshotInfo.totalShards()));\n \n-        assertAcked(client().admin().indices().prepareDelete(indexName));\n+        assertShardFolders(indexName, false);\n+\n+        final boolean deletedBeforeMount = false;", "originalCommit": "e87fcb1888f482e9b1a50435c470a9cce4b662cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMDI1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/60122#discussion_r461710252", "bodyText": "indeed. Leftover from manual testing", "author": "ywelsch", "createdAt": "2020-07-28T16:23:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY3OTM4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY4NTQwNA==", "url": "https://github.com/elastic/elasticsearch/pull/60122#discussion_r461685404", "bodyText": "Can we assert that we actually asserted this on the right number of nodes (or at least one node)? Just to make sure this isn't vacuous.", "author": "DaveCTurner", "createdAt": "2020-07-28T15:47:00Z", "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -275,6 +292,29 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n \n     }\n \n+    private void assertShardFolders(String indexName, boolean snapshotDirectory) throws IOException {\n+        final Index restoredIndex = resolveIndex(indexName);\n+        final ShardId shardId = new ShardId(restoredIndex, 0);\n+        for (String node : internalCluster().getNodeNames()) {\n+            final NodeEnvironment service = internalCluster().getInstance(NodeEnvironment.class, node);\n+            final ShardPath shardPath = ShardPath.loadShardPath(logger, service, shardId, null);\n+            if (shardPath != null && Files.exists(shardPath.getDataPath())) {\n+                assertEquals(snapshotDirectory, Files.notExists(shardPath.resolveIndex()));", "originalCommit": "e87fcb1888f482e9b1a50435c470a9cce4b662cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMDMzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/60122#discussion_r461710331", "bodyText": "good idea", "author": "ywelsch", "createdAt": "2020-07-28T16:23:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY4NTQwNA=="}], "type": "inlineReview"}, {"oid": "a8461d1ec364ffb71d1e14a945f077719f376f6a", "url": "https://github.com/elastic/elasticsearch/commit/a8461d1ec364ffb71d1e14a945f077719f376f6a", "message": "review cmments", "committedDate": "2020-07-28T16:22:12Z", "type": "commit"}, {"oid": "445fca95e8abc3db546e6353005461f04baa281c", "url": "https://github.com/elastic/elasticsearch/commit/445fca95e8abc3db546e6353005461f04baa281c", "message": "Merge remote-tracking branch 'elastic/master' into clean-existing-index-files", "committedDate": "2020-07-28T16:22:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA4MzU4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/60122#discussion_r462083581", "bodyText": "Ah sorry another lost randomBoolean() here, and I'm guessing that deletedBeforeMount doesn't make sense if restoring into a different index name.", "author": "DaveCTurner", "createdAt": "2020-07-29T07:06:17Z", "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -77,7 +84,7 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n         final String fsRepoName = randomAlphaOfLength(10);\n         final String indexName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n         final String aliasName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n-        final String restoredIndexName = randomBoolean() ? indexName : randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        final String restoredIndexName = true ? indexName : randomAlphaOfLength(10).toLowerCase(Locale.ROOT);", "originalCommit": "445fca95e8abc3db546e6353005461f04baa281c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEyMjEyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/60122#discussion_r462122129", "bodyText": "Thanks, I've updated and fixed the test to take all situations properly into account. I've also left the deletedBeforeMount + different index name situation in there (just for completeness, even if it's not the most interesting scenario to test).", "author": "ywelsch", "createdAt": "2020-07-29T08:17:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA4MzU4MQ=="}], "type": "inlineReview"}, {"oid": "070d93c038553296b530e2c688afdc5b613cea1b", "url": "https://github.com/elastic/elasticsearch/commit/070d93c038553296b530e2c688afdc5b613cea1b", "message": "fix test", "committedDate": "2020-07-29T08:16:00Z", "type": "commit"}, {"oid": "012b711b561a00d3bf18a9f9a84e5d251ee6118c", "url": "https://github.com/elastic/elasticsearch/commit/012b711b561a00d3bf18a9f9a84e5d251ee6118c", "message": "so much fun fighting our tooling", "committedDate": "2020-07-29T08:35:51Z", "type": "commit"}]}