{"pr_number": 64252, "pr_title": "Move watcher history to data stream ", "pr_createdAt": "2020-10-27T22:11:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64252", "timeline": [{"oid": "d7f05a1c9e8b2388053ccc19af4837a7755282e2", "url": "https://github.com/elastic/elasticsearch/commit/d7f05a1c9e8b2388053ccc19af4837a7755282e2", "message": "Hidden data streams", "committedDate": "2020-10-21T10:54:44Z", "type": "commit"}, {"oid": "b182d368e25d0b4122f311e39ffb74407f7c3045", "url": "https://github.com/elastic/elasticsearch/commit/b182d368e25d0b4122f311e39ffb74407f7c3045", "message": "whitespace reverted", "committedDate": "2020-10-21T11:00:48Z", "type": "commit"}, {"oid": "100dba5f3c9561a2e8bc5c52bffa5881c114b6c7", "url": "https://github.com/elastic/elasticsearch/commit/100dba5f3c9561a2e8bc5c52bffa5881c114b6c7", "message": "stricter ds name", "committedDate": "2020-10-21T11:27:29Z", "type": "commit"}, {"oid": "0d778f54aa069ed0763122630dcf6d41da48ccd2", "url": "https://github.com/elastic/elasticsearch/commit/0d778f54aa069ed0763122630dcf6d41da48ccd2", "message": "Revert \"stricter ds name\"\n\nThis reverts commit 100dba5f3c9561a2e8bc5c52bffa5881c114b6c7.", "committedDate": "2020-10-21T11:30:04Z", "type": "commit"}, {"oid": "98e45c5229ed6dc52a4ad04f430c3256d8ef2c39", "url": "https://github.com/elastic/elasticsearch/commit/98e45c5229ed6dc52a4ad04f430c3256d8ef2c39", "message": "String.format removed", "committedDate": "2020-10-21T11:55:28Z", "type": "commit"}, {"oid": "cf74871a0b506ee4264a5ff3e33c27cfb2bbf113", "url": "https://github.com/elastic/elasticsearch/commit/cf74871a0b506ee4264a5ff3e33c27cfb2bbf113", "message": "fix test", "committedDate": "2020-10-21T15:00:03Z", "type": "commit"}, {"oid": "a856a8f464f82f397319fbece6c95154fca51c87", "url": "https://github.com/elastic/elasticsearch/commit/a856a8f464f82f397319fbece6c95154fca51c87", "message": "fix GetDataStream action", "committedDate": "2020-10-21T21:44:47Z", "type": "commit"}, {"oid": "4a0e20d82c30988faacead6b4eb9b7d018655a11", "url": "https://github.com/elastic/elasticsearch/commit/4a0e20d82c30988faacead6b4eb9b7d018655a11", "message": "fix test", "committedDate": "2020-10-22T10:25:43Z", "type": "commit"}, {"oid": "19af04d6bdfa19eb5fd802f44ecdb9596adaa45d", "url": "https://github.com/elastic/elasticsearch/commit/19af04d6bdfa19eb5fd802f44ecdb9596adaa45d", "message": "fix test", "committedDate": "2020-10-22T10:47:02Z", "type": "commit"}, {"oid": "5b940396e55367fa7013b2f758c2240d68b14d10", "url": "https://github.com/elastic/elasticsearch/commit/5b940396e55367fa7013b2f758c2240d68b14d10", "message": "rest test", "committedDate": "2020-10-22T11:52:09Z", "type": "commit"}, {"oid": "44415330000762b72aa94ccab65141524f75be54", "url": "https://github.com/elastic/elasticsearch/commit/44415330000762b72aa94ccab65141524f75be54", "message": "rest test", "committedDate": "2020-10-22T12:09:32Z", "type": "commit"}, {"oid": "404d3417b3a38fb52cce82a31540c4eb6a3fc4c0", "url": "https://github.com/elastic/elasticsearch/commit/404d3417b3a38fb52cce82a31540c4eb6a3fc4c0", "message": "spotless", "committedDate": "2020-10-22T14:51:34Z", "type": "commit"}, {"oid": "0059e16b4cc949c13c040a3ef2581862fdd5bfd2", "url": "https://github.com/elastic/elasticsearch/commit/0059e16b4cc949c13c040a3ef2581862fdd5bfd2", "message": "tests", "committedDate": "2020-10-22T20:23:46Z", "type": "commit"}, {"oid": "2c540befc03fd767a3efb74a56865a6e7467f211", "url": "https://github.com/elastic/elasticsearch/commit/2c540befc03fd767a3efb74a56865a6e7467f211", "message": "Merge remote-tracking branch 'origin/master' into hidden-data-streams", "committedDate": "2020-10-22T20:26:10Z", "type": "commit"}, {"oid": "54dddc4c27590407e731c7cfade5427e33d9fdcb", "url": "https://github.com/elastic/elasticsearch/commit/54dddc4c27590407e731c7cfade5427e33d9fdcb", "message": "Delete a.json", "committedDate": "2020-10-22T21:49:14Z", "type": "commit"}, {"oid": "63c0702224915b8186632c57a11976c9776626dc", "url": "https://github.com/elastic/elasticsearch/commit/63c0702224915b8186632c57a11976c9776626dc", "message": "added expand_wildcards for GetDataStream and DeleteDataStream", "committedDate": "2020-10-26T10:42:26Z", "type": "commit"}, {"oid": "dd9afafe7a4771d76059bf306423cd843464f1fe", "url": "https://github.com/elastic/elasticsearch/commit/dd9afafe7a4771d76059bf306423cd843464f1fe", "message": "unused imports", "committedDate": "2020-10-26T10:56:46Z", "type": "commit"}, {"oid": "6152f02629d28c659b6ddb6d0faa1c0863d4a481", "url": "https://github.com/elastic/elasticsearch/commit/6152f02629d28c659b6ddb6d0faa1c0863d4a481", "message": "Merge remote-tracking branch 'origin/master' into hidden-data-streams", "committedDate": "2020-10-26T12:50:47Z", "type": "commit"}, {"oid": "4e71b539b8fe85a442af9d4f0119b97a5b92e707", "url": "https://github.com/elastic/elasticsearch/commit/4e71b539b8fe85a442af9d4f0119b97a5b92e707", "message": "add hidden setting to data stream template", "committedDate": "2020-10-26T22:28:27Z", "type": "commit"}, {"oid": "f00df2d4b67b524bf6a299b04cdc6654652d42ea", "url": "https://github.com/elastic/elasticsearch/commit/f00df2d4b67b524bf6a299b04cdc6654652d42ea", "message": "fix expand_wildcards", "committedDate": "2020-10-26T22:55:31Z", "type": "commit"}, {"oid": "b92f159f2131a48f4a07dc356231bc8f90ac48ba", "url": "https://github.com/elastic/elasticsearch/commit/b92f159f2131a48f4a07dc356231bc8f90ac48ba", "message": "Merge remote-tracking branch 'origin/master' into hidden-data-streams", "committedDate": "2020-10-26T23:04:19Z", "type": "commit"}, {"oid": "194b49291705a88efb26de18b333efff377af756", "url": "https://github.com/elastic/elasticsearch/commit/194b49291705a88efb26de18b333efff377af756", "message": "spotless", "committedDate": "2020-10-26T23:05:35Z", "type": "commit"}, {"oid": "66c8d585874dcb8197e664cae0e5d86cb5f7c86a", "url": "https://github.com/elastic/elasticsearch/commit/66c8d585874dcb8197e664cae0e5d86cb5f7c86a", "message": "fix compilation", "committedDate": "2020-10-26T23:15:38Z", "type": "commit"}, {"oid": "d0ee5e7134272be2abc1fa127376b335d603614b", "url": "https://github.com/elastic/elasticsearch/commit/d0ee5e7134272be2abc1fa127376b335d603614b", "message": "unused import", "committedDate": "2020-10-26T23:23:53Z", "type": "commit"}, {"oid": "72add9202709c615f6780c9c52c24548317bbcbf", "url": "https://github.com/elastic/elasticsearch/commit/72add9202709c615f6780c9c52c24548317bbcbf", "message": "yaml test", "committedDate": "2020-10-26T23:49:51Z", "type": "commit"}, {"oid": "cfe3b643712d0fa0f2cd3735f49292d0776a9e5b", "url": "https://github.com/elastic/elasticsearch/commit/cfe3b643712d0fa0f2cd3735f49292d0776a9e5b", "message": "fix test", "committedDate": "2020-10-26T23:56:00Z", "type": "commit"}, {"oid": "247524445b67923d0f4ce629a10b09fc73a5e7bb", "url": "https://github.com/elastic/elasticsearch/commit/247524445b67923d0f4ce629a10b09fc73a5e7bb", "message": "fix cleanup", "committedDate": "2020-10-27T09:53:48Z", "type": "commit"}, {"oid": "136011dfddd25d5fdf3c098182c98f82cb20b67e", "url": "https://github.com/elastic/elasticsearch/commit/136011dfddd25d5fdf3c098182c98f82cb20b67e", "message": "Move watcher history to data stream", "committedDate": "2020-10-27T22:05:12Z", "type": "commit"}, {"oid": "df8eba6969bfa832ade48af130fbf4c6496ee5e1", "url": "https://github.com/elastic/elasticsearch/commit/df8eba6969bfa832ade48af130fbf4c6496ee5e1", "message": "unused import", "committedDate": "2020-10-27T22:23:17Z", "type": "commit"}, {"oid": "c9de8640aa760ec510cb34aa64df219097ce7078", "url": "https://github.com/elastic/elasticsearch/commit/c9de8640aa760ec510cb34aa64df219097ce7078", "message": "fixed wipeDataStream", "committedDate": "2020-10-28T00:17:12Z", "type": "commit"}, {"oid": "e9ee0f3545ea2e716f8cd7e4c2f3c8cb682b7bfa", "url": "https://github.com/elastic/elasticsearch/commit/e9ee0f3545ea2e716f8cd7e4c2f3c8cb682b7bfa", "message": "fix doc test", "committedDate": "2020-10-28T00:26:23Z", "type": "commit"}, {"oid": "3654fe66c23fd88caa6486a45161430a41a5cbdf", "url": "https://github.com/elastic/elasticsearch/commit/3654fe66c23fd88caa6486a45161430a41a5cbdf", "message": "fix doc test", "committedDate": "2020-10-28T00:28:12Z", "type": "commit"}, {"oid": "ffa01638e4e94e89cbb9d8754b49d7f9333ff95e", "url": "https://github.com/elastic/elasticsearch/commit/ffa01638e4e94e89cbb9d8754b49d7f9333ff95e", "message": "fix test", "committedDate": "2020-10-28T00:48:31Z", "type": "commit"}, {"oid": "2078e956b5d3ad0e12ce9368ca89253a83c5da57", "url": "https://github.com/elastic/elasticsearch/commit/2078e956b5d3ad0e12ce9368ca89253a83c5da57", "message": "checkstyle", "committedDate": "2020-10-28T08:08:52Z", "type": "commit"}, {"oid": "c89f592dd03730565f29a60af22c32cb5f7c26e4", "url": "https://github.com/elastic/elasticsearch/commit/c89f592dd03730565f29a60af22c32cb5f7c26e4", "message": "fix cleanup", "committedDate": "2020-10-28T09:58:16Z", "type": "commit"}, {"oid": "c97a41de94a4e7e09d6c5246815da846ba7795ac", "url": "https://github.com/elastic/elasticsearch/commit/c97a41de94a4e7e09d6c5246815da846ba7795ac", "message": "Merge remote-tracking branch 'origin/master' into watcher-history-data-stream2", "committedDate": "2020-10-28T12:23:24Z", "type": "commit"}, {"oid": "070cbf3e27d8d504c23d24fd06112e8065cb1ade", "url": "https://github.com/elastic/elasticsearch/commit/070cbf3e27d8d504c23d24fd06112e8065cb1ade", "message": "Merge remote-tracking branch 'origin/master' into hidden-data-streams", "committedDate": "2020-10-28T12:25:15Z", "type": "commit"}, {"oid": "a6b533bc9af30884e1887e43ca2e8fa72c759d23", "url": "https://github.com/elastic/elasticsearch/commit/a6b533bc9af30884e1887e43ca2e8fa72c759d23", "message": "flush history during pause", "committedDate": "2020-10-29T11:42:45Z", "type": "commit"}, {"oid": "da08544a515fa5e6791caf076e5e62776461006e", "url": "https://github.com/elastic/elasticsearch/commit/da08544a515fa5e6791caf076e5e62776461006e", "message": "fix test", "committedDate": "2020-10-29T12:50:29Z", "type": "commit"}, {"oid": "ff845eb1f51de26af4aa0bb187f90fda74ff58fd", "url": "https://github.com/elastic/elasticsearch/commit/ff845eb1f51de26af4aa0bb187f90fda74ff58fd", "message": "review", "committedDate": "2020-10-30T00:53:37Z", "type": "commit"}, {"oid": "b9fc82d71e4db7ac2498c011b9af3af1e1cda503", "url": "https://github.com/elastic/elasticsearch/commit/b9fc82d71e4db7ac2498c011b9af3af1e1cda503", "message": "Merge branch 'master' into hidden-data-streams", "committedDate": "2020-10-30T07:39:57Z", "type": "commit"}, {"oid": "8ffd4445f069e9d9a89c7dae00f4c7c7634aaab7", "url": "https://github.com/elastic/elasticsearch/commit/8ffd4445f069e9d9a89c7dae00f4c7c7634aaab7", "message": "compilation fix", "committedDate": "2020-10-30T07:48:11Z", "type": "commit"}, {"oid": "d3d5a6a4096b8564bf21524fd2f8e9f232601107", "url": "https://github.com/elastic/elasticsearch/commit/d3d5a6a4096b8564bf21524fd2f8e9f232601107", "message": "fix javadoc", "committedDate": "2020-10-30T07:53:29Z", "type": "commit"}, {"oid": "9a9700ad6eba31868ca8467393e268778fbd1ce5", "url": "https://github.com/elastic/elasticsearch/commit/9a9700ad6eba31868ca8467393e268778fbd1ce5", "message": "fix javadoc", "committedDate": "2020-10-30T07:57:28Z", "type": "commit"}, {"oid": "b9c8694430d4b2f344b712639b4b382098e5f8cf", "url": "https://github.com/elastic/elasticsearch/commit/b9c8694430d4b2f344b712639b4b382098e5f8cf", "message": "Merge branch 'hidden-data-streams' into watcher-history-data-stream2", "committedDate": "2020-10-30T09:57:22Z", "type": "commit"}, {"oid": "59830f104716c5a176e645b319b145b3bf6a6f36", "url": "https://github.com/elastic/elasticsearch/commit/59830f104716c5a176e645b319b145b3bf6a6f36", "message": "Merge remote-tracking branch 'origin/master' into watcher-history-data-stream2", "committedDate": "2020-10-30T11:09:31Z", "type": "commit"}, {"oid": "f8e7d1fcc6687bb941468e47e83e64b88d830a27", "url": "https://github.com/elastic/elasticsearch/commit/f8e7d1fcc6687bb941468e47e83e64b88d830a27", "message": "fix cleanup", "committedDate": "2020-11-05T23:21:28Z", "type": "commit"}, {"oid": "8a440a5f245831c87b817dba4dc9318d8aa27ed3", "url": "https://github.com/elastic/elasticsearch/commit/8a440a5f245831c87b817dba4dc9318d8aa27ed3", "message": "fix opType", "committedDate": "2020-11-06T08:18:24Z", "type": "commit"}, {"oid": "9dc5f17722d3e92c381e2988fc944d2715a1bc41", "url": "https://github.com/elastic/elasticsearch/commit/9dc5f17722d3e92c381e2988fc944d2715a1bc41", "message": "Merge branch 'master' into watcher-history-data-stream2", "committedDate": "2020-11-06T08:41:00Z", "type": "commit"}, {"oid": "35084e8b013266df1de5f4580a2bfdc79196f75a", "url": "https://github.com/elastic/elasticsearch/commit/35084e8b013266df1de5f4580a2bfdc79196f75a", "message": "cleanup", "committedDate": "2020-11-06T09:29:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODcwNTk1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64252#discussion_r518705959", "bodyText": "auto_create_index does not affect the creation of data streams, so it shouldn't be necessary to check for that here.", "author": "danhermann", "createdAt": "2020-11-06T11:57:31Z", "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/Watcher.java", "diffHunk": "@@ -615,14 +615,7 @@ static void validAutoCreateIndex(Settings settings, Logger logger) {\n         indices.add(\".watches\");\n         indices.add(\".triggered_watches\");\n         ZonedDateTime now = ZonedDateTime.now(ZoneOffset.UTC);\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusDays(1)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(1)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(2)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(3)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(4)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(5)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(6)));\n+        indices.add(HistoryStoreField.DATA_STREAM);", "originalCommit": "35084e8b013266df1de5f4580a2bfdc79196f75a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ0MTA4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64252#discussion_r522441087", "bodyText": "Thanks, I've removed it", "author": "probakowski", "createdAt": "2020-11-12T21:36:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODcwNTk1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODcwNzUyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64252#discussion_r518707529", "bodyText": "Out of curiosity, is this addressing a scenario that's specific to data streams or just a general case where history entries weren't being written?", "author": "danhermann", "createdAt": "2020-11-06T12:01:00Z", "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/history/HistoryStore.java", "diffHunk": "@@ -78,9 +76,12 @@ public void forcePut(WatchRecord watchRecord) {\n      * @return true, if history store is ready to be started\n      */\n     public static boolean validate(ClusterState state) {\n-        String currentIndex = HistoryStoreField.getHistoryIndexNameForTime(ZonedDateTime.now(ZoneOffset.UTC));\n-        IndexMetadata indexMetadata = WatchStoreUtils.getConcreteIndex(currentIndex, state.metadata());\n+        IndexMetadata indexMetadata = WatchStoreUtils.getConcreteIndex(HistoryStoreField.DATA_STREAM, state.metadata());\n         return indexMetadata == null || (indexMetadata.getState() == IndexMetadata.State.OPEN &&\n             state.routingTable().index(indexMetadata.getIndex()).allPrimaryShardsActive());\n     }\n+\n+    public void flush() {\n+        bulkProcessor.flush();\n+    }", "originalCommit": "35084e8b013266df1de5f4580a2bfdc79196f75a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ0MTc5MA==", "url": "https://github.com/elastic/elasticsearch/pull/64252#discussion_r522441790", "bodyText": "Main reason for this is to have clear state after tests. This makes sure that we don't have any pending docs to index so we can do proper cleanup after the test and leave no hanging indices behind", "author": "probakowski", "createdAt": "2020-11-12T21:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODcwNzUyOQ=="}], "type": "inlineReview"}, {"oid": "6d0899ae1aea3bdb2d777a45df979f9cfe71c20b", "url": "https://github.com/elastic/elasticsearch/commit/6d0899ae1aea3bdb2d777a45df979f9cfe71c20b", "message": "Merge branch 'master' into watcher-history-data-stream2", "committedDate": "2020-11-12T10:05:38Z", "type": "commit"}, {"oid": "83ad3fe8d2c3e21bcd2136dec677be3dc7820ec0", "url": "https://github.com/elastic/elasticsearch/commit/83ad3fe8d2c3e21bcd2136dec677be3dc7820ec0", "message": "Remove unneeded check", "committedDate": "2020-11-12T10:12:27Z", "type": "commit"}, {"oid": "664ff6432d4c4acbba6f1418681668bd184cac66", "url": "https://github.com/elastic/elasticsearch/commit/664ff6432d4c4acbba6f1418681668bd184cac66", "message": "test fix", "committedDate": "2020-11-12T10:49:07Z", "type": "commit"}, {"oid": "2c5c91c901eaded5b9d2b34097dbf60177e91f58", "url": "https://github.com/elastic/elasticsearch/commit/2c5c91c901eaded5b9d2b34097dbf60177e91f58", "message": "unused imports", "committedDate": "2020-11-12T11:19:40Z", "type": "commit"}]}