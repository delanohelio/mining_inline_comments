{"pr_number": 54522, "pr_title": "[DOCS] Clarifies API key breaking change", "pr_createdAt": "2020-03-31T17:26:28Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54522", "timeline": [{"oid": "7d7a1c4534944b3c0e2791eca38fd7fa26294238", "url": "https://github.com/elastic/elasticsearch/commit/7d7a1c4534944b3c0e2791eca38fd7fa26294238", "message": "[DOCS] Clarify API key breaking change", "committedDate": "2020-03-31T17:20:41Z", "type": "commit"}, {"oid": "fb195a1260ed860e9304dc0286aa06ed9f16a60b", "url": "https://github.com/elastic/elasticsearch/commit/fb195a1260ed860e9304dc0286aa06ed9f16a60b", "message": "[DOCS] More edits", "committedDate": "2020-03-31T17:24:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4OTcwMA==", "url": "https://github.com/elastic/elasticsearch/pull/54522#discussion_r401089700", "bodyText": "by default it had no privileges...\n\nThe documentation for the create API key API (https://www.elastic.co/guide/en/elasticsearch/reference/master/security-api-create-api-key.html) says \"When [role_descriptors] is not specified or is an empty array, then the API key will have a point in time snapshot of permissions of the authenticated user. If you supply role descriptors then the resultant permissions would be an intersection of API keys permissions and authenticated user\u2019s permissions thereby limiting the access scope for API keys...\".  Is that still correct?  Or does it need a clarification that this behaviour differs when you're creating a derived key?", "author": "lcawl", "createdAt": "2020-03-31T17:30:12Z", "path": "docs/reference/migration/migrate_7_6.asciidoc", "diffHunk": "@@ -14,12 +14,43 @@ See also <<release-highlights>> and <<es-release-notes>>.\n //Installation and Upgrade Guide\n \n //tag::notable-breaking-changes[]\n+[discrete]\n+[[breaking_76_security_changes]]\n+=== Security changes\n+\n+[discrete]\n+==== {es} authentication API key privileges\n+\n+If you use the {es} API key service to generate API keys, the behavior of new\n+API keys is impacted by the fix for\n+https://www.elastic.co/community/security[CVE-2020-7009].\n+\n+When you make a request to create API keys, you can specify an expiration and\n+permissions for the API key. Previously, if you used an API key to create\n+another API key (sometimes called a _derived key_), by default it had no\n+privileges. It could nonetheless perform some operations such as running", "originalCommit": "fb195a1260ed860e9304dc0286aa06ed9f16a60b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0MDk0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/54522#discussion_r401240949", "bodyText": "This is still correct for \"non-derived\" keys. For any derived keys, the role descriptors must be specified and its member must be an empty descriptor.", "author": "ywangd", "createdAt": "2020-03-31T21:59:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4OTcwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI5OTcxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/54522#discussion_r401299711", "bodyText": "and its member must be an empty descriptor\n\nSorry, but I don't understand this qualifier.  Could you please clarify?", "author": "lcawl", "createdAt": "2020-04-01T01:03:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4OTcwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwNzE3MA==", "url": "https://github.com/elastic/elasticsearch/pull/54522#discussion_r401307170", "bodyText": "The basically means the example you put into the breaking change section:\n\"role_descriptors\": {\n    \"no_privileges\": {}\n}\nThe internal \"no_privileges\" is an empty member of the outer \"role_descriptors\".  It cannot be skipped.", "author": "ywangd", "createdAt": "2020-04-01T01:33:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4OTcwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwOTcxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/54522#discussion_r401309715", "bodyText": "Thanks, I'll create a separate PR to augment the description in the create API key API reference", "author": "lcawl", "createdAt": "2020-04-01T01:44:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4OTcwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg1NDM2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/54522#discussion_r448854362", "bodyText": "@ywangd  what is the point of having a derived key with no privilege? I mean is there any way to have a admin-key that can be used to create other derived keys with limited but non-empty privileges. Currently I can create only empty privilege derived key and could not found a way to associate roles with it?", "author": "baturozgur", "createdAt": "2020-07-02T08:58:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4OTcwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMyNDgyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/54522#discussion_r449324821", "bodyText": "@baturozgur Previously we had a bug that derived keys are always created with no privileges regardless of what you specify in the role descriptors at creation time. We'd like to support derived keys properly and have an issue #52244 to track it. But we are still working out details on how we should approach the implementation. In the mean time, we decided to fix the bug temporarily by explicitly require no privilege should be specified at creation time for derived keys. This avoids the confusion that our users used to have.\nIn summary, currently there is no way to create derived keys with non-empty privileges. This has been the case since day 1 of the API key feature. The fix did not change this behaviour. It only tightens what you can specify in the input to avoid the false impression that you could create derived keys with non-empty privileges.\nDerived keys can still be used for the authentication API, i.e. GET /_security/_authenticate. I understand it might not be something you would be interested. But a 3rd party application could leverage it as an authentication mechanism but manages privileges on its own.", "author": "ywangd", "createdAt": "2020-07-03T00:45:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4OTcwMA=="}], "type": "inlineReview"}, {"oid": "b1387ac2a593a9618a92b08d7030882676a3bb3e", "url": "https://github.com/elastic/elasticsearch/commit/b1387ac2a593a9618a92b08d7030882676a3bb3e", "message": "[DOCS] Skips snippet test", "committedDate": "2020-03-31T17:36:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NDI5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54522#discussion_r401244293", "bodyText": "Should we be more explicity about the previous behaviour? that is the derived key had no privilege regardless of the role descriptors specified at creation time", "author": "ywangd", "createdAt": "2020-03-31T22:07:51Z", "path": "docs/reference/migration/migrate_7_6.asciidoc", "diffHunk": "@@ -14,12 +14,44 @@ See also <<release-highlights>> and <<es-release-notes>>.\n //Installation and Upgrade Guide\n \n //tag::notable-breaking-changes[]\n+[discrete]\n+[[breaking_76_security_changes]]\n+=== Security changes\n+\n+[discrete]\n+==== {es} authentication API key privileges\n+\n+If you use the {es} API key service to generate API keys, the behavior of new\n+API keys is impacted by the fix for\n+https://www.elastic.co/community/security[CVE-2020-7009].\n+\n+When you make a request to create API keys, you can specify an expiration and\n+permissions for the API key. Previously, if you used an API key to create\n+another API key (sometimes called a _derived key_), by default it had no", "originalCommit": "b1387ac2a593a9618a92b08d7030882676a3bb3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NDk3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/54522#discussion_r401244971", "bodyText": "Is it possible or necessary to emphasize in the beginning that the change only impact derived keys? Since most users are probably not using them and they can skip the details.", "author": "ywangd", "createdAt": "2020-03-31T22:09:25Z", "path": "docs/reference/migration/migrate_7_6.asciidoc", "diffHunk": "@@ -14,12 +14,44 @@ See also <<release-highlights>> and <<es-release-notes>>.\n //Installation and Upgrade Guide\n \n //tag::notable-breaking-changes[]\n+[discrete]\n+[[breaking_76_security_changes]]\n+=== Security changes\n+\n+[discrete]\n+==== {es} authentication API key privileges\n+\n+If you use the {es} API key service to generate API keys, the behavior of new\n+API keys is impacted by the fix for\n+https://www.elastic.co/community/security[CVE-2020-7009].\n+\n+When you make a request to create API keys, you can specify an expiration and", "originalCommit": "b1387ac2a593a9618a92b08d7030882676a3bb3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMxMTEwNg==", "url": "https://github.com/elastic/elasticsearch/pull/54522#discussion_r401311106", "bodyText": "Good point, done!", "author": "lcawl", "createdAt": "2020-04-01T01:49:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NDk3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NTgzOA==", "url": "https://github.com/elastic/elasticsearch/pull/54522#discussion_r401245838", "bodyText": "It's called \"child\" keys here. Probably better to use a consistent name. I have no preference over either \"derived\" or \"child\" keys.", "author": "ywangd", "createdAt": "2020-03-31T22:11:32Z", "path": "docs/reference/release-notes/7.6.asciidoc", "diffHunk": "@@ -3,6 +3,13 @@\n \n Also see <<breaking-changes-7.6,Breaking changes in 7.6>>.\n \n+[[breaking-7.6.2]]\n+[float]\n+=== Breaking changes\n+\n+Authorization::\n+* Creation of child API keys (keys created by existing keys) now requires explicit \"no privileges\" configuration {pull}53647[#53647], https://www.elastic.co/community/security[CVE-2020-7009]", "originalCommit": "b1387ac2a593a9618a92b08d7030882676a3bb3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMxMTMyMw==", "url": "https://github.com/elastic/elasticsearch/pull/54522#discussion_r401311323", "bodyText": "Good catch, thanks!", "author": "lcawl", "createdAt": "2020-04-01T01:50:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NTgzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0Njg1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54522#discussion_r401246853", "bodyText": "The word \"authentication\" does not seem to be necessary here. Also privileges are in the scope of authorization.", "author": "ywangd", "createdAt": "2020-03-31T22:13:54Z", "path": "docs/reference/migration/migrate_7_6.asciidoc", "diffHunk": "@@ -14,12 +14,44 @@ See also <<release-highlights>> and <<es-release-notes>>.\n //Installation and Upgrade Guide\n \n //tag::notable-breaking-changes[]\n+[discrete]\n+[[breaking_76_security_changes]]\n+=== Security changes\n+\n+[discrete]\n+==== {es} authentication API key privileges", "originalCommit": "b1387ac2a593a9618a92b08d7030882676a3bb3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ce0a26f7fcc8414412574fdc2034c50cdf0f6470", "url": "https://github.com/elastic/elasticsearch/commit/ce0a26f7fcc8414412574fdc2034c50cdf0f6470", "message": "[DOCS] Addresses feedback", "committedDate": "2020-04-01T01:04:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwNzc4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/54522#discussion_r401307789", "bodyText": "The role_descriptors is technically an object not an array.", "author": "ywangd", "createdAt": "2020-04-01T01:36:04Z", "path": "docs/reference/migration/migrate_7_6.asciidoc", "diffHunk": "@@ -14,12 +14,42 @@ See also <<release-highlights>> and <<es-release-notes>>.\n //Installation and Upgrade Guide\n \n //tag::notable-breaking-changes[]\n+[discrete]\n+[[breaking_76_security_changes]]\n+=== Security changes\n+\n+[discrete]\n+==== {es} API key privileges\n+\n+If you use an API key to create another API key (sometimes called a\n+_derived key_), its behavior is impacted by the fix for\n+https://www.elastic.co/community/security[CVE-2020-7009].\n+\n+When you make a request to create API keys, you can specify an expiration and\n+privileges for the API key. Previously, when you created a derived key, it had\n+no privileges. This behavior disregarded any privileges that you specified in\n+the {ref}/security-api-create-api-key.html[create API key API].\n+\n+As of 7.6.2, this behavior changes. To create derived keys with no privileges,\n+you must explicitly specify an empty object in the `role_descriptors` array.", "originalCommit": "ce0a26f7fcc8414412574fdc2034c50cdf0f6470", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMxMTcxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/54522#discussion_r401311711", "bodyText": "Thanks, I'll fix that in the API ref in a separate PR too.  For here, I've changed the sentence to \"...you must explicitly specify an empty role descriptor\".", "author": "lcawl", "createdAt": "2020-04-01T01:52:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwNzc4OQ=="}], "type": "inlineReview"}, {"oid": "12b34e942d0de36fd3ef96e55e69bf07afbd3995", "url": "https://github.com/elastic/elasticsearch/commit/12b34e942d0de36fd3ef96e55e69bf07afbd3995", "message": "[DOCS] Clarify role descriptor object", "committedDate": "2020-04-01T01:48:44Z", "type": "commit"}]}