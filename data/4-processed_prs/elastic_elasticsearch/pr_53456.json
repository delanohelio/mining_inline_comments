{"pr_number": 53456, "pr_title": "Use boolean methods for allowed realm types in license state", "pr_createdAt": "2020-03-12T08:38:30Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53456", "timeline": [{"oid": "8a2c0053e60595e2f930e3686e15f0d165788932", "url": "https://github.com/elastic/elasticsearch/commit/8a2c0053e60595e2f930e3686e15f0d165788932", "message": "Use boolean methods for allowed realm types in license state\n\nIn xpack the license state contains methods to determine whether a\nparticular feature is allowed to be used. The one exception is\nallowsRealmTypes() which returns an enum of the types of realms allowed.\nThis change converts the enum values to boolean methods. There are 2\nnotable changes: NONE is removed as we always fall back to basic license\nbehavior, and NATIVE is not needed because it would always return true\nsince we should always have a basic license.", "committedDate": "2020-03-12T08:35:57Z", "type": "commit"}, {"oid": "2851d18d999ef387d05bf3a6160b512d83f29886", "url": "https://github.com/elastic/elasticsearch/commit/2851d18d999ef387d05bf3a6160b512d83f29886", "message": "Merge branch 'master' into refactor_license4", "committedDate": "2020-03-12T08:56:27Z", "type": "commit"}, {"oid": "d6bf13f5365fa710403e15611a8150418c64528e", "url": "https://github.com/elastic/elasticsearch/commit/d6bf13f5365fa710403e15611a8150418c64528e", "message": "fix reversed logic", "committedDate": "2020-03-12T18:46:58Z", "type": "commit"}, {"oid": "357035f94b7483545a2a3e0fd4e4fccd380b770c", "url": "https://github.com/elastic/elasticsearch/commit/357035f94b7483545a2a3e0fd4e4fccd380b770c", "message": "Merge branch 'master' into refactor_license4", "committedDate": "2020-03-12T19:08:39Z", "type": "commit"}, {"oid": "9e38f8c85ca7be63edd74b4d66210bbe1bf93ec2", "url": "https://github.com/elastic/elasticsearch/commit/9e38f8c85ca7be63edd74b4d66210bbe1bf93ec2", "message": "revert saml check", "committedDate": "2020-03-12T22:51:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQwNzM0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53456#discussion_r392407347", "bodyText": "While this may never happen in practice, we need to have a consistent view of the license state for correctness here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (licenseState.isAuthAllowed() == false) {\n          \n          \n            \n                        return Collections.emptyList();\n          \n          \n            \n                    }\n          \n          \n            \n                    final XPackLicenseState licenseStateSnapshot = copyCurrentLicenseState();\n          \n          \n            \n                    if (licenseStateSnapshot.isAuthAllowed() == false) {\n          \n          \n            \n                        return Collections.emptyList();\n          \n          \n            \n                    }", "author": "jaymode", "createdAt": "2020-03-13T18:42:04Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "diffHunk": "@@ -153,17 +137,13 @@ public Realms(Settings settings, Environment env, Map<String, Realm.Factory> fac\n         if (licenseState.isAuthAllowed() == false) {\n             return Collections.emptyList();\n         }", "originalCommit": "9e38f8c85ca7be63edd74b4d66210bbe1bf93ec2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQwNzY4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53456#discussion_r392407689", "bodyText": "Continuation of the previous comment.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (licenseState.areAllRealmsAllowed()) {\n          \n          \n            \n                        return realms;\n          \n          \n            \n                    } else if (licenseState.areStandardRealmsAllowed()) {\n          \n          \n            \n                        return standardRealmsOnly;\n          \n          \n            \n                    } else {\n          \n          \n            \n                        // native realms are basic licensed, and always allowed, even for an expired license\n          \n          \n            \n                        return nativeRealmsOnly;\n          \n          \n            \n                    if (licenseStateSnapshot.areAllRealmsAllowed()) {\n          \n          \n            \n                        return realms;\n          \n          \n            \n                    } else if (licenseStateSnapshot.areStandardRealmsAllowed()) {\n          \n          \n            \n                        return standardRealmsOnly;\n          \n          \n            \n                    } else {\n          \n          \n            \n                        // native realms are basic licensed, and always allowed, even for an expired license\n          \n          \n            \n                        return nativeRealmsOnly;", "author": "jaymode", "createdAt": "2020-03-13T18:42:51Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "diffHunk": "@@ -153,17 +137,13 @@ public Realms(Settings settings, Environment env, Map<String, Realm.Factory> fac\n         if (licenseState.isAuthAllowed() == false) {\n             return Collections.emptyList();\n         }\n-\n-        AllowedRealmType allowedRealmType = licenseState.allowedRealmType();\n-        switch (allowedRealmType) {\n-            case ALL:\n-                return Collections.unmodifiableList(realms);\n-            case DEFAULT:\n-                return Collections.unmodifiableList(standardRealmsOnly);\n-            case NATIVE:\n-                return Collections.unmodifiableList(nativeRealmsOnly);\n-            default:\n-                throw new IllegalStateException(\"authentication should not be enabled\");\n+        if (licenseState.areAllRealmsAllowed()) {\n+            return realms;\n+        } else if (licenseState.areStandardRealmsAllowed()) {\n+            return standardRealmsOnly;\n+        } else {\n+            // native realms are basic licensed, and always allowed, even for an expired license\n+            return nativeRealmsOnly;", "originalCommit": "9e38f8c85ca7be63edd74b4d66210bbe1bf93ec2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQwODM3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/53456#discussion_r392408373", "bodyText": "For correctness, this method should also get a snapshot of the license state and possibly even pass it into an internal version of asList() that accepts the snapshot.", "author": "jaymode", "createdAt": "2020-03-13T18:44:20Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "diffHunk": "@@ -128,9 +113,8 @@ public Realms(Settings settings, Environment env, Map<String, Realm.Factory> fac\n             return Collections.unmodifiableList(realms);\n         }\n \n-        AllowedRealmType allowedRealmType = licenseState.allowedRealmType();\n         // If all realms are allowed, then nothing is unlicensed\n-        if (allowedRealmType == AllowedRealmType.ALL) {\n+        if (licenseState.areAllRealmsAllowed()) {", "originalCommit": "9e38f8c85ca7be63edd74b4d66210bbe1bf93ec2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQwODkyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/53456#discussion_r392408925", "bodyText": "We'll also want to have a snapshot of the license state here since it can change.", "author": "jaymode", "createdAt": "2020-03-13T18:45:29Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "diffHunk": "@@ -250,26 +230,24 @@ public void usageStats(ActionListener<Map<String, Object>> listener) {\n         final List<Realm> realmList = asList().stream()\n             .filter(r -> ReservedRealm.TYPE.equals(r.type()) == false)\n             .collect(Collectors.toList());\n+        final Set<String> realmTypes = realmList.stream().map(Realm::type).collect(Collectors.toSet());\n         final CountDown countDown = new CountDown(realmList.size());\n         final Runnable doCountDown = () -> {\n             if ((realmList.isEmpty() || countDown.countDown()) && failed.get() == false) {\n-                final AllowedRealmType allowedRealmType = licenseState.allowedRealmType();\n                 // iterate over the factories so we can add enabled & available info\n                 for (String type : factories.keySet()) {\n                     assert ReservedRealm.TYPE.equals(type) == false;\n                     realmMap.compute(type, (key, value) -> {\n                         if (value == null) {\n                             return MapBuilder.<String, Object>newMapBuilder()\n                                 .put(\"enabled\", false)\n-                                .put(\"available\", isRealmTypeAvailable(allowedRealmType, type))\n+                                .put(\"available\", isRealmTypeAvailable(licenseState, type))", "originalCommit": "9e38f8c85ca7be63edd74b4d66210bbe1bf93ec2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQxMDcxMA==", "url": "https://github.com/elastic/elasticsearch/pull/53456#discussion_r392410710", "bodyText": "I do not believe OIDC should be allowed in standard realms based on the InternalRealms class. It might be best to have these use Realms.isRealmTypeAvailable to try to keep the logic consolidated?", "author": "jaymode", "createdAt": "2020-03-13T18:49:16Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/oidc/OpenIdConnectBaseRestHandler.java", "diffHunk": "@@ -33,7 +32,7 @@ protected Exception checkFeatureAvailable(RestRequest request) {\n         Exception failedFeature = super.checkFeatureAvailable(request);\n         if (failedFeature != null) {\n             return failedFeature;\n-        } else if (Realms.isRealmTypeAvailable(licenseState.allowedRealmType(), OIDC_REALM_TYPE)) {\n+        } else if (licenseState.areStandardRealmsAllowed()) {", "originalCommit": "9e38f8c85ca7be63edd74b4d66210bbe1bf93ec2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ4MTc2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53456#discussion_r392481767", "bodyText": "This was an accidental change, I will revert.", "author": "rjernst", "createdAt": "2020-03-13T21:15:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQxMDcxMA=="}], "type": "inlineReview"}, {"oid": "b43f86ff1c933db37169edab528f4f72c316f608", "url": "https://github.com/elastic/elasticsearch/commit/b43f86ff1c933db37169edab528f4f72c316f608", "message": "Merge branch 'master' into refactor_license4", "committedDate": "2020-03-17T16:34:52Z", "type": "commit"}, {"oid": "cfecb70fe42d2fc1846c8aa63e03e896687429c5", "url": "https://github.com/elastic/elasticsearch/commit/cfecb70fe42d2fc1846c8aa63e03e896687429c5", "message": "address feedback", "committedDate": "2020-03-17T17:13:34Z", "type": "commit"}, {"oid": "38083faace4d0128f8b118e2df37d5795d6a510e", "url": "https://github.com/elastic/elasticsearch/commit/38083faace4d0128f8b118e2df37d5795d6a510e", "message": "test fixes", "committedDate": "2020-03-18T03:00:45Z", "type": "commit"}, {"oid": "c1c815bf206c6ae75da2bed76b19c56b22c4ad5c", "url": "https://github.com/elastic/elasticsearch/commit/c1c815bf206c6ae75da2bed76b19c56b22c4ad5c", "message": "Merge branch 'master' into refactor_license4", "committedDate": "2020-03-18T19:49:26Z", "type": "commit"}]}