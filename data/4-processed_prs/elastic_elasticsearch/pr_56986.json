{"pr_number": 56986, "pr_title": "Remove Mapper.updateFieldType()", "pr_createdAt": "2020-05-20T09:57:34Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56986", "timeline": [{"oid": "e6d087be5f710f1152123288e07e2482030b7abf", "url": "https://github.com/elastic/elasticsearch/commit/e6d087be5f710f1152123288e07e2482030b7abf", "message": "Remove Mapper.updateFieldType()", "committedDate": "2020-05-20T09:52:58Z", "type": "commit"}, {"oid": "b66c60eba70c0cdfdb8b1dc6a358c19940346eab", "url": "https://github.com/elastic/elasticsearch/commit/b66c60eba70c0cdfdb8b1dc6a358c19940346eab", "message": "MetaJoinMapperField uses a fieldname lookup rather than holding a reference to the mapper", "committedDate": "2020-05-20T12:01:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4NTU2NA==", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r427985564", "bodyText": "ParentJoinFieldMapper was using updateFieldType() to update its linked MetaJoinFieldMapper.  This requires a small bit of hackery to get round, which I hope to fix in a followup by moving the various filter factory methods from the field mapper to the field type.", "author": "romseygeek", "createdAt": "2020-05-20T12:55:32Z", "path": "modules/parent-join/src/main/java/org/elasticsearch/join/mapper/ParentJoinFieldMapper.java", "diffHunk": "@@ -85,7 +85,8 @@\n     public static ParentJoinFieldMapper getMapper(MapperService service) {\n         MetaJoinFieldMapper.MetaJoinFieldType fieldType =\n             (MetaJoinFieldMapper.MetaJoinFieldType) service.fieldType(MetaJoinFieldMapper.NAME);\n-        return fieldType == null ? null : fieldType.getMapper();\n+        return fieldType == null ? null :\n+            (ParentJoinFieldMapper) service.fieldMapper(fieldType.getJoinField());", "originalCommit": "b66c60eba70c0cdfdb8b1dc6a358c19940346eab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4NjM4OA==", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r427986388", "bodyText": "This is unfortunately necessary as a shim to get round the ParentJoinFieldMapper issue above.  Hopefully removed asap.", "author": "romseygeek", "createdAt": "2020-05-20T12:56:43Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -590,6 +584,10 @@ public MappedFieldType fieldType(String fullName) {\n         return fieldTypes.get(fullName);\n     }\n \n+    public Mapper fieldMapper(String fieldName) {", "originalCommit": "b66c60eba70c0cdfdb8b1dc6a358c19940346eab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI5MDY0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r428290641", "bodyText": "Could we avoid adding this new method and call this inline in ParentJoinFieldMapper? All the methods like documentMapper() are public, so it seems do-able.", "author": "jtibshirani", "createdAt": "2020-05-20T20:33:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4NjM4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzNDQ0NA==", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r428634444", "bodyText": "++ have reworked the mocking (which sent me down a surprisingly deep rabbit hole, but I think it's fixed now!)", "author": "romseygeek", "createdAt": "2020-05-21T12:57:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4NjM4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIxNTk1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r428215955", "bodyText": "I think we could remove this whole method assertMappersShareSameFieldType, it doesn't seem helpful now that we only have one type.", "author": "jtibshirani", "createdAt": "2020-05-20T18:20:31Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -439,7 +431,9 @@ private boolean assertMappersShareSameFieldType() {\n             Collections.addAll(fieldMappers, mapper.mapping().metadataMappers);\n             MapperUtils.collect(mapper.root(), new ArrayList<>(), fieldMappers, new ArrayList<>());\n             for (FieldMapper fieldMapper : fieldMappers) {\n-                assert fieldMapper.fieldType() == fieldTypes.get(fieldMapper.name()) : fieldMapper.name();\n+                assert Objects.equals(fieldMapper.fieldType(), fieldTypes.get(fieldMapper.name())) :", "originalCommit": "b66c60eba70c0cdfdb8b1dc6a358c19940346eab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzNDQ5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r428634495", "bodyText": "++", "author": "romseygeek", "createdAt": "2020-05-21T12:57:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIxNTk1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIxNjAyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r428216025", "bodyText": "If I'm understanding correctly, we can now assume existingFieldType will always be null, since there is only one type. In that case we could remove the logic above too, including the method createBuilderFromFieldType.", "author": "jtibshirani", "createdAt": "2020-05-20T18:20:38Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentParser.java", "diffHunk": "@@ -812,10 +812,6 @@ private static void parseDynamicValue(final ParseContext context, ObjectMapper p\n             builder = createBuilderFromDynamicValue(context, token, currentFieldName);\n         }\n         Mapper mapper = builder.build(builderContext);\n-        if (existingFieldType != null) {", "originalCommit": "b66c60eba70c0cdfdb8b1dc6a358c19940346eab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzNDU2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r428634569", "bodyText": "++", "author": "romseygeek", "createdAt": "2020-05-21T12:57:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIxNjAyNQ=="}], "type": "inlineReview"}, {"oid": "4ca0d7f377f69fbd36b6a5e01f01d7398676ffea", "url": "https://github.com/elastic/elasticsearch/commit/4ca0d7f377f69fbd36b6a5e01f01d7398676ffea", "message": "feedback", "committedDate": "2020-05-21T12:52:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzNjA2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r428636061", "bodyText": "I wasted several hours trying to work out why my mocked DocumentMapper class wasn't returning the DocumentFieldMapper instance I was asking it to.  This appears to be unnecessary, so I've removed it", "author": "romseygeek", "createdAt": "2020-05-21T13:00:25Z", "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -295,10 +293,6 @@ public boolean shouldCache(Query query) {\n         MapperService mapperService = mapperServiceMock();\n         when(mapperService.getIndexSettings()).thenReturn(indexSettings);\n         when(mapperService.hasNested()).thenReturn(false);\n-        DocumentMapper mapper = mock(DocumentMapper.class);\n-        when(mapper.typeText()).thenReturn(new Text(TYPE_NAME));\n-        when(mapper.type()).thenReturn(TYPE_NAME);\n-        when(mapperService.documentMapper()).thenReturn(mapper);", "originalCommit": "4ca0d7f377f69fbd36b6a5e01f01d7398676ffea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc0OTkzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r428749931", "bodyText": "I think we can delete createBuilderFromFieldType now, since it's unused.", "author": "jtibshirani", "createdAt": "2020-05-21T15:58:16Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentParser.java", "diffHunk": "@@ -801,16 +801,8 @@ private static void parseDynamicValue(final ParseContext context, ObjectMapper p\n         if (dynamic == ObjectMapper.Dynamic.FALSE) {\n             return;\n         }\n-        final String path = context.path().pathAsText(currentFieldName);\n         final Mapper.BuilderContext builderContext = new Mapper.BuilderContext(context.indexSettings().getSettings(), context.path());\n-        final MappedFieldType existingFieldType = context.mapperService().fieldType(path);\n-        final Mapper.Builder builder;\n-        if (existingFieldType != null) {\n-            // create a builder of the same type\n-            builder = createBuilderFromFieldType(context, existingFieldType, currentFieldName);\n-        } else {\n-            builder = createBuilderFromDynamicValue(context, token, currentFieldName);\n-        }\n+        final Mapper.Builder<?> builder = createBuilderFromDynamicValue(context, token, currentFieldName);", "originalCommit": "4ca0d7f377f69fbd36b6a5e01f01d7398676ffea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "de25af92b3bdce9ca6b8164f363408883fc4bbe5", "url": "https://github.com/elastic/elasticsearch/commit/de25af92b3bdce9ca6b8164f363408883fc4bbe5", "message": "Remove Mapper.updateFieldType()", "committedDate": "2020-05-21T17:20:49Z", "type": "commit"}, {"oid": "71abe8e5df8f8853c59ebf541856846d6e7991ef", "url": "https://github.com/elastic/elasticsearch/commit/71abe8e5df8f8853c59ebf541856846d6e7991ef", "message": "MetaJoinMapperField uses a fieldname lookup rather than holding a reference to the mapper", "committedDate": "2020-05-21T17:20:49Z", "type": "commit"}, {"oid": "b710a50163e3f887ca4dc6097ea3a3c57f29461f", "url": "https://github.com/elastic/elasticsearch/commit/b710a50163e3f887ca4dc6097ea3a3c57f29461f", "message": "feedback", "committedDate": "2020-05-21T17:20:49Z", "type": "commit"}, {"oid": "fdae94408f77a79a31f730e798fb1a68e641052f", "url": "https://github.com/elastic/elasticsearch/commit/fdae94408f77a79a31f730e798fb1a68e641052f", "message": "remove unused method", "committedDate": "2020-05-21T17:22:56Z", "type": "commit"}, {"oid": "33a0faf16e07d00b61f4c9065470ac6c6010e218", "url": "https://github.com/elastic/elasticsearch/commit/33a0faf16e07d00b61f4c9065470ac6c6010e218", "message": "Merge remote-tracking branch 'romseygeek/mapper/update-field-type' into mapper/update-field-type", "committedDate": "2020-05-21T17:30:10Z", "type": "commit"}, {"oid": "72a357ea8cc4a3311d0cfe1d724280b85aeb559e", "url": "https://github.com/elastic/elasticsearch/commit/72a357ea8cc4a3311d0cfe1d724280b85aeb559e", "message": "Merge remote-tracking branch 'origin/master' into mapper/update-field-type", "committedDate": "2020-05-26T11:23:01Z", "type": "commit"}]}