{"pr_number": 66356, "pr_title": "ILM: make the unfollow action and CCR related steps retryable", "pr_createdAt": "2020-12-15T14:54:55Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66356", "timeline": [{"oid": "b8340a1f40c8918c8b7bc3243e5ca763387211f9", "url": "https://github.com/elastic/elasticsearch/commit/b8340a1f40c8918c8b7bc3243e5ca763387211f9", "message": "ILM: make the unfollow action and CCR related steps retryable", "committedDate": "2020-12-15T14:41:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5Mzk3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/66356#discussion_r543493973", "bodyText": "I just realized that we could remove this step entirely in favor of the OpenIndexStep, because as far as I can see, they're identical. (definitely as a followup though)", "author": "dakrone", "createdAt": "2020-12-15T16:28:09Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/OpenFollowerIndexStep.java", "diffHunk": "@@ -20,6 +20,11 @@\n         super(key, nextStepKey, client);\n     }\n \n+    @Override\n+    public boolean isRetryable() {", "originalCommit": "b8340a1f40c8918c8b7bc3243e5ca763387211f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTE4NjU5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/66356#discussion_r545186595", "bodyText": "Great spot! I'll make this change in a followup", "author": "andreidan", "createdAt": "2020-12-17T15:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5Mzk3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxMjE0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/66356#discussion_r544512145", "bodyText": "Is there any way that we can check whether the pause has already happened and skip it here? Here's the scenario I'm concerned about:\n\nPause gets executed\nRequest is not acknowledged\nAssertion is thrown (I think I've seen users run with assertions enabled before)\nIndex enters the ERROR state\nRetries the pause\nBecause the pause has already occurred, the TransportPauseFollowAction throws an exception as pausing twice throws an exception\nNow we're stuck in an ERROR loop\n\nI think we should also handle the case where the index is manually paused and then the pause-follower-index step runs, it should skip the index.", "author": "dakrone", "createdAt": "2020-12-16T18:06:28Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/PauseFollowerIndexStep.java", "diffHunk": "@@ -17,6 +17,11 @@\n         super(key, nextStepKey, client);\n     }\n \n+    @Override\n+    public boolean isRetryable() {\n+        return true;\n+    }\n+\n     @Override\n     void innerPerformAction(String followerIndex, Listener listener) {\n         PauseFollowAction.Request request = new PauseFollowAction.Request(followerIndex);", "originalCommit": "b8340a1f40c8918c8b7bc3243e5ca763387211f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1NTgwNw==", "url": "https://github.com/elastic/elasticsearch/pull/66356#discussion_r545255807", "bodyText": "Yes, ++ on making them idempotent. I'll do that as part of this PR.\nI do wonder with regards to the isAcked check. I don't think it should be an assertion as it's something that can happen, so IMO, it should either be an exception or we shouldn't care about it? Given a majority of users run without enabled assertions I'd say we shouldn't care about it (also, an unacked operation is not a failed one). I believe that if we want to wait for all nodes (well, shards in this case) to ack an operation, we should have a step that waits for this condition.\nWhat do you think?", "author": "andreidan", "createdAt": "2020-12-17T17:10:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxMjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI2NjI3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/66356#discussion_r545266279", "bodyText": "I think it's mostly an assertion for our tests, so that the test will fail and we'll be able to figure out why. Especially in the case of an integration test, we would always want to know if something wasn't acknowledged.\nI think I'm good with keeping it, I know that most users don't run with assertions enabled (and I think we don't recommend that they do). The example above is pretty contrived (the assertion one), and I don't think it is important enough for us to need to remove the assertion.", "author": "dakrone", "createdAt": "2020-12-17T17:25:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxMjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk2NTgzNA==", "url": "https://github.com/elastic/elasticsearch/pull/66356#discussion_r545965834", "bodyText": "@dakrone\nRe:acknowledged /unacknowledged - I agree we'd want to surface this situation if it's a problem. I guess we might view differently an assertion (which I view as expressing/sanity checking \"something that should never happen\"). A successful unacked operation is something that can happen quite often (?) (especially with larger cluster and many shards), so what I'm proposing is making this explicit (especially now that it'll be a retryable step) and explicitly fail the step if the response is unacked (regardless of assertions enabled/disabled).\nRe:idempotency. On a closer look, both UnfollowFollowerIndexStep and PauseFollowerIndexStep are already idempotent as the AbstractUnfollowIndexStep makes sure of this:\nMap<String, String> customIndexMetadata = indexMetadata.getCustomData(CCR_METADATA_KEY);\n        if (customIndexMetadata == null) {\n            listener.onResponse(true);\n            return;\n        }\n\nOn another note, I renamed UnfollowFollowIndexStep to UnfollowFollowerIndexStep as the former made my brain spagheti :)\nI'll merge this PR as is if you agree with the rename.", "author": "andreidan", "createdAt": "2020-12-18T17:02:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxMjE0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk4MTQ3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/66356#discussion_r545981471", "bodyText": "what I'm proposing is making this explicit (especially now that it'll be a retryable step) and explicitly fail the step if the response is unacked (regardless of assertions enabled/disabled).\n\nThat sounds good to me!\n\nOn a closer look, both UnfollowFollowerIndexStep and PauseFollowerIndexStep are already idempotent as the AbstractUnfollowIndexStep makes sure of this:\nif (customIndexMetadata == null) ...\n\nLooking at the TransportPauseFollowAction however, pausing an index doesn't actually remove the CCR_METADATA_KEY custom metadata. So the AbstractUnfollowIndexStep only makes sure that we skip indices that don't have any CCR configuration. If an index is a follower, then double pausing/unfollowing still throws this error:\n\n  \n    \n      elasticsearch/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/TransportPauseFollowAction.java\n    \n    \n         Line 77\n      in\n      ce30ac1\n    \n    \n    \n    \n\n        \n          \n           listener.onFailure(new IllegalArgumentException(\"no shard follow tasks for [\" + request.getFollowIndex() + \"]\")); \n        \n    \n  \n\n\n(Which is actually after a check of the same kind):\n\n  \n    \n      elasticsearch/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/TransportPauseFollowAction.java\n    \n    \n        Lines 57 to 60\n      in\n      ce30ac1\n    \n    \n    \n    \n\n        \n          \n           if (followerIMD.getCustomData(Ccr.CCR_CUSTOM_METADATA_KEY) == null) { \n        \n\n        \n          \n               listener.onFailure(new IllegalArgumentException(\"index [\" + request.getFollowIndex() + \"] is not a follower index\")); \n        \n\n        \n          \n               return; \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nSo we still need to do additional checks to see if there are any follow tasks, basically doing this:\n\n  \n    \n      elasticsearch/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/TransportPauseFollowAction.java\n    \n    \n        Lines 61 to 74\n      in\n      ce30ac1\n    \n    \n    \n    \n\n        \n          \n           PersistentTasksCustomMetadata persistentTasksMetadata = state.metadata().custom(PersistentTasksCustomMetadata.TYPE); \n        \n\n        \n          \n           if (persistentTasksMetadata == null) { \n        \n\n        \n          \n               listener.onFailure(new IllegalArgumentException(\"no shard follow tasks found\")); \n        \n\n        \n          \n               return; \n        \n\n        \n          \n           } \n        \n\n        \n          \n            \n        \n\n        \n          \n           List<String> shardFollowTaskIds = persistentTasksMetadata.tasks().stream() \n        \n\n        \n          \n               .filter(persistentTask -> ShardFollowTask.NAME.equals(persistentTask.getTaskName())) \n        \n\n        \n          \n               .filter(persistentTask -> { \n        \n\n        \n          \n                   ShardFollowTask shardFollowTask = (ShardFollowTask) persistentTask.getParams(); \n        \n\n        \n          \n                   return shardFollowTask.getFollowShardId().getIndexName().equals(request.getFollowIndex()); \n        \n\n        \n          \n               }) \n        \n\n        \n          \n               .map(PersistentTasksCustomMetadata.PersistentTask::getId) \n        \n\n        \n          \n               .collect(Collectors.toList()); \n        \n    \n  \n\n\nand then checking if the list is empty (in which case we can be idempotent and do listener.onResponse(true, null) instead of calling the pause API a second time)", "author": "dakrone", "createdAt": "2020-12-18T17:31:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxMjE0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxMzI2OA==", "url": "https://github.com/elastic/elasticsearch/pull/66356#discussion_r544513268", "bodyText": "Same comment here about skipping if the index is already unfollowed, a double unfollow throws an error so we'd just be retrying forever if it were executed after the index was already unfollowed", "author": "dakrone", "createdAt": "2020-12-16T18:08:15Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/UnfollowFollowIndexStep.java", "diffHunk": "@@ -23,6 +23,11 @@\n         super(key, nextStepKey, client);\n     }\n \n+    @Override\n+    public boolean isRetryable() {\n+        return true;\n+    }\n+\n     @Override\n     void innerPerformAction(String followerIndex, Listener listener) {\n         UnfollowAction.Request request = new UnfollowAction.Request(followerIndex);", "originalCommit": "b8340a1f40c8918c8b7bc3243e5ca763387211f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "26d71af33ff6f97b7674431740849890d63396ea", "url": "https://github.com/elastic/elasticsearch/commit/26d71af33ff6f97b7674431740849890d63396ea", "message": "Merge branch 'master' into ilm-unfollow-retryable", "committedDate": "2020-12-17T15:35:08Z", "type": "commit"}, {"oid": "f30984de970a3c5b04dba587ec3dd8aa609efa12", "url": "https://github.com/elastic/elasticsearch/commit/f30984de970a3c5b04dba587ec3dd8aa609efa12", "message": "Rename UnfollowFollowIndexStep to UnfollowFollowerIndexStep", "committedDate": "2020-12-18T16:22:27Z", "type": "commit"}, {"oid": "a2a5f923349b5c6f7f94d468cc1d4c025ace7cdf", "url": "https://github.com/elastic/elasticsearch/commit/a2a5f923349b5c6f7f94d468cc1d4c025ace7cdf", "message": "Merge branch 'master' into ilm-unfollow-retryable", "committedDate": "2020-12-22T11:04:45Z", "type": "commit"}, {"oid": "77e06d253ff49b79e041e1f39ad221d92dd25d44", "url": "https://github.com/elastic/elasticsearch/commit/77e06d253ff49b79e041e1f39ad221d92dd25d44", "message": "Merge branch 'master' into ilm-unfollow-retryable", "committedDate": "2021-01-05T13:50:39Z", "type": "commit"}, {"oid": "6729ed03b00adf9b462abe83d6990674c7ff4823", "url": "https://github.com/elastic/elasticsearch/commit/6729ed03b00adf9b462abe83d6990674c7ff4823", "message": "Move ShardFollowTask to `xpack.core`", "committedDate": "2021-01-07T14:50:11Z", "type": "commit"}, {"oid": "9f57a86b86486815036644266a71b2cec3a31f18", "url": "https://github.com/elastic/elasticsearch/commit/9f57a86b86486815036644266a71b2cec3a31f18", "message": "AbstractUnfollowIndexStep skips if the managed index is not a follower index", "committedDate": "2021-01-07T15:51:36Z", "type": "commit"}, {"oid": "4ad2d3f7c5470153a7abcd9cb562ac158253bdc5", "url": "https://github.com/elastic/elasticsearch/commit/4ad2d3f7c5470153a7abcd9cb562ac158253bdc5", "message": "Merge branch 'master' into ilm-unfollow-retryable", "committedDate": "2021-01-07T15:52:40Z", "type": "commit"}, {"oid": "2b8a7ce7784ac4a740b386df2cee1eadd34369e5", "url": "https://github.com/elastic/elasticsearch/commit/2b8a7ce7784ac4a740b386df2cee1eadd34369e5", "message": "Make PauseFollowerIndexStep idempotent\n\nThis moves the idempotency checkes from AbstractUnfollowIndexStep to\nPauseFollowerIndexStep as the UnfollowFollowerIndexStep was already\nidemptotent", "committedDate": "2021-01-07T17:35:38Z", "type": "commit"}, {"oid": "482647f1656cecbd8a9c4060662abb585adb2b91", "url": "https://github.com/elastic/elasticsearch/commit/482647f1656cecbd8a9c4060662abb585adb2b91", "message": "Remove unused import", "committedDate": "2021-01-07T17:44:49Z", "type": "commit"}, {"oid": "f20e9f4cf4e70bf75b856616971056cfd5dad473", "url": "https://github.com/elastic/elasticsearch/commit/f20e9f4cf4e70bf75b856616971056cfd5dad473", "message": "Convert response isAcknoledged checks from assertion to exceptions", "committedDate": "2021-01-11T12:23:59Z", "type": "commit"}, {"oid": "4ea8e782e02d2f6bbd99cacc4edd2c0c052a0fab", "url": "https://github.com/elastic/elasticsearch/commit/4ea8e782e02d2f6bbd99cacc4edd2c0c052a0fab", "message": "Merge branch 'master' into ilm-unfollow-retryable", "committedDate": "2021-01-11T12:24:33Z", "type": "commit"}, {"oid": "c69e313ad1b010d58aaed470b2085a9464a700d5", "url": "https://github.com/elastic/elasticsearch/commit/c69e313ad1b010d58aaed470b2085a9464a700d5", "message": "Convert isAcknowledged assertion to exception", "committedDate": "2021-01-11T12:34:43Z", "type": "commit"}]}