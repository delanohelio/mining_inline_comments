{"pr_number": 61802, "pr_title": "Convert second 1/2 x-pack plugins from integTest to [yaml | java]RestTest or internalClusterTest", "pr_createdAt": "2020-09-01T15:56:09Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61802", "timeline": [{"oid": "c61dbb1939008946179c4a0b39e800dd7b65a723", "url": "https://github.com/elastic/elasticsearch/commit/c61dbb1939008946179c4a0b39e800dd7b65a723", "message": "most of security", "committedDate": "2020-08-31T18:53:44Z", "type": "commit"}, {"oid": "ec7a4f6b74b6a072475e4e8d86becc7fc6c2715b", "url": "https://github.com/elastic/elasticsearch/commit/ec7a4f6b74b6a072475e4e8d86becc7fc6c2715b", "message": "security internalCluster", "committedDate": "2020-08-31T19:24:56Z", "type": "commit"}, {"oid": "ef58dfb799aeb5e59c3f11bf1918c59515f76683", "url": "https://github.com/elastic/elasticsearch/commit/ef58dfb799aeb5e59c3f11bf1918c59515f76683", "message": "finish up security", "committedDate": "2020-08-31T19:51:32Z", "type": "commit"}, {"oid": "92519db4e715ab47dd8b10252a5bca796c42a115", "url": "https://github.com/elastic/elasticsearch/commit/92519db4e715ab47dd8b10252a5bca796c42a115", "message": "security:qa", "committedDate": "2020-08-31T20:51:02Z", "type": "commit"}, {"oid": "505153810946c01995380cdb7c927a6942c30429", "url": "https://github.com/elastic/elasticsearch/commit/505153810946c01995380cdb7c927a6942c30429", "message": "spatial", "committedDate": "2020-08-31T21:49:02Z", "type": "commit"}, {"oid": "3660ab0e5ad7070d7d28930cc171aff2e4ac4ae6", "url": "https://github.com/elastic/elasticsearch/commit/3660ab0e5ad7070d7d28930cc171aff2e4ac4ae6", "message": "stack", "committedDate": "2020-08-31T22:05:15Z", "type": "commit"}, {"oid": "351cb2698012f2c696e5ae7666ce380f09e8b373", "url": "https://github.com/elastic/elasticsearch/commit/351cb2698012f2c696e5ae7666ce380f09e8b373", "message": "transform", "committedDate": "2020-08-31T22:21:06Z", "type": "commit"}, {"oid": "c4d39ddbf11eefb20967e280502c65f90085fe49", "url": "https://github.com/elastic/elasticsearch/commit/c4d39ddbf11eefb20967e280502c65f90085fe49", "message": "vectors", "committedDate": "2020-08-31T22:25:14Z", "type": "commit"}, {"oid": "e62708c82eafae20661c9eded4239a187772828b", "url": "https://github.com/elastic/elasticsearch/commit/e62708c82eafae20661c9eded4239a187772828b", "message": "voting-only-node", "committedDate": "2020-08-31T22:32:47Z", "type": "commit"}, {"oid": "5c325e5942f7fd63ca0e6f2b36085945d5daa76b", "url": "https://github.com/elastic/elasticsearch/commit/5c325e5942f7fd63ca0e6f2b36085945d5daa76b", "message": "watcher - internalClusterTest", "committedDate": "2020-09-01T14:49:56Z", "type": "commit"}, {"oid": "5a657067897e4e5db0ab3a184fec1382c1632452", "url": "https://github.com/elastic/elasticsearch/commit/5a657067897e4e5db0ab3a184fec1382c1632452", "message": "watcher qa", "committedDate": "2020-09-01T15:51:45Z", "type": "commit"}, {"oid": "0a94232fefa885b4cd196a6a2c409839babdff64", "url": "https://github.com/elastic/elasticsearch/commit/0a94232fefa885b4cd196a6a2c409839babdff64", "message": "Merge remote-tracking branch 'upstream/master' into yamlRestTest_xpack_plugins_part2", "committedDate": "2020-09-01T15:56:45Z", "type": "commit"}, {"oid": "93135280c8951717e7b31f09d2ead97b2b96df5c", "url": "https://github.com/elastic/elasticsearch/commit/93135280c8951717e7b31f09d2ead97b2b96df5c", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into yamlRestTest_xpack_plugins_part2", "committedDate": "2020-09-01T17:03:00Z", "type": "commit"}, {"oid": "745f76288609ea0f43109d5156dccec38ccabbc5", "url": "https://github.com/elastic/elasticsearch/commit/745f76288609ea0f43109d5156dccec38ccabbc5", "message": "remove commented out line", "committedDate": "2020-09-01T17:33:05Z", "type": "commit"}, {"oid": "254b20dd3c6da8fa144cfb739677e976dda65204", "url": "https://github.com/elastic/elasticsearch/commit/254b20dd3c6da8fa144cfb739677e976dda65204", "message": "spotless", "committedDate": "2020-09-01T18:11:37Z", "type": "commit"}, {"oid": "3faa914e2434e4aa5ce33bd926c1cdda3c407dc1", "url": "https://github.com/elastic/elasticsearch/commit/3faa914e2434e4aa5ce33bd926c1cdda3c407dc1", "message": "fix precommit", "committedDate": "2020-09-01T19:11:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwMzg3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481403871", "bodyText": "I introduced a qa/common project to better match how the other projects have this configured.", "author": "jakelandis", "createdAt": "2020-09-01T20:13:25Z", "path": "x-pack/plugin/watcher/qa/common/build.gradle", "diffHunk": "@@ -0,0 +1,20 @@\n+apply plugin: 'elasticsearch.build'", "originalCommit": "3faa914e2434e4aa5ce33bd926c1cdda3c407dc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyMzk3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481423977", "bodyText": "Fair enough, but I don't see the point in the additional testJar. We're literally just defining another jar that's identical to the default jar. Why another artifact? Can't we just depend on this project via the default configuraiton?", "author": "mark-vieira", "createdAt": "2020-09-01T20:52:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwMzg3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2NDg3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481464879", "bodyText": "thanks... fixed on 667ea2a", "author": "jakelandis", "createdAt": "2020-09-01T22:21:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwMzg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNDcxNA==", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481404714", "bodyText": "minor duplication here to avoid sharing classpath's between test and javaRestTests", "author": "jakelandis", "createdAt": "2020-09-01T20:15:00Z", "path": "x-pack/plugin/watcher/src/test/java/org/elasticsearch/xpack/watcher/actions/email/EmailActionTests.java", "diffHunk": "@@ -605,4 +607,18 @@ private EmailAttachments randomEmailAttachments() throws IOException {\n \n         return new EmailAttachments(attachments);\n     }\n+\n+    public static class NoopEmailService extends EmailService {", "originalCommit": "3faa914e2434e4aa5ce33bd926c1cdda3c407dc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyNTA3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481425077", "bodyText": "Could this go in the \"common\" qa project to be shared then?", "author": "mark-vieira", "createdAt": "2020-09-01T20:54:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNDcxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2NzM3OA==", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481467378", "bodyText": "i would prefer not to have the unit tests depend on the qa project (which has the parent classes for the java and yaml rest test runners). creating a dependency the other way requires a new test artifact or test fixture (in this case I prefer the minor duplication)", "author": "jakelandis", "createdAt": "2020-09-01T22:28:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNDcxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3NTkxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481475915", "bodyText": "No worries. It's a tiny implementation so it's probably not a big deal for a bit of duplication here.", "author": "mark-vieira", "createdAt": "2020-09-01T22:54:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNDcxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNTEwMA==", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481405100", "bodyText": "didn't mean to change the package ... fixing now ..", "author": "jakelandis", "createdAt": "2020-09-01T20:15:32Z", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/transport/filter/IpFilteringIntegrationTests.java", "diffHunk": "@@ -3,7 +3,7 @@\n  * or more contributor license agreements. Licensed under the Elastic License;\n  * you may not use this file except in compliance with the Elastic License.\n  */\n-package org.elasticsearch.xpack.security.transport.filter;\n+package org.elasticsearch.transport.filter;", "originalCommit": "3faa914e2434e4aa5ce33bd926c1cdda3c407dc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f3dee8bc3c3ad453e603e52efca1d5ccdf0bf52e", "url": "https://github.com/elastic/elasticsearch/commit/f3dee8bc3c3ad453e603e52efca1d5ccdf0bf52e", "message": "fix package location", "committedDate": "2020-09-01T20:20:25Z", "type": "commit"}, {"oid": "f84d203b92622a2d5e794a6a03199daabb15e071", "url": "https://github.com/elastic/elasticsearch/commit/f84d203b92622a2d5e794a6a03199daabb15e071", "message": "fix package location", "committedDate": "2020-09-01T20:22:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyNjUwMw==", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481426503", "bodyText": "This whole thing looks gnarly. Why don't we use two different clusters for this?", "author": "mark-vieira", "createdAt": "2020-09-01T20:56:53Z", "path": "x-pack/plugin/security/qa/basic-enable-security/build.gradle", "diffHunk": "@@ -1,36 +1,36 @@\n import org.elasticsearch.gradle.testclusters.StandaloneRestIntegTestTask\n+import org.elasticsearch.gradle.test.rest.JavaRestTestPlugin\n \n-apply plugin: 'elasticsearch.testclusters'\n-apply plugin: 'elasticsearch.standalone-rest-test'\n-apply plugin: 'elasticsearch.rest-test'\n+apply plugin: 'elasticsearch.java-rest-test'\n \n dependencies {\n-  testImplementation project(path: xpackModule('core'), configuration: 'default')\n-  testImplementation project(path: xpackModule('security'), configuration: 'testArtifacts')\n-  testImplementation project(path: xpackModule('core'), configuration: 'testArtifacts')\n+  javaRestTestImplementation project(path: xpackModule('core'), configuration: 'default')\n+  javaRestTestImplementation project(path: xpackModule('security'), configuration: 'testArtifacts')\n+  javaRestTestImplementation project(path: xpackModule('core'), configuration: 'testArtifacts')\n }\n \n-integTest {\n+javaRestTest {\n   description = \"Run tests against a cluster that doesn't have security\"\n   systemProperty 'tests.has_security', 'false'\n }\n \n-testClusters.integTest {\n+testClusters.javaRestTest {\n   testDistribution = 'DEFAULT'\n   numberOfNodes = 2\n   setting 'xpack.ml.enabled', 'false'\n   setting 'xpack.license.self_generated.type', 'basic'\n   setting 'xpack.security.enabled', 'false'\n }\n \n-task integTestSecurity(type: StandaloneRestIntegTestTask) {\n-  description = \"Run tests against a cluster that has security\"\n-  useCluster testClusters.integTest\n-  dependsOn integTest\n+task javaRestTestWithSecurity(type: StandaloneRestIntegTestTask) {\n+  description = \"Run tests against a cluster that has security enabled\"\n+  useCluster testClusters.javaRestTest\n+  dependsOn javaRestTest", "originalCommit": "f84d203b92622a2d5e794a6a03199daabb15e071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2MzA4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481463083", "bodyText": "yeah... that tripped me up at first sight too.  This is testing that enabling security where it was not enabled prior works. e.g. start without security run some tests, enable security restart then run the same tests. There is a boolean read by the tests that controls what to assert with/without security enabled.", "author": "jakelandis", "createdAt": "2020-09-01T22:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyNjUwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyODM3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481428375", "bodyText": "I suspect this probably isn't needed for unit tests. Can we ditch the block above?", "author": "mark-vieira", "createdAt": "2020-09-01T21:00:28Z", "path": "x-pack/plugin/security/build.gradle", "diffHunk": "@@ -476,6 +484,11 @@ test {\n   systemProperty 'es.transport.buffer.size', '256k'\n }\n \n+internalClusterTest {", "originalCommit": "f84d203b92622a2d5e794a6a03199daabb15e071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2NDcxNg==", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481464716", "bodyText": "yup: 1f4ca9a", "author": "jakelandis", "createdAt": "2020-09-01T22:21:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyODM3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyOTczOA==", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481429738", "bodyText": "Same, I suspect this is only needed for integration tests.", "author": "mark-vieira", "createdAt": "2020-09-01T21:03:08Z", "path": "x-pack/plugin/watcher/build.gradle", "diffHunk": "@@ -86,6 +87,10 @@ test {\n   systemProperty 'es.set.netty.runtime.available.processors', 'false'\n }\n \n+internalClusterTest {\n+  systemProperty 'es.set.netty.runtime.available.processors', 'false'", "originalCommit": "f84d203b92622a2d5e794a6a03199daabb15e071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2NDY3OA==", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481464678", "bodyText": "indeed: 1f4ca9a", "author": "jakelandis", "createdAt": "2020-09-01T22:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyOTczOA=="}], "type": "inlineReview"}, {"oid": "667ea2abd20fc50c91e8ac16f5066ed44aad0d9d", "url": "https://github.com/elastic/elasticsearch/commit/667ea2abd20fc50c91e8ac16f5066ed44aad0d9d", "message": "remove unecessary watcher test artifact", "committedDate": "2020-09-01T22:12:23Z", "type": "commit"}, {"oid": "1f4ca9a0ea0276a9c23b9ec69b4ad0e1f6a01bf7", "url": "https://github.com/elastic/elasticsearch/commit/1f4ca9a0ea0276a9c23b9ec69b4ad0e1f6a01bf7", "message": "remove unnecessary config", "committedDate": "2020-09-01T22:20:18Z", "type": "commit"}]}