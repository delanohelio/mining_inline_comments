{"pr_number": 64046, "pr_title": "Move tasks in build scripts to task avoidance api", "pr_createdAt": "2020-10-22T09:12:08Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64046", "timeline": [{"oid": "1122d063cd96d90cd39766175a0582b58f26804a", "url": "https://github.com/elastic/elasticsearch/commit/1122d063cd96d90cd39766175a0582b58f26804a", "message": "Move tasks in build scripts to task avoidance api", "committedDate": "2020-11-09T12:12:40Z", "type": "forcePushed"}, {"oid": "d41a8e3a26586fab09809d4aeaf430882a59e20c", "url": "https://github.com/elastic/elasticsearch/commit/d41a8e3a26586fab09809d4aeaf430882a59e20c", "message": "Move tasks in build scripts to task avoidance api", "committedDate": "2020-11-11T09:39:17Z", "type": "forcePushed"}, {"oid": "f783deea09f02a270d087e42e6112a31bed7ccfc", "url": "https://github.com/elastic/elasticsearch/commit/f783deea09f02a270d087e42e6112a31bed7ccfc", "message": "Move tasks in build scripts to task avoidance api", "committedDate": "2020-11-11T14:35:58Z", "type": "commit"}, {"oid": "82512ad0ec551677483a3aa4e9687fcadc8fb1f0", "url": "https://github.com/elastic/elasticsearch/commit/82512ad0ec551677483a3aa4e9687fcadc8fb1f0", "message": "Use more task avoidance API in build scripts", "committedDate": "2020-11-11T14:35:58Z", "type": "commit"}, {"oid": "6cd0b4789eb900d016f0a7e00461f59d9280714a", "url": "https://github.com/elastic/elasticsearch/commit/6cd0b4789eb900d016f0a7e00461f59d9280714a", "message": "Fix ci", "committedDate": "2020-11-11T14:35:58Z", "type": "commit"}, {"oid": "ea6c89def1eb58674aec1a1bde430ee1e5f7641c", "url": "https://github.com/elastic/elasticsearch/commit/ea6c89def1eb58674aec1a1bde430ee1e5f7641c", "message": "Revert change that introduce task dependency cycle", "committedDate": "2020-11-11T14:54:20Z", "type": "commit"}, {"oid": "ea6c89def1eb58674aec1a1bde430ee1e5f7641c", "url": "https://github.com/elastic/elasticsearch/commit/ea6c89def1eb58674aec1a1bde430ee1e5f7641c", "message": "Revert change that introduce task dependency cycle", "committedDate": "2020-11-11T14:54:20Z", "type": "forcePushed"}, {"oid": "3b0d0611f1d6a3845f8ad46c45bcabdc5757d927", "url": "https://github.com/elastic/elasticsearch/commit/3b0d0611f1d6a3845f8ad46c45bcabdc5757d927", "message": "Some more cleanup on build scripts\n\n- add reusable method for making subprojects depend on check task\n- more task avoidance api", "committedDate": "2020-11-11T22:05:17Z", "type": "commit"}, {"oid": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997", "url": "https://github.com/elastic/elasticsearch/commit/5a10a04806acb85b3d1e4bd6c39928d6c8dad997", "message": "Fix task dependency in :modules:reindex", "committedDate": "2020-11-11T22:12:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MDQwNw==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521680407", "bodyText": "We seem to be relying on delegation in some places and using the implicit it argument in others. Should we standardize on one or the other?", "author": "mark-vieira", "createdAt": "2020-11-11T22:38:00Z", "path": "buildSrc/build.gradle", "diffHunk": "@@ -146,19 +148,29 @@ if (project != rootProject) {\n   apply plugin: 'elasticsearch.publish'\n \n   // groovydoc succeeds, but has some weird internal exception...\n-  groovydoc.enabled = false\n+  tasks.named(\"groovydoc\").configure {\n+    it.enabled = false", "originalCommit": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk2NzAxOA==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521967018", "bodyText": "I'm going ahead and remove implicit it where its not required", "author": "breskeby", "createdAt": "2020-11-12T09:38:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MDQwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MTU4MA==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521681580", "bodyText": "Is this findAll filter necessary. Doesn't the find above ensure that will always be the case?", "author": "mark-vieira", "createdAt": "2020-11-11T22:40:56Z", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/plugin/PluginBuildPlugin.groovy", "diffHunk": "@@ -108,6 +108,21 @@ class PluginBuildPlugin implements Plugin<Project> {\n             }\n         }\n \n+        // We've ported this from multiple build scripts where we see this pattern into\n+        // an extension method as a first step of consolidation.\n+        // We might want to port this into a general pattern later on.\n+        project.ext.addQaCheckDependencies = {\n+            project.afterEvaluate {\n+                // let check depend on check tasks of qa sub-projects\n+                def checkTaskProvider = project.tasks.named(\"check\")\n+                def qaSubproject = project.subprojects.find { it.path == project.path + \":qa\" }\n+                if(qaSubproject) {\n+                    qaSubproject.subprojects.findAll {p -> p.path.startsWith(project.path + \":qa\") }", "originalCommit": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk2ODEzNA==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521968134", "bodyText": "indeed.", "author": "breskeby", "createdAt": "2020-11-12T09:40:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MTU4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MTk5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521681992", "bodyText": "This is kind of an odd thing already. I would assume in most cases folks would just do ./gradlew -p path/to/project check which should essentially be the same thing. This wiring now makes it impossible to just run the checks on a single project w/o transitively running a ton of other stuff.", "author": "mark-vieira", "createdAt": "2020-11-11T22:41:57Z", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/plugin/PluginBuildPlugin.groovy", "diffHunk": "@@ -108,6 +108,21 @@ class PluginBuildPlugin implements Plugin<Project> {\n             }\n         }\n \n+        // We've ported this from multiple build scripts where we see this pattern into\n+        // an extension method as a first step of consolidation.\n+        // We might want to port this into a general pattern later on.\n+        project.ext.addQaCheckDependencies = {", "originalCommit": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk2NzkxOA==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521967918", "bodyText": "I agree. I just didn't want to change the behaviour with this PR. I'll put this on my todo list to clean up in another separate PR", "author": "breskeby", "createdAt": "2020-11-12T09:40:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MTk5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MzEzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521683135", "bodyText": "Why is this necessary? Should we be depending on some kind of configuration or artifact instead?", "author": "mark-vieira", "createdAt": "2020-11-11T22:44:50Z", "path": "distribution/archives/integ-test-zip/build.gradle", "diffHunk": "@@ -48,15 +44,16 @@ publishing {\n   }\n }\n \n-integTest {\n+tasks.named(\"integTest\").configure {\n+  dependsOn \"assemble\"", "originalCommit": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5MTQ1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521691452", "bodyText": "Doesn't this effectively nullify any benefit of lazily creating the unzip task? Is there a reason we can't lazily create the fixture task?", "author": "mark-vieira", "createdAt": "2020-11-11T23:07:22Z", "path": "modules/reindex/build.gradle", "diffHunk": "@@ -146,7 +148,7 @@ if (Os.isFamily(Os.FAMILY_WINDOWS)) {\n       env 'JAVA_HOME', jdks.legacy.javaHomePath\n       args 'oldes.OldElasticsearch',\n         baseDir,\n-        unzip.temporaryDir,\n+        unzip.get().temporaryDir,", "originalCommit": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3MjI2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521972265", "bodyText": "yeah this just kicks the can down to the fixture task creation. Changing these fixtures to use task avoidance had some side effects in an earlier trial I want to look in an dedicated effort. Again this PR is basically of just porting the low hanging fruits", "author": "breskeby", "createdAt": "2020-11-12T09:46:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5MTQ1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5MzU3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521693575", "bodyText": "By this you just mean that we move this config inside the task configuration block as that guarantees the task has been created, and subsequently, the corresponding testcluster will exist as well?", "author": "mark-vieira", "createdAt": "2020-11-11T23:13:42Z", "path": "plugins/repository-gcs/build.gradle", "diffHunk": "@@ -293,29 +293,28 @@ testClusters {\n  * We only use a small amount of data in these tests, which means that the resumable upload path is not tested. We add\n  * an additional test that forces the large blob threshold to be small to exercise the resumable upload path.\n  */\n-task largeBlobYamlRestTest(type: RestIntegTestTask) {\n-  dependsOn bundlePlugin\n+def largeBlobYamlRestTest = tasks.register(\"largeBlobYamlRestTest\", RestIntegTestTask) {\n+  dependsOn \"bundlePlugin\"\n   if (useFixture) {\n-    dependsOn createServiceAccountFile\n+    dependsOn \"createServiceAccountFile\"\n   }\n-    SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n-    SourceSet yamlRestTestSourceSet = sourceSets.getByName(YamlRestTestPlugin.SOURCE_SET_NAME)\n-    setTestClassesDirs(yamlRestTestSourceSet.getOutput().getClassesDirs())\n-    setClasspath(yamlRestTestSourceSet.getRuntimeClasspath())\n-}\n+  SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+  SourceSet yamlRestTestSourceSet = sourceSets.getByName(YamlRestTestPlugin.SOURCE_SET_NAME)\n+  setTestClassesDirs(yamlRestTestSourceSet.getOutput().getClassesDirs())\n+  setClasspath(yamlRestTestSourceSet.getRuntimeClasspath())\n \n-check.dependsOn largeBlobYamlRestTest\n+  // We have to wait for configure the cluster here as it might not have been created otherwise yet.", "originalCommit": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3NDU5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521974592", "bodyText": "exactly", "author": "breskeby", "createdAt": "2020-11-12T09:50:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5MzU3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5NDI1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521694256", "bodyText": "I see we wrap the task dependency in quotes here, but not later with integTest. In practice, does it matter? Obviously this config block is deferred until this task is needed, at which point we'll need all its dependencies as well, right? Essentially, there's no scenario in which this block will evaluate and we don't need to create the war task.", "author": "mark-vieira", "createdAt": "2020-11-11T23:15:39Z", "path": "qa/wildfly/build.gradle", "diffHunk": "@@ -63,8 +63,8 @@ elasticsearch_distributions {\n   }\n }\n \n-preProcessFixture {\n-  dependsOn war, elasticsearch_distributions.docker\n+tasks.named(\"preProcessFixture\").configure {\n+  dependsOn \"war\", elasticsearch_distributions.docker", "originalCommit": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3ODU3OA==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521978578", "bodyText": "indeed. there's only odd scenarios where this makes a difference I think. (e.g.) materialising this task without the need of having it in the task graph (by accident during configuration time). IMO ideally this materialisation would only happen by gradle itself when calculation the taskgraph", "author": "breskeby", "createdAt": "2020-11-12T09:56:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5NDI1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5NjIyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521696229", "bodyText": "I feel like the rest test plugin or something should be adding this ordering rule.", "author": "mark-vieira", "createdAt": "2020-11-11T23:19:38Z", "path": "x-pack/plugin/ccr/qa/downgrade-to-basic-license/build.gradle", "diffHunk": "@@ -11,7 +11,7 @@ dependencies {\n }\n \n task \"leader-cluster\"(type: RestIntegTestTask) {\n-  mustRunAfter(precommit)\n+  mustRunAfter(\"precommit\")", "originalCommit": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk3OTEzNw==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521979137", "bodyText": "you mean that tasks of type RestIntegTestTask should always run after precommit ?", "author": "breskeby", "createdAt": "2020-11-12T09:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5NjIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0NjU2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r522346565", "bodyText": "Yeah, I would think so.", "author": "mark-vieira", "createdAt": "2020-11-12T19:05:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5NjIyOQ=="}], "type": "inlineReview"}, {"oid": "b54aba559853cf92ed0e931e3617be03f7d8a833", "url": "https://github.com/elastic/elasticsearch/commit/b54aba559853cf92ed0e931e3617be03f7d8a833", "message": "Apply review feedback\n\n- rely in closure delegation for task config blocks", "committedDate": "2020-11-12T09:58:27Z", "type": "commit"}, {"oid": "d737938aaa2d2033991463ff7cb031218503380b", "url": "https://github.com/elastic/elasticsearch/commit/d737938aaa2d2033991463ff7cb031218503380b", "message": "Fix formatting", "committedDate": "2020-11-12T10:13:00Z", "type": "commit"}]}