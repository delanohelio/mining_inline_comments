{"pr_number": 52729, "pr_title": "Soft immutability for VSConfig", "pr_createdAt": "2020-02-24T20:29:09Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52729", "timeline": [{"oid": "60d2be74df4172ed8182e193373209147da8ee48", "url": "https://github.com/elastic/elasticsearch/commit/60d2be74df4172ed8182e193373209147da8ee48", "message": "Narrow scope and requirements", "committedDate": "2020-02-19T20:35:58Z", "type": "commit"}, {"oid": "04475e26efa0a3c58c8dd2415ff9584992c8fc3e", "url": "https://github.com/elastic/elasticsearch/commit/04475e26efa0a3c58c8dd2415ff9584992c8fc3e", "message": "indentation", "committedDate": "2020-02-20T15:46:43Z", "type": "commit"}, {"oid": "3aadb4b84e6cfb463fffcc90466911ea653283c2", "url": "https://github.com/elastic/elasticsearch/commit/3aadb4b84e6cfb463fffcc90466911ea653283c2", "message": "fix typo", "committedDate": "2020-02-20T16:22:35Z", "type": "commit"}, {"oid": "052a2d0c59bd2a8dd3331429088b74581e8c19fa", "url": "https://github.com/elastic/elasticsearch/commit/052a2d0c59bd2a8dd3331429088b74581e8c19fa", "message": "Don't mutate ValuesSourceConfig in Parent & Child aggregations", "committedDate": "2020-02-20T21:53:18Z", "type": "commit"}, {"oid": "1a947edfb6e38b81c18e1af01ccb9787634f7cbf", "url": "https://github.com/elastic/elasticsearch/commit/1a947edfb6e38b81c18e1af01ccb9787634f7cbf", "message": "remove setters for several fields on VSConfig", "committedDate": "2020-02-20T22:35:21Z", "type": "commit"}, {"oid": "1cf006f96fc1db9f6eff1ee95a9c0fc272c7c312", "url": "https://github.com/elastic/elasticsearch/commit/1cf006f96fc1db9f6eff1ee95a9c0fc272c7c312", "message": "Merge branch 'feature/extensible-values-source' into vs-refactor-config-clean-up", "committedDate": "2020-02-24T19:03:19Z", "type": "commit"}, {"oid": "646408090524b8f9e6d87f7a729b9455d356fee2", "url": "https://github.com/elastic/elasticsearch/commit/646408090524b8f9e6d87f7a729b9455d356fee2", "message": "Restrict access on remaining mutators", "committedDate": "2020-02-24T20:17:51Z", "type": "commit"}, {"oid": "d36cfd3679f79a6906fe59713ccaeadfbe19793b", "url": "https://github.com/elastic/elasticsearch/commit/d36cfd3679f79a6906fe59713ccaeadfbe19793b", "message": "remove some outdated TODO notes", "committedDate": "2020-02-24T20:24:55Z", "type": "commit"}, {"oid": "0ecc7d9f26bf8c64df7f4a38f9b44acf5bbf1960", "url": "https://github.com/elastic/elasticsearch/commit/0ecc7d9f26bf8c64df7f4a38f9b44acf5bbf1960", "message": "Remove redundant parameter to toValuesSource", "committedDate": "2020-02-24T20:37:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwNTAzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/52729#discussion_r383505039", "bodyText": "Maybe a static method would be better for these two?", "author": "nik9000", "createdAt": "2020-02-24T20:47:24Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java", "diffHunk": "@@ -152,21 +137,55 @@ private static DocValueFormat resolveFormat(@Nullable String format, @Nullable V\n         return valuesSourceType.getFormatter(format, tz);\n     }\n \n-    private final ValuesSourceType valueSourceType;\n+    private final ValuesSourceType valuesSourceType;\n     private FieldContext fieldContext;\n     private AggregationScript.LeafFactory script;\n     private ValueType scriptValueType;\n-    private boolean unmapped = false;\n+    private boolean unmapped;\n     private DocValueFormat format = DocValueFormat.RAW;\n     private Object missing;\n     private ZoneId timeZone;\n+    private LongSupplier now;\n+\n+\n+    /**\n+     * Config instances which only need to specify a field should use this constructor\n+     */\n+    public ValuesSourceConfig(ValuesSourceType valuesSourceType,\n+                              MappedFieldType fieldType,\n+                              QueryShardContext queryShardContext) {\n+        this(valuesSourceType, fieldType, false, null, null, queryShardContext);\n+    }\n+\n+    /**\n+     * Convenience method for creating unmapped configs\n+     */\n+    public ValuesSourceConfig(ValuesSourceType valuesSourceType, QueryShardContext queryShardContext) {", "originalCommit": "0ecc7d9f26bf8c64df7f4a38f9b44acf5bbf1960", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwNTEzNA==", "url": "https://github.com/elastic/elasticsearch/pull/52729#discussion_r383505134", "bodyText": "They'd have names, at least.", "author": "nik9000", "createdAt": "2020-02-24T20:47:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwNTAzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwNjMxNw==", "url": "https://github.com/elastic/elasticsearch/pull/52729#discussion_r383506317", "bodyText": "nowSupplier?", "author": "nik9000", "createdAt": "2020-02-24T20:50:03Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java", "diffHunk": "@@ -152,21 +137,55 @@ private static DocValueFormat resolveFormat(@Nullable String format, @Nullable V\n         return valuesSourceType.getFormatter(format, tz);\n     }\n \n-    private final ValuesSourceType valueSourceType;\n+    private final ValuesSourceType valuesSourceType;\n     private FieldContext fieldContext;\n     private AggregationScript.LeafFactory script;\n     private ValueType scriptValueType;\n-    private boolean unmapped = false;\n+    private boolean unmapped;\n     private DocValueFormat format = DocValueFormat.RAW;\n     private Object missing;\n     private ZoneId timeZone;\n+    private LongSupplier now;\n+\n+\n+    /**\n+     * Config instances which only need to specify a field should use this constructor\n+     */\n+    public ValuesSourceConfig(ValuesSourceType valuesSourceType,\n+                              MappedFieldType fieldType,\n+                              QueryShardContext queryShardContext) {\n+        this(valuesSourceType, fieldType, false, null, null, queryShardContext);\n+    }\n+\n+    /**\n+     * Convenience method for creating unmapped configs\n+     */\n+    public ValuesSourceConfig(ValuesSourceType valuesSourceType, QueryShardContext queryShardContext) {\n+        this(valuesSourceType, null, true, null, null, queryShardContext);\n+    }\n+\n+    public ValuesSourceConfig(ValuesSourceType valuesSourceType,\n+                              MappedFieldType fieldType,\n+                              boolean unmapped,\n+                              AggregationScript.LeafFactory script,\n+                              ValueType scriptValueType,\n+                              QueryShardContext queryShardContext) {\n+        if (unmapped && fieldType != null) {\n+            throw new IllegalStateException(\"value source config is invalid; marked as unmapped but specified a mapped field\");\n+        }\n+        this.valuesSourceType = valuesSourceType;\n+        if (fieldType != null) {\n+            this.fieldContext = new FieldContext(fieldType.name(), queryShardContext.getForField(fieldType), fieldType);\n+        }\n+        this.unmapped = unmapped;\n+        this.script = script;\n+        this.scriptValueType = scriptValueType;\n+        this.now = queryShardContext::nowInMillis;", "originalCommit": "0ecc7d9f26bf8c64df7f4a38f9b44acf5bbf1960", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c293a8aa988f641e04183048cdb17f732973dfb5", "url": "https://github.com/elastic/elasticsearch/commit/c293a8aa988f641e04183048cdb17f732973dfb5", "message": "Response to PR feedback", "committedDate": "2020-02-24T21:54:28Z", "type": "commit"}, {"oid": "bc792961d2b34131ae175b6e9bbf53bfdd07d245", "url": "https://github.com/elastic/elasticsearch/commit/bc792961d2b34131ae175b6e9bbf53bfdd07d245", "message": "Ampersands in javadoc are compile errors", "committedDate": "2020-02-25T14:39:08Z", "type": "commit"}]}