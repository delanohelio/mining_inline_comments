{"pr_number": 52046, "pr_title": "Fix custom policy in plugins in FIPS 140", "pr_createdAt": "2020-02-07T14:05:38Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52046", "timeline": [{"oid": "0b650cd68776878fdedda6971b69f998bbaf30af", "url": "https://github.com/elastic/elasticsearch/commit/0b650cd68776878fdedda6971b69f998bbaf30af", "message": "Fix custom policy in plugins in FIPS 140\n\nOur FIPS 140 testing depends on setting the appropriate java policy\nin order to configure the JVM in FIPS mode. Some tests (\ndiscovery-ec2 and ccr qa ) also needed to set a custom policy file\nto grant a specific permission, which overwrote the FIPS related\npolicy and tests would fail. This change ensures that when a\ncustom policy needs to be set in these tests, the permissions that\nare necessary for FIPS are also set.\n\nResolves: #51685, #52034", "committedDate": "2020-02-07T14:00:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQwNjk4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/52046#discussion_r376406985", "bodyText": "There might be a way to read the policy as we set it in BuildPlugin ( \n  \n    \n      elasticsearch/buildSrc/src/main/groovy/org/elasticsearch/gradle/BuildPlugin.groovy\n    \n    \n         Line 167\n      in\n      5de8009\n    \n    \n    \n    \n\n        \n          \n           cluster.systemProperty('java.security.policy', '=${ES_PATH_CONF}/fips_java.policy') \n        \n    \n  \n\n ) and just write that to the file adding the 1 necessary grant but I'm not aware how we could do this, so I went with the easy way.", "author": "jkakavas", "createdAt": "2020-02-07T14:07:07Z", "path": "plugins/discovery-ec2/build.gradle", "diffHunk": "@@ -56,12 +58,34 @@ task writeTestJavaPolicy {\n       throw new GradleException(\"failed to create temporary directory [${tmp}]\")\n     }\n     final File javaPolicy = file(\"${tmp}/java.policy\")\n-    javaPolicy.write(\n-      [\n-        \"grant {\",\n-        \"  permission java.util.PropertyPermission \\\"com.amazonaws.sdk.ec2MetadataServiceEndpointOverride\\\", \\\"write\\\";\",\n-        \"};\"\n-      ].join(\"\\n\"))\n+    if (BuildParams.inFipsJvm) {\n+      javaPolicy.write(", "originalCommit": "0b650cd68776878fdedda6971b69f998bbaf30af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}