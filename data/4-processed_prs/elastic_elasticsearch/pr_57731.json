{"pr_number": 57731, "pr_title": "[ML] add new circuit breaker for inference model caching", "pr_createdAt": "2020-06-05T13:43:46Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57731", "timeline": [{"oid": "41c46cb2153b9d96371e5ae96bb9c3bf93047535", "url": "https://github.com/elastic/elasticsearch/commit/41c46cb2153b9d96371e5ae96bb9c3bf93047535", "message": "[ML] add new circuit breaker for inference model caching", "committedDate": "2020-06-05T13:38:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk0NTE4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/57731#discussion_r435945182", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ===== Machine learning circuit breaker settings\n          \n          \n            \n            ==== {ml-cap} circuit breaker settings", "author": "szabosteve", "createdAt": "2020-06-05T14:05:17Z", "path": "docs/reference/settings/ml-settings.asciidoc", "diffHunk": "@@ -137,3 +138,23 @@ to the {es} JVM. When such processes are started they must connect to the {es}\n JVM. If such a process does not connect within the time period specified by this\n setting then the process is assumed to have failed. Defaults to `10s`. The minimum\n value for this setting is `5s`.\n+\n+[[model-inference-circuit-breaker]]\n+===== Machine learning circuit breaker settings", "originalCommit": "41c46cb2153b9d96371e5ae96bb9c3bf93047535", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk1MDg4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/57731#discussion_r435950881", "bodyText": "This should fix the docs build.", "author": "szabosteve", "createdAt": "2020-06-05T14:14:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk0NTE4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk0ODk1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/57731#discussion_r435948952", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            `noop`, meaning the circuit breaker does nothing to prevent too much memory usage\n          \n          \n            \n            `noop`, meaning the circuit breaker does nothing to prevent too much memory usage,", "author": "szabosteve", "createdAt": "2020-06-05T14:11:16Z", "path": "docs/reference/settings/ml-settings.asciidoc", "diffHunk": "@@ -137,3 +138,23 @@ to the {es} JVM. When such processes are started they must connect to the {es}\n JVM. If such a process does not connect within the time period specified by this\n setting then the process is assumed to have failed. Defaults to `10s`. The minimum\n value for this setting is `5s`.\n+\n+[[model-inference-circuit-breaker]]\n+===== Machine learning circuit breaker settings\n+\n+`breaker.model_inference.limit` (<<cluster-update-settings,Dynamic>>)\n+Limit for model inference breaker, defaults to 40% of JVM heap.\n+This means that it is bound by the limit configured for the parent circuit breaker.\n+See <<circuit-breaker>>.\n+\n+`breaker.model_inference.overhead` (<<cluster-update-settings,Dynamic>>)\n+A constant that all accounting estimations are multiplied with to determine\n+a final estimation. Defaults to 1.\n+See <<circuit-breaker>>.\n+\n+`breaker.model_inference.type`\n+The underlying type of the circuit breaker. There are two valid options:\n+`noop`, meaning the circuit breaker does nothing to prevent too much memory usage", "originalCommit": "41c46cb2153b9d96371e5ae96bb9c3bf93047535", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f46d06d14bad35a3287b129f0dfe11d5bf3ff52f", "url": "https://github.com/elastic/elasticsearch/commit/f46d06d14bad35a3287b129f0dfe11d5bf3ff52f", "message": "Applying doc changes\n\nCo-authored-by: Istv\u00e1n Zolt\u00e1n Szab\u00f3 <istvan.szabo@elastic.co>", "committedDate": "2020-06-05T16:53:29Z", "type": "commit"}, {"oid": "e976f7937eeb8dba2742e29e83d70295dca5490c", "url": "https://github.com/elastic/elasticsearch/commit/e976f7937eeb8dba2742e29e83d70295dca5490c", "message": "Merge branch 'master' into feature/ml-add-custom-circuit-breaker", "committedDate": "2020-06-05T17:27:35Z", "type": "commit"}, {"oid": "f616ad99a8dd6f56a70889b766e74422e3984126", "url": "https://github.com/elastic/elasticsearch/commit/f616ad99a8dd6f56a70889b766e74422e3984126", "message": "Merge branch 'feature/ml-add-custom-circuit-breaker' of github.com:benwtrent/elasticsearch into feature/ml-add-custom-circuit-breaker", "committedDate": "2020-06-05T18:04:52Z", "type": "commit"}, {"oid": "ba79ba945eb5c76f1a644a4e3b76e8ed9488cce6", "url": "https://github.com/elastic/elasticsearch/commit/ba79ba945eb5c76f1a644a4e3b76e8ed9488cce6", "message": "adjusting breaker behavior", "committedDate": "2020-06-05T19:08:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY0NjA1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57731#discussion_r436646056", "bodyText": "Unused?\nThe ModelLoadedTracker is required to tell you when a model is loaded but that should not be necessary as assertBusys are used where behaviour is asserted", "author": "davidkyle", "createdAt": "2020-06-08T12:09:50Z", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/loadingservice/ModelLoadingServiceTests.java", "diffHunk": "@@ -370,6 +374,55 @@ public void testGetModelEagerly() throws Exception {\n         verify(trainedModelStatsService, never()).queueStats(any(InferenceStats.class), anyBoolean());\n     }\n \n+    public void testCircuitBreakerBreak() throws Exception {\n+        String model1 = \"test-circuit-break-model-1\";\n+        String model2 = \"test-circuit-break-model-2\";\n+        String model3 = \"test-circuit-break-model-3\";\n+        withTrainedModel(model1, 5L);\n+        withTrainedModel(model2, 5L);\n+        withTrainedModel(model3, 12L);\n+        CircuitBreaker circuitBreaker = new CustomCircuitBreaker(11);\n+        ModelLoadingService modelLoadingService = new ModelLoadingService(trainedModelProvider,\n+            auditor,\n+            threadPool,\n+            clusterService,\n+            trainedModelStatsService,\n+            Settings.EMPTY,\n+            \"test-node\",\n+            circuitBreaker);\n+\n+        // We want to be notified when the models are loaded which happens in a background thread\n+        ModelLoadedTracker loadedTracker = new ModelLoadedTracker(Arrays.asList(model1, model2));", "originalCommit": "ba79ba945eb5c76f1a644a4e3b76e8ed9488cce6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7b9919da2da082f618926df16408d407a2e41766", "url": "https://github.com/elastic/elasticsearch/commit/7b9919da2da082f618926df16408d407a2e41766", "message": "fixing internal cluster tests", "committedDate": "2020-06-08T13:55:28Z", "type": "commit"}, {"oid": "58f2a0f70b8385389de16d5eded33c08dd1b09aa", "url": "https://github.com/elastic/elasticsearch/commit/58f2a0f70b8385389de16d5eded33c08dd1b09aa", "message": "fixing tests", "committedDate": "2020-06-08T14:17:16Z", "type": "commit"}, {"oid": "9630d9a8afe756a2d905199d5cf11f9955a7530a", "url": "https://github.com/elastic/elasticsearch/commit/9630d9a8afe756a2d905199d5cf11f9955a7530a", "message": "Merge branch 'master' into feature/ml-add-custom-circuit-breaker", "committedDate": "2020-06-08T14:38:51Z", "type": "commit"}]}