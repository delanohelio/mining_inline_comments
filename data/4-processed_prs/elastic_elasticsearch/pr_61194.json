{"pr_number": 61194, "pr_title": "Allow running the Docker image with a non-default group", "pr_createdAt": "2020-08-17T11:29:10Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61194", "timeline": [{"oid": "9fe8c2ac14e8f5d1ab67618903ebeaad7368ccc3", "url": "https://github.com/elastic/elasticsearch/commit/9fe8c2ac14e8f5d1ab67618903ebeaad7368ccc3", "message": "Allow running the Docker image with a non-default group", "committedDate": "2020-08-17T11:03:11Z", "type": "commit"}, {"oid": "e98aa56633768858f26d050b09c720ab27bd6cc5", "url": "https://github.com/elastic/elasticsearch/commit/e98aa56633768858f26d050b09c720ab27bd6cc5", "message": "Docker tests fixes on Linux in CI and Vagrant", "committedDate": "2020-08-18T10:50:31Z", "type": "commit"}, {"oid": "26cdbf010970cc6a1ca3247890456c095075c0c6", "url": "https://github.com/elastic/elasticsearch/commit/26cdbf010970cc6a1ca3247890456c095075c0c6", "message": "More fixes", "committedDate": "2020-08-18T13:25:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg4MzY2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/61194#discussion_r474883667", "bodyText": "Should we enforce this in running the image itself?", "author": "rjernst", "createdAt": "2020-08-21T19:17:30Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/Docker.java", "diffHunk": "@@ -158,15 +183,31 @@ private static void executeDockerRun(Distribution distribution, Map<Path, Path>\n             volumes.forEach((localPath, containerPath) -> {\n                 assertThat(localPath, fileExists());\n \n-                if (Platforms.WINDOWS == false && System.getProperty(\"user.name\").equals(\"root\")) {\n+                if (Platforms.WINDOWS == false && System.getProperty(\"user.name\").equals(\"root\") && uid == null) {\n                     // The tests are running as root, but the process in the Docker container runs as `elasticsearch` (UID 1000),\n                     // so we need to ensure that the container process is able to read the bind-mounted files.\n+                    //\n+                    // NOTE that we don't do this if a UID is specified - in that case, we assume that the caller knows\n+                    // what they're doing!\n                     sh.run(\"chown -R 1000:0 \" + localPath);\n                 }\n                 args.add(\"--volume \\\"\" + localPath + \":\" + containerPath + \"\\\"\");\n             });\n         }\n \n+        if (uid == null) {\n+            if (gid != null) {\n+                throw new IllegalArgumentException(\"Cannot override GID without also overriding UID\");", "originalCommit": "26cdbf010970cc6a1ca3247890456c095075c0c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ4NzcyNg==", "url": "https://github.com/elastic/elasticsearch/pull/61194#discussion_r475487726", "bodyText": "According to the docker run documentation, you have to specify the user or UID, so I don't believe that's necessary.\nArguably the API for this test code is weak in that it allows you to pass a null uid and a non-null gid, but I felt it was overkill to introduce something more robust here.", "author": "pugnascotia", "createdAt": "2020-08-24T10:03:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg4MzY2Nw=="}], "type": "inlineReview"}]}