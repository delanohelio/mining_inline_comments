{"pr_number": 51033, "pr_title": "[Transform] Add yml test suite for testing remote clusters (CCS)", "pr_createdAt": "2020-01-15T11:51:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51033", "timeline": [{"oid": "8d09a497026e309dda75ce4b86c39d1009aff9c4", "url": "https://github.com/elastic/elasticsearch/commit/8d09a497026e309dda75ce4b86c39d1009aff9c4", "message": "add a test for operation_behind", "committedDate": "2020-01-15T18:51:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyMDYxMw==", "url": "https://github.com/elastic/elasticsearch/pull/51033#discussion_r369020613", "bodyText": "#TBD -> #51154", "author": "davidkyle", "createdAt": "2020-01-21T14:09:08Z", "path": "x-pack/qa/multi-cluster-tests-with-security/src/test/resources/rest-api-spec/test/multi_cluster/80_transform.yml", "diffHunk": "@@ -0,0 +1,261 @@\n+---\n+setup:\n+  - skip:\n+      features: headers\n+\n+  - do:\n+      cluster.health:\n+        wait_for_status: yellow\n+\n+  - do:\n+      security.put_user:\n+        username: \"joe\"\n+        body:  >\n+            {\n+              \"password\": \"transform\",\n+              \"roles\" : [  \"transform_admin\", \"x_cluster_role\" ]\n+            }\n+  - do:\n+      security.put_role:\n+        name: \"x_cluster_role\"\n+        body:  >\n+            {\n+              \"cluster\": [],\n+              \"indices\": [\n+                {\n+                  \"names\": [\"test_index\", \"my_remote_cluster:test_i*\", \"my_remote_cluster:aliased_test_index\"],\n+                  \"privileges\": [\"all\", \"view_index_metadata\"]\n+                },\n+                {\n+                  \"names\": [\"simple-remote-transform\", \"simple-local-remote-transform\"],\n+                  \"privileges\": [\"all\"]\n+                }\n+              ]\n+            }\n+---\n+teardown:\n+  - do:\n+      security.delete_user:\n+        username: \"joe\"\n+        ignore: 404\n+\n+---\n+\"Search remote cluster\":\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      search:\n+        rest_total_hits_as_int: true\n+        index: my_remote_cluster:test_index\n+        body:\n+          aggs:\n+            user:\n+              terms:\n+                field: user\n+\n+  - match: { _shards.total: 3 }\n+  - match: { hits.total: 9 }\n+  - length: { aggregations.user.buckets: 3 }\n+  - match: { aggregations.user.buckets.0.key: \"a\" }\n+  - match: { aggregations.user.buckets.0.doc_count: 5 }\n+\n+---\n+\"Batch transform from remote cluster\":\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.put_transform:\n+        transform_id: \"simple-remote-transform\"\n+        body: >\n+          {\n+            \"source\": { \"index\": \"my_remote_cluster:test_index\" },\n+            \"dest\": { \"index\": \"simple-remote-transform\" },\n+            \"pivot\": {\n+              \"group_by\": { \"user\": {\"terms\": {\"field\": \"user\"}}},\n+              \"aggs\": {\"avg_stars\": {\"avg\": {\"field\": \"stars\"}}}\n+            }\n+          }\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.start_transform:\n+        transform_id: \"simple-remote-transform\"\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      transform.get_transform_stats:\n+        transform_id: \"simple-remote-transform\"\n+  - match: { count: 1 }\n+  - match: { transforms.0.id: \"simple-remote-transform\" }\n+  - match: { transforms.0.state: \"/started|indexing|stopping|stopped/\" }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.stop_transform:\n+        transform_id: \"simple-remote-transform\"\n+        wait_for_completion: true\n+        wait_for_checkpoint: true\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.get_transform_stats:\n+        transform_id: \"simple-remote-transform\"\n+  - match: { count: 1 }\n+  - match: { transforms.0.id: \"simple-remote-transform\" }\n+  - match: { transforms.0.state: \"stopped\" }\n+  - match: { transforms.0.checkpointing.last.checkpoint: 1 }\n+\n+  # workaround: refresh dest index, to be removed, see gh #TBD", "originalCommit": "8d09a497026e309dda75ce4b86c39d1009aff9c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyMzUwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/51033#discussion_r369023509", "bodyText": "#TBD -> #51154", "author": "davidkyle", "createdAt": "2020-01-21T14:14:13Z", "path": "x-pack/qa/multi-cluster-tests-with-security/src/test/resources/rest-api-spec/test/multi_cluster/80_transform.yml", "diffHunk": "@@ -0,0 +1,261 @@\n+---\n+setup:\n+  - skip:\n+      features: headers\n+\n+  - do:\n+      cluster.health:\n+        wait_for_status: yellow\n+\n+  - do:\n+      security.put_user:\n+        username: \"joe\"\n+        body:  >\n+            {\n+              \"password\": \"transform\",\n+              \"roles\" : [  \"transform_admin\", \"x_cluster_role\" ]\n+            }\n+  - do:\n+      security.put_role:\n+        name: \"x_cluster_role\"\n+        body:  >\n+            {\n+              \"cluster\": [],\n+              \"indices\": [\n+                {\n+                  \"names\": [\"test_index\", \"my_remote_cluster:test_i*\", \"my_remote_cluster:aliased_test_index\"],\n+                  \"privileges\": [\"all\", \"view_index_metadata\"]\n+                },\n+                {\n+                  \"names\": [\"simple-remote-transform\", \"simple-local-remote-transform\"],\n+                  \"privileges\": [\"all\"]\n+                }\n+              ]\n+            }\n+---\n+teardown:\n+  - do:\n+      security.delete_user:\n+        username: \"joe\"\n+        ignore: 404\n+\n+---\n+\"Search remote cluster\":\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      search:\n+        rest_total_hits_as_int: true\n+        index: my_remote_cluster:test_index\n+        body:\n+          aggs:\n+            user:\n+              terms:\n+                field: user\n+\n+  - match: { _shards.total: 3 }\n+  - match: { hits.total: 9 }\n+  - length: { aggregations.user.buckets: 3 }\n+  - match: { aggregations.user.buckets.0.key: \"a\" }\n+  - match: { aggregations.user.buckets.0.doc_count: 5 }\n+\n+---\n+\"Batch transform from remote cluster\":\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.put_transform:\n+        transform_id: \"simple-remote-transform\"\n+        body: >\n+          {\n+            \"source\": { \"index\": \"my_remote_cluster:test_index\" },\n+            \"dest\": { \"index\": \"simple-remote-transform\" },\n+            \"pivot\": {\n+              \"group_by\": { \"user\": {\"terms\": {\"field\": \"user\"}}},\n+              \"aggs\": {\"avg_stars\": {\"avg\": {\"field\": \"stars\"}}}\n+            }\n+          }\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.start_transform:\n+        transform_id: \"simple-remote-transform\"\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      transform.get_transform_stats:\n+        transform_id: \"simple-remote-transform\"\n+  - match: { count: 1 }\n+  - match: { transforms.0.id: \"simple-remote-transform\" }\n+  - match: { transforms.0.state: \"/started|indexing|stopping|stopped/\" }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.stop_transform:\n+        transform_id: \"simple-remote-transform\"\n+        wait_for_completion: true\n+        wait_for_checkpoint: true\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.get_transform_stats:\n+        transform_id: \"simple-remote-transform\"\n+  - match: { count: 1 }\n+  - match: { transforms.0.id: \"simple-remote-transform\" }\n+  - match: { transforms.0.state: \"stopped\" }\n+  - match: { transforms.0.checkpointing.last.checkpoint: 1 }\n+\n+  # workaround: refresh dest index, to be removed, see gh #TBD\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      indices.refresh:\n+        index: simple-remote-transform\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      search:\n+        rest_total_hits_as_int: true\n+        index: simple-remote-transform\n+        sort: user\n+\n+  - match: { hits.total: 3 }\n+  - match: { hits.hits.0._index: simple-remote-transform }\n+  - match: { hits.hits.0._source.avg_stars: 3.6 }\n+  - match: { hits.hits.0._source.user: a }\n+  - match: { hits.hits.1._source.avg_stars: 2.0 }\n+  - match: { hits.hits.1._source.user: b }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.update_transform:\n+        transform_id: \"simple-remote-transform\"\n+        body: >\n+          {\n+            \"source\": { \"index\": [\"my_remote_cluster:test_index\", \"my_remote_cluster:test_index_2\"] }\n+          }\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.get_transform_stats:\n+        transform_id: \"simple-remote-transform\"\n+  - match: { count: 1 }\n+  - match: { transforms.0.id: \"simple-remote-transform\" }\n+  - match: { transforms.0.state: \"stopped\" }\n+  # we added test_index_2, which has 2 more docs:\n+  - match: { transforms.0.checkpointing.operations_behind: 2 }\n+\n+---\n+\"Batch transform from local and remote cluster\":\n+  - do:\n+      indices.create:\n+        index: test_index\n+        body:\n+          settings:\n+            index:\n+              number_of_shards: 3\n+              number_of_replicas: 0\n+          aliases:\n+            test_alias: {}\n+          mappings:\n+            properties:\n+              time:\n+                type: date\n+              user:\n+                type: keyword\n+              stars:\n+                type: integer\n+              coolness:\n+                type: integer\n+\n+  - do:\n+      bulk:\n+        refresh: true\n+        body:\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"a\", \"stars\": 3, \"date\" : \"2018-11-29T12:12:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"c\", \"stars\": 5, \"date\" : \"2018-11-29T12:14:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"d\", \"stars\": 5, \"date\" : \"2018-11-29T12:16:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"e\", \"stars\": 2, \"date\" : \"2018-11-29T12:17:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"b\", \"stars\": 3, \"date\" : \"2018-11-29T12:22:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"c\", \"stars\": 5, \"date\" : \"2018-11-29T12:23:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"d\", \"stars\": 1, \"date\" : \"2018-11-29T12:32:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"e\", \"stars\": 3, \"date\" : \"2018-11-29T12:34:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"c\", \"stars\": 4, \"date\" : \"2018-11-29T12:35:12.123456789Z\"}'\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.put_transform:\n+        transform_id: \"simple-local-remote-transform\"\n+        body: >\n+          {\n+            \"source\": { \"index\": [\"test_index\", \"my_remote_cluster:test_index\"] },\n+            \"dest\": { \"index\": \"simple-local-remote-transform\" },\n+            \"pivot\": {\n+              \"group_by\": { \"user\": {\"terms\": {\"field\": \"user\"}}},\n+              \"aggs\": {\n+                \"avg_stars\": {\"avg\": {\"field\": \"stars\"}},\n+                \"count\": {\"value_count\": {\"field\": \"user\"}}\n+              }\n+            }\n+          }\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.start_transform:\n+        transform_id: \"simple-local-remote-transform\"\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      transform.get_transform_stats:\n+        transform_id: \"simple-local-remote-transform\"\n+  - match: { count: 1 }\n+  - match: { transforms.0.id: \"simple-local-remote-transform\" }\n+  - match: { transforms.0.state: \"/started|indexing|stopping|stopped/\" }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.stop_transform:\n+        transform_id: \"simple-local-remote-transform\"\n+        wait_for_completion: true\n+        wait_for_checkpoint: true\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.get_transform_stats:\n+        transform_id: \"simple-local-remote-transform\"\n+  - match: { count: 1 }\n+  - match: { transforms.0.id: \"simple-local-remote-transform\" }\n+  - match: { transforms.0.state: \"stopped\" }\n+  - match: { transforms.0.checkpointing.last.checkpoint: 1 }\n+\n+  # workaround: refresh dest index, to be removed, see gh #TBD", "originalCommit": "8d09a497026e309dda75ce4b86c39d1009aff9c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "67a248a02364035aa8bb1f8af462158d769ed303", "url": "https://github.com/elastic/elasticsearch/commit/67a248a02364035aa8bb1f8af462158d769ed303", "message": "add a test suite for testing remote cluster features starting with transform", "committedDate": "2020-01-22T08:22:29Z", "type": "commit"}, {"oid": "76595faeb72f2e0b096b7346d1ada36d25d9c6b7", "url": "https://github.com/elastic/elasticsearch/commit/76595faeb72f2e0b096b7346d1ada36d25d9c6b7", "message": "add a test for operation_behind", "committedDate": "2020-01-22T08:22:29Z", "type": "commit"}, {"oid": "e160804961e5c7ff2f426febe352d7b6c8211081", "url": "https://github.com/elastic/elasticsearch/commit/e160804961e5c7ff2f426febe352d7b6c8211081", "message": "Update 80_transform.yml", "committedDate": "2020-01-22T08:22:29Z", "type": "commit"}, {"oid": "4c796e055c8b6a487ea78d5ed625b560c638cdd1", "url": "https://github.com/elastic/elasticsearch/commit/4c796e055c8b6a487ea78d5ed625b560c638cdd1", "message": "Update 80_transform.yml", "committedDate": "2020-01-22T08:22:29Z", "type": "commit"}, {"oid": "4c796e055c8b6a487ea78d5ed625b560c638cdd1", "url": "https://github.com/elastic/elasticsearch/commit/4c796e055c8b6a487ea78d5ed625b560c638cdd1", "message": "Update 80_transform.yml", "committedDate": "2020-01-22T08:22:29Z", "type": "forcePushed"}]}