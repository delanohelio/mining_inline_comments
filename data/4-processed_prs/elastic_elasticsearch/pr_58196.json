{"pr_number": 58196, "pr_title": "For the fields fetch phase, avoid reloading stored fields.", "pr_createdAt": "2020-06-16T20:14:20Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58196", "timeline": [{"oid": "2c7279db4689c526608aac2f832a32a73edfaa0f", "url": "https://github.com/elastic/elasticsearch/commit/2c7279db4689c526608aac2f832a32a73edfaa0f", "message": "For the fields fetch phase, avoid reloading stored fields.\n\nThis PR updates FetchFieldsPhase to override hitExecute instead of hitsExecute\n(plural). This way, we can make sure that the stored fields (including _source)\nare only loaded once per hit as part of FetchPhase.", "committedDate": "2020-06-16T20:22:37Z", "type": "commit"}, {"oid": "2c7279db4689c526608aac2f832a32a73edfaa0f", "url": "https://github.com/elastic/elasticsearch/commit/2c7279db4689c526608aac2f832a32a73edfaa0f", "message": "For the fields fetch phase, avoid reloading stored fields.\n\nThis PR updates FetchFieldsPhase to override hitExecute instead of hitsExecute\n(plural). This way, we can make sure that the stored fields (including _source)\nare only loaded once per hit as part of FetchPhase.", "committedDate": "2020-06-16T20:22:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyNDAzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/58196#discussion_r441124031", "bodyText": "Should we have the same logic in the else below or do we expect users to not use stored_fields in conjunction with the new fields option ?", "author": "jimczi", "createdAt": "2020-06-16T20:31:52Z", "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java", "diffHunk": "@@ -101,7 +101,8 @@ public void execute(SearchContext context) {\n             if (!context.hasScriptFields() && !context.hasFetchSourceContext()) {\n                 context.fetchSourceContext(new FetchSourceContext(true));\n             }\n-            fieldsVisitor = new FieldsVisitor(context.sourceRequested());\n+            boolean loadSource = context.sourceRequested() || context.fetchFieldsContext() != null;", "originalCommit": "2c7279db4689c526608aac2f832a32a73edfaa0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzNTg4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/58196#discussion_r441135885", "bodyText": "I think it'd be safest to add it below too.", "author": "nik9000", "createdAt": "2020-06-16T20:54:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyNDAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE0MTY2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/58196#discussion_r441141662", "bodyText": "Oops, thanks for catching this. I'll push an update.", "author": "jtibshirani", "createdAt": "2020-06-16T21:05:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyNDAzMQ=="}], "type": "inlineReview"}, {"oid": "b1ff79aa51408e581b9b993bbf043ff91b35d106", "url": "https://github.com/elastic/elasticsearch/commit/b1ff79aa51408e581b9b993bbf043ff91b35d106", "message": "Make sure to load _source when stored_fields are requested.", "committedDate": "2020-06-16T21:21:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE2MTQwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/58196#discussion_r441161409", "bodyText": "I tend to stick refresh on the index request.", "author": "nik9000", "createdAt": "2020-06-16T21:48:07Z", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/330_fetch_fields.yml", "diffHunk": "@@ -169,3 +169,51 @@ setup:\n \n   - match: { hits.hits.0.fields.integer.0: 42 }\n   - is_false: hits.hits.1.fields.integer\n+\n+---\n+\"Test disable _source loading\":\n+  - do:\n+      indices.create:\n+        index:  test\n+        body:\n+          settings:\n+            number_of_shards: 1\n+          mappings:\n+            properties:\n+              keyword:\n+                type: keyword\n+              integer:\n+                type: integer\n+                store: true\n+\n+  - do:\n+      index:\n+        index:  test\n+        id:     1\n+        body:\n+          keyword: \"x\"\n+          integer: 42\n+\n+  - do:", "originalCommit": "b1ff79aa51408e581b9b993bbf043ff91b35d106", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE2Mzc1NA==", "url": "https://github.com/elastic/elasticsearch/pull/58196#discussion_r441163754", "bodyText": "\ud83d\udc4d  this is nicer, especially when there's only one index request.", "author": "jtibshirani", "createdAt": "2020-06-16T21:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE2MTQwOQ=="}], "type": "inlineReview"}, {"oid": "02c5c599ddd2269417588657423c770430bfc5af", "url": "https://github.com/elastic/elasticsearch/commit/02c5c599ddd2269417588657423c770430bfc5af", "message": "Small simplification to YAML test.", "committedDate": "2020-06-16T21:54:44Z", "type": "commit"}]}