{"pr_number": 63573, "pr_title": "EQL: make allow_no_indices true by default", "pr_createdAt": "2020-10-12T18:09:46Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63573", "timeline": [{"oid": "198f1f528290adcd155c8ecc25804ffd0f0b52c8", "url": "https://github.com/elastic/elasticsearch/commit/198f1f528290adcd155c8ecc25804ffd0f0b52c8", "message": "Allow all indices options variants\nIrrespective of allow_no_indices value, throw VerificationException when\nthere is no index validated", "committedDate": "2020-10-12T17:49:10Z", "type": "commit"}, {"oid": "af85c63a1b8d2466cdfb1484891b124400be6586", "url": "https://github.com/elastic/elasticsearch/commit/af85c63a1b8d2466cdfb1484891b124400be6586", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 62986_fix", "committedDate": "2020-10-12T17:50:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2NzI2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63573#discussion_r503467263", "bodyText": "Use indices.isValid instead to check if the index is valid and if it's not, call toString() on it which returns the message instead of the index name.\nPotentially pass the listener in the method to call onFailure with the failure instead of throwing it.", "author": "costin", "createdAt": "2020-10-12T18:32:42Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/analysis/PreAnalyzer.java", "diffHunk": "@@ -6,16 +6,28 @@\n \n package org.elasticsearch.xpack.eql.analysis;\n \n+import org.elasticsearch.xpack.ql.common.Failure;\n+import org.elasticsearch.xpack.ql.index.EsIndex;\n import org.elasticsearch.xpack.ql.index.IndexResolution;\n+import org.elasticsearch.xpack.ql.index.MappingException;\n import org.elasticsearch.xpack.ql.plan.logical.EsRelation;\n import org.elasticsearch.xpack.ql.plan.logical.LogicalPlan;\n import org.elasticsearch.xpack.ql.plan.logical.UnresolvedRelation;\n \n+import java.util.Collections;\n+\n public class PreAnalyzer {\n \n     public LogicalPlan preAnalyze(LogicalPlan plan, IndexResolution indices) {\n+        EsIndex esIndex = null;\n+        // wrap a potential index_not_found_exception with a VerificationException (expected by client)\n+        try {\n+            esIndex = indices.get();\n+        } catch (MappingException me) {\n+            throw new VerificationException(Collections.singletonList(Failure.fail(plan, me.getMessage())));\n+        }", "originalCommit": "af85c63a1b8d2466cdfb1484891b124400be6586", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2Nzg5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63573#discussion_r503467891", "bodyText": "\ud83d\udc4d", "author": "costin", "createdAt": "2020-10-12T18:34:07Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/session/EqlSession.java", "diffHunk": "@@ -100,7 +100,7 @@ public void analyzedPlan(LogicalPlan parsed, ActionListener<LogicalPlan> listene\n             listener.onFailure(new TaskCancelledException(\"cancelled\"));\n             return;\n         }\n-        indexResolver.resolveAsMergedMapping(indexWildcard, null, configuration.includeFrozen(), configuration.filter(),\n+        indexResolver.resolveAsMergedMapping(indexWildcard, null, configuration.indicesOptions(), configuration.filter(),", "originalCommit": "af85c63a1b8d2466cdfb1484891b124400be6586", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ec93dc40d18b97da476eb1c3d734ba96cd3e6db2", "url": "https://github.com/elastic/elasticsearch/commit/ec93dc40d18b97da476eb1c3d734ba96cd3e6db2", "message": "Update PreAnalyzer", "committedDate": "2020-10-12T19:04:47Z", "type": "commit"}]}