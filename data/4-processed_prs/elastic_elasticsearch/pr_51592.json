{"pr_number": 51592, "pr_title": "SQL: improve timezone sensitive JDBC tests to account for offset differences", "pr_createdAt": "2020-01-29T07:40:34Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51592", "timeline": [{"oid": "4f424609af8327f22870c7bc5174109c99ae1cb4", "url": "https://github.com/elastic/elasticsearch/commit/4f424609af8327f22870c7bc5174109c99ae1cb4", "message": "* Changed one test to use fixed offsets\n* Changed several tests to compare only the relevant parts of the\nconversion failure error message and ignore the actual datetime String\nfrom the error message itself", "committedDate": "2020-01-29T07:36:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMxNzA4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/51592#discussion_r372317081", "bodyText": "Could you please add a comment here, for the 18 (maximum offset)?", "author": "matriv", "createdAt": "2020-01-29T11:00:20Z", "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/jdbc/ResultSetTestCase.java", "diffHunk": "@@ -879,10 +887,20 @@ public void testGettingDateWithoutCalendar() throws Exception {\n         Long randomLongDate = randomNonNegativeLong();\n         indexSimpleDocumentWithTrueValues(randomLongDate);\n         \n-        doWithQuery(SELECT_ALL_FIELDS, (results) -> {\n+        // Create simple timezones (in the form of Z/GMT+/-x so that timezones offsets differences between\n+        // Java versions (the one server runs on and the one the test runs on) will not skew the tests' results\n+        int hoursOffset = randomIntBetween(0, 18);", "originalCommit": "4f424609af8327f22870c7bc5174109c99ae1cb4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "abd222f3a1807ea36539313c83abaefbd9decd47", "url": "https://github.com/elastic/elasticsearch/commit/abd222f3a1807ea36539313c83abaefbd9decd47", "message": "Address review", "committedDate": "2020-01-29T11:32:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQyNTIxMA==", "url": "https://github.com/elastic/elasticsearch/pull/51592#discussion_r372425210", "bodyText": "Just a note: while GMT and UTC are identical in this timezones context, my impression is that there is a shift towards using the UTC for references.", "author": "bpintea", "createdAt": "2020-01-29T14:48:03Z", "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/jdbc/ResultSetTestCase.java", "diffHunk": "@@ -879,10 +887,23 @@ public void testGettingDateWithoutCalendar() throws Exception {\n         Long randomLongDate = randomNonNegativeLong();\n         indexSimpleDocumentWithTrueValues(randomLongDate);\n         \n-        doWithQuery(SELECT_ALL_FIELDS, (results) -> {\n+        /*\n+         * Create simple timezones (in the form of Z/GMT+/-x so that timezones offsets differences between Java versions (the one \n+         * server runs on and the one the test runs on) will not skew the tests' results.\n+         * -18/+18 is the maximum range of offsets accepted by ZoneOffset, even if in reality this range is more like [-12, +14].\n+         */\n+        int hoursOffset = randomIntBetween(0, 18);\n+        int subHours = hoursOffset != 18 ? randomFrom(0, 15, 30, 45) : 0;\n+        int plusMinus = randomBoolean() ? 1 : -1;\n+        int totalSeconds = (hoursOffset * 3600 + subHours * 60) * plusMinus;\n+        \n+        ZoneOffset randomFixedZone = ZoneOffset.ofTotalSeconds(totalSeconds);\n+        String zoneString = (hoursOffset == 0 && subHours == 0) ? \"Z\" : \"GMT\" + randomFixedZone.getId();", "originalCommit": "abd222f3a1807ea36539313c83abaefbd9decd47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}