{"pr_number": 62794, "pr_title": "Grok: Handle utf-8 natively", "pr_createdAt": "2020-09-22T21:46:11Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62794", "timeline": [{"oid": "28f31a8b75bf25ed98f1279c325586b51b1dcdc8", "url": "https://github.com/elastic/elasticsearch/commit/28f31a8b75bf25ed98f1279c325586b51b1dcdc8", "message": "Grok: Handle utf-8 natively\n\nThis adds a method to `Grok` that matches against sections offset from\nutf-8 byte arrays:\n```\nMap<String, Object> captures(byte[] utf8Bytes, int offset, int length)\n```\n\nThis'll be useful for the grok-flavored runtime fields because they\nwant to match against utf-8 encoded strings stored in a big array. And\njoni already supports this.", "committedDate": "2020-09-22T21:39:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ4NzE5NA==", "url": "https://github.com/elastic/elasticsearch/pull/62794#discussion_r493487194", "bodyText": "Ah, I was thrown off by this initially.\nThe region starts at index 0 and we have to offset it just like we did the initial match because we are extracting from the original utf8Bytes.\nBut the question is...if region.beg[number] is 0, how does region.end[number] - region.beg[number] work? Doesn't it have to take the offset into account too?", "author": "benwtrent", "createdAt": "2020-09-23T11:41:28Z", "path": "libs/grok/src/main/java/org/elasticsearch/grok/GrokCaptureConfig.java", "diffHunk": "@@ -54,10 +54,10 @@ public GrokCaptureType type() {\n         return type;\n     }\n \n-    Object extract(byte[] textAsBytes, Region region) {\n+    Object extract(byte[] utf8Bytes, int offset, Region region) {\n         for (int number : backRefs) {\n             if (region.beg[number] >= 0) {\n-                String matchValue = new String(textAsBytes, region.beg[number], region.end[number] - region.beg[number],\n+                String matchValue = new String(utf8Bytes, offset + region.beg[number], region.end[number] - region.beg[number],", "originalCommit": "28f31a8b75bf25ed98f1279c325586b51b1dcdc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzUzODY2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/62794#discussion_r493538667", "bodyText": "region.end[number] - region.beg[number] is a length so adding the offset would sort of break it.", "author": "nik9000", "createdAt": "2020-09-23T12:38:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ4NzE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzU0Njg4OA==", "url": "https://github.com/elastic/elasticsearch/pull/62794#discussion_r493546888", "bodyText": "@nik9000 D'OH", "author": "benwtrent", "createdAt": "2020-09-23T12:46:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ4NzE5NA=="}], "type": "inlineReview"}]}