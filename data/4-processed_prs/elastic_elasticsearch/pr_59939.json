{"pr_number": 59939, "pr_title": "Introduce javaRestTest source set/task and convert modules", "pr_createdAt": "2020-07-20T23:34:43Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59939", "timeline": [{"oid": "a65914c9d588d030a780b796f1c4aadce0768797", "url": "https://github.com/elastic/elasticsearch/commit/a65914c9d588d030a780b796f1c4aadce0768797", "message": "new javaRestTest plugin and 1/2 modules converted", "committedDate": "2020-07-20T22:30:22Z", "type": "commit"}, {"oid": "45bf3d85a0756b528cb26e04c01d41766a0b5b71", "url": "https://github.com/elastic/elasticsearch/commit/45bf3d85a0756b528cb26e04c01d41766a0b5b71", "message": "should all work", "committedDate": "2020-07-20T23:33:13Z", "type": "commit"}, {"oid": "319d6fac4b71d76dccd37fa44e73f0176f7aa70f", "url": "https://github.com/elastic/elasticsearch/commit/319d6fac4b71d76dccd37fa44e73f0176f7aa70f", "message": "spotless", "committedDate": "2020-07-21T12:53:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyMDk4OA==", "url": "https://github.com/elastic/elasticsearch/pull/59939#discussion_r458120988", "bodyText": "this was pulled from YamlRestTestPlugin so it can be reused with JavaRestTestPlugin. There are no substantive changes introduced here ... just copy/pasted.", "author": "jakelandis", "createdAt": "2020-07-21T14:02:15Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/AbstractRestTestPlugin.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n+import org.elasticsearch.gradle.test.RestIntegTestTask;\n+import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+/**\n+ * Helper parent to configure the necessary tasks and dependencies.\n+ */\n+public abstract class AbstractRestTestPlugin implements Plugin<Project> {", "originalCommit": "319d6fac4b71d76dccd37fa44e73f0176f7aa70f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3NjM1OA==", "url": "https://github.com/elastic/elasticsearch/pull/59939#discussion_r458376358", "bodyText": "All these methods can be static and therefore live in a utility class rather than an abstract class that must be extended.", "author": "mark-vieira", "createdAt": "2020-07-21T20:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyMDk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMxMDAxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/59939#discussion_r458310019", "bodyText": "nit: space after if\nHowever, should the integTest task be disabled through onlyIf? There is no guarantee the plugins checked for here will be applied before esplugin.", "author": "rjernst", "createdAt": "2020-07-21T18:39:37Z", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/plugin/PluginBuildPlugin.groovy", "diffHunk": "@@ -115,6 +115,11 @@ class PluginBuildPlugin implements Plugin<Project> {\n             if (isModule == false || isXPackModule) {\n                 addNoticeGeneration(project, extension1)\n             }\n+            if(project.pluginManager.hasPlugin(\"elasticsearch.yaml-rest-test\")", "originalCommit": "319d6fac4b71d76dccd37fa44e73f0176f7aa70f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMyNTc0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59939#discussion_r458325745", "bodyText": "fixed nit.\n\nThere is no guarantee the plugins checked for here will be applied before esplugin.\n\nThis is part of an project.afterEvaluate block, so I think it is guaranteed to be applied.", "author": "jakelandis", "createdAt": "2020-07-21T19:07:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMxMDAxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMxMzgxNA==", "url": "https://github.com/elastic/elasticsearch/pull/59939#discussion_r458313814", "bodyText": "Dont' we still need this system property for test?", "author": "rjernst", "createdAt": "2020-07-21T18:46:25Z", "path": "modules/transport-netty4/build.gradle", "diffHunk": "@@ -55,15 +59,15 @@ tasks.named(\"dependencyLicenses\").configure {\n   mapping from: /netty-.*/, to: 'netty'\n }\n \n-test {\n+internalClusterTest {", "originalCommit": "319d6fac4b71d76dccd37fa44e73f0176f7aa70f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMyNjIyMA==", "url": "https://github.com/elastic/elasticsearch/pull/59939#discussion_r458326220", "bodyText": "indeed. d5e4572 thanks!", "author": "jakelandis", "createdAt": "2020-07-21T19:08:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMxMzgxNA=="}], "type": "inlineReview"}, {"oid": "d5e45728ec18fa707685582cc0db065d45591f59", "url": "https://github.com/elastic/elasticsearch/commit/d5e45728ec18fa707685582cc0db065d45591f59", "message": "minor review changes", "committedDate": "2020-07-21T19:08:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3NTM0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59939#discussion_r458375346", "bodyText": "Let's not use afterEvaluate + hasPlugin. This is subject to configuration ordering. Let's instead move this outside of afterEvaluate and just use withPlugin to disable that integTest task whenever either of these plugins is applied.", "author": "mark-vieira", "createdAt": "2020-07-21T20:42:22Z", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/plugin/PluginBuildPlugin.groovy", "diffHunk": "@@ -115,6 +115,11 @@ class PluginBuildPlugin implements Plugin<Project> {\n             if (isModule == false || isXPackModule) {\n                 addNoticeGeneration(project, extension1)\n             }\n+            if (project.pluginManager.hasPlugin(\"elasticsearch.yaml-rest-test\")", "originalCommit": "d5e45728ec18fa707685582cc0db065d45591f59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3NzIwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/59939#discussion_r458377201", "bodyText": "So this doesn't actually remove this task, we simply disable it in a central location to remove noise from build scripts. What's keeping us from actually getting rid of this altogether?", "author": "mark-vieira", "createdAt": "2020-07-21T20:46:01Z", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/plugin/PluginBuildPlugin.groovy", "diffHunk": "@@ -115,6 +115,11 @@ class PluginBuildPlugin implements Plugin<Project> {\n             if (isModule == false || isXPackModule) {\n                 addNoticeGeneration(project, extension1)\n             }\n+            if (project.pluginManager.hasPlugin(\"elasticsearch.yaml-rest-test\")\n+                || project.pluginManager.hasPlugin(\"elasticsearch.java-rest-test\")) {\n+                //disable integTest task if project has been converted to use yaml or java rest test plugin\n+                project.tasks.integTest.enabled = false", "originalCommit": "d5e45728ec18fa707685582cc0db065d45591f59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM4MTIwNw==", "url": "https://github.com/elastic/elasticsearch/pull/59939#discussion_r458381207", "bodyText": "So this doesn't actually remove this task, we simply disable it in a central location to remove noise from build scripts.\n\ncorrect.\n\nWhat's keeping us from actually getting rid of this altogether?\n\nThis PR only covers modules.  I am in the process of converting all of the projects to this pattern. Once that is done, I can (and will) remove integTest from here.", "author": "jakelandis", "createdAt": "2020-07-21T20:53:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3NzIwMQ=="}], "type": "inlineReview"}, {"oid": "01521f972fc1d79ca201ce7e3f14ef1444f24626", "url": "https://github.com/elastic/elasticsearch/commit/01521f972fc1d79ca201ce7e3f14ef1444f24626", "message": "withPlugin and static methods", "committedDate": "2020-07-21T21:09:59Z", "type": "commit"}]}