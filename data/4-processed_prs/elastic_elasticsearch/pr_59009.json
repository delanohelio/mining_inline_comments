{"pr_number": 59009, "pr_title": "Clean searchable snapshots cache on startup", "pr_createdAt": "2020-07-03T11:50:57Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59009", "timeline": [{"oid": "8314c77d348440c0ff9230c84e29705aa4343129", "url": "https://github.com/elastic/elasticsearch/commit/8314c77d348440c0ff9230c84e29705aa4343129", "message": "Clean searchable snapshots cache on startup\n\nToday we empty the searchable snapshots cache when cleanly closing a\nshard, but leak cache files in some cases involving an unclean shutdown.\nSuch leaks are not permanent, they are cleaned up on shard relocation or\ndeletion, but they still might last for arbitrarily long until that\nhappens. This commit introduces a cleanup process that runs during node\nstartup to catch such leaks sooner.\n\nAlso, today we permit searchable snapshots to be held on custom data\npaths, and store the corresponding cache files within the custom\nlocation. Supporting this feature would make the cleanup process\nsignificantly more complicated since it would require each node to parse\nthe index metadata for the shards it held before shutdown. Yet, this\nfeature is undocumented and offers minimal benefits to searchable\nsnapshots. Therefore with this commit we forbid custom data paths for\nsearchable snapshot shards.", "committedDate": "2020-07-03T11:43:37Z", "type": "commit"}, {"oid": "dd5bd16ee784fc4a6213237cb3bd82c96f004c10", "url": "https://github.com/elastic/elasticsearch/commit/dd5bd16ee784fc4a6213237cb3bd82c96f004c10", "message": "No need to remove setting, we ignore it elsewhere", "committedDate": "2020-07-03T11:53:05Z", "type": "commit"}, {"oid": "f6e17d4787b92772bd5bbcbf35124f1f77287adc", "url": "https://github.com/elastic/elasticsearch/commit/f6e17d4787b92772bd5bbcbf35124f1f77287adc", "message": "Imports", "committedDate": "2020-07-03T12:01:58Z", "type": "commit"}, {"oid": "c31b5a5949be0412143e55d6e1d02300c0c3e43f", "url": "https://github.com/elastic/elasticsearch/commit/c31b5a5949be0412143e55d6e1d02300c0c3e43f", "message": "Add assertion", "committedDate": "2020-07-03T12:04:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAyMzU1NA==", "url": "https://github.com/elastic/elasticsearch/pull/59009#discussion_r450023554", "bodyText": "I've made a suggestion in Slack how we can possibly avoid introducing this setting. The idea is to simulate a crash by blocking write access to the disk during a restart, similar as is done in DiskDisruptionIT.", "author": "ywelsch", "createdAt": "2020-07-06T07:08:13Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheService.java", "diffHunk": "@@ -47,18 +48,39 @@\n         Setting.Property.NodeScope\n     );\n \n+    // Deliberately unregistered, we only use this in tests\n+    public static final Setting<Boolean> DELETE_ON_EVICTION_SETTING = Setting.boolSetting(", "originalCommit": "c31b5a5949be0412143e55d6e1d02300c0c3e43f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "169a0623785f839611564c2d2b72a32a134bfcdf", "url": "https://github.com/elastic/elasticsearch/commit/169a0623785f839611564c2d2b72a32a134bfcdf", "message": "Merge branch 'master' into 2020-07-03-clean-searchable-snapshots-cache", "committedDate": "2020-07-07T10:21:08Z", "type": "commit"}, {"oid": "fa00566bb01cffe9abe39357bb2d300d3aa3206e", "url": "https://github.com/elastic/elasticsearch/commit/fa00566bb01cffe9abe39357bb2d300d3aa3206e", "message": "Remove setting for tests", "committedDate": "2020-07-08T09:34:41Z", "type": "commit"}, {"oid": "86f8d74a5a8c755843406d8849a6c0e37467c72d", "url": "https://github.com/elastic/elasticsearch/commit/86f8d74a5a8c755843406d8849a6c0e37467c72d", "message": "Merge branch 'master' into 2020-07-03-clean-searchable-snapshots-cache", "committedDate": "2020-07-08T12:02:00Z", "type": "commit"}, {"oid": "2a346a53f32d095b3a356de962e3c81df7a20634", "url": "https://github.com/elastic/elasticsearch/commit/2a346a53f32d095b3a356de962e3c81df7a20634", "message": "Separate test harness", "committedDate": "2020-07-08T12:12:41Z", "type": "commit"}, {"oid": "47a6949d109a29bd4044defe7241f6f443d2bfff", "url": "https://github.com/elastic/elasticsearch/commit/47a6949d109a29bd4044defe7241f6f443d2bfff", "message": "Block deleteIfExists calls during shutdown", "committedDate": "2020-07-08T12:37:51Z", "type": "commit"}, {"oid": "825b94942e0ef02dfcf059920f229d7c5fb120bf", "url": "https://github.com/elastic/elasticsearch/commit/825b94942e0ef02dfcf059920f229d7c5fb120bf", "message": "Spotless", "committedDate": "2020-07-08T12:47:48Z", "type": "commit"}, {"oid": "c064b81331872f8017ac805f386cfce1afc377b0", "url": "https://github.com/elastic/elasticsearch/commit/c064b81331872f8017ac805f386cfce1afc377b0", "message": "Better URI scheme", "committedDate": "2020-07-08T12:58:25Z", "type": "commit"}]}