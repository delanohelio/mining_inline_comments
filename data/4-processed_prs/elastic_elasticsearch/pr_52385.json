{"pr_number": 52385, "pr_title": "Introduce system index APIs for Kibana", "pr_createdAt": "2020-02-14T21:41:34Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52385", "timeline": [{"oid": "9e8c2133a94dc1eeefe642b8ffc60908f6e108be", "url": "https://github.com/elastic/elasticsearch/commit/9e8c2133a94dc1eeefe642b8ffc60908f6e108be", "message": "Introduce system index APIs for Kibana\n\nThis commit introduces a module for Kibana that exposes REST APIs that\nwill be used by Kibana for access to its system indices.", "committedDate": "2020-02-14T21:37:47Z", "type": "commit"}, {"oid": "80c8c76250baa6ec638fa156568e959b499e7f72", "url": "https://github.com/elastic/elasticsearch/commit/80c8c76250baa6ec638fa156568e959b499e7f72", "message": "update method signatures", "committedDate": "2020-02-14T21:50:05Z", "type": "commit"}, {"oid": "8cb8a65cd070403e9d6b35e1421ebdeb49466068", "url": "https://github.com/elastic/elasticsearch/commit/8cb8a65cd070403e9d6b35e1421ebdeb49466068", "message": "s/compileOnly/compile", "committedDate": "2020-02-14T21:57:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2NTI4NA==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r379665284", "bodyText": "This caught my eye and after a quick search I see we do this all over the place. @rjernst any idea why were are explicitly declaring a dependency on the publishing project's runtime configuration? This is generally redundant as the default configuration for Java projects is this already.", "author": "mark-vieira", "createdAt": "2020-02-14T22:02:35Z", "path": "modules/kibana/build.gradle", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+esplugin {\n+  description 'Plugin exposing APIs for Kibana system indices'\n+  classname 'org.elasticsearch.kibana.KibanaPlugin'\n+}\n+\n+dependencies {\n+  compile project(path: ':modules:reindex', configuration: 'runtime')", "originalCommit": "8cb8a65cd070403e9d6b35e1421ebdeb49466068", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2NTkzMw==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r379665933", "bodyText": "Well actually, I think what the behavior of this is, is that we will bring in all the runtime dependencies of that project, but not the JAR for that project itself. Is that handled differently? Are we expecting the module jars to be on the runtime classpath already so no need?", "author": "mark-vieira", "createdAt": "2020-02-14T22:04:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2NTI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY3MDQxMA==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r379670410", "bodyText": "I don't recall why we have this in some places. I do now notice we explicitly declare the default configuration to extend runtime (in PluginBuildPlugin):\nproject.configurations.getByName('default').extendsFrom(project.configurations.getByName('runtime'))\n\nI vaguely recall having issues with getting the jars instead of the zip. In the case here, we are trying to reuse the request builders, but unfortunately we don't package or ship these, so we must pull in a copy of the entire module.", "author": "rjernst", "createdAt": "2020-02-14T22:18:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2NTI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5MTMyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r380891329", "bodyText": "I vaguely recall having issues with getting the jars instead of the zip.\n\nAh, this sounds like it makes sense. Thanks.", "author": "mark-vieira", "createdAt": "2020-02-18T19:37:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY2NTI4NA=="}], "type": "inlineReview"}, {"oid": "39b6290de81291fd90dd9458183e6ecf385bde8b", "url": "https://github.com/elastic/elasticsearch/commit/39b6290de81291fd90dd9458183e6ecf385bde8b", "message": "fix threadcontext serialization", "committedDate": "2020-02-18T16:37:49Z", "type": "commit"}, {"oid": "3d80bd35a2e13da6ca5535b1702162485cd368cc", "url": "https://github.com/elastic/elasticsearch/commit/3d80bd35a2e13da6ca5535b1702162485cd368cc", "message": "Merge branch 'master' into kibana_system_index_plugin", "committedDate": "2020-02-18T16:38:21Z", "type": "commit"}, {"oid": "758409c253d26d5b5e01bd8360446baa2c2dc9e2", "url": "https://github.com/elastic/elasticsearch/commit/758409c253d26d5b5e01bd8360446baa2c2dc9e2", "message": "add simple test for client that limits requests/indices", "committedDate": "2020-02-18T20:45:58Z", "type": "commit"}, {"oid": "45776166b848bf3c0a9aef962b9079b47c8b5580", "url": "https://github.com/elastic/elasticsearch/commit/45776166b848bf3c0a9aef962b9079b47c8b5580", "message": "set version on streamgit add .git add .git add .", "committedDate": "2020-02-18T21:14:37Z", "type": "commit"}, {"oid": "46325b2d08ac22af5eb43ce1f35254b82b3d8dd6", "url": "https://github.com/elastic/elasticsearch/commit/46325b2d08ac22af5eb43ce1f35254b82b3d8dd6", "message": "Merge branch 'master' into kibana_system_index_plugin", "committedDate": "2020-02-19T19:33:09Z", "type": "commit"}, {"oid": "b0194a8f9cdbd8a238738635f07edb2c4efaa770", "url": "https://github.com/elastic/elasticsearch/commit/b0194a8f9cdbd8a238738635f07edb2c4efaa770", "message": "add tests for APIs", "committedDate": "2020-02-19T20:53:10Z", "type": "commit"}, {"oid": "86a27ce6704b437b64010fcec4f289a9307437dc", "url": "https://github.com/elastic/elasticsearch/commit/86a27ce6704b437b64010fcec4f289a9307437dc", "message": "Merge branch 'master' into kibana_system_index_plugin", "committedDate": "2020-02-20T17:17:04Z", "type": "commit"}, {"oid": "16e5e87685b1084fc88ed06794eeabb914e6bf25", "url": "https://github.com/elastic/elasticsearch/commit/16e5e87685b1084fc88ed06794eeabb914e6bf25", "message": "rest controller test for system index restriction", "committedDate": "2020-02-20T17:27:17Z", "type": "commit"}, {"oid": "d9fa9aef67db86315e4aeda90a8ed808d728e247", "url": "https://github.com/elastic/elasticsearch/commit/d9fa9aef67db86315e4aeda90a8ed808d728e247", "message": "threadcontext tests", "committedDate": "2020-02-20T18:54:19Z", "type": "commit"}, {"oid": "15aad51ae3fc65e8df98172df1a366300fbf6cf7", "url": "https://github.com/elastic/elasticsearch/commit/15aad51ae3fc65e8df98172df1a366300fbf6cf7", "message": "Merge branch 'master' into kibana_system_index_plugin", "committedDate": "2020-02-20T20:25:15Z", "type": "commit"}, {"oid": "2dabec85fd4a289cfc5e4227e0d95cc815929a8d", "url": "https://github.com/elastic/elasticsearch/commit/2dabec85fd4a289cfc5e4227e0d95cc815929a8d", "message": "no randomBoolean in static value", "committedDate": "2020-02-20T20:26:29Z", "type": "commit"}, {"oid": "43e735e909e8160a55b7ea7ee580df3aed5bd740", "url": "https://github.com/elastic/elasticsearch/commit/43e735e909e8160a55b7ea7ee580df3aed5bd740", "message": "Merge branch 'master' into kibana_system_index_plugin", "committedDate": "2020-02-25T16:49:31Z", "type": "commit"}, {"oid": "3bf05f16d3611e4b739b6b712176697daabaff55", "url": "https://github.com/elastic/elasticsearch/commit/3bf05f16d3611e4b739b6b712176697daabaff55", "message": "Merge branch 'master' into kibana_system_index_plugin", "committedDate": "2020-02-26T20:02:38Z", "type": "commit"}, {"oid": "2a749968b156b57cc1258f4272f37415f03c9325", "url": "https://github.com/elastic/elasticsearch/commit/2a749968b156b57cc1258f4272f37415f03c9325", "message": "add APIs listed in Kibana issue", "committedDate": "2020-02-26T20:33:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1MjQyNw==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r384752427", "bodyText": "@tylersmalley I was looking at elastic/kibana#49764 and I wanted to make sure I understood the request there for the paths where you have _kibana/{kibana.name}/ and kibana.name would be understood by elasticsearch based on settings.\nRight now in this plugin, the setting I have would look like this in the elasticsearch.yml file:\nkibana.system_indices: [ \".kibana\", \".kibana_task_manager\", \".reporting\" ]\nI think the Kibana issue is actually looking for something more like:\nkibana:\n  instances:\n    my_kibana:\n       kibana_index: \".my-kibana\"\n       task_manager_index: \".my-tm\"\n       reporting_index: \".my-reports\"\nIs this correct?", "author": "jaymode", "createdAt": "2020-02-26T20:41:06Z", "path": "modules/kibana/src/main/java/org/elasticsearch/kibana/KibanaPlugin.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.kibana;\n+\n+import org.apache.lucene.util.automaton.Automaton;\n+import org.apache.lucene.util.automaton.CharacterRunAutomaton;\n+import org.apache.lucene.util.automaton.Operations;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.ActionResponse;\n+import org.elasticsearch.action.ActionType;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.IndicesRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.get.MultiGetRequest;\n+import org.elasticsearch.action.get.MultiGetRequest.Item;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.node.DiscoveryNodes;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.regex.Regex;\n+import org.elasticsearch.common.settings.ClusterSettings;\n+import org.elasticsearch.common.settings.IndexScopedSettings;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Setting.Property;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.settings.SettingsFilter;\n+import org.elasticsearch.index.reindex.RestDeleteByQueryAction;\n+import org.elasticsearch.indices.SystemIndexDescriptor;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.SystemIndexPlugin;\n+import org.elasticsearch.rest.BaseRestHandler;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestHandler;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+import org.elasticsearch.rest.action.admin.indices.RestGetAliasesAction;\n+import org.elasticsearch.rest.action.admin.indices.RestGetIndicesAction;\n+import org.elasticsearch.rest.action.admin.indices.RestIndexPutAliasAction;\n+import org.elasticsearch.rest.action.admin.indices.RestRefreshAction;\n+import org.elasticsearch.rest.action.admin.indices.RestUpdateSettingsAction;\n+import org.elasticsearch.rest.action.document.RestBulkAction;\n+import org.elasticsearch.rest.action.document.RestDeleteAction;\n+import org.elasticsearch.rest.action.document.RestGetAction;\n+import org.elasticsearch.rest.action.document.RestIndexAction;\n+import org.elasticsearch.rest.action.document.RestMultiGetAction;\n+import org.elasticsearch.rest.action.document.RestUpdateAction;\n+import org.elasticsearch.rest.action.search.RestClearScrollAction;\n+import org.elasticsearch.rest.action.search.RestSearchAction;\n+import org.elasticsearch.rest.action.search.RestSearchScrollAction;\n+import org.elasticsearch.tasks.Task;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+\n+import static java.util.Collections.unmodifiableList;\n+\n+public class KibanaPlugin extends Plugin implements SystemIndexPlugin {\n+\n+    public static final Setting<List<String>> KIBANA_INDEX_NAMES_SETTING = Setting.listSetting(\"kibana.system_indices\",", "originalCommit": "2a749968b156b57cc1258f4272f37415f03c9325", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgxNDU5NA==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r384814594", "bodyText": "The latter is correct. Ideally, I would like to define a list of names which we could derive each index off of, but that won't work today as users can configure them individually.\nIn that example, would the endpoint be _kibana/my_kibana/*?\nIt would probably also make sense to include a default so Kibana instance configuration is only necessary if they intend on having multiple instances.", "author": "tylersmalley", "createdAt": "2020-02-26T22:47:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1MjQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgyODIyNw==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r384828227", "bodyText": "Yes that would be the endpoint path. For the default, I think we will still want an instance name so maybe just \u2018kibana\u2019 for that?", "author": "jaymode", "createdAt": "2020-02-26T23:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1MjQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzODg4MA==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r384838880", "bodyText": "Agreed. Though, could we use default for the name of the default instance? I feel this should be clear as to what the instance is and avoid _kibana/kibana/*", "author": "tylersmalley", "createdAt": "2020-02-26T23:57:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1MjQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA0NDc3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r385044771", "bodyText": "What is the risk for not whitelisting kibana instances and indices? From a user's perspective it's error prone to have to adjust both the kibana and elasticsearch config files and keep them in sync. The status quo is that Kibana creates any instances (it's currently just an index prefix) and indices it wants to.", "author": "rudolf", "createdAt": "2020-02-27T10:39:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1MjQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIyNDQwMg==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r385224402", "bodyText": "Every system index plugin needs to declare the system indices it is used for as a way to identify indices that are system indices. If you are ok with just creating all of your indices under a single prefix, then I think that would be fine.", "author": "jaymode", "createdAt": "2020-02-27T16:32:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1MjQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIyODA0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r385228046", "bodyText": "A question was also brought up as to if we would consider this a breaking change if it was introduced before 8.0. Currently, to migrate to the system indices the user would be required to update ES and Kibana configuration.\nThe prefixing is interesting idea worth exploring, but would require coming up with a plan to migrate to these index names, correct?", "author": "tylersmalley", "createdAt": "2020-02-27T16:37:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1MjQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0MjAyOA==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r385242028", "bodyText": "Good point on it being breaking. One thing we can do is allow the APIs under /_kibana to be unrestricted for the indices that could be used in 7.x.", "author": "jaymode", "createdAt": "2020-02-27T16:59:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1MjQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1MjA5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r385352097", "bodyText": "For the time being, I have gone ahead and removed the limiting of indices accessible by the APIs until we figure out what we should do here regarding these indices and their names.", "author": "jaymode", "createdAt": "2020-02-27T20:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1MjQyNw=="}], "type": "inlineReview"}, {"oid": "2a8b63747fe4a06df2ac63192c9c5c8931370dd5", "url": "https://github.com/elastic/elasticsearch/commit/2a8b63747fe4a06df2ac63192c9c5c8931370dd5", "message": "add reporting", "committedDate": "2020-02-26T20:53:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgxNjY2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r384816662", "bodyText": "Nitpick:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .map(pattern -> new SystemIndexDescriptor(pattern, \"System indices used by kibana\"))\n          \n          \n            \n                        .map(pattern -> new SystemIndexDescriptor(pattern, \"System index used by kibana\"))\n          \n      \n    \n    \n  \n\nThe description applies to a single index, not multiple.", "author": "gwbrown", "createdAt": "2020-02-26T22:52:41Z", "path": "modules/kibana/src/main/java/org/elasticsearch/kibana/KibanaPlugin.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.kibana;\n+\n+import org.apache.lucene.util.automaton.Automaton;\n+import org.apache.lucene.util.automaton.CharacterRunAutomaton;\n+import org.apache.lucene.util.automaton.Operations;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.ActionResponse;\n+import org.elasticsearch.action.ActionType;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.IndicesRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.get.MultiGetRequest;\n+import org.elasticsearch.action.get.MultiGetRequest.Item;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.node.DiscoveryNodes;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.regex.Regex;\n+import org.elasticsearch.common.settings.ClusterSettings;\n+import org.elasticsearch.common.settings.IndexScopedSettings;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Setting.Property;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.settings.SettingsFilter;\n+import org.elasticsearch.index.reindex.RestDeleteByQueryAction;\n+import org.elasticsearch.indices.SystemIndexDescriptor;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.SystemIndexPlugin;\n+import org.elasticsearch.rest.BaseRestHandler;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestHandler;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+import org.elasticsearch.rest.action.admin.indices.RestGetAliasesAction;\n+import org.elasticsearch.rest.action.admin.indices.RestGetIndicesAction;\n+import org.elasticsearch.rest.action.admin.indices.RestIndexPutAliasAction;\n+import org.elasticsearch.rest.action.admin.indices.RestRefreshAction;\n+import org.elasticsearch.rest.action.admin.indices.RestUpdateSettingsAction;\n+import org.elasticsearch.rest.action.document.RestBulkAction;\n+import org.elasticsearch.rest.action.document.RestDeleteAction;\n+import org.elasticsearch.rest.action.document.RestGetAction;\n+import org.elasticsearch.rest.action.document.RestIndexAction;\n+import org.elasticsearch.rest.action.document.RestMultiGetAction;\n+import org.elasticsearch.rest.action.document.RestUpdateAction;\n+import org.elasticsearch.rest.action.search.RestClearScrollAction;\n+import org.elasticsearch.rest.action.search.RestSearchAction;\n+import org.elasticsearch.rest.action.search.RestSearchScrollAction;\n+import org.elasticsearch.tasks.Task;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+\n+import static java.util.Collections.unmodifiableList;\n+\n+public class KibanaPlugin extends Plugin implements SystemIndexPlugin {\n+\n+    public static final Setting<List<String>> KIBANA_INDEX_NAMES_SETTING = Setting.listSetting(\"kibana.system_indices\",\n+        unmodifiableList(Arrays.asList(\".kibana\", \".kibana_task_manager\", \".reporting\")), Function.identity(), Property.NodeScope);\n+\n+    @Override\n+    public Collection<SystemIndexDescriptor> getSystemIndexDescriptors(Settings settings) {\n+        return KIBANA_INDEX_NAMES_SETTING.get(settings).stream()\n+            .map(pattern -> new SystemIndexDescriptor(pattern, \"System indices used by kibana\"))", "originalCommit": "2a8b63747fe4a06df2ac63192c9c5c8931370dd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgxODU2OA==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r384818568", "bodyText": "Do you think this is worth breaking out into its own file, rather than nesting it in the Kibana plugin? This seems like it might be useful for any other plugins that follow this pattern.", "author": "gwbrown", "createdAt": "2020-02-26T22:57:16Z", "path": "modules/kibana/src/main/java/org/elasticsearch/kibana/KibanaPlugin.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.kibana;\n+\n+import org.apache.lucene.util.automaton.Automaton;\n+import org.apache.lucene.util.automaton.CharacterRunAutomaton;\n+import org.apache.lucene.util.automaton.Operations;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.ActionResponse;\n+import org.elasticsearch.action.ActionType;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.IndicesRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.get.MultiGetRequest;\n+import org.elasticsearch.action.get.MultiGetRequest.Item;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.node.DiscoveryNodes;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.regex.Regex;\n+import org.elasticsearch.common.settings.ClusterSettings;\n+import org.elasticsearch.common.settings.IndexScopedSettings;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Setting.Property;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.settings.SettingsFilter;\n+import org.elasticsearch.index.reindex.RestDeleteByQueryAction;\n+import org.elasticsearch.indices.SystemIndexDescriptor;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.SystemIndexPlugin;\n+import org.elasticsearch.rest.BaseRestHandler;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestHandler;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+import org.elasticsearch.rest.action.admin.indices.RestGetAliasesAction;\n+import org.elasticsearch.rest.action.admin.indices.RestGetIndicesAction;\n+import org.elasticsearch.rest.action.admin.indices.RestIndexPutAliasAction;\n+import org.elasticsearch.rest.action.admin.indices.RestRefreshAction;\n+import org.elasticsearch.rest.action.admin.indices.RestUpdateSettingsAction;\n+import org.elasticsearch.rest.action.document.RestBulkAction;\n+import org.elasticsearch.rest.action.document.RestDeleteAction;\n+import org.elasticsearch.rest.action.document.RestGetAction;\n+import org.elasticsearch.rest.action.document.RestIndexAction;\n+import org.elasticsearch.rest.action.document.RestMultiGetAction;\n+import org.elasticsearch.rest.action.document.RestUpdateAction;\n+import org.elasticsearch.rest.action.search.RestClearScrollAction;\n+import org.elasticsearch.rest.action.search.RestSearchAction;\n+import org.elasticsearch.rest.action.search.RestSearchScrollAction;\n+import org.elasticsearch.tasks.Task;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+\n+import static java.util.Collections.unmodifiableList;\n+\n+public class KibanaPlugin extends Plugin implements SystemIndexPlugin {\n+\n+    public static final Setting<List<String>> KIBANA_INDEX_NAMES_SETTING = Setting.listSetting(\"kibana.system_indices\",\n+        unmodifiableList(Arrays.asList(\".kibana\", \".kibana_task_manager\", \".reporting\")), Function.identity(), Property.NodeScope);\n+\n+    @Override\n+    public Collection<SystemIndexDescriptor> getSystemIndexDescriptors(Settings settings) {\n+        return KIBANA_INDEX_NAMES_SETTING.get(settings).stream()\n+            .map(pattern -> new SystemIndexDescriptor(pattern, \"System indices used by kibana\"))\n+            .collect(Collectors.toUnmodifiableList());\n+    }\n+\n+    @Override\n+    public List<RestHandler> getRestHandlers(Settings settings, RestController restController, ClusterSettings clusterSettings,\n+                                             IndexScopedSettings indexScopedSettings, SettingsFilter settingsFilter,\n+                                             IndexNameExpressionResolver indexNameExpressionResolver,\n+                                             Supplier<DiscoveryNodes> nodesInCluster) {\n+        final List<String> allowedIndexPatterns = KIBANA_INDEX_NAMES_SETTING.get(settings);\n+        return List.of(\n+            // Based on https://github.com/elastic/kibana/issues/49764\n+            // apis needed to perform migrations... ideally these will go away\n+            new KibanaWrappedRestHandler(new RestCreateIndexAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestGetAliasesAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestIndexPutAliasAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestRefreshAction(), allowedIndexPatterns),\n+\n+            // apis needed to access saved objects\n+            new KibanaWrappedRestHandler(new RestGetAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestMultiGetAction(settings), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestSearchAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestBulkAction(settings), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestDeleteAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestDeleteByQueryAction(), allowedIndexPatterns),\n+\n+            // api used for testing\n+            new KibanaWrappedRestHandler(new RestUpdateSettingsAction(), allowedIndexPatterns),\n+\n+            // apis used specifically by reporting\n+            new KibanaWrappedRestHandler(new RestGetIndicesAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestIndexAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestUpdateAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestSearchScrollAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestClearScrollAction(), allowedIndexPatterns)\n+        );\n+\n+    }\n+\n+    @Override\n+    public List<Setting<?>> getSettings() {\n+        return List.of(KIBANA_INDEX_NAMES_SETTING);\n+    }\n+\n+    static class KibanaWrappedRestHandler extends BaseRestHandler.Wrapper {\n+\n+        private final List<String> allowedIndexPatterns;\n+\n+        KibanaWrappedRestHandler(BaseRestHandler delegate, List<String> allowedIndexPatterns) {\n+            super(delegate);\n+            this.allowedIndexPatterns = allowedIndexPatterns;\n+        }\n+\n+        @Override\n+        public String getName() {\n+            return \"kibana_\" + super.getName();\n+        }\n+\n+        @Override\n+        public List<Route> routes() {\n+            return super.routes().stream().map(route -> new Route(route.getMethod(), \"/_kibana\" + route.getPath()))\n+                .collect(Collectors.toUnmodifiableList());\n+        }\n+\n+        @Override\n+        protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient client) throws IOException {\n+            client.threadPool().getThreadContext().allowSystemIndexAccess(allowedIndexPatterns);\n+            return super.prepareRequest(request, new IndexLimitingNodeClient(client, allowedIndexPatterns));\n+        }\n+    }\n+\n+    static class IndexLimitingNodeClient extends NodeClient {", "originalCommit": "2a8b63747fe4a06df2ac63192c9c5c8931370dd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIxOTU2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r385219563", "bodyText": "I am not ready to break this out just yet because there are no guarantees that its functional beyond the APIs used by this plugin. Also, I still have some reservations about whether I should do it this way or handle it elsewhere.", "author": "jaymode", "createdAt": "2020-02-27T16:25:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgxODU2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgyMDU2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r384820567", "bodyText": "We might need wildcard support eventually, although I don't think we do for Kibana (@tylersmalley do you know?). Date math support is more questionable. It might be worth trying to detect it and throwing an exception, similar to what we do here.", "author": "gwbrown", "createdAt": "2020-02-26T23:02:20Z", "path": "modules/kibana/src/main/java/org/elasticsearch/kibana/KibanaPlugin.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.kibana;\n+\n+import org.apache.lucene.util.automaton.Automaton;\n+import org.apache.lucene.util.automaton.CharacterRunAutomaton;\n+import org.apache.lucene.util.automaton.Operations;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.ActionResponse;\n+import org.elasticsearch.action.ActionType;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.IndicesRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.get.MultiGetRequest;\n+import org.elasticsearch.action.get.MultiGetRequest.Item;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.node.DiscoveryNodes;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.regex.Regex;\n+import org.elasticsearch.common.settings.ClusterSettings;\n+import org.elasticsearch.common.settings.IndexScopedSettings;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Setting.Property;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.settings.SettingsFilter;\n+import org.elasticsearch.index.reindex.RestDeleteByQueryAction;\n+import org.elasticsearch.indices.SystemIndexDescriptor;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.SystemIndexPlugin;\n+import org.elasticsearch.rest.BaseRestHandler;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestHandler;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+import org.elasticsearch.rest.action.admin.indices.RestGetAliasesAction;\n+import org.elasticsearch.rest.action.admin.indices.RestGetIndicesAction;\n+import org.elasticsearch.rest.action.admin.indices.RestIndexPutAliasAction;\n+import org.elasticsearch.rest.action.admin.indices.RestRefreshAction;\n+import org.elasticsearch.rest.action.admin.indices.RestUpdateSettingsAction;\n+import org.elasticsearch.rest.action.document.RestBulkAction;\n+import org.elasticsearch.rest.action.document.RestDeleteAction;\n+import org.elasticsearch.rest.action.document.RestGetAction;\n+import org.elasticsearch.rest.action.document.RestIndexAction;\n+import org.elasticsearch.rest.action.document.RestMultiGetAction;\n+import org.elasticsearch.rest.action.document.RestUpdateAction;\n+import org.elasticsearch.rest.action.search.RestClearScrollAction;\n+import org.elasticsearch.rest.action.search.RestSearchAction;\n+import org.elasticsearch.rest.action.search.RestSearchScrollAction;\n+import org.elasticsearch.tasks.Task;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+\n+import static java.util.Collections.unmodifiableList;\n+\n+public class KibanaPlugin extends Plugin implements SystemIndexPlugin {\n+\n+    public static final Setting<List<String>> KIBANA_INDEX_NAMES_SETTING = Setting.listSetting(\"kibana.system_indices\",\n+        unmodifiableList(Arrays.asList(\".kibana\", \".kibana_task_manager\", \".reporting\")), Function.identity(), Property.NodeScope);\n+\n+    @Override\n+    public Collection<SystemIndexDescriptor> getSystemIndexDescriptors(Settings settings) {\n+        return KIBANA_INDEX_NAMES_SETTING.get(settings).stream()\n+            .map(pattern -> new SystemIndexDescriptor(pattern, \"System indices used by kibana\"))\n+            .collect(Collectors.toUnmodifiableList());\n+    }\n+\n+    @Override\n+    public List<RestHandler> getRestHandlers(Settings settings, RestController restController, ClusterSettings clusterSettings,\n+                                             IndexScopedSettings indexScopedSettings, SettingsFilter settingsFilter,\n+                                             IndexNameExpressionResolver indexNameExpressionResolver,\n+                                             Supplier<DiscoveryNodes> nodesInCluster) {\n+        final List<String> allowedIndexPatterns = KIBANA_INDEX_NAMES_SETTING.get(settings);\n+        return List.of(\n+            // Based on https://github.com/elastic/kibana/issues/49764\n+            // apis needed to perform migrations... ideally these will go away\n+            new KibanaWrappedRestHandler(new RestCreateIndexAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestGetAliasesAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestIndexPutAliasAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestRefreshAction(), allowedIndexPatterns),\n+\n+            // apis needed to access saved objects\n+            new KibanaWrappedRestHandler(new RestGetAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestMultiGetAction(settings), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestSearchAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestBulkAction(settings), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestDeleteAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestDeleteByQueryAction(), allowedIndexPatterns),\n+\n+            // api used for testing\n+            new KibanaWrappedRestHandler(new RestUpdateSettingsAction(), allowedIndexPatterns),\n+\n+            // apis used specifically by reporting\n+            new KibanaWrappedRestHandler(new RestGetIndicesAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestIndexAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestUpdateAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestSearchScrollAction(), allowedIndexPatterns),\n+            new KibanaWrappedRestHandler(new RestClearScrollAction(), allowedIndexPatterns)\n+        );\n+\n+    }\n+\n+    @Override\n+    public List<Setting<?>> getSettings() {\n+        return List.of(KIBANA_INDEX_NAMES_SETTING);\n+    }\n+\n+    static class KibanaWrappedRestHandler extends BaseRestHandler.Wrapper {\n+\n+        private final List<String> allowedIndexPatterns;\n+\n+        KibanaWrappedRestHandler(BaseRestHandler delegate, List<String> allowedIndexPatterns) {\n+            super(delegate);\n+            this.allowedIndexPatterns = allowedIndexPatterns;\n+        }\n+\n+        @Override\n+        public String getName() {\n+            return \"kibana_\" + super.getName();\n+        }\n+\n+        @Override\n+        public List<Route> routes() {\n+            return super.routes().stream().map(route -> new Route(route.getMethod(), \"/_kibana\" + route.getPath()))\n+                .collect(Collectors.toUnmodifiableList());\n+        }\n+\n+        @Override\n+        protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient client) throws IOException {\n+            client.threadPool().getThreadContext().allowSystemIndexAccess(allowedIndexPatterns);\n+            return super.prepareRequest(request, new IndexLimitingNodeClient(client, allowedIndexPatterns));\n+        }\n+    }\n+\n+    static class IndexLimitingNodeClient extends NodeClient {\n+\n+        private final NodeClient nodeClient;\n+        private final String[] allowedIndexPatterns;\n+        private final Automaton allowedIndexAutomaton;\n+        private final CharacterRunAutomaton automaton;\n+\n+        IndexLimitingNodeClient(NodeClient nodeClient, List<String> allowedIndexPatterns) {\n+            super(nodeClient.settings(), nodeClient.threadPool());\n+            this.nodeClient = nodeClient;\n+            this.allowedIndexPatterns = allowedIndexPatterns.toArray(Strings.EMPTY_ARRAY);\n+            this.allowedIndexAutomaton = Regex.simpleMatchToAutomaton(this.allowedIndexPatterns);\n+            this.automaton = new CharacterRunAutomaton(this.allowedIndexAutomaton);\n+        }\n+\n+        @Override\n+        public <Request extends ActionRequest, Response extends ActionResponse> Task executeLocally(ActionType<Response> action,\n+                                                                                                    Request request,\n+                                                                                                    ActionListener<Response> listener) {\n+            final String[] indices;\n+            if (request instanceof BulkRequest) {\n+                indices = ((BulkRequest) request).requests().stream()\n+                    .map(DocWriteRequest::index)\n+                    .collect(Collectors.toList())\n+                    .toArray(Strings.EMPTY_ARRAY);\n+            } else if (request instanceof MultiGetRequest) {\n+                indices = ((MultiGetRequest) request).getItems().stream()\n+                    .map(Item::index)\n+                    .collect(Collectors.toList())\n+                    .toArray(Strings.EMPTY_ARRAY);\n+            } else if (request instanceof IndicesRequest) {\n+                indices = ((IndicesRequest) request).indices();\n+            } else {\n+                throw new IllegalArgumentException(\"This client cannot be used to make a non indices request\");\n+            }\n+\n+            if (indices == null || indices.length == 0 ||\n+                (indices.length == 1 && (IndexNameExpressionResolver.isAllIndices(List.of(indices)) || indices[0].equals(\"*\")))) {\n+                if (request instanceof IndicesRequest.Replaceable) {\n+                    // just replace this with the allowed system index patterns\n+                    ((IndicesRequest.Replaceable) request).indices(allowedIndexPatterns);\n+                } else {\n+                    throw new IllegalStateException(\"Unable to replace indices on request \" +\n+                        request.getClass().getSimpleName());\n+                }\n+            } else {\n+                for (String index : indices) {\n+                    // TODO this will not handle date math, is that OK? Do we need wildcard support?", "originalCommit": "2a8b63747fe4a06df2ac63192c9c5c8931370dd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgyMTg4OA==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r384821888", "bodyText": "Since this appears to be using the REST interface anyway, any reason this isn't an ESRestTestCase? I thought that was generally preferred for new suites that don't need to meddle with ES internals over ESIntegTestCase.", "author": "gwbrown", "createdAt": "2020-02-26T23:05:49Z", "path": "modules/kibana/src/test/java/org/elasticsearch/kibana/KibanaSystemIndexIT.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.kibana;\n+\n+import org.apache.http.util.EntityUtils;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.ResponseException;\n+import org.elasticsearch.test.ESIntegTestCase;\n+\n+import java.io.IOException;\n+\n+import static org.hamcrest.Matchers.containsString;\n+import static org.hamcrest.Matchers.is;\n+\n+public class KibanaSystemIndexIT extends ESIntegTestCase {", "originalCommit": "2a8b63747fe4a06df2ac63192c9c5c8931370dd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE5NjI2NA==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r385196264", "bodyText": "Good call", "author": "jaymode", "createdAt": "2020-02-27T15:50:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgyMTg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgyODU5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r384828596", "bodyText": "I'm not sure anything really needs to change, but I think we're now setting the version of the input stream multiple times - decompressingStream() and namedWriteableStream() in this file both set the version after constructing a new wrapper object, but both wrappers delegate version handling to the original StreamInput object anyway. I'm not sure why it wasn't set here in the first place.", "author": "gwbrown", "createdAt": "2020-02-26T23:25:14Z", "path": "server/src/main/java/org/elasticsearch/transport/InboundMessage.java", "diffHunk": "@@ -62,6 +62,7 @@ InboundMessage deserialize(BytesReference reference) throws IOException {\n                 long requestId = streamInput.readLong();\n                 byte status = streamInput.readByte();\n                 Version remoteVersion = Version.fromId(streamInput.readInt());\n+                streamInput.setVersion(remoteVersion);", "originalCommit": "2a8b63747fe4a06df2ac63192c9c5c8931370dd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIxODEyMg==", "url": "https://github.com/elastic/elasticsearch/pull/52385#discussion_r385218122", "bodyText": "Thanks for pointing this out. I went ahead and did some cleanup work here.", "author": "jaymode", "createdAt": "2020-02-27T16:23:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgyODU5Ng=="}], "type": "inlineReview"}, {"oid": "863fe79e00d9482d0a6fb7c1ad0f02d891a1de22", "url": "https://github.com/elastic/elasticsearch/commit/863fe79e00d9482d0a6fb7c1ad0f02d891a1de22", "message": "address description", "committedDate": "2020-02-27T15:27:46Z", "type": "commit"}, {"oid": "b1c53f7020533cc4ae9f09fae434dab979e71754", "url": "https://github.com/elastic/elasticsearch/commit/b1c53f7020533cc4ae9f09fae434dab979e71754", "message": "ESRestTestCase", "committedDate": "2020-02-27T15:41:03Z", "type": "commit"}, {"oid": "eaac89d6175859bd594c4e9de142ecdd387733b1", "url": "https://github.com/elastic/elasticsearch/commit/eaac89d6175859bd594c4e9de142ecdd387733b1", "message": "cleanup stream version setting", "committedDate": "2020-02-27T16:22:11Z", "type": "commit"}, {"oid": "43d413408beae535989cf4a3d7cb2231f399ba43", "url": "https://github.com/elastic/elasticsearch/commit/43d413408beae535989cf4a3d7cb2231f399ba43", "message": "Fix version on CompressibleBytesOutputStream", "committedDate": "2020-02-27T16:54:04Z", "type": "commit"}, {"oid": "954bcad2c8f5f498cc9c4452a2eb4b1183a3dafc", "url": "https://github.com/elastic/elasticsearch/commit/954bcad2c8f5f498cc9c4452a2eb4b1183a3dafc", "message": "Merge branch 'master' into kibana_system_index_plugin", "committedDate": "2020-02-27T20:03:57Z", "type": "commit"}, {"oid": "57781291bb9e7af851de2015ba593de768d403ed", "url": "https://github.com/elastic/elasticsearch/commit/57781291bb9e7af851de2015ba593de768d403ed", "message": "remove limiting of indices", "committedDate": "2020-02-27T20:21:59Z", "type": "commit"}, {"oid": "52b609da993681225bd484ad25d01ab4d327ef58", "url": "https://github.com/elastic/elasticsearch/commit/52b609da993681225bd484ad25d01ab4d327ef58", "message": "add tests for rest of apis", "committedDate": "2020-02-27T21:30:38Z", "type": "commit"}, {"oid": "681924e8d3f72e59b86a031b2f4d027778aaba23", "url": "https://github.com/elastic/elasticsearch/commit/681924e8d3f72e59b86a031b2f4d027778aaba23", "message": "Merge branch 'master' into kibana_system_index_plugin", "committedDate": "2020-03-02T19:47:35Z", "type": "commit"}]}