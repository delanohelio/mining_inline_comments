{"pr_number": 53126, "pr_title": "Convert Wildfly tests to run in Docker", "pr_createdAt": "2020-03-04T17:17:15Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53126", "timeline": [{"oid": "f9d0749766b951e6f9da77a7c6fa6c4ac308a93b", "url": "https://github.com/elastic/elasticsearch/commit/f9d0749766b951e6f9da77a7c6fa6c4ac308a93b", "message": "Something vaguely working", "committedDate": "2020-03-04T16:37:45Z", "type": "commit"}, {"oid": "8023f5f14f037f77b6799120637d62df9e059927", "url": "https://github.com/elastic/elasticsearch/commit/8023f5f14f037f77b6799120637d62df9e059927", "message": "Auto-format :qa:wildfly", "committedDate": "2020-03-04T16:45:33Z", "type": "commit"}, {"oid": "4d342ac1c30c5fbb8281853799d4305b5076c94c", "url": "https://github.com/elastic/elasticsearch/commit/4d342ac1c30c5fbb8281853799d4305b5076c94c", "message": "Don't require a specific local port", "committedDate": "2020-03-04T16:50:53Z", "type": "commit"}, {"oid": "c7297a5d76986c9f81b7e81dcfe5888461599ccc", "url": "https://github.com/elastic/elasticsearch/commit/c7297a5d76986c9f81b7e81dcfe5888461599ccc", "message": "Use literal JSON string", "committedDate": "2020-03-04T16:53:24Z", "type": "commit"}, {"oid": "dbfa4473c5f249a7b60f7c48a6f86b7294c5a519", "url": "https://github.com/elastic/elasticsearch/commit/dbfa4473c5f249a7b60f7c48a6f86b7294c5a519", "message": "Give the wildfly war file a specific name", "committedDate": "2020-03-04T17:12:46Z", "type": "commit"}, {"oid": "e41336079531dae81f2ce3e0096020c1fc929c77", "url": "https://github.com/elastic/elasticsearch/commit/e41336079531dae81f2ce3e0096020c1fc929c77", "message": "Format tweak", "committedDate": "2020-03-04T17:14:46Z", "type": "commit"}, {"oid": "1f17918faee4747e105d2cc7224e8de71e2b3ca2", "url": "https://github.com/elastic/elasticsearch/commit/1f17918faee4747e105d2cc7224e8de71e2b3ca2", "message": "Disable irrelevant tasks", "committedDate": "2020-03-04T17:24:06Z", "type": "commit"}, {"oid": "c6a872efcfca258eb2a13c4076ca9414a718719a", "url": "https://github.com/elastic/elasticsearch/commit/c6a872efcfca258eb2a13c4076ca9414a718719a", "message": "More gradle tweaks", "committedDate": "2020-03-04T17:28:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4MDg3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53126#discussion_r387880876", "bodyText": "I see what you did there!", "author": "jasontedor", "createdAt": "2020-03-04T19:21:24Z", "path": "build.gradle", "diffHunk": "@@ -115,6 +115,7 @@ subprojects {\n       ':distribution:tools:launchers',\n       ':distribution:tools:plugin-cli',\n       ':qa:os',\n+      ':qa:wildfly',", "originalCommit": "c6a872efcfca258eb2a13c4076ca9414a718719a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a862bc6aea1faedb7d010bf3cf11ff7a6e1f0d13", "url": "https://github.com/elastic/elasticsearch/commit/a862bc6aea1faedb7d010bf3cf11ff7a6e1f0d13", "message": "Merge branch 'master' into 49374-docker-wildfly-tests", "committedDate": "2020-03-04T19:39:51Z", "type": "commit"}, {"oid": "f47918cfe202d20027f8065dc10178423dd5072d", "url": "https://github.com/elastic/elasticsearch/commit/f47918cfe202d20027f8065dc10178423dd5072d", "message": "Add missing dependency on docker build", "committedDate": "2020-03-04T20:08:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyMTYyNw==", "url": "https://github.com/elastic/elasticsearch/pull/53126#discussion_r387921627", "bodyText": "Why change from a String to a GString?", "author": "mark-vieira", "createdAt": "2020-03-04T20:40:58Z", "path": "qa/wildfly/build.gradle", "diffHunk": "@@ -73,177 +45,52 @@ dependencies {\n   compile \"org.apache.logging.log4j:log4j-api:${versions.log4j}\"\n   compile \"org.apache.logging.log4j:log4j-core:${versions.log4j}\"\n   compile project(path: ':client:rest-high-level', configuration: 'shadow')\n-  wildfly \"org.jboss:wildfly:${wildflyVersion}@zip\"\n   testCompile project(':test:framework')\n }\n \n-task unzipWildfly(type: Sync) {\n-  into wildflyDir\n-  from { zipTree(configurations.wildfly.singleFile) }\n+war {\n+  archiveName \"example-app.war\"\n }\n \n-task deploy(type: Copy) {\n-  dependsOn unzipWildfly, war\n-  from war\n-  into \"${wildflyInstall}/standalone/deployments\"\n-}\n-\n-task writeElasticsearchProperties(type: DefaultTestClustersTask) {\n-  onlyIf { !Os.isFamily(Os.FAMILY_WINDOWS) }\n-  useCluster testClusters.integTest\n-  dependsOn deploy\n-  doLast {\n-    final File elasticsearchProperties = file(\"${wildflyInstall}/standalone/configuration/elasticsearch.properties\")\n-    elasticsearchProperties.write(\n-      [\n-        \"http.uri=${-> testClusters.integTest.getAllHttpSocketURI().get(0)}\"\n-      ].join(\"\\n\"))\n+elasticsearch_distributions {\n+  docker {\n+    type = 'docker'\n+    flavor = System.getProperty('tests.distribution', 'default')\n+    version = VersionProperties.getElasticsearch()\n+    failIfUnavailable = false // This ensures we skip this testing if Docker is unavailable\n   }\n }\n \n-// the default configuration ships with IPv6 disabled but our cluster could be bound to IPv6 if the host supports it\n-task enableIPv6 {\n-  dependsOn unzipWildfly\n-  doLast {\n-    final File standaloneConf = file(\"${wildflyInstall}/bin/standalone.conf\")\n-    final List<String> lines =\n-      Files.readAllLines(standaloneConf.toPath())\n-        .collect { line -> line.replace(\"-Djava.net.preferIPv4Stack=true\", \"-Djava.net.preferIPv4Stack=false\") }\n-    standaloneConf.write(lines.join(\"\\n\"))\n-  }\n+preProcessFixture {\n+  dependsOn elasticsearch_distributions.docker\n }\n \n-task startWildfly {\n-  dependsOn enableIPv6, writeElasticsearchProperties\n-  doLast {\n-    // we skip these tests on Windows so we do no need to worry about compatibility here\n-    final ProcessBuilder wildfly = new ProcessBuilder(\n-      \"${wildflyInstall}/bin/standalone.sh\",\n-      \"-Djboss.http.port=0\",\n-      \"-Djboss.https.port=0\",\n-      \"-Djboss.management.http.port=0\")\n-    final Process process = wildfly.start()\n-    new BufferedReader(new InputStreamReader(process.getInputStream())).withReader { br ->\n-      String line\n-      int httpPort = 0\n-      while ((line = br.readLine()) != null) {\n-        logger.info(line)\n-        if (line.matches('.*Undertow HTTP listener default listening on .*:\\\\d+$')) {\n-          assert httpPort == 0\n-          final int index = line.lastIndexOf(\":\")\n-          assert index >= 0\n-          httpPort = Integer.parseInt(line.substring(index + 1))\n-          // set this system property so the test runner knows the port Wildfly is listening for HTTP requests on\n-          integTestRunner.systemProperty(\"tests.jboss.root\", \"http://localhost:$httpPort/wildfly-$version/transport\")\n-        } else if (line.matches('.*Http management interface listening on http://.*:\\\\d+/management$')) {\n-          assert managementPort == 0\n-          final int colonIndex = line.lastIndexOf(\":\")\n-          assert colonIndex >= 0\n-          final int slashIndex = line.lastIndexOf(\"/\")\n-          assert slashIndex >= 0\n-          managementPort = Integer.parseInt(line.substring(colonIndex + 1, slashIndex))\n-\n-          /*\n-           * As soon as we know the management port, we fork a process that will ensure the Wildfly process is killed if we\n-           * teardown abnormally. We skip these tests on Windows so we do not need to worry about CLI compatibility here.\n-           */\n-          final File script = new File(project.buildDir, \"wildfly/wildfly.killer.sh\")\n-          script.setText(\n-            [\"function shutdown {\",\n-             \"  ${wildflyInstall}/bin/jboss-cli.sh --controller=localhost:${-> managementPort} --connect command=shutdown\",\n-             \"}\",\n-             \"trap shutdown EXIT\",\n-             // will wait indefinitely for input, but we never pass input, and the pipe is only closed when the build dies\n-             \"read line\\n\"].join('\\n'), 'UTF-8')\n-          final ProcessBuilder killer = new ProcessBuilder(\"bash\", script.absolutePath)\n-          killer.start()\n-\n-        } else if (line.matches(\".*WildFly Full \\\\d+\\\\.\\\\d+\\\\.\\\\d+\\\\.Final \\\\(WildFly Core \\\\d+\\\\.\\\\d+\\\\.\\\\d+\\\\.Final\\\\) started.*\")) {\n-          break\n-        }\n-      }\n-\n-      if (httpPort == 0 || managementPort == 0) {\n-        String portType = httpPort == 0 ? \"http\" : \"management\"\n-        throw new GradleException(\"Failed to find ${portType} port in wildfly log\")\n-      }\n-    }\n+dockerCompose {\n+  if ('default'.equalsIgnoreCase(System.getProperty('tests.distribution', 'default'))) {\n+    useComposeFiles = ['docker-compose.yml']\n+  } else {\n+    useComposeFiles = ['docker-compose-oss.yml']\n   }\n }\n \n-task configureClient(type: LoggedExec) {\n-  dependsOn startWildfly\n-  // we skip these tests on Windows so we do not need to worry about compatibility here\n-  commandLine \"${wildflyInstall}/bin/jboss-cli.sh\",\n-    \"--controller=localhost:${-> managementPort}\",\n-    \"--connect\",\n-    \"--command=/system-property=elasticsearch.properties:add(value=\\${jboss.server.config.dir}/elasticsearch.properties)\"\n-}\n-\n-task stopWildfly(type: LoggedExec) {\n-  // we skip these tests on Windows so we do not need to worry about CLI compatibility here\n-  commandLine \"${wildflyInstall}/bin/jboss-cli.sh\", \"--controller=localhost:${-> managementPort}\", \"--connect\", \"command=shutdown\"\n-}\n-\n-if (!Os.isFamily(Os.FAMILY_WINDOWS)) {\n-  integTestRunner.dependsOn(configureClient)\n-  final TaskExecutionAdapter logDumpListener = new TaskExecutionAdapter() {\n-    @Override\n-    void afterExecute(final Task task, final TaskState state) {\n-      if (task != startWildfly && task != integTestRunner) {\n-        // we might have been called from a parallel, unrelated task\n-        return\n-      }\n-      if (state.failure != null) {\n-        final File logFile = new File(wildflyInstall, \"standalone/log/server.log\")\n-        println(\"\\nWildfly server log (from ${logFile}):\")\n-        println('-----------------------------------------')\n-        final Stream<String> stream = Files.lines(logFile.toPath(), StandardCharsets.UTF_8)\n-        try {\n-          for (String line : stream) {\n-            println(line)\n-          }\n-        } finally {\n-          stream.close()\n-        }\n-        println('=========================================')\n-      }\n-    }\n-  }\n-  startWildfly.doFirst {\n-    project.gradle.addListener(logDumpListener)\n-  }\n-  integTestRunner.doFirst {\n-    project.gradle.addListener(logDumpListener)\n-  }\n-  integTestRunner.doLast {\n-    project.gradle.removeListener(logDumpListener)\n-  }\n-  startWildfly.doLast {\n-    project.gradle.removeListener(logDumpListener)\n-  }\n-  integTestRunner.finalizedBy(stopWildfly)\n-} else {\n-  integTest.enabled = false\n-  testingConventions.enabled = false\n+task integTest(type: Test) {\n+  outputs.doNotCacheIf('Build cache is disabled for Docker tests') { true }\n+  maxParallelForks = '1'\n+  include '**/*IT.class'\n }\n \n-check.dependsOn(integTest)\n+check.dependsOn integTest\n \n test.enabled = false\n-\n dependencyLicenses.enabled = false\n dependenciesInfo.enabled = false\n-\n thirdPartyAudit.enabled = false\n \n-\n testingConventions {\n   naming.clear()\n-  // We only have one \"special\" integration test here to connect to wildfly\n   naming {\n     IT {\n-      baseClass 'org.apache.lucene.util.LuceneTestCase'\n+      baseClass \"org.apache.lucene.util.LuceneTestCase\"", "originalCommit": "f47918cfe202d20027f8065dc10178423dd5072d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkzNDA2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/53126#discussion_r387934063", "bodyText": "What actually happened here is that a stripped a ton of stuff out of this file, then added stuff back in when I discovered that I needed it. This was such a piece, which is why it looks like all I did was change the quotes.", "author": "pugnascotia", "createdAt": "2020-03-04T21:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyMTYyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyMzQyMA==", "url": "https://github.com/elastic/elasticsearch/pull/53126#discussion_r387923420", "bodyText": "We should also depend on war here as well, as otherwise there's nothing to actually ensure we build the war artifact before spinning up the docker test fixture. I suspect this is why we are failing in CI here.", "author": "mark-vieira", "createdAt": "2020-03-04T20:44:28Z", "path": "qa/wildfly/build.gradle", "diffHunk": "@@ -73,177 +45,52 @@ dependencies {\n   compile \"org.apache.logging.log4j:log4j-api:${versions.log4j}\"\n   compile \"org.apache.logging.log4j:log4j-core:${versions.log4j}\"\n   compile project(path: ':client:rest-high-level', configuration: 'shadow')\n-  wildfly \"org.jboss:wildfly:${wildflyVersion}@zip\"\n   testCompile project(':test:framework')\n }\n \n-task unzipWildfly(type: Sync) {\n-  into wildflyDir\n-  from { zipTree(configurations.wildfly.singleFile) }\n+war {\n+  archiveName \"example-app.war\"\n }\n \n-task deploy(type: Copy) {\n-  dependsOn unzipWildfly, war\n-  from war\n-  into \"${wildflyInstall}/standalone/deployments\"\n-}\n-\n-task writeElasticsearchProperties(type: DefaultTestClustersTask) {\n-  onlyIf { !Os.isFamily(Os.FAMILY_WINDOWS) }\n-  useCluster testClusters.integTest\n-  dependsOn deploy\n-  doLast {\n-    final File elasticsearchProperties = file(\"${wildflyInstall}/standalone/configuration/elasticsearch.properties\")\n-    elasticsearchProperties.write(\n-      [\n-        \"http.uri=${-> testClusters.integTest.getAllHttpSocketURI().get(0)}\"\n-      ].join(\"\\n\"))\n+elasticsearch_distributions {\n+  docker {\n+    type = 'docker'\n+    flavor = System.getProperty('tests.distribution', 'default')\n+    version = VersionProperties.getElasticsearch()\n+    failIfUnavailable = false // This ensures we skip this testing if Docker is unavailable\n   }\n }\n \n-// the default configuration ships with IPv6 disabled but our cluster could be bound to IPv6 if the host supports it\n-task enableIPv6 {\n-  dependsOn unzipWildfly\n-  doLast {\n-    final File standaloneConf = file(\"${wildflyInstall}/bin/standalone.conf\")\n-    final List<String> lines =\n-      Files.readAllLines(standaloneConf.toPath())\n-        .collect { line -> line.replace(\"-Djava.net.preferIPv4Stack=true\", \"-Djava.net.preferIPv4Stack=false\") }\n-    standaloneConf.write(lines.join(\"\\n\"))\n-  }\n+preProcessFixture {\n+  dependsOn elasticsearch_distributions.docker", "originalCommit": "f47918cfe202d20027f8065dc10178423dd5072d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkzNDA5NA==", "url": "https://github.com/elastic/elasticsearch/pull/53126#discussion_r387934094", "bodyText": "Added", "author": "pugnascotia", "createdAt": "2020-03-04T21:06:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyMzQyMA=="}], "type": "inlineReview"}, {"oid": "d7b2d1d0859e4b23c450d1ebe9442bf67e30d1e1", "url": "https://github.com/elastic/elasticsearch/commit/d7b2d1d0859e4b23c450d1ebe9442bf67e30d1e1", "message": "Add war dependency, tweaks", "committedDate": "2020-03-04T21:04:52Z", "type": "commit"}]}