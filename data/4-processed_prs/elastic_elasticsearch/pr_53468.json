{"pr_number": 53468, "pr_title": "Add support for distance queries on shape queries", "pr_createdAt": "2020-03-12T10:40:51Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53468", "timeline": [{"oid": "605f69b0e2f84a17a740a083147edf7ce01f70d5", "url": "https://github.com/elastic/elasticsearch/commit/605f69b0e2f84a17a740a083147edf7ce01f70d5", "message": "Add support for distance queries on shape queries", "committedDate": "2020-03-12T10:37:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUzNDYxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/53468#discussion_r391534611", "bodyText": "It seems our circle interface does not really support cartesian circles.", "author": "iverase", "createdAt": "2020-03-12T10:42:07Z", "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/mapper/ShapeUtils.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.spatial.index.mapper;\n+\n+import org.elasticsearch.geometry.Circle;\n+import org.elasticsearch.geometry.Line;\n+import org.elasticsearch.geometry.Point;\n+import org.elasticsearch.geometry.Polygon;\n+import org.elasticsearch.geometry.Rectangle;\n+\n+\n+/**\n+ * Utility class that transforms Elasticsearch geometry objects to the Lucene representation\n+ */\n+public class ShapeUtils {\n+\n+    public static org.apache.lucene.geo.XYPolygon toLuceneXYPolygon(Polygon polygon) {\n+        org.apache.lucene.geo.XYPolygon[] holes = new org.apache.lucene.geo.XYPolygon[polygon.getNumberOfHoles()];\n+        for(int i = 0; i<holes.length; i++) {\n+            holes[i] = new org.apache.lucene.geo.XYPolygon(\n+                doubleArrayToFloatArray(polygon.getHole(i).getX()),\n+                doubleArrayToFloatArray(polygon.getHole(i).getY()));\n+        }\n+        return new org.apache.lucene.geo.XYPolygon(\n+            doubleArrayToFloatArray(polygon.getPolygon().getX()),\n+            doubleArrayToFloatArray(polygon.getPolygon().getY()), holes);\n+    }\n+\n+    public static org.apache.lucene.geo.XYPolygon toLuceneXYPolygon(Rectangle r) {\n+        return new org.apache.lucene.geo.XYPolygon(\n+            new float[]{(float) r.getMinX(), (float) r.getMaxX(), (float) r.getMaxX(), (float) r.getMinX(), (float) r.getMinX()},\n+            new float[]{(float) r.getMinY(), (float) r.getMinY(), (float) r.getMaxY(), (float) r.getMaxY(), (float) r.getMinY()});\n+    }\n+\n+    public static org.apache.lucene.geo.XYRectangle toLuceneXYRectangle(Rectangle r) {\n+        return new org.apache.lucene.geo.XYRectangle((float) r.getMinX(), (float) r.getMaxX(),\n+                                                     (float) r.getMinY(), (float) r.getMaxY());\n+    }\n+\n+    public static org.apache.lucene.geo.XYPoint toLuceneXYPoint(Point point) {\n+        return new org.apache.lucene.geo.XYPoint((float) point.getX(), (float) point.getY());\n+    }\n+\n+    public static org.apache.lucene.geo.XYLine toLuceneXYLine(Line line) {\n+        return new org.apache.lucene.geo.XYLine(\n+            doubleArrayToFloatArray(line.getX()),\n+            doubleArrayToFloatArray(line.getY()));\n+    }\n+\n+    public static org.apache.lucene.geo.XYCircle toLuceneXYCircle(Circle circle) {\n+        return new org.apache.lucene.geo.XYCircle((float) circle.getX(), (float) circle.getY(), (float) circle.getRadiusMeters());", "originalCommit": "605f69b0e2f84a17a740a083147edf7ce01f70d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ2OTg4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/53468#discussion_r392469881", "bodyText": "Yeah, it is a bit misleading to have the Geometry API specify the circle radius as getRadiusMeters. Probably worth a clean up in another PR. /cc @imotov", "author": "nknize", "createdAt": "2020-03-13T20:53:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUzNDYxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ5NTE3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53468#discussion_r392495179", "bodyText": "Yeah, I am not particularly happy with my decision to go with meters here. I think it was a mistake. I agree we need to clean this up, but it probably deserves some brainstorming and definitely a separate PR since it affects SQL as well.", "author": "imotov", "createdAt": "2020-03-13T21:37:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUzNDYxMQ=="}], "type": "inlineReview"}, {"oid": "82218d720825168ca326ea48dc0618fac38298e1", "url": "https://github.com/elastic/elasticsearch/commit/82218d720825168ca326ea48dc0618fac38298e1", "message": "Merge branch 'master' into ShapeCircle", "committedDate": "2020-03-12T14:26:28Z", "type": "commit"}, {"oid": "92768b481643bd9ff22dd3bc5720717cd6131516", "url": "https://github.com/elastic/elasticsearch/commit/92768b481643bd9ff22dd3bc5720717cd6131516", "message": "Merge branch 'master' into shapeCircle", "committedDate": "2020-03-19T10:27:39Z", "type": "commit"}]}