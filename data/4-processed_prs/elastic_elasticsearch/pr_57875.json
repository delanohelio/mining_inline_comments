{"pr_number": 57875, "pr_title": "Use Search After job iterators", "pr_createdAt": "2020-06-09T12:33:09Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57875", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQzMjk1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/57875#discussion_r437432959", "bodyText": "We only need total hits for the first query. Would be good to have this be false once we have the total hits recorded.", "author": "benwtrent", "createdAt": "2020-06-09T13:47:57Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/utils/persistence/SearchAfterDocumentsIterator.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.utils.persistence;\n+\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.OriginSettingClient;\n+import org.elasticsearch.index.query.QueryBuilder;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.search.sort.FieldSortBuilder;\n+import org.elasticsearch.xpack.ml.utils.MlIndicesUtils;\n+\n+import java.util.ArrayDeque;\n+import java.util.Deque;\n+import java.util.NoSuchElementException;\n+import java.util.Objects;\n+\n+/**\n+ * An iterator useful to fetch a large number of documents of type T\n+ * and iterate through them in batches of 10,000.\n+ *\n+ * In terms of functionality this is very similar to {@link BatchedDocumentsIterator}\n+ * the difference being that this uses search after rather than scroll.\n+ *\n+ * Search after has the advantage that the scroll context does not have to be kept\n+ * alive so if processing each batch takes a long time search after should be\n+ * preferred to scroll.\n+ */\n+public abstract class SearchAfterDocumentsIterator<T> implements BatchedIterator<T> {\n+\n+    private static final int BATCH_SIZE = 10_000;\n+\n+    private final OriginSettingClient client;\n+    private final String index;\n+    private volatile long count;\n+    private volatile long totalHits;\n+\n+    protected SearchAfterDocumentsIterator(OriginSettingClient client, String index) {\n+        this.client = Objects.requireNonNull(client);\n+        this.index = Objects.requireNonNull(index);\n+        this.totalHits = -1;\n+        this.count = 0;\n+    }\n+\n+    /**\n+     * Returns {@code true} if the iteration has more elements or\n+     * no searches have been been run and it is unknown if there is a next.\n+     *\n+     * @return {@code true} if the iteration has more elements or the first\n+     * search has not been run\n+     */\n+    @Override\n+    public boolean hasNext() {\n+        return count != totalHits;\n+    }\n+\n+    /**\n+     * The first time next() is called, the search will be performed and the first\n+     * batch will be returned. Any subsequent call will return the following batches.\n+     * <p>\n+     * Note that in some implementations it is possible that when there are no\n+     * results at all, the first time this method is called an empty {@code Deque} is returned.\n+     *\n+     * @return a {@code Deque} with the next batch of documents\n+     * @throws NoSuchElementException if the iteration has no more elements\n+     */\n+    @Override\n+    public Deque<T> next() {\n+        if (!hasNext()) {\n+            throw new NoSuchElementException();\n+        }\n+\n+        SearchResponse searchResponse;\n+        if (totalHits == -1) {\n+            searchResponse = initSearch();\n+        } else {\n+            searchResponse = doSearch(searchAfterFields());\n+        }\n+        return mapHits(searchResponse);\n+    }\n+\n+    private SearchResponse initSearch() {\n+        SearchResponse searchResponse = doSearch(null);\n+        totalHits = searchResponse.getHits().getTotalHits().value;\n+        return searchResponse;\n+    }\n+\n+    private SearchResponse doSearch(Object [] searchAfterValues) {\n+        SearchRequest searchRequest = new SearchRequest(index);\n+        searchRequest.indicesOptions(MlIndicesUtils.addIgnoreUnavailable(SearchRequest.DEFAULT_INDICES_OPTIONS));\n+        SearchSourceBuilder sourceBuilder = (new SearchSourceBuilder()\n+            .size(BATCH_SIZE)\n+            .query(getQuery())\n+            .fetchSource(shouldFetchSource())\n+            .trackTotalHits(true)", "originalCommit": "83313a84ef11c2d9becc25848d5ed669d090605c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQzNjI2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/57875#discussion_r437436261", "bodyText": "Does search after protect us from new docs being added?\nIt seems to me that there is a possibility of count > totalHits if new documents are added + the index is refreshed.\nIt might be good to have this as count <= totalHits as adjust the initial values + initialization of values accordingly.", "author": "benwtrent", "createdAt": "2020-06-09T13:51:03Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/utils/persistence/SearchAfterDocumentsIterator.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.utils.persistence;\n+\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.OriginSettingClient;\n+import org.elasticsearch.index.query.QueryBuilder;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.search.sort.FieldSortBuilder;\n+import org.elasticsearch.xpack.ml.utils.MlIndicesUtils;\n+\n+import java.util.ArrayDeque;\n+import java.util.Deque;\n+import java.util.NoSuchElementException;\n+import java.util.Objects;\n+\n+/**\n+ * An iterator useful to fetch a large number of documents of type T\n+ * and iterate through them in batches of 10,000.\n+ *\n+ * In terms of functionality this is very similar to {@link BatchedDocumentsIterator}\n+ * the difference being that this uses search after rather than scroll.\n+ *\n+ * Search after has the advantage that the scroll context does not have to be kept\n+ * alive so if processing each batch takes a long time search after should be\n+ * preferred to scroll.\n+ */\n+public abstract class SearchAfterDocumentsIterator<T> implements BatchedIterator<T> {\n+\n+    private static final int BATCH_SIZE = 10_000;\n+\n+    private final OriginSettingClient client;\n+    private final String index;\n+    private volatile long count;\n+    private volatile long totalHits;\n+\n+    protected SearchAfterDocumentsIterator(OriginSettingClient client, String index) {\n+        this.client = Objects.requireNonNull(client);\n+        this.index = Objects.requireNonNull(index);\n+        this.totalHits = -1;\n+        this.count = 0;\n+    }\n+\n+    /**\n+     * Returns {@code true} if the iteration has more elements or\n+     * no searches have been been run and it is unknown if there is a next.\n+     *\n+     * @return {@code true} if the iteration has more elements or the first\n+     * search has not been run\n+     */\n+    @Override\n+    public boolean hasNext() {\n+        return count != totalHits;", "originalCommit": "83313a84ef11c2d9becc25848d5ed669d090605c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2NzQzMw==", "url": "https://github.com/elastic/elasticsearch/pull/57875#discussion_r437667433", "bodyText": "That is a very good point and with deletes count may never ==  totalHits.\nI changed the logic so that hasNext will return false only if the last search returned less than the requested number for hits e.g. I asked for 10 results but only got 8 back so there are no more search results and that is the end of the iteration.", "author": "davidkyle", "createdAt": "2020-06-09T19:29:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQzNjI2MQ=="}], "type": "inlineReview"}, {"oid": "d16bc5c141f73c840ded9c6cf842d5f1892673fe", "url": "https://github.com/elastic/elasticsearch/commit/d16bc5c141f73c840ded9c6cf842d5f1892673fe", "message": "WIP", "committedDate": "2020-06-09T17:02:40Z", "type": "commit"}, {"oid": "3cc6d16c65c651a969ff33bebb89123ccec051dd", "url": "https://github.com/elastic/elasticsearch/commit/3cc6d16c65c651a969ff33bebb89123ccec051dd", "message": "Add SearchAfterDocumentsIterator", "committedDate": "2020-06-09T17:02:40Z", "type": "commit"}, {"oid": "c95ca06e8c631034617c0e33bd3e155e3eba849c", "url": "https://github.com/elastic/elasticsearch/commit/c95ca06e8c631034617c0e33bd3e155e3eba849c", "message": "Use search after iterator in expired data removers", "committedDate": "2020-06-09T17:02:40Z", "type": "commit"}, {"oid": "e4b995c8cdb4aa861da753a0a8e7230bc9df752e", "url": "https://github.com/elastic/elasticsearch/commit/e4b995c8cdb4aa861da753a0a8e7230bc9df752e", "message": "Expand jobs with config porovider", "committedDate": "2020-06-09T17:02:40Z", "type": "commit"}, {"oid": "24fde634aeddb34daca0141a5b45d0493c45d193", "url": "https://github.com/elastic/elasticsearch/commit/24fde634aeddb34daca0141a5b45d0493c45d193", "message": "Remove unused class", "committedDate": "2020-06-09T17:02:40Z", "type": "commit"}, {"oid": "22b320c5c933c9f50234a302d867983fbeaa3b9a", "url": "https://github.com/elastic/elasticsearch/commit/22b320c5c933c9f50234a302d867983fbeaa3b9a", "message": "Fix yml test match", "committedDate": "2020-06-09T17:02:40Z", "type": "commit"}, {"oid": "87d25f17cfcd69634b48321dbc833b0adb30a283", "url": "https://github.com/elastic/elasticsearch/commit/87d25f17cfcd69634b48321dbc833b0adb30a283", "message": "Use number of search results to determine hasNext", "committedDate": "2020-06-09T19:25:20Z", "type": "commit"}, {"oid": "87d25f17cfcd69634b48321dbc833b0adb30a283", "url": "https://github.com/elastic/elasticsearch/commit/87d25f17cfcd69634b48321dbc833b0adb30a283", "message": "Use number of search results to determine hasNext", "committedDate": "2020-06-09T19:25:20Z", "type": "forcePushed"}]}