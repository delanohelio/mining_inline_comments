{"pr_number": 53030, "pr_title": "[DOCS] Adds PKI delegation.enabled example", "pr_createdAt": "2020-03-02T19:46:53Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53030", "timeline": [{"oid": "21b50f9f91dee99388aa9b8c359bd0f5e6542bd2", "url": "https://github.com/elastic/elasticsearch/commit/21b50f9f91dee99388aa9b8c359bd0f5e6542bd2", "message": "[DOCS] Adds PKI delegation.enabled example", "committedDate": "2020-03-02T19:45:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY2MzU2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53030#discussion_r386663569", "bodyText": "I moved this paragraph to a separate step, which links to the Kibana section.", "author": "lcawl", "createdAt": "2020-03-02T21:33:49Z", "path": "x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc", "diffHunk": "@@ -3,11 +3,8 @@\n \n To use PKI in {es}, you configure a PKI realm, enable client authentication on\n the desired network layers (transport or http), and map the Distinguished Names\n-(DNs) from the Subject field in the user certificates to roles. You create the mappings in a role mapping file or use the role mappings API.\n-\n-If you want the same users to also be authenticated using certificates when they connect to {kib}, you must configure the {es} PKI realm to\n-<<pki-realm-for-proxied-clients,allow delegation>> and to\n-{kibana-ref}/kibana-authentication.html#pki-authentication[enable PKI authentication in {kib}].", "originalCommit": "21b50f9f91dee99388aa9b8c359bd0f5e6542bd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY2Mzg3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/53030#discussion_r386663873", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            . If you want the same users to also be authenticated using certificates when\n          \n          \n            \n            . Optional: If you want the same users to also be authenticated using certificates when", "author": "lcawl", "createdAt": "2020-03-02T21:34:27Z", "path": "x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc", "diffHunk": "@@ -69,6 +70,10 @@ client's certificate, then the realm does not authenticate the certificate.\n \n --\n \n+. If you want the same users to also be authenticated using certificates when", "originalCommit": "21b50f9f91dee99388aa9b8c359bd0f5e6542bd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7d1140bf1d24a4c17f7e9ef1aeb3cbddb64b3103", "url": "https://github.com/elastic/elasticsearch/commit/7d1140bf1d24a4c17f7e9ef1aeb3cbddb64b3103", "message": "Update x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc", "committedDate": "2020-03-02T21:34:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3MzUxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/53030#discussion_r386673515", "bodyText": "without SSL/TLS client authentication. See <>\n\nThis sentence is a bit unclear to me, since I don't think we describe a way to configure TLS without authentication in the linked page. Can we clarify or is there a better link?", "author": "lcawl", "createdAt": "2020-03-02T21:53:42Z", "path": "x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc", "diffHunk": "@@ -200,52 +205,75 @@ alternative to role mapping.\n \n --\n \n+. If you want the same users to also be authenticated using certificates when\n+they connect to {kib},\n+{kibana-ref}/kibana-authentication.html#pki-authentication[enable PKI authentication in {kib}].\n+\n [[pki-realm-for-proxied-clients]]\n ==== PKI authentication for clients connecting to {kib}\n \n By default, the PKI realm relies on the node's network interface to perform the\n SSL/TLS handshake and extract the client certificate. This behaviour requires\n-that that clients connect directly to {es} so that their SSL connection is\n-terminated by the {es} node.  If SSL/TLS authenticatication is to be performed\n-by {kib}, the PKI realm must be configured to permit delegation.\n+that clients connect directly to {es} so that their SSL connection is terminated\n+by the {es} node.  If SSL/TLS authentication is to be performed by {kib}, the\n+PKI realm must be configured to permit delegation.\n \n Specifically, when clients presenting X.509 certificates connect to {kib},\n {kib} performs the SSL/TLS authentication. {kib} then forwards the client's\n-certificate chain, by calling an {es} API, to have them further validated by\n+certificate chain (by calling an {es} API) to have them further validated by\n the PKI realms that have been configured for delegation.\n \n To permit authentication delegation for a specific {es} PKI realm, start by\n configuring the realm for the usual case, as detailed in the\n-<<pki-realm-for-direct-clients>>\n-section. Note that you must explicitly configure a `truststore` (or,\n-equivalently `certificate_authorities`) even though it is the same trust\n-configuration that you have configured on the network layer.  Afterwards,\n-simply toggle the `delegation.enabled` realm setting to `true`.  This realm is\n-now allowed to validate delegated PKI authentication (after restarting {es}).\n+<<pki-realm-for-direct-clients>> section. Note that you must explicitly\n+configure a `truststore` (or, equivalently `certificate_authorities`) even\n+though it is the same trust configuration that you have configured on the\n+network layer. The `xpack.security.authc.token.enabled` setting must also be\n+`true`. Then simply toggle the `delegation.enabled` realm setting to `true`. For example:\n+\n+[source, yaml]\n+------------------------------------------------------------\n+xpack:\n+  security:\n+    authc:\n+      token.enabled: true\n+      realms:\n+        pki:\n+          pki1:\n+            order: 1\n+            delegation.enabled: true\n+            truststore:\n+              path: \"pki1_truststore.jks\"\n+------------------------------------------------------------\n+\n+After you restart {es}, this realm can validate delegated PKI authentication.\n+For more information about these settings, see <<security-settings>>.\n+\n+[NOTE]\n+====\n \n-NOTE: PKI authentication delegation requires that the\n-`xpack.security.authc.token.enabled` setting be `true` and that SSL/TLS be\n-configured (without SSL/TLS client authentication).\n+. PKI authentication delegation requires that SSL/TLS is configured (without\n+SSL/TLS client authentication). See <<ssl-tls>>.", "originalCommit": "7d1140bf1d24a4c17f7e9ef1aeb3cbddb64b3103", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a1fa1e4a3a890983e82b8460ce28c645111255a7", "url": "https://github.com/elastic/elasticsearch/commit/a1fa1e4a3a890983e82b8460ce28c645111255a7", "message": "[DOCS] More edits", "committedDate": "2020-03-02T21:58:08Z", "type": "commit"}, {"oid": "a26c012f81b5252f3411979db898497a2460c3f6", "url": "https://github.com/elastic/elasticsearch/commit/a26c012f81b5252f3411979db898497a2460c3f6", "message": "[DOCS] More edits", "committedDate": "2020-03-03T00:52:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ4Mjk3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53030#discussion_r387482979", "bodyText": "\ud83d\udc4d", "author": "albertzaharovits", "createdAt": "2020-03-04T07:12:21Z", "path": "x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc", "diffHunk": "@@ -20,9 +17,9 @@ IMPORTANT: You must enable SSL/TLS with client authentication to use PKI when\n clients connect directly to {es}.\n \n . Add a realm configuration for a `pki` realm to `elasticsearch.yml` under the\n-`xpack.security.authc.realms.pki` namespace.\n-You must explicitly set the `order` attribute. See <<ref-pki-settings>> for all\n-of the options you can set for a `pki` realm.\n+`xpack.security.authc.realms.pki` namespace. You must explicitly set the `order`", "originalCommit": "a26c012f81b5252f3411979db898497a2460c3f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "312aecb32f6e1c264992301bf8a3fe15b7256466", "url": "https://github.com/elastic/elasticsearch/commit/312aecb32f6e1c264992301bf8a3fe15b7256466", "message": "[DOCS] Clarifies TLS HTTP requirement", "committedDate": "2020-03-04T19:49:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg5ODM2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53030#discussion_r387898367", "bodyText": "You can also set xpack.security.transport.ssl.client_authentication ... You must enable SSL/TLS with client authentication...\n\nI moved this content into the \"Enable client authentication on the desired network layers (transport or http)\" step, since in my opinion it was out of context and therefore harder to understand in this introductory section.", "author": "lcawl", "createdAt": "2020-03-04T19:52:47Z", "path": "x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc", "diffHunk": "@@ -3,26 +3,18 @@\n \n To use PKI in {es}, you configure a PKI realm, enable client authentication on\n the desired network layers (transport or http), and map the Distinguished Names\n-(DNs) from the Subject field in the user certificates to roles. You create the mappings in a role mapping file or use the role mappings API.\n+(DNs) from the Subject field in the user certificates to roles. You create the\n+mappings in a role mapping file or use the role mappings API.\n \n-If you want the same users to also be authenticated using certificates when they connect to {kib}, you must configure the {es} PKI realm to\n-<<pki-realm-for-proxied-clients,allow delegation>> and to\n-{kibana-ref}/kibana-authentication.html#pki-authentication[enable PKI authentication in {kib}].\n-\n-You can also use a combination of PKI and username/password authentication. For\n+TIP: You can use a combination of PKI and username/password authentication. For\n example, you can enable SSL/TLS on the transport layer and define a PKI realm to\n require transport clients to authenticate with X.509 certificates, while still\n-authenticating HTTP traffic using username and password credentials. You can\n-also set `xpack.security.transport.ssl.client_authentication` to `optional` to\n-allow clients without certificates to authenticate with other credentials.\n-\n-IMPORTANT: You must enable SSL/TLS with client authentication to use PKI when\n-clients connect directly to {es}.", "originalCommit": "312aecb32f6e1c264992301bf8a3fe15b7256466", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg5OTMzMw==", "url": "https://github.com/elastic/elasticsearch/pull/53030#discussion_r387899333", "bodyText": "is not sufficient\n\nI changed this sentence since by my understanding this step is necessary to permit PKI authentication in Kibana, it just isn't sufficient (other steps are required).  If I've misunderstood, please let me know and I can revert this change.", "author": "lcawl", "createdAt": "2020-03-04T19:54:39Z", "path": "x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc", "diffHunk": "@@ -41,15 +33,21 @@ xpack:\n With this configuration, any certificate trusted by the {es} SSL/TLS layer is\n accepted for authentication. The username is the common name (CN) extracted\n from the DN in the Subject field of the end-entity certificate. This\n-configuration does not permit PKI authentication to {kib}.\n+configuration is not sufficient to permit PKI authentication to {kib};", "originalCommit": "312aecb32f6e1c264992301bf8a3fe15b7256466", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkzMTY3MA==", "url": "https://github.com/elastic/elasticsearch/pull/53030#discussion_r387931670", "bodyText": "This is correct!", "author": "albertzaharovits", "createdAt": "2020-03-04T21:01:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg5OTMzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkzMjgwMA==", "url": "https://github.com/elastic/elasticsearch/pull/53030#discussion_r387932800", "bodyText": "\ud83d\udc4d", "author": "albertzaharovits", "createdAt": "2020-03-04T21:03:32Z", "path": "x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc", "diffHunk": "@@ -205,47 +212,60 @@ alternative to role mapping.\n \n By default, the PKI realm relies on the node's network interface to perform the\n SSL/TLS handshake and extract the client certificate. This behaviour requires\n-that that clients connect directly to {es} so that their SSL connection is\n-terminated by the {es} node.  If SSL/TLS authenticatication is to be performed\n-by {kib}, the PKI realm must be configured to permit delegation.\n+that clients connect directly to {es} so that their SSL connection is terminated\n+by the {es} node.  If SSL/TLS authentication is to be performed by {kib}, the\n+PKI realm must be configured to permit delegation.\n \n Specifically, when clients presenting X.509 certificates connect to {kib},\n {kib} performs the SSL/TLS authentication. {kib} then forwards the client's\n-certificate chain, by calling an {es} API, to have them further validated by\n+certificate chain (by calling an {es} API) to have them further validated by\n the PKI realms that have been configured for delegation.\n \n To permit authentication delegation for a specific {es} PKI realm, start by\n configuring the realm for the usual case, as detailed in the\n-<<pki-realm-for-direct-clients>>\n-section. Note that you must explicitly configure a `truststore` (or,\n-equivalently `certificate_authorities`) even though it is the same trust\n-configuration that you have configured on the network layer.  Afterwards,\n-simply toggle the `delegation.enabled` realm setting to `true`.  This realm is\n-now allowed to validate delegated PKI authentication (after restarting {es}).\n+<<pki-realm-for-direct-clients>> section. In this scenario, when you enable TLS,\n+it is mandatory that you <<tls-http,encrypt HTTP client communications>>.", "originalCommit": "312aecb32f6e1c264992301bf8a3fe15b7256466", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}