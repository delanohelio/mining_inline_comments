{"pr_number": 52586, "pr_title": "SQL: use a calendar interval for histograms over 1 month intervals", "pr_createdAt": "2020-02-20T18:05:35Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52586", "timeline": [{"oid": "fce41a493cc3eacc7b32eb33ed8543e181147e2a", "url": "https://github.com/elastic/elasticsearch/commit/fce41a493cc3eacc7b32eb33ed8543e181147e2a", "message": "Use a calendar interval for histograms on INTERVAL 1 MONTH", "committedDate": "2020-02-20T18:02:27Z", "type": "commit"}, {"oid": "1298d85de6b08bd57fad975ef5c40b0a30b7450e", "url": "https://github.com/elastic/elasticsearch/commit/1298d85de6b08bd57fad975ef5c40b0a30b7450e", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 51538_impl", "committedDate": "2020-02-20T18:02:56Z", "type": "commit"}, {"oid": "7b1a2547820beba41cd51ae21939bed94d0102cb", "url": "https://github.com/elastic/elasticsearch/commit/7b1a2547820beba41cd51ae21939bed94d0102cb", "message": "Remove unused import", "committedDate": "2020-02-21T01:06:19Z", "type": "commit"}, {"oid": "72f01a2c85d9d12ab97dfebf4a76cd926a48117a", "url": "https://github.com/elastic/elasticsearch/commit/72f01a2c85d9d12ab97dfebf4a76cd926a48117a", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 51538_impl", "committedDate": "2020-02-21T01:11:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ4MjQ2MA==", "url": "https://github.com/elastic/elasticsearch/pull/52586#discussion_r382482460", "bodyText": "This is already checked that it's one of the two so mayb an else is enough.", "author": "matriv", "createdAt": "2020-02-21T09:37:06Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/planner/QueryFolder.java", "diffHunk": "@@ -322,17 +320,30 @@ else if (exp instanceof GroupingFunction) {\n                             // date histogram\n                             if (isDateBased(h.dataType())) {\n                                 Object value = h.interval().value();\n-                                // interval of exactly 1 year\n-                                if (value instanceof IntervalYearMonth\n-                                        && ((IntervalYearMonth) value).interval().equals(Period.ofYears(1))) {\n-                                    String calendarInterval = Year.YEAR_INTERVAL;\n+                                // interval of exactly 1 year or 1 month\n+                                if (value instanceof IntervalYearMonth &&\n+                                        (((IntervalYearMonth) value).interval().equals(Period.ofYears(1)) \n+                                        || ((IntervalYearMonth) value).interval().equals(Period.ofMonths(1)))) {\n+                                    Period yearMonth = ((IntervalYearMonth) value).interval();\n+                                    \n+                                    String calendarInterval = null;\n+                                    if (yearMonth.equals(Period.ofYears(1))) {\n+                                        calendarInterval = Histogram.YEAR_INTERVAL;\n+                                    } else if (yearMonth.equals(Period.ofMonths(1))) {", "originalCommit": "72f01a2c85d9d12ab97dfebf4a76cd926a48117a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ4MzA5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/52586#discussion_r382483093", "bodyText": "Here too, the null check is superfluous as the whole block is guarded by:\n&& (((IntervalYearMonth) value).interval().equals(Period.ofYears(1)) || ((IntervalYearMonth) value).interval().equals(Period.ofMonths(1)))", "author": "matriv", "createdAt": "2020-02-21T09:38:17Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/planner/QueryFolder.java", "diffHunk": "@@ -322,17 +320,30 @@ else if (exp instanceof GroupingFunction) {\n                             // date histogram\n                             if (isDateBased(h.dataType())) {\n                                 Object value = h.interval().value();\n-                                // interval of exactly 1 year\n-                                if (value instanceof IntervalYearMonth\n-                                        && ((IntervalYearMonth) value).interval().equals(Period.ofYears(1))) {\n-                                    String calendarInterval = Year.YEAR_INTERVAL;\n+                                // interval of exactly 1 year or 1 month\n+                                if (value instanceof IntervalYearMonth &&\n+                                        (((IntervalYearMonth) value).interval().equals(Period.ofYears(1)) \n+                                        || ((IntervalYearMonth) value).interval().equals(Period.ofMonths(1)))) {\n+                                    Period yearMonth = ((IntervalYearMonth) value).interval();\n+                                    \n+                                    String calendarInterval = null;\n+                                    if (yearMonth.equals(Period.ofYears(1))) {\n+                                        calendarInterval = Histogram.YEAR_INTERVAL;\n+                                    } else if (yearMonth.equals(Period.ofMonths(1))) {\n+                                        calendarInterval = Histogram.MONTH_INTERVAL;\n+                                    }\n \n-                                    // When the histogram is `INTERVAL '1' YEAR`, the interval used in the ES date_histogram will be\n-                                    // a calendar_interval with value \"1y\". All other intervals will be fixed_intervals expressed in ms.\n-                                    if (field instanceof FieldAttribute) {\n-                                        key = new GroupByDateHistogram(aggId, QueryTranslator.nameOf(field), calendarInterval, h.zoneId());\n-                                    } else if (field instanceof Function) {\n-                                        key = new GroupByDateHistogram(aggId, ((Function) field).asScript(), calendarInterval, h.zoneId());\n+                                    // When the histogram is `INTERVAL '1' YEAR` or `INTERVAL '1' MONTH`, the interval used in \n+                                    // the ES date_histogram will be a calendar_interval with value \"1y\" or \"1M\" respectively.\n+                                    // All other intervals will be fixed_intervals expressed in ms.\n+                                    if (calendarInterval != null) {", "originalCommit": "72f01a2c85d9d12ab97dfebf4a76cd926a48117a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ4OTI4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52586#discussion_r382489282", "bodyText": "Yep, true. It's a leftover from a previous idea.", "author": "astefan", "createdAt": "2020-02-21T09:50:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ4MzA5Mw=="}], "type": "inlineReview"}, {"oid": "7af8f142c4b7fee4b977aa90bb96cd1b18557279", "url": "https://github.com/elastic/elasticsearch/commit/7af8f142c4b7fee4b977aa90bb96cd1b18557279", "message": "Address feedback", "committedDate": "2020-02-21T09:51:25Z", "type": "commit"}, {"oid": "1b468f5c2b97a92c44ca66c4a7c5b9a36ffaaa54", "url": "https://github.com/elastic/elasticsearch/commit/1b468f5c2b97a92c44ca66c4a7c5b9a36ffaaa54", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 51538_impl", "committedDate": "2020-02-21T09:51:51Z", "type": "commit"}]}