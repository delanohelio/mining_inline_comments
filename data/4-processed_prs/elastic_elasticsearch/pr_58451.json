{"pr_number": 58451, "pr_title": "Replace compile configuration usage with api", "pr_createdAt": "2020-06-23T15:03:52Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58451", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI5NjM1NA==", "url": "https://github.com/elastic/elasticsearch/pull/58451#discussion_r444296354", "bodyText": "required to use the api configuration. Another benefit is that with the java library plugin the compile dependencies will not require jar tasks to be build but rely on classes instead. runtime will still use jars. This could probably make some build job scenarios faster / utilise parallelisation better", "author": "breskeby", "createdAt": "2020-06-23T15:05:07Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java", "diffHunk": "@@ -83,7 +84,7 @@ public void apply(Project project) {\n         // apply global test task failure listener\n         project.getRootProject().getPluginManager().apply(TestFailureReportingPlugin.class);\n \n-        project.getPluginManager().apply(JavaPlugin.class);\n+        project.getPluginManager().apply(JavaLibraryPlugin.class);", "originalCommit": "a399d7139fe5cf636d9e9ce018e61086a05c39f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "00cff9e3399c8abe02ae203c883982e0697b0772", "url": "https://github.com/elastic/elasticsearch/commit/00cff9e3399c8abe02ae203c883982e0697b0772", "message": "Make test runtime classpath input for testing convetion\n\n- required as java library will by default not have build jar file\n- jar file is now explicit input of the task and gradle will ensure its properly build", "committedDate": "2020-06-24T14:20:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYwMDI5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/58451#discussion_r445600295", "bodyText": "with compile tasks only depending on dependent projects compile tasks, the task input here needs to be explicit as it depends on jars that could not have been build before.", "author": "breskeby", "createdAt": "2020-06-25T14:27:10Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/precommit/TestingConventionsTasks.java", "diffHunk": "@@ -348,7 +349,8 @@ private boolean isAnnotated(Method method, Class<?> annotation) {\n         return false;\n     }\n \n-    private FileCollection getTestsClassPath() {\n+    @Classpath\n+    public FileCollection getTestsClassPath() {", "originalCommit": "306c263245b8f5b6c9982c7f696357857853f4f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxMjc0OA==", "url": "https://github.com/elastic/elasticsearch/pull/58451#discussion_r445612748", "bodyText": "We should always fail on resolution. no matter if the configuration actually contains a dependency or not.", "author": "breskeby", "createdAt": "2020-06-25T14:43:46Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/EnforceDeprecationFailuresPlugin.java", "diffHunk": "@@ -78,15 +78,13 @@ private void failOnCompileConfigurationResolution(SourceSet sourceSet) {\n             .getByName(sourceSet.getCompileConfigurationName())\n             .getIncoming()\n             .beforeResolve(resolvableDependencies -> {\n-                if (resolvableDependencies.getDependencies().size() > 0) {", "originalCommit": "b297965bf141004a7bb6384a425b9dd75faea35b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNDI4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/58451#discussion_r445614286", "bodyText": "This is actually necessary as the previously used runtime configuration extends compile and is therefore now empty. Using the correct runtimeClasspath configuration here has also the nice effect of removing another deprecated behaviour (of using \"runtime\")", "author": "breskeby", "createdAt": "2020-06-25T14:45:50Z", "path": "distribution/build.gradle", "diffHunk": "@@ -287,21 +287,21 @@ configure(subprojects.findAll { ['archives', 'packages'].contains(it.name) }) {\n       copySpec {\n         // delay by using closures, since they have not yet been configured, so no jar task exists yet\n         from { project(':server').jar }\n-        from { project(':server').configurations.runtime }", "originalCommit": "b297965bf141004a7bb6384a425b9dd75faea35b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNjY0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/58451#discussion_r445616645", "bodyText": "we need to use runtimeElements as runtime is a) empty because it extends compile and is therefore empty now and 2) runtime is deprecated for consumption by other projects (see https://docs.gradle.org/6.5/userguide/java_library_plugin.html#sec:java_library_configurations_graph for details)", "author": "breskeby", "createdAt": "2020-06-25T14:48:58Z", "path": "modules/kibana/build.gradle", "diffHunk": "@@ -23,7 +23,7 @@ esplugin {\n }\n \n dependencies {\n-  compile project(path: ':modules:reindex', configuration: 'runtime')\n+  api project(path: ':modules:reindex', configuration: 'runtimeElements')", "originalCommit": "b297965bf141004a7bb6384a425b9dd75faea35b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcxNDczMQ==", "url": "https://github.com/elastic/elasticsearch/pull/58451#discussion_r445714731", "bodyText": "Why are we even specifying this? Why can't we use the default configuration here?", "author": "mark-vieira", "createdAt": "2020-06-25T17:16:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNjY0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTc5MDcxMw==", "url": "https://github.com/elastic/elasticsearch/pull/58451#discussion_r445790713", "bodyText": "I don't know yet and I have that on my todo list to double check. But for the sake of keeping things simple and focussed in this PR I just did straight forward replacement for now", "author": "breskeby", "createdAt": "2020-06-25T19:31:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNjY0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg3OTg3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/58451#discussion_r445879873", "bodyText": "I looked into this closer. I assumed there was a subtile difference between default but since we ported all dependencies from compile to api we ensured actually that they are the same here. I'll remove this", "author": "breskeby", "createdAt": "2020-06-25T22:48:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNjY0NQ=="}], "type": "inlineReview"}, {"oid": "b5e42e7bf0969312ec97ff8831400871ba8a5fd4", "url": "https://github.com/elastic/elasticsearch/commit/b5e42e7bf0969312ec97ff8831400871ba8a5fd4", "message": "Replace compile configuration usage with api\n\nFix distribution packaging\n\nMake test runtime classpath input for testing convetion\n\n- required as java library will by default not have build jar file\n- jar file is now explicit input of the task and gradle will ensure its properly build\n\nSimplify project depenencies\n\n- remove explicit runtimeElements usage and rely on default configuration", "committedDate": "2020-06-26T07:13:36Z", "type": "forcePushed"}, {"oid": "769cbc7781737a3f249f6e43f5e0e25c37caab9d", "url": "https://github.com/elastic/elasticsearch/commit/769cbc7781737a3f249f6e43f5e0e25c37caab9d", "message": "Replace compile configuration usage with api\n\n- Use java-library instead of plugin to allow api configuration usage\n- Remove explicit references to runtime configurations in dependency declarations\n- Make test runtime classpath input for testing convention\n  - required as java library will by default not have build jar file\n  - jar file is now explicit input of the task and gradle will ensure its properly build", "committedDate": "2020-06-26T08:45:54Z", "type": "commit"}, {"oid": "769cbc7781737a3f249f6e43f5e0e25c37caab9d", "url": "https://github.com/elastic/elasticsearch/commit/769cbc7781737a3f249f6e43f5e0e25c37caab9d", "message": "Replace compile configuration usage with api\n\n- Use java-library instead of plugin to allow api configuration usage\n- Remove explicit references to runtime configurations in dependency declarations\n- Make test runtime classpath input for testing convention\n  - required as java library will by default not have build jar file\n  - jar file is now explicit input of the task and gradle will ensure its properly build", "committedDate": "2020-06-26T08:45:54Z", "type": "forcePushed"}]}