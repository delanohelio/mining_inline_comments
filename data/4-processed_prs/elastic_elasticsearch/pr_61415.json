{"pr_number": 61415, "pr_title": "Remove Potentially Expensive Use of BytesReference.toBytesRef", "pr_createdAt": "2020-08-21T12:44:22Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61415", "timeline": [{"oid": "542d288af95c905b9fb15ceeba4fe3d3a3a1a520", "url": "https://github.com/elastic/elasticsearch/commit/542d288af95c905b9fb15ceeba4fe3d3a3a1a520", "message": "Remove Potentially Expensive Use of BytesReference.toBytesRef\n\nThis method might materialize all the bytes in a reference into a fresh `byte[]`.\nUsing the stream is much safer and only trivially more expensive.", "committedDate": "2020-08-21T12:33:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY5MjE2OA==", "url": "https://github.com/elastic/elasticsearch/pull/61415#discussion_r475692168", "bodyText": "We should probably catch and handle IllegalArgumentException in case the stream input doesn't support marking", "author": "jaymode", "createdAt": "2020-08-24T15:16:46Z", "path": "server/src/main/java/org/elasticsearch/common/xcontent/XContentHelper.java", "diffHunk": "@@ -380,8 +380,13 @@ public static BytesReference toXContent(ToXContent toXContent, XContentType xCon\n      */\n     @Deprecated\n     public static XContentType xContentType(BytesReference bytes) {\n-        BytesRef br = bytes.toBytesRef();\n-        return XContentFactory.xContentType(br.bytes, br.offset, br.length);\n+        try {\n+            final InputStream inputStream = bytes.streamInput();\n+            return XContentFactory.xContentType(inputStream);", "originalCommit": "542d288af95c905b9fb15ceeba4fe3d3a3a1a520", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgyNjk0MA==", "url": "https://github.com/elastic/elasticsearch/pull/61415#discussion_r475826940", "bodyText": "Right that's quite subtle, how about this: added an assertion for this explicitly since we rely on the fact that the BytesReference returns a stream that supports marking elsewhere as well and on second look also added the BytesArray fast-path to speed things up.\nwdyt?", "author": "original-brownbear", "createdAt": "2020-08-24T18:54:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY5MjE2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgyODIzNA==", "url": "https://github.com/elastic/elasticsearch/pull/61415#discussion_r475828234", "bodyText": "Works for me. I do wonder if we should consider a separate change to BytesReference and add a hasArray method so we can stop using instanceof BytesArray", "author": "jaymode", "createdAt": "2020-08-24T18:57:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY5MjE2OA=="}], "type": "inlineReview"}, {"oid": "2eee242365b23b3cb0ae2906eab6c65910564a48", "url": "https://github.com/elastic/elasticsearch/commit/2eee242365b23b3cb0ae2906eab6c65910564a48", "message": "Merge remote-tracking branch 'elastic/master' into cheaper-content-type-determination", "committedDate": "2020-08-24T18:46:26Z", "type": "commit"}, {"oid": "a4cc7e74acb11e92b6fdf5d2c40e88dbe5dfa6c4", "url": "https://github.com/elastic/elasticsearch/commit/a4cc7e74acb11e92b6fdf5d2c40e88dbe5dfa6c4", "message": "faster and assertion", "committedDate": "2020-08-24T18:52:11Z", "type": "commit"}]}