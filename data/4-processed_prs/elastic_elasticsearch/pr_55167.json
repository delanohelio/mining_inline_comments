{"pr_number": 55167, "pr_title": "Allow transactional metadata update with index creation", "pr_createdAt": "2020-04-14T15:18:09Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55167", "timeline": [{"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa", "url": "https://github.com/elastic/elasticsearch/commit/8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa", "message": "hook for transactional metadata update with index creation", "committedDate": "2020-04-14T15:10:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408248079", "bodyText": "Drive-by comment, but does this really need to return a brand new builder? Since the existing builder is being passed in couldn't this be a BiConsumer<Metadata.Builder, IndexMetadata> and modify the builder directly?", "author": "dakrone", "createdAt": "2020-04-14T15:54:26Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -685,10 +701,14 @@ static int getIndexNumberOfRoutingShards(Settings indexSettings, @Nullable Index\n      * table based on the live nodes.\n      */\n     static ClusterState clusterStateCreateIndex(ClusterState currentState, Set<ClusterBlock> clusterBlocks, IndexMetadata indexMetadata,\n-                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable) {\n-        Metadata newMetadata = Metadata.builder(currentState.metadata())\n-            .put(indexMetadata, false)\n-            .build();\n+                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable,\n+                                                BiFunction<Metadata.Builder, IndexMetadata, Metadata.Builder> metadataTransaction) {\n+        Metadata.Builder builder = Metadata.builder(currentState.metadata())\n+            .put(indexMetadata, false);\n+        if (metadataTransaction != null) {\n+            builder = metadataTransaction.apply(builder, indexMetadata);", "originalCommit": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1NzkwMA==", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408257900", "bodyText": "That makes sense to me if the return value on builder methods is only for enabling a fluent API and not for changing the identity of the builder.", "author": "danhermann", "createdAt": "2020-04-14T16:08:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3NzEzNA==", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408277134", "bodyText": "This PR didn't have any uses of the actual transaction builder, what is the expected use that will change the identity of the builder?", "author": "dakrone", "createdAt": "2020-04-14T16:35:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3ODg4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408278881", "bodyText": "@dakrone, it's for rolling over data streams. Create the new backing index and add it to the data stream in the same cluster state update operation.", "author": "danhermann", "createdAt": "2020-04-14T16:38:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5ODE0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408698141", "bodyText": "I agree that there is no need need for the metadataTransaction to return a new builder instance.\nReturning the same instance should suffice for the use case we would like to do with this change.", "author": "martijnvg", "createdAt": "2020-04-15T09:15:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5OTkzNA==", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408699934", "bodyText": "maybe in that spirit also add an assertion that the same metadata builder instance is returned from the function?", "author": "martijnvg", "createdAt": "2020-04-15T09:18:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc4MTY5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408781693", "bodyText": "I think we should just turn it into a BiConsumer instead?", "author": "henningandersen", "createdAt": "2020-04-15T11:48:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ=="}], "type": "inlineReview"}, {"oid": "630f525836e2c8ea4337f785ffb3d80d06263228", "url": "https://github.com/elastic/elasticsearch/commit/630f525836e2c8ea4337f785ffb3d80d06263228", "message": "BiFunction to BiConsumer", "committedDate": "2020-04-14T21:50:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5OTA3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408699075", "bodyText": "Maybe rename metadataTransaction to metadataTransformer?\nSince if provided the function will change the metadata builder.", "author": "martijnvg", "createdAt": "2020-04-15T09:17:28Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -685,10 +701,14 @@ static int getIndexNumberOfRoutingShards(Settings indexSettings, @Nullable Index\n      * table based on the live nodes.\n      */\n     static ClusterState clusterStateCreateIndex(ClusterState currentState, Set<ClusterBlock> clusterBlocks, IndexMetadata indexMetadata,\n-                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable) {\n-        Metadata newMetadata = Metadata.builder(currentState.metadata())\n-            .put(indexMetadata, false)\n-            .build();\n+                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable,\n+                                                BiFunction<Metadata.Builder, IndexMetadata, Metadata.Builder> metadataTransaction) {", "originalCommit": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc5MzY2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408793667", "bodyText": "Ah, that is a better name \ud83d\udc4d", "author": "danhermann", "createdAt": "2020-04-15T12:11:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5OTA3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5OTQ2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408699463", "bodyText": "nit: List.of()?", "author": "martijnvg", "createdAt": "2020-04-15T09:18:10Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -492,7 +508,7 @@ private ClusterState applyCreateIndexRequestWithExistingMetadata(final ClusterSt\n                 // the context is only used for validation so it's fine to pass fake values for the\n                 // shard id and the current timestamp\n                 indexService.newQueryShardContext(0, null, () -> 0L, null)),\n-            Collections.emptyList());\n+            Collections.emptyList(), metadataTransaction);", "originalCommit": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "125f023d4fbc5cbf610150f64c28467668f11665", "url": "https://github.com/elastic/elasticsearch/commit/125f023d4fbc5cbf610150f64c28467668f11665", "message": "review comments", "committedDate": "2020-04-15T12:14:23Z", "type": "commit"}]}