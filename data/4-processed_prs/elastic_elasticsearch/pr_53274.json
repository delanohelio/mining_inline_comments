{"pr_number": 53274, "pr_title": "[DOCS] Adds painless transform examples", "pr_createdAt": "2020-03-09T10:42:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53274", "timeline": [{"oid": "f122d3466e78e8f7994a5fc87bea8917cbd6098e", "url": "https://github.com/elastic/elasticsearch/commit/f122d3466e78e8f7994a5fc87bea8917cbd6098e", "message": "[DOCS] Adds painless transform examples.", "committedDate": "2020-03-09T10:28:08Z", "type": "commit"}, {"oid": "db025da8b34936451c93ce4722a0d933f79a8d50", "url": "https://github.com/elastic/elasticsearch/commit/db025da8b34936451c93ce4722a0d933f79a8d50", "message": "[DOCS] Adds painles examples to index.asciidoc.", "committedDate": "2020-03-09T10:31:31Z", "type": "commit"}, {"oid": "39b4b66731e346674436790164ac2d517d562d29", "url": "https://github.com/elastic/elasticsearch/commit/39b4b66731e346674436790164ac2d517d562d29", "message": "[DOCS] Adds formatting.", "committedDate": "2020-03-09T10:41:05Z", "type": "commit"}, {"oid": "67249c1449ce44c9662b967a082eed93a309b386", "url": "https://github.com/elastic/elasticsearch/commit/67249c1449ce44c9662b967a082eed93a309b386", "message": "[DOCS] Minor adjustments.", "committedDate": "2020-03-09T15:19:56Z", "type": "commit"}, {"oid": "0b74dd4b12310c521307e55eb49cfeef17610729", "url": "https://github.com/elastic/elasticsearch/commit/0b74dd4b12310c521307e55eb49cfeef17610729", "message": "[DOCS] Adds time features as scripted fields example.", "committedDate": "2020-03-10T10:48:54Z", "type": "commit"}, {"oid": "4c1e3114d4967c3b73eaf4f819e344fa02d995a8", "url": "https://github.com/elastic/elasticsearch/commit/4c1e3114d4967c3b73eaf4f819e344fa02d995a8", "message": "[DOCS] Fixes code block closure.", "committedDate": "2020-03-10T11:03:52Z", "type": "commit"}, {"oid": "03c2d28a07ba74dc289fe175e2b746b4c76617c5", "url": "https://github.com/elastic/elasticsearch/commit/03c2d28a07ba74dc289fe175e2b746b4c76617c5", "message": "[DOCS] Minor adjustments.", "committedDate": "2020-03-10T16:11:43Z", "type": "commit"}, {"oid": "318ab7c525cbaed9cc4447e756e6376324924c87", "url": "https://github.com/elastic/elasticsearch/commit/318ab7c525cbaed9cc4447e756e6376324924c87", "message": "[DOCS] Adds group-by example and table.", "committedDate": "2020-03-11T14:55:50Z", "type": "commit"}, {"oid": "dca1e21da89b47a78c76b5192956c2ea5f4e452b", "url": "https://github.com/elastic/elasticsearch/commit/dca1e21da89b47a78c76b5192956c2ea5f4e452b", "message": "[DOCS] Adds code snippet for the bucket script example.", "committedDate": "2020-03-13T15:19:27Z", "type": "commit"}, {"oid": "f8bc975df376c8e3b91c1661831b5df0b0c47d6a", "url": "https://github.com/elastic/elasticsearch/commit/f8bc975df376c8e3b91c1661831b5df0b0c47d6a", "message": "[DOCS] Bucket script pt 2.", "committedDate": "2020-03-16T11:59:17Z", "type": "commit"}, {"oid": "1868afec9adb68fe6cfb484c5dccfdff7c39108e", "url": "https://github.com/elastic/elasticsearch/commit/1868afec9adb68fe6cfb484c5dccfdff7c39108e", "message": "[DOCS] Minor adjustments.", "committedDate": "2020-03-16T12:02:17Z", "type": "commit"}, {"oid": "52fb38c11642bbe7d026b29e574c222fb31e6fcd", "url": "https://github.com/elastic/elasticsearch/commit/52fb38c11642bbe7d026b29e574c222fb31e6fcd", "message": "[DOCS] Adjusts indentation.", "committedDate": "2020-03-16T14:54:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE4Mjc0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53274#discussion_r393182746", "bodyText": "You can use the shared attribute from https://github.com/elastic/docs/blob/master/shared/attributes.asciidoc:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-guide.html[Painless guide].\n          \n          \n            \n            {painless}/painless-guide.html[Painless guide].", "author": "lcawl", "createdAt": "2020-03-16T17:10:20Z", "path": "docs/reference/transform/painless-examples.asciidoc", "diffHunk": "@@ -0,0 +1,327 @@\n+[role=\"xpack\"]\n+[testenv=\"basic\"]\n+[[transform-painless-examples]]\n+=== Painless examples for {transforms}\n+++++\n+<titleabbrev>Painless examples for {transforms}</titleabbrev>\n+++++\n+\n+These examples demonstrate how to use Painless in {transforms}. You can learn \n+more about the Painless scripting language in the \n+https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-guide.html[Painless guide].", "originalCommit": "52fb38c11642bbe7d026b29e574c222fb31e6fcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI2NzUyNw==", "url": "https://github.com/elastic/elasticsearch/pull/53274#discussion_r393267527", "bodyText": "I added this anchor in #53618\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            {ref}/search-aggregations-metrics-scripted-metric-aggregation.html#_scope_of_scripts[scope of scripts]\n          \n          \n            \n            <<scripted-metric-aggregation-scope,scope of scripts>>", "author": "lcawl", "createdAt": "2020-03-16T19:38:18Z", "path": "docs/reference/transform/painless-examples.asciidoc", "diffHunk": "@@ -0,0 +1,327 @@\n+[role=\"xpack\"]\n+[testenv=\"basic\"]\n+[[transform-painless-examples]]\n+=== Painless examples for {transforms}\n+++++\n+<titleabbrev>Painless examples for {transforms}</titleabbrev>\n+++++\n+\n+These examples demonstrate how to use Painless in {transforms}. You can learn \n+more about the Painless scripting language in the \n+https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-guide.html[Painless guide].\n+\n+* <<painless-top-hits>>\n+* <<painless-time-features>>\n+* <<painless-group-by>>\n+* <<painless-bucket-script>>\n+\n+\n+[discrete]\n+[[painless-top-hits]]\n+==== Getting top hits by using scripted metric\n+\n+This snippet shows how to find the latest document, in other words the document \n+with the earliest timestamp. From a technical perspective, it helps to achieve \n+the function of a <<search-aggregations-metrics-top-hits-aggregation>> by using \n+scripted metric aggregation which provides a metric output.\n+\n+[source,js]\n+--------------------------------------------------\n+\"latest_doc\": { \n+  \"scripted_metric\": {\n+    \"init_script\": \"state.timestamp_latest = 0L; state.last_doc = ''\", <1>\n+    \"map_script\": \"\"\" <2>\n+      def current_date = doc['@timestamp'].getValue().toInstant().toEpochMilli(); \n+      if (current_date > state.timestamp_latest) \n+      {state.timestamp_latest = current_date;\n+      state.last_doc = new HashMap(params['_source']);}\n+    \"\"\",\n+    \"combine_script\": \"return state\", <3>\n+    \"reduce_script\": \"\"\" <4>\n+      def last_doc = '';\n+      def timestamp_latest = 0L;\n+      for (s in states) {if (s.timestamp_latest > (timestamp_latest))\n+      {timestamp_latest = s.timestamp_latest; last_doc = s.last_doc;}} \n+      return last_doc\n+    \"\"\"\n+  }\n+}\n+--------------------------------------------------\n+// NOTCONSOLE\n+\n+<1> The `init_script` creates a long type `timestamp_latest` and a string type \n+`last_doc` in the `state` object.\n+<2> The `map_script` defines `current_date` based on the timestamp of the \n+document, then compares `current_date` with `state.timestamp_latest`, finally \n+returns `state.last_doc` from the shard.\n+<3> The `combine_script` returns `state` from each shard.\n+<4> The `reduce_script` iterates through the value of `s.timestamp_latest` \n+returned by each shard and returns the document with the latest timestamp \n+(`last_doc`). In the response, the top hit (in other words, the `latest_doc`) is \n+nested below the `latest_doc` field.\n+\n+Check the\n+{ref}/search-aggregations-metrics-scripted-metric-aggregation.html#_scope_of_scripts[scope of scripts]", "originalCommit": "52fb38c11642bbe7d026b29e574c222fb31e6fcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0be57e30c9aef2654fd06e091b89c162e6e38b45", "url": "https://github.com/elastic/elasticsearch/commit/0be57e30c9aef2654fd06e091b89c162e6e38b45", "message": "Update docs/reference/transform/painless-examples.asciidoc\n\nCo-Authored-By: Lisa Cawley <lcawley@elastic.co>", "committedDate": "2020-03-17T08:18:58Z", "type": "commit"}, {"oid": "2f02c2d3e928df58c2dfa5ed0c78eac0eaeded74", "url": "https://github.com/elastic/elasticsearch/commit/2f02c2d3e928df58c2dfa5ed0c78eac0eaeded74", "message": "Update docs/reference/transform/painless-examples.asciidoc\n\nCo-Authored-By: Lisa Cawley <lcawley@elastic.co>", "committedDate": "2020-03-17T08:19:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxNjU1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53274#discussion_r393516559", "bodyText": "For correctness I think we should explain new HashMap(...):\n\"By using new HashMap(...) we copy the source document, this is important whenever you want to pass the full source object from one phase to the next.\"\nBut: let me clarify this with the painless developers, this might be a bug in painless.", "author": "hendrikmuhs", "createdAt": "2020-03-17T08:38:03Z", "path": "docs/reference/transform/painless-examples.asciidoc", "diffHunk": "@@ -0,0 +1,327 @@\n+[role=\"xpack\"]\n+[testenv=\"basic\"]\n+[[transform-painless-examples]]\n+=== Painless examples for {transforms}\n+++++\n+<titleabbrev>Painless examples for {transforms}</titleabbrev>\n+++++\n+\n+These examples demonstrate how to use Painless in {transforms}. You can learn \n+more about the Painless scripting language in the \n+{painless}/painless-guide.html[Painless guide].\n+\n+* <<painless-top-hits>>\n+* <<painless-time-features>>\n+* <<painless-group-by>>\n+* <<painless-bucket-script>>\n+\n+\n+[discrete]\n+[[painless-top-hits]]\n+==== Getting top hits by using scripted metric\n+\n+This snippet shows how to find the latest document, in other words the document \n+with the earliest timestamp. From a technical perspective, it helps to achieve \n+the function of a <<search-aggregations-metrics-top-hits-aggregation>> by using \n+scripted metric aggregation which provides a metric output.\n+\n+[source,js]\n+--------------------------------------------------\n+\"latest_doc\": { \n+  \"scripted_metric\": {\n+    \"init_script\": \"state.timestamp_latest = 0L; state.last_doc = ''\", <1>\n+    \"map_script\": \"\"\" <2>\n+      def current_date = doc['@timestamp'].getValue().toInstant().toEpochMilli(); \n+      if (current_date > state.timestamp_latest) \n+      {state.timestamp_latest = current_date;\n+      state.last_doc = new HashMap(params['_source']);}\n+    \"\"\",\n+    \"combine_script\": \"return state\", <3>\n+    \"reduce_script\": \"\"\" <4>\n+      def last_doc = '';\n+      def timestamp_latest = 0L;\n+      for (s in states) {if (s.timestamp_latest > (timestamp_latest))\n+      {timestamp_latest = s.timestamp_latest; last_doc = s.last_doc;}} \n+      return last_doc\n+    \"\"\"\n+  }\n+}\n+--------------------------------------------------\n+// NOTCONSOLE\n+\n+<1> The `init_script` creates a long type `timestamp_latest` and a string type \n+`last_doc` in the `state` object.\n+<2> The `map_script` defines `current_date` based on the timestamp of the \n+document, then compares `current_date` with `state.timestamp_latest`, finally \n+returns `state.last_doc` from the shard.", "originalCommit": "2f02c2d3e928df58c2dfa5ed0c78eac0eaeded74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgyNzQ0OA==", "url": "https://github.com/elastic/elasticsearch/pull/53274#discussion_r393827448", "bodyText": "follow up issue: #53679\n(will be picked up on thursday, so I expect some answer at the end of this week)", "author": "hendrikmuhs", "createdAt": "2020-03-17T16:55:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxNjU1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE5ODI5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53274#discussion_r394198299", "bodyText": "@hendrikmuhs Thank you for this!", "author": "szabosteve", "createdAt": "2020-03-18T09:11:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxNjU1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMwNTM1NA==", "url": "https://github.com/elastic/elasticsearch/pull/53274#discussion_r396305354", "bodyText": "For the record: we decided to go forward with the workaround and change the documentation once #53679 got fixed.", "author": "hendrikmuhs", "createdAt": "2020-03-23T09:16:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxNjU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyMDc5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53274#discussion_r393520795", "bodyText": "This PR has the 7.6.2 label, too. However scripting in group_by is a 7.7 feature.", "author": "hendrikmuhs", "createdAt": "2020-03-17T08:46:07Z", "path": "docs/reference/transform/painless-examples.asciidoc", "diffHunk": "@@ -0,0 +1,327 @@\n+[role=\"xpack\"]\n+[testenv=\"basic\"]\n+[[transform-painless-examples]]\n+=== Painless examples for {transforms}\n+++++\n+<titleabbrev>Painless examples for {transforms}</titleabbrev>\n+++++\n+\n+These examples demonstrate how to use Painless in {transforms}. You can learn \n+more about the Painless scripting language in the \n+{painless}/painless-guide.html[Painless guide].\n+\n+* <<painless-top-hits>>\n+* <<painless-time-features>>\n+* <<painless-group-by>>\n+* <<painless-bucket-script>>\n+\n+\n+[discrete]\n+[[painless-top-hits]]\n+==== Getting top hits by using scripted metric\n+\n+This snippet shows how to find the latest document, in other words the document \n+with the earliest timestamp. From a technical perspective, it helps to achieve \n+the function of a <<search-aggregations-metrics-top-hits-aggregation>> by using \n+scripted metric aggregation which provides a metric output.\n+\n+[source,js]\n+--------------------------------------------------\n+\"latest_doc\": { \n+  \"scripted_metric\": {\n+    \"init_script\": \"state.timestamp_latest = 0L; state.last_doc = ''\", <1>\n+    \"map_script\": \"\"\" <2>\n+      def current_date = doc['@timestamp'].getValue().toInstant().toEpochMilli(); \n+      if (current_date > state.timestamp_latest) \n+      {state.timestamp_latest = current_date;\n+      state.last_doc = new HashMap(params['_source']);}\n+    \"\"\",\n+    \"combine_script\": \"return state\", <3>\n+    \"reduce_script\": \"\"\" <4>\n+      def last_doc = '';\n+      def timestamp_latest = 0L;\n+      for (s in states) {if (s.timestamp_latest > (timestamp_latest))\n+      {timestamp_latest = s.timestamp_latest; last_doc = s.last_doc;}} \n+      return last_doc\n+    \"\"\"\n+  }\n+}\n+--------------------------------------------------\n+// NOTCONSOLE\n+\n+<1> The `init_script` creates a long type `timestamp_latest` and a string type \n+`last_doc` in the `state` object.\n+<2> The `map_script` defines `current_date` based on the timestamp of the \n+document, then compares `current_date` with `state.timestamp_latest`, finally \n+returns `state.last_doc` from the shard.\n+<3> The `combine_script` returns `state` from each shard.\n+<4> The `reduce_script` iterates through the value of `s.timestamp_latest` \n+returned by each shard and returns the document with the latest timestamp \n+(`last_doc`). In the response, the top hit (in other words, the `latest_doc`) is \n+nested below the `latest_doc` field.\n+\n+Check the\n+<<scripted-metric-aggregation-scope,scope of scripts>>\n+for detailed explanation on the respective scripts.\n+\n+You can retrieve the last value in a similar way: \n+\n+[source,js]\n+--------------------------------------------------\n+\"latest_value\": {\n+  \"scripted_metric\": {\n+    \"init_script\": \"state.timestamp_latest = 0L; state.last_value = ''\",\n+    \"map_script\": \"\"\"\n+      def current_date = doc['date'].getValue().toInstant().toEpochMilli(); \n+      if (current_date > state.timestamp_latest) \n+      {state.timestamp_latest = current_date;\n+      state.last_value = params['_source']['value'];}\n+    \"\"\",\n+    \"combine_script\": \"return state\",\n+    \"reduce_script\": \"\"\"\n+      def last_value = '';\n+      def timestamp_latest = 0L; \n+      for (s in states) {if (s.timestamp_latest > (timestamp_latest)) \n+      {timestamp_latest = s.timestamp_latest; last_value = s.last_value;}} \n+      return last_value\n+    \"\"\"\n+  }\n+}\n+--------------------------------------------------\n+// NOTCONSOLE\n+\n+\n+[discrete]\n+[[painless-time-features]]\n+==== Getting time features as scripted fields\n+\n+This snippet shows how to extract time based features by using Painless. The \n+snippet uses an index where `@timestamp` is defined as a `date` type field.\n+\n+[source,js]\n+--------------------------------------------------\n+\"script_fields\": {\n+    \"hour_of_day\": { <1>\n+      \"script\": {\n+        \"lang\": \"painless\",\n+        \"source\": \"\"\"\n+          ZonedDateTime date =  doc['@timestamp'].value; <2>\n+          return date.getHour(); <3>\n+        \"\"\"\n+      }\n+    },\n+    \"month_of_year\": { <4>\n+      \"script\": {\n+        \"lang\": \"painless\",\n+        \"source\": \"\"\"\n+          ZonedDateTime date =  doc['@timestamp'].value; <5>\n+          return date.getMonthValue(); <6>\n+        \"\"\"\n+      }\n+    }\n+  }\n+--------------------------------------------------\n+// NOTCONSOLE\n+\n+<1> Contains the Painless script that returns the hour of the day.\n+<2> Sets `date` based on the timestamp of the document.\n+<3> Returns the hour value from `date`.\n+<4> Contains the Painless script that returns the month of the year.\n+<5> Sets `date` based on the timestamp of the document.\n+<6> Returns the month value from `date`.\n+\n+\n+[discrete]\n+[[painless-group-by]]\n+==== Using Painless in `group_by`", "originalCommit": "2f02c2d3e928df58c2dfa5ed0c78eac0eaeded74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUzMTM2OA==", "url": "https://github.com/elastic/elasticsearch/pull/53274#discussion_r393531368", "bodyText": "@hendrikmuhs Thanks, Hendrik! I removed the label.", "author": "szabosteve", "createdAt": "2020-03-17T09:05:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyMDc5NQ=="}], "type": "inlineReview"}, {"oid": "d177dd460cfb0ee87fab93b75777ea76c9c7c728", "url": "https://github.com/elastic/elasticsearch/commit/d177dd460cfb0ee87fab93b75777ea76c9c7c728", "message": "[DOCS] Explains new HashMap(...) in the first example.", "committedDate": "2020-03-19T09:57:41Z", "type": "commit"}, {"oid": "1243da70d10db4246019a90b0af2691a6eac968d", "url": "https://github.com/elastic/elasticsearch/commit/1243da70d10db4246019a90b0af2691a6eac968d", "message": "Merge branch 'painless.transforms' of github.com:szabosteve/elasticsearch into painless.transforms", "committedDate": "2020-03-23T09:07:34Z", "type": "commit"}]}