{"pr_number": 55201, "pr_title": "Treat IdP roles as a SortedSet", "pr_createdAt": "2020-04-15T06:21:36Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55201", "timeline": [{"oid": "e8c783ffc356d6d7ab030b03594accfa44cd880f", "url": "https://github.com/elastic/elasticsearch/commit/e8c783ffc356d6d7ab030b03594accfa44cd880f", "message": "Treat roles as a SortedSet\n\nThe Saml SP document stored the role mapping in a Set, but this made\nthe order in XContent inconsistent. This switched it to use a TreeSet.\n\nResolves: #54733", "committedDate": "2020-04-15T05:07:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYxODU3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55201#discussion_r408618576", "bodyText": "I don't see how we would get a null String in the Collection here but I assume that the NPE we would throw is fine and we don;t want to guard this with requireNonNull or similar ?", "author": "jkakavas", "createdAt": "2020-04-15T06:53:26Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/SamlServiceProviderDocument.java", "diffHunk": "@@ -52,14 +54,15 @@\n \n     public static class Privileges {\n         public String resource;\n-        public Set<String> rolePatterns = Set.of();\n+        // we use a sorted set so that the order is consistent in XContent APIs\n+        public SortedSet<String> rolePatterns = new TreeSet<>();\n \n         public void setResource(String resource) {\n             this.resource = resource;\n         }\n \n         public void setRolePatterns(Collection<String> rolePatterns) {\n-            this.rolePatterns = Set.copyOf(rolePatterns);\n+            this.rolePatterns = new TreeSet<>(rolePatterns);", "originalCommit": "e8c783ffc356d6d7ab030b03594accfa44cd880f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI4OTI0NA==", "url": "https://github.com/elastic/elasticsearch/pull/55201#discussion_r409289244", "bodyText": "copyOf would fail on null Strings, so I don't think there's any change here.", "author": "tvernum", "createdAt": "2020-04-16T05:23:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYxODU3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYzMDA1NA==", "url": "https://github.com/elastic/elasticsearch/pull/55201#discussion_r408630054", "bodyText": "We don't need this to be sorted/consistent for any other reason that testing the XContent to/from right?  We use it in https://github.com/elastic/elasticsearch/blob/7.7/x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/SamlServiceProviderFactory.java#L67 so we shouldn't care about performance that much since we cache the built service provider. Just thinking out loud here", "author": "jkakavas", "createdAt": "2020-04-15T07:18:10Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/SamlServiceProviderDocument.java", "diffHunk": "@@ -52,14 +54,15 @@\n \n     public static class Privileges {\n         public String resource;\n-        public Set<String> rolePatterns = Set.of();\n+        // we use a sorted set so that the order is consistent in XContent APIs\n+        public SortedSet<String> rolePatterns = new TreeSet<>();", "originalCommit": "e8c783ffc356d6d7ab030b03594accfa44cd880f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI4OTcxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/55201#discussion_r409289719", "bodyText": "I had the same thought stream. I don't think there's really any issue here. Yes, we're sorting the set where it might not be needed, but 99% of the time it will have 1 item in it, so the impact is effectively zero in real world usage.", "author": "tvernum", "createdAt": "2020-04-16T05:25:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYzMDA1NA=="}], "type": "inlineReview"}]}