{"pr_number": 64461, "pr_title": "Limit the Number of Snapshots in a BlobStoreRepository", "pr_createdAt": "2020-11-02T09:40:31Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64461", "timeline": [{"oid": "4a290c841b9a77cb86bec63fa402593b328f8059", "url": "https://github.com/elastic/elasticsearch/commit/4a290c841b9a77cb86bec63fa402593b328f8059", "message": "Limit the Number of Snapshots in a BlobStoreRepository\n\nAdds a limit to the maximum number of snapshots that are allowed\nto be added to a snapshot repository as a safety measure of last resort\nagainst repositories that grow to an unmanagable size due to e.g. incorrect SLM\nsettings.", "committedDate": "2020-11-02T09:30:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg4ODI5MA==", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515888290", "bodyText": "This setting name might be confusing.  I would rename to max_number_of_snapshots.", "author": "fcofdez", "createdAt": "2020-11-02T10:49:45Z", "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "diffHunk": "@@ -162,6 +162,9 @@ unit, for example: `1GB`, `10MB`, `5KB`, `500B`. Defaults to `null` (unlimited c\n `max_restore_bytes_per_sec`:: Throttles per node restore rate. Defaults to unlimited. Note that restores are also throttled through <<recovery,recovery settings>>.\n `max_snapshot_bytes_per_sec`:: Throttles per node snapshot rate. Defaults to `40mb` per second.\n `readonly`:: Makes repository read-only.  Defaults to `false`.\n+`size_limit`:: Limits the maximum number of snapshots that the repository may contain. Defaults to `500`. Note that snapshot repositories do not", "originalCommit": "4a290c841b9a77cb86bec63fa402593b328f8059", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkxMzQ4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515913483", "bodyText": "++", "author": "original-brownbear", "createdAt": "2020-11-02T11:37:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg4ODI5MA=="}], "type": "inlineReview"}, {"oid": "0a39d31341333382a9b1b177774c2d0c67bb5633", "url": "https://github.com/elastic/elasticsearch/commit/0a39d31341333382a9b1b177774c2d0c67bb5633", "message": "Merge remote-tracking branch 'elastic/master' into limit-snapshots-per-blobstore-repository", "committedDate": "2020-11-02T11:37:37Z", "type": "commit"}, {"oid": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8", "url": "https://github.com/elastic/elasticsearch/commit/f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8", "message": "CR: rename setting", "committedDate": "2020-11-02T11:43:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1MTk2OA==", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515951968", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            listener.onFailure(new RepositoryException(metadata.name(), \"Can not add another snapshot to this repository as it \" +\n          \n          \n            \n                            listener.onFailure(new RepositoryException(metadata.name(), \"Cannot add another snapshot to this repository as it \" +", "author": "DaveCTurner", "createdAt": "2020-11-02T12:55:41Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1081,6 +1094,14 @@ public void finalizeSnapshot(final ShardGenerations shardGenerations,\n         final StepListener<RepositoryData> repoDataListener = new StepListener<>();\n         getRepositoryData(repoDataListener);\n         repoDataListener.whenComplete(existingRepositoryData -> {\n+            final int existingSnapshotCount = existingRepositoryData.getSnapshotIds().size();\n+            if (existingSnapshotCount >= maxSnapshotCount) {\n+                listener.onFailure(new RepositoryException(metadata.name(), \"Can not add another snapshot to this repository as it \" +", "originalCommit": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1MjU3MA==", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515952570", "bodyText": "I think we should name the setting in the message (as done here) but think we shouldn't recommend increasing it if you hit the limit and should instead suggest deleting some snapshots and/or adjusting retention settings to bring the snapshot count below the limit.", "author": "DaveCTurner", "createdAt": "2020-11-02T12:56:47Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1081,6 +1094,14 @@ public void finalizeSnapshot(final ShardGenerations shardGenerations,\n         final StepListener<RepositoryData> repoDataListener = new StepListener<>();\n         getRepositoryData(repoDataListener);\n         repoDataListener.whenComplete(existingRepositoryData -> {\n+            final int existingSnapshotCount = existingRepositoryData.getSnapshotIds().size();\n+            if (existingSnapshotCount >= maxSnapshotCount) {\n+                listener.onFailure(new RepositoryException(metadata.name(), \"Can not add another snapshot to this repository as it \" +\n+                        \"already contains [\" + existingSnapshotCount + \"] snapshots and is configured to hold up to [\" + maxSnapshotCount +\n+                        \"] snapshots only. Please increase repository setting [\" + MAX_SNAPSHOTS_SETTING.getKey() +", "originalCommit": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk2MjA5MA==", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515962090", "bodyText": "++ adjusted the exception message", "author": "original-brownbear", "createdAt": "2020-11-02T13:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1MjU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1MzA3OA==", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515953078", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            scale indefinitely in size and might lead to master node performance and stability issues if grown past a certain size. Increasing this setting\n          \n          \n            \n            scale indefinitely in size and might lead to master node performance and stability issues if they grow past a certain size. We do not recommend increasing this setting.", "author": "DaveCTurner", "createdAt": "2020-11-02T12:57:35Z", "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "diffHunk": "@@ -162,6 +162,9 @@ unit, for example: `1GB`, `10MB`, `5KB`, `500B`. Defaults to `null` (unlimited c\n `max_restore_bytes_per_sec`:: Throttles per node restore rate. Defaults to unlimited. Note that restores are also throttled through <<recovery,recovery settings>>.\n `max_snapshot_bytes_per_sec`:: Throttles per node snapshot rate. Defaults to `40mb` per second.\n `readonly`:: Makes repository read-only.  Defaults to `false`.\n+`max_number_of_snapshots`:: Limits the maximum number of snapshots that the repository may contain. Defaults to `500`. Note that snapshot repositories do not\n+scale indefinitely in size and might lead to master node performance and stability issues if grown past a certain size. Increasing this setting", "originalCommit": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1Mzc5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515953791", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            is generally not advisable and should be weighted carefully against alternatives such as deleting older snapshots or creating multiple repositories.\n          \n          \n            \n            Instead you should delete older snapshots or use multiple repositories.\n          \n      \n    \n    \n  \n\nIs creating multiple repositories really a solution?", "author": "DaveCTurner", "createdAt": "2020-11-02T12:58:56Z", "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "diffHunk": "@@ -162,6 +162,9 @@ unit, for example: `1GB`, `10MB`, `5KB`, `500B`. Defaults to `null` (unlimited c\n `max_restore_bytes_per_sec`:: Throttles per node restore rate. Defaults to unlimited. Note that restores are also throttled through <<recovery,recovery settings>>.\n `max_snapshot_bytes_per_sec`:: Throttles per node snapshot rate. Defaults to `40mb` per second.\n `readonly`:: Makes repository read-only.  Defaults to `false`.\n+`max_number_of_snapshots`:: Limits the maximum number of snapshots that the repository may contain. Defaults to `500`. Note that snapshot repositories do not\n+scale indefinitely in size and might lead to master node performance and stability issues if grown past a certain size. Increasing this setting\n+is generally not advisable and should be weighted carefully against alternatives such as deleting older snapshots or creating multiple repositories.", "originalCommit": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1NTYxMg==", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515955612", "bodyText": "I guess technically yes, not a great one but you could run two (or more) SLM policies that take turns creating snapshots I suppose. That way you could have a much longer retention time at high resolution.\nAlso, if you just want certain snapshots to live for a long time maybe it's a solution.\n... certainly all of these aren't super ergonomically but I guess for some use-cases these are valid?", "author": "original-brownbear", "createdAt": "2020-11-02T13:02:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1Mzc5MQ=="}], "type": "inlineReview"}, {"oid": "2463271da49c4f8dd3229d6ebc24ed662d96101c", "url": "https://github.com/elastic/elasticsearch/commit/2463271da49c4f8dd3229d6ebc24ed662d96101c", "message": "Update docs/reference/snapshot-restore/register-repository.asciidoc\n\nCo-authored-by: David Turner <david.turner@elastic.co>", "committedDate": "2020-11-02T13:03:13Z", "type": "commit"}, {"oid": "de3199c75f38385988cf6de4d3cfe8aaaf6abbf5", "url": "https://github.com/elastic/elasticsearch/commit/de3199c75f38385988cf6de4d3cfe8aaaf6abbf5", "message": "Update docs/reference/snapshot-restore/register-repository.asciidoc\n\nCo-authored-by: David Turner <david.turner@elastic.co>", "committedDate": "2020-11-02T13:03:26Z", "type": "commit"}, {"oid": "da46ccb71c280207c7429260101ce37904765b6c", "url": "https://github.com/elastic/elasticsearch/commit/da46ccb71c280207c7429260101ce37904765b6c", "message": "Update server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java\n\nCo-authored-by: David Turner <david.turner@elastic.co>", "committedDate": "2020-11-02T13:03:42Z", "type": "commit"}, {"oid": "990d83bafc710d5b1347d1036d6a1375f6380569", "url": "https://github.com/elastic/elasticsearch/commit/990d83bafc710d5b1347d1036d6a1375f6380569", "message": "adjust exception msg", "committedDate": "2020-11-02T13:05:58Z", "type": "commit"}, {"oid": "80510e2810aca06673d98b6a48ee1c8bfd15e131", "url": "https://github.com/elastic/elasticsearch/commit/80510e2810aca06673d98b6a48ee1c8bfd15e131", "message": "Merge remote-tracking branch 'elastic/master' into limit-snapshots-per-blobstore-repository", "committedDate": "2020-11-02T13:46:53Z", "type": "commit"}, {"oid": "aeed53b51b46813ef3df4debdf3f0541e5b3a4cc", "url": "https://github.com/elastic/elasticsearch/commit/aeed53b51b46813ef3df4debdf3f0541e5b3a4cc", "message": "Merge remote-tracking branch 'elastic/master' into limit-snapshots-per-blobstore-repository", "committedDate": "2020-11-03T12:00:27Z", "type": "commit"}]}