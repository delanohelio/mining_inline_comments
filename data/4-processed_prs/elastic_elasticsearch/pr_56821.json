{"pr_number": 56821, "pr_title": "Track multipart/resumable uploads GCS API calls", "pr_createdAt": "2020-05-15T13:35:33Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56821", "timeline": [{"oid": "4bdd164a3f649145a67cb109d308ffddc27c5d9a", "url": "https://github.com/elastic/elasticsearch/commit/4bdd164a3f649145a67cb109d308ffddc27c5d9a", "message": "Track multipart/resumable uploads GCS API calls\n\nAdd tracking for multipart and resumable uploads for GoogleCloudStorage.\nFor resumable uploads only the last request is taken into account for\nbilling, so that's the only request that's tracked.", "committedDate": "2020-05-15T13:28:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgzNDAxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/56821#discussion_r425834019", "bodyText": "Let's track this under a different key so we can identify the counts by type? Just POST is probably fine here as I currently can't think of another POST we do on GCS.", "author": "original-brownbear", "createdAt": "2020-05-15T14:19:01Z", "path": "plugins/repository-gcs/src/test/java/org/elasticsearch/repositories/gcs/GoogleCloudStorageBlobStoreRepositoryTests.java", "diffHunk": "@@ -289,17 +292,40 @@ protected boolean canFailRequest(final HttpExchange exchange) {\n     @SuppressForbidden(reason = \"this tests uses a HttpServer to emulate an GCS endpoint\")\n     private static class GoogleCloudStorageStatsCollectorHttpHandler extends HttpStatsCollectorHandler {\n \n+        public static final Pattern contentRangeMatcher = Pattern.compile(\"bytes \\\\d+-(\\\\d+)/(\\\\d+)\");\n+\n         GoogleCloudStorageStatsCollectorHttpHandler(final HttpHandler delegate) {\n             super(delegate);\n         }\n \n         @Override\n-        public void maybeTrack(final String request) {\n+        public void maybeTrack(final String request, Headers requestHeaders) {\n             if (Regex.simpleMatch(\"GET /storage/v1/b/*/o*\", request)) {\n                 trackRequest(\"LIST\");\n             } else if (Regex.simpleMatch(\"GET /download/storage/v1/b/*\", request)) {\n                 trackRequest(\"GET\");\n+            } else if (Regex.simpleMatch(\"PUT /upload/storage/v1/b/*\", request) && isLastPart(requestHeaders)) {\n+                trackRequest(\"PUT\");\n+            } else if (Regex.simpleMatch(\"POST /upload/storage/v1/b/*uploadType=multipart*\", request)) {\n+                trackRequest(\"PUT\");", "originalCommit": "4bdd164a3f649145a67cb109d308ffddc27c5d9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgzNjkyMA==", "url": "https://github.com/elastic/elasticsearch/pull/56821#discussion_r425836920", "bodyText": "As mentioned below, let's give this a separate key to track under so we get metrics on what upload type we use how often.", "author": "original-brownbear", "createdAt": "2020-05-15T14:23:12Z", "path": "plugins/repository-gcs/src/main/java/org/elasticsearch/repositories/gcs/GoogleCloudStorageBlobStore.java", "diffHunk": "@@ -335,6 +336,7 @@ private void writeBlobMultipart(BlobInfo blobInfo, InputStream inputStream, long\n                 new Storage.BlobTargetOption[0];\n             SocketAccess.doPrivilegedVoidIOException(\n                     () -> client().create(blobInfo, buffer, targetOptions));\n+            stats.trackPutObjectOperation();", "originalCommit": "4bdd164a3f649145a67cb109d308ffddc27c5d9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3b907b285a40857b92710aae0d8f098395946b63", "url": "https://github.com/elastic/elasticsearch/commit/3b907b285a40857b92710aae0d8f098395946b63", "message": "Classify multipart and resumable uploads into two categories", "committedDate": "2020-05-15T15:06:55Z", "type": "commit"}, {"oid": "139d5539a53b5c8794563b5effad7b15d238656b", "url": "https://github.com/elastic/elasticsearch/commit/139d5539a53b5c8794563b5effad7b15d238656b", "message": "Change how requests are counted.", "committedDate": "2020-05-15T15:10:17Z", "type": "commit"}, {"oid": "321989853793a840c00afb6fbb88a90692cba35d", "url": "https://github.com/elastic/elasticsearch/commit/321989853793a840c00afb6fbb88a90692cba35d", "message": "Clarify why put and post are tracked differently", "committedDate": "2020-05-18T08:02:52Z", "type": "commit"}, {"oid": "2c53f47c463b849c1791cd3f78b0f121cabe11aa", "url": "https://github.com/elastic/elasticsearch/commit/2c53f47c463b849c1791cd3f78b0f121cabe11aa", "message": "Merge remote-tracking branch 'origin/master' into track-put-requests-gcs", "committedDate": "2020-05-18T08:03:39Z", "type": "commit"}]}