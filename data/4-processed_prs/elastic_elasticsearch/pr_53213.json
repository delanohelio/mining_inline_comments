{"pr_number": 53213, "pr_title": "Resolve correct service privileges for user", "pr_createdAt": "2020-03-06T04:47:39Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53213", "timeline": [{"oid": "191a935918065d9342eca4acc5ad02533322bc74", "url": "https://github.com/elastic/elasticsearch/commit/191a935918065d9342eca4acc5ad02533322bc74", "message": "Resolve correct service privileges for user\n\nWhen a user SSOs to a service provider, the IdP will provide\nattributes to indicate the user's access (roles) in that service.\n\nThis change connect the component that determines the user's access\n(UserPrivilegeResolver) to the action that generates the SAML response\n(TransportSamlInitiateSingleSignOnAction).", "committedDate": "2020-03-06T04:42:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU5Mzc0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53213#discussion_r389593742", "bodyText": "I think we should and it's fine to do in a followup", "author": "jkakavas", "createdAt": "2020-03-09T11:08:01Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "diffHunk": "@@ -66,14 +67,25 @@ protected void doExecute(Task task, SamlInitiateSingleSignOnRequest request,\n                         listener.onFailure(new IllegalStateException(\"Request is missing secondary authentication\"));\n                         return;\n                     }\n-                    final UserServiceAuthentication user = buildUserFromAuthentication(secondaryAuthentication.getAuthentication(), sp);\n-                    final SuccessfulAuthenticationResponseMessageBuilder builder = new SuccessfulAuthenticationResponseMessageBuilder(\n-                        samlFactory, Clock.systemUTC(), identityProvider);\n-                    final Response response = builder.build(user, null);\n-                    listener.onResponse(new SamlInitiateSingleSignOnResponse(\n-                        user.getServiceProvider().getAssertionConsumerService().toString(),\n-                        samlFactory.getXmlContent(response),\n-                        user.getServiceProvider().getEntityId()));\n+                    buildUserFromAuthentication(secondaryAuthentication, sp, ActionListener.wrap(\n+                        user -> {\n+                            if (user == null) {\n+                                // TODO return SAML failure instead?", "originalCommit": "191a935918065d9342eca4acc5ad02533322bc74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6a70c7fe16866a862a074570f25a8ecf1fc6a96c", "url": "https://github.com/elastic/elasticsearch/commit/6a70c7fe16866a862a074570f25a8ecf1fc6a96c", "message": "Merge branch 'feature-internal-idp' into idp/real-privileges", "committedDate": "2020-03-10T01:10:06Z", "type": "commit"}]}