{"pr_number": 53260, "pr_title": "Use given executor for global checkpoint listener", "pr_createdAt": "2020-03-07T18:53:56Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53260", "timeline": [{"oid": "e086753926e4940cb4d165412230073187015de1", "url": "https://github.com/elastic/elasticsearch/commit/e086753926e4940cb4d165412230073187015de1", "message": "Use given executor for global checkpoint listener\n\nToday when notifying a global checkpoint listener, we use the listener\nthread pool. This commit turns this inside out so that the global\ncheckpoint listener must provide an executor on which to notify the\nlistener.", "committedDate": "2020-03-07T18:51:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MDgxMA==", "url": "https://github.com/elastic/elasticsearch/pull/53260#discussion_r389340810", "bodyText": "It seems this default is only used in tests (and the interface is only implemented once anyways), should we maybe just extract some utility method into tests to build these listeners?\nE.g.\n    public static GlobalCheckpointListeners.GlobalCheckpointListener syncListener(BiConsumer<Long, Exception> consumer) {\n        return new GlobalCheckpointListeners.GlobalCheckpointListener() {\n            @Override\n            public Executor executor() {\n                return Runnable::run;\n            }\n\n            @Override\n            public void accept(long globalCheckpoint, Exception e) {\n                consumer.accept(globalCheckpoint, e);\n            }\n        };\n    }\nIt seems a little strange to mark this as a @FunctionalInterface when it really only is one in tests?", "author": "original-brownbear", "createdAt": "2020-03-08T06:43:49Z", "path": "server/src/main/java/org/elasticsearch/index/shard/GlobalCheckpointListeners.java", "diffHunk": "@@ -53,6 +53,16 @@\n      */\n     @FunctionalInterface\n     public interface GlobalCheckpointListener {\n+\n+        /**\n+         * The executor on which the listener is notified. Defaults to the calling thread.\n+         *\n+         * @return the executor\n+         */\n+        default Executor executor() {\n+            return Runnable::run;", "originalCommit": "e086753926e4940cb4d165412230073187015de1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM3MDY4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53260#discussion_r389370687", "bodyText": "I pushed b565820. I mistakenly combined your two suggestions into a single commit, sorry.", "author": "jasontedor", "createdAt": "2020-03-08T13:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MDgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MDkyMg==", "url": "https://github.com/elastic/elasticsearch/pull/53260#discussion_r389340922", "bodyText": "Maybe move the wrapping listener.executor().execute(() ... into notifyListener to dry things up? We only ever invoke notifyListener from listener.executor().execute(() -> ... anyway.", "author": "original-brownbear", "createdAt": "2020-03-08T06:46:24Z", "path": "server/src/main/java/org/elasticsearch/index/shard/GlobalCheckpointListeners.java", "diffHunk": "@@ -214,16 +220,15 @@ private void notifyListeners(final long globalCheckpoint, final IndexShardClosed\n             listeners.clear();\n         }\n         if (listenersToNotify.isEmpty() == false) {\n-            executor.execute(() ->\n-                    listenersToNotify\n-                            .forEach((listener, t) -> {\n-                                /*\n-                                 * We do not want to interrupt any timeouts that fired, these will detect that the listener has been\n-                                 * notified and not trigger the timeout.\n-                                 */\n-                                FutureUtils.cancel(t.v2());\n-                                notifyListener(listener, globalCheckpoint, e);\n-                            }));\n+            listenersToNotify\n+                .forEach((listener, t) -> {\n+                    /*\n+                     * We do not want to interrupt any timeouts that fired, these will detect that the listener has been notified and not\n+                     * trigger the timeout.\n+                     */\n+                    FutureUtils.cancel(t.v2());\n+                    listener.executor().execute(() -> notifyListener(listener, globalCheckpoint, e));", "originalCommit": "e086753926e4940cb4d165412230073187015de1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM3MDY5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53260#discussion_r389370699", "bodyText": "I pushed b565820. I mistakenly combined your two suggestions into a single commit, sorry.", "author": "jasontedor", "createdAt": "2020-03-08T13:42:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MDkyMg=="}], "type": "inlineReview"}, {"oid": "b565820a862107f74bfdd23a99158a820e1231f9", "url": "https://github.com/elastic/elasticsearch/commit/b565820a862107f74bfdd23a99158a820e1231f9", "message": "Remove functional interface", "committedDate": "2020-03-08T13:40:30Z", "type": "commit"}, {"oid": "0d37aeacbdd3b3a401a72522cc98271fc795b4c0", "url": "https://github.com/elastic/elasticsearch/commit/0d37aeacbdd3b3a401a72522cc98271fc795b4c0", "message": "Remove stale comment", "committedDate": "2020-03-08T13:43:11Z", "type": "commit"}, {"oid": "d4fbc83623a5cfe737dbfc88e679347b20c78f24", "url": "https://github.com/elastic/elasticsearch/commit/d4fbc83623a5cfe737dbfc88e679347b20c78f24", "message": "Fix compilation", "committedDate": "2020-03-08T14:07:35Z", "type": "commit"}]}