{"pr_number": 57378, "pr_title": "Refactor how to determine if a field is metafield", "pr_createdAt": "2020-05-29T18:31:53Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57378", "timeline": [{"oid": "3de627247eed5e4fccd432ae4b1675848e39ae83", "url": "https://github.com/elastic/elasticsearch/commit/3de627247eed5e4fccd432ae4b1675848e39ae83", "message": "Refactor how to determine if a field is metafield\n\nBefore to determine if a field is meta-field, a static method of MapperService\nisMetadataField was used. This method was using an outdated static list\nof meta-fields.\n\nThis PR instead changes this method to the instance method that\nis also aware of meta-fields in all registered plugins.\n\nRelated #38373, #41656\nCloses #24422", "committedDate": "2020-05-29T19:25:50Z", "type": "commit"}, {"oid": "3de627247eed5e4fccd432ae4b1675848e39ae83", "url": "https://github.com/elastic/elasticsearch/commit/3de627247eed5e4fccd432ae4b1675848e39ae83", "message": "Refactor how to determine if a field is metafield\n\nBefore to determine if a field is meta-field, a static method of MapperService\nisMetadataField was used. This method was using an outdated static list\nof meta-fields.\n\nThis PR instead changes this method to the instance method that\nis also aware of meta-fields in all registered plugins.\n\nRelated #38373, #41656\nCloses #24422", "committedDate": "2020-05-29T19:25:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkxMjU5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r433912595", "bodyText": "suggestion: maybe having two methods would be clearer to read: setMetaDataField, setDocumentField? Or is this method used a lot or maybe by users so the API change would be bad? I think we mostly use it internally? Just throwing this out, maybe this makes code at the call sites uglier...", "author": "cbuescher", "createdAt": "2020-06-02T14:17:21Z", "path": "server/src/main/java/org/elasticsearch/search/SearchHit.java", "diffHunk": "@@ -449,17 +442,28 @@ public String getSourceAsString() {\n      * The hit field matching the given field name.\n      */\n     public DocumentField field(String fieldName) {\n-        return getFields().get(fieldName);\n+        DocumentField result = documentFields.get(fieldName);\n+        if (result != null) {\n+            return result;\n+        } else {\n+            return metaFields.get(fieldName);\n+        }\n+    }\n+\n+    public boolean isMetadataField(String fieldName) {\n+        return metaFields.containsKey(fieldName);\n     }\n \n     /*\n     * Adds a new DocumentField to the map in case both parameters are not null.\n     * */\n-    public void setField(String fieldName, DocumentField field) {\n+    public void setField(String fieldName, DocumentField field, boolean isMetaField) {", "originalCommit": "3de627247eed5e4fccd432ae4b1675848e39ae83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4NzA5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r434787096", "bodyText": "Thanks, this is a good suggestion! I will rename this method to setDocumentField and make metaFields final as they are never modified.", "author": "mayya-sharipova", "createdAt": "2020-06-03T18:59:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkxMjU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkxNzE3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r433917176", "bodyText": "If I read this method right, fieldName should be either FIELD_NAME_PREFIX or FIELD_NAME_PREFIX + \"_\" + percolateQuery.getName(), which I'm not sure if they are meta or document fields, but that should be fixed, so maybe we don't need to ask the mapperService here? That would also mean call sites don't have to pass it in.", "author": "cbuescher", "createdAt": "2020-06-02T14:23:33Z", "path": "modules/percolator/src/main/java/org/elasticsearch/percolator/PercolatorMatchedSlotSubFetchPhase.java", "diffHunk": "@@ -101,13 +101,9 @@ static void innerHitsExecute(Query mainQuery,\n                     continue;\n                 }\n \n-                Map<String, DocumentField> fields = hit.fieldsOrNull();\n-                if (fields == null) {\n-                    fields = new HashMap<>();\n-                    hit.fields(fields);\n-                }\n                 IntStream slots = convertTopDocsToSlots(topDocs, rootDocsBySlot);\n-                hit.setField(fieldName, new DocumentField(fieldName, slots.boxed().collect(Collectors.toList())));\n+                hit.setField(fieldName, new DocumentField(fieldName, slots.boxed().collect(Collectors.toList())),", "originalCommit": "3de627247eed5e4fccd432ae4b1675848e39ae83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkyMTEyMg==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r433921122", "bodyText": "Do we need to test that \"_routing\" is a meta data field here?", "author": "cbuescher", "createdAt": "2020-06-02T14:28:51Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/search/fields/SearchFieldsIT.java", "diffHunk": "@@ -659,7 +659,7 @@ public void testSearchFieldsMetadata() throws Exception {\n \n         assertThat(searchResponse.getHits().getTotalHits().value, equalTo(1L));\n         assertThat(searchResponse.getHits().getAt(0).field(\"field1\"), nullValue());\n-        assertThat(searchResponse.getHits().getAt(0).field(\"_routing\").isMetadataField(), equalTo(true));\n+        assertThat(searchResponse.getHits().getAt(0).isMetadataField(\"_routing\"), equalTo(true));", "originalCommit": "3de627247eed5e4fccd432ae4b1675848e39ae83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc3MDk4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r434770983", "bodyText": "This is not necessary, I just tried to imitate the olde test, I can remove this line instead.", "author": "mayya-sharipova", "createdAt": "2020-06-03T18:29:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkyMTEyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkyNDExNg==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r433924116", "bodyText": "Do we need this method? I think its only used in tests atm, we can ask MapperService directly there if needed.", "author": "cbuescher", "createdAt": "2020-06-02T14:32:57Z", "path": "server/src/main/java/org/elasticsearch/search/SearchHit.java", "diffHunk": "@@ -449,17 +442,28 @@ public String getSourceAsString() {\n      * The hit field matching the given field name.\n      */\n     public DocumentField field(String fieldName) {\n-        return getFields().get(fieldName);\n+        DocumentField result = documentFields.get(fieldName);\n+        if (result != null) {\n+            return result;\n+        } else {\n+            return metaFields.get(fieldName);\n+        }\n+    }\n+\n+    public boolean isMetadataField(String fieldName) {", "originalCommit": "3de627247eed5e4fccd432ae4b1675848e39ae83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxMjQwOA==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r434012408", "bodyText": "Is this because the maps might be an immutable empty map? I would be interested why you chose this over simply new HashMap() e.g in the ctor, isn't it highly likely that we add meta-fields at some point (e.g. _index etc...)? I think I'd prefer using a modifiable map in ctor / deserialization in that case from the start just to make things simpler.", "author": "cbuescher", "createdAt": "2020-06-02T16:28:17Z", "path": "server/src/main/java/org/elasticsearch/search/SearchHit.java", "diffHunk": "@@ -449,17 +442,28 @@ public String getSourceAsString() {\n      * The hit field matching the given field name.\n      */\n     public DocumentField field(String fieldName) {\n-        return getFields().get(fieldName);\n+        DocumentField result = documentFields.get(fieldName);\n+        if (result != null) {\n+            return result;\n+        } else {\n+            return metaFields.get(fieldName);\n+        }\n+    }\n+\n+    public boolean isMetadataField(String fieldName) {\n+        return metaFields.containsKey(fieldName);\n     }\n \n     /*\n     * Adds a new DocumentField to the map in case both parameters are not null.\n     * */\n-    public void setField(String fieldName, DocumentField field) {\n+    public void setField(String fieldName, DocumentField field, boolean isMetaField) {\n         if (fieldName == null || field == null) return;\n-        if (field.isMetadataField()) {\n+        if (isMetaField) {\n+            if (metaFields.size() == 0) this.metaFields = new HashMap<>();", "originalCommit": "3de627247eed5e4fccd432ae4b1675848e39ae83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxMjkxNg==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r434012916", "bodyText": "same here, although it seems that docomentFields are less likely to contain sth. if I'm not mistaken? Still, I think just using a modifiable map here from the start makes things easier without much cost, wdyt?", "author": "cbuescher", "createdAt": "2020-06-02T16:29:07Z", "path": "server/src/main/java/org/elasticsearch/search/SearchHit.java", "diffHunk": "@@ -449,17 +442,28 @@ public String getSourceAsString() {\n      * The hit field matching the given field name.\n      */\n     public DocumentField field(String fieldName) {\n-        return getFields().get(fieldName);\n+        DocumentField result = documentFields.get(fieldName);\n+        if (result != null) {\n+            return result;\n+        } else {\n+            return metaFields.get(fieldName);\n+        }\n+    }\n+\n+    public boolean isMetadataField(String fieldName) {\n+        return metaFields.containsKey(fieldName);\n     }\n \n     /*\n     * Adds a new DocumentField to the map in case both parameters are not null.\n     * */\n-    public void setField(String fieldName, DocumentField field) {\n+    public void setField(String fieldName, DocumentField field, boolean isMetaField) {\n         if (fieldName == null || field == null) return;\n-        if (field.isMetadataField()) {\n+        if (isMetaField) {\n+            if (metaFields.size() == 0) this.metaFields = new HashMap<>();\n             this.metaFields.put(fieldName, field);\n         } else {\n+            if (documentFields.size() == 0) this.documentFields = new HashMap<>();", "originalCommit": "3de627247eed5e4fccd432ae4b1675848e39ae83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4OTg3MA==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r434789870", "bodyText": "docomentFields are less likely to contain sth.\n\nIndeed, in most cases, documentFields should be empty or give in Ctor.\nIf documentFields are absent, it is cheaper to reference EmptyMap for documentFields  than to create a new HashMap for every hit.  We only use setField if we request doc values, script or percolator fields, which is not a usual case.", "author": "mayya-sharipova", "createdAt": "2020-06-03T19:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxMjkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxMzUxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r434013515", "bodyText": "maybe use new HashMap() here or sth. similar, see below for question.", "author": "cbuescher", "createdAt": "2020-06-02T16:30:01Z", "path": "server/src/main/java/org/elasticsearch/search/SearchHit.java", "diffHunk": "@@ -137,15 +136,8 @@ public SearchHit(int nestedTopDocId, String id, NestedIdentity nestedIdentity,\n             this.id = null;\n         }\n         this.nestedIdentity = nestedIdentity;\n-        this.documentFields = documentFields;\n-        if (this.documentFields == null) {\n-            this.documentFields = new HashMap<>();\n-        }\n-\n-        this.metaFields = metaFields;\n-        if (this.metaFields == null) {\n-            this.metaFields = new HashMap<>();\n-        }\n+        this.documentFields = documentFields == null ? emptyMap() : documentFields;\n+        this.metaFields = metaFields == null ? emptyMap() : metaFields;", "originalCommit": "3de627247eed5e4fccd432ae4b1675848e39ae83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxNzQ3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r434017472", "bodyText": "I'd probably prefer it if we continue using null arguments and remove earlier declaration of maps (move it down to where they are needed?)", "author": "cbuescher", "createdAt": "2020-06-02T16:36:09Z", "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java", "diffHunk": "@@ -203,19 +203,20 @@ private SearchHit createSearchHit(SearchContext context,\n                                       int subDocId,\n                                       Map<String, Set<String>> storedToRequestedFields,\n                                       LeafReaderContext subReaderContext) {\n+        Map<String, DocumentField> docFields = emptyMap();\n+        Map<String, DocumentField> metaFields = emptyMap();\n         if (fieldsVisitor == null) {\n-            return new SearchHit(docId, null, null, null);\n-\n+            return new SearchHit(docId, null, docFields, metaFields);", "originalCommit": "3de627247eed5e4fccd432ae4b1675848e39ae83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxOTAzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r434019039", "bodyText": "I'd prefer modifiable maps right here and remove L261/262 instead. Just for readability", "author": "cbuescher", "createdAt": "2020-06-02T16:38:34Z", "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java", "diffHunk": "@@ -278,11 +251,17 @@ private SearchHit createNestedSearchHit(SearchContext context,\n             source = null;\n         }\n \n-        Map<String, DocumentField> searchFields = null;\n+        Map<String, DocumentField> docFields = emptyMap();", "originalCommit": "3de627247eed5e4fccd432ae4b1675848e39ae83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgwMjkzNg==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r434802936", "bodyText": "Indeed, readability will be improved with this suggestion. But I think it is more important not to create unnecessary HashMap object for every nested hit, that's why I set it to emptyMap(). I can also set it to null as it was before. What do you think?", "author": "mayya-sharipova", "createdAt": "2020-06-03T19:29:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxOTAzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAyMTI3OA==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r434021278", "bodyText": "I was under the impression docValues are put under \"documentFields\", not meta? Am I missing sth here? Maybe rephrase?", "author": "cbuescher", "createdAt": "2020-06-02T16:42:08Z", "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FetchDocValuesPhase.java", "diffHunk": "@@ -122,13 +121,11 @@ public void hitsExecute(SearchContext context, SearchHit[] hits) throws IOExcept\n                             binaryValues = data.getBytesValues();\n                         }\n                     }\n-                    if (hit.fieldsOrNull() == null) {\n-                        hit.fields(new HashMap<>(2));\n-                    }\n-                    DocumentField hitField = hit.getFields().get(field);\n+                    DocumentField hitField = hit.field(field);\n                     if (hitField == null) {\n                         hitField = new DocumentField(field, new ArrayList<>(2));\n-                        hit.setField(field, hitField);\n+                        // docValues field is put under \"fields\" even if they are meta-data fields", "originalCommit": "3de627247eed5e4fccd432ae4b1675848e39ae83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAyMzI3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r434023276", "bodyText": "Do you know why we exclude these random field types here? I don't remember atm, if you do (bc. you added some cases) maybe a comment would help my future me understanding this better.", "author": "cbuescher", "createdAt": "2020-06-02T16:45:25Z", "path": "server/src/test/java/org/elasticsearch/index/get/DocumentFieldTests.java", "diffHunk": "@@ -101,10 +104,16 @@ private static DocumentField mutateDocumentField(DocumentField documentField) {\n     }\n \n     public static Tuple<DocumentField, DocumentField> randomDocumentField(XContentType xContentType) {\n-        if (randomBoolean()) {\n+        return randomDocumentField(xContentType, randomBoolean());\n+    }\n+\n+    public static Tuple<DocumentField, DocumentField> randomDocumentField(XContentType xContentType, boolean isMetafield) {\n+        if (isMetafield) {\n             String metaField = randomValueOtherThanMany(field -> field.equals(TypeFieldMapper.NAME)\n-                    || field.equals(IndexFieldMapper.NAME) || field.equals(IdFieldMapper.NAME),\n-                () -> randomFrom(MapperService.getAllMetaFields()));\n+                    || field.equals(IndexFieldMapper.NAME) || field.equals(IdFieldMapper.NAME)", "originalCommit": "3de627247eed5e4fccd432ae4b1675848e39ae83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAzMzY3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r434033671", "bodyText": "Since this sticks out as odd, maybe extend the comment by briefly explaining the cases where we need this. As far as I understand this should only be the case when a pre-7.3 node uses the size mapper plugin and sends these fields jumbled with the other document fields, right?", "author": "cbuescher", "createdAt": "2020-06-02T17:02:05Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -640,14 +634,25 @@ public void close() throws IOException {\n     }\n \n     /**\n-     * @return Whether a field is a metadata field.\n+     * @return Whether a field is a metadata field for older indexes\n+     * TODO: remove in v 9.0\n+     * @deprecated  Use an instance method isMetadataField instead\n      */\n-    public static boolean isMetadataField(String fieldName) {\n-        return META_FIELDS.contains(fieldName);\n+    @Deprecated\n+    public static boolean isMetadataFieldStatic(String fieldName) {\n+        if (IndicesModule.getBuiltInMetadataFields().contains(fieldName)) {\n+            return true;\n+        }\n+        // adding _size field as meta-field for bwc", "originalCommit": "3de627247eed5e4fccd432ae4b1675848e39ae83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3a56fd20909d887dd8016fdceeb751ea3a89a131", "url": "https://github.com/elastic/elasticsearch/commit/3a56fd20909d887dd8016fdceeb751ea3a89a131", "message": "Address Christoph's feedback", "committedDate": "2020-06-03T21:58:52Z", "type": "commit"}, {"oid": "a5a6b3fa0a2916335332572af24fe32f42d87791", "url": "https://github.com/elastic/elasticsearch/commit/a5a6b3fa0a2916335332572af24fe32f42d87791", "message": "Merge remote-tracking branch 'upstream/master' into metafield-refactoring", "committedDate": "2020-06-04T14:49:41Z", "type": "commit"}, {"oid": "b6d3364c65387138406ce85f4b0c4f7dee1e9527", "url": "https://github.com/elastic/elasticsearch/commit/b6d3364c65387138406ce85f4b0c4f7dee1e9527", "message": "Correct AggregationsTests to exclude random fields from top_hits", "committedDate": "2020-06-04T16:01:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM4MTYwMw==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r435381603", "bodyText": "Great way to test!\nnit: could you add a very brief comment explaining why this proves the metadata field from the plugin was correctly registered? Makes it easier to later track why tests are there and what they check.", "author": "cbuescher", "createdAt": "2020-06-04T16:14:44Z", "path": "modules/mapper-extras/src/test/java/org/elasticsearch/index/mapper/RankFeatureMetaFieldMapperTests.java", "diffHunk": "@@ -55,4 +57,14 @@ public void testBasics() throws Exception {\n         assertEquals(mapping, mapper.mappingSource().toString());\n         assertNotNull(mapper.metadataMapper(RankFeatureMetaFieldMapper.class));\n     }\n+\n+    public void testDocumentParsingFailsOnMetaField() throws Exception {", "originalCommit": "3a56fd20909d887dd8016fdceeb751ea3a89a131", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUzNTk4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/57378#discussion_r435535987", "bodyText": "@cbuescher Thank you for the review.\nThe last comment addressed in ac6a4bc", "author": "mayya-sharipova", "createdAt": "2020-06-04T20:40:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM4MTYwMw=="}], "type": "inlineReview"}, {"oid": "ac6a4bc4b41731aa30551ce58a472c0bf8e35fdb", "url": "https://github.com/elastic/elasticsearch/commit/ac6a4bc4b41731aa30551ce58a472c0bf8e35fdb", "message": "Add comment to test: testDocumentParsingFailsOnMetaField", "committedDate": "2020-06-04T20:39:03Z", "type": "commit"}]}