{"pr_number": 50862, "pr_title": "Deprecate and remove camel-case nGram and edgeNGram tokenizers", "pr_createdAt": "2020-01-10T16:45:15Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50862", "timeline": [{"oid": "00d5965223a83607eb2e7c00d5aa8e97f1e4356b", "url": "https://github.com/elastic/elasticsearch/commit/00d5965223a83607eb2e7c00d5aa8e97f1e4356b", "message": "Deprecate and remove camel-case nGram and edgeNGram tokenizers\n\nWe already deprecated and removed the camel-case versions of the nGram and edgeNGram filters\na while ago and we should do the same with the nGram and edgeNGram tokenizers.\nThis PR deprecates the use of these names in favour of ngram and edge_ngram in 7\nand disallows usage in new indices starting with 8. The deprecation part will be\nbackported to 7.6.\n\nCloses #50561", "committedDate": "2020-01-10T16:40:59Z", "type": "commit"}, {"oid": "fdf34e3307ceb2273194e4548dfec33395223a11", "url": "https://github.com/elastic/elasticsearch/commit/fdf34e3307ceb2273194e4548dfec33395223a11", "message": "Adapt EdgeNGramTokenizerTests", "committedDate": "2020-01-10T17:16:17Z", "type": "commit"}, {"oid": "d3a1240dd21535d60c2ec055472e85aa75052240", "url": "https://github.com/elastic/elasticsearch/commit/d3a1240dd21535d60c2ec055472e85aa75052240", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix-50561", "committedDate": "2020-01-13T08:35:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA2MzA5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/50862#discussion_r366063099", "bodyText": "instead of Version.CURRENT should we put a specific version to make sure the test doesn't fail after v 8.0?", "author": "mayya-sharipova", "createdAt": "2020-01-13T22:28:23Z", "path": "modules/analysis-common/src/test/java/org/elasticsearch/analysis/common/EdgeNGramTokenizerTests.java", "diffHunk": "@@ -86,9 +86,11 @@ public void testPreConfiguredTokenizer() throws IOException {\n             }\n         }\n \n-        // Check deprecated name as well\n+        // Check deprecated name as well, needs version before 8.0 because throws IAE after that\n         {\n-            try (IndexAnalyzers indexAnalyzers = buildAnalyzers(Version.CURRENT, \"edgeNGram\")) {\n+            try (IndexAnalyzers indexAnalyzers = buildAnalyzers(\n+                    VersionUtils.randomVersionBetween(random(), Version.V_7_3_0, VersionUtils.getPreviousVersion(Version.CURRENT)),", "originalCommit": "d3a1240dd21535d60c2ec055472e85aa75052240", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "53e25dfbc966de0f8700ced7ea46f085d2af2c54", "url": "https://github.com/elastic/elasticsearch/commit/53e25dfbc966de0f8700ced7ea46f085d2af2c54", "message": "iter", "committedDate": "2020-01-14T09:06:13Z", "type": "commit"}, {"oid": "15321425c588473b3d938e54955e0508cc72e33b", "url": "https://github.com/elastic/elasticsearch/commit/15321425c588473b3d938e54955e0508cc72e33b", "message": "Merge branch 'master' into fix-50561", "committedDate": "2020-01-14T14:04:07Z", "type": "commit"}, {"oid": "bf9f8611c74ab4624d8caeadff17c8dffe432458", "url": "https://github.com/elastic/elasticsearch/commit/bf9f8611c74ab4624d8caeadff17c8dffe432458", "message": "iter", "committedDate": "2020-01-14T15:08:08Z", "type": "commit"}, {"oid": "1369e17cfe333fffb2db935549a9aa7455e69a7b", "url": "https://github.com/elastic/elasticsearch/commit/1369e17cfe333fffb2db935549a9aa7455e69a7b", "message": "Moving migration note from mappings -> analysis", "committedDate": "2020-01-14T15:28:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQwOTUxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/50862#discussion_r366409511", "bodyText": "You shouldn't need to pull a factory and call create to get warnings anymore, they will be emitted when createTestAnalysis is called.", "author": "romseygeek", "createdAt": "2020-01-14T15:38:14Z", "path": "modules/analysis-common/src/test/java/org/elasticsearch/analysis/common/CommonAnalysisPluginTests.java", "diffHunk": "@@ -102,4 +105,82 @@ public void testEdgeNGramFilterInCustomAnalyzerDeprecationError() throws IOExcep\n                     + \"Please change the filter name to [edge_ngram] instead.\");\n         }\n     }\n+\n+    /**\n+     * Check that we log a deprecation warning for \"nGram\" and \"edgeNGram\" tokenizer names with 7.6 and\n+     * disallow usages for indices created after 8.0\n+     */\n+    public void testNGramTokenizerDeprecation() throws IOException {\n+        // tests for prebuilt tokenizer\n+        doTestPrebuiltTokenizerDeprecation(\"nGram\", \"ngram\",\n+                VersionUtils.randomVersionBetween(random(), Version.V_7_0_0, Version.V_7_5_2), false);\n+        doTestPrebuiltTokenizerDeprecation(\"edgeNGram\", \"edge_ngram\",\n+                VersionUtils.randomVersionBetween(random(), Version.V_7_0_0, Version.V_7_5_2), false);\n+        doTestPrebuiltTokenizerDeprecation(\"nGram\", \"ngram\",\n+                VersionUtils.randomVersionBetween(random(), Version.V_7_6_0,\n+                        Version.max(Version.V_7_6_0, VersionUtils.getPreviousVersion(Version.V_8_0_0))),\n+                true);\n+        doTestPrebuiltTokenizerDeprecation(\"edgeNGram\", \"edge_ngram\",\n+                VersionUtils.randomVersionBetween(random(), Version.V_7_6_0,\n+                        Version.max(Version.V_7_6_0, VersionUtils.getPreviousVersion(Version.V_8_0_0))), true);\n+        expectThrows(IllegalArgumentException.class, () -> doTestPrebuiltTokenizerDeprecation(\"nGram\", \"ngram\",\n+                VersionUtils.randomVersionBetween(random(), Version.V_8_0_0, Version.CURRENT), true));\n+        expectThrows(IllegalArgumentException.class, () -> doTestPrebuiltTokenizerDeprecation(\"edgeNGram\", \"edge_ngram\",\n+                VersionUtils.randomVersionBetween(random(), Version.V_8_0_0, Version.CURRENT), true));\n+\n+        // same batch of tests for custom tokenizer definition in the settings\n+        doTestCustomTokenizerDeprecation(\"nGram\", \"ngram\",\n+                VersionUtils.randomVersionBetween(random(), Version.V_7_0_0, Version.V_7_5_2), false);\n+        doTestCustomTokenizerDeprecation(\"edgeNGram\", \"edge_ngram\",\n+                VersionUtils.randomVersionBetween(random(), Version.V_7_0_0, Version.V_7_5_2), false);\n+        doTestCustomTokenizerDeprecation(\"nGram\", \"ngram\",\n+                VersionUtils.randomVersionBetween(random(), Version.V_7_6_0,\n+                        Version.max(Version.V_7_6_0, VersionUtils.getPreviousVersion(Version.V_8_0_0))),\n+                true);\n+        doTestCustomTokenizerDeprecation(\"edgeNGram\", \"edge_ngram\",\n+                VersionUtils.randomVersionBetween(random(), Version.V_7_6_0,\n+                        Version.max(Version.V_7_6_0, VersionUtils.getPreviousVersion(Version.V_8_0_0))), true);\n+        expectThrows(IllegalArgumentException.class, () -> doTestCustomTokenizerDeprecation(\"nGram\", \"ngram\",\n+                VersionUtils.randomVersionBetween(random(), Version.V_8_0_0, Version.CURRENT), true));\n+        expectThrows(IllegalArgumentException.class, () -> doTestCustomTokenizerDeprecation(\"edgeNGram\", \"edge_ngram\",\n+                VersionUtils.randomVersionBetween(random(), Version.V_8_0_0, Version.CURRENT), true));\n+    }\n+\n+    public void doTestPrebuiltTokenizerDeprecation(String deprecatedName, String replacement, Version version, boolean expectWarning)\n+            throws IOException {\n+        final Settings settings = Settings.builder().put(Environment.PATH_HOME_SETTING.getKey(), createTempDir())\n+            .put(IndexMetaData.SETTING_VERSION_CREATED, version).build();\n+\n+        try (CommonAnalysisPlugin commonAnalysisPlugin = new CommonAnalysisPlugin()) {\n+            Map<String, TokenizerFactory> tokenizers = createTestAnalysis(\n+                    IndexSettingsModule.newIndexSettings(\"index\", settings), settings, commonAnalysisPlugin).tokenizer;\n+            TokenizerFactory tokenizerFactory = tokenizers.get(deprecatedName);", "originalCommit": "1369e17cfe333fffb2db935549a9aa7455e69a7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQxMzg3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/50862#discussion_r366413873", "bodyText": "This tests prebuild tokenizer directly though, e.g. when they are used via \u201c_analyze\u201d endpoint directly they wouldn\u2019t appear in analyzers. createTestAnalysis  doesn\u2019t trigger the warning in that case if nothing refers to them from analysis settings.", "author": "cbuescher", "createdAt": "2020-01-14T15:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQwOTUxMQ=="}], "type": "inlineReview"}]}