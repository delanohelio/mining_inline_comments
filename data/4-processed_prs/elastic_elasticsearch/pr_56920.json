{"pr_number": 56920, "pr_title": "[DOCS] Fix clarity of URL snapshot repo docs", "pr_createdAt": "2020-05-18T19:09:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56920", "timeline": [{"oid": "89523e4c692c0ce5fbbc04a5a9e3768c416aa591", "url": "https://github.com/elastic/elasticsearch/commit/89523e4c692c0ce5fbbc04a5a9e3768c416aa591", "message": "[DOCS] Fix clarity of URL snapshot repo docs\n\nMakes following changes to better clarify docs for read-only URL\nsnapshot repositories:\n\n* Adds an example snippet for registering a URL repository\n* Rewrites the protocols paragraph\n* Adds a note to explicitly point out that only URLs using the `ftp`,\n  `http`, `http`, and `jar` protocols do not need the `path.repo`\n  setting.\n\nFixes #16280", "committedDate": "2020-05-18T13:23:11Z", "type": "commit"}, {"oid": "72ce45e6e920d7210ca756cee18901f1d4dc0981", "url": "https://github.com/elastic/elasticsearch/commit/72ce45e6e920d7210ca756cee18901f1d4dc0981", "message": "fix tests", "committedDate": "2020-05-18T20:15:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2NDM0NA==", "url": "https://github.com/elastic/elasticsearch/pull/56920#discussion_r430764344", "bodyText": "This intro feels awkward & doesn't really explain why you would want to use a URL repository. Is the point that you can write snapshots to a shared file system repository, and then serve them up so they can be restored to nodes that don't have access to the shared filesystem?", "author": "debadair", "createdAt": "2020-05-26T23:36:44Z", "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "diffHunk": "@@ -153,22 +153,44 @@ unit, for example: `1GB`, `10MB`, `5KB`, `500B`. Defaults to `null` (unlimited c\n \n The URL repository (`\"type\": \"url\"`) can be used as an alternative read-only way to access data created by the shared file", "originalCommit": "72ce45e6e920d7210ca756cee18901f1d4dc0981", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE1NjQ5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/56920#discussion_r431156496", "bodyText": "Added some more context with aa2b76a.\nI don't think the primary issue is access but safety. A read-only shared file system could be accidentally switched to write, which could lead to corrupting snapshots if multiple clusters write to the same repository.", "author": "jrodewig", "createdAt": "2020-05-27T14:03:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2NDM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2NTExNQ==", "url": "https://github.com/elastic/elasticsearch/pull/56920#discussion_r430765115", "bodyText": "This is consistent with the other examples, but I think the naming adds to the confusion. You see put...backup, when you're not putting a backup, you're specifying a backup location.", "author": "debadair", "createdAt": "2020-05-26T23:39:19Z", "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "diffHunk": "@@ -153,22 +153,44 @@ unit, for example: `1GB`, `10MB`, `5KB`, `500B`. Defaults to `null` (unlimited c\n \n The URL repository (`\"type\": \"url\"`) can be used as an alternative read-only way to access data created by the shared file\n system repository. The URL specified in the `url` parameter should point to the root of the shared filesystem repository.\n-The following settings are supported:\n \n-[horizontal]\n-`url`:: Location of the snapshots. Mandatory.\n+[source,console]\n+----\n+PUT /_snapshot/my_read_only_url_backup", "originalCommit": "72ce45e6e920d7210ca756cee18901f1d4dc0981", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE1NjkwOA==", "url": "https://github.com/elastic/elasticsearch/pull/56920#discussion_r431156908", "bodyText": "Updated with 1866a79.", "author": "jrodewig", "createdAt": "2020-05-27T14:03:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2NTExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2NjEzNw==", "url": "https://github.com/elastic/elasticsearch/pull/56920#discussion_r430766137", "bodyText": "It's not clear to me what the advantage is of using the file protocol over just using the filesystem repo directly. Is just because it is read only?", "author": "debadair", "createdAt": "2020-05-26T23:42:39Z", "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "diffHunk": "@@ -153,22 +153,44 @@ unit, for example: `1GB`, `10MB`, `5KB`, `500B`. Defaults to `null` (unlimited c\n \n The URL repository (`\"type\": \"url\"`) can be used as an alternative read-only way to access data created by the shared file\n system repository. The URL specified in the `url` parameter should point to the root of the shared filesystem repository.\n-The following settings are supported:\n \n-[horizontal]\n-`url`:: Location of the snapshots. Mandatory.\n+[source,console]\n+----\n+PUT /_snapshot/my_read_only_url_backup\n+{\n+  \"type\": \"url\",\n+  \"settings\": {\n+    \"url\": \"file:/mount/backups/my_fs_backup_location\"\n+  }\n+}\n+----\n+// TEST[skip:no access to url file path]\n \n-URL Repository supports the following protocols: \"http\", \"https\", \"ftp\", \"file\" and \"jar\". URL repositories with `http:`,\n-`https:`, and `ftp:` URLs has to be whitelisted by specifying allowed URLs in the `repositories.url.allowed_urls` setting.\n-This setting supports wildcards in the place of host, path, query, and fragment. For example:\n+\n+The `url` parameter supports the following protocols:\n+\n+* `file`\n+* `ftp`\n+* `http`\n+* `https`\n+* `jar`\n+\n+URLs using the `file` protocol must point to the location of a shared filesystem", "originalCommit": "72ce45e6e920d7210ca756cee18901f1d4dc0981", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE1NzMwMw==", "url": "https://github.com/elastic/elasticsearch/pull/56920#discussion_r431157303", "bodyText": "Yes. It being read-only is a safety feature. Updated with aa2b76a.", "author": "jrodewig", "createdAt": "2020-05-27T14:04:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2NjEzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2NzEzMg==", "url": "https://github.com/elastic/elasticsearch/pull/56920#discussion_r430767132", "bodyText": "Do not need to be, or should not be?", "author": "debadair", "createdAt": "2020-05-26T23:45:55Z", "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "diffHunk": "@@ -153,22 +153,44 @@ unit, for example: `1GB`, `10MB`, `5KB`, `500B`. Defaults to `null` (unlimited c\n \n The URL repository (`\"type\": \"url\"`) can be used as an alternative read-only way to access data created by the shared file\n system repository. The URL specified in the `url` parameter should point to the root of the shared filesystem repository.\n-The following settings are supported:\n \n-[horizontal]\n-`url`:: Location of the snapshots. Mandatory.\n+[source,console]\n+----\n+PUT /_snapshot/my_read_only_url_backup\n+{\n+  \"type\": \"url\",\n+  \"settings\": {\n+    \"url\": \"file:/mount/backups/my_fs_backup_location\"\n+  }\n+}\n+----\n+// TEST[skip:no access to url file path]\n \n-URL Repository supports the following protocols: \"http\", \"https\", \"ftp\", \"file\" and \"jar\". URL repositories with `http:`,\n-`https:`, and `ftp:` URLs has to be whitelisted by specifying allowed URLs in the `repositories.url.allowed_urls` setting.\n-This setting supports wildcards in the place of host, path, query, and fragment. For example:\n+\n+The `url` parameter supports the following protocols:\n+\n+* `file`\n+* `ftp`\n+* `http`\n+* `https`\n+* `jar`\n+\n+URLs using the `file` protocol must point to the location of a shared filesystem\n+accessible to all master and data nodes in the cluster. This location must be\n+registered in the `path.repo` setting, similar to a\n+<<snapshots-filesystem-repository,shared file system repository>>.\n+\n+URLs using the `ftp`, `http`, or `https` protocols must be whitelisted in the\n+`repositories.url.allowed_urls` setting. This setting supports wildcards (`*`)\n+in place of a host, path, query, or fragment in the URL. For example:\n \n [source,yaml]\n------------------------------------\n+----\n repositories.url.allowed_urls: [\"http://www.example.org/root/*\", \"https://*.mydomain.com/*?*#*\"]\n------------------------------------\n+----\n \n-URL repositories with `file:` URLs can only point to locations registered in the `path.repo` setting similar to\n-shared file system repository.\n+NOTE: URLs using the `ftp`, `http`, `https`, or `jar` protocols do not need to", "originalCommit": "72ce45e6e920d7210ca756cee18901f1d4dc0981", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE1ODYxMA==", "url": "https://github.com/elastic/elasticsearch/pull/56920#discussion_r431158610", "bodyText": "Gonna leave this as-is. There is no real harm in registering them but it's not necessary.", "author": "jrodewig", "createdAt": "2020-05-27T14:05:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2NzEzMg=="}], "type": "inlineReview"}, {"oid": "aa2b76ad0b922d370771ae0977ec4e6478765877", "url": "https://github.com/elastic/elasticsearch/commit/aa2b76ad0b922d370771ae0977ec4e6478765877", "message": "Add intro context", "committedDate": "2020-05-27T14:01:53Z", "type": "commit"}, {"oid": "1866a79cf2ff470a945c47f56228930add302074", "url": "https://github.com/elastic/elasticsearch/commit/1866a79cf2ff470a945c47f56228930add302074", "message": "rename url repo", "committedDate": "2020-05-27T14:03:27Z", "type": "commit"}, {"oid": "3984fd9419566fb5adededeb72dbcffa1c835adb", "url": "https://github.com/elastic/elasticsearch/commit/3984fd9419566fb5adededeb72dbcffa1c835adb", "message": "tweak", "committedDate": "2020-05-27T14:15:08Z", "type": "commit"}]}