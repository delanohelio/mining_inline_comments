{"pr_number": 53166, "pr_title": "Check for query cancellation during rewrite", "pr_createdAt": "2020-03-05T13:55:23Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53166", "timeline": [{"oid": "f0d778f97ca26b51c2759c153e804eef5a7a78bd", "url": "https://github.com/elastic/elasticsearch/commit/f0d778f97ca26b51c2759c153e804eef5a7a78bd", "message": "Check for query cancellation during rewrite\n\nWith ExitableDirectoryReader in place, check for query cancellation\nduring QueryPhase#preProcess where the query rewriting takes place.\n\nFollows: #52822", "committedDate": "2020-03-05T14:02:04Z", "type": "commit"}, {"oid": "f0d778f97ca26b51c2759c153e804eef5a7a78bd", "url": "https://github.com/elastic/elasticsearch/commit/f0d778f97ca26b51c2759c153e804eef5a7a78bd", "message": "Check for query cancellation during rewrite\n\nWith ExitableDirectoryReader in place, check for query cancellation\nduring QueryPhase#preProcess where the query rewriting takes place.\n\nFollows: #52822", "committedDate": "2020-03-05T14:02:04Z", "type": "forcePushed"}, {"oid": "3d7076988955d34bc99a0a30df669c034a9214bf", "url": "https://github.com/elastic/elasticsearch/commit/3d7076988955d34bc99a0a30df669c034a9214bf", "message": "fix checktyle", "committedDate": "2020-03-05T14:21:45Z", "type": "commit"}, {"oid": "301f0c21ed3b0f0bf2d107e22e05becfa32ddddd", "url": "https://github.com/elastic/elasticsearch/commit/301f0c21ed3b0f0bf2d107e22e05becfa32ddddd", "message": "use try-with-resources for reader", "committedDate": "2020-03-05T17:21:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2MjIzNA==", "url": "https://github.com/elastic/elasticsearch/pull/53166#discussion_r388562234", "bodyText": "I think it's safe to ignore this parameter. Let's leave it for now but I wonder if we should simply remove this setting in a follow up. @jpountz what do you think ? I can open an issue if you think this deserves a full discussion.", "author": "jimczi", "createdAt": "2020-03-05T20:59:15Z", "path": "server/src/main/java/org/elasticsearch/search/query/QueryPhase.java", "diffHunk": "@@ -110,7 +109,23 @@ public QueryPhase() {\n \n     @Override\n     public void preProcess(SearchContext context) {\n-        context.preProcess(true);\n+        final Runnable cancellation;\n+        if (context.lowLevelCancellation()) {", "originalCommit": "301f0c21ed3b0f0bf2d107e22e05becfa32ddddd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3NjA4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53166#discussion_r388776085", "bodyText": "In the long term, I agree that we should remove it. The thing that isn't clear to me is how much it hurts terms-dict-intensive queries like fuzzy queries.", "author": "jpountz", "createdAt": "2020-03-06T08:45:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2MjIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2Njc5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53166#discussion_r388566797", "bodyText": "let's get the task once outside of the runnable like we do below ?", "author": "jimczi", "createdAt": "2020-03-05T21:09:21Z", "path": "server/src/main/java/org/elasticsearch/search/query/QueryPhase.java", "diffHunk": "@@ -110,7 +109,23 @@ public QueryPhase() {\n \n     @Override\n     public void preProcess(SearchContext context) {\n-        context.preProcess(true);\n+        final Runnable cancellation;\n+        if (context.lowLevelCancellation()) {\n+            cancellation = context.searcher().addQueryCancellation(() -> {\n+                if (context.getTask().isCancelled()) {", "originalCommit": "301f0c21ed3b0f0bf2d107e22e05becfa32ddddd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2NzM5MA==", "url": "https://github.com/elastic/elasticsearch/pull/53166#discussion_r388567390", "bodyText": "I have a slight preference for this version. The task should never change during the execution of a search request.", "author": "jimczi", "createdAt": "2020-03-05T21:10:32Z", "path": "server/src/main/java/org/elasticsearch/search/query/QueryPhase.java", "diffHunk": "@@ -265,9 +280,8 @@ static boolean executeInternal(SearchContext searchContext) throws QueryPhaseExe\n             }\n \n             if (searchContext.lowLevelCancellation()) {\n-                SearchShardTask task = searchContext.getTask();", "originalCommit": "301f0c21ed3b0f0bf2d107e22e05becfa32ddddd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8615408cd9a4a5e5aa4626e02826fc35ed48666f", "url": "https://github.com/elastic/elasticsearch/commit/8615408cd9a4a5e5aa4626e02826fc35ed48666f", "message": "address comments", "committedDate": "2020-03-05T21:41:46Z", "type": "commit"}, {"oid": "125330104b413665e5bb3a1dbde749a7751bbabc", "url": "https://github.com/elastic/elasticsearch/commit/125330104b413665e5bb3a1dbde749a7751bbabc", "message": "move task out of the runnable", "committedDate": "2020-03-05T22:05:17Z", "type": "commit"}]}