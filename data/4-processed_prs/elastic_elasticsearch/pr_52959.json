{"pr_number": 52959, "pr_title": "[ML] Fixing datafeed bwc tests", "pr_createdAt": "2020-02-28T16:11:57Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52959", "timeline": [{"oid": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e", "url": "https://github.com/elastic/elasticsearch/commit/b917e415b6537b21cea71b5ec7d0bf8dcf98a96e", "message": "[ML] Fixing datafeed bwc tests", "committedDate": "2020-02-28T16:06:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4Njc5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r385786797", "bodyText": "@nik9000 Since you wrote the original logic, thought I would ping you.\nThis allows for the same warning to be mentioned multiple times in the headers. This is required for ML since there are times when a warning appears more than once.\nThe number of times a warning appears is non-deterministic in multi-node tests.\nThis is because for ML we occasionally need to route to specific nodes (e.g. to a master node) and warnings can appear on parsing XContent and on serializing between nodes.", "author": "benwtrent", "createdAt": "2020-02-28T16:16:36Z", "path": "test/framework/src/main/java/org/elasticsearch/test/rest/yaml/section/DoSection.java", "diffHunk": "@@ -307,16 +310,20 @@ void checkWarningHeaders(final List<String> warningHeaders, final Version master\n                      * We skip warnings related to types deprecation and transform rename so that we can continue to run the many\n                      * mixed-version tests that used typed APIs.\n                      */\n-                } else if (expected.remove(message) == false) {\n+                } else if (expected.contains(message) == false) {", "originalCommit": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4OTc5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r385789796", "bodyText": "Also, this PR is against 7.x. If approved and merged, I am going to forward-port this change.", "author": "benwtrent", "createdAt": "2020-02-28T16:22:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4Njc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcyNDk2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r387724962", "bodyText": "I'm weary to change this behavior, though I admit the error message that you get with duplicate warning ain't great. I think for the most part we want to assert that you get exactly the warnings that you specify back. Emitting duplicate warnings feels a little like a bug to me.", "author": "nik9000", "createdAt": "2020-03-04T15:04:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4Njc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc4NjIzNg==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r387786236", "bodyText": "@nik9000 the issue is because the warning is added via different nodes. One is when the object is deserialized via XContent. The other is when it is streamed across to another node:\nWARNING: request [PUT http://[::1]:59141/_ml/datafeeds/mixed-cluster-datafeed-with-aggs?error_trace=true] returned 2 warnings:\n[299 Elasticsearch-7.4.0-22e1767283e61a198cb4db791ea66e3f11ab9910 \"[interval] on [date_histogram] is deprecated, use [fixed_interval] or [calendar_interval] in the future.\"],\n[299 Elasticsearch-7.7.0-SNAPSHOT-ea4c2ef5cb553bcf5fff8226c0878411fa9b6a2e \"[interval] on [date_histogram] is deprecated, use [fixed_interval] or [calendar_interval] in the future.\"]\n\nI am not sure how to prevent this as they are different thread contexts altogether.", "author": "benwtrent", "createdAt": "2020-03-04T16:32:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4Njc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc4ODk5OA==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r387788998", "bodyText": "\ud83d\udc4d I filed #53123. I'll see about making an \"allowed warnings\".", "author": "nik9000", "createdAt": "2020-03-04T16:36:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4Njc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NzQwNA==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r385787404", "bodyText": "This is frustrating, but I cannot think of a way to \"sometimes\" expected a warning header. We just don't know if the call would hit an old node, a new node, or is serialized between the two.", "author": "benwtrent", "createdAt": "2020-02-28T16:17:44Z", "path": "x-pack/qa/rolling-upgrade/build.gradle", "diffHunk": "@@ -137,7 +137,10 @@ for (Version bwcVersion : bwcVersions.wireCompatible) {\n     if (bwcVersion.before('7.4.0')) {\n       toBlackList.addAll([\n         'mixed_cluster/80_transform_jobs_crud/Test GET, start, and stop old cluster batch transforms',\n-        'mixed_cluster/80_transform_jobs_crud/Test GET, stop, start, old continuous transforms'\n+        'mixed_cluster/80_transform_jobs_crud/Test GET, stop, start, old continuous transforms',\n+        //Cannot determine if we will throw a warning on get as we might hit an old node\n+        //Cannot determine if we will have a warning on get _stats as we might hit an old node\n+        'mixed_cluster/40_ml_datafeed_crud/Test old cluster datafeed with aggs'", "originalCommit": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc5NDkxMw==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r385794913", "bodyText": "I agree.  This is not great.\nBecause the tests are being so picky about non-fatal warnings we cannot test the functionality at all which means we might ship a fatal error.\nIt seems that the framework needs a \"tolerate this warning but don't require it\" option.  Then we could test that doing a minor version upgrade of a cluster that is using deprecated functionality works.", "author": "droberts195", "createdAt": "2020-02-28T16:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NzQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcyNTI2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r387725267", "bodyText": "I think it'd be useful to have \"allowed warnings\" as a thing.", "author": "nik9000", "createdAt": "2020-03-04T15:05:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NzQwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4Nzg1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r385787857", "bodyText": "Again, it is possible here that the PUT does not hit a new node at all and no deprecation warning is returned :(", "author": "benwtrent", "createdAt": "2020-02-28T16:18:29Z", "path": "x-pack/qa/rolling-upgrade/build.gradle", "diffHunk": "@@ -160,9 +163,17 @@ for (Version bwcVersion : bwcVersions.wireCompatible) {\n         'mixed_cluster/80_transform_jobs_crud/Test put batch transform on mixed cluster',\n         'mixed_cluster/80_transform_jobs_crud/Test GET, start, and stop old cluster batch transforms',\n         'mixed_cluster/80_transform_jobs_crud/Test put continuous transform on mixed cluster',\n-        'mixed_cluster/80_transform_jobs_crud/Test GET, stop, start, old continuous transforms'\n+        'mixed_cluster/80_transform_jobs_crud/Test GET, stop, start, old continuous transforms',\n+        //Cannot determine if we will throw a warning on get as we might hit an old node\n+        //Cannot determine if we will have a warning on get _stats as we might hit an old node\n+        'mixed_cluster/40_ml_datafeed_crud/Test old cluster datafeed with aggs'\n       ])\n     }\n+    // Skip putting aggs if we have a mixed cluster were certain nodes will return a deprecation warning\n+    // and others will not.\n+    if (bwcVersion.before('7.2.0')) {\n+      toBlackList << 'mixed_cluster/40_ml_datafeed_crud/Put job and datafeed with aggs in mixed cluster'", "originalCommit": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4ODY1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r385788652", "bodyText": "This is so we at least have mixed cluster coverage on versions > 7.2.0.\nI could add this back, but then we would lose mixed cluster coverage for aggs for clusters containing nodes < 7.4.0", "author": "benwtrent", "createdAt": "2020-02-28T16:20:04Z", "path": "x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/mixed_cluster/40_ml_datafeed_crud.yml", "diffHunk": "@@ -151,9 +148,3 @@ setup:\n               }\n             }\n           }\n-\n-  - do:", "originalCommit": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4OTU0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r385789541", "bodyText": "I am going to forward-port this split if we merge this pr.", "author": "benwtrent", "createdAt": "2020-02-28T16:21:38Z", "path": "x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/upgraded_cluster/40_ml_datafeed_crud.yml", "diffHunk": "@@ -183,6 +166,45 @@ setup:\n         job_id: old-cluster-datafeed-job-with-aggs\n   - match: { acknowledged: true }\n \n+  - do:\n+      indices.delete:\n+        index: airline-data\n+\n+---\n+\"Test mixed cluster datafeeds with aggs\":", "originalCommit": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ea4c2ef5cb553bcf5fff8226c0878411fa9b6a2e", "url": "https://github.com/elastic/elasticsearch/commit/ea4c2ef5cb553bcf5fff8226c0878411fa9b6a2e", "message": "removing unused import", "committedDate": "2020-02-28T16:22:58Z", "type": "commit"}, {"oid": "b9962f8b520d2601daf28d66669ca747ff8c9e66", "url": "https://github.com/elastic/elasticsearch/commit/b9962f8b520d2601daf28d66669ca747ff8c9e66", "message": "reverting some changes", "committedDate": "2020-03-06T13:52:47Z", "type": "commit"}, {"oid": "8435d58a6b3bfe03becbdf699e52d48cc0d8d00e", "url": "https://github.com/elastic/elasticsearch/commit/8435d58a6b3bfe03becbdf699e52d48cc0d8d00e", "message": "Merge remote-tracking branch 'upstream/7.x' into tests/datafeed-bwc-tests", "committedDate": "2020-03-06T13:52:53Z", "type": "commit"}, {"oid": "44f43aefd468a45902bb85f9c3a0644adf68eba8", "url": "https://github.com/elastic/elasticsearch/commit/44f43aefd468a45902bb85f9c3a0644adf68eba8", "message": "using new allowed_warnings setting", "committedDate": "2020-03-06T14:00:33Z", "type": "commit"}, {"oid": "94007a5c2c2e0405cbfa4b279cd317a94c3db319", "url": "https://github.com/elastic/elasticsearch/commit/94007a5c2c2e0405cbfa4b279cd317a94c3db319", "message": "reverting needless changes", "committedDate": "2020-03-06T14:09:01Z", "type": "commit"}, {"oid": "c0bc3369b86e5e376762e714dc36447ad52d6638", "url": "https://github.com/elastic/elasticsearch/commit/c0bc3369b86e5e376762e714dc36447ad52d6638", "message": "allowing warnings in updated cluster tests", "committedDate": "2020-03-06T14:25:27Z", "type": "commit"}]}