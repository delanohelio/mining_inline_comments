{"pr_number": 65464, "pr_title": "Gracefully handle exceptions from Security Providers", "pr_createdAt": "2020-11-24T20:07:24Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65464", "timeline": [{"oid": "12e14574750a2bfbb77ce59799dde36a40b2822b", "url": "https://github.com/elastic/elasticsearch/commit/12e14574750a2bfbb77ce59799dde36a40b2822b", "message": "Gracefully handle exceptions from Security Providers\n\nIn certain situtations, such as when configured in FIPS 140 mode,\nthe Java security provider in use might throw a subclass of\njava.lang.Error. We currently do not catch these and as a result\nthe JVM exits, shutting down elasticsearch.\n\nThis commit attempts to address this by catching AssertionErrors\nthat we are aware that might be thrown when a PBKDF2 implementation\nis used from a Security Provider in FIPS 140 mode, with the password\ninput being less than 14 bytes (112 bits).\n\n- In our PBKDF2 family of hashers, we catch the AssertionError and\nthrow an ElasticsearchException while creating or verifying the\nhash. We throw on verification instead of simply returning false\non purpose so that the message bubbles up and the cause becomes\nobvious (otherwise it would be indistinguishable from a wrong\npassword).\n- In KeyStoreWrapper, we catch the AssertionError in order to\nwrap and rethrow with a helpful message. This can happen when using\nany of the keystore CLI commands, when the node starts or when we attempt\nto reload secure settings.\n- In the `elasticsearch-users` tool, we catch the AssertionError and\nthrow an appropriate UserException.", "committedDate": "2020-11-24T19:52:33Z", "type": "commit"}, {"oid": "54e88965ddb4b09198aed49de76f6eab31da76d2", "url": "https://github.com/elastic/elasticsearch/commit/54e88965ddb4b09198aed49de76f6eab31da76d2", "message": "remove unused import and add space", "committedDate": "2020-11-24T20:08:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0NzQ3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r529847471", "bodyText": "Because GeneralSecurityException can be thrown now too", "author": "jkakavas", "createdAt": "2020-11-24T20:07:53Z", "path": "distribution/tools/keystore-cli/src/main/java/org/elasticsearch/common/settings/BaseKeyStoreCommand.java", "diffHunk": "@@ -68,7 +68,7 @@ protected final void execute(Terminal terminal, OptionSet options, Environment e\n                 keyStore.decrypt(keyStorePassword.getChars());\n             }\n             executeCommand(terminal, options, env);\n-        } catch (SecurityException e) {\n+        } catch (Exception e) {", "originalCommit": "12e14574750a2bfbb77ce59799dde36a40b2822b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0NzUyMA==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r529847520", "bodyText": "Because GeneralSecurityException can be thrown now too", "author": "jkakavas", "createdAt": "2020-11-24T20:07:59Z", "path": "server/src/main/java/org/elasticsearch/cli/KeyStoreAwareCommand.java", "diffHunk": "@@ -75,7 +75,7 @@ protected static void decryptKeyStore(KeyStoreWrapper keyStore, Terminal termina\n         try (SecureString keystorePassword = keyStore.hasPassword() ?\n             readPassword(terminal, false) : new SecureString(new char[0])) {\n             keyStore.decrypt(keystorePassword.getChars());\n-        } catch (SecurityException e) {\n+        } catch (Exception e) {", "originalCommit": "12e14574750a2bfbb77ce59799dde36a40b2822b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI3ODMzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530278331", "bodyText": "Nit: why not catch (SecurityException | GeneralSecurityException e) as above?\nAlso KeyStoreWrapper#decrypt is declared to throw GeneralSecurityException as well. It wasn't a problem before or maybe it was just an oversight?", "author": "ywangd", "createdAt": "2020-11-25T10:48:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0NzUyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI5NjcxNA==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530296714", "bodyText": "Yeah I missed that when I changed it in BaseKeyStoreCommand. readPassword throws a UserException and we don't want to catch it here either.\n\nAlso KeyStoreWrapper#decrypt is declared to throw GeneralSecurityException as well. It wasn't a problem before or maybe it was just an oversight?\n\nI think it was an oversight but it wasn't such an issue because the CLI would just exit throwing the exception. It wasn't as user friendly as a UserException with an error message but it wasn't too problematic to be noticed or reported, I'd guess", "author": "jkakavas", "createdAt": "2020-11-25T11:17:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0NzUyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0OTAwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r529849009", "bodyText": "My thinking is that we should scope this tightly first and expand if/when we get reports/CI failures for additional errors. The ones we know are thrown are all AssertionError and catching all Error felt too wide of a net. Not holding a strong opinion on this, happy to discuss", "author": "jkakavas", "createdAt": "2020-11-24T20:10:58Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/support/Hasher.java", "diffHunk": "@@ -512,6 +512,8 @@ public static boolean verifyHash(SecureString data, char[] hash) {\n             PBEKeySpec keySpec = new PBEKeySpec(data.getChars(), salt, cost, PBKDF2_KEY_LENGTH);\n             result.put(Base64.getEncoder().encodeToString(secretKeyFactory.generateSecret(keySpec).getEncoded()));\n             return result.array();\n+        } catch (AssertionError ae){", "originalCommit": "12e14574750a2bfbb77ce59799dde36a40b2822b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMwMDMxMA==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530300310", "bodyText": "Somehow missed this comment in the previous pass ... I see you already considered it. I suggest a wider net (even wider then Error) because 1) any future fix to this would require a release which is purely overhead; 2) I cannot think of a valid reason for ES to shutdown here due to any kinda of error. So wider net (at least Error) should provide mostly benefit.", "author": "ywangd", "createdAt": "2020-11-25T11:23:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0OTAwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMwODMzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530308339", "bodyText": "Thanks for the comment Yang. I see your points. I'll let Lyudmila weigh in too and we can reach a consensus", "author": "jkakavas", "createdAt": "2020-11-25T11:37:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0OTAwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQzNTA3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530435072", "bodyText": "I would leave an ability to throw and shutdown for when something unthinkable happens. Catching Error should be ok though", "author": "BigPandaToo", "createdAt": "2020-11-25T14:57:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0OTAwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0OTQ2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r529849467", "bodyText": "Throw instead of returning false so that this is distinguishable from wrong password, which i believe is desired.", "author": "jkakavas", "createdAt": "2020-11-24T20:11:55Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/support/Hasher.java", "diffHunk": "@@ -538,6 +540,8 @@ private static boolean verifyPbkdf2Hash(SecureString data, char[] hash) {\n                 .encode(secretKeyFactory.generateSecret(keySpec).getEncoded()));\n             final boolean result = CharArrays.constantTimeEquals(computedPwdHash, hashChars);\n             return result;\n+        } catch (AssertionError ae) {\n+            throw new ElasticsearchException(\"Can't use PBKDF2 implementation from the Security Provider in use.\", ae);", "originalCommit": "12e14574750a2bfbb77ce59799dde36a40b2822b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI4OTQ3MA==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530289470", "bodyText": "Nit: I cannot help trying to make this error message read more like the others. So how about \"Error in using PBKDF2 implementation from the chosen Security Provider\". Also this string has an extra period at the end while the above one does not :)", "author": "ywangd", "createdAt": "2020-11-25T11:05:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0OTQ2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMwMjY2MA==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530302660", "bodyText": "Sure, why not! I'll change the one below while we're at it", "author": "jkakavas", "createdAt": "2020-11-25T11:27:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0OTQ2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMwMzE4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530303185", "bodyText": "I like Error using PBKDF2 implementation from the selected Security Provider slightly more if you don't mind :)", "author": "jkakavas", "createdAt": "2020-11-25T11:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0OTQ2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxNTYxMA==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530315610", "bodyText": "Sure. My comment on this was really my OCD.", "author": "ywangd", "createdAt": "2020-11-25T11:50:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0OTQ2Nw=="}], "type": "inlineReview"}, {"oid": "b0d3207f69fd3598f1ccc7c96088059dca731536", "url": "https://github.com/elastic/elasticsearch/commit/b0d3207f69fd3598f1ccc7c96088059dca731536", "message": "We don't want to catch UserExceptions", "committedDate": "2020-11-24T20:48:53Z", "type": "commit"}, {"oid": "cf3cdc5f7afde6008e33f61a455f4c9b2cbe276f", "url": "https://github.com/elastic/elasticsearch/commit/cf3cdc5f7afde6008e33f61a455f4c9b2cbe276f", "message": "Merge remote-tracking branch 'origin/master' into fips-exception-handling", "committedDate": "2020-11-24T21:11:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI4MTA0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530281046", "bodyText": "I wonder whether we could just be very liberal and catch a Throwable here. So we are sure nothing is going to trip it regardless of the provider.", "author": "ywangd", "createdAt": "2020-11-25T10:52:37Z", "path": "server/src/main/java/org/elasticsearch/common/settings/KeyStoreWrapper.java", "diffHunk": "@@ -310,7 +310,12 @@ public boolean hasPassword() {\n     private Cipher createCipher(int opmode, char[] password, byte[] salt, byte[] iv) throws GeneralSecurityException {\n         PBEKeySpec keySpec = new PBEKeySpec(password, salt, KDF_ITERS, CIPHER_KEY_BITS);\n         SecretKeyFactory keyFactory = SecretKeyFactory.getInstance(KDF_ALGO);\n-        SecretKey secretKey = keyFactory.generateSecret(keySpec);\n+        SecretKey secretKey;\n+        try {\n+            secretKey = keyFactory.generateSecret(keySpec);\n+        } catch (AssertionError ae) {", "originalCommit": "cf3cdc5f7afde6008e33f61a455f4c9b2cbe276f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI5OTI2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530299269", "bodyText": "I went back and forth as to how wide the net should be. My counter argument is that when something throws an Error instead of an Exception it supposedly denotes an irrecoverable error. We know that this is not true for the AssertionError that BCFIPS throws here, but can we be certain that we want to catch all Throwables that can be thrown from external code. We don't do that in any other place. WDYT ?", "author": "jkakavas", "createdAt": "2020-11-25T11:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI4MTA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3OTMzNw==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530379337", "bodyText": "+1 to leave it this way, we shoudn't catch potentially irrecoverable exceptions", "author": "BigPandaToo", "createdAt": "2020-11-25T13:37:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI4MTA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgzODgwNw==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530838807", "bodyText": "You got me thinking again @ywangd .. On the one hand, I tried to limit the scope of these try-catch blocks to a min so it makes sense that we would catch all irrecoverable errors from that line and give out an error message. On the other hand, the very limited scope makes it less possible that a wider net would catch issues thrown by other security providers that we know nothing of (other than the PBKDF2 112 bits limitation). I'm a bit torn on this one", "author": "jkakavas", "createdAt": "2020-11-26T08:09:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI4MTA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2MjEyMw==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530962123", "bodyText": "Had a short chat with Yang and we decided that catching Error is the way to go based on the arguments that have been made already in this PR", "author": "jkakavas", "createdAt": "2020-11-26T11:26:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI4MTA0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI4NzAzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530287039", "bodyText": "We throw ElasticsearchException in other places while throwing GeneralSecurityException here. Do we want to be consistent?\nNit: extra space (and the period?) at the end of the error message string :)", "author": "ywangd", "createdAt": "2020-11-25T11:02:04Z", "path": "server/src/main/java/org/elasticsearch/common/settings/KeyStoreWrapper.java", "diffHunk": "@@ -310,7 +310,12 @@ public boolean hasPassword() {\n     private Cipher createCipher(int opmode, char[] password, byte[] salt, byte[] iv) throws GeneralSecurityException {\n         PBEKeySpec keySpec = new PBEKeySpec(password, salt, KDF_ITERS, CIPHER_KEY_BITS);\n         SecretKeyFactory keyFactory = SecretKeyFactory.getInstance(KDF_ALGO);\n-        SecretKey secretKey = keyFactory.generateSecret(keySpec);\n+        SecretKey secretKey;\n+        try {\n+            secretKey = keyFactory.generateSecret(keySpec);\n+        } catch (AssertionError ae) {\n+            throw new GeneralSecurityException(\"Error generating an encryption key from the provided password. \", ae);", "originalCommit": "cf3cdc5f7afde6008e33f61a455f4c9b2cbe276f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMwMTA1OA==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530301058", "bodyText": "We throw ElasticsearchException in other places while throwing GeneralSecurityException here. Do we want to be consistent?\n\nWe don't have consistency over this. I don't know if it should. Choice might seem arbitrary but I did put some thought in it.  I went with a GeneralSecurityException in the KeyStoreWrapper since it is an exception that is already used in similar issues here. I chose ElasticsearchException in Hasher as a generic elasticsearch related exception because I didn't find any one more specific that would make much sense. Happy to discuss and change that approach if you or Lyudmila have better suggestions", "author": "jkakavas", "createdAt": "2020-11-25T11:25:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI4NzAzOQ=="}], "type": "inlineReview"}, {"oid": "752b77acc654808bbcb23d620ecaf0d0aba1ca3b", "url": "https://github.com/elastic/elasticsearch/commit/752b77acc654808bbcb23d620ecaf0d0aba1ca3b", "message": "address feedback", "committedDate": "2020-11-25T11:30:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM4OTYwMg==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530389602", "bodyText": "Are we OK with just swallowing exceptions of any other causes?", "author": "BigPandaToo", "createdAt": "2020-11-25T13:53:43Z", "path": "server/src/main/java/org/elasticsearch/cli/KeyStoreAwareCommand.java", "diffHunk": "@@ -71,11 +71,11 @@ protected static SecureString readPassword(Terminal terminal, boolean withVerifi\n      * Decrypt the {@code keyStore}, prompting the user to enter the password in the {@link Terminal} if it is password protected\n      */\n     protected static void decryptKeyStore(KeyStoreWrapper keyStore, Terminal terminal)\n-        throws UserException, GeneralSecurityException, IOException {\n+        throws UserException, IOException {\n         try (SecureString keystorePassword = keyStore.hasPassword() ?\n             readPassword(terminal, false) : new SecureString(new char[0])) {\n             keyStore.decrypt(keystorePassword.getChars());\n-        } catch (SecurityException e) {\n+        } catch (SecurityException | GeneralSecurityException e) {\n             if (e.getCause() instanceof AEADBadTagException) {", "originalCommit": "752b77acc654808bbcb23d620ecaf0d0aba1ca3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQwMDMyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/65464#discussion_r530400329", "bodyText": "This is addressed in #65366 that is already merged", "author": "jkakavas", "createdAt": "2020-11-25T14:09:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM4OTYwMg=="}], "type": "inlineReview"}, {"oid": "c70b54bf19667a17bdea61751cd5c7fb785c27fb", "url": "https://github.com/elastic/elasticsearch/commit/c70b54bf19667a17bdea61751cd5c7fb785c27fb", "message": "Merge remote-tracking branch 'origin/master' into fips-exception-handling", "committedDate": "2020-11-25T14:12:02Z", "type": "commit"}, {"oid": "b46e8db1452a37c18ed832904ca24cb3748559cb", "url": "https://github.com/elastic/elasticsearch/commit/b46e8db1452a37c18ed832904ca24cb3748559cb", "message": "Catch all Errors instead of only AssertionError subclasses", "committedDate": "2020-11-26T11:34:12Z", "type": "commit"}]}