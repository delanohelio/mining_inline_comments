{"pr_number": 51029, "pr_title": "SQL: add support for passing query parameters in REST API calls", "pr_createdAt": "2020-01-15T10:43:22Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51029", "timeline": [{"oid": "f3284a22b3bc6c2f4e98eb7e8e9a751f92a5128c", "url": "https://github.com/elastic/elasticsearch/commit/f3284a22b3bc6c2f4e98eb7e8e9a751f92a5128c", "message": "Add support for REST PreparedStatement-like query parameters", "committedDate": "2020-01-15T10:36:02Z", "type": "commit"}, {"oid": "2ef9a553ff8c86eb3f005a29c768d5d7f43c50df", "url": "https://github.com/elastic/elasticsearch/commit/2ef9a553ff8c86eb3f005a29c768d5d7f43c50df", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 42916_impl", "committedDate": "2020-01-15T10:36:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg1MjYzNw==", "url": "https://github.com/elastic/elasticsearch/pull/51029#discussion_r366852637", "bodyText": "I would add a statement to mention that this is the recommended way of passing parameters to avoid hacking or SQL injection (which does not apply to us but nevertheless).", "author": "costin", "createdAt": "2020-01-15T12:36:52Z", "path": "docs/reference/sql/endpoints/rest.asciidoc", "diffHunk": "@@ -442,6 +443,34 @@ Which looks like:\n --------------------------------------------------\n // TESTRESPONSE[s/46ToAwFzQERYRjFaWEo1UVc1a1JtVjBZMmdCQUFBQUFBQUFBQUVXWjBaNlFXbzNOV0pVY21Wa1NUZDJhV2t3V2xwblp3PT3\\/\\/\\/\\/\\/DwQBZgZhdXRob3IBBHRleHQAAAFmBG5hbWUBBHRleHQAAAFmCnBhZ2VfY291bnQBBGxvbmcBAAFmDHJlbGVhc2VfZGF0ZQEIZGF0ZXRpbWUBAAEP/$body.cursor/]\n \n+[[sql-rest-params]]\n+=== Passing parameters to a query\n+\n+Using values in a query condition, for example, or in a `HAVING` statement can be done \"inline\",\n+by integrating the value in the query string itself:\n+\n+[source,console]\n+--------------------------------------------------\n+POST /_sql?format=txt\n+{\n+\t\"query\": \"SELECT YEAR(release_date) AS year FROM library WHERE page_count > 300 AND author = 'Frank Herbert' GROUP BY year HAVING COUNT(*) > 0\"\n+}\n+--------------------------------------------------\n+// TEST[setup:library]\n+\n+or it can be done by extracting the values in a separate list of parameters and using question mark placeholders (`?`) in the query string:", "originalCommit": "2ef9a553ff8c86eb3f005a29c768d5d7f43c50df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "595f5051e6956eec24d1cfcf169ab5b26dbf0a92", "url": "https://github.com/elastic/elasticsearch/commit/595f5051e6956eec24d1cfcf169ab5b26dbf0a92", "message": "Add statement about recommended way of passing values", "committedDate": "2020-01-16T08:12:24Z", "type": "commit"}, {"oid": "08b74d0b33e50efd4ac01528e95b955d8277e23d", "url": "https://github.com/elastic/elasticsearch/commit/08b74d0b33e50efd4ac01528e95b955d8277e23d", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 42916_impl", "committedDate": "2020-01-16T08:12:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg0NDQ3MA==", "url": "https://github.com/elastic/elasticsearch/pull/51029#discussion_r366844470", "bodyText": "I think this formatting change is wrong?", "author": "matriv", "createdAt": "2020-01-15T12:15:35Z", "path": "x-pack/plugin/sql/sql-action/src/main/java/org/elasticsearch/xpack/sql/action/SqlQueryRequest.java", "diffHunk": "@@ -61,8 +61,8 @@ public SqlQueryRequest() {\n     }\n \n     public SqlQueryRequest(String query, List<SqlTypedParamValue> params, QueryBuilder filter, ZoneId zoneId,\n-                           int fetchSize, TimeValue requestTimeout, TimeValue pageTimeout, Boolean columnar,\n-                           String cursor, RequestInfo requestInfo, boolean fieldMultiValueLeniency, boolean indexIncludeFrozen) {\n+            int fetchSize, TimeValue requestTimeout, TimeValue pageTimeout, Boolean columnar,", "originalCommit": "2ef9a553ff8c86eb3f005a29c768d5d7f43c50df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQyNjExNQ==", "url": "https://github.com/elastic/elasticsearch/pull/51029#discussion_r368426115", "bodyText": "I'll change it.", "author": "astefan", "createdAt": "2020-01-20T08:51:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg0NDQ3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg0NTAxNg==", "url": "https://github.com/elastic/elasticsearch/pull/51029#discussion_r366845016", "bodyText": "tokenLocation shouldn't be part of equals and hashCode?", "author": "matriv", "createdAt": "2020-01-15T12:17:00Z", "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/SqlTypedParamValue.java", "diffHunk": "@@ -65,12 +89,14 @@ public boolean equals(Object o) {\n             return false;\n         }\n         SqlTypedParamValue that = (SqlTypedParamValue) o;\n-        return Objects.equals(value, that.value) && Objects.equals(type, that.type);\n+        return Objects.equals(value, that.value)\n+                && Objects.equals(type, that.type)\n+                && Objects.equals(hasExplicitType, that.hasExplicitType);", "originalCommit": "2ef9a553ff8c86eb3f005a29c768d5d7f43c50df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MDg5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/51029#discussion_r367540892", "bodyText": "was the extra space intended?", "author": "bpintea", "createdAt": "2020-01-16T17:05:23Z", "path": "x-pack/plugin/sql/sql-action/src/main/java/org/elasticsearch/xpack/sql/action/AbstractSqlQueryRequest.java", "diffHunk": "@@ -75,11 +81,11 @@ public AbstractSqlQueryRequest(String query, List<SqlTypedParamValue> params, Qu\n         parser.declareString(AbstractSqlQueryRequest::query, QUERY);\n         parser.declareString((request, mode) -> request.mode(Mode.fromString(mode)), MODE);\n         parser.declareString((request, clientId) -> request.clientId(clientId), CLIENT_ID);\n-        parser.declareObjectArray(AbstractSqlQueryRequest::params, (p, c) -> SqlTypedParamValue.fromXContent(p), PARAMS);\n+        parser.declareField(AbstractSqlQueryRequest::params, p -> AbstractSqlQueryRequest.parseParams(p), PARAMS, ValueType.VALUE_ARRAY);\n         parser.declareString((request, zoneId) -> request.zoneId(ZoneId.of(zoneId)), TIME_ZONE);\n         parser.declareInt(AbstractSqlQueryRequest::fetchSize, FETCH_SIZE);\n         parser.declareString((request, timeout) -> request.requestTimeout(TimeValue.parseTimeValue(timeout, Protocol.REQUEST_TIMEOUT,\n-            \"request_timeout\")), REQUEST_TIMEOUT);\n+                \"request_timeout\")), REQUEST_TIMEOUT);", "originalCommit": "08b74d0b33e50efd4ac01528e95b955d8277e23d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQyNTgyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/51029#discussion_r368425829", "bodyText": "Yes, to have a uniform formatting for the field parsers' declaration. See here the initial formatting.", "author": "astefan", "createdAt": "2020-01-20T08:50:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MDg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MDk4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/51029#discussion_r367540987", "bodyText": "Was wondering if this was meant as ... for the first param that doesn't meet ..., since an object could occur at any point in the array.", "author": "bpintea", "createdAt": "2020-01-16T17:05:33Z", "path": "x-pack/plugin/sql/sql-action/src/main/java/org/elasticsearch/xpack/sql/action/AbstractSqlQueryRequest.java", "diffHunk": "@@ -117,6 +123,86 @@ public AbstractSqlQueryRequest params(List<SqlTypedParamValue> params) {\n         this.params = params;\n         return this;\n     }\n+    \n+    private static List<SqlTypedParamValue> parseParams(XContentParser p) throws IOException {\n+        List<SqlTypedParamValue> result = new ArrayList<>();\n+        Token token = p.currentToken();\n+        \n+        if (token == Token.START_ARRAY) {\n+            Object value = null;\n+            String type = null;\n+            SqlTypedParamValue previousParam = null;\n+            \n+            while ((token = p.nextToken()) != Token.END_ARRAY) {\n+                XContentLocation loc = p.getTokenLocation();\n+                \n+                if (token == Token.START_OBJECT) {\n+                    // we are at the start of a value/type pair... hopefully\n+                    SqlTypedParamValue s = SqlTypedParamValue.fromXContent(p);\n+                    /*\n+                     * Set the xcontentlocation for the first param just in case the first one doesn't meet the parsing rules", "originalCommit": "08b74d0b33e50efd4ac01528e95b955d8277e23d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQyNzEzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/51029#discussion_r368427131", "bodyText": "I rephrased this section for, hopefully, better clarity.", "author": "astefan", "createdAt": "2020-01-20T08:53:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MDk4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MTAyNg==", "url": "https://github.com/elastic/elasticsearch/pull/51029#discussion_r367541026", "bodyText": "This code executes in both if/else branches, it might be worth considering taking it out.\nAnother nit: a switch with all the top enums (object, string, number, bool, null) might also arguably simplify the code.", "author": "bpintea", "createdAt": "2020-01-16T17:05:37Z", "path": "x-pack/plugin/sql/sql-action/src/main/java/org/elasticsearch/xpack/sql/action/AbstractSqlQueryRequest.java", "diffHunk": "@@ -117,6 +123,86 @@ public AbstractSqlQueryRequest params(List<SqlTypedParamValue> params) {\n         this.params = params;\n         return this;\n     }\n+    \n+    private static List<SqlTypedParamValue> parseParams(XContentParser p) throws IOException {\n+        List<SqlTypedParamValue> result = new ArrayList<>();\n+        Token token = p.currentToken();\n+        \n+        if (token == Token.START_ARRAY) {\n+            Object value = null;\n+            String type = null;\n+            SqlTypedParamValue previousParam = null;\n+            \n+            while ((token = p.nextToken()) != Token.END_ARRAY) {\n+                XContentLocation loc = p.getTokenLocation();\n+                \n+                if (token == Token.START_OBJECT) {\n+                    // we are at the start of a value/type pair... hopefully\n+                    SqlTypedParamValue s = SqlTypedParamValue.fromXContent(p);\n+                    /*\n+                     * Set the xcontentlocation for the first param just in case the first one doesn't meet the parsing rules\n+                     * that are checked later in validateParams method and, also, the xcontentlocation of the param that is \n+                     * different from the previous param in list when it comes to its type being explicitly set or inferred.\n+                     */\n+                    if ((previousParam != null && previousParam.hasExplicitType() == false) || result.isEmpty()) {\n+                        s.tokenLocation(loc);\n+                    }\n+                    result.add(s);\n+                    previousParam = s;", "originalCommit": "08b74d0b33e50efd4ac01528e95b955d8277e23d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQyOTIzMg==", "url": "https://github.com/elastic/elasticsearch/pull/51029#discussion_r368429232", "bodyText": "I've extracted the common code, but I kept the if/else approach. I find it a bit more clear than a switch.", "author": "astefan", "createdAt": "2020-01-20T08:58:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MTAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MjQ4OA==", "url": "https://github.com/elastic/elasticsearch/pull/51029#discussion_r367542488", "bodyText": "Could the second arg also be a method reference?", "author": "bpintea", "createdAt": "2020-01-16T17:08:23Z", "path": "x-pack/plugin/sql/sql-action/src/main/java/org/elasticsearch/xpack/sql/action/AbstractSqlQueryRequest.java", "diffHunk": "@@ -75,11 +81,11 @@ public AbstractSqlQueryRequest(String query, List<SqlTypedParamValue> params, Qu\n         parser.declareString(AbstractSqlQueryRequest::query, QUERY);\n         parser.declareString((request, mode) -> request.mode(Mode.fromString(mode)), MODE);\n         parser.declareString((request, clientId) -> request.clientId(clientId), CLIENT_ID);\n-        parser.declareObjectArray(AbstractSqlQueryRequest::params, (p, c) -> SqlTypedParamValue.fromXContent(p), PARAMS);\n+        parser.declareField(AbstractSqlQueryRequest::params, p -> AbstractSqlQueryRequest.parseParams(p), PARAMS, ValueType.VALUE_ARRAY);", "originalCommit": "08b74d0b33e50efd4ac01528e95b955d8277e23d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQzMDY0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/51029#discussion_r368430646", "bodyText": "Indeed", "author": "astefan", "createdAt": "2020-01-20T09:01:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MjQ4OA=="}], "type": "inlineReview"}, {"oid": "6eac38baa3b51fbc506196249335d399ee2707c7", "url": "https://github.com/elastic/elasticsearch/commit/6eac38baa3b51fbc506196249335d399ee2707c7", "message": "Address reviews", "committedDate": "2020-01-20T09:03:38Z", "type": "commit"}, {"oid": "09570d693cc28db75e9f61bbcfcc93b534b3d629", "url": "https://github.com/elastic/elasticsearch/commit/09570d693cc28db75e9f61bbcfcc93b534b3d629", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 42916_impl", "committedDate": "2020-01-20T09:03:56Z", "type": "commit"}, {"oid": "a81d8ef2638f47891b85a04f27ff08a5f222c0f5", "url": "https://github.com/elastic/elasticsearch/commit/a81d8ef2638f47891b85a04f27ff08a5f222c0f5", "message": "Revert adding tokenLocation to toString and hashCode methods since\nthe equality between TokenLocations is based on instance and not inner\nvalues.", "committedDate": "2020-01-20T11:42:11Z", "type": "commit"}, {"oid": "a059a0de37141983ed771121f9edf280eb8d341b", "url": "https://github.com/elastic/elasticsearch/commit/a059a0de37141983ed771121f9edf280eb8d341b", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 42916_impl", "committedDate": "2020-01-20T11:42:48Z", "type": "commit"}]}