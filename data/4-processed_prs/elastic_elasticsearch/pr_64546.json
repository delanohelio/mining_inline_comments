{"pr_number": 64546, "pr_title": "SQL: Test `IN` operator out of range validation", "pr_createdAt": "2020-11-03T18:07:10Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64546", "timeline": [{"oid": "6f96c97c0e8abdbf04c0498a408b18ddaf4c2777", "url": "https://github.com/elastic/elasticsearch/commit/6f96c97c0e8abdbf04c0498a408b18ddaf4c2777", "message": "SQL: Test `IN` operator out of range validation\n\nAdditional tests.\n\nTest if the type of the field is actually picked up from the field\nmapping and if the values specified for the `IN` operator are\nconverter to the type of the field (for numerical fields).\n\nRelates to #64238", "committedDate": "2020-11-03T18:05:58Z", "type": "commit"}, {"oid": "118966855c6176800ab33abe5f474b2db8639073", "url": "https://github.com/elastic/elasticsearch/commit/118966855c6176800ab33abe5f474b2db8639073", "message": "Fix checkstyle complaint", "committedDate": "2020-11-03T22:19:38Z", "type": "commit"}, {"oid": "573a271121a3d0a125661b1fc56b534b9915874c", "url": "https://github.com/elastic/elasticsearch/commit/573a271121a3d0a125661b1fc56b534b9915874c", "message": "Merge remote-tracking branch 'origin/master' into fix/64238", "committedDate": "2020-11-03T22:20:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2MjU4NA==", "url": "https://github.com/elastic/elasticsearch/pull/64546#discussion_r517162584", "bodyText": "This test might be a good fit in x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/planner/PostOptimizerVerifierTests.java?", "author": "bpintea", "createdAt": "2020-11-04T08:14:57Z", "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/planner/QueryTranslatorTests.java", "diffHunk": "@@ -2239,4 +2260,16 @@ public void testScriptsInsideAggregateFunctions_WithDateField_AndExtendedStats()\n             + \"InternalSqlScriptUtils.asDateTime(params.a0),InternalSqlScriptUtils.asDateTime(params.v0)))\\\",\\\"lang\\\":\\\"painless\\\",\"\n             + \"\\\"params\\\":{\\\"v0\\\":\\\"2020-05-03T00:00:00.000Z\\\"}},\\\"gap_policy\\\":\\\"skip\\\"}}}}}}\"));\n     }\n+\n+    public void testInOutOfRangeValues() {", "originalCommit": "573a271121a3d0a125661b1fc56b534b9915874c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY1ODY3NA==", "url": "https://github.com/elastic/elasticsearch/pull/64546#discussion_r517658674", "bodyText": "The logic I test here is in the ExpressionTranslators (QueryTranslator -> ExpressionTranslators call path) and not in the Verifier. Although the PostOptimizerVerifierTests also exercise the QueryTranslator, so far (and based on the name) that class only tests the Verifier logic.", "author": "palesz", "createdAt": "2020-11-04T22:05:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2MjU4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2Mjg0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64546#discussion_r517162841", "bodyText": "This might be suitable for x-pack/plugin/sql/qa/server/src/main/resources/filter.sql-spec.", "author": "bpintea", "createdAt": "2020-11-04T08:15:25Z", "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/planner/QueryTranslatorTests.java", "diffHunk": "@@ -2239,4 +2260,16 @@ public void testScriptsInsideAggregateFunctions_WithDateField_AndExtendedStats()\n             + \"InternalSqlScriptUtils.asDateTime(params.a0),InternalSqlScriptUtils.asDateTime(params.v0)))\\\",\\\"lang\\\":\\\"painless\\\",\"\n             + \"\\\"params\\\":{\\\"v0\\\":\\\"2020-05-03T00:00:00.000Z\\\"}},\\\"gap_policy\\\":\\\"skip\\\"}}}}}}\"));\n     }\n+\n+    public void testInOutOfRangeValues() {\n+        QlIllegalArgumentException ex = expectThrows(QlIllegalArgumentException.class,\n+            () -> optimizeAndPlan(\"SELECT int FROM test WHERE int IN (1, 2, 3, \" + Long.MAX_VALUE + \", 5, 6, 7)\"));\n+        assertThat(ex.getMessage(), is(\"[\" + Long.MAX_VALUE + \"] out of [integer] range\"));\n+    }\n+\n+    public void testInInRangeValues() {", "originalCommit": "573a271121a3d0a125661b1fc56b534b9915874c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY1OTUyMw==", "url": "https://github.com/elastic/elasticsearch/pull/64546#discussion_r517659523", "bodyText": "I can add the positive case to the integration tests too.", "author": "palesz", "createdAt": "2020-11-04T22:07:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2Mjg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY3MjgyMg==", "url": "https://github.com/elastic/elasticsearch/pull/64546#discussion_r517672822", "bodyText": "One problem though: I don't see any long type fields in the test_emp dataset -> I cannot test it there (and IMHO it does not worth to change the dataset for this one testcase that I can test in a unit test).", "author": "palesz", "createdAt": "2020-11-04T22:38:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2Mjg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkzMTQxNw==", "url": "https://github.com/elastic/elasticsearch/pull/64546#discussion_r517931417", "bodyText": "Not the most straightforward construct but casts should work;  something like ...WHERE salary::LONG IN (1, 2::LONG). But anyways, I think the tests are OK as they have been merged too.", "author": "bpintea", "createdAt": "2020-11-05T10:06:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2Mjg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA5NzE2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64546#discussion_r518097161", "bodyText": "Good idea, will remember this one next time.", "author": "palesz", "createdAt": "2020-11-05T14:34:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2Mjg0MQ=="}], "type": "inlineReview"}, {"oid": "4fd124bf431663b8fd66fc40674e4e6ebdfccd70", "url": "https://github.com/elastic/elasticsearch/commit/4fd124bf431663b8fd66fc40674e4e6ebdfccd70", "message": "Merge remote-tracking branch 'origin/master' into fix/64238", "committedDate": "2020-11-04T22:48:42Z", "type": "commit"}, {"oid": "559a95e9e1e47fec14fe735c31c2b950e7b1a22a", "url": "https://github.com/elastic/elasticsearch/commit/559a95e9e1e47fec14fe735c31c2b950e7b1a22a", "message": "Fix merge issue", "committedDate": "2020-11-04T23:20:42Z", "type": "commit"}]}