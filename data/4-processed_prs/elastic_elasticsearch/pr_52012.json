{"pr_number": 52012, "pr_title": "[ML] job results provider refactoring", "pr_createdAt": "2020-02-06T18:52:04Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52012", "timeline": [{"oid": "8d1393c407a848edf68a63d34059c40dcd302f3c", "url": "https://github.com/elastic/elasticsearch/commit/8d1393c407a848edf68a63d34059c40dcd302f3c", "message": "[ML] Fixing provider and delete issues", "committedDate": "2020-02-05T20:00:49Z", "type": "commit"}, {"oid": "c30845bd42629aa488cd3c1182c67b6763ab131c", "url": "https://github.com/elastic/elasticsearch/commit/c30845bd42629aa488cd3c1182c67b6763ab131c", "message": "Merge branch 'master' into feature/ml-delete-job-fixups", "committedDate": "2020-02-06T18:23:46Z", "type": "commit"}, {"oid": "0fe6907f556624f56ae69701c3e3bb6a257061c8", "url": "https://github.com/elastic/elasticsearch/commit/0fe6907f556624f56ae69701c3e3bb6a257061c8", "message": "minor clean up", "committedDate": "2020-02-06T18:36:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAxODYwNg==", "url": "https://github.com/elastic/elasticsearch/pull/52012#discussion_r376018606", "bodyText": "This was called assuming only one handler was called only once.", "author": "benwtrent", "createdAt": "2020-02-06T18:52:49Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/persistence/JobResultsProvider.java", "diffHunk": "@@ -441,10 +441,9 @@ private SearchRequestBuilder createLatestTimingStatsSearch(String indexName, Str\n             .addSort(SortBuilders.fieldSort(TimingStats.BUCKET_COUNT.getPreferredName()).order(SortOrder.DESC));\n     }\n \n-    public void datafeedTimingStats(List<String> jobIds, Consumer<Map<String, DatafeedTimingStats>> handler,\n-                                    Consumer<Exception> errorHandler) {\n+    public void datafeedTimingStats(List<String> jobIds, ActionListener<Map<String, DatafeedTimingStats>> listener) {", "originalCommit": "0fe6907f556624f56ae69701c3e3bb6a257061c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAxOTMzNA==", "url": "https://github.com/elastic/elasticsearch/pull/52012#discussion_r376019334", "bodyText": "The only place where this method is used is in getAutodetectParams which is called when a job is opened. Any failure marked the job task as failed and attempted to close the job.\nProblem was the potential of the callback being called numerous times. (see line 600)", "author": "benwtrent", "createdAt": "2020-02-06T18:54:21Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/persistence/JobResultsProvider.java", "diffHunk": "@@ -607,38 +622,47 @@ private SearchRequestBuilder createDocIdSearch(String index, String id) {\n                 .setRouting(id);\n     }\n \n-    private static void parseAutodetectParamSearchHit(String jobId, AutodetectParams.Builder paramsBuilder, SearchHit hit,\n-                                               Consumer<Exception> errorHandler) {\n+    /**\n+     * @throws ElasticsearchException when search hit cannot be parsed\n+     * @throws IllegalStateException when search hit has an unexpected ID\n+     */\n+    private static void parseAutodetectParamSearchHit(String jobId,", "originalCommit": "0fe6907f556624f56ae69701c3e3bb6a257061c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI2NzE1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/52012#discussion_r376267159", "bodyText": "If we opt to add returns when we signal a failure, then we might as well use that to simplify the code and remove those elses. Same holds for the added returns a bit lower.", "author": "dimitris-athanasiou", "createdAt": "2020-02-07T08:31:14Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/persistence/JobResultsProvider.java", "diffHunk": "@@ -567,6 +574,7 @@ public void getAutodetectParams(Job job, Consumer<AutodetectParams> consumer, Co\n                                 MultiSearchResponse.Item itemResponse = response.getResponses()[i];\n                                 if (itemResponse.isFailure()) {\n                                     errorHandler.accept(itemResponse.getFailure());\n+                                    return;", "originalCommit": "0fe6907f556624f56ae69701c3e3bb6a257061c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI2Nzg5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52012#discussion_r376267896", "bodyText": "Same as the my later comment. As we return now, we can simplify by not using else.", "author": "dimitris-athanasiou", "createdAt": "2020-02-07T08:33:11Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/persistence/JobResultsProvider.java", "diffHunk": "@@ -465,19 +464,22 @@ public void datafeedTimingStats(List<String> jobIds, Consumer<Map<String, Datafe\n                         String jobId = jobIds.get(i);\n                         MultiSearchResponse.Item itemResponse = msearchResponse.getResponses()[i];\n                         if (itemResponse.isFailure()) {\n-                            errorHandler.accept(itemResponse.getFailure());\n+                            listener.onFailure(itemResponse.getFailure());\n+                            return;\n                         } else {\n                             SearchResponse searchResponse = itemResponse.getResponse();\n                             ShardSearchFailure[] shardFailures = searchResponse.getShardFailures();\n                             int unavailableShards = searchResponse.getTotalShards() - searchResponse.getSuccessfulShards();\n                             if (shardFailures != null && shardFailures.length > 0) {\n                                 LOGGER.error(\"[{}] Search request returned shard failures: {}\", jobId, Arrays.toString(shardFailures));\n-                                errorHandler.accept(\n+                                listener.onFailure(\n                                     new ElasticsearchException(ExceptionsHelper.shardFailuresToErrorMsg(jobId, shardFailures)));\n+                                return;", "originalCommit": "0fe6907f556624f56ae69701c3e3bb6a257061c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQwNzE5MA==", "url": "https://github.com/elastic/elasticsearch/pull/52012#discussion_r376407190", "bodyText": "I know you didn't introduce this problem, but if this assertion error is ever thrown it will be frustrating because it will not say what the root case was.  So please can you change it to e -> { throw new AssertionError(\"Failure getting datafeed timing stats\", e); }.", "author": "droberts195", "createdAt": "2020-02-07T14:07:33Z", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/persistence/JobResultsProviderTests.java", "diffHunk": "@@ -897,8 +897,9 @@ public void testDatafeedTimingStats_EmptyJobList() {\n         JobResultsProvider provider = createProvider(client);\n         provider.datafeedTimingStats(\n             List.of(),\n-            statsByJobId -> assertThat(statsByJobId, anEmptyMap()),\n-            e -> { throw new AssertionError(); });\n+            ActionListener.wrap(\n+                statsByJobId -> assertThat(statsByJobId, anEmptyMap()),\n+                e -> { throw new AssertionError(); }));", "originalCommit": "0fe6907f556624f56ae69701c3e3bb6a257061c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ4MDA5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52012#discussion_r376480091", "bodyText": "\ud83d\udc4d", "author": "benwtrent", "createdAt": "2020-02-07T16:20:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQwNzE5MA=="}], "type": "inlineReview"}, {"oid": "d4589d16c30eff07682cd036bf5823003adb5f21", "url": "https://github.com/elastic/elasticsearch/commit/d4589d16c30eff07682cd036bf5823003adb5f21", "message": "addressing PR comments", "committedDate": "2020-02-11T16:25:38Z", "type": "commit"}, {"oid": "20f58f6405d658fc05142e2ec7342d6d800d8215", "url": "https://github.com/elastic/elasticsearch/commit/20f58f6405d658fc05142e2ec7342d6d800d8215", "message": "fixing results parser", "committedDate": "2020-02-11T17:09:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5NzIxMA==", "url": "https://github.com/elastic/elasticsearch/pull/52012#discussion_r377797210", "bodyText": "Is there an redundant indentation here or is it github messing with me?", "author": "dimitris-athanasiou", "createdAt": "2020-02-11T17:50:20Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/persistence/JobResultsProvider.java", "diffHunk": "@@ -575,40 +572,38 @@ public void getAutodetectParams(Job job, Consumer<AutodetectParams> consumer, Co\n                                 if (itemResponse.isFailure()) {\n                                     errorHandler.accept(itemResponse.getFailure());\n                                     return;\n-                                } else {\n-                                    SearchResponse searchResponse = itemResponse.getResponse();\n-                                    ShardSearchFailure[] shardFailures = searchResponse.getShardFailures();\n-                                    int unavailableShards = searchResponse.getTotalShards() - searchResponse.getSuccessfulShards();\n-                                    if (shardFailures != null && shardFailures.length > 0) {\n-                                        LOGGER.error(\"[{}] Search request returned shard failures: {}\", jobId,\n-                                                Arrays.toString(shardFailures));\n-                                        errorHandler.accept(new ElasticsearchException(\n-                                                ExceptionsHelper.shardFailuresToErrorMsg(jobId, shardFailures)));\n-                                        return;\n-                                    } else if (unavailableShards > 0) {\n-                                        errorHandler.accept(new ElasticsearchException(\"[\" + jobId\n-                                                + \"] Search request encountered [\" + unavailableShards + \"] unavailable shards\"));\n-                                        return;\n-                                    } else {\n-                                        SearchHits hits = searchResponse.getHits();\n-                                        long hitsCount = hits.getHits().length;\n-                                        if (hitsCount == 0) {\n-                                            SearchRequest searchRequest = msearch.request().requests().get(i);\n-                                            LOGGER.debug(\"Found 0 hits for [{}]\", new Object[]{searchRequest.indices()});\n-                                        } else {\n-                                            for (SearchHit hit : hits) {\n-                                                try {\n-                                                    parseAutodetectParamSearchHit(jobId, paramsBuilder, hit);\n-                                                } catch (Exception e) {\n-                                                    errorHandler.accept(e);\n-                                                    return;\n-                                                }\n-                                            }\n+                                }\n+                                SearchResponse searchResponse = itemResponse.getResponse();\n+                                ShardSearchFailure[] shardFailures = searchResponse.getShardFailures();\n+                                int unavailableShards = searchResponse.getTotalShards() - searchResponse.getSuccessfulShards();\n+                                if (shardFailures != null && shardFailures.length > 0) {\n+                                    LOGGER.error(\"[{}] Search request returned shard failures: {}\", jobId,\n+                                            Arrays.toString(shardFailures));\n+                                    errorHandler.accept(new ElasticsearchException(\n+                                            ExceptionsHelper.shardFailuresToErrorMsg(jobId, shardFailures)));\n+                                    return;\n+                                }\n+                                if (unavailableShards > 0) {\n+                                    errorHandler.accept(new ElasticsearchException(\"[\" + jobId\n+                                            + \"] Search request encountered [\" + unavailableShards + \"] unavailable shards\"));\n+                                    return;\n+                                }\n+                                SearchHits hits = searchResponse.getHits();\n+                                long hitsCount = hits.getHits().length;\n+                                if (hitsCount == 0) {\n+                                    SearchRequest searchRequest = msearch.request().requests().get(i);\n+                                    LOGGER.debug(\"Found 0 hits for [{}]\", new Object[]{searchRequest.indices()});\n+                                    return;\n+                                }\n+                                    for (SearchHit hit : hits) {", "originalCommit": "d4589d16c30eff07682cd036bf5823003adb5f21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxNjIxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/52012#discussion_r377816215", "bodyText": "fixed :)", "author": "benwtrent", "createdAt": "2020-02-11T18:26:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc5NzIxMA=="}], "type": "inlineReview"}, {"oid": "235bb4ee13f0d0959ca1d06b3ac9d88a9f786c06", "url": "https://github.com/elastic/elasticsearch/commit/235bb4ee13f0d0959ca1d06b3ac9d88a9f786c06", "message": "Merge branch 'master' into feature/ml-delete-job-fixups", "committedDate": "2020-02-11T18:28:14Z", "type": "commit"}, {"oid": "f451a8af706b9254ca16b66461df1dcaa2f93df8", "url": "https://github.com/elastic/elasticsearch/commit/f451a8af706b9254ca16b66461df1dcaa2f93df8", "message": "removing unnecessary return statements", "committedDate": "2020-02-11T18:47:25Z", "type": "commit"}]}