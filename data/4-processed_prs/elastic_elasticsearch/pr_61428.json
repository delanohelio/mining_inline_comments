{"pr_number": 61428, "pr_title": "EQL: Replace SearchHit in response with Event", "pr_createdAt": "2020-08-21T15:49:09Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61428", "timeline": [{"oid": "8ddc9ca3fad6309f365d39fd20346bc0923a3d29", "url": "https://github.com/elastic/elasticsearch/commit/8ddc9ca3fad6309f365d39fd20346bc0923a3d29", "message": "EQL: Replace SearchHit in response with Event\n\nThe building block of the eql response is currently the SearchHit. This\nis a problem since it is tied to an actual search, and thus has scoring,\nhighlighting, shard information and a lot of other things that are not\nrelevant for EQL.\nThis becomes a problem when doing sequence queries since the response is\nnot generated from one search query and thus there are no SearchHits to\nspeak of.\nEmulating one is not just conceptually incorrect but also problematic\nsince most of the data is missed or made-up.\n\nAs such this PR introduces a simple class, Event, that maps nicely to\nthe terminology while hiding the ES internals (the use of SearchHit or\nGetResult/GetResponse depending on the API used).\n\nFix #59764\nFix #59779", "committedDate": "2020-08-21T15:45:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MzgzNA==", "url": "https://github.com/elastic/elasticsearch/pull/61428#discussion_r474783834", "bodyText": "This bit caused a lot of wasted time trying to figure out why the response was not working. I had to use the deprecated form since the form above gave incorrect results - the json was mangled with some extra characters and I'm not sure where those occurred. Initially I assumed it's a compressed stream but it's not since the source is always uncompressed from the underlying object.\nSo maybe it's stored in JSON format ... don't know.\n@imotov any ideas?", "author": "costin", "createdAt": "2020-08-21T15:52:30Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/action/EqlSearchResponse.java", "diffHunk": "@@ -179,6 +182,110 @@ public String toString() {\n         return Strings.toString(this);\n     }\n \n+    // Event\n+    public static class Event implements Writeable, ToXContentObject {\n+\n+        private static final class Fields {\n+            static final String INDEX = GetResult._INDEX;\n+            static final String ID = GetResult._ID;\n+            static final String SOURCE = SourceFieldMapper.NAME;\n+        }\n+\n+        private static final ParseField INDEX = new ParseField(Fields.INDEX);\n+        private static final ParseField ID = new ParseField(Fields.ID);\n+        private static final ParseField SOURCE = new ParseField(Fields.SOURCE);\n+\n+        private static final ConstructingObjectParser<Event, Void> PARSER =\n+                new ConstructingObjectParser<>(\"eql/search_response_event\", true,\n+                        args -> new Event((String) args[0], (String) args[1], (BytesReference) args[2]));\n+\n+        static {\n+            PARSER.declareString(constructorArg(), INDEX);\n+            PARSER.declareString(constructorArg(), ID);\n+            PARSER.declareObject(constructorArg(), (p, c) -> {\n+                try (XContentBuilder builder = XContentBuilder.builder(p.contentType().xContent())) {\n+                    builder.copyCurrentStructure(p);\n+                    return BytesReference.bytes(builder);\n+                }\n+            }, SOURCE);\n+        }\n+\n+        private final String index;\n+        private final String id;\n+        private final BytesReference source;\n+\n+        public Event(String index, String id, BytesReference source) {\n+            this.index = index;\n+            this.id = id;\n+            this.source = source;\n+        }\n+        \n+        public Event(StreamInput in) throws IOException {\n+            index = in.readString();\n+            id = in.readString();\n+            source = in.readBytesReference();\n+        }\n+\n+        @Override\n+        public void writeTo(StreamOutput out) throws IOException {\n+            out.writeString(index);\n+            out.writeString(id);\n+            out.writeBytesReference(source);\n+        }\n+\n+        @Override\n+        public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n+            builder.startObject();\n+            builder.field(Fields.INDEX, index);\n+            builder.field(Fields.ID, id);\n+            //XContentHelper.writeRawField(Fields.SOURCE, source, builder.contentType(), builder, params);\n+            XContentHelper.writeRawField(Fields.SOURCE, source, builder, params);", "originalCommit": "8ddc9ca3fad6309f365d39fd20346bc0923a3d29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4Nzg2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/61428#discussion_r474787861", "bodyText": "Where wasn't it working? Can I reproduce it somehow?", "author": "imotov", "createdAt": "2020-08-21T15:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MzgzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzNTc0OA==", "url": "https://github.com/elastic/elasticsearch/pull/61428#discussion_r474835748", "bodyText": "If you switch the statements above (uncomment the line above and comment the existing one) you should get failures in EqlIT tests.\nI closed the shell with the failure but looking at it, the whitespaces and starting delimiters in JSON for source where replaced with some out of band ASCII ones (hence why I assume it's CBOR or some other binary format).", "author": "costin", "createdAt": "2020-08-21T17:37:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MzgzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg0NTI0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/61428#discussion_r474845242", "bodyText": "Looks the CI managed to reproduce this in the unit tests.\nRunning org.elasticsearch.client.eql.EqlSearchResponseTests using seed 9361DF75459AFCD5 causes the underlying bytearray to different chars - trying to read the byte array gives:\njava.lang.AssertionError: b = 0xfa\n\tat org.apache.lucene.util.UnicodeUtil.UTF8toUTF16(UnicodeUtil.java:601)\n\tat org.apache.lucene.util.BytesRef.utf8ToString(BytesRef.java:137)\n\tat org.elasticsearch.common.bytes.AbstractBytesReference.utf8ToString(AbstractBytesReference.java:68)\n\tat org.elasticsearch.client.eql.EqlSearchResponseTests.assertInstances(EqlSearchResponseTests.java:240)\n\tat org.elasticsearch.client.eql.EqlSearchResponseTests.assertInstances(EqlSearchResponseTests.java:1)\n\nSwitch the lines above and you'll get the same error I seen before:\njava.lang.AssertionError: \nExpected: is <[org.elasticsearch.client.eql.EqlSearchResponse$Event@627ca34b, org.elasticsearch.client.eql.EqlSearchResponse$Event@7dae4c21, org.elasticsearch.client.eql.EqlSearchResponse$Event@8dba81f1, org.elasticsearch.client.eql.EqlSearchResponse$Event@245f1512, org.elasticsearch.client.eql.EqlSearchResponse$Event@cb4a5cb4, org.elasticsearch.client.eql.EqlSearchResponse$Event@5c36c41c, org.elasticsearch.client.eql.EqlSearchResponse$Event@eb88326f]>\n     but: was <[{\n  \"error\" : \"error building toString out of XContent: Unexpected character (':' (code 58)): expected a valid value (JSON String, Number, Array, Object or token 'null', 'true' or 'false')\\n at [Source: (org.elasticsearch.common.bytes.AbstractBytesReference$MarkSupportingStreamInputWrapper); line: 1, column: 2]\",", "author": "costin", "createdAt": "2020-08-21T17:57:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MzgzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk5NTc5NA==", "url": "https://github.com/elastic/elasticsearch/pull/61428#discussion_r474995794", "bodyText": "Oh, I see, it thinks it is the start of the stream. I will take a look the first thing Monday morning. SDH today - so didn't have a chance to look at it yet.", "author": "imotov", "createdAt": "2020-08-21T22:28:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MzgzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTkxNDg4OA==", "url": "https://github.com/elastic/elasticsearch/pull/61428#discussion_r475914888", "bodyText": "I don't think we can avoid using this deprecated method as long as it is used by SearchHit for the same basic reason it is used by SearchHit - we have no idea in which format the source was stored so we need to detect it in the run time. We would basically need to store original source content type in order to avoid using this method, which we don't.", "author": "imotov", "createdAt": "2020-08-24T21:51:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4MzgzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4OTAyMA==", "url": "https://github.com/elastic/elasticsearch/pull/61428#discussion_r474789020", "bodyText": "We also need to remove docs for _version, seq_no, and primary_term params (located right above this one). I can do that in a follow-up PR if wanted.", "author": "jrodewig", "createdAt": "2020-08-21T16:02:21Z", "path": "docs/reference/eql/eql-search-api.asciidoc", "diffHunk": "@@ -442,11 +442,6 @@ doesn\u2019t overwrite a newer version. See <<optimistic-concurrency-control>>.\n (integer)\n Primary term assigned to the document. See <<optimistic-concurrency-control>>.\n \n-`_score`::", "originalCommit": "8ddc9ca3fad6309f365d39fd20346bc0923a3d29", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cda6d22ebc32e5d38ca7cb9052354ef09af9991f", "url": "https://github.com/elastic/elasticsearch/commit/cda6d22ebc32e5d38ca7cb9052354ef09af9991f", "message": "Fix EqlSearchResponseTests.testFromXContent\n\nAdds proper check for source comparison.", "committedDate": "2020-08-24T21:19:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1NzQ2NA==", "url": "https://github.com/elastic/elasticsearch/pull/61428#discussion_r476357464", "bodyText": "What does As mean?", "author": "matriv", "createdAt": "2020-08-25T10:52:39Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/AsEventListener.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.search;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.xpack.eql.execution.payload.EventPayload;\n+import org.elasticsearch.xpack.eql.session.Payload;\n+\n+public class AsEventListener implements ActionListener<SearchResponse> {", "originalCommit": "cda6d22ebc32e5d38ca7cb9052354ef09af9991f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3NDUyMw==", "url": "https://github.com/elastic/elasticsearch/pull/61428#discussion_r476374523", "bodyText": "SearchResponse as Event", "author": "costin", "createdAt": "2020-08-25T11:27:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM1NzQ2NA=="}], "type": "inlineReview"}]}