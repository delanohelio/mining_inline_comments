{"pr_number": 60865, "pr_title": "Optimize a few Spots on IO Loop", "pr_createdAt": "2020-08-08T18:54:01Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60865", "timeline": [{"oid": "ba2195fce347df660ac7fb6cc3c3270198c71b01", "url": "https://github.com/elastic/elasticsearch/commit/ba2195fce347df660ac7fb6cc3c3270198c71b01", "message": "Optimize 2 Spots on IO Loop\n\n* Don't instantiate new `Runnable` to execute on `SAME`\n* Don't instantiate complicated wrapped stream for empty messages", "committedDate": "2020-08-08T18:31:27Z", "type": "commit"}, {"oid": "9abd13e6de3419dddd1c688ce3bb9eef4bfd96cf", "url": "https://github.com/elastic/elasticsearch/commit/9abd13e6de3419dddd1c688ce3bb9eef4bfd96cf", "message": "fixes", "committedDate": "2020-08-09T06:13:04Z", "type": "commit"}, {"oid": "3bb42e91022b9ca09393769eefd924f0faaacf1b", "url": "https://github.com/elastic/elasticsearch/commit/3bb42e91022b9ca09393769eefd924f0faaacf1b", "message": "fix tests", "committedDate": "2020-08-09T13:16:54Z", "type": "commit"}, {"oid": "4f0e402fa50c3833e634dc6e4b234c6f83f8b89c", "url": "https://github.com/elastic/elasticsearch/commit/4f0e402fa50c3833e634dc6e4b234c6f83f8b89c", "message": "can't do this", "committedDate": "2020-08-09T16:57:48Z", "type": "commit"}, {"oid": "ee52b68ee90fbe1681cb24045a3af953e4a9871b", "url": "https://github.com/elastic/elasticsearch/commit/ee52b68ee90fbe1681cb24045a3af953e4a9871b", "message": "fix tests", "committedDate": "2020-08-09T23:11:47Z", "type": "commit"}, {"oid": "5f27736c8f4785a97b5a61f2c99f62f8d25d7d25", "url": "https://github.com/elastic/elasticsearch/commit/5f27736c8f4785a97b5a61f2c99f62f8d25d7d25", "message": "fix tests", "committedDate": "2020-08-09T23:38:57Z", "type": "commit"}, {"oid": "f418bcdddb643df3f1442fea3587f3ee16ccf8b3", "url": "https://github.com/elastic/elasticsearch/commit/f418bcdddb643df3f1442fea3587f3ee16ccf8b3", "message": "fix tests", "committedDate": "2020-08-10T05:06:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwNTQ1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/60865#discussion_r467705457", "bodyText": "This may introduce a BWC problem in the case that a response is only empty in some versions, because EMPTY_STREAM_INPUT#getVersion() returns Version.CURRENT which may not match header.getVersion().", "author": "DaveCTurner", "createdAt": "2020-08-10T06:19:15Z", "path": "server/src/main/java/org/elasticsearch/transport/InboundHandler.java", "diffHunk": "@@ -111,17 +114,26 @@ private void messageReceived(TcpChannel channel, InboundMessage message) throws\n                 }\n                 // ignore if its null, the service logs it\n                 if (handler != null) {\n-                    if (header.isError()) {\n-                        handlerResponseError(streamInput, handler);\n+                    final StreamInput streamInput;\n+                    if (message.getContentLength() > 0) {\n+                        streamInput = namedWriteableStream(message.openOrGetStreamInput());\n+                        assertRemoteVersion(streamInput, header.getVersion());\n+                        if (header.isError()) {\n+                            handlerResponseError(streamInput, handler);\n+                        } else {\n+                            handleResponse(remoteAddress, streamInput, handler);\n+                        }\n+                        // Check the entire message has been read\n+                        final int nextByte = streamInput.read();\n+                        // calling read() is useful to make sure the message is fully read, even if there is an EOS marker\n+                        if (nextByte != -1) {\n+                            throw new IllegalStateException(\"Message not fully read (response) for requestId [\"\n+                                + requestId + \"], handler [\" + handler + \"], error [\" + header.isError()\n+                                + \"]; resetting\");\n+                        }\n                     } else {\n-                        handleResponse(remoteAddress, streamInput, handler);\n-                    }\n-                    // Check the entire message has been read\n-                    final int nextByte = streamInput.read();\n-                    // calling read() is useful to make sure the message is fully read, even if there is an EOS marker\n-                    if (nextByte != -1) {\n-                        throw new IllegalStateException(\"Message not fully read (response) for requestId [\" + requestId + \"], handler [\"\n-                            + handler + \"], error [\" + header.isError() + \"]; resetting\");\n+                        assert header.isError() == false;\n+                        handleResponse(remoteAddress, EMPTY_STREAM_INPUT, handler);", "originalCommit": "f418bcdddb643df3f1442fea3587f3ee16ccf8b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgwOTc5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/60865#discussion_r467809797", "bodyText": "Yea that was a little lazy on my end, I couldn't find a case where we ever moved from an empty message to a non-empty one but that doesn't mean that won't happen in the future. I adjusted the logic accordingly to use an empty stream per thread.", "author": "original-brownbear", "createdAt": "2020-08-10T10:17:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwNTQ1Nw=="}], "type": "inlineReview"}, {"oid": "be76b310a00eef2bb5da69f4db642ba3e8b630c9", "url": "https://github.com/elastic/elasticsearch/commit/be76b310a00eef2bb5da69f4db642ba3e8b630c9", "message": "revert stuff", "committedDate": "2020-08-10T09:45:14Z", "type": "commit"}, {"oid": "1de973aebba994df23dea36067f9ad6100e090c6", "url": "https://github.com/elastic/elasticsearch/commit/1de973aebba994df23dea36067f9ad6100e090c6", "message": "Merge remote-tracking branch 'elastic/master' into random-optimizations", "committedDate": "2020-08-10T09:45:18Z", "type": "commit"}, {"oid": "a4c2391925b94af674d3de444d6a38bab6f4e9d4", "url": "https://github.com/elastic/elasticsearch/commit/a4c2391925b94af674d3de444d6a38bab6f4e9d4", "message": "revert stuff", "committedDate": "2020-08-10T09:49:28Z", "type": "commit"}, {"oid": "b4a3ac29b5ce9e48b9718587f855ab65680a42ae", "url": "https://github.com/elastic/elasticsearch/commit/b4a3ac29b5ce9e48b9718587f855ab65680a42ae", "message": "bwc", "committedDate": "2020-08-10T10:12:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgxNzM2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/60865#discussion_r467817369", "bodyText": "I think I'd have just done this rather than introducing thread-locals here, and mixed-version clusters be (slightly) damned.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (message.getContentLength() > 0) {\n          \n          \n            \n                                if (message.getContentLength() > 0 || header.getVersion().equals(Version.CURRENT) == false) {\n          \n      \n    \n    \n  \n\nWhat you've got looks ok as long as we don't refactor the deserialisation onto a different thread at some point in the future, but that's going to be a tricky bug to track down if ever we do so... \ud83d\ude01", "author": "DaveCTurner", "createdAt": "2020-08-10T10:34:25Z", "path": "server/src/main/java/org/elasticsearch/transport/InboundHandler.java", "diffHunk": "@@ -111,18 +120,29 @@ private void messageReceived(TcpChannel channel, InboundMessage message) throws\n                 }\n                 // ignore if its null, the service logs it\n                 if (handler != null) {\n-                    if (header.isError()) {\n-                        handlerResponseError(streamInput, handler);\n+                    final StreamInput streamInput;\n+                    if (message.getContentLength() > 0) {", "originalCommit": "b4a3ac29b5ce9e48b9718587f855ab65680a42ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgyMTM2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/60865#discussion_r467821366", "bodyText": "Yea but that's the least of my worries in that case :D (we already make a million assumptions that assume we never escape the stream from the current thread with the way we release the paged bytes).\nPlus, I tried moving the deserialization off the IO thread in #50138 with pretty mixed results performance wise (it's the same reason we moved the serialization onto the IO loop, we just waste a ton of buffers if we deserialize later, which really hurts with 16k+ page sizes).", "author": "original-brownbear", "createdAt": "2020-08-10T10:43:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgxNzM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgyMjg0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/60865#discussion_r467822849", "bodyText": "I think I'd have just done this rather than introducing thread-locals here, and mixed-version clusters be (slightly) damned.\n\nYea that's better, applied your suggestion :)", "author": "original-brownbear", "createdAt": "2020-08-10T10:47:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgxNzM2OQ=="}], "type": "inlineReview"}, {"oid": "03708fa89833f4923d705baf4389f8c59f34f1ae", "url": "https://github.com/elastic/elasticsearch/commit/03708fa89833f4923d705baf4389f8c59f34f1ae", "message": "CR: - thread-local", "committedDate": "2020-08-10T10:46:36Z", "type": "commit"}, {"oid": "9f1df436fa589329887deb76264e37c7a5ba0ed2", "url": "https://github.com/elastic/elasticsearch/commit/9f1df436fa589329887deb76264e37c7a5ba0ed2", "message": "OR", "committedDate": "2020-08-10T10:49:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgzODcxMw==", "url": "https://github.com/elastic/elasticsearch/pull/60865#discussion_r473838713", "bodyText": "This change means that the timeout starts counting from the first retry, rather than from the start of execution of the action. I think we should adjust the timeout to account for this since this retry might be happening a long time later.", "author": "DaveCTurner", "createdAt": "2020-08-20T10:01:20Z", "path": "server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java", "diffHunk": "@@ -201,7 +193,15 @@ public void handleException(final TransportException exp) {\n             }\n         }\n \n-        private void retry(final Throwable failure, final Predicate<ClusterState> statePredicate) {\n+        private void retryOnMasterChange(ClusterState state, Throwable failure) {\n+            retry(state, failure, MasterNodeChangePredicate.build(state));\n+        }\n+\n+        private void retry(ClusterState state, final Throwable failure, final Predicate<ClusterState> statePredicate) {\n+            if (observer == null) {\n+                this.observer =\n+                    new ClusterStateObserver(state, clusterService, request.masterNodeTimeout(), logger, threadPool.getThreadContext());", "originalCommit": "9f1df436fa589329887deb76264e37c7a5ba0ed2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk1MTYxNw==", "url": "https://github.com/elastic/elasticsearch/pull/60865#discussion_r473951617", "bodyText": "Fair point, I pushed 29806e8 :)", "author": "original-brownbear", "createdAt": "2020-08-20T13:02:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgzODcxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg0MDg0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/60865#discussion_r473840847", "bodyText": "\ud83d\udc4d we can always bring this back later if we need it again", "author": "DaveCTurner", "createdAt": "2020-08-20T10:03:59Z", "path": "server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java", "diffHunk": "@@ -224,12 +224,4 @@ public void onTimeout(TimeValue timeout) {\n                 }, statePredicate);\n         }\n     }\n-\n-    /**\n-     * Allows to conditionally return a different master node action name in the case an action gets renamed.\n-     * This mainly for backwards compatibility should be used rarely\n-     */\n-    protected String getMasterActionName(DiscoveryNode node) {\n-        return actionName;", "originalCommit": "9f1df436fa589329887deb76264e37c7a5ba0ed2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2c5c8c2daa4df89e30224bb1026cba48fc3b7603", "url": "https://github.com/elastic/elasticsearch/commit/2c5c8c2daa4df89e30224bb1026cba48fc3b7603", "message": "Merge remote-tracking branch 'elastic/master' into random-optimizations", "committedDate": "2020-08-20T12:26:55Z", "type": "commit"}, {"oid": "29806e8cc5b4129c3d1705eb73cccf4c142066a5", "url": "https://github.com/elastic/elasticsearch/commit/29806e8cc5b4129c3d1705eb73cccf4c142066a5", "message": "CR: cleaner timeout handling", "committedDate": "2020-08-20T13:01:45Z", "type": "commit"}]}