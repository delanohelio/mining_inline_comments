{"pr_number": 59667, "pr_title": "Use different G1GC options for small heaps", "pr_createdAt": "2020-07-15T20:50:17Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59667", "timeline": [{"oid": "7d987ba1425e9a8a13efb7b3527c2d0c6a92a55c", "url": "https://github.com/elastic/elasticsearch/commit/7d987ba1425e9a8a13efb7b3527c2d0c6a92a55c", "message": "Use the parallel collector for small heaps\n\n    Our benchmarks have demonstrated that Elasticsearch performs better with\n    the parallel collector than with the default G1 collector when the heap\n    size is small. With this commit we ergonomically choose the parallel\n    collector for heap sizes smaller than (and including) 4GB and turn real\n    memory circuit breaker off when running with  ParallelGC.\nCo-authored-by: Evgenia Badiyanova <evgenia.badiyanova@elastic.co>\nCo-authored-by: Daniel Mitterdorfer <daniel.mitterdorfer@elastic.co>", "committedDate": "2020-07-15T20:48:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM0NTIzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r455345239", "bodyText": "Drive by comment (sorry!), but the comment in jvm.options would be incorrect after this change, since the user would no longer be uncommenting the lines to use G1", "author": "dakrone", "createdAt": "2020-07-15T21:06:18Z", "path": "distribution/src/config/jvm.options", "diffHunk": "@@ -42,7 +42,6 @@\n # following three lines to your version of the JDK", "originalCommit": "7d987ba1425e9a8a13efb7b3527c2d0c6a92a55c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY0OTY3MA==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r461649670", "bodyText": "hmm, I wonder what we want to add instead.. we want to users to be able to use G1GC before jdk 14, but if they specifically add -XX:+UseG1GC the ergonomics choice won't kick in..", "author": "ebadyano", "createdAt": "2020-07-28T14:57:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM0NTIzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1MjEyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r461752125", "bodyText": "Isn't the point fo the change to make ergonomics choose which GC to use? It doesn't just have to be based on small heaps, it can be based on java version as well?", "author": "rjernst", "createdAt": "2020-07-28T17:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM0NTIzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxNDYzMg==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r462514632", "bodyText": "I updated the jvm.options, any comments/thoughts are welcome!", "author": "ebadyano", "createdAt": "2020-07-29T18:50:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM0NTIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMxMjg0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r459312846", "bodyText": "Drive-by comment, feel free to ignore - should we pass Pattern.COMMENTS here so that we can break up the regex with whitespace, to make it easier to read?", "author": "pugnascotia", "createdAt": "2020-07-23T09:07:30Z", "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/JvmErgonomics.java", "diffHunk": "@@ -53,25 +53,53 @@ private JvmErgonomics() {\n      */\n     static List<String> choose(final List<String> userDefinedJvmOptions) throws InterruptedException, IOException {\n         final List<String> ergonomicChoices = new ArrayList<>();\n-        final Map<String, Optional<String>> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n+        final Map<String, JvmOption> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n         final long heapSize = extractHeapSize(finalJvmOptions);\n         final long maxDirectMemorySize = extractMaxDirectMemorySize(finalJvmOptions);\n         if (maxDirectMemorySize == 0) {\n             ergonomicChoices.add(\"-XX:MaxDirectMemorySize=\" + heapSize / 2);\n         }\n+        // Use ParallelGC for heaps <= 4GB unless the user has explicitly set the garbage collector\n+        JvmOption g1 = finalJvmOptions.get(\"UseG1GC\");\n+        if (heapSize <= 4 * 1024 * 1024 * 1024 && g1.getMandatoryValue().equals(\"true\") && g1.isCommandLineOrigin() == false) {\n+            ergonomicChoices.add(\"-XX:+UseParallelGC\");\n+        }\n+        System.out.println(\"HEre inn\");\n         return ergonomicChoices;\n     }\n \n     private static final Pattern OPTION = Pattern.compile(\n-        \"^\\\\s*\\\\S+\\\\s+(?<flag>\\\\S+)\\\\s+:?=\\\\s+(?<value>\\\\S+)?\\\\s+\\\\{[^}]+?\\\\}\\\\s+\\\\{[^}]+}\"\n+        \"^\\\\s*\\\\S+\\\\s+(?<flag>\\\\S+)\\\\s+:?=\\\\s+(?<value>\\\\S+)?\\\\s+\\\\{[^}]+?\\\\}\\\\s+\\\\{(?<origin>[^}]+)}\"", "originalCommit": "7d987ba1425e9a8a13efb7b3527c2d0c6a92a55c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3MTg2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r457671865", "bodyText": "Can we use Booleans.parseBoolean? Also, please use == false for negation.", "author": "rjernst", "createdAt": "2020-07-20T20:27:12Z", "path": "server/src/main/java/org/elasticsearch/indices/breaker/HierarchyCircuitBreakerService.java", "diffHunk": "@@ -69,7 +69,10 @@\n     private final Map<String, CircuitBreaker> breakers;\n \n     public static final Setting<Boolean> USE_REAL_MEMORY_USAGE_SETTING =\n-        Setting.boolSetting(\"indices.breaker.total.use_real_memory\", true, Property.NodeScope);\n+        Setting.boolSetting(\"indices.breaker.total.use_real_memory\", settings -> {\n+            // turn real memory circuit breaker off for ParallelGC\n+            return String.valueOf(!JvmInfo.jvmInfo().useParallelGC().equals(\"true\"));", "originalCommit": "7d987ba1425e9a8a13efb7b3527c2d0c6a92a55c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ab6059d28d8b14f2c7ed2ef7b1abfa50df9effa9", "url": "https://github.com/elastic/elasticsearch/commit/ab6059d28d8b14f2c7ed2ef7b1abfa50df9effa9", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc", "committedDate": "2020-07-28T23:48:10Z", "type": "commit"}, {"oid": "2655315881e80def2ac3dc30a29ee6b0523e0181", "url": "https://github.com/elastic/elasticsearch/commit/2655315881e80def2ac3dc30a29ee6b0523e0181", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc", "committedDate": "2020-07-29T13:34:03Z", "type": "commit"}, {"oid": "2003331d318cc37610d512c8c5f71e50913032a6", "url": "https://github.com/elastic/elasticsearch/commit/2003331d318cc37610d512c8c5f71e50913032a6", "message": "Addressed some comments and fixed tests.", "committedDate": "2020-07-29T18:48:41Z", "type": "commit"}, {"oid": "3c05949b26dc81ba7e26a0f772c4a84cefba73ec", "url": "https://github.com/elastic/elasticsearch/commit/3c05949b26dc81ba7e26a0f772c4a84cefba73ec", "message": "Fix precomit erorrs", "committedDate": "2020-07-29T23:51:49Z", "type": "commit"}, {"oid": "818226a63d0b78d1ac408b38b7dace41adabf5e0", "url": "https://github.com/elastic/elasticsearch/commit/818226a63d0b78d1ac408b38b7dace41adabf5e0", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc", "committedDate": "2020-07-30T00:24:19Z", "type": "commit"}, {"oid": "f14d2cdb234b3ed56a63dbeb269c28747b56d6e6", "url": "https://github.com/elastic/elasticsearch/commit/f14d2cdb234b3ed56a63dbeb269c28747b56d6e6", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc", "committedDate": "2020-07-31T16:18:55Z", "type": "commit"}, {"oid": "4d033a498deaf7081b1e93fb54dd0a273da753ee", "url": "https://github.com/elastic/elasticsearch/commit/4d033a498deaf7081b1e93fb54dd0a273da753ee", "message": "Fix test", "committedDate": "2020-07-31T16:19:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc0NDcyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r463744725", "bodyText": "won't these G1 options break the system if parallelGC is selected?", "author": "rjernst", "createdAt": "2020-07-31T17:43:36Z", "path": "distribution/src/config/jvm.options", "diffHunk": "@@ -38,13 +38,16 @@\n 8-13:-XX:+UseCMSInitiatingOccupancyOnly\n \n ## G1GC Configuration\n-# to use G1GC, uncomment the next two lines and update the version on the\n-# following three lines to your version of the JDK\n+# to use G1GC (ParallelGC for heaps smaller than 4G),\n+# uncomment the next three lines and update the version on the\n+# following two lines to your version of the JDK\n # 8-13:-XX:-UseConcMarkSweepGC\n # 8-13:-XX:-UseCMSInitiatingOccupancyOnly\n-14-:-XX:+UseG1GC\n 14-:-XX:G1ReservePercent=25", "originalCommit": "4d033a498deaf7081b1e93fb54dd0a273da753ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc3Njk0MA==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r463776940", "bodyText": "with -XX:+UseParallelGC java seem to ignore -XX:G1ReservePercent=25 and XX:InitiatingHeapOccupancyPercent  them as long as -XX:+UseG1GC is not specified. On the other hand it might be confusing to have G1GC options there when running ParallelGC.", "author": "ebadyano", "createdAt": "2020-07-31T18:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc0NDcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc4MzM0MA==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r463783340", "bodyText": "Have you tested if that is true for all G1 options? I wonder if we should completely move all GC options into ergonomics.", "author": "rjernst", "createdAt": "2020-07-31T19:09:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc0NDcyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg0MzkwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r464843909", "bodyText": "In #46751, a check is made purely against the parent breaker, relying on this being the real memory circuit breaker. This PR disables that PR by default for small heaps.\nI seem to remember seeing that approach (just checking the parent breaker, now that we have real memory circuit breaker) has come up a few times.", "author": "henningandersen", "createdAt": "2020-08-04T07:07:57Z", "path": "server/src/main/java/org/elasticsearch/indices/breaker/HierarchyCircuitBreakerService.java", "diffHunk": "@@ -69,7 +69,10 @@\n     private final Map<String, CircuitBreaker> breakers;\n \n     public static final Setting<Boolean> USE_REAL_MEMORY_USAGE_SETTING =\n-        Setting.boolSetting(\"indices.breaker.total.use_real_memory\", true, Property.NodeScope);\n+        Setting.boolSetting(\"indices.breaker.total.use_real_memory\", settings -> {\n+            // turn real memory circuit breaker off for ParallelGC\n+            return String.valueOf(Booleans.parseBoolean(JvmInfo.jvmInfo().useParallelGC()) == false);", "originalCommit": "4d033a498deaf7081b1e93fb54dd0a273da753ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9008ede953098e9ce1df646848f27880238270ec", "url": "https://github.com/elastic/elasticsearch/commit/9008ede953098e9ce1df646848f27880238270ec", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc", "committedDate": "2020-09-22T22:47:07Z", "type": "commit"}, {"oid": "d0e34fe0630ceb28e4370523cac174ca58cda87a", "url": "https://github.com/elastic/elasticsearch/commit/d0e34fe0630ceb28e4370523cac174ca58cda87a", "message": "Changed the ergonomics heuristic to use G1GC  with tuned options instead\nof ParallelGC", "committedDate": "2020-09-29T12:37:51Z", "type": "commit"}, {"oid": "70b4de9c0a15165532e92d3ebaf3645d99ccb1d9", "url": "https://github.com/elastic/elasticsearch/commit/70b4de9c0a15165532e92d3ebaf3645d99ccb1d9", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc", "committedDate": "2020-09-29T12:38:21Z", "type": "commit"}, {"oid": "a6f5302e8910fbf259854b1f9fe81a18d855b845", "url": "https://github.com/elastic/elasticsearch/commit/a6f5302e8910fbf259854b1f9fe81a18d855b845", "message": "fix precomit errors", "committedDate": "2020-09-29T15:17:04Z", "type": "commit"}, {"oid": "ffec016f0f63c877fdee1d12a288002db52731c0", "url": "https://github.com/elastic/elasticsearch/commit/ffec016f0f63c877fdee1d12a288002db52731c0", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc", "committedDate": "2020-09-29T15:48:21Z", "type": "commit"}, {"oid": "80b713b170e56d89a59ac4faa9755123e7505d59", "url": "https://github.com/elastic/elasticsearch/commit/80b713b170e56d89a59ac4faa9755123e7505d59", "message": "Fix precomit errors", "committedDate": "2020-09-29T16:01:40Z", "type": "commit"}, {"oid": "411cfd422de27ffe6eb1e406c1d105793f75bf75", "url": "https://github.com/elastic/elasticsearch/commit/411cfd422de27ffe6eb1e406c1d105793f75bf75", "message": "Fix indentation", "committedDate": "2020-10-01T14:19:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2MzM2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r498863361", "bodyText": "I think we should turn the heap size check into heapSize < 8L << 30, since java before version 15 will round the region size down, causing a 7.99GB heap to have a region size of 2MB.", "author": "henningandersen", "createdAt": "2020-10-02T14:39:20Z", "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/JvmErgonomics.java", "diffHunk": "@@ -116,12 +146,30 @@ private JvmErgonomics() {\n     }\n \n     // package private for testing\n-    static Long extractHeapSize(final Map<String, Optional<String>> finalJvmOptions) {\n-        return Long.parseLong(finalJvmOptions.get(\"MaxHeapSize\").get());\n+    static Long extractHeapSize(final Map<String, JvmOption> finalJvmOptions) {\n+        return Long.parseLong(finalJvmOptions.get(\"MaxHeapSize\").getMandatoryValue());\n+    }\n+\n+    static long extractMaxDirectMemorySize(final Map<String, JvmOption> finalJvmOptions) {\n+        return Long.parseLong(finalJvmOptions.get(\"MaxDirectMemorySize\").getMandatoryValue());\n+    }\n+\n+    // Tune G1GC options for heaps <= 4GB unless the user has explicitly set G1HeapRegionSize\n+    static boolean tuneG1GCForSmallHeap(final Map<String, JvmOption> finalJvmOptions, final long heapSize) {\n+        JvmOption g1GC = finalJvmOptions.get(\"UseG1GC\");\n+        JvmOption g1GCHeapRegion = finalJvmOptions.get(\"G1HeapRegionSize\");\n+        return (heapSize <= 4L << 30 && g1GC.getMandatoryValue().equals(\"true\") && g1GCHeapRegion.isCommandLineOrigin() == false);", "originalCommit": "411cfd422de27ffe6eb1e406c1d105793f75bf75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAzMDk5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r499030993", "bodyText": "Sorry missread the comment. Make sense, so the tuning options will be for heaps strictly smaller than 8G.", "author": "ebadyano", "createdAt": "2020-10-02T20:16:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2MzM2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg4MDcyMw==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r498880723", "bodyText": "As mentioned on another channel, I think we should make reserve pct 15 rather than the default 10 - to stay safely clear of real memory circuit breaker exceptions.\nI also think we should add in the IHOP always if it is not defined, just to be safe. It should not matter for performance since G1 will adaptively adjust the value.", "author": "henningandersen", "createdAt": "2020-10-02T15:07:32Z", "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/JvmErgonomics.java", "diffHunk": "@@ -53,25 +53,55 @@ private JvmErgonomics() {\n      */\n     static List<String> choose(final List<String> userDefinedJvmOptions) throws InterruptedException, IOException {\n         final List<String> ergonomicChoices = new ArrayList<>();\n-        final Map<String, Optional<String>> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n+        final Map<String, JvmOption> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n         final long heapSize = extractHeapSize(finalJvmOptions);\n         final long maxDirectMemorySize = extractMaxDirectMemorySize(finalJvmOptions);\n         if (maxDirectMemorySize == 0) {\n             ergonomicChoices.add(\"-XX:MaxDirectMemorySize=\" + heapSize / 2);\n         }\n+        final boolean tuneG1GCForSmallHeap = tuneG1GCForSmallHeap(finalJvmOptions, heapSize);\n+        final boolean tuneG1GCForLargeHeap = tuneG1GCForLargeHeap(finalJvmOptions, heapSize);\n+        if (tuneG1GCForSmallHeap) {\n+            ergonomicChoices.add(\"-XX:G1HeapRegionSize=4m\");", "originalCommit": "411cfd422de27ffe6eb1e406c1d105793f75bf75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk1ODY0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r498958646", "bodyText": "Since we are not choosing the actual GC implementation in ergonomics, doesn't this need to stay uncommented?", "author": "rjernst", "createdAt": "2020-10-02T17:37:26Z", "path": "distribution/src/config/jvm.options", "diffHunk": "@@ -42,9 +42,7 @@\n # following three lines to your version of the JDK\n # 8-13:-XX:-UseConcMarkSweepGC\n # 8-13:-XX:-UseCMSInitiatingOccupancyOnly\n-14-:-XX:+UseG1GC\n-14-:-XX:G1ReservePercent=25\n-14-:-XX:InitiatingHeapOccupancyPercent=30\n+# 14-:-XX:+UseG1GC", "originalCommit": "411cfd422de27ffe6eb1e406c1d105793f75bf75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk1OTY3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r498959672", "bodyText": "Or if we are relying on G1GC being the default now, then do we still need this line in the jvm options at all? Will the ergonomics detect using G1GC when it is not explicitly added to the options?", "author": "rjernst", "createdAt": "2020-10-02T17:39:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk1ODY0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTAyODMxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r499028315", "bodyText": "Thank you for catching this. I should've uncommented the line 14-:-XX:+UseG1GC. I think we still want to keep it uncommented in case someone wants to use G1GC with jdk older than jdk14. Then the comment above still makes sense.", "author": "ebadyano", "createdAt": "2020-10-02T20:10:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk1ODY0Ng=="}], "type": "inlineReview"}, {"oid": "ec2b8917bb3dd04759466ed6cc5c3a5aefabcb0c", "url": "https://github.com/elastic/elasticsearch/commit/ec2b8917bb3dd04759466ed6cc5c3a5aefabcb0c", "message": "Addressed Henning's and Ryan's comments.", "committedDate": "2020-10-02T20:32:07Z", "type": "commit"}, {"oid": "8d3c734c0d21861f2fc11f3ec0baa994e8d2dee6", "url": "https://github.com/elastic/elasticsearch/commit/8d3c734c0d21861f2fc11f3ec0baa994e8d2dee6", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc", "committedDate": "2020-10-02T23:25:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgxMTE2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r499811163", "bodyText": "I think we should use 30 in this case too.", "author": "henningandersen", "createdAt": "2020-10-05T19:06:34Z", "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/JvmErgonomics.java", "diffHunk": "@@ -53,25 +53,57 @@ private JvmErgonomics() {\n      */\n     static List<String> choose(final List<String> userDefinedJvmOptions) throws InterruptedException, IOException {\n         final List<String> ergonomicChoices = new ArrayList<>();\n-        final Map<String, Optional<String>> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n+        final Map<String, JvmOption> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n         final long heapSize = extractHeapSize(finalJvmOptions);\n         final long maxDirectMemorySize = extractMaxDirectMemorySize(finalJvmOptions);\n         if (maxDirectMemorySize == 0) {\n             ergonomicChoices.add(\"-XX:MaxDirectMemorySize=\" + heapSize / 2);\n         }\n+        final boolean tuneG1GCForSmallHeap = tuneG1GCForSmallHeap(finalJvmOptions, heapSize);\n+        final boolean tuneG1GCForLargeHeap = tuneG1GCForLargeHeap(finalJvmOptions, heapSize);\n+        if (tuneG1GCForSmallHeap) {\n+            ergonomicChoices.add(\"-XX:G1HeapRegionSize=4m\");\n+            ergonomicChoices.add(\"-XX:G1ReservePercent=15\");\n+            ergonomicChoices.add(\"-XX:InitiatingHeapOccupancyPercent=45\");", "originalCommit": "8d3c734c0d21861f2fc11f3ec0baa994e8d2dee6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgxNTc3NA==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r499815774", "bodyText": "I think it is surprising that if you manually specify any of the 3 parameters you loose all 3. For instance if they decide to raise G1ReservePercent to 20, the region size adjustment is lost.\nI think the check in tuneG1GCForSmallHeap should only check heap size and maybe that G1 is in use.\nThe code below should then only add options where there is no existing command line origin option.\nAlternatively (to the last part), we could swap the two lines here:\n\n  \n    \n      elasticsearch/distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/JvmOptionsParser.java\n    \n    \n         Line 144\n      in\n      01dc110\n    \n    \n    \n    \n\n        \n          \n           finalJvmOptions.addAll(substitutedJvmOptions); \n        \n    \n  \n\n\nto be:\n        finalJvmOptions.addAll(ergonomicJvmOptions);\n        finalJvmOptions.addAll(substitutedJvmOptions);\n\nsince that would ensure that the original command line options override the ergonomics picked here.", "author": "henningandersen", "createdAt": "2020-10-05T19:15:26Z", "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/JvmErgonomics.java", "diffHunk": "@@ -53,25 +53,57 @@ private JvmErgonomics() {\n      */\n     static List<String> choose(final List<String> userDefinedJvmOptions) throws InterruptedException, IOException {\n         final List<String> ergonomicChoices = new ArrayList<>();\n-        final Map<String, Optional<String>> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n+        final Map<String, JvmOption> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n         final long heapSize = extractHeapSize(finalJvmOptions);\n         final long maxDirectMemorySize = extractMaxDirectMemorySize(finalJvmOptions);\n         if (maxDirectMemorySize == 0) {\n             ergonomicChoices.add(\"-XX:MaxDirectMemorySize=\" + heapSize / 2);\n         }\n+        final boolean tuneG1GCForSmallHeap = tuneG1GCForSmallHeap(finalJvmOptions, heapSize);\n+        final boolean tuneG1GCForLargeHeap = tuneG1GCForLargeHeap(finalJvmOptions, heapSize);\n+        if (tuneG1GCForSmallHeap) {", "originalCommit": "8d3c734c0d21861f2fc11f3ec0baa994e8d2dee6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgxNjMxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r499816319", "bodyText": "Same comment as above, is surprising that if one of them is specified you loose the other. In particular if IHOP is specified, it seems quite dangerous to no longer set G1ReservePercent.", "author": "henningandersen", "createdAt": "2020-10-05T19:16:28Z", "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/JvmErgonomics.java", "diffHunk": "@@ -53,25 +53,57 @@ private JvmErgonomics() {\n      */\n     static List<String> choose(final List<String> userDefinedJvmOptions) throws InterruptedException, IOException {\n         final List<String> ergonomicChoices = new ArrayList<>();\n-        final Map<String, Optional<String>> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n+        final Map<String, JvmOption> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n         final long heapSize = extractHeapSize(finalJvmOptions);\n         final long maxDirectMemorySize = extractMaxDirectMemorySize(finalJvmOptions);\n         if (maxDirectMemorySize == 0) {\n             ergonomicChoices.add(\"-XX:MaxDirectMemorySize=\" + heapSize / 2);\n         }\n+        final boolean tuneG1GCForSmallHeap = tuneG1GCForSmallHeap(finalJvmOptions, heapSize);\n+        final boolean tuneG1GCForLargeHeap = tuneG1GCForLargeHeap(finalJvmOptions, heapSize);\n+        if (tuneG1GCForSmallHeap) {\n+            ergonomicChoices.add(\"-XX:G1HeapRegionSize=4m\");\n+            ergonomicChoices.add(\"-XX:G1ReservePercent=15\");\n+            ergonomicChoices.add(\"-XX:InitiatingHeapOccupancyPercent=45\");\n+        } else if (tuneG1GCForLargeHeap) {", "originalCommit": "8d3c734c0d21861f2fc11f3ec0baa994e8d2dee6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg1NDg2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r499854866", "bodyText": "Thank you for catching this, I updated the pr.", "author": "ebadyano", "createdAt": "2020-10-05T20:31:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgxNjMxOQ=="}], "type": "inlineReview"}, {"oid": "ac9a5686bfe5c1b475a72d9f13ca8ce12e27905c", "url": "https://github.com/elastic/elasticsearch/commit/ac9a5686bfe5c1b475a72d9f13ca8ce12e27905c", "message": "Address Henning's comments", "committedDate": "2020-10-05T20:16:03Z", "type": "commit"}, {"oid": "f326f5ba3c5f0811dd7ee6bde8f999c19638b028", "url": "https://github.com/elastic/elasticsearch/commit/f326f5ba3c5f0811dd7ee6bde8f999c19638b028", "message": "address Henning's comments", "committedDate": "2020-10-05T20:27:02Z", "type": "commit"}, {"oid": "5ddb619f1a2a3d9d0b1b2997485e48cd211b6d9f", "url": "https://github.com/elastic/elasticsearch/commit/5ddb619f1a2a3d9d0b1b2997485e48cd211b6d9f", "message": "Fix tests", "committedDate": "2020-10-05T20:41:31Z", "type": "commit"}, {"oid": "d628ff90dba6492fca680c3523bcd2b973ac03d8", "url": "https://github.com/elastic/elasticsearch/commit/d628ff90dba6492fca680c3523bcd2b973ac03d8", "message": "Fix precommit tests", "committedDate": "2020-10-05T20:59:33Z", "type": "commit"}, {"oid": "d8a38403c2a5e213367eb1a64ea6bcfac05d1163", "url": "https://github.com/elastic/elasticsearch/commit/d8a38403c2a5e213367eb1a64ea6bcfac05d1163", "message": "Fix logic", "committedDate": "2020-10-05T21:19:51Z", "type": "commit"}, {"oid": "f2e999acdaf1a27117a30636b026d1c277b2edb0", "url": "https://github.com/elastic/elasticsearch/commit/f2e999acdaf1a27117a30636b026d1c277b2edb0", "message": "Add an extra test for when non G1GC policy is set", "committedDate": "2020-10-06T14:15:36Z", "type": "commit"}]}