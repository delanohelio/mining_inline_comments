{"pr_number": 58352, "pr_title": "Create utility for custom config setup in packaging tests", "pr_createdAt": "2020-06-18T19:12:27Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58352", "timeline": [{"oid": "6a856290effe14f19deb169fa7f1ad371a8147e3", "url": "https://github.com/elastic/elasticsearch/commit/6a856290effe14f19deb169fa7f1ad371a8147e3", "message": "Create utility for custom config setup in packaging tests\n\nThis commit creates a shared withCustomConfig method that may be used by\nany packaging test. The method will copy the config directory and\noverride the conf path appropriately depending on the distribution type.", "committedDate": "2020-06-18T19:10:06Z", "type": "commit"}, {"oid": "6ec7ce275a1cf63206b3da635db7e1eed9fd768e", "url": "https://github.com/elastic/elasticsearch/commit/6ec7ce275a1cf63206b3da635db7e1eed9fd768e", "message": "remove imports", "committedDate": "2020-06-18T19:20:58Z", "type": "commit"}, {"oid": "336cc6a00de54067ddfb383d737f0abfe8cb888e", "url": "https://github.com/elastic/elasticsearch/commit/336cc6a00de54067ddfb383d737f0abfe8cb888e", "message": "adjust expected heap bytes", "committedDate": "2020-06-18T21:10:02Z", "type": "commit"}, {"oid": "6e39eb345d0c005c9620dfe71dcf04b0c13daeab", "url": "https://github.com/elastic/elasticsearch/commit/6e39eb345d0c005c9620dfe71dcf04b0c13daeab", "message": "oops", "committedDate": "2020-06-18T22:07:27Z", "type": "commit"}, {"oid": "74e9e0a537883836cada8e0c746dddc36c4e5589", "url": "https://github.com/elastic/elasticsearch/commit/74e9e0a537883836cada8e0c746dddc36c4e5589", "message": "another oops", "committedDate": "2020-06-19T05:40:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3NDcyOA==", "url": "https://github.com/elastic/elasticsearch/pull/58352#discussion_r444074728", "bodyText": "The previous implementation of the withCustomConfig method in PackageTests.java used exception handling to ensure that the cleanup / restore steps where always carried out. I'm curious about why this method isn't doing that?", "author": "pugnascotia", "createdAt": "2020-06-23T09:04:18Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/test/PackagingTestCase.java", "diffHunk": "@@ -392,4 +394,32 @@ public static Path createTempDir(String prefix) throws IOException {\n         return Files.createTempDirectory(getRootTempDir(), prefix, NEW_DIR_PERMS);\n     }\n \n+    @FunctionalInterface\n+    public interface ThrowingConsumer<T> {\n+        void accept(T t) throws Exception;\n+    }\n+\n+    public void withCustomConfig(ThrowingConsumer<Path> action) throws Exception {\n+        Path tempDir = Files.createTempDirectory(getRootTempDir(), \"custom-config\");\n+        Path tempConf = tempDir.resolve(\"elasticsearch\");\n+        FileUtils.copyDirectory(installation.config, tempConf);\n+\n+        Platforms.onLinux(() -> sh.run(\"chown -R elasticsearch:elasticsearch \" + tempDir));\n+\n+        if (distribution.isPackage()) {\n+            Files.copy(installation.envFile, tempDir.resolve(\"elasticsearch.bk\"));// backup\n+            append(installation.envFile, \"ES_PATH_CONF=\" + tempConf + \"\\n\");\n+        } else {\n+            sh.getEnv().put(\"ES_PATH_CONF\", tempConf.toString());\n+        }\n+\n+        action.accept(tempConf);", "originalCommit": "74e9e0a537883836cada8e0c746dddc36c4e5589", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMxODI5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/58352#discussion_r444318299", "bodyText": "I don't think we need this type of exception handling at all, since the tests are single threaded, and all test execution stops once a test failure is found. So there is no reason to restore the state, since the exception means the test will have failed, and in fact restoring the state could make diagnosing the failure more difficult.", "author": "rjernst", "createdAt": "2020-06-23T15:35:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3NDcyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3NjkzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/58352#discussion_r444076939", "bodyText": "We probabaly don't want to move this interface, since it's only being used in this file, but a possible alternative home would be libs/core/src/main/java/org/elasticsearch/common, since we already have CheckedFunction and CheckedRunnable in there.", "author": "pugnascotia", "createdAt": "2020-06-23T09:08:06Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/test/PackagingTestCase.java", "diffHunk": "@@ -392,4 +394,32 @@ public static Path createTempDir(String prefix) throws IOException {\n         return Files.createTempDirectory(getRootTempDir(), prefix, NEW_DIR_PERMS);\n     }\n \n+    @FunctionalInterface\n+    public interface ThrowingConsumer<T> {", "originalCommit": "74e9e0a537883836cada8e0c746dddc36c4e5589", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMyMzUzMg==", "url": "https://github.com/elastic/elasticsearch/pull/58352#discussion_r444323532", "bodyText": "We had CheckedConsumer in server, but I've now moved it to elasticsearch-core lib.", "author": "rjernst", "createdAt": "2020-06-23T15:43:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3NjkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3Nzc5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/58352#discussion_r444077791", "bodyText": "I would appreciate adding Javadoc here.", "author": "pugnascotia", "createdAt": "2020-06-23T09:09:29Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/test/PackagingTestCase.java", "diffHunk": "@@ -392,4 +394,32 @@ public static Path createTempDir(String prefix) throws IOException {\n         return Files.createTempDirectory(getRootTempDir(), prefix, NEW_DIR_PERMS);\n     }\n \n+    @FunctionalInterface\n+    public interface ThrowingConsumer<T> {\n+        void accept(T t) throws Exception;\n+    }\n+\n+    public void withCustomConfig(ThrowingConsumer<Path> action) throws Exception {", "originalCommit": "74e9e0a537883836cada8e0c746dddc36c4e5589", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1bc894188677218795f5db84fd76e7ca18131b21", "url": "https://github.com/elastic/elasticsearch/commit/1bc894188677218795f5db84fd76e7ca18131b21", "message": "address feedback", "committedDate": "2020-06-23T15:45:49Z", "type": "commit"}, {"oid": "17890c9095c9daa87b9c35832e9353cf3f87cd37", "url": "https://github.com/elastic/elasticsearch/commit/17890c9095c9daa87b9c35832e9353cf3f87cd37", "message": "typo", "committedDate": "2020-06-23T20:32:24Z", "type": "commit"}]}