{"pr_number": 60070, "pr_title": "Set timeout of master node requests on follower to unbounded", "pr_createdAt": "2020-07-22T17:20:52Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60070", "timeline": [{"oid": "42a308e4bc9b50ac19534ab7c21af42891820656", "url": "https://github.com/elastic/elasticsearch/commit/42a308e4bc9b50ac19534ab7c21af42891820656", "message": "Set timeout of master node requests on follower to unbounded", "committedDate": "2020-07-22T17:13:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI1MDA3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/60070#discussion_r459250072", "bodyText": "Should we add this to CcrRequests.putMappingRequest instead? There is one other caller of that method that does something similar (setting it to 30 minutes, mainly because that felt like \"unbounded\" at the time)", "author": "ywelsch", "createdAt": "2020-07-23T07:00:53Z", "path": "x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowTasksExecutor.java", "diffHunk": "@@ -158,7 +181,8 @@ protected void innerUpdateMapping(long minRequiredMappingVersion, LongConsumer h\n                             return;\n                         }\n                         MappingMetadata mappingMetadata = indexMetadata.mapping();\n-                        PutMappingRequest putMappingRequest = CcrRequests.putMappingRequest(followerIndex.getName(), mappingMetadata);\n+                        PutMappingRequest putMappingRequest = CcrRequests.putMappingRequest(followerIndex.getName(), mappingMetadata)\n+                            .masterNodeTimeout(UNBOUNDED_TIMEOUT);", "originalCommit": "42a308e4bc9b50ac19534ab7c21af42891820656", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU5NDUyMg==", "url": "https://github.com/elastic/elasticsearch/pull/60070#discussion_r459594522", "bodyText": "++. Adjusted in 6ad4d4f.", "author": "dnhatn", "createdAt": "2020-07-23T16:58:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI1MDA3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI1MTEyMA==", "url": "https://github.com/elastic/elasticsearch/pull/60070#discussion_r459251120", "bodyText": "Instead of checking this here, could we add a transport interceptor in the CCR IT tests that asserts the same thing?", "author": "ywelsch", "createdAt": "2020-07-23T07:03:43Z", "path": "x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowTasksExecutor.java", "diffHunk": "@@ -137,7 +144,23 @@ protected AllocatedPersistentTask createTask(long id, String type, String action\n                                                  PersistentTasksCustomMetadata.PersistentTask<ShardFollowTask> taskInProgress,\n                                                  Map<String, String> headers) {\n         ShardFollowTask params = taskInProgress.getParams();\n-        Client followerClient = wrapClient(client, params.getHeaders());\n+        final Client followerClient;\n+        if (Assertions.ENABLED) {\n+            followerClient = new FilterClient(wrapClient(client, params.getHeaders())) {\n+                @Override\n+                protected <Request extends ActionRequest, Response extends ActionResponse>\n+                void doExecute(ActionType<Response> action, Request request, ActionListener<Response> listener) {\n+                    if (request instanceof MasterNodeRequest) {\n+                        final TimeValue masterTimeout = ((MasterNodeRequest<?>) request).masterNodeTimeout();\n+                        assert masterTimeout.nanos() == Long.MAX_VALUE :", "originalCommit": "42a308e4bc9b50ac19534ab7c21af42891820656", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU5NDQwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/60070#discussion_r459594401", "bodyText": "ok, I've moved this check to tests. See de4fc61.", "author": "dnhatn", "createdAt": "2020-07-23T16:58:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI1MTEyMA=="}], "type": "inlineReview"}, {"oid": "6ad4d4fd4584485b7312bc0ec4f7e03e7af64082", "url": "https://github.com/elastic/elasticsearch/commit/6ad4d4fd4584485b7312bc0ec4f7e03e7af64082", "message": "move timeout for requests", "committedDate": "2020-07-23T16:14:09Z", "type": "commit"}, {"oid": "de4fc6153915034a1b6cbcfb82b0a205342fed46", "url": "https://github.com/elastic/elasticsearch/commit/de4fc6153915034a1b6cbcfb82b0a205342fed46", "message": "add validation in tests instead", "committedDate": "2020-07-23T16:47:52Z", "type": "commit"}, {"oid": "a8845591e074d1cdb7552c895db71adb66d1a376", "url": "https://github.com/elastic/elasticsearch/commit/a8845591e074d1cdb7552c895db71adb66d1a376", "message": "Merge branch 'master' into ccr-request-unbounded", "committedDate": "2020-07-23T18:49:07Z", "type": "commit"}, {"oid": "3909afdb8dbc67bf59793d46e1d7d50520d6be9f", "url": "https://github.com/elastic/elasticsearch/commit/3909afdb8dbc67bf59793d46e1d7d50520d6be9f", "message": "set timeout for requests used in tests", "committedDate": "2020-07-25T00:56:47Z", "type": "commit"}]}