{"pr_number": 54752, "pr_title": "[ML] inference only persist if there are stats", "pr_createdAt": "2020-04-03T20:07:01Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54752", "timeline": [{"oid": "6fe842c9b4f6c9d19164a32cf8745f40b88de693", "url": "https://github.com/elastic/elasticsearch/commit/6fe842c9b4f6c9d19164a32cf8745f40b88de693", "message": "[ML] only persist if there are stats", "committedDate": "2020-04-03T20:06:48Z", "type": "commit"}, {"oid": "93872143be4d9c3e2535ac533efd50be58a57de5", "url": "https://github.com/elastic/elasticsearch/commit/93872143be4d9c3e2535ac533efd50be58a57de5", "message": "Merge branch 'master' into feature/ml-inference-only-persist-if-there-are-stats", "committedDate": "2020-04-03T20:16:12Z", "type": "commit"}, {"oid": "eb77503ab4f54f732df6ebaf0c5abe8186d955c2", "url": "https://github.com/elastic/elasticsearch/commit/eb77503ab4f54f732df6ebaf0c5abe8186d955c2", "message": "removing unecessary assertions", "committedDate": "2020-04-03T20:43:04Z", "type": "commit"}, {"oid": "24085b098a9cb37d3a8a3b12d71488b26b561092", "url": "https://github.com/elastic/elasticsearch/commit/24085b098a9cb37d3a8a3b12d71488b26b561092", "message": "Merge branch 'feature/ml-inference-only-persist-if-there-are-stats' of github.com:benwtrent/elasticsearch into feature/ml-inference-only-persist-if-there-are-stats", "committedDate": "2020-04-03T20:43:28Z", "type": "commit"}, {"oid": "d4637a1269d5c92acd7fad5d54447f2d5b38693a", "url": "https://github.com/elastic/elasticsearch/commit/d4637a1269d5c92acd7fad5d54447f2d5b38693a", "message": "Merge remote-tracking branch 'upstream/master' into feature/ml-inference-only-persist-if-there-are-stats", "committedDate": "2020-04-13T11:40:20Z", "type": "commit"}, {"oid": "c1933bf9a0f7e1582cf68275083ff1926f2f21f7", "url": "https://github.com/elastic/elasticsearch/commit/c1933bf9a0f7e1582cf68275083ff1926f2f21f7", "message": "fixing test, timestamp calculation, concurrency", "committedDate": "2020-04-13T13:32:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4MjIzMw==", "url": "https://github.com/elastic/elasticsearch/pull/54752#discussion_r407482233", "bodyText": "Is it possible for timestamp to be an invalid number here?", "author": "dimitris-athanasiou", "createdAt": "2020-04-13T13:38:41Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/persistence/TrainedModelProvider.java", "diffHunk": "@@ -550,7 +551,9 @@ private InferenceStats handleMultiNodeStatsResponse(SearchResponse response, Str\n             failures == null ? 0L : Double.valueOf(failures.getValue()).longValue(),\n             modelId,\n             null,\n-            timeStamp == null ? Instant.now() : Instant.ofEpochMilli(Double.valueOf(timeStamp.getValue()).longValue())\n+            timeStamp == null || (Numbers.isValidDouble(timeStamp.getValue()) == false) ?", "originalCommit": "c1933bf9a0f7e1582cf68275083ff1926f2f21f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4Mzg0MA==", "url": "https://github.com/elastic/elasticsearch/pull/54752#discussion_r407483840", "bodyText": "Yes, it is. The agg could have not found any values, or the values they found were changed somehow. This type of check is effectively what aggs do under the hood when they serialize to JSON to protect against goofy doubles. The difference here is that we write out now() instead of null", "author": "benwtrent", "createdAt": "2020-04-13T13:42:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4MjIzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4NzEzMw==", "url": "https://github.com/elastic/elasticsearch/pull/54752#discussion_r407487133", "bodyText": "Are we missing InferenceStats.MISSING_ALL_FIELDS_COUNT here?", "author": "dimitris-athanasiou", "createdAt": "2020-04-13T13:49:07Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/TrainedModelStatsService.java", "diffHunk": "@@ -47,12 +48,16 @@\n     private static final Logger logger = LogManager.getLogger(TrainedModelStatsService.class);\n     private static final TimeValue PERSISTENCE_INTERVAL = TimeValue.timeValueSeconds(1);\n \n+    private static final String STATS_UPDATE_SCRIPT_TEMPLATE = \"\" +\n+        \"    ctx._source.{0} += params.{0};\\n\" +\n+        \"    ctx._source.{1} += params.{1};\\n\" +\n+        \"    ctx._source.{2} += params.{2};\\n\" +\n+        \"    ctx._source.{3} = params.{3};\";\n     // Script to only update if stats have increased since last persistence\n-    private static final String STATS_UPDATE_SCRIPT = \"\" +\n-        \"    ctx._source.missing_all_fields_count += params.missing_all_fields_count;\\n\" +\n-        \"    ctx._source.inference_count += params.inference_count;\\n\" +\n-        \"    ctx._source.failure_count += params.failure_count;\\n\" +\n-        \"    ctx._source.time_stamp = params.time_stamp;\";\n+    private static final String STATS_UPDATE_SCRIPT = Messages.getMessage(STATS_UPDATE_SCRIPT_TEMPLATE,\n+        InferenceStats.INFERENCE_COUNT.getPreferredName(),", "originalCommit": "c1933bf9a0f7e1582cf68275083ff1926f2f21f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4ODYwOA==", "url": "https://github.com/elastic/elasticsearch/pull/54752#discussion_r407488608", "bodyText": "yep, I am :/", "author": "benwtrent", "createdAt": "2020-04-13T13:52:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4NzEzMw=="}], "type": "inlineReview"}, {"oid": "51058d97bd1fc6cdb146b7e0e8715135969e469f", "url": "https://github.com/elastic/elasticsearch/commit/51058d97bd1fc6cdb146b7e0e8715135969e469f", "message": "fixing update script", "committedDate": "2020-04-13T13:52:32Z", "type": "commit"}]}