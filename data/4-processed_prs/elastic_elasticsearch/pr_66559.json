{"pr_number": 66559, "pr_title": "Allow ESRestTestClient to trust certificates", "pr_createdAt": "2020-12-17T20:08:00Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66559", "timeline": [{"oid": "7cd032642eeab1d5b92acaf407112a74af0100c2", "url": "https://github.com/elastic/elasticsearch/commit/7cd032642eeab1d5b92acaf407112a74af0100c2", "message": "Allow ESRestTestClient to trust certificates\n\nESRestTestCase rest clients could only be configured to trust\nthe certificate authorities that were contained in a truststore. In\ncertain cases (like in fips mode where JKS/PKCS12 keystores) cannot\nbe used, it's beneficial to be able to trust specific certificate\nauthorities (indicated by the CA PEM endoded certificate)", "committedDate": "2020-12-17T20:06:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxNjc5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/66559#discussion_r547916792", "bodyText": "Do we need to cater for the use case of mulitple certificates from the single PEM file?", "author": "ywangd", "createdAt": "2020-12-23T11:40:17Z", "path": "test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java", "diffHunk": "@@ -1020,7 +1034,24 @@ protected static void configureClient(RestClientBuilder builder, Settings settin\n                 SSLContext sslcontext = SSLContexts.custom().loadTrustMaterial(keyStore, null).build();\n                 SSLIOSessionStrategy sessionStrategy = new SSLIOSessionStrategy(sslcontext);\n                 builder.setHttpClientConfigCallback(httpClientBuilder -> httpClientBuilder.setSSLStrategy(sessionStrategy));\n-            } catch (KeyStoreException |NoSuchAlgorithmException |KeyManagementException |CertificateException e) {\n+            } catch (KeyStoreException | NoSuchAlgorithmException | KeyManagementException | CertificateException e) {\n+                throw new RuntimeException(\"Error setting up ssl\", e);\n+            }\n+        }\n+        if (certificateAuthorities != null) {\n+            Path path = PathUtils.get(certificateAuthorities);\n+            if (!Files.exists(path)) {\n+                throw new IllegalStateException(CERTIFICATE_AUTHORITIES + \" is set but points to a non-existing file\");\n+            }\n+            try {\n+                KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\n+                keyStore.load(null, null);\n+                Certificate cert = PemUtils.readCertificates(List.of(path)).get(0);\n+                keyStore.setCertificateEntry(cert.toString(), cert);", "originalCommit": "7cd032642eeab1d5b92acaf407112a74af0100c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODAxMzYyMA==", "url": "https://github.com/elastic/elasticsearch/pull/66559#discussion_r548013620", "bodyText": "There's no use right now, we can tackle this in a follow up if the need arises", "author": "jkakavas", "createdAt": "2020-12-23T15:29:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxNjc5Mg=="}], "type": "inlineReview"}]}