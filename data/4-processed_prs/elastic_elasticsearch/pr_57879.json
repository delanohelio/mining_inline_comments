{"pr_number": 57879, "pr_title": "Test adjustments for FIPS 140 (#56526)", "pr_createdAt": "2020-06-09T13:56:08Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57879", "timeline": [{"oid": "409128398886768af17c706130f5aa90bb1e2c77", "url": "https://github.com/elastic/elasticsearch/commit/409128398886768af17c706130f5aa90bb1e2c77", "message": "Test adjustments for FIPS 140 (#56526)\n\nThis change aims to fix our setup in CI so that we can run 7.x in\nFIPS 140 mode. The major issue that we have in 7.x and did not\nhave in master is that we can't use the diagnostic trust manager\nin FIPS mode in Java 8 with SunJSSE in FIPS approved mode as it\nexplicitly disallows the wrapping of X509TrustManager.\n\nPrevious attempts like #56427 and #52211 focused on disabling the\nsetting in all of our tests when creating a Settings object or\non setting fips_mode.enabled accordingly (which implicitly disables\nthe diagnostic trust manager). The attempts weren't future proof\nthough as nothing would forbid someone to add new tests without\nsetting the necessary setting and forcing this would be very\ninconvenient for any other case ( see\n\nThis change introduces a runtime check in SSLService that overrides\nthe configuration value of xpack.security.ssl.diagnose.trust and\ndisables the diagnostic trust manager when we are running in Java 8\nand the SunJSSE provider is set in FIPS mode.", "committedDate": "2020-06-09T13:52:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0ODY0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57879#discussion_r437448643", "bodyText": "@tvernum I asked for your review since this is changing this default behavior in a patch release ( 7.7.2 ):\n\nBefore the change, if a user configured a JDK8 JVM using the SunJSSE provider in fips mode we would allow them to explicitly enable the diagnostic trust manager on startup and we would fail in runtime\nAfter the change, we do not allow the user to explicitly enable the diagnostic trust manager in this scenario at all and we print a message on INFO level.\n\nI think this is fine, because the new behavior is much more sane and I could argue is a bugfix over the old one, but I wanted to get a +1", "author": "jkakavas", "createdAt": "2020-06-09T14:04:29Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ssl/SSLService.java", "diffHunk": "@@ -826,11 +828,21 @@ private static String sslContextAlgorithm(List<String> supportedProtocols) {\n     }\n \n     private boolean shouldEnableDiagnoseTrust() {\n-        if (XPackSettings.FIPS_MODE_ENABLED.get(settings) && DIAGNOSE_TRUST_EXCEPTIONS_SETTING.exists(settings) == false ) {\n+        // We disable the DiagnosticTrustManager in Java 8 when SunJSSE is set in FIPS 140 mode, as it doesn't allow X509TrustManager to be\n+        // wrapped\n+        if (inSunJsseInFipsMode()) {", "originalCommit": "409128398886768af17c706130f5aa90bb1e2c77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc3OTIzNA==", "url": "https://github.com/elastic/elasticsearch/pull/57879#discussion_r438779234", "bodyText": "ping @tvernum for a quick +1/-1", "author": "jkakavas", "createdAt": "2020-06-11T13:27:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0ODY0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU5MjQyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/57879#discussion_r440592429", "bodyText": "+1", "author": "tvernum", "createdAt": "2020-06-16T05:21:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0ODY0Mw=="}], "type": "inlineReview"}]}