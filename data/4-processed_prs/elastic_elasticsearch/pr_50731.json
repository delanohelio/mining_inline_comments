{"pr_number": 50731, "pr_title": "Work around JVM Bug in LongGCDisruptionTests", "pr_createdAt": "2020-01-08T10:17:27Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50731", "timeline": [{"oid": "5067f6d2a1c85cd301468a41905757221be84d90", "url": "https://github.com/elastic/elasticsearch/commit/5067f6d2a1c85cd301468a41905757221be84d90", "message": "Work around JVM Bug in LongGCDisruptionTests\n\nThere is a JVM bug causing `Thread#suspend` calls to randomly take\nmultiple seconds breaking these tests that call the method numerous times\nin a loop. Increasing the timeout would will not work since we may call\n`suspend` tens if not hundreds of times and even a small number of them\nexperiencing the blocking will lead to multiple minutes of waiting.\n\nThis PR detects the specific issue by timing the `Thread#suspend` calls and\nskips the remainder of the test if it timed out because of the JVM bug.\n\nCloses #50047", "committedDate": "2020-01-08T10:06:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI0NjM3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/50731#discussion_r364246377", "bodyText": "Could we make this conditional on the JVM version so that we are sure to keep tracking that JVM bug and to drop this fix when it's no longer needed?", "author": "DaveCTurner", "createdAt": "2020-01-08T14:04:52Z", "path": "test/framework/src/main/java/org/elasticsearch/test/disruption/LongGCDisruption.java", "diffHunk": "@@ -251,7 +265,11 @@ protected boolean suspendThreads(Set<Thread> nodeThreads) {\n                          * assuming that it is safe.\n                          */\n                         boolean definitelySafe = true;\n+                        final long startTime = System.nanoTime();\n                         thread.suspend();\n+                        if (System.nanoTime() - startTime > TimeUnit.SECONDS.toNanos(3L)) {\n+                            sawSlowSuspendBug.set(true);", "originalCommit": "5067f6d2a1c85cd301468a41905757221be84d90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI0OTQ5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/50731#discussion_r364249492", "bodyText": "Technically we could, but right now we're seeing this failure on all versions. This is a little unexpected on 8 so I figured we'd apply the fix for 8 as well to identify whether it's the same issue (slow suspend) there or if it's blocked somewhere else.", "author": "original-brownbear", "createdAt": "2020-01-08T14:11:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI0NjM3Nw=="}], "type": "inlineReview"}]}