{"pr_number": 64016, "pr_title": "Remove aggregation's postCollect phase", "pr_createdAt": "2020-10-21T19:51:31Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64016", "timeline": [{"oid": "31bbf53659609cb511512866882a109a8506229f", "url": "https://github.com/elastic/elasticsearch/commit/31bbf53659609cb511512866882a109a8506229f", "message": "Remove aggregation's postCollect phase\n\nAfter #63811 it became clear to me that `postCollect` is kind of\ndangerous and not all that useful. So this removes it.\n\nThe trouble with `postCollect` is that it all happened right after we\nfinished calling `collect` on the `LeafBucketCollectors` but before we\nbuilt the aggregation results. But in #63811 we found out that we can't\ncall `postCollect` on the children of `parent` or `child` aggregators\nuntil we know which *which* aggregation results we're building.\n\nSo this removes `postCollect` and moves all of the things we did at\npost-collect phase into `buildAggregations` or into hooks called in\nthose methods.", "committedDate": "2020-10-21T19:51:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyNjUzNw==", "url": "https://github.com/elastic/elasticsearch/pull/64016#discussion_r509626537", "bodyText": "I renamed this method to make it a bit more clear what it is for.", "author": "nik9000", "createdAt": "2020-10-21T19:51:55Z", "path": "modules/parent-join/src/main/java/org/elasticsearch/join/aggregations/ParentJoinAggregator.java", "diffHunk": "@@ -113,12 +113,7 @@ public void collect(int docId, long owningBucketOrd) throws IOException {\n     }\n \n     @Override\n-    public void postCollection() throws IOException {\n-        // Delaying until beforeBuildingBuckets\n-    }\n-\n-    @Override\n-    protected void beforeBuildingBuckets(long[] ordsToCollect) throws IOException {\n+    protected void prepareSubAggs(long[] bucketOrdsToCollect) throws IOException {", "originalCommit": "d588ddad9003a3061d3a64cf5515f4dc0c2a919b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyNzcwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/64016#discussion_r509627701", "bodyText": "I think this is a more clear variable name. I made this change in a dead end when I was working on this change locally but I kind of like it.", "author": "nik9000", "createdAt": "2020-10-21T19:52:50Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/Aggregator.java", "diffHunk": "@@ -142,12 +142,12 @@ public BucketComparator bucketComparator(String key, SortOrder order) {\n \n     /**\n      * Build the results of this aggregation.\n-     * @param owningBucketOrds the ordinals of the buckets that we want to\n+     * @param ordsToCollect the ordinals of the buckets that we want to\n      *        collect from this aggregation\n      * @return the results for each ordinal, in the same order as the array\n      *         of ordinals\n      */\n-    public abstract InternalAggregation[] buildAggregations(long[] owningBucketOrds) throws IOException;", "originalCommit": "d588ddad9003a3061d3a64cf5515f4dc0c2a919b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyODkyOA==", "url": "https://github.com/elastic/elasticsearch/pull/64016#discussion_r509628928", "bodyText": "I'm pretty happy about how this turned out! No more finished to check on. It's just all built in now.", "author": "nik9000", "createdAt": "2020-10-21T19:53:34Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/BestBucketsDeferringCollector.java", "diffHunk": "@@ -136,20 +135,12 @@ public void preCollection() throws IOException {\n         collector.preCollection();\n     }\n \n-    @Override\n-    public void postCollection() throws IOException {\n-        finishLeaf();\n-        finished = true;\n-    }\n-\n     /**\n      * Replay the wrapped collector, but only on a selection of buckets.\n      */\n     @Override\n     public void prepareSelectedBuckets(long... selectedBuckets) throws IOException {\n-        if (finished == false) {\n-            throw new IllegalStateException(\"Cannot replay yet, collection is not finished: postCollect() has not been called\");\n-        }\n+        finishLeaf();", "originalCommit": "d588ddad9003a3061d3a64cf5515f4dc0c2a919b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYzMTI0NA==", "url": "https://github.com/elastic/elasticsearch/pull/64016#discussion_r509631244", "bodyText": "This is kind of an unfortunate loss here. Now we'll end up having post_collection in the build_aggregation debug phase. I'm wondering if I can have aggregations that do \"interesting\" things opt in to make their own timers or something.", "author": "nik9000", "createdAt": "2020-10-21T19:55:35Z", "path": "server/src/main/java/org/elasticsearch/search/profile/aggregation/ProfilingAggregator.java", "diffHunk": "@@ -124,17 +124,6 @@ public void preCollection() throws IOException {\n         profiler.pollLastElement();\n     }\n \n-    @Override\n-    public void postCollection() throws IOException {", "originalCommit": "d588ddad9003a3061d3a64cf5515f4dc0c2a919b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "93db73904a8c4f25404036a149f7a9dd7764ab53", "url": "https://github.com/elastic/elasticsearch/commit/93db73904a8c4f25404036a149f7a9dd7764ab53", "message": "Better words", "committedDate": "2020-10-21T19:56:11Z", "type": "commit"}, {"oid": "93db73904a8c4f25404036a149f7a9dd7764ab53", "url": "https://github.com/elastic/elasticsearch/commit/93db73904a8c4f25404036a149f7a9dd7764ab53", "message": "Better words", "committedDate": "2020-10-21T19:56:11Z", "type": "forcePushed"}, {"oid": "e9c80e8d4ab9ebfe055b8d0101b9df74c40dd866", "url": "https://github.com/elastic/elasticsearch/commit/e9c80e8d4ab9ebfe055b8d0101b9df74c40dd866", "message": "Fixup", "committedDate": "2020-10-21T20:35:17Z", "type": "commit"}, {"oid": "1e8647478094f1e7d533cd87c4aa6812172a5395", "url": "https://github.com/elastic/elasticsearch/commit/1e8647478094f1e7d533cd87c4aa6812172a5395", "message": "Merge branch 'master' into aggregration_drop_post_collect", "committedDate": "2020-10-26T13:56:33Z", "type": "commit"}, {"oid": "9b8f630cb9e84ce484e5bebf3a3a80aa24de4361", "url": "https://github.com/elastic/elasticsearch/commit/9b8f630cb9e84ce484e5bebf3a3a80aa24de4361", "message": "Merge branch 'master' into aggregration_drop_post_collect", "committedDate": "2020-10-26T18:42:29Z", "type": "commit"}, {"oid": "9ea6f51f98c8f8031dce816b2a5debe3df1ad426", "url": "https://github.com/elastic/elasticsearch/commit/9ea6f51f98c8f8031dce816b2a5debe3df1ad426", "message": "Remove extra", "committedDate": "2020-10-26T18:57:12Z", "type": "commit"}, {"oid": "a9ae3d737c54a26c336d0899e284e52d62526580", "url": "https://github.com/elastic/elasticsearch/commit/a9ae3d737c54a26c336d0899e284e52d62526580", "message": "Merge branch 'master' into aggregration_drop_post_collect", "committedDate": "2020-10-28T20:31:25Z", "type": "commit"}]}