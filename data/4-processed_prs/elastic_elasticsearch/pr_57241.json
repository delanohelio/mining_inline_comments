{"pr_number": 57241, "pr_title": "Make global ords terms simpler to understand", "pr_createdAt": "2020-05-27T18:34:00Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57241", "timeline": [{"oid": "c46404fa44673d53ddb79cbf04b612566c989b85", "url": "https://github.com/elastic/elasticsearch/commit/c46404fa44673d53ddb79cbf04b612566c989b85", "message": "Make global ords terms simpler to understand\n\nWhen the `terms` enum operates on non-numeric data it can collect it via\nglobal ordinals. It actually has two separate collection strategies for,\none \"dense\" and one \"remapping\". Each of *those* strategies has two\n\"iteration\" strategies that it uses to build buckets, depending on\nwhether or not we need buckets with `0` docs in them. Previously this\nwas done with several `null` checks and never really explained. This\nchange replaces those checks with two `CollectionStrategy` classes which\nhave good stuff like documentation.", "committedDate": "2020-05-27T18:31:49Z", "type": "commit"}, {"oid": "f15258ea2b5e1a5b1c50ceb184c27b775d9ebf50", "url": "https://github.com/elastic/elasticsearch/commit/f15258ea2b5e1a5b1c50ceb184c27b775d9ebf50", "message": "fix", "committedDate": "2020-05-27T20:43:20Z", "type": "commit"}, {"oid": "8e42d86848526ce50fdf1182103505561ca662d4", "url": "https://github.com/elastic/elasticsearch/commit/8e42d86848526ce50fdf1182103505561ca662d4", "message": "Merge branch 'master' into global_ords_terms_collection_strategy", "committedDate": "2020-05-28T13:08:16Z", "type": "commit"}, {"oid": "11f0beaa2faf77a8fadc3d22c84c744f8317d829", "url": "https://github.com/elastic/elasticsearch/commit/11f0beaa2faf77a8fadc3d22c84c744f8317d829", "message": "Be good now!", "committedDate": "2020-05-28T13:18:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg3Mzk2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57241#discussion_r431873963", "bodyText": "I presume this is what gets called by the collector, but I think it'd help to make this javadoc a little more explicit.", "author": "not-napoleon", "createdAt": "2020-05-28T14:23:09Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/GlobalOrdinalsStringTermsAggregator.java", "diffHunk": "@@ -420,4 +392,141 @@ public boolean advanceExact(int target) throws IOException {\n             return false;\n         }\n     }\n+\n+    /**\n+     * Strategy for collecting global ordinals.\n+     */\n+    abstract class CollectionStrategy implements Releasable {\n+        /**\n+         * Short description of the collection mechanism added to the profile\n+         * output to help with debugging.\n+         */\n+        abstract String describe();\n+        /**\n+         * Called when the global ordinals are ready.\n+         */\n+        abstract void globalOrdsReady(SortedSetDocValues globalOrds);\n+        /**\n+         * Collect a global ordinal.", "originalCommit": "11f0beaa2faf77a8fadc3d22c84c744f8317d829", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAyMDcwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/57241#discussion_r432020701", "bodyText": "\ud83d\udc4d", "author": "nik9000", "createdAt": "2020-05-28T17:58:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg3Mzk2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkwMTgwNA==", "url": "https://github.com/elastic/elasticsearch/pull/57241#discussion_r431901804", "bodyText": "Is there a reason not to just pass the collection strategy in directly?", "author": "not-napoleon", "createdAt": "2020-05-28T14:55:01Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/GlobalOrdinalsStringTermsAggregator.java", "diffHunk": "@@ -89,32 +88,17 @@ public GlobalOrdinalsStringTermsAggregator(String name, AggregatorFactories fact\n                                                Map<String, Object> metadata) throws IOException {\n         super(name, factories, context, parent, order, format, bucketCountThresholds, collectionMode, showTermDocCountError, metadata);\n         this.valuesSource = valuesSource;\n-        this.includeExclude = includeExclude;\n         final IndexReader reader = context.searcher().getIndexReader();\n         final SortedSetDocValues values = reader.leaves().size() > 0 ?\n             valuesSource.globalOrdinalsValues(context.searcher().getIndexReader().leaves().get(0)) : DocValues.emptySortedSet();\n         this.valueCount = values.getValueCount();\n         this.lookupGlobalOrd = values::lookupOrd;\n-        this.acceptedGlobalOrdinals = includeExclude != null ? includeExclude.acceptedGlobalOrdinals(values) : null;\n-        this.bucketOrds = remapGlobalOrds ? new LongHash(1, context.bigArrays()) : null;\n-    }\n-\n-    boolean remapGlobalOrds() {\n-        return bucketOrds != null;\n+        this.acceptedGlobalOrdinals = includeExclude == null ? l -> true : includeExclude.acceptedGlobalOrdinals(values)::get;\n+        this.collectionStrategy = remapGlobalOrds ? new RemapGlobalOrds() : new DenseGlobalOrds();", "originalCommit": "11f0beaa2faf77a8fadc3d22c84c744f8317d829", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAxNzg4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57241#discussion_r432017886", "bodyText": "Hmmmm - I did think about it but we'd have to do that same \"pass a builder\" kind of thing because it is a non-static inner class.", "author": "nik9000", "createdAt": "2020-05-28T17:53:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkwMTgwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkwODU3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57241#discussion_r431908576", "bodyText": "I think your comment from the PR description that we have two collection strategies and each has two iteration strategies would fit well in the javadoc for this class.  Or at the very least, a note on forEach that it should account for both iteration cases.", "author": "not-napoleon", "createdAt": "2020-05-28T15:04:05Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/GlobalOrdinalsStringTermsAggregator.java", "diffHunk": "@@ -420,4 +392,141 @@ public boolean advanceExact(int target) throws IOException {\n             return false;\n         }\n     }\n+\n+    /**\n+     * Strategy for collecting global ordinals.", "originalCommit": "11f0beaa2faf77a8fadc3d22c84c744f8317d829", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAxODAxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/57241#discussion_r432018015", "bodyText": "\ud83d\udc4d", "author": "nik9000", "createdAt": "2020-05-28T17:53:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkwODU3Ng=="}], "type": "inlineReview"}, {"oid": "4a8e3aa90c55e31d64de0587864119e34707c903", "url": "https://github.com/elastic/elasticsearch/commit/4a8e3aa90c55e31d64de0587864119e34707c903", "message": "Javadoc", "committedDate": "2020-05-28T18:06:39Z", "type": "commit"}, {"oid": "b2eb394114bb47b448673bf04694ddd1243a0dce", "url": "https://github.com/elastic/elasticsearch/commit/b2eb394114bb47b448673bf04694ddd1243a0dce", "message": "Fix bug", "committedDate": "2020-05-28T18:24:46Z", "type": "commit"}]}