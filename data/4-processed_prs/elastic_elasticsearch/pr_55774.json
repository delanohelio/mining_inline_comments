{"pr_number": 55774, "pr_title": "Just log 401 stacktraces", "pr_createdAt": "2020-04-26T12:30:26Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55774", "timeline": [{"oid": "509625dcfe63b6cca1ac48959849d807b4e3615c", "url": "https://github.com/elastic/elasticsearch/commit/509625dcfe63b6cca1ac48959849d807b4e3615c", "message": "Checkpoint", "committedDate": "2020-04-26T11:01:30Z", "type": "commit"}, {"oid": "945b1b039452bd9ac661f7e9510163182992398b", "url": "https://github.com/elastic/elasticsearch/commit/945b1b039452bd9ac661f7e9510163182992398b", "message": "Done", "committedDate": "2020-04-26T11:11:28Z", "type": "commit"}, {"oid": "c48533b194c0da3816d2c9b60d1bc0c3d636eb57", "url": "https://github.com/elastic/elasticsearch/commit/c48533b194c0da3816d2c9b60d1bc0c3d636eb57", "message": "Fix test", "committedDate": "2020-04-26T12:33:53Z", "type": "commit"}, {"oid": "271c4bfb771fe9b645dde12de1dcfd02f5922d8e", "url": "https://github.com/elastic/elasticsearch/commit/271c4bfb771fe9b645dde12de1dcfd02f5922d8e", "message": "Checkstyle", "committedDate": "2020-04-26T12:46:19Z", "type": "commit"}, {"oid": "48359a07aa04f29121f4993cfed660b5c8edcd52", "url": "https://github.com/elastic/elasticsearch/commit/48359a07aa04f29121f4993cfed660b5c8edcd52", "message": "SecurityRestFilter", "committedDate": "2020-04-26T16:58:13Z", "type": "commit"}, {"oid": "1c800dd103519cf641290ff06a159490633f78c6", "url": "https://github.com/elastic/elasticsearch/commit/1c800dd103519cf641290ff06a159490633f78c6", "message": "More tests", "committedDate": "2020-04-26T17:27:29Z", "type": "commit"}, {"oid": "97915ed75b780d3d6efbca2604bf7929f638ef19", "url": "https://github.com/elastic/elasticsearch/commit/97915ed75b780d3d6efbca2604bf7929f638ef19", "message": "Nits", "committedDate": "2020-04-27T09:53:40Z", "type": "commit"}, {"oid": "ca0f00a0b698eb486efb594f8f7889b85c5f97c4", "url": "https://github.com/elastic/elasticsearch/commit/ca0f00a0b698eb486efb594f8f7889b85c5f97c4", "message": "Merge branch 'master' into hide_security_stacktrace", "committedDate": "2020-04-27T09:54:27Z", "type": "commit"}, {"oid": "508151d32529068fce53650371c68bded7041d42", "url": "https://github.com/elastic/elasticsearch/commit/508151d32529068fce53650371c68bded7041d42", "message": "Docs", "committedDate": "2020-04-27T10:23:06Z", "type": "commit"}, {"oid": "d7cba32a5ad0a929082718328b92a9918ead0634", "url": "https://github.com/elastic/elasticsearch/commit/d7cba32a5ad0a929082718328b92a9918ead0634", "message": "Merge branch 'master' into hide_security_stacktrace", "committedDate": "2020-04-29T15:47:33Z", "type": "commit"}, {"oid": "a9585387fcc625baf792f0f028eb6739fb34d3d5", "url": "https://github.com/elastic/elasticsearch/commit/a9585387fcc625baf792f0f028eb6739fb34d3d5", "message": "Forgot to register setting", "committedDate": "2020-04-29T22:41:18Z", "type": "commit"}, {"oid": "efb5e076bda680ac8d56b2039995a23005d7e745", "url": "https://github.com/elastic/elasticsearch/commit/efb5e076bda680ac8d56b2039995a23005d7e745", "message": "Merge branch 'master' into hide_security_stacktrace", "committedDate": "2020-05-25T16:15:27Z", "type": "commit"}, {"oid": "6f45e455bebd4bd8b044519af2b85724cc3aff9c", "url": "https://github.com/elastic/elasticsearch/commit/6f45e455bebd4bd8b044519af2b85724cc3aff9c", "message": "Remove seetting", "committedDate": "2020-05-25T17:23:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDExNjM3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55774#discussion_r430116376", "bodyText": "We could use a test for a failure that has a non-empty cause and ensure the stack trace is not displayed for the cause either.", "author": "ywangd", "createdAt": "2020-05-26T01:39:20Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/rest/SecurityRestFilterTests.java", "diffHunk": "@@ -141,21 +146,48 @@ public void testProcessBasicLicense() throws Exception {\n         verifyZeroInteractions(channel, authcService);\n     }\n \n-    public void testProcessAuthenticationError() throws Exception {\n-        RestRequest request = mock(RestRequest.class);\n-        Exception exception = authenticationError(\"failed authc\");\n+    public void testProcessAuthenticationFailedNoTrace() throws Exception {\n+        filter = new SecurityRestFilter(licenseState, threadContext, authcService, secondaryAuthenticator, restHandler, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, true, true, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, true, false, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, false, true, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, false, false, false);", "originalCommit": "6f45e455bebd4bd8b044519af2b85724cc3aff9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMxOTY5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55774#discussion_r434319696", "bodyText": "I think\ntestProcessAuthenticationFailed(randomBoolean() ? authenticationError(\"failed authn\") : authenticationError(\"failed authn with \" +\n                \"cause\", new ElasticsearchException(\"cause\")), RestStatus.UNAUTHORIZED, false, false, false);\n\ndoes the job?", "author": "albertzaharovits", "createdAt": "2020-06-03T05:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDExNjM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyMzY2OA==", "url": "https://github.com/elastic/elasticsearch/pull/55774#discussion_r430123668", "bodyText": "I am unsure about this statement. It is probably better be removed. My reasonings are:\n\nSemantically it is not necessary as the else branch is the execution path of the default value, i.e. REST_EXCEPTION_SKIP_STACK_TRACE_DEFAULT, which is true.\nIn fact, it does not matter what the actual default value is. The intention here, as I understand it, is to proceed as default with no extra intervention. This is unlikely in practice, but might be possible in theory: The caller may choose to set REST_EXCEPTION_SKIP_STACK_TRACE to false and wraps it with either a RestChannel or RestRequest. In this case, the else branch should proceed with the value from caller instead of changing it.", "author": "ywangd", "createdAt": "2020-05-26T02:16:08Z", "path": "server/src/main/java/org/elasticsearch/rest/BytesRestResponse.java", "diffHunk": "@@ -117,28 +131,22 @@ public RestStatus status() {\n         return this.status;\n     }\n \n-    private static final Logger SUPPRESSED_ERROR_LOGGER = LogManager.getLogger(\"rest.suppressed\");\n-\n-    private static XContentBuilder build(RestChannel channel, RestStatus status, Exception e) throws IOException {\n-        ToXContent.Params params = channel.request();\n+    protected ToXContent.Params paramsFromRequest(RestRequest restRequest) {\n+        ToXContent.Params params = restRequest;\n         if (params.paramAsBoolean(\"error_trace\", !REST_EXCEPTION_SKIP_STACK_TRACE_DEFAULT)) {\n             params =  new ToXContent.DelegatingMapParams(singletonMap(REST_EXCEPTION_SKIP_STACK_TRACE, \"false\"), params);\n-        } else if (e != null) {\n-            Supplier<?> messageSupplier = () -> new ParameterizedMessage(\"path: {}, params: {}\",\n-                    channel.request().rawPath(), channel.request().params());\n-\n-            if (status.getStatus() < 500) {\n-                SUPPRESSED_ERROR_LOGGER.debug(messageSupplier, e);\n-            } else {\n-                SUPPRESSED_ERROR_LOGGER.warn(messageSupplier, e);\n-            }\n+        } else {\n+            params =  new ToXContent.DelegatingMapParams(singletonMap(REST_EXCEPTION_SKIP_STACK_TRACE, \"true\"), params);", "originalCommit": "6f45e455bebd4bd8b044519af2b85724cc3aff9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA0ODg3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55774#discussion_r434048875", "bodyText": "Sounds good, thanks!", "author": "albertzaharovits", "createdAt": "2020-06-02T17:28:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyMzY2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEzNTI5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55774#discussion_r430135296", "bodyText": "I wonder whether this could just be pulled up into BytesRestResponse itself. I think the intention is probably to not mix security related code with generic Rest code. But the duplication worries me and it is hard to be aware of the additional logic if you just read BytesRestResponse.\nIf pulling this up does not sound right to you, alternatively, we could add an additional method to BytesRestResponse, e.g. allowsStackTrace(), which always returns true and is overridden here to check the restStatus, i.e.:\nFor BytesRestResponse:\nprivate ToXContent.Params paramsFromRequest(RestRequest restRequest) {\n    ToXContent.Params params = restRequest;\n    if (params.paramAsBoolean(\"error_trace\", !REST_EXCEPTION_SKIP_STACK_TRACE_DEFAULT)\n        && allowsStackTrace()) {\n                 ...\n    }\n            ...\n}\n\nprotected boolean allowsStackTrace() { return true; }\nAnd overridden as:\nchannel.sendResponse(new BytesRestResponse(channel, e) {\n    @Override\n    protected boolean allowsStackTrace() { return status() != RestStatus.UNAUTHORIZED; }\n})\nI personally feel the additional method makes it easier to be aware of the possible extra check by just reading the BytesRestResponse class.", "author": "ywangd", "createdAt": "2020-05-26T03:13:34Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/SecurityRestFilter.java", "diffHunk": "@@ -82,8 +89,23 @@ public void handleRequest(RestRequest request, RestChannel channel, NodeClient c\n \n     private void handleException(String actionType, RestRequest request, RestChannel channel, Exception e) {\n         logger.debug(new ParameterizedMessage(\"{} failed for REST request [{}]\", actionType, request.uri()), e);\n+        final RestStatus restStatus = ExceptionsHelper.status(e);\n         try {\n-            channel.sendResponse(new BytesRestResponse(channel, e));\n+            channel.sendResponse(new BytesRestResponse(channel, restStatus, e) {\n+\n+                @Override\n+                protected ToXContent.Params paramsFromRequest(RestRequest restRequest) {\n+                    ToXContent.Params params = restRequest;\n+                    if (params.paramAsBoolean(\"error_trace\", !REST_EXCEPTION_SKIP_STACK_TRACE_DEFAULT)\n+                            && restStatus != RestStatus.UNAUTHORIZED) {\n+                        params = new ToXContent.DelegatingMapParams(singletonMap(REST_EXCEPTION_SKIP_STACK_TRACE, \"false\"), params);\n+                    } else {\n+                        params = new ToXContent.DelegatingMapParams(singletonMap(REST_EXCEPTION_SKIP_STACK_TRACE, \"true\"), params);\n+                    }\n+                    return params;\n+                }", "originalCommit": "6f45e455bebd4bd8b044519af2b85724cc3aff9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM2ODY5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55774#discussion_r430368696", "bodyText": "How about an additional ctor in BytesRestResponse that takes a boolean that in principal overrides REST_EXCEPTION_SKIP_STACK_TRACE, REST_EXCEPTION_SKIP_STACK_TRACE_DEFAULT or error_trace so that you can simply call\nfinal RestStatus restStatus = ExceptionsHelper.status(e);\nfinal boolean hideStackTrace = restStatus == RestStatus.UNAUTHORIZED;\ntry {\n    channel.sendResponse(new BytesRestResponse(channel, hideStackTrace, e));", "author": "jkakavas", "createdAt": "2020-05-26T12:19:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEzNTI5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA0OTE3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55774#discussion_r434049173", "bodyText": "The allowsStackTrace() alternative sounds good, thanks! .. but I've named it skipStackTrace it's more congruous with the parameter naming in that portion of the code.", "author": "albertzaharovits", "createdAt": "2020-06-02T17:28:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEzNTI5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE0MDM1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55774#discussion_r430140356", "bodyText": "Nit: we could probably randomize the RestStatus in 4xx and 5xx.", "author": "ywangd", "createdAt": "2020-05-26T03:40:34Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/rest/SecurityRestFilterTests.java", "diffHunk": "@@ -141,21 +146,48 @@ public void testProcessBasicLicense() throws Exception {\n         verifyZeroInteractions(channel, authcService);\n     }\n \n-    public void testProcessAuthenticationError() throws Exception {\n-        RestRequest request = mock(RestRequest.class);\n-        Exception exception = authenticationError(\"failed authc\");\n+    public void testProcessAuthenticationFailedNoTrace() throws Exception {\n+        filter = new SecurityRestFilter(licenseState, threadContext, authcService, secondaryAuthenticator, restHandler, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, true, true, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, true, false, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, false, true, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, false, false, false);\n+        testProcessAuthenticationFailed(new ElasticsearchException(\"dummy\"), RestStatus.INTERNAL_SERVER_ERROR, false, false, false);\n+        testProcessAuthenticationFailed(new ElasticsearchException(\"dummy\"), RestStatus.INTERNAL_SERVER_ERROR, true, false, false);\n+        testProcessAuthenticationFailed(new ElasticsearchException(\"dummy\"), RestStatus.INTERNAL_SERVER_ERROR, false, true, false);\n+        testProcessAuthenticationFailed(new ElasticsearchException(\"dummy\"), RestStatus.INTERNAL_SERVER_ERROR, true, true, true);", "originalCommit": "6f45e455bebd4bd8b044519af2b85724cc3aff9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d05be027e0f22af23e1f6cf5609289fc735ad3b9", "url": "https://github.com/elastic/elasticsearch/commit/d05be027e0f22af23e1f6cf5609289fc735ad3b9", "message": "Merge branch 'master' into hide_security_stacktrace", "committedDate": "2020-06-02T16:32:18Z", "type": "commit"}, {"oid": "a722b53a1187f49c94d3c3ac32046365bc0af7fc", "url": "https://github.com/elastic/elasticsearch/commit/a722b53a1187f49c94d3c3ac32046365bc0af7fc", "message": "Address review", "committedDate": "2020-06-02T18:10:36Z", "type": "commit"}, {"oid": "1375bed72a4288be295dcbc89c0c7433fe2f42c3", "url": "https://github.com/elastic/elasticsearch/commit/1375bed72a4288be295dcbc89c0c7433fe2f42c3", "message": "400 and 500 errors", "committedDate": "2020-06-02T18:15:39Z", "type": "commit"}, {"oid": "b612f6466da4fa0c59d978ebf5b79e622ad7d49f", "url": "https://github.com/elastic/elasticsearch/commit/b612f6466da4fa0c59d978ebf5b79e622ad7d49f", "message": "Merge branch 'master' into hide_security_stacktrace", "committedDate": "2020-06-10T13:17:31Z", "type": "commit"}]}