{"pr_number": 63298, "pr_title": "Write translog operation bytes to byte stream", "pr_createdAt": "2020-10-06T03:12:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63298", "timeline": [{"oid": "deae63b0e03589887a211ab4df3843a6e701e842", "url": "https://github.com/elastic/elasticsearch/commit/deae63b0e03589887a211ab4df3843a6e701e842", "message": "Write translog operation bytes to byte stream\n\nCurrently we add translog operation bytes to an array list and flush\nthem on the next write. Unfortunately, this does not currently play well\nwith our byte pooling which means each operation is backed, at minimum,\nby a 16KB array. This commit improves memory efficiency for small\noperations by serializing the operations to an output stream.", "committedDate": "2020-10-06T01:30:48Z", "type": "commit"}, {"oid": "6cc0ce55a8cfee0802739c1208f735a4a9c832ad", "url": "https://github.com/elastic/elasticsearch/commit/6cc0ce55a8cfee0802739c1208f735a4a9c832ad", "message": "Merge remote-tracking branch 'upstream/master' into use_bytes_stream", "committedDate": "2020-10-06T03:38:19Z", "type": "commit"}, {"oid": "43200b58f119a70e04bed55941d8f22a96ad9857", "url": "https://github.com/elastic/elasticsearch/commit/43200b58f119a70e04bed55941d8f22a96ad9857", "message": "Fix test", "committedDate": "2020-10-06T04:04:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEyNDMxNw==", "url": "https://github.com/elastic/elasticsearch/pull/63298#discussion_r500124317", "bodyText": "I struggle to see how this can do anything, given that we assert that buffer is null a few lines above and we retain synchronized(this) throughout?", "author": "henningandersen", "createdAt": "2020-10-06T09:11:41Z", "path": "server/src/main/java/org/elasticsearch/index/translog/TranslogWriter.java", "diffHunk": "@@ -335,11 +339,13 @@ public TranslogReader closeIntoReader() throws IOException {\n                         throw ex;\n                     }\n                     // If we reached this point, all of the buffered ops should have been flushed successfully.\n-                    assert bufferedOps.size() == 0;\n+                    assert buffer == null;\n                     assert checkChannelPositionWhileHandlingException(totalOffset);\n                     assert totalOffset == lastSyncedCheckpoint.offset;\n                     if (closed.compareAndSet(false, true)) {\n                         try {\n+                            Releasables.closeWhileHandlingException(buffer);\n+                            buffer = null;", "originalCommit": "43200b58f119a70e04bed55941d8f22a96ad9857", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzOTI4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63298#discussion_r500139282", "bodyText": "I think we should also revert the signature change of add, allowing us to revert Translog.add to its previous slightly simpler form?", "author": "henningandersen", "createdAt": "2020-10-06T09:35:56Z", "path": "server/src/main/java/org/elasticsearch/index/translog/TranslogWriter.java", "diffHunk": "@@ -187,10 +189,12 @@ private synchronized void closeWithTragicEvent(final Exception ex) {\n         final long bytesBufferedAfterAdd;", "originalCommit": "43200b58f119a70e04bed55941d8f22a96ad9857", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9b0e36735ddd2c496c54f27f9114de63885c934d", "url": "https://github.com/elastic/elasticsearch/commit/9b0e36735ddd2c496c54f27f9114de63885c934d", "message": "Changes", "committedDate": "2020-10-06T15:17:49Z", "type": "commit"}, {"oid": "74318513aefd72477e003f564da2781eca0acfc9", "url": "https://github.com/elastic/elasticsearch/commit/74318513aefd72477e003f564da2781eca0acfc9", "message": "Final", "committedDate": "2020-10-06T15:22:21Z", "type": "commit"}, {"oid": "a1e32f33988bc777880cfa57fc574ccab8660499", "url": "https://github.com/elastic/elasticsearch/commit/a1e32f33988bc777880cfa57fc574ccab8660499", "message": "Increase stress of writer test", "committedDate": "2020-10-06T15:47:11Z", "type": "commit"}, {"oid": "c50e3d1678f287c38c228a9d33b6d7744dc0563e", "url": "https://github.com/elastic/elasticsearch/commit/c50e3d1678f287c38c228a9d33b6d7744dc0563e", "message": "Merge remote-tracking branch 'upstream/master' into use_bytes_stream", "committedDate": "2020-10-06T15:59:41Z", "type": "commit"}]}