{"pr_number": 53317, "pr_title": "Enable deprecation checks for removed settings", "pr_createdAt": "2020-03-09T21:57:11Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53317", "timeline": [{"oid": "e54110e2e9ef6dbef0f977efa4e971e34afa5470", "url": "https://github.com/elastic/elasticsearch/commit/e54110e2e9ef6dbef0f977efa4e971e34afa5470", "message": "Enable deprecation checks for removed settings\n\nToday we do not have any infrastructure for adding a deprecation check\nfor settings that are removed. This commit enables this by adding such\ninfrastructure. Note that this infrastructure is unused in this commit,\nwhich is deliberate. However, the primary target for this commit is 7.x\nwhere this infrastructue will be used, in a follow-up.", "committedDate": "2020-03-09T21:54:02Z", "type": "commit"}, {"oid": "b29c683068d42010a7b3660b97e7e221eccce932", "url": "https://github.com/elastic/elasticsearch/commit/b29c683068d42010a7b3660b97e7e221eccce932", "message": "Fix imports", "committedDate": "2020-03-09T21:57:03Z", "type": "commit"}, {"oid": "c36611760b19cb9988eed01e9085c36f40ace52a", "url": "https://github.com/elastic/elasticsearch/commit/c36611760b19cb9988eed01e9085c36f40ace52a", "message": "Fix forbidden call", "committedDate": "2020-03-09T22:49:09Z", "type": "commit"}, {"oid": "42b5aadae1e857a09d734569ba9af1417cd9c7fc", "url": "https://github.com/elastic/elasticsearch/commit/42b5aadae1e857a09d734569ba9af1417cd9c7fc", "message": "Consistency", "committedDate": "2020-03-09T23:05:08Z", "type": "commit"}, {"oid": "efb7740a4085b1f912d14f922fff1c32d45a348c", "url": "https://github.com/elastic/elasticsearch/commit/efb7740a4085b1f912d14f922fff1c32d45a348c", "message": "Merge branch 'master' into removed-setting-deprecation-check", "committedDate": "2020-03-11T12:43:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk0MzY1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/53317#discussion_r390943651", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static List<BiFunction<Settings, PluginsAndModules, DeprecationIssue>> NODE_SETTINGS_CHECKS = List.of();\n          \n          \n            \n                static List<BiFunction<Settings, PluginsAndModules, DeprecationIssue>> NODE_SETTINGS_CHECKS = Collections.emptyList();", "author": "jasontedor", "createdAt": "2020-03-11T12:44:03Z", "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/DeprecationChecks.java", "diffHunk": "@@ -33,7 +33,7 @@ private DeprecationChecks() {\n     static List<Function<ClusterState, DeprecationIssue>> CLUSTER_SETTINGS_CHECKS =\n         Collections.emptyList();\n \n-    static List<BiFunction<Settings, PluginsAndModules, DeprecationIssue>> NODE_SETTINGS_CHECKS = Collections.emptyList();\n+    static List<BiFunction<Settings, PluginsAndModules, DeprecationIssue>> NODE_SETTINGS_CHECKS = List.of();", "originalCommit": "42b5aadae1e857a09d734569ba9af1417cd9c7fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e9a24da88caea12d0d272806051cc7a8aec5d74d", "url": "https://github.com/elastic/elasticsearch/commit/e9a24da88caea12d0d272806051cc7a8aec5d74d", "message": "Update x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/DeprecationChecks.java", "committedDate": "2020-03-11T12:44:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE3MjMyMA==", "url": "https://github.com/elastic/elasticsearch/pull/53317#discussion_r391172320", "bodyText": "should this be WARNING instead of CRITICAL ?\nIf the setting is removed, won't it be be \"archived\" allowing the server to continue to function ? I think we are trying to reserve CRITICAL for things items that will prevent the server from running.", "author": "jakelandis", "createdAt": "2020-03-11T18:18:07Z", "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/NodeDeprecationChecks.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.deprecation;\n+\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.xpack.core.deprecation.DeprecationIssue;\n+\n+import java.util.Locale;\n+\n+public class NodeDeprecationChecks {\n+\n+    static DeprecationIssue checkRemovedSetting(final Settings settings, final Setting<?> removedSetting, final String url) {\n+        if (removedSetting.exists(settings) == false) {\n+            return null;\n+        }\n+        final String removedSettingKey = removedSetting.getKey();\n+        final String value = removedSetting.get(settings).toString();\n+        final String message =\n+            String.format(Locale.ROOT, \"setting [%s] is deprecated and will be removed in the next major version\", removedSettingKey);\n+        final String details =\n+            String.format(Locale.ROOT, \"the setting [%s] is currently set to [%s], remove this setting\", removedSettingKey, value);\n+        return new DeprecationIssue(DeprecationIssue.Level.CRITICAL, message, url, details);", "originalCommit": "e9a24da88caea12d0d272806051cc7a8aec5d74d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE4ODEwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/53317#discussion_r391188101", "bodyText": "Not necessarily, because these could be node level settings, which we don't archive, which do prevent startup if they are unrecognized. Also, we have discussing removing the archiving of settings, so this behavior could change for cluster-level settings too.", "author": "jasontedor", "createdAt": "2020-03-11T18:45:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE3MjMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIxNDQ1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/53317#discussion_r391214451", "bodyText": "In that case, should we flex WARNING or CRITICAL based if the setting has node scope ?\nAlso, should we check that that value is not the default value here so we don't issue an issue a deprecation issue for settings that user never changed ?", "author": "jakelandis", "createdAt": "2020-03-11T19:36:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE3MjMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIxNjE0MA==", "url": "https://github.com/elastic/elasticsearch/pull/53317#discussion_r391216140", "bodyText": "There is a check that the setting is not set on line 18?", "author": "jasontedor", "createdAt": "2020-03-11T19:39:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE3MjMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIxODQ3NA==", "url": "https://github.com/elastic/elasticsearch/pull/53317#discussion_r391218474", "bodyText": "ah .. i missed \"Note that fallback settings are excluded.\" in the exists method.", "author": "jakelandis", "createdAt": "2020-03-11T19:44:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE3MjMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIxOTMxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/53317#discussion_r391219315", "bodyText": "Yeah, that's why we have Setting#existsOrFallbackExists.", "author": "jasontedor", "createdAt": "2020-03-11T19:45:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE3MjMyMA=="}], "type": "inlineReview"}]}