{"pr_number": 65779, "pr_title": "Fix test sending body as url parameter", "pr_createdAt": "2020-12-02T21:29:10Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65779", "timeline": [{"oid": "4e41af07503f592915410469b59bd9c8337a3b4a", "url": "https://github.com/elastic/elasticsearch/commit/4e41af07503f592915410469b59bd9c8337a3b4a", "message": "Fix test sending body as url parameter\n\nOur test framework randomly sends the body of requests over the `source`\nparameter. We never send the body if it is more than 2000 bytes becuse\nour HTTP receiver can't handle lines more the 4096 bytes. The thing is,\nwhen we do that 2000 bytes check we do it against the reported length of\nbody, not the body after it has been url encoded. Than url encoding\nstrings can *vastly* increase their size. Which could cause us to send\nsome request over the URL that are longer than 4096 bytes.\n\nThis fixes that by checking the url encoded length as well. We keep the\n2000 byte check of the unencoded length because it is a nice fast check,\neven if it is a bit inaccurate.\n\nCloses #65718", "committedDate": "2020-12-02T21:12:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk0MTM3MA==", "url": "https://github.com/elastic/elasticsearch/pull/65779#discussion_r534941370", "bodyText": "Should this be changed back to debug?", "author": "romseygeek", "createdAt": "2020-12-03T08:47:23Z", "path": "test/framework/src/main/java/org/elasticsearch/test/rest/yaml/ClientYamlTestClient.java", "diffHunk": "@@ -158,8 +166,8 @@ public ClientYamlTestResponse callApi(String apiName, Map<String, String> params\n             }\n             String contentType = entity.getContentType().getValue();\n             //randomly test the GET with source param instead of GET/POST with body\n-            if (sendBodyAsSourceParam(supportedMethods, contentType, entity.getContentLength())) {\n-                logger.debug(\"sending the request body as source param with GET method\");\n+            if (sendBodyAsSourceParam(supportedMethods, contentType, entity)) {\n+                logger.error(\"sending the request body as source param with GET method\");", "originalCommit": "4e41af07503f592915410469b59bd9c8337a3b4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyNTY5NA==", "url": "https://github.com/elastic/elasticsearch/pull/65779#discussion_r537525694", "bodyText": "yeah.", "author": "nik9000", "createdAt": "2020-12-07T13:58:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk0MTM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk0NTUxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/65779#discussion_r534945515", "bodyText": "NB on backport this needs to restore a previous skip version that looks like this:\n - skip:\n      version: \" - 6.99.99\"\n      reason: \"The regex length limit was introduced in 7.0.0\"", "author": "romseygeek", "createdAt": "2020-12-03T08:49:24Z", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/30_limits.yml", "diffHunk": "@@ -116,9 +116,6 @@ setup:\n \n ---\n \"Regexp length limit\":\n-  - skip:\n-      version: all\n-      reason: Long regex breaks HTTP query length when request body is sent as a query param - https://github.com/elastic/elasticsearch/issues/65718", "originalCommit": "4e41af07503f592915410469b59bd9c8337a3b4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyNTc4NA==", "url": "https://github.com/elastic/elasticsearch/pull/65779#discussion_r537525784", "bodyText": "Thanks!", "author": "nik9000", "createdAt": "2020-12-07T13:58:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk0NTUxNQ=="}], "type": "inlineReview"}, {"oid": "41c30cdf800962e8de6ac01d8066e02f2fdef907", "url": "https://github.com/elastic/elasticsearch/commit/41c30cdf800962e8de6ac01d8066e02f2fdef907", "message": "Revert debug change", "committedDate": "2020-12-07T15:00:54Z", "type": "commit"}, {"oid": "9e50a6967d0ca13f02e7526f8c9071feda3212da", "url": "https://github.com/elastic/elasticsearch/commit/9e50a6967d0ca13f02e7526f8c9071feda3212da", "message": "Merge branch 'master' into too_long_http", "committedDate": "2020-12-07T15:34:13Z", "type": "commit"}]}