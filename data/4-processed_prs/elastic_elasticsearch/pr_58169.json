{"pr_number": 58169, "pr_title": "Delete auto-generated annotations when job is deleted.", "pr_createdAt": "2020-06-16T13:51:23Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58169", "timeline": [{"oid": "4375cb412eadca08ae886725cdd78a3ad5a6a2ba", "url": "https://github.com/elastic/elasticsearch/commit/4375cb412eadca08ae886725cdd78a3ad5a6a2ba", "message": "Delete auto-generated annotations when job is deleted.", "committedDate": "2020-06-16T13:49:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5NjIzMA==", "url": "https://github.com/elastic/elasticsearch/pull/58169#discussion_r440896230", "bodyText": "I know you've just copied it from above, but this comment is no longer correct - we are only deleting the most recent ID format.  So please delete this comment.", "author": "droberts195", "createdAt": "2020-06-16T14:30:11Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportDeleteJobAction.java", "diffHunk": "@@ -444,25 +451,18 @@ private void deleteJobDocuments(ParentTaskAssigningClient parentTaskClient, Stri\n     }\n \n     private void deleteQuantiles(ParentTaskAssigningClient parentTaskClient, String jobId, ActionListener<Boolean> finishedHandler) {\n-        // The quantiles type and doc ID changed in v5.5 so delete both the old and new format\n-        DeleteByQueryRequest request = new DeleteByQueryRequest(AnomalyDetectorsIndex.jobStateIndexPattern());\n         // Just use ID here, not type, as trying to delete different types spams the logs with an exception stack trace\n         IdsQueryBuilder query = new IdsQueryBuilder().addIds(Quantiles.documentId(jobId));\n-        request.setQuery(query);\n-        request.setIndicesOptions(MlIndicesUtils.addIgnoreUnavailable(IndicesOptions.lenientExpandOpen()));\n-        request.setAbortOnVersionConflict(false);\n-        request.setRefresh(true);\n+        // The quantiles type and doc ID changed in v5.5 so delete both the old and new format", "originalCommit": "4375cb412eadca08ae886725cdd78a3ad5a6a2ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI4NTAxNA==", "url": "https://github.com/elastic/elasticsearch/pull/58169#discussion_r441285014", "bodyText": "Done.", "author": "przemekwitek", "createdAt": "2020-06-17T05:15:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5NjIzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5NjYwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/58169#discussion_r440896609", "bodyText": "As above, it's no longer true that we're deleting the 5.4 ID format, so please delete this comment.", "author": "droberts195", "createdAt": "2020-06-16T14:30:40Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportDeleteJobAction.java", "diffHunk": "@@ -479,14 +479,14 @@ private void deleteModelState(ParentTaskAssigningClient parentTaskClient, String\n \n     private void deleteCategorizerState(ParentTaskAssigningClient parentTaskClient, String jobId, int docNum,\n                                         ActionListener<Boolean> finishedHandler) {\n-        // The categorizer state type and doc ID changed in v5.5 so delete both the old and new format\n-        DeleteByQueryRequest request = new DeleteByQueryRequest(AnomalyDetectorsIndex.jobStateIndexPattern());\n         // Just use ID here, not type, as trying to delete different types spams the logs with an exception stack trace\n         IdsQueryBuilder query = new IdsQueryBuilder().addIds(CategorizerState.documentId(jobId, docNum));\n-        request.setQuery(query);\n-        request.setIndicesOptions(MlIndicesUtils.addIgnoreUnavailable(IndicesOptions.lenientExpandOpen()));\n-        request.setAbortOnVersionConflict(false);\n-        request.setRefresh(true);\n+        // The categorizer state type and doc ID changed in v5.5 so delete both the old and new format", "originalCommit": "4375cb412eadca08ae886725cdd78a3ad5a6a2ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI4NTA0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/58169#discussion_r441285041", "bodyText": "Done.", "author": "przemekwitek", "createdAt": "2020-06-17T05:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5NjYwOQ=="}], "type": "inlineReview"}, {"oid": "e8be74499cde2088c61c797f6690861cd1e59b30", "url": "https://github.com/elastic/elasticsearch/commit/e8be74499cde2088c61c797f6690861cd1e59b30", "message": "Apply review comments", "committedDate": "2020-06-17T05:14:33Z", "type": "commit"}]}