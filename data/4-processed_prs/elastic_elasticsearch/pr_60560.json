{"pr_number": 60560, "pr_title": "Convert packaging upgrade tests to java", "pr_createdAt": "2020-08-01T02:06:09Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60560", "timeline": [{"oid": "ecee6ea644a1af1238ac9ea1ac7cbadc82a5a8c8", "url": "https://github.com/elastic/elasticsearch/commit/ecee6ea644a1af1238ac9ea1ac7cbadc82a5a8c8", "message": "Convert packaging upgrade tests to java\n\nThis commit removes the last of the bats tests, converting the rpm/deb\nupgrade tests to java. It adds a new pattern of tasks, similar in nature\nbut separate from the existing distro tests, named `distroUpgradeTest`.\nFor each index compatible version, a `distroUpgradeTest.VERSION` task\nexxists. Each distribution then has a task, named\n`distroUpgradeTest.VERSION.DISTRO`.\n\nOne thing to note is these new tests do not cover no-jdk versions of\nthe rpm/deb packages, since the distribution/bwc project does not\ncurrently build those.\n\ncloses #59145\ncloses #46005", "committedDate": "2020-08-01T01:53:41Z", "type": "commit"}, {"oid": "841871fe4a965811ea7dd3e65b152e2bdc0cc728", "url": "https://github.com/elastic/elasticsearch/commit/841871fe4a965811ea7dd3e65b152e2bdc0cc728", "message": "checkstyle/spotless", "committedDate": "2020-08-01T02:20:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYwNDQ3NA==", "url": "https://github.com/elastic/elasticsearch/pull/60560#discussion_r464604474", "bodyText": "Yay!", "author": "mark-vieira", "createdAt": "2020-08-03T19:00:36Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/BatsTestTask.java", "diffHunk": "@@ -1,131 +0,0 @@\n-/*", "originalCommit": "841871fe4a965811ea7dd3e65b152e2bdc0cc728", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4MzE3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/60560#discussion_r464683177", "bodyText": "I'm now wondering if this intermediary task is striclty necessary. Is there anyreason why the test task can't just depend directly on the distribution, and the VM tasks depend on all distributions?", "author": "mark-vieira", "createdAt": "2020-08-03T21:56:21Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -100,58 +88,101 @@ public void apply(Project project) {\n \n         // TODO: it would be useful to also have the SYSTEM_JAVA_HOME setup in the root project, so that running from GCP only needs\n         // a java for gradle to run, and the tests are self sufficient and consistent with the java they use\n+        NamedDomainObjectContainer<ElasticsearchDistribution> allDistributions = DistributionDownloadPlugin.getContainer(project);\n+        List<ElasticsearchDistribution> testDistributions = configureDistributions(project);\n \n-        Version upgradeVersion = getUpgradeVersion(project);\n-        Provider<Directory> distributionsDir = project.getLayout().getBuildDirectory().dir(\"packaging/distributions\");\n-        Provider<Directory> upgradeDir = project.getLayout().getBuildDirectory().dir(\"packaging/upgrade\");\n-\n-        List<ElasticsearchDistribution> distributions = configureDistributions(project, upgradeVersion);\n-        TaskProvider<Copy> copyDistributionsTask = configureCopyDistributionsTask(project, distributionsDir);\n-        TaskProvider<Copy> copyUpgradeTask = configureCopyUpgradeTask(project, upgradeVersion, upgradeDir);\n-\n-        Map<ElasticsearchDistribution.Type, TaskProvider<?>> lifecyleTasks = lifecyleTasks(project, \"destructiveDistroTest\");\n+        Map<ElasticsearchDistribution.Type, TaskProvider<?>> lifecycleTasks = lifecycleTasks(project, \"destructiveDistroTest\");\n+        Map<String, TaskProvider<?>> versionTasks = versionTasks(project, \"destructiveDistroUpgradeTest\");\n         TaskProvider<Task> destructiveDistroTest = project.getTasks().register(\"destructiveDistroTest\");\n \n         Configuration examplePlugin = configureExamplePlugin(project);\n \n-        for (ElasticsearchDistribution distribution : distributions) {\n-            TaskProvider<?> destructiveTask = configureDistroTest(project, distribution, dockerSupport, examplePlugin);\n+        List<TaskProvider<Test>> windowsTestTasks = new ArrayList<>();\n+        Map<Type, List<TaskProvider<Test>>> linuxTestTasks = new HashMap<>();\n+        Map<String, List<TaskProvider<Test>>> upgradeTestTasks = new HashMap<>();\n+        Map<String, TaskProvider<?>> depsTasks = new HashMap<>();\n+        for (ElasticsearchDistribution distribution : testDistributions) {\n+            String taskname = destructiveDistroTestTaskName(distribution);\n+            TaskProvider<?> depsTask = project.getTasks().register(taskname + \"#deps\");", "originalCommit": "841871fe4a965811ea7dd3e65b152e2bdc0cc728", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY5MDA2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/60560#discussion_r464690069", "bodyText": "I don't think we want the VM task depending on all distributions. That would mean a repro line would rebuild all distros, instead of just the one you are trying to run.", "author": "rjernst", "createdAt": "2020-08-03T22:14:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4MzE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY5NzA4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/60560#discussion_r464697085", "bodyText": "Ok, I got confused by the fact we are passing all the deps tasks to the wrapper task creation. Couldn't we do the same thing though, and directly bucket the distributions, instead of the deps tasks? Just seems another layer we don't really need.", "author": "mark-vieira", "createdAt": "2020-08-03T22:34:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4MzE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxMDk4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/60560#discussion_r464710985", "bodyText": "We would need to apply the distro download plugin inside the subprojects (ie the ones with the wrapper tasks), as well as produce the test jar as an artifact. However, that is a lot of extra work that is not useful since we don't actually need those in the subproject to run, we only want to ensure the tasks in :qa:os ran before launching the VM task.", "author": "rjernst", "createdAt": "2020-08-03T23:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4MzE3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4NjY2MA==", "url": "https://github.com/elastic/elasticsearch/pull/60560#discussion_r464686660", "bodyText": "Why rename this? I think having \"VM\" in the name is helpful. Else let's add a comment.", "author": "mark-vieira", "createdAt": "2020-08-03T22:05:24Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -323,69 +295,52 @@ private static Configuration configureExamplePlugin(Project project) {\n         return examplePlugin;\n     }\n \n-    private static TaskProvider<GradleDistroTestTask> configureVMWrapperTask(\n+    private static void configureWrapperTasks(", "originalCommit": "841871fe4a965811ea7dd3e65b152e2bdc0cc728", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a236723df11dbee440488a9d5c5fb1fff4964f48", "url": "https://github.com/elastic/elasticsearch/commit/a236723df11dbee440488a9d5c5fb1fff4964f48", "message": "add VM back to wrapper method name", "committedDate": "2020-08-03T22:16:25Z", "type": "commit"}]}