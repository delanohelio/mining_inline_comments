{"pr_number": 55073, "pr_title": "Define aarch64 packaging test tasks", "pr_createdAt": "2020-04-10T15:46:56Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55073", "timeline": [{"oid": "e5fdb8a0831be47def2038a12b958bbdd5327313", "url": "https://github.com/elastic/elasticsearch/commit/e5fdb8a0831be47def2038a12b958bbdd5327313", "message": "Define aarch64 packaging test tasks\n\nWe added tasks to build an ARM distribution and Docker image, but didn't\nprovide any way to run packaging tests against them. Add extra loops on\nthe possible Architecture values, and skip tasks that can't be run on\nthe current Architecture.", "committedDate": "2020-04-10T15:36:07Z", "type": "commit"}, {"oid": "24f0eb9d1dd37359201ec4e2fe2d30ba90000e4b", "url": "https://github.com/elastic/elasticsearch/commit/24f0eb9d1dd37359201ec4e2fe2d30ba90000e4b", "message": "Don't define non-x86 non-bundled JDK tasks\n\nAlso rename some boolean getters to have names that reflect the return\ntype, since it makes the resulting code clearer.", "committedDate": "2020-04-13T08:51:08Z", "type": "commit"}, {"oid": "21a723a46b01670976f299a0a9165ceb151e6ab9", "url": "https://github.com/elastic/elasticsearch/commit/21a723a46b01670976f299a0a9165ceb151e6ab9", "message": "Merge remote-tracking branch 'upstream/master' into aarch64-packaging-test-tasks", "committedDate": "2020-04-13T09:02:00Z", "type": "commit"}, {"oid": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510", "url": "https://github.com/elastic/elasticsearch/commit/f4e3f82ce5a7a68155fe63bc19ba9bcde1091510", "message": "Configure arch in distribution-download/subproj", "committedDate": "2020-04-13T10:19:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2MTkxMg==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407661912", "bodyText": "The implementation is complicated by the fact that we're inconsistent regarding where the distribution architecture appears in the name\n\nWe should make this consistent then. My preference would be for the convention we take with the :archives project with the arch being a suffix. We should rename the docker and packages subprojects to match that convention so things are consisten IMO. @jasontedor thoughts?", "author": "mark-vieira", "createdAt": "2020-04-13T19:13:31Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DistributionDownloadPlugin.java", "diffHunk": "@@ -285,23 +285,52 @@ private static String distributionProjectPath(ElasticsearchDistribution distribu\n         return projectPath;\n     }\n \n+    /**\n+     * Works out the gradle project name that provides a distribution artifact. The implementation is\n+     * complicated by the fact that we're inconsistent regarding where the distribution architecture\n+     * appears in the name, and whether a distribution even exists for non-x86 architectures.", "originalCommit": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA1MTE0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r408051147", "bodyText": "I'm definitely in favour of making it consistent, but I'd prefer to do it as a separate change.", "author": "pugnascotia", "createdAt": "2020-04-14T11:02:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2MTkxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA1MTQ1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r408051452", "bodyText": "If you like, I could the work to make the project names consistent and merge that first.", "author": "pugnascotia", "createdAt": "2020-04-14T11:03:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2MTkxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA5MzIzMg==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r408093232", "bodyText": "I raised PR #55150.", "author": "pugnascotia", "createdAt": "2020-04-14T12:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2MTkxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzNDcwMA==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r408234700", "bodyText": "@mark-vieira This sounds good to me.", "author": "jasontedor", "createdAt": "2020-04-14T15:36:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2MTkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2MzMzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407663339", "bodyText": "I think one thing for not originally naming this \"has\" is that we configure one of these when we request a distribution and so the naming there makes a bit less sense when the context is that we are asking for a distribution w/ or w/o a bundled JDK.", "author": "mark-vieira", "createdAt": "2020-04-13T19:16:18Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java", "diffHunk": "@@ -182,22 +184,30 @@ public void setFlavor(Flavor flavor) {\n         this.flavor.set(flavor);\n     }\n \n-    public boolean getBundledJdk() {\n+    public boolean hasBundledJdk() {", "originalCommit": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA0ODAxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r408048019", "bodyText": "I've reverted these renames.", "author": "pugnascotia", "createdAt": "2020-04-14T10:57:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2MzMzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2NDU3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407664572", "bodyText": "Again, this isn't only a description of the distribution, we configure this to ask for a distribution. So in that context we are telling the build to fail or not.\nI think in this case we can just make this getter private. It's only used here locally and nothing else should be inspecting this properly. Whatever we do we should make the getter and setter the same name though, even if the getter is private.", "author": "mark-vieira", "createdAt": "2020-04-13T19:18:39Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java", "diffHunk": "@@ -182,22 +184,30 @@ public void setFlavor(Flavor flavor) {\n         this.flavor.set(flavor);\n     }\n \n-    public boolean getBundledJdk() {\n+    public boolean hasBundledJdk() {\n         return bundledJdk.getOrElse(true);\n     }\n \n     public void setBundledJdk(Boolean bundledJdk) {\n         this.bundledJdk.set(bundledJdk);\n     }\n \n-    public boolean getFailIfUnavailable() {\n+    public boolean shouldFailIfUnavailable() {", "originalCommit": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2NzM1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407667359", "bodyText": "FYI, you can add multiple onlyIf conditions, which I think i easier to reason about than having a single more complex conditional. Basically I only run this task if \"docker works\" and \"it's the right architecture\".", "author": "mark-vieira", "createdAt": "2020-04-13T19:23:39Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -346,8 +349,14 @@ public String toString() {\n         Provider<DockerSupportService> dockerSupport\n     ) {\n         return project.getTasks().register(destructiveDistroTestTaskName(distribution), Test.class, t -> {\n+            // Only run tests for the current architecture\n             // Disable Docker distribution tests unless a Docker installation is available\n-            t.onlyIf(t2 -> distribution.getType() != Type.DOCKER || dockerSupport.get().getDockerAvailability().isAvailable);\n+            t.onlyIf(t2 -> {", "originalCommit": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA0ODk4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r408048985", "bodyText": "Nice, TIL.", "author": "pugnascotia", "createdAt": "2020-04-14T10:59:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2NzM1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2ODk2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407668963", "bodyText": "I'd like clarification on this. Why wouldn't we? One main difference between the archives is the version of the bundled JDK but there are other differences (config changes, eventually ml binaries, etc). @jasontedor what's the rationale for offering a no-jdk distro for x86 but not arm?", "author": "mark-vieira", "createdAt": "2020-04-13T19:26:46Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -381,47 +390,68 @@ public String toString() {\n         List<ElasticsearchDistribution> currentDistros = new ArrayList<>();\n         List<ElasticsearchDistribution> upgradeDistros = new ArrayList<>();\n \n-        for (Type type : List.of(Type.DEB, Type.RPM, Type.DOCKER)) {\n-            for (Flavor flavor : Flavor.values()) {\n-                for (boolean bundledJdk : Arrays.asList(true, false)) {\n-                    // All our Docker images include a bundled JDK so it doesn't make sense to test without one\n-                    boolean skip = type == Type.DOCKER && bundledJdk == false;\n-\n-                    if (skip == false) {\n-                        addDistro(distributions, type, null, flavor, bundledJdk, VersionProperties.getElasticsearch(), currentDistros);\n+        for (Architecture architecture : Architecture.values()) {\n+            for (Type type : List.of(Type.DEB, Type.RPM, Type.DOCKER)) {\n+                for (Flavor flavor : Flavor.values()) {\n+                    for (boolean bundledJdk : Arrays.asList(true, false)) {\n+                        // All our Docker images include a bundled JDK so it doesn't make sense to test without one.\n+                        // Also we'll never publish an ARM (aarch64) build without a bundled JDK.", "originalCommit": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExNzc5NA==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r408117794", "bodyText": "Yes, this is deliberate that we do not have a no-jdk distribution for aarch64. The reason is because we'd like to go the other direction and eventually remove the no-jdk distribution. It's easier for us to start from a position of there is no-jdk distribution and adding one if sufficient demand proves that it's needed, than it is to start from a position of having it and later trying to remove it (we are already in a difficult position with the no-jdk images for x64).", "author": "jasontedor", "createdAt": "2020-04-14T13:02:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2ODk2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY3MDEwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407670109", "bodyText": "Hmmm, don't we already have an issue where this blows up if we don't have Docker installed?", "author": "mark-vieira", "createdAt": "2020-04-13T19:29:02Z", "path": "distribution/docker/build.gradle", "diffHunk": "@@ -236,6 +239,8 @@ subprojects { Project subProject ->\n \n     exportDockerImageTask.dependsOn(parent.tasks.getByName(buildTaskName))\n \n+    exportDockerImageTask.onlyIf { Architecture.current().name().toLowerCase().equals(architecture) }", "originalCommit": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA1MDIzMw==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r408050233", "bodyText": "I don't know. The reason I added this was to stop the build from potentially exporting a Docker image of the wrong arch, from a previous build. I do think we should put the arch in the tag name, and we'll likely have to in order to create multi-arch builds.", "author": "pugnascotia", "createdAt": "2020-04-14T11:01:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY3MDEwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY3MDUwOA==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407670508", "bodyText": "Should this technically use the current architecture instead of being hard-coded to x86?", "author": "mark-vieira", "createdAt": "2020-04-13T19:29:43Z", "path": "qa/remote-clusters/build.gradle", "diffHunk": "@@ -42,6 +44,7 @@ task copyKeystore(type: Sync) {\n elasticsearch_distributions {\n   docker {\n     type = 'docker'\n+    architecture = Architecture.X64", "originalCommit": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA0OTE1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r408049152", "bodyText": "Yes.", "author": "pugnascotia", "createdAt": "2020-04-14T10:59:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY3MDUwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY3MDY4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407670681", "bodyText": "Same as above. Why not use current arch?", "author": "mark-vieira", "createdAt": "2020-04-13T19:29:59Z", "path": "qa/wildfly/build.gradle", "diffHunk": "@@ -55,6 +56,7 @@ war {\n elasticsearch_distributions {\n   docker {\n     type = 'docker'\n+    architecture = Architecture.X64", "originalCommit": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA0OTMyNg==", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r408049326", "bodyText": "Yes again. Both now use the current arch.", "author": "pugnascotia", "createdAt": "2020-04-14T10:59:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY3MDY4MQ=="}], "type": "inlineReview"}, {"oid": "dfba5915cf478a5a66beb3ef4ac6dd83b994d5ab", "url": "https://github.com/elastic/elasticsearch/commit/dfba5915cf478a5a66beb3ef4ac6dd83b994d5ab", "message": "Address review comments", "committedDate": "2020-04-14T10:56:55Z", "type": "commit"}, {"oid": "5385a77849ad23118cfe434b82df8b6b52e0e0c5", "url": "https://github.com/elastic/elasticsearch/commit/5385a77849ad23118cfe434b82df8b6b52e0e0c5", "message": "Merge remote-tracking branch 'upstream/master' into aarch64-packaging-test-tasks", "committedDate": "2020-04-14T21:11:27Z", "type": "commit"}, {"oid": "ee4ffea19eb4ed04be75683aae17e9d8bf9bf5f6", "url": "https://github.com/elastic/elasticsearch/commit/ee4ffea19eb4ed04be75683aae17e9d8bf9bf5f6", "message": "Updates and polishing after master merge", "committedDate": "2020-04-15T10:21:04Z", "type": "commit"}]}