{"pr_number": 66342, "pr_title": "Avoid building ES archives for bwc nested builds", "pr_createdAt": "2020-12-15T13:31:48Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66342", "timeline": [{"oid": "bdfbfb238e0db2d51d63bfefcf2213e84fef5736", "url": "https://github.com/elastic/elasticsearch/commit/bdfbfb238e0db2d51d63bfefcf2213e84fef5736", "message": "Fix checkstyle", "committedDate": "2020-12-15T15:38:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU4Njc2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/66342#discussion_r544586766", "bodyText": "I think this should be private.", "author": "mark-vieira", "createdAt": "2020-12-16T20:04:09Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionBwcSetupPlugin.java", "diffHunk": "@@ -225,49 +245,59 @@ static void createBuildBwcTask(\n      * we build from a bwc Version in a cloned repository\n      */\n     private static class DistributionProject {\n-        private final String name;\n-        private File checkoutDir;\n-        private String projectPath;\n-        private File distFile;\n-        private File expandedDistDir;\n+        final String name;\n+        final File checkoutDir;\n+        final String projectPath;\n+\n+        /**\n+         * can be removed once we don't build 7.10 anymore\n+         * from source for bwc tests.\n+         * */\n+        @Deprecated\n+        final boolean expandedDistDirSupport;\n+        final boolean extractedAssembleSupported;\n+        final DistributionProjectArtifact expectedBuildArtifact;\n \n         DistributionProject(String name, String baseDir, Version version, String classifier, String extension, File checkoutDir) {\n             this.name = name;\n             this.checkoutDir = checkoutDir;\n             this.projectPath = baseDir + \"/\" + name;\n-            this.distFile = new File(\n-                checkoutDir,\n-                baseDir\n-                    + \"/\"\n-                    + name\n-                    + \"/build/distributions/elasticsearch-\"\n-                    + (name.startsWith(\"oss\") ? \"oss-\" : \"\")\n-                    + version\n-                    + \"-SNAPSHOT\"\n-                    + classifier\n-                    + \".\"\n-                    + extension\n+            this.expandedDistDirSupport = version.onOrAfter(\"7.10.0\") && (name.endsWith(\"zip\") || name.endsWith(\"tar\"));\n+            this.extractedAssembleSupported = version.onOrAfter(\"7.11.0\") && (name.endsWith(\"zip\") || name.endsWith(\"tar\"));", "originalCommit": "675e7e0953724ec5e28cf5697fd0551c996f6163", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5NDkxOA==", "url": "https://github.com/elastic/elasticsearch/pull/66342#discussion_r544594918", "bodyText": "One thing we lose here with the directory approach is the check that this created the correct version. When we forget to bump versions in branches this will error in a scenario where we expect it to produce an artifact with say, version 7.11.0 but instead 7.12.0 is created. This is an indicator a version bump was missed and we are not testing the thing we expect.\nThat works with the file approach, as the version is embedded in the expected file name, but here we are simply looking for a folder .../build/install at which point that could container an exploded install directory with any version name. The expected build artifact should take this into account. We should specifically ensure the exploded folder name matches the expected version.", "author": "mark-vieira", "createdAt": "2020-12-16T20:17:21Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionBwcSetupPlugin.java", "diffHunk": "@@ -194,28 +206,36 @@ static void createBuildBwcTask(\n         Provider<Version> bwcVersion,\n         String projectName,\n         String projectPath,\n-        File projectArtifact,\n-        TaskProvider<Task> bwcTaskProvider\n+        DistributionProjectArtifact projectArtifact,\n+        TaskProvider<Task> bwcTaskProvider,\n+        String assembleTaskName\n     ) {\n         String bwcTaskName = buildBwcTaskName(projectName);\n         bwcSetupExtension.bwcTask(bwcTaskName, c -> {\n+            boolean useNativeExpanded = projectArtifact.expandedDistDir != null;\n+            File expectedOutputFile = useNativeExpanded ? projectArtifact.expandedDistDir : projectArtifact.distFile;\n             c.getInputs().file(new File(project.getBuildDir(), \"refspec\"));\n-            c.getOutputs().files(projectArtifact);\n+            if (useNativeExpanded) {\n+                c.getOutputs().dir(expectedOutputFile);\n+            } else {\n+                c.getOutputs().files(expectedOutputFile);\n+            }\n             c.getOutputs().cacheIf(\"BWC distribution caching is disabled on 'master' branch\", task -> {\n                 String gitBranch = System.getenv(\"GIT_BRANCH\");\n                 return BuildParams.isCi() && (gitBranch == null || gitBranch.endsWith(\"master\") == false);\n             });\n-            c.args(projectPath.replace('/', ':') + \":assemble\");\n+            c.args(projectPath.replace('/', ':') + \":\" + assembleTaskName);\n             if (project.getGradle().getStartParameter().isBuildCacheEnabled()) {\n                 c.args(\"--build-cache\");\n             }\n             c.doLast(task -> {\n-                if (projectArtifact.exists() == false) {\n+                if (expectedOutputFile.exists() == false) {", "originalCommit": "675e7e0953724ec5e28cf5697fd0551c996f6163", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5NTc0MA==", "url": "https://github.com/elastic/elasticsearch/pull/66342#discussion_r544595740", "bodyText": "Might also be worth adding a test case for this.", "author": "mark-vieira", "createdAt": "2020-12-16T20:18:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5NDkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDg2MzIxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/66342#discussion_r544863219", "bodyText": "will fix this in a separate pr as it involves fixing it on the producer and consumer side (across branches)", "author": "breskeby", "createdAt": "2020-12-17T07:20:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5NDkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1NTM2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/66342#discussion_r545455361", "bodyText": "Let's make sure we do this sooner rather than later as this is one of the primary ways we are notified that version bumps got messed up.", "author": "mark-vieira", "createdAt": "2020-12-17T22:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5NDkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1NTk3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/66342#discussion_r545455977", "bodyText": "and consumer side (across branches)\n\nI dont' think that's true as the install/ directory contains the exploded folder which looks something like elasticsearch-8.0.0-snapshot/ so we just need only check that the install directory contains another folder with the name we expect.", "author": "mark-vieira", "createdAt": "2020-12-17T22:52:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5NDkxOA=="}], "type": "inlineReview"}, {"oid": "fa0404cf74301fd26438173484b6c51a59773532", "url": "https://github.com/elastic/elasticsearch/commit/fa0404cf74301fd26438173484b6c51a59773532", "message": "Address review feedback", "committedDate": "2020-12-17T07:27:49Z", "type": "forcePushed"}, {"oid": "512630cc91e7c723b4020f218200471e3ce5f38b", "url": "https://github.com/elastic/elasticsearch/commit/512630cc91e7c723b4020f218200471e3ce5f38b", "message": "Avoid building ES archives for bwc nested builds\n\n- This closes the loop on avoiding building es archives for bwc tests when build from source\n- Instead of assemble the consuming builds request assembleExtracted", "committedDate": "2020-12-17T07:46:22Z", "type": "commit"}, {"oid": "6e2b5711aaab866cf0dbaae16abc46cff5bcd433", "url": "https://github.com/elastic/elasticsearch/commit/6e2b5711aaab866cf0dbaae16abc46cff5bcd433", "message": "Fix configuration reference to extractedAssemble", "committedDate": "2020-12-17T07:46:24Z", "type": "commit"}, {"oid": "634c0eb2e1ed6567aba48576d88e64a64622566c", "url": "https://github.com/elastic/elasticsearch/commit/634c0eb2e1ed6567aba48576d88e64a64622566c", "message": "native extracted bwc config only available since 7.11", "committedDate": "2020-12-17T07:46:24Z", "type": "commit"}, {"oid": "45bd4f4dec4a145a1175b936df152768e70ead1c", "url": "https://github.com/elastic/elasticsearch/commit/45bd4f4dec4a145a1175b936df152768e70ead1c", "message": "Distinguish between extractedAssemble and expandedDist support", "committedDate": "2020-12-17T07:46:25Z", "type": "commit"}, {"oid": "8ad36ffab64bb4f971b7fcf4ba6204bfd5395659", "url": "https://github.com/elastic/elasticsearch/commit/8ad36ffab64bb4f971b7fcf4ba6204bfd5395659", "message": "Fix checkstyle", "committedDate": "2020-12-17T07:46:25Z", "type": "commit"}, {"oid": "2d0d2dbba3e1ec847d1ffaf0bf45ec1d47adbf76", "url": "https://github.com/elastic/elasticsearch/commit/2d0d2dbba3e1ec847d1ffaf0bf45ec1d47adbf76", "message": "Address review feedback", "committedDate": "2020-12-17T07:46:26Z", "type": "commit"}, {"oid": "2d0d2dbba3e1ec847d1ffaf0bf45ec1d47adbf76", "url": "https://github.com/elastic/elasticsearch/commit/2d0d2dbba3e1ec847d1ffaf0bf45ec1d47adbf76", "message": "Address review feedback", "committedDate": "2020-12-17T07:46:26Z", "type": "forcePushed"}]}