{"pr_number": 61709, "pr_title": "Fix cluster health when closing", "pr_createdAt": "2020-08-31T11:13:22Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61709", "timeline": [{"oid": "809c2d6772b3daf78fc2d87e817e97fc13db3255", "url": "https://github.com/elastic/elasticsearch/commit/809c2d6772b3daf78fc2d87e817e97fc13db3255", "message": "Fix cluster health when closing\n\nWhen master shuts down it's cluster service, a waiting health request\nwould fail rather than fail over to a new master.", "committedDate": "2020-08-31T11:10:03Z", "type": "commit"}, {"oid": "568714624f395c9b29cbb76c909edd399ec08d15", "url": "https://github.com/elastic/elasticsearch/commit/568714624f395c9b29cbb76c909edd399ec08d15", "message": "Merge remote-tracking branch 'origin/master' into fix_cluster_health_when_master_closing", "committedDate": "2020-09-08T11:33:36Z", "type": "commit"}, {"oid": "cf465437c28e235958e11d5973943d715f170e22", "url": "https://github.com/elastic/elasticsearch/commit/cf465437c28e235958e11d5973943d715f170e22", "message": "Better way to provoke wait in test case", "committedDate": "2020-09-08T19:04:47Z", "type": "commit"}, {"oid": "1d9c96695ddfaee08c7d5d088ea18f0dcbb3c64b", "url": "https://github.com/elastic/elasticsearch/commit/1d9c96695ddfaee08c7d5d088ea18f0dcbb3c64b", "message": "Merge remote-tracking branch 'origin/master' into fix_cluster_health_when_master_closing", "committedDate": "2020-09-09T09:19:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU4NTEyNg==", "url": "https://github.com/elastic/elasticsearch/pull/61709#discussion_r485585126", "bodyText": "I'm confused. How can the cluster ever be green with that many replicas? Should this be number_of_shards?", "author": "ywelsch", "createdAt": "2020-09-09T12:50:48Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/cluster/ClusterHealthIT.java", "diffHunk": "@@ -309,14 +310,26 @@ public void clusterStateProcessed(String source, ClusterState oldState, ClusterS\n \n     public void testHealthOnMasterFailover() throws Exception {\n         final String node = internalCluster().startDataOnlyNode();\n+        boolean withIndex = randomBoolean();\n+        if (withIndex) {\n+            // create index with many shards to provoke the health request to wait (for green) while master is being shut down.\n+            createIndex(\"test\", Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, randomIntBetween(0, 10)).build());", "originalCommit": "1d9c96695ddfaee08c7d5d088ea18f0dcbb3c64b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU5MzAzNA==", "url": "https://github.com/elastic/elasticsearch/pull/61709#discussion_r485593034", "bodyText": "It ensures that the cluster is yellow when the health request is made, making the health request wait on the observer, triggering the call to onClusterServiceClose when master is shutdown.\nThe number of replicas is cleared to 0 after having fired all the async restarts and done the master restarts. That ensures that all the requests responds with green status.", "author": "henningandersen", "createdAt": "2020-09-09T13:02:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU4NTEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU5NTM3OA==", "url": "https://github.com/elastic/elasticsearch/pull/61709#discussion_r485595378", "bodyText": "ah ok, can you add a comment to that effect", "author": "ywelsch", "createdAt": "2020-09-09T13:06:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU4NTEyNg=="}], "type": "inlineReview"}, {"oid": "b89d99917eb8b7956b85d8eea12125fcba47c3b2", "url": "https://github.com/elastic/elasticsearch/commit/b89d99917eb8b7956b85d8eea12125fcba47c3b2", "message": "Merge remote-tracking branch 'origin/master' into fix_cluster_health_when_master_closing", "committedDate": "2020-09-18T14:18:05Z", "type": "commit"}, {"oid": "89cc97f0933aeeb47d2e6f24241917fb6cbdc261", "url": "https://github.com/elastic/elasticsearch/commit/89cc97f0933aeeb47d2e6f24241917fb6cbdc261", "message": "Add comment", "committedDate": "2020-09-18T14:20:37Z", "type": "commit"}]}