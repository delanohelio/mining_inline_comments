{"pr_number": 64224, "pr_title": "Enable geo_distance and geo_bounding_box queries on geo_shape field type", "pr_createdAt": "2020-10-27T14:06:21Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64224", "timeline": [{"oid": "745d847f7514eaecd6ddd77f99220f941fcd324e", "url": "https://github.com/elastic/elasticsearch/commit/745d847f7514eaecd6ddd77f99220f941fcd324e", "message": "Enable geo_distance and geo_bounding_box queries on geo_shape field type", "committedDate": "2020-10-27T14:03:48Z", "type": "commit"}, {"oid": "1621132b8c7a99f71f824be1c7b875296bd7943c", "url": "https://github.com/elastic/elasticsearch/commit/1621132b8c7a99f71f824be1c7b875296bd7943c", "message": "fix tests", "committedDate": "2020-10-27T15:24:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAxNTkyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64224#discussion_r513015929", "bodyText": "whoa, I didn't know this is possible", "author": "talevy", "createdAt": "2020-10-27T20:40:33Z", "path": "docs/reference/query-dsl/geo-bounding-box-query.asciidoc", "diffHunk": "@@ -316,6 +395,8 @@ that the `geo_point` type must have lat and lon indexed in this case).\n Note, when using the indexed option, multi locations per document field\n are not supported. Here is an example:\n \n+//./gradlew ':docs:integTest' --tests \"org.elasticsearch.smoketest.DocsClientYamlTestSuiteIT.test {yaml=reference/query-dsl/geo-bounding-box-query/*}\"", "originalCommit": "1621132b8c7a99f71f824be1c7b875296bd7943c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "19e79553d8c4d45190598b5f7636588fedce2e78", "url": "https://github.com/elastic/elasticsearch/commit/19e79553d8c4d45190598b5f7636588fedce2e78", "message": "left-overs", "committedDate": "2020-10-28T08:11:52Z", "type": "commit"}, {"oid": "ae899fd8cf446d9b0908bcd61bd0b5faef783000", "url": "https://github.com/elastic/elasticsearch/commit/ae899fd8cf446d9b0908bcd61bd0b5faef783000", "message": "Merge branch 'master' into GeoBoundsCircleQueries", "committedDate": "2020-10-28T08:11:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQxNDYwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64224#discussion_r513414605", "bodyText": "Your changes are great, but there were some issues with the original language.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            A query allowing to filter hits based on the intersection of a bounding box with\n          \n          \n            \n            data stored on a `geo_shape` or `geo_point` field. Assuming the following indexed documents:\n          \n          \n            \n            Matches <<geo-point,`geo_point`>> and <<geo-shape,`geo_shape`>> values that\n          \n          \n            \n            intersect a bounding box.\n          \n          \n            \n            \n          \n          \n            \n            [discrete]\n          \n          \n            \n            [[geo-bounding-box-query-ex]]\n          \n          \n            \n            ==== Example\n          \n          \n            \n            \n          \n          \n            \n            Assume the following the following documents are indexed:", "author": "jrodewig", "createdAt": "2020-10-28T12:49:22Z", "path": "docs/reference/query-dsl/geo-bounding-box-query.asciidoc", "diffHunk": "@@ -4,8 +4,8 @@\n <titleabbrev>Geo-bounding box</titleabbrev>\n ++++\n \n-A query allowing to filter hits based on a point location using a\n-bounding box. Assuming the following indexed document:\n+A query allowing to filter hits based on the intersection of a bounding box with\n+data stored on a `geo_shape` or `geo_point` field. Assuming the following indexed documents:", "originalCommit": "ae899fd8cf446d9b0908bcd61bd0b5faef783000", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQzMzg5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64224#discussion_r513433895", "bodyText": "Your original text here is fine. Feel free to ignore if wanted.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Then the following simple query can be executed with a\n          \n          \n            \n            `geo_bounding_box` filter:\n          \n          \n            \n            `geo_bounding_box` filter against a `geo_point` field:\n          \n          \n            \n            Use a `geo_bounding_box` filter to match `geo_point` values that intersect a bounding\n          \n          \n            \n            box. To define the box, provide geopoint values for two opposite corners.", "author": "jrodewig", "createdAt": "2020-10-28T13:18:11Z", "path": "docs/reference/query-dsl/geo-bounding-box-query.asciidoc", "diffHunk": "@@ -33,11 +33,36 @@ PUT /my_locations/_doc/1\n     }\n   }\n }\n+\n+PUT /my_geoshapes\n+{\n+  \"mappings\": {\n+    \"properties\": {\n+      \"pin\": {\n+        \"properties\": {\n+          \"location\": {\n+            \"type\": \"geo_shape\"\n+          }\n+        }\n+      }\n+    }\n+  }\n+}\n+\n+PUT /my_geoshapes/_doc/1\n+{\n+  \"pin\": {\n+    \"location\": {\n+      \"type\" : \"polygon\",\n+      \"coordinates\" : [[[13.0 ,51.5], [15.0, 51.5], [15.0, 54.0], [13.0, 54.0], [13.0 ,51.5]]]\n+    }\n+  }\n+}\n --------------------------------------------------\n // TESTSETUP\n \n Then the following simple query can be executed with a\n-`geo_bounding_box` filter:\n+`geo_bounding_box` filter against a `geo_point` field:", "originalCommit": "ae899fd8cf446d9b0908bcd61bd0b5faef783000", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQzNDQ5NA==", "url": "https://github.com/elastic/elasticsearch/pull/64224#discussion_r513434494", "bodyText": "The text here is fine as-is. Feel free to ignore if wanted.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The same simple query can be executed against the 'geo_shape field:\n          \n          \n            \n            Use the same filter to match `geo_shape` values that intersect the bounding box:", "author": "jrodewig", "createdAt": "2020-10-28T13:19:06Z", "path": "docs/reference/query-dsl/geo-bounding-box-query.asciidoc", "diffHunk": "@@ -67,6 +92,67 @@ GET my_locations/_search\n }\n --------------------------------------------------\n \n+\n+The same simple query can be executed against the 'geo_shape field:", "originalCommit": "ae899fd8cf446d9b0908bcd61bd0b5faef783000", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQzNTQ2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64224#discussion_r513435466", "bodyText": "Your text is fine as-is. Feel free to ignore if wanted.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Or it can be executed in both indexes at the same time:\n          \n          \n            \n            To match both `geo_point` and `geo_shape` values, search both indices:", "author": "jrodewig", "createdAt": "2020-10-28T13:20:26Z", "path": "docs/reference/query-dsl/geo-bounding-box-query.asciidoc", "diffHunk": "@@ -67,6 +92,67 @@ GET my_locations/_search\n }\n --------------------------------------------------\n \n+\n+The same simple query can be executed against the 'geo_shape field:\n+\n+[source,console]\n+--------------------------------------------------\n+GET my_locations,my_geoshapes/_search\n+{\n+  \"query\": {\n+    \"bool\": {\n+      \"must\": {\n+        \"match_all\": {}\n+      },\n+      \"filter\": {\n+        \"geo_bounding_box\": {\n+          \"pin.location\": {\n+            \"top_left\": {\n+              \"lat\": 40.73,\n+              \"lon\": -74.1\n+            },\n+            \"bottom_right\": {\n+              \"lat\": 40.01,\n+              \"lon\": -71.12\n+            }\n+          }\n+        }\n+      }\n+    }\n+  }\n+}\n+--------------------------------------------------\n+\n+Or it can be executed in both indexes at the same time:", "originalCommit": "ae899fd8cf446d9b0908bcd61bd0b5faef783000", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ0MTY4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64224#discussion_r513441681", "bodyText": "There are some grammar issues with the current text.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Likewise, geoshapes have the same precision limitations. Therefore, shape edges\n          \n          \n            \n            along the lower bounds (bottom and left edges of the bounding box) might not make it into\n          \n          \n            \n            the bounding box due to the rounding error. At the same time edges alongs\n          \n          \n            \n            the upper bounds (top and right edges) might be selected by the query even if\n          \n          \n            \n            they are located slightly outside the edge.\n          \n          \n            \n            Geoshapes also have limited precision due to rounding. Geoshape edges along the\n          \n          \n            \n            bounding box's bottom and left edges may not match a `geo_bounding_box` query.\n          \n          \n            \n            Geoshape edges slightly outside the box's top and right edges may still match\n          \n          \n            \n            the query.", "author": "jrodewig", "createdAt": "2020-10-28T13:28:59Z", "path": "docs/reference/query-dsl/geo-bounding-box-query.asciidoc", "diffHunk": "@@ -366,3 +445,9 @@ the upper bounds (top and right edges) might be selected by the query even if\n they are located slightly outside the edge. The rounding error should be less\n than 4.20e-8 degrees on the latitude and less than 8.39e-8 degrees on the\n longitude, which translates to less than 1cm error even at the equator.\n+\n+Likewise, geoshapes have the same precision limitations. Therefore, shape edges\n+along the lower bounds (bottom and left edges of the bounding box) might not make it into\n+the bounding box due to the rounding error. At the same time edges alongs\n+the upper bounds (top and right edges) might be selected by the query even if\n+they are located slightly outside the edge.", "originalCommit": "ae899fd8cf446d9b0908bcd61bd0b5faef783000", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ0NTA1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64224#discussion_r513445052", "bodyText": "This searches the wrong indices.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            GET my_locations,my_geoshapes/_search\n          \n          \n            \n            GET my_geoshapes/_search", "author": "jrodewig", "createdAt": "2020-10-28T13:33:24Z", "path": "docs/reference/query-dsl/geo-bounding-box-query.asciidoc", "diffHunk": "@@ -67,6 +92,67 @@ GET my_locations/_search\n }\n --------------------------------------------------\n \n+\n+The same simple query can be executed against the 'geo_shape field:\n+\n+[source,console]\n+--------------------------------------------------\n+GET my_locations,my_geoshapes/_search", "originalCommit": "ae899fd8cf446d9b0908bcd61bd0b5faef783000", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ0NTE5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64224#discussion_r513445192", "bodyText": "Fix to search the right indices.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            GET my_geoshapes/_search\n          \n          \n            \n            GET my_locations,my_geoshapes/_search", "author": "jrodewig", "createdAt": "2020-10-28T13:33:36Z", "path": "docs/reference/query-dsl/geo-bounding-box-query.asciidoc", "diffHunk": "@@ -67,6 +92,67 @@ GET my_locations/_search\n }\n --------------------------------------------------\n \n+\n+The same simple query can be executed against the 'geo_shape field:\n+\n+[source,console]\n+--------------------------------------------------\n+GET my_locations,my_geoshapes/_search\n+{\n+  \"query\": {\n+    \"bool\": {\n+      \"must\": {\n+        \"match_all\": {}\n+      },\n+      \"filter\": {\n+        \"geo_bounding_box\": {\n+          \"pin.location\": {\n+            \"top_left\": {\n+              \"lat\": 40.73,\n+              \"lon\": -74.1\n+            },\n+            \"bottom_right\": {\n+              \"lat\": 40.01,\n+              \"lon\": -71.12\n+            }\n+          }\n+        }\n+      }\n+    }\n+  }\n+}\n+--------------------------------------------------\n+\n+Or it can be executed in both indexes at the same time:\n+\n+[source,console]\n+--------------------------------------------------\n+GET my_geoshapes/_search", "originalCommit": "ae899fd8cf446d9b0908bcd61bd0b5faef783000", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ1NTk5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64224#discussion_r513455993", "bodyText": "The current wording is a bit confusing and implies users can specify a geoshape in the query.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Filters documents that include only hits that exists within a specific\n          \n          \n            \n            distance from a geo point. Assuming the following mapping and indexed\n          \n          \n            \n            document:\n          \n          \n            \n            distance from a `geo_shape` or `geo_point` field. Assuming the following mapping and indexed\n          \n          \n            \n            documents:\n          \n          \n            \n            Matches <<geo-point,`geo_point`>> and <<geo-shape,`geo_shape`>> values within\n          \n          \n            \n            a given distance of a geopoint.\n          \n          \n            \n            \n          \n          \n            \n            [discrete]\n          \n          \n            \n            [[geo-distance-query-ex]]\n          \n          \n            \n            ==== Example\n          \n          \n            \n            \n          \n          \n            \n            Assume the following the following documents are indexed:", "author": "jrodewig", "createdAt": "2020-10-28T13:47:29Z", "path": "docs/reference/query-dsl/geo-distance-query.asciidoc", "diffHunk": "@@ -5,8 +5,8 @@\n ++++\n \n Filters documents that include only hits that exists within a specific\n-distance from a geo point. Assuming the following mapping and indexed\n-document:\n+distance from a `geo_shape` or `geo_point` field. Assuming the following mapping and indexed\n+documents:", "originalCommit": "ae899fd8cf446d9b0908bcd61bd0b5faef783000", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ1ODE1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64224#discussion_r513458159", "bodyText": "The current text is fine as-is. Feel free to ignore if wanted.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Then the following simple query can be executed with a `geo_distance`\n          \n          \n            \n            filter:\n          \n          \n            \n            filter against a `geo_point` field:\n          \n          \n            \n            Use a `geo_distance` filter to match `geo_point` values within a specified\n          \n          \n            \n            distance of another geopoint:", "author": "jrodewig", "createdAt": "2020-10-28T13:50:14Z", "path": "docs/reference/query-dsl/geo-distance-query.asciidoc", "diffHunk": "@@ -34,12 +34,37 @@ PUT /my_locations/_doc/1\n     }\n   }\n }\n+\n+PUT /my_geoshapes\n+{\n+  \"mappings\": {\n+    \"properties\": {\n+      \"pin\": {\n+        \"properties\": {\n+          \"location\": {\n+            \"type\": \"geo_shape\"\n+          }\n+        }\n+      }\n+    }\n+  }\n+}\n+\n+PUT /my_geoshapes/_doc/1\n+{\n+  \"pin\": {\n+    \"location\": {\n+      \"type\" : \"polygon\",\n+      \"coordinates\" : [[[13.0 ,51.5], [15.0, 51.5], [15.0, 54.0], [13.0, 54.0], [13.0 ,51.5]]]\n+    }\n+  }\n+}\n --------------------------------------------------\n // TESTSETUP\n \n \n Then the following simple query can be executed with a `geo_distance`\n-filter:\n+filter against a `geo_point` field:", "originalCommit": "ae899fd8cf446d9b0908bcd61bd0b5faef783000", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ1OTAxNg==", "url": "https://github.com/elastic/elasticsearch/pull/64224#discussion_r513459016", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            GET my_geoshapes/_search\n          \n          \n            \n            GET my_locations,my_geoshapes/_search", "author": "jrodewig", "createdAt": "2020-10-28T13:51:11Z", "path": "docs/reference/query-dsl/geo-distance-query.asciidoc", "diffHunk": "@@ -64,6 +89,57 @@ GET /my_locations/_search\n }\n --------------------------------------------------\n \n+The same simple query can be executed against the 'geo_shape field:\n+\n+[source,console]\n+--------------------------------------------------\n+GET my_locations,my_geoshapes/_search\n+{\n+  \"query\": {\n+    \"bool\": {\n+      \"must\": {\n+        \"match_all\": {}\n+      },\n+      \"filter\": {\n+        \"geo_distance\": {\n+          \"distance\": \"200km\",\n+          \"pin.location\": {\n+            \"lat\": 40,\n+            \"lon\": -70\n+          }\n+        }\n+      }\n+    }\n+  }\n+}\n+--------------------------------------------------\n+\n+Or it can be executed in both indexes at the same time:\n+\n+[source,console]\n+--------------------------------------------------\n+GET my_geoshapes/_search", "originalCommit": "ae899fd8cf446d9b0908bcd61bd0b5faef783000", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ1OTEyMg==", "url": "https://github.com/elastic/elasticsearch/pull/64224#discussion_r513459122", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            GET my_locations,my_geoshapes/_search\n          \n          \n            \n            GET my_geoshapes/_search", "author": "jrodewig", "createdAt": "2020-10-28T13:51:18Z", "path": "docs/reference/query-dsl/geo-distance-query.asciidoc", "diffHunk": "@@ -64,6 +89,57 @@ GET /my_locations/_search\n }\n --------------------------------------------------\n \n+The same simple query can be executed against the 'geo_shape field:\n+\n+[source,console]\n+--------------------------------------------------\n+GET my_locations,my_geoshapes/_search", "originalCommit": "ae899fd8cf446d9b0908bcd61bd0b5faef783000", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ1OTM2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64224#discussion_r513459366", "bodyText": "Current text is fine as-is. Feel free to ignore if wanted.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The same simple query can be executed against the 'geo_shape field:\n          \n          \n            \n            Use the same filter to match `geo_shape` values within the given distance:", "author": "jrodewig", "createdAt": "2020-10-28T13:51:36Z", "path": "docs/reference/query-dsl/geo-distance-query.asciidoc", "diffHunk": "@@ -64,6 +89,57 @@ GET /my_locations/_search\n }\n --------------------------------------------------\n \n+The same simple query can be executed against the 'geo_shape field:", "originalCommit": "ae899fd8cf446d9b0908bcd61bd0b5faef783000", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ2NzQ2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64224#discussion_r513467465", "bodyText": "Current text is fine. Feel free to ignore if wanted.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Or it can be executed in both indexes at the same time:\n          \n          \n            \n            To match both `geo_point` and `geo_shape` values, search both indices:", "author": "jrodewig", "createdAt": "2020-10-28T14:01:54Z", "path": "docs/reference/query-dsl/geo-distance-query.asciidoc", "diffHunk": "@@ -64,6 +89,57 @@ GET /my_locations/_search\n }\n --------------------------------------------------\n \n+The same simple query can be executed against the 'geo_shape field:\n+\n+[source,console]\n+--------------------------------------------------\n+GET my_locations,my_geoshapes/_search\n+{\n+  \"query\": {\n+    \"bool\": {\n+      \"must\": {\n+        \"match_all\": {}\n+      },\n+      \"filter\": {\n+        \"geo_distance\": {\n+          \"distance\": \"200km\",\n+          \"pin.location\": {\n+            \"lat\": 40,\n+            \"lon\": -70\n+          }\n+        }\n+      }\n+    }\n+  }\n+}\n+--------------------------------------------------\n+\n+Or it can be executed in both indexes at the same time:", "originalCommit": "ae899fd8cf446d9b0908bcd61bd0b5faef783000", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2e41a3d6a4df9eee17e029ae04e65c45b5c3f416", "url": "https://github.com/elastic/elasticsearch/commit/2e41a3d6a4df9eee17e029ae04e65c45b5c3f416", "message": "address doc review", "committedDate": "2020-10-28T15:36:16Z", "type": "commit"}]}