{"pr_number": 66593, "pr_title": "Annotated text plugin highlighter causes \"array_index_out_of_bounds_exception\"", "pr_createdAt": "2020-12-18T13:38:33Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66593", "timeline": [{"oid": "096e65b341237381902f475b8673fd4e9bb872d0", "url": "https://github.com/elastic/elasticsearch/commit/096e65b341237381902f475b8673fd4e9bb872d0", "message": "Added test for array index out of bounds issue\n\nRelates to #66535", "committedDate": "2021-01-04T09:33:41Z", "type": "commit"}, {"oid": "72ad0df826c38d24d806e420aed74edafbc50bb1", "url": "https://github.com/elastic/elasticsearch/commit/72ad0df826c38d24d806e420aed74edafbc50bb1", "message": "Reset counter on new document", "committedDate": "2021-01-04T09:33:42Z", "type": "commit"}, {"oid": "77d3f64e3e571827663115a3b09dc38618caeded", "url": "https://github.com/elastic/elasticsearch/commit/77d3f64e3e571827663115a3b09dc38618caeded", "message": "Removed needless thread safety on readerNum variable - the Analyzer is created per highlight operation on a field per search request and the use of AtomicInteger only gives a false impression of threading.", "committedDate": "2021-01-04T09:33:42Z", "type": "commit"}, {"oid": "87ef7aef17a6a9e1be279d10c16150656ae608dc", "url": "https://github.com/elastic/elasticsearch/commit/87ef7aef17a6a9e1be279d10c16150656ae608dc", "message": "Remove unused import", "committedDate": "2021-01-04T09:33:42Z", "type": "commit"}, {"oid": "87ef7aef17a6a9e1be279d10c16150656ae608dc", "url": "https://github.com/elastic/elasticsearch/commit/87ef7aef17a6a9e1be279d10c16150656ae608dc", "message": "Remove unused import", "committedDate": "2021-01-04T09:33:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI5Njk3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/66593#discussion_r551296977", "bodyText": "Might be worth changing this to javadoc, and stressing that you must create new instances per search because it's not thread-safe.", "author": "romseygeek", "createdAt": "2021-01-04T12:46:49Z", "path": "plugins/mapper-annotated-text/src/main/java/org/elasticsearch/index/mapper/annotatedtext/AnnotatedTextFieldMapper.java", "diffHunk": "@@ -272,9 +271,16 @@ public AnnotationToken getAnnotation(int index) {\n     // The class takes markedup format field values and returns plain text versions.\n     // When asked to tokenize plain-text versions by the highlighter it tokenizes the\n     // original markup form in order to inject annotations.\n+    // Unlike other Analyzers, which tend to be single-instance, this class has\n+    // instances created per search request and field being highlighted. This allows us to keep\n+    // state about the annotations being processed and pass them into token streams\n+    // being highlighted.", "originalCommit": "87ef7aef17a6a9e1be279d10c16150656ae608dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM0NTI0OA==", "url": "https://github.com/elastic/elasticsearch/pull/66593#discussion_r551345248", "bodyText": "Will do. Thanks for the review!", "author": "markharwood", "createdAt": "2021-01-04T14:23:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI5Njk3Nw=="}], "type": "inlineReview"}, {"oid": "1c5d0da7abc96a93859f12973aed9b10c2eb33d1", "url": "https://github.com/elastic/elasticsearch/commit/1c5d0da7abc96a93859f12973aed9b10c2eb33d1", "message": "Change comment to java doc and add thread safety note.", "committedDate": "2021-01-04T14:32:48Z", "type": "commit"}]}