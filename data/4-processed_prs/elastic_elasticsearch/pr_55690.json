{"pr_number": 55690, "pr_title": "Delete index API properly handles backing indices for data streams", "pr_createdAt": "2020-04-23T19:24:41Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55690", "timeline": [{"oid": "eb174641c7813e29b183b024ef111173a7024f87", "url": "https://github.com/elastic/elasticsearch/commit/eb174641c7813e29b183b024ef111173a7024f87", "message": "cherry pick plus test stub", "committedDate": "2020-04-22T23:48:29Z", "type": "commit"}, {"oid": "6fc8a9fd3de40c461315c013a2fb7ab25729ba14", "url": "https://github.com/elastic/elasticsearch/commit/6fc8a9fd3de40c461315c013a2fb7ab25729ba14", "message": "tighter validation on backing indices", "committedDate": "2020-04-23T00:15:03Z", "type": "commit"}, {"oid": "af28f9bf98b206ecc2f7c746bf43ce974e1ecf02", "url": "https://github.com/elastic/elasticsearch/commit/af28f9bf98b206ecc2f7c746bf43ce974e1ecf02", "message": "add more tests", "committedDate": "2020-04-23T19:20:43Z", "type": "commit"}, {"oid": "b4b6196cbbe47942184d8170326ec803e68e3112", "url": "https://github.com/elastic/elasticsearch/commit/b4b6196cbbe47942184d8170326ec803e68e3112", "message": "checkstyle", "committedDate": "2020-04-23T19:47:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU2MDgxMA==", "url": "https://github.com/elastic/elasticsearch/pull/55690#discussion_r414560810", "bodyText": "nit: { on the previous line?", "author": "martijnvg", "createdAt": "2020-04-24T13:06:41Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataDeleteIndexService.java", "diffHunk": "@@ -91,7 +92,22 @@ public ClusterState execute(final ClusterState currentState) {\n      */\n     public ClusterState deleteIndices(ClusterState currentState, Set<Index> indices) {\n         final Metadata meta = currentState.metadata();\n-        final Set<Index> indicesToDelete = indices.stream().map(i -> meta.getIndexSafe(i).getIndex()).collect(toSet());\n+        final Set<Index> indicesToDelete = new HashSet<>();\n+        final Map<Index, DataStream> backingIndices = new HashMap<>();\n+        for (Index index : indices) {\n+            IndexMetadata im = meta.getIndexSafe(index);\n+            IndexAbstraction.DataStream parent = meta.getIndicesLookup().get(im.getIndex().getName()).getParentDataStream();\n+            if (parent != null)\n+            {", "originalCommit": "b4b6196cbbe47942184d8170326ec803e68e3112", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU2MjY3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/55690#discussion_r414562671", "bodyText": "maybe also verify that the data stream is updated by checking the get data streams api and verify that there is only one backing index?", "author": "martijnvg", "createdAt": "2020-04-24T13:09:36Z", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/indices.delete/20_backing_indices.yml", "diffHunk": "@@ -0,0 +1,90 @@\n+---\n+\"Delete backing index on data stream\":\n+  - skip:\n+      version: \" - 7.99.99\"\n+      reason:  \"enable in 7.8+ after backporting\"\n+\n+  - do:\n+      indices.create_data_stream:\n+        name: simple-data-stream\n+        body:\n+          timestamp_field: \"@timestamp\"\n+  - is_true: acknowledged\n+\n+  # rollover data stream to create new backing index\n+  - do:\n+      indices.rollover:\n+        alias: \"simple-data-stream\"\n+\n+  - match: { old_index: simple-data-stream-000001 }\n+  - match: { new_index: simple-data-stream-000002 }\n+  - match: { rolled_over: true }\n+  - match: { dry_run: false }\n+\n+  # ensure new index is created\n+  - do:\n+      indices.exists:\n+        index: simple-data-stream-000002\n+\n+  - is_true: ''\n+\n+  - do:\n+      indices.delete:\n+        index: simple-data-stream-000001\n+\n+  - do:\n+      indices.exists:\n+        index: simple-data-stream-000001\n+\n+  - is_false: ''\n+\n+  - do:", "originalCommit": "b4b6196cbbe47942184d8170326ec803e68e3112", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU2ODIxMg==", "url": "https://github.com/elastic/elasticsearch/pull/55690#discussion_r414568212", "bodyText": "nit: use assertThat(...) with isNull() as matcher instead? I think in general that is the preferred way of writing test assertions.", "author": "martijnvg", "createdAt": "2020-04-24T13:17:44Z", "path": "server/src/test/java/org/elasticsearch/cluster/metadata/MetadataDeleteIndexServiceTests.java", "diffHunk": "@@ -92,6 +110,38 @@ public void testDeleteUnassigned() {\n         verify(allocationService).reroute(any(ClusterState.class), any(String.class));\n     }\n \n+    public void testDeleteBackingIndexForDataStream() {\n+        int numBackingIndices = randomIntBetween(2, 5);\n+        String dataStreamName = randomAlphaOfLength(6).toLowerCase(Locale.ROOT);\n+        ClusterState before = DeleteDataStreamRequestTests.getClusterStateWithDataStreams(\n+            List.of(new Tuple<>(dataStreamName, numBackingIndices)), List.of());\n+\n+        int numIndexToDelete = randomIntBetween(1, numBackingIndices - 1);\n+\n+        Index indexToDelete = before.metadata().index(DataStream.getBackingIndexName(dataStreamName, numIndexToDelete)).getIndex();\n+        ClusterState after = service.deleteIndices(before, Set.of(indexToDelete));\n+\n+        assertNull(after.metadata().getIndices().get(indexToDelete.getName()));", "originalCommit": "b4b6196cbbe47942184d8170326ec803e68e3112", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3MTMzMw==", "url": "https://github.com/elastic/elasticsearch/pull/55690#discussion_r414571333", "bodyText": "maybe also assert that the index that is supposed to be removed really is removed? I think we now just check that all other indices but the removed index exists. I think that for that, just checking that the number of backing indices is decremented by 1 should suffice.", "author": "martijnvg", "createdAt": "2020-04-24T13:22:06Z", "path": "server/src/test/java/org/elasticsearch/cluster/metadata/DataStreamTests.java", "diffHunk": "@@ -78,4 +78,23 @@ public void testRollover() {\n         assertTrue(rolledDs.getIndices().containsAll(ds.getIndices()));\n         assertTrue(rolledDs.getIndices().contains(newWriteIndex));\n     }\n+\n+    public void testRemoveBackingIndex() {\n+        int numBackingIndices = randomIntBetween(2, 32);\n+        int indexToRemove = randomIntBetween(1, numBackingIndices - 1);\n+        String dataStreamName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+\n+        List<Index> indices = new ArrayList<>(numBackingIndices);\n+        for (int k = 1; k <= numBackingIndices; k++) {\n+            indices.add(new Index(DataStream.getBackingIndexName(dataStreamName, k), UUIDs.randomBase64UUID(random())));\n+        }\n+        DataStream original = new DataStream(dataStreamName, \"@timestamp\", indices);\n+        DataStream updated = original.removeBackingIndex(indices.get(indexToRemove - 1));\n+        assertThat(updated.getName(), equalTo(original.getName()));\n+        assertThat(updated.getGeneration(), equalTo(original.getGeneration()));\n+        assertThat(updated.getTimeStampField(), equalTo(original.getTimeStampField()));\n+        for (int k = 0; k < (numBackingIndices - 1); k++) {\n+            assertThat(updated.getIndices().get(k), equalTo(original.getIndices().get(k < (indexToRemove - 1) ? k : k + 1)));\n+        }", "originalCommit": "b4b6196cbbe47942184d8170326ec803e68e3112", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3MzAwNA==", "url": "https://github.com/elastic/elasticsearch/pull/55690#discussion_r414573004", "bodyText": "I think that instead of looping here just checking that the index that is supposed to be removed is removed and checking that the number of indices is decremented by one is sufficient.", "author": "martijnvg", "createdAt": "2020-04-24T13:24:32Z", "path": "server/src/test/java/org/elasticsearch/cluster/metadata/MetadataDeleteIndexServiceTests.java", "diffHunk": "@@ -92,6 +110,38 @@ public void testDeleteUnassigned() {\n         verify(allocationService).reroute(any(ClusterState.class), any(String.class));\n     }\n \n+    public void testDeleteBackingIndexForDataStream() {\n+        int numBackingIndices = randomIntBetween(2, 5);\n+        String dataStreamName = randomAlphaOfLength(6).toLowerCase(Locale.ROOT);\n+        ClusterState before = DeleteDataStreamRequestTests.getClusterStateWithDataStreams(\n+            List.of(new Tuple<>(dataStreamName, numBackingIndices)), List.of());\n+\n+        int numIndexToDelete = randomIntBetween(1, numBackingIndices - 1);\n+\n+        Index indexToDelete = before.metadata().index(DataStream.getBackingIndexName(dataStreamName, numIndexToDelete)).getIndex();\n+        ClusterState after = service.deleteIndices(before, Set.of(indexToDelete));\n+\n+        assertNull(after.metadata().getIndices().get(indexToDelete.getName()));\n+        for (int k = 1; k <= numBackingIndices; k++) {\n+            if (k != numIndexToDelete) {\n+                assertNotNull(after.metadata().getIndices().get(DataStream.getBackingIndexName(dataStreamName, k)));", "originalCommit": "b4b6196cbbe47942184d8170326ec803e68e3112", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eaca2f6f09e50f2eb1b2e734265b95542203cad4", "url": "https://github.com/elastic/elasticsearch/commit/eaca2f6f09e50f2eb1b2e734265b95542203cad4", "message": "review comments", "committedDate": "2020-04-24T15:27:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMzMzU5MA==", "url": "https://github.com/elastic/elasticsearch/pull/55690#discussion_r415333590", "bodyText": "Would be good to assert that backingIndices.size() == indices.size() - 1?", "author": "henningandersen", "createdAt": "2020-04-26T15:19:59Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/DataStream.java", "diffHunk": "@@ -84,6 +86,19 @@ public DataStream rollover(Index newWriteIndex) {\n         return new DataStream(name, timeStampField, backingIndices, generation + 1);\n     }\n \n+    /**\n+     * Removes the specified backing index and returns a new {@code DataStream} instance with\n+     * the remaining backing indices.\n+     *\n+     * @param index the backing index to remove\n+     * @return new {@code DataStream} instance with the remaining backing indices\n+     */\n+    public DataStream removeBackingIndex(Index index) {\n+        List<Index> backingIndices = new ArrayList<>(indices);\n+        backingIndices.remove(index);\n+        return new DataStream(name, timeStampField, backingIndices, generation);", "originalCommit": "eaca2f6f09e50f2eb1b2e734265b95542203cad4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc3NzMzMA==", "url": "https://github.com/elastic/elasticsearch/pull/55690#discussion_r415777330", "bodyText": "@henningandersen, I've added that assertion in #55802", "author": "danhermann", "createdAt": "2020-04-27T12:40:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTMzMzU5MA=="}], "type": "inlineReview"}]}