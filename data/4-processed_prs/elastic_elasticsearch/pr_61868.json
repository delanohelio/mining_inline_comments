{"pr_number": 61868, "pr_title": "[ML] Update reindexing task progress before persisting job progress", "pr_createdAt": "2020-09-02T16:17:30Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61868", "timeline": [{"oid": "32d3427da7bac5be4915a5b843543ccef565192d", "url": "https://github.com/elastic/elasticsearch/commit/32d3427da7bac5be4915a5b843543ccef565192d", "message": "[ML] Update reindexing task progress before persisting job progress\n\nThis fixes a bug introduced by #61782. In that PR I thought I could\nsimplify the persistence of progress by using the progress straight\nfrom the stats holder in the task instead of calling the get\nstats action. However, I overlooked that it is then possible to\nhave stale progress for the reindexing task as that is only updated\nwhen the get stats API is called.\n\nIn this commit this is fixed by updating reindexing task progress\nbefore persisting the job progress. This seems to be much more\nlightweight than calling the get stats request.\n\nCloses #61852", "committedDate": "2020-09-02T16:10:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIwNTk3OA==", "url": "https://github.com/elastic/elasticsearch/pull/61868#discussion_r482205978", "bodyText": "I was going to comment about \"what else could be stale\", but looking at how we handle the _stats call, we effectively do this.\nSo, we are just shortcutting the _stats call here by slightly \"duplicating\" the code here\nI am referencing:\n\n  \n    \n      elasticsearch/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportGetDataFrameAnalyticsStatsAction.java\n    \n    \n         Line 122\n      in\n      c5cef17\n    \n    \n    \n    \n\n        \n          \n           task.updateReindexTaskProgress(reindexingProgressListener);", "author": "benwtrent", "createdAt": "2020-09-02T16:32:09Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsTask.java", "diffHunk": "@@ -331,14 +331,26 @@ void persistProgress(Client client, String jobId, Runnable runnable) {\n             }\n         );\n \n-        // Step 1: Search for existing progress document in .ml-state*\n-        SearchRequest searchRequest =\n-            new SearchRequest(AnomalyDetectorsIndex.jobStateIndexPattern())\n-                .source(\n-                    new SearchSourceBuilder()\n-                        .size(1)\n-                        .query(new IdsQueryBuilder().addIds(progressDocId)));\n-        executeAsyncWithOrigin(client, ML_ORIGIN, SearchAction.INSTANCE, searchRequest, searchFormerProgressDocListener);\n+        // Step 2: Search for existing progress document in .ml-state*\n+        ActionListener<Void> reindexProgressUpdateListener = ActionListener.wrap(\n+            aVoid -> {\n+                SearchRequest searchRequest =\n+                    new SearchRequest(AnomalyDetectorsIndex.jobStateIndexPattern())\n+                        .source(\n+                            new SearchSourceBuilder()\n+                                .size(1)\n+                                .query(new IdsQueryBuilder().addIds(progressDocId)));\n+                executeAsyncWithOrigin(client, ML_ORIGIN, SearchAction.INSTANCE, searchRequest, searchFormerProgressDocListener);\n+            },\n+            e -> {\n+                LOGGER.error(new ParameterizedMessage(\n+                    \"[{}] cannot persist progress as an error occurred while updating reindexing task progress\", taskParams.getId()), e);\n+                runnable.run();\n+            }\n+        );\n+\n+        // Step 1: Update reindexing progress as it could be stale\n+        updateReindexTaskProgress(reindexProgressUpdateListener);", "originalCommit": "32d3427da7bac5be4915a5b843543ccef565192d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIwODczOQ==", "url": "https://github.com/elastic/elasticsearch/pull/61868#discussion_r482208739", "bodyText": "Yes indeed. Reindex is the only async task that we need to take care of updating its progress before reporting it. I thought about adding back the call to the get stats API. But it is quite a long way around. What do you think is better?", "author": "dimitris-athanasiou", "createdAt": "2020-09-02T16:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIwNTk3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIwOTk5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/61868#discussion_r482209992", "bodyText": "I think doing this directly is fine.\nWe should definitely comment here AND on the _stats call. That way if ever we introduce another async service that we have to worry about refreshing, we capture it.", "author": "benwtrent", "createdAt": "2020-09-02T16:38:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIwNTk3OA=="}], "type": "inlineReview"}, {"oid": "d58c9480531b3097ad1ec720f305ddaafab68c70", "url": "https://github.com/elastic/elasticsearch/commit/d58c9480531b3097ad1ec720f305ddaafab68c70", "message": "Add comment in get stats", "committedDate": "2020-09-02T17:20:23Z", "type": "commit"}]}