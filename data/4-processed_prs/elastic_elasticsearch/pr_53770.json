{"pr_number": 53770, "pr_title": "[Transform][Rollup] add processing stats to record the time spent for processing results", "pr_createdAt": "2020-03-18T21:49:28Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53770", "timeline": [{"oid": "0adb4b91a49fd4ab3c6d6ade729ee3961efe45c1", "url": "https://github.com/elastic/elasticsearch/commit/0adb4b91a49fd4ab3c6d6ade729ee3961efe45c1", "message": "add processing stats to record the time spent for processing results", "committedDate": "2020-03-18T21:15:18Z", "type": "commit"}, {"oid": "75d12725668995cae626f3572b8187f8fbbadcbb", "url": "https://github.com/elastic/elasticsearch/commit/75d12725668995cae626f3572b8187f8fbbadcbb", "message": "fix some rest tests", "committedDate": "2020-03-19T06:39:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk2MTUzMA==", "url": "https://github.com/elastic/elasticsearch/pull/53770#discussion_r394961530", "bodyText": "The new long values need to be Long since they won't exist in older stats files. This will throw an NPE if it tries to parse XContent where these new values don't exist.", "author": "benwtrent", "createdAt": "2020-03-19T11:34:02Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/TransformIndexerStats.java", "diffHunk": "@@ -73,8 +77,10 @@\n         LENIENT_PARSER.declareLong(constructorArg(), NUM_INVOCATIONS);\n         LENIENT_PARSER.declareLong(constructorArg(), INDEX_TIME_IN_MS);\n         LENIENT_PARSER.declareLong(constructorArg(), SEARCH_TIME_IN_MS);\n+        LENIENT_PARSER.declareLong(constructorArg(), PROCESSING_TIME_IN_MS);", "originalCommit": "75d12725668995cae626f3572b8187f8fbbadcbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAyMjU5OA==", "url": "https://github.com/elastic/elasticsearch/pull/53770#discussion_r395022598", "bodyText": "Thanks for pointing this out. I actually wonder why all variables are mandatory in the 1st place, especially as its supposed to be a LENIENT_PARSER, the exponential stats are optional.\nLet me know if you have an idea why mandatory, if there is no good reason, I suggest to switch them all to optional.", "author": "hendrikmuhs", "createdAt": "2020-03-19T13:26:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk2MTUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAyNjAzOA==", "url": "https://github.com/elastic/elasticsearch/pull/53770#discussion_r395026038", "bodyText": "Will also make parsing more robust w.r.t. non existing fields (NPE)", "author": "hendrikmuhs", "createdAt": "2020-03-19T13:31:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk2MTUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA1MDUzNA==", "url": "https://github.com/elastic/elasticsearch/pull/53770#discussion_r395050534", "bodyText": "Switching them all to optional makes sense to me. The ctor should handling the Long. But I do think that the final stats object should just be unboxed long where 0L is an unboxed null.", "author": "benwtrent", "createdAt": "2020-03-19T14:06:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk2MTUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUzNzgxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/53770#discussion_r395537815", "bodyText": "I decided for a slightly different approach. I wanted to avoid massive re-factorings, too. In a nutshell I use a \"take default if Null\" helper method. I am  surprised that I could not find an existing method for this.", "author": "hendrikmuhs", "createdAt": "2020-03-20T10:05:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk2MTUzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk2MjEzOA==", "url": "https://github.com/elastic/elasticsearch/pull/53770#discussion_r394962138", "bodyText": "We also need to be BWC with de-serializing an old stats document via XContent.", "author": "benwtrent", "createdAt": "2020-03-19T11:35:16Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/transform/transforms/TransformStatsTests.java", "diffHunk": "@@ -89,4 +89,32 @@ public void testBwcWith73() throws IOException {\n             }\n         }\n     }\n+\n+    public void testBwcWith76() throws IOException {", "originalCommit": "75d12725668995cae626f3572b8187f8fbbadcbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUzNjAyNA==", "url": "https://github.com/elastic/elasticsearch/pull/53770#discussion_r395536024", "bodyText": "with true lenient parsing this is not necessary anymore", "author": "hendrikmuhs", "createdAt": "2020-03-20T10:01:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDk2MjEzOA=="}], "type": "inlineReview"}, {"oid": "b2f609bce196fe1ce3eba45c36acde597b50ba88", "url": "https://github.com/elastic/elasticsearch/commit/b2f609bce196fe1ce3eba45c36acde597b50ba88", "message": "fix rest tests, bump internal index and add additional mappings", "committedDate": "2020-03-19T13:22:21Z", "type": "commit"}, {"oid": "87cec095f40f1d903f57a26cfc7a6c0f9d88e24f", "url": "https://github.com/elastic/elasticsearch/commit/87cec095f40f1d903f57a26cfc7a6c0f9d88e24f", "message": "make all stats field optional, avoids BWC issues", "committedDate": "2020-03-20T09:52:29Z", "type": "commit"}, {"oid": "2c7cca7e41652ffe44b90d748d383931eb15b4d6", "url": "https://github.com/elastic/elasticsearch/commit/2c7cca7e41652ffe44b90d748d383931eb15b4d6", "message": "fix else code style", "committedDate": "2020-03-20T11:07:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQxNzE3OA==", "url": "https://github.com/elastic/elasticsearch/pull/53770#discussion_r396417178", "bodyText": "\u2764\ufe0f", "author": "benwtrent", "createdAt": "2020-03-23T12:34:53Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/transform/transforms/TransformIndexerStats.java", "diffHunk": "@@ -109,19 +149,44 @@ public boolean equals(Object other) {\n             && Objects.equals(this.numInvocations, that.numInvocations)\n             && Objects.equals(this.indexTime, that.indexTime)\n             && Objects.equals(this.searchTime, that.searchTime)\n+            && Objects.equals(this.processingTime, that.processingTime)\n             && Objects.equals(this.indexFailures, that.indexFailures)\n             && Objects.equals(this.searchFailures, that.searchFailures)\n             && Objects.equals(this.indexTotal, that.indexTotal)\n             && Objects.equals(this.searchTotal, that.searchTotal)\n+            && Objects.equals(this.processingTotal, that.processingTotal)\n             && Objects.equals(this.expAvgCheckpointDurationMs, that.expAvgCheckpointDurationMs)\n             && Objects.equals(this.expAvgDocumentsIndexed, that.expAvgDocumentsIndexed)\n             && Objects.equals(this.expAvgDocumentsProcessed, that.expAvgDocumentsProcessed);\n     }\n \n     @Override\n     public int hashCode() {\n-        return Objects.hash(numPages, numInputDocuments, numOuputDocuments, numInvocations,\n-            indexTime, searchTime, indexFailures, searchFailures, indexTotal, searchTotal,\n-            expAvgCheckpointDurationMs, expAvgDocumentsIndexed, expAvgDocumentsProcessed);\n+        return Objects.hash(\n+            numPages,\n+            numInputDocuments,\n+            numOuputDocuments,\n+            numInvocations,\n+            indexTime,\n+            searchTime,\n+            processingTime,\n+            indexFailures,\n+            searchFailures,\n+            indexTotal,\n+            searchTotal,\n+            processingTotal,\n+            expAvgCheckpointDurationMs,\n+            expAvgDocumentsIndexed,\n+            expAvgDocumentsProcessed\n+        );\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private static <T> T unboxSafe(Object l, T default_value) {", "originalCommit": "2c7cca7e41652ffe44b90d748d383931eb15b4d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}