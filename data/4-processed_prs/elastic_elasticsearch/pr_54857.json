{"pr_number": 54857, "pr_title": "Exists queries to MatchNoneQueryBuilder when the field is unmapped ", "pr_createdAt": "2020-04-07T03:24:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54857", "timeline": [{"oid": "84639ee3c0794f3eead1682fc644ee09041c8732", "url": "https://github.com/elastic/elasticsearch/commit/84639ee3c0794f3eead1682fc644ee09041c8732", "message": "Initial Commit", "committedDate": "2020-04-06T06:12:27Z", "type": "commit"}, {"oid": "1ace54ca9467c81d5e71edc440e771ebedd7a694", "url": "https://github.com/elastic/elasticsearch/commit/1ace54ca9467c81d5e71edc440e771ebedd7a694", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-04-06T06:12:56Z", "type": "commit"}, {"oid": "cce05da7adafd17d480bc9f1e3cf4a011740b942", "url": "https://github.com/elastic/elasticsearch/commit/cce05da7adafd17d480bc9f1e3cf4a011740b942", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-04-07T02:54:38Z", "type": "commit"}, {"oid": "a6a81669e38f26270ce7306f9d7f197e22db461f", "url": "https://github.com/elastic/elasticsearch/commit/a6a81669e38f26270ce7306f9d7f197e22db461f", "message": "Refactor", "committedDate": "2020-04-07T03:24:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzNTAzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/54857#discussion_r404635031", "bodyText": "We should reuse the same logic as newFilter a couple lines below to resolve fields, in order to make sure to not break the behavior of exists queries. Can you extract how fields are resolved to a separate method, use it here, and rewrite to a MatchNoneQueryBuilder if none of the fields is mapped?", "author": "jpountz", "createdAt": "2020-04-07T08:36:43Z", "path": "server/src/main/java/org/elasticsearch/index/query/ExistsQueryBuilder.java", "diffHunk": "@@ -77,6 +77,18 @@ public String fieldName() {\n         return this.fieldName;\n     }\n \n+    @Override\n+    protected QueryBuilder doRewrite(QueryRewriteContext queryShardContext) throws IOException {\n+        QueryShardContext context = queryShardContext.convertToShardContext();\n+        if (context != null) {\n+            MappedFieldType fieldType = context.fieldMapper(fieldName);\n+            if (!fieldName.contains(\"*\") && fieldType == null) {", "originalCommit": "a6a81669e38f26270ce7306f9d7f197e22db461f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3MjkxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/54857#discussion_r405172911", "bodyText": "Sure, updated the PR. Let me know if that works", "author": "SivagurunathanV", "createdAt": "2020-04-07T23:30:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzNTAzMQ=="}], "type": "inlineReview"}, {"oid": "6e00e7d2d4b7921618a8339dab18bf5d98706f25", "url": "https://github.com/elastic/elasticsearch/commit/6e00e7d2d4b7921618a8339dab18bf5d98706f25", "message": "Refactored", "committedDate": "2020-04-07T23:30:01Z", "type": "commit"}, {"oid": "bbfb2fbc8f62fb9ed9251812fa37c051ea9b53e6", "url": "https://github.com/elastic/elasticsearch/commit/bbfb2fbc8f62fb9ed9251812fa37c051ea9b53e6", "message": "Refactoring the comment section", "committedDate": "2020-04-09T20:19:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4MDM5MA==", "url": "https://github.com/elastic/elasticsearch/pull/54857#discussion_r406680390", "bodyText": "It's very easy for this method to get out-of-sync with newFilter, which would likely translate into bugs. Can you make this method called by newFilter? For instance I wonder that it could return a collection of fields instead of a boolean, and all above return false statements would become return Collections.emptySet(); and then in doRewrite we'd check whether the return collection is empty? Finally in doToQuery we could raise an exception when the returned collection is empty, as it would mean that the query wasn't rewritten first even though it is a requirement of the API.", "author": "jpountz", "createdAt": "2020-04-10T09:25:42Z", "path": "server/src/main/java/org/elasticsearch/index/query/ExistsQueryBuilder.java", "diffHunk": "@@ -181,6 +192,45 @@ private static Query newObjectFieldExistsQuery(QueryShardContext context, String\n         return new ConstantScoreQuery(booleanQuery.build());\n     }\n \n+    /**\n+     * Helper method to validate whether field is mapped\n+     * @return true if the field is mapped, false otherwise\n+     */\n+\n+    private static boolean isFieldMapped(QueryShardContext context, String fieldPattern) {\n+        final FieldNamesFieldMapper.FieldNamesFieldType fieldNamesFieldType = (FieldNamesFieldMapper.FieldNamesFieldType) context\n+            .getMapperService().fieldType(FieldNamesFieldMapper.NAME);\n+\n+        if (fieldNamesFieldType == null) {\n+            // can only happen when no types exist, so no docs exist either\n+            return false;\n+        }\n+\n+        final Collection<String> fields;\n+        if (context.getObjectMapper(fieldPattern) != null) {\n+            // the _field_names field also indexes objects, so we don't have to\n+            // do any more work to support exists queries on whole objects\n+            fields = Collections.singleton(fieldPattern);\n+        } else {\n+            fields = context.simpleMatchToIndexNames(fieldPattern);\n+        }\n+\n+        if (fields.size() == 1) {\n+            String field = fields.iterator().next();\n+            MappedFieldType fieldType = context.getMapperService().fieldType(field);\n+            if (fieldType == null) {\n+                // The field does not exist as a leaf but could be an object so\n+                // check for an object mapper\n+                if (context.getObjectMapper(field) != null) {\n+                    return false;\n+                }\n+                return false; // no field mapped\n+            }\n+        }\n+\n+        return true;\n+    }", "originalCommit": "bbfb2fbc8f62fb9ed9251812fa37c051ea9b53e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzOTgzOA==", "url": "https://github.com/elastic/elasticsearch/pull/54857#discussion_r407139838", "bodyText": "A good suggestion \ud83d\udc4d I made the necessary changes. Thanks for pointing out.", "author": "SivagurunathanV", "createdAt": "2020-04-12T03:24:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4MDM5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4MDYxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/54857#discussion_r406680619", "bodyText": "please remove this empty line for consistency with the rest of the code base, we generally don't leave empty lines between javadocs and methods", "author": "jpountz", "createdAt": "2020-04-10T09:26:24Z", "path": "server/src/main/java/org/elasticsearch/index/query/ExistsQueryBuilder.java", "diffHunk": "@@ -181,6 +192,45 @@ private static Query newObjectFieldExistsQuery(QueryShardContext context, String\n         return new ConstantScoreQuery(booleanQuery.build());\n     }\n \n+    /**\n+     * Helper method to validate whether field is mapped\n+     * @return true if the field is mapped, false otherwise\n+     */\n+", "originalCommit": "bbfb2fbc8f62fb9ed9251812fa37c051ea9b53e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzOTc5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/54857#discussion_r407139799", "bodyText": "yes made changes.", "author": "SivagurunathanV", "createdAt": "2020-04-12T03:24:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4MDYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4MjA3NA==", "url": "https://github.com/elastic/elasticsearch/pull/54857#discussion_r406682074", "bodyText": "Let's remove this assertion on the error message. I suspect that attempting to maintain this error message is not going to be worth the efforts, and there is no point in asserting on an error message that is not helpful.", "author": "jpountz", "createdAt": "2020-04-10T09:30:31Z", "path": "server/src/test/java/org/elasticsearch/index/query/ExistsQueryBuilderTests.java", "diffHunk": "@@ -62,12 +62,12 @@ protected void doAssertLuceneQuery(ExistsQueryBuilder queryBuilder, Query query,\n         String fieldPattern = queryBuilder.fieldName();\n         Collection<String> fields = context.simpleMatchToIndexNames(fieldPattern);\n         Collection<String> mappedFields = fields.stream().filter((field) -> context.getObjectMapper(field) != null\n-                || context.getMapperService().fieldType(field) != null).collect(Collectors.toList());\n+            || context.getMapperService().fieldType(field) != null).collect(Collectors.toList());\n         if (fields.size() == 1 && mappedFields.size() == 0) {\n             assertThat(query, instanceOf(MatchNoDocsQuery.class));\n             MatchNoDocsQuery matchNoDocsQuery = (MatchNoDocsQuery) query;\n             assertThat(matchNoDocsQuery.toString(null),\n-                    containsString(\"No field \\\"\" + fields.iterator().next() + \"\\\" exists in mappings.\"));\n+                containsString(\"User requested \\\"match_none\\\" query.\"));", "originalCommit": "bbfb2fbc8f62fb9ed9251812fa37c051ea9b53e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzOTc1OA==", "url": "https://github.com/elastic/elasticsearch/pull/54857#discussion_r407139758", "bodyText": "Sure, done.", "author": "SivagurunathanV", "createdAt": "2020-04-12T03:23:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4MjA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4MjIxNA==", "url": "https://github.com/elastic/elasticsearch/pull/54857#discussion_r406682214", "bodyText": "can you undo all indentation changes to this pull request?", "author": "jpountz", "createdAt": "2020-04-10T09:30:57Z", "path": "server/src/test/java/org/elasticsearch/index/query/ExistsQueryBuilderTests.java", "diffHunk": "@@ -115,7 +115,7 @@ public void testIllegalArguments() {\n \n     public void testFromJson() throws IOException {\n         String json =\n-                \"{\\n\" +\n+            \"{\\n\" +", "originalCommit": "bbfb2fbc8f62fb9ed9251812fa37c051ea9b53e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzOTg0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54857#discussion_r407139845", "bodyText": "Done.", "author": "SivagurunathanV", "createdAt": "2020-04-12T03:25:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4MjIxNA=="}], "type": "inlineReview"}, {"oid": "274cf4338d892465381b3707a891b479a4dd36fb", "url": "https://github.com/elastic/elasticsearch/commit/274cf4338d892465381b3707a891b479a4dd36fb", "message": "Refactoring review comments", "committedDate": "2020-04-12T03:20:05Z", "type": "commit"}, {"oid": "fef8b0a885f5739ca8316de97be1a778420898bc", "url": "https://github.com/elastic/elasticsearch/commit/fef8b0a885f5739ca8316de97be1a778420898bc", "message": "Indentation changes", "committedDate": "2020-04-12T03:23:14Z", "type": "commit"}, {"oid": "13901cb4b9c16765e08a2365eb1da1880a18f2ed", "url": "https://github.com/elastic/elasticsearch/commit/13901cb4b9c16765e08a2365eb1da1880a18f2ed", "message": "Indendation again", "committedDate": "2020-04-12T03:25:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ0MjM3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54857#discussion_r407442373", "bodyText": "I believe that this entire if statement can be removed without affecting correctness. It is not possible to have a field that is neither and object nor a field at this stage.", "author": "jpountz", "createdAt": "2020-04-13T11:49:07Z", "path": "server/src/main/java/org/elasticsearch/index/query/ExistsQueryBuilder.java", "diffHunk": "@@ -181,6 +183,43 @@ private static Query newObjectFieldExistsQuery(QueryShardContext context, String\n         return new ConstantScoreQuery(booleanQuery.build());\n     }\n \n+    /**\n+     * Helper method to get field mapped to this fieldPattern\n+     * @return return collection of fields if exists else return empty.\n+     */\n+    private static Collection<String> getMappedField(QueryShardContext context, String fieldPattern) {\n+        final FieldNamesFieldMapper.FieldNamesFieldType fieldNamesFieldType = (FieldNamesFieldMapper.FieldNamesFieldType) context\n+            .getMapperService().fieldType(FieldNamesFieldMapper.NAME);\n+\n+        if (fieldNamesFieldType == null) {\n+            // can only happen when no types exist, so no docs exist either\n+            return Collections.emptySet();\n+        }\n+\n+        final Collection<String> fields;\n+        if (context.getObjectMapper(fieldPattern) != null) {\n+            // the _field_names field also indexes objects, so we don't have to\n+            // do any more work to support exists queries on whole objects\n+            fields = Collections.singleton(fieldPattern);\n+        } else {\n+            fields = context.simpleMatchToIndexNames(fieldPattern);\n+        }\n+\n+        if (fields.size() == 1) {\n+            String field = fields.iterator().next();\n+            MappedFieldType fieldType = context.getMapperService().fieldType(field);\n+            if (fieldType == null) {\n+                // The field does not exist as a leaf but could be an object so\n+                // check for an object mapper\n+                if (context.getObjectMapper(field) == null) {\n+                    return Collections.emptySet();\n+                }\n+            }\n+        }", "originalCommit": "13901cb4b9c16765e08a2365eb1da1880a18f2ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMyNDQ2OA==", "url": "https://github.com/elastic/elasticsearch/pull/54857#discussion_r409324468", "bodyText": "But in this, if statement we are checking the field type.\n MappedFieldType fieldType = context.getMapperService().fieldType(field);", "author": "SivagurunathanV", "createdAt": "2020-04-16T06:59:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ0MjM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTUwMjkxNw==", "url": "https://github.com/elastic/elasticsearch/pull/54857#discussion_r409502917", "bodyText": "Thanks I had the wrong assumption that simpleMatchToIndexName would return an empty set if the field is not mapped.", "author": "jpountz", "createdAt": "2020-04-16T12:05:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ0MjM3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ0Mjc2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/54857#discussion_r407442761", "bodyText": "this line is unreachable right? maybe throw an IllegalStateException instead? If I'm wrong and this is not dead code, would you mind explaining the conditions under which it is triggered?", "author": "jpountz", "createdAt": "2020-04-13T11:50:20Z", "path": "server/src/main/java/org/elasticsearch/index/query/ExistsQueryBuilder.java", "diffHunk": "@@ -165,7 +167,7 @@ private static Query newFieldExistsQuery(QueryShardContext context, String field\n             if (context.getObjectMapper(field) != null) {\n                 return newObjectFieldExistsQuery(context, field);\n             }\n-            return Queries.newMatchNoDocsQuery(\"No field \\\"\" + field + \"\\\" exists in mappings.\");\n+            return Queries.newMatchNoDocsQuery(\"User requested \\\"match_none\\\" query.\");", "originalCommit": "13901cb4b9c16765e08a2365eb1da1880a18f2ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMyMzMzMw==", "url": "https://github.com/elastic/elasticsearch/pull/54857#discussion_r409323333", "bodyText": "No, when User looks for an Object field that does not exist in the mapping, it will fall into this - as per my understanding. please correct me if I am wrong.", "author": "SivagurunathanV", "createdAt": "2020-04-16T06:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ0Mjc2MQ=="}], "type": "inlineReview"}, {"oid": "73ba7475e903f7fb70c79ee302166d6db92d14ab", "url": "https://github.com/elastic/elasticsearch/commit/73ba7475e903f7fb70c79ee302166d6db92d14ab", "message": "Adding test for rewrite", "committedDate": "2020-04-16T07:01:09Z", "type": "commit"}, {"oid": "c969bc1bc66fde9f4c9d2aa4fc099554ccb0b9df", "url": "https://github.com/elastic/elasticsearch/commit/c969bc1bc66fde9f4c9d2aa4fc099554ccb0b9df", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-04-16T14:57:08Z", "type": "commit"}, {"oid": "44afde6b6592b71169a7d17cbcbc8784bd5d9ae6", "url": "https://github.com/elastic/elasticsearch/commit/44afde6b6592b71169a7d17cbcbc8784bd5d9ae6", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-04-18T17:42:22Z", "type": "commit"}, {"oid": "7a3ec01efde242e575d66b83ef273eab9db3bd06", "url": "https://github.com/elastic/elasticsearch/commit/7a3ec01efde242e575d66b83ef273eab9db3bd06", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-04-21T15:52:32Z", "type": "commit"}]}