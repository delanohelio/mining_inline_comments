{"pr_number": 59959, "pr_title": "Cleanup and optimize More Serialization Spots", "pr_createdAt": "2020-07-21T11:00:24Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59959", "timeline": [{"oid": "8b7ec6d59ce4b0c36120fc8321805dcc4cb4d5e3", "url": "https://github.com/elastic/elasticsearch/commit/8b7ec6d59ce4b0c36120fc8321805dcc4cb4d5e3", "message": "Cleanup and optimize More Serialization Spots\n\nSame as #59626 for a few more spots.", "committedDate": "2020-07-21T10:58:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM5NDEyMg==", "url": "https://github.com/elastic/elasticsearch/pull/59959#discussion_r458394122", "bodyText": "Since i is typically an integer, maybe use mapIn or something like that?", "author": "rjernst", "createdAt": "2020-07-21T21:18:55Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/mapping/get/GetFieldMappingsResponse.java", "diffHunk": "@@ -61,23 +60,18 @@\n \n     GetFieldMappingsResponse(StreamInput in) throws IOException {\n         super(in);\n-        int size = in.readVInt();\n-        Map<String, Map<String, FieldMappingMetadata>> indexMapBuilder = new HashMap<>(size);\n-        for (int i = 0; i < size; i++) {\n-            String index = in.readString();\n-            if (in.getVersion().before(Version.V_8_0_0)) {\n-                int typesSize = in.readVInt();\n+        mappings = unmodifiableMap(in.readMap(StreamInput::readString, i -> {", "originalCommit": "8b7ec6d59ce4b0c36120fc8321805dcc4cb4d5e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYwNzYwNA==", "url": "https://github.com/elastic/elasticsearch/pull/59959#discussion_r458607604", "bodyText": "Makes sense, renamed :)", "author": "original-brownbear", "createdAt": "2020-07-22T07:59:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM5NDEyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM5NTE4MA==", "url": "https://github.com/elastic/elasticsearch/pull/59959#discussion_r458395180", "bodyText": "Since this PR is labeled to be backported to 7.10, shouldn't we keep this as is so the backport is easy, and cleanup in a separate change just for master?", "author": "rjernst", "createdAt": "2020-07-21T21:21:02Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/shards/IndicesShardStoresResponse.java", "diffHunk": "@@ -213,21 +211,16 @@ public int compareTo(StoreStatus other) {\n      * Single node failure while retrieving shard store information\n      */\n     public static class Failure extends DefaultShardOperationFailedException {\n-        private String nodeId;\n+        private final String nodeId;\n \n         public Failure(String nodeId, String index, int shardId, Throwable reason) {\n             super(index, shardId, reason);\n             this.nodeId = nodeId;\n         }\n \n         private Failure(StreamInput in) throws IOException {\n-            if (in.getVersion().before(Version.V_7_4_0)) {", "originalCommit": "8b7ec6d59ce4b0c36120fc8321805dcc4cb4d5e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYwNzkwMw==", "url": "https://github.com/elastic/elasticsearch/pull/59959#discussion_r458607903", "bodyText": "Makes sense, less noisy I'll batch this with a few other cleanups of outdated version handling in master soon :)", "author": "original-brownbear", "createdAt": "2020-07-22T08:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM5NTE4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM5NTkzOA==", "url": "https://github.com/elastic/elasticsearch/pull/59959#discussion_r458395938", "bodyText": "ditto on making this change in a dedicated PR for master only", "author": "rjernst", "createdAt": "2020-07-21T21:22:35Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java", "diffHunk": "@@ -950,9 +950,7 @@ public void writeTo(StreamOutput out) throws IOException {\n         coordinationMetadata.writeTo(out);\n         writeSettingsToStream(transientSettings, out);\n         writeSettingsToStream(persistentSettings, out);\n-        if (out.getVersion().onOrAfter(Version.V_7_3_0)) {", "originalCommit": "8b7ec6d59ce4b0c36120fc8321805dcc4cb4d5e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "30a9b158d32c9b14939ab8b3ab985b025a82c604", "url": "https://github.com/elastic/elasticsearch/commit/30a9b158d32c9b14939ab8b3ab985b025a82c604", "message": "Merge remote-tracking branch 'elastic/master' into cleanup-some-serialization-3", "committedDate": "2020-07-22T07:37:46Z", "type": "commit"}, {"oid": "bf77da242db2784b3d592796c250b41bb458489e", "url": "https://github.com/elastic/elasticsearch/commit/bf77da242db2784b3d592796c250b41bb458489e", "message": "CR: comments", "committedDate": "2020-07-22T07:58:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTczNDg5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/59959#discussion_r461734892", "bodyText": "Maybe this should exist in MappingMetadata, rather than a random response class?", "author": "rjernst", "createdAt": "2020-07-28T17:02:28Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/mapping/get/GetMappingsResponse.java", "diffHunk": "@@ -69,6 +69,10 @@ public GetMappingsResponse(ImmutableOpenMap<String, MappingMetadata> mappings) {\n \n     @Override\n     public void writeTo(StreamOutput out) throws IOException {\n+        writeMappingMetadata(out, mappings);\n+    }\n+\n+    public static void writeMappingMetadata(StreamOutput out, ImmutableOpenMap<String, MappingMetadata> mappings) throws IOException {", "originalCommit": "bf77da242db2784b3d592796c250b41bb458489e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MjM1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/59959#discussion_r461792351", "bodyText": "++", "author": "original-brownbear", "createdAt": "2020-07-28T18:39:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTczNDg5Mg=="}], "type": "inlineReview"}, {"oid": "355223c0dced77b4b170beb9d797ae85fd35aa7b", "url": "https://github.com/elastic/elasticsearch/commit/355223c0dced77b4b170beb9d797ae85fd35aa7b", "message": "Merge remote-tracking branch 'elastic/master' into cleanup-some-serialization-3", "committedDate": "2020-07-28T17:43:13Z", "type": "commit"}, {"oid": "254cca8a7c3600b391e458eb140f118ab3ae3402", "url": "https://github.com/elastic/elasticsearch/commit/254cca8a7c3600b391e458eb140f118ab3ae3402", "message": "move things around", "committedDate": "2020-07-28T17:47:53Z", "type": "commit"}]}