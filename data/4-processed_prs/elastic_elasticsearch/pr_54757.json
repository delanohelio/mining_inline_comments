{"pr_number": 54757, "pr_title": "Support hierarchical task cancellation", "pr_createdAt": "2020-04-03T21:11:29Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54757", "timeline": [{"oid": "33c943a0320a763bf819f9188a57e71cb72ea2c2", "url": "https://github.com/elastic/elasticsearch/commit/33c943a0320a763bf819f9188a57e71cb72ea2c2", "message": "Support hierarchical task cancellation", "committedDate": "2020-04-03T21:00:25Z", "type": "commit"}, {"oid": "c8d017b0e7f104468246c146cd53e4938b2cf13f", "url": "https://github.com/elastic/elasticsearch/commit/c8d017b0e7f104468246c146cd53e4938b2cf13f", "message": "Merge branch 'master' into hierarchical-cancellation", "committedDate": "2020-04-03T22:02:46Z", "type": "commit"}, {"oid": "b755814174659d47c98a296925668667b00354af", "url": "https://github.com/elastic/elasticsearch/commit/b755814174659d47c98a296925668667b00354af", "message": "Merge branch 'master' into hierarchical-cancellation", "committedDate": "2020-04-04T02:05:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg4NTg3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54757#discussion_r403885877", "bodyText": "I wonder if we need to eventually optimize this, in case there might be a very large list of cancellable tasks. Also, this does not have proper happens-before, as iterating a concurrent map after an element has been added is not guaranteed to yield the element (it's eventually consistent).", "author": "ywelsch", "createdAt": "2020-04-06T07:38:11Z", "path": "server/src/main/java/org/elasticsearch/tasks/TaskManager.java", "diffHunk": "@@ -377,14 +378,10 @@ public void setBan(TaskId parentTaskId, String reason) {\n                 banedParents.put(parentTaskId, reason);\n             }\n         }\n-\n-        // Now go through already running tasks and cancel them\n-        for (Map.Entry<Long, CancellableTaskHolder> taskEntry : cancellableTasks.entrySet()) {\n-            CancellableTaskHolder holder = taskEntry.getValue();\n-            if (holder.hasParent(parentTaskId)) {\n-                holder.cancel(reason);\n-            }\n-        }\n+        return cancellableTasks.values().stream()", "originalCommit": "b755814174659d47c98a296925668667b00354af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}