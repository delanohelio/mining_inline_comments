{"pr_number": 66587, "pr_title": "Reduce Overhead of RepositoryData Cache for Large Repositories", "pr_createdAt": "2020-12-18T11:14:45Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66587", "timeline": [{"oid": "95087b3a94c33d500ed291575b4bca06af78dec0", "url": "https://github.com/elastic/elasticsearch/commit/95087b3a94c33d500ed291575b4bca06af78dec0", "message": "Reduce Overhead of RepositoryData Cache for Large Repositories\n\nThis adds caching the fact that `RepositoryData` was too large to be\ncached so we don't serialize it over and over just to find out we can't\ncache it.", "committedDate": "2020-12-18T10:03:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc2ODkxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/66587#discussion_r545768915", "bodyText": "I figured I'd encapsulate this a little (even though it adds a bunch of lines) because the Tuple access is quite hard to read and it's used in a bunch of spots.", "author": "original-brownbear", "createdAt": "2020-12-18T11:22:03Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1298,20 +1297,62 @@ public void endVerification(String seed) {\n     private final AtomicLong latestKnownRepoGen = new AtomicLong(RepositoryData.UNKNOWN_REPO_GEN);\n \n     // Best effort cache of the latest known repository data and its generation, cached serialized as compressed json\n-    private final AtomicReference<Tuple<Long, BytesReference>> latestKnownRepositoryData = new AtomicReference<>();\n+    private final AtomicReference<CachedRepositoryData> latestKnownRepositoryData =\n+            new AtomicReference<>(new CachedRepositoryData(RepositoryData.EMPTY_REPO_GEN, null));\n+\n+    /**\n+     * Cached serialized repository data or placeholder to keep track of the fact that data for a generation was too large to be cached.\n+     */\n+    private static final class CachedRepositoryData {", "originalCommit": "95087b3a94c33d500ed291575b4bca06af78dec0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}